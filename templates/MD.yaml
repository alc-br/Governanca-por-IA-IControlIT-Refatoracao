# =============================================
# Modelo de Dados (MD) — Template YAML
# Versão: 2.0
# Autor padrão: Agência ALC - alc.dev.br
# =============================================
# CHANGELOG v2.0:
# - Seção seed.habilitado alterada para TRUE (OBRIGATÓRIO)
# - Seção central_funcionalidades adicionada (RF112)
# - Seção permissoes atualizada com padrão MODULO.ENTIDADE.ACAO
# - Seção role_permissions adicionada (associação perfis)
# - Seção validacao_seeds adicionada (checklist)
# =============================================

# =============================================
# 1. METADADOS DO DOCUMENTO (OBRIGATÓRIO)
# =============================================
metadata:
  versao: "2.0"
  data: "YYYY-MM-DD"
  autor: "Agência ALC - alc.dev.br"

  documentacao_relacionada:
    id: "RFXXX"
    nome: "Nome do Requisito"

  sistema/modulo: "Nome do sistema ou módulo"
  banco_de_dados:
    engine: "PostgreSQL"        # PostgreSQL | SQLServer | MySQL | etc.
    schema: "public"            # se aplicável
  padroes:
    multi_tenancy: true          # true | false
    auditoria: true              # true | false
    soft_delete: true            # true | false

# =============================================
# 2. ENTIDADES (OBRIGATÓRIO)
# =============================================
entidades:
  - nome: "nome_da_tabela"
    descricao: "Descrição objetiva do propósito da tabela"

    # -----------------------------
    # 2.1 CAMPOS (OBRIGATÓRIO)
    # -----------------------------
    campos:
      - nome: "id"
        tipo: "BIGSERIAL"
        nulo: false
        default: "auto"
        descricao: "Chave primária"
        pk: true

      # Multi-tenancy (se aplicável)
      - nome: "tenant_id"
        tipo: "BIGINT"
        nulo: false
        descricao: "FK para tenants (multi-tenancy)"
        fk:
          tabela: "tenants"
          coluna: "id"
          on_delete: "CASCADE"
        index: true

      # Campos de negócio (exemplos — substitua)
      - nome: "nome"
        tipo: "VARCHAR(200)"
        nulo: false
        default: null
        descricao: "Nome do registro"
        unique_por_tenant: true
        index: true
        mutavel: true
        origem:
          documentacao: "RF-XXX"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-001"

      - nome: "descricao"
        tipo: "TEXT"
        nulo: true
        default: null
        descricao: "Descrição livre"
        mutavel: true
        origem:
          documentacao: "RF-XXX"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-002"

      - nome: "status"
        tipo: "VARCHAR(30)"
        nulo: false
        default: "ativo"
        descricao: "Status do registro (ex.: ativo/inativo/rascunho)"
        index: true
        mutavel: true
        check:
          definicao: "status IN ('ativo','inativo','rascunho')"
          descricao: "Status permitido"
        origem:
          documentacao: "RF-XXX"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-003"

      - nome: "ativo"
        tipo: "BOOLEAN"
        nulo: false
        default: true
        descricao: "Flag de ativo/inativo"
        mutavel: true
        index_parcial:
          where: "ativo = true"
          descricao: "Acelera listagens de ativos"
        origem:
          documentacao: "RF-XXX"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-003"

      # Auditoria (se aplicável)
      - nome: "created_at"
        tipo: "TIMESTAMP"
        nulo: true
        default: "NOW()"
        descricao: "Data de criação"
        audit: true
        mutavel: false
        origem:
          documentacao: "RF-XXX"
          uc: "UC01"
          wf: null
          campo_wf: null
          observacao: "Campo gerado automaticamente pelo sistema"

      - nome: "created_by"
        tipo: "BIGINT"
        nulo: true
        default: null
        descricao: "Usuário que criou"
        audit: true
        mutavel: false
        fk:
          tabela: "users"
          coluna: "id"
          on_delete: "SET NULL"
        origem:
          documentacao: "RF-XXX"
          uc: "UC01"
          wf: null
          campo_wf: null
          observacao: "Preenchido automaticamente com ID do usuário autenticado"

      - nome: "updated_at"
        tipo: "TIMESTAMP"
        nulo: true
        default: null
        descricao: "Data de atualização"
        audit: true
        mutavel: false
        origem:
          documentacao: "RF-XXX"
          uc: "UC03"
          wf: null
          campo_wf: null
          observacao: "Campo gerado automaticamente pelo sistema"

      - nome: "updated_by"
        tipo: "BIGINT"
        nulo: true
        default: null
        descricao: "Usuário que atualizou"
        audit: true
        mutavel: false
        fk:
          tabela: "users"
          coluna: "id"
          on_delete: "SET NULL"
        origem:
          documentacao: "RF-XXX"
          uc: "UC03"
          wf: null
          campo_wf: null
          observacao: "Preenchido automaticamente com ID do usuário autenticado"

      # Soft delete (se aplicável)
      - nome: "deleted_at"
        tipo: "TIMESTAMP"
        nulo: true
        default: null
        descricao: "Soft delete"
        audit: true
        mutavel: false
        origem:
          documentacao: "RF-XXX"
          uc: "UC04"
          wf: null
          campo_wf: null
          observacao: "Preenchido automaticamente ao excluir (soft delete)"

    # -----------------------------
    # 2.2 ÍNDICES (OBRIGATÓRIO)
    # -----------------------------
    indices:
      - nome: "pk_nome_da_tabela"
        tipo: "PRIMARY"
        colunas: ["id"]
        descricao: "Chave primária"

      - nome: "idx_nome_da_tabela_tenant"
        tipo: "BTREE"
        colunas: ["tenant_id"]
        descricao: "Performance em queries multi-tenant"

      - nome: "idx_nome_da_tabela_status"
        tipo: "BTREE"
        colunas: ["status"]
        descricao: "Performance em filtros por status"

      - nome: "idx_nome_da_tabela_created_at"
        tipo: "BTREE"
        colunas: ["created_at"]
        descricao: "Performance em ordenação por data"

      # Índice parcial (PostgreSQL) — opcional
      - nome: "idx_nome_da_tabela_ativo_true"
        tipo: "BTREE"
        colunas: ["ativo"]
        where: "ativo = true"
        descricao: "Acelera consultas apenas de ativos"

    # -----------------------------
    # 2.3 CONSTRAINTS (OBRIGATÓRIO)
    # -----------------------------
    constraints:
      - nome: "fk_nome_da_tabela_tenant"
        tipo: "FOREIGN KEY"
        definicao: "tenant_id REFERENCES tenants(id)"
        on_delete: "CASCADE"
        descricao: "Multi-tenancy"

      # UNIQUE por tenant (se aplicável)
      - nome: "uq_nome_da_tabela_tenant_nome"
        tipo: "UNIQUE"
        definicao: "(tenant_id, nome)"
        descricao: "Nome único por tenant"

      # CHECK (se aplicável)
      - nome: "chk_nome_da_tabela_status"
        tipo: "CHECK"
        definicao: "status IN ('ativo','inativo','rascunho')"
        descricao: "Status permitido"

    # =============================================
    # 2.4 MD-App (OPCIONAL) — LARAVEL / ELOQUENT
    # =============================================
    app:
      habilitado: true

      model:
        nome: "NomeDaEntidade"
        namespace: "App\Models"
        traits:
          - "HasFactory"
          - "HasTenant"
          - "HasAudit"
          - "SoftDeletes"

      fillable:
        - "tenant_id"
        - "nome"
        - "descricao"
        - "status"
        - "ativo"

      casts:
        ativo: "boolean"
        created_at: "datetime"
        updated_at: "datetime"
        deleted_at: "datetime"

      relacionamentos:
        - nome: "tenant"
          tipo: "BelongsTo"
          model: "Tenant"
          foreign_key: "tenant_id"

        - nome: "createdBy"
          tipo: "BelongsTo"
          model: "User"
          foreign_key: "created_by"

        - nome: "updatedBy"
          tipo: "BelongsTo"
          model: "User"
          foreign_key: "updated_by"

      scopes:
        - nome: "active"
          descricao: "Registros ativos"
          codigo: "where('ativo', true)"

        - nome: "inactive"
          descricao: "Registros inativos"
          codigo: "where('ativo', false)"

    # =============================================
    # 2.5 MD-Seed (OBRIGATÓRIO) — PERMISSÕES E CENTRAL DE FUNCIONALIDADES
    # =============================================
    seed:
      habilitado: true  # OBRIGATÓRIO para toda funcionalidade (alterado de false para true)

      # -----------------------------
      # CENTRAL DE FUNCIONALIDADES (OBRIGATÓRIO)
      # -----------------------------
      # Conforme RF112: Toda funcionalidade DEVE ser registrada na Central de Módulos
      central_funcionalidades:
        modulo:
          codigo: "MODULO"                    # Ex: "CAD" (Cadastros), "FIN" (Financeiro), "CONF" (Configuração)
          nome: "Nome do Módulo"
          descricao: "Descrição do módulo para exibição na Central de Funcionalidades"
          categoria: "cadastro"               # cadastro | operacao | relatorio | configuracao | admin
          icone: "mdi-database"               # Material Design Icon (https://materialdesignicons.com/)
          ordem: 10                           # Ordem de exibição no menu (menor = primeiro)
          ativo: true
          url_base: "/modulo/entidade"

        funcionalidade:
          codigo: "MODULO_ENTIDADE"           # Código único da funcionalidade (snake_case UPPERCASE)
          nome: "Gestão de Entidade"
          descricao: "Gerenciamento completo de registros de entidade"
          icone: "mdi-file-document"
          ordem: 1                            # Ordem dentro do módulo
          ativo: true
          url: "/modulo/entidade"
          modulo_codigo: "MODULO"             # FK para módulo acima (DEVE corresponder)

      # -----------------------------
      # PERMISSÕES RBAC (OBRIGATÓRIO)
      # -----------------------------
      # REGRA: Segregação por AÇÃO (VIEW, CREATE, UPDATE, DELETE, EXPORT, etc.)
      # PADRÃO: MODULO.ENTIDADE.ACAO (UPPERCASE com pontos)
      # OBRIGATÓRIO: Perfil Developer SEMPRE deve ter TODAS as permissões (para testes)
      permissoes:
        - codigo: "MODULO.ENTIDADE.VIEW"
          nome: "Visualizar Entidade"
          descricao: "Permite visualizar lista e detalhes de registros de entidade"
          funcionalidade_codigo: "MODULO_ENTIDADE"  # FK para funcionalidade acima
          ativo: true
          perfis_obrigatorios:
            - "Developer"                     # OBRIGATÓRIO: Perfil Developer para testes
          perfis_sugeridos:
            - "Super Admin"
            - "Admin"
            - "User"
          uc_relacionado: "UC00"              # UC que exige esta permissão
          endpoint_backend: "GET /api/v1/entidade"

        - codigo: "MODULO.ENTIDADE.CREATE"
          nome: "Criar Entidade"
          descricao: "Permite criar novos registros de entidade"
          funcionalidade_codigo: "MODULO_ENTIDADE"
          ativo: true
          perfis_obrigatorios:
            - "Developer"
          perfis_sugeridos:
            - "Super Admin"
            - "Admin"
          uc_relacionado: "UC01"
          endpoint_backend: "POST /api/v1/entidade"

        - codigo: "MODULO.ENTIDADE.UPDATE"
          nome: "Editar Entidade"
          descricao: "Permite editar registros existentes de entidade"
          funcionalidade_codigo: "MODULO_ENTIDADE"
          ativo: true
          perfis_obrigatorios:
            - "Developer"
          perfis_sugeridos:
            - "Super Admin"
            - "Admin"
          uc_relacionado: "UC02"
          endpoint_backend: "PUT /api/v1/entidade/:id"

        - codigo: "MODULO.ENTIDADE.DELETE"
          nome: "Excluir Entidade"
          descricao: "Permite excluir registros de entidade (soft delete)"
          funcionalidade_codigo: "MODULO_ENTIDADE"
          ativo: true
          perfis_obrigatorios:
            - "Developer"
          perfis_sugeridos:
            - "Super Admin"
            - "Admin"
          uc_relacionado: "UC03"
          endpoint_backend: "DELETE /api/v1/entidade/:id"

        - codigo: "MODULO.ENTIDADE.EXPORT"
          nome: "Exportar Entidade"
          descricao: "Permite exportar registros de entidade para Excel/PDF"
          funcionalidade_codigo: "MODULO_ENTIDADE"
          ativo: true
          perfis_obrigatorios:
            - "Developer"
          perfis_sugeridos:
            - "Super Admin"
            - "Admin"
            - "User"
          uc_relacionado: "UC04"
          endpoint_backend: "GET /api/v1/entidade/export"

        # Adicionar permissões adicionais conforme necessário:
        # - MODULO.ENTIDADE.IMPORT (importar registros)
        # - MODULO.ENTIDADE.APPROVE (aprovar registros)
        # - MODULO.ENTIDADE.CANCEL (cancelar operação)
        # - MODULO.ENTIDADE.CLONE (duplicar registro)
        # - etc.

      # -----------------------------
      # ASSOCIAÇÃO PERFIS x PERMISSÕES (OBRIGATÓRIO)
      # -----------------------------
      role_permissions:
        - role: "Developer"
          permissoes:
            - "MODULO.ENTIDADE.VIEW"
            - "MODULO.ENTIDADE.CREATE"
            - "MODULO.ENTIDADE.UPDATE"
            - "MODULO.ENTIDADE.DELETE"
            - "MODULO.ENTIDADE.EXPORT"
          justificativa: "Perfil Developer DEVE ter TODAS as permissões para execução de testes E2E"

        - role: "Super Admin"
          permissoes:
            - "MODULO.ENTIDADE.VIEW"
            - "MODULO.ENTIDADE.CREATE"
            - "MODULO.ENTIDADE.UPDATE"
            - "MODULO.ENTIDADE.DELETE"
            - "MODULO.ENTIDADE.EXPORT"
          justificativa: "Super Admin possui acesso total ao sistema"

        - role: "Admin"
          permissoes:
            - "MODULO.ENTIDADE.VIEW"
            - "MODULO.ENTIDADE.CREATE"
            - "MODULO.ENTIDADE.UPDATE"
            - "MODULO.ENTIDADE.DELETE"
          justificativa: "Admin pode gerenciar registros mas não exportar"

        - role: "User"
          permissoes:
            - "MODULO.ENTIDADE.VIEW"
            - "MODULO.ENTIDADE.EXPORT"
          justificativa: "User pode apenas visualizar e exportar"

      # -----------------------------
      # DADOS DE TESTE (OPCIONAL)
      # -----------------------------
      factory: # opcional
        campos:
          tenant_id: "Tenant::factory()"
          nome: "fake()->words(3, true)"
          descricao: "fake()->sentence()"
          status: "fake()->randomElement(['ativo','inativo','rascunho'])"
          ativo: "true"
        states:
          - nome: "inactive"
            campos:
              ativo: "false"
              status: "inativo"

      seeder: # opcional
        registros:
          - nome: "Exemplo 1"
            descricao: "Descrição do exemplo 1"
            status: "ativo"
            ativo: true

          - nome: "Exemplo 2"
            descricao: "Descrição do exemplo 2"
            status: "rascunho"
            ativo: true

      # -----------------------------
      # VALIDAÇÃO DE COMPLETUDE (OBRIGATÓRIO)
      # -----------------------------
      validacao_seeds:
        - item: "Módulo registrado na Central de Funcionalidades?"
          status: "pending"  # pending | ok | fail

        - item: "Funcionalidade registrada na Central de Funcionalidades?"
          status: "pending"

        - item: "TODAS as ações possuem permissão segregada?"
          status: "pending"

        - item: "Perfil Developer associado a TODAS as permissões?"
          status: "pending"

        - item: "Código de permissões segue padrão MODULO.ENTIDADE.ACAO?"
          status: "pending"

        - item: "Todas as permissões possuem endpoint_backend documentado?"
          status: "pending"

        - item: "Todas as permissões possuem uc_relacionado documentado?"
          status: "pending"

        - item: "Todas as permissões possuem funcionalidade_codigo correto?"
          status: "pending"

# =============================================
# 3. RELACIONAMENTOS GLOBAIS (OPCIONAL)
# =============================================
relacionamentos_globais:
  - origem: "tenants"
    cardinalidade: "1:N"
    destino: "nome_da_tabela"
    descricao: "Um tenant possui muitos registros de nome_da_tabela"

# =============================================
# 4. OBSERVAÇÕES E DECISÕES (OBRIGATÓRIO)
# =============================================
observacoes:
  - categoria: "Modelagem"
    descricao: "Decisões importantes de modelagem e justificativas"

  - categoria: "Performance"
    descricao: "Índices, cardinalidade, hotspots de consulta, etc."

  - categoria: "Migração"
    descricao: "Regras de migração de dados, compatibilidades e cuidados"

  - categoria: "RBAC"
    descricao: "Justificativa da segregação de permissões e perfis associados"

  - categoria: "Central de Funcionalidades"
    descricao: "Categoria, ícone e ordenação escolhidos para o módulo/funcionalidade"

# =============================================
# 5. HISTÓRICO DE ALTERAÇÕES (OBRIGATÓRIO)
# =============================================
historico:
  - versao: "2.0"
    data: "2026-01-13"
    autor: "Agência ALC - alc.dev.br + Claude (Agente de Governança)"
    descricao: |
      Versão 2.0 - Adições críticas:
      - seed.habilitado alterado para TRUE (OBRIGATÓRIO para todas as funcionalidades)
      - Seção central_funcionalidades adicionada (RF112 - registro obrigatório)
      - Seção permissoes atualizada com padrão MODULO.ENTIDADE.ACAO
      - Seção role_permissions adicionada (associação perfis x permissões)
      - Seção validacao_seeds adicionada (checklist de completude)
      - Perfil Developer OBRIGATÓRIO em todas as permissões (para testes)
      - Rastreabilidade completa: Permissão → UC → Endpoint → Funcionalidade

  - versao: "1.0"
    data: "YYYY-MM-DD"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Versão inicial do template em camadas (Core/App/Seed)"
