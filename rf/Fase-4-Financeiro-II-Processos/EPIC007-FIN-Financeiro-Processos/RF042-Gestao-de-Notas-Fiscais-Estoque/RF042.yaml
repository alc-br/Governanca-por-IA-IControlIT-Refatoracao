# RF042.yaml - Gestão de Notas Fiscais Estoque (Estruturado)
# Versão: 2.0 (Governança v2.0 - Sincronizado com RF042.md)
# Data: 2025-12-30
# Autor: Agência ALC - alc.dev.br

rf_id: RF042
rf_title: "Gestão de Notas Fiscais Estoque"
versao_governanca: "2.0"
data_migracao: "2025-12-30"
epic: "EPIC007-FIN-Financeiro-Processos"
fase: "Fase-4-Financeiro-II-Processos"

# ==============================================================================
# REGRAS DE NEGÓCIO
# ==============================================================================

regras_negocio:
  - id: "RN-RF042-001"
    titulo: "Importação Automática de E-mails com XML NFe"
    descricao: |
      Sistema DEVE monitorar automaticamente caixa de e-mail corporativa (ex: nfe@empresa.com)
      e importar todos os anexos XML de NFes recebidos via job Hangfire a cada 15 minutos.
    criticidade: "CRÍTICA"
    implementacao:
      backend: true
      frontend: false
      validacao_api: true
      validacao_ui: false
    validacao:
      tipo: "job_automatizado"
      mensagem_erro: "Falha ao conectar caixa de e-mail ou importar XML"
      http_code: 500

  - id: "RN-RF042-002"
    titulo: "Validação Automática na SEFAZ"
    descricao: |
      Toda NFe importada DEVE ser validada automaticamente junto à SEFAZ via WebService oficial
      para garantir autenticidade e status de autorização (100=Autorizada).
    criticidade: "CRÍTICA"
    implementacao:
      backend: true
      frontend: false
      validacao_api: true
      validacao_ui: false
    validacao:
      tipo: "webservice_externo"
      mensagem_erro: "NFe não autorizada pela SEFAZ (status ≠ 100)"
      http_code: 400

  - id: "RN-RF042-003"
    titulo: "OCR de PDFs com Fallback para Busca na SEFAZ"
    descricao: |
      Quando fornecedor envia apenas PDF (sem XML), sistema DEVE aplicar OCR inteligente
      com Tesseract + Azure Form Recognizer e, se detectar chave, buscar XML na SEFAZ.
    criticidade: "ALTA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "confianca_ocr"
      mensagem_erro: "OCR com confiança <85% - revisão manual necessária"
      http_code: 400

  - id: "RN-RF042-004"
    titulo: "Conciliação Automática NFe ↔ Pedido de Compra"
    descricao: |
      Sistema DEVE cruzar automaticamente NFe com pedido de compra correspondente
      via CNPJ fornecedor + número pedido, comparando itens com tolerâncias configuráveis.
    criticidade: "ALTA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "tolerancia_configuravel"
      mensagem_erro: "Divergência acima da tolerância (±5% qtd, ±2% valor)"
      http_code: 400

  - id: "RN-RF042-005"
    titulo: "Cálculo Automático de Impostos Conforme Legislação Vigente"
    descricao: |
      Sistema DEVE calcular automaticamente ICMS, IPI, PIS, COFINS, DIFAL, ISS
      com base em alíquotas vigentes, NCM, CFOP e UF origem/destino.
    criticidade: "ALTA"
    implementacao:
      backend: true
      frontend: false
      validacao_api: true
      validacao_ui: false
    validacao:
      tipo: "engine_fiscal"
      mensagem_erro: "NCM inválido ou alíquotas não encontradas"
      http_code: 400

  - id: "RN-RF042-006"
    titulo: "Rateio Proporcional de Frete por Peso ou Valor"
    descricao: |
      Frete total DEVE ser rateado entre itens proporcionalmente ao peso ou valor,
      impactando custo médio de estoque.
    criticidade: "MÉDIA"
    implementacao:
      backend: true
      frontend: false
      validacao_api: true
      validacao_ui: false
    validacao:
      tipo: "rateio_matematico"
      mensagem_erro: "Soma dos rateios ≠ frete total (tolerância ±R$ 0,10)"
      http_code: 400

  - id: "RN-RF042-007"
    titulo: "Lançamento Automático no Estoque Após Aprovação"
    descricao: |
      NFe aprovada DEVE gerar automaticamente movimentação ENTRADA_COMPRA,
      atualizando quantidade disponível e custo médio ponderado.
    criticidade: "CRÍTICA"
    implementacao:
      backend: true
      frontend: false
      validacao_api: true
      validacao_ui: false
    validacao:
      tipo: "transacao_atomica"
      mensagem_erro: "Falha ao lançar no estoque - movimentação revertida"
      http_code: 500

  - id: "RN-RF042-008"
    titulo: "Workflow de Aprovação com SLA Configurável"
    descricao: |
      NFes com divergências DEVEM seguir workflow multinível conforme valor:
      <R$ 500 (Comprador), R$ 500-5.000 (Comprador+Gestor), >R$ 5.000 (Comprador+Gestor+Financeiro).
    criticidade: "ALTA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "workflow_multinivel"
      mensagem_erro: "SLA vencido - escalação automática para superior"
      http_code: 400

  - id: "RN-RF042-009"
    titulo: "Geração Automática de DANFE em PDF/A com QR Code"
    descricao: |
      Sistema DEVE gerar DANFE em PDF/A-1b (ISO 19005-1) com QR Code
      para consulta SEFAZ e armazenamento 7 anos.
    criticidade: "MÉDIA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: false
    validacao:
      tipo: "pdf_a_compliance"
      mensagem_erro: "PDF não conforme PDF/A-1b"
      http_code: 500

  - id: "RN-RF042-010"
    titulo: "Detecção de Duplicatas por Chave de Acesso"
    descricao: |
      Sistema DEVE bloquear importação de NFes duplicadas verificando
      chave de acesso única por tenant (índice único: ChaveAcesso + ClienteId).
    criticidade: "CRÍTICA"
    implementacao:
      backend: true
      frontend: false
      validacao_api: true
      validacao_ui: false
    validacao:
      tipo: "unicidade"
      mensagem_erro: "NFe duplicada - já importada em {{date}} por {{user}}"
      http_code: 409

  - id: "RN-RF042-011"
    titulo: "Integração com ERP via API REST"
    descricao: |
      Sistema DEVE exportar automaticamente dados de NFes aprovadas
      para ERPs externos (SAP, TOTVS, Protheus) via API REST JSON.
    criticidade: "MÉDIA"
    implementacao:
      backend: true
      frontend: false
      validacao_api: true
      validacao_ui: false
    validacao:
      tipo: "retry_policy"
      mensagem_erro: "Falha na integração ERP após 5 tentativas"
      http_code: 500

  - id: "RN-RF042-012"
    titulo: "Alertas em Tempo Real via SignalR"
    descricao: |
      Sistema DEVE enviar notificações push em tempo real para usuários
      quando NFe importada, aprovada, rejeitada ou com divergência crítica.
    criticidade: "MÉDIA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: false
      validacao_ui: true
    validacao:
      tipo: "signalr_hub"
      mensagem_erro: "Notificação salva no banco (usuário offline)"
      http_code: 200

  - id: "RN-RF042-013"
    titulo: "Retenção de XML Original por 7 Anos (Legislação Fiscal)"
    descricao: |
      Sistema DEVE armazenar XML original em blob storage criptografado (AES-256)
      por 7 anos conforme legislação fiscal brasileira.
    criticidade: "CRÍTICA"
    implementacao:
      backend: true
      frontend: false
      validacao_api: true
      validacao_ui: false
    validacao:
      tipo: "criptografia_obrigatoria"
      mensagem_erro: "Falha ao armazenar XML no blob storage"
      http_code: 500

  - id: "RN-RF042-014"
    titulo: "Dashboard Executivo de Notas Fiscais"
    descricao: |
      Sistema DEVE fornecer dashboard visual com KPIs: volume mensal,
      top fornecedores, divergências pendentes, tempo médio aprovação.
    criticidade: "BAIXA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: false
      validacao_ui: true
    validacao:
      tipo: "performance"
      mensagem_erro: "Dashboard deve carregar <2 segundos"
      http_code: 200

  - id: "RN-RF042-015"
    titulo: "Multi-tenancy com Limite de NFes por Plano"
    descricao: |
      Sistema DEVE garantir isolamento completo por ClienteId com limites:
      Básico (1.000 NFes/mês), Profissional (5.000 NFes/mês), Enterprise (ilimitado).
    criticidade: "CRÍTICA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "quota_limit"
      mensagem_erro: "Limite de importações atingido ({{used}}/{{limit}})"
      http_code: 429

# ==============================================================================
# PERMISSÕES RBAC
# ==============================================================================

permissoes_rbac:
  - permission_code: "GES.NOTAS_FISCAIS_ESTOQUE.VIEW"
    descricao: "Visualizar lista e detalhes de NFes"
    roles_autorizadas:
      - "Comprador"
      - "Gestor"
      - "Financeiro"
      - "Auditor"
    endpoint: "GET /api/notas-fiscais-estoque"

  - permission_code: "GES.NOTAS_FISCAIS_ESTOQUE.IMPORT"
    descricao: "Importar XMLs/PDFs de NFes"
    roles_autorizadas:
      - "Comprador"
      - "Almoxarife"
    endpoint: "POST /api/notas-fiscais-estoque/import-xml"

  - permission_code: "GES.NOTAS_FISCAIS_ESTOQUE.APPROVE_MINOR"
    descricao: "Aprovar divergências <R$ 500"
    roles_autorizadas:
      - "Comprador"
    endpoint: "POST /api/notas-fiscais-estoque/{id}/aprovar"

  - permission_code: "GES.NOTAS_FISCAIS_ESTOQUE.APPROVE_MAJOR"
    descricao: "Aprovar divergências >R$ 500"
    roles_autorizadas:
      - "Gestor"
      - "Diretor"
    endpoint: "POST /api/notas-fiscais-estoque/{id}/aprovar"

  - permission_code: "GES.NOTAS_FISCAIS_ESTOQUE.REJECT"
    descricao: "Rejeitar NFes com problemas"
    roles_autorizadas:
      - "Comprador"
      - "Gestor"
    endpoint: "POST /api/notas-fiscais-estoque/{id}/rejeitar"

  - permission_code: "GES.NOTAS_FISCAIS_ESTOQUE.POST_INVENTORY"
    descricao: "Forçar lançamento manual no estoque"
    roles_autorizadas:
      - "Almoxarife"
      - "Gestor"
    endpoint: "POST /api/notas-fiscais-estoque/{id}/lancar-estoque"

  - permission_code: "GES.NOTAS_FISCAIS_ESTOQUE.CANCEL"
    descricao: "Cancelar NFe lançada (estorno)"
    roles_autorizadas:
      - "Gestor"
      - "Controller"
    endpoint: "DELETE /api/notas-fiscais-estoque/{id}"

  - permission_code: "GES.NOTAS_FISCAIS_ESTOQUE.EXPORT"
    descricao: "Exportar relatórios Excel/PDF"
    roles_autorizadas:
      - "Comprador"
      - "Gestor"
      - "Auditor"
    endpoint: "GET /api/notas-fiscais-estoque/export"

  - permission_code: "GES.NOTAS_FISCAIS_ESTOQUE.CONFIGURE"
    descricao: "Configurar tolerâncias, SLAs, integração ERP"
    roles_autorizadas:
      - "Super Admin"
      - "Diretor"
    endpoint: "PUT /api/notas-fiscais-estoque/configuracoes"

  - permission_code: "GES.NOTAS_FISCAIS_ESTOQUE.AUDIT"
    descricao: "Acessar logs de auditoria completos"
    roles_autorizadas:
      - "Auditor"
      - "Controller"
      - "Super Admin"
    endpoint: "GET /api/notas-fiscais-estoque/audit-logs"

# ==============================================================================
# API ENDPOINTS
# ==============================================================================

endpoints:
  - method: "GET"
    route: "/api/notas-fiscais-estoque"
    descricao: "Listar NFes com paginação, ordenação e filtros"
    autenticacao: true
    authorization_policy: "NotasFiscaisEstoqueView"
    request_dto: null
    response_dto: "PaginatedListDto<NotaFiscalEstoqueDto>"
    query_parameters:
      - "pageNumber (int, default: 1)"
      - "pageSize (int, default: 20, max: 100)"
      - "sortBy (string, default: DataEmissao)"
      - "sortDirection (string, asc/desc)"
      - "filtroFornecedor (Guid, optional)"
      - "filtroStatus (string, optional)"

  - method: "GET"
    route: "/api/notas-fiscais-estoque/{id}"
    descricao: "Consultar NFe por ID com detalhes completos"
    autenticacao: true
    authorization_policy: "NotasFiscaisEstoqueView"
    request_dto: null
    response_dto: "NotaFiscalEstoqueDetalhadoDto"

  - method: "POST"
    route: "/api/notas-fiscais-estoque/import-xml"
    descricao: "Importar NFe a partir de arquivo XML"
    autenticacao: true
    authorization_policy: "NotasFiscaisEstoqueImport"
    request_dto: "ImportarNFeXmlCommand"
    response_dto: "Guid"

  - method: "POST"
    route: "/api/notas-fiscais-estoque/import-pdf"
    descricao: "Importar NFe a partir de PDF escaneado (OCR)"
    autenticacao: true
    authorization_policy: "NotasFiscaisEstoqueImport"
    request_dto: "ImportarNFePdfCommand"
    response_dto: "Guid"

  - method: "POST"
    route: "/api/notas-fiscais-estoque/{id}/validar-sefaz"
    descricao: "Validar NFe junto à SEFAZ manualmente"
    autenticacao: true
    authorization_policy: "NotasFiscaisEstoqueView"
    request_dto: null
    response_dto: "ResultadoValidacaoSefazDto"

  - method: "POST"
    route: "/api/notas-fiscais-estoque/{id}/aprovar"
    descricao: "Aprovar NFe (com ou sem divergência)"
    autenticacao: true
    authorization_policy: "NotasFiscaisEstoqueApproveMinor ou NotasFiscaisEstoqueApproveMajor"
    request_dto: "AprovarNFeCommand"
    response_dto: "void"

  - method: "POST"
    route: "/api/notas-fiscais-estoque/{id}/rejeitar"
    descricao: "Rejeitar NFe (com motivo obrigatório)"
    autenticacao: true
    authorization_policy: "NotasFiscaisEstoqueReject"
    request_dto: "RejeitarNFeCommand"
    response_dto: "void"

  - method: "POST"
    route: "/api/notas-fiscais-estoque/{id}/lancar-estoque"
    descricao: "Forçar lançamento manual no estoque"
    autenticacao: true
    authorization_policy: "NotasFiscaisEstoquePostInventory"
    request_dto: null
    response_dto: "void"

  - method: "DELETE"
    route: "/api/notas-fiscais-estoque/{id}"
    descricao: "Cancelar NFe lançada (estorno)"
    autenticacao: true
    authorization_policy: "NotasFiscaisEstoqueCancel"
    request_dto: null
    response_dto: "void"

  - method: "GET"
    route: "/api/notas-fiscais-estoque/{id}/danfe"
    descricao: "Gerar DANFE em PDF/A"
    autenticacao: true
    authorization_policy: "NotasFiscaisEstoqueView"
    request_dto: null
    response_dto: "FileStreamResult (application/pdf)"

  - method: "GET"
    route: "/api/notas-fiscais-estoque/{id}/xml"
    descricao: "Download do XML original"
    autenticacao: true
    authorization_policy: "NotasFiscaisEstoqueView"
    request_dto: null
    response_dto: "FileStreamResult (application/xml)"

  - method: "GET"
    route: "/api/notas-fiscais-estoque/export"
    descricao: "Exportar relatório Excel/PDF"
    autenticacao: true
    authorization_policy: "NotasFiscaisEstoqueExport"
    request_dto: null
    response_dto: "FileStreamResult"
    query_parameters:
      - "formato (string, excel/pdf)"
      - "filtros iguais aos da listagem"

  - method: "PUT"
    route: "/api/notas-fiscais-estoque/configuracoes"
    descricao: "Configurar tolerâncias, SLAs, integração ERP"
    autenticacao: true
    authorization_policy: "NotasFiscaisEstoqueConfigure"
    request_dto: "ConfigurarNFeCommand"
    response_dto: "void"

# ==============================================================================
# KPIs E MÉTRICAS
# ==============================================================================

kpis:
  - nome: "Taxa de Importação Automática"
    descricao: "% de NFes importadas automaticamente via e-mail (sem upload manual)"
    meta: ">= 80%"
    log_obrigatorio: true
    frequencia_medicao: "diária"

  - nome: "Taxa de Validação SEFAZ Bem-Sucedida"
    descricao: "% de NFes validadas com sucesso na SEFAZ (status 100)"
    meta: ">= 95%"
    log_obrigatorio: true
    frequencia_medicao: "diária"

  - nome: "Taxa de Precisão OCR"
    descricao: "% de PDFs processados com OCR confiança ≥85%"
    meta: ">= 90%"
    log_obrigatorio: true
    frequencia_medicao: "semanal"

  - nome: "Taxa de Conciliação Automática"
    descricao: "% de NFes conciliadas automaticamente com pedido (sem divergência)"
    meta: ">= 70%"
    log_obrigatorio: true
    frequencia_medicao: "semanal"

  - nome: "Tempo Médio de Importação"
    descricao: "Tempo desde upload XML até registro criado no banco"
    meta: "<= 5s"
    log_obrigatorio: true
    frequencia_medicao: "diária"

  - nome: "Tempo Médio de Aprovação"
    descricao: "Tempo desde importação até aprovação final"
    meta: "<= 24h"
    log_obrigatorio: true
    frequencia_medicao: "semanal"

  - nome: "Taxa de Duplicatas Detectadas"
    descricao: "% de tentativas de importação de NFes duplicadas bloqueadas"
    meta: "100%"
    log_obrigatorio: true
    frequencia_medicao: "diária"

  - nome: "Taxa de Lançamento Automático"
    descricao: "% de NFes aprovadas lançadas automaticamente no estoque"
    meta: ">= 95%"
    log_obrigatorio: true
    frequencia_medicao: "semanal"

# ==============================================================================
# ALERTAS CRÍTICOS
# ==============================================================================

alertas:
  # Alertas de Sistema
  - evento: "Falha ao conectar e-mail IMAP"
    threshold: ">3 falhas consecutivas"
    severidade: "ALTA"
    canal_notificacao:
      - "email_ti"
      - "signalr_admin"

  - evento: "SEFAZ indisponível"
    threshold: ">5 falhas consecutivas em 1 hora"
    severidade: "CRÍTICA"
    canal_notificacao:
      - "email_ti"
      - "slack"
      - "sms"

  - evento: "OCR com taxa de erro alta"
    threshold: "<70% confiança em 10 PDFs consecutivos"
    severidade: "MÉDIA"
    canal_notificacao:
      - "email_responsavel"
      - "signalr"

  - evento: "Limite de importação atingido"
    threshold: "≥95% do limite mensal"
    severidade: "ALTA"
    canal_notificacao:
      - "email_cliente"
      - "signalr"
      - "badge"

  - evento: "Blob storage indisponível"
    threshold: "1 falha"
    severidade: "CRÍTICA"
    canal_notificacao:
      - "email_ti"
      - "slack"

  - evento: "Integração ERP falhando"
    threshold: ">5 falhas consecutivas"
    severidade: "ALTA"
    canal_notificacao:
      - "email_ti"
      - "slack"

  - evento: "SLA de aprovação vencido"
    threshold: ">24h pendente"
    severidade: "MÉDIA"
    canal_notificacao:
      - "email_gestor"
      - "signalr"

  - evento: "Divergência >R$ 10.000"
    threshold: "1 ocorrência"
    severidade: "ALTA"
    canal_notificacao:
      - "email_diretor"
      - "sms"

  # Alertas de Negócio
  - evento: "NFe com divergência detectada"
    threshold: "Valor >R$ 1.000 ou %divergência >10%"
    severidade: "MÉDIA"
    canal_notificacao:
      - "signalr_comprador"
      - "email"

  - evento: "NFe rejeitada pela SEFAZ"
    threshold: "Status ≠ 100"
    severidade: "ALTA"
    canal_notificacao:
      - "email_comprador"
      - "signalr"

  - evento: "Tentativa de importação de duplicata"
    threshold: "1 ocorrência"
    severidade: "BAIXA"
    canal_notificacao:
      - "log_auditoria"

  - evento: "NFe sem pedido vinculado"
    threshold: "NFe >R$ 5.000 sem pedido"
    severidade: "MÉDIA"
    canal_notificacao:
      - "email_comprador"

  - evento: "Frete muito alto"
    threshold: "Frete >30% do valor produtos"
    severidade: "MÉDIA"
    canal_notificacao:
      - "email_comprador"

  - evento: "Imposto calculado divergente"
    threshold: "Diferença >5% vs XML"
    severidade: "ALTA"
    canal_notificacao:
      - "email_fiscal"
      - "signalr"

# ==============================================================================
# DEPENDÊNCIAS
# ==============================================================================

dependencias:
  rfs_upstream:
    - rf_id: "RF008"
      nome: "Gestão de Fornecedores"
      tipo_dependencia: "CRÍTICA"
      descricao: "CNPJ do fornecedor DEVE existir antes de importar NFe"

    - rf_id: "RF010"
      nome: "Gestão de Produtos"
      tipo_dependencia: "CRÍTICA"
      descricao: "Produtos DEVEM estar cadastrados (ou criar automaticamente)"

    - rf_id: "RF019"
      nome: "Gestão de Pedidos de Compra"
      tipo_dependencia: "ALTA"
      descricao: "Necessário para conciliação NFe ↔ Pedido"

    - rf_id: "RF021"
      nome: "Gestão de Estoque"
      tipo_dependencia: "CRÍTICA"
      descricao: "Lançamento automático depende de tabela Estoque"

    - rf_id: "RF024"
      nome: "Gestão de Centros de Custo"
      tipo_dependencia: "MÉDIA"
      descricao: "Rateio de custos por CC (opcional)"

    - rf_id: "RF001"
      nome: "Parâmetros e Configurações"
      tipo_dependencia: "ALTA"
      descricao: "Tolerâncias, SLAs, limites de plano"

    - rf_id: "RF003"
      nome: "Auditoria"
      tipo_dependencia: "ALTA"
      descricao: "Log de todas as operações"

    - rf_id: "RF006"
      nome: "Gestão de Usuários"
      tipo_dependencia: "ALTA"
      descricao: "Workflow de aprovação, RBAC, notificações"

  bibliotecas_externas:
    backend:
      - nome: "Entity Framework Core"
        versao: "10.0"
        proposito: "ORM"

      - nome: "MediatR"
        versao: "12.0"
        proposito: "CQRS (Commands/Queries)"

      - nome: "FluentValidation"
        versao: "11.0"
        proposito: "Validação de dados"

      - nome: "Hangfire"
        versao: "1.8"
        proposito: "Jobs agendados (importação e-mail)"

      - nome: "Polly"
        versao: "8.0"
        proposito: "Retry policy para SEFAZ"

      - nome: "iTextSharp"
        versao: "5.5.13"
        proposito: "Geração de DANFE em PDF/A"

      - nome: "Tesseract"
        versao: "5.0"
        proposito: "OCR gratuito de PDFs"

      - nome: "Azure.AI.FormRecognizer"
        versao: "4.0"
        proposito: "OCR avançado (pago)"

      - nome: "Microsoft.AspNetCore.SignalR"
        versao: "7.0"
        proposito: "Notificações em tempo real"

      - nome: "Azure.Storage.Blobs"
        versao: "12.0"
        proposito: "Armazenamento de XMLs"

      - nome: "Azure.Security.KeyVault.Keys"
        versao: "4.5"
        proposito: "Gerenciamento de chaves criptografia"

    frontend:
      - nome: "@angular/material"
        versao: "19.0"
        proposito: "Componentes UI"

      - nome: "@jsverse/transloco"
        versao: "6.0"
        proposito: "Internacionalização (i18n)"

      - nome: "apexcharts"
        versao: "3.45"
        proposito: "Gráficos do dashboard"

      - nome: "ngx-file-drop"
        versao: "16.0"
        proposito: "Drag-and-drop de arquivos"

  integracoes_externas:
    - nome: "WebService SEFAZ"
      url: "https://nfe.fazenda.sp.gov.br/ws/"
      proposito: "Validação de NFes"
      tipo: "SOAP"

    - nome: "APIs ERPs"
      sistemas:
        - "SAP"
        - "TOTVS"
        - "Protheus"
      proposito: "Exportação automática de dados"
      tipo: "REST"

# ==============================================================================
# INTEGRAÇÕES OBRIGATÓRIAS
# ==============================================================================

integracoes_obrigatorias:
  - tipo: "i18n"
    namespace: "ges.notasFiscaisEstoque"
    idiomas:
      - "pt-BR"
      - "en-US"
      - "es-ES"
    fallback: "pt-BR → en-US → es-ES"

  - tipo: "auditoria"
    campos_obrigatorios:
      - "CriadoPor"
      - "CriadoEm"
      - "AlteradoPor"
      - "AlteradoEm"
      - "AprovadoPor"
      - "AprovadoEm"
    operacoes_auditadas:
      - "Importação de NFe"
      - "Validação SEFAZ"
      - "Aprovação"
      - "Rejeição"
      - "Lançamento estoque"
      - "Cancelamento"

  - tipo: "rbac"
    modulo: "GES.NOTAS_FISCAIS_ESTOQUE"
    total_permissoes: 10

  - tipo: "central_funcionalidades"
    codigo: "GES.NOTAS_FISCAIS_ESTOQUE"
    modulo: "Gestão"
    icone: "receipt_long"
    rota: "/gestao/notas-fiscais-estoque"
    ordem: 50

# ==============================================================================
# METADADOS
# ==============================================================================

metadados:
  total_regras_negocio: 15
  total_endpoints: 13
  total_permissoes: 10
  total_kpis: 8
  total_alertas: 14
  total_dependencias_rfs: 8
  complexidade: "MUITO_ALTA"
  estimativa_implementacao: "348h"
  risco_projeto: "ALTO"

# ==============================================================================
# CHANGELOG
# ==============================================================================

changelog:
  - versao: "2.0"
    data: "2025-12-30"
    descricao: "Migração v1.0 → v2.0 com separação RF/RL (governança v2.0)"
    autor: "Agência ALC - alc.dev.br"
    alteracoes:
      - "Criação de RF042.yaml sincronizado 100% com RF042.md"
      - "15 regras de negócio estruturadas"
      - "13 endpoints API documentados"
      - "10 permissões RBAC definidas"
      - "8 KPIs e 14 alertas configurados"
      - "Dependências de 8 RFs mapeadas"
      - "Integrações obrigatórias especificadas"
