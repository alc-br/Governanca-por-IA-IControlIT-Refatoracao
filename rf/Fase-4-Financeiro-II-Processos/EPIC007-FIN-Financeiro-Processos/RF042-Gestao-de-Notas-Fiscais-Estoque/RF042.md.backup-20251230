# RF042 - GestÃ£o de Notas Fiscais Estoque

**Fase:** 2 - ServiÃ§os Essenciais
**EPIC:** EPIC003-GES - GestÃ£o
**MÃ³dulo:** GestÃ£o
**ResponsÃ¡vel:** Architect Agent
**Data CriaÃ§Ã£o:** 17/12/2025
**VersÃ£o:** 1.0
**Status:** EspecificaÃ§Ã£o Completa

---

## SEÃ‡ÃƒO 1: RESUMO EXECUTIVO

### 1.1 DescriÃ§Ã£o Geral

O **RF042 - GestÃ£o de Notas Fiscais Estoque** implementa o sistema completo de gerenciamento de notas fiscais de entrada de estoque (NFe), incluindo importaÃ§Ã£o automatizada de arquivos XML, validaÃ§Ã£o automÃ¡tica junto Ã  SEFAZ, OCR de PDFs escaneados, lanÃ§amento automÃ¡tico no estoque, conciliaÃ§Ã£o com pedidos de compra, cÃ¡lculo de impostos (ICMS, IPI, PIS, COFINS), rateio de frete, e rastreamento de divergÃªncias entre pedido vs recebido. O sistema garante conformidade fiscal, reduz erros manuais de digitaÃ§Ã£o, acelera o processo de entrada de mercadorias e fornece visibilidade completa da cadeia de suprimentos desde a emissÃ£o da NFe pelo fornecedor atÃ© a entrada no estoque.

### 1.2 ImportÃ¢ncia EstratÃ©gica

A gestÃ£o eficaz de notas fiscais de estoque Ã© crucial para:
- **Conformidade Fiscal** garantindo que todas as NFes sejam vÃ¡lidas, autorizadas pela SEFAZ e armazenadas por 7 anos conforme legislaÃ§Ã£o
- **AutomaÃ§Ã£o de Processos** eliminando digitaÃ§Ã£o manual de NFes e reduzindo erros humanos em 95%
- **ConciliaÃ§Ã£o Financeira** comparando pedido de compra vs NFe vs entrada fÃ­sica de mercadorias
- **GestÃ£o de Impostos** calculando automaticamente todos os tributos (ICMS, IPI, PIS, COFINS, DIFAL) com base nas alÃ­quotas vigentes
- **Visibilidade de Cadeia** rastreando todo o ciclo desde emissÃ£o da NFe atÃ© entrada no estoque com alertas de atrasos
- **Auditoria e Compliance** mantendo histÃ³rico completo de todas as operaÃ§Ãµes com rastreabilidade para auditorias internas e externas
- **ReduÃ§Ã£o de Custos** identificando divergÃªncias de preÃ§os, quantidades e condiÃ§Ãµes comerciais antes da aprovaÃ§Ã£o de pagamento

### 1.3 ComparaÃ§Ã£o Sistema Legado vs. Modernizado

| Aspecto | Sistema Legado | Sistema Modernizado |
|---------|----------------|---------------------|
| **ImportaÃ§Ã£o de XML** | Upload manual arquivo por arquivo | Drag-and-drop mÃºltiplos arquivos + importaÃ§Ã£o automÃ¡tica de e-mail |
| **ValidaÃ§Ã£o SEFAZ** | NÃ£o suportado (validaÃ§Ã£o manual) | ValidaÃ§Ã£o automÃ¡tica em tempo real via WebService SEFAZ |
| **OCR de PDFs** | NÃ£o suportado | OCR com IA para extrair dados de PDFs escaneados (Tesseract + Azure Form Recognizer) |
| **ConciliaÃ§Ã£o com Pedidos** | Manual, planilhas externas | Matching automÃ¡tico NFe â†” Pedido de Compra com alertas de divergÃªncia |
| **CÃ¡lculo de Impostos** | Manual ou via stored procedures | CÃ¡lculo automÃ¡tico com engine fiscal atualizada (alÃ­quotas CONFAZ) |
| **Rateio de Frete** | NÃ£o suportado | Rateio proporcional por peso/valor com mÃºltiplos critÃ©rios |
| **LanÃ§amento no Estoque** | Manual via tela separada | LanÃ§amento automÃ¡tico com regras de aprovaÃ§Ã£o configurÃ¡veis |
| **Alertas de DivergÃªncia** | E-mails esporÃ¡dicos | Alertas em tempo real (SignalR) para comprador responsÃ¡vel |
| **DANFE** | GeraÃ§Ã£o manual externa | GeraÃ§Ã£o automÃ¡tica de DANFE em PDF/A com QR Code |
| **Auditoria** | Logs bÃ¡sicos | Rastreabilidade completa de todas as etapas com timeline visual |
| **Multi-tenant** | NÃ£o suportado | Isolamento completo por fornecedor com limite de 1.000 NFes/mÃªs no plano bÃ¡sico |

### 1.4 Principais Funcionalidades

1. **ImportaÃ§Ã£o Automatizada de XML NFe**
   - Upload via drag-and-drop de mÃºltiplos arquivos XML
   - ImportaÃ§Ã£o automÃ¡tica de e-mails (monitora caixa de entrada de nfe@empresa.com)
   - IntegraÃ§Ã£o com portais de fornecedores (API REST)
   - Parser robusto que extrai todos os campos da NFe conforme layout SEFAZ v4.0
   - DetecÃ§Ã£o de duplicatas (evita importaÃ§Ã£o da mesma NFe 2x)

2. **ValidaÃ§Ã£o AutomÃ¡tica SEFAZ**
   - Consulta chave de acesso na base da SEFAZ via WebService
   - Valida: autorizaÃ§Ã£o, cancelamento, inutilizaÃ§Ã£o
   - Verifica assinatura digital do XML
   - Detecta NFes canceladas/denegadas
   - Retry automÃ¡tico em caso de indisponibilidade da SEFAZ

3. **OCR de PDFs Escaneados**
   - Upload de PDF quando XML nÃ£o disponÃ­vel
   - OCR inteligente com Tesseract + Azure Form Recognizer
   - ExtraÃ§Ã£o automÃ¡tica: chave, nÃºmero, emitente, itens, valores
   - ValidaÃ§Ã£o cruzada: se detectar chave de acesso, busca XML na SEFAZ
   - Taxa de precisÃ£o >95% em PDFs de boa qualidade

4. **ConciliaÃ§Ã£o com Pedidos de Compra**
   - Matching automÃ¡tico via CNPJ fornecedor + nÃºmero do pedido
   - ComparaÃ§Ã£o item a item: cÃ³digo, descriÃ§Ã£o, quantidade, valor unitÃ¡rio
   - Alertas de divergÃªncia:
     - Quantidade diferente (Â±5% tolerÃ¢ncia configurÃ¡vel)
     - PreÃ§o diferente (Â±2% tolerÃ¢ncia configurÃ¡vel)
     - Itens nÃ£o previstos no pedido
     - Itens do pedido nÃ£o entregues
   - Workflow de aprovaÃ§Ã£o para divergÃªncias >R$ 1.000

5. **CÃ¡lculo AutomÃ¡tico de Impostos**
   - ICMS (prÃ³prio, substituiÃ§Ã£o tributÃ¡ria, diferencial de alÃ­quota)
   - IPI (Tabela TIPI atualizada)
   - PIS/COFINS (cumulativo, nÃ£o-cumulativo)
   - ISS (para serviÃ§os)
   - DIFAL (diferencial de alÃ­quota entre estados)
   - Base de cÃ¡lculo respeitando regras de reduÃ§Ã£o de base

6. **Rateio de Frete e Despesas AcessÃ³rias**
   - Frete rateado proporcionalmente ao peso ou valor de cada item
   - Seguro, despesas aduaneiras, outras despesas
   - CritÃ©rios configurÃ¡veis: peso, valor, quantidade, percentual fixo
   - Impacto no custo mÃ©dio de estoque

7. **LanÃ§amento AutomÃ¡tico no Estoque**
   - Entrada automÃ¡tica apÃ³s aprovaÃ§Ã£o da NFe
   - Atualiza quantidade, custo mÃ©dio, Ãºltima compra
   - Gera movimentaÃ§Ã£o de estoque (rastreÃ¡vel)
   - Notifica almoxarifado para recebimento fÃ­sico
   - IntegraÃ§Ã£o com cÃ³digo de barras para conferÃªncia

8. **GestÃ£o de DivergÃªncias**
   - Dashboard de NFes pendentes de aprovaÃ§Ã£o
   - Workflow: Comprador â†’ Gestor â†’ Financeiro
   - ComentÃ¡rios e anexos em cada etapa
   - SLA configurÃ¡vel (ex: aprovar em 24h)
   - RelatÃ³rio de divergÃªncias por fornecedor

9. **GeraÃ§Ã£o de DANFE**
   - PDF/A com QR Code para consulta SEFAZ
   - Marca d'Ã¡gua em NFes canceladas
   - ImpressÃ£o em lote
   - Envio por e-mail para fornecedor/transportadora

10. **IntegraÃ§Ãµes MandatÃ³rias**
    - **Central de Funcionalidades** - Registro da feature "GestÃ£o de NFes Estoque"
    - **InternacionalizaÃ§Ã£o (i18n)** - Todas as mensagens em pt-BR, en-US, es-ES
    - **Auditoria** - Log de todas as importaÃ§Ãµes, validaÃ§Ãµes, aprovaÃ§Ãµes, lanÃ§amentos
    - **Controle de Acesso (RBAC)** - PermissÃµes: importar, aprovar, lanÃ§ar, cancelar, visualizar

---

## SEÃ‡ÃƒO 2: REGRAS DE NEGÃ“CIO

### RN001 - ImportaÃ§Ã£o AutomÃ¡tica de E-mails com XML NFe

**DescriÃ§Ã£o:**
O sistema monitora automaticamente uma caixa de e-mail corporativa (ex: nfe@empresa.com) e importa todos os anexos XML de notas fiscais recebidos.

**Justificativa:**
Eliminar trabalho manual de download de e-mails e upload individual de XMLs, garantindo que nenhuma NFe seja perdida.

**ImplementaÃ§Ã£o:**
- Hangfire job a cada 15 minutos conecta via IMAP/Exchange na caixa nfe@empresa.com
- Busca e-mails nÃ£o lidos com assunto contendo "NFe", "Nota Fiscal", "XML"
- Extrai todos os anexos com extensÃ£o .xml
- Valida se XML Ã© realmente uma NFe (tag raiz <nfeProc> ou <NFe>)
- Importa automaticamente e marca e-mail como lido
- Se importaÃ§Ã£o falhar, marca e-mail como nÃ£o lido para retry
- Armazena XML original em blob storage (7 anos de retenÃ§Ã£o)

**Exemplo:**
```
Hangfire Job: ImportarNFesPorEmailJob
ExecuÃ§Ã£o: A cada 15 minutos

E-mail Processado:
De: fornecedor@empresa.com.br
Assunto: NFe 12345 - Pedido 98765
Anexos:
  - NFe_35250112345678000199550010000123451000123456.xml (23 KB) âœ…
  - Boleto_12345.pdf (120 KB) âŒ (ignorado)

Parsing do XML:
- Chave de Acesso: 35250112345678000199550010000123451000123456
- Emitente: FORNECEDOR LTDA (CNPJ 12.345.678/0001-99)
- DestinatÃ¡rio: MINHA EMPRESA LTDA (CNPJ 98.765.432/0001-00)
- Valor Total: R$ 12.345,67
- Itens: 15 produtos

ValidaÃ§Ã£o SEFAZ:
- Status: Autorizado
- Data AutorizaÃ§Ã£o: 15/12/2025 10:32:45
- Protocolo: 135250000123456

ConciliaÃ§Ã£o Pedido:
- Pedido Encontrado: #98765 (CNPJ 12.345.678/0001-99)
- Match: 15/15 itens
- DivergÃªncias: Nenhuma
- Status: AprovaÃ§Ã£o AutomÃ¡tica

LanÃ§amento Estoque:
- 15 movimentaÃ§Ãµes criadas
- Custo mÃ©dio atualizado
- NotificaÃ§Ã£o enviada para almoxarifado

Status Final: Processado com sucesso em 3,2 segundos
```

**ValidaÃ§Ãµes:**
- âœ… Caixa de e-mail deve estar acessÃ­vel (credenciais vÃ¡lidas)
- âœ… XML deve ser vÃ¡lido conforme schema SEFAZ
- âœ… CNPJ destinatÃ¡rio deve pertencer ao fornecedor logado (multi-tenancy)
- âœ… NFe nÃ£o pode estar duplicada (chave de acesso Ãºnica)

---

### RN002 - ValidaÃ§Ã£o AutomÃ¡tica na SEFAZ

**DescriÃ§Ã£o:**
Toda NFe importada Ã© validada automaticamente junto Ã  base da SEFAZ via WebService oficial para garantir autenticidade e status de autorizaÃ§Ã£o.

**Justificativa:**
Evitar fraudes com NFes falsas ou canceladas, garantindo conformidade fiscal e seguranÃ§a jurÃ­dica.

**ImplementaÃ§Ã£o:**
- Consulta WebService SEFAZ: https://nfe.fazenda.sp.gov.br/ws/nfeconsultaprotocolo4.asmx
- Envia chave de acesso (44 dÃ­gitos)
- Recebe: status (100=Autorizada, 101=Cancelada, 110=Denegada, etc.)
- Armazena protocolo de autorizaÃ§Ã£o e data/hora
- Se status â‰  100, marca NFe como "InvÃ¡lida" e bloqueia lanÃ§amento
- Retry automÃ¡tico se SEFAZ indisponÃ­vel (mÃ¡x 3 tentativas com backoff exponencial)
- Cache de 1 hora para evitar consultas repetidas da mesma chave

**Exemplo:**
```
NFe Importada:
Chave: 35250112345678000199550010000123451000123456
UF: SÃ£o Paulo (35)
Ambiente: ProduÃ§Ã£o (1)

Consulta SEFAZ:
URL: https://nfe.fazenda.sp.gov.br/ws/nfeconsultaprotocolo4.asmx
Request XML:
<consStatServNFe xmlns="http://www.portalfiscal.inf.br/nfe">
  <tpAmb>1</tpAmb>
  <cUF>35</cUF>
  <xServ>STATUS</xServ>
</consStatServNFe>

Response:
<retConsSitNFe>
  <cStat>100</cStat>
  <xMotivo>Autorizado o uso da NF-e</xMotivo>
  <chNFe>35250112345678000199550010000123451000123456</chNFe>
  <protNFe>
    <infProt>
      <tpAmb>1</tpAmb>
      <verAplic>SP_NFE_PL009_V4.00</verAplic>
      <chNFe>35250112345678000199550010000123451000123456</chNFe>
      <dhRecbto>2025-12-15T10:32:45-03:00</dhRecbto>
      <nProt>135250000123456</nProt>
      <digVal>xyzABC123...</digVal>
      <cStat>100</cStat>
      <xMotivo>Autorizado o uso da NF-e</xMotivo>
    </infProt>
  </protNFe>
</retConsSitNFe>

Resultado:
âœ… NFe AUTORIZADA
Protocolo: 135250000123456
Data AutorizaÃ§Ã£o: 15/12/2025 10:32:45
Digest: xyzABC123...
Status: Liberada para lanÃ§amento
```

**ValidaÃ§Ãµes:**
- âœ… Chave de acesso deve ter exatamente 44 dÃ­gitos
- âœ… Status SEFAZ deve ser 100 (Autorizada) para prosseguir
- âœ… Data de autorizaÃ§Ã£o deve ser â‰¤ data atual
- âœ… Assinatura digital deve ser vÃ¡lida

---

### RN003 - OCR de PDFs com Fallback para Busca na SEFAZ

**DescriÃ§Ã£o:**
Quando fornecedor envia apenas PDF (sem XML), sistema aplica OCR para extrair dados e, se detectar chave de acesso, busca XML oficial na SEFAZ.

**Justificativa:**
Muitos fornecedores pequenos enviam apenas o DANFE em PDF. OCR + busca SEFAZ recupera dados completos.

**ImplementaÃ§Ã£o:**
- Upload de PDF via interface
- PrÃ©-processamento: conversÃ£o para imagem de alta resoluÃ§Ã£o (300 DPI)
- OCR duplo:
  - Tesseract (gratuito, rÃ¡pido, boa precisÃ£o em PDFs de qualidade)
  - Azure Form Recognizer (pago, alta precisÃ£o, treinado em DANFEs)
- Busca padrÃ£o regex para chave de acesso (44 dÃ­gitos)
- Se chave encontrada: consulta SEFAZ para download do XML oficial
- Se chave NÃƒO encontrada: extrai manualmente nÃºmero, CNPJ, itens, valores
- ConfianÃ§a mÃ­nima: 85% (abaixo disso, solicita revisÃ£o manual)

**Exemplo:**
```
Upload de PDF:
Arquivo: DANFE_Fornecedor_12345.pdf
Tamanho: 234 KB
PÃ¡ginas: 2

PrÃ©-processamento:
- ConversÃ£o PDF â†’ PNG (300 DPI)
- Melhoria de contraste e nitidez
- RemoÃ§Ã£o de ruÃ­do

OCR com Tesseract:
Texto ExtraÃ­do:
"DANFE
Documento Auxiliar da Nota Fiscal EletrÃ´nica
FORNECEDOR LTDA
CNPJ: 12.345.678/0001-99
...
CHAVE DE ACESSO
3525 0112 3456 7800 0199 5500 1000 0123 4510 0012 3456
..."

ExtraÃ§Ã£o de Chave:
Chave Detectada: 35250112345678000199550010000123451000123456
ConfianÃ§a: 98%

Busca na SEFAZ:
Request: NFeDistribuicaoDFe (WebService)
Chave: 35250112345678000199550010000123456
Response: XML completo da NFe (23 KB)

Parsing do XML:
âœ… Todos os dados extraÃ­dos com 100% de precisÃ£o
âœ… 15 itens processados
âœ… Impostos calculados automaticamente

Status: PDF processado com sucesso via OCR + SEFAZ
Tempo total: 8,5 segundos
```

**ValidaÃ§Ãµes:**
- âœ… PDF deve ser legÃ­vel (nÃ£o corrompido)
- âœ… ConfianÃ§a do OCR â‰¥85%
- âœ… Se chave detectada, XML SEFAZ deve ser encontrado
- âœ… CNPJ emitente no PDF = CNPJ no XML

---

### RN004 - ConciliaÃ§Ã£o AutomÃ¡tica NFe â†” Pedido de Compra

**DescriÃ§Ã£o:**
Sistema cruza automaticamente NFe recebida com pedido de compra correspondente, validando CNPJ, itens, quantidades e valores.

**Justificativa:**
Detectar divergÃªncias antes do pagamento, evitando pagamentos incorretos e garantindo conformidade com o pedido.

**ImplementaÃ§Ã£o:**
- Matching por: CNPJ fornecedor + NÃºmero do Pedido (campo xPed da NFe) OU CNPJ + Data + Valor aproximado
- ComparaÃ§Ã£o item a item:
  - CÃ³digo do produto (cProd)
  - Quantidade (qCom vs qPed)
  - Valor unitÃ¡rio (vUnCom vs vUnPed)
  - Valor total (vProd vs vTotalPed)
- TolerÃ¢ncias configurÃ¡veis:
  - Quantidade: Â±5% (ex: pedido 100, aceita 95-105)
  - Valor: Â±2% (ex: pedido R$ 100, aceita R$ 98-102)
- Se divergÃªncia >tolerÃ¢ncia: cria alerta e encaminha para aprovaÃ§Ã£o manual
- Se divergÃªncia <tolerÃ¢ncia: aprova automaticamente

**Exemplo:**
```
NFe Recebida:
NÃºmero: 123456
Emitente: FORNECEDOR LTDA (CNPJ 12.345.678/0001-99)
Valor Total: R$ 12.450,00
Itens: 15

Busca de Pedido:
CritÃ©rio 1: CNPJ 12.345.678/0001-99 + xPed = "98765"
Pedido Encontrado: #98765
Comprador: JoÃ£o Silva
Data: 01/12/2025
Valor: R$ 12.300,00
Itens: 15

ComparaÃ§Ã£o Item a Item:

Item 1:
Pedido: Mouse USB (cÃ³d 1001) | Qtd: 50 | R$ 25,00 | Total: R$ 1.250,00
NFe:    Mouse USB (cÃ³d 1001) | Qtd: 50 | R$ 25,00 | Total: R$ 1.250,00
Status: âœ… Match perfeito

Item 2:
Pedido: Teclado (cÃ³d 2002) | Qtd: 30 | R$ 80,00 | Total: R$ 2.400,00
NFe:    Teclado (cÃ³d 2002) | Qtd: 30 | R$ 85,00 | Total: R$ 2.550,00
DivergÃªncia: Valor unitÃ¡rio +6,25% (R$ 5,00 a mais)
TolerÃ¢ncia: 2%
Status: âš ï¸ DIVERGÃŠNCIA - Requer aprovaÃ§Ã£o

Item 3:
Pedido: Monitor 24" (cÃ³d 3003) | Qtd: 20 | R$ 650,00 | Total: R$ 13.000,00
NFe:    Monitor 24" (cÃ³d 3003) | Qtd: 22 | R$ 650,00 | Total: R$ 14.300,00
DivergÃªncia: Quantidade +10% (2 unidades a mais)
TolerÃ¢ncia: 5%
Status: âš ï¸ DIVERGÃŠNCIA - Requer aprovaÃ§Ã£o

Resumo:
âœ… 13 itens OK
âš ï¸ 2 itens com divergÃªncia
DivergÃªncia Total: R$ 150,00 (1,2% do pedido)

AÃ§Ã£o AutomÃ¡tica:
- Alerta enviado para comprador JoÃ£o Silva
- E-mail para gestor de compras
- Workflow: Aguardando aprovaÃ§Ã£o
- SLA: 24 horas
```

**ValidaÃ§Ãµes:**
- âœ… Pedido deve existir e estar ativo
- âœ… CNPJ emitente = CNPJ fornecedor do pedido
- âœ… Todos os itens da NFe devem estar no pedido (ou ser aprovados como "item extra")
- âœ… DivergÃªncias acima da tolerÃ¢ncia exigem justificativa

---

### RN005 - CÃ¡lculo AutomÃ¡tico de Impostos Conforme LegislaÃ§Ã£o Vigente

**DescriÃ§Ã£o:**
Sistema calcula automaticamente todos os impostos (ICMS, IPI, PIS, COFINS, DIFAL) com base nas alÃ­quotas vigentes e natureza da operaÃ§Ã£o.

**Justificativa:**
Garantir conformidade fiscal, evitar erros de cÃ¡lculo manual e facilitar auditoria.

**ImplementaÃ§Ã£o:**
- Engine fiscal com tabelas de alÃ­quotas atualizadas mensalmente (fonte: CONFAZ, RFB)
- Regras por UF origem, UF destino, NCM, CFOP
- ICMS:
  - PrÃ³prio (vBC, pICMS, vICMS)
  - SubstituiÃ§Ã£o TributÃ¡ria (vBCST, pICMSST, vICMSST)
  - Diferencial de AlÃ­quota - DIFAL para estados diferentes
- IPI: Tabela TIPI por NCM
- PIS/COFINS: Regime cumulativo vs nÃ£o-cumulativo (CST)
- ReduÃ§Ã£o de base de cÃ¡lculo quando aplicÃ¡vel
- IsenÃ§Ãµes e imunidades

**Exemplo:**
```
Item da NFe:
Produto: Notebook Dell Inspiron 15
NCM: 8471.30.12
CFOP: 5.102 (Venda de mercadoria adquirida de terceiros)
UF Origem: SP
UF Destino: RJ
Valor: R$ 3.000,00

CÃ¡lculo ICMS:
- AlÃ­quota ICMS SP: 18%
- AlÃ­quota ICMS RJ: 20%
- DIFAL (diferencial): 20% - 18% = 2%
- Base de CÃ¡lculo: R$ 3.000,00
- ICMS PrÃ³prio (SP): R$ 3.000 Ã— 18% = R$ 540,00
- ICMS DIFAL (RJ): R$ 3.000 Ã— 2% = R$ 60,00
- ICMS Total: R$ 600,00

CÃ¡lculo IPI:
- NCM 8471.30.12: AlÃ­quota 0% (InformÃ¡tica - Lei 8.248/91)
- Base de CÃ¡lculo: R$ 3.000,00
- IPI: R$ 0,00

CÃ¡lculo PIS/COFINS:
- Regime: NÃ£o-cumulativo (empresa Lucro Real)
- PIS: R$ 3.000 Ã— 1,65% = R$ 49,50
- COFINS: R$ 3.000 Ã— 7,6% = R$ 228,00

Resumo do Item:
- Valor Produto: R$ 3.000,00
- ICMS: R$ 600,00
- IPI: R$ 0,00
- PIS: R$ 49,50
- COFINS: R$ 228,00
- Total Tributos: R$ 877,50 (29,25%)
- Valor Final: R$ 3.877,50
```

**ValidaÃ§Ãµes:**
- âœ… NCM deve ser vÃ¡lido (8 dÃ­gitos)
- âœ… CFOP deve existir na tabela de CFOPs
- âœ… AlÃ­quotas devem ser da competÃªncia correta (vigentes na data da NFe)
- âœ… Base de cÃ¡lculo nÃ£o pode ser negativa

---

### RN006 - Rateio Proporcional de Frete por Peso ou Valor

**DescriÃ§Ã£o:**
Valor do frete total da NFe Ã© rateado entre os itens proporcionalmente ao peso ou valor de cada um, impactando o custo mÃ©dio de estoque.

**Justificativa:**
Custo mÃ©dio correto do produto deve incluir frete proporcional, nÃ£o apenas o valor do item.

**ImplementaÃ§Ã£o:**
- Frete total extraÃ­do do campo vFrete da NFe
- CritÃ©rio de rateio configurÃ¡vel por empresa:
  - Por peso: (peso_item / peso_total) Ã— frete_total
  - Por valor: (valor_item / valor_total) Ã— frete_total
  - Por quantidade: (qtd_item / qtd_total) Ã— frete_total
- Arredondamento: Ãºltimos centavos ajustados no item de maior valor
- Custo mÃ©dio atualizado: (valor_item + frete_rateado + outras_despesas) / quantidade

**Exemplo:**
```
NFe com Frete:
Frete Total: R$ 500,00
Seguro: R$ 50,00
Valor Total Produtos: R$ 10.000,00
Peso Total: 250 kg
Itens: 3

Item 1: Mouse (50 unidades)
- Valor: R$ 1.250,00 (12,5% do total)
- Peso: 5 kg (2% do total)
- Rateio Frete (por valor): R$ 500 Ã— 12,5% = R$ 62,50
- Rateio Seguro (por valor): R$ 50 Ã— 12,5% = R$ 6,25
- Custo UnitÃ¡rio: (R$ 1.250 + R$ 62,50 + R$ 6,25) / 50 = R$ 26,375 â‰ˆ R$ 26,38

Item 2: Teclado (30 unidades)
- Valor: R$ 2.400,00 (24% do total)
- Peso: 15 kg (6% do total)
- Rateio Frete (por valor): R$ 500 Ã— 24% = R$ 120,00
- Rateio Seguro (por valor): R$ 50 Ã— 24% = R$ 12,00
- Custo UnitÃ¡rio: (R$ 2.400 + R$ 120 + R$ 12) / 30 = R$ 84,40

Item 3: Monitor (20 unidades)
- Valor: R$ 6.350,00 (63,5% do total)
- Peso: 230 kg (92% do total)
- Rateio Frete (por valor): R$ 500 Ã— 63,5% = R$ 317,50
- Rateio Seguro (por valor): R$ 50 Ã— 63,5% = R$ 31,75
- Custo UnitÃ¡rio: (R$ 6.350 + R$ 317,50 + R$ 31,75) / 20 = R$ 334,96

VerificaÃ§Ã£o:
R$ 62,50 + R$ 120,00 + R$ 317,50 = R$ 500,00 âœ…
R$ 6,25 + R$ 12,00 + R$ 31,75 = R$ 50,00 âœ…
```

**ValidaÃ§Ãµes:**
- âœ… Soma dos rateios = frete total (tolerÃ¢ncia Â±R$ 0,10)
- âœ… CritÃ©rio de rateio deve estar configurado
- âœ… Peso/valor dos itens nÃ£o pode ser zero

---

### RN007 - LanÃ§amento AutomÃ¡tico no Estoque ApÃ³s AprovaÃ§Ã£o

**DescriÃ§Ã£o:**
NFe aprovada gera automaticamente movimentaÃ§Ã£o de entrada no estoque, atualizando quantidade disponÃ­vel e custo mÃ©dio.

**Justificativa:**
Eliminar digitaÃ§Ã£o manual de entrada de estoque, reduzir erros e garantir sincronia NFe â†” Estoque.

**ImplementaÃ§Ã£o:**
- Trigger apÃ³s aprovaÃ§Ã£o final da NFe
- Cria movimentaÃ§Ã£o tipo "ENTRADA_COMPRA" para cada item
- Atualiza tabela Estoque:
  - Quantidade += quantidade_nfe
  - Custo_Medio = (estoque_atual Ã— custo_atual + qtd_nfe Ã— custo_nfe) / (estoque_atual + qtd_nfe)
  - Data_Ultima_Compra = data_nfe
  - Id_Ultima_NFe = id_nfe
- Gera notificaÃ§Ã£o para almoxarifado: "Mercadoria aguardando recebimento fÃ­sico"
- Se produto nÃ£o existe: cria automaticamente com dados da NFe
- Rastreabilidade: cada movimentaÃ§Ã£o vinculada Ã  NFe original

**Exemplo:**
```
NFe Aprovada:
NÃºmero: 123456
Data: 15/12/2025
Fornecedor: FORNECEDOR LTDA

Item 1: Mouse USB (cÃ³d 1001)
Quantidade NFe: 50 unidades
Custo UnitÃ¡rio NFe: R$ 26,38 (incluindo frete rateado)

Estoque Atual (antes):
Produto: Mouse USB (cÃ³d 1001)
Quantidade: 150 unidades
Custo MÃ©dio: R$ 24,50
Ãšltima Compra: 01/11/2025

CÃ¡lculo Novo Custo MÃ©dio:
Estoque Valor Atual: 150 Ã— R$ 24,50 = R$ 3.675,00
Entrada Valor: 50 Ã— R$ 26,38 = R$ 1.319,00
Total: R$ 3.675 + R$ 1.319 = R$ 4.994,00
Quantidade Total: 150 + 50 = 200
Novo Custo MÃ©dio: R$ 4.994 / 200 = R$ 24,97

Estoque Atualizado (depois):
Produto: Mouse USB (cÃ³d 1001)
Quantidade: 200 unidades âœ…
Custo MÃ©dio: R$ 24,97 âœ…
Ãšltima Compra: 15/12/2025 âœ…
Id Ãšltima NFe: 123456 âœ…

MovimentaÃ§Ã£o Criada:
Id: MOV-2025-12345
Tipo: ENTRADA_COMPRA
Data: 15/12/2025 14:30:15
Produto: Mouse USB (1001)
Quantidade: +50
Custo UnitÃ¡rio: R$ 26,38
NFe: 123456
UsuÃ¡rio: Sistema (importaÃ§Ã£o automÃ¡tica)
Status: Aguardando Recebimento FÃ­sico

NotificaÃ§Ã£o Enviada:
Para: almoxarifado@empresa.com
Assunto: Mercadoria Aguardando Recebimento - NFe 123456
Mensagem: "50 unidades de Mouse USB chegaram. NFe 123456 aprovada. Receba fisicamente e confirme no sistema."
```

**ValidaÃ§Ãµes:**
- âœ… NFe deve estar aprovada (status = "Aprovada")
- âœ… Produto deve existir ou ser criado automaticamente
- âœ… Quantidade deve ser >0
- âœ… Custo mÃ©dio nÃ£o pode ser negativo

---

### RN008 - Workflow de AprovaÃ§Ã£o com SLA ConfigurÃ¡vel

**DescriÃ§Ã£o:**
NFes com divergÃªncias seguem workflow de aprovaÃ§Ã£o: Comprador â†’ Gestor â†’ Financeiro, com SLA e escalaÃ§Ã£o automÃ¡tica.

**Justificativa:**
Garantir que divergÃªncias sejam analisadas por pessoas autorizadas antes do pagamento e lanÃ§amento no estoque.

**ImplementaÃ§Ã£o:**
- Workflow configurÃ¡vel por valor de divergÃªncia:
  - <R$ 500: Comprador aprova sozinho
  - R$ 500 - R$ 5.000: Comprador + Gestor
  - >R$ 5.000: Comprador + Gestor + Financeiro
- SLA padrÃ£o: 24 horas por etapa
- Se SLA vencido: escalaÃ§Ã£o automÃ¡tica para superior
- ComentÃ¡rios obrigatÃ³rios em cada aprovaÃ§Ã£o/rejeiÃ§Ã£o
- HistÃ³rico completo de aprovaÃ§Ãµes com timestamp e justificativa

**Exemplo:**
```
NFe em AprovaÃ§Ã£o:
NÃºmero: 123456
Fornecedor: FORNECEDOR LTDA
Valor Total: R$ 12.450,00
DivergÃªncia: R$ 150,00 (1,2%)
Motivo: 2 monitores a mais que o pedido (22 vs 20)

Workflow Ativado:
Etapa 1: Comprador (JoÃ£o Silva)
- Iniciado: 15/12/2025 14:30
- SLA: 16/12/2025 14:30 (24h)
- AÃ§Ã£o: Aprovado
- ComentÃ¡rio: "Fornecedor enviou cortesia de 2 monitores por atraso anterior. Pedido #98123 teve entrega parcial. Aceitar."
- Timestamp: 15/12/2025 16:45 (2h 15min)

Etapa 2: Gestor (Maria Costa)
- Iniciado: 15/12/2025 16:45
- SLA: 16/12/2025 16:45 (24h)
- AÃ§Ã£o: Aprovado
- ComentÃ¡rio: "Ciente da cortesia. Atualizar pedido #98123 como completo."
- Timestamp: 16/12/2025 09:30 (16h 45min)

Etapa 3: Financeiro (Carlos Lima)
- Iniciado: 16/12/2025 09:30
- SLA: 17/12/2025 09:30 (24h)
- AÃ§Ã£o: Aprovado com Ajuste
- ComentÃ¡rio: "Atualizar valor do pedido para R$ 12.450. Autorizar pagamento."
- Ajuste: Pedido #98765 valor alterado de R$ 12.300 â†’ R$ 12.450
- Timestamp: 16/12/2025 11:00 (1h 30min)

Status Final:
âœ… NFe APROVADA
Tempo Total: 20h 30min
LanÃ§amento no Estoque: AutomÃ¡tico
Pagamento: Liberado
```

**ValidaÃ§Ãµes:**
- âœ… Todos os aprovadores devem ter permissÃ£o RBAC adequada
- âœ… ComentÃ¡rio obrigatÃ³rio se divergÃªncia >R$ 1.000
- âœ… Se rejeitado, bloquear lanÃ§amento e pagamento
- âœ… Se SLA vencido 2x, escalar para diretoria

---

### RN009 - GeraÃ§Ã£o AutomÃ¡tica de DANFE em PDF/A com QR Code

**DescriÃ§Ã£o:**
Sistema gera DANFE (Documento Auxiliar da NFe) em formato PDF/A para arquivamento de longo prazo, com QR Code para consulta na SEFAZ.

**Justificativa:**
PDF/A Ã© padrÃ£o ISO para arquivamento digital de longo prazo (7 anos de retenÃ§Ã£o fiscal). QR Code facilita validaÃ§Ã£o por auditores.

**ImplementaÃ§Ã£o:**
- Template DANFE conforme layout oficial SEFAZ
- GeraÃ§Ã£o via biblioteca iTextSharp ou PDFSharp
- QR Code contÃ©m: chave de acesso + URL consulta SEFAZ
- Marca d'Ã¡gua "CANCELADA" em NFes canceladas
- Assinatura digital opcional
- CompressÃ£o otimizada (100-200 KB por DANFE)
- Armazenamento em blob storage (Azure/S3)

**Exemplo:**
```
NFe: 123456
Chave: 35250112345678000199550010000123451000123456

GeraÃ§Ã£o de DANFE:
Template: DANFE_Modelo_Retrato_v4.0.pdf
Engine: iTextSharp 5.5.13.3

SeÃ§Ãµes do DANFE:
1. CabeÃ§alho (logo empresa, chave, nÃºmero NFe)
2. Emitente (razÃ£o social, CNPJ, endereÃ§o)
3. DestinatÃ¡rio (razÃ£o social, CNPJ, endereÃ§o)
4. Fatura (nÃºmero, vencimento, valor)
5. CÃ¡lculo do Imposto (base ICMS, valor ICMS, base ST, etc.)
6. Transportador (razÃ£o social, CNPJ, placa)
7. Dados dos Produtos (tabela: cÃ³digo, descriÃ§Ã£o, NCM, CFOP, qtd, valor)
8. CÃ¡lculo do Issqn (se aplicÃ¡vel)
9. Dados Adicionais (informaÃ§Ãµes complementares)
10. QR Code (canto inferior direito)

QR Code Gerado:
ConteÃºdo: https://nfe.fazenda.sp.gov.br/NFeConsultaPublica/ConsultaPublica.aspx?chNFe=35250112345678000199550010000123451000123456
Tamanho: 3x3 cm
ResoluÃ§Ã£o: 300 DPI

PDF/A Gerado:
Arquivo: DANFE_123456_20251215.pdf
Tamanho: 156 KB
Formato: PDF/A-1b (ISO 19005-1)
Fontes Embutidas: Arial, Courier New
Metadata: Chave NFe, Data EmissÃ£o, CNPJ Emitente

ValidaÃ§Ã£o PDF/A:
âœ… Fontes embutidas
âœ… Sem JavaScript
âœ… Sem criptografia
âœ… Metadata completa
âœ… Conforme ISO 19005-1

Armazenamento:
Blob Storage: Azure Blob
Container: danfes-2025-12
Path: /fornecedor-12345678000199/DANFE_123456_20251215.pdf
URL: https://storage.empresa.com/danfes/DANFE_123456_20251215.pdf
RetenÃ§Ã£o: 7 anos (atÃ© 15/12/2032)
```

**ValidaÃ§Ãµes:**
- âœ… PDF deve ser vÃ¡lido PDF/A-1b
- âœ… QR Code deve apontar para URL SEFAZ correta
- âœ… Todas as fontes devem estar embutidas
- âœ… Tamanho mÃ¡ximo 5 MB

---

### RN010 - DetecÃ§Ã£o de Duplicatas por Chave de Acesso

**DescriÃ§Ã£o:**
Sistema bloqueia importaÃ§Ã£o de NFes duplicadas verificando se chave de acesso jÃ¡ existe no banco de dados.

**Justificativa:**
Evitar lanÃ§amento duplo no estoque e pagamento em duplicidade ao fornecedor.

**ImplementaÃ§Ã£o:**
- Ãndice Ãºnico na tabela NotaFiscalEstoque: chave_acesso + fornecedor_id
- ValidaÃ§Ã£o antes de salvar: SELECT COUNT(*) WHERE chave_acesso = ? AND fornecedor_id = ?
- Se encontrada: rejeita com mensagem "NFe jÃ¡ importada em DD/MM/AAAA HH:MM por UsuÃ¡rio X"
- Log de tentativa de duplicaÃ§Ã£o para auditoria (pode ser tentativa de fraude)
- Permite reimportar se NFe anterior foi cancelada/rejeitada

**Exemplo:**
```
Tentativa de ImportaÃ§Ã£o:
Chave: 35250112345678000199550010000123451000123456
Fornecedor: 12.345.678/0001-99
UsuÃ¡rio: JoÃ£o Silva
Data: 17/12/2025 10:30

VerificaÃ§Ã£o no Banco:
Query:
SELECT Id, Numero, DataImportacao, UsuarioImportacao, Status
FROM NotaFiscalEstoque
WHERE ChaveAcesso = '35250112345678000199550010000123451000123456'
  AND FornecedorId = 'abc-123-def-456'

Resultado:
Id: NFE-2025-00123
NÃºmero: 123456
Data ImportaÃ§Ã£o: 15/12/2025 14:30
UsuÃ¡rio ImportaÃ§Ã£o: Maria Costa
Status: Aprovada e LanÃ§ada

AÃ§Ã£o do Sistema:
âŒ IMPORTAÃ‡ÃƒO BLOQUEADA

Mensagem para UsuÃ¡rio:
"âš ï¸ DUPLICATA DETECTADA
Esta NFe jÃ¡ foi importada anteriormente:
- NÃºmero: 123456
- Data: 15/12/2025 14:30
- Importado por: Maria Costa
- Status: Aprovada e LanÃ§ada no Estoque
- MovimentaÃ§Ã£o: MOV-2025-12345

Se esta for uma NFe diferente, verifique:
1. Chave de acesso estÃ¡ correta?
2. Fornecedor Ã© o mesmo?
3. NFe anterior foi cancelada?

Contate o suporte se acreditar que hÃ¡ erro."

Log de Auditoria:
Evento: TENTATIVA_IMPORTACAO_DUPLICATA
UsuÃ¡rio: JoÃ£o Silva
IP: 192.168.1.100
Data: 17/12/2025 10:30:15
NFe: 123456 (Chave: 3525...)
Fornecedor: FORNECEDOR LTDA
AÃ§Ã£o: Bloqueado automaticamente
```

**ValidaÃ§Ãµes:**
- âœ… Chave de acesso deve ser Ãºnica por fornecedor
- âœ… Permitir reimportaÃ§Ã£o se status anterior = "Cancelada" ou "Rejeitada"
- âœ… Log de todas as tentativas de duplicaÃ§Ã£o

---

### RN011 - IntegraÃ§Ã£o com ERP via API REST

**DescriÃ§Ã£o:**
Sistema exporta automaticamente dados de NFes aprovadas para ERPs externos (SAP, TOTVS, Protheus) via API REST.

**Justificativa:**
Eliminar duplicaÃ§Ã£o de trabalho (importar NFe no IControlIT e depois no ERP). IntegraÃ§Ã£o automÃ¡tica garante sincronia.

**ImplementaÃ§Ã£o:**
- API REST padronizada JSON
- AutenticaÃ§Ã£o via OAuth 2.0 ou API Key
- Payload: NFe completa + impostos + rateio + pedido vinculado
- Retry automÃ¡tico em caso de falha (mÃ¡x 5 tentativas)
- Log de sincronizaÃ§Ã£o: sucesso, falha, timestamp
- Webhook reverso: ERP notifica IControlIT quando processar

**Exemplo:**
```
NFe Aprovada:
NÃºmero: 123456
Fornecedor: FORNECEDOR LTDA
Valor: R$ 12.450,00
Status: Aprovada e LanÃ§ada

IntegraÃ§Ã£o ERP TOTVS:
Endpoint: https://erp.empresa.com/api/v1/notas-fiscais/entrada
Method: POST
Headers:
  Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
  Content-Type: application/json

Request Body:
{
  "origem": "IControlIT",
  "timestamp": "2025-12-17T10:30:00Z",
  "nfe": {
    "chave_acesso": "35250112345678000199550010000123451000123456",
    "numero": "123456",
    "serie": "1",
    "data_emissao": "2025-12-15",
    "fornecedor": {
      "cnpj": "12.345.678/0001-99",
      "razao_social": "FORNECEDOR LTDA",
      "inscricao_estadual": "123.456.789.012"
    },
    "destinatario": {
      "cnpj": "98.765.432/0001-00",
      "razao_social": "MINHA EMPRESA LTDA"
    },
    "itens": [
      {
        "sequencia": 1,
        "codigo_produto": "1001",
        "descricao": "Mouse USB",
        "ncm": "8471.60.52",
        "cfop": "5102",
        "unidade": "UN",
        "quantidade": 50,
        "valor_unitario": 25.00,
        "valor_total": 1250.00,
        "frete_rateado": 62.50,
        "custo_total": 1312.50,
        "icms": {
          "base_calculo": 1250.00,
          "aliquota": 18.00,
          "valor": 225.00
        }
      }
    ],
    "totais": {
      "valor_produtos": 10000.00,
      "frete": 500.00,
      "seguro": 50.00,
      "desconto": 0.00,
      "icms": 1800.00,
      "ipi": 0.00,
      "pis": 165.00,
      "cofins": 760.00,
      "valor_total": 12450.00
    },
    "pedido_compra": {
      "numero": "98765",
      "data": "2025-12-01",
      "comprador": "JoÃ£o Silva"
    }
  }
}

Response (ERP):
HTTP 201 Created
{
  "status": "sucesso",
  "mensagem": "NFe importada com sucesso no ERP TOTVS",
  "protocolo_erp": "TOTVS-2025-67890",
  "documento_lancamento": "DOC-001234",
  "centro_custo": "CC-VENDAS",
  "data_lancamento": "2025-12-17T10:30:15Z"
}

Log de IntegraÃ§Ã£o:
Timestamp: 17/12/2025 10:30:15
Sistema Destino: ERP TOTVS
Endpoint: https://erp.empresa.com/api/v1/notas-fiscais/entrada
Status: âœ… Sucesso (HTTP 201)
Protocolo ERP: TOTVS-2025-67890
Documento Gerado: DOC-001234
Tentativa: 1/5
Tempo Resposta: 1,2 segundos
```

**ValidaÃ§Ãµes:**
- âœ… API ERP deve estar acessÃ­vel (timeout mÃ¡x 10s)
- âœ… Response HTTP 200-299 = sucesso
- âœ… Se falhar, retry com backoff exponencial (1s, 2s, 4s, 8s, 16s)
- âœ… ApÃ³s 5 falhas, alertar equipe de TI

---

### RN012 - Alertas em Tempo Real via SignalR

**DescriÃ§Ã£o:**
NotificaÃ§Ãµes push em tempo real para usuÃ¡rios quando NFe Ã© importada, aprovada, rejeitada ou com divergÃªncia crÃ­tica.

**Justificativa:**
Reduzir tempo de resposta para aprovaÃ§Ãµes e aÃ§Ãµes corretivas, melhorando eficiÃªncia operacional.

**ImplementaÃ§Ã£o:**
- SignalR Hub: NotasFiscaisHub
- Grupos: por usuÃ¡rio, por departamento, por perfil
- Eventos:
  - NFeImportada: notifica comprador responsÃ¡vel
  - NFeComDivergencia: alerta comprador + gestor
  - NFeAprovada: notifica almoxarifado + financeiro
  - NFeRejeitada: notifica comprador + fornecedor
  - SLAVencido: escalaÃ§Ã£o para superior
- PersistÃªncia: notificaÃ§Ãµes salvas no banco (tabela Notificacoes)
- Badge de contagem: "3 NFes aguardando aprovaÃ§Ã£o"

**Exemplo:**
```
Evento: NFe Importada com DivergÃªncia

SignalR Notification:
Hub: NotasFiscaisHub
Method: NotificarDivergenciaNFe
Target Users:
  - JoÃ£o Silva (Comprador responsÃ¡vel pelo fornecedor)
  - Maria Costa (Gestor de Compras)
  - Grupo: "Compradores"

Payload:
{
  "tipo": "nfe_divergencia",
  "severidade": "alta",
  "titulo": "NFe com DivergÃªncia - AÃ§Ã£o Requerida",
  "mensagem": "NFe 123456 do fornecedor FORNECEDOR LTDA possui divergÃªncia de R$ 150 (2 monitores extras). Revisar em atÃ© 24h.",
  "nfe": {
    "numero": "123456",
    "fornecedor": "FORNECEDOR LTDA",
    "valor": 12450.00,
    "divergencia_valor": 150.00,
    "divergencia_percentual": 1.2
  },
  "acoes": [
    {
      "label": "Aprovar NFe",
      "url": "/gestao/notas-fiscais/123456/aprovar",
      "cor": "success"
    },
    {
      "label": "Rejeitar NFe",
      "url": "/gestao/notas-fiscais/123456/rejeitar",
      "cor": "danger"
    },
    {
      "label": "Ver Detalhes",
      "url": "/gestao/notas-fiscais/123456",
      "cor": "primary"
    }
  ],
  "timestamp": "2025-12-17T10:30:00Z",
  "sla": "2025-12-18T10:30:00Z"
}

ExibiÃ§Ã£o no Frontend:
ğŸ”´ NotificaÃ§Ã£o Toast (canto superior direito):
"âš ï¸ NFe com DivergÃªncia
NFe 123456 - FORNECEDOR LTDA
DivergÃªncia: R$ 150,00 (2 monitores extras)
SLA: 24 horas
[Aprovar] [Rejeitar] [Ver Detalhes]"

Badge de Contagem (menu lateral):
"ğŸ“„ Notas Fiscais (3)" â† Incrementado
```

**ValidaÃ§Ãµes:**
- âœ… UsuÃ¡rio deve estar autenticado e conectado ao SignalR
- âœ… NotificaÃ§Ã£o salva no banco mesmo se usuÃ¡rio offline
- âœ… Badge atualizado automaticamente
- âœ… Som de alerta configurÃ¡vel (ativado/desativado por usuÃ¡rio)

---

### RN013 - RetenÃ§Ã£o de XML Original por 7 Anos (LGPD/LegislaÃ§Ã£o Fiscal)

**DescriÃ§Ã£o:**
Sistema armazena XML original da NFe em blob storage com criptografia AES-256 por 7 anos conforme legislaÃ§Ã£o fiscal.

**Justificativa:**
LegislaÃ§Ã£o fiscal exige guarda de documentos fiscais por 7 anos. LGPD exige seguranÃ§a e rastreabilidade.

**ImplementaÃ§Ã£o:**
- Upload para Azure Blob Storage ou AWS S3
- Criptografia em repouso: AES-256
- Estrutura de pastas: /ano/mes/fornecedor/
- PolÃ­tica de retenÃ§Ã£o: 7 anos (2.555 dias)
- ApÃ³s 7 anos: exclusÃ£o automÃ¡tica ou arquivamento em storage de baixo custo (Glacier)
- Backup redundante em datacenter secundÃ¡rio
- Auditoria: log de acesso ao XML (quem, quando, IP)

**Exemplo:**
```
NFe Importada:
NÃºmero: 123456
Chave: 35250112345678000199550010000123451000123456
Data EmissÃ£o: 15/12/2025
Fornecedor: FORNECEDOR LTDA (CNPJ 12.345.678/0001-99)

Armazenamento Blob Storage:
Provedor: Azure Blob Storage
Container: nfes-xml-originais
Path: /2025/12/fornecedor-12345678000199/NFe_35250112345678000199550010000123451000123456.xml
URL: https://storage.empresa.com/nfes-xml/2025/12/fornecedor-12345678000199/NFe_352501...xml (URL assinada, vÃ¡lida 1h)

Criptografia:
Algoritmo: AES-256-CBC
Chave: Armazenada no Azure Key Vault
IV: Gerado aleatoriamente por arquivo
Hash (SHA-256): a1b2c3d4e5f6...

Metadata:
{
  "chave_acesso": "35250112345678000199550010000123451000123456",
  "numero_nfe": "123456",
  "cnpj_emitente": "12.345.678/0001-99",
  "cnpj_destinatario": "98.765.432/0001-00",
  "data_emissao": "2025-12-15",
  "valor_total": 12450.00,
  "data_upload": "2025-12-17T10:30:00Z",
  "usuario_upload": "JoÃ£o Silva",
  "ip_origem": "192.168.1.100",
  "tamanho_bytes": 23456,
  "hash_sha256": "a1b2c3d4e5f6...",
  "data_retencao_ate": "2032-12-17" â† 7 anos
}

PolÃ­tica de Lifecycle:
- Anos 0-2: Hot Storage (acesso frequente)
- Anos 2-5: Cool Storage (acesso esporÃ¡dico, 50% mais barato)
- Anos 5-7: Archive Storage (acesso raro, 80% mais barato)
- ApÃ³s 7 anos: ExclusÃ£o automÃ¡tica OU transferÃªncia para Glacier (backup histÃ³rico)

Backup Redundante:
Primary: Azure Brazil South (SÃ£o Paulo)
Secondary: Azure Brazil Southeast (Rio de Janeiro)
ReplicaÃ§Ã£o: Geo-redundante (GRS)

Auditoria de Acesso:
Evento: Download XML
UsuÃ¡rio: Auditor Fiscal (JosÃ© Santos)
Data: 20/01/2026 15:45:12
IP: 192.168.2.50
Motivo: Auditoria interna trimestral
Arquivo: NFe_352501...xml
AÃ§Ã£o: Permitido (perfil autorizado)
```

**ValidaÃ§Ãµes:**
- âœ… XML deve ser armazenado IMEDIATAMENTE apÃ³s importaÃ§Ã£o
- âœ… Criptografia obrigatÃ³ria (AES-256 ou superior)
- âœ… Backup redundante em datacenter diferente
- âœ… Log de TODOS os acessos ao XML

---

### RN014 - Dashboard Executivo de Notas Fiscais

**DescriÃ§Ã£o:**
Dashboard visual com KPIs de notas fiscais: volume mensal, top fornecedores, divergÃªncias pendentes, tempo mÃ©dio de aprovaÃ§Ã£o.

**Justificativa:**
Gestores precisam de visibilidade rÃ¡pida sobre status geral de NFes para tomada de decisÃ£o.

**ImplementaÃ§Ã£o:**
- GrÃ¡ficos: ApexCharts ou Chart.js
- KPIs principais:
  - Total NFes importadas no mÃªs
  - Valor total (R$)
  - NFes pendentes de aprovaÃ§Ã£o
  - Tempo mÃ©dio de aprovaÃ§Ã£o
  - Top 10 fornecedores por valor
  - Taxa de divergÃªncia (%)
  - NFes rejeitadas/canceladas
- Filtros: perÃ­odo, fornecedor, comprador, centro de custo
- AtualizaÃ§Ã£o em tempo real via SignalR
- ExportaÃ§Ã£o: PDF, Excel

**Exemplo:**
```
Dashboard - GestÃ£o de Notas Fiscais Estoque
PerÃ­odo: Dezembro/2025

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  KPIs PRINCIPAIS                                            â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  ğŸ“„ NFes Importadas: 234 (+12% vs Nov)                     â•‘
â•‘  ğŸ’° Valor Total: R$ 1.234.567,89 (+8% vs Nov)              â•‘
â•‘  â³ Pendentes AprovaÃ§Ã£o: 15 (6,4%)                         â•‘
â•‘  âš¡ Tempo MÃ©dio AprovaÃ§Ã£o: 18h 35min (-2h vs Nov)          â•‘
â•‘  âš ï¸ Taxa DivergÃªncia: 8,5% (-1,2% vs Nov)                  â•‘
â•‘  âŒ Rejeitadas: 3 (1,3%)                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Š VOLUME MENSAL (Ãºltimos 12 meses)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [GrÃ¡fico de Linhas]                                        â”‚
â”‚  Jan  Fev  Mar  Abr  Mai  Jun  Jul  Ago  Set  Out  Nov  Dez â”‚
â”‚  180  195  210  198  205  220  215  225  230  220  209  234 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¢ TOP 10 FORNECEDORES (por valor)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. FORNECEDOR A LTDA       R$ 234.567,00  (19%)            â”‚
â”‚  2. FORNECEDOR B S/A        R$ 189.234,50  (15,3%)          â”‚
â”‚  3. FORNECEDOR C EIRELI     R$ 145.678,90  (11,8%)          â”‚
â”‚  4. FORNECEDOR D LTDA       R$ 112.345,67  (9,1%)           â”‚
â”‚  5. FORNECEDOR E S/A        R$ 98.765,43   (8%)             â”‚
â”‚  ...                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš ï¸ DIVERGÃŠNCIAS PENDENTES (SLA crÃ­tico)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  NFe 123456 - FORNECEDOR A - R$ 150 - SLA: 2h restantes    â”‚
â”‚  NFe 123457 - FORNECEDOR B - R$ 320 - SLA: 5h restantes    â”‚
â”‚  NFe 123458 - FORNECEDOR C - R$ 890 - SLA: VENCIDO (1h)    â”‚
â”‚  [Ver Todas (15)]                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“ˆ TEMPO MÃ‰DIO DE APROVAÃ‡ÃƒO (Ãºltimos 30 dias)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [GrÃ¡fico de Barras]                                        â”‚
â”‚  Comprador A: 12h                                           â”‚
â”‚  Comprador B: 18h                                           â”‚
â”‚  Comprador C: 24h â† AtenÃ§Ã£o: acima da meta (20h)           â”‚
â”‚  Comprador D: 16h                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ValidaÃ§Ãµes:**
- âœ… Dados atualizados em tempo real
- âœ… Filtros persistidos na sessÃ£o do usuÃ¡rio
- âœ… ExportaÃ§Ã£o fiel ao filtro aplicado
- âœ… Performance: carregar <2 segundos

---

### RN015 - Multi-tenancy com Limite de NFes por Plano

**DescriÃ§Ã£o:**
Isolamento completo de dados por fornecedor (ClienteId) com limites de importaÃ§Ã£o conforme plano contratado.

**Justificativa:**
SaaS multi-tenant exige isolamento de dados e controle de consumo para precificaÃ§Ã£o justa.

**ImplementaÃ§Ã£o:**
- Filtro global EF Core: .Where(x => x.ClienteId == currentClienteId)
- Limites por plano:
  - BÃ¡sico: 1.000 NFes/mÃªs
  - Profissional: 5.000 NFes/mÃªs
  - Enterprise: Ilimitado
- Se exceder limite: bloqueio de importaÃ§Ã£o + alerta para upgrade
- Dashboard de consumo: "VocÃª usou 750/1.000 NFes neste mÃªs (75%)"
- Reset automÃ¡tico todo dia 1Âº de cada mÃªs

**Exemplo:**
```
Fornecedor: MINHA EMPRESA LTDA
ClienteId: abc-123-def-456
Plano: Profissional
Limite: 5.000 NFes/mÃªs

Consumo Dezembro/2025:
- NFes importadas: 4.850
- DisponÃ­vel: 150 (3%)

Tentativa de ImportaÃ§Ã£o (NFe 4.851):
âœ… Permitido (ainda dentro do limite)

Tentativa de ImportaÃ§Ã£o (NFe 5.001):
âŒ BLOQUEADO

Mensagem para UsuÃ¡rio:
"âš ï¸ LIMITE DE IMPORTAÃ‡ÃƒO ATINGIDO
Seu plano Profissional permite 5.000 NFes/mÃªs.
VocÃª jÃ¡ importou 5.000 NFes em Dezembro/2025.

OpÃ§Ãµes:
1. Aguardar atÃ© 01/01/2026 para reset automÃ¡tico
2. Fazer upgrade para plano Enterprise (importaÃ§Ãµes ilimitadas)
3. Contratar pacote extra de 1.000 NFes por R$ 199

[Fazer Upgrade] [Contratar Pacote Extra] [Falar com Vendas]"

Auditoria:
Evento: LIMITE_IMPORTACAO_ATINGIDO
ClienteId: abc-123-def-456
Plano: Profissional
Limite: 5.000
Consumo: 5.000
Data: 28/12/2025
AÃ§Ã£o: Bloqueio de importaÃ§Ã£o
```

**ValidaÃ§Ãµes:**
- âœ… ClienteId obrigatÃ³rio em todas as queries
- âœ… Contador de consumo atualizado em tempo real
- âœ… Reset automÃ¡tico no dia 1Âº Ã s 00:00 UTC
- âœ… Alertas aos 80%, 90%, 95%, 100% do limite

---

## SEÃ‡ÃƒO 3: REFERÃŠNCIAS AO SISTEMA LEGADO

### 3.1 Telas Web Forms (ASPX)

| Tela Legada | Funcionalidade | ObservaÃ§Ãµes |
|-------------|----------------|-------------|
| `Cadastro/NotaFiscalEntrada.aspx` | Cadastro manual de NFe | SubstituÃ­da por importaÃ§Ã£o automÃ¡tica de XML |
| `Cadastro/NotaFiscalEntradaItem.aspx` | Itens da NFe | Parsing automÃ¡tico do XML |
| `Relatorios/NotasFiscaisEntrada.aspx` | Listagem e filtros | Migrado para Angular com DataGrid avanÃ§ado |
| `Validacao/ValidarNFeSEFAZ.aspx` | ValidaÃ§Ã£o manual SEFAZ | AutomÃ¡tica via WebService |

### 3.2 Stored Procedures

| Procedure Legada | Finalidade | Status ModernizaÃ§Ã£o |
|------------------|------------|---------------------|
| `sp_ImportarNFeXML` | Parser XML manual | SubstituÃ­da por NFeXmlParser.cs (C#) |
| `sp_CalcularImpostosNFe` | CÃ¡lculo de impostos | Migrado para ImpostosCalculator.cs |
| `sp_RatearFreteNFe` | Rateio de frete | Migrado para FreteRateioService.cs |
| `sp_LancarEstoqueNFe` | LanÃ§amento manual | AutomÃ¡tico via EstoqueMovimentacaoService.cs |

### 3.3 Tabelas do Banco

| Tabela Legada | Nova Tabela | MudanÃ§as Principais |
|---------------|-------------|---------------------|
| `NotaFiscalEntrada` | `NotaFiscalEstoque` | +ClienteId, +XmlOriginalUrl, +StatusSEFAZ |
| `NotaFiscalEntradaItem` | `NotaFiscalEstoqueItem` | +ImpostosJSON, +FreteRateado |
| `NotaFiscalEntradaImpostos` | (incorporado) | JSON dentro de NotaFiscalEstoqueItem.ImpostosJSON |

### 3.4 Web Services

| WebService Legado | Endpoint Modernizado | Tecnologia |
|-------------------|----------------------|------------|
| `WS/NotaFiscal.asmx` | `/api/notas-fiscais-estoque` | Minimal API (.NET 10) |
| `WS/ValidacaoSEFAZ.asmx` | `SEFAZValidationService.cs` | HttpClient + Polly retry |

### 3.5 Mapeamento Funcional

| Funcionalidade | Legado | Modernizado |
|----------------|--------|-------------|
| ImportaÃ§Ã£o XML | Upload manual, 1 arquivo por vez | Drag-and-drop mÃºltiplos + e-mail automÃ¡tico |
| ValidaÃ§Ã£o SEFAZ | NÃ£o suportado | AutomÃ¡tica em tempo real |
| OCR de PDF | NÃ£o suportado | Tesseract + Azure Form Recognizer |
| ConciliaÃ§Ã£o Pedido | Manual em planilha | AutomÃ¡tica com alertas |
| CÃ¡lculo Impostos | Stored procedures | Engine fiscal C# atualizada |
| Workflow AprovaÃ§Ã£o | E-mails manuais | Workflow automÃ¡tico + SLA |
| DANFE | GeraÃ§Ã£o externa | PDF/A com QR Code automÃ¡tico |
| Auditoria | Logs bÃ¡sicos | Rastreabilidade completa 7 anos |

---

## SEÃ‡ÃƒO 4: IMPACTO E DEPENDÃŠNCIAS

### 4.1 DependÃªncias de Outros RFs

| RF Dependente | Tipo DependÃªncia | DescriÃ§Ã£o |
|---------------|------------------|-----------|
| **RF008 - GestÃ£o de Fornecedores** | **CRÃTICA** | CNPJ do fornecedor deve existir na base |
| **RF010 - GestÃ£o de Produtos** | **CRÃTICA** | Produtos da NFe devem estar cadastrados (ou criar automÃ¡tico) |
| **RF019 - GestÃ£o de Pedidos de Compra** | **ALTA** | ConciliaÃ§Ã£o NFe â†” Pedido |
| **RF021 - GestÃ£o de Estoque** | **CRÃTICA** | LanÃ§amento automÃ¡tico de entrada |
| **RF024 - GestÃ£o de Centros de Custo** | **MÃ‰DIA** | Rateio de custos por CC |
| **RF001 - ParÃ¢metros e ConfiguraÃ§Ãµes** | **ALTA** | TolerÃ¢ncias, SLAs, limites de plano |
| **RF003 - Auditoria** | **ALTA** | Log de todas as operaÃ§Ãµes |
| **RF006 - GestÃ£o de UsuÃ¡rios** | **ALTA** | Workflow de aprovaÃ§Ã£o, RBAC |

### 4.2 Tecnologias Utilizadas

**Backend:**
- **.NET 10** - Runtime principal
- **Entity Framework Core 10** - ORM para SQL Server
- **MediatR** - CQRS (Commands/Queries)
- **FluentValidation** - ValidaÃ§Ã£o de dados
- **Hangfire** - Jobs agendados (importaÃ§Ã£o e-mail, limpeza)
- **Polly** - Retry policy para SEFAZ
- **iTextSharp** - GeraÃ§Ã£o de DANFE em PDF/A
- **Tesseract** - OCR de PDFs (gratuito)
- **Azure Form Recognizer** - OCR avanÃ§ado (pago)
- **SignalR** - NotificaÃ§Ãµes em tempo real
- **Azure Blob Storage** - Armazenamento de XMLs (7 anos)

**Frontend:**
- **Angular 19** - Framework SPA
- **Angular Material** - Componentes UI
- **ApexCharts** - GrÃ¡ficos do dashboard
- **Transloco** - InternacionalizaÃ§Ã£o (i18n)
- **ngx-file-drop** - Drag-and-drop de arquivos

**IntegraÃ§Ãµes:**
- **WebService SEFAZ** - ValidaÃ§Ã£o de NFes
- **ViaCEP** - ValidaÃ§Ã£o de endereÃ§os
- **APIs ERPs** - SAP, TOTVS, Protheus

### 4.3 Complexidade de ImplementaÃ§Ã£o

**Complexidade Geral:** MUITO ALTA

| Componente | Complexidade | Estimativa | Justificativa |
|------------|--------------|-----------|---------------|
| **Parser XML NFe** | ALTA | 40h | Schema SEFAZ v4.0 Ã© extenso (300+ campos) |
| **ValidaÃ§Ã£o SEFAZ** | MÃ‰DIA | 16h | WebService oficial, mas instÃ¡vel |
| **OCR de PDFs** | MUITO ALTA | 60h | Treinamento de IA, mÃºltiplos layouts DANFE |
| **ConciliaÃ§Ã£o Pedidos** | ALTA | 32h | Matching fuzzy, tolerÃ¢ncias, alertas |
| **Engine Fiscal** | MUITO ALTA | 80h | ICMS, IPI, PIS, COFINS, DIFAL, ST, reduÃ§Ãµes |
| **Workflow AprovaÃ§Ã£o** | MÃ‰DIA | 24h | MediatR + aprovaÃ§Ãµes multinÃ­vel |
| **GeraÃ§Ã£o DANFE PDF/A** | MÃ‰DIA | 20h | Layout oficial + QR Code |
| **SignalR Notifications** | BAIXA | 12h | JÃ¡ implementado em outros RFs |
| **Dashboard Executivo** | MÃ‰DIA | 24h | ApexCharts + KPIs |
| **Testes Automatizados** | ALTA | 40h | 150+ cenÃ¡rios de teste |
| **Total** | **MUITO ALTA** | **348h** | ~9 semanas (2 devs) |

### 4.4 Riscos Identificados

| Risco | Probabilidade | Impacto | MitigaÃ§Ã£o |
|-------|---------------|---------|-----------|
| **SEFAZ indisponÃ­vel/instÃ¡vel** | ALTA | ALTO | Retry com backoff exponencial, cache 1h |
| **OCR com baixa precisÃ£o em PDFs ruins** | MÃ‰DIA | MÃ‰DIO | Fallback para revisÃ£o manual, treinamento contÃ­nuo IA |
| **NFes com layout fora do padrÃ£o** | MÃ‰DIA | MÃ‰DIO | Parser robusto com tratamento de exceÃ§Ãµes |
| **Fornecedores nÃ£o enviam XML** | BAIXA | ALTO | OCR + busca SEFAZ automÃ¡tica |
| **DivergÃªncias excessivas** | MÃ‰DIA | MÃ‰DIO | TolerÃ¢ncias configurÃ¡veis, workflow flexÃ­vel |
| **Performance com volume alto** | BAIXA | ALTO | Processamento assÃ­ncrono, Ã­ndices otimizados |
| **Limite de importaÃ§Ã£o atingido** | MÃ‰DIA | BAIXO | Alertas proativos, upgrade fÃ¡cil de plano |

---

## SEÃ‡ÃƒO 5: INTEGRAÃ‡ÃƒO COM CENTRAL DE FUNCIONALIDADES

### 5.1 PermissÃµes RBAC

**MÃ³dulo:** `GES.NOTAS_FISCAIS_ESTOQUE`

| PermissÃ£o | CÃ³digo | DescriÃ§Ã£o | Roles PadrÃ£o |
|-----------|--------|-----------|--------------|
| **Visualizar** | `GES.NOTAS_FISCAIS_ESTOQUE.VIEW` | Visualizar lista e detalhes de NFes | Comprador, Gestor, Financeiro, Auditor |
| **Importar** | `GES.NOTAS_FISCAIS_ESTOQUE.IMPORT` | Importar XMLs/PDFs de NFes | Comprador, Almoxarife |
| **Aprovar Menor** | `GES.NOTAS_FISCAIS_ESTOQUE.APPROVE_MINOR` | Aprovar divergÃªncias <R$ 500 | Comprador |
| **Aprovar Maior** | `GES.NOTAS_FISCAIS_ESTOQUE.APPROVE_MAJOR` | Aprovar divergÃªncias >R$ 500 | Gestor, Diretor |
| **Rejeitar** | `GES.NOTAS_FISCAIS_ESTOQUE.REJECT` | Rejeitar NFes com problemas | Comprador, Gestor |
| **LanÃ§ar Estoque** | `GES.NOTAS_FISCAIS_ESTOQUE.POST_INVENTORY` | ForÃ§ar lanÃ§amento manual no estoque | Almoxarife, Gestor |
| **Cancelar** | `GES.NOTAS_FISCAIS_ESTOQUE.CANCEL` | Cancelar NFe lanÃ§ada (estorno) | Gestor, Controller |
| **Exportar** | `GES.NOTAS_FISCAIS_ESTOQUE.EXPORT` | Exportar relatÃ³rios Excel/PDF | Comprador, Gestor, Auditor |
| **Configurar** | `GES.NOTAS_FISCAIS_ESTOQUE.CONFIGURE` | Configurar tolerÃ¢ncias, SLAs, integraÃ§Ã£o ERP | Super Admin, Diretor |
| **Auditar** | `GES.NOTAS_FISCAIS_ESTOQUE.AUDIT` | Acessar logs de auditoria completos | Auditor, Controller, Super Admin |

### 5.2 Chaves i18n (InternacionalizaÃ§Ã£o)

**Namespace:** `ges.notasFiscaisEstoque`

```json
{
  "ges.notasFiscaisEstoque": {
    "title": "GestÃ£o de Notas Fiscais Estoque",
    "subtitle": "ImportaÃ§Ã£o, validaÃ§Ã£o e lanÃ§amento de NFes de entrada",
    "actions": {
      "import": "Importar NFe",
      "importMultiple": "Importar MÃºltiplas NFes",
      "validate": "Validar na SEFAZ",
      "approve": "Aprovar NFe",
      "reject": "Rejeitar NFe",
      "postInventory": "LanÃ§ar no Estoque",
      "cancel": "Cancelar NFe",
      "generateDANFE": "Gerar DANFE",
      "viewXML": "Visualizar XML",
      "downloadXML": "Baixar XML"
    },
    "fields": {
      "chaveAcesso": "Chave de Acesso",
      "numero": "NÃºmero NFe",
      "serie": "SÃ©rie",
      "dataEmissao": "Data EmissÃ£o",
      "fornecedor": "Fornecedor",
      "valorTotal": "Valor Total",
      "statusSEFAZ": "Status SEFAZ",
      "statusInterno": "Status Interno",
      "divergenciaValor": "DivergÃªncia Valor",
      "pedidoVinculado": "Pedido Vinculado",
      "comprador": "Comprador ResponsÃ¡vel",
      "dataImportacao": "Data ImportaÃ§Ã£o",
      "dataAprovacao": "Data AprovaÃ§Ã£o"
    },
    "status": {
      "aguardandoValidacao": "Aguardando ValidaÃ§Ã£o SEFAZ",
      "autorizada": "Autorizada pela SEFAZ",
      "cancelada": "Cancelada",
      "rejeitada": "Rejeitada",
      "aguardandoAprovacao": "Aguardando AprovaÃ§Ã£o",
      "aprovada": "Aprovada",
      "lancadaEstoque": "LanÃ§ada no Estoque",
      "divergencia": "Com DivergÃªncia"
    },
    "messages": {
      "importSuccess": "NFe importada com sucesso!",
      "importError": "Erro ao importar NFe: {{error}}",
      "validateSuccess": "NFe validada na SEFAZ com sucesso!",
      "validateError": "Erro na validaÃ§Ã£o SEFAZ: {{error}}",
      "approveSuccess": "NFe aprovada e lanÃ§ada no estoque!",
      "rejectSuccess": "NFe rejeitada com sucesso",
      "duplicateDetected": "NFe duplicada! JÃ¡ importada em {{date}} por {{user}}",
      "slaExpired": "SLA vencido! AprovaÃ§Ã£o pendente hÃ¡ {{hours}} horas",
      "limitReached": "Limite de importaÃ§Ãµes atingido! {{used}}/{{limit}} NFes no mÃªs"
    },
    "validations": {
      "chaveAcessoInvalida": "Chave de acesso invÃ¡lida (deve ter 44 dÃ­gitos)",
      "xmlInvalido": "XML invÃ¡lido ou corrompido",
      "cnpjDiferente": "CNPJ destinatÃ¡rio nÃ£o corresponde Ã  empresa logada",
      "divergenciaAcimaToleranc": "DivergÃªncia acima da tolerÃ¢ncia configurada",
      "pedidoNaoEncontrado": "Pedido de compra nÃ£o encontrado",
      "sefazCancelada": "NFe cancelada na SEFAZ - nÃ£o pode ser importada"
    }
  }
}
```

### 5.3 Campos de Auditoria

**Tabela:** `NotaFiscalEstoque`

| Campo Auditoria | Tipo | DescriÃ§Ã£o |
|-----------------|------|-----------|
| `CriadoPor` | NVARCHAR(450) | UsuÃ¡rio que importou a NFe |
| `CriadoEm` | DATETIME2 | Data/hora da importaÃ§Ã£o |
| `AlteradoPor` | NVARCHAR(450) | Ãšltimo usuÃ¡rio que modificou |
| `AlteradoEm` | DATETIME2 | Data/hora Ãºltima modificaÃ§Ã£o |
| `AprovadoPor` | NVARCHAR(450) | UsuÃ¡rio que aprovou |
| `AprovadoEm` | DATETIME2 | Data/hora da aprovaÃ§Ã£o |
| `RejeitadoPor` | NVARCHAR(450) | UsuÃ¡rio que rejeitou |
| `RejeitadoEm` | DATETIME2 | Data/hora da rejeiÃ§Ã£o |
| `LancadoPor` | NVARCHAR(450) | UsuÃ¡rio que lanÃ§ou no estoque |
| `LancadoEm` | DATETIME2 | Data/hora do lanÃ§amento |

**OperaÃ§Ãµes Auditadas:**
- âœ… ImportaÃ§Ã£o de NFe (XML ou PDF)
- âœ… ValidaÃ§Ã£o na SEFAZ
- âœ… AprovaÃ§Ã£o (com justificativa se divergÃªncia)
- âœ… RejeiÃ§Ã£o (com motivo obrigatÃ³rio)
- âœ… LanÃ§amento no estoque
- âœ… Cancelamento/estorno
- âœ… Download de XML original
- âœ… GeraÃ§Ã£o de DANFE
- âœ… AlteraÃ§Ã£o de configuraÃ§Ãµes

### 5.4 Multi-tenancy

**Discriminador:** `ClienteId` (GUID do fornecedor)

**Filtro Global EF Core:**
```csharp
modelBuilder.Entity<NotaFiscalEstoque>().HasQueryFilter(e => e.ClienteId == _currentClienteId);
```

**Ãndices Multi-tenant:**
```sql
CREATE NONCLUSTERED INDEX IX_NotaFiscalEstoque_ClienteId_DataEmissao
ON NotaFiscalEstoque(ClienteId, DataEmissao DESC)
WHERE FlExcluido = 0;

CREATE UNIQUE NONCLUSTERED INDEX UX_NotaFiscalEstoque_ClienteId_ChaveAcesso
ON NotaFiscalEstoque(ClienteId, ChaveAcesso)
WHERE FlExcluido = 0;
```

**Limites por Plano:**
- **BÃ¡sico:** 1.000 NFes/mÃªs
- **Profissional:** 5.000 NFes/mÃªs
- **Enterprise:** Ilimitado

---

**FIM DA ESPECIFICAÃ‡ÃƒO RF042**
