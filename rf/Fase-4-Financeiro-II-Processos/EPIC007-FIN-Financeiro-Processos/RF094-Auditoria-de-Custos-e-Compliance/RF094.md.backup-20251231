# RF-094: Auditoria de Custos e Compliance

**Versao**: 1.0 | **Data**: 2025-12-28
**RF Relacionado**: RF-089, RF-032, RF-035, RF-054 | **EPIC**: EPIC007-FIN-Financeiro-Processos
**Fase**: Fase 4 - Financeiro II: Processos

---

## 1. RESUMO EXECUTIVO

### 1.1 Descricao Geral

Este requisito especifica o módulo de **Auditoria de Custos e Compliance** do sistema IControlIT, responsável por analisar despesas, detectar desvios orçamentários, identificar anomalias, garantir conformidade com políticas corporativas e regulamentações, além de disponibilizar insights analíticos para tomada de decisão.

O módulo integra dados de múltiplas fontes (linhas móveis, contratos, ativos, faturas) e aplica algoritmos de detecção de anomalias para identificar oportunidades de economia, desperdícios e violações de conformidade. Fornece relatórios executivos, dashboards analíticos e alertas em tempo real.

### 1.2 Importancia Estrategica

O módulo de Auditoria de Custos e Compliance é crítico para:

- **Conformidade Regulatória**: Atender requisitos de LGPD, SOX (Sarbanes-Oxley), ISO 27001 e políticas corporativas internas. Garantir rastreabilidade completa de despesas e conformidade com políticas de gastos (RF-079).
- **Otimização de Despesas**: Identificar desperdícios, duplicidades e oportunidades de negociação. Quantificar economia potencial e ROI de iniciativas. Pode resultar em redução de 5-15% de custos operacionais.
- **Governança Corporativa**: Fornecer evidências auditáveis de controle de despesas. Detectar fraudes, desvios de política e gastos anômalos. Suportar auditorias internas e externas.
- **Inteligência de Negócio**: Análise multidimensional de custos (por fornecedor, categoria, período, filial, departamento). Identificar tendências, sazonalidades e padrões. Suportar projeções orçamentárias.
- **Tomada de Decisão Executiva**: Dashboards e KPIs que mostram saúde financeira. Alertas de desvios de SLA, orçamentos e políticas. Subsidia decisões de fornecedores e negociações.

### 1.3 Conceitos Fundamentais

**Auditoria de Custos**: Processo sistemático de revisar despesas para verificar conformidade com políticas, detectar anomalias e quantificar oportunidades de economia.
- Análise de variância (variance analysis): Comparação entre custo planejado vs realizado
- Benchmarking: Comparação de custos entre unidades, períodos ou fornecedores

**Detecção de Anomalias**: Identificação de transações atípicas usando técnicas estatísticas e Machine Learning.
- Z-score: Desvio padrão da média
- Isolation Forest: Algoritmo não-supervisionado para outliers
- Prophet (série temporal): Previsão e detecção de anomalias em padrões

**Compliance**: Conformidade com regulamentações externas (LGPD, SOX) e políticas internas.
- LGPD: Lei Geral de Proteção de Dados (retenção 7 anos, auditoria de acesso)
- SOX: Requisitos de controle interno e segregação de deveres
- Políticas Corporativas: Aprovações, limites de gasto, fornecedores aprovados

**TCO (Total Cost of Ownership)**: Custo total de um ativo durante todo seu ciclo de vida.
- Inclui: aquisição, manutenção, suporte, depreciação, descarte
- Usado para decisões de aquisição vs locação

**ROI (Return on Investment)**: Retorno sobre investimento.
- ROI = (Benefício - Custo) / Custo × 100%
- Usado para priorizar iniciativas de economia

**Dimensões de Análise**: Formas de agrupar e analisar custos.
- Dimensões: Fornecedor, Categoria, Centro de Custo, Departamento, Filial, Período
- Métricas: Valor total, quantidade, valor médio, crescimento, variância

### 1.4 Legado vs Modernizado

| Aspecto | Legado (VB.NET) | Modernizado (.NET 10 + Angular) |
|---------|-----------------|--------------------------------|
| **Análise de Custos** | Relatórios estáticos (Crystal Reports/Excel) | Dashboards interativos com drill-down e filtros |
| **Detecção de Anomalias** | Manual (revisão de especialistas) | Algoritmos ML (Isolation Forest, Z-score) |
| **Integração de Dados** | Queries SQL hardcoded em SPs | ETL via integração de APIs (Operadoras, ERPs) |
| **Visualização** | Tabelas em ASPX | Gráficos interativos (Chart.js, Angular Material) |
| **Performance** | Lento (queries complexas sem índices) | Otimizado (índices, materialização, Redis cache) |
| **Auditoria de Acesso** | Logs em texto | Auditoria estruturada em tabela (AuditLog) |
| **Relatórios Executivos** | PDF gerado diariamente | Relatórios on-demand com histórico |
| **Alertas** | Nenhum (usuário consulta manualmente) | Alertas em tempo real via webhook, email, dashboard |
| **Machine Learning** | Não existe | Azure ML ou Python/Scikit-learn (Hangfire job) |
| **Multi-tenancy** | Separado (banco por cliente) | Unificado (Query Filter automático) |

### 1.5 Funcionalidades Principais

1. **Análise de Custos Multidimensional** - Visualizar custos agrupados por fornecedor, categoria, departamento, período com drill-down interativo
2. **Detecção de Anomalias** - Identificar transações atípicas, desvios de padrão e possíveis fraudes usando ML
3. **Análise de Variância** - Comparar custo planejado vs realizado, identificar desvios e calcular percentage variance
4. **Benchmarking Interno** - Comparar custos entre filiais, departamentos ou períodos para identificar melhores práticas
5. **Cálculo de TCO** - Determinar custo total de propriedade de ativos incluindo depreciação, manutenção e descarte
6. **Análise de ROI** - Quantificar retorno de investimentos e iniciativas de otimização
7. **Identificação de Desperdícios** - Detectar ativos inativos, linhas sem uso, fornecedores duplicados
8. **Alertas de Não-Conformidade** - Notificações de violações de política corporativa (gastos acima do limite, fornecedor não aprovado)
9. **Relatórios Executivos** - Sumários com top gastos, economia potencial, recomendações
10. **Dashboard Analítico** - Visualizações em tempo real com KPIs, tendências e alertas
11. **Exportação de Relatórios** - Download em formatos PDF, Excel, CSV para apresentações e arquivos
12. **Integração com BI** - Exposição de dados via API para Power BI, Tableau ou ferramentas customizadas
13. **Análise de Conformidade** - Relatórios de compliance com políticas corporativas (RF-079) e regulatórias (LGPD, SOX)
14. **Histórico e Auditoria** - Rastreamento de todas as operações e cálculos (LGPD 7 anos)
15. **Jobs de Análise Batch** - Processamento noturno de detecção de anomalias, cálculo de depreciação, previsões (Hangfire)

---

## 2. REGRAS DE NEGOCIO

### RN-AUD-094-01: Análise de Variância - Regra de Cálculo

**Descricao**: O sistema deve calcular a variância entre custo planejado e realizado, expressando como percentual e valor absoluto.

**Justificativa**: Variância é métrica fundamental para identificar desvios orçamentários e quantificar impacto financeiro.

**Implementacao**:
```csharp
public class VarianciaAnalise
{
    public decimal CustoPlano { get; set; }
    public decimal CustoRealizado { get; set; }

    public decimal CalcularVariancia()
    {
        return CustoRealizado - CustoPlano;
    }

    public decimal CalcularVarianciaPercentual()
    {
        if (CustoPlano == 0) return 0;
        return (CalcularVariancia() / CustoPlano) * 100m;
    }

    // Classificação
    public string ClassificarVariancia()
    {
        var percentual = CalcularVarianciaPercentual();
        return Math.Abs(percentual) switch
        {
            <= 5m => "Aceitável",
            <= 15m => "Aviso",
            > 15m => "Crítico",
            _ => "Desconhecido"
        };
    }
}
```

**Exemplos**:
- Plano: R$ 10.000, Realizado: R$ 10.500 → Variância: R$ 500 (5%) - Aceitável
- Plano: R$ 10.000, Realizado: R$ 8.500 → Variância: -R$ 1.500 (-15%) - Economia
- Plano: R$ 10.000, Realizado: R$ 12.000 → Variância: R$ 2.000 (20%) - Crítico

---

### RN-AUD-094-02: Detecção de Anomalias por Z-Score

**Descricao**: O sistema deve identificar transações com desvio superior a 2.5 desvios padrão (Z-score > 2.5 ou < -2.5) como potencial anomalia.

**Justificativa**: Z-score é método estatístico padrão para detecção de outliers. Valor 2.5 captura ~98% dos dados normais.

**Implementacao**:
```csharp
public class DeteccaoAnomaliasZScore
{
    public List<TransacaoAnomala> DetectarAnomalias(List<decimal> valores)
    {
        var media = valores.Average();
        var desvio = Math.Sqrt(valores.Average(x => Math.Pow(x - media, 2)));

        var anomalias = new List<TransacaoAnomala>();

        foreach (var valor in valores)
        {
            var zScore = desvio > 0 ? (valor - media) / desvio : 0;

            if (Math.Abs(zScore) > 2.5m)
            {
                anomalias.Add(new TransacaoAnomala
                {
                    Valor = valor,
                    ZScore = zScore,
                    Severidade = Math.Abs(zScore) > 4 ? "Alta" : "Média"
                });
            }
        }

        return anomalias;
    }
}
```

**Exemplos**:
- Consumo médio mensal: R$ 500, Desvio: R$ 50
- Consumo X: R$ 650 → Z-Score: 3.0 → Anomalia (consumo 30% acima da normal)
- Consumo Y: R$ 350 → Z-Score: -3.0 → Anomalia (consumo 30% abaixo da normal, possível linha inativa)

---

### RN-AUD-094-03: Categorização de Severidade de Anomalias

**Descricao**: Anomalias detectadas devem ser categorizadas por severidade baseado em impacto financeiro e probabilidade de fraude.

**Justificativa**: Permite priorização de investigação manual pelos analistas de auditoria.

**Implementacao**:
```csharp
public class CategorizacaoSeveridadeAnomalia
{
    public enum SeveridadeAnomalia { Baixa, Media, Alta, Critica }

    public SeveridadeAnomalia CalcularSeveridade(
        decimal impactoFinanceiro,
        double zScore,
        string categoria)
    {
        // Impacto financeiro tem maior peso
        if (impactoFinanceiro > 10000m && Math.Abs(zScore) > 4)
            return SeveridadeAnomalia.Critica;

        if (impactoFinanceiro > 5000m || Math.Abs(zScore) > 3.5)
            return SeveridadeAnomalia.Alta;

        if (impactoFinanceiro > 1000m || Math.Abs(zScore) > 2.8)
            return SeveridadeAnomalia.Media;

        return SeveridadeAnomalia.Baixa;
    }
}
```

**Exemplos**:
- Transação R$ 50.000 com Z-Score 5.0 em categoria "Viagem" → Crítica
- Consumo de dados R$ 2.000 acima do normal → Alta (potencial roubo de chip)
- Consumo R$ 200 abaixo do normal → Baixa (possível inatividade temporária)

---

### RN-AUD-094-04: Cálculo de TCO (Total Cost of Ownership)

**Descricao**: O TCO de um ativo deve incluir aquisição, depreciação, manutenção, suporte e descarte durante seu ciclo de vida.

**Justificativa**: Fornece visão completa do custo real de um ativo para decisões de aquisição vs locação.

**Implementacao**:
```csharp
public class CalculoTCO
{
    public decimal CalcularTCO(
        decimal valorAquisicao,
        decimal depreciacaoAnual,
        decimal custoManutencaoAnual,
        decimal custoSuporteAnual,
        int anosVidaUtil,
        decimal valorResidual = 0)
    {
        var tco = valorAquisicao; // Aquisição

        // Depreciação acumulada
        tco += depreciacaoAnual * anosVidaUtil;

        // Manutenção e suporte
        tco += (custoManutencaoAnual + custoSuporteAnual) * anosVidaUtil;

        // Valor residual reduz TCO (recuperado no descarte)
        tco -= valorResidual;

        return tco;
    }

    public decimal CalcularCustoMensalTCO(decimal tco, int meses)
    {
        return tco / meses;
    }
}
```

**Exemplos**:
- Notebook adquirido por R$ 4.000: Manutenção R$ 500/ano, Suporte R$ 300/ano, Vida útil 4 anos, Valor residual R$ 1.000
  - TCO = 4.000 + (500×4) + (300×4) - 1.000 = R$ 6.200
  - Custo mensal: R$ 6.200 / 48 meses = R$ 129

---

### RN-AUD-094-05: Cálculo de ROI (Return on Investment)

**Descricao**: ROI deve ser calculado para quantificar benefício de iniciativas de otimização de custos.

**Justificativa**: Permite priorização de iniciativas baseada em retorno efetivo.

**Implementacao**:
```csharp
public class CalculoROI
{
    public decimal CalcularROI(
        decimal investimento,
        decimal beneficioAnual,
        int anos = 1)
    {
        var beneficioTotal = beneficioAnual * anos;
        var lucroLiquido = beneficioTotal - investimento;

        if (investimento == 0) return 0;
        return (lucroLiquido / investimento) * 100m;
    }

    public int CalcularPaybackPeriodo(
        decimal investimento,
        decimal beneficioMensal)
    {
        if (beneficioMensal == 0) return int.MaxValue;
        return (int)Math.Ceiling(investimento / beneficioMensal);
    }
}
```

**Exemplos**:
- Investimento em renegociação de contrato: R$ 20.000
- Economia anual esperada: R$ 60.000
- ROI = (60.000 - 20.000) / 20.000 × 100% = 200% ao ano
- Payback = 20.000 / (60.000/12) = 4 meses

---

### RN-AUD-094-06: Identificação de Desperdícios

**Descricao**: O sistema deve detectar automaticamente: ativos inativos (sem movimento > 90 dias), linhas inativas (consumo zero > 60 dias), fornecedores duplicados (CNPJ idêntico), contratos expirados e consumo anômalo.

**Justificativa**: Desperdícios são fonte principal de economia identifica e evitáveis.

**Implementacao**:
```csharp
public class DeteccaoDesperdicio
{
    public List<Desperdicio> IdentificarDesperdicos(
        List<Ativo> ativos,
        List<LinhaMovel> linhas,
        List<Fornecedor> fornecedores,
        DateTime dataReferencia)
    {
        var desperdicos = new List<Desperdicio>();

        // Ativos inativos (sem movimento > 90 dias)
        desperdicos.AddRange(ativos
            .Where(a => a.UltimoMovimento < dataReferencia.AddDays(-90))
            .Select(a => new Desperdicio
            {
                Tipo = "Ativo Inativo",
                Impacto = a.ValorDepreciacao * 0.12m, // ~12% custo anual
                Descricao = $"Ativo {a.Numero} sem movimento"
            }));

        // Linhas inativas (consumo zero > 60 dias)
        desperdicos.AddRange(linhas
            .Where(l => l.ConsumoUltimos30Dias == 0 && l.ConsumoUltimos60Dias == 0)
            .Select(l => new Desperdicio
            {
                Tipo = "Linha Inativa",
                Impacto = l.ValorMensalContrato,
                Descricao = $"Linha {l.Numero} sem consumo"
            }));

        // Fornecedores duplicados (mesmo CNPJ)
        desperdicos.AddRange(fornecedores
            .GroupBy(f => f.CNPJ)
            .Where(g => g.Count() > 1)
            .SelectMany(g => g)
            .Select(f => new Desperdicio
            {
                Tipo = "Fornecedor Duplicado",
                Impacto = f.ContratoMensal,
                Descricao = $"Fornecedor {f.RazaoSocial} duplicado"
            }));

        return desperdicos;
    }
}
```

**Exemplos**:
- Notebook alocado em 2023, sem movimentação em 2025 → Ativo inativo (economia potencial: deprec. anual)
- Linha chip 11999999999, sem consumo desde outubro → Linha inativa (economia: R$ 89/mês × 12 = R$ 1.068/ano)
- CNPJ 12.345.678/0001-90 cadastrado 2× com contratos distintos → Fornecedor duplicado (renegociar)

---

### RN-AUD-094-07: Alertas de Não-Conformidade Automáticos

**Descricao**: Sistema deve gerar alertas automáticos para: gastos acima do limite de política, fornecedores não aprovados, linhas sem SLA ativo, contratos proximos do vencimento, aprovações pendentes.

**Justificativa**: Alertas proativos previnem violações de compliance e retrabalho.

**Implementacao**:
```csharp
public class GeneradorAlertasNaoConformidade
{
    public List<AlertaConformidade> GerarAlertas(
        ContextoAuditoria contexto,
        PoliticaEmpresa politica)
    {
        var alertas = new List<AlertaConformidade>();

        // 1. Gastos acima do limite
        var gastosAltosFilial = contexto.Faturas
            .Where(f => f.DataEmissao >= DateTime.Now.AddMonths(-1))
            .GroupBy(f => f.FilialId)
            .Where(g => g.Sum(f => f.ValorTotal) > politica.LimiteGastoMensalFilial)
            .Select(g => new AlertaConformidade
            {
                Tipo = AlertaTipo.GastoAltoFilial,
                Severidade = "Alta",
                Mensagem = $"Filial {g.Key} gastou acima do limite: {g.Sum(f => f.ValorTotal):C}",
                AcaoRecomendada = "Revisar faturas e buscar economia"
            });
        alertas.AddRange(gastosAltosFilial);

        // 2. Fornecedores não aprovados
        var fornecedoresNaoAprovados = contexto.Faturas
            .Where(f => !politica.FornecedoresAprovados.Contains(f.FornecedorId) &&
                        f.DataEmissao >= DateTime.Now.AddMonths(-1))
            .Select(f => new AlertaConformidade
            {
                Tipo = AlertaTipo.FornecedorNaoAprovado,
                Severidade = "Crítica",
                Mensagem = $"Fatura emitida por fornecedor não aprovado: {f.Fornecedor.RazaoSocial}",
                AcaoRecomendada = "Solicitar aprovação ou cancelar contrato"
            });
        alertas.AddRange(fornecedoresNaoAprovados);

        // 3. Contratos proximos do vencimento (< 30 dias)
        var contratosPoximos = contexto.Contratos
            .Where(c => c.DataVencimento >= DateTime.Now &&
                       c.DataVencimento < DateTime.Now.AddDays(30) &&
                       c.Status != "Renovado")
            .Select(c => new AlertaConformidade
            {
                Tipo = AlertaTipo.ContratoProximoVencimento,
                Severidade = "Média",
                Mensagem = $"Contrato {c.Numero} vence em {(c.DataVencimento - DateTime.Now).Days} dias",
                AcaoRecomendada = "Renovar ou renegociar contrato"
            });
        alertas.AddRange(contratosPoximos);

        return alertas;
    }
}
```

**Exemplos**:
- Filial SP gasta R$ 250.000/mês (limite R$ 200.000) → Alerta Alta: "Revisar faturas"
- Fatura recebida de fornecedor não cadastrado em "Fornecedores Aprovados" → Alerta Crítica
- Contrato vence em 20 dias → Alerta Média: "Agendar renegociação"

---

### RN-AUD-094-08: Auditoria de Acesso com LGPD

**Descricao**: Todas as operações de leitura, modificação e exportação de dados de auditoria devem ser registradas com usuário, timestamp, IP e dados acessados. Retenção mínima 7 anos conforme LGPD.

**Justificativa**: LGPD artigo 7° exige rastreamento de tratamento de dados pessoais. Auditoria é defensável em caso de litígio.

**Implementacao**:
```csharp
public class AuditoriaAcessoLGPD
{
    public class RegistroAuditoria
    {
        public Guid Id { get; set; }
        public Guid ClienteId { get; set; } // Multi-tenancy
        public string Usuario { get; set; }
        public string Operacao { get; set; } // READ, MODIFY, EXPORT, DELETE
        public string Recurso { get; set; } // Relatório, Dashboard, etc
        public string IpAddress { get; set; }
        public DateTime Timestamp { get; set; }
        public string DadosAccessados { get; set; } // JSON: quais campos?
        public string DadosAntigos { get; set; } // Before image
        public string DadosNovos { get; set; } // After image
        public string MotivoBusiness { get; set; } // Por que acessou?
        public bool FlExcluido { get; set; } // Soft delete
    }

    public async Task<Guid> RegistrarAcessoAsync(
        Guid clienteId,
        string usuario,
        string operacao,
        string recurso,
        string ipAddress,
        object dados)
    {
        var registro = new RegistroAuditoria
        {
            Id = Guid.NewGuid(),
            ClienteId = clienteId,
            Usuario = usuario,
            Operacao = operacao,
            Recurso = recurso,
            IpAddress = ipAddress,
            Timestamp = DateTime.UtcNow,
            DadosAccessados = JsonConvert.SerializeObject(dados),
            FlExcluido = false
        };

        _context.AuditoriaLGPD.Add(registro);
        await _context.SaveChangesAsync();

        // Agendar limpeza após 7 anos
        _hangfireClient.Schedule<LimpezaAuditoriaLGPDJob>(
            x => x.LimparRegistrosAntigos(clienteId, DateTime.UtcNow.AddYears(7)),
            TimeSpan.FromDays(7 * 365));

        return registro.Id;
    }
}
```

**Exemplos**:
- João da Silva (usuário) exportou relatório "Custos por Fornecedor" em 2025-12-28 10:30 de IP 192.168.1.100
- Sistema registra: quais colunas (fornecedor, valor, período), quantidade de linhas, formato (PDF/Excel)
- Registro mantido até 2032-12-28 e então soft-deletado (nunca excluído fisicamente)

---

### RN-AUD-094-09: Cálculo de Depreciação de Ativos

**Descricao**: Depreciação deve ser calculada mensalmente usando método linear: (Valor - Residual) / Vida Útil = Depreciação Anual. Suportar também método acelerado (depreciação de 50% no primeiro ano).

**Justificativa**: Necessário para cálculos de TCO e análises financeiras conforme normas contábeis (NPC, IFRS).

**Implementacao**:
```csharp
public class CalculoDepreciacao
{
    public enum MetodoDepreciacao { Linear, Acelerado }

    public decimal CalcularDepreciacaoMensal(
        decimal valorOriginal,
        decimal valorResidual,
        int anosVidaUtil,
        MetodoDepreciacao metodo)
    {
        var valorDepreciavel = valorOriginal - valorResidual;

        if (metodo == MetodoDepreciacao.Linear)
        {
            return valorDepreciavel / (anosVidaUtil * 12m);
        }
        else // Acelerado: 50% no primeiro ano
        {
            // TODO: implementar lógica de aceleração
            var depreciacaoAnual = valorDepreciavel / anosVidaUtil;
            var depreciacaoMensalAno1 = (depreciacaoAnual * 0.5m) / 12m;
            var depreciacaoMensalProx = (depreciacaoAnual * 0.5m) / ((anosVidaUtil - 1) * 12m);

            return depreciacaoMensalAno1; // Retorna valor para ano 1
        }
    }

    public async Task ProcessarDepreciacaoMensalAsync(
        Guid clienteId,
        DateTime mesReferencia)
    {
        var ativos = await _context.Ativos
            .Where(a => a.ClienteId == clienteId && !a.FlExcluido)
            .ToListAsync();

        var hoje = DateTime.UtcNow.Date;

        foreach (var ativo in ativos)
        {
            var diasDesdeAquisicao = (hoje - ativo.DataAquisicao).Days;
            if (diasDesdeAquisicao < 30) continue; // Não deprecia em primeiro mês

            var depreciacao = CalcularDepreciacaoMensal(
                ativo.ValorOriginal,
                ativo.ValorResidual,
                ativo.AnosVidaUtil,
                ativo.MetodoDepreciacao);

            ativo.ValorDepreciado += depreciacao;
            ativo.AlteradoEm = DateTime.UtcNow;
            ativo.AlteradoPor = "SISTEMA_DEPRECIACAO";
        }

        await _context.SaveChangesAsync();
    }
}
```

**Exemplos**:
- Notebook adquirido R$ 4.000, vida útil 4 anos, valor residual R$ 500
  - Depreciação mensal linear = (4.000 - 500) / 48 = R$ 72,92/mês
  - Após 12 meses: Valor depreciado = R$ 875
  - Valor contábil = R$ 4.000 - R$ 875 = R$ 3.125

---

### RN-AUD-094-10: Jobs de Análise Batch (Hangfire)

**Descricao**: Sistema deve agendar jobs noturnos (02:00 UTC) para: detecção de anomalias, cálculo de depreciação, análise de tendências, previsões de custo, limpeza de auditoria antiga.

**Justificativa**: Processamento batch evita overhead em horário de pico. Análises complexas requerem volume de dados grande.

**Implementacao**:
```csharp
[DisableConcurrentExecution(timeoutInSeconds: 3600)]
public class AnaliseBatchAuditoriaJob
{
    public async Task ExecutarAnaliseAnomalias(Guid clienteId)
    {
        var periodo = new DateTime(DateTime.UtcNow.Year, DateTime.UtcNow.Month, 1)
            .AddMonths(-1);

        var faturas = await _context.Faturas
            .Where(f => f.ClienteId == clienteId &&
                       f.DataEmissao.Year == periodo.Year &&
                       f.DataEmissao.Month == periodo.Month)
            .ToListAsync();

        // Agrupar por fornecedor e executar Z-score
        var porFornecedor = faturas.GroupBy(f => f.FornecedorId);

        foreach (var grupo in porFornecedor)
        {
            var valores = grupo.Select(f => f.ValorTotal).ToList();
            var detector = new DeteccaoAnomaliasZScore();
            var anomalias = detector.DetectarAnomalias(valores);

            // Persistir resultados
            foreach (var anomalia in anomalias)
            {
                _context.AnomaliasCustos.Add(new AnomaliaCusto
                {
                    ClienteId = clienteId,
                    FornecedorId = grupo.Key,
                    DataAnalise = DateTime.UtcNow,
                    ZScore = anomalia.ZScore,
                    Severidade = anomalia.Severidade,
                    Status = "Pendente Análise",
                    FlExcluido = false
                });
            }
        }

        await _context.SaveChangesAsync();
    }

    public async Task ExecutarDepreciacaoMensal(Guid clienteId)
    {
        var calculadora = new CalculoDepreciacao();
        await calculadora.ProcessarDepreciacaoMensalAsync(clienteId, DateTime.UtcNow);
    }
}

// Configuração no Program.cs
public static void ConfigurarHangfire(this IServiceCollection services)
{
    services.AddHangfire(config => config
        .SetDataCompatibilityLevel(CompatibilityLevel.Version_180)
        .UseSimpleAssemblyNameTypeSerializer()
        .UseRecommendedSerializerSettings()
        .UseSqlServerStorage(connectionString));

    services.AddHangfireServer();

    // Agendar jobs
    RecurringJob.AddOrUpdate<AnaliseBatchAuditoriaJob>(
        nameof(AnaliseBatchAuditoriaJob),
        x => x.ExecutarAnaliseAnomalias(default),
        "0 2 * * *", // 02:00 UTC diariamente
        TimeZoneInfo.Utc);
}
```

**Exemplos**:
- 02:00 UTC: Job detecta anomalias do mês anterior, persiste em tabela AnomaliaCusto
- Usuário acessa dashboard pela manhã, vê anomalias já processadas
- Se anomalia crítica, alerta enviado ao gerente de contrato por email automático

---

## 3. REFERENCIAS AO LEGADO

### 3.1 Banco de Dados Legado

**Banco**: `[Bases 18 clientes legados - Alpargatas, Vale, Bombril, etc]`

**Tabelas Principais Relacionadas**:

```sql
-- Tabela de Faturas (núcleo de análise de custos)
CREATE TABLE [dbo].[Fatura] (
    [Id]                    UNIQUEIDENTIFIER    NOT NULL    DEFAULT NEWID(),
    [ClienteId]             UNIQUEIDENTIFIER    NOT NULL,
    [FornecedorId]          UNIQUEIDENTIFIER    NOT NULL,
    [NumeroFatura]          VARCHAR(50)         NOT NULL,
    [DataEmissao]           DATE                NOT NULL,
    [DataVencimento]        DATE                NOT NULL,
    [DataPagamento]         DATE                NULL,
    [ValorBruto]            DECIMAL(18,2)       NOT NULL,
    [Desconto]              DECIMAL(18,2)       NULL,
    [ValorTotal]            DECIMAL(18,2)       NOT NULL,
    [Status]                VARCHAR(50)         DEFAULT 'Pendente',
    [MotivoOuObservacoes]   NVARCHAR(MAX)       NULL,
    [FlExcluido]            BIT                 NOT NULL    DEFAULT 0,

    [CriadoPor]             NVARCHAR(450)       NULL,
    [CriadoEm]              DATETIME2           NOT NULL    DEFAULT GETUTCDATE(),
    [AlteradoPor]           NVARCHAR(450)       NULL,
    [AlteradoEm]            DATETIME2           NULL,

    CONSTRAINT [PK_Fatura] PRIMARY KEY CLUSTERED ([Id]),
    CONSTRAINT [FK_Fatura_Cliente] FOREIGN KEY ([ClienteId]) REFERENCES [dbo].[Cliente]([Id]),
    CONSTRAINT [FK_Fatura_Fornecedor] FOREIGN KEY ([FornecedorId]) REFERENCES [dbo].[Fornecedor]([Id])
);

CREATE NONCLUSTERED INDEX [IX_Fatura_ClienteId_DataEmissao]
    ON [dbo].[Fatura] ([ClienteId], [DataEmissao]) WHERE [FlExcluido] = 0;
CREATE NONCLUSTERED INDEX [IX_Fatura_FornecedorId]
    ON [dbo].[Fatura] ([FornecedorId]) WHERE [FlExcluido] = 0;

-- Tabela de Linhas Móveis (análise de consumo telecom)
CREATE TABLE [dbo].[LinhaMovel] (
    [Id]                    UNIQUEIDENTIFIER    NOT NULL,
    [ClienteId]             UNIQUEIDENTIFIER    NOT NULL,
    [NumeroLinha]           VARCHAR(11)         NOT NULL,
    [OperadoraId]           UNIQUEIDENTIFIER    NOT NULL,
    [ConsumidorId]          UNIQUEIDENTIFIER    NULL,
    [DataAtivacao]          DATE                NOT NULL,
    [DataDesativacao]       DATE                NULL,
    [PlanoId]               UNIQUEIDENTIFIER    NOT NULL,
    [ValorMensal]           DECIMAL(18,2)       NOT NULL,
    [Status]                VARCHAR(50)         DEFAULT 'Ativa',
    [FlExcluido]            BIT                 NOT NULL    DEFAULT 0,

    CONSTRAINT [PK_LinhaMovel] PRIMARY KEY CLUSTERED ([Id]),
    CONSTRAINT [FK_LinhaMovel_Operadora] FOREIGN KEY ([OperadoraId]) REFERENCES [dbo].[Operadora]([Id]),
    CONSTRAINT [FK_LinhaMovel_Consumidor] FOREIGN KEY ([ConsumidorId]) REFERENCES [dbo].[Consumidor]([Id])
);

-- Tabela de Consumo (detalhe de gastos telecom)
CREATE TABLE [dbo].[ConsumoLinhaMovel] (
    [Id]                    UNIQUEIDENTIFIER    NOT NULL,
    [ClienteId]             UNIQUEIDENTIFIER    NOT NULL,
    [LinhaMovelId]          UNIQUEIDENTIFIER    NOT NULL,
    [MesReferencia]         DATE                NOT NULL,
    [ConsumoVoz]            DECIMAL(18,2)       NOT NULL,
    [ConsumoSMS]            DECIMAL(18,2)       NOT NULL,
    [ConsumoInternet]       DECIMAL(18,2)       NOT NULL,
    [ValorTotal]            DECIMAL(18,2)       NOT NULL,
    [FlExcluido]            BIT                 NOT NULL    DEFAULT 0,

    CONSTRAINT [PK_ConsumoLinhaMovel] PRIMARY KEY CLUSTERED ([Id]),
    CONSTRAINT [FK_ConsumoLinhaMovel_Linha] FOREIGN KEY ([LinhaMovelId]) REFERENCES [dbo].[LinhaMovel]([Id])
);

-- Tabela de Contratos (análise de conformidade contratual)
CREATE TABLE [dbo].[Contrato] (
    [Id]                    UNIQUEIDENTIFIER    NOT NULL,
    [ClienteId]             UNIQUEIDENTIFIER    NOT NULL,
    [FornecedorId]          UNIQUEIDENTIFIER    NOT NULL,
    [NumeroContrato]        VARCHAR(50)         NOT NULL,
    [DataInicio]            DATE                NOT NULL,
    [DataVencimento]        DATE                NOT NULL,
    [ValorMensal]           DECIMAL(18,2)       NOT NULL,
    [Descricao]             NVARCHAR(MAX)       NULL,
    [Status]                VARCHAR(50)         DEFAULT 'Ativo',
    [FlExcluido]            BIT                 NOT NULL    DEFAULT 0,

    CONSTRAINT [PK_Contrato] PRIMARY KEY CLUSTERED ([Id]),
    CONSTRAINT [FK_Contrato_Fornecedor] FOREIGN KEY ([FornecedorId]) REFERENCES [dbo].[Fornecedor]([Id])
);

-- Tabela de Ativos (análise de depreciação)
CREATE TABLE [dbo].[Ativo] (
    [Id]                    UNIQUEIDENTIFIER    NOT NULL,
    [ClienteId]             UNIQUEIDENTIFIER    NOT NULL,
    [NumeroSerie]           VARCHAR(100)        NOT NULL,
    [DataAquisicao]         DATE                NOT NULL,
    [ValorAquisicao]        DECIMAL(18,2)       NOT NULL,
    [ValorResidual]         DECIMAL(18,2)       NULL,
    [AnosVidaUtil]          INT                 NOT NULL,
    [DataUltimoMovimento]   DATETIME2           NULL,
    [Status]                VARCHAR(50)         DEFAULT 'Ativo',
    [FlExcluido]            BIT                 NOT NULL    DEFAULT 0,

    CONSTRAINT [PK_Ativo] PRIMARY KEY CLUSTERED ([Id])
);

-- Tabela de Centros de Custo (rateio de despesas)
CREATE TABLE [dbo].[Centro_Custo] (
    [Id]                    UNIQUEIDENTIFIER    NOT NULL,
    [ClienteId]             UNIQUEIDENTIFIER    NOT NULL,
    [FilialId]              UNIQUEIDENTIFIER    NOT NULL,
    [Nm_Centro_Custo]       NVARCHAR(100)       NOT NULL,
    [Codigo_Centro_Custo]   VARCHAR(50)         NULL,
    [Orcamento_Mensal]      DECIMAL(18,2)       NULL,
    [FlExcluido]            BIT                 NOT NULL    DEFAULT 0,

    CONSTRAINT [PK_Centro_Custo] PRIMARY KEY CLUSTERED ([Id]),
    CONSTRAINT [FK_Centro_Custo_Filial] FOREIGN KEY ([FilialId]) REFERENCES [dbo].[Filial]([Id])
);

-- Tabela de Fornecedores (gestão de fornecedores aprovados)
CREATE TABLE [dbo].[Fornecedor] (
    [Id]                    UNIQUEIDENTIFIER    NOT NULL,
    [ClienteId]             UNIQUEIDENTIFIER    NOT NULL,
    [RazaoSocial]           NVARCHAR(200)       NOT NULL,
    [CNPJ]                  VARCHAR(14)         NOT NULL,
    [Aprovado]              BIT                 NOT NULL    DEFAULT 0,
    [DataAprovacao]         DATE                NULL,
    [FlExcluido]            BIT                 NOT NULL    DEFAULT 0,

    CONSTRAINT [PK_Fornecedor] PRIMARY KEY CLUSTERED ([Id])
);
```

**Campos Importantes**:

| Campo Legado | Descricao | Uso no Modernizado |
|--------------|-----------|-------------------|
| `Fatura.ValorTotal` | Valor líquido da fatura | Base para análise de custos, detecção de anomalias |
| `Fatura.DataEmissao` | Data de emissão | Agrupamento temporal (mensal, trimestral) |
| `LinhaMovel.ValorMensal` | Custo mensal do plano | Baseline para comparação com consumo real |
| `ConsumoLinhaMovel.ValorTotal` | Valor cobrado de consumo | Detecção de sobretarifa e anomalias |
| `Contrato.ValorMensal` | Valor contratado | Análise de variância (contratado vs realizado) |
| `Ativo.ValorAquisicao` | Preço de compra | Base para cálculo de TCO e depreciação |
| `Ativo.DataAquisicao` | Data de compra | Cálculo de tempo de vida e inatividade |
| `Centro_Custo.Orcamento_Mensal` | Orçamento aprovado | Análise de variância de orçamento |
| `Fornecedor.Aprovado` | Flag de aprovação | Alerta de conformidade (fornecedor não aprovado) |

### 3.2 Stored Procedures Legado

| Procedure | Descricao | Migracao |
|-----------|-----------|----------|
| `pa_CustosPorFornecedor` | Agrega custos mensais por fornecedor com comparação ao mês anterior | Convertida para Query EF Core + LINQ |
| `pa_AnaliseVariancia` | Compara orçamento vs realizado por centro de custo | Implementada como Handler + Query |
| `pa_DeteccaoAnomalias` | Simples verificação de valores extremos (MAX, MIN) | Melhorada com Z-score e Isolation Forest |
| `pa_DepreciacaoMensal` | Calcula depreciação linear de ativos | Job Hangfire com lógica aprimorada |
| `pa_CustosTelecom` | Agrega consumo + plano de linhas móveis | Query EF Core com group by |
| `pa_LimparAuditoria` | Deleta registros de auditoria > 90 dias | Soft delete com retenção 7 anos (LGPD) |

### 3.3 Telas ASPX Legado

| Pagina | Descricao | Tela Moderna |
|--------|-----------|--------------|
| `RelatoriosCustos.aspx` | Relatórios estáticos em tabela, export PDF | `/financeiro/auditoria/relatorios` (Angular) |
| `AnaliseVariancia.aspx` | Análise manual de variância com filtros | `/financeiro/auditoria/variancia` (Dashboard interativo) |
| `AnomaliasCustos.aspx` | Lista de anomalias detectadas manualmente | `/financeiro/auditoria/anomalias` (Com filtro automático) |
| `CustosporFornecedor.aspx` | Custos agrupados por fornecedor | `/financeiro/auditoria/custos-fornecedor` (Drill-down) |
| `DepreciacaoAtivos.aspx` | Relatório de depreciação | `/financeiro/auditoria/depreciacao` (Com histórico mensal) |
| `ConformidadeComplianceaspx` | Check-list manual de conformidade | `/financeiro/auditoria/compliance` (Alertas automáticos) |

### 3.4 WebServices Legado (VB.NET)

**Arquivo**: `D:\IC2\ic1_legado\WebService\WS[Auditoria|Custos|Compliance].asmx.vb`

| Metodo | Descricao | Endpoint Moderno |
|--------|-----------|-----------------|
| `GetCustosPorFornecedor(dataInicio, dataFim)` | Retorna custo agrupado por fornecedor | `GET /api/auditoria/custos/por-fornecedor?dataInicio=&dataFim=` |
| `CalcularVariancia(ccId, dataInicio, dataFim)` | Calcula variância para centro de custo | `GET /api/auditoria/variancia?centrocustoId=&dataInicio=&dataFim=` |
| `DetectarAnomalias(fornecedorId)` | Detecta anomalias de custo (legado: usa MAX/MIN) | `POST /api/auditoria/anomalias/detectar` |
| `ExportarRelatorio(tipo, formato)` | Exporta relatório em PDF ou Excel | `GET /api/auditoria/relatorios/exportar?tipo=&formato=` |
| `CalcularDepreciacao(ativoId)` | Calcula depreciação de um ativo | `GET /api/auditoria/depreciacacao/{ativoId}` |
| `VerificarCompliance(clienteId)` | Verifica violações de conformidade | `GET /api/auditoria/compliance/verificar` |

---

## 4. INTEGRACOES OBRIGATORIAS

### 4.1 Central de Funcionalidades (Feature Flags)

**FeatureKey**: `AUDITORIA_CUSTOS_COMPLIANCE`

**Configuracao**:
```json
{
    "featureKey": "AUDITORIA_CUSTOS_COMPLIANCE",
    "nome": "Módulo de Auditoria de Custos e Compliance",
    "descricao": "Análise de custos, detecção de anomalias, alertas de conformidade",
    "habilitado": true,
    "isSystemFeature": false,
    "subFeatures": [
        {
            "key": "AUDITORIA_ANALISE_VARIANCIA",
            "nome": "Análise de Variância",
            "habilitado": true
        },
        {
            "key": "AUDITORIA_DETECCAO_ANOMALIAS",
            "nome": "Detecção Automática de Anomalias",
            "habilitado": true
        },
        {
            "key": "AUDITORIA_TCO_ROI",
            "nome": "Cálculo de TCO e ROI",
            "habilitado": true
        },
        {
            "key": "AUDITORIA_JOBS_BATCH",
            "nome": "Jobs de Análise Batch (Hangfire)",
            "habilitado": true
        },
        {
            "key": "AUDITORIA_ML_ANOMALIAS",
            "nome": "Machine Learning para Anomalias (Azure ML/Scikit-learn)",
            "habilitado": false
        }
    ]
}
```

**Nota**: Feature flags permitem ativar/desativar análises avançadas (ML) sem alterar código. Útil para clientes premium vs básico.

---

### 4.2 Internacionalizacao (i18n)

**Chaves de Traducao**:

```json
{
    "auditoria": {
        "titulo": "Auditoria de Custos e Compliance",
        "menu": "Auditoria",
        "nav": {
            "analiseVariancia": "Análise de Variância",
            "deteccaoAnomalias": "Anomalias Detectadas",
            "calculoTCO": "TCO de Ativos",
            "relatorios": "Relatórios",
            "compliance": "Conformidade",
            "dashboards": "Dashboards"
        },
        "analiseVariancia": {
            "titulo": "Análise de Variância de Custos",
            "descricao": "Comparação entre custo planejado e realizado",
            "labels": {
                "periodo": "Período",
                "centroCusto": "Centro de Custo",
                "fornecedor": "Fornecedor",
                "custoPlano": "Custo Planejado",
                "custoRealizado": "Custo Realizado",
                "variancia": "Variância",
                "percentual": "Percentual",
                "classificacao": "Classificação"
            },
            "messages": {
                "loading": "Calculando variâncias...",
                "success": "Variâncias calculadas com sucesso",
                "error": "Erro ao calcular variâncias"
            },
            "classification": {
                "aceitavel": "Aceitável",
                "aviso": "Aviso",
                "critico": "Crítico"
            }
        },
        "deteccaoAnomalias": {
            "titulo": "Detecção de Anomalias",
            "descricao": "Transações atípicas identificadas pelo sistema",
            "labels": {
                "data": "Data",
                "fornecedor": "Fornecedor",
                "valor": "Valor",
                "zScore": "Z-Score",
                "severidade": "Severidade",
                "status": "Status",
                "acaoRecomendada": "Ação Recomendada"
            },
            "severidade": {
                "baixa": "Baixa",
                "media": "Média",
                "alta": "Alta",
                "critica": "Crítica"
            },
            "status": {
                "novo": "Novo",
                "investigando": "Investigando",
                "resolvido": "Resolvido",
                "falsoPositivo": "Falso Positivo"
            }
        },
        "compliance": {
            "titulo": "Conformidade e Alertas",
            "descricao": "Violações de política corporativa e regulatória",
            "alertas": {
                "gastoAlto": "Gasto acima do limite de política",
                "fornecedorNaoAprovado": "Fornecedor não aprovado",
                "contratoVencimento": "Contrato próximo do vencimento",
                "linhaInativa": "Linha de telefone inativa",
                "aprovacaoPendente": "Aprovação pendente"
            }
        },
        "tco": {
            "titulo": "Total Cost of Ownership (TCO)",
            "labels": {
                "ativo": "Ativo",
                "valorAquisicao": "Valor de Aquisição",
                "manutencao": "Manutenção Anual",
                "suporte": "Suporte Anual",
                "vidaUtil": "Vida Útil (anos)",
                "valorResidual": "Valor Residual",
                "tcoTotal": "TCO Total",
                "custoMensal": "Custo Mensal"
            }
        },
        "roi": {
            "titulo": "Return on Investment (ROI)",
            "labels": {
                "iniciativa": "Iniciativa",
                "investimento": "Investimento",
                "beneficioAnual": "Benefício Anual",
                "roi": "ROI (%)",
                "payback": "Payback (meses)"
            }
        },
        "relatorios": {
            "titulo": "Relatórios de Auditoria",
            "tipos": {
                "custosPorFornecedor": "Custos por Fornecedor",
                "variancia": "Análise de Variância",
                "anomalias": "Anomalias Detectadas",
                "compliance": "Relatório de Compliance",
                "desperdicio": "Identificação de Desperdícios",
                "depreciacao": "Relatório de Depreciação"
            },
            "formatos": {
                "pdf": "PDF",
                "excel": "Excel",
                "csv": "CSV"
            }
        },
        "validation": {
            "periodoObrigatorio": "Período é obrigatório",
            "dataInvalida": "Data inválida",
            "fornecedorObrigatorio": "Fornecedor é obrigatório"
        }
    }
}
```

---

### 4.3 Auditoria

**Operacoes Auditadas**:

| Operacao | Codigo | Dados Registrados |
|----------|--------|-------------------|
| Gerar Relatório de Custos | `AUD_RELATORIO_CUSTOS_VIEW` | Relatório ID, período, fornecedores filtrados, usuário, timestamp |
| Exportar Relatório | `AUD_RELATORIO_EXPORT` | Tipo (PDF/Excel), formato, quantidade registros, usuário, IP |
| Modificar Classificação de Anomalia | `AUD_ANOMALIA_UPDATE` | Anomalia ID, status anterior/novo, motivo, usuário |
| Gerar Alerta de Não-Conformidade | `AUD_ALERTA_CREATE` | Tipo alerta, severidade, contexto (fornecedor/contrato), timestamp |
| Acessar Dashboard Executivo | `AUD_DASHBOARD_VIEW` | Seções acessadas, filtros aplicados, usuário, duração |

**Retencao**: 7 anos (LGPD) - soft delete, nunca excluído fisicamente

---

### 4.4 Controle de Acesso (RBAC)

**Permissoes**:

| Permissao | Descricao | Perfis |
|-----------|-----------|--------|
| `aud:auditoria:view` | Visualizar módulo de auditoria | Super Admin, Developer, Cliente Admin, Gestor, Auditor |
| `aud:variancia:view` | Visualizar análise de variância | Super Admin, Cliente Admin, Gestor, Auditor |
| `aud:variancia:exportar` | Exportar análise de variância | Super Admin, Cliente Admin, Auditor |
| `aud:anomalias:view` | Visualizar anomalias detectadas | Super Admin, Cliente Admin, Gestor, Auditor |
| `aud:anomalias:investigar` | Marcar anomalia como investigando | Super Admin, Cliente Admin, Auditor |
| `aud:anomalias:resolver` | Resolver anomalia (falso positivo, etc) | Super Admin, Cliente Admin, Auditor |
| `aud:compliance:view` | Visualizar alertas de conformidade | Super Admin, Cliente Admin, Gestor, Auditor |
| `aud:compliance:remediar` | Abrir chamado para remediar alerta | Super Admin, Cliente Admin, Gestor |
| `aud:relatorios:view` | Visualizar relatórios | Super Admin, Cliente Admin, Gestor, Auditor, Operador |
| `aud:relatorios:gerar` | Gerar novos relatórios | Super Admin, Cliente Admin, Auditor |
| `aud:relatorios:exportar` | Exportar relatórios (PDF, Excel) | Super Admin, Cliente Admin, Auditor |
| `aud:tco:calcular` | Calcular TCO de ativos | Super Admin, Cliente Admin, Gestor |
| `aud:roi:calcular` | Calcular ROI de iniciativas | Super Admin, Cliente Admin, Gestor |
| `aud:dashboard:view` | Acessar dashboard executivo | Super Admin, Cliente Admin, Gestor |

**Nota**: Operador pode apenas visualizar relatórios (view), não pode exportar ou modificar. Auditor tem acesso completo mas não pode executar ações (como remediar alertas).

---

## 5. ENDPOINTS DA API

### 5.1 CRUD Principal

| Metodo | Endpoint | Descricao | Permissao |
|--------|----------|-----------|-----------|
| GET | `/api/auditoria/variancia?dataInicio=&dataFim=&centrocustoId=` | Listar análises de variância | `aud:variancia:view` |
| GET | `/api/auditoria/variancia/{id}` | Obter análise de variância específica | `aud:variancia:view` |
| POST | `/api/auditoria/variancia` | Criar nova análise de variância | `aud:variancia:create` |
| PUT | `/api/auditoria/variancia/{id}` | Atualizar análise de variância | `aud:variancia:update` |
| DELETE | `/api/auditoria/variancia/{id}` | Excluir análise de variância (soft delete) | `aud:variancia:delete` |

### 5.2 Operacoes Especiais

| Metodo | Endpoint | Descricao | Permissao |
|--------|----------|-----------|-----------|
| GET | `/api/auditoria/anomalias?dataInicio=&dataFim=&severidade=` | Listar anomalias detectadas | `aud:anomalias:view` |
| GET | `/api/auditoria/anomalias/{id}` | Obter detalhes de anomalia | `aud:anomalias:view` |
| POST | `/api/auditoria/anomalias/detectar` | Forçar execução de detecção de anomalias | `aud:anomalias:investigar` |
| PATCH | `/api/auditoria/anomalias/{id}/status` | Atualizar status de anomalia (investigando, resolvido) | `aud:anomalias:resolver` |
| GET | `/api/auditoria/compliance?dataInicio=&dataFim=&tipo=` | Listar alertas de conformidade | `aud:compliance:view` |
| POST | `/api/auditoria/compliance/alertas/remediar` | Criar chamado para remediar alerta | `aud:compliance:remediar` |
| GET | `/api/auditoria/desperdicos?dataInicio=&dataFim=` | Listar desperdícios identificados | `aud:auditoria:view` |
| GET | `/api/auditoria/tco/{ativoId}` | Calcular TCO de um ativo específico | `aud:tco:calcular` |
| POST | `/api/auditoria/tco/calcular-lote` | Calcular TCO para múltiplos ativos | `aud:tco:calcular` |
| GET | `/api/auditoria/roi/{inicativaId}` | Calcular ROI de uma iniciativa | `aud:roi:calcular` |
| GET | `/api/auditoria/relatorios?tipo=&dataInicio=&dataFim=` | Listar relatórios gerados | `aud:relatorios:view` |
| POST | `/api/auditoria/relatorios/gerar` | Gerar novo relatório de auditoria | `aud:relatorios:gerar` |
| GET | `/api/auditoria/relatorios/{id}/exportar?formato=pdf` | Exportar relatório em PDF | `aud:relatorios:exportar` |
| GET | `/api/auditoria/relatorios/{id}/exportar?formato=excel` | Exportar relatório em Excel | `aud:relatorios:exportar` |
| GET | `/api/auditoria/dashboard` | Obter dados do dashboard executivo | `aud:dashboard:view` |
| GET | `/api/auditoria/custos-fornecedor?dataInicio=&dataFim=` | Análise de custos por fornecedor (drill-down) | `aud:auditoria:view` |
| GET | `/api/auditoria/custos-categoria?dataInicio=&dataFim=` | Análise de custos por categoria | `aud:auditoria:view` |
| GET | `/api/auditoria/tendencias?periodo=mensal&meses=12` | Análise de tendências de custo | `aud:auditoria:view` |

---

## 6. FLUXOS PRINCIPAIS

### 6.1 Fluxo de Análise de Variância

```
Usuário acessa /auditoria/analise-variancia
    │
    ▼
Frontend exibe formulário com filtros:
- Data Início / Data Fim
- Centro de Custo (dropdown)
- Tipo de Custo (todos, TI, telecom, etc)
    │
    ▼
Usuário clica "Analisar"
    │
    ▼
Frontend chama GET /api/auditoria/variancia?dataInicio=X&dataFim=Y&centrocustoId=Z
    │
    ▼
Backend (Handler GetVarianciaQuery):
1. Valida ClienteId do usuário
2. Busca orçamentos planejados para período
3. Busca custos realizados (Faturas + Consumo + Contratos)
4. Agrupa por Centro de Custo
5. Calcula variância = Realizado - Planejado
6. Classifica: Aceitável (<5%), Aviso (5-15%), Crítico (>15%)
    │
    ▼
Backend retorna JSON com:
{
    "periodo": "2025-12",
    "centroCustoId": "abc123",
    "centroCustoNome": "TI - São Paulo",
    "custoPlanejado": 50000.00,
    "custoRealizado": 52500.00,
    "variancia": 2500.00,
    "varanciaPercentual": 5.0,
    "classificacao": "Aviso",
    "detalhes": [
        {
            "descricao": "Outsourcing",
            "plano": 30000,
            "realizado": 31000,
            "variancia": 1000,
            "varianciaPercentual": 3.3
        },
        ...
    ]
}
    │
    ▼
Frontend renderiza tabela com linhas coloridas:
- Verde: Aceitável
- Amarelo: Aviso
- Vermelho: Crítico
    │
    ▼
Usuário pode:
- Clicar em linha para drill-down (detalhes de fornecedores)
- Clicar "Exportar" para gerar PDF/Excel
- Clicar "Configurar Orçamento" para ajustar plano para próximo período
```

### 6.2 Fluxo de Detecção de Anomalias (Job Batch)

```
02:00 UTC - Hangfire dispara AnaliseBatchAuditoriaJob
    │
    ▼
Job: ExecutarAnaliseAnomalias(clienteId)
1. Busca todas as faturas do mês anterior
2. Agrupa por Fornecedor
3. Para cada fornecedor:
   a. Coleta valores (ValorTotal) dos últimos 12 meses
   b. Calcula média e desvio padrão
   c. Para cada fatura, calcula Z-Score
   d. Se |Z-Score| > 2.5, insere em tabela AnomaliaCusto
4. Para cada anomalia crítica (Z-Score > 4.0):
   a. Envia email ao gestor de contratos
   b. Cria alerta em tabela AlertaConformidade
    │
    ▼
Manhã do dia seguinte - Usuário acessa /auditoria/anomalias
    │
    ▼
Frontend exibe tabela com anomalias:
{
    "id": "anom_001",
    "data": "2025-12-25",
    "fornecedor": "Operadora TIM",
    "descricao": "Consumo de dados R$ 15.000",
    "zScore": 4.5,
    "severidade": "Crítica",
    "status": "Novo",
    "acaoRecomendada": "Investigar roubo de chip SIM"
}
    │
    ▼
Usuário clica "Investigar"
    │
    ▼
Frontend chama PATCH /api/auditoria/anomalias/{id}/status
{
    "status": "Investigando",
    "observacao": "Enviado para auditoria de segurança"
}
    │
    ▼
Backend atualiza status, registra auditoria (LGPD), envia notificação
    │
    ▼
Usuário depois clica "Resolver"
    │
    ▼
Frontend exibe dialog:
- Motivo: "Falso Positivo", "Fraude Confirmada", "Evento Legítimo"
- Observação: (textarea)
    │
    ▼
Backend atualiza status para "Resolvido", registra resolução

```

### 6.3 Fluxo de Cálculo de TCO

```
Usuário acessa /auditoria/tco
    │
    ▼
Frontend exibe lista de ativos com opção "Calcular TCO"
    │
    ▼
Usuário seleciona ativo: Notebook ID abc123
    │
    ▼
Frontend chama GET /api/auditoria/tco/abc123
    │
    ▼
Backend busca dados do ativo:
{
    "numero": "NB-001",
    "descricao": "Notebook Lenovo ThinkPad",
    "valorAquisicao": 4000.00,
    "dataAquisicao": "2022-01-15",
    "anosVidaUtil": 4,
    "valorResidual": 500.00,
    "custoManutencaoAnual": 500.00,
    "custoSuporteAnual": 300.00
}
    │
    ▼
Backend calcula:
- TCO = 4000 + (500×4) + (300×4) - 500 = R$ 6.700
- Custo mensal = 6.700 / 48 = R$ 139,58
- Depreciação total = 4000 - 500 = R$ 3.500
- Data término vida útil = 2026-01-15
    │
    ▼
Frontend exibe resultado em card:
┌─────────────────────────┐
│ Notebook Lenovo         │
│ ─────────────────────── │
│ Valor Original: R$ 4.000│
│ Manutenção/ano: R$ 500  │
│ Suporte/ano: R$ 300     │
│ Vida Útil: 4 anos       │
│ Residual: R$ 500        │
│ ───────────────────────│
│ TCO Total: R$ 6.700     │
│ Custo Mensal: R$ 139,58 │
│ Vencimento: 2026-01-15  │
└─────────────────────────┘
    │
    ▼
Usuário pode:
- Comparar com preço de locação
- Gerar relatório PDF
- Compartilhar com gestor de contratos
```

---

## 7. SEGURANCA

### 7.1 Protecoes Implementadas

| Protecao | Descricao |
|----------|-----------|
| Multi-Tenancy | Validação de ClienteId em todos os handlers + Query Filter automático do EF Core |
| Autorização RBAC | Apenas usuários com permissão `aud:auditoria:view` podem acessar o módulo |
| Auditoria LGPD | Todas as operações registradas com usuário, IP, timestamp (7 anos retenção) |
| Soft Delete | Nenhum dado permanentemente deletado (FlExcluido = true) |
| Criptografia de Transporte | TLS 1.3 em todos os endpoints |
| Validação de Entrada | FluentValidation em todos os Commands |
| SQL Injection Prevention | Entity Framework Core (ORM safe) + Parameterized Queries |
| XSS Prevention | Angular sanitização automática de conteúdo HTML |

### 7.2 Testes de Seguranca Obrigatorios

- [x] SQL Injection: Testar payload malicioso em filtros de data, fornecedor
- [x] XSS em campos de texto: Tentar injetar <script> em "Observação"
- [x] CSRF Protection: Validar token CSRF em POST/PUT/DELETE
- [x] Validacao de permissoes: Usuário sem `aud:anomalias:resolver` não pode PATCH status
- [x] Validacao de ClienteId: Usuário do Cliente A não consegue acessar dados do Cliente B
- [x] Soft Delete: Registros com FlExcluido=1 nunca retornados em queries
- [x] Auditoria LGPD: Verificar que acesso a dados sensíveis foi registrado
- [x] Expiração de Sessão: Após expiração de JWT, usuário é redirecionado para login

---

## 8. METRICAS E INDICADORES

### 8.1 KPIs

| KPI | Meta | Medicao |
|-----|------|---------|
| **Economia Identificada (mensal)** | R$ 50.000+ | Soma de economia potencial de desperdícios e renegociações |
| **Anomalias Detectadas (mensal)** | 5-20 por cliente | Contagem de anomalias com Z-Score > 2.5 |
| **Taxa de Variância Aceitável** | > 90% dos centros | Percentual de centros com variância < 5% |
| **Tempo de Resolução de Anomalia** | < 5 dias | Mediano entre detecção e resolução |
| **Taxa de Falsos Positivos** | < 20% | Anomalias marcadas como "Falso Positivo" / Total |
| **Conformidade com Política** | > 95% | Transações aprovadas / Total de transações |
| **Tempo de Resposta Dashboard** | < 2 segundos | P95 de latência ao carregar dashboard |
| **Disponibilidade do Módulo** | 99,5% | Uptime mensal do serviço |

### 8.2 Alertas

| Alerta | Condicao | Acao |
|--------|----------|------|
| **Anomalia Crítica Detectada** | Z-Score > 4.0 em gasto de fornecedor | Email ao gestor + SMS (opcional) + Card no dashboard |
| **Compliance Violado** | Transação com fornecedor não aprovado | Notificação ao compliance officer + bloquear pagamento |
| **Orçamento Excedido** | Gasto mensal > 110% do orçamento de centro | Email ao diretor do centro + sugerir economia |
| **Job Batch Falhou** | Execução de AnaliseBatchAuditoriaJob retorna erro | Alerta ao DevOps para investigação |
| **Taxa de Variância Alta** | > 15% em centro de custo | Relatório automático enviado ao gestor |
| **Contrato Vencido** | Data vencimento < hoje | Alerta crítica ao procurement |

---

## 9. PROXIMOS PASSOS

1. **Modelo de Dados**: Criar [MD-RF094](./MD-RF094.md) com DDL completo incluindo tabelas AnomaliasCustos, AlertasConformidade, RelatoriosAuditoria
2. **Casos de Uso**: Criar [UC-RF094](./UC-RF094.md) com 5+ casos de uso (UC00-UC04) descrevendo fluxos detalhados
3. **Workflows**: Criar [WF-RF094](./WF-RF094.md) com diagramas de fluxo de análises, jobs batch, geração de alertas
4. **User Stories**: Criar [user-stories.yaml](./user-stories.yaml) com stories implementáveis (mínimo 2, máximo 100 pontos totais)
5. **Testes**: Criar [TC-RF094-BACKEND.md](./TC-RF094-BACKEND.md), [TC-RF094-FRONTEND.md](./TC-RF094-FRONTEND.md), [TC-RF094-E2E.md](./TC-RF094-E2E.md)
6. **Implementação Backend**: Commands/Queries, Handlers, Validators, DTOs conforme Clean Architecture
7. **Implementação Frontend**: Componentes Angular, Services, Dashboards interativos
8. **Integração ML**: Implementar detecção de anomalias com Scikit-learn (Isolation Forest) ou Azure ML
9. **Deploy Azure**: Containerizar em Azure App Service, configurar CI/CD no DevOps
10. **Validação pelo Tester-Backend**: Submeter para aprovação formal antes de merge em dev

---

## CHANGELOG

| Versao | Data | Descricao | Autor |
|--------|------|-----------|-------|
| 1.0 | 2025-12-28 | Versao inicial com 10 regras de negócio, 13 endpoints, integrações obrigatórias | Claude Code (IA) |

---

**Ultima Atualizacao**: 2025-12-28
**Autor**: Claude Code (Sistema de IA)
**Revisao**: Pendente de aprovação pelo time de arquitetura
