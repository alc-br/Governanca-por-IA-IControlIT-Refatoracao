# Template de Referência ao Legado (RL-RF094.yaml)
# Versão: 2.0 (Adequação para Automação e Rastreabilidade)
# Data: 2025-12-31

rf_id: RF094
titulo: "Auditoria de Custos e Compliance"

legado:
  sistema: "VB.NET + ASP.NET Web Forms"
  versao: "IControlIT v1.x (2008-2024)"
  arquitetura: "Monolítica WebForms"
  banco_dados: "SQL Server 2008 R2 (18 bancos isolados, 1 por cliente)"
  multi_tenant: false
  auditoria: "none"

# ============================================================================
# SEÇÃO CRÍTICA: Referencias ao Legado com Destino Obrigatório
# Total: 25 itens (6 telas + 6 webservices + 6 stored procedures + 7 tabelas)
# ============================================================================
referencias:
  # ========== TELAS LEGADAS (6 itens) ==========
  - id: "LEG-RF094-TELA-001"
    tipo: "tela"
    nome: "RelatoriosCustos.aspx"
    caminho: "ic1_legado/IControlIT/Relatorios/RelatoriosCustos.aspx"
    descricao: |
      Tela legada para exibição de relatórios estáticos de custos agrupados por fornecedor.
      Utilizava GridView com binding direto a DataTable, sem paginação ou filtros avançados.

      Problemas críticos:
      - Sem isolamento multi-tenant (dropdown carregava fornecedores de TODOS os clientes)
      - Sem paginação (crash com > 5.000 registros - OutOfMemoryException)
      - Query sem índices (timeout > 60s)
      - Sem cache (query executada a cada postback)

    destino: "substituido"
    justificativa: |
      Tela completamente redesenhada como SPA Angular com:
      - Paginação server-side (50 registros/página)
      - Filtros avançados com debounce
      - Cache de 5 minutos
      - Isolamento multi-tenant rigoroso (WHERE EmpresaId = @empresaId)

    rf_item_relacionado: "FUNC-094-01"
    uc_relacionado: "UC01"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF094-TELA-002"
    tipo: "tela"
    nome: "AuditoriaAnomalia.aspx"
    caminho: "ic1_legado/IControlIT/Auditoria/AuditoriaAnomalia.aspx"
    descricao: |
      Tela para detecção manual de anomalias. Auditor precisava configurar threshold manualmente
      e executar análise sob demanda. Sem histórico de execuções ou algoritmo estatístico.

      Problemas críticos:
      - Threshold fixo global (sem customização por categoria)
      - Sem algoritmo estatístico (apenas comparação simples > X%)
      - Sem histórico de análises (impossível auditar decisões passadas)

    destino: "substituido"
    justificativa: |
      Sistema moderno implementa:
      - Algoritmo Z-score (detecção estatística com threshold 2.5σ)
      - Threshold configurável por categoria (tabela AuditoriaThreshold)
      - Análise batch via Hangfire (execução automática diária)
      - Histórico completo de análises (tabela AuditoriaAnaliseHistorico)

    rf_item_relacionado: "FUNC-094-02"
    uc_relacionado: "UC02"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF094-TELA-003"
    tipo: "tela"
    nome: "HistoricoAuditoria.aspx"
    caminho: "ic1_legado/IControlIT/Auditoria/HistoricoAuditoria.aspx"
    descricao: |
      Tela para consulta de histórico de auditorias. Exibia lista simples sem agrupamento,
      filtros limitados (apenas por data), sem exportação.

      Problemas críticos:
      - Sem retenção automática (registros podiam ser deletados manualmente - violação LGPD)
      - Sem exportação estruturada (apenas print screen)
      - Filtros limitados (só data - busca manual demorada)

    destino: "substituido"
    justificativa: |
      Sistema moderno garante:
      - Retenção automática de 7 anos (soft delete + job de arquivamento)
      - Exportação completa (Excel/PDF/JSON)
      - Filtros avançados (data, usuário, tipo, status, categoria)
      - Assinatura digital dos registros (imutabilidade via HMAC-SHA256)

    rf_item_relacionado: "FUNC-094-08"
    uc_relacionado: "UC03"
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF094-TELA-004"
    tipo: "tela"
    nome: "ConfiguracaoThreshold.aspx"
    caminho: "ic1_legado/IControlIT/Configuracoes/ConfiguracaoThreshold.aspx"
    descricao: |
      Tela para configuração de threshold global de anomalias. Valor único aplicado a
      todas as categorias, sem histórico de alterações.

      Problemas:
      - Threshold único global (não customizável por categoria)
      - Sem histórico de alterações (impossível rastrear mudanças de configuração)

    destino: "substituido"
    justificativa: |
      Sistema moderno permite:
      - Threshold customizável por categoria (tabela AuditoriaThreshold)
      - Histórico completo de alterações com auditoria automática
      - Sugestão automática de threshold baseada em análise estatística

    rf_item_relacionado: "FUNC-094-11"
    uc_relacionado: "UC04"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF094-TELA-005"
    tipo: "tela"
    nome: "DashboardAuditoria.aspx"
    caminho: "ic1_legado/IControlIT/Dashboard/DashboardAuditoria.aspx"
    descricao: |
      Dashboard com gráficos estáticos (Crystal Reports) mostrando KPIs básicos de auditoria.
      Sem drill-down, sem filtros, sem atualização automática.

      Problemas:
      - Gráficos estáticos (Crystal Reports - lento e sem interatividade)
      - Sem atualização automática (dados desatualizados, refresh manual via F5)

    destino: "substituido"
    justificativa: |
      Dashboard moderno com:
      - Gráficos interativos (ApexCharts) com drill-down
      - Atualização automática via SignalR (real-time)
      - Filtros avançados (período, categoria, status)
      - 8 KPIs críticos com indicadores de tendência

    rf_item_relacionado: "FUNC-094-10"
    uc_relacionado: "UC05"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF094-TELA-006"
    tipo: "tela"
    nome: "AprovacaoAjustes.aspx"
    caminho: "ic1_legado/IControlIT/Auditoria/AprovacaoAjustes.aspx"
    descricao: |
      Tela para aprovação/rejeição de ajustes sugeridos pela auditoria.
      Workflow manual sem notificações, sem SLA, sem histórico de decisões.

      Problemas:
      - Sem workflow automático (aprovação manual sem rastreio)
      - Sem notificações (aprovadores não eram alertados de novos ajustes)
      - Sem SLA (ajustes críticos demoravam meses para aprovar)

    destino: "substituido"
    justificativa: |
      Workflow moderno com:
      - Notificações automáticas (email + SignalR)
      - SLA configurável (3 dias úteis padrão)
      - Histórico completo de decisões (auditado)
      - Escalação automática se SLA expirar

    rf_item_relacionado: "FUNC-094-06"
    uc_relacionado: "UC06"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  # ========== WEBSERVICES LEGADOS (6 itens) ==========
  - id: "LEG-RF094-WS-001"
    tipo: "webservice"
    nome: "AuditoriaService.asmx :: CalcularVariancia"
    caminho: "ic1_legado/IControlIT/WebServices/AuditoriaService.asmx"
    descricao: |
      WebService SOAP que calculava variância entre custo planejado e realizado.
      Retornava DataTable serializado via XML.

      Assinatura VB.NET:
      Public Function CalcularVariancia(clienteId As Integer, fornecedorId As Integer,
                                        dataInicio As Date, dataFim As Date) As DataTable

      Problemas:
      - SOAP/XML (protocolo legado, verboso, lento - payload 10x maior que JSON)
      - Sem cache (query executada a cada chamada - sobrecarga no banco)
      - Retorno não tipado (DataTable - sem validação de schema, erros em runtime)

    destino: "substituido"
    justificativa: |
      API REST moderna substitui SOAP:
      - Endpoint: GET /api/v1/financeiro/auditoria/relatorios/variancia
      - Retorno tipado (DTO com validação via FluentValidation)
      - Cache Redis (5 min)
      - Paginação automática (PagedList)

    rf_item_relacionado: "RN-RF094-001"
    uc_relacionado: "UC01"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF094-WS-002"
    tipo: "webservice"
    nome: "AuditoriaService.asmx :: DetectarAnomalias"
    caminho: "ic1_legado/IControlIT/WebServices/AuditoriaService.asmx"
    descricao: |
      Método SOAP que detectava anomalias comparando custo atual com threshold fixo.
      Algoritmo simplista (apenas > X%), sem estatística.

      Assinatura VB.NET:
      Public Function DetectarAnomalias(clienteId As Integer, categoriaId As Integer,
                                        threshold As Decimal) As DataTable

      Problemas:
      - Algoritmo simplista (apenas > threshold fixo - falsos positivos)
      - Execução síncrona (bloqueante - timeout em bases grandes > 10.000 registros)

    destino: "substituido"
    justificativa: |
      Análise batch assíncrona via Hangfire:
      - Algoritmo Z-score (detecção estatística com threshold 2.5σ)
      - Job recorrente (diário às 02:00)
      - Threshold configurável por categoria
      - Histórico completo de execuções

    rf_item_relacionado: "RN-RF094-003"
    uc_relacionado: "UC02"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF094-WS-003"
    tipo: "webservice"
    nome: "AuditoriaService.asmx :: CalcularTCO"
    caminho: "ic1_legado/IControlIT/WebServices/AuditoriaService.asmx"
    descricao: |
      Cálculo simplificado de TCO (Total Cost of Ownership).
      Somava apenas custos diretos, ignorava depreciação e custos indiretos.

      Assinatura VB.NET:
      Public Function CalcularTCO(clienteId As Integer, ativoId As Integer) As Decimal

      Problemas:
      - Cálculo simplificado (só custos diretos - TCO subestimado em ~40%)
      - Sem breakdown por categoria (impossível analisar composição do TCO)

    destino: "substituido"
    justificativa: |
      Cálculo completo de TCO no sistema moderno:
      - Custos diretos (compra, licenças, treinamento)
      - Custos indiretos (manutenção, energia, suporte)
      - Depreciação (método linear configurável)
      - Breakdown detalhado por categoria

    rf_item_relacionado: "RN-RF094-006"
    uc_relacionado: "UC07"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF094-WS-004"
    tipo: "webservice"
    nome: "AuditoriaService.asmx :: CalcularROI"
    caminho: "ic1_legado/IControlIT/WebServices/AuditoriaService.asmx"
    descricao: |
      Cálculo básico de ROI sem considerar valor do dinheiro no tempo (TVM).
      Fórmula simplista: (Ganho - Custo) / Custo * 100

      Assinatura VB.NET:
      Public Function CalcularROI(clienteId As Integer, investimentoId As Integer) As Decimal

      Problemas:
      - Sem considerar valor do dinheiro no tempo (TVM - ROI impreciso para investimentos de longo prazo)
      - Sem breakdown temporal (ROI por ano - impossível analisar evolução do retorno)

    destino: "substituido"
    justificativa: |
      Cálculo moderno de ROI com:
      - Consideração de TVM (valor presente líquido - NPV)
      - Breakdown anual do retorno
      - Projeção de ROI futuro (5 anos)
      - Comparação com benchmarks do setor

    rf_item_relacionado: "RN-RF094-007"
    uc_relacionado: "UC08"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF094-WS-005"
    tipo: "webservice"
    nome: "AuditoriaService.asmx :: ExportarRelatorio"
    caminho: "ic1_legado/IControlIT/WebServices/AuditoriaService.asmx"
    descricao: |
      Exportação via Crystal Reports. Lenta, consumia muita memória,
      formatos limitados (PDF, Excel via propriedade).

      Assinatura VB.NET:
      Public Function ExportarRelatorio(clienteId As Integer, relatorioId As Integer,
                                        formato As String) As Byte()

      Problemas:
      - Crystal Reports (lento, consome muita memória - timeout em relatórios grandes > 1000 registros)
      - Formatos limitados (só PDF e Excel básico - sem exportação para JSON, CSV estruturado)

    destino: "substituido"
    justificativa: |
      Exportação moderna via bibliotecas especializadas:
      - Excel via EPPlus (rápido, formatado)
      - PDF via QuestPDF (customizável)
      - CSV via CsvHelper (estruturado)
      - JSON nativo

    rf_item_relacionado: "FUNC-094-09"
    uc_relacionado: "UC09"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF094-WS-006"
    tipo: "webservice"
    nome: "AuditoriaService.asmx :: ObterHistorico"
    caminho: "ic1_legado/IControlIT/WebServices/AuditoriaService.asmx"
    descricao: |
      Retornava histórico de auditorias sem paginação.
      Query ineficiente (SELECT *), sem índices adequados.

      Assinatura VB.NET:
      Public Function ObterHistorico(clienteId As Integer, dataInicio As Date,
                                     dataFim As Date) As DataTable

      Problemas críticos:
      - Sem paginação (retorna TODOS os registros - crash com > 5.000 auditorias - OutOfMemoryException)
      - SELECT * sem projeção (tráfego de rede desnecessário)
      - Query sem índices (timeout em bases grandes)

    destino: "substituido"
    justificativa: |
      API REST com:
      - Paginação automática (50 registros/página)
      - Projeção otimizada (só campos necessários - Select(x => new HistoricoDto))
      - Índices compostos adequados (EmpresaId, DataAuditoria DESC)
      - Cache Redis (5 min)

    rf_item_relacionado: "FUNC-094-08"
    uc_relacionado: "UC03"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  # ========== STORED PROCEDURES LEGADAS (6 itens) ==========
  - id: "LEG-RF094-SP-001"
    tipo: "stored_procedure"
    nome: "sp_CalcularVarianciaConsolidada"
    caminho: "ic1_legado/Database/StoredProcedures/sp_CalcularVarianciaConsolidada.sql"
    descricao: |
      SP que calculava variância consolidada por fornecedor.
      Lógica complexa em T-SQL com cursores (lento).

      Parâmetros:
      - @ClienteId INT
      - @DataInicio DATETIME
      - @DataFim DATETIME

      Problemas críticos:
      - Uso de cursores (CURSOR FOR - performance horrível: 1 registro/vez, > 30s para 1000 registros)
      - Sem transaction (dados inconsistentes em caso de falha - corrupção de dados)
      - Lógica de negócio no banco (difícil testar, impossível versionar adequadamente)

    destino: "substituido"
    justificativa: |
      Lógica migrada para Application Layer (C#):
      - Sem cursores (LINQ to Entities com batch processing)
      - Transaction automática (UnitOfWork pattern)
      - Testável via testes unitários
      - Versionamento via Git
      - Performance: < 500ms para 10.000 registros (vs 30s do cursor)

    rf_item_relacionado: "RN-RF094-001"
    uc_relacionado: "UC01"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF094-SP-002"
    tipo: "stored_procedure"
    nome: "sp_DetectarAnomalias_Batch"
    caminho: "ic1_legado/Database/StoredProcedures/sp_DetectarAnomalias_Batch.sql"
    descricao: |
      SP para detecção batch de anomalias. Executava comparação simples (> threshold)
      para todos os registros do cliente.

      Parâmetros:
      - @ClienteId INT
      - @Threshold DECIMAL(18,2)

      Problemas críticos:
      - Algoritmo simplista (apenas > threshold fixo - falsos positivos em categorias com alta variação)
      - Sem logging de execução (impossível auditar execuções - quando rodou, quantos detectou)
      - Execução bloqueante (locks na tabela inteira - bloqueio de outras operações)

    destino: "substituido"
    justificativa: |
      Job Hangfire assíncrono com:
      - Algoritmo Z-score (estatístico)
      - Logging completo de execuções (tabela AuditoriaAnaliseHistorico)
      - Processamento em lotes (1000 registros/vez, sem locks prolongados)
      - Histórico de análises

    rf_item_relacionado: "RN-RF094-003"
    uc_relacionado: "UC02"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF094-SP-003"
    tipo: "stored_procedure"
    nome: "sp_CalcularTCO_PorAtivo"
    caminho: "ic1_legado/Database/StoredProcedures/sp_CalcularTCO_PorAtivo.sql"
    descricao: |
      Cálculo de TCO somando custos diretos de um ativo.
      Não considerava depreciação nem custos indiretos.

      Parâmetros:
      - @ClienteId INT
      - @AtivoId INT

      Query original:
      SELECT SUM(ValorAquisicao) + SUM(ValorLicencas) AS TCO
      FROM tbl_Custos
      WHERE AtivoID = @AtivoID

      Problemas:
      - Cálculo incompleto (só custos diretos - TCO subestimado em ~40% dos custos reais)
      - Sem breakdown por categoria (impossível analisar onde está o maior custo)

    destino: "substituido"
    justificativa: |
      Handler C# com cálculo completo:
      - Custos diretos + indiretos + depreciação
      - Breakdown detalhado por categoria
      - Projeção de custos futuros

    rf_item_relacionado: "RN-RF094-006"
    uc_relacionado: "UC07"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF094-SP-004"
    tipo: "stored_procedure"
    nome: "sp_CalcularROI_PorInvestimento"
    caminho: "ic1_legado/Database/StoredProcedures/sp_CalcularROI_PorInvestimento.sql"
    descricao: |
      Cálculo básico de ROI: (Ganho - Custo) / Custo * 100.
      Não considerava valor do dinheiro no tempo.

      Parâmetros:
      - @ClienteId INT
      - @InvestimentoId INT

      Query original:
      SELECT ((SUM(Ganho) - SUM(Custo)) / SUM(Custo)) * 100 AS ROI
      FROM tbl_Investimentos
      WHERE InvestimentoID = @InvestimentoID

      Problemas:
      - Sem considerar valor do dinheiro no tempo (TVM - ROI impreciso para investimentos de longo prazo)

    destino: "substituido"
    justificativa: |
      Handler com cálculo de NPV (Net Present Value):
      - Considera taxa de desconto (10% a.a. padrão)
      - Breakdown anual
      - Payback period (anos até retorno total)

    rf_item_relacionado: "RN-RF094-007"
    uc_relacionado: "UC08"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF094-SP-005"
    tipo: "stored_procedure"
    nome: "sp_LimparHistorico_Antigo"
    caminho: "ic1_legado/Database/StoredProcedures/sp_LimparHistorico_Antigo.sql"
    descricao: |
      SP que deletava registros antigos (hard delete).
      Violava LGPD (retenção de 7 anos obrigatória).

      Parâmetros:
      - @ClienteId INT
      - @DiasRetencao INT

      Query original:
      DELETE FROM tbl_Auditoria_Historico
      WHERE ClienteID = @ClienteId
        AND DataAuditoria < DATEADD(DAY, -@DiasRetencao, GETDATE())

      Problemas críticos:
      - Hard delete (violação LGPD - perda de dados de auditoria obrigatória)
      - Sem arquivamento antes de deletar (impossível recuperar dados deletados acidentalmente)

    destino: "substituido"
    justificativa: |
      Job Hangfire com:
      - Soft delete (IsDeleted = true)
      - Arquivamento automático após 7 anos (tabela AuditoriaHistoricoArquivado)
      - Retenção conforme LGPD

    rf_item_relacionado: "FUNC-094-08"
    uc_relacionado: "UC03"
    complexidade: "media"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF094-SP-006"
    tipo: "stored_procedure"
    nome: "sp_GerarRelatorio_ConsolidadoMensal"
    caminho: "ic1_legado/Database/StoredProcedures/sp_GerarRelatorio_ConsolidadoMensal.sql"
    descricao: |
      SP que gerava relatório consolidado mensal.
      Query complexa com múltiplos JOINs, sem índices adequados (lento).

      Parâmetros:
      - @ClienteId INT
      - @Mes INT
      - @Ano INT

      Problemas:
      - Query complexa sem índices adequados (timeout em bases grandes > 60s)
      - Sem cache (recalculava a cada chamada - sobrecarga desnecessária)

    destino: "substituido"
    justificativa: |
      View materializada + cache Redis:
      - View vw_AuditoriaConsolidadoMensal (pré-calculada, atualizada daily às 01:00)
      - Cache Redis (1 hora)
      - Índices otimizados (EmpresaId, Ano, Mes)

    rf_item_relacionado: "FUNC-094-10"
    uc_relacionado: "UC05"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 2

  # ========== TABELAS LEGADAS (7 itens) ==========
  - id: "LEG-RF094-TAB-001"
    tipo: "tabela"
    nome: "tbl_Auditoria_Custos"
    caminho: "ic1_legado/Database/Tables/tbl_Auditoria_Custos.sql"
    descricao: |
      Tabela principal de custos de auditoria.

      Schema problemático:
      CREATE TABLE tbl_Auditoria_Custos (
        ID INT IDENTITY(1,1) PRIMARY KEY,
        ClienteID INT,  -- ❌ Sem FK, sem índice
        FornecedorID INT,
        Valor DECIMAL(18,2),
        DataRegistro DATETIME,
        Observacoes VARCHAR(MAX)  -- ❌ Sem limite, sem validação
      )

      Problemas críticos:
      - Sem Foreign Keys (integridade referencial quebrada - registros órfãos)
      - Sem índices adequados (queries lentas - full table scan)
      - Campos sem validação VARCHAR(MAX) (dados inconsistentes, difícil buscar)

    destino: "assumido"
    justificativa: |
      Tabela migrada para EF Core com correções:
      - Foreign Keys adequadas (EmpresaId, FornecedorId)
      - Índices compostos otimizados: IX_AuditoriaCusto_EmpresaId_DataRegistro (DESC)
      - Validações no modelo (FluentValidation - MaxLength(500) para Observacoes)
      - Auditoria automática (AuditInterceptor)

    rf_item_relacionado: "Entidade AuditoriaCusto"
    uc_relacionado: null
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF094-TAB-002"
    tipo: "tabela"
    nome: "tbl_Auditoria_Anomalias"
    caminho: "ic1_legado/Database/Tables/tbl_Auditoria_Anomalias.sql"
    descricao: |
      Tabela de anomalias detectadas.

      Schema problemático:
      CREATE TABLE tbl_Auditoria_Anomalias (
        ID INT IDENTITY(1,1) PRIMARY KEY,
        ClienteID INT,
        RegistroID INT,  -- ❌ Referência genérica (qual tabela?)
        Motivo VARCHAR(200),  -- ❌ Texto livre (impossível filtrar)
        DataDeteccao DATETIME
      )

      Problemas críticos:
      - RegistroID genérico (não sabe qual tabela referencia - impossível fazer JOIN)
      - Motivo em texto livre (não estruturado - impossível filtrar ou agrupar anomalias por tipo)

    destino: "substituido"
    justificativa: |
      Tabela redesenhada com:
      - FK específica (AuditoriaCustoId - GUID)
      - Enum TipoAnomalia (estruturado: VarianciaAlta, CustoAtipico, PadraoAnormal, OutlierEstatistico)
      - Z-score armazenado (rastreabilidade da detecção)

    rf_item_relacionado: "Entidade AuditoriaAnomaliaDetectada"
    uc_relacionado: "UC02"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF094-TAB-003"
    tipo: "tabela"
    nome: "tbl_Auditoria_Historico"
    caminho: "ic1_legado/Database/Tables/tbl_Auditoria_Historico.sql"
    descricao: |
      Tabela de histórico de auditorias.

      Schema problemático:
      CREATE TABLE tbl_Auditoria_Historico (
        ID INT IDENTITY(1,1) PRIMARY KEY,
        ClienteID INT,
        UsuarioID INT,
        Acao VARCHAR(50),  -- ❌ Texto livre
        DataHora DATETIME,
        Detalhes VARCHAR(MAX)  -- ❌ Sem estrutura
      )

      Problemas críticos:
      - Sem assinatura digital (mutabilidade - dados de auditoria podem ser alterados/deletados)
      - Detalhes não estruturados VARCHAR(MAX) (impossível buscar por campos específicos)

    destino: "assumido"
    justificativa: |
      Tabela corrigida com:
      - Assinatura HMAC-SHA256 (imutabilidade)
      - Detalhes estruturados (JSON validado - JSONB)
      - Soft delete com retenção de 7 anos (LGPD - IsDeleted, DataDelecao)

    rf_item_relacionado: "Entidade AuditoriaHistorico"
    uc_relacionado: "UC03"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF094-TAB-004"
    tipo: "tabela"
    nome: "tbl_Auditoria_Threshold"
    caminho: "ic1_legado/Database/Tables/tbl_Auditoria_Threshold.sql"
    descricao: |
      Tabela de configuração de threshold.

      Schema problemático:
      CREATE TABLE tbl_Auditoria_Threshold (
        ID INT IDENTITY(1,1) PRIMARY KEY,
        ClienteID INT,
        ThresholdGlobal DECIMAL(18,2)  -- ❌ Único threshold para tudo
      )

      Problemas:
      - Threshold único global (não customizável por categoria - falsos positivos em categorias com alta variação natural)

    destino: "assumido"
    justificativa: |
      Tabela redesenhada com threshold por categoria:
      - AuditoriaThreshold (EmpresaId, CategoriaId, Threshold)
      - Histórico completo de alterações via AuditLog

    rf_item_relacionado: "Entidade AuditoriaThreshold"
    uc_relacionado: "UC04"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF094-TAB-005"
    tipo: "tabela"
    nome: "tbl_Auditoria_TCO"
    caminho: "ic1_legado/Database/Tables/tbl_Auditoria_TCO.sql"
    descricao: |
      Tabela de Total Cost of Ownership.

      Schema problemático:
      CREATE TABLE tbl_Auditoria_TCO (
        ID INT IDENTITY(1,1) PRIMARY KEY,
        ClienteID INT,
        AtivoID INT,
        TCO DECIMAL(18,2)  -- ❌ Só valor total (sem breakdown)
      )

      Problemas:
      - Só armazena valor total (sem breakdown por categoria - impossível analisar composição do TCO)

    destino: "assumido"
    justificativa: |
      Tabela redesenhada com breakdown:
      - AuditoriaTCO (valor total + categorias separadas: CustosDiretos, CustosIndiretos, Depreciacao)
      - AuditoriaTCODetalhes (breakdown por tipo de custo via navigation property)

    rf_item_relacionado: "Entidade AuditoriaTCO"
    uc_relacionado: "UC07"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF094-TAB-006"
    tipo: "tabela"
    nome: "tbl_Auditoria_ROI"
    caminho: "ic1_legado/Database/Tables/tbl_Auditoria_ROI.sql"
    descricao: |
      Tabela de Return on Investment.

      Schema problemático:
      CREATE TABLE tbl_Auditoria_ROI (
        ID INT IDENTITY(1,1) PRIMARY KEY,
        ClienteID INT,
        InvestimentoID INT,
        ROI DECIMAL(18,2)  -- ❌ Só percentual final (sem breakdown temporal)
      )

      Problemas:
      - Só armazena ROI final (sem breakdown anual - impossível analisar evolução do retorno ao longo do tempo)

    destino: "assumido"
    justificativa: |
      Tabela redesenhada com breakdown temporal:
      - AuditoriaROI (valor total + NPV + payback + TaxaDesconto)
      - AuditoriaROIAnual (breakdown ano a ano: Ano, FluxoCaixa, ValorPresente, ROIAcumulado)

    rf_item_relacionado: "Entidade AuditoriaROI"
    uc_relacionado: "UC08"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF094-TAB-007"
    tipo: "tabela"
    nome: "tbl_Auditoria_Ajustes"
    caminho: "ic1_legado/Database/Tables/tbl_Auditoria_Ajustes.sql"
    descricao: |
      Tabela de ajustes sugeridos.

      Schema problemático:
      CREATE TABLE tbl_Auditoria_Ajustes (
        ID INT IDENTITY(1,1) PRIMARY KEY,
        ClienteID INT,
        AnomaliaID INT,
        Acao VARCHAR(MAX),  -- ❌ Texto livre
        Status VARCHAR(20)  -- ❌ Texto livre (não enum)
      )

      Problemas:
      - Status em texto livre (não enum - inconsistências: PENDENTE vs Pendente vs pendente)
      - Sem SLA (data limite de aprovação - ajustes ficam pendentes indefinidamente)

    destino: "assumido"
    justificativa: |
      Tabela redesenhada com:
      - Enum StatusAjuste (estruturado: Pendente, Aprovado, Rejeitado, Executado, Cancelado)
      - SLA (DataLimite calculada automaticamente, DataAprovacao, DataExecucao)
      - Workflow completo (solicitação → aprovação → execução)

    rf_item_relacionado: "Entidade AuditoriaAjuste"
    uc_relacionado: "UC06"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

# ============================================================================
# REGRAS DE NEGÓCIO IMPLÍCITAS (Não Documentadas)
# ============================================================================
regras_implicitas:
  - id: "RL-RN-001"
    descricao: |
      Threshold de detecção de anomalias variava sem critério documentado.
      No legado, o threshold era alterado manualmente sem auditoria da justificativa.
      Não havia histórico das alterações.
    fonte: "ic1_legado/IControlIT/Auditoria/AuditoriaAnomalia.aspx.vb - Textbox 'txtThreshold' permitia digitação livre"
    destino: "substituido"
    justificativa: "Sistema moderno registra TODAS as alterações via AuditLog + validação de range (0.1 a 10.0)"

  - id: "RL-RN-002"
    descricao: |
      Apenas usuários com perfil "Administrador" podiam exportar relatórios.
      Regra implementada em code-behind, não documentada.
    fonte: "ic1_legado/IControlIT/Relatorios/RelatoriosCustos.aspx.vb - If Session('PerfilUsuario') <> 'Administrador' Then btnExportar.Enabled = False"
    destino: "substituido"
    justificativa: "Sistema moderno usa RBAC centralizado: permissão FINANCEIRO.AUDITORIA.RELATORIOS.EXPORTAR"

  - id: "RL-RN-003"
    descricao: |
      Detecção de anomalias era executada sob demanda via botão na tela.
      Não havia agendamento automático.
    fonte: "ic1_legado/IControlIT/Auditoria/AuditoriaAnomalia.aspx.vb - Protected Sub btnDetectar_Click()"
    destino: "substituido"
    justificativa: "Job Hangfire automático: execução diária às 02:00 + notificações automáticas"

  - id: "RL-RN-004"
    descricao: |
      Ajustes sugeridos ficavam em lista na tela, sem notificar aprovador.
      Aprovador precisava entrar na tela manualmente para ver.
    fonte: "ic1_legado/IControlIT/Auditoria/AprovacaoAjustes.aspx - GridView com lista de ajustes pendentes"
    destino: "substituido"
    justificativa: "Workflow com notificações: email + SignalR real-time + SLA de 3 dias úteis + escalação automática"

  - id: "RL-RN-005"
    descricao: |
      Cálculo de TCO ignorava custos indiretos (manutenção, energia, espaço físico, suporte)
      e depreciação. Somava apenas valor de aquisição + licenças.
    fonte: "ic1_legado/Database/StoredProcedures/sp_CalcularTCO_PorAtivo.sql"
    destino: "substituido"
    justificativa: "Cálculo completo: custos diretos + indiretos + depreciação (método linear configurável)"

  - id: "RL-RN-006"
    descricao: |
      Cálculo de ROI usava fórmula simplista sem considerar valor do dinheiro no tempo (TVM).
      ROI = (Ganho - Custo) / Custo * 100
    fonte: "ic1_legado/Database/StoredProcedures/sp_CalcularROI_PorInvestimento.sql"
    destino: "substituido"
    justificativa: "Cálculo com NPV (Net Present Value): considera taxa de desconto (10% a.a. padrão) + breakdown anual + payback period"

# ============================================================================
# GAP ANALYSIS (Legado x Moderno)
# ============================================================================
gap_analysis:
  - item: "Multi-tenancy"
    existe_legado: false
    existe_moderno: true
    notas: "Sistema legado tinha 18 bancos de dados isolados (1 por cliente). Sistema moderno usa Row-Level Security com EmpresaId."

  - item: "Auditoria automática"
    existe_legado: false
    existe_moderno: true
    notas: "Sistema legado não auditava alterações. Sistema moderno usa AuditInterceptor para todas as entidades."

  - item: "Algoritmo Z-score para anomalias"
    existe_legado: false
    existe_moderno: true
    notas: "Sistema legado usava comparação simples (> threshold fixo). Sistema moderno usa Z-score estatístico."

  - item: "Cálculo completo de TCO"
    existe_legado: false
    existe_moderno: true
    notas: "Sistema legado somava só custos diretos. Sistema moderno inclui custos indiretos + depreciação."

  - item: "Cálculo de ROI com NPV"
    existe_legado: false
    existe_moderno: true
    notas: "Sistema legado usava fórmula simplista. Sistema moderno usa NPV (valor presente líquido)."

  - item: "Notificações automáticas"
    existe_legado: false
    existe_moderno: true
    notas: "Sistema legado não notificava. Sistema moderno usa email + SignalR real-time."

  - item: "Retenção de 7 anos (LGPD)"
    existe_legado: false
    existe_moderno: true
    notas: "Sistema legado permitia hard delete. Sistema moderno garante soft delete + arquivamento após 7 anos."

  - item: "Assinatura digital de logs"
    existe_legado: false
    existe_moderno: true
    notas: "Sistema legado logs eram mutáveis. Sistema moderno usa HMAC-SHA256 para imutabilidade."

  - item: "Dashboard interativo"
    existe_legado: false
    existe_moderno: true
    notas: "Sistema legado usava Crystal Reports (estático). Sistema moderno usa ApexCharts (interativo com drill-down)."

  - item: "Threshold por categoria"
    existe_legado: false
    existe_moderno: true
    notas: "Sistema legado tinha threshold único global. Sistema moderno permite threshold por categoria."

# ============================================================================
# DECISÕES DE MODERNIZAÇÃO
# ============================================================================
decisoes_modernizacao:
  - decisao: "Migração de SOAP/XML para REST/JSON"
    motivo: |
      SOAP é protocolo legado (payload 10x maior que JSON).
      REST é padrão moderno: menor payload, mais rápido, melhor suporte de ferramentas.
    impacto: "alto"
    data: "2025-01-15"

  - decisao: "Algoritmo Z-score para detecção de anomalias"
    motivo: |
      Comparação simples (> threshold fixo) gera muitos falsos positivos.
      Z-score detecta anomalias estatisticamente significativas.
    impacto: "alto"
    data: "2025-02-01"

  - decisao: "Job Hangfire para análise batch"
    motivo: |
      Execução manual é propensa a esquecimento.
      Job automático garante análise recorrente (diária às 02:00).
    impacto: "medio"
    data: "2025-02-10"

  - decisao: "Soft delete + arquivamento para LGPD"
    motivo: |
      Hard delete viola LGPD (retenção de 7 anos obrigatória).
      Soft delete + job de arquivamento garante compliance.
    impacto: "alto"
    data: "2025-02-15"

# ============================================================================
# RISCOS DE MIGRAÇÃO
# ============================================================================
riscos_migracao:
  - risco: "Perda de histórico de auditorias antigas"
    impacto: "alto"
    probabilidade: "baixa"
    mitigacao: |
      Executar ETL completo de tbl_Auditoria_Historico → AuditoriaHistorico.
      Validar 100% dos registros antes de descomissionar legado.

  - risco: "Falsos positivos no algoritmo Z-score inicial"
    impacto: "medio"
    probabilidade: "media"
    mitigacao: |
      Executar análise em paralelo (legado vs moderno) por 1 mês.
      Ajustar threshold padrão (2.5σ) se necessário.

  - risco: "Quebra de integrações externas que consomem SOAP"
    impacto: "alto"
    probabilidade: "baixa"
    mitigacao: |
      Manter endpoints SOAP legados ativos por 6 meses (deprecated).
      Notificar integradores com 3 meses de antecedência.

# ============================================================================
# RASTREABILIDADE (Legado → Moderno)
# ============================================================================
rastreabilidade:
  - elemento_legado: "RelatoriosCustos.aspx"
    referencia_rf: "FUNC-094-01"
    referencia_uc: "UC01"
    status: "migrado"

  - elemento_legado: "AuditoriaAnomalia.aspx"
    referencia_rf: "FUNC-094-02"
    referencia_uc: "UC02"
    status: "migrado"

  - elemento_legado: "sp_CalcularVarianciaConsolidada"
    referencia_rf: "RN-RF094-001"
    referencia_uc: "UC01"
    status: "migrado"

  - elemento_legado: "sp_DetectarAnomalias_Batch"
    referencia_rf: "RN-RF094-003"
    referencia_uc: "UC02"
    status: "migrado"

# ============================================================================
# ESTATÍSTICAS DE MIGRAÇÃO
# ============================================================================
estatisticas_migracao:
  total_itens_legado: 25
  total_telas: 6
  total_webservices: 6
  total_stored_procedures: 6
  total_tabelas: 7
  total_regras_implicitas: 6

  destinos:
    substituido: 18  # 72%
    assumido: 6      # 24%
    descartado: 0    # 0%
    a_revisar: 0     # 0%

  cobertura_destinos: 100%

# ============================================================================
# CHANGELOG
# ============================================================================
changelog:
  - versao: "2.0"
    data: "2025-12-31"
    descricao: "Migração completa de RF094 (Governança v2.0) - Separação RF/RL com 100% destinos definidos"
    autor: "Agência ALC - alc.dev.br"
