rf:
  id: RF057
  nome: Gestão de Itens de Rateio
  versao: '1.0'
  data: '2025-01-14'
  fase: Fase-4-Financeiro-II-Processos
  epic: EPIC007-FIN-Financeiro-Processos
  status: em_desenvolvimento
descricao:
  objetivo: Sistema de configuração granular de itens que serão rateados (linhas móveis,
    licenças software, links de dados, equipamentos) com regras individuais por item,
    categoria ou grupo. Permite exceções, rateios customizados por item específico
    e controle detalhado de alocação de custos.
  problema_resolvido: Ausência de controle fino sobre como cada item de custo é alocado
    entre centros de custo, impossibilitando flexibilidade para exceções (VIPs, projetos
    especiais), rateio proporcional ao uso real, e rastreabilidade detalhada de quem
    consumiu o quê.
  publico_afetado: Gestores financeiros, controladores de custo, gestores de TI, administradores
    de telecom/licenças
escopo:
  incluso:
  - 'Categorização de itens em 4 tipos: Linha Móvel, Licença Software, Link Dados,
    Equipamento'
  - Rateio dedicado (100% para um CC) ou compartilhado (% entre múltiplos CCs)
  - Separação de custos fixos (franquias) e variáveis (excedentes)
  - 'Exceções temporárias ou permanentes de rateio (ex: CEO não participa)'
  - Histórico versionado de mudanças de alocação
  - Rateio proporcional ao uso real medido
  - Detecção automática de itens sem uso > 3 meses (Hangfire job mensal)
  - Grupos de itens para aplicar regra em lote
  - Ajustes e créditos vinculados a item específico
  - Dashboard com top itens mais caros, sem uso, evolução de custos
  - Validação de alocação 100% (soma dos percentuais)
  - Transferência de item dedicado entre CCs com rastreabilidade
  - Import CSV em massa de itens com alocações
  - Comparativo de custo mês atual vs anterior (alerta variação > 30%)
  - Relatório detalhado por item (histórico custos, alocações, transferências, ajustes)
  fora:
  - Integração com sistemas de telefonia (captura automática de consumo) - será feito
    em RF separado
  - Workflow de aprovação de mudança de alocação - será feito em RF separado
  - Projeção de custos futuros baseada em ML - versão futura
entidades:
- nome: ItemRateio
  descricao: Item que pode ser rateado (linha móvel, licença, link, equipamento)
  multi_tenant: true
  soft_delete: true
  auditoria: true
  campos_principais:
  - Numero (string) - Número da linha, ID da licença, serial do equipamento
  - Categoria (enum) - LinhaMobile, LicencaSoftware, LinkDados, Equipamento
  - Tipo (enum) - DEDICADO, COMPARTILHADO
  - CustoMensal (decimal) - Custo fixo mensal do item
  - Status (string) - ATIVO, INATIVO, CANCELADO
  - EmpresaId (Guid) - Multi-tenancy
- nome: AlocacaoItem
  descricao: Percentual de alocação de um item para um centro de custo
  multi_tenant: false
  soft_delete: false
  auditoria: true
  campos_principais:
  - ItemId (Guid) - FK para ItemRateio
  - CentroCusto (string) - Código do CC
  - Percentual (decimal) - 0-100, soma deve ser 100%
  - DataInicio (DateTime) - Vigência início
  - DataFim (DateTime?) - Vigência fim (null = vigente)
- nome: CustoItem
  descricao: Custo de um item em um período (fixo + variável)
  multi_tenant: false
  soft_delete: false
  auditoria: true
  campos_principais:
  - ItemId (Guid) - FK para ItemRateio
  - Periodo (DateTime) - Mês/Ano referência
  - CustoFixo (decimal) - Franquia mensal
  - CustoVariavel (decimal) - Excedente de uso
  - CustoTotal (decimal, computed) - CustoFixo + CustoVariavel
- nome: ExcecaoRateio
  descricao: Exceção temporária ou permanente de rateio para um item
  multi_tenant: false
  soft_delete: false
  auditoria: true
  campos_principais:
  - ItemId (Guid) - FK para ItemRateio
  - Motivo (string) - Justificativa da exceção
  - ExcluirTotalmente (bool) - Se true, não ratear esse item
  - DataInicio (DateTime?) - Início da exceção
  - DataFim (DateTime?) - Fim da exceção (null = permanente)
- nome: HistoricoAlocacao
  descricao: Histórico versionado de mudanças de alocação
  multi_tenant: false
  soft_delete: false
  auditoria: true
  campos_principais:
  - ItemId (Guid) - FK para ItemRateio
  - CentroCusto (string) - CC na versão histórica
  - Percentual (decimal) - Percentual na versão histórica
  - DataInicio (DateTime) - Vigência início
  - DataFim (DateTime) - Vigência fim
  - UsuarioAlteracaoId (Guid) - Quem alterou
- nome: GrupoItens
  descricao: Grupo de itens para aplicar regra de rateio em lote
  multi_tenant: true
  soft_delete: true
  auditoria: true
  campos_principais:
  - Nome (string) - Celulares Vendas, Licenças Marketing
  - EmpresaId (Guid) - Multi-tenancy
- nome: AjusteItem
  descricao: Ajustes/créditos vinculados a item específico
  multi_tenant: false
  soft_delete: false
  auditoria: true
  campos_principais:
  - ItemId (Guid) - FK para ItemRateio
  - Periodo (DateTime) - Mês/Ano referência
  - Tipo (string) - MULTA, CREDITO, DESCONTO, AJUSTE
  - Valor (decimal) - Valor do ajuste
  - Justificativa (string) - Motivo do ajuste
- nome: TransferenciaItem
  descricao: Histórico de transferências de item entre CCs
  multi_tenant: false
  soft_delete: false
  auditoria: true
  campos_principais:
  - ItemId (Guid) - FK para ItemRateio
  - CentroCustoOrigem (string) - CC de origem
  - CentroCustoDestino (string) - CC de destino
  - Motivo (string) - Justificativa
  - DataTransferencia (DateTime) - Quando ocorreu
  - UsuarioId (Guid) - Quem transferiu
- nome: AlertaItem
  descricao: Alertas automáticos (sem uso, variação anormal de custo)
  multi_tenant: false
  soft_delete: false
  auditoria: true
  campos_principais:
  - ItemId (Guid) - FK para ItemRateio
  - Tipo (string) - SEM_USO_3_MESES, VARIACAO_ANORMAL
  - Descricao (string) - Mensagem do alerta
  - SugestaoAcao (string) - CANCELAR, REVISAR, etc
  - EconomiaPotencial (decimal?) - Valor que pode ser economizado
  - ValorAtual (decimal?) - Custo atual (para variação)
  - ValorAnterior (decimal?) - Custo anterior (para variação)
regras_negocio:
- id: RN-RF057-001
  descricao: 'Sistema deve suportar 4 categorias principais de itens: LinhaMobile
    (celulares voz+dados), LicencaSoftware (Office/Adobe/Salesforce), LinkDados (internet/MPLS/VPN),
    Equipamento (laptops/desktops/monitores)'
  tipo: regra_negocio
  campos_afetados:
  - ItemRateio.Categoria
  obrigatorio: true
  enum_relacionado: CategoriaItem
- id: RN-RF057-002
  descricao: Item pode ser alocado 100% para um centro de custo (DEDICADO) ou dividido
    entre múltiplos centros de custo com percentuais (COMPARTILHADO). A soma dos percentuais
    DEVE ser exatamente 100%
  tipo: validacao
  campos_afetados:
  - ItemRateio.Tipo
  - AlocacaoItem.Percentual
  obrigatorio: true
  validacao_custom: Math.Abs(alocacoes.Sum(a => a.Percentual) - 100m) <= 0.01m
- id: RN-RF057-003
  descricao: Custos fixos (franquias mensais) e custos variáveis (excedentes de uso)
    devem ser separados e rateados independentemente, aplicando os mesmos percentuais
    de alocação para cada tipo de custo
  tipo: regra_negocio
  campos_afetados:
  - CustoItem.CustoFixo
  - CustoItem.CustoVariavel
  obrigatorio: true
- id: RN-RF057-004
  descricao: Permitir exceções temporárias (com DataInicio e DataFim) ou permanentes
    (DataFim = null) de rateio. Se ExcluirTotalmente = true, o item não participa
    do rateio no período da exceção
  tipo: regra_negocio
  campos_afetados:
  - ExcecaoRateio.ExcluirTotalmente
  - ExcecaoRateio.DataInicio
  - ExcecaoRateio.DataFim
  obrigatorio: true
- id: RN-RF057-005
  descricao: Todas as mudanças de alocação devem ser versionadas em HistoricoAlocacao,
    arquivando a versão anterior com DataInicio/DataFim de vigência e UsuarioAlteracaoId
    para rastreabilidade. Deve ser possível consultar qual era a alocação em qualquer
    período passado
  tipo: auditoria
  campos_afetados:
  - HistoricoAlocacao
  obrigatorio: true
- id: RN-RF057-006
  descricao: Para itens compartilhados, permitir rateio baseado em consumo real individual
    medido. O sistema deve calcular o percentual de uso de cada usuário/CC e distribuir
    o custo total proporcionalmente ao consumo medido
  tipo: regra_negocio
  campos_afetados:
  - Consumos.Quantidade
  obrigatorio: true
  integracao_relacionada: Tabela Consumos (de RF separado)
- id: RN-RF057-007
  descricao: Job Hangfire mensal (dia 1, 02:00) deve detectar itens sem uso há mais
    de 3 meses (verificando tabela Consumos) e criar AlertaItem tipo SEM_USO_3_MESES
    com sugestão de cancelamento e economia potencial = CustoMensal
  tipo: automacao
  campos_afetados:
  - AlertaItem.Tipo
  - AlertaItem.SugestaoAcao
  - AlertaItem.EconomiaPotencial
  obrigatorio: true
  job_relacionado: DetectarItensSemUso - RecurringJob mensal
- id: RN-RF057-008
  descricao: 'Permitir criar grupos de itens (ex: Celulares Vendas, Licenças Marketing)
    e aplicar mesma regra de rateio em lote para todos os itens do grupo'
  tipo: regra_negocio
  campos_afetados:
  - GrupoItens.Nome
  - ItemRateio.GrupoId
  obrigatorio: true
- id: RN-RF057-009
  descricao: Permitir lançar ajustes (MULTA, CREDITO, DESCONTO, AJUSTE) vinculados
    a item específico em um período. Ajuste deve ser rateado proporcionalmente às
    alocações do item
  tipo: regra_negocio
  campos_afetados:
  - AjusteItem.Tipo
  - AjusteItem.Valor
  - AjusteItem.Justificativa
  obrigatorio: true
- id: RN-RF057-010
  descricao: 'Dashboard deve exibir: total de itens ativos, custo total do mês, top
    10 itens mais caros, itens sem uso (últimos 3 meses), e evolução de custos (12
    meses com gráfico de linha)'
  tipo: regra_negocio
  campos_afetados:
  - DashboardItens
  obrigatorio: true
  componente_frontend: Chart.js (Bar + Line)
- id: RN-RF057-011
  descricao: 'Validação obrigatória ao salvar alocações: soma dos percentuais deve
    ser exatamente 100% (tolerância de 0.01%). Se diferente, retornar erro HTTP 400
    com mensagem clara'
  tipo: validacao
  campos_afetados:
  - AlocacaoItem.Percentual
  obrigatorio: true
  validacao_custom: Math.Abs(alocacoes.Sum(a => a.Percentual) - 100m) > 0.01m
- id: RN-RF057-012
  descricao: Permitir transferir item dedicado (Tipo = DEDICADO) de um centro de custo
    para outro. Criar registro em TransferenciaItem com motivo, data, usuário, CC
    origem/destino. Atualizar AlocacaoItem.CentroCusto e DataInicio. Itens compartilhados
    NÃO podem ser transferidos (retornar erro)
  tipo: regra_negocio
  campos_afetados:
  - TransferenciaItem
  - AlocacaoItem.CentroCusto
  - AlocacaoItem.DataInicio
  obrigatorio: true
  validacao_custom: if (item.Tipo != TipoRateio.Dedicado) return Failure()
- id: RN-RF057-013
  descricao: 'Permitir importar planilha CSV com múltiplos itens e suas alocações.
    Formato de alocações: CC1:40;CC2:30;CC3:30 (centro de custo:percentual separados
    por ;). Validar cada linha e retornar resultado com contadores de sucessos e lista
    de erros'
  tipo: integracao
  campos_afetados:
  - ItemRateio
  - AlocacaoItem
  obrigatorio: true
  formato_csv: Numero,Categoria,TipoRateio,CustoMensal,Alocacoes
- id: RN-RF057-014
  descricao: Comparar custo do item no mês atual vs mês anterior. Se variação absoluta
    for maior que 30%, criar AlertaItem tipo VARIACAO_ANORMAL com ValorAtual, ValorAnterior,
    e descrição da variação percentual. Notificar gestor
  tipo: automacao
  campos_afetados:
  - AlertaItem.Tipo
  - AlertaItem.ValorAtual
  - AlertaItem.ValorAnterior
  obrigatorio: true
  threshold: 30%
- id: RN-RF057-015
  descricao: 'Gerar relatório completo de um item com: dados básicos, histórico de
    custos (últimos 12 meses), histórico de alocações, transferências, ajustes, e
    custo total acumulado no período'
  tipo: relatorio
  campos_afetados:
  - RelatorioItem
  obrigatorio: true
  periodo_padrao: 12 meses
estados:
- id: ATIVO
  descricao: Item em uso e sendo rateado
- id: INATIVO
  descricao: Item temporariamente inativo (sem rateio)
- id: CANCELADO
  descricao: Item cancelado permanentemente
transicoes:
  permitidas:
  - de: ATIVO
    para: INATIVO
  - de: INATIVO
    para: ATIVO
  - de: ATIVO
    para: CANCELADO
  - de: INATIVO
    para: CANCELADO
  proibidas:
  - de: CANCELADO
    para: ATIVO
  - de: CANCELADO
    para: INATIVO
permissoes:
- codigo: GES.ITENS_RATEIO.VIEW_ANY
  descricao: Listar itens de rateio
- codigo: GES.ITENS_RATEIO.VIEW
  descricao: Visualizar detalhes de um item
- codigo: GES.ITENS_RATEIO.CREATE
  descricao: Criar novo item de rateio
- codigo: GES.ITENS_RATEIO.EDIT
  descricao: Editar alocações de item
- codigo: GES.ITENS_RATEIO.DELETE
  descricao: Inativar/Cancelar item
- codigo: GES.ITENS_RATEIO.TRANSFER
  descricao: Transferir item dedicado entre CCs
- codigo: GES.ITENS_RATEIO.VIEW_COSTS
  descricao: Visualizar custos e relatórios financeiros
- codigo: GES.ITENS_RATEIO.IMPORT
  descricao: Importar itens em massa via CSV
- codigo: GES.ITENS_RATEIO.MANAGE_GROUPS
  descricao: Gerenciar grupos de itens
- codigo: GES.ITENS_RATEIO.MANAGE_EXCEPTIONS
  descricao: Criar/editar exceções de rateio
integracoes:
  internas:
  - Autenticação (JWT Bearer Token)
  - Multi-Tenancy (EmpresaId em ItemRateio)
  - Auditoria (AuditableEntity em todas entidades principais)
  - 'Central de Funcionalidades (SistemaFuncionalidade: GES.ITENS_RATEIO)'
  - RBAC (ItensRateioPermissions)
  - 'i18n (Transloco - chaves prefixo: itensRateio)'
  - Hangfire (DetectarItensSemUso - job mensal)
  externas:
  - sistema: Sistema de Consumos (RF separado)
    tipo: Database
    obrigatoria: true
    descricao: Consulta tabela Consumos para calcular rateio proporcional ao uso real
      e detectar itens sem uso
  - sistema: Sistema de Centros de Custo (RF separado)
    tipo: Database
    obrigatoria: true
    descricao: Validação de códigos de centro de custo em AlocacaoItem
seguranca:
  isolamento_tenant: true
  auditoria_obrigatoria: true
  soft_delete: true
  permissoes_especificas:
  - Apenas gestores financeiros podem alterar alocações (EDIT)
  - Apenas super admin pode criar exceções permanentes (MANAGE_EXCEPTIONS)
  - Transferências exigem permissão TRANSFER e são auditadas
  - Relatórios de custo exigem permissão VIEW_COSTS
rastreabilidade:
  ucs_esperados:
  - UC00 - Listar Itens de Rateio
  - UC01 - Criar Item de Rateio
  - UC02 - Visualizar Item de Rateio
  - UC03 - Editar Item de Rateio
  - UC04 - Inativar/Cancelar Item de Rateio
  - UC05 - Transferir Item entre CCs
  - UC06 - Gerenciar Grupos de Itens
  - UC07 - Criar Exceção de Rateio
  - UC08 - Importar Itens via CSV
  - UC09 - Visualizar Dashboard de Itens
  - UC10 - Gerar Relatório Detalhado de Item
catalog:
  crud:
  - id: RF-CRUD-01
    title: Criar item de rateio
    required: true
    endpoint: POST /api/itens-rateio
  - id: RF-CRUD-02
    title: Listar itens de rateio
    required: true
    endpoint: GET /api/itens-rateio
  - id: RF-CRUD-03
    title: Visualizar item de rateio
    required: true
    endpoint: GET /api/itens-rateio/{id}
  - id: RF-CRUD-04
    title: Atualizar item de rateio
    required: true
    endpoint: PUT /api/itens-rateio/{id}
  - id: RF-CRUD-05
    title: Inativar/Cancelar item de rateio
    required: true
    endpoint: DELETE /api/itens-rateio/{id}
  validacoes:
  - id: RF-VAL-01
    title: Validar campos obrigatórios (Numero, Categoria, Tipo, EmpresaId)
    required: true
  - id: RF-VAL-02
    title: Validar unicidade de Numero dentro de EmpresaId (multi-tenancy)
    required: true
  - id: RF-VAL-03
    title: Validar soma de percentuais = 100% (tolerância 0.01%)
    required: true
  - id: RF-VAL-04
    title: Validar CentroCusto existe no sistema
    required: true
  - id: RF-VAL-05
    title: Validar vigência de exceção (DataInicio <= DataFim)
    required: false
  seguranca:
  - id: RF-SEC-01
    title: Isolamento de tenant (EmpresaId em queries)
    required: true
  - id: RF-SEC-02
    title: Permissões RBAC em todos endpoints
    required: true
  - id: RF-SEC-03
    title: Auditoria de todas operações (Created, CreatedBy, LastModified, LastModifiedBy)
    required: true
  funcionalidades_especificas:
  - id: RF-FUNC-01
    title: Rateio de custos (fixo + variável) com aplicação de percentuais
    required: true
  - id: RF-FUNC-02
    title: Histórico versionado de alocações
    required: true
  - id: RF-FUNC-03
    title: Exceções de rateio (temporárias e permanentes)
    required: true
  - id: RF-FUNC-04
    title: Rateio proporcional ao uso real medido
    required: true
  - id: RF-FUNC-05
    title: Detecção automática de itens sem uso (Hangfire job mensal)
    required: true
  - id: RF-FUNC-06
    title: Grupos de itens para rateio em lote
    required: true
  - id: RF-FUNC-07
    title: Ajustes e créditos por item
    required: true
  - id: RF-FUNC-08
    title: Dashboard de análises (top caros, sem uso, evolução)
    required: true
  - id: RF-FUNC-09
    title: Transferência de item dedicado entre CCs
    required: true
  - id: RF-FUNC-10
    title: Import CSV em massa
    required: true
  - id: RF-FUNC-11
    title: Comparativo de custo mensal (alerta variação > 30%)
    required: true
  - id: RF-FUNC-12
    title: Relatório detalhado por item
    required: true
exclusions:
  rf_items:
  - Integração com sistemas de telefonia para captura automática de consumo (será
    RF separado)
  - Workflow de aprovação de mudança de alocação (será RF separado)
  - Projeção de custos futuros baseada em ML (versão futura)
requisitos_nao_funcionais:
  performance:
  - Processar rateio de 50.000 itens em menos de 10 minutos
  - Dashboard carrega em menos de 3 segundos
  precisao:
  - Cálculos com 4 casas decimais
  - Validação de soma de percentuais com tolerância de 0.01%
  auditoria:
  - Histórico completo de 7 anos (conformidade fiscal)
  - Rastreabilidade de todas mudanças de alocação
  seguranca:
  - Apenas gestores financeiros podem alterar alocações
  - Transferências exigem permissão específica e são auditadas
  - Relatórios de custo exigem permissão VIEW_COSTS
historico:
- versao: '1.0'
  data: '2025-01-14'
  autor: Agência ALC - alc.dev.br
  descricao: Versão inicial do RF057 - Gestão de Itens de Rateio (criado diretamente
    no formato moderno, sem sistema legado correspondente)
