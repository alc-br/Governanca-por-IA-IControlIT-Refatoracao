# RL-RF057.yaml - Referência ao Legado (Gestão de Itens de Rateio)
# Versão: 1.0
# Data: 2025-01-14
# Autor: Agência ALC - alc.dev.br

rf_id: RF057
titulo: "Gestão de Itens de Rateio"

legado:
  sistema: "VB.NET + ASP.NET Web Forms"
  versao: "Framework 4.7.2"
  arquitetura: "Monolítica WebForms"
  banco_dados: "SQL Server 2012+"
  multi_tenant: false  # Segregação por base cliente, não por TenantId
  auditoria: "partial"  # Existe WS_Cadastro.Envia_Log mas não é automático

# SEÇÃO CRÍTICA: Referências ao Legado com Destino Obrigatório
# IMPORTANTE: RF-057 é uma funcionalidade INTEIRAMENTE NOVA sem equivalente legado
# Os itens abaixo documentam funcionalidades RELACIONADAS (mas não equivalentes)
referencias:
  - id: "LEG-RF057-001"
    tipo: "tela"
    nome: "Rateio.aspx (Rateio de Fatura - NÃO de Itens)"
    caminho: "ic1_legado/IControlIT/Recepcao_Fatura/Rateio.aspx"
    descricao: |
      Tela legada que permite configurar regras de rateio de FATURA COMPLETA
      entre centros de custo com percentuais.

      DIFERENÇA CRÍTICA vs RF-057:
      - Legado: Rateia VALOR TOTAL DA FATURA (nível estratégico)
      - RF-057: Rateia ITENS INDIVIDUAIS (linha, licença, link - nível tático)

      COMPORTAMENTO LEGADO:
      - DropDownList de centros de custo
      - TextBox para percentual (validação soma = 100%)
      - GridView exibindo regras de rateio
      - Botão Salvar persiste em tabela Rateio (FK para Id_Fatura)

      LIMITAÇÕES:
      - Impossível ratear linha móvel X diferentemente de linha móvel Y
      - Sem separação custo fixo vs variável
      - Sem histórico de mudanças (UPDATE sobrescreve)
      - Sem detecção de anomalias
      - Sem categorização de itens

    destino: "descartado"
    justificativa: |
      RF-057 é funcionalidade NOVA com escopo completamente diferente.
      Rateio de Fatura (legado) continuará existindo para rateio estratégico de faturas completas.
      RF-057 adiciona camada tática de rateio por item individual.
      COEXISTÊNCIA PACÍFICA - ambos podem operar sem conflito.

    rf_item_relacionado: null
    uc_relacionado: null
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 5  # Baixa - não há migração necessária

  - id: "LEG-RF057-002"
    tipo: "stored_procedure"
    nome: "pa_Rateio (CRUD de Regras de Rateio de Fatura)"
    caminho: "BancoDados/Base/Branco.sql"
    descricao: |
      Stored procedure que implementa CRUD de regras de rateio de fatura.

      PARÂMETROS:
      - @pAcao (VARCHAR) - 'Consultar', 'Inserir', 'Atualizar', 'Excluir'
      - @pId_Rateio (INT) - PK da regra
      - @pId_Fatura (INT) - FK para fatura
      - @pId_Centro_Custo (INT) - Centro de custo destino
      - @pPercentual (DECIMAL) - Percentual de alocação

      VALIDAÇÕES:
      - Soma dos percentuais de uma fatura = 100%
      - Centro de custo deve existir

      DIFERENÇA vs RF-057:
      - Legado: Rateio vinculado a FATURA (Id_Fatura)
      - RF-057: Rateio vinculado a ITEM (ItemId - linha, licença, link, equipamento)

    destino: "substituido"
    justificativa: |
      RF-057 criará procedures novas (pa_ItemRateio, pa_AlocacaoItem, pa_CustoItem)
      com escopo completamente diferente (item individual vs fatura).

      CONCEITO APROVEITADO:
      - Validação soma percentuais = 100% será mantida (RN-RF057-011)
      - Estrutura percentual por centro de custo será similar (AlocacaoItem)

    rf_item_relacionado: "RN-RF057-011"
    uc_relacionado: "UC01"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF057-003"
    tipo: "stored_procedure"
    nome: "sp_ProcessarRateioFatura (Aplica Rateio sobre Fatura Fechada)"
    caminho: "BancoDados/Base/Branco.sql"
    descricao: |
      Stored procedure executada quando fatura é fechada para distribuir
      custo total entre centros de custo conforme regras de rateio.

      LÓGICA:
      1. Busca fatura fechada (Id_Fatura)
      2. Busca regras de rateio (tabela Rateio WHERE Id_Fatura)
      3. Para cada regra:
         - Calcula: ValorAlocado = Fatura.ValorTotal * (Rateio.Percentual / 100)
         - Insere em tabela CustoAlocado (Centro_Custo, Valor, Periodo)
      4. Valida: SUM(ValorAlocado) == Fatura.ValorTotal

      DIFERENÇA vs RF-057:
      - Legado: Rateia VALOR TOTAL (campo único Fatura.ValorTotal)
      - RF-057: Rateia CUSTOS SEPARADOS (CustoFixo + CustoVariavel) por ITEM

    destino: "substituido"
    justificativa: |
      RF-057 criará procedure sp_RatearCustoItem com lógica DIFERENTE:
      - Separa CustoFixo de CustoVariavel (RN-RF057-003)
      - Aplica percentuais de AlocacaoItem para cada tipo de custo
      - Gera CustoAlocado por ITEM (não por fatura completa)

      ALGORITMO NOVO (RN-RF057-003):
      ```sql
      FOR EACH item IN ItensRateio WHERE Status = 'ATIVO'
        FOR EACH alocacao IN item.Alocacoes
          INSERT CustoAlocado (
            CentroCusto = alocacao.CentroCusto,
            CustoFixo = custo.CustoFixo * (alocacao.Percentual / 100),
            CustoVariavel = custo.CustoVariavel * (alocacao.Percentual / 100)
          )
      ```

    rf_item_relacionado: "RN-RF057-003"
    uc_relacionado: "UC01"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 2

  - id: "LEG-RF057-004"
    tipo: "tabela"
    nome: "Rateio (Tabela de Regras de Rateio de Fatura)"
    caminho: "BancoDados/Base/Branco.sql"
    descricao: |
      Tabela legada que armazena regras de rateio de fatura.

      ESTRUTURA:
      CREATE TABLE Rateio (
        Id_Rateio INT IDENTITY(1,1) PRIMARY KEY,
        Id_Fatura INT FOREIGN KEY REFERENCES Fatura(Id_Fatura),
        Id_Centro_Custo INT,
        Percentual DECIMAL(5,2),
        -- SEM campos de auditoria (Created, CreatedBy, LastModified, LastModifiedBy)
        -- SEM multi-tenancy (EmpresaId)
        -- SEM vigência (DataInicio, DataFim)
      )

      PROBLEMAS IDENTIFICADOS:
      - FK para Fatura (RF-057 precisa FK para Item)
      - Sem auditoria automática
      - Sem multi-tenancy
      - Sem versionamento (mudanças sobrescrevem sem histórico)
      - Sem validação de soma percentuais (feita em SP)

    destino: "substituido"
    justificativa: |
      RF-057 criará tabelas NOVAS com estrutura COMPLETAMENTE DIFERENTE:

      1. ItemRateio (item individual - linha, licença, link, equipamento)
      2. AlocacaoItem (percentuais de alocação POR ITEM)
      3. CustoItem (custos fixos e variáveis separados POR ITEM POR PERÍODO)
      4. ExcecaoRateio (exceções temporárias/permanentes POR ITEM)
      5. HistoricoAlocacao (versionamento de mudanças de alocação)
      6. GrupoItens (grupos de itens para rateio em lote)
      7. AjusteItem (ajustes/créditos por item)
      8. TransferenciaItem (histórico de transferências entre CCs)
      9. AlertaItem (alertas automáticos - sem uso, variação anormal)

      Tabela Rateio do legado PERMANECE intocada para rateio de fatura.
      ZERO CONFLITO entre legado e moderno.

    rf_item_relacionado: "RN-RF057-002"
    uc_relacionado: "UC01"
    complexidade: "alta"
    risco_migracao: "baixo"
    prioridade: 1

  - id: "LEG-RF057-005"
    tipo: "tabela"
    nome: "Consumos (Tabela de Consumo Medido - JÁ EXISTE NO LEGADO)"
    caminho: "BancoDados/Base/Branco.sql"
    descricao: |
      Tabela legada que armazena consumo medido de linhas/serviços.

      ESTRUTURA LEGADA (estimada):
      CREATE TABLE Consumos (
        Id_Consumo INT IDENTITY(1,1) PRIMARY KEY,
        Id_Ativo INT,  -- FK para item (linha, licença, etc)
        Id_Usuario INT,
        Periodo DATETIME,
        Quantidade DECIMAL(18,4),  -- Minutos, MB, SMS
        -- outros campos
      )

      RF-057 DEPENDE desta tabela para:
      - RN-RF057-006: Rateio proporcional ao uso real
      - RN-RF057-007: Detecção de itens sem uso (> 3 meses)

    destino: "assumido"
    justificativa: |
      Tabela Consumos JÁ EXISTE no legado e será REUSADA no RF-057.

      INTEGRAÇÃO OBRIGATÓRIA:
      - RN-RF057-006 consulta Consumos para calcular percentual de uso
      - RN-RF057-007 (Hangfire job) consulta Consumos para detectar inatividade

      VALIDAÇÃO NECESSÁRIA antes de implementar RF-057:
      - Confirmar estrutura da tabela Consumos
      - Verificar se campo Quantidade é confiável
      - Validar se existe índice em (Id_Ativo, Periodo) para performance

      RISCO: Se tabela Consumos não tiver dados, RN-RF057-006 e RN-RF057-007 falham.

    rf_item_relacionado: "RN-RF057-006, RN-RF057-007"
    uc_relacionado: "UC01, UC09"
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: 1

# Telas Legadas (estrutura detalhada)
telas:
  - id: "LEG-RF057-001"
    nome: "Rateio.aspx (Rateio de Fatura)"
    caminho: "ic1_legado/IControlIT/Recepcao_Fatura/Rateio.aspx"
    responsabilidade: "Configurar regras de rateio de fatura completa entre centros de custo"
    campos:
      - nome: "ddlCentroCusto"
        tipo: "DropDownList"
        obrigatorio: true
        validacao: "Centro de custo deve existir"
      - nome: "txtPercentual"
        tipo: "TextBox"
        obrigatorio: true
        validacao: "Decimal 0-100, soma total = 100%"
      - nome: "gvRateios"
        tipo: "GridView"
        obrigatorio: false
        validacao: "Exibe regras cadastradas"
    comportamentos_implicitos:
      - "Botão Adicionar insere linha em GridView temporário (ViewState)"
      - "Botão Salvar persiste todas as linhas no banco (transaction)"
      - "Validação client-side (jQuery) e server-side (code-behind)"
      - "Não há versionamento - UPDATE sobrescreve regras anteriores"
      - "Não há auditoria - quem/quando alterou não é registrado"

# WebServices Legados
servicos:
  - id: "LEG-RF057-002"
    nome: "WSRateio.asmx"
    localizacao: "IControlIT/WS_IControlIT/WSRateio.asmx"
    responsabilidade: "Endpoint SOAP para operações de rateio de fatura"
    notas: |
      WebService mencionado no README do legado (seção "Servicos SOAP principais")
      mas SEM DETALHES sobre métodos específicos.

      IMPORTANTE: WSRateio.asmx trata de RATEIO DE FATURA, NÃO de gestão de itens.
      RF-057 criará novos endpoints REST API (NÃO SOAP):
      - POST /api/itens-rateio
      - GET /api/itens-rateio
      - GET /api/itens-rateio/{id}
      - PUT /api/itens-rateio/{id}
      - DELETE /api/itens-rateio/{id}
      - POST /api/itens-rateio/{id}/transferir
      - POST /api/itens-rateio/importar
      - GET /api/itens-rateio/dashboard
      - GET /api/itens-rateio/{id}/relatorio

# Tabelas Legadas com Problemas
tabelas:
  - nome: "Rateio"
    finalidade: "Armazenar regras de rateio de fatura entre centros de custo"
    problemas:
      - "FK para Fatura (RF-057 precisa FK para Item)"
      - "Sem campos de auditoria (Created, CreatedBy, LastModified, LastModifiedBy)"
      - "Sem multi-tenancy (EmpresaId)"
      - "Sem versionamento (mudanças sobrescrevem sem histórico)"
      - "Sem vigência temporal (DataInicio, DataFim)"
      - "Validação de soma percentuais = 100% apenas em SP (não há constraint)"

  - nome: "Consumos"
    finalidade: "Armazenar consumo medido de linhas/serviços (minutos, MB, SMS)"
    problemas:
      - "Sem documentação completa da estrutura (estimada)"
      - "Não confirmado se campo Quantidade é confiável"
      - "Possível ausência de índice em (Id_Ativo, Periodo) para performance"
      - "DEPENDÊNCIA CRÍTICA para RN-RF057-006 e RN-RF057-007"

# Regras de Negócio Implícitas (não documentadas no legado)
regras_implicitas:
  - id: "RL-RN-001"
    descricao: |
      Sistema legado rateia apenas o VALOR TOTAL DA FATURA, nunca itens individuais.
      Impossível ratear linha móvel X diferentemente de linha móvel Y na mesma fatura.
    fonte: "ic1_legado/IControlIT/Recepcao_Fatura/Rateio.aspx.vb"

  - id: "RL-RN-002"
    descricao: |
      Percentual de rateio é definido uma vez e aplicado para toda a fatura.
      Impossível aplicar percentuais diferentes para tipos de item diferentes.
    fonte: "sp_ProcessarRateioFatura"

  - id: "RL-RN-003"
    descricao: |
      Custo total da fatura é rateado sem separar franquia (fixo) de excedente (variável).
      Impossível ratear franquia igualmente e excedente proporcionalmente ao uso.
    fonte: "pa_Rateio"

  - id: "RL-RN-004"
    descricao: |
      Alterar regra de rateio afeta todas as faturas retroativamente (sem vigência).
      Impossível manter histórico "CC X recebia 40% até março, depois 30%".
    fonte: "Rateio.aspx.vb (botão Salvar)"

  - id: "RL-RN-005"
    descricao: |
      Não há alertas automáticos de variação de custo ou itens sem uso.
      Gestores não são notificados de linhas com custo 300% maior que mês anterior.
    fonte: "Módulo Consulta (relatórios manuais estáticos)"

# Gap Analysis (Legado x Moderno)
gap_analysis:
  - item: "Granularidade"
    existe_legado: true
    existe_moderno: true
    notas: |
      LEGADO: Fatura completa
      MODERNO: Item individual (linha, licença, link, equipamento)
      GAP CRÍTICO: Conceitos completamente diferentes

  - item: "Categorização de Itens"
    existe_legado: false
    existe_moderno: true
    notas: |
      LEGADO: Não categoriza itens
      MODERNO: 4 categorias (LinhaMobile, LicencaSoftware, LinkDados, Equipamento)
      FUNCIONALIDADE NOVA

  - item: "Tipo de Rateio (Dedicado vs Compartilhado)"
    existe_legado: false
    existe_moderno: true
    notas: |
      LEGADO: Assume sempre compartilhado (percentuais)
      MODERNO: Dedicado (100% para um CC) ou Compartilhado (% entre múltiplos)
      FUNCIONALIDADE NOVA

  - item: "Separação Custos Fixos vs Variáveis"
    existe_legado: false
    existe_moderno: true
    notas: |
      LEGADO: Rateia valor total (sem separação)
      MODERNO: CustoFixo (franquia) + CustoVariavel (excedente) separados
      FUNCIONALIDADE NOVA - Precisão contábil

  - item: "Exceções de Rateio"
    existe_legado: false
    existe_moderno: true
    notas: |
      LEGADO: Não suporta exceções
      MODERNO: Exceções temporárias/permanentes por item (ex: CEO não participa)
      FUNCIONALIDADE NOVA - Flexibilidade para VIPs

  - item: "Histórico Versionado"
    existe_legado: false
    existe_moderno: true
    notas: |
      LEGADO: UPDATE sobrescreve sem histórico
      MODERNO: Versionamento completo com DataInicio/DataFim e UsuarioAlteracaoId
      FUNCIONALIDADE NOVA - Auditoria LGPD

  - item: "Rateio Proporcional ao Uso Real"
    existe_legado: false
    existe_moderno: true
    notas: |
      LEGADO: Percentuais fixos
      MODERNO: Baseado em Consumos.Quantidade medido individualmente
      FUNCIONALIDADE NOVA - Justiça na distribuição de custos

  - item: "Detecção Automática de Itens Sem Uso"
    existe_legado: false
    existe_moderno: true
    notas: |
      LEGADO: Não detecta
      MODERNO: Hangfire job mensal detecta itens sem uso > 3 meses
      FUNCIONALIDADE NOVA - Economia de custos

  - item: "Dashboard de Itens"
    existe_legado: false
    existe_moderno: true
    notas: |
      LEGADO: Não possui
      MODERNO: Top caros, sem uso, evolução de custos (Chart.js)
      FUNCIONALIDADE NOVA - Gestão gerencial

# Decisões de Modernização
decisoes_modernizacao:
  - decisao: "Criar funcionalidade totalmente nova sem migração de dados"
    motivo: |
      RF-057 é funcionalidade nova sem equivalente no legado.
      Legado só rateia faturas completas, não itens individuais.
      Não há dados legados a migrar.
    impacto: "alto"  # Funcionalidade completamente nova
    data: "2025-01-14"

  - decisao: "Não integrar com Rateio de Fatura legado"
    motivo: |
      Escopos diferentes (item vs fatura completa).
      RF-057 é nível tático, Rateio de Fatura é nível estratégico.
      Ambos podem coexistir sem conflito.
    impacto: "baixo"
    data: "2025-01-14"

  - decisao: "Não reaproveitar tabela Rateio do legado"
    motivo: |
      Estrutura incompatível (FK para Fatura, não para Item).
      Criar tabelas novas evita conflitos e mantém separação de responsabilidades.
    impacto: "baixo"
    data: "2025-01-14"

  - decisao: "Implementar Hangfire para automações (detecção itens sem uso, comparar custos)"
    motivo: |
      Legado não possui scheduler/jobs automáticos.
      Proatividade na gestão de custos é requisito crítico (RN-RF057-007, RN-RF057-014).
    impacto: "medio"
    data: "2025-01-14"

  - decisao: "Usar Clean Architecture + CQRS desde o início"
    motivo: |
      Não há código legado a refatorar.
      Aproveitar ausência de legado para seguir boas práticas desde o início.
    impacto: "medio"
    data: "2025-01-14"

# Riscos de Migração
riscos_migracao:
  - risco: "Usuários podem esperar que RF-057 se comporte como Rateio de Fatura legado"
    impacto: "medio"
    probabilidade: "baixa"
    mitigacao: |
      Treinamento explicitando que RF-057 é funcionalidade nova, não substituição.
      Comunicar claramente: RF-057 = rateio TÁTICO (item a item), Rateio Fatura = ESTRATÉGICO (fatura completa).

  - risco: "Dados de consumo podem não existir na tabela Consumos"
    impacto: "alto"
    probabilidade: "baixa"
    mitigacao: |
      Validar integração com tabela Consumos no legado ANTES de implementar RN-RF057-006 e RN-RF057-007.
      Criar testes que consultam Consumos para confirmar dados disponíveis.
      Se Consumos não tiver dados, RN-RF057-006 e RN-RF057-007 devem ser marcados como "Não Aplicável" temporariamente.

  - risco: "Performance com 50.000 itens pode ser lenta"
    impacto: "alto"
    probabilidade: "media"
    mitigacao: |
      Usar processamento em lote (Hangfire background jobs) para rateio.
      Criar índices otimizados em ItemRateio, AlocacaoItem, CustoItem.
      Considerar particionamento de tabela CustoItem por Periodo se volume for muito alto.

# Rastreabilidade (Legado → Moderno)
rastreabilidade:
  - elemento_legado: "NENHUM - Funcionalidade não existe no legado"
    referencia_rf: "RF-057 completo"
    referencia_uc: "UC00-UC10"
    status: "novo"

  - elemento_legado: "Conceito de percentual de alocação (tabela Rateio)"
    referencia_rf: "AlocacaoItem.Percentual"
    referencia_uc: "UC01, UC03"
    status: "inspirado"

  - elemento_legado: "Validação soma percentuais = 100% (Rateio de Fatura)"
    referencia_rf: "RN-RF057-011"
    referencia_uc: "UC01, UC03"
    status: "assumido"

  - elemento_legado: "Tabela Consumos (já existe no legado)"
    referencia_rf: "RN-RF057-006, RN-RF057-007"
    referencia_uc: "UC01, UC09"
    status: "integracao"

  - elemento_legado: "Conceito de Centro de Custo"
    referencia_rf: "AlocacaoItem.CentroCusto"
    referencia_uc: "UC01, UC03, UC05"
    status: "assumido"

# Changelog
changelog:
  - versao: "1.0"
    data: "2025-01-14"
    descricao: |
      Versão inicial do RL-RF057.
      RF-057 é funcionalidade INTEIRAMENTE NOVA sem equivalente no sistema legado.
      Legado possui apenas Rateio de Fatura (nível estratégico).
      RF-057 adiciona Rateio de Itens (nível tático) como funcionalidade inédita.
    autor: "Agência ALC - alc.dev.br"
