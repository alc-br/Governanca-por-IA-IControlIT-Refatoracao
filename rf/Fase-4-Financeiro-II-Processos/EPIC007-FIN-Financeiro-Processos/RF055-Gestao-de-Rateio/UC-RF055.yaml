# =============================================
# UC-RF055 - Casos de Uso Canônicos
# Versão: 2.0
# Data: 2025-12-31
# Autor: Agência ALC - alc.dev.br
# =============================================

uc:
  rf: "RF055"
  titulo: "Gestão de Rateio de Custos"
  epic: "EPIC007-FIN - Financeiro Processos"
  fase: "Fase 4 - Financeiro II - Processos"
  versao: "2.0"
  data: "2025-12-31"

casos_de_uso:

  - id: "UC00"
    nome: "Listar Rateios"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      rf_items:
        - "RF-CRUD-02"
        - "RF-SEC-01"
      uc_items:
        - id: "FP-UC00-001"
          title: "Usuário acessa o menu Financeiro > Rateio de Custos"
          required: true
        - id: "FP-UC00-002"
          title: "Sistema valida permissão rateio.view_any"
          required: true
        - id: "FP-UC00-003"
          title: "Sistema carrega rateios do Id_Conglomerado do usuário logado"
          required: true
        - id: "FP-UC00-004"
          title: "Sistema aplica paginação (20 registros/página) e ordenação DESC"
          required: true
        - id: "FP-UC00-005"
          title: "Sistema exibe grid com colunas: Nome, Tipo, Critério, Status, Última Execução, Ações"
          required: true
        - id: "FA-UC00-001"
          title: "Usuário aplica filtro por Nome"
          required: false
        - id: "FA-UC00-002"
          title: "Usuário aplica filtro por Tipo"
          required: false
        - id: "FA-UC00-003"
          title: "Usuário aplica filtro por Status"
          required: false
        - id: "FA-UC00-004"
          title: "Usuário ordena por coluna"
          required: false
        - id: "FA-UC00-005"
          title: "Usuário navega entre páginas"
          required: false
        - id: "FE-UC00-001"
          title: "Usuário sem permissão → acesso negado"
          required: true
        - id: "FE-UC00-002"
          title: "Nenhum rateio cadastrado → estado vazio exibido"
          required: true
        - id: "FE-UC00-003"
          title: "Erro ao carregar dados → mensagem de erro"
          required: true

    precondicoes:
      - permissao: "rateio.view_any"

    gatilho: "Usuário acessa o menu Financeiro > Rateio de Custos"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessa_menu_rateio"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao_view_any"
      - passo: 3
        ator: "sistema"
        acao: "carregar_rateios_tenant"
      - passo: 4
        ator: "sistema"
        acao: "aplicar_paginacao_ordenacao"
      - passo: 5
        ator: "sistema"
        acao: "exibir_grid_rateios"

    fluxos_alternativos:
      - id: "FA-UC00-01"
        condicao: "usuario_aplica_filtro_nome"
        resultado: "lista_filtrada_por_nome"
      - id: "FA-UC00-02"
        condicao: "usuario_aplica_filtro_tipo"
        resultado: "lista_filtrada_por_tipo"
      - id: "FA-UC00-03"
        condicao: "usuario_aplica_filtro_status"
        resultado: "lista_filtrada_por_status"

    fluxos_excecao:
      - id: "FE-UC00-01"
        condicao: "sem_permissao_view_any"
        resultado: "acesso_negado_redirecionar_home"
      - id: "FE-UC00-02"
        condicao: "nenhum_rateio_cadastrado"
        resultado: "exibir_estado_vazio"
      - id: "FE-UC00-03"
        condicao: "erro_carregar_dados"
        resultado: "exibir_mensagem_erro_log"

    regras_aplicadas:
      - "RN-UC-00-001"
      - "RN-UC-00-002"
      - "RN-UC-00-003"

    resultado_final:
      estado: "lista_rateios_exibida"

  - id: "UC01"
    nome: "Criar Regra de Rateio"
    ator_principal: "usuario_autenticado"
    tipo: "crud"
    impacta_dados: true

    covers:
      rf_items:
        - "RF-CRUD-01"
        - "RF-VAL-01"
        - "RF-VAL-02"
        - "RF-SEC-02"
      uc_items:
        - id: "FP-UC01-001"
          title: "Usuário clica em Nova Regra de Rateio"
          required: true
        - id: "FP-UC01-002"
          title: "Sistema valida permissão rateio.create"
          required: true
        - id: "FP-UC01-003"
          title: "Sistema exibe formulário com campos obrigatórios"
          required: true
        - id: "FP-UC01-004"
          title: "Usuário preenche campos obrigatórios"
          required: true
        - id: "FP-UC01-005"
          title: "Usuário adiciona regras de distribuição no grid"
          required: true
        - id: "FP-UC01-006"
          title: "Usuário clica em Salvar"
          required: true
        - id: "FP-UC01-007"
          title: "Sistema valida dados (RN-UC-01-001 a RN-UC-01-005)"
          required: true
        - id: "FP-UC01-008"
          title: "Sistema cria registro na tabela Rateio com Status Ativo"
          required: true
        - id: "FP-UC01-009"
          title: "Sistema salva regras de distribuição na tabela Rateio_Regra"
          required: true
        - id: "FP-UC01-010"
          title: "Sistema registra auditoria (AuditLog)"
          required: true
        - id: "FP-UC01-011"
          title: "Sistema exibe mensagem: Regra de rateio criada com sucesso!"
          required: true
        - id: "FP-UC01-012"
          title: "Sistema redireciona para listagem"
          required: true
        - id: "FA-UC01-001"
          title: "Salvar e Criar Outro"
          required: false
        - id: "FA-UC01-002"
          title: "Cancelar criação"
          required: false
        - id: "FA-UC01-003"
          title: "Tipo Proporcional por Headcount → campo adicional Departamento Origem"
          required: false
        - id: "FA-UC01-004"
          title: "Tipo Uso Real → campo adicional Métrica de Uso"
          required: false
        - id: "FE-UC01-001"
          title: "Campos obrigatórios não preenchidos → mensagem de validação"
          required: true
        - id: "FE-UC01-002"
          title: "Soma dos percentuais ≠ 100% → impede salvamento"
          required: true
        - id: "FE-UC01-003"
          title: "Nome duplicado → impede salvamento"
          required: true
        - id: "FE-UC01-004"
          title: "Destinos duplicados → impede salvamento"
          required: true
        - id: "FE-UC01-005"
          title: "Erro ao salvar no banco → rollback"
          required: true

    precondicoes:
      - permissao: "rateio.create"

    gatilho: "Usuário clica em Nova Regra de Rateio"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "clicar_nova_regra"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao_create"
      - passo: 3
        ator: "sistema"
        acao: "exibir_formulario"
      - passo: 4
        ator: "usuario"
        acao: "preencher_campos"
      - passo: 5
        ator: "usuario"
        acao: "adicionar_distribuicoes"
      - passo: 6
        ator: "usuario"
        acao: "salvar"
      - passo: 7
        ator: "sistema"
        acao: "validar_dados"
      - passo: 8
        ator: "sistema"
        acao: "criar_registro_rateio"
      - passo: 9
        ator: "sistema"
        acao: "salvar_regras_distribuicao"
      - passo: 10
        ator: "sistema"
        acao: "registrar_auditoria"

    fluxos_excecao:
      - id: "FE-UC01-01"
        condicao: "campos_obrigatorios_vazios"
        resultado: "exibir_erros_validacao"
      - id: "FE-UC01-02"
        condicao: "soma_percentuais_diferente_100"
        resultado: "bloquear_salvamento"
      - id: "FE-UC01-03"
        condicao: "nome_duplicado_tenant"
        resultado: "bloquear_salvamento"
      - id: "FE-UC01-04"
        condicao: "destinos_duplicados_grid"
        resultado: "bloquear_salvamento"
      - id: "FE-UC01-05"
        condicao: "erro_banco_dados"
        resultado: "rollback_transacao"

    regras_aplicadas:
      - "RN-UC-01-001"
      - "RN-UC-01-002"
      - "RN-UC-01-003"
      - "RN-UC-01-004"
      - "RN-UC-01-005"
      - "RN-UC-01-006"
      - "RN-UC-01-007"
      - "RN-UC-01-008"

    resultado_final:
      estado: "regra_rateio_criada"

  - id: "UC02"
    nome: "Visualizar Detalhes de Rateio"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      rf_items:
        - "RF-CRUD-03"
        - "RF-SEC-01"
      uc_items:
        - id: "FP-UC02-001"
          title: "Usuário clica em Visualizar em um rateio da listagem"
          required: true
        - id: "FP-UC02-002"
          title: "Sistema valida permissão rateio.view"
          required: true
        - id: "FP-UC02-003"
          title: "Sistema valida que rateio pertence ao Id_Conglomerado do usuário"
          required: true
        - id: "FP-UC02-004"
          title: "Sistema exibe tela de detalhes com 3 seções"
          required: true
        - id: "FP-UC02-005"
          title: "Sistema exibe botões de ação: Editar, Inativar, Simular"
          required: true
        - id: "FA-UC02-001"
          title: "Visualizar Detalhes de uma execução"
          required: false
        - id: "FA-UC02-002"
          title: "Clicar em Simular → redirecionar UC06"
          required: false
        - id: "FA-UC02-003"
          title: "Clicar em Editar → redirecionar UC03"
          required: false
        - id: "FA-UC02-004"
          title: "Clicar em Inativar → confirmação e inativação"
          required: false
        - id: "FE-UC02-001"
          title: "Rateio não encontrado → redirecionar listagem"
          required: true
        - id: "FE-UC02-002"
          title: "Rateio de outro tenant → acesso negado e log segurança"
          required: true
        - id: "FE-UC02-003"
          title: "Usuário sem permissão rateio.view → acesso negado"
          required: true

    precondicoes:
      - permissao: "rateio.view"
      - rateio_pertence_tenant: true

    gatilho: "Usuário clica em Visualizar em um rateio da listagem"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "clicar_visualizar_rateio"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao_view"
      - passo: 3
        ator: "sistema"
        acao: "validar_tenant_ownership"
      - passo: 4
        ator: "sistema"
        acao: "exibir_detalhes_3_secoes"
      - passo: 5
        ator: "sistema"
        acao: "exibir_botoes_acao"

    fluxos_alternativos:
      - id: "FA-UC02-01"
        condicao: "visualizar_detalhes_execucao"
        resultado: "modal_com_detalhamento_execucao"
      - id: "FA-UC02-02"
        condicao: "clicar_simular"
        resultado: "redirecionar_uc06"
      - id: "FA-UC02-03"
        condicao: "clicar_editar"
        resultado: "redirecionar_uc03"
      - id: "FA-UC02-04"
        condicao: "clicar_inativar"
        resultado: "confirmacao_e_inativacao"

    fluxos_excecao:
      - id: "FE-UC02-01"
        condicao: "rateio_nao_encontrado"
        resultado: "mensagem_erro_redirecionar"
      - id: "FE-UC02-02"
        condicao: "rateio_outro_tenant"
        resultado: "acesso_negado_log_seguranca"
      - id: "FE-UC02-03"
        condicao: "sem_permissao_view"
        resultado: "acesso_negado_redirecionar"

    regras_aplicadas:
      - "RN-UC-02-001"
      - "RN-UC-02-002"
      - "RN-UC-02-003"

    resultado_final:
      estado: "detalhes_rateio_exibidos"

  - id: "UC03"
    nome: "Editar Regra de Rateio"
    ator_principal: "usuario_autenticado"
    tipo: "crud"
    impacta_dados: true

    covers:
      rf_items:
        - "RF-CRUD-04"
        - "RF-VAL-01"
        - "RF-VAL-02"
        - "RF-VAL-03"
        - "RF-SEC-03"
      uc_items:
        - id: "FP-UC03-001"
          title: "Usuário clica em Editar na visualização de detalhes (UC02)"
          required: true
        - id: "FP-UC03-002"
          title: "Sistema valida permissões e pré-condições"
          required: true
        - id: "FP-UC03-003"
          title: "Sistema exibe formulário preenchido com dados atuais"
          required: true
        - id: "FP-UC03-004"
          title: "Usuário altera campos desejados (Nome, Descrição, Regras)"
          required: true
        - id: "FP-UC03-005"
          title: "Usuário clica em Salvar"
          required: true
        - id: "FP-UC03-006"
          title: "Sistema valida dados (mesmas validações do UC01)"
          required: true
        - id: "FP-UC03-007"
          title: "Sistema cria snapshot da versão anterior em Rateio_Historico"
          required: true
        - id: "FP-UC03-008"
          title: "Sistema atualiza registro na tabela Rateio"
          required: true
        - id: "FP-UC03-009"
          title: "Sistema atualiza regras de distribuição em Rateio_Regra"
          required: true
        - id: "FP-UC03-010"
          title: "Sistema registra auditoria"
          required: true
        - id: "FP-UC03-011"
          title: "Sistema exibe mensagem: Regra de rateio atualizada com sucesso!"
          required: true
        - id: "FP-UC03-012"
          title: "Sistema redireciona para visualização de detalhes"
          required: true
        - id: "FA-UC03-001"
          title: "Cancelar edição"
          required: false
        - id: "FA-UC03-002"
          title: "Visualizar Histórico de Alterações"
          required: false
        - id: "FE-UC03-001"
          title: "Rateio executado no mês corrente → bloquear edição"
          required: true
        - id: "FE-UC03-002"
          title: "Campos obrigatórios não preenchidos → mensagem validação"
          required: true
        - id: "FE-UC03-003"
          title: "Soma percentuais ≠ 100% → mensagem validação"
          required: true
        - id: "FE-UC03-004"
          title: "Erro ao salvar → rollback e manter versão anterior"
          required: true

    precondicoes:
      - permissao: "rateio.update"
      - rateio_nao_executado_mes_corrente: true

    gatilho: "Usuário clica em Editar na visualização de detalhes"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "clicar_editar"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissoes_precondicoes"
      - passo: 3
        ator: "sistema"
        acao: "exibir_formulario_preenchido"
      - passo: 4
        ator: "usuario"
        acao: "alterar_campos"
      - passo: 5
        ator: "usuario"
        acao: "salvar"
      - passo: 6
        ator: "sistema"
        acao: "validar_dados"
      - passo: 7
        ator: "sistema"
        acao: "criar_snapshot_historico"
      - passo: 8
        ator: "sistema"
        acao: "atualizar_registro_rateio"
      - passo: 9
        ator: "sistema"
        acao: "atualizar_regras_distribuicao"
      - passo: 10
        ator: "sistema"
        acao: "registrar_auditoria"

    fluxos_excecao:
      - id: "FE-UC03-01"
        condicao: "executado_mes_corrente"
        resultado: "bloquear_edicao_mensagem"
      - id: "FE-UC03-02"
        condicao: "validacao_falhou"
        resultado: "exibir_erros_validacao"
      - id: "FE-UC03-03"
        condicao: "soma_percentuais_invalida"
        resultado: "bloquear_salvamento"
      - id: "FE-UC03-04"
        condicao: "erro_banco_dados"
        resultado: "rollback_manter_versao_anterior"

    regras_aplicadas:
      - "RN-UC-03-001"
      - "RN-UC-03-002"
      - "RN-UC-03-003"
      - "RN-UC-03-004"
      - "RN-UC-03-005"
      - "RN-UC-03-006"

    resultado_final:
      estado: "regra_rateio_atualizada"

  - id: "UC04"
    nome: "Aprovar Rateio Processado"
    ator_principal: "usuario_autenticado"
    tipo: "acao"
    impacta_dados: true

    covers:
      rf_items:
        - "RF-VAL-04"
        - "RF-SEC-04"
        - "RF-PROC-01"
      uc_items:
        - id: "FP-UC04-001"
          title: "Usuário acessa Financeiro > Rateios Pendentes de Aprovação"
          required: true
        - id: "FP-UC04-002"
          title: "Sistema valida permissão rateio.approve"
          required: true
        - id: "FP-UC04-003"
          title: "Sistema exibe grid com rateios PROCESSADOS"
          required: true
        - id: "FP-UC04-004"
          title: "Usuário clica em Visualizar em um rateio"
          required: true
        - id: "FP-UC04-005"
          title: "Sistema exibe detalhes: Resumo, Grid distribuição, Comparativo mensal"
          required: true
        - id: "FP-UC04-006"
          title: "Usuário clica em Aprovar"
          required: true
        - id: "FP-UC04-007"
          title: "Sistema valida se variação > 10% em algum destino"
          required: true
        - id: "FP-UC04-008"
          title: "Sistema atualiza Status para APROVADO"
          required: true
        - id: "FP-UC04-009"
          title: "Sistema registra usuário aprovador e data/hora de aprovação"
          required: true
        - id: "FP-UC04-010"
          title: "Sistema registra auditoria"
          required: true
        - id: "FP-UC04-011"
          title: "Sistema exibe mensagem: Rateio aprovado com sucesso!"
          required: true
        - id: "FP-UC04-012"
          title: "Sistema remove rateio da lista de pendentes"
          required: true
        - id: "FA-UC04-001"
          title: "Variação > 10% detectada → alerta de confirmação"
          required: false
        - id: "FA-UC04-002"
          title: "Rejeitar rateio → motivo obrigatório"
          required: false
        - id: "FA-UC04-003"
          title: "Aprovar múltiplos rateios em lote"
          required: false
        - id: "FE-UC04-001"
          title: "Usuário sem permissão rateio.approve → acesso negado"
          required: true
        - id: "FE-UC04-002"
          title: "Rateio já foi aprovado por outro usuário → mensagem"
          required: true
        - id: "FE-UC04-003"
          title: "Erro ao salvar aprovação → rollback"
          required: true

    precondicoes:
      - permissao: "rateio.approve"
      - rateio_status_processado: true

    gatilho: "Usuário acessa Rateios Pendentes de Aprovação"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessar_pendentes_aprovacao"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao_approve"
      - passo: 3
        ator: "sistema"
        acao: "exibir_grid_processados"
      - passo: 4
        ator: "usuario"
        acao: "visualizar_rateio"
      - passo: 5
        ator: "sistema"
        acao: "exibir_detalhes_aprovacao"
      - passo: 6
        ator: "usuario"
        acao: "aprovar"
      - passo: 7
        ator: "sistema"
        acao: "validar_variacao_10_porcento"
      - passo: 8
        ator: "sistema"
        acao: "atualizar_status_aprovado"
      - passo: 9
        ator: "sistema"
        acao: "registrar_aprovador_data_hora"
      - passo: 10
        ator: "sistema"
        acao: "registrar_auditoria"

    fluxos_alternativos:
      - id: "FA-UC04-01"
        condicao: "variacao_maior_10_porcento"
        resultado: "exibir_alerta_confirmacao"
      - id: "FA-UC04-02"
        condicao: "rejeitar_rateio"
        resultado: "motivo_obrigatorio_status_rejeitado"
      - id: "FA-UC04-03"
        condicao: "aprovar_multiplos_lote"
        resultado: "validacao_lote_aprovacao_unica"

    fluxos_excecao:
      - id: "FE-UC04-01"
        condicao: "sem_permissao_approve"
        resultado: "acesso_negado_redirecionar"
      - id: "FE-UC04-02"
        condicao: "ja_aprovado_outro_usuario"
        resultado: "mensagem_informativa_atualizar_listagem"
      - id: "FE-UC04-03"
        condicao: "erro_salvar_aprovacao"
        resultado: "rollback_manter_status_processado"

    regras_aplicadas:
      - "RN-UC-04-001"
      - "RN-UC-04-002"
      - "RN-UC-04-003"
      - "RN-UC-04-004"
      - "RN-UC-04-005"
      - "RN-UC-04-006"

    resultado_final:
      estado: "rateio_aprovado"

  - id: "UC05"
    nome: "Exportar Rateio para ERP"
    ator_principal: "usuario_autenticado"
    tipo: "batch"
    impacta_dados: true

    covers:
      rf_items:
        - "RF-SEC-05"
        - "RF-INT-01"
        - "RF-INT-02"
        - "RF-INT-03"
        - "RF-PROC-02"
      uc_items:
        - id: "FP-UC05-001"
          title: "Usuário acessa Financeiro > Rateios Aprovados"
          required: true
        - id: "FP-UC05-002"
          title: "Sistema valida permissão rateio.export"
          required: true
        - id: "FP-UC05-003"
          title: "Sistema exibe grid com rateios APROVADOS"
          required: true
        - id: "FP-UC05-004"
          title: "Usuário seleciona um ou mais rateios"
          required: true
        - id: "FP-UC05-005"
          title: "Usuário clica em Exportar"
          required: true
        - id: "FP-UC05-006"
          title: "Sistema exibe modal de confirmação (ERP destino, formato, data competência)"
          required: true
        - id: "FP-UC05-007"
          title: "Usuário confirma exportação"
          required: true
        - id: "FP-UC05-008"
          title: "Sistema valida integração ERP configurada"
          required: true
        - id: "FP-UC05-009"
          title: "Sistema gera arquivo de exportação (CSV ou XML)"
          required: true
        - id: "FP-UC05-010"
          title: "Sistema envia arquivo via API REST para ERP ou disponibiliza download"
          required: true
        - id: "FP-UC05-011"
          title: "Sistema atualiza Status para EXPORTADO"
          required: true
        - id: "FP-UC05-012"
          title: "Sistema registra log de exportação"
          required: true
        - id: "FP-UC05-013"
          title: "Sistema registra auditoria"
          required: true
        - id: "FP-UC05-014"
          title: "Sistema exibe mensagem: Rateio exportado com sucesso! Arquivo: {nome}"
          required: true
        - id: "FA-UC05-001"
          title: "Integração ERP não configurada → download manual"
          required: false
        - id: "FA-UC05-002"
          title: "Exportação manual (download de arquivo)"
          required: false
        - id: "FA-UC05-003"
          title: "Erro na API do ERP → tentar novamente"
          required: false
        - id: "FA-UC05-004"
          title: "Exportação em lote (múltiplos rateios)"
          required: false
        - id: "FE-UC05-001"
          title: "Usuário sem permissão rateio.export → acesso negado"
          required: true
        - id: "FE-UC05-002"
          title: "Rateio já foi exportado → desabilitar botão"
          required: true
        - id: "FE-UC05-003"
          title: "Erro ao gerar arquivo → mensagem erro e log"
          required: true

    precondicoes:
      - permissao: "rateio.export"
      - rateio_status_aprovado: true
      - integracao_erp_configurada: false  # Opcional

    gatilho: "Usuário acessa Rateios Aprovados e clica em Exportar"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessar_rateios_aprovados"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao_export"
      - passo: 3
        ator: "sistema"
        acao: "exibir_grid_aprovados"
      - passo: 4
        ator: "usuario"
        acao: "selecionar_rateios"
      - passo: 5
        ator: "usuario"
        acao: "clicar_exportar"
      - passo: 6
        ator: "sistema"
        acao: "exibir_modal_confirmacao"
      - passo: 7
        ator: "usuario"
        acao: "confirmar_exportacao"
      - passo: 8
        ator: "sistema"
        acao: "validar_integracao_erp"
      - passo: 9
        ator: "sistema"
        acao: "gerar_arquivo_csv_ou_xml"
      - passo: 10
        ator: "sistema"
        acao: "enviar_api_ou_download"
      - passo: 11
        ator: "sistema"
        acao: "atualizar_status_exportado"
      - passo: 12
        ator: "sistema"
        acao: "registrar_log_exportacao"
      - passo: 13
        ator: "sistema"
        acao: "registrar_auditoria"

    fluxos_alternativos:
      - id: "FA-UC05-01"
        condicao: "integracao_nao_configurada"
        resultado: "download_manual_arquivo"
      - id: "FA-UC05-02"
        condicao: "exportacao_manual"
        resultado: "baixar_arquivo_status_exportado_manualmente"
      - id: "FA-UC05-03"
        condicao: "erro_api_erp"
        resultado: "manter_status_aprovado_tentar_novamente"
      - id: "FA-UC05-04"
        condicao: "exportacao_lote"
        resultado: "arquivo_consolidado_unico"

    fluxos_excecao:
      - id: "FE-UC05-01"
        condicao: "sem_permissao_export"
        resultado: "acesso_negado_redirecionar"
      - id: "FE-UC05-02"
        condicao: "ja_exportado"
        resultado: "desabilitar_botao_mensagem"
      - id: "FE-UC05-03"
        condicao: "erro_gerar_arquivo"
        resultado: "mensagem_erro_log"

    regras_aplicadas:
      - "RN-UC-05-001"
      - "RN-UC-05-002"
      - "RN-UC-05-003"
      - "RN-UC-05-004"
      - "RN-UC-05-005"
      - "RN-UC-05-006"
      - "RN-UC-05-007"

    resultado_final:
      estado: "rateio_exportado"

  - id: "UC06"
    nome: "Simular Rateio"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      rf_items:
        - "RF-SEC-06"
        - "RF-REL-02"
        - "RF-PROC-01"
      uc_items:
        - id: "FP-UC06-001"
          title: "Usuário acessa Financeiro > Simular Rateio"
          required: true
        - id: "FP-UC06-002"
          title: "Sistema valida permissão rateio.simulate"
          required: true
        - id: "FP-UC06-003"
          title: "Sistema exibe formulário: Regra, Mês/Ano, Valor Total"
          required: true
        - id: "FP-UC06-004"
          title: "Usuário seleciona regra e define valor total"
          required: true
        - id: "FP-UC06-005"
          title: "Usuário clica em Simular"
          required: true
        - id: "FP-UC06-006"
          title: "Sistema calcula distribuição conforme tipo de rateio"
          required: true
        - id: "FP-UC06-007"
          title: "Sistema exibe preview com 3 seções: Resumo, Distribuição, Gráficos"
          required: true
        - id: "FP-UC06-008"
          title: "Sistema exibe botões: Exportar PDF, Exportar Excel, Executar Rateio"
          required: true
        - id: "FA-UC06-001"
          title: "Exportar PDF → gerar PDF com preview"
          required: false
        - id: "FA-UC06-002"
          title: "Exportar Excel → gerar planilha"
          required: false
        - id: "FA-UC06-003"
          title: "Executar Rateio → confirmação e execução real"
          required: false
        - id: "FA-UC06-004"
          title: "Alterar valor total → recalcular automaticamente"
          required: false
        - id: "FE-UC06-001"
          title: "Usuário sem permissão rateio.simulate → acesso negado"
          required: true
        - id: "FE-UC06-002"
          title: "Regra de rateio inativa → desabilitar simulação"
          required: true
        - id: "FE-UC06-003"
          title: "Dados insuficientes para simulação → mensagem erro"
          required: true
        - id: "FE-UC06-004"
          title: "Erro ao calcular distribuição → mensagem erro e log"
          required: true

    precondicoes:
      - permissao: "rateio.simulate"
      - regra_ativa: true

    gatilho: "Usuário acessa Financeiro > Simular Rateio"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessar_simular_rateio"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao_simulate"
      - passo: 3
        ator: "sistema"
        acao: "exibir_formulario_simulacao"
      - passo: 4
        ator: "usuario"
        acao: "selecionar_regra_valor"
      - passo: 5
        ator: "usuario"
        acao: "clicar_simular"
      - passo: 6
        ator: "sistema"
        acao: "calcular_distribuicao_tipo_rateio"
      - passo: 7
        ator: "sistema"
        acao: "exibir_preview_3_secoes"
      - passo: 8
        ator: "sistema"
        acao: "exibir_botoes_exportar_executar"

    fluxos_alternativos:
      - id: "FA-UC06-01"
        condicao: "exportar_pdf"
        resultado: "gerar_pdf_download"
      - id: "FA-UC06-02"
        condicao: "exportar_excel"
        resultado: "gerar_planilha_download"
      - id: "FA-UC06-03"
        condicao: "executar_rateio"
        resultado: "confirmacao_executar_real_status_processado"
      - id: "FA-UC06-04"
        condicao: "alterar_valor_total"
        resultado: "recalcular_automaticamente"

    fluxos_excecao:
      - id: "FE-UC06-01"
        condicao: "sem_permissao_simulate"
        resultado: "acesso_negado_redirecionar"
      - id: "FE-UC06-02"
        condicao: "regra_inativa"
        resultado: "desabilitar_botao_simular"
      - id: "FE-UC06-03"
        condicao: "dados_insuficientes"
        resultado: "mensagem_erro_sugestao"
      - id: "FE-UC06-04"
        condicao: "erro_calcular"
        resultado: "mensagem_erro_log"

    regras_aplicadas:
      - "RN-UC-06-001"
      - "RN-UC-06-002"
      - "RN-UC-06-003"
      - "RN-UC-06-004"
      - "RN-UC-06-005"
      - "RN-UC-06-006"

    resultado_final:
      estado: "simulacao_exibida"

  - id: "UC07"
    nome: "Dashboard de Rateios"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      rf_items:
        - "RF-SEC-07"
        - "RF-REL-01"
      uc_items:
        - id: "FP-UC07-001"
          title: "Usuário acessa Financeiro > Dashboard de Rateios"
          required: true
        - id: "FP-UC07-002"
          title: "Sistema valida permissão rateio.view_dashboard"
          required: true
        - id: "FP-UC07-003"
          title: "Sistema carrega dados do Id_Conglomerado do usuário"
          required: true
        - id: "FP-UC07-004"
          title: "Sistema exibe dashboard com 4 seções: Cards Resumo, Gráficos, Alertas, Últimos Rateios"
          required: true
        - id: "FP-UC07-005"
          title: "Sistema permite filtrar por período (mês/ano)"
          required: true
        - id: "FA-UC07-001"
          title: "Aplicar filtro de período → recarregar dashboard"
          required: false
        - id: "FA-UC07-002"
          title: "Clicar em alerta → redirecionar para detalhes (UC02)"
          required: false
        - id: "FA-UC07-003"
          title: "Clicar em Visualizar → redirecionar UC02"
          required: false
        - id: "FA-UC07-004"
          title: "Exportar dashboard para PDF"
          required: false
        - id: "FE-UC07-001"
          title: "Usuário sem permissão rateio.view_dashboard → acesso negado"
          required: true
        - id: "FE-UC07-002"
          title: "Nenhum rateio executado no período → estado vazio"
          required: true
        - id: "FE-UC07-003"
          title: "Erro ao carregar dados → mensagem erro e log"
          required: true

    precondicoes:
      - permissao: "rateio.view_dashboard"

    gatilho: "Usuário acessa Financeiro > Dashboard de Rateios"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessar_dashboard_rateios"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao_view_dashboard"
      - passo: 3
        ator: "sistema"
        acao: "carregar_dados_tenant"
      - passo: 4
        ator: "sistema"
        acao: "exibir_dashboard_4_secoes"
      - passo: 5
        ator: "sistema"
        acao: "permitir_filtro_periodo"

    fluxos_alternativos:
      - id: "FA-UC07-01"
        condicao: "aplicar_filtro_periodo"
        resultado: "recarregar_dashboard_periodo_selecionado"
      - id: "FA-UC07-02"
        condicao: "clicar_alerta"
        resultado: "redirecionar_uc02_detalhes"
      - id: "FA-UC07-03"
        condicao: "clicar_visualizar_rateio"
        resultado: "redirecionar_uc02"
      - id: "FA-UC07-04"
        condicao: "exportar_pdf"
        resultado: "gerar_pdf_graficos_metricas"

    fluxos_excecao:
      - id: "FE-UC07-01"
        condicao: "sem_permissao_view_dashboard"
        resultado: "acesso_negado_redirecionar"
      - id: "FE-UC07-02"
        condicao: "nenhum_rateio_periodo"
        resultado: "exibir_estado_vazio"
      - id: "FE-UC07-03"
        condicao: "erro_carregar_dados"
        resultado: "mensagem_erro_log"

    regras_aplicadas:
      - "RN-UC-07-001"
      - "RN-UC-07-002"
      - "RN-UC-07-003"
      - "RN-UC-07-004"
      - "RN-UC-07-005"
      - "RN-UC-07-006"

    resultado_final:
      estado: "dashboard_exibido"

exclusions:
  uc_items: []

historico:
  - versao: "1.0"
    data: "2025-12-18"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Versao inicial (formato resumido)"
  - versao: "2.0"
    data: "2025-12-31"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Migração para template v2.0 (detalhamento completo: FP/FA/FE, RN, CA, rastreabilidade)"
