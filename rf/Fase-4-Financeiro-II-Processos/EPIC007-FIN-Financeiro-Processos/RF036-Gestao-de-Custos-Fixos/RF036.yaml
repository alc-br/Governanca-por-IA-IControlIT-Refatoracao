# =============================================
# RF036 - Gestão de Custos Fixos
# Versão: 2.0
# Autor: Agência ALC - alc.dev.br
# =============================================

rf:
  id: "RF036"
  nome: "Gestão de Custos Fixos"
  versao: "2.0"
  data: "2025-12-30"
  fase: "Fase 4 - Financeiro II - Processos"
  epic: "EPIC007-FIN"
  status: "em_desenvolvimento" # draft | aprovado | em_desenvolvimento | concluido

descricao:
  objetivo: "Implementar sistema completo para gerenciamento de despesas recorrentes mensais (custos fixos) com provisionamento automático, controle de variações orçamentárias, detecção de anomalias e análise de tendências."
  problema_resolvido: "Controle manual de custos fixos sem provisionamento automático, sem alertas de variação orçamentária e sem análise de tendências."
  publico_afetado: "Gestores financeiros, controllers, diretores e equipe de contas a pagar."

escopo:
  incluso:
    - "Cadastro completo de custos fixos mensais"
    - "Provisionamento automático de lançamentos mensais"
    - "Sistema de alertas de variação orçamentária (>10%, >20%, >30%)"
    - "Detecção automática de anomalias estatísticas"
    - "Análise de tendências e comparação Year-over-Year (YoY)"
    - "Dashboard gerencial com projeções de custos"
    - "Rateio multi-dimensional (centro de custo, filial)"
    - "Alertas de vencimento (7, 3, 1 dia antes)"
    - "Histórico completo de alterações"
    - "Aprovação gerencial para variações >30%"
    - "Controle de acesso RBAC por operação"
    - "Auditoria completa de todas operações"
    - "Multi-tenancy com isolamento por conglomerado"
  fora:
    - "Interface visual específica (responsabilidade do frontend)"
    - "Tecnologia, framework ou linguagem (responsabilidade técnica)"
    - "Layout, UX ou identidade visual (design system)"
    - "Estratégia de deploy ou infraestrutura (DevOps)"
    - "Integração direta com ERP externo (RF futuro)"
    - "Pagamento automático de títulos (módulo financeiro)"
    - "Gestão de custos variáveis (RF separado)"
    - "Importação de faturas de serviços (módulo específico)"

entidades:
  - nome: "CustoFixo"
    descricao: "Despesa recorrente mensal com valor relativamente constante"
    multi_tenant: true
    soft_delete: true
    auditoria: true
    estados:
      - id: "ativo"
        codigo: 1
        descricao: "Custo fixo ativo, será provisionado automaticamente"
      - id: "inativo"
        codigo: 2
        descricao: "Custo fixo inativo, não será provisionado"
      - id: "suspenso"
        codigo: 3
        descricao: "Custo fixo temporariamente suspenso"
      - id: "cancelado"
        codigo: 4
        descricao: "Custo fixo cancelado definitivamente"

  - nome: "LancamentoCustoFixo"
    descricao: "Registro específico de custo fixo em um mês de referência"
    multi_tenant: true
    soft_delete: true
    auditoria: true
    estados:
      - id: "provisionado"
        codigo: 1
        descricao: "Lançamento criado automaticamente, valor ainda não confirmado"
      - id: "realizado"
        codigo: 2
        descricao: "Valor realizado informado"
      - id: "aguardando_aprovacao"
        codigo: 3
        descricao: "Lançamento com variação >30% aguardando aprovação gerencial"
      - id: "aprovado"
        codigo: 4
        descricao: "Lançamento aprovado pela gerência"
      - id: "pago"
        codigo: 5
        descricao: "Lançamento pago, não pode ser mais editado"
      - id: "cancelado"
        codigo: 6
        descricao: "Lançamento cancelado"

  - nome: "RateioCustoFixo"
    descricao: "Distribuição do custo entre múltiplos centros de custo ou filiais"
    multi_tenant: true
    soft_delete: true
    auditoria: true

regras_negocio:
  - id: "RN-RF036-01"
    descricao: "Campos obrigatórios no cadastro (Descricao, TipoCustoFixoId, ValorOrcadoMensal, DataInicio, Status)"
    tipo: "validacao"
    campos_afetados: ["Descricao", "TipoCustoFixoId", "ValorOrcadoMensal", "DataInicio", "Status"]
    obrigatorio: true
    criterio_aceite:
      - "Campo ausente → HTTP 400 com mensagem específica"
      - "Campo vazio ou inválido → HTTP 400 com mensagem específica"
      - "Descrição com mais de 500 caracteres → HTTP 400"
      - "Valor orçado ≤ 0 → HTTP 400"
      - "Data de início futura → HTTP 400"

  - id: "RN-RF036-02"
    descricao: "Provisionamento automático mensal no 1º dia útil do mês"
    tipo: "regra_negocio"
    campos_afetados: ["Status", "DataInicio", "DataFim"]
    obrigatorio: true
    criterio_aceite:
      - "Job executado no 1º dia útil de cada mês"
      - "Apenas custos com Status=Ativo são provisionados"
      - "Apenas custos com DataInicio ≤ hoje são provisionados"
      - "Custos com DataFim < hoje NÃO são provisionados"
      - "Valor provisionado = valor realizado mês anterior OU valor orçado"
      - "FlProvisionamentoAutomatico = true no lançamento criado"
      - "Notificação enviada ao responsável após provisionamento"

  - id: "RN-RF036-03"
    descricao: "Alertas de variação orçamentária em 3 níveis (10%, 20%, 30%)"
    tipo: "regra_negocio"
    campos_afetados: ["ValorRealizado", "ValorOrcado"]
    obrigatorio: true
    criterio_aceite:
      - "Variação ≥10% e <20% → Alerta Informativo"
      - "Variação ≥20% e <30% → Alerta de Aviso"
      - "Variação ≥30% → Alerta Crítico + RequereAprovacaoGerencial = true"
      - "Alerta enviado ao usuário responsável do custo fixo"
      - "Percentual = |valorRealizado - valorOrcado| / valorOrcado * 100"

  - id: "RN-RF036-04"
    descricao: "Justificativa obrigatória para variações >20%"
    tipo: "validacao"
    campos_afetados: ["Justificativa"]
    obrigatorio: true
    criterio_aceite:
      - "Variação >20% sem justificativa → HTTP 400"
      - "Justificativa deve ter no mínimo 10 caracteres"
      - "Justificativa persistida no lançamento"

  - id: "RN-RF036-05"
    descricao: "Aprovação gerencial obrigatória para variações >30%"
    tipo: "regra_negocio"
    campos_afetados: ["RequereAprovacaoGerencial", "Status"]
    obrigatorio: true
    criterio_aceite:
      - "Variação >30% → RequereAprovacaoGerencial = true automaticamente"
      - "Status do lançamento = AguardandoAprovacao"
      - "Apenas usuários com permissão GES.CUSTOS_FIXOS.APROVAR podem aprovar"
      - "Ao reprovar, justificativa é obrigatória"
      - "Ao aprovar, lançamento muda para Status = Aprovado"

  - id: "RN-RF036-06"
    descricao: "Rateio multi-dimensional com soma dos percentuais = 100%"
    tipo: "validacao"
    campos_afetados: ["ItensRateio[].Percentual"]
    obrigatorio: false
    criterio_aceite:
      - "Soma dos percentuais ≠ 100% → HTTP 400"
      - "Deve haver ao menos 1 item de rateio"
      - "Cada item deve ter Percentual > 0 e ≤ 100"
      - "Cada item deve ter CentroCustoId válido"

  - id: "RN-RF036-07"
    descricao: "Detecção automática de anomalias estatísticas (média + 2σ)"
    tipo: "regra_negocio"
    campos_afetados: ["ValorRealizado", "FlAnomalia", "DescricaoAnomalia"]
    obrigatorio: true
    criterio_aceite:
      - "Mínimo 3 meses de histórico necessários"
      - "Anomalia se: valorAtual > média + (2 × desvio padrão)"
      - "FlAnomalia = true no lançamento"
      - "DescricaoAnomalia preenchida com detalhes"
      - "Alerta enviado ao responsável"

  - id: "RN-RF036-08"
    descricao: "Data de fim opcional mas se informada deve ser > DataInicio"
    tipo: "validacao"
    campos_afetados: ["DataFim"]
    obrigatorio: false
    criterio_aceite:
      - "DataFim < DataInicio → HTTP 400"
      - "Provisionamento NÃO cria lançamento para mês > DataFim"

  - id: "RN-RF036-09"
    descricao: "Vinculação opcional a fornecedor e/ou contrato"
    tipo: "regra_negocio"
    campos_afetados: ["FornecedorId", "ContratoId"]
    obrigatorio: false
    criterio_aceite:
      - "FornecedorId informado → deve existir e pertencer ao mesmo ConglomeradoId"
      - "ContratoId informado → deve existir e pertencer ao mesmo ConglomeradoId"
      - "Ambos são opcionais"

  - id: "RN-RF036-10"
    descricao: "Status do custo fixo (Ativo, Inativo, Suspenso, Cancelado)"
    tipo: "regra_negocio"
    campos_afetados: ["Status"]
    obrigatorio: true
    criterio_aceite:
      - "Status deve ser 1=Ativo, 2=Inativo, 3=Suspenso, 4=Cancelado"
      - "Provisionamento considera apenas Status = Ativo"
      - "Status inválido → HTTP 400"

  - id: "RN-RF036-11"
    descricao: "Alertas de vencimento em 7, 3 e 1 dia antes"
    tipo: "regra_negocio"
    campos_afetados: ["DataVencimento"]
    obrigatorio: false
    criterio_aceite:
      - "Job diário verifica vencimentos em 7, 3 e 1 dia"
      - "Alerta enviado apenas para Status ≠ Pago"
      - "Severidade: 7 dias = Informativo, 3 dias = Aviso, 1 dia = Crítico"

  - id: "RN-RF036-12"
    descricao: "Bloqueio de edição de lançamentos com Status = Pago"
    tipo: "validacao"
    campos_afetados: ["Status"]
    obrigatorio: true
    criterio_aceite:
      - "Tentativa de atualização de lançamento Pago → HTTP 400"
      - "Tentativa de exclusão de lançamento Pago → HTTP 400"
      - "Visualização permanece permitida"

  - id: "RN-RF036-13"
    descricao: "Isolamento multi-tenant por ConglomeradoId"
    tipo: "seguranca"
    campos_afetados: ["ConglomeradoId"]
    obrigatorio: true
    criterio_aceite:
      - "Tentativa de acesso a custo de outro conglomerado → HTTP 404"
      - "Queries automáticas filtram por ConglomeradoId do usuário"
      - "ConglomeradoId obrigatório em criação"

estados:
  custo_fixo:
    - id: "ativo"
      codigo: 1
      descricao: "Ativo"
    - id: "inativo"
      codigo: 2
      descricao: "Inativo"
    - id: "suspenso"
      codigo: 3
      descricao: "Suspenso"
    - id: "cancelado"
      codigo: 4
      descricao: "Cancelado"

  lancamento_custo_fixo:
    - id: "provisionado"
      codigo: 1
      descricao: "Provisionado"
    - id: "realizado"
      codigo: 2
      descricao: "Realizado"
    - id: "aguardando_aprovacao"
      codigo: 3
      descricao: "Aguardando Aprovação"
    - id: "aprovado"
      codigo: 4
      descricao: "Aprovado"
    - id: "pago"
      codigo: 5
      descricao: "Pago"
    - id: "cancelado"
      codigo: 6
      descricao: "Cancelado"

transicoes:
  permitidas:
    - de: "provisionado"
      para: "realizado"
      condicao: "Valor realizado informado, variação ≤30%"
    - de: "provisionado"
      para: "aguardando_aprovacao"
      condicao: "Valor realizado informado, variação >30%"
    - de: "realizado"
      para: "aguardando_aprovacao"
      condicao: "Recálculo identificou variação >30%"
    - de: "aguardando_aprovacao"
      para: "aprovado"
      condicao: "Aprovação gerencial concedida"
    - de: "aguardando_aprovacao"
      para: "cancelado"
      condicao: "Aprovação gerencial negada"
    - de: "realizado"
      para: "pago"
      condicao: "Pagamento efetuado"
    - de: "aprovado"
      para: "pago"
      condicao: "Pagamento efetuado"
  proibidas:
    - de: "pago"
      para: "*"
      motivo: "Lançamentos pagos são imutáveis"
    - de: "cancelado"
      para: "*"
      motivo: "Lançamentos cancelados não podem ser reativados"

eventos_dominio:
  - id: "CustoFixoCriado"
    quando: "Após criação bem-sucedida"
    dados: ["Id", "Descricao", "ValorOrcado", "ConglomeradoId"]
  - id: "CustoFixoAtualizado"
    quando: "Após atualização"
    dados: ["Id", "CamposAlterados"]
  - id: "CustoFixoInativado"
    quando: "Mudança de status para Inativo"
    dados: ["Id", "MotivoInativacao"]
  - id: "LancamentoProvisionado"
    quando: "Job de provisionamento cria lançamento"
    dados: ["CustoFixoId", "MesReferencia", "ValorProvisionado"]
  - id: "VariacaoOrcamentariaDetectada"
    quando: "Variação >10% identificada"
    dados: ["LancamentoId", "PercentualVariacao", "NivelSeveridade"]
  - id: "AnomaliaDetectada"
    quando: "Valor fora do padrão estatístico"
    dados: ["LancamentoId", "ValorAtual", "MediaHistorica"]
  - id: "AprovacaoSolicitada"
    quando: "Lançamento com variação >30%"
    dados: ["LancamentoId", "UsuarioResponsavel"]
  - id: "LancamentoAprovado"
    quando: "Aprovação gerencial concedida"
    dados: ["LancamentoId", "AprovadoPor"]
  - id: "VencimentoProximo"
    quando: "Alerta de vencimento (7, 3, 1 dia)"
    dados: ["LancamentoId", "DiasRestantes"]

permissoes:
  - codigo: "GES.CUSTOS_FIXOS.VIEW"
    descricao: "Visualizar custos fixos"
  - codigo: "GES.CUSTOS_FIXOS.CREATE"
    descricao: "Criar custo fixo"
  - codigo: "GES.CUSTOS_FIXOS.UPDATE"
    descricao: "Atualizar custo fixo"
  - codigo: "GES.CUSTOS_FIXOS.DELETE"
    descricao: "Excluir custo fixo"
  - codigo: "GES.CUSTOS_FIXOS.APROVAR"
    descricao: "Aprovar lançamentos com variação >30%"
  - codigo: "GES.CUSTOS_FIXOS.PROVISIONAR"
    descricao: "Executar provisionamento manual"
  - codigo: "GES.CUSTOS_FIXOS.EXPORT"
    descricao: "Exportar relatórios de custos fixos"

integracoes:
  internas:
    - "Autenticacao (JWT Bearer Token)"
    - "Multi-Tenancy (ConglomeradoId)"
    - "Auditoria (AuditInterceptor)"
    - "Notificacoes (Sistema de Alertas)"
    - "Jobs (Hangfire - Provisionamento, Detecção Anomalias, Alertas Vencimento)"
  externas:
    - sistema: "ERP Externo"
      tipo: "API"
      obrigatoria: false
      status: "futuro"

seguranca:
  isolamento_tenant: true
  auditoria_obrigatoria: true
  soft_delete: true
  validacao_entrada: true
  protecao_injecao: true

rastreabilidade:
  ucs_esperados:
    - "UC00-listar-custos-fixos"
    - "UC01-criar-custo-fixo"
    - "UC02-visualizar-custo-fixo"
    - "UC03-editar-custo-fixo"
    - "UC04-inativar-custo-fixo"
    - "UC05-provisionar-custos-fixos"
    - "UC06-registrar-valor-realizado"
    - "UC07-aprovar-lancamento"
    - "UC08-configurar-rateio"
    - "UC09-dashboard-custos-fixos"
    - "UC10-projecao-custos"
  md_esperado: "MD-RF036.yaml"
  wf_esperado: "WF-RF036.md"
  mt_esperado: "MT-RF036.yaml"
  tc_esperado: "TC-RF036.yaml"
  rl_relacionado: "RL-RF036.md"

catalog:
  crud:
    - id: "RF-CRUD-01"
      title: "Criar custo fixo"
      required: true
    - id: "RF-CRUD-02"
      title: "Listar custos fixos"
      required: true
    - id: "RF-CRUD-03"
      title: "Visualizar custo fixo"
      required: true
    - id: "RF-CRUD-04"
      title: "Atualizar custo fixo"
      required: true
    - id: "RF-CRUD-05"
      title: "Inativar custo fixo"
      required: true

  validacoes:
    - id: "RF-VAL-01"
      title: "Validar campos obrigatórios"
      required: true
    - id: "RF-VAL-02"
      title: "Validar variação orçamentária >20% com justificativa"
      required: true
    - id: "RF-VAL-03"
      title: "Validar rateio soma = 100%"
      required: false
    - id: "RF-VAL-04"
      title: "Validar DataFim > DataInicio"
      required: false
    - id: "RF-VAL-05"
      title: "Bloquear edição de lançamentos pagos"
      required: true

  seguranca:
    - id: "RF-SEC-01"
      title: "Isolamento de tenant (ConglomeradoId)"
      required: true
    - id: "RF-SEC-02"
      title: "Permissões RBAC por operação"
      required: true
    - id: "RF-SEC-03"
      title: "Auditoria completa de operações"
      required: true

  jobs:
    - id: "RF-JOB-01"
      title: "Provisionamento automático mensal"
      required: true
      periodicidade: "Mensal (1º dia útil)"
    - id: "RF-JOB-02"
      title: "Detecção de anomalias estatísticas"
      required: true
      periodicidade: "Semanal"
    - id: "RF-JOB-03"
      title: "Alertas de vencimento"
      required: true
      periodicidade: "Diário"

exclusions:
  rf_items: []

historico:
  - versao: "2.0"
    data: "2025-12-30"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Migração v1.0 → v2.0: Separação RF/RL completa, estruturação YAML canônica"
  - versao: "1.0"
    data: "2025-12-17"
    autor: "Architect Agent"
    descricao: "Versão inicial com conteúdo legado misturado"
