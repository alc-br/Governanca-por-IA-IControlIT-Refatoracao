# RF-037: Gest√£o de Custos por Ativo (TCO)

**Vers√£o**: 2.0
**Data**: 2025-12-30
**Autor**: Ag√™ncia ALC - alc.dev.br
**EPIC**: EPIC007-FIN - Financeiro Processos
**Fase**: Fase 4 - Financeiro II - Processos

---

## 1. OBJETIVO DO REQUISITO

Implementar um sistema completo de TCO (Total Cost of Ownership) para rastreamento, an√°lise e otimiza√ß√£o de todos os custos associados a ativos espec√≠ficos ao longo de seu ciclo de vida. O sistema deve calcular automaticamente o TCO total, realizar an√°lises de ROI, projetar custos futuros, comparar ativos similares e recomendar substitui√ß√µes quando economicamente vi√°vel.

Este documento define **o que o sistema deve fazer** em rela√ß√£o √† gest√£o de custos por ativo, sem prescrever tecnologias ou implementa√ß√µes espec√≠ficas. Serve como contrato oficial entre neg√≥cio, desenvolvimento, testes e agentes de IA.

---

## 2. ESCOPO

### 2.1 O que est√° dentro do escopo

- [x] Registro de custos por categoria (aquisi√ß√£o, manuten√ß√£o, licen√ßas, consum√≠veis, energia, deprecia√ß√£o)
- [x] C√°lculo autom√°tico de TCO total e por categoria
- [x] Sistema de deprecia√ß√£o autom√°tica mensal (m√©todos linear e acelerado)
- [x] An√°lise de ROI e payback period
- [x] Proje√ß√£o de custos futuros baseada em hist√≥rico
- [x] Compara√ß√£o e benchmarking entre ativos do mesmo tipo
- [x] Alertas de custos acima da m√©dia
- [x] Recomenda√ß√£o autom√°tica de substitui√ß√£o de ativos
- [x] Dashboard de TCO com gr√°ficos interativos
- [x] Exporta√ß√£o de relat√≥rios de TCO
- [x] Controle de acesso e isolamento por tenant
- [x] Auditoria completa de opera√ß√µes

### 2.2 Fora do escopo (n√£o objetivos)

- Interface visual espec√≠fica (design, layout, UX)
- Tecnologia, framework ou linguagem de programa√ß√£o
- Integra√ß√£o com sistema de contabilidade externo (ser√° RF futuro)
- C√°lculo de impostos sobre ativos
- Gest√£o de garantias (m√≥dulo espec√≠fico)
- An√°lise preditiva de falhas com IA/ML (fase futura)
- Estrat√©gia de deploy ou infraestrutura

---

## 3. CONCEITOS E DEFINI√á√ïES

| Termo | Defini√ß√£o |
|-------|-----------|
| **TCO (Total Cost of Ownership)** | Soma de todos os custos diretos e indiretos associados a um ativo ao longo de seu ciclo de vida |
| **CAPEX** | Capital Expenditure - Investimento em aquisi√ß√£o de ativo |
| **OPEX** | Operational Expenditure - Despesas operacionais (manuten√ß√£o, licen√ßas, consum√≠veis) |
| **ROI** | Return on Investment - Retorno sobre investimento calculado como (Benef√≠cios - Custos) / Custos |
| **Payback Period** | Tempo necess√°rio para recuperar o investimento inicial atrav√©s dos benef√≠cios gerados |
| **Deprecia√ß√£o** | Redu√ß√£o do valor cont√°bil do ativo ao longo do tempo |
| **Valor Residual** | Valor estimado do ativo ao final de sua vida √∫til |
| **Custo Unit√°rio** | TCO dividido por unidade de medida (por usu√°rio, por p√°gina, por hora) |
| **Benchmarking** | Compara√ß√£o de desempenho de custo entre ativos similares |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Criar custo associado a ativo** - Registrar novo custo com categoria, valor, data e descri√ß√£o
2. **Atualizar custo existente** - Editar informa√ß√µes de custo previamente registrado
3. **Consultar custo por ID** - Visualizar detalhes completos de um custo espec√≠fico
4. **Listar custos de um ativo** - Ver hist√≥rico completo de custos com filtros por categoria e per√≠odo
5. **Excluir custo** - Remover custo via soft delete
6. **Calcular TCO total** - Somar todos os custos associados ao ativo
7. **Calcular TCO por categoria** - Agregar custos por tipo (aquisi√ß√£o, manuten√ß√£o, licen√ßas, etc.)
8. **Calcular deprecia√ß√£o autom√°tica** - Gerar lan√ßamentos mensais de deprecia√ß√£o
9. **Calcular ROI do ativo** - Comparar benef√≠cios vs. custos totais
10. **Projetar custos futuros** - Estimar custos baseado em m√©dia hist√≥rica
11. **Comparar TCO entre ativos** - Analisar ativos similares e identificar outliers
12. **Gerar alertas de custo** - Notificar quando custo ultrapassar m√©dia do tipo
13. **Recomendar substitui√ß√£o** - Sugerir troca quando TCO anual > 50% do valor de ativo novo
14. **Exportar relat√≥rio de TCO** - Gerar relat√≥rios em Excel/PDF com breakdown de custos
15. **Visualizar dashboard de TCO** - Exibir gr√°ficos de evolu√ß√£o, breakdown e compara√ß√µes

---

## 5. REGRAS DE NEG√ìCIO

### RN-RF037-01 ‚Äî Campos obrigat√≥rios no registro de custo

**Descri√ß√£o**: Todo custo associado a ativo deve ter ativo, tipo de custo, valor, data de ocorr√™ncia e categoria obrigat√≥rios.

**Justificativa**: Garante informa√ß√µes m√≠nimas para c√°lculo preciso de TCO e an√°lises financeiras.

**Crit√©rio de Aceite**:
- Campo "AtivoId" ausente ou inv√°lido ‚Üí rejei√ß√£o HTTP 400
- Campo "TipoCustoAtivoId" ausente ‚Üí rejei√ß√£o HTTP 400
- Campo "Valor" ausente, zero ou negativo ‚Üí rejei√ß√£o HTTP 400
- Campo "DataOcorrencia" ausente ou futura ‚Üí rejei√ß√£o HTTP 400
- Campo "Categoria" ausente ou fora do enum v√°lido ‚Üí rejei√ß√£o HTTP 400

---

### RN-RF037-02 ‚Äî C√°lculo autom√°tico de TCO ao adicionar custo

**Descri√ß√£o**: Sempre que um custo √© criado, editado ou exclu√≠do, o TCO total do ativo deve ser recalculado automaticamente em tempo real.

**Justificativa**: Mant√©m TCO sempre atualizado para an√°lises precisas e decis√µes gerenciais.

**Crit√©rio de Aceite**:
- Criar custo ‚Üí disparar evento de rec√°lculo de TCO
- Editar custo ‚Üí recalcular TCO total e por categoria
- Excluir custo ‚Üí recalcular TCO descontando o valor removido
- TCO total = soma de todos os custos n√£o exclu√≠dos (FlExcluido = false)
- TCO por categoria = soma agrupada por enum CustoCategoriaEnum

---

### RN-RF037-03 ‚Äî Deprecia√ß√£o autom√°tica mensal

**Descri√ß√£o**: No primeiro dia de cada m√™s √†s 02:00 UTC, o sistema deve calcular e registrar a deprecia√ß√£o de todos os ativos depreci√°veis que ainda n√£o foram depreciados completamente.

**Justificativa**: Mant√©m valor cont√°bil atualizado e custos de deprecia√ß√£o no TCO automaticamente.

**Crit√©rio de Aceite**:
- Job executado mensalmente via agendador (ex: Hangfire)
- Somente ativos com FlDepreciavel = true s√£o processados
- Deprecia√ß√£o = (ValorAquisicao - ValorResidual) / (VidaUtilAnos * 12)
- Quando deprecia√ß√£o acumulada atingir valor depreci√°vel total ‚Üí FlDepreciadoTotalmente = true
- Custo de deprecia√ß√£o registrado com FlDepreciacaoAutomatica = true
- N√£o duplicar deprecia√ß√£o no mesmo m√™s

---

### RN-RF037-04 ‚Äî C√°lculo de ROI (Return on Investment)

**Descri√ß√£o**: O sistema deve calcular ROI do ativo comparando benef√≠cios gerados (receita, economia) vs. custos totais (TCO).

**Justificativa**: Permite decis√µes baseadas em retorno financeiro real do ativo.

**Crit√©rio de Aceite**:
- ROI (%) = ((Benef√≠cios - Custos) / Custos) * 100
- Payback Period (meses) = TCO Total / Benef√≠cio M√©dio Mensal
- Status ROI: "Positivo" se ROI >= 0, "Negativo" se ROI < 0
- Recomenda√ß√£o:
  - ROI < -20% ‚Üí "Considerar substitui√ß√£o do ativo"
  - ROI < 0% ‚Üí "Monitorar desempenho"
  - ROI < 20% ‚Üí "ROI moderado"
  - ROI >= 20% ‚Üí "√ìtimo investimento"

---

### RN-RF037-05 ‚Äî Alertas de custos acima da m√©dia

**Descri√ß√£o**: O sistema deve alertar quando o TCO de um ativo ultrapassar 30% da m√©dia de ativos do mesmo tipo.

**Justificativa**: Identifica ativos problem√°ticos que podem necessitar manuten√ß√£o ou substitui√ß√£o.

**Crit√©rio de Aceite**:
- Executar verifica√ß√£o diariamente via job
- Calcular m√©dia de TCO por tipo de ativo (m√≠nimo 3 ativos para c√°lculo v√°lido)
- Limite de alerta = m√©dia TCO * 1.30
- Se ativo.TCOTotal > limite ‚Üí disparar notifica√ß√£o ao usu√°rio respons√°vel
- Marcar ativo.FlCustoAcimaDaMedia = true
- Registrar percentual acima da m√©dia para exibi√ß√£o

---

### RN-RF037-06 ‚Äî Vincula√ß√£o a ordem de servi√ßo ou contrato

**Descri√ß√£o**: Custos de manuten√ß√£o devem ser vinculados a ordens de servi√ßo. Custos de licen√ßas devem ser vinculados a contratos.

**Justificativa**: Rastreabilidade completa de origem dos custos e integra√ß√£o com outros m√≥dulos.

**Crit√©rio de Aceite**:
- Categoria = Manuten√ß√£o ‚Üí OrdemServicoId obrigat√≥rio
- Categoria = Licen√ßas ‚Üí ContratoId obrigat√≥rio
- Outras categorias ‚Üí vincula√ß√£o opcional
- Valida√ß√£o na cria√ß√£o/edi√ß√£o do custo

---

### RN-RF037-07 ‚Äî Categoriza√ß√£o de custos (CAPEX vs. OPEX)

**Descri√ß√£o**: Custos devem ser categorizados como CAPEX (Capital Expenditure) ou OPEX (Operational Expenditure) para fins cont√°beis.

**Justificativa**: Diferencia√ß√£o cont√°bil entre investimentos e despesas operacionais.

**Crit√©rio de Aceite**:
- Categoria = Aquisicao ‚Üí CAPEX
- Categorias Manutencao, Licencas, Consumiveis, Energia, Suporte, Treinamento ‚Üí OPEX
- Categoria = Depreciacao ‚Üí Cont√°bil (n√£o CAPEX nem OPEX)
- Campo calculado "TipoCusto" retornado nas consultas

---

### RN-RF037-08 ‚Äî Proje√ß√£o de custos futuros

**Descri√ß√£o**: O sistema deve projetar custos futuros baseado em m√©dia hist√≥rica dos √∫ltimos 12 meses.

**Justificativa**: Facilita planejamento or√ßament√°rio e decis√µes de substitui√ß√£o de ativos.

**Crit√©rio de Aceite**:
- Buscar custos dos √∫ltimos 12 meses
- Calcular m√©dia mensal por categoria
- Projetar N meses futuros (par√¢metro configur√°vel)
- Retornar proje√ß√£o total e por categoria
- Indicar se proje√ß√£o √© confi√°vel (baseada em quantos meses de hist√≥rico)

---

### RN-RF037-09 ‚Äî Compara√ß√£o entre ativos (Benchmarking)

**Descri√ß√£o**: O sistema deve permitir compara√ß√£o de TCO entre m√∫ltiplos ativos do mesmo tipo para benchmarking.

**Justificativa**: Identifica ativos com melhor e pior custo-benef√≠cio, facilitando decis√µes de gest√£o.

**Crit√©rio de Aceite**:
- Filtrar ativos por TipoAtivoId e Status = Ativo
- Calcular TCO total, TCO mensal m√©dio, idade do ativo em meses
- Calcular m√©dia de TCO do grupo
- Classificar cada ativo:
  - TCO <= 80% da m√©dia ‚Üí "Econ√¥mico"
  - TCO entre 80% e 120% da m√©dia ‚Üí "Normal"
  - TCO > 120% da m√©dia ‚Üí "Custoso"
- Retornar top 3 mais custosos e top 3 mais econ√¥micos
- Calcular varia√ß√£o percentual de cada ativo vs. m√©dia

---

### RN-RF037-10 ‚Äî Valida√ß√£o de data de ocorr√™ncia

**Descri√ß√£o**: A data de ocorr√™ncia do custo n√£o pode ser anterior √† data de aquisi√ß√£o do ativo.

**Justificativa**: Evita lan√ßamentos inv√°lidos de custos antes do ativo existir.

**Crit√©rio de Aceite**:
- Se ativo.DataAquisicao existe ‚Üí custo.DataOcorrencia >= ativo.DataAquisicao
- Data futura ‚Üí n√£o permitida
- Valida√ß√£o na cria√ß√£o e edi√ß√£o do custo
- Retornar HTTP 400 com mensagem clara

---

### RN-RF037-11 ‚Äî Soft delete com rec√°lculo de TCO

**Descri√ß√£o**: Ao excluir um custo, usar soft delete (FlExcluido = true) e recalcular TCO automaticamente.

**Justificativa**: Mant√©m hist√≥rico para auditoria e garante TCO sempre correto.

**Crit√©rio de Aceite**:
- Exclus√£o l√≥gica (FlExcluido = true, n√£o remo√ß√£o f√≠sica do banco)
- Disparar evento de rec√°lculo de TCO
- Registrar na auditoria: usu√°rio, data, motivo da exclus√£o
- Custos exclu√≠dos n√£o aparecem em listagens padr√£o
- Custos exclu√≠dos n√£o s√£o somados no TCO

---

### RN-RF037-12 ‚Äî Dashboard de TCO por per√≠odo

**Descri√ß√£o**: O sistema deve permitir visualiza√ß√£o de TCO agregado por per√≠odos: mensal, trimestral, anual.

**Justificativa**: Facilita an√°lise de evolu√ß√£o de custos ao longo do tempo.

**Crit√©rio de Aceite**:
- Par√¢metro de per√≠odo: Mensal, Trimestral, Anual
- Agrupar custos por data de ocorr√™ncia
- Retornar s√©rie temporal com per√≠odo e valor total
- Ordenar cronologicamente
- Filtrar apenas custos n√£o exclu√≠dos

---

### RN-RF037-13 ‚Äî Exporta√ß√£o de relat√≥rio de TCO

**Descri√ß√£o**: O sistema deve permitir exporta√ß√£o de relat√≥rio completo de TCO em Excel com breakdown por categoria.

**Justificativa**: Facilita apresenta√ß√µes gerenciais e an√°lises externas.

**Crit√©rio de Aceite**:
- Formato de sa√≠da: Excel (.xlsx) ou PDF
- Conte√∫do obrigat√≥rio:
  - Dados do ativo (nome, tipo, data aquisi√ß√£o, valor aquisi√ß√£o)
  - TCO total
  - TCO por categoria (tabela e gr√°fico pizza)
  - Detalhamento de todos os custos (data, categoria, descri√ß√£o, valor)
  - An√°lise de ROI se dispon√≠vel
- Permiss√£o espec√≠fica para exporta√ß√£o (GES.CUSTOS_ATIVO.EXPORT)

---

### RN-RF037-14 ‚Äî Recomenda√ß√£o de substitui√ß√£o

**Descri√ß√£o**: O sistema deve recomendar substitui√ß√£o de ativo quando TCO anual > 50% do valor de aquisi√ß√£o de ativo novo similar.

**Justificativa**: Identifica ativos cujo custo de manuten√ß√£o n√£o compensa manter.

**Crit√©rio de Aceite**:
- Calcular TCO dos √∫ltimos 12 meses
- Buscar valor de mercado de ativo novo similar (campo TipoAtivo.ValorMedioMercado)
- Calcular percentual: (TCO Anual / Valor Novo) * 100
- Recomenda√ß√µes:
  - >= 50% ‚Üí "Substituir urgentemente"
  - >= 30% ‚Üí "Considerar substitui√ß√£o"
  - >= 15% ‚Üí "Monitorar custos"
  - < 15% ‚Üí "Manter ativo"
- Incluir justificativa detalhada com valores

---

### RN-RF037-15 ‚Äî Auditoria completa de opera√ß√µes

**Descri√ß√£o**: Todas as opera√ß√µes de cria√ß√£o, edi√ß√£o e exclus√£o de custos devem ser auditadas com registro de usu√°rio, timestamp e valores antes/depois.

**Justificativa**: Conformidade com LGPD e rastreabilidade fiscal completa.

**Crit√©rio de Aceite**:
- Herdar de BaseAuditableEntity
- Campos autom√°ticos: UsuarioCriacaoId, DataCriacao, UsuarioAlteracaoId, DataAlteracao, FlExcluido
- Registrar opera√ß√µes: CREATE, UPDATE, DELETE, RECALCULAR_TCO, DEPRECIAR
- Reten√ß√£o de 7 anos conforme LGPD
- Auditoria implementada via interceptor do DbContext

---

### RN-RF037-16 ‚Äî Isolamento por tenant

**Descri√ß√£o**: Um usu√°rio s√≥ pode acessar custos de ativos pertencentes ao seu pr√≥prio tenant (FornecedorId).

**Justificativa**: Seguran√ßa e isolamento de dados em ambiente multi-tenant.

**Crit√©rio de Aceite**:
- Todas as queries filtram automaticamente por FornecedorId do usu√°rio logado
- Tentativa de acesso cruzado ‚Üí HTTP 403 Forbidden
- Valida√ß√£o em cria√ß√£o/edi√ß√£o: ativo pertence ao Fornecedor do usu√°rio
- Filtro aplicado via Query Filter global do EF Core

---

## 6. ESTADOS DA ENTIDADE

**A entidade CustoAtivo n√£o possui estados formais.** Um custo pode estar:

| Estado L√≥gico | Descri√ß√£o |
|---------------|-----------|
| **Ativo** | FlExcluido = false - Custo v√°lido e contabilizado no TCO |
| **Exclu√≠do** | FlExcluido = true - Custo removido logicamente, n√£o conta no TCO |

N√£o h√° transi√ß√µes de estado formais. A √∫nica opera√ß√£o √© a exclus√£o l√≥gica (soft delete).

---

## 7. EVENTOS DE DOM√çNIO

| Evento | Quando ocorre |
|--------|---------------|
| **CustoAtivoCriadoDomainEvent** | Ap√≥s cria√ß√£o de custo - dispara rec√°lculo de TCO |
| **CustoAtivoEditadoDomainEvent** | Ap√≥s edi√ß√£o de custo - dispara rec√°lculo de TCO |
| **CustoAtivoExcluidoDomainEvent** | Ap√≥s exclus√£o l√≥gica - dispara rec√°lculo de TCO |
| **TCORecalculadoDomainEvent** | Ap√≥s atualiza√ß√£o do TCO total e por categoria do ativo |
| **DepreciacaoCalculadaDomainEvent** | Ap√≥s c√°lculo autom√°tico mensal de deprecia√ß√£o |
| **AlertaCustoAcimaDaMediaDomainEvent** | Quando ativo ultrapassa 30% da m√©dia de custos |

---

## 8. CRIT√âRIOS GLOBAIS DE ACEITE

- Nenhuma opera√ß√£o pode violar isolamento de tenant (FornecedorId)
- Todas as regras de neg√≥cio (RN-RF037-01 a RN-RF037-16) devem ser respeitadas
- Erros devem retornar c√≥digos HTTP apropriados (400, 403, 404) com mensagens claras
- Auditoria deve registrar quem, quando e o que mudou em todas as opera√ß√µes
- TCO deve ser recalculado automaticamente em tempo real
- Performance: listagem de custos de um ativo deve retornar em < 500ms para at√© 10.000 custos
- Deprecia√ß√£o autom√°tica deve processar at√© 100.000 ativos em < 10 minutos

---

## 9. SEGURAN√áA

### Permiss√µes RBAC

| Opera√ß√£o | Permiss√£o Necess√°ria |
|----------|---------------------|
| Visualizar custos | GES.CUSTOS_ATIVO.VIEW |
| Listar custos | GES.CUSTOS_ATIVO.VIEW_ANY |
| Criar custo | GES.CUSTOS_ATIVO.CREATE |
| Atualizar custo | GES.CUSTOS_ATIVO.UPDATE |
| Excluir custo | GES.CUSTOS_ATIVO.DELETE |
| Exportar relat√≥rio | GES.CUSTOS_ATIVO.EXPORT |
| Visualizar ROI | GES.CUSTOS_ATIVO.VIEW_ROI |

### Valida√ß√µes de Seguran√ßa

- Valida√ß√£o de entrada obrigat√≥ria (FluentValidation)
- Prote√ß√£o contra inje√ß√£o SQL (EF Core parametrizado)
- Controle de permiss√µes via RBAC
- Isolamento multi-tenant via Query Filter
- Sanitiza√ß√£o de inputs antes de persist√™ncia

---

## 10. ARTEFATOS DERIVADOS

Este RF √© base para:

- **UC-RF037.md** - Casos de Uso (UC00 a UC14 detalhando fluxos CRUD, c√°lculos, alertas)
- **MT-RF037.yaml** - Massas de Teste (dados de custos v√°lidos/inv√°lidos, cen√°rios de TCO)
- **TC-RF037.yaml** - Casos de Teste (testes de backend, frontend, E2E, seguran√ßa)
- **MD-RF037.md** - Modelo de Dados (estrutura de tabelas CustosAtivo, BeneficiosAtivo, AtivosTCOCache)
- **WF-RF037.md** - Wireframes (telas de listagem, formul√°rios, dashboard de TCO)

---

## 11. RASTREABILIDADE

| Artefato | Status | Local |
|----------|--------|-------|
| Casos de Uso (UC-RF037.md) | ‚úÖ Criado | docs/rf/Fase-4/EPIC007/RF037/Casos de Uso/ |
| Modelo de Dados (MD-RF037.md) | ‚úÖ Criado | docs/rf/Fase-4/EPIC007/RF037/ |
| Wireframes (WF-RF037.md) | ‚úÖ Criado | docs/rf/Fase-4/EPIC007/RF037/ |
| Massas de Teste (MT-RF037.yaml) | Pendente | docs/rf/Fase-4/EPIC007/RF037/Testes/ |
| Casos de Teste (TC-RF037.yaml) | Pendente | docs/rf/Fase-4/EPIC007/RF037/Testes/ |
| Backend (.NET 10) | üîÑ Skeleton (10%) | D:\IC2\backend\IControlIT.API/src/ |
| Frontend (Angular 19) | ‚úÖ Conclu√≠do | D:\IC2\frontend\icontrolit-app/src/app/modules/gestao/custos-ativo/ |
| Testes E2E (Playwright) | ‚úÖ Aprovados | D:\IC2\frontend\icontrolit-app/e2e/custos-ativo/ |

---

## CHANGELOG

| Vers√£o | Data | Descri√ß√£o | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-30 | Migra√ß√£o v1.0 ‚Üí v2.0: separa√ß√£o RF/RL, 11 se√ß√µes can√¥nicas, 16 regras de neg√≥cio modernas, remo√ß√£o completa de refer√™ncias ao legado | Ag√™ncia ALC - alc.dev.br |
| 1.0 | 2025-12-17 | Vers√£o inicial com 5 se√ß√µes (inclu√≠a refer√™ncias ao legado misturadas) | Architect Agent |
