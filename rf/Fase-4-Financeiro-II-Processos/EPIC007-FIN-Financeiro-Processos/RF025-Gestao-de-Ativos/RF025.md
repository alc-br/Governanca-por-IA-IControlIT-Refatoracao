# RF-025: Gestão Completa de Ativos de TI e Telecom

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC007-FIN - Financeiro Processos
**Fase**: Fase 4 - Financeiro II Processos

---

## 1. OBJETIVO DO REQUISITO

Prover sistema completo de gestão de ativos de TI (notebooks, desktops, servidores, smartphones, tablets, impressoras) e Telecom (linhas móveis, fixas, aparelhos telefônicos) com rastreamento de ciclo de vida desde aquisição até baixa patrimonial, incluindo geração automática de QR Codes para identificação, controle de movimentações com geolocalização GPS, cálculo automático de depreciação contábil, alertas de vencimento de garantia e integração bidirecional com sistemas ERP para sincronização contábil.

Este documento define **o que o sistema deve fazer**, não como implementar, servindo como **contrato oficial** entre negócio, desenvolvimento, testes e agentes de IA.

### Objetivos Mensuráveis

- **Redução de Extravio**: De 15% para 5% dos ativos (economia estimada R$500k/ano)
- **Inventário Físico**: De 2 semanas (40h/pessoa) para 2 dias (8h/pessoa) via app mobile = 80% redução
- **Compliance Contábil**: Depreciação automática elimina 100% dos erros de cálculo manual
- **ROI**: Sistema paga-se em 6 meses com redução de perdas e otimização de inventário

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Cadastro completo de ativos com geração automática de QR Code único
- [x] Workflow de movimentações com validação de transições de status
- [x] Histórico completo de movimentações (chain of custody) imutável
- [x] Alocação de ativos com responsável obrigatório e termo digital
- [x] Geolocalização GPS obrigatória para inventário mobile
- [x] Depreciação automática mensal (job Hangfire) com 3 métodos (Linear, Acelerada, Soma Dígitos)
- [x] Alertas automáticos de vencimento de garantia (30/60/90 dias)
- [x] Validação de IMEI para smartphones (algoritmo Luhn + consulta Anatel)
- [x] Workflow de aprovação de 2 níveis para baixa patrimonial
- [x] App mobile MAUI para inventário com scan QR Code
- [x] Dashboard executivo com gráficos tempo real (Chart.js)
- [x] Integração bidirecional com ERP (SAP, TOTVS) via API REST
- [x] Isolamento multi-tenant com filtro obrigatório por Id_Conglomerado
- [x] Soft delete obrigatório para preservação de histórico
- [x] Auditoria completa de operações CREATE/UPDATE/DELETE/ACCESS

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (framework/template)
- Tecnologia de implementação (linguagem, banco de dados)
- Layout, UX ou identidade visual
- Estratégia de deploy ou infraestrutura
- Gestão de contratos (RF separado)
- Gestão de chamados/tickets (RF separado)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Ativo** | Bem patrimonial de TI ou Telecom rastreado pelo sistema |
| **Número Patrimônio** | Identificador único gerado automaticamente no formato PAT-{TipoAbrev}-{Ano}-{Sequencial} |
| **QR Code** | Código bidimensional gerado automaticamente apontando para URL do ativo |
| **Movimentação** | Qualquer alteração de status, responsável ou localização de um ativo |
| **Chain of Custody** | Histórico completo e imutável de todas as movimentações |
| **Depreciação** | Redução gradual do valor contábil do ativo ao longo do tempo |
| **Garantia** | Período em que fabricante/fornecedor cobre reparos sem custo |
| **Inventário Físico** | Conferência presencial da existência e estado de ativos |
| **Baixa Patrimonial** | Remoção definitiva do ativo do patrimônio da empresa |
| **Tenant** | Unidade lógica de isolamento de dados (Conglomerado) |
| **Geolocalização** | Coordenadas GPS (latitude/longitude) capturadas em movimentações |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Criar Ativo** - Cadastro completo com geração automática de QR Code e número patrimônio
2. **Atualizar Ativo** - Edição de dados com validação de campos obrigatórios por tipo
3. **Consultar Ativo por ID** - Busca detalhada com histórico completo de movimentações
4. **Listar Ativos** - Listagem paginada com filtros por tipo, status, localização, responsável
5. **Alocar Ativo** - Atribuir a usuário com termo de responsabilidade digital
6. **Transferir Ativo** - Mover entre localizações com captura GPS
7. **Devolver Ativo** - Liberar para reutilização com checklist de devolução
8. **Enviar para Manutenção** - Alterar status e registrar motivo
9. **Baixar Ativo** - Baixa patrimonial com workflow de aprovação de 2 níveis
10. **Inventariar Ativo** - Registrar conferência física com foto e GPS (app mobile)
11. **Consultar Histórico** - Timeline completa de movimentações com responsáveis
12. **Gerar QR Code** - Impressão de etiquetas em lote (PDF)
13. **Calcular Depreciação** - Job automático mensal com integração ERP
14. **Alertar Garantia** - Notificações automáticas 30/60/90 dias antes vencimento
15. **Dashboard Executivo** - Gráficos tempo real (ativos por status, tipo, taxa utilização)

---

## 5. REGRAS DE NEGÓCIO

### RN-RF025-001: Número de Patrimônio Único Global

**Descrição**: Cada ativo DEVE ter um número de patrimônio único no sistema, gerado automaticamente no formato `PAT-{TipoAbrev}-{Ano}-{Sequencial}`.

**Exemplo**: PAT-NB-2025-0001 (Notebook), PAT-SM-2025-0045 (Smartphone)

**Unicidade**: Sistema valida unicidade ANTES de salvar. Constraint UNIQUE INDEX no banco previne duplicatas.

**Geração Automática**: Backend gera número sequencial por tipo de ativo e ano (reinicia contador a cada ano).

**Critério de Aceite**:
- Tentativa de criar ativo com número duplicado → rejeição HTTP 409 Conflict
- Número gerado automaticamente deve seguir formato exato
- Sequencial deve reiniciar a cada ano (01/01)

---

### RN-RF025-002: QR Code Gerado Automaticamente

**Descrição**: Ao criar ativo, sistema DEVE gerar QR Code único apontando para URL `https://api.icontrolit.com.br/ativos/qr/{Id_Ativo}`.

**Armazenamento**:
- Campo `QR_Code_Base64` para impressão offline
- Campo `QR_Code_URL` para acesso online

**Formato**: Correção de erro nível "High" (30% da imagem pode estar danificada e ainda funcionar)

**Tamanho**: 300x300px para impressão em etiquetas 30x30mm

**Critério de Aceite**:
- QR Code gerado automaticamente ao criar ativo
- Scan do QR Code redireciona para detalhes do ativo
- Base64 armazenado permite impressão offline

---

### RN-RF025-003: Status de Ativo com Transições Válidas

**Descrição**: Ativo possui status (Enum: Disponivel, Alocado, Manutencao, Baixado, Perdido, Reservado) com transições válidas.

**Transições Permitidas**:
- **Disponivel** → Alocado, Reservado, Manutencao, Baixado
- **Alocado** → Disponivel (devolução), Manutencao, Perdido, Baixado
- **Manutencao** → Disponivel (reparo concluído), Baixado (irreparável)
- **Reservado** → Disponivel (cancelamento), Alocado (efetivação)
- **Baixado** → Nenhum (estado final)
- **Perdido** → Disponivel (encontrado), Baixado (baixa patrimonial)

**Critério de Aceite**:
- Transição inválida → HTTP 400 Bad Request com mensagem explicativa
- Sistema valida transição antes de salvar
- Estado "Baixado" é irreversível (exceto para administradores com justificativa)

---

### RN-RF025-004: Alocação Requer Usuário Responsável

**Descrição**: Ao mudar status para "Alocado", campo `Id_Usuario_Responsavel` DEVE ser preenchido obrigatoriamente.

**Validação**: Campo validado como FK existente na tabela Users.

**Notificação**: Usuário responsável DEVE receber email/push notification com Termo de Responsabilidade digital para aceite.

**Devolução**: Ao mudar status de "Alocado" para "Disponivel", campo `Id_Usuario_Responsavel` é limpo (NULL) automaticamente.

**Critério de Aceite**:
- Alocar sem responsável → HTTP 400 Bad Request
- Termo de responsabilidade enviado automaticamente
- Devolução limpa responsável automaticamente

---

### RN-RF025-005: Histórico Completo de Movimentações (Chain of Custody)

**Descrição**: TODA alteração de status ou responsável DEVE gerar registro em tabela `Ativo_Movimentacao` com campos obrigatórios.

**Campos Obrigatórios**:
- `Tipo_Movimentacao`: Enum (Alocacao, Transferencia, Devolucao, Manutencao, Baixa)
- `Status_Origem` e `Status_Destino`
- `Usuario_Origem_Id` e `Usuario_Destino_Id` (se aplicável)
- `Localizacao_Origem_Id` e `Localizacao_Destino_Id` (se aplicável)
- `Latitude` e `Longitude` (se capturado via mobile app)
- `Data_Movimentacao` (timestamp UTC)
- `Usuario_Responsavel_Movimentacao` (quem executou a ação)
- `Justificativa` (obrigatória para Baixa e Perdido, opcional para demais)

**Imutabilidade**: Registros em `Ativo_Movimentacao` NUNCA podem ser editados ou deletados (apenas INSERT).

**Critério de Aceite**:
- Toda movimentação registrada automaticamente
- Registros imutáveis (tentativa de UPDATE/DELETE → HTTP 403 Forbidden)
- Timeline completa acessível via API

---

### RN-RF025-006: Depreciação Automática Mensal

**Descrição**: Job Hangfire executa TODO mês (dia 1 às 02:00 UTC) cálculo de depreciação para ativos com `Dt_Aquisicao` preenchida.

**Métodos Suportados**:
1. **Linear**: Depreciação constante por mês = (Valor_Aquisicao - Valor_Residual) / (Taxa_Depreciacao_Anual * 12)
2. **Acelerada**: Depreciação maior no início (Declining Balance Method) = Valor_Atual × Taxa_Anual / 12
3. **Soma_Digitos**: Soma dos dígitos dos anos (Sum-of-Years' Digits Method)

**Atualização**: Job atualiza campos `Valor_Atual_Depreciado` e `Dt_Ultima_Depreciacao` após cálculo.

**Integração ERP**: Job envia lançamentos contábeis via API REST para sistema ERP com retry 3x se falha.

**Critério de Aceite**:
- Job executa automaticamente todo dia 1 do mês às 02:00 UTC
- Depreciação calculada corretamente conforme método escolhido
- Integração com ERP com retry automático

---

### RN-RF025-007: Alertas de Garantia Automáticos

**Descrição**: Job Hangfire executa DIARIAMENTE (às 08:00 UTC) verificando ativos com `Dt_Garantia_Fim` nos próximos 90, 60 ou 30 dias.

**Notificações**:
- **90 dias antes**: Email para gestor de TI com lista de ativos
- **60 dias antes**: Email + Push notification para responsável direto + gestor
- **30 dias antes**: Email + Push + In-App notification para todos stakeholders + alerta no dashboard

**Duplicação**: Sistema registra notificações enviadas em tabela `Ativo_Notificacoes_Enviadas` para evitar duplicatas.

**Critério de Aceite**:
- Job executa diariamente às 08:00 UTC
- Notificações enviadas apenas uma vez por período (30/60/90 dias)
- Alerta exibido no dashboard

---

### RN-RF025-008: Validação de Campos Obrigatórios por Tipo

**Descrição**: Campos obrigatórios variam por `Tipo_Ativo`.

**Ativos TI (Notebook, Desktop, Servidor)**:
- Obrigatórios: Tipo_Ativo, Categoria, Numero_Serie, Id_Marca, Id_Modelo, Valor_Aquisicao, Dt_Aquisicao
- Opcionais mas recomendados: Sistema_Operacional, Processador, Memoria_RAM_GB, MAC_Address, Hostname

**Ativos Telecom (Smartphone, Linha_Movel)**:
- Obrigatórios: Tipo_Ativo, Categoria, Numero_Linha, Operadora, Tipo_Plano
- Opcionais: IMEI (obrigatório se Smartphone), Numero_Serie

**Validação**: FluentValidation com regras condicionais baseadas em `Tipo_Ativo`. Retorna 400 Bad Request com lista de campos faltantes.

**Critério de Aceite**:
- Validação específica por tipo de ativo
- Erro 400 com mensagem detalhada sobre campos faltantes

---

### RN-RF025-009: Geolocalização Obrigatória para Inventário Mobile

**Descrição**: Ao usar app mobile para inventário (scan QR Code), sistema DEVE capturar latitude e longitude (GPS) obrigatoriamente.

**Precisão**: Aceitar apenas coordenadas com precisão ≤ 20 metros (accuracy ≤ 20m).

**Motivo**: Prevenir fraudes (ex: marcar inventário sem estar fisicamente no local) e rastrear localização real de ativos.

**Exceção**: Inventário via web (desktop) permite preencher localização manual (sem GPS) mas registra flag `InventarioRemoto=TRUE` para auditoria.

**Critério de Aceite**:
- GPS desabilitado ou sem sinal → app exibe erro e impede confirmar
- Precisão > 20m → app exige aguardar sinal melhor
- Inventário web marca flag InventarioRemoto=TRUE

---

### RN-RF025-010: Baixa de Ativo Requer Aprovação

**Descrição**: Baixa patrimonial (Status → "Baixado") DEVE passar por workflow de aprovação de 2 níveis.

**Níveis de Aprovação**:
1. **Nível 1**: Gestor imediato do responsável atual
2. **Nível 2**: Controller/Gerente Financeiro

**Justificativa Obrigatória**: Campo `Justificativa` com mínimo 50 caracteres explicando motivo.

**Anexos**: Upload obrigatório de documentos (BO para roubo, laudo técnico para dano irreparável, NF de venda para alienação).

**Critério de Aceite**:
- Baixa sem aprovação de 2 níveis → bloqueada
- Justificativa com < 50 caracteres → HTTP 400 Bad Request
- Anexos obrigatórios conforme motivo

---

### RN-RF025-011: IMEI Validation para Smartphones

**Descrição**: Se `Tipo_Ativo = 'Smartphone'`, campo `IMEI` DEVE ser validado.

**Validações**:
1. Formato: 15 dígitos numéricos
2. Checksum: Algoritmo de Luhn (último dígito verificador)
3. Não blacklist: Consulta API Anatel para verificar se IMEI não está bloqueado

**Bloqueio**: Se IMEI bloqueado, sistema exibe alerta mas permite cadastro (pode ser equipamento recuperado de roubo).

**Registro**: Salvar resultado da consulta Anatel em campo `IMEI_Status` (Ativo, Bloqueado, Irregular).

**Critério de Aceite**:
- IMEI inválido (formato ou Luhn) → HTTP 400 Bad Request
- Consulta Anatel executada automaticamente
- IMEI bloqueado exibe alerta mas permite cadastro

---

### RN-RF025-012: Isolamento Multi-Tenant Obrigatório

**Descrição**: TODAS as queries e operações DEVEM filtrar por `Id_Conglomerado` obtido do JWT token do usuário logado.

**Segurança**: Usuário de Conglomerado A NÃO pode ver/editar/deletar ativos de Conglomerado B mesmo se descobrir o ID.

**Performance**: Índice composto (Id_Conglomerado, Status_Ativo) otimiza queries mais comuns.

**Critério de Aceite**:
- Tentativa de acesso cruzado → HTTP 403 Forbidden
- Todas as queries filtradas automaticamente por Id_Conglomerado

---

### RN-RF025-013: Soft Delete Obrigatório

**Descrição**: Sistema NUNCA deve fazer DELETE físico de ativos. Exclusão lógica via flag `Fl_Ativo = FALSE`.

**Motivo**: Preservar histórico completo para auditorias e compliance (manter dados por 7 anos conforme legislação).

**Queries**: Todas as queries incluem `WHERE Fl_Ativo = 1` por padrão (EF Core Query Filter global).

**Restauração**: Administrador pode reativar ativo via endpoint `POST /api/ativos/{id}/reativar` com justificativa.

**Critério de Aceite**:
- Nenhum DELETE físico permitido
- Ativos excluídos não aparecem em listagens padrão
- Restauração possível apenas para administradores

---

### RN-RF025-014: Integração com Sistema de Patrimônio Externo

**Descrição**: Sistema DEVE sincronizar bidireccionalmente com ERP/sistema de patrimônio.

**Sincronização**:
1. **Webhook Outbound**: Enviar evento ao criar/atualizar/baixar ativo
2. **API REST Inbound**: Receber atualizações de valor contábil, depreciação acumulada, centro custo

**Formato**: JSON payload com schema versionado (v1, v2) para backward compatibility.

**Retry**: Polly policy com 3 tentativas (backoff exponencial 2s, 4s, 8s) se falha.

**Dead Letter Queue**: Eventos não sincronizados após 3 tentativas vão para DLQ (RabbitMQ) para reprocessamento manual.

**Critério de Aceite**:
- Webhooks enviados automaticamente
- Retry com backoff exponencial
- DLQ para eventos falhos

---

### RN-RF025-015: Inventário Periódico Obrigatório

**Descrição**: Sistema DEVE rastrear data do último inventário físico por ativo (campo `Dt_Ultimo_Inventario`).

**Alertas**:
- **Ativos >R$5.000**: Inventário obrigatório a cada 6 meses
- **Ativos >R$1.000**: Inventário obrigatório a cada 12 meses
- **Ativos <R$1.000**: Inventário obrigatório a cada 24 meses

**Dashboard**: Exibir contador de ativos "atrasados" para inventário (semáforo vermelho se >10%).

**Notificação**: Email semanal para gestores com lista de ativos pendentes de inventário.

**Critério de Aceite**:
- Dashboard exibe ativos atrasados
- Notificação semanal automática
- Filtro por valor para definir periodicidade

---

## 6. ESTADOS DA ENTIDADE

| Estado | Descrição |
|--------|-----------|
| **Disponivel** | Ativo disponível para alocação |
| **Alocado** | Ativo em uso por usuário específico |
| **Manutencao** | Ativo em manutenção preventiva ou corretiva |
| **Reservado** | Ativo reservado para alocação futura |
| **Perdido** | Ativo extraviado ou roubado |
| **Baixado** | Ativo removido do patrimônio (estado final) |

### Transições Permitidas

| De | Para |
|----|------|
| Disponivel | Alocado, Reservado, Manutencao, Baixado |
| Alocado | Disponivel, Manutencao, Perdido, Baixado |
| Manutencao | Disponivel, Baixado |
| Reservado | Disponivel, Alocado |
| Perdido | Disponivel, Baixado |
| Baixado | Nenhum (final) |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre |
|--------|---------------|
| **ativo.criado** | Após criação de ativo com QR Code gerado |
| **ativo.atualizado** | Após atualização de dados do ativo |
| **ativo.alocado** | Ativo atribuído a usuário responsável |
| **ativo.transferido** | Ativo movido entre localizações |
| **ativo.devolvido** | Ativo devolvido e liberado para reuso |
| **ativo.manutencao_iniciada** | Ativo enviado para manutenção |
| **ativo.manutencao_finalizada** | Ativo retorna da manutenção |
| **ativo.baixado** | Ativo removido do patrimônio |
| **ativo.perdido** | Ativo marcado como extraviado |
| **ativo.encontrado** | Ativo perdido localizado |
| **ativo.inventariado** | Inventário físico registrado |
| **ativo.depreciado** | Depreciação mensal calculada |
| **ativo.garantia_vencendo** | Garantia próxima do vencimento (30/60/90 dias) |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant (Id_Conglomerado)
- Nenhuma regra de negócio pode ser ignorada
- Erros devem ser previsíveis e rastreáveis com códigos HTTP padronizados
- Auditoria deve registrar quem, quando e o que mudou em TODAS as operações
- Soft delete obrigatório para preservação de histórico
- Transições de status devem ser validadas antes de salvar
- Campos obrigatórios devem variar por tipo de ativo
- Geolocalização GPS obrigatória para inventário mobile
- QR Code gerado automaticamente ao criar ativo
- Histórico de movimentações imutável (chain of custody)
- Depreciação calculada automaticamente via job mensal
- Alertas de garantia enviados automaticamente
- Integração bidirecional com ERP via webhooks e API REST
- Performance adequada para 10.000+ ativos sem degradação

---

## 9. SEGURANÇA

- Validação de entrada obrigatória (FluentValidation)
- Proteção contra injeção SQL (EF Core parameterizado)
- Controle de permissões granulares (RBAC)
- Isolamento multi-tenant rigoroso
- Rate limiting (100 req/min por usuário, 500 req/min por IP)
- CORS restrito a domínios autorizados
- Content-Security-Policy headers
- Input sanitization (prevenir XSS)
- JWT Bearer authentication
- Logs estruturados (Serilog JSON)
- Auditoria imutável de operações sensíveis
- 2FA para operações críticas (baixa de ativo, alteração de valor)

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF025.md** (Casos de Uso - 5 obrigatórios: UC00-UC04)
- **MD-RF025.md** (Modelo de Dados - 8 tabelas principais)
- **WF-RF025.md** (Wireframes e fluxos de tela)
- **TC-RF025-BACKEND.md** (Casos de Teste Backend)
- **TC-RF025-FRONTEND.md** (Casos de Teste Frontend)
- **TC-RF025-SEGURANCA.md** (Casos de Teste Segurança)
- **TC-RF025-E2E.md** (Casos de Teste E2E)
- **user-stories.yaml** (User Stories para Azure DevOps)

---

## 11. RASTREABILIDADE

| Artefato | Gerado | Status |
|----------|--------|--------|
| Casos de Uso (UC) | Obrigatório | Pendente |
| Modelo de Dados (MD) | Obrigatório | Pendente |
| Wireframes (WF) | Obrigatório | Pendente |
| Casos de Teste (TC) | Obrigatório | Pendente |
| User Stories | Obrigatório | Pendente |

### Dependências Upstream

- RF-USR-001: Gestão de Usuários (para campo Id_Usuario_Responsavel)
- RF-LOC-001: Gestão de Localizações (para hierarquia Filial → Andar → Sala)
- RF-MRC-001: Gestão de Marcas e Modelos (para normalização)

### Dependências Downstream

- RF-CTR-001: Gestão de Contratos (pode vincular ativos a contratos)
- RF-CHA-001: Gestão de Chamados (pode vincular manutenções a tickets)
- RF-REL-001: Relatórios Gerenciais (dashboards consolidados)

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0 - Separação RF/RL completa, 11 seções canônicas, 15 regras de negócio detalhadas, sem referências ao legado | Agência ALC - alc.dev.br |
| 1.0 | 2025-11-04 | Versão inicial com documentação legado misturada | Equipe IControlIT |
