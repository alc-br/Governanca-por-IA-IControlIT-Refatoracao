# RF-031: Gest√£o de Plano de Contas Cont√°bil Multi-Dimensional

**Vers√£o**: 2.0
**Data**: 2025-12-30
**Autor**: Ag√™ncia ALC - alc.dev.br
**EPIC**: EPIC006-FIN - Financeiro Base
**Fase**: Fase 3 - Financeiro I - Base Cont√°bil

---

## 1. OBJETIVO DO REQUISITO

Prover sistema completo de gest√£o de plano de contas cont√°bil multi-dimensional que permita classifica√ß√£o, rateio e an√°lise financeira de despesas de Telecom e TI, eliminando re-trabalho manual de classifica√ß√£o (de 120h/m√™s para 5h/m√™s), garantindo conformidade fiscal com rastreabilidade total para auditorias externas e fornecendo visibilidade multi-dimensional de custos para tomada de decis√£o estrat√©gica.

O sistema deve suportar estrutura hier√°rquica configur√°vel (at√© 7 n√≠veis), centros de custo integrados √† hierarquia organizacional, dimens√µes customiz√°veis ilimitadas, classifica√ß√£o autom√°tica via regras e Machine Learning, importa√ß√£o/exporta√ß√£o de m√∫ltiplos layouts de ERP, gera√ß√£o de lan√ßamentos cont√°beis v√°lidos em formato D-E (d√©bito-cr√©dito), relat√≥rios DRE multi-dimensionais com drill-down ilimitado e integra√ß√£o bidirecional com sistemas ERP.

**Impacto de Neg√≥cio Esperado:**
- Redu√ß√£o de 96% no tempo de classifica√ß√£o cont√°bil (economia R$67k/ano)
- Redu√ß√£o de erros de 18% para <2% (elimina R$95k/ano em re-trabalho + multas)
- Rastreabilidade 100% conforme Receita Federal, Sped, ECF
- Visibilidade gerencial para decis√µes data-driven
- ROI em 4 meses

---

## 2. ESCOPO

### 2.1 O que est√° dentro do escopo

- [x] Estrutura hier√°rquica de plano de contas configur√°vel (at√© 7 n√≠veis)
- [x] Builder visual drag-and-drop para gest√£o de hierarquia com preview de impacto
- [x] Gest√£o de centros de custo integrados √† hierarquia organizacional
- [x] Dimens√µes customiz√°veis ilimitadas (Projeto, Regi√£o, Produto, etc.)
- [x] Engine de regras de classifica√ß√£o autom√°tica (50+ templates + custom builder)
- [x] Importa√ß√£o multi-layout de ERPs (SAP, TOTVS, Protheus, Oracle, Sankhya)
- [x] Exporta√ß√£o de lan√ßamentos cont√°beis em formato D-E (partida dobrada)
- [x] Relat√≥rios gerenciais DRE multi-dimensionais com drill-down
- [x] M√≥dulo or√ßamento vs. realizado com alertas de varia√ß√£o
- [x] Auditoria completa com trilha de mudan√ßas versionada
- [x] Valida√ß√£o cont√°bil com 20+ regras fiscais
- [x] Reconcilia√ß√£o autom√°tica com fuzzy matching
- [x] Integra√ß√£o bidirecional com ERP financeiro
- [x] Isolamento multi-tenant com row-level security
- [x] Soft delete com hist√≥rico versionado

### 2.2 Fora do escopo (n√£o objetivos)

- Interface visual espec√≠fica (delegado ao frontend)
- Tecnologia de implementa√ß√£o espec√≠fica (Clean Architecture abstrai)
- Layout UX/UI (Fuse Template decide)
- Estrat√©gia de deploy (Azure Pipeline decide)
- Modelo espec√≠fico de Machine Learning (ML.NET abstrai)
- Formato espec√≠fico de arquivo importa√ß√£o (engine multi-layout suporta m√∫ltiplos)

---

## 3. CONCEITOS E DEFINI√á√ïES

| Termo | Defini√ß√£o |
|-------|-----------|
| **Plano de Contas** | Estrutura hier√°rquica de contas cont√°beis usadas para classificar lan√ßamentos financeiros conforme padr√µes cont√°beis (DRE, BP) |
| **Conta Sint√©tica** | Conta de agrupamento que possui contas filhas, n√£o recebe lan√ßamentos diretos |
| **Conta Anal√≠tica** | Conta folha da hierarquia que recebe lan√ßamentos cont√°beis diretos |
| **C√≥digo Cont√°bil** | Identificador √∫nico da conta, pode ser num√©rico hier√°rquico (5.1.2.01.001) ou alfanum√©rico customizado |
| **Centro de Custo** | Unidade organizacional para apropria√ß√£o de despesas, vinculada √† hierarquia (Empresa ‚Üí Filial ‚Üí Departamento) |
| **Dimens√£o** | Eixo de an√°lise customiz√°vel (Projeto, Regi√£o, Produto) para classifica√ß√£o multi-dimensional |
| **Rateio** | Distribui√ß√£o proporcional de despesa entre m√∫ltiplos centros de custo ou dimens√µes |
| **Classifica√ß√£o Autom√°tica** | Aplica√ß√£o de regras configur√°veis para atribuir conta cont√°bil a lan√ßamentos importados |
| **Lan√ßamento D-E** | Formato cont√°bil de d√©bito-cr√©dito respeitando partida dobrada (Œ£ d√©bitos = Œ£ cr√©ditos) |
| **DRE** | Demonstra√ß√£o do Resultado do Exerc√≠cio - relat√≥rio cont√°bil estruturado |
| **Partida Dobrada** | Princ√≠pio cont√°bil onde cada d√©bito tem cr√©dito correspondente de igual valor |
| **Reconcilia√ß√£o** | Processo de matching entre lan√ßamentos importados e contas do plano usando algoritmos |
| **Fuzzy Matching** | Algoritmo de similaridade textual (Levenshtein) para sugest√µes de classifica√ß√£o |
| **Soft Delete** | Exclus√£o l√≥gica via flag `FlExcluido` preservando dados para auditoria |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Gest√£o de Estrutura Hier√°rquica** - Criar/editar/mover/excluir contas em at√© 7 n√≠veis configur√°veis
2. **Builder Visual Drag-and-Drop** - Interface para reorganizar hierarquia com preview de impacto
3. **Gest√£o de Centros de Custo** - Vincular centros √† hierarquia organizacional com rateio cascata
4. **Gest√£o de Dimens√µes** - Criar dimens√µes customizadas ilimitadas com valores e aloca√ß√£o
5. **Regras de Classifica√ß√£o Autom√°tica** - Biblioteca 50+ templates + custom builder visual sem c√≥digo
6. **Importa√ß√£o Multi-Layout** - Engine configur√°vel para SAP, TOTVS, Protheus, Oracle, Sankhya
7. **Exporta√ß√£o Lan√ßamentos D-E** - Gera√ß√£o de arquivo cont√°bil com valida√ß√£o partida dobrada
8. **Relat√≥rios DRE Multi-Dimensionais** - Filtros avan√ßados, drill-down ilimitado, an√°lise vertical/horizontal
9. **Or√ßamento vs. Realizado** - Cadastro or√ßamento anual, compara√ß√£o visual, alertas varia√ß√£o
10. **Auditoria e Compliance** - Trilha completa de mudan√ßas com versionamento, reten√ß√£o 7 anos
11. **Valida√ß√£o Cont√°bil** - 20+ regras fiscais executadas pr√©-save
12. **Reconcilia√ß√£o Autom√°tica** - Fuzzy matching para sugest√£o de contas em importa√ß√µes
13. **Integra√ß√£o Bidirecional ERP** - Jobs Hangfire para sync estrutura e envio lan√ßamentos

---

## 5. REGRAS DE NEG√ìCIO

### RN-RF031-01 ‚Äî Estrutura Hier√°rquica Configur√°vel at√© 7 N√≠veis

**Descri√ß√£o**: Sistema DEVE suportar estrutura de plano de contas hier√°rquica com at√© 7 n√≠veis configur√°veis por Cliente. Cada Cliente define quantos n√≠veis utilizar (m√≠nimo 3, m√°ximo 7) e nomenclatura de cada n√≠vel.

**N√≠veis Padr√£o Sugeridos** (compat√≠vel com DRE/BP brasileiro):
1. Classe (ex: 1-Ativo, 5-Despesas)
2. Grupo (ex: 5.1-Despesas Administrativas)
3. Subgrupo (ex: 5.1.2-Despesas Gerais)
4. Conta (ex: 5.1.2.01-Despesas Telecom)
5. Subconta (ex: 5.1.2.01.001-Telefonia M√≥vel)
6. Item (ex: 5.1.2.01.001.01-Linhas Executivos)
7. Detalhe (ex: 5.1.2.01.001.01.001-Vivo Plano Controle)

**Valida√ß√µes Obrigat√≥rias**:
- C√≥digo cont√°bil √∫nico dentro do mesmo `ClienteId`
- Heran√ßa de propriedades: filhas herdam caracter√≠sticas do pai (ex: dedutibilidade IR)
- M√°ximo 7 n√≠veis de profundidade

**Crit√©rio de Aceite**:
- Cliente pode criar conta em qualquer n√≠vel de 1 a 7
- C√≥digo cont√°bil duplicado ‚Üí rejei√ß√£o com HTTP 400
- Tentar criar n√≠vel 8 ‚Üí rejei√ß√£o com HTTP 400

---

### RN-RF031-02 ‚Äî Builder Visual com Preview de Impacto

**Descri√ß√£o**: Interface DEVE permitir reorganiza√ß√£o de estrutura cont√°bil via drag-and-drop com preview em tempo real do impacto em lan√ßamentos e relat√≥rios existentes.

**Opera√ß√µes Suportadas**:
- **Criar**: Modal com valida√ß√£o c√≥digo √∫nico
- **Mover**: Drag-drop com valida√ß√£o circular dependency
- **Excluir**: Soft delete se sem lan√ßamentos, sen√£o apenas inativa
- **Renomear**: Edi√ß√£o inline com valida√ß√£o

**Preview Obrigat√≥rio Antes de Salvar**:
- Quantidade de lan√ßamentos afetados (√∫ltimos 12 meses)
- Relat√≥rios que usam essa conta
- Usu√°rios com regras de classifica√ß√£o impactadas

**Valida√ß√£o Circular**: Sistema detecta e impede loops na hierarquia.

**Crit√©rio de Aceite**:
- Mover conta ‚Üí exibir preview antes de confirmar
- Detectar loop circular ‚Üí rejei√ß√£o com HTTP 400
- Altera√ß√£o estrutura n√≠vel 1-3 ‚Üí exigir aprova√ß√£o Controller/CFO (se configurado)

---

### RN-RF031-03 ‚Äî Centros de Custo com Hierarquia Organizacional

**Descri√ß√£o**: Sistema DEVE integrar centros de custo com hierarquia organizacional (Cliente ‚Üí Conglomerado ‚Üí Empresa ‚Üí Filial ‚Üí Departamento ‚Üí Setor) permitindo rateio autom√°tico multi-n√≠vel.

**Rateio Cascata**: Despesa alocada em n√≠vel superior √© rateada automaticamente para n√≠veis inferiores segundo percentuais configurados.

**Exemplo**:
1. Despesa R$100k em Empresa
2. Rateia 50% SP, 30% RJ, 20% BH (Filiais)
3. Dentro de cada Filial: TI 40%, RH 30%, Comercial 30%
4. Dentro de cada Depto: rateio por Projetos ativos

**Valida√ß√µes**:
- Soma percentuais = 100% em cada n√≠vel
- Mudan√ßa percentual cria nova vers√£o com data vig√™ncia

**Crit√©rio de Aceite**:
- Configurar rateio cascata ‚Üí validar soma 100%
- Soma ‚â† 100% ‚Üí rejei√ß√£o com HTTP 400
- Hist√≥rico de mudan√ßas versionado preservado

---

### RN-RF031-04 ‚Äî Dimens√µes Customiz√°veis Ilimitadas

**Descri√ß√£o**: Al√©m de centros custo padr√£o, sistema DEVE suportar dimens√µes customiz√°veis ilimitadas (Projeto, Produto, Cliente, Regi√£o, Canal Venda) para an√°lises multi-dimensionais.

**Criar Dimens√£o**: Administrador define Nome, C√≥digo Prefixo, Tipo Aloca√ß√£o (Percentual/Absoluto/Unit√°rio), Obrigatoriedade.

**Aloca√ß√£o Multi-Dimens√£o**: Despesa pode ser alocada em m√∫ltiplas dimens√µes simultaneamente com valida√ß√£o cruzada.

**Crit√©rio de Aceite**:
- Criar dimens√£o customizada ‚Üí aceitar
- Dimens√£o obrigat√≥ria sem aloca√ß√£o ‚Üí rejei√ß√£o com HTTP 400
- Soma aloca√ß√£o percentual ‚â† 100% em dimens√£o obrigat√≥ria ‚Üí rejei√ß√£o

---

### RN-RF031-05 ‚Äî Regras de Classifica√ß√£o Autom√°tica

**Descri√ß√£o**: Sistema DEVE classificar automaticamente lan√ßamentos importados aplicando regras configur√°veis (biblioteca 50+ templates + custom builder visual sem c√≥digo).

**Templates Pr√©-Definidos**: Fornecedor = Vivo ‚Üí Telefonia M√≥vel, Fornecedor = AWS ‚Üí Cloud Computing, etc.

**Custom Rules Builder**: Interface visual tipo Zapier com operadores (=, ‚â†, >, <, Cont√©m, Regex).

**Prioridade e Simula√ß√£o**: Regras executadas em ordem com op√ß√£o "Simular em √∫ltimos 100 lan√ßamentos" antes de ativar.

**Crit√©rio de Aceite**:
- Criar regra customizada ‚Üí aplicar em lan√ßamentos novos
- Simular regra ‚Üí exibir quantos lan√ßamentos seriam afetados
- Meta: >95% taxa de match autom√°tico

---

### RN-RF031-06 ‚Äî Importa√ß√£o Multi-Layout de ERPs

**Descri√ß√£o**: Sistema DEVE importar plano de contas e lan√ßamentos de arquivos exportados de ERPs com templates configur√°veis (SAP, TOTVS, Protheus, Oracle, Sankhya, Conta Azul, Omie).

**Templates Pr√©-Configurados**: Cada ERP possui mapeamento de campos, encoding, separador, transforma√ß√µes.

**Valida√ß√£o Pr√©-Importa√ß√£o**:
- ‚úÖ Formato correto
- ‚úÖ Encoding detectado
- ‚úÖ Campos obrigat√≥rios presentes
- ‚úÖ C√≥digos n√£o duplicados
- ‚úÖ Hierarquia sem loops

**Preview**: Exibe 10 primeiras linhas parseadas antes de confirmar.

**Crit√©rio de Aceite**:
- Importar arquivo SAP v√°lido ‚Üí sucesso
- Formato inv√°lido ‚Üí rejei√ß√£o com HTTP 400
- C√≥digo duplicado ‚Üí rejei√ß√£o com HTTP 409

---

### RN-RF031-07 ‚Äî Exporta√ß√£o Lan√ßamentos D-E (D√©bito-Cr√©dito)

**Descri√ß√£o**: Sistema DEVE gerar arquivo texto de lan√ßamentos cont√°beis em formato D-E compat√≠vel com partida dobrada e import√°vel em qualquer ERP brasileiro.

**Valida√ß√£o Partida Dobrada**: Œ£ d√©bitos = Œ£ cr√©ditos (toler√¢ncia R$0,01 arredondamento).

**Preview Obrigat√≥rio**: UI exibe grid com d√©bitos/cr√©ditos coloridos + totalizador antes de exportar.

**Formatos Suportados**: TXT delimitado, CSV, XML, JSON.

**Crit√©rio de Aceite**:
- Exportar lan√ßamentos ‚Üí validar partida dobrada
- D√©bitos ‚â† cr√©ditos ‚Üí rejei√ß√£o com HTTP 400
- Conta inv√°lida ‚Üí rejei√ß√£o com HTTP 422

---

### RN-RF031-08 ‚Äî Relat√≥rios DRE Multi-Dimensionais

**Descri√ß√£o**: Sistema DEVE gerar DRE (Demonstra√ß√£o Resultado Exerc√≠cio) com filtros multi-dimensionais e drill-down ilimitado.

**Filtros Dispon√≠veis**: Per√≠odo, Centro Custo, Projeto, Departamento, Regi√£o, Compara√ß√£o (MoM, YoY, Or√ßado x Realizado).

**Estrutura DRE Padr√£o**: Receita Bruta ‚Üí Receita L√≠quida ‚Üí Lucro Bruto ‚Üí EBITDA ‚Üí EBIT ‚Üí LAIR ‚Üí Lucro L√≠quido.

**Drill-Down**: Clicar em linha ‚Üí detalha contas filhas at√© n√≠vel anal√≠tico ‚Üí lista lan√ßamentos individuais.

**An√°lises**: Vertical (% sobre Receita L√≠quida), Horizontal (compara√ß√£o per√≠odos).

**Crit√©rio de Aceite**:
- Gerar DRE filtrado por Projeto ‚Üí exibir apenas dados daquele projeto
- Drill-down em conta ‚Üí listar lan√ßamentos individuais
- Sem dados ‚Üí exibir mensagem informativa

---

### RN-RF031-09 ‚Äî Or√ßamento vs. Realizado com Alertas

**Descri√ß√£o**: Sistema DEVE permitir cadastrar or√ßamento anual por conta cont√°bil com rateio mensal autom√°tico e compara√ß√£o visual real x or√ßado em tempo real.

**Cadastro Or√ßamento**: Informar valor anual OU valores mensais, com aprova√ß√£o workflow CFO/Controller.

**Alertas Autom√°ticos**:
- 80% or√ßado com >5 dias √∫teis restantes ‚Üí Email amarelo
- 100% or√ßado ‚Üí Email vermelho + push
- >110% or√ßado ‚Üí Escala para Controller/CFO

**Forecast**: Machine Learning prev√™ fechamento m√™s baseado em tend√™ncia.

**Crit√©rio de Aceite**:
- Conta atingir 100% or√ßado ‚Üí disparar alerta
- Or√ßamento sem valor para conta obrigat√≥ria ‚Üí rejei√ß√£o com HTTP 400
- Usu√°rio sem permiss√£o aprovar ‚Üí rejei√ß√£o com HTTP 403

---

### RN-RF031-10 ‚Äî Auditoria Completa com Trilha de Mudan√ßas

**Descri√ß√£o**: Sistema DEVE manter hist√≥rico completo de todas altera√ß√µes estrutura cont√°bil, lan√ßamentos e configura√ß√µes com campos obrigat√≥rios (antes/depois, justificativa, aprovador).

**Eventos Auditados**: Cria√ß√£o/Edi√ß√£o/Exclus√£o conta, mudan√ßa hierarquia, altera√ß√£o centro custo, altera√ß√£o regras, importa√ß√£o/exporta√ß√£o, altera√ß√£o or√ßamento, aprova√ß√£o workflows.

**Campos Trilha**: EventoId, Tipo, Usuario, DataHora, IP, ValorAnterior, ValorNovo, Justificativa, AprovadorId, Status.

**Reten√ß√£o**: 7 anos conforme LGPD/exig√™ncia fiscal com compress√£o ap√≥s 1 ano.

**Imutabilidade**: Registros auditoria s√£o append-only (nunca deletados ou editados).

**Crit√©rio de Aceite**:
- Toda altera√ß√£o estrutural ‚Üí gerar registro auditoria
- Consultar auditoria filtrada por per√≠odo/usu√°rio ‚Üí listar eventos
- Dados retidos por 7 anos

---

### RN-RF031-11 ‚Äî Valida√ß√£o Cont√°bil com 20+ Regras Fiscais

**Descri√ß√£o**: Sistema DEVE executar valida√ß√µes cont√°beis autom√°ticas antes de salvar qualquer lan√ßamento, impedindo erros que causariam rejei√ß√£o em auditorias fiscais.

**Regras Valida√ß√£o Principais**:
1. Lan√ßamento s√≥ em conta Anal√≠tica (nunca Sint√©tica)
2. Partida dobrada (Œ£ d√©bitos = Œ£ cr√©ditos, toler√¢ncia R$0,01)
3. Data lan√ßamento em per√≠odo fiscal aberto
4. C√≥digo cont√°bil existe e ativo
5. Centro custo obrigat√≥rio (se configurado)
6. Valor positivo
7. Hist√≥rico m√≠nimo 10 caracteres
8. Documento √∫nico por per√≠odo/fornecedor
9. Hierarquia v√°lida
10. Dimens√£o obrigat√≥ria preenchida
... (10+ regras adicionais)

**Severidade**: Bloqueante (impede save), Advert√™ncia (exige confirma√ß√£o), Informativa (apenas alerta).

**Crit√©rio de Aceite**:
- Tentar salvar lan√ßamento em conta Sint√©tica ‚Üí rejei√ß√£o com HTTP 400
- Valida√ß√£o falhar ‚Üí retornar lista detalhada de erros

---

### RN-RF031-12 ‚Äî Reconcilia√ß√£o Autom√°tica com Fuzzy Matching

**Descri√ß√£o**: Ao importar lan√ßamentos de arquivo externo, sistema DEVE tentar reconciliar automaticamente com contas cont√°beis usando algoritmo fuzzy matching.

**Algoritmo Matching**:
1. Match Exato: C√≥digo importado = c√≥digo sistema ‚Üí 100% match
2. Fuzzy Nome: Levenshtein distance ‚â•85% ‚Üí sugest√£o
3. Hist√≥rico: Lan√ßamentos passados mesmo fornecedor ‚Üí sugest√£o
4. Machine Learning: Modelo treinado sugere com score confian√ßa

**Status Reconcilia√ß√£o**: Conciliado (100%), Sugest√£o (85-99%), N√£o Conciliado (<85%).

**Aprendizado**: Confirma√ß√£o/corre√ß√£o usu√°rio melhora pr√≥ximas importa√ß√µes.

**Crit√©rio de Aceite**:
- Importar lan√ßamento com match exato ‚Üí conciliar automaticamente
- Match 90% ‚Üí sugerir para confirma√ß√£o usu√°rio
- Meta: >90% taxa reconcilia√ß√£o autom√°tica

---

### RN-RF031-13 ‚Äî Integra√ß√£o Bidirecional com ERP Financeiro

**Descri√ß√£o**: Sistema DEVE integrar bidirecionalmente com ERPs financeiros (SAP, TOTVS, Oracle) via API REST ou arquivos batch.

**Fluxos**:
1. **ERP ‚Üí IControlIT**: Hangfire job di√°rio 03:00 UTC importa estrutura plano contas atualizada
2. **IControlIT ‚Üí ERP**: Usu√°rio aprova lan√ßamentos, sistema gera arquivo D-E, valida, envia via API/SFTP, recebe callback confirma√ß√£o

**Autentica√ß√£o**: OAuth 2.0 com refresh token autom√°tico + Azure Key Vault.

**Retry Policy**: Polly backoff exponencial (3 tentativas: 2s, 4s, 8s).

**Crit√©rio de Aceite**:
- Job di√°rio executar com sucesso ‚Üí atualizar estrutura local
- Falha 3x consecutivas ‚Üí enviar email equipe TI + desativar job

---

### RN-RF031-14 ‚Äî Isolamento Multi-Tenant com Row-Level Security

**Descri√ß√£o**: TODAS as queries e opera√ß√µes DEVEM filtrar por `ClienteId` obtido do JWT token do usu√°rio logado (multi-tenancy seguro).

**Seguran√ßa**: Usu√°rio Cliente A n√£o pode ver/editar contas de Cliente B mesmo se descobrir ID.

**Performance**: √çndice composto `(ClienteId, Codigo_Contabil)`.

**Valida√ß√£o**: EF Core Query Filter global adiciona `WHERE ClienteId = {userClientId}` automaticamente.

**Crit√©rio de Aceite**:
- Usu√°rio Cliente A tentar acessar conta Cliente B ‚Üí retornar 404 Not Found
- Todas queries inclu√≠rem filtro `ClienteId`

---

### RN-RF031-15 ‚Äî Soft Delete com Hist√≥rico Versionado

**Descri√ß√£o**: Sistema NUNCA deve fazer DELETE f√≠sico de contas cont√°beis ou lan√ßamentos. Exclus√£o l√≥gica via `FlExcluido = TRUE` com versionamento completo.

**Motivo**: Preservar hist√≥rico para auditorias fiscais (obrigat√≥rio 7 anos Receita Federal).

**Queries**: Todas queries incluem `WHERE FlExcluido = 0` por padr√£o (EF Core Query Filter).

**Restaura√ß√£o**: Administrador pode restaurar conta exclu√≠da com justificativa + aprova√ß√£o.

**Versionamento**: Edi√ß√£o cria snapshot JSON antes/depois na tabela `Plano_Conta_Versao`.

**Crit√©rio de Aceite**:
- Excluir conta ‚Üí marcar `FlExcluido = TRUE` preservando dados
- Listar contas ‚Üí n√£o exibir exclu√≠das
- Administrador restaurar conta ‚Üí voltar `FlExcluido = FALSE`

---

## 6. ESTADOS DA ENTIDADE

### PlanoContaContabil

| Estado | Descri√ß√£o |
|--------|-----------|
| **Ativo** | Conta criada e dispon√≠vel para uso |
| **Inativo** | Conta temporariamente desabilitada, n√£o aceita novos lan√ßamentos |
| **Exclu√≠do** | Soft delete (`FlExcluido = TRUE`), n√£o exibido em listagens |

### Transi√ß√µes Permitidas

| De | Para | Condi√ß√£o |
|----|------|----------|
| Ativo | Inativo | Usu√°rio com permiss√£o `Edit` |
| Inativo | Ativo | Usu√°rio com permiss√£o `Edit` |
| Ativo | Exclu√≠do | Usu√°rio com permiss√£o `Delete`, conta sem lan√ßamentos ou apenas inativar |
| Inativo | Exclu√≠do | Usu√°rio com permiss√£o `Delete` |
| Exclu√≠do | Ativo | Administrador com permiss√£o `RestoreDeleted` + justificativa |

---

## 7. EVENTOS DE DOM√çNIO

| Evento | Quando Ocorre | Payload |
|--------|---------------|---------|
| `PlanoContaCriada` | Ap√≥s cria√ß√£o de nova conta | `{ ContaId, Codigo, Nome, ClienteId }` |
| `PlanoContaAtualizada` | Ap√≥s edi√ß√£o de conta | `{ ContaId, CamposAlterados, UsuarioId }` |
| `PlanoContaMovida` | Ap√≥s drag-drop na hierarquia | `{ ContaId, PaiAnteriorId, PaiNovoId }` |
| `PlanoContaExcluida` | Ap√≥s soft delete | `{ ContaId, UsuarioId, Motivo }` |
| `PlanoContaRestaurada` | Ap√≥s restaura√ß√£o de exclu√≠da | `{ ContaId, AprovadorId }` |
| `ClassificacaoAutomaticaExecutada` | Ap√≥s aplicar regras em lote | `{ QtdLancamentos, TaxaMatch }` |
| `OrcamentoAprovado` | Ap√≥s aprova√ß√£o de or√ßamento | `{ Ano, AprovadorId }` |
| `AlertaVariacaoOrcamento` | Quando conta atinge limite | `{ ContaId, Percentual, Valor }` |

---

## 8. CRIT√âRIOS GLOBAIS DE ACEITE

- ‚úÖ Nenhuma opera√ß√£o pode violar isolamento de tenant (`ClienteId`)
- ‚úÖ Nenhuma regra de neg√≥cio pode ser ignorada
- ‚úÖ Erros devem ser previs√≠veis, estruturados e rastre√°veis
- ‚úÖ Auditoria deve registrar quem, quando e o que mudou (reten√ß√£o 7 anos)
- ‚úÖ Soft delete obrigat√≥rio (nunca DELETE f√≠sico)
- ‚úÖ Valida√ß√µes cont√°beis executadas antes de save
- ‚úÖ Partida dobrada sempre validada (Œ£ d√©bitos = Œ£ cr√©ditos)
- ‚úÖ Importa√ß√£o/Exporta√ß√£o suportar m√∫ltiplos layouts de ERP
- ‚úÖ Relat√≥rios DRE suportar drill-down ilimitado
- ‚úÖ Classifica√ß√£o autom√°tica atingir >95% taxa de match
- ‚úÖ Reconcilia√ß√£o fuzzy matching atingir >90% sucesso

---

## 9. SEGURAN√áA

### 9.1 Valida√ß√£o de Entrada

- ‚úÖ Todos inputs validados antes de processar
- ‚úÖ Prote√ß√£o contra SQL Injection (EF Core parametrizado)
- ‚úÖ Prote√ß√£o contra XSS (sanitiza√ß√£o frontend)
- ‚úÖ Valida√ß√£o tamanho m√°ximo campos (evitar DoS)

### 9.2 Controle de Permiss√µes

- ‚úÖ Toda opera√ß√£o exige permiss√£o RBAC expl√≠cita
- ‚úÖ Altera√ß√µes estrutura n√≠vel 1-3 exigem aprova√ß√£o Controller/CFO (configur√°vel)
- ‚úÖ Opera√ß√µes administrativas (restaurar, aprovar) restritas a perfis espec√≠ficos

### 9.3 Isolamento Multi-Tenant

- ‚úÖ Row-level security via `ClienteId`
- ‚úÖ Query Filter global EF Core
- ‚úÖ √çndice composto otimizado

### 9.4 Auditoria e Compliance

- ‚úÖ Trilha completa de mudan√ßas
- ‚úÖ Reten√ß√£o 7 anos (LGPD, Receita Federal)
- ‚úÖ Imutabilidade registros auditoria

---

## 10. ARTEFATOS DERIVADOS

Este RF √© base para:

- ‚úÖ **UC-RF031.md** - Casos de Uso (UC00-UC04 padr√£o + UC05-UC09 espec√≠ficos)
- ‚úÖ **MD-RF031.md** - Modelo de Dados com DDL completo
- ‚úÖ **WF-RF031.md** - Wireframes e fluxos de tela
- ‚úÖ **TC-RF031-BACKEND.yaml** - Casos de Teste Backend
- ‚úÖ **TC-RF031-FRONTEND.yaml** - Casos de Teste Frontend
- ‚úÖ **TC-RF031-SEGURANCA.yaml** - Casos de Teste Seguran√ßa
- ‚úÖ **TC-RF031-E2E.yaml** - Casos de Teste E2E
- ‚úÖ **MT-RF031.yaml** - Massas de Teste

---

## 11. RASTREABILIDADE

### 11.1 Depend√™ncias de Outros RFs

**Obrigat√≥rias**:
- ‚úÖ **RF-030** - Cliente Multi-Tenant ‚Üí Fornece `ClienteId`
- ‚úÖ **RF-024** - Gest√£o Departamentos ‚Üí Hierarquia organizacional para centros custo
- ‚úÖ **RF-026** - Gest√£o Faturas ‚Üí Fonte de lan√ßamentos para classificar

**Opcionais**:
- üî∏ **RF-022** - Gest√£o Fornecedores ‚Üí Regras classifica√ß√£o por fornecedor
- üî∏ **RF-023** - Gest√£o Contratos ‚Üí Vincula despesas a projetos/contratos

### 11.2 RFs que Dependem Deste

- üìä **RF-040** - Relat√≥rios Gerenciais ‚Üí Usa estrutura plano contas para DRE
- üìä **RF-041** - Dashboards Executivos ‚Üí Consome dados classificados
- üìä **RF-042** - Business Intelligence ‚Üí An√°lises multi-dimensionais

### 11.3 Integra√ß√µes Obrigat√≥rias

- ‚úÖ **Central de Funcionalidades** - Permiss√µes RBAC completas
- ‚úÖ **i18n (Transloco)** - Chaves tradu√ß√£o pt-BR, en-US, es-ES
- ‚úÖ **Auditoria** - Todas opera√ß√µes CREATE/UPDATE/DELETE/MOVE auditadas
- ‚úÖ **Multi-Tenancy** - Isolamento por `ClienteId` em todas queries

---

## 12. PERMISS√ïES RBAC

```csharp
public static class PlanoContasPermissions
{
    // Visualiza√ß√£o
    public const string View = "GES.PLANO_CONTAS.VIEW";
    public const string ViewDetails = "GES.PLANO_CONTAS.VIEW_DETAILS";

    // Gest√£o Contas
    public const string Create = "GES.PLANO_CONTAS.CREATE";
    public const string Edit = "GES.PLANO_CONTAS.EDIT";
    public const string Delete = "GES.PLANO_CONTAS.DELETE";
    public const string Move = "GES.PLANO_CONTAS.MOVE";

    // Centros Custo
    public const string ManageCentroCusto = "GES.PLANO_CONTAS.MANAGE_CENTRO_CUSTO";
    public const string EditRateio = "GES.PLANO_CONTAS.EDIT_RATEIO";

    // Dimens√µes
    public const string ManageDimensoes = "GES.PLANO_CONTAS.MANAGE_DIMENSOES";

    // Regras
    public const string ViewRegras = "GES.PLANO_CONTAS.VIEW_REGRAS";
    public const string ManageRegras = "GES.PLANO_CONTAS.MANAGE_REGRAS";
    public const string ExecuteClassificacao = "GES.PLANO_CONTAS.EXECUTE_CLASSIFICACAO";

    // Import/Export
    public const string Import = "GES.PLANO_CONTAS.IMPORT";
    public const string Export = "GES.PLANO_CONTAS.EXPORT";
    public const string ImportERP = "GES.PLANO_CONTAS.IMPORT_ERP";
    public const string ExportLancamentos = "GES.PLANO_CONTAS.EXPORT_LANCAMENTOS";

    // Relat√≥rios
    public const string ViewDRE = "GES.PLANO_CONTAS.VIEW_DRE";
    public const string ViewOrcamento = "GES.PLANO_CONTAS.VIEW_ORCAMENTO";
    public const string ManageOrcamento = "GES.PLANO_CONTAS.MANAGE_ORCAMENTO";
    public const string ApproveOrcamento = "GES.PLANO_CONTAS.APPROVE_ORCAMENTO";

    // Auditoria
    public const string ViewAudit = "GES.PLANO_CONTAS.VIEW_AUDIT";
    public const string RestoreDeleted = "GES.PLANO_CONTAS.RESTORE_DELETED";

    // Administra√ß√£o
    public const string ManageTemplates = "GES.PLANO_CONTAS.MANAGE_TEMPLATES";
    public const string ApproveStructureChange = "GES.PLANO_CONTAS.APPROVE_STRUCTURE_CHANGE";
}
```

### Matriz Permiss√£o ‚Üí Perfil

| Permiss√£o | Controller/CFO | Gerente Financeiro | Analista Cont√°bil | Consulta |
|-----------|----------------|---------------------|-------------------|----------|
| View | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| Create/Edit/Delete | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| Move (estrutura) | ‚úÖ | ‚ö†Ô∏è (aprova√ß√£o) | ‚ùå | ‚ùå |
| ManageRegras | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| Import/Export | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| ManageOrcamento | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| ApproveOrcamento | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| ApproveStructureChange | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| ViewAudit | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |

---

## CHANGELOG

| Vers√£o | Data | Descri√ß√£o | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-30 | Migra√ß√£o v1.0‚Üív2.0: separa√ß√£o RF/RL, remo√ß√£o legado, 11 se√ß√µes can√¥nicas | Ag√™ncia ALC - alc.dev.br |
| 1.0 | 2024-12-17 | Vers√£o inicial com legado mesclado (5 se√ß√µes) | Equipe IControlIT |
