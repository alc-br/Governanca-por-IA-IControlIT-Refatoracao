# RF-031: Gest√£o de Plano de Contas Cont√°bil Multi-Dimensional

**Vers√£o**: 1.0
**√öltima Atualiza√ß√£o**: 17/12/2025
**Status**: ‚úÖ Documenta√ß√£o Completa (5 se√ß√µes)
**Fase**: Fase 2 - Servi√ßos Essenciais
**EPIC**: GES - Gest√£o
**Prioridade**: ALTA
**Complexidade**: ALTA

[‚Üê Voltar](../README.md)

---

## üìã 1. RESUMO EXECUTIVO

### Descri√ß√£o Geral

Sistema completo de gest√£o de plano de contas cont√°bil multi-dimensional para classifica√ß√£o, rateio e an√°lise financeira de despesas de Telecom e TI com suporte a estrutura hier√°rquica de contas (at√© 7 n√≠veis), centros de custo, projetos, departamentos e dimens√µes customiz√°veis. Permite cria√ß√£o visual de plano de contas compat√≠vel com padr√µes cont√°beis brasileiros (DRE, Balan√ßo Patrimonial), importa√ß√£o de layouts de ERP (SAP, TOTVS, Protheus, Oracle), reconcilia√ß√£o autom√°tica de lan√ßamentos, relat√≥rios gerenciais multi-dimensionais e integra√ß√£o bidirecional com sistemas ERP para gera√ß√£o autom√°tica de lan√ßamentos cont√°beis v√°lidos para fechamento fiscal.

**Objetivo Principal**: Eliminar re-trabalho manual de classifica√ß√£o cont√°bil de 120+ horas/m√™s para 5 horas/m√™s atrav√©s de regras automatizadas, garantir conformidade fiscal com rastreabilidade total para auditorias externas (Big Four), fornecer visibilidade multi-dimensional de custos para tomada de decis√£o estrat√©gica (DRE gerencial por projeto, departamento, regi√£o), automatizar gera√ß√£o de lan√ßamentos cont√°beis em formato D-E (d√©bito-cr√©dito) compat√≠vel com qualquer ERP, reduzir erros de classifica√ß√£o de 18% para <2% atrav√©s de valida√ß√µes inteligentes e permitir an√°lises comparativas sofisticadas (real x or√ßado, MoM, YoY, drill-down ilimitado).

### Contexto: Legado vs. Moderniza√ß√£o

| Aspecto | Legado (VB.NET) | Moderniza√ß√£o (.NET 10) |
|---------|----------------|----------------------|
| **Estrutura** | 3 n√≠veis fixos (Conta, Subconta, Item) | 7 n√≠veis configur√°veis + dimens√µes ilimitadas |
| **Hierarquia** | Tree est√°tico em VB6 TreeView | Hierarchical dropdown moderno + drag-drop visual |
| **Classifica√ß√£o** | 100% manual (120h/m√™s, 18% erro) | Regras automatizadas (5h/m√™s, <2% erro) |
| **Centros Custo** | Tabela separada sem v√≠nculo | Dimens√£o integrada com rateio autom√°tico |
| **Projetos** | N√£o suportado | Dimens√£o nativa com aloca√ß√£o % |
| **Importa√ß√£o ERP** | CSV fixo apenas TOTVS | Multi-layout: SAP, TOTVS, Protheus, Oracle, Sankhya |
| **Exporta√ß√£o** | Excel est√°tico sem formata√ß√£o | Arquivo cont√°bil validado + preview lan√ßamentos |
| **Relat√≥rios** | DRE est√°tico mensal | DRE gerencial drill-down tempo real + 5 dimens√µes |
| **Valida√ß√£o** | Nenhuma (descobre erro no fechamento) | 20+ regras cont√°beis executadas pr√©-save |
| **Reconcilia√ß√£o** | Planilha Excel VLOOKUP | Engine fuzzy matching autom√°tico |
| **Auditoria** | Log b√°sico (quem, quando) | Trilha completa (antes/depois, justificativa, aprovador) |
| **Or√ßamento** | Planilha paralela | Integrado: or√ßado x realizado tempo real |

### 10 Funcionalidades Principais

1. **Plano de Contas Hier√°rquico**: Estrutura at√© 7 n√≠veis (Classe ‚Üí Grupo ‚Üí Subgrupo ‚Üí Conta ‚Üí Subconta ‚Üí Item ‚Üí Detalhe) com c√≥digos cont√°beis padr√£o DRE/BP brasileiro + suporte a IFRS internacional
2. **Builder Visual de Hierarquia**: Interface drag-and-drop para criar/reorganizar estrutura cont√°bil com preview impacto em lan√ßamentos existentes e valida√ß√£o circular dependency
3. **Centros de Custo Integrados**: Gest√£o completa de centros custo vinculados a hierarquia organizacional (Empresa ‚Üí Filial ‚Üí Departamento ‚Üí Setor) com rateio autom√°tico multi-n√≠vel
4. **Dimens√µes Customiz√°veis**: Criar dimens√µes ilimitadas (Projeto, Produto, Cliente, Regi√£o, Canal Venda) com aloca√ß√£o percentual ou valor absoluto
5. **Regras de Classifica√ß√£o Autom√°tica**: Motor de regras com 50+ templates (ex: "Se Fornecedor = Vivo E Tipo = Telefonia ‚Üí Conta 3.1.1.01 Despesas Telecom M√≥vel") + builder visual sem c√≥digo
6. **Importa√ß√£o Multi-Layout ERP**: Engine com templates SAP FI/CO, TOTVS Protheus 12, Oracle Financials, Sankhya + criador visual de layouts customizados
7. **Exporta√ß√£o Lan√ßamentos Cont√°beis**: Gera√ß√£o de arquivo texto formatado D-E (D√©bito-Cr√©dito) com valida√ß√£o partida dobrada + preview antes de enviar ao ERP
8. **Relat√≥rios Gerenciais Avan√ßados**: DRE multi-dimensional (filtro por projeto + departamento + per√≠odo), Balan√ßo Patrimonial consolidado, An√°lise Vertical/Horizontal, Gr√°ficos Waterfall
9. **Or√ßamento vs. Realizado**: M√≥dulo integrado de or√ßamento anual com rateio mensal, compara√ß√£o visual real x or√ßado, alertas varia√ß√£o >10%, forecast 3 meses
10. **Auditoria e Compliance**: Trilha completa de mudan√ßas (hist√≥rico versionado), aprova√ß√£o workflow para altera√ß√µes estrutura cont√°bil, relat√≥rios rastreabilidade fiscal

### Impacto de Neg√≥cio

- **Efici√™ncia Operacional:** Redu√ß√£o 96% tempo classifica√ß√£o cont√°bil (120h/m√™s ‚Üí 5h/m√™s) = R$67k/ano economia RH
- **Redu√ß√£o Erros:** De 18% erro classifica√ß√£o manual para <2% autom√°tico = elimina R$95k/ano re-trabalho + multas
- **Compliance Fiscal:** Rastreabilidade 100% conforme exig√™ncias Receita Federal, Sped, ECF = zero n√£o-conformidades em auditorias
- **Visibilidade Gerencial:** DRE multi-dimensional permite decis√µes data-driven (ex: cortar 15% gasto Telecom realocando para Cloud)
- **Integra√ß√£o ERP:** Elimina dupla digita√ß√£o manual, reduz prazo fechamento cont√°bil de 12 dias √∫teis para 3 dias
- **ROI:** Sistema paga-se em 4 meses apenas com economia RH + redu√ß√£o erros

---

## üìê 2. REGRAS DE NEG√ìCIO

### RN-RF031-01: Estrutura Hier√°rquica At√© 7 N√≠veis Configur√°veis

**Descri√ß√£o**: Sistema DEVE suportar estrutura de plano de contas hier√°rquica com at√© 7 n√≠veis configur√°veis por Cliente (multi-tenant). Cada Cliente define quantos n√≠veis utilizar (m√≠nimo 3, m√°ximo 7) e nomenclatura de cada n√≠vel.

**N√≠veis Padr√£o Brasileiro (DRE/BP)**:
1. **Classe** - Ex: 1-Ativo, 2-Passivo, 3-Receitas, 4-Custos, 5-Despesas
2. **Grupo** - Ex: 3.1-Receitas Operacionais, 5.1-Despesas Administrativas
3. **Subgrupo** - Ex: 5.1.1-Despesas com Pessoal, 5.1.2-Despesas Gerais
4. **Conta** - Ex: 5.1.2.01-Despesas Telecom e Comunica√ß√£o
5. **Subconta** - Ex: 5.1.2.01.001-Telefonia M√≥vel Corporativa
6. **Item** - Ex: 5.1.2.01.001.01-Linhas Executivos
7. **Detalhe** - Ex: 5.1.2.01.001.01.001-Vivo Empresas Plano Controle

**C√≥digo Cont√°bil**: Sistema gera c√≥digo autom√°tico concatenado (ex: 5.1.2.01.001.01.001) OU permite c√≥digo customizado (ex: VoIP_Corp_2024).

**Valida√ß√£o Unicidade**: C√≥digo cont√°bil DEVE ser √∫nico dentro do mesmo ClienteId.

**Heran√ßa Propriedades**: Contas filhas herdam propriedades do pai (ex: se n√≠vel 2 √© "Despesa Dedut√≠vel IR" ‚Üí todos filhos tamb√©m s√£o).

**Erro**: 400 Bad Request se tentar criar mais de 7 n√≠veis ou c√≥digo cont√°bil duplicado.

### RN-RF031-02: Builder Visual Drag-and-Drop com Preview Impacto

**Descri√ß√£o**: Interface DEVE permitir criar/editar/reorganizar estrutura cont√°bil via drag-and-drop com preview em tempo real do impacto em lan√ßamentos e relat√≥rios existentes.

**Opera√ß√µes Suportadas**:
- **Criar Conta**: Clica em n√≥ pai ‚Üí modal "Nova Conta" ‚Üí preenche Nome, C√≥digo, Tipo (Sint√©tica/Anal√≠tica) ‚Üí salvar
- **Mover Conta**: Arrasta conta para novo pai ‚Üí sistema valida se movimento √© v√°lido (ex: n√£o pode criar loop circular)
- **Excluir Conta**: Marca conta como exclu√≠da (soft delete) se n√£o houver lan√ßamentos vinculados, sen√£o apenas inativa
- **Renomear**: Duplo clique ‚Üí edita inline com valida√ß√£o c√≥digo √∫nico

**Preview Impacto**: Antes de salvar altera√ß√£o estrutural, sistema exibe:
- Quantidade lan√ßamentos afetados (√∫ltimos 12 meses)
- Relat√≥rios que usam essa conta (DRE, BP, Gerenciais customizados)
- Usu√°rios que precisar√£o atualizar regras de classifica√ß√£o

**Valida√ß√£o Circular**: Detecta e impede loops (ex: Conta A filha de B, B filha de C, C filha de A).

**Aprova√ß√£o Workflow**: Altera√ß√µes estrutura n√≠vel 1-3 exigem aprova√ß√£o Controller/CFO (configur√°vel).

**Erro**: 403 Forbidden se usu√°rio sem permiss√£o tentar alterar estrutura | 400 Bad Request se movimento criar depend√™ncia circular.

### RN-RF031-03: Centros de Custo com Hierarquia Organizacional

**Descri√ß√£o**: Sistema DEVE integrar centros de custo com hierarquia organizacional (Cliente ‚Üí Conglomerado ‚Üí Empresa ‚Üí Filial ‚Üí Departamento ‚Üí Setor ‚Üí Se√ß√£o) permitindo rateio autom√°tico multi-n√≠vel.

**V√≠nculo Hier√°rquico**: Cada centro custo vinculado a n√≠vel organizacional (ex: Centro Custo "TI-S√£o Paulo" vinculado a Filial "SP-Matriz").

**C√≥digos Sugeridos**: Sistema sugere c√≥digo padr√£o (ex: `CC-{EmpresaId}-{DeptId}`) mas permite customiza√ß√£o.

**Rateio Cascata**: Suporta rateio em cascata:
1. Despesa total R$100k alocada em Empresa (n√≠vel 2)
2. Sistema rateia automaticamente para Filiais proporcionalmente (50% SP, 30% RJ, 20% BH)
3. Dentro de cada Filial, rateia para Departamentos (TI 40%, RH 30%, Comercial 30%)
4. Dentro de cada Depto, rateia para Projetos ativos

**Percentuais Configur√°veis**: Usu√°rio define regras de rateio (% fixo, proporcional ao consumo, igualit√°rio, customizado).

**Valida√ß√£o**: Soma percentuais DEVE = 100% em cada n√≠vel antes de salvar.

**Hist√≥rico**: Mudan√ßa percentual rateio cria nova vers√£o com data vig√™ncia (ex: "Jan-Mar 2024: 60/40" ‚Üí "Abr+ 2024: 50/50").

### RN-RF031-04: Dimens√µes Customiz√°veis Ilimitadas

**Descri√ß√£o**: Al√©m de centros custo padr√£o, sistema DEVE suportar dimens√µes customiz√°veis ilimitadas (Projeto, Produto, Cliente, Regi√£o, Canal Venda, Campanha Marketing) para an√°lises multi-dimensionais.

**Criar Dimens√£o**: Administrador cria nova dimens√£o via UI:
- Nome (ex: "Projeto")
- C√≥digo Prefixo (ex: "PROJ")
- Tipo Aloca√ß√£o (Percentual, Valor Absoluto, Unit√°rio)
- Obrigat√≥ria (Sim/N√£o)

**Valores Dimens√£o**: Para cada dimens√£o, cadastrar valores poss√≠veis:
- Projeto ‚Üí Transforma√ß√£o Digital, Cloud Migration, ERP Upgrade
- Regi√£o ‚Üí Sudeste, Sul, Nordeste, Norte, Centro-Oeste
- Canal ‚Üí Online, Varejo F√≠sico, Televendas, Distribuidores

**Aloca√ß√£o Multi-Dimens√£o**: Despesa pode ser alocada em m√∫ltiplas dimens√µes simultaneamente:
- Centro Custo: TI (100%)
- Projeto: Transforma√ß√£o Digital (60%) + Cloud Migration (40%)
- Regi√£o: Sudeste (100%)

**Valida√ß√£o Cruzada**: Se dimens√£o obrigat√≥ria, sistema bloqueia save se n√£o houver aloca√ß√£o.

**Relat√≥rios**: Todos relat√≥rios gerenciais permitem filtro/agrupamento por qualquer dimens√£o.

**Erro**: 400 Bad Request se soma aloca√ß√£o percentual ‚â† 100% em dimens√£o obrigat√≥ria.

### RN-RF031-05: Regras de Classifica√ß√£o Autom√°tica com Builder Visual

**Descri√ß√£o**: Sistema DEVE classificar automaticamente lan√ßamentos importados aplicando regras configur√°veis (biblioteca 50+ templates + custom builder visual sem c√≥digo).

**50+ Regras Pr√©-Definidas**:
1. **Fornecedor = Vivo** ‚Üí Conta 5.1.2.01.001 (Telefonia M√≥vel)
2. **Fornecedor = AWS** ‚Üí Conta 5.1.2.05.002 (Cloud Computing)
3. **Valor >R$10k E Tipo = Consultoria** ‚Üí Projeto "Transforma√ß√£o Digital"
4. **Filial = SP E Departamento = TI** ‚Üí Centro Custo CC-SP-TI
5. **Categoria = Viagem E Destino Internacional** ‚Üí Conta 5.1.3.02 (Viagens Internacionais)
... (45 regras adicionais)

**Custom Rules Builder**: Interface visual tipo Zapier para criar regras:
```
[SE] [Campo Lan√ßamento] [Operador] [Valor]
  [E/OU] [Campo Lan√ßamento] [Operador] [Valor]
[ENT√ÉO] [A√ß√£o]
  - Atribuir Conta: [dropdown plano contas]
  - Atribuir Centro Custo: [dropdown centros]
  - Atribuir Dimens√£o [Projeto]: [dropdown projetos]
  - Adicionar Tag: [texto livre]
```

**Operadores Suportados**: =, ‚â†, >, ‚â•, <, ‚â§, Cont√©m, N√£o Cont√©m, Come√ßa Com, Termina Com, Regex.

**Prioridade Regras**: Regras executadas em ordem (1, 2, 3...). Se m√∫ltiplas regras match, √∫ltima ganha (ou primeira se flag "Parar ap√≥s match").

**Simula√ß√£o**: Antes de ativar regra, bot√£o "Simular em √∫ltimos 100 lan√ßamentos" exibe quantos seriam afetados.

**Taxa Match**: Dashboard mostra % lan√ßamentos classificados automaticamente vs. manual (meta: >95%).

**Erro**: Nenhum erro se regra n√£o faz match (lan√ßamento fica "Aguardando Classifica√ß√£o Manual").

### RN-RF031-06: Importa√ß√£o Multi-Layout de ERPs

**Descri√ß√£o**: Sistema DEVE importar plano de contas e lan√ßamentos de arquivos exportados de ERPs com templates configur√°veis por sistema (SAP, TOTVS, Protheus, Oracle, Sankhya, Conta Azul, Omie).

**Templates Pr√©-Configurados**:
- **SAP FI/CO**: Formato `.txt` delimitado TAB com cabe√ßalho fixo 15 colunas
- **TOTVS Protheus 12**: CSV com encoding ISO-8859-1, separador `;`
- **Oracle Financials**: XML estruturado conforme schema Oracle GL
- **Sankhya**: JSON API REST com pagina√ß√£o
- **Conta Azul/Omie**: API REST OAuth 2.0

**Mapeamento Campos**: Cada template define mapeamento:
| Campo Sistema | Campo ERP | Transforma√ß√£o |
|---------------|-----------|---------------|
| Codigo_Conta | CONT_COD | Trim, PadLeft(10, '0') |
| Nome_Conta | CONT_DESC | Upper, RemoveAccents |
| Tipo_Conta | CONT_TIPO | Map: 'S'‚ÜíSint√©tica, 'A'‚ÜíAnal√≠tica |
| Centro_Custo | CC_COD | Lookup tabela Centro_Custo |

**Valida√ß√£o Importa√ß√£o**: Antes de importar, sistema valida:
- ‚úÖ Arquivo formato correto
- ‚úÖ Encoding detectado (UTF-8, ISO-8859-1, Windows-1252)
- ‚úÖ Campos obrigat√≥rios presentes
- ‚úÖ C√≥digos cont√°beis n√£o duplicados
- ‚úÖ Hierarquia sem loops circulares

**Preview**: Exibe 10 primeiras linhas parseadas antes de confirmar importa√ß√£o completa.

**Reconcilia√ß√£o**: Se importar estrutura onde 80% contas j√° existem, pergunta "Atualizar contas existentes?" (Sim/N√£o).

**Erro**: 400 Bad Request se formato inv√°lido | 409 Conflict se c√≥digo duplicado | 422 Unprocessable se hierarquia circular.

### RN-RF031-07: Exporta√ß√£o Lan√ßamentos Cont√°beis D-E (D√©bito-Cr√©dito)

**Descri√ß√£o**: Sistema DEVE gerar arquivo texto de lan√ßamentos cont√°beis em formato D-E (D√©bito-Cr√©dito) compat√≠vel com partida dobrada e import√°vel em qualquer ERP brasileiro.

**Formato Padr√£o Brasileiro**:
```
TIPO|LOTE|DT_LANCAMENTO|NUM_DOC|CONTA_DEBITO|CONTA_CREDITO|HISTORICO|VALOR|CENTRO_CUSTO|FILIAL
D|001|2024-01-15|NF-12345|5.1.2.01.001|2.1.1.03.001|Pgto fatura Vivo Jan/24|15000.00|CC-TI-SP|01
C|001|2024-01-15|NF-12345|2.1.1.03.001|5.1.2.01.001|Pgto fatura Vivo Jan/24|15000.00|CC-TI-SP|01
```

**Valida√ß√£o Partida Dobrada**: Sistema valida que soma d√©bitos = soma cr√©ditos ANTES de gerar arquivo (toler√¢ncia arredondamento: R$0,01).

**Preview Lan√ßamentos**: UI exibe preview grid com d√©bitos/cr√©ditos coloridos (verde/vermelho) + totalizador antes de exportar.

**Formatos Suportados**:
- **TXT Delimitado**: | , ; TAB customiz√°vel
- **CSV**: Encoding ISO-8859-1 ou UTF-8
- **XML**: Schema customiz√°vel
- **JSON**: Para ERPs modernos

**Agrupamento**: Op√ß√£o agrupar lan√ßamentos por (Dia, Semana, M√™s, Fornecedor, Centro Custo).

**Numera√ß√£o Lote**: Sistema gera n√∫mero sequencial lote cont√°bil (ex: LOTE-2024-001) ou permite manual.

**Hist√≥rico Padr√£o**: Template de hist√≥rico customiz√°vel (ex: "{Fornecedor} - {Descri√ß√£o} - {Compet√™ncia}").

**Erro**: 400 Bad Request se d√©bitos ‚â† cr√©ditos | 422 Unprocessable se conta inv√°lida.

### RN-RF031-08: Relat√≥rios Gerenciais DRE Multi-Dimensional

**Descri√ß√£o**: Sistema DEVE gerar relat√≥rios DRE (Demonstra√ß√£o Resultado Exerc√≠cio) com filtros multi-dimensionais e drill-down ilimitado.

**Filtros Dispon√≠veis**:
- Per√≠odo: M√™s, Trimestre, Semestre, Ano, Range customizado
- Centro Custo: Sele√ß√£o m√∫ltipla hier√°rquica
- Projeto: Todos, espec√≠fico, m√∫ltiplos
- Departamento: Dropdown hier√°rquico
- Regi√£o: Sudeste, Sul, etc.
- Compara√ß√£o: Nenhuma, MoM, YoY, Or√ßado x Realizado

**Estrutura DRE Padr√£o**:
```
RECEITA BRUTA
(-) Dedu√ß√µes
(=) RECEITA L√çQUIDA
(-) CPV (Custo Produto Vendido)
(=) LUCRO BRUTO
(-) Despesas Operacionais
  - Despesas Administrativas
    - Pessoal (sal√°rios, encargos, benef√≠cios)
    - Gerais (aluguel, utilities, seguros)
    - Telecom e TI ‚Üê DRILL-DOWN AQUI
      - Telefonia M√≥vel
      - Telefonia Fixa
      - Internet/Links
      - Cloud Computing
      - Licen√ßas Software
  - Despesas Comerciais
  - Despesas Financeiras
(=) RESULTADO OPERACIONAL (EBITDA)
(-) Deprecia√ß√£o/Amortiza√ß√£o
(=) EBIT
(-) Resultado Financeiro
(=) LAIR (Lucro Antes IR)
(-) Provis√£o IR/CSLL
(=) LUCRO L√çQUIDO
```

**Drill-Down**: Clica em qualquer linha ‚Üí detalha contas filhas at√© n√≠vel anal√≠tico ‚Üí clica em conta anal√≠tica ‚Üí lista lan√ßamentos individuais.

**An√°lise Vertical**: Mostra % cada item sobre Receita L√≠quida (ex: Telecom = 3,2% Receita).

**An√°lise Horizontal**: Compara per√≠odos (ex: Jan 2024: R$100k vs. Jan 2023: R$85k = +17,6% ‚Üó).

**Gr√°ficos**: Chart.js waterfall, line chart evolu√ß√£o temporal, pie chart distribui√ß√£o despesas.

**Exporta√ß√£o**: Excel formatado (cores, borders, f√≥rmulas), PDF executivo, CSV dados brutos.

**Erro**: Nenhum (se sem dados, exibe "Nenhum lan√ßamento no per√≠odo selecionado").

### RN-RF031-09: Or√ßamento vs. Realizado com Alertas Varia√ß√£o

**Descri√ß√£o**: Sistema DEVE permitir cadastrar or√ßamento anual por conta cont√°bil com rateio mensal autom√°tico e compara√ß√£o visual real x or√ßado em tempo real.

**Cadastro Or√ßamento**:
1. Selecionar ano fiscal (ex: 2025)
2. Para cada conta anal√≠tica, informar valor anual OU valores mensais individuais
3. Sistema calcula rateio mensal (anual √∑ 12) se n√£o informado m√™s a m√™s
4. Aprovar or√ßamento (workflow CFO/Controller)

**Compara√ß√£o Visual**: Dashboard cards:
```
DESPESAS TELECOM - JANEIRO 2025
Or√ßado: R$ 150.000,00
Realizado: R$ 162.500,00
Varia√ß√£o: + R$ 12.500,00 (8,3% ‚Üó) üî¥

Detalhamento:
Telefonia M√≥vel: 105% or√ßado (R$5k acima)
Internet/Links: 98% or√ßado (ok)
Cloud: 112% or√ßado (R$9k acima) ‚ö†Ô∏è
```

**Alertas Autom√°ticos**: Sistema dispara alerta quando:
- Conta atinge 80% or√ßado com >5 dias √∫teis restantes no m√™s ‚Üí Email amarelo
- Conta atinge 100% or√ßado ‚Üí Email vermelho + notifica√ß√£o push
- Conta ultrapassa 110% or√ßado ‚Üí Escala para Controller/CFO

**Forecast**: Machine Learning prev√™ se fechamento m√™s ficar√° acima or√ßado baseado em tend√™ncia consumo dias anteriores.

**Ajuste Or√ßamento**: Permitir re-forecast mid-year com aprova√ß√£o e hist√≥rico vers√£o (ex: Or√ßamento Original ‚Üí Revis√£o Q2 ‚Üí Revis√£o Q4).

**Erro**: 400 Bad Request se or√ßamento sem valor para conta obrigat√≥ria | 403 Forbidden se usu√°rio sem permiss√£o aprovar.

### RN-RF031-10: Auditoria Completa com Trilha de Mudan√ßas

**Descri√ß√£o**: Sistema DEVE manter hist√≥rico completo de todas altera√ß√µes estrutura cont√°bil, lan√ßamentos e configura√ß√µes com campos obrigat√≥rios (antes/depois, justificativa, aprovador).

**Eventos Auditados**:
- Cria√ß√£o/Edi√ß√£o/Exclus√£o conta cont√°bil
- Mudan√ßa hierarquia (mover conta)
- Altera√ß√£o centro custo, percentuais rateio
- Mudan√ßa regra classifica√ß√£o autom√°tica
- Importa√ß√£o/Exporta√ß√£o arquivos
- Altera√ß√£o or√ßamento
- Aprova√ß√£o/Rejei√ß√£o workflows

**Campos Trilha**:
```json
{
  "EventoId": "uuid",
  "Tipo": "Conta.Movida",
  "Usuario": "joao.silva@empresa.com",
  "DataHora": "2024-01-15T14:32:18Z",
  "IP": "192.168.1.100",
  "ValorAnterior": {
    "ContaId": "uuid-conta-telecom",
    "PaiId": "uuid-despesas-gerais"
  },
  "ValorNovo": {
    "ContaId": "uuid-conta-telecom",
    "PaiId": "uuid-despesas-ti"
  },
  "Justificativa": "Reorganiza√ß√£o estrutura cont√°bil conforme novo plano contas 2024",
  "AprovadorId": "maria.controller@empresa.com",
  "Status": "Aprovado"
}
```

**Consulta Auditoria**: UI com filtros (per√≠odo, usu√°rio, tipo evento, conta afetada) + export Excel.

**Reten√ß√£o**: Dados auditoria mantidos por 7 anos (LGPD, exig√™ncia fiscal) com compress√£o ap√≥s 1 ano.

**Imutabilidade**: Registros auditoria s√£o append-only (nunca deletados ou editados).

### RN-RF031-11: Valida√ß√£o Cont√°bil com 20+ Regras Fiscais

**Descri√ß√£o**: Sistema DEVE executar valida√ß√µes cont√°beis autom√°ticas antes de salvar qualquer lan√ßamento, impedindo erros que causariam rejei√ß√£o em auditorias fiscais.

**20 Regras Valida√ß√£o**:
1. **Conta Anal√≠tica**: Lan√ßamento s√≥ em conta tipo "Anal√≠tica" (nunca em Sint√©tica)
2. **Partida Dobrada**: Soma d√©bitos = soma cr√©ditos (toler√¢ncia R$0,01)
3. **Data V√°lida**: Data lan√ßamento entre per√≠odo fiscal aberto (n√£o pode lan√ßar em per√≠odo fechado)
4. **C√≥digo Cont√°bil**: Conta existe no plano contas ativo (n√£o exclu√≠da)
5. **Centro Custo Obrigat√≥rio**: Se configurado obrigat√≥rio, n√£o aceita null
6. **Valor Positivo**: Valor lan√ßamento > 0
7. **Hist√≥rico M√≠nimo**: Hist√≥rico com m√≠nimo 10 caracteres (n√£o aceita ".")
8. **Documento √önico**: N√∫mero documento √∫nico por per√≠odo/fornecedor (detecta duplicidade)
9. **Hierarquia V√°lida**: Conta filha do tipo compat√≠vel com pai
10. **Dimens√£o Obrigat√≥ria**: Se dimens√£o marcada obrigat√≥ria, exige preenchimento
11. **Percentual Rateio**: Soma = 100% se multi-centro custo
12. **Conta Movimento**: Detecta se conta sint√©tica tem lan√ßamento direto
13. **Saldo Devedor/Credor**: Valida natureza saldo (Ativo = devedor, Passivo = credor)
14. **Conta Encerrada**: N√£o permite lan√ßamento em conta marcada "Encerrada"
15. **Limite Valor**: Alerta se valor >R$1M (poss√≠vel erro digita√ß√£o)
... (5 valida√ß√µes adicionais)

**Severidade**: Cada regra tem n√≠vel:
- **Bloqueante**: Impede save at√© corre√ß√£o
- **Advert√™ncia**: Permite save mas exige confirma√ß√£o usu√°rio + justificativa
- **Informativa**: Apenas alerta, n√£o bloqueia

**Feedback Imediato**: Valida√ß√£o executa em tempo real (ao sair do campo) com mensagem clara sobre como corrigir.

**Erro**: 400 Bad Request com lista detalhada de todas valida√ß√µes falhadas (ex: "Conta inv√°lida, Centro custo obrigat√≥rio, Valor negativo").

### RN-RF031-12: Reconcilia√ß√£o Autom√°tica com Engine Fuzzy Matching

**Descri√ß√£o**: Ao importar lan√ßamentos de arquivo externo (ERP, banco), sistema DEVE tentar reconciliar automaticamente com contas cont√°beis do plano usando algoritmo fuzzy matching.

**Algoritmo Matching**:
1. **Match Exato**: C√≥digo conta importado = c√≥digo conta sistema ‚Üí 100% match
2. **Fuzzy Nome**: Levenshtein distance entre nomes ‚â•85% ‚Üí sugest√£o (ex: "Desp Telefonia" vs "Despesas Telefonia")
3. **Hist√≥rico**: Se lan√ßamentos passados mesmo fornecedor usaram conta X, sugere conta X
4. **Machine Learning**: Modelo treinado com 10.000+ lan√ßamentos hist√≥ricos sugere conta com score confian√ßa

**Status Reconcilia√ß√£o**:
- ‚úÖ **Conciliado** (100% match) - verde
- ‚ö†Ô∏è **Sugest√£o** (85-99% match) - amarelo, usu√°rio confirma
- ‚ùå **N√£o Conciliado** (<85% match) - vermelho, classifica√ß√£o manual

**Interface Reconcilia√ß√£o**: Grid com 3 colunas lado a lado:
| Lan√ßamento Importado | ‚Üí | Conta Sugerida | Confian√ßa | A√ß√£o |
|----------------------|---|----------------|-----------|------|
| "Tel Vivo Jan/24" | ‚Üí | 5.1.2.01.001 Telefonia M√≥vel | 94% | ‚úÖ Aceitar / ‚úó Rejeitar |

**Aprendizado**: Quando usu√°rio confirma ou corrige sugest√£o, sistema armazena para melhorar pr√≥ximas importa√ß√µes.

**Taxa Sucesso**: Dashboard mostra % reconcilia√ß√£o autom√°tica (meta: >90%).

### RN-RF031-13: Integra√ß√£o Bidirecional com ERP Financeiro

**Descri√ß√£o**: Sistema DEVE integrar bidirecionalmente com ERPs financeiros (SAP, TOTVS, Oracle) via API REST ou arquivos batch.

**Fluxos Integra√ß√£o**:

**1. ERP ‚Üí IControlIT (Importa√ß√£o Estrutura)**:
- Hangfire job di√°rio √†s 03:00 UTC consulta API ERP
- Baixa estrutura plano contas atualizada
- Detecta mudan√ßas (novas contas, renomea√ß√µes, exclus√µes)
- Aplica merge com plano local preservando customiza√ß√µes IControlIT

**2. IControlIT ‚Üí ERP (Exporta√ß√£o Lan√ßamentos)**:
- Usu√°rio aprova lan√ßamentos para envio
- Sistema gera arquivo formato ERP (D-E, XML, JSON)
- Valida partida dobrada + regras fiscais
- Envia via API ou deposita em pasta SFTP
- Recebe callback confirma√ß√£o importa√ß√£o ERP
- Marca lan√ßamentos como "Integrado ERP" com timestamp

**Autentica√ß√£o**: OAuth 2.0 com refresh token autom√°tico + armazenamento Azure Key Vault.

**Retry Policy**: Polly retry backoff exponencial (3 tentativas com delay 2s, 4s, 8s).

**Logs Integra√ß√£o**: Tabela audit_log_integracao com status (Sucesso, Falha, Parcial) + erro detalhado.

**Erro**: Se integra√ß√£o falha 3x consecutivas, sistema envia email para equipe TI + desativa job at√© investiga√ß√£o.

### RN-RF031-14: Isolamento Multi-Tenant com Row-Level Security

**Descri√ß√£o**: TODAS as queries e opera√ß√µes DEVEM filtrar por `ClienteId` obtido do JWT token do usu√°rio logado (multi-tenancy seguro).

**Seguran√ßa**: Usu√°rio Cliente A n√£o pode ver/editar contas cont√°beis de Cliente B mesmo se descobrir ID.

**Performance**: √çndice composto (ClienteId, Codigo_Conta) otimiza queries principais.

**Valida√ß√£o**: EF Core Query Filter global adiciona `WHERE ClienteId = {userClientId}` automaticamente.

### RN-RF031-15: Soft Delete com Hist√≥rico Versionado

**Descri√ß√£o**: Sistema NUNCA deve fazer DELETE f√≠sico de contas cont√°beis ou lan√ßamentos. Exclus√£o l√≥gica via `FlExcluido = TRUE` com versionamento completo.

**Motivo**: Preservar hist√≥rico para auditorias fiscais (obrigat√≥rio 7 anos Receita Federal).

**Queries**: Todas queries incluem `WHERE FlExcluido = 0` por padr√£o (EF Core Query Filter).

**Restaura√ß√£o**: Administrador pode restaurar conta exclu√≠da com justificativa + aprova√ß√£o Controller.

**Versionamento**: Se conta editada, sistema cria snapshot JSON antes/depois na tabela `Plano_Conta_Versao`.

---

## üóÑÔ∏è 3. REFER√äNCIAS AO SISTEMA LEGADO

### 3.1 Telas Web Forms Mapeadas (ASPX + VB.NET)

**Sistema legado N√ÉO possui m√≥dulo espec√≠fico de Plano de Contas estruturado.** A funcionalidade estava fragmentada em:

| Tela Legada | Funcionalidade Parcial | Limita√ß√µes |
|-------------|------------------------|------------|
| `Cadastro/Centro_Custo.aspx` | Cadastro b√°sico centros custo | Sem hierarquia, sem rateio autom√°tico |
| `Recepcao_Fatura/Plano_Conta.aspx` | Cadastro simplificado contas | 3 n√≠veis fixos, sem dimens√µes |
| `Recepcao_Fatura/Rateio.aspx` | Rateio manual planilha Excel | 100% manual, sem regras automatizadas |
| `Consulta/Template_Consulta.aspx` | Relat√≥rios b√°sicos | Est√°tico, sem drill-down multi-dimensional |

**Observa√ß√µes**:
- Legado usava planilhas Excel paralelas para gest√£o real do plano de contas
- Controllers mantinham documenta√ß√£o Word com estrutura cont√°bil oficial
- Integra√ß√£o ERP era 100% manual (export CSV ‚Üí import manual ERP)
- Sem auditoria de mudan√ßas estruturais

### 3.2 Stored Procedures Relacionadas

**N√£o h√° stored procedures espec√≠ficas de plano contas no legado.** Opera√ß√µes cont√°beis estavam dispersas em:

| Procedure Legada | Uso | Limita√ß√£o |
|------------------|-----|-----------|
| `pa_Centro_Custo` | CRUD centros custo | Tabela simples sem hierarquia |
| `pa_Plano_Conta` | CRUD contas b√°sico | Estrutura fixa 3 n√≠veis |
| `sp_Rateio_Calcular` | C√°lculo rateio manual | Requer input Excel, sem automa√ß√£o |

### 3.3 Tabelas do Banco de Dados Legado

**Estrutura simplificada fragmentada em 3 tabelas:**

```sql
-- Legado: Tabela Centro_Custo (sem hierarquia)
CREATE TABLE Centro_Custo (
    Id_Centro_Custo INT IDENTITY PRIMARY KEY,
    Nm_Centro_Custo NVARCHAR(100) NOT NULL,
    Codigo_Centro_Custo VARCHAR(50) NULL,
    Fl_Desativado BIT DEFAULT 0
);

-- Legado: Tabela Plano_Conta (estrutura r√≠gida 3 n√≠veis)
CREATE TABLE Plano_Conta (
    Id_Plano_Conta INT IDENTITY PRIMARY KEY,
    Codigo_Nivel_1 VARCHAR(10) NULL,  -- Ex: "5" (Despesas)
    Codigo_Nivel_2 VARCHAR(10) NULL,  -- Ex: "5.1" (Desp Admin)
    Codigo_Nivel_3 VARCHAR(10) NULL,  -- Ex: "5.1.2" (Telecom)
    Nm_Conta NVARCHAR(200) NOT NULL,
    Tipo_Conta CHAR(1) CHECK (Tipo_Conta IN ('S','A')) -- S=Sint√©tica, A=Anal√≠tica
);

-- Legado: Tabela Rateio (vincula√ß√£o manual)
CREATE TABLE Rateio (
    Id_Rateio INT IDENTITY PRIMARY KEY,
    Id_Fatura INT NOT NULL,
    Id_Centro_Custo INT NOT NULL,
    Percentual DECIMAL(5,2) NOT NULL,
    Valor_Rateado DECIMAL(18,2) NULL
);
```

**Problemas Estrutura Legada**:
- ‚ùå Apenas 3 n√≠veis hier√°rquicos fixos (insuficiente para empresas grandes)
- ‚ùå Sem suporte a dimens√µes (projeto, regi√£o, produto)
- ‚ùå Centros custo sem v√≠nculo hierarquia organizacional
- ‚ùå Rateio manual sem regras automatizadas
- ‚ùå Sem auditoria de mudan√ßas
- ‚ùå Sem versionamento estrutura cont√°bil

### 3.4 WebServices Relacionados

**Sistema legado N√ÉO possui WebServices espec√≠ficos para plano contas.** Opera√ß√µes eram:

- `WSCadastro.asmx/Centro_Custo` - CRUD b√°sico centros
- `WSRecepcao_Fatura.asmx/Plano_Conta` - CRUD contas simples
- `WSRateio.asmx/Calcular_Rateio` - C√°lculo rateio via stored procedure

### 3.5 Mapeamento Funcional Legado ‚Üí Modernizado

| Funcionalidade | Legado | Modernizado RF-031 |
|----------------|--------|-------------------|
| **N√≠veis Hierarquia** | 3 fixos (Classe, Grupo, Conta) | 7 configur√°veis + nomenclatura customiz√°vel |
| **Centros Custo** | Tabela independente | Integrado hierarquia organizacional com rateio cascata |
| **Dimens√µes** | Nenhuma | Ilimitadas (Projeto, Regi√£o, Produto, etc.) |
| **Classifica√ß√£o** | 100% manual Excel | Regras automatizadas (>95% autom√°tico) |
| **Importa√ß√£o** | CSV fixo √∫nico | Multi-layout (SAP, TOTVS, Oracle, Sankhya) |
| **Exporta√ß√£o** | Excel est√°tico | Arquivo D-E validado + preview |
| **Rateio** | Manual planilha | Autom√°tico multi-dimensional |
| **Relat√≥rios** | Est√°tico sem drill-down | DRE gerencial drill-down ilimitado |
| **Or√ßamento** | Excel paralelo | Integrado real x or√ßado tempo real |
| **Auditoria** | Nenhuma | Trilha completa versionada |
| **Valida√ß√µes** | Nenhuma (erro p√≥s-fechamento) | 20+ regras pr√©-save |
| **Integra√ß√£o ERP** | Manual | API REST bidirecional |

---

## üîó 4. IMPACTO E DEPEND√äNCIAS

### 4.1 Depend√™ncias de Outros RFs

**Depend√™ncias Obrigat√≥rias (RF DEVE existir primeiro):**
- ‚úÖ **RF-030** - Cliente Multi-Tenant ‚Üí Fornece `ClienteId` para isolamento
- ‚úÖ **RF-024** - Gest√£o Departamentos ‚Üí Fornece hierarquia organizacional para centros custo
- ‚úÖ **RF-026** - Gest√£o Faturas ‚Üí Lan√ßamentos classificados v√™m de faturas importadas

**Depend√™ncias Opcionais (RF melhora se existir):**
- üî∏ **RF-022** - Gest√£o Fornecedores ‚Üí Regras classifica√ß√£o autom√°tica por fornecedor
- üî∏ **RF-023** - Gest√£o Contratos ‚Üí Vincula despesas a projetos/contratos
- üî∏ **RF-026** - Gest√£o Faturas ‚Üí Fonte principal de lan√ßamentos para classificar

**RFs que Dependem Deste:**
- üìä **RF-040** - Relat√≥rios Gerenciais ‚Üí Usa estrutura plano contas para DRE
- üìä **RF-041** - Dashboards Executivos ‚Üí Consome dados classificados por conta
- üìä **RF-042** - Business Intelligence ‚Üí An√°lises multi-dimensionais baseadas em dimens√µes

### 4.2 Tecnologias Utilizadas

**Backend (.NET 10)**:
```csharp
// Domain - Entidades
public class PlanoContaContabil : BaseAuditableEntity
{
    public Guid ClienteId { get; set; }          // Multi-tenant
    public Guid? PlanoContaContabil_PaiId { get; set; }  // Hierarquia
    public string Codigo_Contabil { get; set; }  // Ex: 5.1.2.01.001
    public string Nome_Conta { get; set; }
    public int Nivel { get; set; }               // 1-7
    public char Tipo_Conta { get; set; }         // S=Sint√©tica, A=Anal√≠tica
    public bool FlPermiteLancamento { get; set; } // S√≥ anal√≠tica

    // Navega√ß√£o
    public PlanoContaContabil Pai { get; set; }
    public ICollection<PlanoContaContabil> Filhas { get; set; }
    public ICollection<LancamentoContabil> Lancamentos { get; set; }
}

// Application - Commands
public record CreatePlanoContaCommand : IRequest<Guid>
{
    public string CodigoContabil { get; init; }
    public string NomeConta { get; init; }
    public Guid? PaiId { get; init; }
    public char TipoConta { get; init; }
}

// Validator
public class CreatePlanoContaCommandValidator : AbstractValidator<CreatePlanoContaCommand>
{
    public CreatePlanoContaCommandValidator(IApplicationDbContext context)
    {
        RuleFor(v => v.CodigoContabil)
            .NotEmpty()
            .MaximumLength(50)
            .MustAsync(async (codigo, cancellation) =>
                await context.PlanosContasContabeis.AllAsync(c => c.Codigo_Contabil != codigo))
            .WithMessage("C√≥digo cont√°bil j√° existe");

        RuleFor(v => v.TipoConta)
            .Must(tipo => tipo == 'S' || tipo == 'A')
            .WithMessage("Tipo conta deve ser S (Sint√©tica) ou A (Anal√≠tica)");

        // Regra: N√£o criar loop circular
        RuleFor(v => v.PaiId)
            .MustAsync(async (command, paiId, context, cancellation) => {
                if (!paiId.HasValue) return true;
                // Verificar se criar esse v√≠nculo causaria loop
                return await ValidarNaoCircular(paiId.Value, command.PaiId);
            })
            .WithMessage("Hierarquia circular detectada");
    }
}
```

**Frontend (Angular 19)**:
```typescript
// Component - Plano Contas Hier√°rquico
@Component({
  selector: 'app-plano-contas-tree',
  standalone: true,
  imports: [
    CommonModule,
    MatTreeModule,
    MatButtonModule,
    MatIconModule,
    DragDropModule,  // Drag-and-drop
    TranslocoModule
  ],
  templateUrl: './plano-contas-tree.component.html'
})
export class PlanoContasTreeComponent {
  dataSource: MatTreeNestedDataSource<PlanoContaNode>;
  treeControl: NestedTreeControl<PlanoContaNode>;

  // Drag-and-drop
  drop(event: CdkDragDrop<PlanoContaNode>) {
    const conta = event.item.data;
    const novoPai = event.container.data;

    // Preview impacto
    this.planoContasService.previewMoverConta(conta.id, novoPai.id)
      .subscribe(impacto => {
        const dialogRef = this.dialog.open(PreviewImpactoDialog, {
          data: impacto  // { lancamentosAfetados: 1250, relatoriosAfetados: 5 }
        });

        dialogRef.afterClosed().subscribe(confirmed => {
          if (confirmed) {
            this.planoContasService.moverConta(conta.id, novoPai.id)
              .subscribe(() => this.reloadTree());
          }
        });
      });
  }
}

// Service - Classifica√ß√£o Autom√°tica
@Injectable({ providedIn: 'root' })
export class ClassificacaoAutomaticaService {

  classificarLancamento(lancamento: LancamentoDto): Observable<ClassificacaoSugeridaDto> {
    return this.http.post<ClassificacaoSugeridaDto>(
      `${environment.apiUrl}/classificacao/sugerir`,
      lancamento
    ).pipe(
      map(sugestao => ({
        ...sugestao,
        confianca: this.calcularConfianca(sugestao)
      }))
    );
  }

  private calcularConfianca(sugestao: ClassificacaoSugeridaDto): number {
    // Score baseado em: match exato, fuzzy, ML model, hist√≥rico
    let score = 0;
    if (sugestao.matchExato) score = 100;
    else if (sugestao.fuzzyScore >= 90) score = sugestao.fuzzyScore;
    else if (sugestao.mlScore) score = sugestao.mlScore * 100;
    return Math.min(score, 99); // Max 99% (100% reservado para match exato)
  }
}
```

**Bibliotecas Externas**:
- **ClosedXML** - Importa√ß√£o/Exporta√ß√£o Excel avan√ßada
- **CsvHelper** - Parse CSV robusto multi-encoding
- **ML.NET** - Machine Learning para classifica√ß√£o autom√°tica e forecast
- **Hangfire** - Jobs agendados (importa√ß√£o di√°ria ERP, alertas)
- **Chart.js** - Gr√°ficos DRE (Waterfall, Line, Pie)
- **Angular CDK Drag-Drop** - Interface drag-and-drop visual
- **Transloco** - i18n (pt-BR, en-US, es-ES)

### 4.3 Complexidade de Implementa√ß√£o

**Estimativa**: 120 horas (15 dias √∫teis, 1 desenvolvedor senior)

**Breakdown**:
- Backend Domain/Entities (8h)
- Backend Commands/Queries (20h)
- Backend Validators (12h)
- Backend Importa√ß√£o Multi-Layout (18h)
- Backend Regras Classifica√ß√£o Autom√°tica + ML (24h)
- Backend Exporta√ß√£o Lan√ßamentos D-E (8h)
- Frontend Tree Hier√°rquico Drag-Drop (16h)
- Frontend Relat√≥rios DRE Drill-Down (14h)
- Testes Unit√°rios Backend (10h)
- Testes E2E Frontend (8h)
- Documenta√ß√£o API (2h)

**Complexidade ALTA devido a**:
- Hierarquia recursiva at√© 7 n√≠veis com drag-drop
- Engine classifica√ß√£o autom√°tica com ML
- Valida√ß√µes cont√°beis complexas (partida dobrada, regras fiscais)
- Importa√ß√£o multi-layout (parsers customizados)
- Relat√≥rios drill-down multi-dimensionais com performance

### 4.4 Riscos Identificados

| Risco | Probabilidade | Impacto | Mitiga√ß√£o |
|-------|---------------|---------|-----------|
| **Performance queries hier√°rquicas** | M√©dia | Alto | Usar CTE recursiva SQL + cache Redis estrutura |
| **Importa√ß√£o arquivo gigante (>1M linhas)** | Baixa | Alto | Processamento batch com progress bar + chunking 10k linhas |
| **Drag-drop criar loop circular** | M√©dia | M√©dio | Valida√ß√£o backend + frontend com grafo directed acyclic |
| **ML model baixa acur√°cia inicial** | Alta | M√©dio | Come√ßar com regras determin√≠sticas, treinar ML com 3 meses dados |
| **Integra√ß√£o ERP falha** | M√©dia | Alto | Retry policy + fallback manual + alertas equipe |
| **Usu√°rio deletar conta com lan√ßamentos** | M√©dia | Cr√≠tico | Soft delete obrigat√≥rio + confirma√ß√£o m√∫ltipla |

---

## üéØ 5. INTEGRA√á√ÉO COM CENTRAL DE FUNCIONALIDADES

### 5.1 Permiss√µes RBAC Necess√°rias

```csharp
public static class PlanoContasPermissions
{
    // Visualiza√ß√£o
    public const string View = "GES.PLANO_CONTAS.VIEW";
    public const string ViewDetails = "GES.PLANO_CONTAS.VIEW_DETAILS";

    // Gest√£o Contas
    public const string Create = "GES.PLANO_CONTAS.CREATE";
    public const string Edit = "GES.PLANO_CONTAS.EDIT";
    public const string Delete = "GES.PLANO_CONTAS.DELETE";
    public const string Move = "GES.PLANO_CONTAS.MOVE";  // Drag-drop hierarquia

    // Gest√£o Centros Custo
    public const string ManageCentroCusto = "GES.PLANO_CONTAS.MANAGE_CENTRO_CUSTO";
    public const string EditRateio = "GES.PLANO_CONTAS.EDIT_RATEIO";

    // Gest√£o Dimens√µes
    public const string ManageDimensoes = "GES.PLANO_CONTAS.MANAGE_DIMENSOES";
    public const string CreateDimensao = "GES.PLANO_CONTAS.CREATE_DIMENSAO";

    // Regras Classifica√ß√£o
    public const string ViewRegras = "GES.PLANO_CONTAS.VIEW_REGRAS";
    public const string ManageRegras = "GES.PLANO_CONTAS.MANAGE_REGRAS";
    public const string ExecuteClassificacao = "GES.PLANO_CONTAS.EXECUTE_CLASSIFICACAO";

    // Importa√ß√£o/Exporta√ß√£o
    public const string Import = "GES.PLANO_CONTAS.IMPORT";
    public const string Export = "GES.PLANO_CONTAS.EXPORT";
    public const string ImportERP = "GES.PLANO_CONTAS.IMPORT_ERP";
    public const string ExportLancamentos = "GES.PLANO_CONTAS.EXPORT_LANCAMENTOS";

    // Relat√≥rios
    public const string ViewDRE = "GES.PLANO_CONTAS.VIEW_DRE";
    public const string ViewOrcamento = "GES.PLANO_CONTAS.VIEW_ORCAMENTO";
    public const string ManageOrcamento = "GES.PLANO_CONTAS.MANAGE_ORCAMENTO";
    public const string ApproveOrcamento = "GES.PLANO_CONTAS.APPROVE_ORCAMENTO";

    // Auditoria
    public const string ViewAudit = "GES.PLANO_CONTAS.VIEW_AUDIT";
    public const string RestoreDeleted = "GES.PLANO_CONTAS.RESTORE_DELETED";

    // Administra√ß√£o
    public const string ManageTemplates = "GES.PLANO_CONTAS.MANAGE_TEMPLATES";
    public const string ApproveStructureChange = "GES.PLANO_CONTAS.APPROVE_STRUCTURE_CHANGE";
}
```

**Matriz Permiss√£o ‚Üí Perfil**:
| Permiss√£o | Controller/CFO | Gerente Financeiro | Analista Cont√°bil | Consulta |
|-----------|----------------|---------------------|-------------------|----------|
| View | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| Create/Edit/Delete | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| Move (estrutura) | ‚úÖ | ‚ö†Ô∏è (aprova√ß√£o) | ‚ùå | ‚ùå |
| ManageRegras | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| Import/Export | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| ManageOrcamento | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| ApproveOrcamento | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| ApproveStructureChange | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| ViewAudit | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |

### 5.2 Chaves i18n Completas (pt-BR, en-US, es-ES)

```json
{
  "planoContas": {
    "title": "Plano de Contas Cont√°bil",
    "subtitle": "Gest√£o hier√°rquica multi-dimensional",

    "menu": {
      "estrutura": "Estrutura Cont√°bil",
      "centrosCusto": "Centros de Custo",
      "dimensoes": "Dimens√µes",
      "regras": "Regras Classifica√ß√£o",
      "relatorios": "Relat√≥rios",
      "orcamento": "Or√ßamento"
    },

    "actions": {
      "createConta": "Nova Conta",
      "createCentroCusto": "Novo Centro Custo",
      "createDimensao": "Nova Dimens√£o",
      "createRegra": "Nova Regra",
      "import": "Importar Estrutura",
      "export": "Exportar Lan√ßamentos",
      "previewImpacto": "Preview Impacto",
      "moverConta": "Mover Conta",
      "editarConta": "Editar Conta",
      "excluirConta": "Excluir Conta",
      "restaurarConta": "Restaurar Conta",
      "duplicarRegra": "Duplicar Regra",
      "simularRegra": "Simular Regra"
    },

    "form": {
      "codigoContabil": "C√≥digo Cont√°bil",
      "nomeConta": "Nome da Conta",
      "tipoConta": "Tipo",
      "tipoSintetica": "Sint√©tica (agrupamento)",
      "tipoAnalitica": "Anal√≠tica (recebe lan√ßamentos)",
      "contaPai": "Conta Pai",
      "nivel": "N√≠vel Hier√°rquico",
      "permiteLancamento": "Permite Lan√ßamento Direto",
      "naturezaSaldo": "Natureza Saldo",
      "devedora": "Devedora",
      "credora": "Credora",
      "centroCusto": "Centro de Custo",
      "projeto": "Projeto",
      "departamento": "Departamento",
      "percentualRateio": "% Rateio",
      "observacoes": "Observa√ß√µes"
    },

    "validation": {
      "codigoObrigatorio": "C√≥digo cont√°bil √© obrigat√≥rio",
      "codigoDuplicado": "C√≥digo cont√°bil j√° existe",
      "nomeObrigatorio": "Nome da conta √© obrigat√≥rio",
      "tipoInvalido": "Tipo deve ser Sint√©tica (S) ou Anal√≠tica (A)",
      "hierarquiaCircular": "Opera√ß√£o criaria hierarquia circular",
      "contaComLancamentos": "Conta possui lan√ßamentos, n√£o pode ser exclu√≠da",
      "partidaDobradaInvalida": "Soma d√©bitos diferente de soma cr√©ditos",
      "percentualRateioInvalido": "Soma percentuais deve ser 100%",
      "periodoFechado": "Per√≠odo cont√°bil fechado, n√£o permite lan√ßamentos",
      "valorNegativo": "Valor n√£o pode ser negativo",
      "contaSintetica": "Lan√ßamento s√≥ permitido em conta Anal√≠tica"
    },

    "messages": {
      "createSuccess": "Conta criada com sucesso",
      "updateSuccess": "Conta atualizada com sucesso",
      "deleteSuccess": "Conta exclu√≠da com sucesso",
      "moveSuccess": "Conta movida com sucesso",
      "importSuccess": "{{count}} contas importadas com sucesso",
      "exportSuccess": "Lan√ßamentos exportados com sucesso",
      "classificacaoSuccess": "{{count}} lan√ßamentos classificados automaticamente",
      "previewImpacto": "{{lancamentos}} lan√ßamentos e {{relatorios}} relat√≥rios ser√£o afetados",
      "aprovarOrcamento": "Or√ßamento {{ano}} aprovado com sucesso",
      "alertaVariacao": "Aten√ß√£o: {{conta}} atingiu {{percentual}}% do or√ßado"
    },

    "relatorios": {
      "dre": "Demonstra√ß√£o Resultado Exerc√≠cio (DRE)",
      "balanco": "Balan√ßo Patrimonial",
      "analiseVertical": "An√°lise Vertical",
      "analiseHorizontal": "An√°lise Horizontal",
      "orcadoRealizado": "Or√ßado x Realizado",
      "receitaBruta": "Receita Bruta",
      "receitaLiquida": "Receita L√≠quida",
      "lucroBruto": "Lucro Bruto",
      "despesasOperacionais": "Despesas Operacionais",
      "ebitda": "EBITDA",
      "lucroLiquido": "Lucro L√≠quido",
      "variacao": "Varia√ß√£o",
      "participacao": "% Participa√ß√£o"
    }
  }
}
```

### 5.3 Campos de Auditoria (Padr√£o BaseAuditableEntity)

```csharp
public class PlanoContaContabil : BaseAuditableEntity
{
    // Campos de auditoria herdados:
    public string CriadoPor { get; set; }        // Email usu√°rio criou
    public DateTime CriadoEm { get; set; }       // UTC timestamp
    public string? AlteradoPor { get; set; }     // Email √∫ltimo editor
    public DateTime? AlteradoEm { get; set; }    // UTC timestamp √∫ltima edi√ß√£o

    // Campos controle pr√≥prios:
    public bool FlExcluido { get; set; }         // Soft delete
    public DateTime? ExcluidoEm { get; set; }    // Quando foi exclu√≠do
    public string? ExcluidoPor { get; set; }     // Quem excluiu
    public string? MotivoExclusao { get; set; }  // Justificativa obrigat√≥ria
}

// Tabela hist√≥rico versionamento
public class PlanoContaContabilVersao
{
    public Guid Id { get; set; }
    public Guid PlanoContaContabilId { get; set; }
    public int NumeroVersao { get; set; }
    public DateTime DataVersao { get; set; }
    public string UsuarioResponsavel { get; set; }
    public string MotivoAlteracao { get; set; }  // Obrigat√≥rio se vers√£o >1
    public string SnapshotDados { get; set; }    // JSON completo da vers√£o
    public string TipoOperacao { get; set; }     // CREATE, UPDATE, MOVE, DELETE
}
```

**Opera√ß√µes Auditadas**:
- ‚úÖ Cria√ß√£o conta cont√°bil
- ‚úÖ Edi√ß√£o nome/c√≥digo/tipo
- ‚úÖ Movimenta√ß√£o hierarquia (drag-drop)
- ‚úÖ Exclus√£o/Restaura√ß√£o
- ‚úÖ Altera√ß√£o centro custo/dimens√µes
- ‚úÖ Mudan√ßa regras classifica√ß√£o
- ‚úÖ Importa√ß√£o/Exporta√ß√£o arquivos
- ‚úÖ Altera√ß√£o or√ßamento
- ‚úÖ Aprova√ß√£o workflows

### 5.4 Multi-Tenancy (Isolamento por ClienteId)

```csharp
// EF Core Global Query Filter
modelBuilder.Entity<PlanoContaContabil>()
    .HasQueryFilter(e => e.ClienteId == _currentUserService.ClienteId);

// √çndice composto para performance
modelBuilder.Entity<PlanoContaContabil>()
    .HasIndex(e => new { e.ClienteId, e.Codigo_Contabil })
    .IsUnique();

// Valida√ß√£o autom√°tica em Commands
public class CreatePlanoContaCommandHandler : IRequestHandler<CreatePlanoContaCommand, Guid>
{
    public async Task<Guid> Handle(CreatePlanoContaCommand request, CancellationToken cancellationToken)
    {
        // ClienteId vem do JWT token automaticamente
        var clienteId = _currentUserService.ClienteId;

        var conta = new PlanoContaContabil
        {
            ClienteId = clienteId,  // Sempre obrigat√≥rio
            Codigo_Contabil = request.CodigoContabil,
            Nome_Conta = request.NomeConta,
            // ...
        };

        _context.PlanosContasContabeis.Add(conta);
        await _context.SaveChangesAsync(cancellationToken);

        return conta.Id;
    }
}
```

---

**FIM DO RF-031**

**Pr√≥ximos Passos**:
1. Criar Casos de Uso (UC00 a UC04) em pasta `Casos de Uso/`
2. Criar Modelo de Dados (MD-031) com DDL completo
3. Criar Cen√°rios/Casos/Massa Testes (CN, TC, MT) nas 3 camadas
4. Validar com stakeholders (Controller, CFO, Analistas Cont√°beis)
5. Implementar backend (.NET 10) conforme padr√µes Clean Architecture
6. Implementar frontend (Angular 19) com tree drag-drop visual
7. Testes E2E cobrindo 100% funcionalidades cr√≠ticas

**Documenta√ß√£o Complementar**:
- `MD-031-Plano-Contas.md` - Modelo dados completo com DDL
- `UC00-listar-contas.md` - Listagem hier√°rquica
- `UC01-criar-conta.md` - Cria√ß√£o com valida√ß√µes
- `UC02-visualizar-conta.md` - Detalhes + drill-down
- `UC03-editar-conta.md` - Edi√ß√£o + versionamento
- `UC04-excluir-conta.md` - Soft delete com confirma√ß√£o
- `UC05-mover-conta.md` - Drag-drop com preview impacto
- `UC06-importar-estrutura.md` - Multi-layout ERP
- `UC07-classificar-automatico.md` - Engine regras + ML
- `UC08-relatorio-dre.md` - DRE multi-dimensional
- `UC09-orcamento-vs-realizado.md` - Budget tracking

**Total Linhas**: ~750 linhas ‚úÖ (padr√£o Lote 1 mantido)
