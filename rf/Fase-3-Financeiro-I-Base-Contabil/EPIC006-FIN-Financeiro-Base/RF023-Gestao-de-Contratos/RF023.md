# RF-023: Gestão de Contratos

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC006-FIN-Financeiro-Base
**Fase**: Fase 3 - Financeiro I - Base Contábil

**RFs Relacionados**: RF022 (Gestão de Fornecedores), RF090 (Medição e Faturamento de Contratos), RF092 (Garantias e Seguros Contratuais), RF093 (Indicadores de Performance e Compliance)

---

## 1. OBJETIVO DO REQUISITO

Especificar o módulo de Gestão de Contratos do sistema IControlIT, responsável pela administração completa do ciclo de vida de contratos comerciais, de fornecimento, locação, manutenção e telecomunicações com fornecedores, operadoras e prestadores de serviço.

O módulo centraliza a gestão de documentos contratuais, vigências, valores, reajustes, anexos, workflows de aprovação, alertas automáticos, medições, garantias e histórico completo de alterações, garantindo conformidade legal e controle financeiro rigoroso.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] CRUD completo de contratos
- [x] Gestão de tipos de contrato (Compra, Locação, Manutenção, Telecom, Serviço)
- [x] Controle de vigência (data início, data fim, renovação automática)
- [x] Gestão de anexos contratuais (upload/download com versioning)
- [x] Controle de valores (valor total, valor mensal, moeda, reajustes)
- [x] Workflow de aprovação por alçadas de valor
- [x] Medição e faturamento (FK para RF090)
- [x] Garantias e seguros (FK para RF092)
- [x] Indicadores de performance (FK para RF093)
- [x] Versionamento de contratos
- [x] Relatórios gerenciais
- [x] Integração com fornecedores (FK para RF022)
- [x] Multi-tenancy rigoroso (isolamento por ClienteId)
- [x] Auditoria imutável de todas as operações
- [x] Alertas automáticos de vencimento

### 2.2 Fora do escopo

- Interface visual específica (responsabilidade do frontend)
- Tecnologia, framework ou linguagem de implementação
- Layout, UX ou identidade visual
- Estratégia de deploy ou infraestrutura
- Integração com sistemas externos de e-procurement

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Contrato** | Documento formal que estabelece direitos, obrigações e condições entre a empresa (ClienteId) e um terceiro (fornecedor, operadora, prestador). Pode ter múltiplas vigências, versionamento e histórico de alterações. |
| **Vigência** | Período de validade do contrato (DataInicio até DataFim). Contratos podem ter renovação automática ou exigir confirmação manual de renovação. |
| **Workflow de Aprovação** | Fluxo de autorização baseado em alçadas de valores. Exemplo: Até R$1.000 = Gestor, Até R$10.000 = Diretor, Acima = CFO. Cada nível pode aprovar, rejeitar ou solicitar informações adicionais. |
| **Reajuste Contratual** | Aumento automático de valores conforme índice econômico (IGPM, IPCA, INPC) na data de aniversário do contrato. RN-CTR-023-07 define validação e cálculo. |
| **Medição** | Associação entre contrato e faturas de consumo/serviços prestados (FK para RF090). Exemplo: Contrato de telecom tem 12 medições mensais (uma por mês). |
| **Multi-tenancy** | Cada contrato é isolado por ClienteId (cliente/empresa contratante). Nenhum dado de clientes diferentes pode ser visível. Segregação em database row-level. |
| **Soft Delete** | Contratos nunca são deletados fisicamente do banco. Ao excluir, a coluna IsDeleted é marcada como true, preservando auditoria e rastreabilidade. |
| **Alçada de Aprovação** | Limite de valor que define qual perfil de usuário pode aprovar um contrato. Configurável por cliente. |
| **Anexo Contratual** | Arquivo relacionado ao contrato (PDF, DOCX, XML) armazenado com versionamento, metadata e validação de integridade (hash CRC32). |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Criação de Contrato** - Criar novo contrato com validações completas
2. **Atualização de Contrato** - Editar contrato existente (status, valores, vigência)
3. **Consulta de Contrato** - Obter contrato por ID ou número
4. **Listagem de Contratos** - Listar contratos com filtros dinâmicos e paginação
5. **Exclusão Lógica** - Soft delete com auditoria completa
6. **Gestão de Anexos** - Upload/download de documentos contratuais
7. **Workflow de Aprovação** - Submeter, aprovar, rejeitar contratos
8. **Renovação Automática** - Sistema renova contratos automaticamente ao vencimento
9. **Reajuste Automático** - Sistema aplica reajustes por índices econômicos
10. **Alertas de Vencimento** - Notificações automáticas em 30/60/90 dias
11. **Relatórios Gerenciais** - Contratos ativos, a vencer, vencidos, análise de custos
12. **Histórico de Alterações** - Rastreamento completo de modificações
13. **Simulação de Reajuste** - Projetar valores futuros conforme índices
14. **Métricas de Performance** - KPIs de aprovação, renovação, aderência

---

## 5. REGRAS DE NEGÓCIO

### RN-CTR-023-01 — Validação de Vigência Contratual

**Descrição**: A data de término (DataFim) de um contrato deve ser sempre maior ou igual à data de início (DataInicio). Não é permitido criar ou atualizar contrato com datas inválidas. Validação ocorre antes de persistência.

**Justificativa**: Prevenir erros operacionais que resultariam em contratos com períodos inválidos ou impossíveis, comprometendo relatórios, cálculos de custo e auditoria.

**Critério de Aceite**:
- Campo DataFim ausente ou vazio → Rejeição HTTP 400
- DataFim <= DataInicio → Rejeição HTTP 400
- Vigência > 10 anos → Rejeição HTTP 400 (limite de segurança)
- Mensagem de erro clara e específica retornada ao usuário

**Exemplos**:
- ✅ Válido: DataInicio = 01/01/2025, DataFim = 31/12/2025 (364 dias)
- ❌ Inválido: DataInicio = 31/12/2025, DataFim = 01/01/2025 (negativo)
- ❌ Inválido: DataInicio = DataFim (zero dias de vigência)

---

### RN-CTR-023-02 — Cálculo Automático de Valor Mensal Proporcional

**Descrição**: Quando um contrato é criado, o sistema calcula automaticamente o valor mensal proporcional dividindo ValorTotal pela quantidade de meses da vigência (usando 30,44 dias/mês). Se usuário informar ValorMensal explícito, este prevalece e ValorTotal é recalculado para manter consistência.

**Justificativa**: Evitar erros de cálculo manual, garantir consistência entre valor total e valor mensal em toda gestão financeira e facilitar comparações de custo.

**Critério de Aceite**:
- ValorTotal informado, ValorMensal não → ValorMensal = ValorTotal / (meses de vigência)
- ValorMensal informado → ValorTotal recalculado proporcionalmente
- Valores negativos → Rejeição HTTP 400
- Arredondamento em 2 casas decimais

**Exemplos**:
- Contrato: ValorTotal = R$12.000, Vigência = 01/01/2025 a 31/12/2025 (12 meses) → ValorMensal = R$1.000
- Atualização: ValorMensal = R$1.100 → ValorTotal recalculado para R$13.200

---

### RN-CTR-023-03 — Renovação Automática de Contrato

**Descrição**: Contratos configurados com RenovacaoAutomatica = true são prolongados automaticamente por um novo período igual ao anterior quando a data de término é atingida. Um novo registro de contrato é criado com status "RenovacaoAutomatica" e o contrato anterior passa para status "Renovado".

**Justificativa**: Reduzir intervenções manuais em contratos de longa duração, garantir continuidade operacional sem gaps de cobertura e evitar suspensão de serviços críticos.

**Critério de Aceite**:
- Job background executa diariamente às 00:00 UTC
- Contrato com RenovacaoAutomatica = true e DataFim = hoje → Novo contrato criado
- Novo contrato: DataInicio = DataFim anterior + 1 dia, periodicidade mantida
- Contrato original: Status = "Renovado"
- Notificação enviada ao responsável (e-mail + SignalR)
- Auditoria completa registrada

**Exemplos**:
- Contrato válido até 31/12/2025, RenovacaoAutomatica = true, periodicidade = 365 dias
- Em 31/12/2025: Sistema cria novo contrato válido até 31/12/2026
- Status: Contrato original → "Renovado", Novo contrato → "RenovacaoAutomatica"

---

### RN-CTR-023-04 — Alertas Automáticos de Vencimento

**Descrição**: O sistema gera alertas automáticos (e-mail + SignalR em tempo real) para usuários responsáveis quando um contrato se aproxima do vencimento em 30, 60 ou 90 dias. Alertas são gravados na tabela AuditoriaAlerta para rastreamento e evitar duplicatas.

**Justificativa**: Notificar stakeholders com antecedência permite decisões proativas de renovação, renegociação ou encerramento, evitando gaps de serviço.

**Critério de Aceite**:
- Job background executa diariamente às 00:00 UTC
- Alertas gerados em 30, 60 e 90 dias antes do vencimento
- Apenas um alerta por período (verificação de duplicatas)
- E-mail assíncrono enviado ao responsável
- Notificação SignalR em tempo real no dashboard
- Auditoria com código CTR_CONTRATO_ALERTA_VENCIMENTO

**Exemplos**:
- Contrato com DataFim = 31/01/2025
- Alertas enviados em: 02/12/2024 (60 dias), 02/01/2025 (30 dias)
- Cada alerta registrado na auditoria para rastreamento

---

### RN-CTR-023-05 — Workflow de Aprovação por Alçada de Valor

**Descrição**: Contratos são submetidos a workflow de aprovação baseado em faixas de valor configuráveis. State-machine: Rascunho → PendenteAprovacao → Aprovado/Rejeitado. Cada nível de aprovação (Gestor, Jurídico, Diretoria) valida regras específicas de alçada e registra auditoria.

**Justificativa**: Garantir controle gerencial, segregação de responsabilidades conforme políticas corporativas e conformidade com limites de autorização.

**Critério de Aceite**:
- Apenas contratos em status "Rascunho" podem ser submetidos
- Alçada determinada pelo valor do contrato
- Sistema identifica próximo aprovador automaticamente
- Notificação enviada ao aprovador (e-mail + SignalR)
- Aprovação/Rejeição registra timestamp, usuário, justificativa
- Tentativa de aprovação sem permissão → HTTP 403 Forbidden
- Auditoria completa de transições de estado

**Exemplos de Alçadas (configuráveis)**:
- Até R$5.000 → Gestor
- R$5.001 - R$50.000 → Jurista
- Acima de R$50.000 → Diretor/CFO

**Transições de Estado**:
- Rascunho → PendenteAprovacao (ação: Submeter)
- PendenteAprovacao → Aprovado (ação: Aprovar com permissão)
- PendenteAprovacao → Rejeitado (ação: Rejeitar com justificativa)

---

### RN-CTR-023-06 — Bloqueio de Exclusão com Medições Associadas

**Descrição**: Um contrato não pode ser excluído (soft delete) se possuir medições ou faturas associadas (FK em RF090). O sistema retorna erro HTTP 409 Conflict informando quantidade exata de medições bloqueando a exclusão.

**Justificativa**: Garantir integridade referencial e auditoria. Medições precisam manter vínculo com contrato original para rastreabilidade financeira e conformidade legal.

**Critério de Aceite**:
- Verificação de medições antes de exclusão
- Contrato com medições → HTTP 409 Conflict
- Mensagem de erro clara indicando quantidade de medições e valor total
- Sugestão de ação: excluir medições primeiro ou contatar suporte
- Contrato sem medições → Soft delete executado normalmente

**Exemplos**:
- ✅ Exclusão bem-sucedida: Contrato sem medições
- ❌ Bloqueado: Contrato com 5 medições (erro: "Não é possível excluir contrato com 5 medição(ões) associada(s). Valor total: R$10.500,00")

---

### RN-CTR-023-07 — Controle de Reajuste por Índice Econômico

**Descrição**: Contratos podem ter reajustes automáticos anuais conforme índice econômico (IGPM, IPCA, INPC, etc). O reajuste é calculado na data de aniversário (data de início) e aplicado ao ValorMensal e ValorTotal. Histórico de reajustes é registrado em tabela de auditoria.

**Justificativa**: Adequar valores contratuais à inflação e índices econômicos, conforme práticas comerciais e legislação. Garante revisão periódica automática.

**Critério de Aceite**:
- Job background executa diariamente às 00:00 UTC
- Contratos com IndiceReajuste configurado e data aniversário = hoje → Reajuste aplicado
- Percentual do índice obtido de serviço externo ou tabela de índices
- ValorMensal e ValorTotal atualizados proporcionalmente
- Histórico registrado: valor anterior, novo valor, percentual, índice, data
- Notificação enviada ao responsável (e-mail + SignalR)
- Auditoria com código CTR_CONTRATO_REAJUSTE

**Exemplos**:
- Contrato: IGPM, ValorMensal = R$1.000, data aniversário = 01/01
- IGPM janeiro = 0,5% (obtido do serviço de índices)
- Novo ValorMensal = R$1.005 (1.000 * 1,005)
- Novo ValorTotal recalculado proporcionalmente

---

### RN-CTR-023-08 — Validação de CNPJ do Fornecedor

**Descrição**: Todo contrato deve estar associado a um fornecedor válido (FK para RF022). O CNPJ do fornecedor é validado no momento da criação/edição do contrato. CNPJ inválido ou fornecedor inativo retorna erro de validação HTTP 400.

**Justificativa**: Garantir que contratos sejam celebrados apenas com fornecedores cadastrados, validados e ativos na empresa, evitando fraude e inconsistências.

**Critério de Aceite**:
- Fornecedor inexistente → HTTP 400 "Fornecedor não encontrado"
- Fornecedor inativo → HTTP 400 "Fornecedor [Nome] está inativo"
- CNPJ inválido (dígitos verificadores) → HTTP 400 "CNPJ inválido"
- Validação executada antes de criação/atualização do contrato

**Exemplos**:
- ✅ Válido: Fornecedor ABC LTDA com CNPJ 12.345.678/0001-90 (ativo e CNPJ válido)
- ❌ Inválido: Fornecedor XYZ (CNPJ 11.111.111/1111-11 = inválido)
- ❌ Inválido: Fornecedor inativo (IsAtivo = false)

---

### RN-CTR-023-09 — Multi-tenancy (ClienteId Obrigatório)

**Descrição**: Todos os contratos são isolados por ClienteId. Nenhuma operação (read, write, delete) pode ser realizada sem validação de ClienteId. Queries sempre filtram por ClienteId do usuário autenticado. Tentativa de acesso a contrato de outro cliente retorna HTTP 403 Forbidden.

**Justificativa**: Garantir isolamento total de dados entre clientes, atendendo requisitos de confidencialidade, LGPD, compliance e segregação de dados SaaS.

**Critério de Aceite**:
- Todas as queries incluem WHERE ClienteId = [ClienteId do usuário autenticado]
- Tentativa de acesso cruzado → HTTP 403 Forbidden
- Middleware valida ClienteId em todas as requisições
- Logs de segurança para tentativas de violação
- Repository layer força filtro automático por ClienteId

**Exemplos**:
- Cliente A (ClienteId: "aaa-111"): Vê apenas seus 10 contratos
- Cliente B (ClienteId: "bbb-222"): Vê apenas seus 15 contratos
- Tentativa de Cliente A acessar contrato de Cliente B: HTTP 403 Forbidden

---

### RN-CTR-023-10 — Soft Delete com Auditoria

**Descrição**: Contratos nunca são deletados fisicamente do banco. Ao excluir (soft delete), a coluna IsDeleted é marcada como true, DataDelecao é registrada com timestamp, DeletadoPor registra usuário e uma entrada de auditoria é criada. Queries padrão filtram IsDeleted = false automaticamente.

**Justificativa**: Manter auditoria completa e permitir recuperação de dados em caso de erros operacionais, requisito legal de retenção e compliance.

**Critério de Aceite**:
- DELETE nunca executa físico (no DELETE FROM)
- Soft delete marca IsDeleted = true, DataDelecao = timestamp UTC, DeletadoPor = usuário
- Auditoria registra snapshot completo do contrato antes da exclusão
- Queries padrão filtram WHERE IsDeleted = false
- Método específico para consultar contratos deletados (se necessário para admin)
- Possibilidade de restauração (reversão de soft delete)

**Exemplos**:
- Contrato excluído: IsDeleted = true, DataDelecao = 2025-12-30 10:30:45, DeletadoPor = "user-123"
- Auditoria registra: Quem deletou, quando, motivo, snapshot completo dos dados
- Relatórios automaticamente não mostram contratos deletados

---

## 6. ESTADOS DA ENTIDADE

| Estado | Descrição | Transições Permitidas |
|--------|-----------|----------------------|
| **Rascunho** | Contrato criado, não submetido para aprovação | → PendenteAprovacao (Submeter) |
| **PendenteAprovacao** | Aguardando aprovação conforme alçada | → Aprovado (Aprovar), → Rejeitado (Rejeitar) |
| **Aprovado** | Contrato aprovado, aguardando início de vigência | → Ativo (DataInicio atingida) |
| **Ativo** | Contrato em vigência ativa | → Vencido (DataFim atingida), → Cancelado (Cancelar) |
| **Vencido** | DataFim ultrapassada sem renovação | → Renovado (se RenovacaoAutomatica) |
| **Renovado** | Contrato foi renovado (novo contrato criado) | N/A (estado final) |
| **RenovacaoAutomatica** | Contrato criado por renovação automática | → Ativo (quando DataInicio chegar) |
| **Rejeitado** | Rejeitado no workflow de aprovação | → Rascunho (Reabrir) |
| **Cancelado** | Cancelado manualmente antes do término | N/A (estado final) |
| **Deletado** | Soft delete (IsDeleted = true) | N/A (estado final, recuperável) |

---

## 7. PERMISSÕES RBAC

| Permissão | Descrição | Perfis Autorizados |
|-----------|-----------|-------------------|
| `contratos:contratos:create` | Criar contrato | Gestor, Gerente Contrato, Admin |
| `contratos:contratos:read` | Visualizar contrato | Gestor, Gerente Contrato, Admin, Financeiro |
| `contratos:contratos:update` | Editar contrato | Gerente Contrato, Admin |
| `contratos:contratos:delete` | Excluir contrato | Admin |
| `contratos:contratos:approve` | Aprovar contrato | Gerente Contrato, Jurista, Diretor |
| `contratos:contratos:reject` | Rejeitar contrato | Gerente Contrato, Jurista, Diretor |
| `contratos:contratos:export` | Exportar relatório | Gerente Contrato, Admin, Financeiro |
| `contratos:anexos:upload` | Upload de anexo | Gerente Contrato, Admin |
| `contratos:anexos:read` | Visualizar anexo | Gestor, Gerente Contrato, Admin |
| `contratos:renovacao:criar` | Criar renovação | Gerente Contrato, Admin |

**Nota**: Perfis de aprovação são baseados em alçadas de valor configuráveis. Exemplo: Diretor aprova valores acima de R$100.000.

---

## 8. API ENDPOINTS

### 8.1 CRUD Principal

| Método | Endpoint | Descrição | Permissão | Status HTTP |
|--------|----------|-----------|-----------|-------------|
| GET | `/api/contratos` | Listar contratos com filtros | `contratos:contratos:read` | 200, 403 |
| GET | `/api/contratos/{id}` | Obter contrato por ID | `contratos:contratos:read` | 200, 403, 404 |
| POST | `/api/contratos` | Criar contrato | `contratos:contratos:create` | 201, 400, 403 |
| PUT | `/api/contratos/{id}` | Atualizar contrato | `contratos:contratos:update` | 200, 400, 403, 404 |
| DELETE | `/api/contratos/{id}` | Excluir contrato (soft delete) | `contratos:contratos:delete` | 204, 403, 404, 409 |
| GET | `/api/contratos/buscar` | Busca avançada com paginação | `contratos:contratos:read` | 200, 400 |

### 8.2 Operações Especiais

| Método | Endpoint | Descrição | Permissão | Status HTTP |
|--------|----------|-----------|-----------|-------------|
| POST | `/api/contratos/{id}/anexos` | Upload de anexo | `contratos:anexos:upload` | 201, 400, 403, 404 |
| GET | `/api/contratos/{id}/anexos` | Listar anexos | `contratos:anexos:read` | 200, 403, 404 |
| GET | `/api/contratos/{id}/anexos/{anexoId}` | Download de anexo | `contratos:anexos:read` | 200, 403, 404 |
| DELETE | `/api/contratos/{id}/anexos/{anexoId}` | Excluir anexo | `contratos:anexos:upload` | 204, 403, 404 |
| POST | `/api/contratos/{id}/aprovar` | Aprovar contrato | `contratos:contratos:approve` | 200, 400, 403, 404 |
| POST | `/api/contratos/{id}/rejeitar` | Rejeitar contrato | `contratos:contratos:reject` | 200, 400, 403, 404 |
| POST | `/api/contratos/{id}/renovar` | Renovar contrato | `contratos:renovacao:criar` | 201, 400, 403, 404 |
| GET | `/api/contratos/vencimentos` | Contratos próximos de vencer | `contratos:contratos:read` | 200, 400 |
| GET | `/api/contratos/export` | Exportar relatório (Excel/PDF) | `contratos:contratos:export` | 200, 400, 403 |
| GET | `/api/contratos/{id}/historico` | Histórico de alterações | `contratos:contratos:read` | 200, 403, 404 |
| POST | `/api/contratos/{id}/simular-reajuste` | Simular reajuste futuro | `contratos:contratos:read` | 200, 400, 403, 404 |
| GET | `/api/contratos/metricas` | Métricas gerenciais | `contratos:contratos:read` | 200, 403 |

---

## 9. INTEGRAÇÕES OBRIGATÓRIAS

### 9.1 Central de Funcionalidades (Feature Flags)

**FeatureKeys**:
- `CONTRATOS_GESTAO`: CRUD e operações básicas de contratos
- `CONTRATOS_WORKFLOW`: Workflow de aprovação por alçadas de valor
- `CONTRATOS_ALERTAS`: Alertas automáticos de vencimento (30/60/90 dias)
- `CONTRATOS_REAJUSTES`: Reajustes automáticos por índices econômicos (IGPM, IPCA, INPC)
- `CONTRATOS_RENOVACAO_AUTOMATICA`: Renovação automática de contratos ao vencimento

Todas as features devem estar habilitadas por padrão em HOM e PRD.

---

### 9.2 Internacionalização (i18n)

**Chaves de Tradução** (pt-BR, en-US, es-ES):

```json
{
    "contratos": {
        "gestao": {
            "title": "Gestão de Contratos",
            "description": "Administração de contratos com fornecedores e prestadores de serviço",
            "form": {
                "numero": "Número do Contrato",
                "fornecedor": "Fornecedor",
                "tipoContrato": "Tipo de Contrato",
                "descricao": "Descrição",
                "dataInicio": "Data de Início",
                "dataFim": "Data de Término",
                "valorTotal": "Valor Total",
                "valorMensal": "Valor Mensal",
                "moeda": "Moeda",
                "indiceReajuste": "Índice de Reajuste",
                "renovacaoAutomatica": "Renovação Automática",
                "status": "Status",
                "anexos": "Anexos"
            },
            "status": {
                "rascunho": "Rascunho",
                "pendenteAprovacao": "Pendente Aprovação",
                "aprovado": "Aprovado",
                "rejeitado": "Rejeitado",
                "ativo": "Ativo",
                "vencido": "Vencido",
                "renovado": "Renovado",
                "renovacaoAutomatica": "Renovação Automática",
                "cancelado": "Cancelado"
            },
            "tipoContrato": {
                "compra": "Compra",
                "locacao": "Locação",
                "manutencao": "Manutenção",
                "telecom": "Telecomunicações",
                "servico": "Serviço"
            },
            "messages": {
                "success": "Contrato salvo com sucesso",
                "error": "Erro ao salvar contrato",
                "delete": "Contrato excluído com sucesso",
                "deleteError": "Não é possível excluir contrato com medições associadas",
                "approval": "Contrato encaminhado para aprovação",
                "approved": "Contrato aprovado",
                "rejected": "Contrato rejeitado"
            },
            "validation": {
                "required": "Campo obrigatório",
                "dataFimGreaterThanDataInicio": "Data de término deve ser maior que data de início",
                "cnpjInvalid": "CNPJ do fornecedor é inválido",
                "fornecedorInativo": "Fornecedor está inativo"
            },
            "labels": {
                "criar": "Novo Contrato",
                "editar": "Editar Contrato",
                "visualizar": "Detalhes do Contrato",
                "excluir": "Excluir Contrato",
                "aprovar": "Aprovar Contrato",
                "rejeitar": "Rejeitar Contrato",
                "renovar": "Renovar Contrato",
                "anexos": "Anexos",
                "historico": "Histórico"
            },
            "alerts": {
                "vencimento30dias": "Contrato vencerá em 30 dias",
                "vencimento60dias": "Contrato vencerá em 60 dias",
                "vencimento90dias": "Contrato vencerá em 90 dias",
                "aguardandoAprovacao": "Contrato aguardando aprovação",
                "reajusteAplicado": "Reajuste aplicado ao contrato"
            }
        }
    }
}
```

---

### 9.3 Auditoria

**Operações Auditadas**:

| Operação | Código | Dados Registrados |
|----------|--------|-------------------|
| Criar contrato | `CTR_CONTRATO_CREATE` | ID, Número, Fornecedor, Datas, Valores, UsuarioId |
| Editar contrato | `CTR_CONTRATO_UPDATE` | ID, Campos alterados (before/after JSON), UsuarioId |
| Excluir contrato | `CTR_CONTRATO_DELETE` | ID, Número, Motivo da exclusão, DataDelecao, UsuarioId |
| Aprovar contrato | `CTR_CONTRATO_APPROVE` | ID, Aprovador, Nível de aprovação, DataAprovacao |
| Rejeitar contrato | `CTR_CONTRATO_REJECT` | ID, Motivo da rejeição, UsuarioId |
| Upload de anexo | `CTR_CONTRATO_ANEXO_UPLOAD` | ID contrato, Nome do anexo, Tamanho, CRC32 |
| Aplicar reajuste | `CTR_CONTRATO_REAJUSTE` | ID, Índice, Percentual, Valores antes/depois |
| Renovar contrato | `CTR_CONTRATO_RENOVACAO` | ID contrato original, ID contrato novo, Periodicidade |
| Gerar alerta | `CTR_CONTRATO_ALERTA_VENCIMENTO` | ID, Dias de antecedência, DestinatarioEmail |

**Retenção**: 7 anos (conforme legislação fiscal brasileira e LGPD)

---

## 10. SEGURANÇA

### 10.1 Proteções Implementadas

| Proteção | Descrição |
|----------|-----------|
| **Multi-tenancy Isolamento** | ClienteId validado em todos os endpoints; tentativas de acesso a outro cliente retorna HTTP 403 |
| **Validação de Entrada** | Todos os campos validados (tipo, tamanho, range); valores fora do esperado retornam HTTP 400 |
| **RBAC + Alçadas** | Permissões baseadas em perfil + alçadas de valor; aprovações bloqueadas se usuário sem permissão |
| **Soft Delete Auditado** | Exclusões nunca removem dados; IsDeleted + DataDelecao + auditoria sempre registradas |
| **SQL Injection Protection** | Queries parametrizadas; ORM (EF Core) com proteção built-in contra SQL injection |
| **XSS Prevention** | Inputs sanitizados no backend; encoding no Angular; Content-Security-Policy headers |
| **CSRF Protection** | Tokens CSRF obrigatórios em POST/PUT/DELETE; validação no middleware |
| **Auditoria Imutável** | Logs de auditoria gravados em tabela separada com timestamp e hash de integridade |
| **Criptografia de Dados Sensíveis** | CNPJ, dados de anexos, informações de garantia criptografados em repouso |
| **Rate Limiting** | Máximo 1000 requisições/hora por IP; proteção contra brute force e DoS |

### 10.2 Testes de Segurança Obrigatórios

- [ ] SQL Injection em campos: `/api/contratos?filtro=' OR 1=1 --`
- [ ] XSS em descrição: `<script>alert('XSS')</script>`
- [ ] CSRF: POST sem token CSRF
- [ ] Validação de permissões: Cliente A tenta acessar contrato de Cliente B
- [ ] Alçada não autorizada: Gestor tenta aprovar contrato de R$1.000.000
- [ ] Bypass de soft delete: Tentar referenciar contrato deletado
- [ ] Validação de CNPJ: CNPJ inválido deve ser rejeitado
- [ ] Datas inválidas: DataFim < DataInicio deve ser rejeitado
- [ ] Upload malicioso: Tentar upload de .exe disfarçado de .pdf
- [ ] Rate limiting: 1001+ requisições em uma hora devem ser bloqueadas

---

## 11. MÉTRICAS E INDICADORES

### 11.1 KPIs

| KPI | Meta | Medição |
|-----|------|---------|
| **Contratos Ativos** | Manter >= 80% dos contratos em status Aprovado/Ativo | Contagem mensal em dashboard |
| **Taxa de Aprovação** | >= 90% dos contratos aprovados em até 5 dias | Diferença (DataAprovacao - DataSubmissao) |
| **Alertas de Vencimento Enviados** | 100% dos contratos a vencer recebem alerta | Contagem de CTR_CONTRATO_ALERTA_VENCIMENTO |
| **Renovações Automáticas Sucesso** | >= 95% das renovações automáticas executadas com sucesso | Contagem de renovações bem-sucedidas / total |
| **Tempo Médio de Aprovação** | <= 3 dias por nível de aprovação | (DataAprovacao - DataSubmissao) / níveis |
| **Cobertura de Medições** | >= 80% dos contratos tem medições associadas | Contratos com FK em Medicao / total |
| **Aderência de Reajustes** | 100% dos reajustes automáticos aplicados conforme índice | Reajustes aplicados / reajustes esperados |
| **Integridade de Anexos** | 100% dos anexos com hash de integridade validado | Anexos com hash válido / total |
| **Conformidade de Vigência** | 0 contratos com DataFim inválida | Contratos com DataFim < DataInicio |
| **Taxa de Exclusão Bloqueada** | 100% das exclusões bloqueadas com motivo claro | Exclusões rejeitadas com RN-CTR-023-06 |

### 11.2 Alertas

| Alerta | Condição | Ação |
|--------|----------|------|
| **Contrato Vencido Não Renovado** | DataFim < Hoje E Status != Renovado E RenovacaoAutomatica = false | Notificar gestor (e-mail + SignalR) |
| **Reajuste Não Aplicado** | DataUltimoReajuste < (Hoje - 1 ano) E IndiceReajuste IS NOT NULL | Notificar admin, revisar configuração |
| **Anexo Corrompido** | Hash do anexo diferente ao download | Notificar admin, bloquear download |
| **Aprovação Travada** | PendenteAprovacao > 5 dias | Escalar para gerente direto |
| **Fornecedor Inativo** | Contrato associado a fornecedor com Ativo = false | Notificar gestor, bloquear renovação |
| **Valor Fora de Alçada** | Contrato criado com valor que viola alçada de aprovador | Bloquear submissão, exigir aprovador correto |
| **Multi-tenancy Violado** | Tentativa de acesso a contrato de outro ClienteId | Log de segurança, HTTP 403, notificar admin |
| **Taxa Limite Atingida** | > 1000 requisições por hora de um IP | Rate limiting: HTTP 429, IP bloqueado por 1 hora |

---

## PRÓXIMOS PASSOS

1. **Modelo de Dados**: Criar MD-RF023.md
2. **Casos de Uso**: Criar UC-RF023.md
3. **Workflow de Telas**: Criar WF-RF023.md
4. **User Stories**: Criar user-stories.yaml
5. **Implementação Backend**: Commands/Queries/Handlers/Controllers
6. **Implementação Frontend**: Componentes Angular/Telas/Rotas
7. **Testes Automatizados**: Unit tests, Integration tests, E2E (Playwright)
8. **Testes de Segurança**: SQL Injection, XSS, CSRF, Permissões
9. **Documentação de Testes**: TC-RF023-BACKEND.md, TC-RF023-FRONTEND.md
10. **Deploy em HOM**: Validação do ambiente de homologação

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 1.0 | 2025-12-28 | Versão inicial com 10 RNs, 13+ endpoints, fluxos, segurança e KPIs | Claude Code |
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0 (separação RF/RL completa, sem referências ao legado) | Claude Code |

---

**Última Atualização**: 2025-12-30
**Autor**: Claude Code - Agência ALC
**Revisão**: Pendente
