rf:
  id: RF097
  nome: Auditoria de Faturas (NF-e e Documentos Fiscais)
  versao: '2.0'
  data: '2025-12-31'
  fase: Fase 3 - Financeiro I - Base Contábil
  epic: EPIC006-FIN-Financeiro-Base
  status: em_desenvolvimento
descricao:
  objetivo: Permitir auditoria fiscal automatizada de Notas Fiscais Eletrônicas (NF-e),
    validação de integridade (assinatura digital, chave de acesso, status SEFAZ),
    detecção de fraudes (duplicatas, operações anômalas), conferência de impostos
    (ICMS, IPI, PIS, COFINS, ISS), e conformidade com SPED Fiscal (EFD-ICMS/IPI).
  problema_resolvido: Empresas perdem milhares de horas/mês em conferência manual
    de NF-e, SEFAZ, cálculo de impostos. Erros resultam em autuações fiscais. Fraudes
    (NF-e canceladas, duplicatas, fornecedores fictícios) passam sem detecção. Falta
    rastreabilidade e auditoria automatizada.
  publico_afetado: Auditores Fiscais, Contadores, Controllers, CFOs, Administradores,
    Gerentes Financeiros, Integrações Fiscais.
escopo:
  incluso:
  - Validação de integridade de chave de acesso NF-e (44 dígitos, módulo 11)
  - Consulta de status NF-e no SEFAZ via WebService
  - Validação de assinatura digital XML (certificado A1/A3)
  - Auditoria de impostos (ICMS, IPI, PIS, COFINS, ISS) conforme CFOP
  - Detecção de duplicatas (mesma chave, CNPJ duplicado no período)
  - Validação de retenções obrigatórias (IRRF, CSLL, ISS, INSS)
  - Conformidade SPED Fiscal (EFD-ICMS/IPI, apuração de ICMS)
  - Detecção de operações anômalas via Machine Learning (Azure ML)
  - Dashboard de KPIs fiscais (taxa de conformidade, tempo de auditoria, alertas críticos)
  - Alertas críticos (NF-e cancelada com movimentação, impostos divergentes, SEFAZ
    indisponível)
  - Geração de relatórios fiscais (Livro Fiscal, Apuração ICMS, Inconsistências)
  - Integração com Central de Funcionalidades (Feature Flags)
  fora:
  - Emissão de NF-e (escopo de RF032)
  - Conciliação bancária (escopo de RF089)
  - Parametrização de impostos (escopo de RF001)
  - Importação de XML de NF-e (escopo de RF086)
  - Geração de SPED Fiscal completo (escopo de RF específico de SPED)
entidades:
- nome: auditoria_fatura
  descricao: Auditoria fiscal de NF-e e documentos fiscais
  multi_tenant: true
  soft_delete: true
  auditoria: true
- nome: alerta_fiscal
  descricao: Alertas críticos gerados durante auditoria
  multi_tenant: true
  soft_delete: true
  auditoria: true
- nome: historico_auditoria
  descricao: Histórico de auditorias realizadas
  multi_tenant: true
  soft_delete: false
  auditoria: true
- nome: kpi_fiscal
  descricao: KPIs fiscais consolidados (taxas de conformidade, performance)
  multi_tenant: true
  soft_delete: false
  auditoria: true
regras_negocio:
- id: RN-AUF-097-001
  descricao: 'Validação Obrigatória de Chave de Acesso NF-e: toda NF-e importada ou
    registrada deve ter chave de acesso válida (44 dígitos numéricos), validada via
    algoritmo de verificação de dígito (módulo 11). Chaves inválidas são rejeitadas
    com erro HTTP 400.'
  tipo: validacao
  campos_afetados:
  - ChaveAcesso
  obrigatorio: true
  criticidade: CRITICA
  http_code: 400
  mensagem_erro: 'Chave de acesso inválida: {motivo}'
- id: RN-AUF-097-002
  descricao: 'Consulta Obrigatória de Status SEFAZ para NF-e Autorizada: ao validar
    NF-e com status ''Autorizada'', o sistema deve consultar a situação atual no WebService
    SEFAZ. Se a NF-e estiver cancelada ou denegada no SEFAZ, um alerta crítico é gerado
    e a auditoria falha.'
  tipo: regra_negocio
  campos_afetados:
  - StatusSEFAZ
  - DataConsultaSEFAZ
  obrigatorio: true
  criticidade: CRITICA
  http_code: 200
  mensagem_erro: 'Status SEFAZ divergente: NF-e autorizada localmente mas {status}
    no SEFAZ'
- id: RN-AUF-097-003
  descricao: 'Validação de Alíquota ICMS Conforme CFOP: cada CFOP possui alíquotas
    padrão de ICMS conforme legislação estadual. O sistema valida se a alíquota aplicada
    na NF-e está dentro do range esperado (±2%). Divergências superiores geram alerta.'
  tipo: validacao
  campos_afetados:
  - CFOP
  - AliquotaICMS
  obrigatorio: true
  criticidade: IMPORTANTE
  http_code: 200
  mensagem_erro: 'Alíquota ICMS divergente para CFOP {cfop}: esperado {esperado}%,
    encontrado {atual}%'
- id: RN-AUF-097-004
  descricao: 'Detecção de NF-e Cancelada com Movimentação Posterior: se uma NF-e foi
    cancelada no SEFAZ, mas há registros de movimentação financeira, estoque ou contábil
    posteriores à data de cancelamento, um alerta crítico é gerado indicando inconsistência.'
  tipo: seguranca
  campos_afetados:
  - DataCancelamento
  - MovimentacoesPosteriores
  obrigatorio: true
  criticidade: CRITICA
  http_code: 200
  mensagem_erro: 'NF-e cancelada com movimentação posterior: {detalhes}'
- id: RN-AUF-097-005
  descricao: 'Validação de Integridade de Assinatura Digital (XML NF-e): toda NF-e
    em XML deve ter assinatura digital válida (certificado A1/A3). O sistema valida:
    (1) certificado não expirado, (2) cadeia de certificação válida, (3) assinatura
    XML íntegra. Falhas rejeitam a NF-e.'
  tipo: seguranca
  campos_afetados:
  - AssinaturaDigital
  - CertificadoA1A3
  obrigatorio: true
  criticidade: CRITICA
  http_code: 400
  mensagem_erro: 'Assinatura digital inválida: {motivo}'
- id: RN-AUF-097-006
  descricao: 'Validação de Base de Cálculo e Impostos: o sistema recalcula a base
    de cálculo de ICMS, IPI, PIS, COFINS, ISS conforme regras do CFOP e compara com
    os valores declarados na NF-e. Divergências superiores a R$ 0,10 geram alerta.'
  tipo: validacao
  campos_afetados:
  - BaseCalculoICMS
  - BaseCalculoIPI
  - ValorICMS
  - ValorIPI
  - ValorPIS
  - ValorCOFINS
  - ValorISS
  obrigatorio: true
  criticidade: CRITICA
  http_code: 200
  mensagem_erro: 'Base de cálculo divergente para imposto {imposto}: esperado R$ {esperado},
    encontrado R$ {atual}'
- id: RN-AUF-097-007
  descricao: 'Detecção de Duplicatas (Mesma Chave ou CNPJ Duplicado): o sistema detecta:
    (1) duas NF-e com mesma chave de acesso, (2) mesmo CNPJ emitindo múltiplas NF-e
    com mesma numeração no mesmo mês. Ambas situações geram alerta crítico de possível
    fraude.'
  tipo: unicidade
  campos_afetados:
  - ChaveAcesso
  - CNPJ
  - Numero
  - Serie
  - MesEmissao
  obrigatorio: true
  criticidade: CRITICA
  http_code: 200
  mensagem_erro: 'Duplicata detectada: {detalhes}'
- id: RN-AUF-097-008
  descricao: 'Validação de Conformidade SPED Fiscal (EFD-ICMS/IPI): toda NF-e de entrada/saída
    deve ser escriturada no SPED Fiscal (EFD-ICMS/IPI). O sistema valida se há registro
    correspondente no SPED Fiscal e se os valores batem (ICMS, IPI). Divergências
    geram alerta de não conformidade.'
  tipo: regra_negocio
  campos_afetados:
  - RegistroSPED
  - ValorICMSSPED
  - ValorIPISPED
  obrigatorio: true
  criticidade: CRITICA
  http_code: 200
  mensagem_erro: 'Divergência SPED Fiscal: {detalhes}'
- id: RN-AUF-097-009
  descricao: 'Validação de Retenções Obrigatórias (IRRF, CSLL, ISS, INSS): para NF-e
    de serviços (CFOP 5.933, 6.933), o sistema valida se as retenções obrigatórias
    foram aplicadas conforme legislação (IRRF 1,5%, CSLL 1%, ISS conforme município,
    INSS 11%). Ausência de retenção obrigatória gera alerta.'
  tipo: validacao
  campos_afetados:
  - CFOP
  - ValorIRRF
  - ValorCSLL
  - ValorISS
  - ValorINSS
  obrigatorio: true
  criticidade: IMPORTANTE
  http_code: 200
  mensagem_erro: 'Retenção obrigatória ausente: {imposto} não retido para CFOP {cfop}'
- id: RN-AUF-097-010
  descricao: 'Detecção de Operações Anômalas via Machine Learning: o sistema utiliza
    modelo Azure ML treinado com histórico de NF-e para detectar anomalias (valores
    fora do padrão do fornecedor, horários incomuns de emissão, NCM incompatível com
    histórico). Score de anomalia > 0.75 gera alerta de possível fraude.'
  tipo: seguranca
  campos_afetados:
  - ValorTotal
  - DataEmissao
  - NCM
  - CNPJEmitente
  - ScoreAnomaliaML
  obrigatorio: false
  criticidade: IMPORTANTE
  http_code: 200
  mensagem_erro: 'Operação anômala detectada: score {score}, motivo: {motivo}'
estados:
- id: pending
  descricao: Auditoria criada, aguardando processamento
- id: in_progress
  descricao: Auditoria em andamento (validações sendo executadas)
- id: completed_success
  descricao: Auditoria concluída com sucesso (100% conformidade)
- id: completed_with_warnings
  descricao: Auditoria concluída com alertas (conformidade parcial)
- id: completed_with_errors
  descricao: Auditoria concluída com erros críticos (não conforme)
- id: failed
  descricao: Auditoria falhou (erro técnico, SEFAZ indisponível)
- id: cancelled
  descricao: Auditoria cancelada pelo usuário
transicoes:
  permitidas:
  - de: pending
    para: in_progress
  - de: in_progress
    para: completed_success
  - de: in_progress
    para: completed_with_warnings
  - de: in_progress
    para: completed_with_errors
  - de: in_progress
    para: failed
  - de: pending
    para: cancelled
  - de: in_progress
    para: cancelled
  proibidas:
  - de: completed_success
    para: pending
  - de: completed_with_warnings
    para: pending
  - de: completed_with_errors
    para: pending
  - de: failed
    para: pending
  - de: cancelled
    para: in_progress
permissoes:
- codigo: fin:auditoria:read
  descricao: Visualizar auditorias de faturas
  roles:
  - Auditor
  - Contador
  - CFO
  - Admin
- codigo: fin:auditoria:create
  descricao: Iniciar auditoria de NF-e
  roles:
  - Auditor
  - CFO
  - Admin
- codigo: fin:auditoria:sefaz
  descricao: Consultar status SEFAZ de NF-e
  roles:
  - Auditor
  - Admin
  - IntegracaoFiscal
- codigo: fin:auditoria:alertas:resolve
  descricao: Resolver alertas críticos de auditoria
  roles:
  - Auditor
  - CFO
  - Admin
- codigo: fin:auditoria:relatorios
  descricao: Gerar relatórios fiscais (Livro Fiscal, Apuração ICMS)
  roles:
  - Contador
  - CFO
  - Admin
- codigo: fin:auditoria:export
  descricao: Exportar dados de auditoria (CSV, Excel, PDF)
  roles:
  - Contador
  - CFO
  - Admin
integracoes:
  internas:
  - Autenticacao (JWT Bearer Token)
  - Multi-Tenancy (EmpresaId)
  - Auditoria (AuditInterceptor)
  - i18n (Transloco - pt-BR, en, es)
  - Central de Funcionalidades (Feature Flags)
  externas:
  - sistema: SEFAZ (Secretaria da Fazenda)
    tipo: WebService SOAP
    obrigatoria: true
    descricao: Consulta de status de NF-e autorizada
  - sistema: Azure ML (Machine Learning)
    tipo: API REST
    obrigatoria: false
    descricao: Detecção de operações anômalas via ML
  - sistema: RF032 - Notas Fiscais Eletrônicas
    tipo: API REST interna
    obrigatoria: true
    descricao: Acesso a dados de NF-e importadas
  - sistema: RF001 - Parâmetros e Configurações
    tipo: API REST interna
    obrigatoria: true
    descricao: Parâmetros de impostos, alíquotas ICMS
  - sistema: RF089 - Conciliação Bancária e Financeira
    tipo: API REST interna
    obrigatoria: false
    descricao: Verificação de movimentações financeiras
  - sistema: Hangfire (Background Jobs)
    tipo: Framework .NET
    obrigatoria: true
    descricao: Agendamento de auditorias em lote
seguranca:
  isolamento_tenant: true
  auditoria_obrigatoria: true
  soft_delete: true
  validacao_assinatura_digital: true
  validacao_certificado_a1_a3: true
rastreabilidade:
  ucs_esperados:
  - UC00
  - UC01
  - UC02
  - UC03
  - UC04
catalog:
  crud:
  - id: RF-CRUD-01
    title: Criar auditoria de NF-e
    required: true
    endpoint: POST /api/auditoria-faturas
  - id: RF-CRUD-02
    title: Listar auditorias (paginadas)
    required: true
    endpoint: GET /api/auditoria-faturas
  - id: RF-CRUD-03
    title: Visualizar auditoria por ID
    required: true
    endpoint: GET /api/auditoria-faturas/{id}
  - id: RF-CRUD-04
    title: Atualizar resultado de auditoria
    required: true
    endpoint: PUT /api/auditoria-faturas/{id}
  - id: RF-CRUD-05
    title: Deletar auditoria
    required: true
    endpoint: DELETE /api/auditoria-faturas/{id}
  validacoes:
  - id: RF-VAL-01
    title: Validar chave de acesso NF-e (44 dígitos, módulo 11)
    required: true
    regra: RN-AUF-097-001
  - id: RF-VAL-02
    title: Validar assinatura digital XML (certificado A1/A3)
    required: true
    regra: RN-AUF-097-005
    endpoint: POST /api/auditoria-faturas/{id}/validar-assinatura
  - id: RF-VAL-03
    title: Validar base de cálculo e impostos (ICMS, IPI, PIS, COFINS, ISS)
    required: true
    regra: RN-AUF-097-006
  - id: RF-VAL-04
    title: Validar alíquota ICMS conforme CFOP
    required: true
    regra: RN-AUF-097-003
  - id: RF-VAL-05
    title: Validar retenções obrigatórias (IRRF, CSLL, ISS, INSS)
    required: true
    regra: RN-AUF-097-009
  - id: RF-VAL-06
    title: Detectar duplicatas (mesma chave ou CNPJ duplicado)
    required: true
    regra: RN-AUF-097-007
  seguranca:
  - id: RF-SEC-01
    title: Isolamento de tenant (EmpresaId)
    required: true
  - id: RF-SEC-02
    title: Permissões RBAC (6 permissões fiscais)
    required: true
  - id: RF-SEC-03
    title: Detecção de NF-e cancelada com movimentação posterior
    required: true
    regra: RN-AUF-097-004
  - id: RF-SEC-04
    title: Detecção de operações anômalas via Machine Learning
    required: false
    regra: RN-AUF-097-010
  operacoes_especiais:
  - id: RF-OP-01
    title: Consultar status SEFAZ de NF-e autorizada
    required: true
    regra: RN-AUF-097-002
    endpoint: POST /api/auditoria-faturas/{id}/consultar-sefaz
  - id: RF-OP-02
    title: Validar conformidade SPED Fiscal (EFD-ICMS/IPI)
    required: true
    regra: RN-AUF-097-008
  - id: RF-OP-03
    title: Listar alertas críticos de auditoria
    required: true
    endpoint: GET /api/auditoria-faturas/{id}/alertas
  - id: RF-OP-04
    title: Resolver alerta crítico
    required: true
    endpoint: POST /api/auditoria-faturas/alertas/{alertaId}/resolver
  - id: RF-OP-05
    title: Gerar relatório Livro Fiscal
    required: true
    endpoint: GET /api/auditoria-faturas/relatorios/livro-fiscal
  - id: RF-OP-06
    title: Gerar relatório Apuração ICMS
    required: true
    endpoint: GET /api/auditoria-faturas/relatorios/apuracao-icms
  - id: RF-OP-07
    title: Dashboard de KPIs fiscais
    required: true
    endpoint: GET /api/auditoria-faturas/dashboard
  - id: RF-OP-08
    title: Exportar dados de auditoria (CSV, Excel, PDF)
    required: true
    endpoint: POST /api/auditoria-faturas/exportar
exclusions:
  rf_items:
  - Emissão de NF-e (escopo de RF032)
  - Conciliação bancária (escopo de RF089)
  - Parametrização de impostos (escopo de RF001)
  - Importação de XML de NF-e (escopo de RF086)
  - Geração de SPED Fiscal completo
kpis:
- id: KPI-AUF-01
  nome: Taxa de Conformidade Fiscal
  descricao: Percentual de NF-e aprovadas sem alertas críticos
  formula: (NF-e sem alertas / Total NF-e auditadas) × 100
  meta: ≥ 95%
  frequencia: Diária
- id: KPI-AUF-02
  nome: Tempo Médio de Auditoria
  descricao: Tempo médio para auditar uma NF-e (validações + SEFAZ + impostos)
  formula: SUM(tempo_auditoria) / COUNT(auditorias)
  meta: ≤ 30 segundos
  frequencia: Diária
- id: KPI-AUF-03
  nome: Taxa de Detecção de Fraudes
  descricao: Percentual de NF-e fraudulentas detectadas (duplicatas + canceladas +
    ML)
  formula: (Fraudes detectadas / Total NF-e auditadas) × 100
  meta: 100% detecção
  frequencia: Mensal
- id: KPI-AUF-04
  nome: Taxa de Disponibilidade SEFAZ
  descricao: Percentual de sucesso em consultas ao WebService SEFAZ
  formula: (Consultas SEFAZ sucesso / Total consultas SEFAZ) × 100
  meta: ≥ 98%
  frequencia: Diária
- id: KPI-AUF-05
  nome: Taxa de Conformidade SPED Fiscal
  descricao: Percentual de NF-e com escrituração correta no SPED Fiscal
  formula: (NF-e conformes SPED / Total NF-e auditadas) × 100
  meta: ≥ 100%
  frequencia: Mensal
- id: KPI-AUF-06
  nome: Alertas Críticos Resolvidos
  descricao: Percentual de alertas críticos resolvidos em < 24h
  formula: (Alertas resolvidos < 24h / Total alertas críticos) × 100
  meta: ≥ 90%
  frequencia: Diária
- id: KPI-AUF-07
  nome: Economia com Detecção de Erros
  descricao: Valor economizado com detecção de erros fiscais antes da autuação
  formula: SUM(valor_multa_evitada)
  meta: R$ 50.000/mês
  frequencia: Mensal
alertas_criticos:
- id: ALERT-AUF-01
  nome: NF-e Cancelada com Movimentação Posterior
  descricao: NF-e foi cancelada no SEFAZ mas há registros de movimentação financeira/estoque/contábil
    posteriores
  severidade: CRITICA
  regra: RN-AUF-097-004
  acao: Bloqueio automático de movimentações + notificação CFO/Auditor
- id: ALERT-AUF-02
  nome: Duplicata de NF-e Detectada
  descricao: Duas NF-e com mesma chave de acesso ou mesmo CNPJ com numeração duplicada
  severidade: CRITICA
  regra: RN-AUF-097-007
  acao: Bloqueio de pagamento + notificação CFO/Auditor
- id: ALERT-AUF-03
  nome: Impostos Divergentes (> R$ 100)
  descricao: Valor calculado de ICMS/IPI/PIS/COFINS diverge da NF-e em mais de R$
    100
  severidade: CRITICA
  regra: RN-AUF-097-006
  acao: Retenção de pagamento + auditoria manual obrigatória
- id: ALERT-AUF-04
  nome: SEFAZ Indisponível (> 1h)
  descricao: WebService SEFAZ está indisponível por mais de 1 hora, impossibilitando
    validação de status
  severidade: IMPORTANTE
  regra: RN-AUF-097-002
  acao: Notificação IntegracaoFiscal + fallback para validação local
- id: ALERT-AUF-05
  nome: Assinatura Digital Inválida
  descricao: NF-e possui assinatura digital inválida (certificado expirado, cadeia
    quebrada)
  severidade: CRITICA
  regra: RN-AUF-097-005
  acao: Bloqueio de importação + notificação Contador
- id: ALERT-AUF-06
  nome: Operação Anômala Detectada (ML Score > 0.75)
  descricao: Azure ML detectou anomalia (valor fora do padrão, horário incomum, NCM
    incompatível)
  severidade: IMPORTANTE
  regra: RN-AUF-097-010
  acao: Marcação para auditoria manual + notificação Auditor
- id: ALERT-AUF-07
  nome: Divergência SPED Fiscal
  descricao: NF-e não possui registro correspondente no SPED Fiscal ou valores divergem
  severidade: CRITICA
  regra: RN-AUF-097-008
  acao: Bloqueio de fechamento contábil + notificação Contador
central_funcionalidades:
  feature_flags:
  - codigo: fin:auditoria:ml_detection
    nome: Detecção de Fraudes via Machine Learning
    descricao: Habilitar detecção de operações anômalas via Azure ML
    padrao: false
  - codigo: fin:auditoria:sefaz_realtime
    nome: Consulta SEFAZ em Tempo Real
    descricao: Consultar status SEFAZ em tempo real (true) ou em lote (false)
    padrao: true
  - codigo: fin:auditoria:sped_validation
    nome: Validação SPED Fiscal
    descricao: Validar conformidade com SPED Fiscal (EFD-ICMS/IPI)
    padrao: true
  - codigo: fin:auditoria:auto_alerts
    nome: Alertas Automáticos
    descricao: Enviar alertas automáticos via email/SMS quando anomalias forem detectadas
    padrao: true
dependencias:
  upstream:
  - rf: RF032
    descricao: Notas Fiscais Eletrônicas (fonte de dados de NF-e)
    obrigatoria: true
  - rf: RF001
    descricao: Parâmetros e Configurações (alíquotas ICMS, regras CFOP)
    obrigatoria: true
  - rf: RF089
    descricao: Conciliação Bancária e Financeira (verificação de movimentações)
    obrigatoria: false
  downstream:
  - rf: RF-CONTABIL-XXX
    descricao: Sistema Contábil (consumidor de relatórios fiscais)
    obrigatoria: false
  externas:
  - sistema: SEFAZ
    descricao: WebService SEFAZ para consulta de status NF-e
    obrigatoria: true
  - sistema: Azure ML
    descricao: Azure Machine Learning para detecção de fraudes
    obrigatoria: false
  - sistema: Hangfire
    descricao: Framework de background jobs para auditorias em lote
    obrigatoria: true
historico:
- versao: '2.0'
  data: '2025-12-31'
  autor: Agência ALC - alc.dev.br
  descricao: Versão 2.0 - Separação total RF/RL (Governance v2.0). Contrato funcional
    moderno sem legado. 10 regras de negócio em linguagem natural, 7 KPIs, 7 alertas
    críticos, integração SEFAZ + Azure ML + SPED Fiscal.
- versao: '1.0'
  data: 2024-XX-XX
  autor: Equipe IControlIT
  descricao: Versão inicial com conteúdo legado misturado (VB.NET, ASPX, stored procedures).
