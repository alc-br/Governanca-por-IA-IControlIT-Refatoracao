# RF-024: Gestão de Departamentos e Estrutura Organizacional

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC006-FIN - Financeiro Base
**Fase**: Fase 3 - Financeiro I - Base Contábil

---

## 1. OBJETIVO DO REQUISITO

Fornecer CRUD completo de departamentos organizacionais do IControlIT v2 com hierarquia multinível ilimitada, gestão de líderes, lotação de colaboradores com estrutura matricial (dotted-line), organograma visual interativo, sincronização automática com Azure AD, workflow de movimentações interdepartamentais, e analytics de força de trabalho.

Este documento define **o que o sistema deve fazer** em relação à gestão de departamentos, sob quais condições e quais garantias devem ser preservadas.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Criação de departamentos com hierarquia recursiva ilimitada
- [x] Atualização de departamentos e estrutura hierárquica
- [x] Listagem de departamentos com filtros e paginação
- [x] Exclusão lógica de departamentos (soft delete)
- [x] Gestão de líderes de departamento (FK Usuario válida)
- [x] Lotação de colaboradores com estrutura matricial (principal + dotted-line)
- [x] Organograma visual interativo (D3.js - zoom, pan, collapse/expand)
- [x] Sincronização automática com Azure AD (grupos de segurança)
- [x] Workflow de aprovação para movimentações interdepartamentais
- [x] Dashboard de headcount em tempo real (SignalR)
- [x] Analytics de turnover departamental
- [x] Validação de referências circulares na hierarquia
- [x] Controle de acesso e isolamento por tenant
- [x] Auditoria completa de operações (change tracking)

### 2.2 Fora do escopo (não objetivos)

- Gestão de folha de pagamento (RF-FIN-002)
- Avaliações de desempenho (RF-RH-001)
- Gestão de férias (RF-RH-002)
- Ponto eletrônico detalhado (RF-RH-003)
- Interface visual específica (wireframes em WF-RF024.md)
- Estratégia de deploy ou infraestrutura

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-----|---------|
| Departamento | Unidade organizacional da empresa com hierarquia recursiva |
| Hierarquia Recursiva | Estrutura de árvore com self-referencing (Id_Departamento_Pai) |
| Nível Hierárquico | Profundidade na árvore (1=Raiz, 2=Filho, 3=Neto, etc.) |
| Líder | Usuário responsável pelo departamento (FK Usuario) |
| Lotação Principal | Alocação 100% do colaborador em um departamento |
| Dotted-Line | Alocação parcial em departamento secundário (estrutura matricial) |
| Movimentação | Transferência de colaborador entre departamentos com workflow |
| Headcount | Quantidade de colaboradores lotados em um departamento |
| Span of Control | Número de subordinados diretos por líder (ideal 5-10) |
| Turnover | Taxa de rotatividade do departamento (Saídas / Headcount Médio) |

---

## 4. FUNCIONALIDADES COBERTAS

1. Criar departamento com hierarquia recursiva
2. Atualizar departamento e mover na hierarquia
3. Consultar departamento por ID
4. Listar departamentos com filtros (tipo, nível, líder)
5. Excluir departamento logicamente (soft delete)
6. Obter organograma completo (DTO recursivo)
7. Alocar colaborador em departamento (principal ou dotted-line)
8. Criar movimentação interdepartamental
9. Aprovar movimentação (líder origem → líder destino → RH)
10. Sincronizar com Azure AD (criar grupos, adicionar membros)
11. Obter dashboard de headcount em tempo real
12. Obter analytics de turnover departamental
13. Validar referências circulares na hierarquia
14. Exportar organograma (PNG, PDF, SVG)

---

## 5. REGRAS DE NEGÓCIO

### RN-RF024-001 — Código Departamento Único Alfanumérico

**Descrição**: Código departamento DEVE ser único por Fornecedor, formato alfanumérico [TIPO]-[NOME] 3-30 caracteres.

**Justificativa**: Garantir identificação única e padronizada de departamentos.

**Critério de Aceite**:
- Código deve seguir regex `^[A-Z]{3,5}-[A-Z0-9]{2,20}$`
- Exemplos válidos: "DIR-TI", "GER-DEV", "COORD-BACKEND"
- Tentativa de cadastro com código duplicado → HTTP 409 Conflict
- Backend valida unicidade por Fornecedor

**Validação**:
- FluentValidation: `RuleFor(x => x.CodigoDepartamento).Matches(@"^[A-Z]{3,5}-[A-Z0-9]{2,20}$")`
- Database constraint: UNIQUE (Codigo_Departamento, Id_Fornecedor)

---

### RN-RF024-002 — Hierarquia Multinível Ilimitada Self-Referencing

**Descrição**: Sistema suporta hierarquia recursiva ilimitada através de self-referencing FK `Id_Departamento_Pai`.

**Justificativa**: Permitir estruturas organizacionais complexas sem limitação de níveis.

**Critério de Aceite**:
- Campo `Id_Departamento_Pai` nullable (NULL = departamento raiz)
- Níveis típicos: 1=Diretoria, 2=Gerência, 3=Coordenação, 4+=Equipes
- Campo `Nivel_Hierarquia` calculado automaticamente (trigger CTE recursivo)
- Campo `Caminho_Hierarquico` atualizado automaticamente (ex: "/DIR-TI/GER-DEV/COORD-BACKEND")

**Implementação**:
- EF Core: `HasOne(d => d.DepartamentoPai).WithMany(d => d.DepartamentosFilhos).HasForeignKey(d => d.IdDepartamentoPai)`
- Trigger: `trg_Departamento_AtualizarCaminhoHierarquico` (After INSERT/UPDATE)
- View: `VW_Departamento_Hierarquia_Completa` (CTE recursivo para organograma)

---

### RN-RF024-003 — Validação Referências Circulares Hierarquia

**Descrição**: Sistema DEVE detectar e bloquear loops infinitos na hierarquia (ex: A → B → C → A).

**Justificativa**: Prevenir inconsistências e erros de processamento na árvore hierárquica.

**Critério de Aceite**:
- Algoritmo de detecção usa HashSet visitados
- Percorre `Id_Departamento_Pai` recursivamente
- Se encontrar mesmo ID novamente → loop detectado
- Retornar HTTP 422 Unprocessable Entity "Referência circular detectada na hierarquia"

**Validação**:
- Executada em `CriarDepartamentoCommand` e `AtualizarDepartamentoCommand`
- Validação ANTES de salvar no banco

---

### RN-RF024-004 — Líder Obrigatório Usuário Válido FK

**Descrição**: Departamento ativo DEVE ter líder válido (FK Usuario). Campo `Id_Usuario_Lider` NOT NULL (exceto departamentos tipo "Equipe").

**Justificativa**: Garantir responsabilidade clara por cada departamento.

**Critério de Aceite**:
- Backend verifica se líder existe e está ativo
- Se líder inválido ou inativo → HTTP 422 "Líder inválido ou inativo"
- Ao designar líder, sistema concede permissão "Gestor" sobre subordinados
- Notificação multicanal enviada ao líder designado (email + push + SignalR)

---

### RN-RF024-005 — Sincronização Automática Azure AD Grupos Segurança

**Descrição**: Sistema sincroniza UNIDIRECIONAL IControlIT → Azure AD. Ao criar departamento, cria grupo Azure AD via Microsoft Graph API.

**Justificativa**: Manter consistência entre estrutura organizacional e grupos de segurança corporativos.

**Critério de Aceite**:
- Job Hangfire executa diário às 03:00 BRT (Cron "0 3 * * *")
- Sincronização sob demanda via POST `/api/v1/departamentos/{id}/sincronizar-azuread`
- Ações: criar grupo, adicionar membros, atualizar displayName/description
- Armazenar `Azure_AD_Object_Id`, `AD_Distinguished_Name`, `Dt_Ultima_Sincronizacao_AD`

**Implementação**:
- Microsoft Graph SDK .NET
- Autenticação: Client Credentials Flow
- Permissões: `Group.ReadWrite.All`, `User.Read.All`

---

### RN-RF024-006 — Movimentações Interdepartamentais Workflow Aprovação Multinível

**Descrição**: Transferências de colaboradores exigem aprovação multinível sequencial: (1) Líder Origem, (2) Líder Destino, (3) RH.

**Justificativa**: Controle e rastreabilidade de mudanças organizacionais.

**Critério de Aceite**:
- Status sequencial: Pendente → Aprovado_Origem → Aprovado_Destino → Aprovado_RH
- Notificações enviadas a cada etapa (email + push)
- Campo `Motivo` obrigatório (NVARCHAR(1000))
- Campo `Tipo_Movimentacao` enum: Transferencia/Promocao/Realocacao/Temporaria/Retorno
- Ao finalizar: atualiza `Usuario_Departamento`, `Qtd_Colaboradores`, sincroniza Azure AD

---

### RN-RF024-007 — Dotted-Line Múltiplos Departamentos Soma ≤100%

**Descrição**: Colaborador pode ter lotação em múltiplos departamentos: (1) Principal = 100%, (2) Dotted-Line = parcial, (3) Temporária = com Dt_Fim.

**Justificativa**: Suportar estrutura matricial moderna e projetos temporários.

**Critério de Aceite**:
- Validação: SUM(Percentual_Alocacao) WHERE Fl_Ativo=1 <= 100
- Trigger: `trg_Usuario_Departamento_ValidarAlocacao` (After INSERT/UPDATE)
- Se soma > 100% → ROLLBACK "Soma de alocações excede 100%"
- Constraint: UNIQUE (Id_Usuario, Tipo_Lotacao='Principal', Fl_Ativo=1)

**Campos**:
- `Tipo_Lotacao`: enum Principal/DottedLine/Temporaria
- `Percentual_Alocacao`: DECIMAL(5,2) CHECK (>0 AND <=100)
- `Dt_Inicio`: DATE obrigatório
- `Dt_Fim`: DATE nullable (NULL = vigente)

---

### RN-RF024-008 — Atualização Automática Qtd_Colaboradores Trigger

**Descrição**: Campo `Qtd_Colaboradores` atualizado automaticamente por trigger After INSERT/UPDATE/DELETE em `Usuario_Departamento`.

**Justificativa**: Manter contador sincronizado sem dependência de aplicação.

**Critério de Aceite**:
- Cálculo: COUNT(*) WHERE Tipo_Lotacao='Principal' AND Fl_Ativo=1
- Trigger: `trg_Usuario_Departamento_AtualizarQtdColaboradores`
- Atualiza apenas departamentos afetados (inserted/deleted)
- Campo calculado `Span_Of_Control` AS (Qtd_Colaboradores) PERSISTED

---

### RN-RF024-009 — Organograma Visual D3.js Interativo

**Descrição**: Frontend Angular renderiza organograma interativo usando D3.js v7 com funcionalidades avançadas.

**Justificativa**: Visualização clara e intuitiva da estrutura organizacional.

**Critério de Aceite**:
- Zoom: Mouse wheel / pinch mobile (scale 0.1x - 10x)
- Pan: Drag & drop canvas
- Collapse/Expand: Click nó colapsa/expande subárvore
- Busca: Destaca caminho hierárquico completo
- Filtro: Por tipo departamento (Diretoria, Gerencia, Coordenacao, Equipe)
- Export: PNG (canvas.toDataURL), PDF (jsPDF), SVG (d3.serialize)

**Backend**:
- Endpoint: GET `/api/v1/departamentos/organograma`
- Retorna DTO recursivo com Id, Nome, Tipo, Lider, QtdColaboradores, Children
- Cache Redis TTL 1h, invalidar ao criar/editar departamento

---

### RN-RF024-010 — Notificação Líder Nova Lotação Multicanal

**Descrição**: Líder recebe notificação quando colaborador alocado em seu departamento através de 3 canais.

**Justificativa**: Comunicação imediata e clara sobre mudanças na equipe.

**Critério de Aceite**:
- Canais: Email, Push notification mobile, Inbox in-app
- Conteúdo: "João Silva foi alocado em seu departamento (TI > Desenvolvimento > Backend) em 01/11/2025 com 100% alocação"
- SignalR Hub `DepartamentoHub` broadcast evento `OnColaboradorAlocado`
- Dashboard líder atualiza contador headcount tempo real

**Implementação**:
- Domain event: `ColaboradorAlocadoEvent` via MediatR
- Handler: `NotificarLiderColaboradorAlocadoHandler`
- Service: `INotificationService` multicanal

---

### RN-RF024-011 — Dashboard Headcount Tempo Real SignalR

**Descrição**: Dashboard KPIs headcount por departamento atualizado tempo real via SignalR.

**Justificativa**: Visibilidade imediata de métricas organizacionais críticas.

**Critério de Aceite**:
- Métricas:
  - Headcount Atual: COUNT Tipo_Lotacao='Principal' AND Fl_Ativo=1
  - Headcount Orçado: Campo `Headcount_Orcado` em `Departamento_Meta`
  - Taxa Ocupação: (Atual / Orçado) * 100
  - Variação Mês Anterior: Atual - Mês Anterior
  - Projeção Próximo Trimestre: ML baseado em histórico
- Refresh: SignalR Hub `OnHeadcountAtualizado` após movimentações
- Frontend: Chart.js line chart 12 meses, gauge chart taxa ocupação
- Cores: Verde ≥90%, Amarelo 75-89%, Vermelho <75%

---

### RN-RF024-012 — Analytics Turnover Departamental

**Descrição**: Cálculo turnover (rotatividade) por departamento baseado em movimentações últimos 12 meses.

**Justificativa**: Identificar departamentos com alta rotatividade para ação preventiva.

**Critério de Aceite**:
- Fórmula: Turnover = (Saídas_Período / Headcount_Médio_Período) * 100
- Benchmark: Turnover saudável <10% ao ano (< 0.83% ao mês)
- Alertas: Se turnover >15% em trimestre → notificação RH + Diretor
- Dashboard: Bar chart comparativo todos departamentos, line chart evolução 12 meses

**Cálculo**:
- Saídas: COUNT Tipo_Movimentacao IN ('Transferencia', 'Desligamento') últimos 12 meses
- Headcount Médio: AVG(Qtd_Colaboradores) de `Departamento_Snapshot_Mensal` últimos 12 meses

---

### RN-RF024-013 — Relatório Movimentações Mensal RH Compliance

**Descrição**: Relatório consolidado movimentações interdepartamentais para RH compliance fiscal/trabalhista (eSocial, RAIS).

**Justificativa**: Atender exigências legais e auditoria trabalhista.

**Critério de Aceite**:
- Conteúdo: Transferências, promoções, realocações, temporárias por departamento
- Formato: Excel (EPPlus) com 4 abas
- Colunas: Colaborador, Matrícula, Origem, Destino, Data, Cargo Anterior, Cargo Novo, Motivo, Aprovadores
- Agendamento: Job Hangfire Cron "0 8 1 * *" (1º dia útil mês 08:00)
- Storage: Azure Blob Storage `relatorios-rh/{ano}/{mes}/movimentacoes-{ano}-{mes}.xlsx`
- Retenção: 7 anos compliance LGPD

---

### RN-RF024-014 — Integração Ponto Eletrônico Validar Presença Física

**Descrição**: Integração com sistema ponto eletrônico para validar presença física colaborador no local do departamento.

**Justificativa**: Identificar trabalho remoto não autorizado e alocação física incorreta.

**Critério de Aceite**:
- Colaborador bate ponto em local diferente de `Localizacao_Fisica` departamento → alerta
- Webhook: POST `/api/v1/departamentos/validar-presenca` com {idUsuario, localBatida, dtHora}
- Backend compara `localBatida` com `Localizacao_Fisica`
- Se diferente: cria `Alerta_Ponto` e notifica RH + Gestor
- Exceções: `Fl_Trabalho_Remoto=1` ou `Tipo_Lotacao='Temporaria'` não geram alerta

---

### RN-RF024-015 — Versionamento Estrutura Organizacional Change Tracking

**Descrição**: Tabela `Departamento_Historico` append-only registra TODOS eventos estrutura organizacional para auditoria e rollback.

**Justificativa**: Rastreabilidade completa de mudanças organizacionais e compliance.

**Critério de Aceite**:
- Campos: Id_Historico, Id_Departamento, Tipo_Evento, Dt_Evento, Id_Usuario_Responsavel, Valores_JSON_Antes, Valores_JSON_Depois, Descricao
- Tipos evento: Criacao/Alteracao/Exclusao/Movimentacao_Hierarquia/Mudanca_Lider
- Captura: EF Core `SaveChangesInterceptor` serializa valores JSON
- Retenção: 7 anos banco, após move para Azure Blob Storage (cold storage)
- Uso: Auditoria quem/quando alterou, rollback para versão anterior, timeline mudanças

---

## 6. ESTADOS DA ENTIDADE

| Estado | Descrição |
|------|-----------|
| Ativo | Departamento operacional |
| Inativo | Departamento desativado temporariamente |
| Excluido | Departamento excluído logicamente (soft delete) |

### Transições permitidas

| De | Para |
|---|---|
| Ativo | Inativo |
| Inativo | Ativo |
| Ativo | Excluido |
| Inativo | Excluido |

**Observação**: Não há transição de Excluido para outros estados (soft delete permanente).

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre |
|------|--------------|
| DepartamentoCriadoEvent | Após criação bem-sucedida |
| DepartamentoAtualizadoEvent | Após atualização bem-sucedida |
| DepartamentoExcluidoEvent | Após exclusão lógica |
| ColaboradorAlocadoEvent | Após alocação em departamento |
| MovimentacaoAprovadaEvent | Após aprovação final (RH) de movimentação |
| EstruturaDepartamentoAlteradaEvent | Após mudança hierárquica (Id_Departamento_Pai) |
| HeadcountAtualizadoEvent | Após mudança em Qtd_Colaboradores |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant (Id_Fornecedor)
- Nenhuma regra de negócio pode ser ignorada
- Erros devem ser previsíveis e rastreáveis (HTTP status codes padronizados)
- Auditoria deve registrar quem, quando e o que mudou (campos Created, CreatedBy, LastModified, LastModifiedBy)
- Organograma deve renderizar árvores com >500 nós em <2 segundos
- SignalR deve ter latência <500ms para broadcast headcount
- Sincronização Azure AD deve ter taxa de sucesso >95%
- Validação de referências circulares deve executar em O(n) onde n = profundidade hierarquia

---

## 9. SEGURANÇA

- Validação de entrada obrigatória em todos endpoints (FluentValidation)
- Proteção contra SQL Injection (EF Core parametrizado)
- Proteção contra XSS (sanitização frontend Angular)
- Controle de permissões RBAC (policies: DepartamentosCreate, DepartamentosUpdate, DepartamentosDelete)
- Isolamento multi-tenant (query filter global EF Core)
- Autenticação JWT obrigatória (Bearer token)
- Autorização baseada em roles (Super Admin, Admin, Gestor, RH)

**Matriz de Permissões:**

| Operação | Permission Code | Roles Autorizadas |
|----------|----------------|-------------------|
| Criar departamento | `CAD.DEPARTAMENTOS.CREATE` | Super Admin, Admin |
| Editar departamento | `CAD.DEPARTAMENTOS.UPDATE` | Super Admin, Admin, Gestor (próprio dept) |
| Excluir departamento | `CAD.DEPARTAMENTOS.DELETE` | Super Admin |
| Visualizar organograma | `CAD.DEPARTAMENTOS.VIEW_ORGCHART` | Todos autenticados |
| Aprovar movimentação (Origem) | `CAD.DEPARTAMENTOS.APPROVE_MOVE_ORIGIN` | Gestor do departamento origem |
| Aprovar movimentação (Destino) | `CAD.DEPARTAMENTOS.APPROVE_MOVE_DEST` | Gestor do departamento destino |
| Aprovar movimentação (RH) | `CAD.DEPARTAMENTOS.APPROVE_MOVE_HR` | RH |
| Sincronizar Azure AD | `CAD.DEPARTAMENTOS.SYNC_AZUREAD` | Super Admin |

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF024.md** (Casos de Uso) - 5 UCs padrão CRUD + 6 UCs específicos
- **MD-RF024.md** (Modelo de Dados) - 5 entidades + 3 views + 3 triggers
- **WF-RF024.md** (Wireframes) - 8 telas (lista, criar, editar, organograma, dashboard, movimentações, aprovações, relatórios)
- **TC-RF024.yaml** (Casos de Teste) - 3 baterias (Backend, Sistema, Outros)
- **MT-RF024.yaml** (Massas de Teste) - Dados para testes automatizados

---

## 11. RASTREABILIDADE

### Dependências Upstream (RFs que este depende)

| RF | Descrição | Tipo Dependência |
|----|-----------|------------------|
| RF-CAD-005 | Gestão de Usuários | FK Usuario (líder e colaboradores) |
| RF-CAD-006 | Gestão de Perfis | Permissões RBAC |
| RF-NOT-001 | Notificações | Multicanal (email, push, inbox) |
| RF-AUD-001 | Auditoria | Change tracking histórico |

### Dependências Downstream (RFs que dependem deste)

| RF | Descrição | Tipo Dependência |
|----|-----------|------------------|
| RF-FIN-002 | Folha Pagamento | Custos departamentais |
| RF-RH-001 | Avaliações Desempenho | Span of control, analytics |
| RF-RH-002 | Gestão Férias | Aprovações por líder departamento |
| RF-RH-003 | Ponto Eletrônico | Validação presença física |

### Integrações Obrigatórias

| Sistema | Tipo | Descrição |
|---------|------|-----------|
| Azure AD | External API | Sincronização grupos segurança via Microsoft Graph |
| Ponto Eletrônico | Webhook | Validação presença física (REP-A, Dimep, Secullum) |
| eSocial | Compliance | Relatório movimentações mensais |
| RAIS | Compliance | Relatório estrutura organizacional anual |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|------|------|----------|------|
| 2.0 | 2025-12-30 | Separação RF/RL - Contrato funcional moderno (sem legado) | Agência ALC - alc.dev.br |
| 1.0 | 2025-11-03 | Versão inicial com legado misturado | Equipe IControlIT |
