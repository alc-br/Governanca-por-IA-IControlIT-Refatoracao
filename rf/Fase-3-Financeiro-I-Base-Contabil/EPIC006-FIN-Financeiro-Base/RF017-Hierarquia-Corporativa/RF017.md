# RF-017: Gestão de Hierarquia Corporativa

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC006-FIN - Financeiro Base
**Fase**: Fase 3 - Financeiro I - Base Contábil

---

## 1. OBJETIVO DO REQUISITO

Descrever de forma clara, objetiva e verificável o comportamento esperado do requisito funcional **RF-017 - Gestão de Hierarquia Corporativa**, servindo como **contrato oficial** entre negócio, desenvolvimento, testes e agentes de IA.

Este documento **não define implementação**, apenas **o que o sistema deve fazer** para permitir a criação, manutenção e gestão de uma estrutura hierárquica corporativa composta por:

- **Centro de Custo** (vinculado a uma Filial)
- **Departamento** (vinculado a um Centro de Custo)
- **Setor** (vinculado a um Departamento)
- **Seção** (vinculado a um Setor)

A hierarquia deve garantir:
- Isolamento multi-tenant (por conglomerado)
- Rastreabilidade e auditoria completa
- Gestão de responsáveis (gestores, gerentes, supervisores, coordenadores)
- Controle de orçamento (budget mensal) por nível hierárquico
- Validação de integridade referencial em cascata
- Relatórios de consumo agrupados por qualquer nível da hierarquia

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Criação de Centro de Custo vinculado a Filial
- [x] Criação de Departamento vinculado a Centro de Custo
- [x] Criação de Setor vinculado a Departamento
- [x] Criação de Seção vinculado a Setor
- [x] Atualização de qualquer nível da hierarquia
- [x] Listagem de qualquer nível da hierarquia com filtros
- [x] Inativação lógica (soft delete) de qualquer nível
- [x] Validações hierárquicas (não criar nível sem nível anterior)
- [x] Validações de integridade (não inativar com filhos ativos)
- [x] Controle de acesso RBAC por operação
- [x] Auditoria completa de todas as operações
- [x] Isolamento multi-tenant por conglomerado
- [x] Gestão de responsáveis (vínculo com consumidores ativos)
- [x] Gestão de budget mensal por nível
- [x] Alertas de budget excedido
- [x] Relatórios de consumo por nível hierárquico
- [x] Propagação de inativação em cascata (opcional)

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica
- Tecnologia, framework ou linguagem
- Layout, UX ou identidade visual
- Estratégia de deploy ou infraestrutura
- Regras de integração com módulos financeiros (tratados em outros RFs)
- Controle de acesso físico ou biométrico

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Conglomerado** | Unidade lógica de isolamento multi-tenant (tenant) |
| **Filial** | Unidade física da empresa (CNPJ, endereço) |
| **Centro de Custo** | Primeira camada hierárquica, vinculada a uma Filial |
| **Departamento** | Segunda camada hierárquica, vinculada a um Centro de Custo |
| **Setor** | Terceira camada hierárquica, vinculada a um Departamento |
| **Seção** | Quarta camada hierárquica (última), vinculada a um Setor |
| **Gestor/Gerente/Supervisor/Coordenador** | Consumidor ativo responsável por um nível hierárquico |
| **Budget Mensal** | Valor de orçamento mensal planejado para um nível hierárquico |
| **Código Hierárquico** | Identificador único no formato UPPER_SNAKE_CASE (ex: DEPTO_TI, SETOR_RH) |
| **Inativação em Cascata** | Processo opcional de inativar automaticamente todos os níveis filhos ao inativar um nível pai |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Criar Centro de Custo** vinculado a uma Filial ativa
2. **Criar Departamento** vinculado a um Centro de Custo ativo
3. **Criar Setor** vinculado a um Departamento ativo
4. **Criar Seção** vinculado a um Setor ativo
5. **Atualizar** qualquer nível hierárquico
6. **Consultar por ID** qualquer nível hierárquico
7. **Listar** qualquer nível hierárquico com filtros (por Filial, por nível pai, por status)
8. **Inativar** qualquer nível hierárquico (soft delete)
9. **Reativar** qualquer nível hierárquico previamente inativado
10. **Validar hierarquia** antes de criar (não pode pular níveis)
11. **Validar integridade** antes de inativar (não pode inativar com filhos ativos)
12. **Vincular responsável** (gestor/gerente/supervisor/coordenador) a qualquer nível
13. **Configurar budget mensal** para qualquer nível
14. **Gerar alertas** de budget excedido
15. **Gerar relatórios de consumo** agrupados por qualquer nível hierárquico

---

## 5. REGRAS DE NEGÓCIO

### RN-RF017-01 — Código Único por Conglomerado

**Descrição**: O código do centro de custo, departamento, setor ou seção deve ser único dentro do conglomerado.

**Justificativa**: Evitar duplicidade e ambiguidade na identificação de níveis hierárquicos.

**Critério de Aceite**:
- Tentativa de criar com código duplicado → HTTP 400 (Bad Request)
- Mensagem de erro: "Código {codigo} já existe para este conglomerado"
- Validação case-insensitive (DEPTO_TI = depto_ti)

---

### RN-RF017-02 — Hierarquia Obrigatória em Cascata

**Descrição**: A hierarquia deve respeitar a ordem: **Filial → Centro de Custo → Departamento → Setor → Seção**. Não se pode criar um nível sem o anterior existir e estar ativo.

**Justificativa**: Garantir integridade referencial e evitar estruturas órfãs.

**Critério de Aceite**:
- Criar Departamento sem Centro de Custo ativo → HTTP 400
- Criar Setor sem Departamento ativo → HTTP 400
- Criar Seção sem Setor ativo → HTTP 400
- Mensagem de erro: "Não é possível criar {nivel} sem {nivel_pai} ativo"

---

### RN-RF017-03 — Não Pode Inativar com Filhos Ativos

**Descrição**: Não se pode inativar um centro de custo com departamentos ativos, nem um departamento com setores ativos, nem um setor com seções ativas.

**Justificativa**: Evitar inconsistências hierárquicas e perda de contexto.

**Critério de Aceite**:
- Tentativa de inativar com filhos ativos → HTTP 400
- Mensagem de erro: "Não é possível inativar {nivel} com {quantidade} {nivel_filho}(s) ativo(s)"
- Listar filhos ativos na mensagem de erro

---

### RN-RF017-04 — Gestor Deve Ser Consumidor Ativo

**Descrição**: O gestor/gerente/supervisor/coordenador deve ser um consumidor ativo do sistema.

**Justificativa**: Garantir que responsáveis sejam pessoas válidas e ativas no sistema.

**Critério de Aceite**:
- Vincular consumidor inativo → HTTP 400
- Vincular consumidor inexistente → HTTP 404
- Mensagem de erro: "Consumidor {id} não está ativo ou não existe"

---

### RN-RF017-05 — Budget Mensal Deve Ser Positivo

**Descrição**: Se informado, o valor do budget mensal deve ser maior que zero.

**Justificativa**: Evitar valores inválidos ou negativos que não fazem sentido para orçamento.

**Critério de Aceite**:
- Budget mensal ≤ 0 → HTTP 400
- Budget mensal = NULL → permitido (sem budget definido)
- Mensagem de erro: "Budget mensal deve ser maior que zero"

---

### RN-RF017-06 — Centro de Custo Vinculado à Filial

**Descrição**: Todo centro de custo deve estar vinculado a uma filial ativa.

**Justificativa**: Centro de Custo é a primeira camada hierárquica e depende de Filial.

**Critério de Aceite**:
- Criar Centro de Custo sem Filial → HTTP 400
- Criar Centro de Custo com Filial inativa → HTTP 400
- Mensagem de erro: "Filial {id} não existe ou está inativa"

---

### RN-RF017-07 — Código Deve Ser UPPER_SNAKE_CASE

**Descrição**: O código deve seguir o padrão UPPER_SNAKE_CASE (ex: DEPTO_TI, SETOR_RH, CC_FINANCEIRO).

**Justificativa**: Padronização e facilidade de identificação.

**Critério de Aceite**:
- Código com letras minúsculas → HTTP 400
- Código com espaços → HTTP 400
- Código com caracteres especiais (exceto underscore) → HTTP 400
- Mensagem de erro: "Código deve seguir padrão UPPER_SNAKE_CASE"
- Exemplos válidos: DEPTO_TI, SETOR_RH, CC_ADM
- Exemplos inválidos: depto ti, Depto-TI, DEPTO.TI

---

### RN-RF017-08 — Não Alterar Código com Histórico

**Descrição**: Se o centro de custo/departamento/setor/seção já tiver histórico de movimentações financeiras, não permitir alteração do código.

**Justificativa**: Evitar perda de rastreabilidade e inconsistências em relatórios históricos.

**Critério de Aceite**:
- Alterar código com movimentações financeiras → HTTP 400
- Mensagem de erro: "Não é possível alterar código com histórico de movimentações financeiras"
- Permitir alteração de outros campos (nome, gestor, budget)

---

### RN-RF017-09 — Isolamento por Conglomerado (Multi-tenancy)

**Descrição**: Todas as consultas e operações devem filtrar automaticamente por Id_Conglomerado do usuário autenticado.

**Justificativa**: Segurança e isolamento de dados multi-tenant.

**Critério de Aceite**:
- Tentativa de acesso a dados de outro conglomerado → HTTP 403 (Forbidden)
- Filtro automático aplicado em todas as queries
- Auditoria deve registrar Id_Conglomerado

---

### RN-RF017-10 — Auditoria Completa de Alterações

**Descrição**: Todas as operações (INSERT, UPDATE, DELETE) devem registrar histórico com dados anteriores em JSON.

**Justificativa**: Rastreabilidade, compliance e auditoria.

**Critério de Aceite**:
- Toda operação gera registro de auditoria
- Dados anteriores salvos em formato JSON
- Registro inclui: usuário, IP, timestamp, operação, dados_anteriores, dados_novos

---

### RN-RF017-11 — Nome Obrigatório e Limite de Caracteres

**Descrição**: O nome deve ser obrigatório e respeitar limite de 120 caracteres.

**Justificativa**: Garantir identificação legível e evitar problemas de UI.

**Critério de Aceite**:
- Nome ausente → HTTP 400
- Nome vazio → HTTP 400
- Nome > 120 caracteres → HTTP 400
- Mensagem de erro: "Nome é obrigatório e deve ter até 120 caracteres"

---

### RN-RF017-12 — Propagação de Inativação em Cascata (Opcional)

**Descrição**: Ao inativar um centro de custo, pode-se opcionalmente inativar todos os departamentos, setores e seções filhos automaticamente.

**Justificativa**: Facilitar gestão em massa quando uma estrutura inteira é desativada.

**Critério de Aceite**:
- Parâmetro `inativar_em_cascata=true` → inativa todos os filhos
- Parâmetro `inativar_em_cascata=false` (padrão) → valida que não há filhos ativos (RN-RF017-03)
- Auditoria deve registrar cada inativação individual
- Retornar lista de IDs inativados

---

### RN-RF017-13 — Validação de E-mail de Gestor

**Descrição**: Se o gestor tiver e-mail cadastrado, deve ser um e-mail válido.

**Justificativa**: Garantir que alertas de budget possam ser enviados.

**Critério de Aceite**:
- E-mail inválido → HTTP 400
- Mensagem de erro: "E-mail {email} inválido"
- Validação de formato (regex padrão de e-mail)

---

### RN-RF017-14 — Relatório de Consumo por CC/Depto/Setor/Seção

**Descrição**: O sistema deve permitir relatórios de consumo agrupados por qualquer nível da hierarquia (CC, Depto, Setor, Seção).

**Justificativa**: Análise de custos em diferentes níveis de granularidade.

**Critério de Aceite**:
- Endpoint: `GET /api/relatorios/consumo?nivel={cc|depto|setor|secao}&periodo={mes/ano}`
- Retornar: código, nome, consumo_real, budget, percentual_uso
- Ordenar por consumo decrescente

---

### RN-RF017-15 — Alerta de Budget Excedido

**Descrição**: Se o consumo mensal ultrapassar o budget configurado, enviar alerta para o gestor.

**Justificativa**: Controle proativo de orçamento.

**Critério de Aceite**:
- Verificação diária automatizada
- Alerta enviado quando consumo > budget
- Alerta enviado quando consumo > 80% do budget (warning)
- Alerta via e-mail e notificação no sistema
- Gestor sem e-mail → apenas notificação no sistema

---

## 6. ESTADOS DA ENTIDADE

Todas as entidades hierárquicas (Centro de Custo, Departamento, Setor, Seção) possuem os mesmos estados:

| Estado | Descrição |
|--------|-----------|
| **active** | Ativo, pode ser usado em operações |
| **inactive** | Inativo, não pode ser usado em novas operações |

### Transições permitidas

| De | Para | Condição |
|----|------|----------|
| active | inactive | Não ter filhos ativos (exceto se inativar_em_cascata=true) |
| inactive | active | Nível pai estar ativo |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre | Payload |
|--------|---------------|---------|
| **centro_custo.criado** | Após criação de Centro de Custo | { id, codigo, nome, filial_id, conglomerado_id } |
| **centro_custo.atualizado** | Após atualização de Centro de Custo | { id, campos_alterados, dados_anteriores } |
| **centro_custo.inativado** | Após inativação de Centro de Custo | { id, codigo, inativado_em_cascata } |
| **departamento.criado** | Após criação de Departamento | { id, codigo, nome, centro_custo_id } |
| **departamento.atualizado** | Após atualização de Departamento | { id, campos_alterados } |
| **departamento.inativado** | Após inativação de Departamento | { id, codigo } |
| **setor.criado** | Após criação de Setor | { id, codigo, nome, departamento_id } |
| **setor.atualizado** | Após atualização de Setor | { id, campos_alterados } |
| **setor.inativado** | Após inativação de Setor | { id, codigo } |
| **secao.criada** | Após criação de Seção | { id, codigo, nome, setor_id } |
| **secao.atualizada** | Após atualização de Seção | { id, campos_alterados } |
| **secao.inativada** | Após inativação de Seção | { id, codigo } |
| **budget.excedido** | Quando consumo > budget | { nivel, id, consumo, budget, percentual } |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de conglomerado (multi-tenant)
- Nenhuma regra de negócio pode ser ignorada
- Erros devem ser previsíveis, rastreáveis e retornar mensagens claras
- Auditoria deve registrar: quem, quando, o que mudou (dados anteriores + novos)
- Todos os endpoints devem validar permissões RBAC
- Todas as entidades devem ter soft delete (não exclusão física)
- Todas as consultas devem aplicar filtro de conglomerado automaticamente
- Integridade referencial deve ser preservada em toda a hierarquia
- Códigos devem seguir padrão UPPER_SNAKE_CASE
- Nomes devem ser obrigatórios e limitados a 120 caracteres
- Budget mensal, se informado, deve ser > 0
- Gestores devem ser consumidores ativos

---

## 9. SEGURANÇA

### 9.1 Autenticação
- Todos os endpoints exigem autenticação via JWT Bearer Token
- Token deve conter: Id_Usuario, Id_Conglomerado, Roles, Permissions

### 9.2 Autorização (RBAC)

| Operação | Permissão Necessária |
|----------|---------------------|
| Listar | `hierarquia.view_any` |
| Visualizar | `hierarquia.view` |
| Criar | `hierarquia.create` |
| Atualizar | `hierarquia.update` |
| Inativar | `hierarquia.delete` |
| Reativar | `hierarquia.restore` |
| Relatórios | `relatorios.consumo.view` |

### 9.3 Proteções
- Validação de entrada obrigatória (DTO com FluentValidation)
- Proteção contra SQL Injection (EF Core parametrizado)
- Proteção contra XSS (sanitização de inputs)
- Isolamento multi-tenant automático (Row-Level Security)
- Rate limiting (100 requests/minuto por usuário)
- Auditoria completa de todas as operações

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF017.md** - Casos de Uso (UC00-UC04)
- **TC-RF017-BACKEND.md** - Casos de Teste Backend
- **TC-RF017-FRONTEND.md** - Casos de Teste Frontend
- **TC-RF017-SEGURANCA.md** - Casos de Teste Segurança
- **TC-RF017-E2E.md** - Casos de Teste End-to-End
- **MT-RF017.yaml** - Massas de Teste
- **MD-RF017.md** - Modelo de Dados

---

## 11. RASTREABILIDADE

| Artefato | Status | Responsável |
|----------|--------|-------------|
| UC-RF017.md | Pendente | Architect Agent |
| TC-RF017-BACKEND.md | Pendente | Tester Agent |
| TC-RF017-FRONTEND.md | Pendente | Tester Agent |
| TC-RF017-SEGURANCA.md | Pendente | Tester Agent |
| TC-RF017-E2E.md | Pendente | Tester Agent |
| MT-RF017.yaml | Pendente | Tester Agent |
| MD-RF017.md | Pendente | Architect Agent |
| Backend Implementation | Pendente | Developer Agent |
| Frontend Implementation | Pendente | Developer Agent |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-30 | Migração para versão 2.0 com separação RF/RL. Estrutura com 11 seções obrigatórias. Foco em contrato funcional moderno sem mistura de legado. | Agência ALC - alc.dev.br |
| 1.0 | 2025-11-03 | Versão inicial (misturava RF e RL) | Agência ALC - alc.dev.br |
