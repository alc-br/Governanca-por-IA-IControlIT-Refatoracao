# =============================================
# RF-017 - Gestão de Hierarquia Corporativa
# Versão: 2.0
# Autor: Agência ALC - alc.dev.br
# Data: 2025-12-30
# =============================================

rf:
  id: "RF017"
  nome: "Gestão de Hierarquia Corporativa"
  versao: "2.0"
  data: "2025-12-30"
  fase: "Fase 3 - Financeiro I - Base Contábil"
  epic: "EPIC006-FIN"
  status: "em_desenvolvimento" # draft | aprovado | em_desenvolvimento | concluido

descricao:
  objetivo: |
    Permitir a criação, manutenção e gestão de uma estrutura hierárquica corporativa
    composta por Centro de Custo, Departamento, Setor e Seção, garantindo isolamento
    multi-tenant, auditoria completa, controle de orçamento e rastreabilidade.
  problema_resolvido: |
    Necessidade de organizar custos e responsabilidades em uma estrutura hierárquica
    que permita análise de consumo em diferentes níveis de granularidade (Centro de Custo,
    Departamento, Setor, Seção) com controle de orçamento e alertas de budget excedido.
  publico_afetado: |
    Gestores financeiros, gestores de centro de custo, gerentes de departamento,
    supervisores de setor, coordenadores de seção, analistas de custos, auditores.

escopo:
  incluso:
    - "Criação de Centro de Custo vinculado a Filial"
    - "Criação de Departamento vinculado a Centro de Custo"
    - "Criação de Setor vinculado a Departamento"
    - "Criação de Seção vinculado a Setor"
    - "Atualização de qualquer nível hierárquico"
    - "Listagem com filtros por Filial, nível pai, status"
    - "Inativação lógica (soft delete) de qualquer nível"
    - "Validações hierárquicas (não criar nível sem nível anterior)"
    - "Validações de integridade (não inativar com filhos ativos)"
    - "Controle de acesso RBAC por operação"
    - "Auditoria completa de todas as operações"
    - "Isolamento multi-tenant por Fornecedor"
    - "Gestão de responsáveis (vínculo com consumidores ativos)"
    - "Gestão de budget mensal por nível"
    - "Alertas de budget excedido"
    - "Relatórios de consumo por nível hierárquico"
    - "Propagação de inativação em cascata (opcional)"
  fora:
    - "Interface visual específica"
    - "Tecnologia, framework ou linguagem"
    - "Layout, UX ou identidade visual"
    - "Estratégia de deploy ou infraestrutura"
    - "Regras de integração com módulos financeiros (outros RFs)"
    - "Controle de acesso físico ou biométrico"

entidades:
  - nome: "CentroCusto"
    descricao: "Primeira camada hierárquica, vinculada a uma Filial"
    multi_tenant: true
    soft_delete: true
    auditoria: true

  - nome: "Departamento"
    descricao: "Segunda camada hierárquica, vinculada a um Centro de Custo"
    multi_tenant: true
    soft_delete: true
    auditoria: true

  - nome: "Setor"
    descricao: "Terceira camada hierárquica, vinculada a um Departamento"
    multi_tenant: true
    soft_delete: true
    auditoria: true

  - nome: "Secao"
    descricao: "Quarta camada hierárquica (última), vinculada a um Setor"
    multi_tenant: true
    soft_delete: true
    auditoria: true

regras_negocio:
  - id: "RN-RF017-01"
    descricao: "Código Único por Fornecedor"
    tipo: "unicidade"
    campos_afetados: ["Fornecedor_id", "codigo"]
    obrigatorio: true
    criticidade: "alta"
    implementacao: |
      Validar que código não exista para o mesmo Fornecedor (case-insensitive).
      HTTP 400 se duplicado com mensagem: "Código {codigo} já existe para este Fornecedor".
    validacao: |
      - Tentativa de criar com código duplicado → HTTP 400
      - Validação case-insensitive (DEPTO_TI = depto_ti)

  - id: "RN-RF017-02"
    descricao: "Hierarquia Obrigatória em Cascata"
    tipo: "regra_negocio"
    campos_afetados: ["filial_id", "centro_custo_id", "departamento_id", "setor_id"]
    obrigatorio: true
    criticidade: "alta"
    implementacao: |
      Validar que nível pai existe e está ativo antes de criar nível filho.
      Ordem: Filial → Centro de Custo → Departamento → Setor → Seção.
      HTTP 400 se nível pai não existe ou inativo.
    validacao: |
      - Criar Departamento sem Centro de Custo ativo → HTTP 400
      - Criar Setor sem Departamento ativo → HTTP 400
      - Criar Seção sem Setor ativo → HTTP 400

  - id: "RN-RF017-03"
    descricao: "Não Pode Inativar com Filhos Ativos"
    tipo: "regra_negocio"
    campos_afetados: ["status"]
    obrigatorio: true
    criticidade: "alta"
    implementacao: |
      Antes de inativar, verificar se existem filhos ativos.
      Se existirem, HTTP 400 com lista de filhos ativos.
      Exceção: se parâmetro inativar_em_cascata=true.
    validacao: |
      - Tentativa de inativar com filhos ativos → HTTP 400
      - Mensagem listando filhos ativos

  - id: "RN-RF017-04"
    descricao: "Gestor Deve Ser Consumidor Ativo"
    tipo: "validacao"
    campos_afetados: ["gestor_id", "gerente_id", "supervisor_id", "coordenador_id"]
    obrigatorio: false
    criticidade: "media"
    implementacao: |
      Se gestor/gerente/supervisor/coordenador informado, validar que consumidor existe e está ativo.
      HTTP 404 se não existe, HTTP 400 se inativo.
    validacao: |
      - Vincular consumidor inativo → HTTP 400
      - Vincular consumidor inexistente → HTTP 404

  - id: "RN-RF017-05"
    descricao: "Budget Mensal Deve Ser Positivo"
    tipo: "validacao"
    campos_afetados: ["budget_mensal"]
    obrigatorio: false
    criticidade: "media"
    implementacao: |
      Se budget_mensal informado, validar que é > 0.
      NULL é permitido (sem budget definido).
      HTTP 400 se ≤ 0.
    validacao: |
      - Budget mensal ≤ 0 → HTTP 400
      - Budget mensal = NULL → permitido

  - id: "RN-RF017-06"
    descricao: "Centro de Custo Vinculado à Filial"
    tipo: "regra_negocio"
    campos_afetados: ["filial_id"]
    obrigatorio: true
    criticidade: "alta"
    implementacao: |
      Validar que filial_id existe e filial está ativa.
      HTTP 400 se filial não existe ou inativa.
    validacao: |
      - Criar Centro de Custo sem Filial → HTTP 400
      - Criar Centro de Custo com Filial inativa → HTTP 400

  - id: "RN-RF017-07"
    descricao: "Código Deve Ser UPPER_SNAKE_CASE"
    tipo: "validacao"
    campos_afetados: ["codigo"]
    obrigatorio: true
    criticidade: "media"
    implementacao: |
      Validar que código segue padrão UPPER_SNAKE_CASE.
      Permitido: A-Z, 0-9, underscore (_).
      HTTP 400 se não seguir padrão.
    validacao: |
      - Código com letras minúsculas → HTTP 400
      - Código com espaços → HTTP 400
      - Código com caracteres especiais (exceto _) → HTTP 400
      - Exemplos válidos: DEPTO_TI, SETOR_RH, CC_ADM
      - Exemplos inválidos: depto ti, Depto-TI, DEPTO.TI

  - id: "RN-RF017-08"
    descricao: "Não Alterar Código com Histórico"
    tipo: "regra_negocio"
    campos_afetados: ["codigo"]
    obrigatorio: true
    criticidade: "alta"
    implementacao: |
      Antes de atualizar código, verificar se existe histórico de movimentações financeiras.
      Se existir, HTTP 400.
      Permitir alteração de outros campos (nome, gestor, budget).
    validacao: |
      - Alterar código com movimentações financeiras → HTTP 400
      - Permitir alteração de outros campos

  - id: "RN-RF017-09"
    descricao: "Isolamento por Fornecedor (Multi-tenancy)"
    tipo: "seguranca"
    campos_afetados: ["Fornecedor_id"]
    obrigatorio: true
    criticidade: "critica"
    implementacao: |
      Todas as queries devem aplicar filtro WHERE Fornecedor_id = {usuario.Fornecedor_id}.
      Tentativa de acesso a dados de outro Fornecedor → HTTP 403.
      Auditoria deve registrar Fornecedor_id.
    validacao: |
      - Tentativa de acesso a dados de outro Fornecedor → HTTP 403
      - Filtro automático em todas as queries

  - id: "RN-RF017-10"
    descricao: "Auditoria Completa de Alterações"
    tipo: "auditoria"
    campos_afetados: ["*"]
    obrigatorio: true
    criticidade: "critica"
    implementacao: |
      Todas as operações (INSERT, UPDATE, DELETE) geram registro de auditoria.
      Dados anteriores salvos em JSON.
      Registro inclui: usuario_id, ip, timestamp, operacao, dados_anteriores, dados_novos.
    validacao: |
      - Toda operação gera registro de auditoria
      - Dados anteriores em formato JSON

  - id: "RN-RF017-11"
    descricao: "Nome Obrigatório e Limite de Caracteres"
    tipo: "validacao"
    campos_afetados: ["nome"]
    obrigatorio: true
    criticidade: "alta"
    implementacao: |
      Validar que nome está presente, não vazio, e ≤ 120 caracteres.
      HTTP 400 se ausente, vazio ou > 120 caracteres.
    validacao: |
      - Nome ausente → HTTP 400
      - Nome vazio → HTTP 400
      - Nome > 120 caracteres → HTTP 400

  - id: "RN-RF017-12"
    descricao: "Propagação de Inativação em Cascata (Opcional)"
    tipo: "regra_negocio"
    campos_afetados: ["status"]
    obrigatorio: false
    criticidade: "media"
    implementacao: |
      Parâmetro opcional inativar_em_cascata (default=false).
      Se true, inativar todos os filhos recursivamente.
      Se false, validar que não há filhos ativos (RN-RF017-03).
      Auditoria deve registrar cada inativação individual.
      Retornar lista de IDs inativados.
    validacao: |
      - inativar_em_cascata=true → inativa todos os filhos
      - inativar_em_cascata=false → valida que não há filhos ativos
      - Retornar lista de IDs inativados

  - id: "RN-RF017-13"
    descricao: "Validação de E-mail de Gestor"
    tipo: "validacao"
    campos_afetados: ["gestor_email"]
    obrigatorio: false
    criticidade: "baixa"
    implementacao: |
      Se gestor tiver e-mail cadastrado, validar formato.
      HTTP 400 se formato inválido.
      Usar regex padrão de e-mail.
    validacao: |
      - E-mail inválido → HTTP 400
      - Validação de formato (regex)

  - id: "RN-RF017-14"
    descricao: "Relatório de Consumo por CC/Depto/Setor/Seção"
    tipo: "regra_negocio"
    campos_afetados: ["*"]
    obrigatorio: true
    criticidade: "media"
    implementacao: |
      Endpoint: GET /api/relatorios/consumo?nivel={cc|depto|setor|secao}&periodo={mes/ano}
      Retornar: codigo, nome, consumo_real, budget, percentual_uso
      Ordenar por consumo decrescente.
    validacao: |
      - Endpoint funcional
      - Retornar dados corretos
      - Ordenar por consumo decrescente

  - id: "RN-RF017-15"
    descricao: "Alerta de Budget Excedido"
    tipo: "regra_negocio"
    campos_afetados: ["budget_mensal", "consumo_mensal"]
    obrigatorio: true
    criticidade: "alta"
    implementacao: |
      Verificação diária automatizada.
      Alerta enviado quando consumo > budget.
      Warning enviado quando consumo > 80% budget.
      Alerta via e-mail e notificação no sistema.
      Gestor sem e-mail → apenas notificação no sistema.
    validacao: |
      - Verificação diária automatizada
      - Alerta quando consumo > budget
      - Warning quando consumo > 80% budget

estados:
  - id: "active"
    descricao: "Ativo, pode ser usado em operações"
  - id: "inactive"
    descricao: "Inativo, não pode ser usado em novas operações"

transicoes:
  permitidas:
    - de: "active"
      para: "inactive"
      condicao: "Não ter filhos ativos (exceto se inativar_em_cascata=true)"
    - de: "inactive"
      para: "active"
      condicao: "Nível pai estar ativo"
  proibidas: []

permissoes:
  - codigo: "hierarquia.view_any"
    descricao: "Listar registros da hierarquia"
  - codigo: "hierarquia.view"
    descricao: "Visualizar registro da hierarquia"
  - codigo: "hierarquia.create"
    descricao: "Criar registro da hierarquia"
  - codigo: "hierarquia.update"
    descricao: "Atualizar registro da hierarquia"
  - codigo: "hierarquia.delete"
    descricao: "Inativar registro da hierarquia"
  - codigo: "hierarquia.restore"
    descricao: "Reativar registro da hierarquia"
  - codigo: "relatorios.consumo.view"
    descricao: "Visualizar relatórios de consumo"

endpoints:
  # Centro de Custo
  - metodo: "GET"
    rota: "/api/centrocusto"
    descricao: "Listar centros de custo"
    autenticacao: true
    autorizacao: "hierarquia.view_any"

  - metodo: "GET"
    rota: "/api/centrocusto/{id}"
    descricao: "Obter centro de custo por ID"
    autenticacao: true
    autorizacao: "hierarquia.view"

  - metodo: "POST"
    rota: "/api/centrocusto"
    descricao: "Criar centro de custo"
    autenticacao: true
    autorizacao: "hierarquia.create"

  - metodo: "PUT"
    rota: "/api/centrocusto/{id}"
    descricao: "Atualizar centro de custo"
    autenticacao: true
    autorizacao: "hierarquia.update"

  - metodo: "DELETE"
    rota: "/api/centrocusto/{id}"
    descricao: "Inativar centro de custo"
    autenticacao: true
    autorizacao: "hierarquia.delete"

  # Departamento
  - metodo: "GET"
    rota: "/api/departamento"
    descricao: "Listar departamentos"
    autenticacao: true
    autorizacao: "hierarquia.view_any"

  - metodo: "GET"
    rota: "/api/departamento/{id}"
    descricao: "Obter departamento por ID"
    autenticacao: true
    autorizacao: "hierarquia.view"

  - metodo: "POST"
    rota: "/api/departamento"
    descricao: "Criar departamento"
    autenticacao: true
    autorizacao: "hierarquia.create"

  - metodo: "PUT"
    rota: "/api/departamento/{id}"
    descricao: "Atualizar departamento"
    autenticacao: true
    autorizacao: "hierarquia.update"

  - metodo: "DELETE"
    rota: "/api/departamento/{id}"
    descricao: "Inativar departamento"
    autenticacao: true
    autorizacao: "hierarquia.delete"

  # Setor
  - metodo: "GET"
    rota: "/api/setor"
    descricao: "Listar setores"
    autenticacao: true
    autorizacao: "hierarquia.view_any"

  - metodo: "GET"
    rota: "/api/setor/{id}"
    descricao: "Obter setor por ID"
    autenticacao: true
    autorizacao: "hierarquia.view"

  - metodo: "POST"
    rota: "/api/setor"
    descricao: "Criar setor"
    autenticacao: true
    autorizacao: "hierarquia.create"

  - metodo: "PUT"
    rota: "/api/setor/{id}"
    descricao: "Atualizar setor"
    autenticacao: true
    autorizacao: "hierarquia.update"

  - metodo: "DELETE"
    rota: "/api/setor/{id}"
    descricao: "Inativar setor"
    autenticacao: true
    autorizacao: "hierarquia.delete"

  # Seção
  - metodo: "GET"
    rota: "/api/secao"
    descricao: "Listar seções"
    autenticacao: true
    autorizacao: "hierarquia.view_any"

  - metodo: "GET"
    rota: "/api/secao/{id}"
    descricao: "Obter seção por ID"
    autenticacao: true
    autorizacao: "hierarquia.view"

  - metodo: "POST"
    rota: "/api/secao"
    descricao: "Criar seção"
    autenticacao: true
    autorizacao: "hierarquia.create"

  - metodo: "PUT"
    rota: "/api/secao/{id}"
    descricao: "Atualizar seção"
    autenticacao: true
    autorizacao: "hierarquia.update"

  - metodo: "DELETE"
    rota: "/api/secao/{id}"
    descricao: "Inativar seção"
    autenticacao: true
    autorizacao: "hierarquia.delete"

  # Relatórios
  - metodo: "GET"
    rota: "/api/relatorios/consumo"
    descricao: "Relatório de consumo por nível hierárquico"
    autenticacao: true
    autorizacao: "relatorios.consumo.view"

integracoes:
  internas:
    - "Autenticacao JWT"
    - "Multi-Tenancy (Fornecedor)"
    - "Auditoria Automática"
    - "RBAC (Role-Based Access Control)"
    - "Soft Delete"
    - "Sistema de Alertas (Budget Excedido)"
  externas: []

seguranca:
  isolamento_tenant: true
  auditoria_obrigatoria: true
  soft_delete: true
  rbac: true
  validacao_entrada: true
  protecao_sql_injection: true
  protecao_xss: true
  rate_limiting: "100 requests/minuto por usuário"

kpis:
  - nome: "Tempo de criação de nível hierárquico"
    meta: "< 2 segundos"
    medicao: "Tempo de resposta do endpoint POST"

  - nome: "Tempo de listagem de níveis hierárquicos"
    meta: "< 1 segundo para até 1000 registros"
    medicao: "Tempo de resposta do endpoint GET"

  - nome: "Precisão de alertas de budget"
    meta: "100% de alertas corretos (sem falsos positivos/negativos)"
    medicao: "Comparação entre alertas enviados e budget real excedido"

  - nome: "Disponibilidade do sistema"
    meta: "> 99.9% uptime"
    medicao: "Monitoramento de disponibilidade dos endpoints"

alertas_criticos:
  - condicao: "Tempo de resposta > 5 segundos"
    acao: "Alertar equipe de infraestrutura"
    threshold: "3 ocorrências em 5 minutos"

  - condicao: "Taxa de erro > 5%"
    acao: "Alertar equipe de desenvolvimento"
    threshold: "10 erros em 1 minuto"

  - condicao: "Tentativas de acesso cross-tenant"
    acao: "Alertar equipe de segurança"
    threshold: "1 ocorrência"

tecnologias:
  backend:
    - ".NET 10"
    - "Entity Framework Core 10"
    - "MediatR (CQRS)"
    - "FluentValidation"
  frontend:
    - "Angular 19"
    - "Standalone Components"
    - "Transloco (i18n)"
  banco_dados:
    - "SQLite (dev)"
    - "SQL Server (prod)"

rastreabilidade:
  ucs_esperados:
    - "UC00-Visualizar-Hierarquia"
    - "UC01-Criar-Nivel-Hierarquico"
    - "UC02-Atualizar-Nivel-Hierarquico"
    - "UC03-Inativar-Nivel-Hierarquico"
    - "UC04-Relatorios-Consumo"
  artefatos_derivados:
    - "UC-RF017.md"
    - "TC-RF017-BACKEND.md"
    - "TC-RF017-FRONTEND.md"
    - "TC-RF017-SEGURANCA.md"
    - "TC-RF017-E2E.md"
    - "MT-RF017.yaml"
    - "MD-RF017.md"

catalog:
  crud:
    - id: "RF-CRUD-01"
      title: "Criar Centro de Custo"
      required: true
    - id: "RF-CRUD-02"
      title: "Criar Departamento"
      required: true
    - id: "RF-CRUD-03"
      title: "Criar Setor"
      required: true
    - id: "RF-CRUD-04"
      title: "Criar Seção"
      required: true
    - id: "RF-CRUD-05"
      title: "Listar níveis hierárquicos"
      required: true
    - id: "RF-CRUD-06"
      title: "Visualizar nível hierárquico"
      required: true
    - id: "RF-CRUD-07"
      title: "Atualizar nível hierárquico"
      required: true
    - id: "RF-CRUD-08"
      title: "Inativar nível hierárquico"
      required: true
    - id: "RF-CRUD-09"
      title: "Reativar nível hierárquico"
      required: true

  validacoes:
    - id: "RF-VAL-01"
      title: "Validar campos obrigatórios"
      required: true
    - id: "RF-VAL-02"
      title: "Validar unicidade de código"
      required: true
    - id: "RF-VAL-03"
      title: "Validar hierarquia em cascata"
      required: true
    - id: "RF-VAL-04"
      title: "Validar integridade referencial"
      required: true
    - id: "RF-VAL-05"
      title: "Validar código UPPER_SNAKE_CASE"
      required: true
    - id: "RF-VAL-06"
      title: "Validar budget positivo"
      required: true
    - id: "RF-VAL-07"
      title: "Validar gestor ativo"
      required: true
    - id: "RF-VAL-08"
      title: "Validar e-mail de gestor"
      required: false

  seguranca:
    - id: "RF-SEC-01"
      title: "Isolamento de tenant"
      required: true
    - id: "RF-SEC-02"
      title: "Permissões RBAC"
      required: true
    - id: "RF-SEC-03"
      title: "Auditoria completa"
      required: true
    - id: "RF-SEC-04"
      title: "Soft delete"
      required: true
    - id: "RF-SEC-05"
      title: "Validação de entrada"
      required: true
    - id: "RF-SEC-06"
      title: "Proteção SQL Injection"
      required: true
    - id: "RF-SEC-07"
      title: "Proteção XSS"
      required: true
    - id: "RF-SEC-08"
      title: "Rate limiting"
      required: true

  funcionalidades_especiais:
    - id: "RF-ESP-01"
      title: "Inativação em cascata opcional"
      required: true
    - id: "RF-ESP-02"
      title: "Alertas de budget excedido"
      required: true
    - id: "RF-ESP-03"
      title: "Relatórios de consumo multi-nível"
      required: true
    - id: "RF-ESP-04"
      title: "Gestão de responsáveis"
      required: true
    - id: "RF-ESP-05"
      title: "Controle de budget mensal"
      required: true

exclusions:
  rf_items: []

historico:
  - versao: "2.0"
    data: "2025-12-30"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Migração para versão 2.0 com separação RF/RL. Estruturado e sincronizado com RF017.md."

  - versao: "1.0"
    data: "2025-11-03"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Versão inicial (misturava RF e RL)"
