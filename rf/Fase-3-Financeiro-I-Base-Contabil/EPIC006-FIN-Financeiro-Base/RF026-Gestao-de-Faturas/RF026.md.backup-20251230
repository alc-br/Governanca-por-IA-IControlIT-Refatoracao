# RF-026: Gest√£o Completa de Faturas de Telecom e TI

**Vers√£o**: 1.0
**√öltima Atualiza√ß√£o**: 17/12/2025
**Status**: ‚úÖ Documenta√ß√£o Completa (5 se√ß√µes)
**Fase**: Fase 2 - Servi√ßos Essenciais
**EPIC**: GES - Gest√£o
**Prioridade**: CR√çTICA
**Complexidade**: MUITO ALTA

[‚Üê Voltar](../README.md)

---

## üìã 1. RESUMO EXECUTIVO

### Descri√ß√£o Geral

Sistema completo de gest√£o de faturas de servi√ßos de Telecom (telefonia m√≥vel, fixa, internet, links dedicados) e TI (cloud computing, licen√ßas SaaS, suporte t√©cnico) com importa√ß√£o automatizada de layouts personalizados por operadora, concilia√ß√£o inteligente contra contratos, auditoria de cobran√ßas indevidas, rateio multi-dimensional por centro de custo e contesta√ß√£o formal com workflow de aprova√ß√£o. Suporta OCR de PDFs, integra√ß√£o com APIs de operadoras (Vivo, Claro, TIM, Oi), dashboard executivo de curva de gastos e alertas preditivos de estouro de budget.

**Objetivo Principal**: Eliminar erros de cobran√ßa (economia m√©dia 12-18% do valor total de faturas), automatizar concilia√ß√£o que hoje leva 40 horas/m√™s para 2 horas/m√™s, garantir rastreabilidade total de gastos para compliance (LGPD, SOX), identificar oportunidades de renegocia√ß√£o de contratos (an√°lise de consumo real vs. contratado) e fornecer visibilidade gerencial de custos de Telecom/TI que representam 8-15% do OPEX total das empresas.

### Contexto: Legado vs. Moderniza√ß√£o

| Aspecto | Legado (VB.NET) | Moderniza√ß√£o (.NET 10) |
|---------|----------------|----------------------|
| **Importa√ß√£o** | Upload manual CSV (1 layout fixo, quebra sempre) | Multi-layout engine com templates por operadora + OCR de PDF |
| **Concilia√ß√£o** | Manual em planilha Excel (40h/m√™s, erros 15%) | Algoritmo ML autom√°tico com 98% acur√°cia em 2h/m√™s |
| **Auditoria** | Checklist papel (descobre erro ap√≥s pagar) | Regras configur√°veis executadas pr√©-pagamento |
| **Rateio** | Planilha Excel com VLOOKUP (recalculo = 8h) | Motor multi-dimensional em tempo real (segundos) |
| **Contesta√ß√£o** | Email manual + telefone (sem rastreamento) | Workflow integrado com portal operadora + hist√≥rico completo |
| **Relat√≥rios** | Excel est√°tico exportado semanalmente | Dashboards Chart.js tempo real + BI drill-down |
| **Alertas** | Nenhum (descobre estouro ao fechar m√™s) | Alertas preditivos 7/15/30 dias antes limite |
| **APIs Operadoras** | Nenhuma integra√ß√£o | Consumo autom√°tico APIs Vivo/Claro/TIM |
| **OCR PDF** | N√£o suportado (exige CSV da operadora) | Azure Form Recognizer extrai dados de PDF scaneado |
| **Mobile** | Nenhum app | MAUI app para aprovar contesta√ß√µes on-the-go |

### 10 Funcionalidades Principais

1. **Importa√ß√£o Multi-Layout**: Engine inteligente com 15+ templates pr√©-configurados (Vivo, Claro, TIM, Oi, Embratel, Level 3, AWS, Azure, Google Cloud) + builder visual para criar layouts customizados
2. **OCR de PDF Automatizado**: Azure Form Recognizer + custom model treinado com 10.000+ faturas reais para extrair campos-chave (valor total, linhas, consumo, impostos) com 95% acur√°cia
3. **Concilia√ß√£o Inteligente**: Algoritmo de matching difuso (Levenshtein distance) para reconciliar linhas/ativos com contratos mesmo com diverg√™ncias (ex: "(11) 98765-4321" vs. "11987654321" vs. "+55 11 98765-4321")
4. **Auditoria Configur√°vel**: 25+ regras pr√©-definidas (ex: linha cobrada sem contrato, valor >15% da m√©dia hist√≥rica, servi√ßo cancelado mas cobrado, roaming internacional n√£o autorizado)
5. **Workflow de Contesta√ß√£o**: Fluxo completo - identificar erro ‚Üí criar ticket ‚Üí enviar para operadora ‚Üí acompanhar SLA ‚Üí receber cr√©dito ‚Üí validar pr√≥xima fatura
6. **Rateio Multi-Dimensional**: Motor distribui√ß√£o de custos por 5 dimens√µes (Centro Custo, Projeto, Departamento, Geolocaliza√ß√£o, Tipo Servi√ßo) com regras de percentual fixo, proporcional ao consumo ou misto
7. **Dashboard Executivo**: Gr√°ficos - curva de gastos 12 meses, top 10 maiores contas, distribui√ß√£o por tipo servi√ßo, varia√ß√£o MoM/YoY, forecast 3 meses, oportunidades economia
8. **Alertas Preditivos**: Machine Learning prev√™ estouro de budget com 30 dias anteced√™ncia baseado em tend√™ncias hist√≥ricas + consumo atual projetado
9. **Integra√ß√£o APIs Operadoras**: Consumo autom√°tico APIs (quando dispon√≠veis) para baixar faturas, consultar consumo em tempo real, enviar contesta√ß√µes e verificar status de tickets
10. **Aprova√ß√£o Mobile**: App MAUI para gestores aprovarem contesta√ß√µes, rateios e pagamentos via smartphone com notifica√ß√µes push e assinatura digital

### Impacto de Neg√≥cio

- **Economia Direta:** Recupera√ß√£o de 12-18% em cobran√ßas indevidas (m√©dia R$180k/ano para empresa com R$1,5M/ano Telecom)
- **Efici√™ncia Operacional:** Redu√ß√£o de 95% no tempo de concilia√ß√£o (de 40h/m√™s para 2h/m√™s) = R$42k/ano economia RH
- **Compliance:** Rastreabilidade total (LGPD, SOX) elimina 100% das n√£o-conformidades em auditorias
- **ROI:** Sistema paga-se em 3 meses com economia em cobran√ßas + efici√™ncia
- **Visibilidade:** Dashboards permitem renegocia√ß√£o proativa de contratos (economia adicional 8-12%)

---

## üìê 2. REGRAS DE NEG√ìCIO

### RN-FAT-026-01: Importa√ß√£o Suporta M√∫ltiplos Layouts

**Descri√ß√£o**: Sistema DEVE suportar importa√ß√£o de faturas em m√∫ltiplos formatos (CSV, XLS, XLSX, TXT, PDF) com templates configur√°veis por operadora/fornecedor. Cada template define mapeamento de colunas, delimitadores, encoding e regras de valida√ß√£o.

**Templates Padr√£o**: Sistema vem com 15+ templates pr√©-configurados:
- Telecom: Vivo Empresas, Claro Corporate, TIM Corporate, Oi Solu√ß√µes, Embratel, Level 3
- Cloud: AWS Billing, Azure Cost Management, Google Cloud Billing
- SaaS: Microsoft 365, Salesforce, Adobe Creative Cloud

**Builder Visual**: Usu√°rio administrador pode criar novos templates via interface drag-and-drop sem c√≥digo:
1. Upload arquivo exemplo
2. Marcar linha de cabe√ßalho
3. Mapear colunas (Campo Sistema ‚Üê Coluna Arquivo)
4. Definir regras transforma√ß√£o (ex: remover "R$", converter data "DD/MM/AAAA" ‚Üí ISO)
5. Validar com 10 linhas amostra
6. Salvar template reutiliz√°vel

**Valida√ß√£o**: Sistema detecta automaticamente encoding (UTF-8, ISO-8859-1, Windows-1252) e delimitador (`,`, `;`, `\t`, `|`).

**Erro**: 400 Bad Request se arquivo n√£o corresponde a nenhum template conhecido + sugest√£o de template mais pr√≥ximo.

### RN-FAT-026-02: OCR de PDF com Azure Form Recognizer

**Descri√ß√£o**: Se arquivo √© PDF (n√£o estruturado), sistema DEVE extrair dados via OCR usando Azure Form Recognizer com custom model treinado com 10.000+ faturas reais brasileiras.

**Campos Extra√≠dos**:
- Identifica√ß√£o: N√∫mero fatura, data emiss√£o, data vencimento, operadora, CNPJ
- Valores: Total bruto, descontos, acr√©scimos, total l√≠quido, impostos (ICMS, PIS, COFINS)
- Detalhamento: Linhas/ativos cobrados, consumo individual, valores por servi√ßo

**Confian√ßa M√≠nima**: Sistema aceita apenas campos com confidence score ‚â• 85%. Campos <85% marcados para revis√£o manual.

**Revis√£o Manual**: UI exibe PDF lado a lado com dados extra√≠dos. Usu√°rio corrige campos marcados amarelo e valida.

**Re-treinamento**: Sistema coleta corre√ß√µes manuais para re-treinar modelo mensalmente (active learning loop).

### RN-FAT-026-03: Concilia√ß√£o Autom√°tica de Linhas com Contratos

**Descri√ß√£o**: Ao importar fatura, sistema DEVE automaticamente tentar conciliar cada linha/ativo cobrado com:
1. Contrato vigente correspondente
2. Ativo registrado no sistema (se linha telef√¥nica, chip, etc.)
3. Centro de custo/departamento respons√°vel

**Algoritmo de Matching**:
- **Exato**: N√∫mero linha/IMEI/serial number match exato ‚Üí concilia√ß√£o autom√°tica
- **Fuzzy**: Se n√£o houver match exato, usa Levenshtein distance com threshold 90% similaridade
- **Manual**: Se fuzzy <90%, marca para concilia√ß√£o manual com sugest√µes top 3

**Status Concilia√ß√£o**: Cada item fatura recebe status:
- ‚úÖ **Conciliado** - Match autom√°tico encontrado
- ‚ö†Ô∏è **Revisar** - Match fuzzy requer confirma√ß√£o
- ‚ùå **N√£o Conciliado** - Nenhum match encontrado (poss√≠vel cobran√ßa indevida)

**Relat√≥rio**: Sistema gera relat√≥rio p√≥s-importa√ß√£o: X% conciliado, Y% revisar, Z% n√£o conciliado.

### RN-FAT-026-04: Auditoria Pr√©-Pagamento com Regras Configur√°veis

**Descri√ß√£o**: Sistema DEVE executar auditoria autom√°tica ANTES da aprova√ß√£o para pagamento, aplicando regras configur√°veis (biblioteca padr√£o + custom).

**25 Regras Pr√©-Definidas**:
1. **Linha sem contrato**: Item cobrado n√£o vinculado a contrato vigente
2. **Valor >15% m√©dia**: Valor item >15% da m√©dia hist√≥rica 6 meses
3. **Servi√ßo cancelado**: Item de linha/ativo marcado como cancelado/inativo
4. **Roaming n√£o autorizado**: Cobran√ßa roaming sem workflow aprova√ß√£o pr√©via
5. **Limite excedido**: Consumo >120% do plano contratado sem notifica√ß√£o
6. **Duplicidade**: Mesmo item cobrado 2x (match n√∫mero + per√≠odo)
7. **Data inv√°lida**: Cobran√ßa per√≠odo anterior √† ativa√ß√£o ou posterior ao cancelamento
8. **ICMS suspeito**: Al√≠quota ICMS diferente da praticada no estado
9. **Assinatura duplicada**: 2+ assinaturas para mesma linha
10. **Servi√ßo VAS n√£o solicitado**: Valor agregado (ringtone, hor√≥scopo) n√£o autorizado
... (15 regras adicionais)

**Custom Rules Engine**: Usu√°rio pode criar regras via interface visual:
- **Condi√ß√£o**: Campo X operador Y valor
- **A√ß√£o**: Se verdadeiro ‚Üí marcar como "Auditoria Falhou" + mensagem personalizada

**Severidade**: Cada regra tem severidade (Alta, M√©dia, Baixa):
- Alta: Bloqueia aprova√ß√£o at√© resolu√ß√£o
- M√©dia: Permite aprova√ß√£o mas exige justificativa
- Baixa: Apenas alerta informativo

**Relat√≥rio Auditoria**: PDF export√°vel com todas as n√£o-conformidades encontradas + valor total suspeito.

### RN-FAT-026-05: Workflow de Contesta√ß√£o Formal

**Descri√ß√£o**: Quando auditoria identifica cobran√ßa indevida, usu√°rio DEVE poder criar contesta√ß√£o formal com workflow de aprova√ß√£o e integra√ß√£o com operadora.

**Fluxo Contesta√ß√£o**:
1. **Cria√ß√£o**: Selecionar itens auditoria + anexar evid√™ncias (ex: email cancelamento)
2. **Aprova√ß√£o Interna**: Gerente departamento aprova contesta√ß√£o
3. **Envio Operadora**: Sistema envia via API (se dispon√≠vel) ou gera email formal + anexos
4. **Acompanhamento SLA**: Sistema rastreia prazo resposta operadora (5/10/15 dias √∫teis conforme SLA contratual)
5. **Resposta Operadora**: Registrar resposta (aceito total, aceito parcial, negado) + justificativa
6. **Cr√©dito Pr√≥xima Fatura**: Validar se cr√©dito apareceu na fatura seguinte
7. **Fechamento**: Marcar contesta√ß√£o como resolvida ou escalar para jur√≠dico/Anatel

**Prazo SLA Alerta**: Se operadora n√£o responde em 80% do prazo SLA, sistema envia alerta autom√°tico para gestor + escala para supervisor.

**Hist√≥rico Completo**: Timeline visual com todos os eventos (cria√ß√£o, aprova√ß√£o, envio, resposta, cr√©dito) e respons√°veis.

**Taxa Sucesso**: Dashboard KPI mostrando % contesta√ß√µes aceitas, valor m√©dio recuperado, tempo m√©dio resolu√ß√£o por operadora.

### RN-FAT-026-06: Rateio Multi-Dimensional Autom√°tico

**Descri√ß√£o**: Sistema DEVE calcular rateio de custos automaticamente com suporte a 5 dimens√µes (Centro Custo, Projeto, Departamento, Geolocaliza√ß√£o, Tipo Servi√ßo) e regras configur√°veis.

**Tipos de Rateio**:
1. **Percentual Fixo**: Ex: 60% Depto A, 40% Depto B
2. **Proporcional ao Consumo**: Distribui valor total proporcionalmente ao consumo real de cada unidade
3. **Misto**: Combina fixo + proporcional (ex: assinatura fixa rateada igualmente, consumo rateado proporcionalmente)
4. **Por Ativo**: Cada linha/ativo j√° tem centro custo pr√©-definido
5. **Hier√°rquico**: Rateia n√≠vel 1 (empresas) ‚Üí n√≠vel 2 (filiais) ‚Üí n√≠vel 3 (centros custo)

**Regras de Rateio**: Usu√°rio cria regras via UI:
- **Se** Tipo Servi√ßo = "Telefonia M√≥vel" **E** Valor > R$100 ‚Üí Ratear 70% Usu√°rio, 30% Empresa
- **Se** Centro Custo = "TI" ‚Üí 100% Projeto "Transforma√ß√£o Digital"

**Valida√ß√£o**: Sistema valida que soma percentuais = 100% antes de salvar regra.

**Recalculo Autom√°tico**: Se alterar regra, sistema oferece op√ß√£o recalcular rateios de faturas anteriores (√∫ltimos 12 meses).

**Exporta√ß√£o Cont√°bil**: Gera lan√ßamentos cont√°beis em formato CSV/TXT para importar em ERP (SAP, TOTVS, Protheus) com c√≥digos cont√°beis mapeados por dimens√£o.

### RN-FAT-026-07: Dashboard Executivo com KPIs Cr√≠ticos

**Descri√ß√£o**: Sistema DEVE exibir dashboard executivo com 10+ KPIs principais atualizados em tempo real via SignalR.

**KPIs Principais**:
1. **Gasto Total M√™s**: Valor total faturas aprovadas no m√™s
2. **Varia√ß√£o MoM**: % varia√ß√£o vs. m√™s anterior (green ‚Üì, red ‚Üë)
3. **Varia√ß√£o YoY**: % varia√ß√£o vs. mesmo m√™s ano anterior
4. **Top 10 Maiores Contas**: Ranking linhas/ativos por valor
5. **Distribui√ß√£o por Tipo**: Pie chart - telefonia m√≥vel, fixa, internet, cloud, SaaS
6. **Curva de Gastos 12 Meses**: Line chart evolu√ß√£o temporal
7. **Forecast 3 Meses**: Previs√£o ML baseada em tend√™ncias
8. **Taxa Economia Auditoria**: % valor recuperado em contesta√ß√µes
9. **Taxa Concilia√ß√£o**: % itens conciliados automaticamente
10. **Alertas Ativos**: Contador de alertas cr√≠ticos pendentes

**Drill-Down**: Todos os gr√°ficos permitem drill-down (ex: clica em "Telefonia M√≥vel" ‚Üí lista detalhada linhas m√≥veis).

**Exporta√ß√£o**: Dashboard export√°vel em PDF (snapshot mensal) ou Excel (dados brutos).

**Permiss√µes**: Visibilidade configur√°vel por perfil (executivo v√™ consolidado, gestor v√™ apenas seu centro custo).

### RN-FAT-026-08: Alertas Preditivos de Estouro de Budget

**Descri√ß√£o**: Sistema DEVE usar Machine Learning para prever estouros de budget com 7/15/30 dias de anteced√™ncia.

**Modelo ML**: Random Forest Regressor treinado com:
- Features: Consumo hist√≥rico 12 meses, sazonalidade, crescimento headcount, novos contratos, cancelamentos
- Target: Valor total fatura m√™s N+1

**Threshold Alerta**: Dispara alerta se previs√£o >90% do budget aprovado.

**Canais Notifica√ß√£o**:
- **7 dias antes**: Email para controller + gestor TI
- **15 dias antes**: Email + push notification mobile
- **30 dias antes**: Email + push + in-app notification + dashboard highlight

**A√ß√£o Recomendada**: Alerta inclui sugest√µes autom√°ticas:
- "Consumo voz +35% vs. m√©dia ‚Üí revisar plano corporativo"
- "5 novas linhas ativadas sem planejamento ‚Üí validar necessidade"
- "Roaming internacional R$12k (usual R$2k) ‚Üí bloquear roaming preventivamente"

**Feedback Loop**: Sistema registra se alerta resultou em a√ß√£o corretiva e aprimora modelo com essas informa√ß√µes.

### RN-FAT-026-09: Integra√ß√£o com APIs de Operadoras

**Descri√ß√£o**: Sistema DEVE integrar com APIs REST de operadoras (quando dispon√≠veis) para automatizar download de faturas, consulta de consumo e envio de contesta√ß√µes.

**APIs Suportadas**:
- **Vivo Empresas API**: Download faturas PDF/XML, consulta consumo em tempo real, abertura de tickets
- **Claro Corporate API**: Download faturas, hist√≥rico chamadas, gest√£o de linhas
- **TIM Corporate Portal**: Web scraping automatizado (n√£o possui API oficial)

**Autentica√ß√£o**: OAuth 2.0 com refresh token autom√°tico (v√°lido 90 dias) + armazenamento seguro em Azure Key Vault.

**Polling Autom√°tico**: Hangfire job executa diariamente √†s 02:00 UTC verificando novas faturas dispon√≠veis nas APIs.

**Fallback Manual**: Se API falha 3x consecutivas, sistema envia email para usu√°rio fazer upload manual + notifica equipe TI.

**Rate Limiting**: Respeita rate limits das APIs (ex: Vivo 100 req/min) com retry backoff exponencial (Polly policy).

### RN-FAT-026-10: Aprova√ß√£o Mobile com Assinatura Digital

**Descri√ß√£o**: Gestores DEVEM poder aprovar pagamentos de faturas, contesta√ß√µes e rateios via app mobile MAUI com assinatura digital.

**App MAUI Features**:
- Login biom√©trico (FaceID, TouchID, digital)
- Push notifications de faturas pendentes
- Visualizar resumo fatura (valor, per√≠odo, varia√ß√£o vs. m√™s anterior)
- Drill-down em itens principais
- Aprovar/Rejeitar com justificativa obrigat√≥ria se rejeitar
- Assinatura digital via DocuSign Mobile SDK

**Assinatura Digital**: Integra√ß√£o DocuSign para workflow legalmente v√°lido:
1. Fatura pronta para aprova√ß√£o ‚Üí gera PDF
2. Envia para DocuSign com template pr√©-configurado
3. Gestor assina via app mobile
4. Callback webhook atualiza status fatura para "Aprovada"

**Offline Mode**: App permite visualizar faturas j√° baixadas mesmo sem internet. Aprova√ß√µes ficam em fila e sincronizam quando reconectar.

**Auditoria**: Toda a√ß√£o no app mobile √© logada (timestamp, geolocaliza√ß√£o GPS, device ID, IP) para compliance SOX.

### RN-FAT-026-11: Isolamento Multi-Tenant Obrigat√≥rio

**Descri√ß√£o**: TODAS as queries e opera√ß√µes DEVEM filtrar por `ClienteId` obtido do JWT token do usu√°rio logado.

**Seguran√ßa**: Usu√°rio de Cliente A N√ÉO pode ver/editar/deletar faturas de Cliente B mesmo se descobrir o ID.

**Performance**: √çndice composto (ClienteId, DataEmissao DESC) otimiza queries mais comuns.

### RN-FAT-026-12: Soft Delete Obrigat√≥rio

**Descri√ß√£o**: Sistema NUNCA deve fazer DELETE f√≠sico de faturas. Exclus√£o l√≥gica via flag `FlExcluido = TRUE`.

**Motivo**: Preservar hist√≥rico completo para auditorias fiscais (obrigat√≥rio manter 7 anos conforme legisla√ß√£o).

**Queries**: Todas as queries incluem `WHERE FlExcluido = 0` por padr√£o (EF Core Query Filter global).

### RN-FAT-026-13: Hist√≥rico de Vers√µes de Fatura

**Descri√ß√£o**: Se fatura √© reimportada ou corrigida manualmente, sistema DEVE criar nova vers√£o preservando vers√µes anteriores.

**Versionamento**: Tabela `Fatura_Versao` com campos:
- Numero_Versao (1, 2, 3...)
- Data_Versao
- Usuario_Responsavel
- Motivo_Alteracao (obrigat√≥rio se v2+)
- Snapshot_Dados (JSON completo da vers√£o)

**Compara√ß√£o**: UI permite comparar vers√µes lado a lado (diff highlighting).

**Restaura√ß√£o**: Administrador pode restaurar vers√£o anterior com justificativa.

### RN-FAT-026-14: Integra√ß√£o com ERP Financeiro

**Descri√ß√£o**: Sistema DEVE sincronizar faturas aprovadas com ERP financeiro via API REST ou arquivo CSV/TXT.

**Formatos Suportados**:
- **SAP**: IDoc INVOIC02
- **TOTVS Protheus**: TXT layout CNAB
- **API REST gen√©rica**: JSON payload

**Dados Sincronizados**:
- Cabe√ßalho fatura (n√∫mero, fornecedor, valor total, vencimento)
- Rateio cont√°bil (centro custo, conta cont√°bil, percentual)
- Anexos (PDF fatura original)

**Retry Policy**: Polly com 3 tentativas (backoff 2s, 4s, 8s) se falha.

**Dead Letter Queue**: Eventos n√£o sincronizados ap√≥s 3 tentativas v√£o para DLQ (Azure Service Bus) para reprocessamento manual.

### RN-FAT-026-15: Campos Obrigat√≥rios por Status

**Descri√ß√£o**: Campos obrigat√≥rios variam por status da fatura:

**Rascunho** (importa√ß√£o em andamento):
- Apenas: Arquivo_Original, Data_Importacao

**Aguardando Concilia√ß√£o**:
- + Operadora, Periodo_Referencia, Data_Emissao, Valor_Total

**Aguardando Auditoria**:
- + Resultado_Conciliacao (% conciliado)

**Aguardando Aprova√ß√£o**:
- + Resultado_Auditoria (aprovado/reprovado), Rateio_Calculado

**Aprovada**:
- + Aprovador_Id, Data_Aprovacao, Assinatura_Digital_Id

**Paga**:
- + Data_Pagamento, Numero_Documento_Pagamento

**Valida√ß√£o**: FluentValidation com regras condicionais baseadas em status.

---

## üóÑÔ∏è 3. BANCO DE DADOS LEGADO

### Contexto do Sistema Legado

Sistema legado VB.NET/ASP.NET Web Forms tinha gest√£o rudimentar de faturas com problemas cr√≠ticos:
1. **Importa√ß√£o Manual**: Upload √∫nico arquivo CSV com layout fixo - quebrava a cada mudan√ßa da operadora
2. **Sem Concilia√ß√£o Autom√°tica**: Controlador comparava manualmente em planilha Excel
3. **Auditoria Manual**: Checklist em papel impresso - descobria erros ap√≥s pagar
4. **Rateio em Excel**: VLOOKUP complexos - recalcular = 8 horas de trabalho
5. **Sem Workflow**: Aprova√ß√£o por email - nenhum hist√≥rico rastre√°vel

### Estrutura Legado Existente

**Fatura** (tabela principal):
- Campos: Id_Fatura, Num_Fatura, Dt_Emissao, Dt_Vencimento, Id_Operadora, Valor_Total, Observacao, Fl_Paga
- N√£o tinha: Status workflow, vers√µes, auditoria autom√°tica, OCR metadata

**Fatura_Detalhe** (linhas fatura):
- Campos: Id_Fatura, Numero_Linha, Descricao_Servico, Valor, Qtde
- N√£o tinha: Concilia√ß√£o com contrato/ativo, resultado auditoria

**Fatura_Rateio** (rateio manual):
- Campos: Id_Fatura, Id_Centro_Custo, Percentual, Valor
- N√£o tinha: Regras autom√°ticas, multi-dimensional, recalculo

**Tabelas Ausentes**:
- N√£o existiam `Fatura_Auditoria` (regras), `Fatura_Contestacao` (workflow), `Fatura_Versao` (hist√≥rico), `Fatura_Importacao_Log` (rastreamento uploads), `Fatura_Anexos` (PDFs)

### Migra√ß√£o para Sistema Moderno

Sistema moderno introduz 12 tabelas:

**Fatura (Evolu√≠da)**:
Adicionados 40+ campos incluindo Status workflow (Enum: Rascunho, Conciliacao, Auditoria, Aprovacao, Aprovada, Paga, Contestada, Cancelada), OCR metadata (OCR_Confidence, OCR_Raw_JSON), Impostos detalhados (ICMS, PIS, COFINS, ISS), Integra√ß√£o ERP (ERP_Sincronizado, ERP_Documento_Numero, ERP_Data_Sync), Versionamento (Numero_Versao, Versao_Atual_Flag).

**Fatura_Detalhe (Evolu√≠da)**:
Adicionados campos Conciliacao (Conciliado, Id_Contrato_Item, Id_Ativo, Match_Score), Auditoria (Auditoria_Status, Auditoria_Regras_Falhas JSON), Rateio (Rateio_Centro_Custo, Rateio_Projeto, Rateio_Departamento).

**Fatura_Auditoria_Regra (Nova)**:
Biblioteca de regras de auditoria (Id, Nome_Regra, Descricao, Severidade, Condicao_SQL, Ativa, Parametros_JSON).

**Fatura_Auditoria_Resultado (Nova)**:
Log de execu√ß√£o de regras por fatura (Id_Fatura, Id_Regra, Passou, Valor_Suspeito, Mensagem_Detalhada, Dt_Execucao).

**Fatura_Contestacao (Nova)**:
Workflow completo de contesta√ß√£o (Id_Fatura, Itens_Contestados JSON, Valor_Total_Contestado, Status workflow, Aprovador_Interno_Id, Dt_Envio_Operadora, Resposta_Operadora, Credito_Recebido, Dt_Fechamento).

**Fatura_Rateio_Regra (Nova)**:
Regras configur√°veis de rateio (Nome_Regra, Tipo rateio, Dimensoes JSON, Percentuais, Ativa).

**Fatura_Importacao_Template (Nova)**:
Templates de layouts (Nome_Template, Operadora, Formato, Mapeamento_Colunas JSON, Regras_Transformacao JSON, Ativo).

**Fatura_Importacao_Log (Nova)**:
Hist√≥rico de uploads (Arquivo_Nome, Template_Usado, Linhas_Total, Linhas_Sucesso, Linhas_Erro, Erros_JSON, Dt_Importacao, Usuario_Id).

**Fatura_Anexos (Nova)**:
Armazena PDFs originais (Tipo documento, Azure_Blob_URL, SHA256_Hash, Tamanho_Bytes, Dt_Upload).

**Fatura_Aprovacao (Nova)**:
Workflow aprova√ß√£o (Id_Fatura, Nivel_Aprovacao 1/2/3, Aprovador_Id, Status, Justificativa_Rejeicao, DocuSign_Envelope_Id, Dt_Assinatura).

**Fatura_KPI_Snapshot (Nova)**:
Snapshots di√°rios de KPIs para dashboard hist√≥rico (Dt_Snapshot, Gasto_Total, Taxa_Conciliacao, Taxa_Auditoria, Valor_Contestado, ClienteId).

**Fatura_Previsao_ML (Nova)**:
Armazena previs√µes do modelo ML (Mes_Referencia, Valor_Previsto, Confidence_Interval, Alertas_Gerados JSON, Dt_Previsao).

---

## üîå 4. WEBSERVICES LEGADO

### Contexto

Sistema legado VB.NET utilizava Web Services SOAP b√°sicos com limita√ß√µes severas:
- Importa√ß√£o apenas CSV layout fixo
- Sem auditoria autom√°tica
- Processamento s√≠ncrono (timeout em arquivos >5MB)

### Web Services SOAP Existentes

**Endpoint Base**: `http://servidor/IControlIT/Fatura.asmx`
**Protocolo**: SOAP 1.1
**Autentica√ß√£o**: Windows Authentication

#### M√©todos Principais

**1. ImportarFatura()**
- **Entrada**: Arquivo CSV Base64, IdOperadora
- **Sa√≠da**: IdFatura (INT) ou Exception
- **L√≥gica**: Parse linha por linha, INSERT em Fatura + Fatura_Detalhe
- **Problema**: Layout fixo quebrava a cada mudan√ßa da operadora, timeout em arquivos >1000 linhas

**2. ConsultarFaturas()**
- **Entrada**: Filtros (Operadora, Periodo, Status)
- **Sa√≠da**: Array de FaturaDto
- **Problema**: Sem pagina√ß√£o, query lenta (>5s com 500 faturas)

**3. AprovarFatura()**
- **Entrada**: IdFatura, IdUsuario
- **Sa√≠da**: Boolean
- **Problema**: Sem workflow (aprova√ß√£o direta), sem assinatura digital, sem auditoria de quem aprovou

**4. RatearFatura()**
- **Entrada**: IdFatura, Array<RateioDto>
- **Sa√≠da**: Boolean
- **Problema**: Rateio manual item por item, sem valida√ß√£o soma 100%, sem regras reutiliz√°veis

### Evolu√ß√£o para REST API Moderna

Sistema moderno substitui SOAP por REST API (.NET 10 Web API) com 25+ endpoints:

**Importa√ß√£o**:
- `POST /api/v1/faturas/importar` - Upload multi-layout (CSV/XLS/PDF) com auto-detect
- `POST /api/v1/faturas/importar/ocr` - OCR de PDF via Azure Form Recognizer
- `GET /api/v1/faturas/templates` - Listar templates dispon√≠veis
- `POST /api/v1/faturas/templates` - Criar template customizado (builder visual)

**CRUD**:
- `GET /api/v1/faturas` - Listar com pagina√ß√£o cursor-based
- `GET /api/v1/faturas/{id}` - Buscar por ID com detalhes completos
- `PUT /api/v1/faturas/{id}` - Atualizar (cria nova vers√£o)
- `DELETE /api/v1/faturas/{id}` - Soft delete

**Concilia√ß√£o**:
- `POST /api/v1/faturas/{id}/conciliar` - Executar concilia√ß√£o autom√°tica
- `GET /api/v1/faturas/{id}/conciliacao` - Resultado detalhado
- `PUT /api/v1/faturas/{id}/conciliacao/manual` - Corrigir match manual

**Auditoria**:
- `POST /api/v1/faturas/{id}/auditar` - Executar regras de auditoria
- `GET /api/v1/faturas/{id}/auditoria` - Resultados com falhas destacadas
- `GET /api/v1/faturas/regras-auditoria` - Listar regras configuradas
- `POST /api/v1/faturas/regras-auditoria` - Criar regra customizada

**Contesta√ß√£o**:
- `POST /api/v1/faturas/{id}/contestacoes` - Criar contesta√ß√£o
- `PUT /api/v1/faturas/contestacoes/{id}/aprovar` - Aprovar envio operadora
- `POST /api/v1/faturas/contestacoes/{id}/enviar` - Enviar para operadora (API/email)
- `GET /api/v1/faturas/contestacoes` - Listar contesta√ß√µes ativas
- `PUT /api/v1/faturas/contestacoes/{id}/fechar` - Fechar com resultado

**Rateio**:
- `POST /api/v1/faturas/{id}/ratear` - Calcular rateio com regras autom√°ticas
- `GET /api/v1/faturas/{id}/rateio` - Visualizar rateio calculado
- `POST /api/v1/faturas/regras-rateio` - Criar regra reutiliz√°vel
- `POST /api/v1/faturas/{id}/rateio/recalcular` - Recalcular com novas regras

**Aprova√ß√£o**:
- `POST /api/v1/faturas/{id}/aprovar` - Aprovar para pagamento (multi-n√≠vel)
- `POST /api/v1/faturas/{id}/rejeitar` - Rejeitar com justificativa
- `GET /api/v1/faturas/pendentes-aprovacao` - Fila aprova√ß√£o por usu√°rio
- `POST /api/v1/faturas/{id}/docusign` - Enviar para assinatura digital

**Dashboard/Analytics**:
- `GET /api/v1/faturas/dashboard` - KPIs principais (gasto total, varia√ß√£o MoM/YoY)
- `GET /api/v1/faturas/dashboard/curva-gastos` - S√©rie temporal 12 meses
- `GET /api/v1/faturas/dashboard/top-contas` - Ranking maiores valores
- `GET /api/v1/faturas/dashboard/forecast` - Previs√£o ML 3 meses
- `GET /api/v1/faturas/dashboard/alertas` - Alertas preditivos ativos

**Tecnologias REST Moderno**:
- **.NET 10 Minimal APIs**: Performance otimizada
- **MediatR CQRS**: Separa√ß√£o comando/query
- **Hangfire**: Jobs background (importa√ß√£o, auditoria, ML)
- **Azure Form Recognizer**: OCR de PDFs
- **ML.NET**: Modelo previs√£o gastos
- **DocuSign API**: Assinatura digital
- **SignalR**: Dashboard tempo real
- **Polly**: Resili√™ncia integra√ß√µes APIs operadoras

---

## üîó 5. REFER√äNCIAS AO LEGADO

### Mapeamento de Conceitos

| Conceito Legado | Conceito Moderno | Observa√ß√µes |
|----------------|------------------|-------------|
| Upload CSV manual | Engine multi-layout + OCR | Suporta 15+ formatos |
| Concilia√ß√£o Excel | Algoritmo fuzzy matching | 98% acur√°cia autom√°tica |
| Checklist papel auditoria | Rules engine 25+ regras | Pr√©-pagamento |
| Rateio VLOOKUP | Motor multi-dimensional | Tempo real |
| Aprova√ß√£o email | Workflow + DocuSign | Rastre√°vel + legal |
| Planilha Excel reports | Dashboard Chart.js | Tempo real + drill-down |
| Sem alertas | ML preditivo 30 dias | Previne estouros |
| Sem integra√ß√£o operadoras | APIs Vivo/Claro/TIM | Download autom√°tico |

### Funcionalidades Legado ‚Üí Moderno

| ID | Funcionalidade Legado | Funcionalidade Moderna | Status |
|----|----------------------|------------------------|--------|
| WS01 | ImportarFatura (CSV fixo) | POST /api/v1/faturas/importar (multi-layout) | üîÑ Evolu√≠do |
| WS02 | ConsultarFaturas (sem pagina√ß√£o) | GET /api/v1/faturas?cursor=X&size=50 | üîÑ Otimizado |
| WS03 | AprovarFatura (direto) | POST /api/v1/faturas/{id}/aprovar (workflow) | üîÑ + Workflow |
| WS04 | RatearFatura (manual) | POST /api/v1/faturas/{id}/ratear (autom√°tico) | üîÑ Inteligente |
| N/A | OCR de PDF | POST /api/v1/faturas/importar/ocr | ‚úÖ Nova |
| N/A | Concilia√ß√£o autom√°tica | POST /api/v1/faturas/{id}/conciliar | ‚úÖ Nova |
| N/A | Auditoria rules engine | POST /api/v1/faturas/{id}/auditar | ‚úÖ Nova |
| N/A | Workflow contesta√ß√£o | POST /api/v1/faturas/{id}/contestacoes | ‚úÖ Nova |
| N/A | Dashboard executivo | GET /api/v1/faturas/dashboard | ‚úÖ Nova |
| N/A | Previs√£o ML gastos | GET /api/v1/faturas/dashboard/forecast | ‚úÖ Nova |
| N/A | App mobile aprova√ß√£o | MAUI + DocuSign | ‚úÖ Nova |
| N/A | Integra√ß√£o APIs operadoras | Hangfire jobs | ‚úÖ Nova |

### Telas Legado vs. Moderno

| Tela ASP.NET WebForms | Angular Moderno | Melhorias |
|-----------------------|-----------------|-----------|
| Fatura\Upload.aspx | /faturas/importar | Multi-layout picker + OCR preview |
| Fatura\Lista.aspx | /faturas | Filtros avan√ßados + status workflow |
| Fatura\Detalhes.aspx | /faturas/{id} | Timeline vers√µes + auditoria visual |
| Fatura\Rateio.aspx | /faturas/{id}/rateio | Regras autom√°ticas + preview |
| N/A | /faturas/contestacoes | Workflow completo + SLA tracking |
| N/A | /dashboard/faturas | Gr√°ficos Chart.js tempo real |
| N/A (Excel) | /faturas/templates/builder | Visual template builder drag-drop |

### Migra√ß√£o de Dados

**Faturas Legado**: 2.400 faturas migradas (24 meses √ó 100/m√™s) preservando dados essenciais.

**Recalculos**: Auditoria e rateio N√ÉO recalculados retroativamente (dados originais preservados).

**Status Normaliza√ß√£o**: Faturas pagas marcadas como "Paga", pendentes como "Aguardando Aprova√ß√£o".

**Valida√ß√£o**: Script p√≥s-migra√ß√£o valida 100% integridade (FKs, valores, per√≠odos).

---

## üìö REFER√äNCIAS T√âCNICAS

### Documenta√ß√£o Relacionada

- [ROADMAP-BASE.md](../../../../ROADMAP-BASE.md)
- [RF-027: Gest√£o de Aditivos Contratos](../RF027-Gestao-de-Aditivos-Contratos/RF027.md)
- [RF-028: Gest√£o de SLA Opera√ß√µes](../RF028-Gestao-de-SLA-Operacoes/RF028.md)

### Tecnologias Utilizadas

- **.NET 10**: Framework backend
- **Entity Framework Core 10**: ORM
- **MediatR**: CQRS pattern
- **Hangfire**: Background jobs
- **Azure Form Recognizer**: OCR
- **ML.NET**: Machine Learning
- **DocuSign API**: Assinatura digital
- **SignalR**: Real-time dashboards
- **Chart.js**: Gr√°ficos interativos
- **Azure Service Bus**: DLQ contesta√ß√µes
- **Polly**: Resili√™ncia

---

**√öltima Revis√£o**: 17/12/2025
**Revisado Por**: Equipe IControlIT Architect
**Pr√≥xima Revis√£o**: 17/03/2026
