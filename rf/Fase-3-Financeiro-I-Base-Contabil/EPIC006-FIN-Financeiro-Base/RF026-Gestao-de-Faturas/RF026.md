# RF-026: Gest√£o Completa de Faturas de Telecom e TI

**Vers√£o**: 2.0
**Data**: 2025-12-30
**Autor**: Ag√™ncia ALC - alc.dev.br
**EPIC**: EPIC006-FIN-Financeiro-Base
**Fase**: Fase 3 - Financeiro I - Base Cont√°bil
**Prioridade**: CR√çTICA
**Complexidade**: MUITO ALTA

[‚Üê Voltar](../README.md)

---

## 1. OBJETIVO DO REQUISITO

Prover capacidade completa de gest√£o de faturas de servi√ßos de Telecom (telefonia m√≥vel, fixa, internet, links dedicados) e TI (cloud computing, licen√ßas SaaS, suporte t√©cnico) com importa√ß√£o automatizada multi-layout, concilia√ß√£o inteligente contra contratos, auditoria configur√°vel pr√©-pagamento, rateio multi-dimensional, workflow de contesta√ß√£o formal e dashboard executivo com alertas preditivos de estouro de budget.

**Objetivo de Neg√≥cio**: Eliminar cobran√ßas indevidas (economia 12-18% do valor total de faturas), automatizar concilia√ß√£o manual de 40h/m√™s para 2h/m√™s, garantir rastreabilidade total para compliance (LGPD, SOX), identificar oportunidades de renegocia√ß√£o de contratos e fornecer visibilidade gerencial de custos de Telecom/TI que representam 8-15% do OPEX das empresas.

**Problema Resolvido**: Processos manuais de concilia√ß√£o (planilhas Excel com 40h/m√™s de trabalho repetitivo), descoberta tardia de erros de cobran√ßa (ap√≥s pagamento), falta de visibilidade de consumo em tempo real, impossibilidade de prever estouros de budget e aus√™ncia de workflow formal de contesta√ß√£o com rastreamento de SLA de operadoras.

**P√∫blico Afetado**: Controladores financeiros (aprova√ß√£o de pagamentos), gestores de TI (an√°lise de consumo), equipes de procurement (renegocia√ß√£o de contratos), usu√°rios finais (responsabiliza√ß√£o por consumo), executivos (dashboards gerenciais) e auditores (compliance fiscal).

---

## 2. ESCOPO

### 2.1 O que est√° dentro do escopo

- [x] Importa√ß√£o multi-layout (CSV, XLS, XLSX, TXT, PDF) com 15+ templates pr√©-configurados (Vivo, Claro, TIM, Oi, Embratel, Level 3, AWS, Azure, Google Cloud, Microsoft 365, Salesforce, Adobe) + builder visual drag-and-drop para layouts customizados
- [x] OCR de PDF automatizado via Azure Form Recognizer com custom model treinado (10.000+ faturas reais, 95% acur√°cia)
- [x] Concilia√ß√£o autom√°tica de linhas/ativos com contratos usando algoritmo fuzzy matching (Levenshtein distance, threshold 90% similaridade) + matching exato (n√∫mero, IMEI, serial)
- [x] Auditoria configur√°vel com 25+ regras pr√©-definidas (linha sem contrato, valor >15% m√©dia hist√≥rica, servi√ßo cancelado mas cobrado, roaming n√£o autorizado, duplicidade, data inv√°lida, ICMS suspeito, servi√ßos VAS n√£o solicitados) + custom rules engine visual
- [x] Workflow contesta√ß√£o formal (7 etapas: cria√ß√£o ‚Üí aprova√ß√£o interna ‚Üí envio operadora ‚Üí acompanhamento SLA ‚Üí resposta ‚Üí valida√ß√£o cr√©dito ‚Üí fechamento)
- [x] Rateio multi-dimensional autom√°tico (5 dimens√µes: Centro Custo, Projeto, Departamento, Geolocaliza√ß√£o, Tipo Servi√ßo) com 5 tipos de rateio (percentual fixo, proporcional ao consumo, misto, por ativo, hier√°rquico)
- [x] Dashboard executivo Chart.js com 10+ KPIs (gasto total m√™s, varia√ß√£o MoM/YoY, top 10 maiores contas, distribui√ß√£o por tipo, curva 12 meses, forecast 3 meses ML, taxa economia auditoria, taxa concilia√ß√£o, alertas ativos) atualizados em tempo real via SignalR
- [x] Alertas preditivos ML (Random Forest Regressor) para prever estouros de budget com 7/15/30 dias de anteced√™ncia baseado em tend√™ncias hist√≥ricas + consumo atual projetado
- [x] Integra√ß√£o com APIs REST de operadoras (Vivo Empresas API, Claro Corporate API, TIM web scraping quando API indispon√≠vel) com autentica√ß√£o OAuth 2.0 + polling autom√°tico (Hangfire job di√°rio √†s 02:00 UTC)
- [x] App mobile MAUI para aprova√ß√£o de contesta√ß√µes/rateios/pagamentos via smartphone com login biom√©trico, push notifications, assinatura digital DocuSign Mobile SDK e offline mode
- [x] Isolamento multi-tenant obrigat√≥rio (filtro ClienteId em todas as queries)
- [x] Soft delete obrigat√≥rio (preserva√ß√£o de hist√≥rico 7 anos para compliance fiscal)
- [x] Versionamento de faturas (preservar snapshots de vers√µes anteriores em caso de reimporta√ß√£o/corre√ß√£o manual)
- [x] Integra√ß√£o com ERP financeiro (SAP IDoc INVOIC02, TOTVS Protheus TXT layout CNAB, API REST gen√©rica) com retry policy (Polly 3 tentativas) + dead letter queue (Azure Service Bus)
- [x] Valida√ß√µes condicionais por status (FluentValidation com regras que variam conforme workflow: Rascunho ‚Üí Aguardando Concilia√ß√£o ‚Üí Aguardando Auditoria ‚Üí Aguardando Aprova√ß√£o ‚Üí Aprovada ‚Üí Paga)

### 2.2 Fora do escopo (n√£o objetivos)

- Interface visual espec√≠fica (design e UX s√£o responsabilidade do frontend Angular)
- Tecnologia, framework ou linguagem (exceto integra√ß√µes obrigat√≥rias: Azure Form Recognizer, DocuSign, APIs operadoras)
- Layout, UX ou identidade visual (Fuse Admin Template)
- Estrat√©gia de deploy ou infraestrutura (responsabilidade DevOps)
- Gest√£o de contratos (responsabilidade RF-023)
- Gest√£o de ativos (responsabilidade RF-025)
- Contabiliza√ß√£o de lan√ßamentos cont√°beis (apenas gera√ß√£o de arquivo para importar no ERP)

---

## 3. CONCEITOS E DEFINI√á√ïES

| Termo | Defini√ß√£o |
|-------|-----------|
| **Fatura** | Documento fiscal emitido por operadora/fornecedor cobrando servi√ßos de Telecom/TI em per√≠odo determinado (mensal) |
| **Concilia√ß√£o** | Processo de reconciliar linhas/ativos cobrados em fatura com contratos vigentes e ativos cadastrados no sistema |
| **Auditoria** | Execu√ß√£o autom√°tica de regras configur√°veis para identificar cobran√ßas indevidas antes da aprova√ß√£o para pagamento |
| **Contesta√ß√£o** | Processo formal de questionamento de cobran√ßa indevida com workflow de aprova√ß√£o interna ‚Üí envio operadora ‚Üí acompanhamento SLA ‚Üí resposta ‚Üí valida√ß√£o cr√©dito |
| **Rateio** | Distribui√ß√£o de custos de fatura por dimens√µes configur√°veis (Centro Custo, Projeto, Departamento, etc.) usando regras autom√°ticas |
| **Template de Layout** | Configura√ß√£o de mapeamento de colunas de arquivo (CSV, XLS, PDF) para campos do sistema com regras de transforma√ß√£o (ex: remover "R$", converter data "DD/MM/AAAA" ‚Üí ISO) |
| **OCR (Optical Character Recognition)** | Tecnologia de extra√ß√£o de texto de documentos scaneados/imagens usando Azure Form Recognizer com custom model treinado |
| **Fuzzy Matching** | Algoritmo de correspond√™ncia aproximada usando Levenshtein distance para reconciliar dados com diverg√™ncias (ex: "(11) 98765-4321" vs "11987654321") |
| **SLA (Service Level Agreement)** | Prazo contratual de resposta de operadora a contesta√ß√µes (t√≠pico: 5/10/15 dias √∫teis) |
| **Multi-tenant** | Isolamento l√≥gico de dados por ClienteId (cada cliente v√™ apenas suas pr√≥prias faturas) |
| **Soft Delete** | Exclus√£o l√≥gica via flag FlExcluido sem remo√ß√£o f√≠sica do banco (preserva√ß√£o de hist√≥rico 7 anos para compliance fiscal) |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Importar fatura multi-layout** - Upload de arquivo (CSV, XLS, XLSX, TXT, PDF) com auto-detect de template ou sele√ß√£o manual + valida√ß√£o de integridade + preview de dados antes de confirmar
2. **OCR de PDF automatizado** - Extra√ß√£o de dados via Azure Form Recognizer com confidence score m√≠nimo 85% + revis√£o manual para campos <85% com UI side-by-side (PDF √ó dados extra√≠dos)
3. **Conciliar fatura automaticamente** - Execu√ß√£o de algoritmo de matching (exato + fuzzy) para reconciliar linhas/ativos com contratos e ativos cadastrados + gera√ß√£o de relat√≥rio de concilia√ß√£o (X% conciliado, Y% revisar, Z% n√£o conciliado)
4. **Auditar fatura com regras configur√°veis** - Execu√ß√£o de 25+ regras pr√©-definidas + custom rules criadas via builder visual + classifica√ß√£o de severidade (Alta bloqueia aprova√ß√£o, M√©dia exige justificativa, Baixa apenas alerta) + gera√ß√£o de relat√≥rio PDF export√°vel
5. **Criar contesta√ß√£o formal** - Sele√ß√£o de itens com auditoria falhada + anexo de evid√™ncias (ex: email cancelamento) + workflow de aprova√ß√£o interna + envio para operadora (API ou email) + acompanhamento de SLA + registro de resposta + valida√ß√£o de cr√©dito em pr√≥xima fatura
6. **Calcular rateio multi-dimensional** - Aplica√ß√£o de regras de rateio (percentual fixo, proporcional, misto, por ativo, hier√°rquico) em 5 dimens√µes + valida√ß√£o de soma 100% + gera√ß√£o de lan√ßamentos cont√°beis em formato CSV/TXT para importar no ERP
7. **Aprovar fatura para pagamento** - Workflow multi-n√≠vel (Gerente ‚Üí Diretor ‚Üí CFO conforme valor) com assinatura digital DocuSign + valida√ß√£o de todas as etapas anteriores (concilia√ß√£o, auditoria, rateio) completas
8. **Visualizar dashboard executivo** - Exibi√ß√£o de 10+ KPIs em tempo real via SignalR com gr√°ficos Chart.js interativos + drill-down (ex: clica "Telefonia M√≥vel" ‚Üí lista linhas m√≥veis detalhadas) + exporta√ß√£o PDF/Excel
9. **Receber alertas preditivos de estouro** - Previs√£o ML (Random Forest) de gasto m√™s N+1 com 7/15/30 dias de anteced√™ncia + disparo de alertas se >90% do budget + sugest√µes autom√°ticas de a√ß√£o corretiva
10. **Integrar com APIs de operadoras** - Polling autom√°tico di√°rio (Hangfire job 02:00 UTC) para baixar faturas dispon√≠veis + autentica√ß√£o OAuth 2.0 com refresh token + retry policy (Polly) + fallback para upload manual se API falha 3x consecutivas
11. **Aprovar via mobile** - Login biom√©trico (FaceID, TouchID) + push notifications de faturas pendentes + visualiza√ß√£o de resumo + drill-down em itens + aprovar/rejeitar com justificativa + assinatura digital DocuSign + offline mode (sincroniza quando reconectar)
12. **Consultar hist√≥rico de vers√µes** - Visualiza√ß√£o de timeline de vers√µes de fatura (v1, v2, v3...) com dados de cada vers√£o preservados em JSON + compara√ß√£o lado a lado (diff highlighting) + restaura√ß√£o de vers√£o anterior (apenas administrador com justificativa)
13. **Sincronizar com ERP financeiro** - Envio de cabe√ßalho fatura + rateio cont√°bil + anexos via API REST ou arquivo (SAP IDoc, TOTVS TXT, gen√©rico JSON) + retry policy (Polly 3 tentativas) + dead letter queue (Azure Service Bus) para reprocessamento manual
14. **Listar faturas com filtros avan√ßados** - Pagina√ß√£o cursor-based + filtros (operadora, per√≠odo, status, valor min/max, resultado auditoria) + ordena√ß√£o configur√°vel + exporta√ß√£o de resultados
15. **Visualizar detalhes completos de fatura** - Cabe√ßalho + itens detalhados + resultado concilia√ß√£o + resultado auditoria + rateio calculado + hist√≥rico de aprova√ß√µes + contesta√ß√µes relacionadas + anexos (PDF original) + timeline de eventos

---

## 5. REGRAS DE NEG√ìCIO

### RN-RF026-001: Importa√ß√£o Suporta M√∫ltiplos Layouts

**Descri√ß√£o**: Sistema DEVE suportar importa√ß√£o de faturas em m√∫ltiplos formatos (CSV, XLS, XLSX, TXT, PDF) com templates configur√°veis por operadora/fornecedor. Cada template define mapeamento de colunas, delimitadores, encoding e regras de valida√ß√£o.

**Justificativa**: Cada operadora fornece faturas em layout pr√≥prio (diferentes colunas, ordem, delimitadores). Vers√£o anterior aceitava apenas 1 layout fixo que quebrava a cada mudan√ßa da operadora.

**Crit√©rio de Aceite**:
- Template n√£o encontrado ‚Üí rejei√ß√£o HTTP 400 com sugest√£o de template mais pr√≥ximo
- Arquivo corrompido ou formato inv√°lido ‚Üí rejei√ß√£o HTTP 400 com mensagem espec√≠fica
- Sucesso ‚Üí fatura em status "Rascunho" com preview de dados para usu√°rio confirmar

**Campos Afetados**: Template_Id, Arquivo_Original_Blob_URL, Status

**Tipo**: Valida√ß√£o T√©cnica

**Obrigat√≥rio**: Sim

---

### RN-RF026-002: OCR de PDF com Azure Form Recognizer

**Descri√ß√£o**: Se arquivo √© PDF (n√£o estruturado), sistema DEVE extrair dados via OCR usando Azure Form Recognizer com custom model treinado com 10.000+ faturas reais brasileiras. Campos extra√≠dos: N√∫mero fatura, data emiss√£o, data vencimento, operadora, CNPJ, total bruto, descontos, acr√©scimos, total l√≠quido, impostos (ICMS, PIS, COFINS), linhas/ativos cobrados, consumo individual, valores por servi√ßo.

**Justificativa**: Operadoras frequentemente enviam faturas apenas em PDF scaneado sem CSV estruturado. Vers√£o anterior n√£o suportava OCR, exigindo digita√ß√£o manual.

**Crit√©rio de Aceite**:
- Confidence score ‚â• 85% ‚Üí aceito automaticamente
- Confidence score < 85% ‚Üí marcado para revis√£o manual com UI side-by-side (PDF √ó dados extra√≠dos)
- Campos ausentes ‚Üí revis√£o manual obrigat√≥ria

**Campos Afetados**: OCR_Confidence_Score, OCR_Raw_JSON, Campos_Revisao_Manual_Pendente

**Tipo**: Valida√ß√£o T√©cnica

**Obrigat√≥rio**: Sim para arquivos PDF

---

### RN-RF026-003: Concilia√ß√£o Autom√°tica de Linhas com Contratos

**Descri√ß√£o**: Ao importar fatura, sistema DEVE automaticamente tentar conciliar cada linha/ativo cobrado com contrato vigente, ativo registrado no sistema e centro de custo respons√°vel. Algoritmo: Exato (n√∫mero linha/IMEI/serial number match exato) ‚Üí Fuzzy (Levenshtein distance threshold 90%) ‚Üí Manual (match <90% com sugest√µes top 3).

**Justificativa**: Controlador gasta 40h/m√™s conciliando manualmente em planilha Excel. Automa√ß√£o reduz para 2h/m√™s revisando apenas casos de match <90%.

**Crit√©rio de Aceite**:
- Match exato ‚Üí status "Conciliado" automaticamente
- Match fuzzy ‚â•90% ‚Üí status "Revisar" com sugest√£o top 3
- Match <90% ‚Üí status "N√£o Conciliado" para revis√£o manual obrigat√≥ria
- Relat√≥rio p√≥s-importa√ß√£o: X% conciliado, Y% revisar, Z% n√£o conciliado

**Campos Afetados**: Conciliacao_Status, Contrato_Id, Ativo_Id, Match_Score, Sugestoes_JSON

**Tipo**: Regra de Neg√≥cio Automatizada

**Obrigat√≥rio**: Sim

---

### RN-RF026-004: Auditoria Pr√©-Pagamento com Regras Configur√°veis

**Descri√ß√£o**: Sistema DEVE executar auditoria autom√°tica ANTES da aprova√ß√£o para pagamento, aplicando 25+ regras pr√©-definidas (linha sem contrato, valor >15% m√©dia hist√≥rica, servi√ßo cancelado mas cobrado, roaming n√£o autorizado, limite excedido, duplicidade, data inv√°lida, ICMS suspeito, assinatura duplicada, servi√ßos VAS n√£o solicitados) + custom rules criadas via builder visual. Severidade: Alta bloqueia aprova√ß√£o, M√©dia exige justificativa, Baixa apenas alerta.

**Justificativa**: Vers√£o anterior descobria erros ap√≥s pagar (checklist em papel). Auditoria pr√©-pagamento recupera 12-18% do valor total em cobran√ßas indevidas.

**Crit√©rio de Aceite**:
- Severidade Alta + falhou ‚Üí bloqueia transi√ß√£o para status "Aguardando Aprova√ß√£o"
- Severidade M√©dia + falhou ‚Üí permite aprova√ß√£o mas exige justificativa obrigat√≥ria (texto m√≠nimo 20 caracteres)
- Severidade Baixa ‚Üí apenas log de alerta (n√£o bloqueia)
- Relat√≥rio PDF export√°vel com todas as n√£o-conformidades + valor total suspeito

**Campos Afetados**: Auditoria_Status, Regras_Falhas_JSON, Valor_Total_Suspeito, Bloqueio_Aprovacao

**Tipo**: Regra de Neg√≥cio Automatizada

**Obrigat√≥rio**: Sim

---

### RN-RF026-005: Workflow de Contesta√ß√£o Formal

**Descri√ß√£o**: Quando auditoria identifica cobran√ßa indevida, usu√°rio DEVE poder criar contesta√ß√£o formal com workflow 7 etapas: Cria√ß√£o (sele√ß√£o itens + anexo evid√™ncias) ‚Üí Aprova√ß√£o Interna (gerente departamento) ‚Üí Envio Operadora (API ou email) ‚Üí Acompanhamento SLA (prazo 5/10/15 dias √∫teis) ‚Üí Resposta Operadora (aceito total/parcial/negado) ‚Üí Valida√ß√£o Cr√©dito (pr√≥xima fatura) ‚Üí Fechamento (resolvido ou escalar para jur√≠dico/Anatel). Sistema rastreia prazo SLA e envia alerta autom√°tico se operadora n√£o responde em 80% do prazo.

**Justificativa**: Vers√£o anterior n√£o tinha workflow formal (email + telefone sem rastreamento). Novo workflow garante rastreabilidade total e taxa de sucesso de contesta√ß√µes (KPI: % aceitas, valor m√©dio recuperado, tempo m√©dio resolu√ß√£o por operadora).

**Crit√©rio de Aceite**:
- Itens selecionados sem evid√™ncias anexadas ‚Üí alerta mas permite continuar
- Aprova√ß√£o interna negada ‚Üí contesta√ß√£o volta para status "Rascunho"
- SLA excedido 80% ‚Üí alerta autom√°tico para gestor + escala para supervisor
- Cr√©dito n√£o apareceu em pr√≥xima fatura ‚Üí alerta para reabrir contesta√ß√£o

**Campos Afetados**: Contestacao_Status, Aprovador_Interno_Id, Data_Envio_Operadora, SLA_Prazo_Dias, Resposta_Operadora, Credito_Recebido, Data_Fechamento

**Tipo**: Workflow de Neg√≥cio

**Obrigat√≥rio**: Sim

---

### RN-RF026-006: Rateio Multi-Dimensional Autom√°tico

**Descri√ß√£o**: Sistema DEVE calcular rateio de custos automaticamente com suporte a 5 dimens√µes (Centro Custo, Projeto, Departamento, Geolocaliza√ß√£o, Tipo Servi√ßo) e 5 tipos de rateio (Percentual Fixo, Proporcional ao Consumo, Misto, Por Ativo, Hier√°rquico). Regras criadas via UI visual com valida√ß√£o de soma 100% antes de salvar. Sistema oferece recalcular rateios de faturas anteriores (√∫ltimos 12 meses) se alterar regra. Gera lan√ßamentos cont√°beis em formato CSV/TXT para importar em ERP (SAP, TOTVS, Protheus) com c√≥digos cont√°beis mapeados por dimens√£o.

**Justificativa**: Controlador gasta 8 horas para recalcular rateio em planilha Excel com VLOOKUP complexos. Automa√ß√£o reduz para segundos.

**Crit√©rio de Aceite**:
- Soma percentuais ‚â† 100% ‚Üí rejei√ß√£o HTTP 400 com mensagem "Soma dos percentuais deve ser 100%"
- Regra sem dimens√£o definida ‚Üí rejei√ß√£o HTTP 400
- Sucesso ‚Üí rateio calculado em tempo real (< 2 segundos) + exporta√ß√£o CSV/TXT dispon√≠vel

**Campos Afetados**: Rateio_Regra_Id, Rateio_Dimensoes_JSON, Rateio_Percentuais_JSON

**Tipo**: Regra de Neg√≥cio Automatizada

**Obrigat√≥rio**: Sim

---

### RN-RF026-007: Dashboard Executivo com KPIs Cr√≠ticos

**Descri√ß√£o**: Sistema DEVE exibir dashboard executivo com 10+ KPIs principais atualizados em tempo real via SignalR: Gasto Total M√™s, Varia√ß√£o MoM (% vs m√™s anterior, green ‚Üì red ‚Üë), Varia√ß√£o YoY (% vs mesmo m√™s ano anterior), Top 10 Maiores Contas (ranking linhas/ativos por valor), Distribui√ß√£o por Tipo (pie chart: telefonia m√≥vel, fixa, internet, cloud, SaaS), Curva de Gastos 12 Meses (line chart evolu√ß√£o temporal), Forecast 3 Meses (previs√£o ML baseada em tend√™ncias), Taxa Economia Auditoria (% valor recuperado em contesta√ß√µes), Taxa Concilia√ß√£o (% itens conciliados automaticamente), Alertas Ativos (contador de alertas cr√≠ticos pendentes). Todos os gr√°ficos permitem drill-down (ex: clica "Telefonia M√≥vel" ‚Üí lista linhas m√≥veis detalhadas) e exporta√ß√£o PDF/Excel.

**Justificativa**: Vers√£o anterior tinha apenas Excel est√°tico exportado semanalmente. Dashboard tempo real com drill-down permite an√°lise gerencial e identifica√ß√£o proativa de oportunidades de renegocia√ß√£o de contratos.

**Crit√©rio de Aceite**:
- Dashboard carrega em < 3 segundos (mesmo com 10.000+ faturas)
- Drill-down funciona para todos os gr√°ficos
- Exporta√ß√£o PDF snapshot completo do dashboard
- Exporta√ß√£o Excel dados brutos de cada gr√°fico

**Campos Afetados**: N/A (consulta agrega√ß√µes de m√∫ltiplas tabelas)

**Tipo**: Visualiza√ß√£o de Neg√≥cio

**Obrigat√≥rio**: Sim

---

### RN-RF026-008: Alertas Preditivos de Estouro de Budget

**Descri√ß√£o**: Sistema DEVE usar Machine Learning (Random Forest Regressor) para prever estouros de budget com 7/15/30 dias de anteced√™ncia. Modelo treinado com features (consumo hist√≥rico 12 meses, sazonalidade, crescimento headcount, novos contratos, cancelamentos) e target (valor total fatura m√™s N+1). Dispara alerta se previs√£o >90% do budget aprovado com canais de notifica√ß√£o (7 dias: email controller + gestor TI; 15 dias: email + push mobile; 30 dias: email + push + in-app + dashboard highlight). Alerta inclui sugest√µes autom√°ticas de a√ß√£o corretiva (ex: "Consumo voz +35% vs m√©dia ‚Üí revisar plano corporativo", "5 novas linhas ativadas sem planejamento ‚Üí validar necessidade", "Roaming internacional R$12k (usual R$2k) ‚Üí bloquear roaming preventivamente"). Sistema registra se alerta resultou em a√ß√£o corretiva e aprimora modelo com feedback loop.

**Justificativa**: Vers√£o anterior n√£o tinha alertas (descobre estouro ao fechar m√™s quando j√° √© tarde). Alertas preditivos permitem a√ß√µes preventivas antes do estouro.

**Crit√©rio de Aceite**:
- Modelo ML atualizado mensalmente com dados novos
- Previs√£o accuracy m√≠nimo 85% (valida√ß√£o cruzada 5-fold)
- Alertas enviados exatamente nas janelas configuradas (7/15/30 dias antes)
- Feedback loop registra a√ß√µes corretivas tomadas

**Campos Afetados**: Previsao_Mes_Referencia, Previsao_Valor, Previsao_Confidence_Interval, Alertas_Gerados_JSON

**Tipo**: Regra de Neg√≥cio Preditiva (ML)

**Obrigat√≥rio**: Sim

---

### RN-RF026-009: Integra√ß√£o com APIs de Operadoras

**Descri√ß√£o**: Sistema DEVE integrar com APIs REST de operadoras (Vivo Empresas API, Claro Corporate API, TIM web scraping quando API indispon√≠vel) para automatizar download de faturas, consulta de consumo em tempo real e envio de contesta√ß√µes. Autentica√ß√£o OAuth 2.0 com refresh token autom√°tico (v√°lido 90 dias) armazenado seguro em Azure Key Vault. Hangfire job executa diariamente √†s 02:00 UTC verificando novas faturas dispon√≠veis nas APIs. Se API falha 3x consecutivas, sistema envia email para usu√°rio fazer upload manual + notifica equipe TI. Rate limiting respeita limites das APIs (ex: Vivo 100 req/min) com retry backoff exponencial (Polly policy).

**Justificativa**: Vers√£o anterior n√£o tinha integra√ß√£o com APIs de operadoras (exigia download manual de faturas). Automa√ß√£o elimina trabalho manual e reduz atraso na importa√ß√£o.

**Crit√©rio de Aceite**:
- OAuth 2.0 refresh token renovado automaticamente antes de expirar
- Polling di√°rio √†s 02:00 UTC executado via Hangfire
- Falha 3x consecutivas ‚Üí email + notifica√ß√£o TI + fallback manual ativado
- Rate limiting respeitado (n√£o excede 100 req/min para Vivo)

**Campos Afetados**: Operadora_API_Integrada, OAuth_Token_Validade, Ultima_Sincronizacao_API

**Tipo**: Integra√ß√£o Externa

**Obrigat√≥rio**: Sim (quando API dispon√≠vel)

---

### RN-RF026-010: Aprova√ß√£o Mobile com Assinatura Digital

**Descri√ß√£o**: Gestores DEVEM poder aprovar pagamentos de faturas, contesta√ß√µes e rateios via app mobile MAUI com login biom√©trico (FaceID, TouchID, digital), push notifications de faturas pendentes, visualiza√ß√£o de resumo fatura (valor, per√≠odo, varia√ß√£o vs m√™s anterior), drill-down em itens principais, aprovar/rejeitar com justificativa obrigat√≥ria se rejeitar, assinatura digital via DocuSign Mobile SDK. App permite visualizar faturas j√° baixadas mesmo sem internet (offline mode) e aprova√ß√µes ficam em fila para sincronizar quando reconectar. Toda a√ß√£o no app mobile √© logada (timestamp, geolocaliza√ß√£o GPS, device ID, IP) para compliance SOX.

**Justificativa**: Gestores em viagem n√£o conseguem aprovar faturas urgentes (vers√£o anterior era apenas web). App mobile com assinatura digital permite aprova√ß√µes on-the-go com validade legal.

**Crit√©rio de Aceite**:
- Login biom√©trico funciona em iOS e Android
- Push notification recebida em < 5 segundos ap√≥s fatura dispon√≠vel
- Offline mode permite visualizar faturas j√° baixadas
- Assinatura digital DocuSign integrada (callback webhook atualiza status)
- Auditoria completa (GPS, device, IP) de todas as a√ß√µes

**Campos Afetados**: Aprovacao_Via_Mobile, Device_Id, GPS_Latitude, GPS_Longitude, DocuSign_Envelope_Id

**Tipo**: Workflow Mobile

**Obrigat√≥rio**: Sim

---

### RN-RF026-011: Isolamento Multi-Tenant Obrigat√≥rio

**Descri√ß√£o**: TODAS as queries e opera√ß√µes DEVEM filtrar por ClienteId obtido do JWT token do usu√°rio logado. Usu√°rio de Cliente A N√ÉO pode ver/editar/deletar faturas de Cliente B mesmo se descobrir o ID (prote√ß√£o contra viola√ß√£o de seguran√ßa).

**Justificativa**: Multi-tenancy √© requisito de seguran√ßa cr√≠tico para SaaS. Vazamento de dados de um cliente para outro √© viola√ß√£o LGPD com multa at√© 2% do faturamento.

**Crit√©rio de Aceite**:
- Tentativa de acessar fatura de outro cliente ‚Üí HTTP 404 Not Found (n√£o 403 para n√£o revelar exist√™ncia)
- Queries incluem `WHERE ClienteId = @clienteIdDoToken` obrigatoriamente (EF Core Query Filter global)
- √çndice composto (ClienteId, DataEmissao DESC) otimiza queries principais

**Campos Afetados**: ClienteId (presente em TODAS as tabelas)

**Tipo**: Seguran√ßa Multi-Tenant

**Obrigat√≥rio**: Sim (CR√çTICO)

---

### RN-RF026-012: Soft Delete Obrigat√≥rio

**Descri√ß√£o**: Sistema NUNCA deve fazer DELETE f√≠sico de faturas. Exclus√£o l√≥gica via flag FlExcluido = TRUE. Motivo: Preservar hist√≥rico completo para auditorias fiscais (obrigat√≥rio manter 7 anos conforme legisla√ß√£o brasileira). Queries incluem `WHERE FlExcluido = 0` por padr√£o (EF Core Query Filter global).

**Justificativa**: Exclus√£o f√≠sica impede auditoria retroativa e viola compliance fiscal. Empresa pode ser multada se n√£o conseguir comprovar faturas dos √∫ltimos 7 anos em auditoria.

**Crit√©rio de Aceite**:
- DELETE f√≠sico n√£o permitido (bot√£o "Excluir" executa UPDATE FlExcluido = TRUE)
- Queries padr√£o n√£o retornam registros com FlExcluido = TRUE
- Administrador pode visualizar registros exclu√≠dos com filtro especial (auditoria)

**Campos Afetados**: FlExcluido, DataExclusao, UsuarioExclusaoId

**Tipo**: Seguran√ßa e Compliance

**Obrigat√≥rio**: Sim (CR√çTICO)

---

### RN-RF026-013: Hist√≥rico de Vers√µes de Fatura

**Descri√ß√£o**: Se fatura √© reimportada ou corrigida manualmente, sistema DEVE criar nova vers√£o preservando vers√µes anteriores em tabela Fatura_Versao com campos: Numero_Versao (1, 2, 3...), Data_Versao, Usuario_Responsavel, Motivo_Alteracao (obrigat√≥rio se v2+), Snapshot_Dados (JSON completo da vers√£o). UI permite comparar vers√µes lado a lado (diff highlighting) e administrador pode restaurar vers√£o anterior com justificativa.

**Justificativa**: Faturas podem ser corrigidas ap√≥s importa√ß√£o inicial (ex: operadora emite fatura corrigida). Sem versionamento, perde-se hist√≥rico do que mudou e por qu√™.

**Crit√©rio de Aceite**:
- Reimporta√ß√£o cria v2 automaticamente preservando v1
- Corre√ß√£o manual exige campo "Motivo_Alteracao" (m√≠nimo 20 caracteres)
- Compara√ß√£o lado a lado mostra diff linha por linha (highlight verde/vermelho)
- Restaura√ß√£o de vers√£o anterior apenas para perfil "Administrador"

**Campos Afetados**: Numero_Versao, Versao_Atual_Flag, Motivo_Alteracao, Snapshot_Dados_JSON

**Tipo**: Auditoria e Rastreabilidade

**Obrigat√≥rio**: Sim

---

### RN-RF026-014: Integra√ß√£o com ERP Financeiro

**Descri√ß√£o**: Sistema DEVE sincronizar faturas aprovadas com ERP financeiro via API REST ou arquivo CSV/TXT. Formatos suportados: SAP IDoc INVOIC02, TOTVS Protheus TXT layout CNAB, API REST gen√©rica JSON. Dados sincronizados: Cabe√ßalho fatura (n√∫mero, fornecedor, valor total, vencimento), Rateio cont√°bil (centro custo, conta cont√°bil, percentual), Anexos (PDF fatura original). Retry policy Polly com 3 tentativas (backoff 2s, 4s, 8s) se falha. Eventos n√£o sincronizados ap√≥s 3 tentativas v√£o para Dead Letter Queue (Azure Service Bus) para reprocessamento manual.

**Justificativa**: Sistema financeiro precisa receber dados de faturas para contabiliza√ß√£o. Integra√ß√£o manual (digita√ß√£o) √© propensa a erros e demorada.

**Crit√©rio de Aceite**:
- Fatura aprovada ‚Üí evento enviado para ERP em < 10 segundos
- Falha tempor√°ria (timeout, erro 5xx) ‚Üí retry autom√°tico 3x
- Falha permanente (erro 4xx) ‚Üí Dead Letter Queue + alerta para equipe TI
- Sincroniza√ß√£o confirmada ‚Üí flag ERP_Sincronizado = TRUE + ERP_Documento_Numero preenchido

**Campos Afetados**: ERP_Sincronizado, ERP_Documento_Numero, ERP_Data_Sync, ERP_Erro_Log

**Tipo**: Integra√ß√£o Externa

**Obrigat√≥rio**: Sim

---

### RN-RF026-015: Campos Obrigat√≥rios por Status

**Descri√ß√£o**: Campos obrigat√≥rios variam por status da fatura (valida√ß√£o condicional FluentValidation). Rascunho: Arquivo_Original, Data_Importacao. Aguardando Concilia√ß√£o: + Operadora, Periodo_Referencia, Data_Emissao, Valor_Total. Aguardando Auditoria: + Resultado_Conciliacao (% conciliado). Aguardando Aprova√ß√£o: + Resultado_Auditoria (aprovado/reprovado), Rateio_Calculado. Aprovada: + Aprovador_Id, Data_Aprovacao, Assinatura_Digital_Id. Paga: + Data_Pagamento, Numero_Documento_Pagamento.

**Justificativa**: Fatura em status "Rascunho" ainda n√£o tem todos os dados obrigat√≥rios (ex: ainda n√£o foi conciliada). Valida√ß√£o condicional permite progresso incremental sem rejeitar fatura prematuramente.

**Crit√©rio de Aceite**:
- Transi√ß√£o de status valida campos obrigat√≥rios do status destino
- Campo obrigat√≥rio ausente ‚Üí rejei√ß√£o HTTP 400 com mensagem espec√≠fica "Campo X obrigat√≥rio para status Y"
- Status "Paga" sem Data_Pagamento ‚Üí bloqueio

**Campos Afetados**: Varia por status (ver lista acima)

**Tipo**: Valida√ß√£o Condicional

**Obrigat√≥rio**: Sim

---

## 6. ESTADOS DA ENTIDADE

### Estados Principais

| Estado | Descri√ß√£o |
|--------|-----------|
| **Rascunho** | Fatura importada mas ainda n√£o validada (dados podem estar incompletos) |
| **Aguardando Concilia√ß√£o** | Importa√ß√£o confirmada, aguardando execu√ß√£o de concilia√ß√£o autom√°tica |
| **Aguardando Auditoria** | Concilia√ß√£o conclu√≠da (manual ou autom√°tica), aguardando execu√ß√£o de regras de auditoria |
| **Aguardando Aprova√ß√£o** | Auditoria conclu√≠da sem bloqueios (ou bloqueios justificados), aguardando aprova√ß√£o do gestor |
| **Aprovada** | Aprovada por gestor com assinatura digital, aguardando pagamento |
| **Paga** | Pagamento realizado e confirmado (integra√ß√£o com ERP financeiro) |
| **Contestada** | Fatura com contesta√ß√£o ativa (workflow de contesta√ß√£o em andamento) |
| **Cancelada** | Fatura cancelada antes de pagar (ex: operadora emitiu fatura corrigida) |

### Transi√ß√µes Permitidas

| De | Para | Condi√ß√£o |
|----|------|----------|
| Rascunho | Aguardando Concilia√ß√£o | Usu√°rio confirma preview de importa√ß√£o |
| Aguardando Concilia√ß√£o | Aguardando Auditoria | Concilia√ß√£o executada (autom√°tica ou manual) |
| Aguardando Auditoria | Aguardando Aprova√ß√£o | Auditoria executada + sem bloqueios Alta OU bloqueios Alta justificados |
| Aguardando Aprova√ß√£o | Aprovada | Gestor aprova + assinatura digital DocuSign |
| Aprovada | Paga | Pagamento confirmado (integra√ß√£o ERP) |
| Qualquer estado | Contestada | Usu√°rio cria contesta√ß√£o formal |
| Contestada | Estado anterior | Contesta√ß√£o fechada (resolvida ou negada) |
| Qualquer estado | Cancelada | Administrador cancela fatura |

### Transi√ß√µes Proibidas

- N√£o √© poss√≠vel voltar de "Paga" para estados anteriores (irrevers√≠vel)
- "Cancelada" √© estado final (n√£o permite transi√ß√µes para outros estados)
- N√£o √© poss√≠vel pular etapas (ex: Rascunho ‚Üí Aguardando Aprova√ß√£o)

---

## 7. EVENTOS DE DOM√çNIO

| Evento | Quando Ocorre | Payload |
|--------|---------------|---------|
| **FaturaImportada** | Ap√≥s upload e preview confirmado pelo usu√°rio | FaturaId, TemplateId, ArquivoOriginalURL, NumeroLinhasImportadas |
| **FaturaOCRProcessada** | Ap√≥s OCR de PDF completar (sucesso ou falha) | FaturaId, ConfidenceScore, CamposExtraidos, CamposRevisaoPendente |
| **FaturaConciliadaAutomaticamente** | Ap√≥s concilia√ß√£o autom√°tica executar | FaturaId, PercentualConciliado, ItensConciliados, ItensRevisar, ItensNaoConciliados |
| **FaturaAuditada** | Ap√≥s execu√ß√£o de regras de auditoria | FaturaId, RegrasFalhas, ValorTotalSuspeito, BloqueioAprovacao |
| **ContestacaoCriada** | Ap√≥s cria√ß√£o de contesta√ß√£o formal | ContestacaoId, FaturaId, ItensSelecionados, ValorTotalContestado |
| **ContestacaoEnviadaOperadora** | Ap√≥s envio de contesta√ß√£o para operadora (API ou email) | ContestacaoId, CanalEnvio (API/Email), DataEnvio, SLAPrazoDias |
| **RateioCalculado** | Ap√≥s c√°lculo de rateio multi-dimensional | FaturaId, RegraRateioId, RateioDetalhado |
| **FaturaAprovada** | Ap√≥s aprova√ß√£o do gestor com assinatura digital | FaturaId, AprovadorId, DataAprovacao, DocuSignEnvelopeId |
| **FaturaPaga** | Ap√≥s confirma√ß√£o de pagamento | FaturaId, DataPagamento, NumeroDocumentoPagamento, ERPDocumentoNumero |
| **AlertaEstouroBudgetGerado** | Quando previs√£o ML > 90% do budget aprovado | AlertaId, MesReferencia, ValorPrevisto, PercentualBudget, DiasAntecedencia |
| **FaturaSincronizadaERP** | Ap√≥s sincroniza√ß√£o com sucesso no ERP financeiro | FaturaId, ERPDocumentoNumero, DataSync |
| **FaturaVersaoNovaCriada** | Ap√≥s reimporta√ß√£o ou corre√ß√£o manual gerar nova vers√£o | FaturaId, NumeroVersao, MotivoAlteracao, UsuarioResponsavel |

---

## 8. CRIT√âRIOS GLOBAIS DE ACEITE

- Nenhuma opera√ß√£o pode violar isolamento de tenant (ClienteId obrigat√≥rio em todas as queries)
- Nenhuma regra de neg√≥cio pode ser ignorada (valida√ß√£o FluentValidation obrigat√≥ria)
- Erros devem ser previs√≠veis e rastre√°veis (HTTP status codes corretos + mensagens espec√≠ficas)
- Auditoria deve registrar quem, quando e o que mudou (campos Created, CreatedBy, LastModified, LastModifiedBy obrigat√≥rios)
- Performance: Dashboard carrega em < 3 segundos, concilia√ß√£o executa em < 2 minutos (fatura com 500 linhas), rateio calcula em < 2 segundos
- Seguran√ßa: OAuth 2.0 para APIs externas, JWT Bearer token para autentica√ß√£o, rate limiting para evitar abuse, soft delete obrigat√≥rio
- Compliance: Preserva√ß√£o de hist√≥rico 7 anos (soft delete + versionamento), auditoria SOX (GPS, device ID, IP), LGPD (isolamento multi-tenant)

---

## 9. SEGURAN√áA

### 9.1 Autentica√ß√£o e Autoriza√ß√£o
- JWT Bearer token obrigat√≥rio em todas as APIs
- Permiss√µes RBAC baseadas em roles (c√≥digos: `faturas.view`, `faturas.create`, `faturas.update`, `faturas.approve`, `faturas.contest`, `faturas.admin`)
- Assinatura digital via DocuSign para aprova√ß√µes cr√≠ticas (validade legal)

### 9.2 Valida√ß√£o de Entrada
- FluentValidation com regras condicionais por status
- Sanitiza√ß√£o de inputs para prevenir SQL Injection e XSS
- Rate limiting em APIs p√∫blicas (100 req/min por ClienteId)

### 9.3 Prote√ß√£o de Dados Sens√≠veis
- Tokens OAuth 2.0 armazenados em Azure Key Vault (n√£o em banco)
- PDFs de faturas armazenados em Azure Blob Storage com acesso via SAS token tempor√°rio
- Logs n√£o cont√™m dados sens√≠veis (PII mascarado)

### 9.4 Isolamento Multi-Tenant
- ClienteId obrigat√≥rio em todas as queries (EF Core Query Filter global)
- Tentativa de acesso cruzado ‚Üí HTTP 404 (n√£o 403 para n√£o revelar exist√™ncia de dados de outros clientes)

### 9.5 Auditoria de Seguran√ßa
- Toda a√ß√£o cr√≠tica logada (aprova√ß√£o, contesta√ß√£o, altera√ß√£o de valores) com timestamp, usu√°rio, IP, device ID, GPS
- Logs centralizados em Azure Application Insights
- Alertas autom√°ticos para tentativas de acesso n√£o autorizado (>10 em 5 minutos)

---

## 10. ARTEFATOS DERIVADOS

Este RF √© base para:

- **UC-RF026.md** (Casos de Uso detalhados)
- **MD-RF026.md** (Modelo de Dados completo)
- **WF-RF026.md** (Workflows visuais)
- **TC-RF026-BACKEND.md** (Casos de Teste de Backend)
- **TC-RF026-FRONTEND.md** (Casos de Teste de Frontend)
- **TC-RF026-SEGURANCA.md** (Casos de Teste de Seguran√ßa)
- **TC-RF026-E2E.md** (Casos de Teste End-to-End)

---

## 11. METADADOS E RASTREABILIDADE

### Artefatos Obrigat√≥rios

| Artefato | Status | Observa√ß√µes |
|----------|--------|-------------|
| RF-026.md | ‚úÖ Criado | Este documento (v2.0) |
| RF-026.yaml | üîÑ Pendente | Estruturado sincronizado com RF.md |
| RL-RF026.md | üîÑ Pendente | Refer√™ncia ao legado |
| RL-RF026.yaml | üîÑ Pendente | Rastreabilidade com destinos |
| UC-RF026.md | ‚úÖ Criado | Casos de Uso (5 UCs padr√£o CRUD) |
| MD-RF026.md | ‚úÖ Criado | Modelo de Dados (12 tabelas) |
| WF-RF026.md | ‚úÖ Criado | Workflows visuais |
| TC-RF026-*.md | üîÑ Pendente | Casos de Teste (4 camadas) |

### Depend√™ncias Upstream (Este RF depende de)

- **RF-023 (Gest√£o de Contratos)** - Concilia√ß√£o de faturas com contratos vigentes
- **RF-025 (Gest√£o de Ativos)** - Concilia√ß√£o de faturas com ativos cadastrados (linhas, chips, equipamentos)
- **RF-014 (Gest√£o de Centros de Custo)** - Rateio multi-dimensional por centro de custo

### Depend√™ncias Downstream (Dependem deste RF)

- **RF-027 (Gest√£o de Aditivos de Contratos)** - Contesta√ß√µes podem resultar em aditivos contratuais
- **RF-028 (Gest√£o de SLA de Opera√ß√µes)** - Acompanhamento de SLA de contesta√ß√µes

### Integra√ß√µes Externas

- **Azure Form Recognizer** - OCR de PDFs
- **DocuSign API** - Assinatura digital
- **Vivo Empresas API** - Download de faturas e envio de contesta√ß√µes
- **Claro Corporate API** - Download de faturas
- **SAP ERP** - Sincroniza√ß√£o de faturas aprovadas (IDoc INVOIC02)
- **TOTVS Protheus** - Sincroniza√ß√£o de faturas aprovadas (TXT CNAB)
- **Azure Service Bus** - Dead Letter Queue para falhas de sincroniza√ß√£o ERP

---

## CHANGELOG

| Vers√£o | Data | Descri√ß√£o | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-30 | Migra√ß√£o v1.0 ‚Üí v2.0 com separa√ß√£o estrita RF/RL. RF limpo (apenas contrato moderno), refer√™ncias hist√≥ricas movidas para RL-RF026.md. 15 regras de neg√≥cio em linguagem natural pura. Estrutura 11 se√ß√µes conforme template v2.0. Integra√ß√µes obrigat√≥rias documentadas (i18n, auditoria, RBAC, multi-tenancy). | Ag√™ncia ALC - alc.dev.br |
| 1.0 | 2025-12-17 | Vers√£o inicial com conte√∫do misto (refer√™ncias hist√≥ricas + funcionalidades modernas). 5 se√ß√µes b√°sicas. Regras de neg√≥cio misturadas com contexto hist√≥rico. Migrado para v2.0 com separa√ß√£o clara. | Equipe IControlIT Architect |

---

**√öltima Revis√£o**: 2025-12-30
**Revisado Por**: Ag√™ncia ALC - alc.dev.br
**Pr√≥xima Revis√£o**: 2026-03-30
**Status de Governan√ßa**: ‚úÖ Vers√£o 2.0 (Separa√ß√£o RF/RL completa)
