uc:
  rf: RF030
  versao: '2.0'
  data: '2025-12-31'
casos_de_uso:
- id: UC00
  nome: Listar Layouts Importação
  ator_principal: usuario_autenticado
  tipo: leitura
  impacta_dados: false
  covers:
    rf_items:
    - RF030-CRUD-02
    uc_items:
    - id: FP-UC00-001
      title: Usuário acessa menu Parâmetros Faturamento → Layouts Importação
      required: true
    - id: FP-UC00-002
      title: Sistema valida permissão Parametros.View
      required: true
    - id: FP-UC00-003
      title: Sistema carrega lista paginada (20 registros/página)
      required: true
    - id: FP-UC00-004
      title: 'Sistema exibe colunas: Nome Layout, Operadora/Fornecedor, Formato, Versão, Última Atualização, Status, Ações'
      required: true
    - id: FA-UC00-001
      title: Aplicar filtros (operadora, formato)
      required: false
    - id: FA-UC00-002
      title: Ordenar por coluna
      required: false
    - id: FE-UC00-001
      title: Usuário sem permissão
      required: true
  precondicoes:
  - permissao: Parametros.View
  gatilho: Usuario acessa menu Layouts Importacao
  fluxo_principal:
  - passo: 1
    ator: usuario
    acao: acessa_menu_layouts
  - passo: 2
    ator: sistema
    acao: validar_permissao
  - passo: 3
    ator: sistema
    acao: carregar_layouts_tenant
  - passo: 4
    ator: sistema
    acao: exibir_lista_paginada
  fluxos_alternativos:
  - id: FA-UC00-01
    condicao: usuario_aplica_filtro
    resultado: lista_recarregada_filtrada
  fluxos_excecao:
  - id: FE-UC00-01
    condicao: sem_permissao
    resultado: erro_403_acesso_negado
  regras_aplicadas:
  - RN-RF030-015
  resultado_final:
    estado: lista_layouts_exibida
- id: UC01
  nome: Criar Layout Importação
  ator_principal: usuario_autenticado
  tipo: crud
  impacta_dados: true
  covers:
    rf_items:
    - RF030-CRUD-01
    - RF030-VAL-01
    - RF030-SEC-01
    uc_items:
    - id: FP-UC01-001
      title: Usuário clica em Criar Layout
      required: true
    - id: FP-UC01-002
      title: Sistema valida permissão Parametros.Layout.Create
      required: true
    - id: FP-UC01-003
      title: Sistema exibe builder visual drag-and-drop
      required: true
    - id: FP-UC01-004
      title: Usuário define nome, operadora/fornecedor, formato
      required: true
    - id: FP-UC01-005
      title: Usuário mapeia colunas (arrastar campos para colunas arquivo)
      required: true
    - id: FP-UC01-006
      title: Sistema valida 5 campos obrigatórios (CNPJ, número fatura, vencimento, valor, descrição)
      required: true
    - id: FP-UC01-007
      title: Usuário salva layout em estado draft
      required: true
    - id: FP-UC01-008
      title: Sistema registra auditoria
      required: true
    - id: FA-UC01-001
      title: Configurar validações customizadas por coluna
      required: false
    - id: FA-UC01-002
      title: Configurar transformações (uppercase, trim, regex)
      required: false
    - id: FE-UC01-001
      title: Campos obrigatórios não mapeados
      required: true
  precondicoes:
  - permissao: Parametros.Layout.Create
  gatilho: Usuario clica em Criar Layout
  fluxo_principal:
  - passo: 1
    ator: usuario
    acao: clicar_criar_layout
  - passo: 2
    ator: sistema
    acao: validar_permissao
  - passo: 3
    ator: sistema
    acao: exibir_builder_visual
  - passo: 4
    ator: usuario
    acao: preencher_metadados
  - passo: 5
    ator: usuario
    acao: mapear_colunas
  - passo: 6
    ator: sistema
    acao: validar_campos_obrigatorios
  - passo: 7
    ator: sistema
    acao: salvar_draft
  - passo: 8
    ator: sistema
    acao: registrar_auditoria
  fluxos_excecao:
  - id: FE-UC01-01
    condicao: campos_obrigatorios_faltando
    resultado: erro_400_lista_campos
  regras_aplicadas:
  - RN-RF030-001
  - RN-RF030-003
  resultado_final:
    estado: layout_criado_draft
- id: UC02
  nome: Visualizar Layout Importação
  ator_principal: usuario_autenticado
  tipo: leitura
  impacta_dados: false
  covers:
    rf_items:
    - RF030-CRUD-03
    uc_items:
    - id: FP-UC02-001
      title: Usuário seleciona layout na listagem
      required: true
    - id: FP-UC02-002
      title: Sistema valida permissão Parametros.View
      required: true
    - id: FP-UC02-003
      title: 'Sistema exibe detalhes completos: metadados, mapeamento, validações, histórico'
      required: true
    - id: FP-UC02-004
      title: Sistema exibe preview do arquivo esperado
      required: true
  precondicoes:
  - permissao: Parametros.View
  gatilho: Usuario seleciona layout
  fluxo_principal:
  - passo: 1
    ator: usuario
    acao: selecionar_layout
  - passo: 2
    ator: sistema
    acao: validar_permissao
  - passo: 3
    ator: sistema
    acao: carregar_detalhes
  - passo: 4
    ator: sistema
    acao: exibir_informacoes
  regras_aplicadas:
  - RN-RF030-003
  resultado_final:
    estado: detalhes_exibidos
- id: UC03
  nome: Editar Layout Importação
  ator_principal: usuario_autenticado
  tipo: crud
  impacta_dados: true
  covers:
    rf_items:
    - RF030-CRUD-04
    - RF030-VAL-03
    uc_items:
    - id: FP-UC03-001
      title: Usuário clica em Editar layout
      required: true
    - id: FP-UC03-002
      title: Sistema valida permissão Parametros.Layout.Update
      required: true
    - id: FP-UC03-003
      title: Sistema carrega builder visual com dados atuais
      required: true
    - id: FP-UC03-004
      title: Usuário altera mapeamento, validações ou transformações
      required: true
    - id: FP-UC03-005
      title: Usuário fornece justificativa (mínimo 50 caracteres)
      required: true
    - id: FP-UC03-006
      title: Sistema cria nova versão (snapshot before/after)
      required: true
    - id: FP-UC03-007
      title: Sistema registra auditoria especial
      required: true
    - id: FE-UC03-001
      title: Justificativa < 50 caracteres
      required: true
  precondicoes:
  - permissao: Parametros.Layout.Update
  gatilho: Usuario clica em Editar
  fluxo_principal:
  - passo: 1
    ator: usuario
    acao: clicar_editar
  - passo: 2
    ator: sistema
    acao: validar_permissao
  - passo: 3
    ator: sistema
    acao: carregar_builder
  - passo: 4
    ator: usuario
    acao: alterar_configuracoes
  - passo: 5
    ator: usuario
    acao: fornecer_justificativa
  - passo: 6
    ator: sistema
    acao: criar_nova_versao
  - passo: 7
    ator: sistema
    acao: registrar_auditoria
  fluxos_excecao:
  - id: FE-UC03-01
    condicao: justificativa_curta
    resultado: erro_400_minimo_50_chars
  regras_aplicadas:
  - RN-RF030-003
  - RN-RF030-008
  resultado_final:
    estado: layout_atualizado_versionado
- id: UC04
  nome: Inativar Layout Importação
  ator_principal: usuario_autenticado
  tipo: crud
  impacta_dados: true
  covers:
    rf_items:
    - RF030-CRUD-05
    uc_items:
    - id: FP-UC04-001
      title: Usuário seleciona Inativar
      required: true
    - id: FP-UC04-002
      title: Sistema valida permissão Parametros.Layout.Update
      required: true
    - id: FP-UC04-003
      title: Sistema confirma ação (modal)
      required: true
    - id: FP-UC04-004
      title: Sistema executa soft delete (fl_ativo = false)
      required: true
    - id: FP-UC04-005
      title: Sistema registra auditoria
      required: true
  precondicoes:
  - permissao: Parametros.Layout.Update
  gatilho: Usuario clica em Inativar
  fluxo_principal:
  - passo: 1
    ator: usuario
    acao: clicar_inativar
  - passo: 2
    ator: sistema
    acao: validar_permissao
  - passo: 3
    ator: sistema
    acao: confirmar_modal
  - passo: 4
    ator: sistema
    acao: soft_delete
  - passo: 5
    ator: sistema
    acao: registrar_auditoria
  regras_aplicadas:
  - RN-RF030-012
  resultado_final:
    estado: layout_inativado
- id: UC05
  nome: Testar Layout em Sandbox
  ator_principal: usuario_autenticado
  tipo: acao
  impacta_dados: false
  covers:
    rf_items:
    - RF030-ESP-01
    uc_items:
    - id: FP-UC05-001
      title: Usuário clica em Testar em Sandbox
      required: true
    - id: FP-UC05-002
      title: Sistema valida permissão Parametros.Layout.Create
      required: true
    - id: FP-UC05-003
      title: Usuário faz upload de arquivo exemplo (mínimo 10 linhas)
      required: true
    - id: FP-UC05-004
      title: Sistema valida 100% das linhas em modo simulação
      required: true
    - id: FP-UC05-005
      title: 'Sistema exibe relatório: sucessos, erros, warnings'
      required: true
    - id: FP-UC05-006
      title: Sistema marca fl_testado_sandbox = true
      required: true
    - id: FE-UC05-001
      title: Arquivo < 10 linhas
      required: true
    - id: FE-UC05-002
      title: Validação falha (erros encontrados)
      required: true
  precondicoes:
  - permissao: Parametros.Layout.Create
  gatilho: Usuario clica em Testar Sandbox
  fluxo_principal:
  - passo: 1
    ator: usuario
    acao: clicar_testar_sandbox
  - passo: 2
    ator: sistema
    acao: validar_permissao
  - passo: 3
    ator: usuario
    acao: upload_arquivo_exemplo
  - passo: 4
    ator: sistema
    acao: validar_100_porcento_linhas
  - passo: 5
    ator: sistema
    acao: exibir_relatorio
  - passo: 6
    ator: sistema
    acao: marcar_testado
  fluxos_excecao:
  - id: FE-UC05-01
    condicao: arquivo_pequeno
    resultado: erro_400_minimo_10_linhas
  - id: FE-UC05-02
    condicao: validacao_falha
    resultado: relatorio_erros_detalhado
  regras_aplicadas:
  - RN-RF030-002
  - RN-RF030-006
  resultado_final:
    estado: layout_testado_sandbox
- id: UC06
  nome: Ativar Layout para Produção
  ator_principal: usuario_autenticado
  tipo: acao
  impacta_dados: true
  covers:
    rf_items:
    - RF030-ESP-01
    uc_items:
    - id: FP-UC06-001
      title: Usuário clica em Ativar Layout
      required: true
    - id: FP-UC06-002
      title: Sistema valida permissão Parametros.Layout.Activate
      required: true
    - id: FP-UC06-003
      title: Sistema verifica fl_testado_sandbox = true
      required: true
    - id: FP-UC06-004
      title: Sistema confirma ativação (modal)
      required: true
    - id: FP-UC06-005
      title: Sistema marca fl_ativo = true
      required: true
    - id: FP-UC06-006
      title: Sistema notifica usuários do tenant
      required: true
    - id: FP-UC06-007
      title: Sistema registra auditoria
      required: true
    - id: FE-UC06-001
      title: Layout não testado em sandbox
      required: true
  precondicoes:
  - permissao: Parametros.Layout.Activate
  gatilho: Usuario clica em Ativar
  fluxo_principal:
  - passo: 1
    ator: usuario
    acao: clicar_ativar
  - passo: 2
    ator: sistema
    acao: validar_permissao
  - passo: 3
    ator: sistema
    acao: verificar_testado_sandbox
  - passo: 4
    ator: sistema
    acao: confirmar_modal
  - passo: 5
    ator: sistema
    acao: ativar_layout
  - passo: 6
    ator: sistema
    acao: notificar_usuarios
  - passo: 7
    ator: sistema
    acao: registrar_auditoria
  fluxos_excecao:
  - id: FE-UC06-01
    condicao: nao_testado_sandbox
    resultado: erro_400_teste_obrigatorio
  regras_aplicadas:
  - RN-RF030-006
  resultado_final:
    estado: layout_ativado_producao
- id: UC07
  nome: Gerenciar Regras Auditoria
  ator_principal: usuario_autenticado
  tipo: crud
  impacta_dados: true
  covers:
    rf_items:
    - RF030-VAL-05
    uc_items:
    - id: FP-UC07-001
      title: Usuário acessa menu Regras de Auditoria
      required: true
    - id: FP-UC07-002
      title: Sistema valida permissão Parametros.Regra.Create
      required: true
    - id: FP-UC07-003
      title: 'Usuário cria regra com: nome, descrição, expressão NCalc, severidade'
      required: true
    - id: FP-UC07-004
      title: Sistema valida sintaxe expressão (NCalc)
      required: true
    - id: FP-UC07-005
      title: Sistema valida severidade obrigatória (Informativa, Alerta, Bloqueante)
      required: true
    - id: FP-UC07-006
      title: Sistema salva regra
      required: true
    - id: FP-UC07-007
      title: Sistema registra auditoria
      required: true
    - id: FE-UC07-001
      title: Expressão com erro de sintaxe
      required: true
  precondicoes:
  - permissao: Parametros.Regra.Create
  gatilho: Usuario acessa Regras Auditoria
  fluxo_principal:
  - passo: 1
    ator: usuario
    acao: acessar_regras
  - passo: 2
    ator: sistema
    acao: validar_permissao
  - passo: 3
    ator: usuario
    acao: criar_regra
  - passo: 4
    ator: sistema
    acao: validar_sintaxe_ncalc
  - passo: 5
    ator: sistema
    acao: validar_severidade
  - passo: 6
    ator: sistema
    acao: salvar_regra
  - passo: 7
    ator: sistema
    acao: registrar_auditoria
  fluxos_excecao:
  - id: FE-UC07-01
    condicao: sintaxe_invalida
    resultado: erro_400_expressao_invalida
  regras_aplicadas:
  - RN-RF030-004
  - RN-RF030-011
  resultado_final:
    estado: regra_criada
- id: UC08
  nome: Gerenciar Templates Rateio
  ator_principal: usuario_autenticado
  tipo: crud
  impacta_dados: true
  covers:
    rf_items:
    - RF030-VAL-04
    uc_items:
    - id: FP-UC08-001
      title: Usuário acessa menu Templates de Rateio
      required: true
    - id: FP-UC08-002
      title: Sistema valida permissão Parametros.Template.Create
      required: true
    - id: FP-UC08-003
      title: 'Usuário cria template: nome, tipo (percentual, fixo, proporcional, escalonado)'
      required: true
    - id: FP-UC08-004
      title: Usuário define distribuição entre centros de custo
      required: true
    - id: FP-UC08-005
      title: Sistema valida soma = 100% (tolerância ±0.01%) se tipo percentual
      required: true
    - id: FP-UC08-006
      title: Sistema salva template
      required: true
    - id: FP-UC08-007
      title: Sistema registra auditoria
      required: true
    - id: FE-UC08-001
      title: Soma ≠ 100% em template percentual
      required: true
  precondicoes:
  - permissao: Parametros.Template.Create
  gatilho: Usuario acessa Templates Rateio
  fluxo_principal:
  - passo: 1
    ator: usuario
    acao: acessar_templates
  - passo: 2
    ator: sistema
    acao: validar_permissao
  - passo: 3
    ator: usuario
    acao: criar_template
  - passo: 4
    ator: usuario
    acao: definir_distribuicao
  - passo: 5
    ator: sistema
    acao: validar_soma_100
  - passo: 6
    ator: sistema
    acao: salvar_template
  - passo: 7
    ator: sistema
    acao: registrar_auditoria
  fluxos_excecao:
  - id: FE-UC08-01
    condicao: soma_incorreta
    resultado: erro_400_soma_deve_ser_100
  regras_aplicadas:
  - RN-RF030-005
  - RN-RF030-010
  resultado_final:
    estado: template_criado
- id: UC09
  nome: Criar Template de Rateio
  ator_principal: usuario_autenticado
  tipo: crud
  impacta_dados: true
  covers:
    rf_items:
    - RF030-ESP-02
    uc_items:
    - id: FP-UC09-001
      title: Usuário clica em Criar Template Rateio
      required: true
    - id: FP-UC09-002
      title: Sistema valida permissão FIN.PARAM_FATURAMENTO.RATEIO.CREATE
      required: true
    - id: FP-UC09-003
      title: 'Sistema exibe form: Nome*, Fórmula* (NCalc), Dimensões (multi-select), fl_ativo'
      required: true
    - id: FP-UC09-004
      title: 'Usuário preenche fórmula NCalc (ex: TotalValor / NumeroUsuarios)'
      required: true
    - id: FP-UC09-005
      title: Sistema valida sintaxe NCalc (expressões permitidas)
      required: true
    - id: FP-UC09-006
      title: Sistema salva template com EmpresaId
      required: true
    - id: FP-UC09-007
      title: Sistema registra auditoria FIN_TEMPLATE_CRIADO
      required: true
    - id: FE-UC09-001
      title: Fórmula NCalc inválida (sintaxe ou injeção)
      required: true
  precondicoes:
  - permissao: FIN.PARAM_FATURAMENTO.RATEIO.CREATE
  gatilho: Usuario clica em Criar Template Rateio
  fluxo_principal:
  - passo: 1
    ator: usuario
    acao: clicar_criar_template
  - passo: 2
    ator: sistema
    acao: validar_permissao
  - passo: 3
    ator: sistema
    acao: exibir_form
  - passo: 4
    ator: usuario
    acao: preencher_formula
  - passo: 5
    ator: sistema
    acao: validar_ncalc
  - passo: 6
    ator: sistema
    acao: salvar_template
  - passo: 7
    ator: sistema
    acao: registrar_auditoria
  fluxos_excecao:
  - id: FE-UC09-01
    condicao: formula_invalida
    resultado: erro_400_ncalc_invalido
  regras_aplicadas:
  - RN-RF030-011
  resultado_final:
    estado: template_criado
- id: UC10
  nome: Simular Rateio
  ator_principal: usuario_autenticado
  tipo: acao
  impacta_dados: false
  covers:
    rf_items:
    - RF030-ESP-02
    uc_items:
    - id: FP-UC10-001
      title: Usuário seleciona template rateio
      required: true
    - id: FP-UC10-002
      title: Sistema valida permissão FIN.PARAM_FATURAMENTO.RATEIO.VIEW
      required: true
    - id: FP-UC10-003
      title: Usuário fornece valores de entrada (mock data)
      required: true
    - id: FP-UC10-004
      title: Sistema executa fórmula NCalc em modo sandbox
      required: true
    - id: FP-UC10-005
      title: Sistema exibe resultado simulado (preview, não salva)
      required: true
    - id: FP-UC10-006
      title: Sistema exibe breakdown por dimensão (Centro Custo, Departamento)
      required: true
    - id: FE-UC10-001
      title: Erro de execução NCalc (divisão por zero, overflow)
      required: true
  precondicoes:
  - permissao: FIN.PARAM_FATURAMENTO.RATEIO.VIEW
  gatilho: Usuario clica em Simular Rateio
  fluxo_principal:
  - passo: 1
    ator: usuario
    acao: selecionar_template
  - passo: 2
    ator: sistema
    acao: validar_permissao
  - passo: 3
    ator: usuario
    acao: fornecer_valores
  - passo: 4
    ator: sistema
    acao: executar_ncalc_sandbox
  - passo: 5
    ator: sistema
    acao: exibir_resultado
  - passo: 6
    ator: sistema
    acao: exibir_breakdown
  fluxos_excecao:
  - id: FE-UC10-01
    condicao: erro_execucao
    resultado: erro_400_calculo_falhou
  regras_aplicadas:
  - RN-RF030-011
  resultado_final:
    estado: simulacao_exibida
- id: UC11
  nome: Criar Parâmetro Fiscal
  ator_principal: usuario_autenticado
  tipo: crud
  impacta_dados: true
  covers:
    rf_items:
    - RF030-SEC-02
    - RF030-SEC-03
    uc_items:
    - id: FP-UC11-001
      title: Usuário clica em Criar Parâmetro Fiscal
      required: true
    - id: FP-UC11-002
      title: Sistema valida permissão FIN.PARAM_FATURAMENTO.FISCAL.CREATE
      required: true
    - id: FP-UC11-003
      title: 'Sistema exibe form: UF*, CFOP*, Alíquota*, Vigência_Início*, Vigência_Fim, fl_ativo'
      required: true
    - id: FP-UC11-004
      title: Usuário preenche dados fiscais obrigatórios
      required: true
    - id: FP-UC11-005
      title: Sistema valida período vigência (início <= fim)
      required: true
    - id: FP-UC11-006
      title: Sistema valida alíquota (0-100%)
      required: true
    - id: FP-UC11-007
      title: Sistema salva parâmetro com EmpresaId
      required: true
    - id: FP-UC11-008
      title: Sistema registra auditoria FIN_FISCAL_CRIADO
      required: true
    - id: FE-UC11-001
      title: Período vigência inválido (fim < início)
      required: true
    - id: FE-UC11-002
      title: Alíquota fora do range (< 0 ou > 100)
      required: true
  precondicoes:
  - permissao: FIN.PARAM_FATURAMENTO.FISCAL.CREATE
  gatilho: Usuario clica em Criar Parametro Fiscal
  fluxo_principal:
  - passo: 1
    ator: usuario
    acao: clicar_criar_fiscal
  - passo: 2
    ator: sistema
    acao: validar_permissao
  - passo: 3
    ator: sistema
    acao: exibir_form
  - passo: 4
    ator: usuario
    acao: preencher_dados
  - passo: 5
    ator: sistema
    acao: validar_vigencia
  - passo: 6
    ator: sistema
    acao: validar_aliquota
  - passo: 7
    ator: sistema
    acao: salvar_parametro
  - passo: 8
    ator: sistema
    acao: registrar_auditoria
  fluxos_excecao:
  - id: FE-UC11-01
    condicao: vigencia_invalida
    resultado: erro_400_periodo_invalido
  - id: FE-UC11-02
    condicao: aliquota_invalida
    resultado: erro_400_aliquota_fora_range
  regras_aplicadas:
  - RN-RF030-012
  - RN-RF030-013
  resultado_final:
    estado: parametro_fiscal_criado
- id: UC12
  nome: Atualizar Parâmetro Fiscal
  ator_principal: usuario_autenticado
  tipo: crud
  impacta_dados: true
  covers:
    rf_items:
    - RF030-VAL-03
    - RF030-SEC-03
    uc_items:
    - id: FP-UC12-001
      title: Usuário clica em Editar Parâmetro Fiscal
      required: true
    - id: FP-UC12-002
      title: Sistema valida permissão FIN.PARAM_FATURAMENTO.FISCAL.UPDATE
      required: true
    - id: FP-UC12-003
      title: Sistema verifica se parâmetro está em uso (faturas vigentes)
      required: true
    - id: FP-UC12-004
      title: Sistema exibe modal confirmação (impacto em X faturas)
      required: true
    - id: FP-UC12-005
      title: Usuário confirma alteração
      required: true
    - id: FP-UC12-006
      title: Sistema cria versionamento (snapshot histórico)
      required: true
    - id: FP-UC12-007
      title: Sistema salva nova versão
      required: true
    - id: FP-UC12-008
      title: Sistema registra auditoria FIN_FISCAL_EDITADO
      required: true
    - id: FE-UC12-001
      title: Parâmetro em uso - usuário cancela operação
      required: true
  precondicoes:
  - permissao: FIN.PARAM_FATURAMENTO.FISCAL.UPDATE
  gatilho: Usuario clica em Editar Parametro Fiscal
  fluxo_principal:
  - passo: 1
    ator: usuario
    acao: clicar_editar
  - passo: 2
    ator: sistema
    acao: validar_permissao
  - passo: 3
    ator: sistema
    acao: verificar_uso
  - passo: 4
    ator: sistema
    acao: exibir_confirmacao
  - passo: 5
    ator: usuario
    acao: confirmar_alteracao
  - passo: 6
    ator: sistema
    acao: criar_snapshot
  - passo: 7
    ator: sistema
    acao: salvar_versao
  - passo: 8
    ator: sistema
    acao: registrar_auditoria
  fluxos_excecao:
  - id: FE-UC12-01
    condicao: usuario_cancelou
    resultado: operacao_cancelada
  regras_aplicadas:
  - RN-RF030-010
  - RN-RF030-013
  resultado_final:
    estado: parametro_versionado
- id: UC13
  nome: Homologar Fornecedor
  ator_principal: usuario_autenticado
  tipo: acao
  impacta_dados: true
  covers:
    rf_items:
    - RF030-SEC-04
    uc_items:
    - id: FP-UC13-001
      title: Usuário seleciona fornecedor (cadastrado em RF022)
      required: true
    - id: FP-UC13-002
      title: Sistema valida permissão FIN.PARAM_FATURAMENTO.FORNECEDOR.HOMOLOGAR
      required: true
    - id: FP-UC13-003
      title: Sistema exibe checklist homologação (documentos, certidões)
      required: true
    - id: FP-UC13-004
      title: Usuário anexa documentos obrigatórios (PDF)
      required: true
    - id: FP-UC13-005
      title: Sistema valida completude (todos itens checklist OK)
      required: true
    - id: FP-UC13-006
      title: Sistema atualiza status fornecedor (Homologado)
      required: true
    - id: FP-UC13-007
      title: Sistema registra auditoria FIN_FORNECEDOR_HOMOLOGADO
      required: true
    - id: FE-UC13-001
      title: Checklist incompleto (documentos faltando)
      required: true
  precondicoes:
  - permissao: FIN.PARAM_FATURAMENTO.FORNECEDOR.HOMOLOGAR
  gatilho: Usuario clica em Homologar Fornecedor
  fluxo_principal:
  - passo: 1
    ator: usuario
    acao: selecionar_fornecedor
  - passo: 2
    ator: sistema
    acao: validar_permissao
  - passo: 3
    ator: sistema
    acao: exibir_checklist
  - passo: 4
    ator: usuario
    acao: anexar_documentos
  - passo: 5
    ator: sistema
    acao: validar_completude
  - passo: 6
    ator: sistema
    acao: atualizar_status
  - passo: 7
    ator: sistema
    acao: registrar_auditoria
  fluxos_excecao:
  - id: FE-UC13-01
    condicao: checklist_incompleto
    resultado: erro_400_documentos_faltando
  regras_aplicadas:
  - RN-RF030-014
  resultado_final:
    estado: fornecedor_homologado
- id: UC14
  nome: Dashboard de Qualidade
  ator_principal: usuario_autenticado
  tipo: leitura
  impacta_dados: false
  covers:
    rf_items:
    - RF030-ESP-03
    - RF030-ESP-04
    uc_items:
    - id: FP-UC14-001
      title: Usuário acessa Dashboard Qualidade
      required: true
    - id: FP-UC14-002
      title: Sistema valida permissão FIN.PARAM_FATURAMENTO.DASHBOARD.VIEW
      required: true
    - id: FP-UC14-003
      title: Sistema carrega KPIs (cache Redis 5min TTL)
      required: true
    - id: FP-UC14-004
      title: 'Sistema exibe cards: Taxa Rejeição, Tempo Médio Correção, Itens Pendentes, Tendência Qualidade'
      required: true
    - id: FP-UC14-005
      title: Sistema exibe gráfico tempo real (SignalR, atualização <5s)
      required: true
    - id: FP-UC14-006
      title: Sistema exibe drill-down por categoria (clique em card)
      required: true
    - id: FA-UC14-001
      title: Filtrar por período (últimos 7d, 30d, 90d)
      required: false
    - id: FA-UC14-002
      title: Exportar relatório PDF/Excel
      required: false
  precondicoes:
  - permissao: FIN.PARAM_FATURAMENTO.DASHBOARD.VIEW
  gatilho: Usuario acessa Dashboard Qualidade
  fluxo_principal:
  - passo: 1
    ator: usuario
    acao: acessar_dashboard
  - passo: 2
    ator: sistema
    acao: validar_permissao
  - passo: 3
    ator: sistema
    acao: carregar_kpis_cache
  - passo: 4
    ator: sistema
    acao: exibir_cards
  - passo: 5
    ator: sistema
    acao: iniciar_signalr
  - passo: 6
    ator: sistema
    acao: exibir_grafico_tempo_real
  regras_aplicadas:
  - RN-RF030-009
  resultado_final:
    estado: dashboard_exibido
- id: UC09
  nome: Criar Template de Rateio
  ator_principal: usuario_autenticado
  tipo: crud
  impacta_dados: true
  covers:
    rf_items:
    - RF030-ESP-02
    uc_items:
    - id: FP-UC09-001
      title: Usuário clica em Criar Template Rateio
      required: true
    - id: FP-UC09-002
      title: Sistema valida permissão FIN.PARAM_FATURAMENTO.RATEIO.CREATE
      required: true
    - id: FP-UC09-003
      title: 'Sistema exibe form: Nome*, Fórmula* (NCalc), Dimensões (multi-select), fl_ativo'
      required: true
    - id: FP-UC09-004
      title: 'Usuário preenche fórmula NCalc (ex: TotalValor / NumeroUsuarios)'
      required: true
    - id: FP-UC09-005
      title: Sistema valida sintaxe NCalc (expressões permitidas)
      required: true
    - id: FP-UC09-006
      title: Sistema salva template com EmpresaId
      required: true
    - id: FP-UC09-007
      title: Sistema registra auditoria FIN_TEMPLATE_CRIADO
      required: true
    - id: FE-UC09-001
      title: Fórmula NCalc inválida (sintaxe ou injeção)
      required: true
  precondicoes:
  - permissao: FIN.PARAM_FATURAMENTO.RATEIO.CREATE
  gatilho: Usuario clica em Criar Template Rateio
  fluxo_principal:
  - passo: 1
    ator: usuario
    acao: clicar_criar_template
  - passo: 2
    ator: sistema
    acao: validar_permissao
  - passo: 3
    ator: sistema
    acao: exibir_form
  - passo: 4
    ator: usuario
    acao: preencher_formula
  - passo: 5
    ator: sistema
    acao: validar_ncalc
  - passo: 6
    ator: sistema
    acao: salvar_template
  - passo: 7
    ator: sistema
    acao: registrar_auditoria
  fluxos_excecao:
  - id: FE-UC09-01
    condicao: formula_invalida
    resultado: erro_400_ncalc_invalido
  regras_aplicadas:
  - RN-RF030-011
  resultado_final:
    estado: template_criado
- id: UC10
  nome: Simular Rateio
  ator_principal: usuario_autenticado
  tipo: acao
  impacta_dados: false
  covers:
    rf_items:
    - RF030-ESP-02
    uc_items:
    - id: FP-UC10-001
      title: Usuário seleciona template rateio
      required: true
    - id: FP-UC10-002
      title: Sistema valida permissão FIN.PARAM_FATURAMENTO.RATEIO.VIEW
      required: true
    - id: FP-UC10-003
      title: Usuário fornece valores de entrada (mock data)
      required: true
    - id: FP-UC10-004
      title: Sistema executa fórmula NCalc em modo sandbox
      required: true
    - id: FP-UC10-005
      title: Sistema exibe resultado simulado (preview, não salva)
      required: true
    - id: FP-UC10-006
      title: Sistema exibe breakdown por dimensão (Centro Custo, Departamento)
      required: true
    - id: FE-UC10-001
      title: Erro de execução NCalc (divisão por zero, overflow)
      required: true
  precondicoes:
  - permissao: FIN.PARAM_FATURAMENTO.RATEIO.VIEW
  gatilho: Usuario clica em Simular Rateio
  fluxo_principal:
  - passo: 1
    ator: usuario
    acao: selecionar_template
  - passo: 2
    ator: sistema
    acao: validar_permissao
  - passo: 3
    ator: usuario
    acao: fornecer_valores
  - passo: 4
    ator: sistema
    acao: executar_ncalc_sandbox
  - passo: 5
    ator: sistema
    acao: exibir_resultado
  - passo: 6
    ator: sistema
    acao: exibir_breakdown
  fluxos_excecao:
  - id: FE-UC10-01
    condicao: erro_execucao
    resultado: erro_400_calculo_falhou
  regras_aplicadas:
  - RN-RF030-011
  resultado_final:
    estado: simulacao_exibida
- id: UC11
  nome: Criar Parâmetro Fiscal
  ator_principal: usuario_autenticado
  tipo: crud
  impacta_dados: true
  covers:
    rf_items:
    - RF030-SEC-02
    - RF030-SEC-03
    uc_items:
    - id: FP-UC11-001
      title: Usuário clica em Criar Parâmetro Fiscal
      required: true
    - id: FP-UC11-002
      title: Sistema valida permissão FIN.PARAM_FATURAMENTO.FISCAL.CREATE
      required: true
    - id: FP-UC11-003
      title: 'Sistema exibe form: UF*, CFOP*, Alíquota*, Vigência_Início*, Vigência_Fim, fl_ativo'
      required: true
    - id: FP-UC11-004
      title: Usuário preenche dados fiscais obrigatórios
      required: true
    - id: FP-UC11-005
      title: Sistema valida período vigência (início <= fim)
      required: true
    - id: FP-UC11-006
      title: Sistema valida alíquota (0-100%)
      required: true
    - id: FP-UC11-007
      title: Sistema salva parâmetro com EmpresaId
      required: true
    - id: FP-UC11-008
      title: Sistema registra auditoria FIN_FISCAL_CRIADO
      required: true
    - id: FE-UC11-001
      title: Período vigência inválido (fim < início)
      required: true
    - id: FE-UC11-002
      title: Alíquota fora do range (< 0 ou > 100)
      required: true
  precondicoes:
  - permissao: FIN.PARAM_FATURAMENTO.FISCAL.CREATE
  gatilho: Usuario clica em Criar Parametro Fiscal
  fluxo_principal:
  - passo: 1
    ator: usuario
    acao: clicar_criar_fiscal
  - passo: 2
    ator: sistema
    acao: validar_permissao
  - passo: 3
    ator: sistema
    acao: exibir_form
  - passo: 4
    ator: usuario
    acao: preencher_dados
  - passo: 5
    ator: sistema
    acao: validar_vigencia
  - passo: 6
    ator: sistema
    acao: validar_aliquota
  - passo: 7
    ator: sistema
    acao: salvar_parametro
  - passo: 8
    ator: sistema
    acao: registrar_auditoria
  fluxos_excecao:
  - id: FE-UC11-01
    condicao: vigencia_invalida
    resultado: erro_400_periodo_invalido
  - id: FE-UC11-02
    condicao: aliquota_invalida
    resultado: erro_400_aliquota_fora_range
  regras_aplicadas:
  - RN-RF030-012
  - RN-RF030-013
  resultado_final:
    estado: parametro_fiscal_criado
- id: UC12
  nome: Atualizar Parâmetro Fiscal
  ator_principal: usuario_autenticado
  tipo: crud
  impacta_dados: true
  covers:
    rf_items:
    - RF030-VAL-03
    - RF030-SEC-03
    uc_items:
    - id: FP-UC12-001
      title: Usuário clica em Editar Parâmetro Fiscal
      required: true
    - id: FP-UC12-002
      title: Sistema valida permissão FIN.PARAM_FATURAMENTO.FISCAL.UPDATE
      required: true
    - id: FP-UC12-003
      title: Sistema verifica se parâmetro está em uso (faturas vigentes)
      required: true
    - id: FP-UC12-004
      title: Sistema exibe modal confirmação (impacto em X faturas)
      required: true
    - id: FP-UC12-005
      title: Usuário confirma alteração
      required: true
    - id: FP-UC12-006
      title: Sistema cria versionamento (snapshot histórico)
      required: true
    - id: FP-UC12-007
      title: Sistema salva nova versão
      required: true
    - id: FP-UC12-008
      title: Sistema registra auditoria FIN_FISCAL_EDITADO
      required: true
    - id: FE-UC12-001
      title: Parâmetro em uso - usuário cancela operação
      required: true
  precondicoes:
  - permissao: FIN.PARAM_FATURAMENTO.FISCAL.UPDATE
  gatilho: Usuario clica em Editar Parametro Fiscal
  fluxo_principal:
  - passo: 1
    ator: usuario
    acao: clicar_editar
  - passo: 2
    ator: sistema
    acao: validar_permissao
  - passo: 3
    ator: sistema
    acao: verificar_uso
  - passo: 4
    ator: sistema
    acao: exibir_confirmacao
  - passo: 5
    ator: usuario
    acao: confirmar_alteracao
  - passo: 6
    ator: sistema
    acao: criar_snapshot
  - passo: 7
    ator: sistema
    acao: salvar_versao
  - passo: 8
    ator: sistema
    acao: registrar_auditoria
  fluxos_excecao:
  - id: FE-UC12-01
    condicao: usuario_cancelou
    resultado: operacao_cancelada
  regras_aplicadas:
  - RN-RF030-010
  - RN-RF030-013
  resultado_final:
    estado: parametro_versionado
- id: UC13
  nome: Homologar Fornecedor
  ator_principal: usuario_autenticado
  tipo: acao
  impacta_dados: true
  covers:
    rf_items:
    - RF030-SEC-04
    uc_items:
    - id: FP-UC13-001
      title: Usuário seleciona fornecedor (cadastrado em RF022)
      required: true
    - id: FP-UC13-002
      title: Sistema valida permissão FIN.PARAM_FATURAMENTO.FORNECEDOR.HOMOLOGAR
      required: true
    - id: FP-UC13-003
      title: Sistema exibe checklist homologação (documentos, certidões)
      required: true
    - id: FP-UC13-004
      title: Usuário anexa documentos obrigatórios (PDF)
      required: true
    - id: FP-UC13-005
      title: Sistema valida completude (todos itens checklist OK)
      required: true
    - id: FP-UC13-006
      title: Sistema atualiza status fornecedor (Homologado)
      required: true
    - id: FP-UC13-007
      title: Sistema registra auditoria FIN_FORNECEDOR_HOMOLOGADO
      required: true
    - id: FE-UC13-001
      title: Checklist incompleto (documentos faltando)
      required: true
  precondicoes:
  - permissao: FIN.PARAM_FATURAMENTO.FORNECEDOR.HOMOLOGAR
  gatilho: Usuario clica em Homologar Fornecedor
  fluxo_principal:
  - passo: 1
    ator: usuario
    acao: selecionar_fornecedor
  - passo: 2
    ator: sistema
    acao: validar_permissao
  - passo: 3
    ator: sistema
    acao: exibir_checklist
  - passo: 4
    ator: usuario
    acao: anexar_documentos
  - passo: 5
    ator: sistema
    acao: validar_completude
  - passo: 6
    ator: sistema
    acao: atualizar_status
  - passo: 7
    ator: sistema
    acao: registrar_auditoria
  fluxos_excecao:
  - id: FE-UC13-01
    condicao: checklist_incompleto
    resultado: erro_400_documentos_faltando
  regras_aplicadas:
  - RN-RF030-014
  resultado_final:
    estado: fornecedor_homologado
- id: UC14
  nome: Dashboard de Qualidade
  ator_principal: usuario_autenticado
  tipo: leitura
  impacta_dados: false
  covers:
    rf_items:
    - RF030-ESP-03
    - RF030-ESP-04
    uc_items:
    - id: FP-UC14-001
      title: Usuário acessa Dashboard Qualidade
      required: true
    - id: FP-UC14-002
      title: Sistema valida permissão FIN.PARAM_FATURAMENTO.DASHBOARD.VIEW
      required: true
    - id: FP-UC14-003
      title: Sistema carrega KPIs (cache Redis 5min TTL)
      required: true
    - id: FP-UC14-004
      title: 'Sistema exibe cards: Taxa Rejeição, Tempo Médio Correção, Itens Pendentes, Tendência Qualidade'
      required: true
    - id: FP-UC14-005
      title: Sistema exibe gráfico tempo real (SignalR, atualização <5s)
      required: true
    - id: FP-UC14-006
      title: Sistema exibe drill-down por categoria (clique em card)
      required: true
    - id: FA-UC14-001
      title: Filtrar por período (últimos 7d, 30d, 90d)
      required: false
    - id: FA-UC14-002
      title: Exportar relatório PDF/Excel
      required: false
  precondicoes:
  - permissao: FIN.PARAM_FATURAMENTO.DASHBOARD.VIEW
  gatilho: Usuario acessa Dashboard Qualidade
  fluxo_principal:
  - passo: 1
    ator: usuario
    acao: acessar_dashboard
  - passo: 2
    ator: sistema
    acao: validar_permissao
  - passo: 3
    ator: sistema
    acao: carregar_kpis_cache
  - passo: 4
    ator: sistema
    acao: exibir_cards
  - passo: 5
    ator: sistema
    acao: iniciar_signalr
  - passo: 6
    ator: sistema
    acao: exibir_grafico_tempo_real
  regras_aplicadas:
  - RN-RF030-009
  resultado_final:
    estado: dashboard_exibido
exclusions:
  uc_items: []
historico:
- versao: '2.0'
  data: '2025-12-31'
  autor: Agência ALC - alc.dev.br
  descricao: Versão YAML estruturado sincronizado com RF030.yaml v2.0. Criação inicial do UC.yaml para RF030 com 9 casos de
    uso (UC00-UC08).
