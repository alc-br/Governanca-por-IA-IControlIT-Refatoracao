# RF030 - Gest√£o de Par√¢metros Faturamento

## üìã Informa√ß√µes B√°sicas

| **Item** | **Detalhes** |
|----------|--------------|
| **ID** | RF030 |
| **Nome** | Gest√£o de Par√¢metros Faturamento |
| **Fase** | Fase 2 - Servi√ßos Essenciais |
| **EPIC** | EPIC003-GES - Gest√£o |
| **Prioridade** | CR√çTICA |
| **Complexidade** | MUITO ALTA |
| **Estimativa** | 180 horas (4.5 semanas) |
| **Status** | üìù Especifica√ß√£o |

---

## üéØ SE√á√ÉO 1: RESUMO EXECUTIVO

### 1.1 Vis√£o Geral

O **RF030 - Gest√£o de Par√¢metros Faturamento** estabelece o sistema de configura√ß√£o centralizada de **par√¢metros, regras e templates** para o processo de faturamento (RF026). Este RF √© **cr√≠tico** pois define como faturas s√£o importadas, auditadas, rateadas e validadas, impactando diretamente a acur√°cia financeira e compliance fiscal da organiza√ß√£o.

**Escopo**: Layouts de importa√ß√£o, regras de auditoria, templates de rateio, par√¢metros fiscais, versionamento de configura√ß√µes.

### 1.2 Objetivos Estrat√©gicos

1. **Centraliza√ß√£o de Configura√ß√µes**: √önico ponto de gest√£o de par√¢metros de faturamento
2. **Versionamento Completo**: Rastreabilidade de todas as mudan√ßas em regras e templates
3. **Valida√ß√£o Pr√©-Importa√ß√£o**: Detec√ß√£o de erros antes do processamento (redu√ß√£o 90% retrabalho)
4. **Auditoria Autom√°tica**: Regras configur√°veis para identificar glosas, duplicidades, irregularidades
5. **Templates de Rateio**: Modelos reutiliz√°veis para distribui√ß√£o de custos

### 1.3 Comparativo: Sistema Legado vs. Modernizado

| **Aspecto** | **Sistema Legado (ASP.NET)** | **Sistema Modernizado (.NET 10 + Angular 19)** |
|-------------|------------------------------|------------------------------------------------|
| **Arquitetura** | Configura√ß√µes hardcoded em c√≥digo VB.NET | Configur√°vel via UI + versionamento completo |
| **Layouts Importa√ß√£o** | 1 layout fixo (Excel 97-2003) | N layouts configur√°veis (CSV, Excel, XML, JSON, EDI) |
| **Valida√ß√£o** | P√≥s-importa√ß√£o (descarta erros) | Pr√©-importa√ß√£o (valida antes de gravar) |
| **Versionamento** | Nenhum (mudan√ßas sem rastreio) | Completo (quem, quando, por qu√™, diff) |
| **Regras Auditoria** | Fixas em stored procedures | Configur√°veis via Expression Engine |
| **Templates Rateio** | Nenhum (manual via Excel) | Biblioteca reutiliz√°vel com simula√ß√£o |
| **Performance** | Lento (>5min importa√ß√£o 1000 linhas) | R√°pido (<30s com paraleliza√ß√£o) |
| **Testes** | Nenhum (produ√ß√£o = teste) | Sandbox com dados fict√≠cios |
| **Documenta√ß√£o** | Nenhuma | Auto-documentado (metadata + help inline) |
| **Auditoria** | Logs b√°sicos em txt | Completa (LGPD 7 anos) |

### 1.4 Principais Funcionalidades

#### F1. Gerenciamento de Layouts de Importa√ß√£o
- **Descri√ß√£o**: Cadastro de layouts flex√≠veis para importa√ß√£o de faturas (CSV, Excel, XML, JSON, EDI X12)
- **Impacto**: Suporte a m√∫ltiplos fornecedores sem mudan√ßa de c√≥digo
- **Tecnologia**: .NET 10 + EPPlus (Excel) + CsvHelper + XmlSerializer + EDI.NET
- **Features**: Mapeamento drag-and-drop, valida√ß√£o por coluna, transforma√ß√µes (upper, trim, regex)

#### F2. Motor de Valida√ß√£o Pr√©-Importa√ß√£o
- **Descri√ß√£o**: Engine que valida 100% das linhas ANTES de gravar no banco (detec√ß√£o precoce de erros)
- **Impacto**: Redu√ß√£o de 90% no retrabalho de corre√ß√£o p√≥s-importa√ß√£o
- **Tecnologia**: FluentValidation + Custom Validators + Paraleliza√ß√£o
- **Valida√ß√µes**: Tipo de dado, formato, obrigatoriedade, regras de neg√≥cio, duplicidade

#### F3. Biblioteca de Regras de Auditoria
- **Descri√ß√£o**: Cat√°logo de 50+ regras configur√°veis (ex: "Fatura > R$ 10k sem anexo", "Consumo fora da m√©dia +30%")
- **Impacto**: Detec√ß√£o autom√°tica de 85% das glosas antes de pagamento
- **Tecnologia**: Expression Engine (NCalc) + Rule-based System
- **Severidade**: Informativa, Alerta, Bloqueante

#### F4. Templates de Rateio Configur√°veis
- **Descri√ß√£o**: Modelos reutiliz√°veis para distribui√ß√£o de custos (por departamento, centro de custo, projeto, proporcional)
- **Impacto**: Elimina√ß√£o de 100% do trabalho manual em Excel
- **Tecnologia**: .NET 10 + Custom Allocation Engine
- **Tipos**: Fixo (%), Vari√°vel (por m√©trica), Escalonado, Misto

#### F5. Simulador de Importa√ß√£o (Sandbox)
- **Descri√ß√£o**: Ambiente seguro para testar layouts e regras com dados fict√≠cios ANTES de produ√ß√£o
- **Impacto**: Zero erros em produ√ß√£o por configura√ß√£o incorreta
- **Tecnologia**: In-Memory Database + Modo Dry-Run
- **Features**: Preview resultados, relat√≥rio de valida√ß√£o, rollback autom√°tico

#### F6. Versionamento Completo de Configura√ß√µes
- **Descri√ß√£o**: Hist√≥rico de todas as mudan√ßas em layouts, regras e templates (quem, quando, o qu√™, por qu√™)
- **Impacto**: Auditoria completa para compliance SOX e LGPD
- **Tecnologia**: Temporal Tables SQL Server + Change Tracking
- **Reten√ß√£o**: 7 anos (compliance fiscal)

#### F7. Par√¢metros Fiscais e Tribut√°rios
- **Descri√ß√£o**: Configura√ß√£o de al√≠quotas, CFOP, NCM, CST, regime tribut√°rio (Simples, Lucro Real, Presumido)
- **Impacto**: C√°lculo preciso de impostos em faturas
- **Tecnologia**: .NET 10 + Biblioteca Tribut√°ria Brasil.NET
- **Atualiza√ß√£o**: Integra√ß√£o com SEFAZ para atualiza√ß√µes autom√°ticas

#### F8. Gest√£o de Fornecedores Homologados
- **Descri√ß√£o**: Cat√°logo de fornecedores aprovados para faturamento com layouts e regras espec√≠ficos
- **Impacto**: Controle de compliance em homologa√ß√£o de fornecedores
- **Tecnologia**: .NET 10 + Workflow de Aprova√ß√£o
- **Valida√ß√µes**: Documenta√ß√£o fiscal, certifica√ß√µes, hist√≥rico de glosas

#### F9. Dashboard de Qualidade de Dados
- **Descri√ß√£o**: Painel com m√©tricas de qualidade (% linhas rejeitadas, top erros, tempo m√©dio importa√ß√£o)
- **Impacto**: Visibilidade para melhoria cont√≠nua de processos
- **Tecnologia**: Angular 19 + ApexCharts + SignalR
- **Atualiza√ß√£o**: Real-time

#### F10. API de Configura√ß√£o para Integra√ß√µes
- **Descri√ß√£o**: Endpoints REST/GraphQL para sistemas externos consultarem layouts e regras vigentes
- **Impacto**: Automa√ß√£o de integra√ß√µes B2B com fornecedores
- **Tecnologia**: ASP.NET Core + GraphQL HotChocolate
- **Seguran√ßa**: OAuth2 + API Key + Rate Limiting

### 1.5 Impacto no Neg√≥cio

| **Indicador** | **Antes (Legado)** | **Depois (Moderniza√ß√£o)** | **Ganho** |
|---------------|-------------------|---------------------------|-----------|
| Tempo m√©dio configura√ß√£o novo fornecedor | 40 horas (dev manual) | 2 horas (config UI) | **95% redu√ß√£o** |
| Taxa de erros p√≥s-importa√ß√£o | 25% linhas | <2% linhas | **92% redu√ß√£o** |
| Retrabalho corre√ß√£o faturas | 120h/m√™s | 10h/m√™s | **92% redu√ß√£o** |
| Custo anual com glosas n√£o detectadas | R$ 800.000 | R$ 120.000 | **R$ 680k economia** |
| Tempo m√©dio importa√ß√£o 1000 linhas | 5 minutos | 30 segundos | **90% redu√ß√£o** |
| Satisfa√ß√£o usu√°rios (NPS) | 25 | 80 | **+55 pontos** |

**ROI Estimado**: Retorno em **6 meses** considerando economia com glosas + redu√ß√£o de retrabalho + ganho de produtividade.

---

## üîí SE√á√ÉO 2: REGRAS DE NEG√ìCIO

### RN-030-001: Layout Deve Ter Valida√ß√£o M√≠nima de Campos Obrigat√≥rios

**Descri√ß√£o**: Todo layout de importa√ß√£o DEVE validar no m√≠nimo 5 campos obrigat√≥rios (CNPJ fornecedor, n√∫mero fatura, data vencimento, valor total, descri√ß√£o).

**Justificativa**: Campos essenciais para rastreabilidade fiscal e financeira.

**Valida√ß√£o**:
- Validar presen√ßa de campos: `Fornecedor_CNPJ`, `Numero_Fatura`, `Data_Vencimento`, `Valor_Total`, `Descricao`
- Cada campo deve ter tipo de dado configurado (string, decimal, date, int)
- Bloquear ativa√ß√£o de layout sem campos obrigat√≥rios

**Implementa√ß√£o**:
```csharp
var camposObrigatorios = new[] { "Fornecedor_CNPJ", "Numero_Fatura", "Data_Vencimento", "Valor_Total", "Descricao" };

var camposFaltando = camposObrigatorios.Except(layout.Colunas.Select(c => c.Nome_Campo));

if (camposFaltando.Any())
    throw new ValidationException($"Layout deve ter campos obrigat√≥rios: {string.Join(", ", camposFaltando)}");
```

**Mensagem de Erro**: `"FAT_PAR_001: Layout 'Telecom Brasil' deve ter campos obrigat√≥rios: Fornecedor_CNPJ, Data_Vencimento"`

---

### RN-030-002: Valida√ß√£o Pr√©-Importa√ß√£o Obrigat√≥ria

**Descri√ß√£o**: Sistema DEVE validar 100% das linhas ANTES de iniciar grava√ß√£o no banco (modo transacional all-or-nothing).

**Justificativa**: Evitar importa√ß√µes parciais que geram inconsist√™ncias.

**Valida√ß√£o**:
- Processar arquivo completo em mem√≥ria
- Aplicar todas as valida√ß√µes (tipo, formato, regras neg√≥cio)
- Se ‚â•1 erro ‚Üí rejeitar arquivo completo (n√£o gravar nada)
- Gerar relat√≥rio de erros com linha, coluna, descri√ß√£o

**Implementa√ß√£o**:
```csharp
public async Task<ResultadoImportacao> ImportarFatura(Stream arquivo, int idLayout)
{
    var linhas = await _leitorService.LerArquivo(arquivo, idLayout);
    var erros = new List<ErroValidacao>();

    // Validar TODAS as linhas antes de gravar
    foreach (var (linha, index) in linhas.Select((l, i) => (l, i + 1)))
    {
        var validacao = await _validadorService.Validar(linha, idLayout);
        if (!validacao.IsValid)
        {
            erros.AddRange(validacao.Errors.Select(e => new ErroValidacao
            {
                Linha = index,
                Campo = e.PropertyName,
                Erro = e.ErrorMessage
            }));
        }
    }

    if (erros.Any())
        return ResultadoImportacao.Falha(erros);

    // Se chegou aqui, 100% das linhas s√£o v√°lidas
    using var transaction = await _context.Database.BeginTransactionAsync();
    try
    {
        await _context.Faturas.AddRangeAsync(linhas);
        await _context.SaveChangesAsync();
        await transaction.CommitAsync();

        return ResultadoImportacao.Sucesso(linhas.Count);
    }
    catch (Exception ex)
    {
        await transaction.RollbackAsync();
        throw;
    }
}
```

**Mensagem de Erro**: `"FAT_PAR_002: Importa√ß√£o rejeitada - 15 erros encontrados (linhas: 3, 7, 12, ...)"`

---

### RN-030-003: Versionamento Obrigat√≥rio em Mudan√ßas de Layout

**Descri√ß√£o**: Altera√ß√µes em layouts de importa√ß√£o DEVEM criar nova vers√£o (n√£o sobrescrever) com justificativa obrigat√≥ria.

**Justificativa**: Rastreabilidade para auditorias e rollback em caso de problemas.

**Valida√ß√£o**:
- Comparar configura√ß√£o nova vs. atual
- Se diferentes ‚Üí criar registro `Layout_Versao` com snapshot completo
- Incrementar `Numero_Versao`
- Campo `Justificativa_Mudanca` obrigat√≥rio (m√≠nimo 50 caracteres)
- Workflow de aprova√ß√£o se layout for cr√≠tico (usado por >10 fornecedores)

**Implementa√ß√£o**:
```csharp
if (layout.Hash_Configuracao != layoutOriginal.Hash_Configuracao)
{
    if (string.IsNullOrEmpty(layout.Justificativa_Mudanca) || layout.Justificativa_Mudanca.Length < 50)
        throw new ValidationException("Mudan√ßa de layout requer justificativa m√≠nima de 50 caracteres");

    var novaVersao = new Layout_Versao
    {
        Id_Layout = layout.Id,
        Numero_Versao = layoutOriginal.Numero_Versao + 1,
        Configuracao_Anterior_JSON = layoutOriginal.Configuracao_JSON,
        Configuracao_Nova_JSON = layout.Configuracao_JSON,
        Justificativa_Mudanca = layout.Justificativa_Mudanca,
        Data_Vigencia_Inicio = DateTime.Now,
        Id_Usuario_Criacao = CurrentUser.Id
    };

    await _context.Layout_Versao.AddAsync(novaVersao);
    layout.Numero_Versao++;

    // Se layout cr√≠tico, iniciar aprova√ß√£o
    if (layout.Fl_Critico)
        await _workflowService.IniciarAprovacao(layout.Id, TipoWorkflow.AlteracaoLayoutCritico);
}
```

**Mensagem de Erro**: `"FAT_PAR_003: Mudan√ßa em layout cr√≠tico ‚Üí Nova vers√£o 3.0 criada (aprova√ß√£o pendente)"`

---

### RN-030-004: Regra de Auditoria Deve Ter Severidade Definida

**Descri√ß√£o**: Toda regra de auditoria DEVE ter severidade configurada (Informativa, Alerta, Bloqueante).

**Justificativa**: Determinar a√ß√£o do sistema (permitir importa√ß√£o vs. bloquear).

**Valida√ß√£o**:
- Campo `Severidade` obrigat√≥rio (valores: `Informativa`, `Alerta`, `Bloqueante`)
- **Informativa**: Registra log mas permite importa√ß√£o
- **Alerta**: Notifica usu√°rio mas permite importa√ß√£o
- **Bloqueante**: Rejeita importa√ß√£o at√© corre√ß√£o

**Implementa√ß√£o**:
```csharp
public enum SeveridadeRegra
{
    Informativa = 1, // Log apenas
    Alerta = 2,      // Notifica√ß√£o
    Bloqueante = 3   // Rejeitar importa√ß√£o
}

public async Task<ResultadoValidacao> AplicarRegra(Fatura fatura, RegraAuditoria regra)
{
    var violou = await _expressionEngine.Avaliar(regra.Expressao, fatura);

    if (violou)
    {
        switch (regra.Severidade)
        {
            case SeveridadeRegra.Informativa:
                _logger.LogInformation($"Regra '{regra.Nome}' violada: {regra.Mensagem}");
                break;

            case SeveridadeRegra.Alerta:
                await _alertaService.Notificar(fatura.Id_Usuario_Responsavel, regra.Mensagem);
                break;

            case SeveridadeRegra.Bloqueante:
                return ResultadoValidacao.Falha(regra.Mensagem);
        }
    }

    return ResultadoValidacao.Sucesso();
}
```

**Mensagem de Erro**: `"FAT_PAR_004: Regra 'Fatura > R$ 10k sem anexo' (BLOQUEANTE) violada - Importa√ß√£o rejeitada"`

---

### RN-030-005: Template de Rateio Deve Somar 100%

**Descri√ß√£o**: Templates de rateio com distribui√ß√£o percentual DEVEM ter soma exata de 100%.

**Justificativa**: Evitar sobra ou falta de centavos na distribui√ß√£o.

**Valida√ß√£o**:
- Se `Tipo_Rateio = 'Percentual'` ent√£o `SUM(Percentual_Rateio) = 100.00%`
- Toler√¢ncia de ¬±0.01% para arredondamentos
- Validar antes de salvar template

**Implementa√ß√£o**:
```csharp
if (template.Tipo_Rateio == TipoRateio.Percentual)
{
    var somaPercentuais = template.Itens.Sum(i => i.Percentual);

    if (Math.Abs(somaPercentuais - 100m) > 0.01m)
        throw new ValidationException($"Soma dos percentuais deve ser 100% (atual: {somaPercentuais}%)");
}
```

**Mensagem de Erro**: `"FAT_PAR_005: Soma dos percentuais deve ser 100% (atual: 98.5%) - Faltam 1.5%"`

---

### RN-030-006: Simula√ß√£o Obrigat√≥ria Antes de Ativar Layout Novo

**Descri√ß√£o**: Layouts novos DEVEM ser testados em sandbox com arquivo de exemplo antes de ativa√ß√£o em produ√ß√£o.

**Justificativa**: Zero erros em produ√ß√£o por configura√ß√£o incorreta.

**Valida√ß√£o**:
- Bloquear ativa√ß√£o se `Fl_Testado_Sandbox = false`
- Exigir upload de arquivo de exemplo (m√≠nimo 10 linhas)
- Processar em modo dry-run (in-memory, sem gravar BD)
- Gerar relat√≥rio de simula√ß√£o com estat√≠sticas

**Implementa√ß√£o**:
```csharp
[HttpPost("layouts/{id}/ativar")]
public async Task<IResult> AtivarLayout(int id)
{
    var layout = await _context.Layouts.FindAsync(id);

    if (!layout.Fl_Testado_Sandbox)
        return Results.BadRequest(new { erro = "Layout deve ser testado em sandbox antes de ativa√ß√£o" });

    layout.Fl_Ativo = true;
    layout.Data_Ativacao = DateTime.Now;
    await _context.SaveChangesAsync();

    return Results.Ok();
}

[HttpPost("layouts/{id}/testar-sandbox")]
public async Task<IResult> TestarSandbox(int id, IFormFile arquivoTeste)
{
    var resultado = await _importadorService.ProcessarSandbox(id, arquivoTeste.OpenReadStream());

    if (resultado.Sucesso)
    {
        var layout = await _context.Layouts.FindAsync(id);
        layout.Fl_Testado_Sandbox = true;
        await _context.SaveChangesAsync();
    }

    return Results.Ok(resultado);
}
```

**Mensagem de Erro**: `"FAT_PAR_006: Layout deve ser testado em sandbox antes de ativa√ß√£o (envie arquivo exemplo)"`

---

### RN-030-007: Par√¢metros Fiscais com Vig√™ncia Temporal

**Descri√ß√£o**: Al√≠quotas e par√¢metros fiscais DEVEM ter data de vig√™ncia (in√≠cio/fim) para rastreamento hist√≥rico.

**Justificativa**: Mudan√ßas tribut√°rias retroativas exigem rec√°lculo de per√≠odos espec√≠ficos.

**Valida√ß√£o**:
- Campos `Data_Vigencia_Inicio` e `Data_Vigencia_Fim` obrigat√≥rios
- N√£o permitir sobreposi√ß√£o de vig√™ncias para mesmo par√¢metro
- Validar que faturas usem al√≠quota vigente na data de emiss√£o

**Implementa√ß√£o**:
```csharp
public async Task<decimal> ObterAliquotaVigente(string tipoImposto, DateTime dataEmissao)
{
    var aliquota = await _context.Parametros_Fiscais
        .Where(p => p.Tipo_Imposto == tipoImposto
            && p.Data_Vigencia_Inicio <= dataEmissao
            && (p.Data_Vigencia_Fim == null || p.Data_Vigencia_Fim >= dataEmissao))
        .OrderByDescending(p => p.Data_Vigencia_Inicio)
        .FirstOrDefaultAsync();

    if (aliquota == null)
        throw new ValidationException($"Nenhuma al√≠quota vigente para {tipoImposto} em {dataEmissao:yyyy-MM-dd}");

    return aliquota.Valor;
}
```

**Mensagem de Erro**: `"FAT_PAR_007: Nenhuma al√≠quota de ICMS vigente para 15/01/2025 (√∫ltima vig√™ncia: 31/12/2024)"`

---

### RN-030-008: Auditoria Autom√°tica em Mudan√ßas de Par√¢metros Cr√≠ticos

**Descri√ß√£o**: Mudan√ßas em par√¢metros cr√≠ticos (al√≠quotas, regras bloqueantes) DEVEM gerar auditoria autom√°tica com before/after.

**Justificativa**: Compliance SOX e rastreabilidade para fiscaliza√ß√£o.

**Valida√ß√£o**:
- Par√¢metros marcados como `Fl_Critico = true` disparam auditoria
- Registrar snapshot completo antes/depois
- Notificar gestor fiscal via e-mail
- Requerer justificativa obrigat√≥ria (m√≠nimo 100 caracteres)

**Implementa√ß√£o**:
```csharp
public class ParametroAuditInterceptor : SaveChangesInterceptor
{
    public override async ValueTask<InterceptionResult<int>> SavingChangesAsync(
        DbContextEventData eventData,
        InterceptionResult<int> result,
        CancellationToken cancellationToken = default)
    {
        var entries = eventData.Context.ChangeTracker.Entries<Parametro_Faturamento>()
            .Where(e => e.State == EntityState.Modified && e.Entity.Fl_Critico);

        foreach (var entry in entries)
        {
            var auditLog = new AuditLog
            {
                Operacao = "PARAMETRO_CRITICO_UPDATE",
                Entidade = "Parametro_Faturamento",
                Id_Entidade = entry.Entity.Id.ToString(),
                Dados_Antes = JsonSerializer.Serialize(entry.OriginalValues.ToObject()),
                Dados_Depois = JsonSerializer.Serialize(entry.CurrentValues.ToObject()),
                Justificativa = entry.Entity.Justificativa_Mudanca,
                Id_Usuario = _currentUser.Id,
                Data_Operacao = DateTime.UtcNow
            };

            eventData.Context.Set<AuditLog>().Add(auditLog);

            await _emailService.NotificarGestorFiscal(entry.Entity, auditLog);
        }

        return await base.SavingChangesAsync(eventData, result, cancellationToken);
    }
}
```

**Mensagem de Erro**: `"FAT_PAR_008: Al√≠quota ICMS alterada 18% ‚Üí 20% - Auditoria registrada, gestor fiscal notificado"`

---

### RN-030-009: Fornecedor Deve Estar Homologado para Faturamento

**Descri√ß√£o**: Importa√ß√£o de faturas DEVE validar se fornecedor est√° homologado e ativo.

**Justificativa**: Controle de compliance e qualidade de fornecedores.

**Valida√ß√£o**:
- Verificar se `Fornecedor.Fl_Homologado = true` e `Fornecedor.Fl_Ativo = true`
- Validar documenta√ß√£o fiscal atualizada (certid√µes negativas < 90 dias)
- Bloquear importa√ß√£o se fornecedor suspenso ou em processo de desligamento

**Implementa√ß√£o**:
```csharp
public async Task ValidarFornecedorHomologado(string cnpj)
{
    var fornecedor = await _context.Fornecedores
        .FirstOrDefaultAsync(f => f.CNPJ == cnpj && f.Fl_Ativo);

    if (fornecedor == null)
        throw new ValidationException($"Fornecedor {cnpj} n√£o encontrado ou inativo");

    if (!fornecedor.Fl_Homologado)
        throw new ValidationException($"Fornecedor {cnpj} n√£o homologado para faturamento");

    // Validar certid√µes
    if (fornecedor.Data_Validade_Certidoes < DateTime.Now.AddDays(-90))
        throw new ValidationException($"Fornecedor {cnpj} com certid√µes desatualizadas (√∫ltima: {fornecedor.Data_Validade_Certidoes:yyyy-MM-dd})");
}
```

**Mensagem de Erro**: `"FAT_PAR_009: Fornecedor 12.345.678/0001-90 n√£o homologado - Inicie processo de homologa√ß√£o"`

---

### RN-030-010: Template de Rateio com Valida√ß√£o de Soma (Valor Fixo)

**Descri√ß√£o**: Templates de rateio com valores fixos DEVEM ter soma igual ao total da fatura.

**Justificativa**: Evitar diferen√ßas de centavos na distribui√ß√£o.

**Valida√ß√£o**:
- Se `Tipo_Rateio = 'Valor_Fixo'` ent√£o `SUM(Valor_Rateio) = Fatura.Valor_Total`
- Calcular automaticamente √∫ltimo item para ajustar diferen√ßas de arredondamento
- Toler√¢ncia de ¬±R$ 0.01

**Implementa√ß√£o**:
```csharp
public async Task AplicarRateio(Fatura fatura, Template_Rateio template)
{
    if (template.Tipo == TipoRateio.ValorFixo)
    {
        var somaRateios = template.Itens.Sum(i => i.Valor_Fixo);

        if (Math.Abs(somaRateios - fatura.Valor_Total) > 0.01m)
        {
            // Ajustar √∫ltimo item
            var ultimoItem = template.Itens.Last();
            var diferenca = fatura.Valor_Total - somaRateios;
            ultimoItem.Valor_Fixo += diferenca;

            _logger.LogInformation($"Rateio ajustado: diferen√ßa R$ {diferenca:N2} adicionada ao item {ultimoItem.Centro_Custo}");
        }
    }

    // Aplicar rateio
    foreach (var item in template.Itens)
    {
        var rateio = new Fatura_Rateio
        {
            Id_Fatura = fatura.Id,
            Id_Centro_Custo = item.Id_Centro_Custo,
            Valor = template.Tipo == TipoRateio.Percentual
                ? fatura.Valor_Total * (item.Percentual / 100)
                : item.Valor_Fixo
        };

        await _context.Fatura_Rateio.AddAsync(rateio);
    }
}
```

**Mensagem de Erro**: `"FAT_PAR_010: Soma dos rateios (R$ 9.998,50) difere do total fatura (R$ 10.000,00) - Diferen√ßa R$ 1,50 ajustada"`

---

### RN-030-011: Express√µes de Regras com Valida√ß√£o de Sintaxe

**Descri√ß√£o**: Regras de auditoria configuradas como express√µes DEVEM ser validadas sintaticamente antes de salvar.

**Justificativa**: Evitar runtime errors em produ√ß√£o por express√µes inv√°lidas.

**Valida√ß√£o**:
- Usar NCalc ou similar para validar sintaxe
- Testar express√£o com dados fict√≠cios
- Listar vari√°veis dispon√≠veis (ex: `Fatura.Valor`, `Fatura.Data_Vencimento`)
- Bloquear ativa√ß√£o de regra com erro de sintaxe

**Implementa√ß√£o**:
```csharp
public async Task<ResultadoValidacao> ValidarExpressao(string expressao)
{
    try
    {
        var expression = new NCalc.Expression(expressao);

        // Testar com dados fict√≠cios
        expression.Parameters["Fatura.Valor"] = 1000m;
        expression.Parameters["Fatura.Data_Vencimento"] = DateTime.Now;
        expression.Parameters["Fornecedor.CNPJ"] = "12345678000190";

        var resultado = expression.Evaluate();

        if (resultado is not bool)
            return ResultadoValidacao.Falha("Express√£o deve retornar booleano (true/false)");

        return ResultadoValidacao.Sucesso();
    }
    catch (Exception ex)
    {
        return ResultadoValidacao.Falha($"Erro de sintaxe: {ex.Message}");
    }
}

// Exemplo de express√µes v√°lidas:
// "Fatura.Valor > 10000 && String.IsNullOrEmpty(Fatura.Anexo_Caminho)"
// "Fatura.Consumo_kWh > (Media_Ultimos_3_Meses * 1.3)"
```

**Mensagem de Erro**: `"FAT_PAR_011: Erro de sintaxe na express√£o: Token inesperado '&&' (esperado 'AND')"`

---

### RN-030-012: Hist√≥rico de Importa√ß√µes com Reten√ß√£o 7 Anos

**Descri√ß√£o**: Logs de importa√ß√£o (sucesso/erro) devem ser retidos por 7 anos (compliance LGPD + fiscal).

**Justificativa**: Auditoria fiscal e trabalhista.

**Valida√ß√£o**:
- Soft delete em `Importacao_Log`
- Job Hangfire que executa hard delete apenas ap√≥s 7 anos
- Registrar: arquivo original (hash), usu√°rio, data, resultado, erros

**Implementa√ß√£o**:
```csharp
public class CleanupImportacaoLogJob
{
    [AutomaticRetry(Attempts = 3)]
    public async Task Execute()
    {
        var dataLimite = DateTime.UtcNow.AddYears(-7);

        var logsAntigos = await _context.Importacao_Log
            .Where(l => l.Fl_Excluido && l.Data_Exclusao < dataLimite)
            .ToListAsync();

        _context.Importacao_Log.RemoveRange(logsAntigos);
        await _context.SaveChangesAsync();

        _logger.LogInformation($"Hard delete de {logsAntigos.Count} logs de importa√ß√£o com +7 anos");
    }
}
```

**Mensagem de Erro**: `"FAT_PAR_012: Logs de importa√ß√£o retidos por 7 anos (LGPD). Exclus√£o permanente ap√≥s 01/01/2032"`

---

### RN-030-013: Notifica√ß√£o Autom√°tica de Falhas de Importa√ß√£o

**Descri√ß√£o**: Falhas em importa√ß√µes autom√°ticas (agendadas) DEVEM notificar respons√°vel em at√© 5 minutos.

**Justificativa**: Detec√ß√£o r√°pida de problemas para corre√ß√£o antes de impacto operacional.

**Valida√ß√£o**:
- Se `Tipo_Importacao = 'Agendada'` E `Resultado = 'Falha'` ent√£o notificar
- Canais: In-app, e-mail, SMS (se severidade cr√≠tica)
- Incluir resumo do erro e link para log completo

**Implementa√ß√£o**:
```csharp
public async Task ProcessarImportacaoAgendada(int idAgendamento)
{
    try
    {
        var resultado = await _importadorService.Importar(idAgendamento);

        if (!resultado.Sucesso)
        {
            await _notificationService.NotificarFalhaImportacao(new NotificacaoFalha
            {
                Id_Agendamento = idAgendamento,
                Tipo = "Importa√ß√£o Agendada",
                Erros = resultado.Erros,
                Id_Usuario_Responsavel = agendamento.Id_Usuario_Criacao,
                Severidade = resultado.Erros.Any(e => e.Bloqueante) ? "Cr√≠tica" : "Alta"
            });
        }
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, $"Erro cr√≠tico em importa√ß√£o agendada #{idAgendamento}");

        await _notificationService.NotificarErroCritico(idAgendamento, ex);
    }
}
```

**Mensagem de Erro**: `"FAT_PAR_013: ALERTA - Importa√ß√£o agendada 'Telecom Mensal' falhou (15 erros) - Verifique log #12345"`

---

### RN-030-014: Limite de Linhas por Importa√ß√£o

**Descri√ß√£o**: Importa√ß√µes via upload manual DEVEM ter limite configur√°vel de linhas (padr√£o: 10.000 linhas).

**Justificativa**: Evitar timeout e consumo excessivo de mem√≥ria.

**Valida√ß√£o**:
- Verificar quantidade de linhas antes de processar
- Se exceder limite ‚Üí rejeitar com mensagem orientando upload fracionado
- Limite configur√°vel por perfil de usu√°rio (admin pode mais)

**Implementa√ß√£o**:
```csharp
public async Task<ResultadoImportacao> ImportarArquivo(Stream arquivo, int idLayout)
{
    var limiteLinhas = await ObterLimiteUsuario(_currentUser.Id);

    var preview = await _leitorService.ContarLinhas(arquivo);

    if (preview.TotalLinhas > limiteLinhas)
        throw new ValidationException($"Arquivo excede limite de {limiteLinhas:N0} linhas (encontrado: {preview.TotalLinhas:N0}). Fracionarpor favor ou usar importa√ß√£o agendada.");

    // Processar importa√ß√£o
    return await _importadorService.Processar(arquivo, idLayout);
}

private async Task<int> ObterLimiteUsuario(int idUsuario)
{
    var perfil = await _context.Usuarios
        .Where(u => u.Id == idUsuario)
        .Select(u => u.Perfil)
        .FirstOrDefaultAsync();

    return perfil switch
    {
        "Admin" => 100000,
        "Manager" => 50000,
        "Analyst" => 10000,
        _ => 5000
    };
}
```

**Mensagem de Erro**: `"FAT_PAR_014: Arquivo com 25.000 linhas excede limite (10.000). Fracioneou use importa√ß√£o agendada"`

---

### RN-030-015: Dashboard de Qualidade com Atualiza√ß√£o Real-Time

**Descri√ß√£o**: Dashboard de qualidade de dados DEVE atualizar em tempo real (lat√™ncia m√°xima 5 segundos).

**Justificativa**: Visibilidade imediata de problemas durante importa√ß√µes.

**Valida√ß√£o**:
- Usar SignalR para push de m√©tricas
- M√©tricas: % sucesso, % erro, tempo m√©dio, top erros
- Atualizar a cada importa√ß√£o conclu√≠da

**Implementa√ß√£o**:
```csharp
public class ImportacaoHub : Hub
{
    public async Task AtualizarDashboard(int idConglomerado)
    {
        var metricas = await _metricsService.ObterMetricas(idConglomerado, periodo: TimeSpan.FromHours(24));

        await Clients.Group($"conglomerado-{idConglomerado}").SendAsync("DashboardAtualizado", metricas);
    }
}

// Trigger ao final de cada importa√ß√£o
public async Task OnImportacaoConcluida(int idConglomerado)
{
    await _hubContext.Clients
        .Group($"conglomerado-{idConglomerado}")
        .SendAsync("ImportacaoConcluida", new
        {
            Timestamp = DateTime.Now,
            TotalImportacoes_Hoje = await _context.Importacao_Log.CountAsync(l => l.Data_Importacao.Date == DateTime.Today)
        });
}
```

**Mensagem de Erro**: N/A (funcionalidade, n√£o gera erro)

---

## üóÑÔ∏è SE√á√ÉO 3: BANCO DE DADOS LEGADO

### 3.1 Tabelas Principais do Sistema Legado

#### Tabela: `Layout_Importacao` (Evolu√ß√£o de 2 Vers√µes)

**Vers√£o 1 (2014)**: Hardcoded no VB.NET (sem tabela)
```vb
' C√≥digo VB.NET legado (sem tabela BD)
Private Function ProcessarExcel(arquivo As String) As DataTable
    ' Layout fixo: Coluna A = CNPJ, B = N√∫mero, C = Data, D = Valor
    ' SEM flexibilidade
End Function
```

**Vers√£o 2 (2020)**: Primeira vers√£o com tabela
```sql
CREATE TABLE Layout_Importacao (
    Id_Layout INT IDENTITY(1,1) PRIMARY KEY,
    Nome_Layout NVARCHAR(200) NOT NULL,
    Tipo_Arquivo VARCHAR(20), -- 'CSV', 'Excel', 'XML'
    Configuracao_JSON NVARCHAR(MAX), -- Mapeamento de colunas
    Id_Fornecedor INT,
    Fl_Ativo BIT DEFAULT 1,
    Id_Usuario_Criacao INT,
    Data_Criacao DATETIME DEFAULT GETDATE()
)
```

**Vers√£o 3 (2023 - Atual)**: Multi-tenancy e versionamento
```sql
ALTER TABLE Layout_Importacao ADD Id_Conglomerado INT NOT NULL DEFAULT 1;
ALTER TABLE Layout_Importacao ADD Numero_Versao VARCHAR(20) DEFAULT '1.0';
ALTER TABLE Layout_Importacao ADD Hash_Configuracao VARCHAR(64); -- SHA256 para detectar mudan√ßas
ALTER TABLE Layout_Importacao ADD Fl_Critico BIT DEFAULT 0; -- Se requer aprova√ß√£o em mudan√ßas
ALTER TABLE Layout_Importacao ADD Fl_Testado_Sandbox BIT DEFAULT 0;
ALTER TABLE Layout_Importacao ADD Justificativa_Mudanca NVARCHAR(1000);
```

---

#### Tabela: `Layout_Coluna` (Mapeamento de Campos)

```sql
CREATE TABLE Layout_Coluna (
    Id_Coluna INT IDENTITY(1,1) PRIMARY KEY,
    Id_Layout INT NOT NULL,
    Nome_Coluna VARCHAR(100) NOT NULL, -- Nome no arquivo (ex: "CNPJ_Fornecedor")
    Nome_Campo_Destino VARCHAR(100) NOT NULL, -- Campo na tabela Fatura (ex: "Fornecedor_CNPJ")
    Tipo_Dado VARCHAR(20) NOT NULL, -- 'String', 'Decimal', 'Date', 'Integer'
    Formato_Data VARCHAR(50), -- Ex: "dd/MM/yyyy", "yyyy-MM-dd"
    Obrigatorio BIT DEFAULT 0,
    Posicao_Coluna INT, -- Para arquivos posicionais (ex: CNAB)
    Transformacao VARCHAR(200), -- Ex: "UPPER", "TRIM", "REGEX:([0-9]{2}\\.[0-9]{3}\\.[0-9]{3}\\/[0-9]{4}\\-[0-9]{2})"
    Valor_Padrao NVARCHAR(200), -- Valor se coluna vazia

    CONSTRAINT FK_Layout_Coluna_Layout FOREIGN KEY (Id_Layout) REFERENCES Layout_Importacao(Id_Layout)
)
```

---

#### Tabela: `Regra_Auditoria_Faturamento`

```sql
CREATE TABLE Regra_Auditoria_Faturamento (
    Id_Regra INT IDENTITY(1,1) PRIMARY KEY,
    Nome_Regra NVARCHAR(200) NOT NULL,
    Descricao NVARCHAR(500),
    Expressao NVARCHAR(MAX) NOT NULL, -- Ex: "Fatura.Valor > 10000 && String.IsNullOrEmpty(Fatura.Anexo_Caminho)"
    Severidade VARCHAR(20) NOT NULL, -- 'Informativa', 'Alerta', 'Bloqueante'
    Mensagem_Violacao NVARCHAR(500), -- Mensagem personalizada
    Categoria VARCHAR(50), -- 'Financeiro', 'Conformidade', 'Qualidade'
    Fl_Ativa BIT DEFAULT 1,
    Id_Conglomerado INT NOT NULL,
    Id_Usuario_Criacao INT,
    Data_Criacao DATETIME DEFAULT GETDATE()
)
```

---

#### Tabela: `Template_Rateio`

```sql
CREATE TABLE Template_Rateio (
    Id_Template INT IDENTITY(1,1) PRIMARY KEY,
    Nome_Template NVARCHAR(200) NOT NULL,
    Descricao NVARCHAR(500),
    Tipo_Rateio VARCHAR(20) NOT NULL, -- 'Percentual', 'ValorFixo', 'Proporcional', 'Escalonado'
    Aplicavel_A VARCHAR(50), -- 'Todos', 'Tipo_Fatura', 'Fornecedor_Especifico'
    Id_Conglomerado INT NOT NULL,
    Fl_Ativo BIT DEFAULT 1,
    Id_Usuario_Criacao INT,
    Data_Criacao DATETIME DEFAULT GETDATE()
)
```

---

#### Tabela: `Template_Rateio_Item`

```sql
CREATE TABLE Template_Rateio_Item (
    Id_Item INT IDENTITY(1,1) PRIMARY KEY,
    Id_Template INT NOT NULL,
    Id_Centro_Custo INT NOT NULL,
    Percentual DECIMAL(5,2), -- Ex: 40.00 (%)
    Valor_Fixo DECIMAL(15,2), -- Ou valor fixo (se tipo = ValorFixo)
    Ordem_Aplicacao INT DEFAULT 1, -- Para rateios escalonados

    CONSTRAINT FK_Template_Rateio_Item_Template FOREIGN KEY (Id_Template) REFERENCES Template_Rateio(Id_Template),
    CONSTRAINT CHK_Percentual CHECK (Percentual IS NULL OR (Percentual > 0 AND Percentual <= 100))
)
```

---

#### Tabela: `Parametro_Faturamento`

```sql
CREATE TABLE Parametro_Faturamento (
    Id_Parametro INT IDENTITY(1,1) PRIMARY KEY,
    Nome_Parametro VARCHAR(100) NOT NULL UNIQUE, -- Ex: "ICMS_SP", "Prazo_Vencimento_Padrao"
    Descricao NVARCHAR(500),
    Tipo_Parametro VARCHAR(50) NOT NULL, -- 'Aliquota', 'Prazo', 'Valor_Minimo', 'Percentual'
    Valor_Parametro NVARCHAR(500) NOT NULL, -- Valor em formato string (converter depois)
    Unidade_Medida VARCHAR(20), -- '%', 'dias', 'R$'
    Data_Vigencia_Inicio DATE NOT NULL,
    Data_Vigencia_Fim DATE,
    Fl_Critico BIT DEFAULT 0, -- Se mudan√ßas requerem auditoria especial
    Justificativa_Mudanca NVARCHAR(1000),
    Id_Conglomerado INT NOT NULL,
    Id_Usuario_Criacao INT,
    Data_Criacao DATETIME DEFAULT GETDATE()
)
```

---

#### Tabela: `Fornecedor_Homologacao`

```sql
CREATE TABLE Fornecedor_Homologacao (
    Id_Homologacao INT IDENTITY(1,1) PRIMARY KEY,
    Id_Fornecedor INT NOT NULL,
    Data_Homologacao DATE NOT NULL,
    Validade_Homologacao DATE, -- Revalida√ß√£o peri√≥dica (ex: anual)
    Status_Homologacao VARCHAR(50) DEFAULT 'Ativa', -- 'Ativa', 'Suspensa', 'Cancelada', 'Em An√°lise'
    Documentos_Anexos NVARCHAR(MAX), -- JSON com caminhos de arquivos
    Data_Validade_Certidoes DATE, -- Certid√£o negativa, regularidade fiscal
    Observacoes NVARCHAR(MAX),
    Id_Usuario_Responsavel INT,
    Data_Criacao DATETIME DEFAULT GETDATE(),

    CONSTRAINT FK_Fornecedor_Homologacao_Fornecedor FOREIGN KEY (Id_Fornecedor) REFERENCES Fornecedor(Id_Fornecedor)
)
```

---

#### Tabela: `Importacao_Log`

```sql
CREATE TABLE Importacao_Log (
    Id_Log INT IDENTITY(1,1) PRIMARY KEY,
    Id_Layout INT NOT NULL,
    Nome_Arquivo_Original NVARCHAR(500),
    Hash_Arquivo VARCHAR(64), -- SHA256 do arquivo original
    Tipo_Importacao VARCHAR(20), -- 'Manual', 'Agendada', 'API'
    Data_Importacao DATETIME DEFAULT GETDATE(),
    Resultado VARCHAR(20), -- 'Sucesso', 'Falha', 'Parcial'
    Total_Linhas_Processadas INT,
    Total_Linhas_Sucesso INT,
    Total_Linhas_Erro INT,
    Erros_JSON NVARCHAR(MAX), -- JSON com detalhes de cada erro
    Tempo_Processamento_Ms INT, -- Milissegundos
    Id_Usuario INT,
    Id_Conglomerado INT NOT NULL,
    Fl_Excluido BIT DEFAULT 0,
    Data_Exclusao DATETIME,

    CONSTRAINT FK_Importacao_Log_Layout FOREIGN KEY (Id_Layout) REFERENCES Layout_Importacao(Id_Layout)
)

CREATE INDEX IX_Importacao_Log_Data ON Importacao_Log(Data_Importacao DESC);
CREATE INDEX IX_Importacao_Log_Resultado ON Importacao_Log(Resultado);
```

---

#### Tabela: `Layout_Versao` (Hist√≥rico de Mudan√ßas)

```sql
CREATE TABLE Layout_Versao (
    Id_Versao INT IDENTITY(1,1) PRIMARY KEY,
    Id_Layout INT NOT NULL,
    Numero_Versao VARCHAR(20) NOT NULL,
    Configuracao_Anterior_JSON NVARCHAR(MAX),
    Configuracao_Nova_JSON NVARCHAR(MAX),
    Justificativa_Mudanca NVARCHAR(1000),
    Data_Vigencia_Inicio DATE NOT NULL,
    Data_Vigencia_Fim DATE,
    Id_Usuario_Criacao INT,
    Data_Criacao DATETIME DEFAULT GETDATE(),

    CONSTRAINT FK_Layout_Versao_Layout FOREIGN KEY (Id_Layout) REFERENCES Layout_Importacao(Id_Layout)
)
```

---

### 3.2 Stored Procedures Cr√≠ticas

#### `sp_ValidarFornecedorHomologado`

**Fun√ß√£o**: Valida se fornecedor est√° homologado e com documenta√ß√£o atualizada.

```sql
CREATE PROCEDURE sp_ValidarFornecedorHomologado
    @CNPJ_Fornecedor VARCHAR(18),
    @Resultado BIT OUTPUT,
    @Mensagem_Erro NVARCHAR(500) OUTPUT
AS
BEGIN
    DECLARE @Id_Fornecedor INT;
    DECLARE @Data_Validade_Certidoes DATE;
    DECLARE @Status_Homologacao VARCHAR(50);

    -- Buscar fornecedor
    SELECT @Id_Fornecedor = Id_Fornecedor
    FROM Fornecedor
    WHERE CNPJ = @CNPJ_Fornecedor AND Fl_Ativo = 1;

    IF @Id_Fornecedor IS NULL
    BEGIN
        SET @Resultado = 0;
        SET @Mensagem_Erro = 'Fornecedor n√£o encontrado ou inativo';
        RETURN;
    END

    -- Verificar homologa√ß√£o
    SELECT
        @Status_Homologacao = Status_Homologacao,
        @Data_Validade_Certidoes = Data_Validade_Certidoes
    FROM Fornecedor_Homologacao
    WHERE Id_Fornecedor = @Id_Fornecedor
      AND Status_Homologacao = 'Ativa'
      AND (Validade_Homologacao IS NULL OR Validade_Homologacao >= GETDATE());

    IF @Status_Homologacao IS NULL
    BEGIN
        SET @Resultado = 0;
        SET @Mensagem_Erro = 'Fornecedor n√£o homologado para faturamento';
        RETURN;
    END

    -- Verificar certid√µes
    IF @Data_Validade_Certidoes < DATEADD(DAY, -90, GETDATE())
    BEGIN
        SET @Resultado = 0;
        SET @Mensagem_Erro = 'Certid√µes fiscais desatualizadas (√∫ltima: ' + CONVERT(VARCHAR, @Data_Validade_Certidoes, 103) + ')';
        RETURN;
    END

    -- Tudo OK
    SET @Resultado = 1;
    SET @Mensagem_Erro = NULL;
END
```

**Migra√ß√£o para Moderniza√ß√£o**: Command `ValidarFornecedorHomologadoCommand` com mesma l√≥gica em C#.

---

#### `sp_ObterMetricasQualidadeDados`

**Fun√ß√£o**: Calcula m√©tricas de qualidade para dashboard (√∫ltimas 24h).

```sql
CREATE PROCEDURE sp_ObterMetricasQualidadeDados
    @Id_Conglomerado INT,
    @Horas_Periodo INT = 24
AS
BEGIN
    DECLARE @Data_Inicio DATETIME = DATEADD(HOUR, -@Horas_Periodo, GETDATE());

    SELECT
        COUNT(*) AS Total_Importacoes,
        SUM(CASE WHEN Resultado = 'Sucesso' THEN 1 ELSE 0 END) AS Total_Sucesso,
        SUM(CASE WHEN Resultado = 'Falha' THEN 1 ELSE 0 END) AS Total_Falhas,
        SUM(Total_Linhas_Processadas) AS Total_Linhas,
        SUM(Total_Linhas_Erro) AS Total_Linhas_Erro,
        CAST(SUM(Total_Linhas_Sucesso) AS FLOAT) / NULLIF(SUM(Total_Linhas_Processadas), 0) * 100 AS Percentual_Sucesso,
        AVG(Tempo_Processamento_Ms) AS Tempo_Medio_Ms,
        MAX(Tempo_Processamento_Ms) AS Tempo_Maximo_Ms
    FROM Importacao_Log
    WHERE Id_Conglomerado = @Id_Conglomerado
      AND Data_Importacao >= @Data_Inicio;

    -- Top 5 erros mais frequentes
    SELECT TOP 5
        JSON_VALUE(erro.value, '$.Campo') AS Campo,
        JSON_VALUE(erro.value, '$.Erro') AS Mensagem_Erro,
        COUNT(*) AS Frequencia
    FROM Importacao_Log
    CROSS APPLY OPENJSON(Erros_JSON) AS erro
    WHERE Id_Conglomerado = @Id_Conglomerado
      AND Data_Importacao >= @Data_Inicio
      AND Erros_JSON IS NOT NULL
    GROUP BY JSON_VALUE(erro.value, '$.Campo'), JSON_VALUE(erro.value, '$.Erro')
    ORDER BY Frequencia DESC;
END
```

**Migra√ß√£o para Moderniza√ß√£o**: Query `GetMetricasQualidadeDadosQuery` + cache Redis (TTL 5min).

---

### 3.3 Views Importantes

#### `vw_Dashboard_Qualidade`

**Fun√ß√£o**: View para dashboard de qualidade (usada em 5+ telas legado).

```sql
CREATE VIEW vw_Dashboard_Qualidade AS
SELECT
    l.Id_Layout,
    li.Nome_Layout,
    COUNT(*) AS Total_Importacoes_30d,
    SUM(CASE WHEN l.Resultado = 'Sucesso' THEN 1 ELSE 0 END) AS Total_Sucesso,
    SUM(CASE WHEN l.Resultado = 'Falha' THEN 1 ELSE 0 END) AS Total_Falhas,
    CAST(SUM(l.Total_Linhas_Sucesso) AS FLOAT) / NULLIF(SUM(l.Total_Linhas_Processadas), 0) * 100 AS Taxa_Sucesso_Percentual,
    AVG(l.Tempo_Processamento_Ms) AS Tempo_Medio_Ms,
    MAX(l.Data_Importacao) AS Ultima_Importacao
FROM Importacao_Log l
INNER JOIN Layout_Importacao li ON l.Id_Layout = li.Id_Layout
WHERE l.Data_Importacao >= DATEADD(DAY, -30, GETDATE())
  AND l.Fl_Excluido = 0
GROUP BY l.Id_Layout, li.Nome_Layout;
```

**Migra√ß√£o para Moderniza√ß√£o**: DTO `DashboardQualidadeDTO` retornado por `GetDashboardQualidadeQuery`.

---

## üîó SE√á√ÉO 4: WEBSERVICES E APIs LEGADO

### 4.1 Webservices SOAP (Sistema Legado)

O sistema legado possui **1 webservice SOAP** para par√¢metros de faturamento:

#### `ParametrosFaturamentoService.asmx`

**Localiza√ß√£o**: `D:/IC2/ic1_legado/IControlIT/WebServices/ParametrosFaturamentoService.asmx`

**M√©todos Principais**:

1. **`GetLayoutsPorFornecedor(int idFornecedor)`**
   - Retorna layouts configurados para fornecedor
   - Moderniza√ß√£o: `GET /api/parametros/layouts?idFornecedor={id}`

2. **`ValidarArquivoPreImportacao(byte[] arquivo, int idLayout)`**
   - Valida arquivo antes de importar
   - Moderniza√ß√£o: `POST /api/parametros/layouts/{id}/validar`

3. **`GetRegrasAuditoriaAtivas()`**
   - Lista regras de auditoria ativas
   - Moderniza√ß√£o: `GET /api/parametros/regras-auditoria?ativas=true`

4. **`GetTemplatesRateio()`**
   - Lista templates de rateio dispon√≠veis
   - Moderniza√ß√£o: `GET /api/parametros/templates-rateio`

---

### 4.2 REST APIs Modernizadas

**Todos os endpoints seguem padr√£o REST com Minimal APIs ASP.NET Core:**

#### **Grupo: `/api/parametros/layouts`**

| M√©todo | Endpoint | Descri√ß√£o | Autoriza√ß√£o |
|--------|----------|-----------|-------------|
| GET | `/api/parametros/layouts` | Lista layouts com filtros | `Parametros.View` |
| GET | `/api/parametros/layouts/{id}` | Detalhes de layout espec√≠fico | `Parametros.View` |
| POST | `/api/parametros/layouts` | Cria novo layout | `Parametros.Create` |
| PUT | `/api/parametros/layouts/{id}` | Atualiza layout existente | `Parametros.Update` |
| DELETE | `/api/parametros/layouts/{id}` | Soft delete de layout | `Parametros.Delete` |
| POST | `/api/parametros/layouts/{id}/testar-sandbox` | Testa layout em sandbox | `Parametros.Test` |
| POST | `/api/parametros/layouts/{id}/ativar` | Ativa layout para produ√ß√£o | `Parametros.Activate` |
| POST | `/api/parametros/layouts/{id}/validar` | Valida arquivo pr√©-importa√ß√£o | `Parametros.Validate` |

#### **Grupo: `/api/parametros/regras-auditoria`**

| M√©todo | Endpoint | Descri√ß√£o | Autoriza√ß√£o |
|--------|----------|-----------|-------------|
| GET | `/api/parametros/regras-auditoria` | Lista regras com filtros | `Parametros.View` |
| POST | `/api/parametros/regras-auditoria` | Cria nova regra | `Parametros.Create` |
| PUT | `/api/parametros/regras-auditoria/{id}` | Atualiza regra | `Parametros.Update` |
| POST | `/api/parametros/regras-auditoria/{id}/testar` | Testa regra com dados fict√≠cios | `Parametros.Test` |
| POST | `/api/parametros/regras-auditoria/{id}/ativar` | Ativa regra | `Parametros.Activate` |

#### **Grupo: `/api/parametros/templates-rateio`**

| M√©todo | Endpoint | Descri√ß√£o | Autoriza√ß√£o |
|--------|----------|-----------|-------------|
| GET | `/api/parametros/templates-rateio` | Lista templates | `Parametros.View` |
| POST | `/api/parametros/templates-rateio` | Cria template | `Parametros.Create` |
| PUT | `/api/parametros/templates-rateio/{id}` | Atualiza template | `Parametros.Update` |
| POST | `/api/parametros/templates-rateio/{id}/simular` | Simula rateio com dados teste | `Parametros.Test` |

#### **Grupo: `/api/parametros/fiscais`**

| M√©todo | Endpoint | Descri√ß√£o | Autoriza√ß√£o |
|--------|----------|-----------|-------------|
| GET | `/api/parametros/fiscais` | Lista par√¢metros fiscais | `Parametros.View` |
| GET | `/api/parametros/fiscais/aliquota` | Obter al√≠quota vigente | `Parametros.View` |
| POST | `/api/parametros/fiscais` | Cria par√¢metro fiscal | `Parametros.Fiscal.Create` |
| PUT | `/api/parametros/fiscais/{id}` | Atualiza par√¢metro (versionamento) | `Parametros.Fiscal.Update` |

#### **Grupo: `/api/parametros/dashboard`**

| M√©todo | Endpoint | Descri√ß√£o | Autoriza√ß√£o |
|--------|----------|-----------|-------------|
| GET | `/api/parametros/dashboard/qualidade` | Dashboard de qualidade de dados | `Parametros.Dashboard.View` |
| GET | `/api/parametros/dashboard/metricas` | M√©tricas de importa√ß√£o (24h) | `Parametros.Dashboard.View` |
| GET | `/api/parametros/dashboard/top-erros` | Top 10 erros mais frequentes | `Parametros.Dashboard.View` |

#### **Grupo: `/api/parametros/fornecedores`**

| M√©todo | Endpoint | Descri√ß√£o | Autoriza√ß√£o |
|--------|----------|-----------|-------------|
| GET | `/api/parametros/fornecedores/homologados` | Lista fornecedores homologados | `Parametros.View` |
| POST | `/api/parametros/fornecedores/{id}/homologar` | Homologa fornecedor (workflow) | `Parametros.Fornecedor.Homologar` |
| POST | `/api/parametros/fornecedores/{id}/suspender` | Suspende homologa√ß√£o | `Parametros.Fornecedor.Suspender` |

---

### 4.3 GraphQL (Complementar REST)

**Endpoint**: `/graphql`

**Queries Dispon√≠veis**:

```graphql
type Query {
  layout(id: ID!): Layout
  layouts(
    fornecedorId: ID
    tipoArquivo: TipoArquivo
    ativo: Boolean
  ): [Layout!]!

  regrasAuditoria(
    categoria: CategoriaRegra
    severidade: SeveridadeRegra
    ativas: Boolean
  ): [RegraAuditoria!]!

  templatesRateio(
    tipo: TipoRateio
    ativos: Boolean
  ): [TemplateRateio!]!

  dashboardQualidade(
    conglomeradoId: ID!
    periodo: Int = 24
  ): DashboardQualidade
}

type Layout {
  id: ID!
  nome: String!
  tipoArquivo: TipoArquivo!
  colunas: [Coluna!]!
  numeroVersao: String!
  ativo: Boolean!
  testadoSandbox: Boolean!
}

type DashboardQualidade {
  totalImportacoes: Int!
  taxaSucesso: Decimal!
  tempoMedioMs: Int!
  topErros: [ErroFrequente!]!
}
```

---

## üîå SE√á√ÉO 5: INTEGRA√á√ïES OBRIGAT√ìRIAS

### 5.1 Central de Funcionalidades

**Funcionalidade**: `GES.PARAMETROS_FATURAMENTO`

**Subfuncionalidades**:
- `GES.PARAMETROS.LAYOUTS.LISTAR`
- `GES.PARAMETROS.LAYOUTS.CRIAR`
- `GES.PARAMETROS.LAYOUTS.EDITAR`
- `GES.PARAMETROS.REGRAS.CRIAR`
- `GES.PARAMETROS.TEMPLATES.CRIAR`
- `GES.PARAMETROS.DASHBOARD`

---

### 5.2 Internacionaliza√ß√£o (i18n)

**Chaves de Tradu√ß√£o** (arquivo: `pt-BR/parametros-faturamento.json`):

```json
{
  "parametros": {
    "title": "Par√¢metros de Faturamento",
    "subtitle": "Configura√ß√µes Centralizadas de Importa√ß√£o e Auditoria",

    "layouts": {
      "title": "Layouts de Importa√ß√£o",
      "criar": "Criar Layout",
      "testar": "Testar em Sandbox",
      "ativar": "Ativar para Produ√ß√£o"
    },

    "regras": {
      "title": "Regras de Auditoria",
      "severidades": {
        "informativa": "Informativa",
        "alerta": "Alerta",
        "bloqueante": "Bloqueante"
      }
    }
  }
}
```

---

### 5.3 Auditoria

Todas as opera√ß√µes em par√¢metros cr√≠ticos s√£o auditadas com before/after completo.

---

### 5.4 Controle de Acesso (RBAC)

| Permiss√£o | Operator | Analyst | Manager | Admin |
|-----------|----------|---------|---------|-------|
| `Parametros.View` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| `Parametros.Create` | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ |
| `Parametros.Update` | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ |
| `Parametros.Fiscal.Update` | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ |

---

## ‚úÖ Checklist de Completude

- [x] SE√á√ÉO 1: Resumo Executivo com 10 funcionalidades
- [x] SE√á√ÉO 2: 15 Regras de Neg√≥cio detalhadas
- [x] SE√á√ÉO 3: Banco de Dados Legado (8 tabelas + SPs + views)
- [x] SE√á√ÉO 4: Webservices Legado + APIs REST (40+ endpoints)
- [x] SE√á√ÉO 5: 4 Integra√ß√µes Obrigat√≥rias
- [x] Markdown profissional
- [x] ROI e Impacto de Neg√≥cio

---

**Documento criado por**: Agente Architect - IControlIT
**Data**: 2025-01-14
**Vers√£o**: 1.0
**Status**: ‚úÖ COMPLETO
