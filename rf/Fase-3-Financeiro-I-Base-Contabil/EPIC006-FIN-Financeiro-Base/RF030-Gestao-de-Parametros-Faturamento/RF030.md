# RF030 — Gestão de Parâmetros de Faturamento

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC006-FIN - Financeiro Base
**Fase**: Fase 3 - Financeiro I - Base Contábil

---

## 1. OBJETIVO DO REQUISITO

Estabelecer o sistema de configuração centralizada de **parâmetros, regras e templates** para o processo de faturamento, permitindo a gestão de layouts de importação, regras de auditoria automática, templates de rateio e parâmetros fiscais com versionamento completo e rastreabilidade.

Este requisito define **o que o sistema deve fazer** em termos de configuração e validação pré-importação de faturas, sem especificar implementação técnica.

**Problema Resolvido**: Eliminar configurações hardcoded, possibilitar flexibilidade na importação de múltiplos formatos de arquivo e fornecedores, detectar erros antes do processamento e garantir compliance fiscal e auditoria completa.

**Público Afetado**: Gestores financeiros, analistas de faturamento, fornecedores (via API) e sistemas integrados.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- Gerenciamento de layouts de importação (CRUD)
- Motor de validação pré-importação com regras configuráveis
- Biblioteca de regras de auditoria (50+ regras)
- Templates de rateio (percentual, fixo, proporcional, escalonado)
- Simulador de importação (sandbox)
- Versionamento de configurações com rastreabilidade completa
- Parâmetros fiscais e tributários com vigência temporal
- Gestão de fornecedores homologados
- Dashboard de qualidade de dados
- API REST/GraphQL para integrações externas

### 2.2 Fora do escopo

- Processo de importação de faturas em si (coberto por RF026)
- Integração com sistemas externos de fornecedores (coberto por RF específico)
- Interface visual específica (design system)
- Infraestrutura de deploy e hosting
- Motor de workflow de aprovação (coberto por RF de Workflow)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Layout de Importação** | Configuração que define estrutura, colunas, validações e transformações de arquivos para importação de faturas |
| **Regra de Auditoria** | Expressão booleana configurável que valida faturas segundo critérios de negócio (ex: valor acima de threshold sem anexo) |
| **Template de Rateio** | Modelo reutilizável que define distribuição de custos entre centros de custo, departamentos ou projetos |
| **Parâmetro Fiscal** | Configuração de alíquotas, CFOP, NCM, CST, regime tributário com vigência temporal |
| **Fornecedor Homologado** | Fornecedor aprovado para faturamento com documentação fiscal válida |
| **Versionamento** | Registro histórico de mudanças em configurações com before/after, justificativa e usuário responsável |
| **Sandbox** | Ambiente isolado para teste de layouts com dados fictícios sem impacto em produção |
| **Severidade** | Classificação de regras de auditoria (Informativa, Alerta, Bloqueante) |

---

## 4. FUNCIONALIDADES COBERTAS

1. Criar layout de importação
2. Atualizar layout existente (com versionamento)
3. Testar layout em sandbox
4. Ativar layout para produção
5. Validar arquivo pré-importação
6. Criar regra de auditoria
7. Atualizar regra de auditoria
8. Testar regra com dados fictícios
9. Criar template de rateio
10. Simular rateio com valores exemplo
11. Criar parâmetro fiscal
12. Atualizar parâmetro fiscal (com versionamento)
13. Homologar fornecedor
14. Suspender homologação de fornecedor
15. Consultar dashboard de qualidade

---

## 5. REGRAS DE NEGÓCIO

### RN-RF030-001 — Campos Obrigatórios em Layout

**Descrição**: Todo layout de importação deve validar no mínimo 5 campos obrigatórios: CNPJ fornecedor, número fatura, data vencimento, valor total e descrição.

**Justificativa**: Campos essenciais para rastreabilidade fiscal e financeira.

**Critério de Aceite**:
- Layout sem qualquer um dos campos obrigatórios → rejeição com erro específico
- Campo com tipo de dado incorreto → rejeição
- Sistema deve bloquear ativação de layout sem campos obrigatórios

---

### RN-RF030-002 — Validação Pré-Importação All-or-Nothing

**Descrição**: Sistema deve validar 100% das linhas ANTES de gravar qualquer registro (modo transacional).

**Justificativa**: Evitar importações parciais que causem inconsistências.

**Critério de Aceite**:
- Se ≥1 linha com erro → rejeitar arquivo completo
- Gerar relatório de erros com linha, coluna e descrição
- Nenhum dado gravado se houver qualquer erro
- Rollback automático em caso de falha durante gravação

---

### RN-RF030-003 — Versionamento Obrigatório em Mudanças

**Descrição**: Alterações em layouts, regras ou parâmetros críticos devem criar nova versão com justificativa obrigatória (mínimo 50 caracteres).

**Justificativa**: Rastreabilidade para auditorias e rollback.

**Critério de Aceite**:
- Comparação hash da configuração (detecção de mudança)
- Incremento automático de versão
- Justificativa obrigatória (mínimo 50 caracteres)
- Workflow de aprovação para itens críticos (usados por >10 fornecedores)
- Registro de before/after completo

---

### RN-RF030-004 — Severidade Obrigatória em Regras

**Descrição**: Toda regra de auditoria deve ter severidade definida: Informativa, Alerta ou Bloqueante.

**Justificativa**: Determinar ação do sistema (permitir vs bloquear importação).

**Critério de Aceite**:
- **Informativa**: Registra log, permite importação
- **Alerta**: Notifica usuário, permite importação
- **Bloqueante**: Rejeita importação até correção
- Campo severidade obrigatório

---

### RN-RF030-005 — Template Rateio Percentual Soma 100%

**Descrição**: Templates de rateio com distribuição percentual devem ter soma exata de 100%.

**Justificativa**: Evitar sobra ou falta de centavos.

**Critério de Aceite**:
- SUM(percentuais) = 100.00%
- Tolerância de ±0.01% para arredondamentos
- Validação antes de salvar template
- Mensagem de erro clara se soma incorreta

---

### RN-RF030-006 — Simulação Obrigatória Antes de Ativação

**Descrição**: Layouts novos devem ser testados em sandbox com arquivo exemplo (mínimo 10 linhas) antes de ativação.

**Justificativa**: Zero erros em produção por configuração incorreta.

**Critério de Aceite**:
- Bloquear ativação se `Fl_Testado_Sandbox = false`
- Exigir upload de arquivo de exemplo
- Processamento dry-run (in-memory, sem gravar BD)
- Relatório de simulação com estatísticas

---

### RN-RF030-007 — Vigência Temporal em Parâmetros Fiscais

**Descrição**: Alíquotas e parâmetros fiscais devem ter data de vigência (início/fim).

**Justificativa**: Mudanças tributárias retroativas exigem recálculo histórico.

**Critério de Aceite**:
- Campos `Data_Vigencia_Inicio` e `Data_Vigencia_Fim` obrigatórios
- Não permitir sobreposição de vigências
- Faturas usam alíquota vigente na data de emissão
- Erro claro se nenhuma alíquota vigente

---

### RN-RF030-008 — Auditoria Automática em Parâmetros Críticos

**Descrição**: Mudanças em parâmetros críticos (alíquotas, regras bloqueantes) devem gerar auditoria automática com before/after.

**Justificativa**: Compliance SOX e rastreabilidade fiscal.

**Critério de Aceite**:
- Snapshot completo antes/depois
- Notificação automática ao gestor fiscal via e-mail
- Justificativa obrigatória (mínimo 100 caracteres)
- Registro em AuditLog com Id_Usuario, Data, Operação

---

### RN-RF030-009 — Fornecedor Homologado para Faturamento

**Descrição**: Importação de faturas deve validar se fornecedor está homologado e ativo.

**Justificativa**: Controle de compliance e qualidade.

**Critério de Aceite**:
- `Fornecedor.Fl_Homologado = true` E `Fornecedor.Fl_Ativo = true`
- Documentação fiscal atualizada (certidões < 90 dias)
- Bloquear importação se fornecedor suspenso
- Mensagem clara com motivo da rejeição

---

### RN-RF030-010 — Template Rateio Valor Fixo Soma Total Fatura

**Descrição**: Templates de rateio com valores fixos devem ter soma igual ao total da fatura.

**Justificativa**: Evitar diferenças de centavos.

**Critério de Aceite**:
- SUM(valores_fixos) = Fatura.Valor_Total
- Tolerância de ±R$ 0.01
- Ajuste automático no último item se necessário
- Log da correção aplicada

---

### RN-RF030-011 — Validação de Sintaxe em Expressões

**Descrição**: Regras de auditoria configuradas como expressões devem ser validadas sintaticamente antes de salvar.

**Justificativa**: Evitar runtime errors em produção.

**Critério de Aceite**:
- Usar NCalc ou similar para validação
- Testar expressão com dados fictícios
- Listar variáveis disponíveis
- Bloquear ativação se erro de sintaxe

---

### RN-RF030-012 — Histórico de Importações com Retenção 7 Anos

**Descrição**: Logs de importação devem ser retidos por 7 anos (compliance LGPD + fiscal).

**Justificativa**: Auditoria fiscal e trabalhista.

**Critério de Aceite**:
- Soft delete em `Importacao_Log`
- Hard delete apenas após 7 anos (job automático)
- Registro completo: arquivo hash, usuário, data, resultado, erros

---

### RN-RF030-013 — Notificação Automática de Falhas

**Descrição**: Falhas em importações automáticas devem notificar responsável em até 5 minutos.

**Justificativa**: Detecção rápida antes de impacto operacional.

**Critério de Aceite**:
- Notificação in-app, e-mail, SMS (se crítico)
- Resumo do erro e link para log
- Envio em até 5 minutos após falha

---

### RN-RF030-014 — Limite de Linhas por Importação

**Descrição**: Importações via upload manual devem ter limite configurável (padrão: 10.000 linhas).

**Justificativa**: Evitar timeout e consumo excessivo de memória.

**Critério de Aceite**:
- Verificar quantidade antes de processar
- Rejeição se exceder limite
- Limite variável por perfil (Admin: 100k, Manager: 50k, Analyst: 10k)
- Mensagem orientando upload fracionado ou importação agendada

---

### RN-RF030-015 — Dashboard Real-Time (Latência Máxima 5s)

**Descrição**: Dashboard de qualidade deve atualizar em tempo real (latência máxima 5 segundos).

**Justificativa**: Visibilidade imediata de problemas.

**Critério de Aceite**:
- Uso de SignalR para push
- Métricas: % sucesso, % erro, tempo médio, top erros
- Atualização a cada importação concluída

---

## 6. ESTADOS DA ENTIDADE

### Layout de Importação

| Estado | Descrição |
|--------|-----------|
| `draft` | Criado, não testado |
| `sandbox_tested` | Testado em sandbox com sucesso |
| `active` | Ativo para uso em produção |
| `inactive` | Inativo (não pode ser usado) |
| `archived` | Arquivado (histórico) |

### Transições permitidas

| De | Para | Condição |
|----|------|----------|
| `draft` | `sandbox_tested` | Após teste sandbox com sucesso |
| `sandbox_tested` | `active` | Aprovação manual |
| `active` | `inactive` | Inativação manual |
| `inactive` | `active` | Reativação manual |
| `active` | `archived` | Substituição por nova versão |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre | Ação |
|--------|---------------|------|
| `layout.criado` | Após criação de layout | Registrar auditoria |
| `layout.testado_sandbox` | Após teste sandbox | Marcar flag, gerar relatório |
| `layout.ativado` | Após ativação | Notificar usuários, registrar auditoria |
| `layout.versao_criada` | Mudança em layout | Criar snapshot, notificar gestor |
| `regra_auditoria.criada` | Criação de regra | Registrar auditoria |
| `regra_auditoria.violada` | Violação de regra | Log, notificação ou bloqueio (conforme severidade) |
| `template_rateio.criado` | Criação de template | Registrar auditoria |
| `parametro_fiscal.alterado` | Mudança em parâmetro crítico | Auditoria especial, notificar gestor fiscal |
| `fornecedor.homologado` | Homologação aprovada | Notificar fornecedor, ativar faturamento |
| `fornecedor.suspenso` | Homologação suspensa | Bloquear novas faturas, notificar responsável |
| `importacao.falhou` | Falha em importação agendada | Notificação urgente (5min) |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento multi-tenant
- Nenhuma regra de negócio pode ser ignorada silenciosamente
- Erros devem ser previsíveis, rastreáveis e com mensagens claras
- Auditoria deve registrar quem, quando, o quê e por quê (before/after)
- Versionamento obrigatório em mudanças críticas
- Soft delete obrigatório (retenção 7 anos)
- Validação pré-importação 100% (all-or-nothing)
- Dashboard deve ter latência máxima de 5 segundos
- Notificações de falha em até 5 minutos

---

## 9. SEGURANÇA

- Validação de entrada obrigatória em todos os endpoints
- Proteção contra injeção (SQL, XSS, Expression Injection)
- Controle de permissões RBAC em todas as operações
- Isolamento multi-tenant em queries e commands
- Auditoria completa de operações em parâmetros críticos
- Criptografia de dados sensíveis em trânsito e repouso
- Rate limiting em APIs públicas
- API Key obrigatória para integrações externas

**Permissões RBAC**:

| Operação | Permission Code |
|----------|----------------|
| Visualizar parâmetros | `Parametros.View` |
| Criar layout | `Parametros.Layout.Create` |
| Atualizar layout | `Parametros.Layout.Update` |
| Ativar layout | `Parametros.Layout.Activate` |
| Criar regra auditoria | `Parametros.Regra.Create` |
| Atualizar regra | `Parametros.Regra.Update` |
| Criar template rateio | `Parametros.Template.Create` |
| Atualizar parâmetro fiscal | `Parametros.Fiscal.Update` |
| Homologar fornecedor | `Parametros.Fornecedor.Homologar` |
| Dashboard qualidade | `Parametros.Dashboard.View` |

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF030.md** - Casos de Uso detalhados (UC00-UC14)
- **MD-RF030.yaml** - Modelo de Dados (11 tabelas principais)
- **WF-RF030.md** - Wireframes e fluxos de tela
- **TC-RF030-BACKEND.yaml** - Casos de Teste Backend
- **TC-RF030-FRONTEND.yaml** - Casos de Teste Frontend
- **TC-RF030-SEGURANCA.yaml** - Casos de Teste Segurança
- **MT-RF030.yaml** - Massas de Teste

---

## 11. RASTREABILIDADE

### Dependências Upstream

| RF | Descrição | Tipo |
|----|-----------|------|
| RF005 | Gestão de Empresas | Dados de empresas/conglomerados |
| RF007 | Gestão de Usuários | Autenticação e permissões |
| RF019 | Gestão de Fornecedores | Dados de fornecedores |
| RF026 | Processo de Faturamento | Consumidor dos parâmetros |

### Dependências Downstream

| RF | Descrição | Tipo |
|----|-----------|------|
| RF026 | Processo de Faturamento | Utiliza layouts e regras |
| RF031 | Relatórios de Faturamento | Utiliza parâmetros fiscais |
| RF032 | Dashboard Financeiro | Consome métricas de qualidade |

### Artefatos Obrigatórios

| Artefato | Status |
|----------|--------|
| UC-RF030.md | Pendente |
| MD-RF030.yaml | Pendente |
| TC-RF030-*.yaml | Pendente |
| MT-RF030.yaml | Pendente |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0: separação RF/RL, adequação a templates v2.0, remoção de conteúdo legado | Agência ALC - alc.dev.br |
| 1.0 | 2025-01-14 | Versão inicial com análise legado integrada | Agente Architect - IControlIT |
