# =============================================
# RF-089: Conciliação e Auditoria de Faturas
# Versão: 2.0
# Data: 2025-12-31
# Autor: Agência ALC - alc.dev.br
# =============================================

rf:
  id: "RF089"
  nome: "Conciliação e Auditoria de Faturas"
  versao: "2.0"
  data: "2025-12-31"
  fase: "Fase 3 - Financeiro I - Base Contábil"
  epic: "EPIC006-FIN-Financeiro-Base"
  status: "aprovado"

descricao:
  objetivo: |
    Implementar sistema automatizado de conciliação e auditoria de faturas (NF-e) com matching multi-nível,
    detecção de divergências, workflow de aprovação, ML para anomalias, conciliação bancária e relatórios SPED.
  problema_resolvido: |
    Eliminar conciliação manual de faturas em Excel, reduzir fraudes, garantir conformidade fiscal
    (SPED, SOX, LGPD), automatizar matching de documentos e bloquear pagamentos divergentes.
  publico_afetado: |
    Gestores financeiros, controllers, auditores, departamento de contas a pagar, compliance fiscal.

escopo:
  incluso:
    - "Matching automático two-way (NF-e ↔ PC)"
    - "Matching automático three-way (NF-e ↔ PC ↔ RM)"
    - "Detecção de divergências (valores, quantidades, datas, CFOP)"
    - "Classificação de divergências (CRÍTICA, ALTA, MÉDIA, BAIXA)"
    - "Workflow de aprovação com SLA"
    - "Validação de termos contratuais"
    - "Detecção de anomalias com Machine Learning"
    - "Conciliação bancária automática"
    - "Bloqueio automático de pagamentos"
    - "Auditoria completa com event sourcing"
    - "Exportação SPED, Excel, PDF, JSON"
    - "Notificações em tempo real (SignalR)"
    - "Processamento batch noturno (Hangfire)"
  fora:
    - "Importação de NF-e XML (RF-032)"
    - "Gestão de Pedidos de Compra (RF-032)"
    - "Gestão de Contratos (RF-023)"
    - "Interface visual específica"
    - "Deploy e infraestrutura"

entidades:
  - nome: "NotaFiscal"
    descricao: "Nota Fiscal Eletrônica (NF-e) recebida de fornecedores"
    multi_tenant: true
    soft_delete: true
    auditoria: true

  - nome: "Divergencia"
    descricao: "Divergência identificada no matching de documentos"
    multi_tenant: true
    soft_delete: false
    auditoria: true

  - nome: "Conciliacao"
    descricao: "Registro de conciliação bancária (fatura × pagamento)"
    multi_tenant: true
    soft_delete: false
    auditoria: true

  - nome: "AuditoriaEvento"
    descricao: "Log imutável de todas as operações com hash de integridade"
    multi_tenant: true
    soft_delete: false
    auditoria: false

regras_negocio:
  - id: "RN-FIN-089-01"
    descricao: "Toda NF-e deve ser associada a um Pedido de Compra com CHAVE_NFE válida (44 dígitos)"
    tipo: "validacao"
    campos_afetados: ["ChaveNFe", "PedidoCompraId", "FornecedorCNPJ", "ClienteId"]
    obrigatorio: true
    validacao:
      tipo: "campo_obrigatorio"
      mensagem_erro: "CHAVE_NFE é obrigatória e deve ter 44 dígitos"
      http_code: 400

  - id: "RN-FIN-089-02"
    descricao: "Divergências devem ser classificadas em CRÍTICA (>10%), ALTA (5-10%), MÉDIA (2-5%) ou BAIXA (<2%)"
    tipo: "regra_negocio"
    campos_afetados: ["ValorDivergencia", "Severidade"]
    obrigatorio: true

  - id: "RN-FIN-089-03"
    descricao: "Three-way matching deve validar PC → RM → NF-e com tolerâncias configuráveis"
    tipo: "regra_negocio"
    campos_afetados: ["QuantidadePedida", "QuantidadeRecebida", "QuantidadeFaturada", "ValorTotal"]
    obrigatorio: true

  - id: "RN-FIN-089-04"
    descricao: "Validação de termos contratuais (preço, prazo, desconto, alíquotas)"
    tipo: "regra_negocio"
    campos_afetados: ["PrecoUnitario", "PrazoPagamento", "PercentualDesconto", "AliquotaICMS"]
    obrigatorio: true

  - id: "RN-FIN-089-05"
    descricao: "Detecção de anomalias com ML (score >0.75 = revisar, >0.5 = supervisão)"
    tipo: "regra_negocio"
    campos_afetados: ["ScoreAnomalia", "RiscoAnomalia"]
    obrigatorio: true

  - id: "RN-FIN-089-06"
    descricao: "Workflow de aprovação com roteamento automático e SLA (CRÍTICA: 4h, ALTA: 24h, MÉDIA: 72h)"
    tipo: "regra_negocio"
    campos_afetados: ["Severidade", "StatusDivergencia", "DataSLA"]
    obrigatorio: true

  - id: "RN-FIN-089-07"
    descricao: "Bloqueio automático de pagamentos em divergências CRÍTICAS e ALTAS"
    tipo: "seguranca"
    campos_afetados: ["StatusConciliacao", "BloqueadaParaPagamento"]
    obrigatorio: true

  - id: "RN-FIN-089-08"
    descricao: "Conciliação bancária automática com matching de valor e data (±5 dias)"
    tipo: "regra_negocio"
    campos_afetados: ["ValorTotal", "DataVencimento", "DataPagamento"]
    obrigatorio: true

  - id: "RN-FIN-089-09"
    descricao: "Auditoria completa com event sourcing e hash SHA-512"
    tipo: "auditoria"
    campos_afetados: ["OperacaoTipo", "HashIntegridade", "UsuarioId", "Timestamp"]
    obrigatorio: true

  - id: "RN-FIN-089-10"
    descricao: "Exportação de relatórios fiscais SPED (E-100, E-200, E-310)"
    tipo: "integracao"
    campos_afetados: ["ChaveNFe", "CFOP", "AliquotaICMS", "AliquotaIPI"]
    obrigatorio: true

estados:
  - id: "nao_conciliada"
    descricao: "NF-e importada, aguardando matching"
  - id: "conciliada_parcial"
    descricao: "Matching com divergências identificadas"
  - id: "conciliada"
    descricao: "Matching completo, sem divergências ou aprovadas"
  - id: "bloqueada"
    descricao: "Pagamento bloqueado por divergência crítica/alta"
  - id: "paga"
    descricao: "Fatura paga e conciliada bancariamente"
  - id: "cancelada"
    descricao: "NF-e cancelada pelo fornecedor"

transicoes:
  permitidas:
    - de: "nao_conciliada"
      para: "conciliada"
      condicao: "Matching sem divergências"
    - de: "nao_conciliada"
      para: "conciliada_parcial"
      condicao: "Matching com divergências"
    - de: "conciliada_parcial"
      para: "bloqueada"
      condicao: "Divergência CRÍTICA ou ALTA"
    - de: "conciliada_parcial"
      para: "conciliada"
      condicao: "Todas divergências aprovadas"
    - de: "bloqueada"
      para: "conciliada"
      condicao: "Divergências resolvidas"
    - de: "conciliada"
      para: "paga"
      condicao: "Pagamento conciliado bancariamente"
  proibidas:
    - de: "paga"
      para: "nao_conciliada"
      motivo: "Operação irreversível"
    - de: "cancelada"
      para: "qualquer"
      motivo: "NF-e cancelada não pode ser reativada"

permissoes:
  - codigo: "fin.fatura.view_any"
    descricao: "Visualizar lista de faturas"
    roles: ["CONSULTOR", "SUPERVISOR", "GERENTE", "DIRETOR", "CONTROLLER", "AUDITOR"]

  - codigo: "fin.fatura.view"
    descricao: "Visualizar detalhes de fatura"
    roles: ["CONSULTOR", "SUPERVISOR", "GERENTE", "DIRETOR", "CONTROLLER", "AUDITOR"]

  - codigo: "fin.fatura.update"
    descricao: "Editar dados de fatura"
    roles: ["SUPERVISOR", "GERENTE", "DIRETOR", "CONTROLLER"]

  - codigo: "fin.fatura.delete"
    descricao: "Excluir fatura (apenas rascunhos)"
    roles: ["DIRETOR", "AUDITOR"]

  - codigo: "fin.conciliacao.criar"
    descricao: "Executar matching/conciliação"
    roles: ["SUPERVISOR", "GERENTE", "DIRETOR", "CONTROLLER"]

  - codigo: "fin.conciliacao.aprovar_baixa"
    descricao: "Aprovar divergência BAIXA"
    roles: ["SUPERVISOR", "GERENTE", "DIRETOR", "CONTROLLER"]

  - codigo: "fin.conciliacao.aprovar_media"
    descricao: "Aprovar divergência MÉDIA"
    roles: ["GERENTE", "DIRETOR", "CONTROLLER"]

  - codigo: "fin.conciliacao.aprovar_alta"
    descricao: "Aprovar divergência ALTA"
    roles: ["DIRETOR", "CONTROLLER"]

  - codigo: "fin.conciliacao.aprovar_critica"
    descricao: "Aprovar divergência CRÍTICA"
    roles: ["DIRETOR"]

  - codigo: "fin.bloqueio.desbloquear"
    descricao: "Desbloquear fatura para pagamento"
    roles: ["DIRETOR", "CONTROLLER"]

  - codigo: "fin.relatorio.exportar"
    descricao: "Exportar relatórios fiscais"
    roles: ["CONSULTOR", "SUPERVISOR", "GERENTE", "DIRETOR", "CONTROLLER", "AUDITOR"]

  - codigo: "fin.auditoria.visualizar"
    descricao: "Visualizar trilha de auditoria"
    roles: ["AUDITOR", "DIRETOR"]

integracoes:
  internas:
    - "Autenticação JWT"
    - "Multi-Tenancy (ClienteId)"
    - "Auditoria (Event Sourcing)"
    - "RBAC (Permissões)"
    - "SignalR (Notificações)"
    - "Hangfire (Processamento batch)"
  externas:
    - sistema: "Azure Machine Learning"
      tipo: "API"
      obrigatoria: true
      descricao: "Modelo de detecção de anomalias"
    - sistema: "SPED Fiscal (Receita Federal)"
      tipo: "Exportação"
      obrigatoria: false
      descricao: "Geração de arquivos E-100, E-200, E-310"
    - sistema: "RF-032 (Gestão de NF-e)"
      tipo: "Integração interna"
      obrigatoria: true
      descricao: "Fonte de dados de NF-e importadas"
    - sistema: "RF-023 (Gestão de Contratos)"
      tipo: "Integração interna"
      obrigatoria: true
      descricao: "Validação de termos contratuais"

seguranca:
  isolamento_tenant: true
  auditoria_obrigatoria: true
  soft_delete: true
  validacoes:
    - "SQL Injection (Entity Framework + Parametrização)"
    - "XSS (Sanitização de inputs)"
    - "CSRF Protection"
    - "CHAVE_NFE (44 dígitos, dígito verificador)"
    - "Hash SHA-512 para integridade de auditoria"
  protecao_dados:
    - "Criptografia em repouso (CNPJ, valores, dados bancários)"
    - "Criptografia em trânsito (HTTPS)"
    - "LGPD: direito ao esquecimento, retenção 7 anos"

rastreabilidade:
  ucs_esperados:
    - "UC00-listar-faturas"
    - "UC01-criar-fatura"
    - "UC02-visualizar-fatura"
    - "UC03-editar-fatura"
    - "UC04-excluir-fatura"
    - "UC05-conciliar-fatura"
    - "UC06-aprovar-divergencia"
    - "UC07-conciliar-bancariamente"
    - "UC08-exportar-relatorios"
  dependencias_upstream:
    - rf: "RF-032"
      descricao: "Gestão de Notas Fiscais"
      tipo: "OBRIGATÓRIO"
    - rf: "RF-023"
      descricao: "Gestão de Contratos"
      tipo: "OBRIGATÓRIO"
  dependencias_downstream:
    - rf: "RF-XXX"
      descricao: "Contas a Pagar"
      tipo: "OPCIONAL"

catalog:
  crud:
    - id: "RF-CRUD-01"
      title: "Listar faturas com paginação"
      required: true
    - id: "RF-CRUD-02"
      title: "Criar/importar NF-e"
      required: true
    - id: "RF-CRUD-03"
      title: "Visualizar detalhes de fatura"
      required: true
    - id: "RF-CRUD-04"
      title: "Atualizar dados de fatura"
      required: true
    - id: "RF-CRUD-05"
      title: "Excluir fatura (rascunhos)"
      required: false

  validacoes:
    - id: "RF-VAL-01"
      title: "Validar CHAVE_NFE (44 dígitos)"
      required: true
    - id: "RF-VAL-02"
      title: "Validar matching two-way"
      required: true
    - id: "RF-VAL-03"
      title: "Validar matching three-way"
      required: true
    - id: "RF-VAL-04"
      title: "Validar termos contratuais"
      required: true
    - id: "RF-VAL-05"
      title: "Validar score de anomalia ML"
      required: true

  seguranca:
    - id: "RF-SEC-01"
      title: "Isolamento multi-tenant"
      required: true
    - id: "RF-SEC-02"
      title: "Permissões RBAC multi-nível"
      required: true
    - id: "RF-SEC-03"
      title: "Bloqueio automático de pagamentos"
      required: true
    - id: "RF-SEC-04"
      title: "Auditoria com hash SHA-512"
      required: true

exclusions:
  rf_items:
    - item: "Importação de NF-e XML"
      motivo: "Responsabilidade do RF-032"
    - item: "Gestão de Pedidos de Compra"
      motivo: "Responsabilidade de RF dedicado"
    - item: "Layout e UX específicos"
      motivo: "Decisão de design system"

kpis:
  - nome: "Taxa de Conciliação Automática"
    descricao: "Percentual de faturas conciliadas automaticamente"
    meta: ">= 85%"
    log_obrigatorio: true

  - nome: "Tempo Médio de Conciliação"
    descricao: "Tempo desde recebimento da NF-e até conciliação completa"
    meta: "< 2 horas"
    log_obrigatorio: true

  - nome: "Taxa de Divergências Críticas"
    descricao: "Percentual de divergências classificadas como CRÍTICAS"
    meta: "< 2%"
    log_obrigatorio: true

  - nome: "Cumprimento de SLA (CRÍTICA)"
    descricao: "Percentual de divergências críticas aprovadas dentro de 4h"
    meta: ">= 95%"
    log_obrigatorio: true

  - nome: "Acurácia do Modelo ML"
    descricao: "Acurácia do modelo de detecção de anomalias"
    meta: ">= 92%"
    log_obrigatorio: true

alertas:
  - evento: "SLA Divergência Crítica ultrapassado"
    threshold: "> 4 horas"
    severidade: "CRÍTICA"
    canal_notificacao:
      - "email"
      - "signalr"
      - "sms"

  - evento: "Fatura bloqueada > 15 dias"
    threshold: "> 15 dias bloqueada"
    severidade: "ALTA"
    canal_notificacao:
      - "email"
      - "signalr"

  - evento: "Taxa de anomalia alta"
    threshold: "Score médio > 0.65"
    severidade: "MÉDIA"
    canal_notificacao:
      - "email"

  - evento: "Tentativa de bypass de bloqueio"
    threshold: "> 1 tentativa"
    severidade: "CRÍTICA"
    canal_notificacao:
      - "email"
      - "sms"
      - "security_log"

historico:
  - versao: "2.0"
    data: "2025-12-31"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Migração v1.0 → v2.0 (separação RF/RL, remoção de referências ao legado)"

  - versao: "1.0"
    data: "2025-12-28"
    autor: "Sistema"
    descricao: "Versão inicial com referências ao legado"
