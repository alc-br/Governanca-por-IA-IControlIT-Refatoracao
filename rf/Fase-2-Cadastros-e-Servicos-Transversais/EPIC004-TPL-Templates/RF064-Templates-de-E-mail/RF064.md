# RF064 - Templates de E-mail

## 1. RESUMO EXECUTIVO

### 1.1 Vis√£o Geral
Biblioteca de templates pr√©-configurados para e-mails transacionais (confirma√ß√µes, notifica√ß√µes, alertas, newsletters) com design responsivo, personaliza√ß√£o por empresa, rastreamento de m√©tricas de engajamento e testes de renderiza√ß√£o em m√∫ltiplos clientes de e-mail.

### 1.2 Import√¢ncia Estrat√©gica
- **Consist√™ncia Visual:** Padroniza√ß√£o de comunica√ß√£o institucional
- **Deliverability:** Garantia de entrega em Gmail, Outlook, Apple Mail, Yahoo
- **Personaliza√ß√£o:** Branding customizado por empresa (logo, cores, rodap√©)
- **M√©tricas:** Rastreamento de abertura, cliques e convers√£o
- **Conformidade:** Unsubscribe obrigat√≥rio (LGPD/CAN-SPAM)
- **Produtividade:** Biblioteca de 20+ templates prontos para uso
- **Qualidade:** Preview multi-dispositivo e anti-spam score

### 1.3 Funcionalidades Principais

1. **Design Responsivo**
   - Templates adaptam-se a desktop, tablet e mobile
   - Renderiza√ß√£o otimizada para telas pequenas
   - Media queries CSS para breakpoints espec√≠ficos

2. **Compatibilidade Multi-Cliente**
   - Testes automatizados em Gmail, Outlook, Apple Mail, Yahoo
   - Screenshots de renderiza√ß√£o por cliente
   - Valida√ß√£o de HTML/CSS compat√≠vel

3. **Rastreamento de Engajamento**
   - Pixel invis√≠vel para rastrear abertura
   - URLs de rastreamento para cliques
   - M√©tricas consolidadas por template e campanha

4. **Personaliza√ß√£o por Empresa**
   - Logo customiz√°vel
   - Cores prim√°ria e secund√°ria por empresa
   - Rodap√© com informa√ß√µes institucionais
   - Assinatura de e-mail configur√°vel

5. **Teste A/B Autom√°tico**
   - Envio de varia√ß√µes para 10% da base (teste)
   - An√°lise de performance (abertura, cliques)
   - Envio da varia√ß√£o vencedora para 90% restantes

6. **Biblioteca de Templates Padr√£o**
   - 20+ templates pr√©-configurados (boas-vindas, confirma√ß√£o, alerta, newsletter)
   - Categoriza√ß√£o por tipo (transacional, marketing, notifica√ß√£o)
   - Versionamento de templates

7. **Preview Multi-Dispositivo**
   - Visualiza√ß√£o simult√¢nea desktop, tablet, mobile
   - Simula√ß√£o de renderiza√ß√£o em clientes espec√≠ficos
   - Modo escuro vs claro

8. **M√©tricas de Performance**
   - Taxa de abertura por template
   - Taxa de cliques (CTR)
   - Taxa de convers√£o
   - Relat√≥rios comparativos

---

## 2. REGRAS DE NEG√ìCIO

### RN-RF064-001: Design Responsivo Obrigat√≥rio

**Descri√ß√£o:** Todos os templates devem renderizar corretamente em dispositivos desktop (largura >= 600px) e mobile (largura < 600px). Layout de tabela HTML com largura fixa em desktop (600px) e largura 100% em mobile usando media queries CSS.

**Valida√ß√£o:** Sistema deve testar renderiza√ß√£o em ambos os tamanhos de tela antes de aprovar template.

---

### RN-RF064-002: Compatibilidade com Principais Clientes de E-mail

**Descri√ß√£o:** Templates devem ser testados e validados em 4 clientes principais: Gmail (web + app), Outlook (desktop + web), Apple Mail (macOS + iOS) e Yahoo Mail. Sistema deve capturar screenshot de renderiza√ß√£o em cada cliente e permitir valida√ß√£o visual.

**Valida√ß√£o:** Template s√≥ pode ser marcado como "Aprovado" ap√≥s valida√ß√£o bem-sucedida em todos os 4 clientes.

---

### RN-RF064-003: Rastreamento de Abertura via Pixel Invis√≠vel

**Descri√ß√£o:** Sistema deve inserir automaticamente um pixel invis√≠vel (imagem 1x1 transparente) no HTML do e-mail. Quando destinat√°rio abre o e-mail, navegador carrega a imagem de URL √∫nica contendo ID do envio, registrando abertura no backend.

**URL do pixel:** `https://api.icontrolit.com/track/open/{id_envio}`

**Privacidade:** Informar destinat√°rio que e-mail cont√©m rastreamento de abertura (rodap√© obrigat√≥rio).

---

### RN-RF064-004: Rastreamento de Cliques via URL Wrapping

**Descri√ß√£o:** Todos os links (<a href>) no HTML do template devem ser substitu√≠dos por URLs de rastreamento que redirecionam para URL original ap√≥s registrar clique no backend.

**URL de rastreamento:** `https://api.icontrolit.com/track/click/{id_envio}?url={url_original_encoded}`

**Valida√ß√£o:** Sistema deve preservar par√¢metros da URL original (query string) ap√≥s redirecionamento.

---

### RN-RF064-005: Personaliza√ß√£o de Branding por Empresa

**Descri√ß√£o:** Cada empresa (multi-tenancy) deve poder configurar: cor prim√°ria (hexadecimal), cor secund√°ria (hexadecimal), URL do logo (hospedado externamente ou em CDN), texto do rodap√© (endere√ßo, telefone, CNPJ) e assinatura padr√£o de remetente.

**Aplica√ß√£o:** Sistema deve aplicar branding automaticamente ao renderizar template para envio, substituindo placeholders `{{cor_primaria}}`, `{{cor_secundaria}}`, `{{url_logo}}`, `{{rodape}}`.

**Heran√ßa:** Se empresa n√£o configurar branding, usar configura√ß√µes padr√£o do sistema.

---

### RN-RF064-006: Teste A/B Autom√°tico com Varia√ß√µes

**Descri√ß√£o:** Permitir criar at√© 3 varia√ß√µes de um template (ex: assuntos diferentes, layouts diferentes, CTAs diferentes). Sistema envia cada varia√ß√£o para 10% da base de destinat√°rios (total 30% para teste). Ap√≥s 24 horas, analisa m√©tricas (taxa abertura + taxa cliques) e envia varia√ß√£o vencedora para 70% restantes.

**Valida√ß√£o:** Teste A/B s√≥ inicia se lista de destinat√°rios tiver no m√≠nimo 100 e-mails (amostra m√≠nima estat√≠stica).

**Empate:** Se diferen√ßa entre varia√ß√µes for < 5%, enviar varia√ß√£o original (controle) para 70% restantes.

---

### RN-RF064-007: Link de Unsubscribe Obrigat√≥rio (LGPD/CAN-SPAM)

**Descri√ß√£o:** Todos os templates de e-mail marketing devem incluir link de descadastramento no rodap√©. Link deve ser claramente vis√≠vel (fonte >= 12px, cor contrastante) e redirecionar para p√°gina de confirma√ß√£o de descadastramento.

**URL de unsubscribe:** `https://app.icontrolit.com/unsubscribe/{id_envio}`

**Exce√ß√µes:** E-mails transacionais (confirma√ß√£o de compra, redefini√ß√£o de senha) s√£o isentos desta regra.

**Processamento:** Descadastramento deve ser processado em at√© 10 dias √∫teis (requisito CAN-SPAM).

---

### RN-RF064-008: Configura√ß√£o de Pre-Header Text

**Descri√ß√£o:** Pre-header √© o texto exibido ap√≥s o assunto na caixa de entrada (preview do e-mail). Deve ser configur√°vel por template, com limite de 150 caracteres. Pre-header deve ser diferente do primeiro par√°grafo do body para otimizar preview.

**Implementa√ß√£o:** Inserir div invis√≠vel com pre-header text ap√≥s tag body no HTML.

---

### RN-RF064-009: Convers√£o de CSS para Inline

**Descri√ß√£o:** Outlook (especialmente vers√µes desktop) n√£o suporta CSS em tag style ou arquivo externo. Sistema deve converter automaticamente todo CSS para atributos inline (style="") em cada tag HTML antes de enviar.

**Ferramenta:** Usar biblioteca de inlining CSS (ex: PreMailer, Juice) para automatizar convers√£o.

**Valida√ß√£o:** Ap√≥s inlining, remover tags style e verificar que todos os estilos cr√≠ticos foram aplicados inline.

---

### RN-RF064-010: C√°lculo de Anti-Spam Score

**Descri√ß√£o:** Antes de enviar e-mail, sistema deve calcular score de spam usando ferramenta externa (ex: SpamAssassin, Mail Tester). Se score for > 5.0, bloquear envio e exibir alertas com sugest√µes de corre√ß√£o (ex: remover palavras suspeitas, incluir texto alternativo para imagens, balancear texto/imagem).

**Threshold:** Score <= 3.0 = √ìtimo, 3.1-5.0 = Aceit√°vel, > 5.0 = Bloqueado.

**Avisos:** Exibir warnings espec√≠ficos (ex: "Assunto cont√©m palavra 'Gr√°tis' - aumenta score em 0.5 pontos").

---

### RN-RF064-011: Biblioteca de Templates Padr√£o

**Descri√ß√£o:** Sistema deve fornecer biblioteca de 20+ templates pr√©-configurados categorizados por tipo: Transacional (confirma√ß√£o de compra, redefini√ß√£o de senha, notifica√ß√£o de entrega), Marketing (newsletter, promo√ß√£o, lan√ßamento de produto), Notifica√ß√£o (alerta de sistema, lembrete, aviso de vencimento).

**Customiza√ß√£o:** Usu√°rio pode clonar template padr√£o e customizar conte√∫do/branding sem alterar original.

**Atualiza√ß√£o:** Templates padr√£o s√£o atualizados pelo sistema (versionamento) sem afetar templates customizados pelos usu√°rios.

---

### RN-RF064-012: Versionamento de Templates

**Descri√ß√£o:** Toda altera√ß√£o em template deve criar nova vers√£o (incremento autom√°tico: v1.0 ‚Üí v1.1 ‚Üí v2.0). Sistema mant√©m hist√≥rico completo de vers√µes com data/hora, usu√°rio respons√°vel e changelog. Envios sempre referenciam vers√£o espec√≠fica usada (rastreabilidade).

**Rollback:** Permitir ativar vers√£o anterior se necess√°rio.

**Vers√£o ativa:** Apenas uma vers√£o pode estar ativa por vez. Ao ativar nova vers√£o, vers√£o anterior √© arquivada.

---

### RN-RF064-013: Preview Multi-Dispositivo em Tempo Real

**Descri√ß√£o:** Ao editar template, sistema deve exibir previews simult√¢neos em 3 viewports: Desktop (600px), Tablet (480px), Mobile (320px). Mudan√ßas no HTML/CSS devem atualizar previews em tempo real (sem recarregar p√°gina).

**Modos:** Suportar modo claro e modo escuro (simula√ß√£o de prefer√™ncia de sistema operacional).

---

### RN-RF064-014: M√©tricas de Engajamento por Template

**Descri√ß√£o:** Sistema deve consolidar m√©tricas de todos os envios de um template: total de envios, taxa de abertura (%), taxa de cliques (%), taxa de convers√£o (%), taxa de bounce (%), taxa de spam complaints (%). M√©tricas devem ser calculadas em tempo real e exibidas em dashboard.

**Compara√ß√£o:** Permitir comparar m√©tricas de 2 ou mais templates lado a lado.

**Filtros:** Filtrar m√©tricas por per√≠odo (√∫ltimos 7 dias, 30 dias, 90 dias, custom).

---

### RN-RF064-015: Agendamento de Envios

**Descri√ß√£o:** Permitir agendar envio de e-mail para data/hora futura espec√≠fica (timezone do usu√°rio). Envios agendados devem ser enfileirados e processados por job scheduler (Hangfire) no hor√°rio especificado.

**Cancelamento:** Permitir cancelar envio agendado at√© 5 minutos antes do hor√°rio programado.

**Valida√ß√£o:** N√£o permitir agendar para data/hora no passado ou mais de 1 ano no futuro.

---

## 3. REQUISITOS N√ÉO FUNCIONAIS

### 3.1 Performance
- Renderiza√ß√£o de template (HTML + CSS inline) em menos de 300ms
- Envio de e-mail individual em menos de 500ms
- Processamento de lote (1.000 e-mails) em menos de 5 minutos

### 3.2 Escalabilidade
- Suportar 100.000 envios de e-mail por hora
- Fila de envio com processamento paralelo (m√∫ltiplos workers)
- Auto-scaling de workers conforme demanda

### 3.3 Deliverability
- Taxa de entrega superior a 98%
- SPF, DKIM e DMARC configurados corretamente
- Monitoramento de IP reputation (evitar blacklisting)
- Warm-up de IP para novos dom√≠nios

### 3.4 Seguran√ßa
- Sanitiza√ß√£o de HTML para prevenir XSS
- Rate limiting de envios por usu√°rio (anti-spam interno)
- Valida√ß√£o de destinat√°rios (prevenir typosquatting)
- Logs de auditoria de todos os envios

### 3.5 Disponibilidade
- SLA de 99.9% de uptime
- Fallback para provider secund√°rio em caso de falha
- Monitoramento de health check de providers (SMTP)

---

## 4. INTEGRA√á√ïES OBRIGAT√ìRIAS

### 4.1 Central de Funcionalidades

Registro obrigat√≥rio na Central de Funcionalidades:

**C√≥digo:** `TPL.EMAIL`
**Nome:** Templates de E-mail
**M√≥dulo:** Templates
**Descri√ß√£o:** Biblioteca de templates de e-mail com design responsivo, rastreamento e personaliza√ß√£o

### 4.2 RBAC (Permiss√µes)

Matriz de permiss√µes obrigat√≥rias:

| Permission Code | Descri√ß√£o | Roles Autorizadas |
|-----------------|-----------|-------------------|
| `TPL.EMAIL.VIEW_ANY` | Listar templates de e-mail | Admin, Marketing, Suporte |
| `TPL.EMAIL.VIEW` | Visualizar detalhes de template | Admin, Marketing, Suporte |
| `TPL.EMAIL.CREATE` | Criar novo template | Admin, Marketing |
| `TPL.EMAIL.EDIT` | Editar template existente | Admin, Marketing |
| `TPL.EMAIL.DELETE` | Excluir template | Admin |
| `TPL.EMAIL.SEND` | Enviar e-mail usando template | Admin, Marketing, Suporte |
| `TPL.EMAIL.SEND_TEST` | Enviar e-mail de teste | Admin, Marketing |
| `TPL.EMAIL.VIEW_METRICS` | Visualizar m√©tricas de engajamento | Admin, Marketing |
| `TPL.EMAIL.MANAGE_BRANDING` | Gerenciar branding por empresa | Admin |

### 4.3 i18n (Internacionaliza√ß√£o)

Chaves de tradu√ß√£o obrigat√≥rias (Transloco):

- `templates.email.title` - "Templates de E-mail"
- `templates.email.create` - "Criar Template"
- `templates.email.send` - "Enviar E-mail"
- `templates.email.preview` - "Visualizar Preview"
- `templates.email.metrics.openRate` - "Taxa de Abertura"
- `templates.email.metrics.clickRate` - "Taxa de Cliques"
- `templates.email.branding.primaryColor` - "Cor Prim√°ria"
- `templates.email.branding.logo` - "Logo"
- `templates.email.unsubscribe` - "Descadastrar"

Idiomas suportados: pt-BR (padr√£o), en, es

### 4.4 Auditoria

Campos de auditoria obrigat√≥rios em todas as tabelas:

- `Created` (DateTime) - Data/hora de cria√ß√£o
- `CreatedBy` (Guid) - Usu√°rio que criou
- `LastModified` (DateTime) - Data/hora √∫ltima modifica√ß√£o
- `LastModifiedBy` (Guid) - Usu√°rio que modificou

Eventos auditados:
- Cria√ß√£o de template
- Edi√ß√£o de template
- Exclus√£o de template
- Envio de e-mail
- Abertura de e-mail (rastreamento)
- Clique em link (rastreamento)
- Unsubscribe

---

## 5. MODELO DE DADOS

### 5.1 Principais Entidades

#### TemplateEmail

Entidade principal que representa um template de e-mail.

**Campos principais:**
- `Id` (Guid) - PK
- `EmpresaId` (Guid) - FK Multi-tenancy
- `Nome` (string) - Nome do template (ex: "Boas-vindas")
- `Categoria` (enum) - Transacional, Marketing, Notifica√ß√£o
- `Assunto` (string) - Linha de assunto padr√£o
- `PreHeader` (string, max 150) - Texto de preview
- `CorpoHtml` (string) - HTML do template (com placeholders)
- `CorpoTexto` (string) - Vers√£o texto puro (fallback)
- `RemetenteNome` (string) - Nome do remetente
- `RemetenteEmail` (string) - E-mail do remetente
- `VersaoAtiva` (int) - Vers√£o atualmente ativa
- `Status` (enum) - Rascunho, Ativo, Arquivado
- `Auditoria` (campos inherited de AuditableEntity)

#### BrandingEmail

Configura√ß√µes de branding por empresa.

**Campos principais:**
- `Id` (Guid) - PK
- `EmpresaId` (Guid) - FK Multi-tenancy (unique)
- `CorPrimaria` (string) - Hexadecimal (#RRGGBB)
- `CorSecundaria` (string) - Hexadecimal
- `URLLogo` (string) - URL do logo (https://)
- `TextoRodape` (string) - Rodap√© institucional
- `AssinaturaRemetente` (string) - Assinatura padr√£o

#### EnvioEmail

Registro de cada envio de e-mail realizado.

**Campos principais:**
- `Id` (Guid) - PK
- `TemplateId` (Guid) - FK para TemplateEmail
- `VersaoTemplate` (int) - Vers√£o do template usada
- `DestinatarioNome` (string)
- `DestinatarioEmail` (string)
- `DataEnvio` (DateTime)
- `DataAgendamento` (DateTime?) - Null se envio imediato
- `Aberto` (bool) - Rastreamento de abertura
- `DataAbertura` (DateTime?) - Timestamp da primeira abertura
- `TotalCliques` (int) - Contador de cliques
- `Status` (enum) - Agendado, Enviando, Enviado, Falha, Cancelado

#### MetricasTemplate

Consolida√ß√£o de m√©tricas por template (materializada).

**Campos principais:**
- `TemplateId` (Guid) - FK (unique)
- `TotalEnvios` (int)
- `TotalAberturas` (int)
- `TotalCliques` (int)
- `TotalConversoes` (int)
- `TaxaAbertura` (decimal, computed) - (TotalAberturas / TotalEnvios) * 100
- `TaxaCliques` (decimal, computed) - (TotalCliques / TotalEnvios) * 100
- `TaxaConversao` (decimal, computed) - (TotalConversoes / TotalEnvios) * 100
- `UltimaAtualizacao` (DateTime) - Timestamp do √∫ltimo c√°lculo

### 5.2 Relacionamentos

- `TemplateEmail` 1:N `EnvioEmail` - Um template pode ter m√∫ltiplos envios
- `TemplateEmail` 1:1 `MetricasTemplate` - Um template tem uma consolida√ß√£o de m√©tricas
- `Empresa` 1:1 `BrandingEmail` - Uma empresa tem uma configura√ß√£o de branding
- `TemplateEmail` N:1 `Empresa` - Multi-tenancy (isolamento por empresa)

### 5.3 Refer√™ncia ao MD

Diagrama ER completo, DDL e seed de dados est√£o documentados em:
üìÑ **[MD-RF064.md](./MD-RF064.md)**

---

## 6. API ENDPOINTS

### 6.1 CRUD de Templates

| M√©todo | Rota | Descri√ß√£o | Autentica√ß√£o | Permiss√£o |
|--------|------|-----------|--------------|-----------|
| GET | `/api/templates-email` | Listar templates (paginado) | Bearer Token | `TPL.EMAIL.VIEW_ANY` |
| GET | `/api/templates-email/{id}` | Visualizar template | Bearer Token | `TPL.EMAIL.VIEW` |
| POST | `/api/templates-email` | Criar novo template | Bearer Token | `TPL.EMAIL.CREATE` |
| PUT | `/api/templates-email/{id}` | Atualizar template | Bearer Token | `TPL.EMAIL.EDIT` |
| DELETE | `/api/templates-email/{id}` | Excluir template | Bearer Token | `TPL.EMAIL.DELETE` |

### 6.2 Envio de E-mails

| M√©todo | Rota | Descri√ß√£o | Autentica√ß√£o | Permiss√£o |
|--------|------|-----------|--------------|-----------|
| POST | `/api/templates-email/{id}/enviar` | Enviar e-mail usando template | Bearer Token | `TPL.EMAIL.SEND` |
| POST | `/api/templates-email/{id}/enviar-teste` | Enviar e-mail de teste | Bearer Token | `TPL.EMAIL.SEND_TEST` |
| POST | `/api/templates-email/{id}/agendar` | Agendar envio de e-mail | Bearer Token | `TPL.EMAIL.SEND` |

### 6.3 M√©tricas e Rastreamento

| M√©todo | Rota | Descri√ß√£o | Autentica√ß√£o | Permiss√£o |
|--------|------|-----------|--------------|-----------|
| GET | `/api/templates-email/{id}/metricas` | Obter m√©tricas do template | Bearer Token | `TPL.EMAIL.VIEW_METRICS` |
| GET | `/api/track/open/{id_envio}` | Rastrear abertura (pixel) | P√∫blico (GET de imagem) | - |
| GET | `/api/track/click/{id_envio}` | Rastrear clique (redirect) | P√∫blico (GET com redirect) | - |

### 6.4 Branding

| M√©todo | Rota | Descri√ß√£o | Autentica√ß√£o | Permiss√£o |
|--------|------|-----------|--------------|-----------|
| GET | `/api/branding-email` | Obter branding da empresa | Bearer Token | `TPL.EMAIL.VIEW` |
| PUT | `/api/branding-email` | Atualizar branding da empresa | Bearer Token | `TPL.EMAIL.MANAGE_BRANDING` |

---

## 7. DEPEND√äNCIAS

### 7.1 Depend√™ncias Internas

- **RF-001**: Sistema de Par√¢metros e Configura√ß√µes Gerais (configura√ß√£o SMTP, credenciais de provider)
- **RF-SYS-AUTH**: Sistema de Autentica√ß√£o e Autoriza√ß√£o (Bearer Token, RBAC)
- **RF-SYS-I18N**: Sistema de Internacionaliza√ß√£o (chaves de tradu√ß√£o)
- **RF-SYS-AUDIT**: Sistema de Auditoria (registro de eventos)

### 7.2 Depend√™ncias Externas

- **Provider SMTP:** SendGrid, AWS SES, Mailgun (configur√°vel)
- **Servi√ßo de Rendering:** Litmus, Email on Acid (testes de compatibilidade)
- **Servi√ßo de Anti-Spam:** SpamAssassin, Mail Tester (c√°lculo de score)
- **CDN:** Hospedagem de imagens e logos (ex: CloudFlare, AWS S3)

---

## 8. CASOS DE USO RELACIONADOS

Os casos de uso detalhados est√£o documentados em:
üìÑ **[UC-RF064.md](./UC-RF064.md)**

**UCs principais:**
- UC00: Listar Templates de E-mail
- UC01: Criar Template de E-mail
- UC02: Visualizar Template de E-mail
- UC03: Editar Template de E-mail
- UC04: Excluir Template de E-mail
- UC05: Enviar E-mail Usando Template
- UC06: Agendar Envio de E-mail
- UC07: Visualizar M√©tricas de Template
- UC08: Configurar Branding de E-mail
- UC09: Testar Compatibilidade de Template
- UC10: Realizar Teste A/B de Template

---

## 9. WIREFRAMES E FLUXOS

Os wireframes e fluxos de tela est√£o documentados em:
üìÑ **[WF-RF064.md](./WF-RF064.md)**

**Telas principais:**
- Listagem de Templates
- Formul√°rio de Cria√ß√£o/Edi√ß√£o de Template
- Editor Visual de Template (WYSIWYG)
- Preview Multi-Dispositivo
- Dashboard de M√©tricas
- Configura√ß√£o de Branding
- Agendamento de Envio

---

## 10. OBSERVA√á√ïES FINAIS

### 10.1 Evolu√ß√£o Futura

Funcionalidades planejadas para vers√µes futuras (fora do escopo v1.0):
- Editor visual drag-and-drop (WYSIWYG avan√ßado)
- Integra√ß√£o com ferramentas de automa√ß√£o de marketing (HubSpot, Mailchimp)
- Templates din√¢micos com l√≥gica condicional (if/else em Liquid templates)
- Segmenta√ß√£o avan√ßada de destinat√°rios (por comportamento, demographics)
- Integra√ß√£o com Google Analytics (rastreamento de convers√£o)

### 10.2 Riscos Identificados

| Risco | Impacto | Probabilidade | Mitiga√ß√£o |
|-------|---------|---------------|-----------|
| Baixa deliverability (< 98%) | ALTO | M√âDIA | Warm-up de IP, SPF/DKIM/DMARC, monitoramento de reputation |
| Templates marcados como spam | ALTO | M√âDIA | Anti-spam score obrigat√≥rio, biblioteca de boas pr√°ticas |
| Incompatibilidade com Outlook | M√âDIO | ALTA | CSS inline obrigat√≥rio, testes automatizados |
| Sobrecarga de envios | M√âDIO | BAIXA | Rate limiting, fila com workers paralelos |

---

## 9. KPIs E M√âTRICAS

### 9.1 M√©tricas de Performance

| KPI | Meta | Descri√ß√£o | Log Obrigat√≥rio |
|-----|------|-----------|-----------------|
| Taxa de Abertura (Open Rate) | >= 25% | Percentual de e-mails abertos em rela√ß√£o ao total enviado | Sim |
| Taxa de Cliques (CTR) | >= 3% | Percentual de cliques em links em rela√ß√£o ao total enviado | Sim |
| Taxa de Convers√£o | >= 2% | Percentual de a√ß√µes completadas ap√≥s clicar em link | Sim |
| Taxa de Deliverability | >= 98% | Percentual de e-mails entregues com sucesso (n√£o retornados) | Sim |
| Taxa de Unsubscribe | <= 0.5% | Percentual de descadastramentos em rela√ß√£o ao total enviado | Sim |
| Taxa de Spam Complaint | <= 0.1% | Percentual de e-mails marcados como spam pelos usu√°rios | Sim |

### 9.2 M√©tricas de Qualidade de Templates

| KPI | Meta | Descri√ß√£o | Log Obrigat√≥rio |
|-----|------|-----------|-----------------|
| Anti-Spam Score | <= 3.0 | Score calculado via SpamAssassin (0.0 = perfeito, 10.0 = pior) | Sim |
| Compatibilidade Multi-Cliente | 100% | Percentual de renderiza√ß√£o correta em Gmail/Outlook/Apple/Yahoo | Sim |
| Tempo de Renderiza√ß√£o Mobile | <= 2s | Tempo m√©dio para renderizar template em dispositivo m√≥vel | Sim |
| Tempo de Renderiza√ß√£o Desktop | <= 1s | Tempo m√©dio para renderizar template em desktop | Sim |

### 9.3 M√©tricas de Sistema

| KPI | Meta | Descri√ß√£o | Log Obrigat√≥rio |
|-----|------|-----------|-----------------|
| Tempo M√©dio de Envio | <= 5s | Tempo m√©dio entre enfileiramento e envio efetivo (Hangfire) | Sim |
| Taxa de Sucesso de Envio | >= 99.5% | Percentual de e-mails enviados com sucesso (sem erro SMTP) | Sim |
| Tempo de Resposta API (GET) | <= 200ms | Tempo m√©dio de resposta dos endpoints de leitura | Sim |
| Tempo de Resposta API (POST/PUT) | <= 500ms | Tempo m√©dio de resposta dos endpoints de escrita | Sim |
| Taxa de Erro 4xx | <= 1% | Percentual de erros de cliente (valida√ß√£o, autoriza√ß√£o) | Sim |
| Taxa de Erro 5xx | <= 0.1% | Percentual de erros de servidor (exce√ß√µes n√£o tratadas) | Sim |

### 9.4 M√©tricas de Teste A/B

| KPI | Meta | Descri√ß√£o | Log Obrigat√≥rio |
|-----|------|-----------|-----------------|
| Lift de Convers√£o (Winner vs Loser) | >= 10% | Melhoria percentual do template vencedor sobre perdedor | Sim |
| Confian√ßa Estat√≠stica | >= 95% | N√≠vel de confian√ßa estat√≠stica do resultado do teste A/B | Sim |
| Tempo M√©dio de Teste A/B | <= 7 dias | Tempo m√©dio para declarar vencedor (m√≠nimo 100 envios ou 24h) | Sim |

### 9.5 Logs Obrigat√≥rios

Todos os eventos abaixo DEVEM ser logados em tabela de auditoria:

- **Cria√ß√£o de template** - Usu√°rio, timestamp, template criado
- **Edi√ß√£o de template** - Usu√°rio, timestamp, campos alterados
- **Ativa√ß√£o/desativa√ß√£o de template** - Usu√°rio, timestamp, motivo
- **Envio de e-mail** - Template usado, destinat√°rio, hor√°rio, status (enviado/falha)
- **Abertura de e-mail** - Envio relacionado, timestamp, IP, user-agent
- **Clique em link** - Envio relacionado, URL clicada, timestamp, IP, user-agent
- **Falha de envio** - Template, destinat√°rio, mensagem de erro SMTP, timestamp
- **Tentativa de acesso sem permiss√£o** - Usu√°rio, endpoint, timestamp, permiss√£o faltante
- **Altera√ß√£o de branding** - Empresa, campos alterados, usu√°rio, timestamp
- **In√≠cio de teste A/B** - Templates testados, percentual de aloca√ß√£o, usu√°rio
- **Fim de teste A/B** - Template vencedor, m√©tricas finais, confian√ßa estat√≠stica

---

## 10. ALERTAS CR√çTICOS

### 10.1 Alertas de Deliverability

| Evento | Threshold | Severidade | Canal de Notifica√ß√£o |
|--------|-----------|------------|----------------------|
| Taxa de deliverability abaixo do normal | < 95% em 1 hora | ALTA | Email, Slack |
| Taxa de spam complaint alta | > 0.2% em 1 hora | CR√çTICA | Email, Slack, SMS |
| Blacklist de IP detectada | IP em qualquer blacklist p√∫blica | CR√çTICA | Email, Slack, SMS |
| Falha de autentica√ß√£o SPF/DKIM/DMARC | Falha detectada na valida√ß√£o | ALTA | Email, Slack |
| Taxa de bounce alta (hard bounce) | > 5% em 1 hora | ALTA | Email, Slack |

### 10.2 Alertas de Performance

| Evento | Threshold | Severidade | Canal de Notifica√ß√£o |
|--------|-----------|------------|----------------------|
| Tempo de envio alto | > 10s por e-mail (m√©dia 1 hora) | M√âDIA | Email |
| Fila de envio congestionada | > 1000 e-mails pendentes por 30 min | ALTA | Email, Slack |
| Taxa de erro 5xx alta | > 1% em 15 minutos | CR√çTICA | Email, Slack, SMS |
| Tempo de resposta API alto | > 1s (m√©dia 5 minutos) | ALTA | Email, Slack |
| Worker Hangfire parado | Nenhum job processado em 5 min | CR√çTICA | Email, Slack, SMS |

### 10.3 Alertas de Seguran√ßa

| Evento | Threshold | Severidade | Canal de Notifica√ß√£o |
|--------|-----------|------------|----------------------|
| Tentativas de acesso n√£o autorizado | > 10 em 5 minutos (mesmo usu√°rio) | ALTA | Email, Slack |
| Tentativa de SQL Injection detectada | Qualquer tentativa | CR√çTICA | Email, Slack, SMS |
| Tentativa de XSS detectada | Qualquer tentativa | CR√çTICA | Email, Slack, SMS |
| Rate limit excedido | > 150 envios/hora por empresa | M√âDIA | Email |
| Cria√ß√£o massiva de templates | > 50 templates em 1 hora (mesma empresa) | M√âDIA | Email |

### 10.4 Alertas de Qualidade

| Evento | Threshold | Severidade | Canal de Notifica√ß√£o |
|--------|-----------|------------|----------------------|
| Template com anti-spam score alto ativado | Score > 5.0 | ALTA | Email, Slack |
| Incompatibilidade de renderiza√ß√£o detectada | Falha em qualquer cliente (Gmail/Outlook/Apple/Yahoo) | M√âDIA | Email |
| Template sem link de unsubscribe ativado | Viola√ß√£o de LGPD/CAN-SPAM | CR√çTICA | Email, Slack, SMS |
| Taxa de unsubscribe alta | > 1% em 1 dia (mesmo template) | ALTA | Email, Slack |

### 10.5 Configura√ß√£o de Canais de Notifica√ß√£o

- **Email:** Enviado para equipe de DevOps e respons√°vel da empresa (se aplic√°vel)
- **Slack:** Canal `#icontrolit-alerts` com ping para `@devops`
- **SMS:** Apenas para alertas CR√çTICOS, enviado para telefones cadastrados em configura√ß√£o de alerta

---

## 11. CENTRAL DE FUNCIONALIDADES

### 11.1 Registro na Central

| Campo | Valor |
|-------|-------|
| **C√≥digo da Funcionalidade** | `TPL.EMAIL` |
| **M√≥dulo** | Templates |
| **Subm√≥dulo** | Gest√£o de E-mail |
| **Ordem de Exibi√ß√£o** | 400 |
| **√çcone** | `heroicons_outline:envelope` |
| **Ativo por Padr√£o** | Sim |
| **Requer Configura√ß√£o Inicial** | Sim (SMTP obrigat√≥rio) |

### 11.2 Internacionaliza√ß√£o (i18n)

**Chaves obrigat√≥rias de tradu√ß√£o (Transloco):**

```typescript
// pt-BR (Portugu√™s do Brasil)
{
  "templates.email.menu.title": "Templates de E-mail",
  "templates.email.menu.subtitle": "Gerencie templates responsivos e personaliz√°veis",
  "templates.email.list.title": "Biblioteca de Templates",
  "templates.email.create.title": "Criar Novo Template",
  "templates.email.edit.title": "Editar Template",
  "templates.email.send.title": "Enviar E-mail",
  "templates.email.metrics.title": "M√©tricas de Engajamento",
  "templates.email.branding.title": "Configurar Branding",
  "templates.email.ab-test.title": "Teste A/B de Templates",
  "templates.email.smtp.title": "Configura√ß√£o SMTP"
}

// en (English)
{
  "templates.email.menu.title": "Email Templates",
  "templates.email.menu.subtitle": "Manage responsive and customizable templates",
  "templates.email.list.title": "Template Library",
  "templates.email.create.title": "Create New Template",
  "templates.email.edit.title": "Edit Template",
  "templates.email.send.title": "Send Email",
  "templates.email.metrics.title": "Engagement Metrics",
  "templates.email.branding.title": "Configure Branding",
  "templates.email.ab-test.title": "A/B Test Templates",
  "templates.email.smtp.title": "SMTP Configuration"
}

// es (Espa√±ol)
{
  "templates.email.menu.title": "Plantillas de Correo",
  "templates.email.menu.subtitle": "Administre plantillas responsivas y personalizables",
  "templates.email.list.title": "Biblioteca de Plantillas",
  "templates.email.create.title": "Crear Nueva Plantilla",
  "templates.email.edit.title": "Editar Plantilla",
  "templates.email.send.title": "Enviar Correo",
  "templates.email.metrics.title": "M√©tricas de Engagement",
  "templates.email.branding.title": "Configurar Branding",
  "templates.email.ab-test.title": "Prueba A/B de Plantillas",
  "templates.email.smtp.title": "Configuraci√≥n SMTP"
}
```

### 11.3 Rotas Frontend

| Rota | Componente | T√≠tulo (i18n) |
|------|-----------|---------------|
| `/templates/email` | TemplatesEmailListComponent | templates.email.list.title |
| `/templates/email/create` | TemplateEmailCreateComponent | templates.email.create.title |
| `/templates/email/:id/edit` | TemplateEmailEditComponent | templates.email.edit.title |
| `/templates/email/:id/send` | TemplateEmailSendComponent | templates.email.send.title |
| `/templates/email/metrics` | TemplateEmailMetricsComponent | templates.email.metrics.title |
| `/templates/email/branding` | EmailBrandingComponent | templates.email.branding.title |
| `/templates/email/ab-test` | TemplateEmailABTestComponent | templates.email.ab-test.title |
| `/templates/email/smtp-config` | SMTPConfigComponent | templates.email.smtp.title |

### 11.4 Seed Obrigat√≥rio

**Script de seed para popular funcionalidade na Central:**

```csharp
// D:\IC2\backend\IControlIT.API/src/Infrastructure/Data/Seeds/CentralFuncionalidadesSeed.cs
modelBuilder.Entity<Funcionalidade>().HasData(new Funcionalidade
{
    Id = Guid.Parse("064-TEMPLATES-EMAIL-GUID"),
    Codigo = "TPL.EMAIL",
    Nome = "Templates de E-mail",
    Descricao = "Gest√£o de templates de e-mail responsivos com rastreamento e personaliza√ß√£o",
    Modulo = "Templates",
    Submodulo = "Gest√£o de E-mail",
    Icone = "heroicons_outline:envelope",
    Rota = "/templates/email",
    Ordem = 400,
    Ativo = true,
    RequerConfiguracaoInicial = true,
    Created = DateTime.UtcNow,
    CreatedBy = "system"
});
```

**Configura√ß√£o inicial obrigat√≥ria:**
- Ao ativar funcionalidade pela primeira vez, sistema DEVE redirecionar para tela de configura√ß√£o SMTP
- Valida√ß√£o de SPF/DKIM/DMARC deve ser executada antes de permitir envio de e-mails
- Biblioteca de 20+ templates padr√£o deve ser automaticamente criada no primeiro acesso

---

**Documento gerado em:** 2025-01-14
**Vers√£o:** 2.0 (Governan√ßa v2.0 - Separa√ß√£o RF/RL)
**Status:** Aprovado
**Pr√≥xima Revis√£o:** 2025-04-14
