# Casos de Uso - RF064

**VersÃ£o:** 1.0
**Data:** 2025-12-17
**RF Relacionado:** [RF064 - Templates-de-E-mail](./RF064.md)

---

## Ãndice de Casos de Uso

| UC | Nome | DescriÃ§Ã£o |
|----|------|-----------|
| UC00 | UC00 - Listar Perfis de Acesso | Caso de uso |
| UC01 | UC01 - Criar Template de E-mail | Caso de uso |
| UC02 | UC02 - Visualizar Template de E-mail | Caso de uso |
| UC03 | UC03 - Editar Template de E-mail | Caso de uso |
| UC04 | UC04 - Inativar Template de E-mail | Caso de uso |
| UC05 | UC05 - Atribuir PermissÃµes ao Perfil | Caso de uso |

---

# UC00 - Listar Perfis de Acesso

**Requisito Funcional:** RF-CAD-006 - GestÃ£o de Perfis de Acesso
**Ator Principal:** Administrador, Super Administrador
**Objetivo:** Visualizar lista de perfis (roles) do sistema com suas permissÃµes e hierarquia
**PrÃ©-condiÃ§Ãµes:**
- UsuÃ¡rio autenticado no sistema
- UsuÃ¡rio possui permissÃ£o `roles:role:read`

---

## 1. Fluxo Principal

1. UsuÃ¡rio acessa o menu "GestÃ£o de Perfis de Acesso"
2. Sistema carrega e exibe lista de perfis
3. Sistema exibe para cada perfil:
   - Nome do perfil
   - DescriÃ§Ã£o
   - NÃ­vel de hierarquia (0-10)
   - Indicador se Ã© perfil de sistema
   - Status (Ativo/Inativo)
   - Empresa vinculada (se nÃ£o for perfil de sistema)
   - Quantidade de permissÃµes associadas
   - Quantidade de usuÃ¡rios com este perfil
4. Sistema permite as seguintes aÃ§Ãµes:
   - Criar novo perfil (redireciona para UC01)
   - Visualizar detalhes (redireciona para UC02)
   - Editar perfil (redireciona para UC03)
   - Atribuir permissÃµes (redireciona para UC04)
   - Excluir perfil (executa UC05)
   - Filtrar por empresa
   - Filtrar por status (ativo/inativo)
   - Filtrar por tipo (perfil de sistema / perfil personalizado)
   - Pesquisar por nome
5. Caso de uso encerrado

---

## 2. Fluxos Alternativos

### FA-01: Filtrar por Empresa
**Quando:** UsuÃ¡rio seleciona uma empresa no filtro (passo 4)

1. Sistema recarrega lista exibindo apenas perfis da empresa selecionada
2. Perfis de sistema (IsSystemRole = true) continuam visÃ­veis
3. Retorna ao passo 4 do fluxo principal

### FA-02: Filtrar por Status
**Quando:** UsuÃ¡rio seleciona um status no filtro (passo 4)

1. Sistema recarrega lista exibindo apenas perfis com o status selecionado (ativo ou inativo)
2. Retorna ao passo 4 do fluxo principal

### FA-03: Filtrar por Tipo
**Quando:** UsuÃ¡rio seleciona "Apenas perfis de sistema" ou "Apenas perfis personalizados" (passo 4)

1. Sistema recarrega lista exibindo apenas perfis do tipo selecionado
2. Retorna ao passo 4 do fluxo principal

### FA-04: Pesquisar Perfil
**Quando:** UsuÃ¡rio digita texto no campo de pesquisa (passo 4)

1. Sistema filtra lista em tempo real
2. Exibe apenas perfis cujo nome contÃ©m o texto digitado
3. Retorna ao passo 4 do fluxo principal

### FA-05: Nenhum Perfil Encontrado
**Quando:** Filtros aplicados nÃ£o retornam resultados (passo 2)

1. Sistema exibe mensagem "Nenhum perfil encontrado"
2. Sistema oferece opÃ§Ã£o de limpar filtros
3. Retorna ao passo 4 do fluxo principal

### FA-06: Visualizar Hierarquia
**Quando:** UsuÃ¡rio clica em "Ver hierarquia" (passo 4)

1. Sistema exibe modal com Ã¡rvore hierÃ¡rquica de perfis
2. Perfis ordenados por HierarchyLevel (0 no topo)
3. VisualizaÃ§Ã£o em formato de Ã¡rvore:
   ```
   ğŸ”´ Super Admin (NÃ­vel 0)
   ğŸŸ  Administrador (NÃ­vel 1)
   ğŸŸ¡ Gerente (NÃ­vel 2)
   ğŸŸ¢ UsuÃ¡rio PadrÃ£o (NÃ­vel 3)
   ```
4. Retorna ao passo 4 do fluxo principal

---

## 3. Fluxos de ExceÃ§Ã£o

### FE-01: Erro ao Carregar Lista
**Quando:** Erro de comunicaÃ§Ã£o com API (passo 2)

1. Sistema exibe mensagem de erro: "NÃ£o foi possÃ­vel carregar a lista de perfis"
2. Sistema oferece botÃ£o "Tentar novamente"
3. Se usuÃ¡rio clicar em "Tentar novamente", retorna ao passo 2
4. Caso de uso encerrado

### FE-02: PermissÃ£o Insuficiente
**Quando:** UsuÃ¡rio nÃ£o possui permissÃ£o `roles:role:read` (prÃ©-condiÃ§Ã£o)

1. Sistema exibe mensagem: "VocÃª nÃ£o tem permissÃ£o para visualizar perfis"
2. Sistema redireciona para pÃ¡gina inicial
3. Caso de uso encerrado

### FE-03: SessÃ£o Expirada
**Quando:** Token de autenticaÃ§Ã£o expirado durante carregamento (passo 2)

1. Sistema exibe mensagem: "Sua sessÃ£o expirou"
2. Sistema redireciona para tela de login
3. Caso de uso encerrado

---

## 4. Regras de NegÃ³cio

**RN-01: Multi-tenancy**
- UsuÃ¡rios sÃ³ podem visualizar perfis da mesma empresa (EmpresaId)
- Perfis de sistema (IsSystemRole = true) sÃ£o visÃ­veis para todos
- Super Admins podem visualizar perfis de todas as empresas

**RN-02: Hierarquia de VisualizaÃ§Ã£o**
- UsuÃ¡rios sÃ³ podem visualizar perfis de hierarquia igual ou inferior
- Exemplo: Admin (nivel 1) pode ver Manager (nivel 2) e User (nivel 3), mas nÃ£o Super Admin (nivel 0)

**RN-03: Indicadores Visuais**
- NÃ­vel 0: Badge vermelho "Super Admin"
- NÃ­vel 1: Badge laranja "Administrador"
- NÃ­vel 2: Badge amarelo "Gerente"
- NÃ­vel 3+: Badge verde "UsuÃ¡rio"
- Perfil de sistema: Ãcone de cadeado

**RN-04: OrdenaÃ§Ã£o PadrÃ£o**
- Lista ordenada por HierarchyLevel (crescente), depois por Nome (A-Z)
- Super Admin sempre no topo

**RN-05: ProteÃ§Ã£o de Perfis de Sistema**
- Perfis com IsSystemRole = true nÃ£o podem ser excluÃ­dos
- AÃ§Ãµes de ediÃ§Ã£o/exclusÃ£o desabilitadas para perfis de sistema

**RN-06: Quantidade de UsuÃ¡rios**
- Sistema exibe contador de quantos usuÃ¡rios tÃªm cada perfil
- Se perfil tem usuÃ¡rios associados, exclusÃ£o Ã© bloqueada

---

## 5. EspecificaÃ§Ã£o TÃ©cnica

### 5.1 Endpoint API

**Request:**
```http
GET /api/roles?empresaId={guid}&ativo={boolean}&includeSystemRoles={boolean}
Authorization: Bearer {token}
```

**Query Parameters:**
| ParÃ¢metro | Tipo | ObrigatÃ³rio | DescriÃ§Ã£o |
|-----------|------|-------------|-----------|
| empresaId | Guid | NÃ£o | Filtrar por empresa especÃ­fica |
| ativo | Boolean | NÃ£o | Filtrar por status (true = ativo, false = inativo) |
| includeSystemRoles | Boolean | NÃ£o | Incluir perfis de sistema (default = true) |

**Response 200 OK:**
```json
[
  {
    "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "nome": "Super Administrador",
    "descricao": "Acesso total ao sistema",
    "ativo": true,
    "isSystemRole": true,
    "hierarchyLevel": 0,
    "empresaId": null,
    "empresaNome": null,
    "permissions": [
      {
        "id": "4fa85f64-5717-4562-b3fc-2c963f66afa7",
        "codigo": "users:user:create",
        "nome": "Criar UsuÃ¡rios",
        "descricao": "PermissÃ£o para criar novos usuÃ¡rios",
        "modulo": "users",
        "entidade": "user",
        "acao": "create",
        "ativo": true
      }
    ]
  },
  {
    "id": "5fa85f64-5717-4562-b3fc-2c963f66afa8",
    "nome": "Gerente de TI",
    "descricao": "GestÃ£o de ativos e contratos",
    "ativo": true,
    "isSystemRole": false,
    "hierarchyLevel": 2,
    "empresaId": "6fa85f64-5717-4562-b3fc-2c963f66afa9",
    "empresaNome": "Empresa XYZ",
    "permissions": [...]
  }
]
```

**Response 403 Forbidden:**
```json
{
  "message": "VocÃª nÃ£o tem permissÃ£o para visualizar perfis"
}
```

### 5.2 ImplementaÃ§Ã£o Backend

**Query Handler:** `GetRolesQuery` em `D:\IC2\backend\IControlIT.API\src\Application\RoleManagement\Queries\GetRoles\GetRoles.cs`

**ValidaÃ§Ãµes aplicadas:**
1. Verificar permissÃ£o `roles:role:read` via `AuthorizationPolicies.RolesRead`
2. Aplicar filtro de EmpresaId (multi-tenancy)
3. Aplicar filtro de hierarquia (usuÃ¡rio sÃ³ vÃª perfis de nÃ­vel igual ou inferior)
4. Aplicar filtros opcionais (empresaId, ativo, includeSystemRoles)
5. Incluir contagem de usuÃ¡rios por perfil

### 5.3 ImplementaÃ§Ã£o Frontend

**Componente:** `ListComponent` em `D:\IC2\frontend\icontrolit-app\src\app\modules\admin\management\roles\list\list.component.ts`

**Service:** `RolesService.getRoles()` em `D:\IC2\frontend\icontrolit-app\src\app\modules\admin\management\roles\roles.service.ts`

**Features implementadas:**
- Grid responsivo com colunas: Nome, DescriÃ§Ã£o, Hierarquia, Tipo, Status, PermissÃµes, UsuÃ¡rios, AÃ§Ãµes
- Badges coloridos por nÃ­vel de hierarquia
- Filtros: Empresa (dropdown), Status (toggle), Tipo (toggle), Pesquisa (input text)
- AÃ§Ãµes: Criar, Visualizar, Editar, Atribuir PermissÃµes, Excluir
- VisualizaÃ§Ã£o de hierarquia em modal
- Loading state durante carregamento

---

## 6. Casos de Teste

### CT-001: Listar Todos os Perfis
**PrÃ©-condiÃ§Ã£o:** Existem 5 perfis cadastrados (2 de sistema, 3 personalizados)
**Passos:**
1. Acessar tela de listagem
2. Verificar carregamento

**Resultado esperado:**
- Sistema exibe 5 perfis
- Perfis de sistema com Ã­cone de cadeado
- Ordenados por HierarchyLevel

### CT-002: Filtrar por Empresa
**PrÃ©-condiÃ§Ã£o:** Existem perfis de 2 empresas diferentes
**Passos:**
1. Acessar tela de listagem
2. Selecionar "Empresa A" no filtro

**Resultado esperado:**
- Sistema exibe apenas perfis da Empresa A
- Perfis de sistema continuam visÃ­veis

### CT-003: Filtrar por Status Ativo
**PrÃ©-condiÃ§Ã£o:** Existem perfis ativos e inativos
**Passos:**
1. Acessar tela de listagem
2. Selecionar "Apenas ativos" no filtro

**Resultado esperado:**
- Sistema exibe apenas perfis com Ativo = true

### CT-004: Filtrar por Perfis de Sistema
**PrÃ©-condiÃ§Ã£o:** Existem perfis de sistema e personalizados
**Passos:**
1. Acessar tela de listagem
2. Selecionar "Apenas perfis de sistema" no filtro

**Resultado esperado:**
- Sistema exibe apenas perfis com IsSystemRole = true

### CT-005: Pesquisar por Nome
**PrÃ©-condiÃ§Ã£o:** Existe perfil "Administrador"
**Passos:**
1. Acessar tela de listagem
2. Digitar "Admin" no campo de pesquisa

**Resultado esperado:**
- Sistema exibe apenas perfis com "Admin" no nome

### CT-006: Visualizar Hierarquia
**PrÃ©-condiÃ§Ã£o:** Existem perfis de diferentes nÃ­veis
**Passos:**
1. Acessar tela de listagem
2. Clicar em "Ver hierarquia"

**Resultado esperado:**
- Modal exibe Ã¡rvore hierÃ¡rquica
- Super Admin (0) no topo
- Cores diferentes por nÃ­vel

### CT-007: PermissÃ£o Negada
**PrÃ©-condiÃ§Ã£o:** UsuÃ¡rio sem permissÃ£o `roles:role:read`
**Passos:**
1. Tentar acessar tela de listagem

**Resultado esperado:**
- Sistema exibe erro 403
- Mensagem "VocÃª nÃ£o tem permissÃ£o para visualizar perfis"
- Redireciona para pÃ¡gina inicial

### CT-008: Hierarquia - Admin nÃ£o vÃª Super Admin
**PrÃ©-condiÃ§Ã£o:** UsuÃ¡rio logado Ã© Admin (nivel 1), existe Super Admin (nivel 0)
**Passos:**
1. Acessar tela de listagem

**Resultado esperado:**
- Lista NÃƒO inclui perfil Super Admin

### CT-009: Perfil com UsuÃ¡rios - AÃ§Ã£o Excluir Bloqueada
**PrÃ©-condiÃ§Ã£o:** Perfil "Gerente" tem 5 usuÃ¡rios associados
**Passos:**
1. Acessar tela de listagem
2. Tentar excluir perfil "Gerente"

**Resultado esperado:**
- BotÃ£o "Excluir" desabilitado
- Tooltip: "Este perfil possui 5 usuÃ¡rios associados"

### CT-010: Perfil de Sistema - AÃ§Ãµes Bloqueadas
**PrÃ©-condiÃ§Ã£o:** Existe perfil "Super Admin" (IsSystemRole = true)
**Passos:**
1. Acessar tela de listagem
2. Verificar aÃ§Ãµes disponÃ­veis para perfil de sistema

**Resultado esperado:**
- BotÃµes "Editar" e "Excluir" desabilitados
- Apenas "Visualizar" habilitado

### CT-011: Exibir Contagem de PermissÃµes
**PrÃ©-condiÃ§Ã£o:** Perfil "Admin" tem 25 permissÃµes
**Passos:**
1. Acessar tela de listagem
2. Verificar coluna "PermissÃµes" do perfil Admin

**Resultado esperado:**
- Exibe "25 permissÃµes"
- Badge azul clicÃ¡vel

### CT-012: Erro de ComunicaÃ§Ã£o
**PrÃ©-condiÃ§Ã£o:** API estÃ¡ offline
**Passos:**
1. Tentar acessar tela de listagem

**Resultado esperado:**
- Sistema exibe erro de comunicaÃ§Ã£o
- BotÃ£o "Tentar novamente" disponÃ­vel

---

## 7. CritÃ©rios de AceitaÃ§Ã£o

âœ… Lista carrega em menos de 2 segundos
âœ… Filtros aplicam em tempo real (< 500ms)
âœ… Pesquisa funciona por nome do perfil
âœ… Apenas usuÃ¡rios autorizados podem acessar
âœ… Multi-tenancy respeitado (usuÃ¡rio sÃ³ vÃª sua empresa + perfis de sistema)
âœ… Hierarquia respeitada (nÃ£o exibe perfis superiores)
âœ… Badges coloridos por nÃ­vel de hierarquia
âœ… AÃ§Ãµes bloqueadas para perfis de sistema
âœ… AÃ§Ãµes bloqueadas para perfis com usuÃ¡rios associados
âœ… Interface responsiva (funciona em mobile)
âœ… VisualizaÃ§Ã£o de hierarquia em modal
âœ… Contagem de usuÃ¡rios e permissÃµes exibida

---

## 8. Matriz de Hierarquia

| NÃ­vel | Nome Sugerido | Cor do Badge | Pode Gerenciar |
|-------|---------------|--------------|----------------|
| 0 | Super Administrador | ğŸ”´ Vermelho | Todos os nÃ­veis |
| 1 | Administrador | ğŸŸ  Laranja | NÃ­veis 2-10 |
| 2 | Gerente | ğŸŸ¡ Amarelo | NÃ­veis 3-10 |
| 3 | Coordenador | ğŸŸ¢ Verde | NÃ­veis 4-10 |
| 4-10 | UsuÃ¡rio | ğŸ”µ Azul | NÃ­veis inferiores |

---

## 9. HistÃ³rico de AlteraÃ§Ãµes

| Data | VersÃ£o | Autor | DescriÃ§Ã£o |
|------|--------|-------|-----------|
| 2025-10-26 | 1.0 | Sistema | CriaÃ§Ã£o inicial do caso de uso |

---

**Status:** âœ… Implementado (com HierarchyLevel gerenciÃ¡vel)
**Endpoints:** `GET /api/roles` implementado em [Roles.cs:14-15](D:\IC2\backend\IControlIT.API\src\Web\Endpoints\Roles.cs#L14-L15)
**Frontend:** Implementado em [list.component.ts](D:\IC2\frontend\icontrolit-app\src\app\modules\admin\management\roles\list\list.component.ts)
**ValidaÃ§Ãµes:** HierarchyLevel agora gerenciÃ¡vel via API (correÃ§Ã£o implementada em 2025-10-26)

---

# UC01 - Criar Template de E-mail

## 1. CabeÃ§alho

| Item | DescriÃ§Ã£o |
|------|-----------|
| **RF** | RF-090 - Templates de E-mail Transacionais e Marketing |
| **CÃ³digo UC** | UC01 |
| **Nome** | Criar Template de E-mail |
| **Ator Principal** | Administrador, Marketing, Developer |
| **Complexidade** | Alta |
| **Estimativa Backend** | 8 horas (Command, Handler, Validator, MJML compiler, JSON Schema validation) |
| **Estimativa Frontend** | 16 horas (Form component, Monaco Editor for MJML, JSON Schema editor, Preview component) |
| **Estimativa Testes** | 6 horas (Unit + Integration + E2E + Validation scenarios) |
| **VersÃ£o** | 1.0 |
| **Data** | 2025-01-20 |

---

## 2. Objetivo

Permitir que usuÃ¡rios criem novos templates de e-mail responsivos usando framework MJML, definindo assunto dinÃ¢mico, corpo HTML/texto plano, variÃ¡veis esperadas via JSON Schema, tipo de e-mail (Transacional/Marketing/NotificaÃ§Ã£o) e configuraÃ§Ãµes de tracking.

---

## 3. PrÃ©-condiÃ§Ãµes

- [x] UsuÃ¡rio autenticado no sistema
- [x] UsuÃ¡rio possui permissÃ£o `EMAIL_TEMPLATES.CREATE` ou perfil `Admin`/`Marketing`
- [x] Tabela `Email_Template` existe no banco de dados
- [x] RF-063 (Motor de Templates) estÃ¡ implementado e funcional
- [x] Biblioteca MJML configurada no backend (.NET MJML compiler)
- [x] Monaco Editor configurado no frontend (syntax highlighting para MJML)

---

## 4. DependÃªncias de Desenvolvimento

### 4.1 RFs Externos
| RF | UC | Tipo | DescriÃ§Ã£o |
|----|-----|------|-----------|
| RF-001 | UC00-listar-configuracoes | Leitura | Buscar tamanho mÃ¡ximo de template, TTL de cache |
| RF-008 | UC00-listar-usuarios | Leitura | Validar usuÃ¡rio criador |
| RF-063 | UC01-criar-template | HeranÃ§a | Herda estrutura base de template (versionamento, componentes) |
| RF-063 | UC08-renderizar-template | Chamada | Usar motor de renderizaÃ§Ã£o para preview |

### 4.2 IntegraÃ§Ãµes Backend
- **PermissÃµes**: `EMAIL_TEMPLATES.CREATE` via RBAC
- **Auditoria**: Campos `Usuario_Criacao`, `Dt_Criacao` preenchidos automaticamente
- **Multi-tenancy**: `Id_Conglomerado` do usuÃ¡rio logado
- **ValidaÃ§Ã£o MJML**: Compilar MJML para HTML antes de salvar (validaÃ§Ã£o de sintaxe)
- **ValidaÃ§Ã£o JSON Schema**: Validar que schema de variÃ¡veis Ã© vÃ¡lido

### 4.3 DependÃªncias de UCs (ordem de implementaÃ§Ã£o)
| Depende de | Motivo |
|------------|--------|
| UC00-listar-templates-email | Retornar para listagem apÃ³s criar |
| RF-063 UC01-criar-template | Herdar estrutura base de versionamento e componentes |

### 4.4 Endpoints Chamados
- `POST /api/v1/email-templates` (criar template)
- `POST /api/v1/email-templates/validate-mjml` (validar MJML antes de salvar)
- `POST /api/v1/email-templates/preview` (preview em tempo real)

---

## 5. Fluxo Principal

| Passo | Ator | AÃ§Ã£o | Sistema |
|-------|------|------|---------|
| 1 | UsuÃ¡rio | Clica em "Novo Template" na listagem | Abre formulÃ¡rio de criaÃ§Ã£o |
| 2 | UsuÃ¡rio | Preenche nome do template | Valida unicidade do nome (nÃ£o pode duplicar) |
| 3 | UsuÃ¡rio | Seleciona tipo de e-mail (Transacional/Marketing/NotificaÃ§Ã£o) | Ajusta configuraÃ§Ãµes padrÃ£o conforme tipo |
| 4 | UsuÃ¡rio | Preenche assunto (suporta variÃ¡veis Razor: `Bem-vindo, {{Nome}}!`) | Valida sintaxe Razor no assunto |
| 5 | UsuÃ¡rio | Escreve cÃ³digo MJML no editor | Monaco Editor com syntax highlighting e autocomplete |
| 6 | UsuÃ¡rio | Define JSON Schema das variÃ¡veis esperadas | Valida que schema Ã© vÃ¡lido (ex: `{ "nome": "string", "email": "string" }`) |
| 7 | UsuÃ¡rio | _(Opcional)_ Preenche corpo em texto plano (fallback) | Usado para clientes de e-mail que nÃ£o suportam HTML |
| 8 | UsuÃ¡rio | Marca opÃ§Ãµes de tracking (abertura/clique) | PadrÃ£o: ambos marcados para Marketing, apenas abertura para Transacional |
| 9 | UsuÃ¡rio | Clica em "Salvar" | Valida todos os campos obrigatÃ³rios |
| 10 | Sistema | Compila MJML para HTML | Retorna erro se MJML invÃ¡lido |
| 11 | Sistema | Valida JSON Schema | Retorna erro se schema invÃ¡lido |
| 12 | Sistema | Salva template no banco com status Rascunho | Gera ID e timestamp de criaÃ§Ã£o |
| 13 | Sistema | Exibe mensagem de sucesso | "Template criado com sucesso! FaÃ§a um preview antes de publicar." |
| 14 | UsuÃ¡rio | Redirecionado para tela de preview | UC05-preview-multi-device |

**Resultado**: Template de e-mail criado com sucesso e armazenado como rascunho.

---

## 6. Fluxos Alternativos

### FA-01: Uso de Template Base (Iniciar de Template Existente)
- **Gatilho**: UsuÃ¡rio clica em "Duplicar" em template existente
- **Fluxo**:
  1. Sistema carrega dados do template original
  2. Adiciona sufixo " (CÃ³pia)" ao nome
  3. Desmarca flag `Fl_Publicado` (cÃ³pia inicia como rascunho)
  4. UsuÃ¡rio edita campos conforme necessÃ¡rio
- **Resultado**: Novo template criado a partir de base existente

### FA-02: Uso de Biblioteca de Componentes (RF-063)
- **Gatilho**: UsuÃ¡rio clica em "Inserir Componente"
- **Fluxo**:
  1. Sistema exibe galeria de componentes disponÃ­veis (header, footer, button, etc.)
  2. UsuÃ¡rio seleciona componente desejado
  3. Sistema insere MJML do componente no cursor: `<mj-include path="header-oficial" />`
  4. Preview atualiza em tempo real mostrando componente renderizado
- **Resultado**: Componente reutilizÃ¡vel inserido no template

### FA-03: Preview em Tempo Real
- **Gatilho**: UsuÃ¡rio digita no editor MJML
- **Fluxo**:
  1. Sistema aguarda 1 segundo apÃ³s Ãºltima digitaÃ§Ã£o (debounce)
  2. Compila MJML para HTML em background
  3. Atualiza preview na lateral direita da tela
  4. Se erro de sintaxe, exibe linha do erro no editor
- **Resultado**: Feedback visual imediato da renderizaÃ§Ã£o

### FA-04: Definir VariÃ¡veis via Autocomplete
- **Gatilho**: UsuÃ¡rio digita `{{` no editor MJML
- **Fluxo**:
  1. Monaco Editor exibe autocomplete com variÃ¡veis disponÃ­veis do JSON Schema
  2. UsuÃ¡rio seleciona variÃ¡vel da lista (ex: `Nome`, `Email`, `DataCadastro`)
  3. Editor insere sintaxe completa: `{{Nome}}`
- **Resultado**: Autocomplete acelera digitaÃ§Ã£o e reduz erros

### FA-05: Carregar Template de Arquivo
- **Gatilho**: UsuÃ¡rio clica em "Importar de Arquivo"
- **Fluxo**:
  1. Sistema permite upload de arquivo .mjml ou .html
  2. Valida que arquivo nÃ£o excede 100KB
  3. Carrega conteÃºdo no editor MJML
  4. Compila e valida sintaxe automaticamente
- **Resultado**: Template importado de arquivo externo

### FA-06: Definir Teste A/B
- **Gatilho**: UsuÃ¡rio marca checkbox "Criar variante para teste A/B"
- **Fluxo**:
  1. Sistema duplica template criando variante
  2. UsuÃ¡rio define assunto alternativo para teste
  3. Sistema cria relacionamento `Id_Template_Variante` entre original e variante
  4. Define `Percentual_Teste_AB = 50` (split 50/50)
- **Resultado**: Template com variante A/B configurada

---

## 7. Fluxos de ExceÃ§Ã£o

### FE-01: Nome de Template Duplicado
- **Gatilho**: UsuÃ¡rio tenta criar template com nome jÃ¡ existente no conglomerado
- **AÃ§Ã£o**: Retornar HTTP 400 Bad Request
- **Mensagem**: "JÃ¡ existe um template com o nome 'Boas-vindas' neste conglomerado. Escolha outro nome."
- **RecuperaÃ§Ã£o**: UsuÃ¡rio altera nome do template

### FE-02: MJML InvÃ¡lido
- **Gatilho**: CÃ³digo MJML com sintaxe incorreta (tag nÃ£o fechada, atributo invÃ¡lido)
- **AÃ§Ã£o**: CompilaÃ§Ã£o MJML falha
- **Mensagem**: "Erro de sintaxe MJML na linha 15: Tag <mj-section> nÃ£o foi fechada corretamente."
- **RecuperaÃ§Ã£o**: Editor destaca linha com erro, usuÃ¡rio corrige

### FE-03: JSON Schema InvÃ¡lido
- **Gatilho**: Schema de variÃ¡veis com sintaxe JSON incorreta
- **AÃ§Ã£o**: ValidaÃ§Ã£o JSON falha
- **Mensagem**: "JSON Schema invÃ¡lido: Esperado '}' na linha 10."
- **RecuperaÃ§Ã£o**: Editor JSON destaca erro, usuÃ¡rio corrige

### FE-04: Template Excede Tamanho MÃ¡ximo
- **Gatilho**: CÃ³digo MJML > 100KB
- **AÃ§Ã£o**: ValidaÃ§Ã£o de tamanho falha
- **Mensagem**: "Template muito grande (105KB). Tamanho mÃ¡ximo permitido: 100KB. Divida em componentes menores."
- **RecuperaÃ§Ã£o**: UsuÃ¡rio refatora template em componentes reutilizÃ¡veis

### FE-05: VariÃ¡vel NÃ£o Declarada no Schema
- **Gatilho**: Template usa variÃ¡vel `{{Cpf}}` mas JSON Schema nÃ£o a declara
- **AÃ§Ã£o**: ValidaÃ§Ã£o de consistÃªncia falha
- **Mensagem**: "VariÃ¡vel 'Cpf' usada no template mas nÃ£o declarada no JSON Schema. Adicione ao schema ou remova do template."
- **RecuperaÃ§Ã£o**: UsuÃ¡rio adiciona variÃ¡vel ao schema ou remove do template

### FE-06: UsuÃ¡rio Sem PermissÃ£o
- **Gatilho**: UsuÃ¡rio sem permissÃ£o `EMAIL_TEMPLATES.CREATE`
- **AÃ§Ã£o**: Retornar HTTP 403 Forbidden
- **Mensagem**: "VocÃª nÃ£o tem permissÃ£o para criar templates de e-mail. Contate o administrador."
- **RecuperaÃ§Ã£o**: Solicitar permissÃ£o ao administrador

---

## 8. ValidaÃ§Ãµes de Campos

### 8.1 Campos ObrigatÃ³rios
| Campo | ValidaÃ§Ã£o | Mensagem de Erro |
|-------|-----------|------------------|
| Nome Template | 3-100 caracteres | "Nome do template Ã© obrigatÃ³rio (3-100 caracteres)" |
| Tipo Email | Enum vÃ¡lido (Transacional/Marketing/Notificacao) | "Selecione o tipo de e-mail" |
| Assunto Template | 3-200 caracteres | "Assunto Ã© obrigatÃ³rio (3-200 caracteres)" |
| Corpo MJML | 10-100000 caracteres | "Corpo MJML Ã© obrigatÃ³rio (mÃ­n. 10 caracteres)" |
| JSON Schema VariÃ¡veis | JSON vÃ¡lido | "JSON Schema de variÃ¡veis Ã© obrigatÃ³rio e deve ser vÃ¡lido" |

### 8.2 Campos Opcionais
| Campo | ValidaÃ§Ã£o | Valor PadrÃ£o |
|-------|-----------|--------------|
| Corpo Texto Plano | MÃ¡x. 50000 caracteres | NULL (gerado automaticamente do HTML se vazio) |
| DescriÃ§Ã£o | MÃ¡x. 500 caracteres | NULL |
| Tags | Array de strings | [] |
| Id_Template_Pai | FK vÃ¡lido ou NULL | NULL (nÃ£o Ã© template filho) |
| Fl_Tracking_Abertura | Boolean | true |
| Fl_Tracking_Clique | Boolean | true (Marketing), false (Transacional) |

### 8.3 ValidaÃ§Ãµes de NegÃ³cio
| Regra | DescriÃ§Ã£o | Mensagem |
|-------|-----------|----------|
| **VN-01**: Nome Ãºnico | Nome Ãºnico por conglomerado | "JÃ¡ existe template com este nome" |
| **VN-02**: MJML compilÃ¡vel | MJML deve compilar sem erros | "Erro de sintaxe MJML: {detalhes}" |
| **VN-03**: JSON Schema vÃ¡lido | Schema deve ser JSON vÃ¡lido | "JSON Schema invÃ¡lido: {detalhes}" |
| **VN-04**: VariÃ¡veis consistentes | VariÃ¡veis usadas devem estar no schema | "VariÃ¡vel '{nome}' nÃ£o declarada no schema" |
| **VN-05**: Assunto com sintaxe Razor vÃ¡lida | Assunto pode conter variÃ¡veis Razor `{{...}}` | "Sintaxe Razor invÃ¡lida no assunto" |
| **VN-06**: Tamanho mÃ¡ximo | MJML < 100KB | "Template muito grande (mÃ¡x. 100KB)" |

### 8.4 Fluxos Alternativos de ValidaÃ§Ã£o

#### FA-VAL-01: Campos ObrigatÃ³rios NÃ£o Preenchidos
- **Gatilho**: UsuÃ¡rio tenta salvar com campos vazios
- **AÃ§Ã£o**: Highlight em vermelho nos campos obrigatÃ³rios vazios
- **Mensagem**: "Preencha todos os campos obrigatÃ³rios antes de salvar"
- **RecuperaÃ§Ã£o**: UsuÃ¡rio preenche campos destacados

#### FA-VAL-02: Sintaxe MJML InvÃ¡lida
- **Gatilho**: MJML nÃ£o compila
- **AÃ§Ã£o**: Editor destaca linha com erro, exibe painel de erros
- **Mensagem**: "Linha 15: Tag <mj-section> nÃ£o fechada"
- **RecuperaÃ§Ã£o**: UsuÃ¡rio corrige sintaxe no editor

#### FA-VAL-03: Tamanho de Template Excedido
- **Gatilho**: MJML > 100KB
- **AÃ§Ã£o**: Bloquear salvamento, exibir alerta
- **Mensagem**: "Template muito grande (105KB). Divida em componentes."
- **RecuperaÃ§Ã£o**: UsuÃ¡rio extrai trechos para componentes reutilizÃ¡veis (RF-063)

#### FA-VAL-04: ValidaÃ§Ã£o de Foreign Keys
- **Gatilho**: `Id_Conglomerado` ou `Id_Usuario_Criacao` invÃ¡lidos
- **AÃ§Ã£o**: ValidaÃ§Ã£o de FK no backend falha
- **Mensagem**: "Erro interno: Conglomerado ou usuÃ¡rio invÃ¡lido"
- **RecuperaÃ§Ã£o**: Sistema usa IDs do contexto do usuÃ¡rio logado (nÃ£o depende do frontend)

---

## 9. Regras de NegÃ³cio

### RN-UC01-001: CÃ³digo MJML Responsivo ObrigatÃ³rio
- **DescriÃ§Ã£o**: Templates DEVEM usar framework MJML para garantir responsividade mobile
- **ValidaÃ§Ã£o**:
  - Compilar MJML para HTML antes de salvar
  - Validar que HTML gerado Ã© responsivo (largura mÃ¡x. 600px)
  - Testar renderizaÃ§Ã£o em simuladores de: Gmail, Outlook, iPhone, Android

### RN-UC01-002: JSON Schema de VariÃ¡veis ObrigatÃ³rio
- **DescriÃ§Ã£o**: Template transacional DEVE definir JSON Schema de variÃ¡veis esperadas
- **ValidaÃ§Ã£o**:
  - Campo `Variaveis_Json` obrigatÃ³rio para `Tipo_Email = Transacional`
  - Schema deve seguir padrÃ£o JSON Schema Draft 7
  - Autocomplete no editor baseado no schema definido

### RN-UC01-003: Tracking PadrÃ£o por Tipo
- **DescriÃ§Ã£o**: ConfiguraÃ§Ãµes de tracking diferem por tipo de e-mail
- **ValidaÃ§Ã£o**:
  - **Transacional**: `Fl_Tracking_Abertura = true`, `Fl_Tracking_Clique = false` (padrÃ£o)
  - **Marketing**: `Fl_Tracking_Abertura = true`, `Fl_Tracking_Clique = true` (padrÃ£o)
  - **NotificaÃ§Ã£o**: `Fl_Tracking_Abertura = false`, `Fl_Tracking_Clique = false` (padrÃ£o)

### RN-UC01-004: Texto Plano Gerado Automaticamente
- **DescriÃ§Ã£o**: Se corpo texto plano nÃ£o fornecido, gerar automaticamente do HTML
- **ValidaÃ§Ã£o**:
  - Converter HTML para texto plano removendo tags
  - Preservar quebras de linha e estrutura bÃ¡sica
  - Armazenar em `Corpo_Text`

### RN-UC01-005: Template Inicia Como Rascunho
- **DescriÃ§Ã£o**: Templates recÃ©m-criados iniciam com `Fl_Publicado = false`
- **ValidaÃ§Ã£o**:
  - Apenas Admin pode publicar template (`Fl_Publicado = true`)
  - Preview obrigatÃ³rio antes de publicaÃ§Ã£o
  - Templates nÃ£o publicados nÃ£o podem ser usados em envios

### RN-UC01-006: Multi-Tenancy por Conglomerado
- **DescriÃ§Ã£o**: Template criado pertence ao conglomerado do usuÃ¡rio logado
- **ValidaÃ§Ã£o**:
  - `Id_Conglomerado` preenchido automaticamente do contexto do usuÃ¡rio
  - UsuÃ¡rio Admin pode criar templates globais (`Id_Conglomerado = NULL`)

### RN-UC01-007: Versionamento AutomÃ¡tico
- **DescriÃ§Ã£o**: Cada template inicia com `Versao_Atual = 1.0.0`
- **ValidaÃ§Ã£o**:
  - Primeira versÃ£o registrada em `Email_Template_Versao`
  - Registro de commit: "VersÃ£o inicial"
  - Hash do conteÃºdo armazenado para diff futuro

---

## 10. Requisitos NÃ£o-Funcionais

### Performance
- CompilaÃ§Ã£o MJML: < 2 segundos para templates de atÃ© 50KB
- Preview em tempo real: Debounce de 1s apÃ³s Ãºltima digitaÃ§Ã£o
- Salvamento: < 1 segundo (incluindo validaÃ§Ãµes)

### SeguranÃ§a
- ValidaÃ§Ã£o obrigatÃ³ria de permissÃ£o `EMAIL_TEMPLATES.CREATE`
- SanitizaÃ§Ã£o de HTML gerado (XSS protection)
- ValidaÃ§Ã£o de tamanho para evitar DoS (mÃ¡x. 100KB)

### Usabilidade
- Monaco Editor com syntax highlighting MJML
- Autocomplete de variÃ¡veis baseado em JSON Schema
- Preview lado-a-lado (split screen: Editor | Preview)
- Mensagens de erro claras com linha/coluna do problema

### Acessibilidade
- Labels descritivos em todos os campos
- NavegaÃ§Ã£o por teclado funcional (Tab, Shift+Tab)
- ARIA labels em botÃµes de aÃ§Ã£o

---

## 11. Interface UI (Wireframes)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Novo Template de E-mail                            [Salvar] [Cancel]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Nome*: [Boas-vindas ao IControlIT_____________________]             â”‚
â”‚ Tipo*: [Transacional â–¼]  DescriÃ§Ã£o: [Template de boas-vindas___]   â”‚
â”‚ Assunto*: [Bem-vindo, {{Nome}}! Seu acesso ao IControlIT___]        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Editor MJML:                          â”‚ Preview (Desktop):          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ <mjml>                          â”‚   â”‚ â”‚ Bem-vindo, JoÃ£o!        â”‚ â”‚
â”‚ â”‚   <mj-body>                     â”‚   â”‚ â”‚                         â”‚ â”‚
â”‚ â”‚     <mj-section>                â”‚   â”‚ â”‚ Seu acesso ao IControl  â”‚ â”‚
â”‚ â”‚       <mj-column>               â”‚   â”‚ â”‚ IT foi criado com suce  â”‚ â”‚
â”‚ â”‚         <mj-text>               â”‚   â”‚ â”‚ sso!                    â”‚ â”‚
â”‚ â”‚           Bem-vindo, {{Nome}}!  â”‚   â”‚ â”‚                         â”‚ â”‚
â”‚ â”‚         </mj-text>              â”‚   â”‚ â”‚ [Acessar Plataforma]    â”‚ â”‚
â”‚ â”‚       </mj-column>              â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”‚     </mj-section>               â”‚   â”‚                             â”‚
â”‚ â”‚   </mj-body>                    â”‚   â”‚ Preview (Mobile):           â”‚
â”‚ â”‚ </mjml>                         â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚ Bem-vindo,  â”‚            â”‚
â”‚                                        â”‚ â”‚ JoÃ£o!        â”‚            â”‚
â”‚ JSON Schema VariÃ¡veis*:                â”‚ â”‚              â”‚            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚ Seu acesso..â”‚            â”‚
â”‚ â”‚ {                               â”‚   â”‚ â”‚              â”‚            â”‚
â”‚ â”‚   "nome": "string",             â”‚   â”‚ â”‚ [Acessar]    â”‚            â”‚
â”‚ â”‚   "email": "string",            â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚ â”‚   "dataCadastro": "date"        â”‚   â”‚                             â”‚
â”‚ â”‚ }                               â”‚   â”‚ [Desktop] [Tablet] [Mobile] â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                             â”‚
â”‚                                        â”‚                             â”‚
â”‚ Tracking: [âœ“] Abertura  [âœ“] Clique   â”‚                             â”‚
â”‚                                        â”‚                             â”‚
â”‚ Corpo Texto Plano (fallback):          â”‚                             â”‚
â”‚ [Gerado automaticamente do HTML_____________________________________]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Features do Editor:**
- Syntax highlighting para MJML
- Autocomplete de tags MJML
- Autocomplete de variÃ¡veis (baseado em JSON Schema)
- ValidaÃ§Ã£o em tempo real com feedback visual
- Preview lado-a-lado com switch desktop/tablet/mobile

---

## 12. Mensagens ao UsuÃ¡rio

### Sucesso
- âœ… "Template 'Boas-vindas' criado com sucesso! FaÃ§a um preview antes de publicar."
- âœ… "MJML compilado com sucesso. Template responsivo validado."

### Info
- â„¹ï¸ "Corpo em texto plano nÃ£o fornecido. SerÃ¡ gerado automaticamente do HTML."
- â„¹ï¸ "Templates transacionais tÃªm tracking de clique desabilitado por padrÃ£o."
- â„¹ï¸ "Use {{NomeVariavel}} para inserir variÃ¡veis dinÃ¢micas."

### Aviso
- âš ï¸ "Template grande (85KB). Considere dividir em componentes menores."
- âš ï¸ "VariÃ¡vel 'Cpf' usada no template mas nÃ£o declarada no JSON Schema."

### Erro
- âŒ "Erro de sintaxe MJML na linha 15: Tag <mj-section> nÃ£o fechada."
- âŒ "Nome 'Boas-vindas' jÃ¡ existe. Escolha outro nome."
- âŒ "JSON Schema invÃ¡lido: Esperado '}' na linha 10."
- âŒ "Template muito grande (105KB). MÃ¡ximo permitido: 100KB."

---

## 13. Testes

### CenÃ¡rios de Teste Backend
- [ ] **TC-UC01-001**: Criar template vÃ¡lido
  - **Dado**: Dados vÃ¡lidos com MJML correto
  - **Quando**: POST /api/v1/email-templates
  - **EntÃ£o**: Retorna HTTP 201 com ID do template criado

- [ ] **TC-UC01-002**: Rejeitar nome duplicado
  - **Dado**: Template "Boas-vindas" jÃ¡ existe no conglomerado
  - **Quando**: Tentar criar outro com mesmo nome
  - **EntÃ£o**: Retorna HTTP 400 "Nome jÃ¡ existe"

- [ ] **TC-UC01-003**: Validar MJML invÃ¡lido
  - **Dado**: MJML com tag nÃ£o fechada
  - **Quando**: POST com MJML invÃ¡lido
  - **EntÃ£o**: Retorna HTTP 400 com detalhes do erro de sintaxe

- [ ] **TC-UC01-004**: Validar JSON Schema invÃ¡lido
  - **Dado**: Schema com sintaxe JSON incorreta
  - **Quando**: POST com schema invÃ¡lido
  - **EntÃ£o**: Retorna HTTP 400 "JSON Schema invÃ¡lido"

- [ ] **TC-UC01-005**: Gerar texto plano automaticamente
  - **Dado**: Template sem `Corpo_Text` fornecido
  - **Quando**: Criar template
  - **EntÃ£o**: Sistema gera texto plano do HTML e salva em `Corpo_Text`

- [ ] **TC-UC01-006**: Multi-tenancy isolado
  - **Dado**: UsuÃ¡rio do conglomerado A
  - **Quando**: Criar template
  - **EntÃ£o**: Template salvo com `Id_Conglomerado = A` (sem acesso de outros conglomerados)

- [ ] **TC-UC01-007**: Versionamento automÃ¡tico
  - **Dado**: Template recÃ©m-criado
  - **EntÃ£o**: `Versao_Atual = 1.0.0` e registro em `Email_Template_Versao`

### CenÃ¡rios de Teste Frontend
- [ ] **TC-UC01-008**: Monaco Editor carrega com syntax highlighting
  - **Quando**: Tela de criaÃ§Ã£o Ã© aberta
  - **EntÃ£o**: Editor MJML carrega com highlighting de tags

- [ ] **TC-UC01-009**: Preview atualiza em tempo real
  - **Quando**: UsuÃ¡rio digita no editor MJML
  - **EntÃ£o**: Preview atualiza apÃ³s 1s (debounce)

- [ ] **TC-UC01-010**: Autocomplete de variÃ¡veis funcional
  - **Quando**: UsuÃ¡rio digita `{{` no editor
  - **EntÃ£o**: Autocomplete exibe variÃ¡veis do JSON Schema

- [ ] **TC-UC01-011**: ValidaÃ§Ã£o de campos obrigatÃ³rios
  - **Quando**: UsuÃ¡rio tenta salvar sem preencher nome
  - **EntÃ£o**: Campo nome destacado em vermelho com mensagem de erro

- [ ] **TC-UC01-012**: Preview multi-device
  - **Quando**: UsuÃ¡rio alterna entre Desktop/Tablet/Mobile
  - **EntÃ£o**: Preview renderiza em diferentes larguras

### CenÃ¡rios de ValidaÃ§Ã£o
- [ ] **TC-UC01-013**: FA-VAL-01 - Campos obrigatÃ³rios vazios
  - **Quando**: Salvar sem nome/assunto/corpo
  - **EntÃ£o**: Highlight em vermelho nos campos vazios

- [ ] **TC-UC01-014**: FA-VAL-02 - MJML invÃ¡lido
  - **Quando**: MJML com sintaxe incorreta
  - **EntÃ£o**: Editor destaca linha com erro, painel de erros exibe detalhes

- [ ] **TC-UC01-015**: FA-VAL-03 - Template muito grande
  - **Quando**: MJML > 100KB
  - **EntÃ£o**: Alerta "Template muito grande, divida em componentes"

### CenÃ¡rios de SeguranÃ§a
- [ ] **TC-UC01-016**: UsuÃ¡rio sem permissÃ£o
  - **Dado**: UsuÃ¡rio sem `EMAIL_TEMPLATES.CREATE`
  - **Quando**: Tentar acessar tela de criaÃ§Ã£o
  - **EntÃ£o**: HTTP 403 Forbidden

- [ ] **TC-UC01-017**: XSS protegido
  - **Quando**: Inserir `<script>alert('xss')</script>` no MJML
  - **EntÃ£o**: HTML gerado sanitizado (script removido)

---

## 14. Rastreabilidade

### Origem
- **RF-090**: SeÃ§Ã£o "Funcionalidades Principais" (item 1, 2, 3)
- **RN-TPL-002-01**: Templates Responsivos ObrigatÃ³rios
- **RN-TPL-002-02**: ValidaÃ§Ã£o de VariÃ¡veis via JSON Schema
- **RN-TPL-002-14**: Multi-Tenancy por Conglomerado

### Impacto
- **UC00-listar-templates-email**: Novo template aparece na listagem
- **UC05-preview-multi-device**: Redirecionado apÃ³s criar para fazer preview
- **UC08-renderizar-template**: Template pode ser renderizado com dados reais

### Documentos Relacionados
- **MD-Email-Template**: Modelo de dados da tabela `Email_Template`
- **RF-063**: Herda estrutura de versionamento e componentes
- **GUIA-DEVELOPER.md**: PadrÃµes de validaÃ§Ã£o e tratamento de erros

---

**Ãšltima AtualizaÃ§Ã£o**: 2025-01-20
**Autor**: Equipe IControlIT
**Revisor**: Arquiteto de Software

---

# UC02 - Visualizar Template de E-mail

## 1. CabeÃ§alho

| Item | DescriÃ§Ã£o |
|------|-----------|
| **RF** | RF-090 - Templates de E-mail Transacionais e Marketing |
| **CÃ³digo UC** | UC02 |
| **Nome** | Visualizar Template de E-mail |
| **Ator Principal** | Administrador, Marketing, Developer |
| **Complexidade** | Baixa |
| **Estimativa Backend** | 2 horas (Query, Dto incluindo histÃ³rico de versÃµes) |
| **Estimativa Frontend** | 4 horas (Detail component, tabs para versÃµes, preview) |
| **Estimativa Testes** | 2 horas (Unit + Integration + E2E) |
| **VersÃ£o** | 1.0 |
| **Data** | 2025-01-20 |

---

## 2. Objetivo

Permitir que usuÃ¡rios visualizem todos os detalhes de um template de e-mail especÃ­fico, incluindo cÃ³digo MJML, HTML compilado, JSON Schema de variÃ¡veis, histÃ³rico de versÃµes, mÃ©tricas de uso (total de envios, taxa de abertura/clique) e dados de auditoria.

---

## 3. PrÃ©-condiÃ§Ãµes

- [x] UsuÃ¡rio autenticado no sistema
- [x] UsuÃ¡rio possui permissÃ£o `EMAIL_TEMPLATES.VIEW`
- [x] Template de e-mail existe no banco de dados
- [x] UsuÃ¡rio tem acesso ao template (mesmo conglomerado ou template global)

---

## 4. DependÃªncias de Desenvolvimento

### 4.1 RFs Externos
| RF | UC | Tipo | DescriÃ§Ã£o |
|----|-----|------|-----------|
| RF-008 | UC00-listar-usuarios | Leitura | Obter nome do criador/modificador |
| RF-063 | UC02-visualizar-template | HeranÃ§a | Estrutura de visualizaÃ§Ã£o de versÃµes |

### 4.2 IntegraÃ§Ãµes Backend
- **PermissÃµes**: `EMAIL_TEMPLATES.VIEW` via RBAC
- **Multi-tenancy**: Verificar se template pertence ao conglomerado do usuÃ¡rio
- **Analytics**: Agregar dados de `Email_Envio_Log`, `Email_Tracking_Abertura`, `Email_Tracking_Clique`

### 4.3 Endpoints Chamados
- `GET /api/v1/email-templates/{id}`
- `GET /api/v1/email-templates/{id}/versions` (histÃ³rico de versÃµes)
- `GET /api/v1/email-templates/{id}/metrics` (mÃ©tricas de uso)

---

## 5. Fluxo Principal

| Passo | Ator | AÃ§Ã£o | Sistema |
|-------|------|------|---------|
| 1 | UsuÃ¡rio | Clica em Ã­cone "Visualizar" (ğŸ‘ï¸) na listagem | Abre tela de detalhes do template |
| 2 | Sistema | Carrega dados do template | Exibe abas: Detalhes, MJML, Preview, VersÃµes, MÃ©tricas |
| 3 | UsuÃ¡rio | Visualiza aba "Detalhes" | Exibe: Nome, Tipo, Assunto, Status, Data criaÃ§Ã£o/atualizaÃ§Ã£o |
| 4 | UsuÃ¡rio | Acessa aba "MJML" | Exibe cÃ³digo MJML em Monaco Editor (read-only) |
| 5 | UsuÃ¡rio | Acessa aba "Preview" | Renderiza template com dados de exemplo |
| 6 | UsuÃ¡rio | Acessa aba "VersÃµes" | Exibe histÃ³rico de todas as versÃµes |
| 7 | UsuÃ¡rio | Acessa aba "MÃ©tricas" | Exibe: Total de envios, Taxa abertura, Taxa clique |
| 8 | UsuÃ¡rio | _(Opcional)_ Clica em "Editar" | Redireciona para UC03-editar-template-email |
| 9 | UsuÃ¡rio | Fecha tela de detalhes | Retorna para listagem |

**Resultado**: UsuÃ¡rio visualizou todas as informaÃ§Ãµes relevantes do template.

---

## 6. Fluxos Alternativos

### FA-01: Comparar VersÃµes
- **Gatilho**: UsuÃ¡rio seleciona duas versÃµes na aba "VersÃµes"
- **Fluxo**:
  1. Sistema exibe diff lado-a-lado das duas versÃµes
  2. Destaca linhas adicionadas (verde) e removidas (vermelho)
- **Resultado**: VisualizaÃ§Ã£o clara das mudanÃ§as entre versÃµes

### FA-02: Rollback para VersÃ£o Anterior
- **Gatilho**: UsuÃ¡rio clica em "Restaurar" em versÃ£o antiga
- **Fluxo**:
  1. Sistema cria nova versÃ£o com conteÃºdo da versÃ£o selecionada
  2. Incrementa versÃ£o (ex: de 2.3 para 3.0)
  3. Registra commit: "Rollback para versÃ£o 1.5"
- **Resultado**: VersÃ£o anterior restaurada como nova versÃ£o

### FA-03: Exportar Template
- **Gatilho**: UsuÃ¡rio clica em "Exportar"
- **Fluxo**:
  1. Sistema gera arquivo JSON com: template, schema, versÃµes, configuraÃ§Ãµes
  2. Download automÃ¡tico do arquivo `template-boas-vindas.json`
- **Resultado**: Template exportado para uso em outro ambiente

### FA-04: Ver MÃ©tricas Detalhadas
- **Gatilho**: UsuÃ¡rio clica em "Ver Detalhes" na aba MÃ©tricas
- **Fluxo**:
  1. Sistema exibe grÃ¡ficos de: Taxa de abertura ao longo do tempo, Cliques por link, Bounces
  2. Tabela com Ãºltimos 100 envios
- **Resultado**: Analytics detalhado do template

---

## 7. Fluxos de ExceÃ§Ã£o

### FE-01: Template NÃ£o Encontrado
- **Gatilho**: ID inexistente ou deletado
- **AÃ§Ã£o**: Retornar HTTP 404 Not Found
- **Mensagem**: "Template nÃ£o encontrado ou foi removido."
- **RecuperaÃ§Ã£o**: Retornar para listagem

### FE-02: Acesso Negado (Multi-Tenancy)
- **Gatilho**: Template pertence a outro conglomerado
- **AÃ§Ã£o**: Retornar HTTP 403 Forbidden
- **Mensagem**: "VocÃª nÃ£o tem acesso a este template."
- **RecuperaÃ§Ã£o**: Retornar para listagem

### FE-03: Erro ao Carregar VersÃµes
- **Gatilho**: Falha ao buscar histÃ³rico de versÃµes
- **AÃ§Ã£o**: Exibir mensagem na aba "VersÃµes"
- **Mensagem**: "Erro ao carregar histÃ³rico. Tente novamente."
- **RecuperaÃ§Ã£o**: BotÃ£o "Tentar Novamente"

---

## 8. Regras de NegÃ³cio

### RN-UC02-001: VisualizaÃ§Ã£o Read-Only
- **DescriÃ§Ã£o**: Tela de visualizaÃ§Ã£o nÃ£o permite ediÃ§Ã£o direta
- **ValidaÃ§Ã£o**: BotÃµes de aÃ§Ã£o: "Editar", "Duplicar", "Exportar", "Inativar"

### RN-UC02-002: MÃ©tricas Agregadas
- **DescriÃ§Ã£o**: MÃ©tricas calculadas em tempo real de logs de envio
- **ValidaÃ§Ã£o**:
  - Total Envios: `COUNT(*) FROM Email_Envio_Log WHERE Id_Template = X`
  - Taxa Abertura: `(Aberturas / Envios) * 100`
  - Taxa Clique: `(Cliques / Envios) * 100`

### RN-UC02-003: Preview com Dados Mock
- **DescriÃ§Ã£o**: Preview renderiza template com dados de exemplo do JSON Schema
- **ValidaÃ§Ã£o**: Sistema gera dados fictÃ­cios compatÃ­veis com schema

---

## 9. Interface UI (Wireframes)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Template: Boas-vindas                  [Editar] [Duplicar] [Exportar]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Detalhes] [MJML] [Preview] [VersÃµes] [MÃ©tricas]                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Nome: Boas-vindas ao IControlIT                                      â”‚
â”‚ Tipo: Transacional                                                   â”‚
â”‚ Assunto: Bem-vindo, {{Nome}}! Seu acesso ao IControlIT              â”‚
â”‚ Status: ğŸŸ¢ Ativo (Publicado em 15/01/2025)                           â”‚
â”‚                                                                       â”‚
â”‚ Criado por: JoÃ£o Silva em 10/01/2025 14:30                          â”‚
â”‚ Ãšltima modificaÃ§Ã£o: Maria Santos em 15/01/2025 09:15                â”‚
â”‚ VersÃ£o atual: 2.1                                                    â”‚
â”‚                                                                       â”‚
â”‚ JSON Schema VariÃ¡veis:                                               â”‚
â”‚ { "nome": "string", "email": "string", "dataCadastro": "date" }      â”‚
â”‚                                                                       â”‚
â”‚ Tracking: âœ“ Abertura  âœ— Clique                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. Mensagens ao UsuÃ¡rio

### Info
- â„¹ï¸ "Template publicado. Pode ser usado em envios."
- â„¹ï¸ "VersÃ£o atual: 2.1 (atualizada hÃ¡ 5 dias)"

### Erro
- âŒ "Template nÃ£o encontrado ou foi removido."
- âŒ "VocÃª nÃ£o tem acesso a este template."

---

## 11. Testes

### CenÃ¡rios de Teste Backend
- [ ] **TC-UC02-001**: Buscar template por ID vÃ¡lido
  - **Dado**: Template ID existente
  - **Quando**: GET /api/v1/email-templates/{id}
  - **EntÃ£o**: Retorna HTTP 200 com todos os dados

- [ ] **TC-UC02-002**: Bloquear acesso multi-tenancy
  - **Dado**: Template do conglomerado B, usuÃ¡rio do conglomerado A
  - **Quando**: Tentar visualizar
  - **EntÃ£o**: Retorna HTTP 403 Forbidden

- [ ] **TC-UC02-003**: Calcular mÃ©tricas corretamente
  - **Dado**: 100 envios, 75 aberturas, 30 cliques
  - **Quando**: Buscar mÃ©tricas
  - **EntÃ£o**: Taxa abertura = 75%, Taxa clique = 30%

### CenÃ¡rios de Teste Frontend
- [ ] **TC-UC02-004**: Abas navegÃ¡veis
  - **Quando**: Clicar em abas Detalhes/MJML/Preview/VersÃµes/MÃ©tricas
  - **EntÃ£o**: ConteÃºdo de cada aba carrega corretamente

- [ ] **TC-UC02-005**: BotÃ£o "Editar" redireciona
  - **Quando**: Clicar em "Editar"
  - **EntÃ£o**: Redireciona para UC03-editar-template-email

---

## 12. Rastreabilidade

### Origem
- **RF-090**: SeÃ§Ã£o "Funcionalidades Principais"
- **RN-TPL-002-15**: Auditoria Completa de Envios (mÃ©tricas)

### Impacto
- **UC03-editar-template-email**: Acessado via botÃ£o "Editar"
- **UC05-preview-multi-device**: Preview renderizado na aba

---

**Ãšltima AtualizaÃ§Ã£o**: 2025-01-20

---

# UC03 - Editar Template de E-mail

## 1. CabeÃ§alho

| Item | DescriÃ§Ã£o |
|------|-----------|
| **RF** | RF-090 - Templates de E-mail Transacionais e Marketing |
| **CÃ³digo UC** | UC03 |
| **Nome** | Editar Template de E-mail |
| **Ator Principal** | Administrador, Marketing, Developer |
| **Complexidade** | Alta |
| **Estimativa Backend** | 8 horas (Command, Handler, Validator, Versioning logic) |
| **Estimativa Frontend** | 12 horas (Edit form, Monaco Editor, Preview, Diff viewer) |
| **Estimativa Testes** | 6 horas (Unit + Integration + E2E + Validation) |
| **VersÃ£o** | 1.0 |
| **Data** | 2025-01-20 |

---

## 2. Objetivo

Permitir que usuÃ¡rios editem templates de e-mail existentes, modificando nome, assunto, cÃ³digo MJML, JSON Schema de variÃ¡veis e configuraÃ§Ãµes de tracking. Cada ediÃ§Ã£o gera automaticamente uma nova versÃ£o (versionamento git-like) com mensagem de commit e diff.

---

## 3. PrÃ©-condiÃ§Ãµes

- [x] UsuÃ¡rio autenticado no sistema
- [x] UsuÃ¡rio possui permissÃ£o `EMAIL_TEMPLATES.EDIT`
- [x] Template existe no banco de dados
- [x] Template pertence ao conglomerado do usuÃ¡rio ou Ã© template global editÃ¡vel
- [x] Template NÃƒO estÃ¡ publicado OU usuÃ¡rio tem permissÃ£o `EMAIL_TEMPLATES.EDIT_PUBLISHED`

---

## 4. DependÃªncias de Desenvolvimento

### 4.1 RFs Externos
| RF | UC | Tipo | DescriÃ§Ã£o |
|----|-----|------|-----------|
| RF-001 | UC00-listar-configuracoes | Leitura | ConfiguraÃ§Ãµes de versionamento |
| RF-008 | UC00-listar-usuarios | Leitura | Validar usuÃ¡rio modificador |
| RF-063 | UC03-editar-template | HeranÃ§a | Versionamento automÃ¡tico ao editar |
| RF-063 | UC07-versionamento | Chamada | Criar nova versÃ£o ao salvar alteraÃ§Ãµes |

### 4.2 IntegraÃ§Ãµes Backend
- **PermissÃµes**: `EMAIL_TEMPLATES.EDIT` via RBAC
- **Versionamento**: Criar registro em `Email_Template_Versao` ao salvar
- **Diff Generation**: Calcular diff entre versÃ£o atual e anterior
- **Auditoria**: `Usuario_Modificacao`, `Dt_Modificacao` atualizados

### 4.3 DependÃªncias de UCs
| Depende de | Motivo |
|------------|--------|
| UC00-listar-templates-email | Selecionar template para editar |
| UC02-visualizar-template-email | Carregar dados do template no formulÃ¡rio |
| RF-063 UC07-versionamento | Criar nova versÃ£o ao editar |

### 4.4 Endpoints Chamados
- `GET /api/v1/email-templates/{id}` (carregar dados)
- `PUT /api/v1/email-templates/{id}` (salvar alteraÃ§Ãµes)
- `POST /api/v1/email-templates/{id}/versions` (criar nova versÃ£o)

---

## 5. Fluxo Principal

| Passo | Ator | AÃ§Ã£o | Sistema |
|-------|------|------|---------|
| 1 | UsuÃ¡rio | Clica em "Editar" (ğŸ“) na listagem ou visualizaÃ§Ã£o | Abre formulÃ¡rio de ediÃ§Ã£o preenchido |
| 2 | Sistema | Carrega dados do template | Preenche: Nome, Tipo, Assunto, MJML, JSON Schema, Tracking |
| 3 | UsuÃ¡rio | Modifica campos desejados | Valida sintaxe MJML/JSON em tempo real |
| 4 | UsuÃ¡rio | Clica em "Salvar" | Exibe modal de versionamento |
| 5 | UsuÃ¡rio | Preenche mensagem de commit | Ex: "Atualizado assunto para melhorar taxa de abertura" |
| 6 | UsuÃ¡rio | Seleciona tipo de mudanÃ§a (Major/Minor/Patch) | Sistema sugere tipo baseado em anÃ¡lise de mudanÃ§as |
| 7 | Sistema | Valida todos os campos | MJML compilÃ¡vel, JSON Schema vÃ¡lido |
| 8 | Sistema | Calcula diff entre versÃ£o atual e nova | Gera diff linha por linha (adiÃ§Ãµes/remoÃ§Ãµes) |
| 9 | Sistema | Incrementa versÃ£o (ex: 2.1 â†’ 2.2 para Minor) | Atualiza `Versao_Atual` no template |
| 10 | Sistema | Cria registro em `Email_Template_Versao` | Armazena: cÃ³digo anterior, diff, mensagem commit |
| 11 | Sistema | Atualiza template com novos dados | MantÃ©m histÃ³rico completo |
| 12 | Sistema | Exibe mensagem de sucesso | "Template atualizado para versÃ£o 2.2" |
| 13 | UsuÃ¡rio | Redirecionado para visualizaÃ§Ã£o | UC02-visualizar-template-email |

**Resultado**: Template editado com sucesso, nova versÃ£o criada, histÃ³rico preservado.

---

## 6. Fluxos Alternativos

### FA-01: Editar Template Publicado
- **Gatilho**: Template com `Fl_Publicado = true`
- **Fluxo**:
  1. Sistema exibe aviso: "Template publicado. AlteraÃ§Ãµes afetarÃ£o envios futuros."
  2. Checkbox obrigatÃ³rio: "Confirmo que entendo o impacto"
  3. Apenas Admin pode editar templates publicados
- **Resultado**: Template publicado editado com cuidado adicional

### FA-02: Preview Antes de Salvar
- **Gatilho**: UsuÃ¡rio clica em "Preview" durante ediÃ§Ã£o
- **Fluxo**:
  1. Sistema compila MJML temporariamente
  2. Renderiza preview em modal com dados de exemplo
  3. UsuÃ¡rio valida visualmente
  4. Fecha preview e continua editando
- **Resultado**: ValidaÃ§Ã£o visual antes de salvar

### FA-03: Comparar com VersÃ£o Anterior
- **Gatilho**: UsuÃ¡rio clica em "Ver Diff" antes de salvar
- **Fluxo**:
  1. Sistema exibe diff lado-a-lado: VersÃ£o atual | VersÃ£o editada
  2. Destaca linhas modificadas
  3. UsuÃ¡rio confirma mudanÃ§as
- **Resultado**: ConsciÃªncia clara das alteraÃ§Ãµes

### FA-04: Cancelar EdiÃ§Ã£o
- **Gatilho**: UsuÃ¡rio clica em "Cancelar"
- **Fluxo**:
  1. Sistema exibe confirmaÃ§Ã£o: "Descartar alteraÃ§Ãµes?"
  2. Se confirmar: retorna para visualizaÃ§Ã£o sem salvar
  3. Se cancelar: permanece na ediÃ§Ã£o
- **Resultado**: EdiÃ§Ã£o descartada sem criar nova versÃ£o

### FA-05: Editar Apenas ConfiguraÃ§Ãµes (Sem Nova VersÃ£o)
- **Gatilho**: UsuÃ¡rio altera apenas tracking (abertura/clique) ou tags
- **Fluxo**:
  1. Sistema detecta que conteÃºdo MJML nÃ£o mudou
  2. NÃ£o cria nova versÃ£o (apenas atualiza configuraÃ§Ãµes)
  3. Registra em log de auditoria
- **Resultado**: ConfiguraÃ§Ãµes atualizadas sem incrementar versÃ£o

### FA-06: Salvar como Rascunho
- **Gatilho**: UsuÃ¡rio clica em "Salvar Rascunho" (template publicado)
- **Fluxo**:
  1. Sistema cria cÃ³pia do template com sufixo " (Rascunho)"
  2. Marca `Fl_Publicado = false`
  3. UsuÃ¡rio edita rascunho sem afetar publicado
  4. ApÃ³s aprovaÃ§Ã£o, substitui versÃ£o publicada
- **Resultado**: EdiÃ§Ã£o segura sem impactar envios em produÃ§Ã£o

---

## 7. Fluxos de ExceÃ§Ã£o

### FE-01: Template NÃ£o Encontrado
- **Gatilho**: ID invÃ¡lido ou template deletado
- **AÃ§Ã£o**: Retornar HTTP 404 Not Found
- **Mensagem**: "Template nÃ£o encontrado."
- **RecuperaÃ§Ã£o**: Retornar para listagem

### FE-02: UsuÃ¡rio Sem PermissÃ£o
- **Gatilho**: UsuÃ¡rio sem `EMAIL_TEMPLATES.EDIT`
- **AÃ§Ã£o**: Retornar HTTP 403 Forbidden
- **Mensagem**: "VocÃª nÃ£o tem permissÃ£o para editar templates."
- **RecuperaÃ§Ã£o**: Contatar administrador

### FE-03: Template de Outro Conglomerado
- **Gatilho**: Tentar editar template de outro conglomerado
- **AÃ§Ã£o**: Retornar HTTP 403 Forbidden
- **Mensagem**: "VocÃª nÃ£o pode editar templates de outros conglomerados."
- **RecuperaÃ§Ã£o**: Retornar para listagem

### FE-04: MJML InvÃ¡lido ApÃ³s EdiÃ§Ã£o
- **Gatilho**: MJML editado nÃ£o compila
- **AÃ§Ã£o**: Bloquear salvamento
- **Mensagem**: "Erro de sintaxe MJML na linha 23: Tag <mj-button> sem atributo 'href'"
- **RecuperaÃ§Ã£o**: Corrigir sintaxe no editor

### FE-05: JSON Schema InvÃ¡lido
- **Gatilho**: Schema editado tem sintaxe JSON incorreta
- **AÃ§Ã£o**: Bloquear salvamento
- **Mensagem**: "JSON Schema invÃ¡lido: Esperado '}' na linha 15"
- **RecuperaÃ§Ã£o**: Corrigir JSON no editor

### FE-06: Conflito de ConcorrÃªncia
- **Gatilho**: Outro usuÃ¡rio editou template simultaneamente
- **AÃ§Ã£o**: Retornar HTTP 409 Conflict
- **Mensagem**: "Template foi modificado por outro usuÃ¡rio. Recarregue para ver mudanÃ§as."
- **RecuperaÃ§Ã£o**: Recarregar pÃ¡gina e refazer ediÃ§Ãµes

### FE-07: Mensagem de Commit Vazia
- **Gatilho**: UsuÃ¡rio tenta salvar sem mensagem de commit
- **AÃ§Ã£o**: Bloquear salvamento
- **Mensagem**: "Mensagem de commit Ã© obrigatÃ³ria (mÃ­n. 10 caracteres)"
- **RecuperaÃ§Ã£o**: Preencher mensagem descritiva

---

## 8. ValidaÃ§Ãµes de Campos

### 8.1 Campos ObrigatÃ³rios
| Campo | ValidaÃ§Ã£o | Mensagem de Erro |
|-------|-----------|------------------|
| Nome Template | 3-100 caracteres | "Nome do template Ã© obrigatÃ³rio (3-100 caracteres)" |
| Tipo Email | Enum vÃ¡lido | "Tipo de e-mail nÃ£o pode ser alterado apÃ³s criaÃ§Ã£o" |
| Assunto Template | 3-200 caracteres | "Assunto Ã© obrigatÃ³rio (3-200 caracteres)" |
| Corpo MJML | 10-100000 caracteres | "Corpo MJML Ã© obrigatÃ³rio" |
| JSON Schema VariÃ¡veis | JSON vÃ¡lido | "JSON Schema de variÃ¡veis Ã© obrigatÃ³rio" |
| Mensagem Commit | 10-500 caracteres | "Mensagem de commit obrigatÃ³ria (10-500 caracteres)" |
| Tipo MudanÃ§a | Enum (Major/Minor/Patch) | "Selecione o tipo de mudanÃ§a (Major/Minor/Patch)" |

### 8.2 Campos ImutÃ¡veis (NÃ£o EditÃ¡veis)
| Campo | Motivo |
|-------|--------|
| Tipo Email | MudanÃ§a de tipo impacta integraÃ§Ãµes (Transacional â†’ Marketing requer revalidaÃ§Ã£o) |
| Id_Conglomerado | Multi-tenancy fixo (nÃ£o transferir entre conglomerados) |
| Usuario_Criacao | Criador original deve ser preservado |
| Dt_Criacao | Data de criaÃ§Ã£o nÃ£o pode ser alterada |

### 8.3 ValidaÃ§Ãµes de NegÃ³cio
| Regra | DescriÃ§Ã£o | Mensagem |
|-------|-----------|----------|
| **VN-01**: Nome Ãºnico | Nome Ãºnico por conglomerado (exceto prÃ³prio template) | "JÃ¡ existe outro template com este nome" |
| **VN-02**: MJML compilÃ¡vel | MJML deve compilar sem erros | "Erro de sintaxe MJML: {detalhes}" |
| **VN-03**: JSON Schema vÃ¡lido | Schema deve ser JSON vÃ¡lido | "JSON Schema invÃ¡lido: {detalhes}" |
| **VN-04**: VariÃ¡veis consistentes | VariÃ¡veis usadas devem estar no schema | "VariÃ¡vel '{nome}' nÃ£o declarada no schema" |
| **VN-05**: Versionamento incremental | VersÃ£o nova > versÃ£o atual | "VersÃ£o deve ser maior que 2.1 (atual)" |

### 8.4 Fluxos Alternativos de ValidaÃ§Ã£o

#### FA-VAL-01: Campos ObrigatÃ³rios NÃ£o Preenchidos
- **Gatilho**: Tentar salvar com campos vazios
- **AÃ§Ã£o**: Highlight em vermelho nos campos vazios
- **Mensagem**: "Preencha todos os campos obrigatÃ³rios"
- **RecuperaÃ§Ã£o**: Preencher campos destacados

#### FA-VAL-02: MJML InvÃ¡lido
- **Gatilho**: MJML nÃ£o compila
- **AÃ§Ã£o**: Editor destaca linha com erro
- **Mensagem**: "Linha 23: Tag <mj-button> sem 'href'"
- **RecuperaÃ§Ã£o**: Corrigir sintaxe

#### FA-VAL-03: Tamanho Excedido
- **Gatilho**: MJML > 100KB
- **AÃ§Ã£o**: Bloquear salvamento
- **Mensagem**: "Template muito grande (105KB). MÃ¡ximo: 100KB"
- **RecuperaÃ§Ã£o**: Refatorar em componentes menores

#### FA-VAL-04: Mensagem de Commit Muito Curta
- **Gatilho**: Mensagem < 10 caracteres
- **AÃ§Ã£o**: Bloquear salvamento
- **Mensagem**: "Mensagem muito curta. Descreva as mudanÃ§as (mÃ­n. 10 caracteres)"
- **RecuperaÃ§Ã£o**: Escrever mensagem descritiva

---

## 9. Regras de NegÃ³cio

### RN-UC03-001: Versionamento AutomÃ¡tico ObrigatÃ³rio
- **DescriÃ§Ã£o**: Toda ediÃ§Ã£o de conteÃºdo cria nova versÃ£o
- **ValidaÃ§Ã£o**:
  - Se MJML/Assunto/Schema mudaram: criar nova versÃ£o
  - Se apenas tracking/tags mudaram: nÃ£o criar versÃ£o (sÃ³ update)
  - Registrar diff completo em `Email_Template_Versao`

### RN-UC03-002: Tipo de MudanÃ§a SemÃ¢ntico
- **DescriÃ§Ã£o**: Sistema sugere tipo de mudanÃ§a baseado em anÃ¡lise
- **ValidaÃ§Ã£o**:
  - **Major** (3.0): MudanÃ§a breaking (schema incompatÃ­vel com anterior)
  - **Minor** (2.1): Nova feature (variÃ¡vel adicionada ao schema)
  - **Patch** (2.0.1): CorreÃ§Ã£o de bug (typo no assunto, ajuste de layout)

### RN-UC03-003: Templates Publicados Requerem ConfirmaÃ§Ã£o
- **DescriÃ§Ã£o**: Editar template publicado exige confirmaÃ§Ã£o explÃ­cita
- **ValidaÃ§Ã£o**:
  - Modal de confirmaÃ§Ã£o obrigatÃ³rio
  - Checkbox: "Confirmo que entendo o impacto em envios futuros"
  - Apenas Admin pode editar templates publicados

### RN-UC03-004: Preservar HistÃ³rico Completo
- **DescriÃ§Ã£o**: Todas as versÃµes anteriores devem ser preservadas
- **ValidaÃ§Ã£o**:
  - Nunca deletar registros de `Email_Template_Versao`
  - Soft delete do template (`Fl_Ativo = 0`) mantÃ©m histÃ³rico

### RN-UC03-005: Multi-Tenancy ImutÃ¡vel
- **DescriÃ§Ã£o**: NÃ£o permitir transferir template entre conglomerados via ediÃ§Ã£o
- **ValidaÃ§Ã£o**: Campo `Id_Conglomerado` read-only no formulÃ¡rio

---

## 10. Requisitos NÃ£o-Funcionais

### Performance
- Salvamento (incluindo versionamento): < 2 segundos
- Diff generation: < 1 segundo para templates de atÃ© 50KB
- Preview em tempo real: Debounce 1s

### SeguranÃ§a
- ValidaÃ§Ã£o de permissÃµes antes de carregar formulÃ¡rio
- Concurrency control via Optimistic Locking (`RowVersion`)
- XSS protection no HTML gerado

### Usabilidade
- Autosave draft a cada 30 segundos (opcional)
- Indicador de mudanÃ§as nÃ£o salvas
- Atalho Ctrl+S para salvar

### Auditoria
- Log completo de ediÃ§Ãµes com usuÃ¡rio, timestamp, diff
- Rastreabilidade de quem fez cada mudanÃ§a

---

## 11. Interface UI (Wireframes)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Editar Template: Boas-vindas                 [Salvar] [Preview] [x] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Nome*: [Boas-vindas ao IControlIT_____________________]             â”‚
â”‚ Tipo: [Transacional] (nÃ£o editÃ¡vel)                                 â”‚
â”‚ Assunto*: [Bem-vindo, {{Nome}}! Seu acesso ao IControlIT___]        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Editor MJML:                          â”‚ Preview (Desktop):          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ <mjml>                          â”‚   â”‚ â”‚ Bem-vindo, JoÃ£o!        â”‚ â”‚
â”‚ â”‚   <mj-body>                     â”‚   â”‚ â”‚                         â”‚ â”‚
â”‚ â”‚     <mj-section>                â”‚   â”‚ â”‚ Seu acesso foi criado!  â”‚ â”‚
â”‚ â”‚       <mj-text>                 â”‚   â”‚ â”‚                         â”‚ â”‚
â”‚ â”‚         Bem-vindo, {{Nome}}!    â”‚   â”‚ â”‚ [Acessar Plataforma]    â”‚ â”‚
â”‚ â”‚       </mj-text>                â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”‚     </mj-section>               â”‚   â”‚                             â”‚
â”‚ â”‚   </mj-body>                    â”‚   â”‚                             â”‚
â”‚ â”‚ </mjml>                         â”‚   â”‚ [Desktop] [Tablet] [Mobile] â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                             â”‚
â”‚                                        â”‚                             â”‚
â”‚ JSON Schema VariÃ¡veis*:                â”‚                             â”‚
â”‚ { "nome": "string", "email": "string" }â”‚                             â”‚
â”‚                                        â”‚                             â”‚
â”‚ Tracking: [âœ“] Abertura  [âœ—] Clique   â”‚                             â”‚
â”‚                                        â”‚                             â”‚
â”‚ âš ï¸ Template publicado. AlteraÃ§Ãµes afetarÃ£o envios futuros.           â”‚
â”‚ [âœ“] Confirmo que entendo o impacto                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Modal de Salvamento (ao clicar "Salvar"):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Criar Nova VersÃ£o                      [x] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Mensagem de commit*:                        â”‚
â”‚ [Atualizado assunto para melhorar taxa de _â”‚
â”‚  abertura___________________________________]â”‚
â”‚                                             â”‚
â”‚ Tipo de mudanÃ§a*:                           â”‚
â”‚ âšª Major (3.0) - MudanÃ§a breaking           â”‚
â”‚ âš« Minor (2.2) - Nova feature (sugestÃ£o)    â”‚
â”‚ âšª Patch (2.1.1) - CorreÃ§Ã£o de bug          â”‚
â”‚                                             â”‚
â”‚        [Cancelar] [Salvar e Criar VersÃ£o]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 12. Mensagens ao UsuÃ¡rio

### Sucesso
- âœ… "Template atualizado para versÃ£o 2.2"
- âœ… "Rascunho salvo automaticamente Ã s 14:35"

### Aviso
- âš ï¸ "Template publicado. AlteraÃ§Ãµes afetarÃ£o envios futuros."
- âš ï¸ "VocÃª tem alteraÃ§Ãµes nÃ£o salvas. Salvar antes de sair?"

### Erro
- âŒ "Erro de sintaxe MJML na linha 23: Tag <mj-button> sem 'href'"
- âŒ "JSON Schema invÃ¡lido: Esperado '}' na linha 15"
- âŒ "Mensagem de commit Ã© obrigatÃ³ria (mÃ­n. 10 caracteres)"
- âŒ "Template foi modificado por outro usuÃ¡rio. Recarregue para ver mudanÃ§as."

---

## 13. Testes

### CenÃ¡rios de Teste Backend
- [ ] **TC-UC03-001**: Editar template vÃ¡lido
  - **Dado**: Template existente, dados vÃ¡lidos
  - **Quando**: PUT /api/v1/email-templates/{id}
  - **EntÃ£o**: HTTP 200, nova versÃ£o criada

- [ ] **TC-UC03-002**: Versionamento automÃ¡tico
  - **Dado**: Template versÃ£o 2.1, ediÃ§Ã£o com mudanÃ§as no MJML
  - **Quando**: Salvar com tipo "Minor"
  - **EntÃ£o**: `Versao_Atual = 2.2`, registro em `Email_Template_Versao`

- [ ] **TC-UC03-003**: Diff generation
  - **Dado**: VersÃ£o anterior com MJML A, nova com MJML B
  - **Quando**: Salvar ediÃ§Ã£o
  - **EntÃ£o**: Diff calculado e armazenado em `Email_Template_Versao.Diff`

- [ ] **TC-UC03-004**: Bloquear ediÃ§Ã£o multi-tenancy
  - **Dado**: Template do conglomerado B, usuÃ¡rio do conglomerado A
  - **Quando**: Tentar editar
  - **EntÃ£o**: HTTP 403 Forbidden

- [ ] **TC-UC03-005**: Validar MJML invÃ¡lido
  - **Dado**: MJML com tag nÃ£o fechada
  - **Quando**: Tentar salvar
  - **EntÃ£o**: HTTP 400 com detalhes do erro

### CenÃ¡rios de Teste Frontend
- [ ] **TC-UC03-006**: FormulÃ¡rio carrega preenchido
  - **Quando**: Acessar ediÃ§Ã£o de template
  - **EntÃ£o**: Campos preenchidos com dados atuais

- [ ] **TC-UC03-007**: Preview atualiza em tempo real
  - **Quando**: Editar MJML
  - **EntÃ£o**: Preview atualiza apÃ³s 1s (debounce)

- [ ] **TC-UC03-008**: Modal de versionamento ao salvar
  - **Quando**: Clicar em "Salvar"
  - **EntÃ£o**: Modal exibe campos: Mensagem commit, Tipo mudanÃ§a

- [ ] **TC-UC03-009**: ConfirmaÃ§Ã£o ao cancelar
  - **Quando**: Clicar em "Cancelar" com alteraÃ§Ãµes nÃ£o salvas
  - **EntÃ£o**: Modal "Descartar alteraÃ§Ãµes?"

### CenÃ¡rios de ValidaÃ§Ã£o
- [ ] **TC-UC03-010**: FA-VAL-01 - Campos obrigatÃ³rios vazios
  - **Quando**: Tentar salvar sem assunto
  - **EntÃ£o**: Campo assunto destacado em vermelho

- [ ] **TC-UC03-011**: FA-VAL-02 - MJML invÃ¡lido
  - **Quando**: MJML com sintaxe incorreta
  - **EntÃ£o**: Editor destaca linha, painel de erros exibe detalhes

- [ ] **TC-UC03-012**: FA-VAL-04 - Mensagem commit curta
  - **Quando**: Mensagem < 10 caracteres
  - **EntÃ£o**: Bloqueia salvamento, exibe erro

---

## 14. Rastreabilidade

### Origem
- **RF-090**: SeÃ§Ã£o "Funcionalidades Principais"
- **RN-TPL-002-01**: Templates Responsivos ObrigatÃ³rios
- **RN-TPL-002-02**: ValidaÃ§Ã£o de VariÃ¡veis via JSON Schema
- **RF-063**: Versionamento Git-like (heranÃ§a)

### Impacto
- **UC00-listar-templates-email**: Template atualizado aparece na listagem
- **UC02-visualizar-template-email**: Detalhes atualizados
- **RF-063 UC07-versionamento**: Nova versÃ£o criada

---

**Ãšltima AtualizaÃ§Ã£o**: 2025-01-20

---

# UC04 - Inativar Template de E-mail

## 1. CabeÃ§alho

| Item | DescriÃ§Ã£o |
|------|-----------|
| **RF** | RF-090 - Templates de E-mail Transacionais e Marketing |
| **CÃ³digo UC** | UC04 |
| **Nome** | Inativar/Reativar Template de E-mail |
| **Ator Principal** | Administrador, Marketing |
| **Complexidade** | Baixa |
| **Estimativa Backend** | 2 horas (Command, Handler, Soft Delete) |
| **Estimativa Frontend** | 2 horas (Modal confirmaÃ§Ã£o, Toggle ativo/inativo) |
| **Estimativa Testes** | 2 horas (Unit + Integration + E2E) |
| **VersÃ£o** | 1.0 |
| **Data** | 2025-01-20 |

---

## 2. Objetivo

Permitir que usuÃ¡rios inativem templates de e-mail que nÃ£o estÃ£o mais em uso (soft delete), impedindo que sejam usados em novos envios, mas preservando histÃ³rico e permitindo reativaÃ§Ã£o futura.

---

## 3. Fluxo Principal

| Passo | Ator | AÃ§Ã£o | Sistema |
|-------|------|------|---------|
| 1 | UsuÃ¡rio | Clica em "Inativar" (ğŸ—‘ï¸) na listagem | Exibe modal de confirmaÃ§Ã£o |
| 2 | UsuÃ¡rio | Confirma inativaÃ§Ã£o | Verifica se template nÃ£o estÃ¡ em uso ativo |
| 3 | Sistema | Marca `Fl_Ativo = 0` | Template nÃ£o aparece mais em listagem padrÃ£o |
| 4 | Sistema | Registra em log de auditoria | Quem inativou, quando, motivo (opcional) |
| 5 | Sistema | Exibe mensagem de sucesso | "Template inativado com sucesso" |

**Resultado**: Template inativado, nÃ£o utilizÃ¡vel em novos envios.

---

## 4. Fluxos Alternativos

### FA-01: Reativar Template
- **Gatilho**: UsuÃ¡rio clica em "Reativar" (âœ…) em template inativo
- **Fluxo**:
  1. Sistema marca `Fl_Ativo = 1`
  2. Template volta a aparecer na listagem
  3. Mensagem: "Template reativado com sucesso"

### FA-02: Inativar Template em Uso
- **Gatilho**: Template com envios agendados ou campanhas ativas
- **Fluxo**:
  1. Sistema detecta uso ativo
  2. Exibe aviso: "Template usado em 3 campanhas agendadas. Deseja continuar?"
  3. Se confirmar: inativa e cancela campanhas pendentes
  4. Se cancelar: mantÃ©m ativo

---

## 5. Regras de NegÃ³cio

### RN-UC04-001: Soft Delete ObrigatÃ³rio
- **DescriÃ§Ã£o**: Templates NUNCA sÃ£o deletados fisicamente (preservar histÃ³rico)
- **ValidaÃ§Ã£o**: Flag `Fl_Ativo = 0`, dados preservados

### RN-UC04-002: Templates Inativos NÃ£o UsÃ¡veis
- **DescriÃ§Ã£o**: Templates inativos nÃ£o podem ser usados em novos envios
- **ValidaÃ§Ã£o**: Filtro em queries de seleÃ§Ã£o de templates

---

## 6. Interface UI

```
Modal de ConfirmaÃ§Ã£o:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Inativar Template?              [x]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Template: Boas-vindas               â”‚
â”‚                                     â”‚
â”‚ âš ï¸ Template nÃ£o poderÃ¡ ser usado emâ”‚
â”‚    novos envios.                    â”‚
â”‚                                     â”‚
â”‚ Motivo (opcional):                  â”‚
â”‚ [Template desatualizado_________]   â”‚
â”‚                                     â”‚
â”‚     [Cancelar] [Sim, Inativar]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. Testes

- [ ] **TC-UC04-001**: Inativar template vÃ¡lido
  - **Quando**: DELETE /api/v1/email-templates/{id}
  - **EntÃ£o**: `Fl_Ativo = 0`, HTTP 200

- [ ] **TC-UC04-002**: Reativar template
  - **Quando**: POST /api/v1/email-templates/{id}/reactivate
  - **EntÃ£o**: `Fl_Ativo = 1`, HTTP 200

- [ ] **TC-UC04-003**: Templates inativos nÃ£o aparecem em listagem padrÃ£o
  - **Dado**: Template inativo
  - **Quando**: GET /api/v1/email-templates
  - **EntÃ£o**: Template nÃ£o retornado (exceto se filtro `includeInactive=true`)

---

**Ãšltima AtualizaÃ§Ã£o**: 2025-01-20

---

# UC05 - Atribuir PermissÃµes ao Perfil
## ğŸ“‹ Objetivo
Permitir que administradores adicionem ou removam permissÃµes permanentes e temporÃ¡rias em um perfil, com suporte a permissÃµes crÃ­ticas que requerem justificativa.

## ğŸ‘¤ Atores
- Ator Principal: Administrador com permissÃ£o perfis:perfil:update
- Atores SecundÃ¡rios: Sistema de PropagaÃ§Ã£o (heranÃ§a em filhos), Sistema de Cache

## ğŸ¯ PrÃ©-condiÃ§Ãµes
- â˜’ UsuÃ¡rio autenticado no sistema
- â˜’ UsuÃ¡rio possui permissÃ£o perfis:perfil:update
- â˜’ Perfil existe e Ã© editÃ¡vel
- â˜’ PermissÃµes existem no banco de dados

## â–¶ï¸ Fluxo Principal
- UsuÃ¡rio acessa abas â€œPermissÃµesâ€ no detalhes do perfil
- Sistema exibe tree view tristate com todas as permissÃµes:
- Categorias: usuarios, contratos, faturas, relatorios (expansÃ­vel)
- Recursos dentro de cada categoria
- UsuÃ¡rio marca permissÃµes desejadas:
- PermissÃµes prÃ³prias (checkbox normal)
- PermissÃµes herdadas (checkbox desabilitado com badge)
- Para permissÃ£o crÃ­tica, sistema exibe modal:
- â€œEsta permissÃ£o Ã© crÃ­tica. Justificativa obrigatÃ³ria (mÃ­n. 20 chars):â€
- UsuÃ¡rio preenche justificativa
- UsuÃ¡rio define tipo de permissÃ£o:
- Permanente (sem data fim)
- TemporÃ¡ria: seleciona Data InÃ­cio (opcional) e Data Fim
- UsuÃ¡rio clica â€œSalvar PermissÃµesâ€
- Sistema valida:
- Justificativa preenchida para permissÃµes crÃ­ticas
- Datas vÃ¡lidas (inÃ­cio < fim, fim > hoje)
- Sistema atualiza tabela RolePermissions
- Sistema propaga permissÃµes a todos os filhos (marca como herdadas)
- Sistema invalida cache Redis de usuÃ¡rios
- Resultado: PermissÃµes atribuÃ­das com sucesso

## ğŸ”€ Fluxos Alternativos
### FA01 - Atribuir PermissÃ£o TemporÃ¡ria
UsuÃ¡rio seleciona Data Fim = 2025-12-31. Sistema cria job para revogar automaticamente.
### FA02 - Remover PermissÃ£o
UsuÃ¡rio desseleciona permissÃ£o. Sistema remove de RolePermissions (se nÃ£o for herdada).
### FA03 - PropagaÃ§Ã£o em HeranÃ§a
Ao adicionar permissÃ£o em perfil pai, filhos herdam automaticamente (marcadas como Herdada=true).

## âš ï¸ Fluxos de ExceÃ§Ã£o
### FE01 - PermissÃ£o CrÃ­tica Sem Justificativa
Sistema rejeita com: â€œPermissÃ£o crÃ­tica requer justificativa (mÃ­n. 20 caracteres).â€
### FE02 - Data InvÃ¡lida
Se Data Fim < Data InÃ­cio, sistema exibe: â€œData de tÃ©rmino deve ser apÃ³s data de inÃ­cio.â€
### FE03 - Tentar Remover PermissÃ£o Herdada
Sistema desabilita checkbox e exibe: â€œPermissÃ£o herdada do perfil pai. Remova do pai para remover dos filhos.â€
### FE04 - Data Passada
Se Data Fim Ã© anterior a hoje, sistema rejeita com mensagem de erro.

## âœ… PÃ³s-condiÃ§Ãµes
- âœ… PermissÃµes atualizadas na tabela RolePermissions
- âœ… PermissÃµes propagadas a filhos (se aplicÃ¡vel)
- âœ… Jobs agendados para expiraÃ§Ã£o (permissÃµes temporÃ¡rias)
- âœ… Auditoria registrada
- âœ… Cache Redis invalidado

## ğŸ“ Regras de NegÃ³cio

## ğŸ§ª CenÃ¡rios de Teste
- CEN501 - Adicionar permissÃ£o simples
- CEN502 - Adicionar permissÃ£o crÃ­tica com justificativa
- CEN503 - Tentar adicionar permissÃ£o crÃ­tica sem justificativa (HTTP 400)
- CEN504 - Adicionar permissÃ£o temporÃ¡ria com data fim
- CEN505 - Remover permissÃ£o prÃ³pria
- CEN506 - Tentar remover permissÃ£o herdada (desabilitado)
- CEN507 - Adicionar permissÃ£o em pai â†’ verifica propagaÃ§Ã£o para filhos
- CEN508 - Validar datas (inÃ­cio < fim < futuro)
- CEN509 - Validar justificativa com < 20 caracteres (HTTP 400)
- CEN510 - Verificar atualizaÃ§Ã£o de cache apÃ³s salvar
Total: 10 cenÃ¡rios | Status: Documentado

## ğŸ“Š Rastreabilidade

Ãšltima AtualizaÃ§Ã£o: 2025-11-06

---

## HistÃ³rico de AlteraÃ§Ãµes

| VersÃ£o | Data | Autor | DescriÃ§Ã£o |
|--------|------|-------|-----------|
| 1.0 | 2025-12-17 | Sistema | ConsolidaÃ§Ã£o de 6 casos de uso |
