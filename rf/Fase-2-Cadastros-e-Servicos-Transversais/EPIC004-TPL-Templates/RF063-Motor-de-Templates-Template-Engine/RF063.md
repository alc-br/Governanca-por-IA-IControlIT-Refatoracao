# RF063 - Motor de Templates (Template Engine)

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC004-TPL-Templates
**Fase**: Fase-2-Cadastros-e-Servicos-Transversais

---

## 1. OBJETIVO DO REQUISITO

Prover um motor de processamento de templates dinâmicos com sintaxe Liquid/Handlebars para geração de e-mails, relatórios, documentos e notificações, permitindo customização por cliente, versionamento, preview em tempo real e suporte multi-idioma.

Este documento define **o que o sistema deve fazer** em termos de processamento, validação, versionamento e renderização de templates, sem especificar a tecnologia de implementação.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Parser de sintaxe Liquid (variáveis, condicionais, loops)
- [x] Contexto de dados tipado para renderização
- [x] Filtros customizados (currency, formatarData, truncar)
- [x] Preview em tempo real com dados de teste
- [x] Versionamento de templates com rollback
- [x] Validação de sintaxe Liquid
- [x] Testes A/B de templates
- [x] Herança de templates (layout base + template filho)
- [x] Parciais reutilizáveis (header, footer, assinatura)
- [x] Internacionalização (helper `{{ 't' }}` para traduções)
- [x] Sanitização HTML contra XSS
- [x] Cache de templates compilados (Redis)
- [x] Documentação automática de variáveis disponíveis
- [x] Auditoria de uso de templates
- [x] Controle de acesso por tenant

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (editor de templates)
- Tecnologia de renderização (Liquid.NET, Handlebars.NET, etc.)
- Infraestrutura de e-mail (SMTP, SendGrid, etc.)
- Armazenamento de arquivos gerados (PDF, DOCX)
- Integração com sistemas externos de documentos

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-----|---------|
| Template | Documento com marcações dinâmicas (variáveis, condicionais, loops) |
| Contexto | Objeto com dados disponíveis para renderização no template |
| Filtro | Função helper para formatação de valores (currency, data, truncar) |
| Parser | Motor que interpreta sintaxe Liquid e gera HTML/texto final |
| Versão | Snapshot do conteúdo do template em um momento específico |
| Parcial | Componente reutilizável (header, footer) incluído em templates |
| Layout Base | Template pai do qual outros templates podem herdar estrutura |

---

## 4. FUNCIONALIDADES COBERTAS

1. Processar template Liquid com contexto de dados
2. Aplicar filtros customizados em variáveis
3. Gerar preview em tempo real com dados de teste
4. Versionar templates e permitir rollback
5. Validar sintaxe Liquid antes de salvar
6. Criar variações de templates para testes A/B
7. Permitir herança de templates (layout base)
8. Criar e reutilizar parciais
9. Renderizar texto multi-idioma com helper `{{ 't' }}`
10. Sanitizar HTML renderizado contra XSS
11. Cachear templates compilados
12. Documentar variáveis disponíveis automaticamente
13. Rastrear uso de templates (auditoria)
14. Controlar permissões de acesso por tenant

---

## 5. REGRAS DE NEGÓCIO

### RN-RF063-001 — Sintaxe Liquid Obrigatória

**Descrição**: Todo template deve utilizar sintaxe Liquid (Shopify) para marcações dinâmicas.

**Justificativa**: Padronização, portabilidade e ampla adoção no mercado.

**Critério de Aceite**:
- Variáveis: `{{ usuario.nome }}`
- Condicionais: `{% if condicao %}...{% endif %}`
- Loops: `{% for item in lista %}...{% endfor %}`
- Filtros: `{{ valor | currency }}`

---

### RN-RF063-002 — Contexto de Dados Tipado

**Descrição**: O contexto de renderização deve ser um objeto tipado com propriedades bem definidas.

**Justificativa**: Garantir que templates tenham acesso apenas a dados autorizados.

**Critério de Aceite**:
- Contexto contém objetos como `Usuario`, `Solicitacao`, `Empresa`
- Propriedades personalizadas podem ser adicionadas via `Custom` dictionary
- Contexto vazio não deve travar renderização (gerar placeholders)

---

### RN-RF063-003 — Filtros Customizados Obrigatórios

**Descrição**: O sistema deve fornecer filtros de formatação: `currency`, `formatarData`, `truncar`.

**Justificativa**: Facilitar formatação sem lógica complexa no template.

**Critério de Aceite**:
- `{{ 1234.56 | currency }}` → `R$ 1.234,56`
- `{{ data | formatarData: 'dd/MM/yyyy' }}` → `14/01/2025`
- `{{ texto | truncar: 50 }}` → Texto com máximo 50 caracteres + "..."

---

### RN-RF063-004 — Preview em Tempo Real

**Descrição**: O sistema deve gerar preview do template com dados de teste antes de salvar.

**Justificativa**: Evitar erros em produção, permitir validação visual.

**Critério de Aceite**:
- Preview mostra HTML renderizado ao lado do código Liquid
- Erros de sintaxe são destacados no preview
- Variáveis não encontradas mostram placeholder (ex: `[variavel.ausente]`)

---

### RN-RF063-005 — Versionamento Obrigatório

**Descrição**: Toda alteração em template deve criar nova versão, preservando histórico.

**Justificativa**: Rastreabilidade, auditoria, possibilidade de rollback.

**Critério de Aceite**:
- Versões numeradas sequencialmente (1, 2, 3...)
- Apenas uma versão pode estar ativa por vez
- Rollback para versão anterior deve ser possível
- Histórico preserva usuário, data e conteúdo

---

### RN-RF063-006 — Validação de Sintaxe Bloqueante

**Descrição**: Templates com sintaxe Liquid inválida não podem ser salvos.

**Justificativa**: Prevenir erros em produção.

**Critério de Aceite**:
- Tags não fechadas → rejeição
- Filtros inexistentes → rejeição
- Variáveis malformadas → rejeição
- Mensagem de erro clara e localizada

---

### RN-RF063-007 — Testes A/B de Templates

**Descrição**: O sistema deve permitir criar variações de um template para testes A/B.

**Justificativa**: Experimentação de conteúdo, otimização de conversão.

**Critério de Aceite**:
- Variação tem referência ao template original
- Distribuição percentual configurável (ex: 50% variação A, 50% variação B)
- Métricas de uso devem ser rastreadas por variação

---

### RN-RF063-008 — Herança de Templates (Layout Base)

**Descrição**: Templates filhos podem herdar estrutura de um layout base.

**Justificativa**: Evitar duplicação de código, manutenibilidade.

**Critério de Aceite**:
- Layout base define blocos (`{% block conteudo %}{% endblock %}`)
- Template filho sobrescreve blocos (`{% extends 'layout-base' %}`)
- Herança funciona recursivamente (layout → master → filho)

---

### RN-RF063-009 — Parciais Reutilizáveis

**Descrição**: O sistema deve suportar inclusão de parciais (header, footer, assinatura).

**Justificativa**: Reutilização de código, consistência visual.

**Critério de Aceite**:
- Parcial pode ser incluída com `{% include 'parcial-nome' %}`
- Parciais podem receber parâmetros (`{% include 'header', titulo: 'Bem-vindo' %}`)
- Parciais têm acesso ao contexto global

---

### RN-RF063-010 — Internacionalização (Helper `t`)

**Descrição**: Templates devem suportar traduções via helper `{{ 't' }}`.

**Justificativa**: Suporte multi-idioma sem duplicar templates.

**Critério de Aceite**:
- `{{ 't' "email.saudacao" }}` → busca tradução no idioma do contexto
- Fallback para idioma padrão se tradução não existir
- Interpolação de variáveis: `{{ 't' "email.boas_vindas", nome: usuario.nome }}`

---

### RN-RF063-011 — Sanitização HTML Contra XSS

**Descrição**: Variáveis renderizadas devem ser sanitizadas automaticamente.

**Justificativa**: Segurança contra Cross-Site Scripting (XSS).

**Critério de Aceite**:
- `{{ usuario.nome }}` → escape automático de HTML
- `{{ usuario.bio | raw }}` → desabilita sanitização (uso consciente)
- Scripts maliciosos em variáveis devem ser bloqueados

---

### RN-RF063-012 — Cache de Templates Compilados (Redis)

**Descrição**: Templates compilados devem ser armazenados em cache distribuído.

**Justificativa**: Performance, evitar reprocessamento a cada renderização.

**Critério de Aceite**:
- Template compilado armazenado no Redis após primeira renderização
- Cache invalidado ao salvar nova versão
- TTL configurável (padrão: 1 hora)
- Cache miss → recompila e armazena

---

### RN-RF063-013 — Documentação Automática de Variáveis

**Descrição**: O sistema deve listar automaticamente todas as variáveis disponíveis no contexto.

**Justificativa**: Facilitar criação de templates, autodocumentação.

**Critério de Aceite**:
- Lista exibida no editor de templates
- Variáveis agrupadas por objeto (Usuario, Solicitacao, etc.)
- Tipo de cada propriedade exibido (string, number, date, etc.)

---

### RN-RF063-014 — Auditoria de Uso de Templates

**Descrição**: O sistema deve rastrear quando e onde cada template foi utilizado.

**Justificativa**: Compliance, debugging, métricas de uso.

**Critério de Aceite**:
- Registro de uso contém: template ID, versão, contexto, data, usuário
- Logs preservados por 7 anos (LGPD)
- Busca por template ou período

---

### RN-RF063-015 — Isolamento Multi-Tenant

**Descrição**: Cada tenant deve ter acesso apenas aos seus próprios templates.

**Justificativa**: Segurança, isolamento de dados.

**Critério de Aceite**:
- Templates filtrados automaticamente por `EmpresaId`
- Tentativa de acesso a template de outro tenant → HTTP 403
- Templates globais (sistema) acessíveis por todos

---

## 6. ESTADOS DA ENTIDADE

| Estado | Descrição |
|------|-----------|
| draft | Template criado, não publicado |
| active | Template ativo, pode ser usado em produção |
| archived | Template arquivado, não disponível para uso |
| testing | Template em fase de testes A/B |

### Transições permitidas

| De | Para |
|---|---|
| draft | active |
| draft | archived |
| active | archived |
| active | testing |
| testing | active |
| testing | archived |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre |
|------|--------------|
| template.criado | Após criação de novo template |
| template.publicado | Quando template passa de draft → active |
| template.versionado | Quando nova versão é criada |
| template.renderizado | Quando template é processado com contexto |
| template.arquivado | Quando template é movido para archived |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhum template pode ser renderizado sem validação de sintaxe
- Nenhuma variável não-sanitizada pode ser renderizada sem flag explícita (`raw`)
- Erros de renderização devem ser logados mas não travar o sistema
- Auditoria deve registrar quem criou, quando e o que mudou
- Cache deve ser invalidado automaticamente ao alterar template

---

## 9. SEGURANÇA

- Validação de sintaxe obrigatória (prevenir injection)
- Sanitização HTML automática (prevenir XSS)
- Controle de permissões RBAC
- Isolamento multi-tenant
- Auditoria completa de operações

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- UC-RF063.md (Casos de Uso)
- MD-RF063.md (Modelo de Dados)
- TC-RF063.yaml (Casos de Teste)
- MT-RF063.yaml (Massas de Teste)

---

## 11. RASTREABILIDADE

| Artefato | Gerado |
|--------|-------|
| Casos de Uso | Obrigatório |
| Modelo de Dados | Obrigatório |
| Casos de Teste | Obrigatório |
| Massas de Teste | Obrigatório |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|------|------|----------|------|
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0 - Separação RF/RL completa, contrato funcional moderno | Agência ALC - alc.dev.br |
| 1.0 | 2025-01-14 | Versão inicial com 15 regras de negócio | Agência ALC - alc.dev.br |
