# =============================================
# UC - Casos de Uso RF065 - Templates de Relatórios (Excel/PDF)
# Versão: 2.0
# Autor: Agência ALC - alc.dev.br
# =============================================

uc:
  rf: "RF065"
  versao: "2.0"
  data: "2025-12-31"

casos_de_uso:

  - id: "UC00"
    nome: "Listar Templates de Relatórios"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      rf_items:
        - "RF-CRUD-02"
      uc_items:
        - id: "FP-UC00-001"
          title: "Usuário acessa a funcionalidade Templates de Relatórios pelo menu"
          required: true
        - id: "FP-UC00-002"
          title: "Sistema valida permissão TPL.RELATORIOS.VIEW"
          required: true
        - id: "FP-UC00-003"
          title: "Sistema carrega templates do tenant com filtro de permissão"
          required: true
        - id: "FP-UC00-004"
          title: "Sistema aplica paginação (50 registros por página)"
          required: true
        - id: "FP-UC00-005"
          title: "Sistema exibe lista com cards e botões de ação"
          required: true
        - id: "FA-UC00-001"
          title: "Buscar por nome ou categoria"
          required: false
        - id: "FA-UC00-002"
          title: "Filtrar por formato (Excel/PDF/CSV)"
          required: false
        - id: "FA-UC00-003"
          title: "Filtrar por status"
          required: false
        - id: "FE-UC00-001"
          title: "Usuário sem permissão → HTTP 403"
          required: true
        - id: "FE-UC00-002"
          title: "Nenhum template → estado vazio"
          required: true

    precondicoes:
      - permissao: "TPL.RELATORIOS.VIEW"

    gatilho: "Usuario acessa Templates de Relatorios pelo menu"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessa_menu"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "carregar_templates_tenant"
      - passo: 4
        ator: "sistema"
        acao: "exibir_lista_paginada"

    fluxos_alternativos:
      - id: "FA-UC00-01"
        condicao: "usuario_aplica_filtro"
        resultado: "lista_filtrada"

    fluxos_excecao:
      - id: "FE-UC00-01"
        condicao: "sem_permissao"
        resultado: "http_403"

    regras_aplicadas:
      - "RN-RF065-015"

    resultado_final:
      estado: "lista_templates_exibida"

  - id: "UC01"
    nome: "Criar Template de Relatório"
    ator_principal: "usuario_autenticado"
    tipo: "crud"
    impacta_dados: true

    covers:
      rf_items:
        - "RF-CRUD-01"
        - "RF-FUNC-01"
        - "RF-FUNC-02"
        - "RF-FUNC-03"
        - "RF-FUNC-04"
        - "RF-FUNC-05"
        - "RF-FUNC-06"
        - "RF-FUNC-07"
        - "RF-FUNC-08"
        - "RF-FUNC-11"
        - "RF-FUNC-12"
        - "RF-FUNC-13"
        - "RF-FUNC-14"
        - "RF-FUNC-15"
        - "RF-VAL-01"
        - "RF-VAL-02"
        - "RF-VAL-04"
        - "RF-SEC-01"
        - "RF-SEC-02"
        - "RF-SEC-03"
      uc_items:
        - id: "FP-UC01-001"
          title: "Usuário clica em Novo Template"
          required: true
        - id: "FP-UC01-002"
          title: "Sistema valida permissão CREATE"
          required: true
        - id: "FP-UC01-003"
          title: "Sistema exibe wizard de 5 passos"
          required: true
        - id: "FP-UC01-004"
          title: "Passo 1 - Dados Básicos"
          required: true
        - id: "FP-UC01-005"
          title: "Passo 2 - Escolhe SQL ou MDX"
          required: true
        - id: "FP-UC01-006"
          title: "Escreve query no editor"
          required: true
        - id: "FP-UC01-007"
          title: "Define parâmetros dinâmicos"
          required: false
        - id: "FP-UC01-008"
          title: "Executa preview"
          required: true
        - id: "FP-UC01-009"
          title: "Sistema valida sintaxe SQL/MDX"
          required: true
        - id: "FP-UC01-010"
          title: "Sistema executa query com parâmetros padrão"
          required: true
        - id: "FP-UC01-011"
          title: "Sistema retorna preview (100 linhas)"
          required: true
        - id: "FP-UC01-012"
          title: "Sistema exibe estrutura de colunas"
          required: true
        - id: "FP-UC01-013"
          title: "Passo 3 - Configura gráficos Chart.js"
          required: false
        - id: "FP-UC01-014"
          title: "Configura agrupamentos e subtotais"
          required: false
        - id: "FP-UC01-015"
          title: "Configura formatação condicional"
          required: false
        - id: "FP-UC01-016"
          title: "Configura múltiplas abas Excel"
          required: false
        - id: "FP-UC01-017"
          title: "Passo 4 - Configura cabeçalho"
          required: false
        - id: "FP-UC01-018"
          title: "Configura rodapé"
          required: false
        - id: "FP-UC01-019"
          title: "Configura marca d'água PDF"
          required: false
        - id: "FP-UC01-020"
          title: "Passo 5 - Proteção Excel"
          required: false
        - id: "FP-UC01-021"
          title: "Assinatura digital PDF"
          required: false
        - id: "FP-UC01-022"
          title: "Usuário salva template"
          required: true
        - id: "FP-UC01-023"
          title: "Sistema valida campos obrigatórios"
          required: true
        - id: "FP-UC01-024"
          title: "Sistema valida unicidade do nome"
          required: true
        - id: "FP-UC01-025"
          title: "Sistema valida query SQL/MDX"
          required: true
        - id: "FP-UC01-026"
          title: "Sistema sanitiza query (SQL injection)"
          required: true
        - id: "FP-UC01-027"
          title: "Sistema valida whitelist de tabelas"
          required: true
        - id: "FP-UC01-028"
          title: "Sistema cria registro em RelatorioTemplate"
          required: true
        - id: "FP-UC01-029"
          title: "Sistema cria versão 1.0.0"
          required: true
        - id: "FP-UC01-030"
          title: "Sistema registra auditoria CREATE"
          required: true
        - id: "FP-UC01-031"
          title: "Sistema exibe mensagem de sucesso"
          required: true
        - id: "FP-UC01-032"
          title: "Sistema redireciona para visualização"
          required: true
        - id: "FA-UC01-001"
          title: "Importar query de arquivo SQL"
          required: false
        - id: "FA-UC01-002"
          title: "Salvar como rascunho (draft)"
          required: false
        - id: "FA-UC01-003"
          title: "Testar parâmetros dinâmicos"
          required: false
        - id: "FE-UC01-001"
          title: "Query SQL/MDX inválida → HTTP 400"
          required: true
        - id: "FE-UC01-002"
          title: "Nome duplicado → HTTP 400"
          required: true
        - id: "FE-UC01-003"
          title: "Query retorna muitas colunas → aviso"
          required: false
        - id: "FE-UC01-004"
          title: "Query muito lenta → timeout"
          required: true
        - id: "FE-UC01-005"
          title: "Query com UPDATE/DELETE → HTTP 400"
          required: true
        - id: "FE-UC01-006"
          title: "Logo muito grande → HTTP 413"
          required: true
        - id: "FE-UC01-007"
          title: "Certificado X.509 inválido → HTTP 400"
          required: true
        - id: "FE-UC01-008"
          title: "Nome de aba Excel duplicado → HTTP 400"
          required: true

    precondicoes:
      - permissao: "TPL.RELATORIOS.CREATE"

    gatilho: "Usuario clica em Novo Template"

    fluxo_principal:
      - passo: 1
        ator: "sistema"
        acao: "exibir_wizard_5_passos"
      - passo: 2
        ator: "usuario"
        acao: "preencher_dados_basicos"
      - passo: 3
        ator: "usuario"
        acao: "escrever_query_sql_mdx"
      - passo: 4
        ator: "sistema"
        acao: "validar_e_executar_preview"
      - passo: 5
        ator: "usuario"
        acao: "configurar_visuais_e_layout"
      - passo: 6
        ator: "usuario"
        acao: "configurar_seguranca"
      - passo: 7
        ator: "sistema"
        acao: "validar_e_criar_template"

    fluxos_excecao:
      - id: "FE-UC01-01"
        condicao: "query_invalida"
        resultado: "http_400_erro_sintaxe"

    regras_aplicadas:
      - "RN-RF065-001"
      - "RN-RF065-002"
      - "RN-RF065-003"
      - "RN-RF065-004"
      - "RN-RF065-005"
      - "RN-RF065-006"
      - "RN-RF065-008"
      - "RN-RF065-009"
      - "RN-RF065-010"
      - "RN-RF065-011"
      - "RN-RF065-012"

    resultado_final:
      estado: "template_criado_versao_1_0_0"

  - id: "UC02"
    nome: "Visualizar Template de Relatório"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      rf_items:
        - "RF-CRUD-03"
      uc_items:
        - id: "FP-UC02-001"
          title: "Usuário clica em Visualizar"
          required: true
        - id: "FP-UC02-002"
          title: "Sistema valida permissão VIEW"
          required: true
        - id: "FP-UC02-003"
          title: "Sistema valida pertence ao tenant"
          required: true
        - id: "FP-UC02-004"
          title: "Sistema carrega dados completos"
          required: true
        - id: "FP-UC02-005"
          title: "Sistema exibe 6 abas"
          required: true
        - id: "FP-UC02-006"
          title: "Aba Detalhes"
          required: true
        - id: "FP-UC02-007"
          title: "Aba Query"
          required: true
        - id: "FP-UC02-008"
          title: "Aba Configurações Visuais"
          required: true
        - id: "FP-UC02-009"
          title: "Aba Layout"
          required: true
        - id: "FP-UC02-010"
          title: "Aba Versões"
          required: true
        - id: "FP-UC02-011"
          title: "Aba Histórico de Gerações"
          required: true
        - id: "FP-UC02-012"
          title: "Sistema exibe métricas de uso"
          required: true
        - id: "FA-UC02-001"
          title: "Comparar versões (Diff)"
          required: false
        - id: "FA-UC02-002"
          title: "Gerar relatório de teste"
          required: false
        - id: "FA-UC02-003"
          title: "Exportar configuração JSON"
          required: false
        - id: "FE-UC02-001"
          title: "Template não encontrado → HTTP 404"
          required: true
        - id: "FE-UC02-002"
          title: "Acesso negado → HTTP 403"
          required: true
        - id: "FE-UC02-003"
          title: "Template de outro tenant → HTTP 403"
          required: true

    precondicoes:
      - permissao: "TPL.RELATORIOS.VIEW"

    gatilho: "Usuario clica em Visualizar em um template"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "clicar_visualizar"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "carregar_dados_completos"
      - passo: 4
        ator: "sistema"
        acao: "exibir_6_abas"

    fluxos_excecao:
      - id: "FE-UC02-01"
        condicao: "template_nao_encontrado"
        resultado: "http_404"

    regras_aplicadas:
      - "RN-RF065-015"

    resultado_final:
      estado: "detalhes_template_exibidos"

  - id: "UC03"
    nome: "Editar Template de Relatório"
    ator_principal: "usuario_autenticado"
    tipo: "crud"
    impacta_dados: true

    covers:
      rf_items:
        - "RF-CRUD-04"
      uc_items:
        - id: "FP-UC03-001"
          title: "Usuário clica em Editar"
          required: true
        - id: "FP-UC03-002"
          title: "Sistema valida permissão UPDATE"
          required: true
        - id: "FP-UC03-003"
          title: "Sistema valida pertence ao tenant"
          required: true
        - id: "FP-UC03-004"
          title: "Sistema valida não está arquivado"
          required: true
        - id: "FP-UC03-005"
          title: "Sistema carrega wizard preenchido"
          required: true
        - id: "FP-UC03-006"
          title: "Usuário modifica campos"
          required: true
        - id: "FP-UC03-007"
          title: "Sistema permite preview com dados reais"
          required: true
        - id: "FP-UC03-008"
          title: "Usuário salva alterações"
          required: true
        - id: "FP-UC03-009"
          title: "Sistema exibe modal de versionamento"
          required: true
        - id: "FP-UC03-010"
          title: "Usuário preenche mensagem de commit"
          required: true
        - id: "FP-UC03-011"
          title: "Sistema valida campos"
          required: true
        - id: "FP-UC03-012"
          title: "Sistema valida query se modificada"
          required: true
        - id: "FP-UC03-013"
          title: "Sistema calcula diff"
          required: true
        - id: "FP-UC03-014"
          title: "Sistema incrementa versão"
          required: true
        - id: "FP-UC03-015"
          title: "Sistema cria registro de versão"
          required: true
        - id: "FP-UC03-016"
          title: "Sistema atualiza template"
          required: true
        - id: "FP-UC03-017"
          title: "Sistema registra auditoria UPDATE"
          required: true
        - id: "FP-UC03-018"
          title: "Sistema exibe mensagem de sucesso"
          required: true
        - id: "FP-UC03-019"
          title: "Sistema redireciona para visualização"
          required: true
        - id: "FA-UC03-001"
          title: "Preview com dados reais antes de salvar"
          required: false
        - id: "FA-UC03-002"
          title: "Comparar diff antes de salvar"
          required: false
        - id: "FA-UC03-003"
          title: "Reverter para versão anterior"
          required: false
        - id: "FA-UC03-004"
          title: "Cancelar edição"
          required: false
        - id: "FE-UC03-001"
          title: "Query inválida → HTTP 400"
          required: true
        - id: "FE-UC03-002"
          title: "Nome duplicado → HTTP 400"
          required: true
        - id: "FE-UC03-003"
          title: "Mensagem commit vazia → HTTP 400"
          required: true
        - id: "FE-UC03-004"
          title: "Template arquivado → HTTP 400"
          required: true
        - id: "FE-UC03-005"
          title: "Concorrência → HTTP 409"
          required: true

    precondicoes:
      - permissao: "TPL.RELATORIOS.UPDATE"
      - status_nao_permitido: "archived"

    gatilho: "Usuario clica em Editar"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "clicar_editar"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao_e_status"
      - passo: 3
        ator: "sistema"
        acao: "carregar_wizard_preenchido"
      - passo: 4
        ator: "usuario"
        acao: "modificar_campos"
      - passo: 5
        ator: "sistema"
        acao: "modal_versionamento"
      - passo: 6
        ator: "sistema"
        acao: "calcular_diff_e_incrementar_versao"
      - passo: 7
        ator: "sistema"
        acao: "atualizar_template"

    fluxos_excecao:
      - id: "FE-UC03-01"
        condicao: "query_invalida"
        resultado: "http_400"

    regras_aplicadas:
      - "RN-UC01-013"

    resultado_final:
      estado: "template_atualizado_nova_versao"

  - id: "UC04"
    nome: "Excluir Template de Relatório"
    ator_principal: "usuario_autenticado"
    tipo: "crud"
    impacta_dados: true

    covers:
      rf_items:
        - "RF-CRUD-05"
      uc_items:
        - id: "FP-UC04-001"
          title: "Usuário clica em Excluir"
          required: true
        - id: "FP-UC04-002"
          title: "Sistema valida permissão DELETE"
          required: true
        - id: "FP-UC04-003"
          title: "Sistema valida pertence ao tenant"
          required: true
        - id: "FP-UC04-004"
          title: "Sistema verifica agendamentos ativos"
          required: true
        - id: "FP-UC04-005"
          title: "Sistema exibe modal de confirmação"
          required: true
        - id: "FP-UC04-006"
          title: "Usuário marca checkbox e confirma"
          required: true
        - id: "FP-UC04-007"
          title: "Sistema marca Fl_Deletado=1 (soft delete)"
          required: true
        - id: "FP-UC04-008"
          title: "Sistema desativa agendamentos vinculados"
          required: true
        - id: "FP-UC04-009"
          title: "Sistema registra auditoria DELETE"
          required: true
        - id: "FP-UC04-010"
          title: "Sistema exibe mensagem de sucesso"
          required: true
        - id: "FP-UC04-011"
          title: "Sistema redireciona para listagem"
          required: true
        - id: "FA-UC04-001"
          title: "Reativar template excluído"
          required: false
        - id: "FA-UC04-002"
          title: "Arquivar em vez de excluir"
          required: false
        - id: "FE-UC04-001"
          title: "Template não encontrado → HTTP 404"
          required: true
        - id: "FE-UC04-002"
          title: "Acesso negado → HTTP 403"
          required: true
        - id: "FE-UC04-003"
          title: "Template já excluído → HTTP 400"
          required: true
        - id: "FE-UC04-004"
          title: "Template de outro tenant → HTTP 403"
          required: true

    precondicoes:
      - permissao: "TPL.RELATORIOS.DELETE"
      - status_nao_permitido: "archived"

    gatilho: "Usuario clica em Excluir"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "clicar_excluir"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "verificar_agendamentos"
      - passo: 4
        ator: "sistema"
        acao: "modal_confirmacao"
      - passo: 5
        ator: "sistema"
        acao: "soft_delete_e_desativar_agendamentos"

    fluxos_excecao:
      - id: "FE-UC04-01"
        condicao: "template_nao_encontrado"
        resultado: "http_404"

    regras_aplicadas: []

    resultado_final:
      estado: "template_excluido_soft_delete"

  - id: "UC05"
    nome: "Gerar Relatório"
    ator_principal: "usuario_autenticado"
    tipo: "acao"
    impacta_dados: true

    covers:
      rf_items:
        - "RF-FUNC-01"
        - "RF-FUNC-02"
        - "RF-FUNC-03"
        - "RF-FUNC-04"
        - "RF-FUNC-05"
        - "RF-FUNC-06"
        - "RF-FUNC-08"
        - "RF-FUNC-10"
        - "RF-FUNC-11"
        - "RF-FUNC-12"
        - "RF-FUNC-13"
        - "RF-FUNC-14"
        - "RF-FUNC-16"
        - "RF-FUNC-17"
        - "RF-FUNC-18"
      uc_items:
        - id: "FP-UC05-001"
          title: "Usuário clica em Gerar Relatório"
          required: true
        - id: "FP-UC05-002"
          title: "Sistema valida permissão GENERATE"
          required: true
        - id: "FP-UC05-003"
          title: "Sistema valida template ativo"
          required: true
        - id: "FP-UC05-004"
          title: "Sistema verifica parâmetros obrigatórios"
          required: true
        - id: "FP-UC05-005"
          title: "Sistema exibe modal com parâmetros"
          required: true
        - id: "FP-UC05-006"
          title: "Usuário preenche parâmetros"
          required: true
        - id: "FP-UC05-007"
          title: "Usuário clica em Gerar"
          required: true
        - id: "FP-UC05-008"
          title: "Sistema valida parâmetros"
          required: true
        - id: "FP-UC05-009"
          title: "Sistema verifica cache Redis"
          required: true
        - id: "FP-UC05-010"
          title: "Se não há cache ou regenerar"
          required: true
        - id: "FP-UC05-011"
          title: "Sistema executa query SQL/MDX"
          required: true
        - id: "FP-UC05-012"
          title: "Sistema mede tempo de execução"
          required: true
        - id: "FP-UC05-013"
          title: "Sistema aplica agrupamentos e subtotais"
          required: false
        - id: "FP-UC05-014"
          title: "Sistema aplica formatação condicional"
          required: false
        - id: "FP-UC05-015"
          title: "Sistema gera gráficos Chart.js"
          required: false
        - id: "FP-UC05-016"
          title: "Sistema escolhe gerador (EPPlus/QuestPDF/CsvHelper)"
          required: true
        - id: "FP-UC05-017"
          title: "Sistema aplica layout (header/footer/marca d'água)"
          required: false
        - id: "FP-UC05-018"
          title: "Sistema aplica segurança (proteção/assinatura)"
          required: false
        - id: "FP-UC05-019"
          title: "Sistema gera arquivo final"
          required: true
        - id: "FP-UC05-020"
          title: "Sistema faz upload para Azure Blob Storage"
          required: true
        - id: "FP-UC05-021"
          title: "Sistema cria registro em RelatorioExecucao"
          required: true
        - id: "FP-UC05-022"
          title: "Sistema registra auditoria GENERATE"
          required: true
        - id: "FP-UC05-023"
          title: "Sistema atualiza métricas de uso"
          required: true
        - id: "FP-UC05-024"
          title: "Sistema salva no cache se pesado"
          required: false
        - id: "FP-UC05-025"
          title: "Sistema exibe mensagem de sucesso"
          required: true
        - id: "FP-UC05-026"
          title: "Sistema oferece download automático"
          required: true
        - id: "FP-UC05-027"
          title: "Botão Enviar por E-mail disponível"
          required: true
        - id: "FA-UC05-001"
          title: "Gerar múltiplos relatórios em ZIP"
          required: false
        - id: "FA-UC05-002"
          title: "Enviar relatório por e-mail"
          required: false
        - id: "FA-UC05-003"
          title: "Regenerar forçando atualização de cache"
          required: false
        - id: "FE-UC05-001"
          title: "Parâmetros não preenchidos → HTTP 400"
          required: true
        - id: "FE-UC05-002"
          title: "Query retorna erro → HTTP 500"
          required: true
        - id: "FE-UC05-003"
          title: "Query muito lenta → timeout"
          required: true
        - id: "FE-UC05-004"
          title: "Erro upload Azure Blob → HTTP 500"
          required: true
        - id: "FE-UC05-005"
          title: "Certificado expirado → HTTP 400"
          required: true
        - id: "FE-UC05-006"
          title: "Máx 10 relatórios ZIP excedido → HTTP 400"
          required: true
        - id: "FE-UC05-007"
          title: "Query retorna 0 linhas → relatório vazio"
          required: false

    precondicoes:
      - permissao: "TPL.RELATORIOS.GENERATE"
      - template_ativo: true

    gatilho: "Usuario clica em Gerar Relatorio"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "clicar_gerar"
      - passo: 2
        ator: "sistema"
        acao: "validar_e_solicitar_parametros"
      - passo: 3
        ator: "sistema"
        acao: "verificar_cache_redis"
      - passo: 4
        ator: "sistema"
        acao: "executar_query_e_aplicar_visuais"
      - passo: 5
        ator: "sistema"
        acao: "gerar_arquivo_formato_selecionado"
      - passo: 6
        ator: "sistema"
        acao: "upload_azure_blob_e_registrar_execucao"
      - passo: 7
        ator: "sistema"
        acao: "oferecer_download"

    fluxos_excecao:
      - id: "FE-UC05-01"
        condicao: "parametros_nao_preenchidos"
        resultado: "http_400"

    regras_aplicadas:
      - "RN-RF065-001"
      - "RN-RF065-002"
      - "RN-RF065-003"
      - "RN-RF065-004"
      - "RN-RF065-008"
      - "RN-RF065-009"
      - "RN-RF065-010"
      - "RN-RF065-011"
      - "RN-RF065-013"
      - "RN-RF065-014"
      - "RN-RF065-015"

    resultado_final:
      estado: "relatorio_gerado_e_disponivel_para_download"

  - id: "UC06"
    nome: "Agendar Relatório"
    ator_principal: "usuario_autenticado"
    tipo: "acao"
    impacta_dados: true

    covers:
      rf_items:
        - "RF-FUNC-09"
        - "RF-FUNC-10"
      uc_items:
        - id: "FP-UC06-001"
          title: "Usuário clica em Agendar"
          required: true
        - id: "FP-UC06-002"
          title: "Sistema valida permissão SCHEDULE"
          required: true
        - id: "FP-UC06-003"
          title: "Sistema valida template ativo"
          required: true
        - id: "FP-UC06-004"
          title: "Sistema exibe wizard de 3 passos"
          required: true
        - id: "FP-UC06-005"
          title: "Passo 1 - Configuração Básica"
          required: true
        - id: "FP-UC06-006"
          title: "Passo 2 - Seleciona frequência (DIARIO/SEMANAL/MENSAL)"
          required: true
        - id: "FP-UC06-007"
          title: "Seleciona horário"
          required: true
        - id: "FP-UC06-008"
          title: "Se SEMANAL, seleciona dia da semana"
          required: false
        - id: "FP-UC06-009"
          title: "Se MENSAL, seleciona dia do mês"
          required: false
        - id: "FP-UC06-010"
          title: "Sistema exibe parâmetros dinâmicos"
          required: false
        - id: "FP-UC06-011"
          title: "Usuário preenche parâmetros com valores/variáveis"
          required: false
        - id: "FP-UC06-012"
          title: "Passo 3 - Preenche destinatários de e-mail"
          required: true
        - id: "FP-UC06-013"
          title: "Preenche assunto do e-mail"
          required: true
        - id: "FP-UC06-014"
          title: "Preenche corpo do e-mail (HTML)"
          required: false
        - id: "FP-UC06-015"
          title: "Usuário salva agendamento"
          required: true
        - id: "FP-UC06-016"
          title: "Sistema valida campos obrigatórios"
          required: true
        - id: "FP-UC06-017"
          title: "Sistema valida e-mails"
          required: true
        - id: "FP-UC06-018"
          title: "Sistema cria registro em RelatorioAgendamento"
          required: true
        - id: "FP-UC06-019"
          title: "Sistema calcula cron expression"
          required: true
        - id: "FP-UC06-020"
          title: "Sistema registra Hangfire Job"
          required: true
        - id: "FP-UC06-021"
          title: "Sistema registra auditoria CREATE_AGENDAMENTO"
          required: true
        - id: "FP-UC06-022"
          title: "Sistema exibe mensagem de sucesso"
          required: true
        - id: "FP-UC06-023"
          title: "Sistema redireciona para lista de agendamentos"
          required: true
        - id: "FA-UC06-001"
          title: "Visualizar próximas execuções"
          required: false
        - id: "FA-UC06-002"
          title: "Executar agendamento manualmente agora"
          required: false
        - id: "FA-UC06-003"
          title: "Pausar agendamento"
          required: false
        - id: "FA-UC06-004"
          title: "Reativar agendamento pausado"
          required: false
        - id: "FE-UC06-001"
          title: "Nome duplicado → HTTP 400"
          required: true
        - id: "FE-UC06-002"
          title: "E-mail inválido → HTTP 400"
          required: true
        - id: "FE-UC06-003"
          title: "Dia do mês inválido → HTTP 400"
          required: true
        - id: "FE-UC06-004"
          title: "Parâmetro não preenchido → HTTP 400"
          required: true
        - id: "FE-UC06-005"
          title: "Hangfire Job falha → HTTP 500"
          required: true
        - id: "FE-UC06-006"
          title: "Máx 20 destinatários excedido → HTTP 400"
          required: true

    precondicoes:
      - permissao: "TPL.RELATORIOS.SCHEDULE"
      - template_ativo: true

    gatilho: "Usuario clica em Agendar"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "clicar_agendar"
      - passo: 2
        ator: "sistema"
        acao: "validar_e_exibir_wizard_3_passos"
      - passo: 3
        ator: "usuario"
        acao: "configurar_frequencia_e_parametros"
      - passo: 4
        ator: "usuario"
        acao: "configurar_destinatarios_email"
      - passo: 5
        ator: "sistema"
        acao: "criar_agendamento_e_hangfire_job"

    fluxos_excecao:
      - id: "FE-UC06-01"
        condicao: "nome_duplicado"
        resultado: "http_400"

    regras_aplicadas:
      - "RN-RF065-007"

    resultado_final:
      estado: "agendamento_criado_hangfire_job_ativo"

  - id: "UC07"
    nome: "Visualizar Métricas de Uso"
    ator_principal: "gestor"
    tipo: "leitura"
    impacta_dados: false

    covers:
      rf_items:
        - "RF-FUNC-18"
      uc_items:
        - id: "FP-UC07-001"
          title: "Usuário acessa Métricas de Templates"
          required: true
        - id: "FP-UC07-002"
          title: "Sistema valida permissão VIEW_METRICS"
          required: true
        - id: "FP-UC07-003"
          title: "Sistema carrega métricas do tenant"
          required: true
        - id: "FP-UC07-004"
          title: "Sistema exibe dashboard com 6 seções"
          required: true
        - id: "FP-UC07-005"
          title: "Seção 1 - Resumo Geral (cards totalizadores)"
          required: true
        - id: "FP-UC07-006"
          title: "Seção 2 - Top 10 Templates"
          required: true
        - id: "FP-UC07-007"
          title: "Seção 3 - Formato Mais Popular (gráfico pizza)"
          required: true
        - id: "FP-UC07-008"
          title: "Seção 4 - Top 10 Usuários"
          required: true
        - id: "FP-UC07-009"
          title: "Seção 5 - Horário de Pico (gráfico linha)"
          required: true
        - id: "FP-UC07-010"
          title: "Seção 6 - Tempo Médio de Geração (gráfico área)"
          required: true
        - id: "FA-UC07-001"
          title: "Filtrar métricas por período"
          required: false
        - id: "FA-UC07-002"
          title: "Filtrar métricas por categoria"
          required: false
        - id: "FA-UC07-003"
          title: "Exportar relatório de métricas"
          required: false
        - id: "FA-UC07-004"
          title: "Visualizar detalhes de template"
          required: false
        - id: "FE-UC07-001"
          title: "Usuário sem permissão → HTTP 403"
          required: true
        - id: "FE-UC07-002"
          title: "Nenhuma geração → estado vazio"
          required: false
        - id: "FE-UC07-003"
          title: "Erro ao calcular métricas → HTTP 500"
          required: true

    precondicoes:
      - permissao: "TPL.RELATORIOS.VIEW_METRICS"

    gatilho: "Usuario acessa Metricas de Templates"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessar_metricas"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "carregar_metricas_tenant"
      - passo: 4
        ator: "sistema"
        acao: "exibir_dashboard_6_secoes"

    fluxos_excecao:
      - id: "FE-UC07-01"
        condicao: "sem_permissao"
        resultado: "http_403"

    regras_aplicadas:
      - "RN-RF065-015"

    resultado_final:
      estado: "dashboard_metricas_exibido"

exclusions:
  uc_items: []

historico:
  - versao: "2.0"
    data: "2025-12-31"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Versao completa com 8 UCs cobrindo 100% do RF065"
  - versao: "1.0"
    data: "2025-12-17"
    autor: "Sistema"
    descricao: "Versao inicial basica (depreciada)"
