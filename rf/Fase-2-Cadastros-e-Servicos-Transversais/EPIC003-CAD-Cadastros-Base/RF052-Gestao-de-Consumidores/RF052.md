# RF-052: Gestão de Consumidores

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC003-CAD - Cadastros Base
**Fase**: Fase 2 - Cadastros e Serviços Transversais

---

## 1. OBJETIVO DO REQUISITO

Implementar sistema completo de gestão de consumidores (usuários finais de recursos de telecomunicações) com cadastro, hierarquia organizacional, alocação de ativos, controle de custos, perfis de uso, workflows automatizados e dashboard 360°. O sistema serve como ponto central de agregação de dados de consumo, custos, ativos, políticas e histórico, permitindo rastreabilidade completa e rateio preciso de custos.

Este documento define **o que o sistema deve fazer** em relação à gestão de consumidores, servindo como **contrato oficial** entre negócio, desenvolvimento, testes e agentes de IA.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] CRUD completo de consumidores
- [x] Tipos de consumidores: Funcionário, Prestador, Departamento, Visitante
- [x] Dados pessoais: Nome, CPF, RG, Data Nascimento, Contatos
- [x] Dados profissionais: Matrícula, Departamento, Cargo, Gestor, Centro de Custo
- [x] Alocação de ativos: Linhas móveis, Ramais, Aparelhos, Acessos
- [x] Controle de custos: Custos mensais por consumidor, Histórico (7 anos), Rateio
- [x] Perfis de uso: Executivo, Gerente, Colaborador, Estagiário, Externo
- [x] Políticas aplicadas: Limites de consumo, Restrições, Franquias
- [x] Status: Ativo, Suspenso, Bloqueado, Inativo, Pendente
- [x] Histórico de movimentações e mudanças de status
- [x] Workflow de onboarding automatizado (6 etapas)
- [x] Workflow de offboarding automatizado (5 etapas)
- [x] Integração com sistema de RH (sincronização diária)
- [x] Dashboard 360° com abas (Dados, Ativos, Consumo, Custos, Políticas, Histórico)
- [x] Comparação de consumo individual vs média do departamento
- [x] Relatórios de custos por consumidor/departamento
- [x] Importação/Exportação CSV/Excel
- [x] API REST completa com permissões RBAC
- [x] Auditoria completa de todas as operações
- [x] Suporte multi-tenant com isolamento de dados

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (layout, cores, fontes)
- Tecnologia, framework ou linguagem de implementação
- Estratégia de deploy ou infraestrutura
- Gerenciamento de departamentos (RF024)
- Gerenciamento de cargos (RF018)
- Gerenciamento de usuários do sistema (RF006)
- Gestão de RH completa (folha de pagamento, férias, benefícios)
- Gerenciamento de ativos/aparelhos (RF025)
- Gerenciamento de linhas móveis (RF050)
- Faturamento detalhado (RF026)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-----|---------|
| Consumidor | Usuário final de recursos de telecomunicações (colaborador, prestador, departamento, visitante) que consome linhas, ramais, aparelhos e gera custos |
| Tipo de Consumidor | Classificação do consumidor: Funcionário (CLT), Prestador (temporário), Departamento (coletivo), Visitante (curta duração) |
| Perfil de Uso | Classificação que determina políticas aplicadas: Executivo, Gerente, Colaborador, Estagiário, Externo |
| Alocação de Ativo | Associação de um ativo (linha, ramal, aparelho) a um consumidor, registrando data de início e fim |
| Custo Individualizado | Soma de todos os custos dos ativos alocados ao consumidor mais consumo variável |
| Onboarding | Processo de admissão de novo consumidor com criação de cadastro, alocação de ativos e ativação |
| Offboarding | Processo de desligamento de consumidor com desalocação de ativos, cancelamento de acessos e inativação |
| Dashboard 360° | Visão completa do consumidor em abas: Dados, Ativos, Consumo, Custos, Políticas, Histórico |
| Tenant | Unidade lógica de isolamento de dados (Fornecedor/Empresa) |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Criar consumidor** - Cadastro completo com dados pessoais, profissionais e hierarquia organizacional
2. **Atualizar consumidor** - Editar dados existentes mantendo histórico de alterações
3. **Consultar consumidor por ID** - Obter detalhes completos incluindo ativos alocados e custos
4. **Listar consumidores** - Busca paginada com filtros por tipo, status, departamento, cargo
5. **Inativar consumidor** - Exclusão lógica (soft delete) mantendo histórico de 7 anos
6. **Alocar ativo** - Associar linha móvel, ramal ou aparelho ao consumidor
7. **Desalocar ativo** - Remover associação de ativo mantendo histórico
8. **Executar onboarding** - Workflow automatizado de admissão em 6 etapas
9. **Executar offboarding** - Workflow automatizado de desligamento em 5 etapas
10. **Visualizar dashboard 360°** - Visão completa com abas de Dados, Ativos, Consumo, Custos, Políticas, Histórico
11. **Comparar consumo** - Comparar consumo individual com média do departamento
12. **Gerar relatório de custos** - Custos por consumidor, por departamento, top 10
13. **Importar consumidores** - Importação em lote via CSV/Excel
14. **Exportar consumidores** - Exportação para arquivo
15. **Sincronizar com RH** - Integração diária com sistema de RH externo

---

## 5. REGRAS DE NEGÓCIO

### RN-RF052-01 — Tipos de Consumidores Suportados

**Descrição**: Sistema deve suportar diferentes tipos de consumidores com características e campos obrigatórios específicos.

**Justificativa**: Cada tipo de consumidor tem natureza jurídica e requisitos de dados diferentes (CLT requer CPF/Matrícula, Prestador requer CNPJ/Contrato).

**Critério de Aceite**:
- Tipos suportados: Funcionário (CLT, vínculo permanente), Prestador de Serviço (temporário, com prazo), Departamento (consumo coletivo, não pessoa física), Visitante (temporário curto, <30 dias)
- Funcionário requer: CPF, Matrícula, Departamento, Cargo
- Prestador requer: CNPJ ou CPF, Contrato, Prazo de Vigência
- Departamento requer: Centro de Custo, Gestor Responsável
- Visitante requer: Empresa de Origem, Prazo (≤30 dias)
- Sistema valida campos obrigatórios conforme tipo selecionado
- Campo ausente ou inválido → rejeição HTTP 400

---

### RN-RF052-02 — Unicidade de Identificadores

**Descrição**: Identificadores pessoais (CPF, Matrícula, E-mail) devem ser únicos dentro do mesmo tenant (fornecedor).

**Justificativa**: Evitar duplicação de cadastros e garantir rastreabilidade única de custos por pessoa.

**Critério de Aceite**:
- CPF único por tenant (um CPF não pode ter 2 cadastros ativos no mesmo fornecedor)
- Matrícula única por tenant
- E-mail único por tenant
- Sistema permite mesmo CPF em diferentes tenants (isolamento multi-tenant)
- Validação de formato: CPF (11 dígitos + dígitos verificadores), E-mail (RFC 5322)
- Tentativa de criar consumidor com CPF/Matrícula/E-mail duplicado → rejeição HTTP 400 com mensagem clara
- Consumidores tipo "Departamento" não possuem CPF (usar CNPJ se aplicável)

---

### RN-RF052-03 — Hierarquia Organizacional Obrigatória

**Descrição**: Consumidores do tipo Funcionário devem estar vinculados a hierarquia organizacional (Departamento, Cargo, Gestor).

**Justificativa**: Permitir rateio de custos por departamento, aplicação de políticas por cargo e controle de alçadas.

**Critério de Aceite**:
- Obrigatório para Funcionários: Departamento (RF024), Cargo (RF018), Gestor Responsável, Centro de Custo
- Opcional para Prestadores de Serviço
- Não aplicável para Departamento/Visitante
- Sistema valida existência de Departamento e Cargo antes de salvar
- CEO/Presidente podem não ter gestor (campo null permitido)
- Histórico: Sistema registra todas as mudanças de departamento/cargo com data de vigência
- Mudança de departamento pode alterar políticas aplicadas automaticamente

---

### RN-RF052-04 — Alocação de Ativos Múltiplos

**Descrição**: Consumidor pode ter múltiplos ativos (linhas, ramais, aparelhos) alocados simultaneamente.

**Justificativa**: Alguns consumidores possuem linha móvel pessoal + corporativa, ramal VoIP, aparelho fixo, etc.

**Critério de Aceite**:
- Um consumidor pode ter: 1 ou mais Linhas Móveis (RF050), 1 ou mais Ramais VoIP, 1 ou mais Aparelhos (RF025), 1 ou mais Acessos (sistemas, VPN)
- Sistema valida disponibilidade do ativo antes de alocar (ativo não pode estar alocado a outro consumidor)
- Histórico: Sistema registra todas as alocações/desalocações com data de início, data de fim, usuário responsável
- Custo Total do Consumidor = Soma de todos os custos dos ativos alocados + Consumo Variável
- Ativos compartilhados (ramal de departamento) podem ter múltiplos consumidores
- Desalocação de ativo deve registrar data de fim sem excluir histórico

---

### RN-RF052-05 — Controle de Custos Individualizados

**Descrição**: Sistema deve rastrear custos exatos de cada consumidor mês a mês com histórico de 7 anos (conformidade LGPD).

**Justificativa**: Permitir rateio preciso, análise de tendências, identificação de desvios e conformidade legal.

**Critério de Aceite**:
- Custos incluem: Custo Fixo (planos, mensalidades), Custo Variável (chamadas, dados excedentes), Custo de Ativos (depreciação), Custo de Serviços (manutenções)
- Cálculo: Custo Total Mês = Soma(Custos de Ativos Alocados) + Consumo Variável
- Histórico: Armazenar 7 anos de custos mensais na tabela `ConsumidorCustoMensal`
- Job mensal calcula custos e armazena registros consolidados
- Consumidores inativos não acumulam novos custos (histórico preservado)
- Relatórios devem permitir análise temporal (comparação ano a ano, mês a mês)

---

### RN-RF052-06 — Perfis de Uso e Aplicação Automática de Políticas

**Descrição**: Cada consumidor tem perfil de uso que determina políticas aplicadas automaticamente (limites de consumo, restrições, franquias).

**Justificativa**: Evitar configuração manual de políticas para cada consumidor, aplicando regras padrão por perfil.

**Critério de Aceite**:
- Perfis padrão: Executivo (sem limites), Gerente (limite R$ 500), Colaborador (limite R$ 200), Estagiário (limite R$ 50), Externo (limite R$ 100, apenas chamadas locais)
- Ao criar consumidor com perfil X, políticas do perfil (RF049) são aplicadas automaticamente
- Mudança de perfil aplica novas políticas e remove antigas (com registro de auditoria)
- Sistema valida existência de políticas para o perfil selecionado antes de salvar
- Políticas customizadas podem sobrescrever políticas de perfil (com permissão específica)

---

### RN-RF052-07 — Status de Consumidor e Impactos

**Descrição**: Status do consumidor controla acessos, políticas, faturamento e disponibilidade de operações.

**Justificativa**: Gerenciar ciclo de vida do consumidor desde admissão até desligamento com estados claros.

**Critério de Aceite**:
- Status possíveis (RF048): Ativo (acesso total, faturamento normal), Suspenso (bloqueio de novas operações, mantém consulta), Bloqueado (bloqueio total, sem acesso), Inativo (desligado, sem custo, sem acesso), Pendente (aguardando aprovação/configuração)
- Status Inativo suspende faturamento de linhas alocadas
- Status Bloqueado impede novas chamadas/consumo de dados
- Sistema valida transições de status permitidas conforme regras do RF048
- Super Admin pode forçar qualquer status com justificativa obrigatória
- Mudança de status deve ser auditada (usuário, data, justificativa)

---

### RN-RF052-08 — Workflow de Onboarding Automatizado

**Descrição**: Admissão de novo consumidor deve seguir workflow padronizado em 6 etapas com aprovações e notificações.

**Justificativa**: Garantir que todos os novos consumidores sejam configurados corretamente, com acessos, ativos e políticas aplicadas.

**Critério de Aceite**:
- Etapas: 1. Criar cadastro (dados pessoais/profissionais), 2. Atribuir perfil de uso e políticas, 3. Alocar ativos (linha, ramal, aparelho), 4. Configurar acessos (e-mail, VPN, sistemas), 5. Enviar kit de boas-vindas (notificação), 6. Ativar status (Ativo)
- Aprovações: Criação requer aprovação de Gestor, Alocação de ativos >R$ 5.000 requer aprovação de Financeiro
- Sistema executa workflow via Hangfire (background job)
- Notificações enviadas a cada etapa para responsáveis (via RF066/RF067)
- Onboarding emergencial pode pular aprovações com justificativa obrigatória
- Falha em qualquer etapa bloqueia workflow até correção manual

---

### RN-RF052-09 — Workflow de Offboarding Automatizado

**Descrição**: Desligamento de consumidor deve seguir workflow padronizado em 5 etapas garantindo devolução de ativos e desativação de acessos.

**Justificativa**: Evitar custos desnecessários, recuperar ativos e garantir conformidade na saída do consumidor.

**Critério de Aceite**:
- Etapas: 1. Notificar Gestor (15 dias antes), 2. Desalocar ativos (devolver linha, aparelho, ramal), 3. Cancelar acessos (e-mail, VPN, sistemas), 4. Calcular custos finais (proporcional, multas), 5. Atualizar status para Inativo
- Retenção: Dados do consumidor devem ser mantidos por 7 anos (LGPD) mesmo após inativação
- Status Inativo impede login mas mantém histórico completo de custos e consumo
- Sistema valida devolução de todos os ativos antes de finalizar offboarding
- Offboarding por justa causa pode ser imediato sem período de transição (15 dias)
- Custos proporcionais calculados automaticamente (dias trabalhados no mês)

---

### RN-RF052-10 — Integração com RH para Sincronização Automática

**Descrição**: Sistema deve sincronizar dados com sistema de RH externo automaticamente via API ou arquivo CSV.

**Justificativa**: Evitar dessincronia entre RH e sistema de telecomunicações, garantindo que admissões/demissões sejam refletidas.

**Critério de Aceite**:
- Dados sincronizados: Nome, CPF, Matrícula, Departamento, Cargo, Data Admissão, Data Demissão, Status (Ativo/Inativo)
- Frequência: Sincronização diária via API REST ou importação de arquivo CSV
- Em caso de divergência, RH é fonte da verdade (com alerta para revisão manual)
- Job noturno (Hangfire) sincroniza dados do RH, gerando relatório de divergências
- Prestadores e Visitantes não são sincronizados (cadastro manual)
- Sincronização deve atualizar apenas consumidores tipo "Funcionário"

---

### RN-RF052-11 — Dashboard 360° de Consumidor

**Descrição**: Interface deve exibir visão completa de consumidor em abas organizadas com dados, ativos, consumo, custos, políticas e histórico.

**Justificativa**: Permitir análise rápida e completa do consumidor em uma única tela sem necessidade de navegar por múltiplas páginas.

**Critério de Aceite**:
- Abas: Dados (pessoais, profissionais, contatos), Ativos (linhas, ramais, aparelhos alocados), Consumo (dados, voz, SMS do mês), Custos (custo total, histórico mensal, gráfico), Políticas (políticas aplicadas, conformidade), Histórico (movimentações, mudanças de status), Chamados (chamados abertos pelo consumidor)
- Atualização em tempo real via SignalR para aba Consumo (quando consumidor está consumindo)
- Dashboard carrega em ≤2 segundos (performance obrigatória)
- Abas carregam sob demanda (lazy loading)
- Usuários sem permissão veem apenas dados básicos (sem custos/consumo)

---

### RN-RF052-12 — Comparação de Consumo Individual vs Média

**Descrição**: Sistema deve permitir comparar consumo/custo do consumidor com média do departamento para identificar desvios.

**Justificativa**: Identificar consumidores com padrão atípico (muito acima ou muito abaixo da média) para análise e ação.

**Critério de Aceite**:
- Comparação: Consumo Individual vs Média do Departamento, Custo Individual vs Média do Departamento
- Percentual de desvio: Verde se ≤média, Vermelho se >média
- Gráfico: Linha temporal mostrando evolução individual vs média departamental
- Alerta: Se consumidor está consistentemente >150% da média por 3 meses consecutivos, gerar alerta para Gestor
- Cálculo de médias atualizado mensalmente via job Hangfire
- Departamentos com <3 consumidores não têm média calculada (insuficiência estatística)

---

### RN-RF052-13 — Movimentação de Consumidores com Histórico

**Descrição**: Mudanças de departamento, cargo, gestor ou centro de custo devem ser registradas com histórico completo e rastreável.

**Justificativa**: Permitir auditoria de movimentações, análise de impacto em custos e políticas ao longo do tempo.

**Critério de Aceite**:
- Movimentações rastreadas: Mudança de Departamento, Mudança de Cargo, Mudança de Gestor, Mudança de Centro de Custo
- Histórico: Data da mudança, Valor anterior, Valor novo, Usuário responsável, Justificativa
- Sistema registra movimentação na tabela `ConsumidorHistoricoMovimentacao`
- Mudança de departamento pode mudar políticas aplicadas automaticamente
- Mudança de cargo pode mudar perfil de uso
- Movimentações em massa (reestruturação organizacional) podem ser processadas via job Hangfire

---

### RN-RF052-14 — Relatórios de Custos por Consumidor/Departamento

**Descrição**: Sistema deve gerar relatórios detalhados de custos para análise gerencial e tomada de decisões.

**Justificativa**: Permitir visibilidade de custos, identificar oportunidades de economia e justificar investimentos.

**Critério de Aceite**:
- Relatórios disponíveis: Custos por Consumidor (lista todos com custo mensal), Custos por Departamento (soma de custos dos consumidores), Top 10 Consumidores de Maior Custo, Top 10 Consumidores de Maior Crescimento, Consumidores Subutilizados (custo alto, consumo baixo)
- Exportação: Excel (.xlsx), PDF, CSV
- Relatórios gerados sob demanda (não pré-calculados)
- Cache de 1 hora para relatórios idênticos (otimização de performance)
- Relatórios históricos (>1 ano) podem levar mais tempo para processar (alertar usuário)

---

### RN-RF052-15 — Validação de Permissões RBAC

**Descrição**: Operações sobre consumidores devem respeitar permissões granulares por perfil de usuário (RBAC).

**Justificativa**: Garantir que apenas usuários autorizados possam visualizar, criar, editar ou excluir consumidores e suas informações sensíveis.

**Critério de Aceite**:
- Permissões: `GESTAO.CONSUMIDORES.VIEW` (visualizar), `GESTAO.CONSUMIDORES.CREATE` (criar), `GESTAO.CONSUMIDORES.UPDATE` (editar), `GESTAO.CONSUMIDORES.DELETE` (inativar), `GESTAO.CONSUMIDORES.VIEW_CUSTOS` (visualizar custos), `GESTAO.CONSUMIDORES.EXPORT` (exportar relatórios)
- Gestores veem apenas consumidores de seus departamentos subordinados
- Financeiro vê todos os consumidores do tenant
- Super Admin vê todos os consumidores cross-tenant
- Endpoints validam permissões via `RequireAuthorization`
- Commands validam via `Authorize(Roles = "...")`
- Tentativa de acesso sem permissão → HTTP 403 Forbidden

---

## 6. ESTADOS DA ENTIDADE

| Estado | Descrição |
|------|-----------|
| Pendente | Consumidor criado, aguardando aprovação ou configuração inicial |
| Ativo | Consumidor ativo com acesso total a recursos e faturamento normal |
| Suspenso | Bloqueio de novas operações, mantém consulta, aguardando resolução |
| Bloqueado | Bloqueio total sem acesso a recursos (inadimplência, violação de políticas) |
| Inativo | Desligado, sem custos, sem acesso, histórico preservado por 7 anos |

### Transições permitidas

| De | Para | Condição |
|---|---|---|
| Pendente | Ativo | Após conclusão do onboarding |
| Ativo | Suspenso | Por inadimplência ou violação de política |
| Ativo | Bloqueado | Por ordem administrativa ou violação grave |
| Ativo | Inativo | Após conclusão do offboarding |
| Suspenso | Ativo | Após resolução do problema |
| Bloqueado | Ativo | Após autorização administrativa |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre |
|------|--------------|
| ConsumidorCriado | Após criação bem-sucedida de consumidor |
| ConsumidorAtualizado | Após atualização de dados do consumidor |
| ConsumidorInativado | Após inativação (soft delete) do consumidor |
| AtivoAlocado | Após alocação de ativo ao consumidor |
| AtivoDesalocado | Após desalocação de ativo do consumidor |
| OnboardingIniciado | Ao iniciar workflow de onboarding |
| OnboardingConcluido | Ao finalizar workflow de onboarding |
| OffboardingIniciado | Ao iniciar workflow de offboarding |
| OffboardingConcluido | Ao finalizar workflow de offboarding |
| StatusAlterado | Ao alterar status do consumidor |
| PerfilAlterado | Ao alterar perfil de uso do consumidor |
| MovimentacaoRegistrada | Ao registrar mudança de departamento/cargo |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant (consumidor de fornecedor A não pode ver dados de fornecedor B)
- Nenhuma regra de negócio pode ser ignorada (validações obrigatórias em backend e frontend)
- Erros devem ser previsíveis e rastreáveis (mensagens claras, códigos HTTP padrão)
- Auditoria deve registrar quem, quando, o que mudou e de onde (IP, user-agent)
- Histórico de 7 anos deve ser preservado (LGPD) mesmo após inativação
- Workflows automatizados devem ser idempotentes (re-execução não causa duplicação)
- Performance: CRUD ≤300ms, Dashboard ≤2s, Relatórios ≤5s

---

## 9. SEGURANÇA

- Validação de entrada obrigatória em todos os endpoints (FluentValidation)
- Proteção contra injeção SQL (uso de Entity Framework Core com parâmetros)
- Controle de permissões RBAC granular
- Isolamento multi-tenant obrigatório (Query Filters EF Core)
- Criptografia AES-256 para dados sensíveis em repouso (CPF, RG)
- TLS 1.3 para dados em trânsito
- Auditoria completa de todas as operações (RF003)
- Autenticação JWT obrigatória

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- UC-RF052.md (Casos de Uso)
- MT-RF052.yaml (Massas de Teste)
- TC-RF052.yaml (Casos de Teste)
- MD-RF052.md (Modelo de Dados)
- WF-RF052.md (Wireframes)

---

## 11. RASTREABILIDADE

| Artefato | Status | Localização |
|--------|-------|------------|
| Casos de Uso | Criado | UC-RF052.md |
| Massas de Teste | Criado | MT-RF052.yaml |
| Casos de Teste | Criado | TC-RF052.yaml |
| Modelo de Dados | Criado | MD-RF052.md |
| Wireframes | Criado | WF-RF052.md |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|------|------|----------|------|
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0 (separação RF/RL, contrato moderno sem legado) | Agência ALC - alc.dev.br |
| 1.0 | 2025-12-18 | Versão inicial - Especificação completa de Gestão de Consumidores | IControlIT Architect Agent |
