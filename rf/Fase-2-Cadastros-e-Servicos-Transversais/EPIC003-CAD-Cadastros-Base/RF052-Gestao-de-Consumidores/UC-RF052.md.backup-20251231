# Casos de Uso - RF052

**VersÃ£o:** 1.0
**Data:** 2025-12-17
**RF Relacionado:** [RF052 - Gestao-de-Consumidores](./RF052.md)

---

## Ãndice de Casos de Uso

| UC | Nome | DescriÃ§Ã£o |
|----|------|-----------|
| UC00 | UC00 - Listar Consumidores com Busca AvanÃ§ada | Caso de uso |
| UC01 | UC01 - Cadastrar Novo Consumidor | Caso de uso |
| UC02 | UC02 - Editar Dados de Consumidor | Caso de uso |
| UC07 | UC07 - Dashboard Gestor e Import/Export | Caso de uso |

---

# UC00 - Listar Consumidores com Busca AvanÃ§ada

**RF**: RF-029 - GestÃ£o de Consumidores
**Complexidade**: MÃ©dia
**Estimativa**: 5h Backend + 6h Frontend

---

## ğŸ“‹ Objetivo

Listar consumidores (colaboradores/terceiros) com busca full-text usando Elasticsearch, filtros avanÃ§ados por status/tipo/filial/cargo, paginaÃ§Ã£o para alta performance e aÃ§Ãµes em lote (exportar, enviar email, aplicar polÃ­tica). Interface responsiva com busca rÃ¡pida, autocomplete e destaque de termos encontrados.

---

## ğŸ“ Fluxo Principal

1. UsuÃ¡rio acessa "GestÃ£o de Pessoas â†’ Consumidores"
2. Sistema exibe grid paginado (50 por pÃ¡gina):
   - Avatar (foto ou iniciais)
   - Nome Completo
   - MatrÃ­cula
   - Email
   - Cargo
   - Filial
   - Departamento
   - Status (badge colorido: ğŸŸ¢ Ativo, ğŸŸ¡ FÃ©rias, ğŸ”´ Desligado)
   - AÃ§Ãµes ([ğŸ‘ï¸][âœï¸][ğŸ“‹])
3. **Busca RÃ¡pida** (Elasticsearch):
   - Campo Ãºnico: [ğŸ” Buscar por nome, matrÃ­cula, email, CPF...]
   - Typo tolerance: "joa silv" encontra "JoÃ£o Silva"
   - SugestÃµes automÃ¡ticas (autocomplete)
   - Destaque de termos encontrados (highlight)
4. **Filtros AvanÃ§ados** (sidebar):
   - Status: [Todos â–¼] ou Ativo, FÃ©rias, Afastado, LicenÃ§a, Desligado
   - Tipo: [Todos â–¼] ou Colaborador CLT, Terceiro, EstagiÃ¡rio, PJ
   - Filial: [Todas â–¼] (autocomplete)
   - Centro Custo: [Todos â–¼] (depende de Filial)
   - Departamento: [Todos â–¼]
   - Cargo: [Todos â–¼]
   - Com ativos alocados: â˜ Sim â˜ NÃ£o â˜ Tanto faz
   - Data admissÃ£o: De [____] atÃ© [____]
5. **OrdenaÃ§Ã£o**: Clica cabeÃ§alho para ordenar (Nome, MatrÃ­cula, Data AdmissÃ£o)
6. **AÃ§Ãµes em Lote**:
   - Checkbox multi-seleÃ§Ã£o
   - [ğŸ“¤ Exportar Excel] - Exporta filtros aplicados
   - [ğŸ“§ Enviar Email em Lote] - NotificaÃ§Ã£o mÃºltiplos consumidores
   - [ğŸ·ï¸ Aplicar PolÃ­tica] - Atribuir cota em lote

---

## âœ… ValidaÃ§Ãµes

| Campo | Regra |
|-------|-------|
| Busca | Min 2 caracteres para Elasticsearch |
| PaginaÃ§Ã£o | Max 50 registros por pÃ¡gina |
| ExportaÃ§Ã£o | Max 10.000 registros por vez |
| Filtros | Multi-tenancy (Id_Conglomerado) |

---

## ğŸ“ Regras de NegÃ³cio

- **RN-UC00-001**: Busca Elasticsearch com typo tolerance (Levenshtein distance â‰¤2)
- **RN-UC00-002**: Multi-tenancy (WHERE Id_Conglomerado = @Id)
- **RN-UC00-003**: PaginaÃ§Ã£o obrigatÃ³ria (performance com 100k+ consumidores)
- **RN-UC00-004**: Cache Redis (5min) para listas de filtros (Filiais, Cargos)
- **RN-UC00-005**: ExportaÃ§Ã£o limitada a 10.000 registros por vez

---

## ğŸ¨ Interface UI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Consumidores                    [+ Novo] [ğŸ“¤ Exportar]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ” [Buscar por nome, matrÃ­cula, email, CPF............] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Filtros: Status: [Ativo â–¼] Filial: [SP â–¼] Cargo: [Todos]â”‚
â”œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚[â˜]â”‚Avatar Nome â”‚MatrÃ­câ”‚ Email         â”‚Cargo â”‚ AÃ§Ãµes    â”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚[â˜]â”‚ğŸ§‘ JoÃ£o Silvâ”‚12345 â”‚joao@empresa..â”‚Dev Srâ”‚[ğŸ‘ï¸][âœï¸]â”‚
â”‚[â˜]â”‚ğŸ‘© Maria Sanâ”‚12346 â”‚maria@empresa.â”‚Analistâ”‚[ğŸ‘ï¸][âœï¸]â”‚
â”‚[â˜]â”‚ğŸ§‘ Pedro Cosâ”‚12347 â”‚pedro@empresa.â”‚Gestorâ”‚[ğŸ‘ï¸][âœï¸]â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
[Selecionar Todos] [ğŸ“§ Email Lote] [ğŸ·ï¸ PolÃ­tica Lote]
PÃ¡g 1 de 7 (342 consumidores) [â—€ 1 2 3 ... 7 â–¶]
```

---

## ğŸ” ObservaÃ§Ãµes TÃ©cnicas

### Busca Elasticsearch

**Request**:
```typescript
POST /api/v1/consumidores/buscar
{
  "query": "joÃ£o silva",
  "filtros": {
    "status": ["Ativo"],
    "id_filial": ["uuid-filial-sp"],
    "possui_ativos": true
  },
  "ordenacao": "nome_asc",
  "pagina": 1,
  "tamanho": 50
}
```

**Response**:
```json
{
  "total": 342,
  "pagina_atual": 1,
  "total_paginas": 7,
  "consumidores": [
    {
      "id": "uuid-consumidor",
      "nome": "JoÃ£o da Silva Junior",
      "matricula": "12345",
      "email": "joao.silva@empresa.com",
      "cargo": "Desenvolvedor SÃªnior",
      "filial": "SÃ£o Paulo - Matriz",
      "departamento": "TI - Desenvolvimento",
      "status": "Ativo",
      "avatar_url": "https://storage.com/avatar.jpg",
      "total_ativos": 3,
      "valor_ativos": 15000.00
    }
  ],
  "sugestoes": ["JoÃ£o Silva", "JoÃ£o Silveira", "Joaquim Silva"],
  "highlight": { "nome": ["<em>JoÃ£o</em> da <em>Silva</em> Junior"] }
}
```

---

---

# UC01 - Cadastrar Novo Consumidor

**RF**: RF-029 - GestÃ£o de Consumidores
**Complexidade**: Alta
**Estimativa**: 10h Backend + 12h Frontend

---

## ğŸ“‹ Objetivo

Cadastrar consumidor completo (colaborador/terceiro) com validaÃ§Ã£o de duplicatas usando Levenshtein, validaÃ§Ã£o CPF (opcional Serpro API), hierarquia corporativa completa, opÃ§Ã£o de criar usuÃ¡rio de sistema automaticamente, e envio de email de boas-vindas com template Handlebars. Wizard de 4 etapas com validaÃ§Ãµes progressivas e preview final antes de confirmar.

---

## ğŸ“ Fluxo Principal (Wizard 4 Etapas)

### Etapa 1 - Dados Pessoais

1. UsuÃ¡rio clica "+ Novo Consumidor"
2. Sistema exibe formulÃ¡rio Etapa 1:
   - **Nome Completo***: `JoÃ£o da Silva Junior` (min 3 chars)
   - **Nome Social**: `JoÃ£o Silva` (opcional, LGPD)
   - **CPF***: `123.456.789-00` (mÃ¡scara, validaÃ§Ã£o dÃ­gito + duplicata)
   - **RG**: `12.345.678-9` | Ã“rgÃ£o: `SSP` | UF: `SP`
   - **Email***: `joao.silva@empresa.com` (validaÃ§Ã£o formato + unicidade)
   - **Email CÃ³pia**: `gestor@empresa.com` (opcional)
   - **Telefone Celular***: `(11) 98765-4321` (mÃ¡scara)
   - **Telefone Fixo**: `(11) 3456-7890` | Ramal: `2234`
   - **Data Nascimento**: `15/03/1990` (validaÃ§Ã£o â‰¥18 anos ou â‰¥16 se estagiÃ¡rio)
   - **GÃªnero**: [Masculino â–¼] (M/F/Outro/Prefiro nÃ£o informar)
   - **Estado Civil**: [Solteiro â–¼]
   - **Foto**: [ğŸ“· Upload Avatar] (max 2MB, JPG/PNG, crop circular)

### Etapa 2 - Dados Organizacionais

3. UsuÃ¡rio preenche dados corporativos:
   - **MatrÃ­cula***: `12345` (Ãºnica por Conglomerado, alfanumÃ©rico max 20)
   - **Tipo Consumidor***: [Colaborador CLT â–¼] (CLT/PJ/EstagiÃ¡rio/Terceiro/Trainee)
   - **Se Terceiro** â†’ **Empresa Contratada***: [Empresa X â–¼] (obrigatÃ³rio)
   - **Cargo**: [Desenvolvedor SÃªnior â–¼] (autocomplete)
   - **Status***: [Ativo â–¼] (Ativo/FÃ©rias/Afastado/LicenÃ§a/Suspenso/Desligado)
   - **Data AdmissÃ£o***: `20/01/2024`
   - **Data DemissÃ£o**: `____` (desabilitado se status â‰  Desligado)
   - **Tipo Contrato**: [CLT â–¼] (CLT/PJ/EstÃ¡gio/TemporÃ¡rio)
   - **Jornada**: [44h semanais â–¼]
   - **Regime Trabalho**: [HÃ­brido â–¼] (Presencial/Remoto/HÃ­brido)

4. **Hierarquia Corporativa** (cascata dependente):
   - **Filial***: [SÃ£o Paulo - Matriz â–¼] (AutoPostBack virtual)
     - Ao mudar: Recarrega Centros de Custo vinculados
   - **Centro Custo***: [TI - Tecnologia â–¼]
     - Ao mudar: Recarrega Departamentos
   - **Departamento**: [TI - Desenvolvimento â–¼]
     - Ao mudar: Recarrega Setores
   - **Setor**: [Backend .NET â–¼]
     - Ao mudar: Recarrega SeÃ§Ãµes
   - **SeÃ§Ã£o**: `____` (opcional)

5. **Gestor Direto**:
   - **Matricula Chefia**: `10001` ou
   - **Gestor Direto**: [ğŸ” Buscar gestor...] (autocomplete nome/matrÃ­cula)
     - Mostra: Maria Santos (Gerente TI) - Mat. 10001
     - ValidaÃ§Ã£o circular: NÃ£o permitir que A seja chefia de B e B de A

### Etapa 3 - EndereÃ§o

6. UsuÃ¡rio preenche endereÃ§o (opcional):
   - **CEP**: `01310-100` (integraÃ§Ã£o ViaCEP)
   - **Logradouro**: `Av Paulista` | NÂº: `1000` | Compl: `Apto 501`
   - **Bairro**: `Bela Vista` | Cidade: `SÃ£o Paulo` | UF: `SP`
   - â˜ **Mesmo endereÃ§o da Filial** (checkbox copia dados)

### Etapa 4 - ConfiguraÃ§Ãµes Sistema

7. UsuÃ¡rio configura opÃ§Ãµes de sistema:
   - â˜ **Criar usuÃ¡rio de sistema automaticamente**
     - Login sugerido: `joao.silva` (editÃ¡vel)
     - Senha temporÃ¡ria: [Gerar AleatÃ³ria] â†’ Envia por email
     - Perfis de acesso: [â˜ UsuÃ¡rio PadrÃ£o] [â˜ Gestor] [â˜ Administrador]
     - â˜ ForÃ§ar troca senha no primeiro login
     - â˜ Habilitar 2FA obrigatÃ³rio
   - â˜ **NÃ£o enviar emails automÃ¡ticos** (Fl_Nao_Envia_EMail = 1)
   - **ObservaÃ§Ãµes**:
     ```
     Colaborador transferido da filial RJ. HorÃ¡rio flexÃ­vel 09:00-18:00.
     ```

### RevisÃ£o e ConfirmaÃ§Ã£o

8. Sistema exibe preview de TODOS os dados preenchidos
9. Se detectou consumidor similar, exibe alerta:
   ```
   âš ï¸ AtenÃ§Ã£o: Encontramos consumidor similar:
   Nome: JoÃ£o da Silva (sem "Junior")
   MatrÃ­cula: 12344 (diferenÃ§a de 1 dÃ­gito)
   CPF: Diferente
   [Ã‰ a mesma pessoa?] [NÃ£o, continuar cadastro]
   ```
10. Clica "Finalizar Cadastro"
11. Sistema valida:
    - CPF Ãºnico (409 Conflict se duplicado)
    - MatrÃ­cula Ãºnica no Conglomerado
    - Email Ãºnico global
    - Hierarquia vÃ¡lida (Filial â†’ CC â†’ Depto do mesmo Conglomerado)
    - Gestor existe e nÃ£o cria ciclo
12. Cria `Consumidor`:
    ```sql
    INSERT INTO Consumidor (
      Id_Consumidor, Nm_Consumidor, Nm_Social,
      CPF, RG, Email, EMail_Copia,
      Telefone_Celular, Telefone_Fixo, Ramal,
      Dt_Nascimento, Genero, Estado_Civil,
      Matricula, Matricula_Chefia,
      Id_Consumidor_Tipo, Id_Consumidor_Status,
      Id_Cargo, Id_Filial, Id_Centro_Custo,
      Id_Departamento, Id_Setor, Id_Secao,
      Dt_Admissao, Tipo_Contrato, Jornada_Trabalho,
      Regime_Trabalho, Avatar_URL,
      Fl_Nao_Envia_EMail, Observacoes,
      Id_Conglomerado, Id_Empresa, Created, CreatedBy
    ) VALUES (...)
    ```
13. Se "Criar usuÃ¡rio":
    - Cria registro em `Usuario` (RF-005)
    - Envia email com credenciais temporÃ¡rias
14. Indexa em Elasticsearch (job assÃ­ncrono)
15. Envia notificaÃ§Ã£o ao gestor: "Novo colaborador JoÃ£o Silva no seu time"
16. Mensagem: "Consumidor cadastrado! Email de boas-vindas enviado."

---

## âœ… ValidaÃ§Ãµes

| Campo | Regra |
|-------|-------|
| Nome | Min 3 chars, max 120 |
| CPF | DÃ­gito verificador + Ãºnico global |
| MatrÃ­cula | Ãšnica por Conglomerado |
| Email | Formato vÃ¡lido + Ãºnico global |
| Data Nascimento | â‰¥18 anos (ou â‰¥16 se estagiÃ¡rio) |
| Filial | FK vÃ¡lido do Conglomerado |
| Gestor | NÃ£o criar ciclo (Aâ†’Bâ†’A) |

---

## ğŸ“ Regras de NegÃ³cio

- **RN-UC01-001**: ValidaÃ§Ã£o duplicatas com Levenshtein (score â‰¥80% alerta)
- **RN-UC01-002**: CPF validado com dÃ­gito verificador (opcional Serpro API)
- **RN-UC01-003**: Hierarquia mÃ­nima obrigatÃ³ria: Filial + Centro Custo
- **RN-UC01-004**: Matricula_Chefia valida se consumidor existe (FK)
- **RN-UC01-005**: Criar usuÃ¡rio opcional (checkbox)
- **RN-UC01-006**: Email boas-vindas com template Handlebars

---

## ğŸ¨ Interface UI (Etapa 1)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Novo Consumidor          Etapa 1 de 4: Dados Pessoais   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚ â”‚ Avatar â”‚ [ğŸ“· Upload Foto] (max 2MB, crop circular)     â”‚
â”‚ â”‚  ğŸ§‘   â”‚                                               â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚                                                          â”‚
â”‚ Nome Completo*: [JoÃ£o da Silva Junior____________]      â”‚
â”‚ Nome Social: [JoÃ£o Silva_________________] (LGPD)       â”‚
â”‚                                                          â”‚
â”‚ CPF*: [123.456.789-00] âœ… VÃ¡lido                         â”‚
â”‚ RG: [12.345.678-9] Ã“rgÃ£o: [SSP] UF: [SP â–¼]              â”‚
â”‚                                                          â”‚
â”‚ Email*: [joao.silva@empresa.com____________] âœ… VÃ¡lido   â”‚
â”‚ Email CÃ³pia: [gestor@empresa.com___________] (opcional) â”‚
â”‚                                                          â”‚
â”‚ Telefone Celular*: [(11) 98765-4321]                    â”‚
â”‚ Telefone Fixo: [(11) 3456-7890] Ramal: [2234]           â”‚
â”‚                                                          â”‚
â”‚ Data Nascimento: [15/03/1990] (34 anos) âœ…               â”‚
â”‚ GÃªnero: [Masculino â–¼] Estado Civil: [Solteiro â–¼]       â”‚
â”‚                                                          â”‚
â”‚                  [Cancelar] [PrÃ³xima Etapa â–¶]            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” ObservaÃ§Ãµes TÃ©cnicas

### ValidaÃ§Ã£o CPF com Receita Federal

```typescript
// Consulta API Serpro (opcional, se habilitado)
validarCPF(cpf: string): Observable<boolean> {
  return this.http.get(`https://api.serpro.gov.br/consulta-cpf/${cpf}`, {
    headers: { Authorization: `Bearer ${this.serproToken}` }
  }).pipe(
    map(response => response.status === 'REGULAR'),
    catchError(() => of(true)) // Se API falhar, aceita (validaÃ§Ã£o local apenas)
  );
}
```

---

---

# UC02 - Editar Dados de Consumidor

**RF**: RF-029 - GestÃ£o de Consumidores
**Complexidade**: MÃ©dia
**Estimativa**: 6h Backend + 7h Frontend

---

## ğŸ“‹ Objetivo

Atualizar dados cadastrais de consumidor com auditoria completa (event sourcing) registrando TODAS as mudanÃ§as com justificativa obrigatÃ³ria para campos crÃ­ticos. Interface em abas para organizar dados pessoais, organizacionais, endereÃ§o, ativos alocados e histÃ³rico de auditoria. Permite desfazer mudanÃ§as recentes (Ãºltimas 24h).

---

## ğŸ“ Fluxo Principal

1. UsuÃ¡rio clica "Editar" (âœï¸) em consumidor
2. Sistema exibe formulÃ¡rio preenchido (abas)

### Aba 1 - Dados Pessoais
3. Permite editar:
   - Nome, CPF (readonly se jÃ¡ preenchido), RG, Email, Telefones
   - Data Nascimento, GÃªnero, Estado Civil
   - Avatar (upload nova foto)

### Aba 2 - Organizacional
4. Permite editar:
   - MatrÃ­cula (readonly apÃ³s criaÃ§Ã£o)
   - Tipo, Cargo, Status
   - Data AdmissÃ£o/DemissÃ£o
   - Hierarquia (Filial, CC, Depto, Setor, SeÃ§Ã£o)
   - Gestor Direto

### Aba 3 - EndereÃ§o
5. Permite editar:
   - CEP, Logradouro, NÃºmero, Complemento
   - Bairro, Cidade, UF

### Aba 4 - Ativos Alocados (readonly)
6. Exibe grid com ativos em posse
7. [Ver HistÃ³rico] â†’ UC03

### Aba 5 - HistÃ³rico Auditoria (readonly)
8. Timeline de mudanÃ§as:
   ```
   20/01/2025 14:32 - JoÃ£o Admin
   Email: joao@empresa.com â†’ joao.silva@empresa.com
   Motivo: PadronizaÃ§Ã£o email corporativo

   15/01/2025 09:15 - Maria RH
   Status: Ativo â†’ FÃ©rias
   Motivo: FÃ©rias janeiro 2025

   10/01/2025 16:20 - JoÃ£o Admin
   Departamento: TI - Suporte â†’ TI - Desenvolvimento
   Motivo: PromoÃ§Ã£o para time de desenvolvimento
   ```

### ModificaÃ§Ã£o e Justificativa

9. UsuÃ¡rio modifica:
   - Email: joao@empresa.com â†’ joao.silva@empresa.com
   - Departamento: TI - Suporte â†’ TI - Desenvolvimento
   - Status: Ativo â†’ FÃ©rias

10. Modal "Justificar AlteraÃ§Ã£o":
    ```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Justifique as alteraÃ§Ãµes                â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Campos alterados:                        â”‚
    â”‚ â€¢ Email                                  â”‚
    â”‚ â€¢ Departamento                           â”‚
    â”‚ â€¢ Status                                 â”‚
    â”‚                                          â”‚
    â”‚ Justificativa* (min 20 chars):          â”‚
    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚ â”‚PromoÃ§Ã£o para desenvolvedor sÃªnior.   â”‚ â”‚
    â”‚ â”‚Mudou de departamento e entra em      â”‚ â”‚
    â”‚ â”‚fÃ©rias dia 22/01.                     â”‚ â”‚
    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚                                          â”‚
    â”‚      [Cancelar] [Confirmar AlteraÃ§Ãµes]  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    ```

11. Clica "Confirmar AlteraÃ§Ãµes"

12. Sistema:
    - Atualiza `Consumidor` (campos modificados)
    - Para CADA campo alterado, cria registro `Consumidor_Auditoria`:
      ```sql
      INSERT INTO Consumidor_Auditoria (
        Id_Consumidor, Campo_Alterado,
        Valor_Anterior, Valor_Novo,
        Justificativa, Dt_Alteracao,
        Id_Usuario_Alteracao, IP_Address, User_Agent
      ) VALUES (
        @IdConsumidor, 'Email',
        'joao@empresa.com', 'joao.silva@empresa.com',
        @Justificativa, GETDATE(),
        @IdUsuario, @IpAddress, @UserAgent
      );
      ```
    - Reindexaem Elasticsearch (job assÃ­ncrono)
    - Notifica consumidor: "Seus dados foram atualizados. [Ver MudanÃ§as]"

13. Mensagem: "Dados atualizados! 3 campos alterados (Email, Departamento, Status)."

---

## âœ… ValidaÃ§Ãµes

| Campo | Regra |
|-------|-------|
| CPF | ImutÃ¡vel apÃ³s preenchimento (apenas admin) |
| MatrÃ­cula | ImutÃ¡vel apÃ³s criaÃ§Ã£o (apenas admin) |
| Data AdmissÃ£o | Apenas RH pode alterar |
| Justificativa | Min 20 chars se campo crÃ­tico |
| Status Desligado | Requer Data DemissÃ£o |

---

## ğŸ“ Regras de NegÃ³cio

- **RN-UC02-001**: Auditoria obrigatÃ³ria (event sourcing) para TODA mudanÃ§a
- **RN-UC02-002**: Justificativa obrigatÃ³ria (min 20 chars) se alterar campo crÃ­tico
- **RN-UC02-003**: CPF/MatrÃ­cula imutÃ¡veis (apenas admin com permissÃ£o especÃ­fica)
- **RN-UC02-004**: MudanÃ§a status para "Desligado" exige Data DemissÃ£o
- **RN-UC02-005**: Desfazer mudanÃ§as recentes (Ãºltimas 24h) via histÃ³rico

---

## ğŸ¨ Interface UI (Aba Auditoria)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Editar: JoÃ£o da Silva Junior              [Salvar] [x]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Dados Pessoais] [Organizacional] [EndereÃ§o] [Ativos]   â”‚
â”‚ [ğŸ“œ HistÃ³rico de Auditoria]                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Timeline de AlteraÃ§Ãµes (Ãºltimos 90 dias):               â”‚
â”‚                                                          â”‚
â”‚ ğŸ•’ 20/01/2025 14:32 - JoÃ£o Admin                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ Campo: Email                                       â”‚  â”‚
â”‚ â”‚ De: joao@empresa.com                               â”‚  â”‚
â”‚ â”‚ Para: joao.silva@empresa.com                       â”‚  â”‚
â”‚ â”‚ Motivo: PadronizaÃ§Ã£o email corporativo             â”‚  â”‚
â”‚ â”‚ IP: 192.168.1.50                                   â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚ ğŸ•’ 15/01/2025 09:15 - Maria RH                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ Campo: Status                                      â”‚  â”‚
â”‚ â”‚ De: Ativo â†’ Para: FÃ©rias                           â”‚  â”‚
â”‚ â”‚ Motivo: FÃ©rias programadas janeiro 2025            â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚ ğŸ•’ 10/01/2025 16:20 - JoÃ£o Admin                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ Campo: Departamento                                â”‚  â”‚
â”‚ â”‚ De: TI - Suporte                                   â”‚  â”‚
â”‚ â”‚ Para: TI - Desenvolvimento                         â”‚  â”‚
â”‚ â”‚ Motivo: PromoÃ§Ã£o desenvolvedor sÃªnior              â”‚  â”‚
â”‚ â”‚ [âª Desfazer] (disponÃ­vel 24h)                     â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚ [ğŸ“¥ Exportar Auditoria Completa PDF]                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” ObservaÃ§Ãµes TÃ©cnicas

### Campos NÃƒO EditÃ¡veis

- **CPF** (apÃ³s preenchimento inicial, apenas admin pode alterar)
- **MatrÃ­cula** (imutÃ¡vel, apenas admin pode alterar)
- **Data AdmissÃ£o** (apenas RH pode alterar)

### Event Sourcing

Todas as mudanÃ§as sÃ£o registradas em `Consumidor_Auditoria` com:
- Campo alterado
- Valor anterior e novo
- Justificativa
- UsuÃ¡rio, IP, User-Agent
- Timestamp

---

---

# UC07 - Dashboard Gestor e Import/Export

**RF**: RF-029 - GestÃ£o de Consumidores
**Complexidade**: MÃ©dia
**Estimativa**: 10h Backend + 12h Frontend

---

## ğŸ“‹ Objetivo

VisualizaÃ§Ã£o hierÃ¡rquica de subordinados com consulta recursiva SQL (atÃ© 5 nÃ­veis), organograma visual, resumo de ativos alocados/consumo mensal por subordinado, importaÃ§Ã£o em lote de consumidores via CSV/Excel com validaÃ§Ã£o de duplicatas e preview de erros, e exportaÃ§Ã£o Excel com filtros aplicados (limite 10.000 registros).

---

## ğŸ“ Fluxo Principal - Dashboard HierÃ¡rquico do Gestor

1. Gestor "Maria Santos" acessa "Minha Equipe"

2. Sistema consulta hierarquia recursiva:
   ```sql
   WITH RECURSIVE Subordinados AS (
     -- Base: Subordinados diretos
     SELECT Id_Consumidor, Nm_Consumidor, Matricula, Matricula_Chefia, 1 AS Nivel
     FROM Consumidor
     WHERE Matricula_Chefia = (SELECT Matricula FROM Consumidor WHERE Id_Consumidor = @IdGestor)
       AND Fl_Desativado = 2

     UNION ALL

     -- RecursÃ£o: Subordinados dos subordinados
     SELECT c.Id_Consumidor, c.Nm_Consumidor, c.Matricula, c.Matricula_Chefia, s.Nivel + 1
     FROM Consumidor c
     JOIN Subordinados s ON c.Matricula_Chefia = s.Matricula
     WHERE c.Fl_Desativado = 2 AND s.Nivel < 5  -- Limite 5 nÃ­veis
   )
   SELECT * FROM Subordinados;
   ```

3. Para cada subordinado, calcula:
   - Total de ativos alocados
   - Valor total dos ativos
   - Consumo mensal (se houver polÃ­tica)
   - Status da cota (OK/Alerta/CrÃ­tico)

4. Exibe:
   ```
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Minha Equipe - Maria Santos (Gerente TI)                 â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ ğŸ“Š Resumo:                                               â”‚
   â”‚ Total Subordinados: 15 (diretos) + 42 (indiretos) = 57  â”‚
   â”‚ Ativos Alocados: 128 ativos (R$ 542.000)                â”‚
   â”‚ Consumo Mensal: R$ 12.340 / R$ 15.000 (82%)             â”‚
   â”‚                                                          â”‚
   â”‚ ğŸŒ³ Organograma:                                          â”‚
   â”‚ Maria Santos (Gerente TI)                                â”‚
   â”‚ â”œâ”€ JoÃ£o Silva (Desenvolvedor Sr) - 3 ativos, R$ 280/mÃªs â”‚
   â”‚ â”‚  â””â”€ Pedro Costa (Dev Jr) - 2 ativos, R$ 150/mÃªs       â”‚
   â”‚ â”œâ”€ Ana Oliveira (Analista) - 2 ativos, R$ 210/mÃªs       â”‚
   â”‚ â””â”€ Carlos Lima (Coord. Suporte) - 4 ativos, R$ 320/mÃªs  â”‚
   â”‚    â”œâ”€ Lucas Moura (Analista) - 1 ativo, R$ 120/mÃªs      â”‚
   â”‚    â””â”€ Juliana Rocha (Analista) - 1 ativo, R$ 130/mÃªs    â”‚
   â”‚                                                          â”‚
   â”‚ ğŸ“‹ Lista Subordinados (view tabular):                    â”‚
   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
   â”‚ â”‚ Nome         â”‚ Ativosâ”‚ Valor  â”‚ Consumoâ”‚ Status Cotaâ”‚ â”‚
   â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
   â”‚ â”‚ JoÃ£o Silva   â”‚ 3     â”‚R$ 15k  â”‚R$ 280  â”‚ OK âœ…      â”‚ â”‚
   â”‚ â”‚ Ana Oliveira â”‚ 2     â”‚R$ 8k   â”‚R$ 210  â”‚ OK âœ…      â”‚ â”‚
   â”‚ â”‚ Carlos Lima  â”‚ 4     â”‚R$ 22k  â”‚R$ 320  â”‚ Alerta âš ï¸  â”‚ â”‚
   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
   â”‚                                                          â”‚
   â”‚ [ğŸ“¥ Exportar Excel] [ğŸ“Š GrÃ¡ficos Detalhados]             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ```

5. Clicar em subordinado abre modal com detalhes:
   - Ativos alocados (lista completa)
   - HistÃ³rico de consumo (grÃ¡fico 12 meses)
   - PolÃ­ticas ativas
   - Termos assinados

---

## ğŸ“ Fluxo SecundÃ¡rio - Import CSV/Excel (Cadastro em Lote)

1. Admin acessa "Consumidores â†’ Importar"

2. Faz upload de arquivo CSV/Excel:
   ```csv
   Nome,Matricula,Email,CPF,Cargo,Filial,CentroCusto,Status
   "JoÃ£o Silva","12345","joao@empresa.com","123.456.789-00","Desenvolvedor","SP-Matriz","TI","Ativo"
   "Maria Santos","12346","maria@empresa.com","987.654.321-00","Analista","SP-Matriz","TI","Ativo"
   ```

3. Sistema valida arquivo:
   - **Formato**: CSV (UTF-8) ou Excel (.xlsx)
   - **Colunas obrigatÃ³rias**: Nome, Matricula, Email
   - **Max 5.000 registros** por arquivo
   - **Tamanho**: Max 10MB

4. Preview com validaÃ§Ãµes:
   ```
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Preview ImportaÃ§Ã£o - 2.500 linhas                        â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ âœ… Validado: 2.450 (98%)                                 â”‚
   â”‚ âš ï¸  Avisos: 40 (2%) - Email duplicado, CPF invÃ¡lido      â”‚
   â”‚ âŒ Erros: 10 (<1%) - Nome vazio, Filial nÃ£o existe       â”‚
   â”‚                                                          â”‚
   â”‚ Linhas com Erro (nÃ£o serÃ£o importadas):                 â”‚
   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
   â”‚ â”‚ Linhaâ”‚ Nome            â”‚ Erro                       â”‚ â”‚
   â”‚ â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
   â”‚ â”‚ 23   â”‚ (vazio)         â”‚ Nome obrigatÃ³rio           â”‚ â”‚
   â”‚ â”‚ 145  â”‚ Pedro Costa     â”‚ Filial "RJ-Centro" nÃ£o ex. â”‚ â”‚
   â”‚ â”‚ 782  â”‚ Ana Oliveira    â”‚ Email invÃ¡lido (sem @)     â”‚ â”‚
   â”‚ â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
   â”‚                                                          â”‚
   â”‚ Linhas com Aviso (importar com atenÃ§Ã£o):                â”‚
   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
   â”‚ â”‚ Linhaâ”‚ Nome            â”‚ Aviso                      â”‚ â”‚
   â”‚ â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
   â”‚ â”‚ 45   â”‚ JoÃ£o Silva      â”‚ Email jÃ¡ existe (atualizar)â”‚ â”‚
   â”‚ â”‚ 67   â”‚ Maria Santos    â”‚ CPF invÃ¡lido (dÃ­gito errad)â”‚ â”‚
   â”‚ â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
   â”‚                                                          â”‚
   â”‚ OpÃ§Ãµes:                                                  â”‚
   â”‚ âšª Ignorar duplicatas (criar apenas novos)              â”‚
   â”‚ âš« Atualizar existentes (merge por matrÃ­cula/email)     â”‚
   â”‚ âšª Cancelar se houver qualquer erro                     â”‚
   â”‚                                                          â”‚
   â”‚ [ğŸ“¥ Baixar RelatÃ³rio Erros] [Cancelar] [Importar 2.450] â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ```

5. Clica "Importar 2.450"

6. Sistema processa em background (Hangfire):
   ```csharp
   [Queue("imports")]
   public async Task ProcessarImportacao(string fileId) {
       var rows = await _excelReader.Read(fileId);

       foreach (var row in rows.Where(r => r.IsValid)) {
           var consumidor = _mapper.Map<Consumidor>(row);

           var existing = await _repo.FindByMatricula(consumidor.Matricula);

           if (existing != null && _importMode == "Atualizar") {
               await _repo.Update(existing.Id, consumidor);
           } else if (existing == null) {
               await _repo.Create(consumidor);
           }
       }

       await _notificationService.Notify(adminUserId, $"ImportaÃ§Ã£o concluÃ­da! {rows.Count} consumidores processados.");
   }
   ```

7. NotificaÃ§Ã£o: "ImportaÃ§Ã£o concluÃ­da! 2.450 consumidores criados/atualizados. [Ver RelatÃ³rio]"

---

## ğŸ“ Fluxo TerciÃ¡rio - Export Excel

1. UsuÃ¡rio aplica filtros na listagem (ex: Filial = SP, Status = Ativo)
2. Clica "Exportar Excel"
3. Sistema gera Excel com colunas:
   - Nome, MatrÃ­cula, Email, CPF, Cargo
   - Filial, Centro Custo, Departamento
   - Status, Data AdmissÃ£o
   - Total Ativos, Valor Ativos
   - Consumo Mensal, Limite Cota
4. Download automÃ¡tico: `Consumidores_SP_Ativos_20250120.xlsx`
5. Limite: 10.000 registros por exportaÃ§Ã£o (se mais, sugerir filtros)

---

## âœ… ValidaÃ§Ãµes

| Campo | Regra |
|-------|-------|
| Hierarquia | Max 5 nÃ­veis recursivos (performance) |
| Import | Max 5.000 registros por arquivo |
| Export | Max 10.000 registros por exportaÃ§Ã£o |
| Colunas CSV | Nome, Matricula, Email obrigatÃ³rios |

---

## ğŸ“ Regras de NegÃ³cio

- **RN-UC07-001**: Hierarquia recursiva atÃ© 5 nÃ­veis (performance)
- **RN-UC07-002**: Import limitado a 5.000 registros por arquivo
- **RN-UC07-003**: ValidaÃ§Ã£o duplicatas em import (matrÃ­cula/email)
- **RN-UC07-004**: Export limitado a 10.000 registros
- **RN-UC07-005**: Processamento import assÃ­ncrono (Hangfire queue)

---

## ğŸ¨ Interface UI - Import

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Importar Consumidores                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“¤ Upload de Arquivo:                                    â”‚
â”‚ [ğŸ“ Selecionar CSV ou Excel...]                          â”‚
â”‚                                                          â”‚
â”‚ Formato suportado:                                       â”‚
â”‚ â€¢ CSV (UTF-8, separador vÃ­rgula ou ponto-e-vÃ­rgula)     â”‚
â”‚ â€¢ Excel (.xlsx)                                          â”‚
â”‚                                                          â”‚
â”‚ Colunas obrigatÃ³rias:                                    â”‚
â”‚ â€¢ Nome                                                   â”‚
â”‚ â€¢ Matricula                                              â”‚
â”‚ â€¢ Email                                                  â”‚
â”‚                                                          â”‚
â”‚ Colunas opcionais:                                       â”‚
â”‚ â€¢ CPF, Telefone_Celular, Cargo                          â”‚
â”‚ â€¢ Filial, Centro_Custo, Departamento                    â”‚
â”‚ â€¢ Status, Data_Admissao                                  â”‚
â”‚                                                          â”‚
â”‚ [ğŸ“¥ Baixar Template CSV] [ğŸ“¥ Baixar Template Excel]      â”‚
â”‚                                                          â”‚
â”‚ Limites:                                                 â”‚
â”‚ â€¢ MÃ¡ximo 5.000 registros por arquivo                     â”‚
â”‚ â€¢ Tamanho mÃ¡ximo 10MB                                    â”‚
â”‚                                                          â”‚
â”‚                      [Cancelar] [PrÃ³ximo]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” ObservaÃ§Ãµes TÃ©cnicas

### Consulta HierÃ¡rquica Recursiva

A query usa **Common Table Expression (CTE)** recursiva para buscar subordinados em mÃºltiplos nÃ­veis:

```sql
WITH RECURSIVE Subordinados AS (
  -- Ã‚ncora: Subordinados diretos (nÃ­vel 1)
  SELECT Id_Consumidor, Nm_Consumidor, Matricula, Matricula_Chefia, 1 AS Nivel
  FROM Consumidor
  WHERE Matricula_Chefia = @MatriculaGestor
    AND Fl_Desativado = 2

  UNION ALL

  -- RecursÃ£o: Subordinados dos subordinados (nÃ­vel 2+)
  SELECT c.Id_Consumidor, c.Nm_Consumidor, c.Matricula, c.Matricula_Chefia, s.Nivel + 1
  FROM Consumidor c
  JOIN Subordinados s ON c.Matricula_Chefia = s.Matricula
  WHERE c.Fl_Desativado = 2 AND s.Nivel < 5
)
SELECT * FROM Subordinados ORDER BY Nivel, Nm_Consumidor;
```

**Limite de 5 nÃ­veis**: Evita loops infinitos e garante performance.

### Processamento AssÃ­ncrono (Hangfire)

Import de 5.000 registros pode levar 1-2 minutos. Hangfire processa em background:

```csharp
[Queue("imports")]
public async Task ProcessarImportacao(string fileId) {
    // Processa em lote de 100 registros
    var batchSize = 100;
    // ...
}
```

---

---

## HistÃ³rico de AlteraÃ§Ãµes

| VersÃ£o | Data | Autor | DescriÃ§Ã£o |
|--------|------|-------|-----------|
| 1.0 | 2025-12-17 | Sistema | ConsolidaÃ§Ã£o de 4 casos de uso |
