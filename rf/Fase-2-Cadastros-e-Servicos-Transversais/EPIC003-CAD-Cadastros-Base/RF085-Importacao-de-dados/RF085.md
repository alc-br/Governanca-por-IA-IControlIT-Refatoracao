# RF085: Importação de Dados

**Versão**: 2.0
**Data**: 2025-12-31
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC003-CAD-Cadastros-Base
**Fase**: Fase 2 - Cadastros e Serviços Transversais

---

## 1. VISÃO GERAL

### 1.1 Descrição Geral

O módulo **Importação de Dados** é um serviço crítico de ETL (Extract, Transform, Load) responsável pelo processamento, mapeamento, transformação e validação de dados provenientes de múltiplas fontes e formatos (CSV, Excel, XML, JSON, EDI).

### 1.2 Objetivo Principal

Permitir que usuários autorizados importem grandes volumes de dados de sistemas externos para o IControlIT de forma controlada, auditada e resiliente, garantindo:

- Integridade e validação completa dos dados antes da persistência
- Rastreabilidade total de cada operação de importação
- Recuperação e rollback em caso de falhas
- Automação de importações recorrentes

### 1.3 Escopo do RF

**Dentro do escopo:**
- Criação e gerenciamento de templates de mapeamento de campos
- Transformação de dados com conversão de tipos e formatação
- Validação multi-camadas (estrutural, semântica, referencial, negócio)
- Detecção inteligente de duplicatas
- Importação incremental e full
- Agendamento recorrente de importações automáticas
- Histórico completo com capacidade de rollback
- Relatórios detalhados de erros com sugestões de correção
- API de status em tempo real com SignalR

**Fora do escopo:**
- Design específico da interface de usuário
- Implementação técnica de componentes frontend
- Estratégia de deploy ou infraestrutura cloud
- Integração com sistemas terceiros específicos (SAP, Oracle, etc.) - isso será tratado em RF futuros

### 1.4 Importância Estratégica

Este módulo é crítico para:

- **Migração de Sistemas**: Transição ordenada de dados entre sistemas sem perda de informação
- **Integrações B2B**: Recebimento automatizado de dados de ERPs, operadoras de telecom e fornecedores
- **Automatização de Processos**: Redução de trabalho manual através de agendamentos recorrentes
- **Conformidade Legal**: Auditoria completa de cada importação com retenção de 7 anos (LGPD)
- **Qualidade de Dados**: Validação rigorosa garante que apenas dados corretos são inseridos no sistema
- **Recuperação de Falhas**: Histórico completo permite identificar problemas e reverter operações

---

## 2. FUNCIONALIDADES

### F01: Gerenciamento de Templates de Importação

**Prioridade**: CRÍTICA

**Descrição**: Criação, edição e exclusão de templates que definem como dados de origem são mapeados para campos de destino no sistema.

**Capacidades**:
- Definir mapeamento campo origem → campo destino
- Especificar tipo de dados esperado (string, int, decimal, datetime, boolean, enum)
- Configurar obrigatoriedade de campos
- Definir regras de transformação (UPPER, TRIM, FORMAT_DATE, LOOKUP)
- Configurar regras de validação (regex, range, custom)
- Clonar templates existentes para reutilização

---

### F02: Transformação de Dados com Regras

**Prioridade**: ALTA

**Descrição**: Aplicação de transformações configuráveis sobre dados de origem antes da persistência.

**Capacidades**:
- Conversão de tipos de dados (string → decimal, string → datetime)
- Formatação de datas entre diferentes padrões (dd/MM/yyyy → yyyy-MM-dd)
- Normalização de strings (UPPER, LOWER, TRIM, CAPITALIZE)
- Cálculos aritméticos (UnitPrice * Quantity → Total)
- Lookups em tabelas de referência (CodigoFornecedor → IdFornecedor)
- Transformações condicionais (IF tipo = 'X' THEN categoria = 'Y')

---

### F03: Validação Multi-Camadas

**Prioridade**: CRÍTICA

**Descrição**: Sistema de validação em múltiplas camadas que garante integridade e conformidade dos dados.

**Camadas de validação**:

1. **Estrutural**: Campo presente? Tipo correto? Length dentro do limite?
2. **Semântica**: Email válido? Data no futuro? Status permitido?
3. **Referencial**: Foreign Key existe? Cliente ativo? Fornecedor aprovado?
4. **Negócio**: Preço > 0? Quantidade inteira? Datas sem sobreposição?

**Capacidades**:
- Validação antes de qualquer persistência (fail-fast)
- Relatório detalhado de erros com número da linha e sugestões
- Suporte a regras customizadas via expressões
- Validação transacional (tudo ou nada)

---

### F04: Detecção Inteligente de Duplicatas

**Prioridade**: ALTA

**Descrição**: Identificação automática de registros que já existem no sistema para evitar duplicação de dados.

**Estratégias de detecção**:
- Duplicata exata (todos os campos iguais)
- Duplicata por chave natural (CPF, Email, Código)
- Duplicata semelhante (fuzzy matching para strings similares)

**Estratégias de resolução**:
- **IGNORE**: Pula o registro duplicado (não insere)
- **REPLACE**: Substitui o registro existente (UPDATE)
- **REJECT**: Rejeita com erro para análise manual
- **MARK_AS_UPDATE**: Marca para processamento diferenciado

---

### F05: Importação Incremental

**Prioridade**: ALTA

**Descrição**: Processamento apenas de registros novos ou modificados desde a última importação.

**Capacidades**:
- Detecção de delta por timestamp (LastModifiedDate > UltimaImportacao)
- Detecção de delta por sequencial (Id > MaxIdImportado)
- Redução significativa de tempo de processamento em cargas recorrentes
- Atualização automática do timestamp de última execução

---

### F06: Importação Full com Delta Detection

**Prioridade**: MÉDIA

**Descrição**: Reprocessamento de todos os registros mas com detecção inteligente de mudanças reais antes de UPDATE.

**Capacidades**:
- Comparação campo a campo entre registro novo e existente
- UPDATE apenas se houver diferença real
- Útil para sincronização completa de estado
- Recomendado para dados que podem ser deletados após importação

---

### F07: Agendamento Recorrente (Hangfire)

**Prioridade**: ALTA

**Descrição**: Execução automática de importações em horários predefinidos sem intervenção manual.

**Capacidades**:
- Configuração via cron expressions ("0 2 * * *" = 2h todo dia)
- Retry automático em caso de falha (3 tentativas com backoff exponencial)
- Download automático de arquivos de fontes remotas (SFTP, S3, Azure Blob)
- Alertas por email/Slack em caso de falha
- Histórico de todas as execuções agendadas

---

### F08: Histórico Completo de Importações

**Prioridade**: CRÍTICA

**Descrição**: Registro detalhado de todas as importações executadas no sistema.

**Informações registradas**:
- Template utilizado
- Usuário que executou (ou "Sistema" se agendado)
- Timestamp de execução
- Modo (Incremental/Full)
- Quantidade de registros processados/inseridos/atualizados/rejeitados
- Lista completa de erros encontrados
- Status final (Sucesso/Falha Parcial/Falha Total)
- Capacidade de rollback

---

### F09: Rollback por Importação

**Prioridade**: ALTA

**Descrição**: Capacidade de reverter uma importação específica, restaurando o estado anterior do sistema.

**Capacidades**:
- Reversão completa de importações bem-sucedidas
- DELETE dos registros inseridos
- RESTORE dos registros atualizados (valores anteriores)
- Registro em auditoria da operação de rollback
- Rollback transacional (tudo ou nada)

**Restrições**:
- Apenas importações marcadas como `CanRollback=true` podem ser revertidas
- Importações com falha não podem ser revertidas (não há nada para desfazer)
- Após rollback, a importação não pode ser revertida novamente

---

### F10: Relatório de Erros com Sugestões

**Prioridade**: ALTA

**Descrição**: Geração automática de relatórios detalhados para importações com erros de validação.

**Informações no relatório**:
- Número da linha com erro
- Campo com problema
- Valor atual (rejeitado)
- Formato esperado
- Regra de validação violada
- Sugestão de correção automática

**Formatos de exportação**:
- HTML (visualização no navegador)
- CSV (correção no Excel e re-importação)
- JSON (integração com outras ferramentas)

---

### F11: Preview de Dados antes de Importar

**Prioridade**: ALTA

**Descrição**: Visualização das primeiras 100 linhas do arquivo com mapeamento, transformação e validação aplicados.

**Capacidades**:
- Carregar arquivo sem persistir
- Aplicar mapeamento e transformações
- Executar validações
- Mostrar preview em tabela com status por linha (OK/ERRO)
- Permitir ajustes antes de confirmar importação definitiva

---

### F12: Processamento Assíncrono com SignalR

**Prioridade**: ALTA

**Descrição**: Importações executadas em background com notificações em tempo real para o usuário.

**Capacidades**:
- Jobs executados via Hangfire (não bloqueiam UI)
- Notificações em tempo real via SignalR
- Barra de progresso com percentual e ETA
- Taxa de processamento (registros/segundo)
- Cancelamento de importação em andamento

---

### F13: API de Consulta de Status

**Prioridade**: ALTA

**Descrição**: Endpoint REST para consulta do status de importações em execução.

**Informações retornadas**:
- Status atual (Pending, Processing, Completed, Failed)
- Progresso percentual
- Registros processados / Total
- Tempo estimado restante (ETA)
- Erros encontrados até o momento
- Taxa de throughput

---

## 3. REGRAS DE NEGÓCIO

### RN-RF085-001: Mapeamento de Campos Obrigatório

**Descrição**: Toda importação deve usar um template de mapeamento que define explicitamente qual coluna de origem mapeia para qual campo de destino. Nenhuma coluna pode ser ignorada silenciosamente.

**Justificativa**: Evita perda de dados importantes e força o usuário a ser explícito sobre o mapeamento.

**Critério de Aceite**:
- Se arquivo contém coluna não mapeada → REJEITA com erro "Coluna 'X' não está mapeada"
- Se template mapeia coluna que não existe no arquivo → REJEITA com erro "Coluna esperada 'Y' não encontrada"

---

### RN-RF085-002: Transformação de Dados Conforme Template

**Descrição**: Todas as transformações aplicadas (conversão de tipos, formatação) devem estar documentadas no template. Transformação não documentada = erro na importação.

**Justificativa**: Auditoria e rastreabilidade. Garante que sabemos como cada campo foi transformado.

**Critério de Aceite**:
- Transformação aplicada deve estar no campo `TransformationRule` do template
- Se conversão falhar (ex: string "abc" → int) → REJEITA com erro detalhado

---

### RN-RF085-003: Validação de Dados Contra Regras de Negócio

**Descrição**: Cada campo deve ser validado contra regras de negócio antes de ser inserido. Se qualquer validação falhar, a linha é rejeitada com detalhamento do erro.

**Justificativa**: Garante integridade de dados. Banco de dados recebe apenas dados válidos.

**Critério de Aceite**:
- Campo obrigatório ausente → REJEITA com erro "Campo 'X' é obrigatório"
- Valor fora do range → REJEITA com erro "Valor 'Y' está fora do intervalo permitido"
- Foreign Key inexistente → REJEITA com erro "Referência 'Z' não existe no sistema"

---

### RN-RF085-004: Detecção de Duplicatas por Chave Natural

**Descrição**: Sistema detecta automaticamente se um registro (parcial ou total) já existe no banco antes de inserir. Estratégia: ignorar, substituir ou rejeitar.

**Justificativa**: Evita duplicação de dados em importações repetidas.

**Critério de Aceite**:
- Se chave natural existe e estratégia=IGNORE → Não insere (SkippedRecords++)
- Se chave natural existe e estratégia=REPLACE → UPDATE do registro existente (UpdatedRecords++)
- Se chave natural existe e estratégia=REJECT → Erro "Duplicata detectada" (RejectedRecords++)

---

### RN-RF085-005: Importação Incremental (Delta Detection)

**Descrição**: Se importação está configurada como "Incremental", sistema processa apenas registros novos ou modificados desde última execução.

**Justificativa**: Performance em arquivos grandes processados recorrentemente.

**Critério de Aceite**:
- Se modo=Incremental e campo deltaDetectionColumn existe → Filtra registros com deltaValue > LastFullImportDate
- Se modo=Full → Processa todos os registros

---

### RN-RF085-006: Agendamento Recorrente com Hangfire

**Descrição**: Importações podem ser agendadas para executar automaticamente em horários específicos via Hangfire. Sistema retenta automaticamente se falhar.

**Justificativa**: Automação de processos recorrentes sem intervenção manual.

**Critério de Aceite**:
- Job executado conforme cron expression definida
- Se falhar → Retry 3x com backoff exponencial (5min, 10min, 20min)
- Se 3 falhas → Email de alerta para administrador

---

### RN-RF085-007: Histórico de Importações com Rollback

**Descrição**: Cada importação é registrada em tabela de auditoria. Dados sobre importação podem ser consultados. Rollback permite desfazer uma importação específica.

**Justificativa**: Rastreabilidade e recuperação em caso de erro.

**Critério de Aceite**:
- Registro criado em ImportHistory com todos os metadados
- Se IsSuccessful=true → CanRollback=true
- Se IsSuccessful=false → CanRollback=false

---

### RN-RF085-008: Validação Transacional (Tudo ou Nada)

**Descrição**: Importação é executada dentro de uma transação SQL. Se qualquer linha falhar na validação ou inserção, TODA a transação é revertida.

**Justificativa**: Evita estado parcial. Melhor falhar tudo do que inserir metade dos dados.

**Critério de Aceite**:
- Se qualquer erro de validação → ROLLBACK antes de qualquer INSERT
- Se erro em INSERT → ROLLBACK de todos os INSERTs anteriores
- Se tudo OK → COMMIT

---

### RN-RF085-009: API de Status de Importação em Tempo Real

**Descrição**: Endpoint GET /api/imports/{id}/status retorna progresso de importação em execução (percentual, registros processados, ETA), atualizado via SignalR.

**Justificativa**: UX. Usuário acompanha importação grande sem UI congelada.

**Critério de Aceite**:
- Atualização a cada 100 registros processados
- Informações: ProcessedRecords, TotalRecords, PercentComplete, ETA, Status
- SignalR envia notificação em tempo real para clientes conectados

---

### RN-RF085-010: Relatório Detalhado de Erros com Sugestões

**Descrição**: Quando importação falha com validações, sistema gera relatório detalhado listando cada linha rejeitada com: número da linha, valor original, erro específico, sugestão de correção.

**Justificativa**: Facilita correção. Usuário sabe exatamente o que arrumar.

**Critério de Aceite**:
- Relatório contém todas as linhas rejeitadas
- Para cada erro: LineNumber, FieldName, ActualValue, ValidationRule, Suggestion
- Formatos disponíveis: HTML, CSV, JSON

---

### RN-RF085-011: Isolamento Multi-Tenant

**Descrição**: Todas as importações e dados importados respeitam isolamento por ClienteId. Usuário do cliente A não pode importar dados do cliente B.

**Justificativa**: Segurança e conformidade LGPD.

**Critério de Aceite**:
- Todo registro inserido via importação recebe ClienteId do usuário logado
- Query filters do EF Core garantem isolamento automático
- Tentativa de importar dados com ClienteId diferente → REJEITA com 403

---

### RN-RF085-012: Validação de Tamanho e Tipo de Arquivo

**Descrição**: Sistema valida tipo MIME, extensão e tamanho do arquivo antes de qualquer processamento.

**Justificativa**: Segurança e performance.

**Critério de Aceite**:
- Tamanho > 500MB → REJEITA com erro "Arquivo excede limite"
- Extensão não permitida (.exe, .dll, .bat) → REJEITA com erro "Tipo de arquivo não suportado"
- MIME type inválido → REJEITA com erro "MIME type não permitido"

---

### RN-RF085-013: Scan Antivírus Obrigatório

**Descrição**: Todo arquivo carregado é escaneado por ClamAV antes de processamento.

**Justificativa**: Segurança contra malware.

**Critério de Aceite**:
- Scan clean → Continua processamento
- Malware detectado → REJEITA arquivo e registra em auditoria

---

## 4. INTEGRAÇÕES OBRIGATÓRIAS

### 4.1 Central de Funcionalidades (Feature Flags)

**FeatureKey**: `IMP_IMPORTACAO_DADOS`

**Sub-features**:
- `IMP_INCREMENTAL`: Importação incremental (delta detection)
- `IMP_AGENDAMENTO`: Agendamento recorrente de importações
- `IMP_PREVIEW`: Preview de dados antes de confirmar
- `IMP_ROLLBACK`: Reversão de importações

**Configuração**:
- Feature pode ser desabilitada por cliente
- Se desabilitada: Módulo inteiro fica indisponível
- Sub-features controlam funcionalidades específicas

---

### 4.2 Internacionalização (i18n)

**Idiomas suportados**: pt-BR (padrão), en, es

**Chaves principais**:

```
import.page.title
import.page.tabs.manual
import.page.tabs.template
import.page.tabs.scheduled
import.page.tabs.history
import.form.selectTemplate
import.form.selectFile
import.form.selectMode
import.form.duplicateStrategy
import.messages.uploadSuccess
import.messages.importStarted
import.messages.importCompleted
import.messages.importFailed
import.validation.fileRequired
import.validation.fileTooLarge
import.validation.invalidFileType
import.errors.required
import.errors.invalidEmail
import.errors.invalidDate
import.errors.outOfRange
import.errors.foreignKeyNotFound
import.errors.duplicateDetected
```

---

### 4.3 Auditoria

**Operações auditadas**:

| Operação | Código | Dados Registrados |
|----------|--------|-------------------|
| Criação de Template | `IMP_TEMPLATE_CREATE` | Template ID, Nome, Mapeamentos |
| Alteração de Template | `IMP_TEMPLATE_UPDATE` | Template ID, Campos alterados |
| Exclusão de Template | `IMP_TEMPLATE_DELETE` | Template ID, Nome |
| Upload de Arquivo | `IMP_FILE_UPLOAD` | Arquivo ID, Nome, Tamanho, Hash |
| Scan Antivírus | `IMP_ANTIVIRUS_SCAN` | Arquivo ID, Resultado |
| Execução de Importação | `IMP_EXECUTION_START` | Import ID, Template ID, Usuário |
| Conclusão de Importação | `IMP_EXECUTION_COMPLETE` | Import ID, Total, Inseridos, Erros |
| Detecção de Duplicata | `IMP_DUPLICATE_DETECTED` | Chave, Valor, Estratégia |
| Erro de Validação | `IMP_VALIDATION_ERROR` | Linha, Campo, Erro |
| Rollback Executado | `IMP_ROLLBACK_EXECUTED` | Import ID, Registros deletados |

**Retenção**: 7 anos (LGPD)

---

### 4.4 Controle de Acesso (RBAC)

**Permissões**:

| Permissão | Descrição | Perfis Autorizados |
|-----------|-----------|-------------------|
| `imp:template:create` | Criar template | Admin, Gestor Financeiro, TI |
| `imp:template:read` | Visualizar templates | Todos autenticados |
| `imp:template:update` | Editar template | Admin, Gestor Financeiro |
| `imp:template:delete` | Deletar template | Admin |
| `imp:import:create` | Executar importação | Admin, Gestor Financeiro, TI, Analista Dados |
| `imp:import:read` | Visualizar importações | Todos autenticados |
| `imp:import:preview` | Preview de dados | Admin, Gestor Financeiro, Analista Dados |
| `imp:import:rollback` | Reverter importação | Admin (apenas) |
| `imp:schedule:create` | Criar agendamento | Admin, TI |
| `imp:schedule:read` | Visualizar agendamentos | Admin, Gestor Financeiro, TI |
| `imp:schedule:update` | Editar agendamento | Admin, TI |
| `imp:schedule:delete` | Deletar agendamento | Admin |
| `imp:import:export_errors` | Exportar erros | Admin, Gestor Financeiro, Analista Dados |

---

## 5. PERMISSÕES RBAC

| Funcionalidade | Permission Code | Roles Autorizadas |
|----------------|----------------|-------------------|
| Criar Template | `IMP.TEMPLATE.CREATE` | Super Admin, Admin, Gestor Financeiro, TI |
| Visualizar Templates | `IMP.TEMPLATE.READ` | Todos autenticados |
| Editar Template | `IMP.TEMPLATE.UPDATE` | Super Admin, Admin, Gestor Financeiro |
| Deletar Template | `IMP.TEMPLATE.DELETE` | Super Admin, Admin |
| Executar Importação | `IMP.IMPORT.CREATE` | Super Admin, Admin, Gestor Financeiro, TI, Analista Dados |
| Visualizar Importações | `IMP.IMPORT.READ` | Todos autenticados |
| Preview de Dados | `IMP.IMPORT.PREVIEW` | Super Admin, Admin, Gestor Financeiro, Analista Dados |
| Rollback | `IMP.IMPORT.ROLLBACK` | Super Admin, Admin |
| Criar Agendamento | `IMP.SCHEDULE.CREATE` | Super Admin, Admin, TI |
| Visualizar Agendamentos | `IMP.SCHEDULE.READ` | Super Admin, Admin, Gestor Financeiro, TI |
| Editar Agendamento | `IMP.SCHEDULE.UPDATE` | Super Admin, Admin, TI |
| Deletar Agendamento | `IMP.SCHEDULE.DELETE` | Super Admin, Admin |
| Exportar Erros | `IMP.IMPORT.EXPORT_ERRORS` | Super Admin, Admin, Gestor Financeiro, Analista Dados |

---

## 6. API ENDPOINTS

### 6.1 CRUD de Templates

| Método | Endpoint | Descrição | Autorização |
|--------|----------|-----------|-------------|
| GET | `/api/imports/templates` | Listar templates | `IMP.TEMPLATE.READ` |
| GET | `/api/imports/templates/{id}` | Obter template por ID | `IMP.TEMPLATE.READ` |
| POST | `/api/imports/templates` | Criar novo template | `IMP.TEMPLATE.CREATE` |
| PUT | `/api/imports/templates/{id}` | Atualizar template | `IMP.TEMPLATE.UPDATE` |
| DELETE | `/api/imports/templates/{id}` | Deletar template | `IMP.TEMPLATE.DELETE` |
| POST | `/api/imports/templates/{id}/clone` | Clonar template | `IMP.TEMPLATE.CREATE` |

### 6.2 Operações de Importação

| Método | Endpoint | Descrição | Autorização |
|--------|----------|-----------|-------------|
| POST | `/api/imports` | Executar importação manual | `IMP.IMPORT.CREATE` |
| GET | `/api/imports/{id}` | Obter detalhe de importação | `IMP.IMPORT.READ` |
| GET | `/api/imports/{id}/status` | Status em tempo real | `IMP.IMPORT.READ` |
| GET | `/api/imports/{id}/errors` | Erros da importação | `IMP.IMPORT.READ` |
| GET | `/api/imports/{id}/errors/download` | Baixar relatório (HTML/CSV) | `IMP.IMPORT.EXPORT_ERRORS` |
| POST | `/api/imports/{id}/rollback` | Reverter importação | `IMP.IMPORT.ROLLBACK` |
| POST | `/api/imports/preview` | Preview de dados | `IMP.IMPORT.PREVIEW` |

### 6.3 Agendamentos

| Método | Endpoint | Descrição | Autorização |
|--------|----------|-----------|-------------|
| GET | `/api/imports/scheduled` | Listar agendamentos | `IMP.SCHEDULE.READ` |
| GET | `/api/imports/scheduled/{id}` | Obter agendamento | `IMP.SCHEDULE.READ` |
| POST | `/api/imports/scheduled` | Criar agendamento | `IMP.SCHEDULE.CREATE` |
| PUT | `/api/imports/scheduled/{id}` | Atualizar agendamento | `IMP.SCHEDULE.UPDATE` |
| DELETE | `/api/imports/scheduled/{id}` | Deletar agendamento | `IMP.SCHEDULE.DELETE` |
| POST | `/api/imports/scheduled/{id}/execute` | Executar manualmente | `IMP.SCHEDULE.CREATE` |
| POST | `/api/imports/scheduled/{id}/disable` | Desabilitar agendamento | `IMP.SCHEDULE.UPDATE` |

### 6.4 Histórico

| Método | Endpoint | Descrição | Autorização |
|--------|----------|-----------|-------------|
| GET | `/api/imports/history` | Listar histórico | `IMP.IMPORT.READ` |
| GET | `/api/imports/history?templateId={id}` | Filtrar por template | `IMP.IMPORT.READ` |
| GET | `/api/imports/history/{id}` | Detalhe de importação | `IMP.IMPORT.READ` |

---

## 7. MODELO DE DADOS

**Referência completa**: Ver arquivo [MD-RF085-Importacao-de-Dados.md](./MD-RF085-Importacao-de-Dados.md)

**Principais entidades**:

- **ImportTemplate**: Template de mapeamento e configuração de importação
- **FieldMapping**: Mapeamento de campo origem → destino com transformações e validações
- **ValidationRule**: Regras de validação aplicadas durante importação
- **Import**: Registro de uma importação executada
- **ImportHistory**: Histórico completo de importações com metadados
- **ScheduledImport**: Agendamento recorrente de importação
- **ImportError**: Erros de validação encontrados em uma importação

**Relacionamentos críticos**:

- ImportTemplate 1 → N FieldMapping
- ImportTemplate 1 → N ValidationRule
- ImportTemplate 1 → N Import
- Import 1 → 1 ImportHistory
- Import 1 → N ImportError
- ImportTemplate 1 → N ScheduledImport

**Multi-tenancy**: Todas as tabelas possuem `ClienteId` com índice composto.

**Auditoria**: Todas as tabelas possuem campos `Created`, `CreatedBy`, `LastModified`, `LastModifiedBy`.

---

## 8. DEPENDÊNCIAS

### 8.1 RFs Dependentes (Upstream)

| RF | Descrição | Motivo |
|----|-----------|--------|
| RF084 | Upload/Importação | RF085 depende de RF084 para upload de arquivos |
| RF001 | Parâmetros e Configurações | Configurações globais de importação (tamanho máximo, etc.) |
| RF006 | Gestão de Usuários | Auditoria de quem executou cada importação |
| RF007 | Gestão de Perfis de Acesso | Permissões RBAC |

### 8.2 RFs que Dependem Deste (Downstream)

| RF | Descrição | Motivo |
|----|-----------|--------|
| RF086 | Carga de Faturas/Consumo | Usa RF085 para importar faturas de operadoras |
| RF087 | Importação de Ativos | Usa RF085 para importar inventário de ativos |
| RF088 | Importação de Clientes | Usa RF085 para migração de dados de clientes |

### 8.3 Dependências de Bibliotecas

- **CsvHelper**: Leitura de arquivos CSV
- **EPPlus**: Leitura de arquivos Excel (XLSX)
- **System.Xml.Linq**: Leitura de arquivos XML
- **Newtonsoft.Json**: Leitura de arquivos JSON
- **Hangfire**: Agendamento de jobs em background
- **ClamAV.Net**: Scan de antivírus
- **SignalR**: Notificações em tempo real

---

## 9. KPIs E MÉTRICAS

| KPI | Meta | Medição |
|-----|------|---------|
| Taxa de Sucesso | > 95% | (ImportaçõesComSucesso / TotalImportações) * 100 |
| Tempo Médio | < 5 min | Média dos TempoDuracao |
| Taxa de Erros de Validação | < 2% | (RegistrosRejeitados / TotalProcessados) * 100 |
| Taxa de Detecção de Duplicatas | 10-20% | (DuplicatasDetectadas / TotalImportados) * 100 |
| Disponibilidade | > 99.5% | (TempoOperacional / TempoTotal) * 100 |
| Throughput | > 1000 reg/seg | RegistrosProcessados / TempoProcessamento |
| Taxa de Rollback | < 1% | (ImportaçõesRevertidas / TotalImportações) * 100 |

---

## 10. ALERTAS CRÍTICOS

| Alerta | Condição | Threshold | Canal |
|--------|----------|-----------|-------|
| Importação com Erro | IsSuccessful = false | Imediato | Email + Slack |
| Taxa de Erros Alta | RejectedRecords > 10% | Imediato | Email |
| Agendamento Falhou | Job não completou em 1h | Após 3 retries | Email + Slack |
| Espaço em Disco Baixo | Azure Blob > 80% quota | Diário | Email DevOps |
| Throughput Degradado | < 500 reg/seg | Após 5 min | Email DevOps |
| Malware Detectado | ClamAV positivo | Imediato | Email Segurança + Slack |
| Tempo de Processamento Longo | > 20 min | Imediato | Email DevOps |
| Tentativas 403 Recorrentes | > 5 em 1 min | Imediato | Email Segurança |

---

## 11. CENTRAL DE FUNCIONALIDADES

**Código da Funcionalidade**: `IMP_IMPORTACAO_DADOS`

**Módulo**: Configurações → Importação de Dados

**Chaves i18n**:

- **Menu**: `menu.configuracoes.importacao`
- **Título da Página**: `import.page.title`
- **Descrição**: `import.page.subtitle`

**Sub-funcionalidades**:

- `IMP_TEMPLATE_MANAGEMENT`: Gerenciamento de Templates
- `IMP_MANUAL_IMPORT`: Importação Manual
- `IMP_SCHEDULED_IMPORT`: Importações Agendadas
- `IMP_IMPORT_HISTORY`: Histórico de Importações
- `IMP_PREVIEW`: Preview de Dados
- `IMP_ROLLBACK`: Reversão de Importações

**Habilitação**:

- Funcionalidade pode ser desabilitada por cliente
- Se desabilitada: Todo o módulo fica indisponível

---

## REFERÊNCIAS

Para consultar a memória técnica do sistema anterior, incluindo:
- Telas descontinuadas
- Serviços web antigos
- Stored Procedures
- Tabelas descontinuadas
- Regras de negócio implícitas extraídas da implementação anterior

➡️ **Consultar**: `RL-RF085.md` (Referência ao Legado)

Este documento contém EXCLUSIVAMENTE a especificação do sistema moderno. Toda memória histórica foi movida para o documento de referência separado.

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-31 | Migração v1.0 → v2.0: Separação RF/RL, reestruturação completa, 13 regras de negócio, 13 endpoints REST, integrações obrigatórias | Agência ALC - alc.dev.br |
| 1.0 | 2025-12-28 | Versão inicial com referências ao legado misturadas | Claude |

---

**Última Atualização**: 2025-12-31
**Status**: Aprovado para desenvolvimento
**Próximos Artefatos**: UC-RF085.md, MD-RF085.md, WF-RF085.md
