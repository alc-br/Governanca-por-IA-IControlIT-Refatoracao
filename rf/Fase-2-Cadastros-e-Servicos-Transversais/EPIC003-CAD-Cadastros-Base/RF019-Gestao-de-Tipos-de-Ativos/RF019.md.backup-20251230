# RF019: Gest√£o de Tipos de Ativos

**Vers√£o**: 1.0 | **Data**: 2025-12-28
**RF Relacionado**: RF016 (Categorias de Ativos) | **EPIC**: EPIC003-CAD-Cadastros-Base
**Fase**: Fase 2 - Cadastros e Servi√ßos Transversais

---

## üìã VIS√ÉO GERAL

### Descri√ß√£o

O m√≥dulo de **Gest√£o de Tipos de Ativos** √© respons√°vel por categorizar e classificar todos os ativos de TI e Telecom gerenciados pelo sistema IControlIT. Cada ativo (equipamento, linha telef√¥nica, software, servi√ßo) deve obrigatoriamente estar associado a um tipo que define suas caracter√≠sticas, comportamento e regras de neg√≥cio.

### Objetivo

Permitir que a organiza√ß√£o:

- **Classifique ativos** em categorias (Hardware, Software, Linha M√≥vel, Linha Fixa, Servi√ßos, etc.)
- **Defina caracter√≠sticas** espec√≠ficas por tipo (campos customizados)
- **Aplique regras de neg√≥cio** diferenciadas por tipo (deprecia√ß√£o, manuten√ß√£o, faturamento)
- **Organize invent√°rio** com estrutura hier√°rquica de tipos
- **Padronize nomenclatura** e taxonomia de ativos
- **Controle atributos obrigat√≥rios** por tipo de ativo

### Escopo

Este requisito cobre:

1. ‚úÖ CRUD completo de tipos de ativos
2. ‚úÖ Hierarquia de tipos (Tipo Pai ‚Üí Subtipo)
3. ‚úÖ Campos customizados por tipo
4. ‚úÖ Regras de deprecia√ß√£o por tipo
5. ‚úÖ √çcones e identifica√ß√£o visual
6. ‚úÖ Importa√ß√£o em massa de tipos
7. ‚úÖ Valida√ß√µes e restri√ß√µes
8. ‚úÖ Integra√ß√£o com m√≥dulo de Ativos (RF-CAD-001)
9. ‚úÖ Auditoria de altera√ß√µes
10. ‚úÖ Relat√≥rios de tipos mais utilizados

### Telas Legado Relacionadas

| Tela | Arquivo | Descri√ß√£o |
|------|---------|-----------|
| **Tipo de Ativo** | `Cadastro\Ativo_Tipo.aspx(.vb)` | CRUD de tipos de ativos |

---

## 1. Banco de Dados

### 1.1 Tabela: Ativo_Tipo

```sql
CREATE TABLE Ativo_Tipo (
    Id_Ativo_Tipo            UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    Id_Conglomerado          UNIQUEIDENTIFIER NOT NULL,

    -- Identifica√ß√£o
    Cd_Tipo                  VARCHAR(20) NOT NULL,                -- C√≥digo √∫nico (ex: "DESK-01", "NOTE-01")
    Nm_Tipo                  VARCHAR(200) NOT NULL,               -- Nome (ex: "Desktop", "Notebook")
    Ds_Tipo                  NVARCHAR(1000) NULL,                 -- Descri√ß√£o detalhada

    -- Hierarquia
    Id_Tipo_Pai              UNIQUEIDENTIFIER NULL,               -- Tipo pai (para hierarquia)
    Nivel_Hierarquia         INT NOT NULL DEFAULT 1,              -- N√≠vel na √°rvore (1=raiz)
    Caminho_Hierarquia       VARCHAR(500) NULL,                   -- Ex: "/Hardware/Computadores/Notebooks"

    -- Categoria Principal
    Categoria_Principal      VARCHAR(50) NOT NULL,                -- Hardware, Software, LinhaMovel, LinhaFixa, Servico, Licenca
    Subcategoria             VARCHAR(50) NULL,                    -- Desktop, Notebook, Servidor, Impressora, etc.

    -- Caracter√≠sticas do Tipo
    Fl_Inventariavel         BIT NOT NULL DEFAULT 1,              -- 1=Aparece em invent√°rio f√≠sico
    Fl_Depreciavel           BIT NOT NULL DEFAULT 1,              -- 1=Sofre deprecia√ß√£o
    Fl_Rastreavel            BIT NOT NULL DEFAULT 1,              -- 1=Requer localiza√ß√£o f√≠sica
    Fl_Faturavel             BIT NOT NULL DEFAULT 0,              -- 1=Gera faturamento recorrente
    Fl_Requer_Serial         BIT NOT NULL DEFAULT 1,              -- 1=N√∫mero de s√©rie obrigat√≥rio
    Fl_Requer_IMEI           BIT NOT NULL DEFAULT 0,              -- 1=IMEI obrigat√≥rio (dispositivos m√≥veis)
    Fl_Requer_MAC            BIT NOT NULL DEFAULT 0,              -- 1=MAC Address obrigat√≥rio

    -- Deprecia√ß√£o
    Taxa_Depreciacao_Anual   DECIMAL(5,2) NULL,                   -- % ao ano (ex: 20.00 = 20%)
    Vida_Util_Anos           INT NULL,                            -- Anos de vida √∫til estimada
    Metodo_Depreciacao       VARCHAR(50) NULL,                    -- Linear, DeclinioAcelerado, SomaDigitos

    -- Manuten√ß√£o
    Intervalo_Manutencao_Dias INT NULL,                           -- Dias entre manuten√ß√µes preventivas
    Fl_Requer_Calibracao     BIT NOT NULL DEFAULT 0,              -- 1=Requer calibra√ß√£o peri√≥dica

    -- Identifica√ß√£o Visual
    Icone                    VARCHAR(50) NULL,                    -- Classe CSS do √≠cone (ex: "fa-laptop")
    Cor_Identificacao        VARCHAR(7) NULL,                     -- Hex color (ex: "#3498db")

    -- Campos Customizados
    Template_Campos_Custom   NVARCHAR(MAX) NULL,                  -- JSON com defini√ß√£o de campos extras

    -- Controle
    Ordem_Exibicao           INT NOT NULL DEFAULT 100,            -- Ordem para listagens
    Fl_Ativo                 BIT NOT NULL DEFAULT 1,              -- 1=Ativo, 0=Inativo
    Fl_Sistema               BIT NOT NULL DEFAULT 0,              -- 1=Tipo padr√£o do sistema (n√£o edit√°vel)

    -- Auditoria
    Dt_Criacao               DATETIME NOT NULL DEFAULT GETDATE(),
    Id_Usuario_Criacao       UNIQUEIDENTIFIER NULL,
    Dt_Ult_Atualizacao       DATETIME NULL,
    Id_Usuario_Atualizacao   UNIQUEIDENTIFIER NULL,

    -- Constraints
    CONSTRAINT FK_AtivoTipo_TipoPai FOREIGN KEY (Id_Tipo_Pai) REFERENCES Ativo_Tipo(Id_Ativo_Tipo),
    CONSTRAINT UK_AtivoTipo_Codigo UNIQUE (Id_Conglomerado, Cd_Tipo),
    CONSTRAINT CK_AtivoTipo_Categoria CHECK (Categoria_Principal IN ('Hardware', 'Software', 'LinhaMovel', 'LinhaFixa', 'Servico', 'Licenca', 'Acessorio', 'Outro')),
    CONSTRAINT CK_AtivoTipo_MetodoDepreciacao CHECK (Metodo_Depreciacao IS NULL OR Metodo_Depreciacao IN ('Linear', 'DeclinioAcelerado', 'SomaDigitos')),
    CONSTRAINT CK_AtivoTipo_TaxaDepreciacao CHECK (Taxa_Depreciacao_Anual IS NULL OR (Taxa_Depreciacao_Anual >= 0 AND Taxa_Depreciacao_Anual <= 100))
);

CREATE INDEX IX_AtivoTipo_Conglomerado ON Ativo_Tipo(Id_Conglomerado, Fl_Ativo);
CREATE INDEX IX_AtivoTipo_TipoPai ON Ativo_Tipo(Id_Tipo_Pai);
CREATE INDEX IX_AtivoTipo_Categoria ON Ativo_Tipo(Categoria_Principal, Subcategoria);
CREATE INDEX IX_AtivoTipo_OrdemExibicao ON Ativo_Tipo(Ordem_Exibicao, Nm_Tipo);
```

---

### 1.2 Tabela: Ativo_Tipo_Campo_Customizado

```sql
CREATE TABLE Ativo_Tipo_Campo_Customizado (
    Id_Campo                 UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    Id_Ativo_Tipo            UNIQUEIDENTIFIER NOT NULL,

    -- Identifica√ß√£o do Campo
    Cd_Campo                 VARCHAR(50) NOT NULL,                -- C√≥digo do campo (ex: "velocidade_cpu")
    Nm_Campo                 VARCHAR(100) NOT NULL,               -- Nome exibido (ex: "Velocidade do CPU")
    Tipo_Dados               VARCHAR(20) NOT NULL,                -- String, Integer, Decimal, Date, Boolean, List

    -- Configura√ß√£o
    Fl_Obrigatorio           BIT NOT NULL DEFAULT 0,              -- 1=Campo obrigat√≥rio no cadastro de ativo
    Valor_Padrao             VARCHAR(500) NULL,                   -- Valor padr√£o
    Valores_Lista            NVARCHAR(MAX) NULL,                  -- JSON array para campos tipo List
    Mascara                  VARCHAR(100) NULL,                   -- M√°scara de formata√ß√£o

    -- Valida√ß√£o
    Validacao_Regex          VARCHAR(500) NULL,                   -- Express√£o regular para valida√ß√£o
    Mensagem_Validacao       NVARCHAR(200) NULL,                  -- Mensagem de erro customizada

    -- Exibi√ß√£o
    Ordem_Exibicao           INT NOT NULL DEFAULT 100,
    Fl_Exibir_Grid           BIT NOT NULL DEFAULT 1,              -- 1=Exibir em grids de listagem

    -- Controle
    Fl_Ativo                 BIT NOT NULL DEFAULT 1,
    Dt_Criacao               DATETIME NOT NULL DEFAULT GETDATE(),

    CONSTRAINT FK_AtivoTipoCampo_AtivoTipo FOREIGN KEY (Id_Ativo_Tipo) REFERENCES Ativo_Tipo(Id_Ativo_Tipo) ON DELETE CASCADE,
    CONSTRAINT UK_AtivoTipoCampo_Codigo UNIQUE (Id_Ativo_Tipo, Cd_Campo),
    CONSTRAINT CK_AtivoTipoCampo_TipoDados CHECK (Tipo_Dados IN ('String', 'Integer', 'Decimal', 'Date', 'Boolean', 'List', 'Text'))
);

CREATE INDEX IX_AtivoTipoCampo_AtivoTipo ON Ativo_Tipo_Campo_Customizado(Id_Ativo_Tipo, Fl_Ativo);
```

---

### 1.3 Tabela: Ativo_Tipo_Auditoria

```sql
CREATE TABLE Ativo_Tipo_Auditoria (
    Id_Auditoria             UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    Id_Ativo_Tipo            UNIQUEIDENTIFIER NOT NULL,

    -- Opera√ß√£o
    Tipo_Operacao            VARCHAR(20) NOT NULL,                -- INSERT, UPDATE, DELETE
    Dt_Operacao              DATETIME NOT NULL DEFAULT GETDATE(),
    Id_Usuario               UNIQUEIDENTIFIER NULL,
    Nm_Usuario               VARCHAR(200) NULL,
    IP_Origem                VARCHAR(45) NULL,

    -- Dados
    Dados_Antes              NVARCHAR(MAX) NULL,                  -- JSON do estado anterior
    Dados_Depois             NVARCHAR(MAX) NULL,                  -- JSON do estado posterior
    Campos_Alterados         VARCHAR(1000) NULL,                  -- Lista de campos alterados

    CONSTRAINT FK_AtivoTipoAuditoria_AtivoTipo FOREIGN KEY (Id_Ativo_Tipo) REFERENCES Ativo_Tipo(Id_Ativo_Tipo),
    CONSTRAINT CK_AtivoTipoAuditoria_TipoOp CHECK (Tipo_Operacao IN ('INSERT', 'UPDATE', 'DELETE'))
);

CREATE INDEX IX_AtivoTipoAuditoria_AtivoTipo ON Ativo_Tipo_Auditoria(Id_Ativo_Tipo, Dt_Operacao DESC);
CREATE INDEX IX_AtivoTipoAuditoria_Usuario ON Ativo_Tipo_Auditoria(Id_Usuario, Dt_Operacao DESC);
```

---

## 2. WebServices Legado (VB.NET)

### 2.1 WSAtivo.asmx - M√©todos de Tipo de Ativo

```vb
Imports System.Web.Services
Imports System.Data.SqlClient
Imports Newtonsoft.Json

<WebService(Namespace:="http://icontrolit.com.br/services/ativo")>
<WebServiceBinding(ConformsTo:=WsiProfiles.BasicProfile1_1)>
Public Class WSAtivo
    Inherits System.Web.Services.WebService

    Private ReadOnly connectionString As String = ConfigurationManager.ConnectionStrings("IControlIT").ConnectionString

    ' ========================================
    ' M√©todo: ListarTiposAtivo
    ' Descri√ß√£o: Lista todos os tipos de ativos ativos
    ' ========================================
    <WebMethod()>
    Public Function ListarTiposAtivo(ByVal token As String, ByVal idConglomerado As Guid) As List(Of AtivoTipoInfo)
        Try
            Dim usuario As Usuario = ValidarToken(token)

            Dim tipos As New List(Of AtivoTipoInfo)

            Using conn As New SqlConnection(connectionString)
                conn.Open()

                Dim sql As String = "SELECT Id_Ativo_Tipo, Cd_Tipo, Nm_Tipo, Ds_Tipo, Categoria_Principal, Subcategoria, Id_Tipo_Pai, Nivel_Hierarquia, Fl_Inventariavel, Fl_Depreciavel, Taxa_Depreciacao_Anual, Vida_Util_Anos, Icone, Cor_Identificacao, Ordem_Exibicao FROM Ativo_Tipo WHERE Id_Conglomerado = @IdConglomerado AND Fl_Ativo = 1 ORDER BY Ordem_Exibicao, Nm_Tipo"

                Dim cmd As New SqlCommand(sql, conn)
                cmd.Parameters.AddWithValue("@IdConglomerado", idConglomerado)

                Dim dr As SqlDataReader = cmd.ExecuteReader()
                While dr.Read()
                    tipos.Add(New AtivoTipoInfo With {
                        .IdAtivoTipo = DirectCast(dr("Id_Ativo_Tipo"), Guid),
                        .CdTipo = dr("Cd_Tipo").ToString(),
                        .NmTipo = dr("Nm_Tipo").ToString(),
                        .DsTipo = If(IsDBNull(dr("Ds_Tipo")), "", dr("Ds_Tipo").ToString()),
                        .CategoriaPrincipal = dr("Categoria_Principal").ToString(),
                        .Subcategoria = If(IsDBNull(dr("Subcategoria")), "", dr("Subcategoria").ToString()),
                        .IdTipoPai = If(IsDBNull(dr("Id_Tipo_Pai")), Nothing, DirectCast(dr("Id_Tipo_Pai"), Guid)),
                        .NivelHierarquia = CInt(dr("Nivel_Hierarquia")),
                        .FlInventariavel = CBool(dr("Fl_Inventariavel")),
                        .FlDepreciavel = CBool(dr("Fl_Depreciavel")),
                        .TaxaDepreciacaoAnual = If(IsDBNull(dr("Taxa_Depreciacao_Anual")), Nothing, CDec(dr("Taxa_Depreciacao_Anual"))),
                        .VidaUtilAnos = If(IsDBNull(dr("Vida_Util_Anos")), Nothing, CInt(dr("Vida_Util_Anos"))),
                        .Icone = If(IsDBNull(dr("Icone")), "", dr("Icone").ToString()),
                        .CorIdentificacao = If(IsDBNull(dr("Cor_Identificacao")), "", dr("Cor_Identificacao").ToString()),
                        .OrdemExibicao = CInt(dr("Ordem_Exibicao"))
                    })
                End While
            End Using

            Return tipos
        Catch ex As Exception
            Throw New Exception("Erro ao listar tipos de ativos: " & ex.Message)
        End Try
    End Function

    ' ========================================
    ' M√©todo: CriarTipoAtivo
    ' Descri√ß√£o: Cria novo tipo de ativo
    ' ========================================
    <WebMethod()>
    Public Function CriarTipoAtivo(ByVal token As String, ByVal idConglomerado As Guid, _
                                   ByVal cdTipo As String, ByVal nmTipo As String, _
                                   ByVal dsTipo As String, ByVal categoriaPrincipal As String, _
                                   ByVal subcategoria As String, ByVal idTipoPai As Guid?, _
                                   ByVal flInventariavel As Boolean, ByVal flDepreciavel As Boolean, _
                                   ByVal taxaDepreciacaoAnual As Decimal?, ByVal vidaUtilAnos As Integer?, _
                                   ByVal icone As String, ByVal corIdentificacao As String) As OperacaoResult
        Try
            Dim usuario As Usuario = ValidarToken(token)

            If Not TemPermissao(usuario, "cadastros:ativos:tipos:create") Then
                Throw New UnauthorizedAccessException("Usu√°rio sem permiss√£o para criar tipos de ativos")
            End If

            Using conn As New SqlConnection(connectionString)
                conn.Open()

                ' Verificar se c√≥digo j√° existe
                Dim cmdVerif As New SqlCommand("SELECT COUNT(*) FROM Ativo_Tipo WHERE Id_Conglomerado = @IdConglomerado AND Cd_Tipo = @CdTipo AND Fl_Ativo = 1", conn)
                cmdVerif.Parameters.AddWithValue("@IdConglomerado", idConglomerado)
                cmdVerif.Parameters.AddWithValue("@CdTipo", cdTipo)

                If CInt(cmdVerif.ExecuteScalar()) > 0 Then
                    Throw New Exception("J√° existe um tipo de ativo com este c√≥digo")
                End If

                ' Determinar n√≠vel hier√°rquico
                Dim nivelHierarquia As Integer = 1
                Dim caminhoHierarquia As String = "/" & nmTipo

                If idTipoPai.HasValue Then
                    Dim cmdPai As New SqlCommand("SELECT Nivel_Hierarquia, Caminho_Hierarquia FROM Ativo_Tipo WHERE Id_Ativo_Tipo = @IdTipoPai", conn)
                    cmdPai.Parameters.AddWithValue("@IdTipoPai", idTipoPai.Value)
                    Dim drPai As SqlDataReader = cmdPai.ExecuteReader()
                    If drPai.Read() Then
                        nivelHierarquia = CInt(drPai("Nivel_Hierarquia")) + 1
                        caminhoHierarquia = drPai("Caminho_Hierarquia").ToString() & "/" & nmTipo
                    End If
                    drPai.Close()
                End If

                ' Inserir tipo de ativo
                Dim idTipo As Guid = Guid.NewGuid()
                Dim sql As String = "INSERT INTO Ativo_Tipo (Id_Ativo_Tipo, Id_Conglomerado, Cd_Tipo, Nm_Tipo, Ds_Tipo, Categoria_Principal, Subcategoria, Id_Tipo_Pai, Nivel_Hierarquia, Caminho_Hierarquia, Fl_Inventariavel, Fl_Depreciavel, Taxa_Depreciacao_Anual, Vida_Util_Anos, Icone, Cor_Identificacao, Dt_Criacao, Id_Usuario_Criacao) VALUES (@IdTipo, @IdConglomerado, @CdTipo, @NmTipo, @DsTipo, @Categoria, @Subcategoria, @IdTipoPai, @NivelHierarquia, @CaminhoHierarquia, @FlInventariavel, @FlDepreciavel, @TaxaDepreciacao, @VidaUtil, @Icone, @Cor, GETDATE(), @IdUsuario)"

                Dim cmd As New SqlCommand(sql, conn)
                cmd.Parameters.AddWithValue("@IdTipo", idTipo)
                cmd.Parameters.AddWithValue("@IdConglomerado", idConglomerado)
                cmd.Parameters.AddWithValue("@CdTipo", cdTipo)
                cmd.Parameters.AddWithValue("@NmTipo", nmTipo)
                cmd.Parameters.AddWithValue("@DsTipo", If(String.IsNullOrEmpty(dsTipo), DBNull.Value, dsTipo))
                cmd.Parameters.AddWithValue("@Categoria", categoriaPrincipal)
                cmd.Parameters.AddWithValue("@Subcategoria", If(String.IsNullOrEmpty(subcategoria), DBNull.Value, subcategoria))
                cmd.Parameters.AddWithValue("@IdTipoPai", If(idTipoPai.HasValue, idTipoPai.Value, DBNull.Value))
                cmd.Parameters.AddWithValue("@NivelHierarquia", nivelHierarquia)
                cmd.Parameters.AddWithValue("@CaminhoHierarquia", caminhoHierarquia)
                cmd.Parameters.AddWithValue("@FlInventariavel", flInventariavel)
                cmd.Parameters.AddWithValue("@FlDepreciavel", flDepreciavel)
                cmd.Parameters.AddWithValue("@TaxaDepreciacao", If(taxaDepreciacaoAnual.HasValue, taxaDepreciacaoAnual.Value, DBNull.Value))
                cmd.Parameters.AddWithValue("@VidaUtil", If(vidaUtilAnos.HasValue, vidaUtilAnos.Value, DBNull.Value))
                cmd.Parameters.AddWithValue("@Icone", If(String.IsNullOrEmpty(icone), DBNull.Value, icone))
                cmd.Parameters.AddWithValue("@Cor", If(String.IsNullOrEmpty(corIdentificacao), DBNull.Value, corIdentificacao))
                cmd.Parameters.AddWithValue("@IdUsuario", usuario.IdUsuario)
                cmd.ExecuteNonQuery()

                ' Registrar auditoria
                RegistrarAuditoriaTipoAtivo(conn, idTipo, "INSERT", usuario.IdUsuario, usuario.NmUsuario, Nothing, JsonConvert.SerializeObject(New With {
                    .CdTipo = cdTipo,
                    .NmTipo = nmTipo,
                    .CategoriaPrincipal = categoriaPrincipal
                }))

                Return New OperacaoResult With {
                    .Sucesso = True,
                    .Mensagem = "Tipo de ativo criado com sucesso",
                    .Id = idTipo
                }
            End Using
        Catch ex As Exception
            Return New OperacaoResult With {
                .Sucesso = False,
                .Mensagem = "Erro ao criar tipo de ativo: " & ex.Message
            }
        End Try
    End Function

    ' ========================================
    ' M√©todo: AtualizarTipoAtivo
    ' Descri√ß√£o: Atualiza tipo de ativo existente
    ' ========================================
    <WebMethod()>
    Public Function AtualizarTipoAtivo(ByVal token As String, ByVal idTipo As Guid, _
                                      ByVal nmTipo As String, ByVal dsTipo As String, _
                                      ByVal taxaDepreciacaoAnual As Decimal?, _
                                      ByVal vidaUtilAnos As Integer?) As OperacaoResult
        Try
            Dim usuario As Usuario = ValidarToken(token)

            If Not TemPermissao(usuario, "cadastros:ativos:tipos:update") Then
                Throw New UnauthorizedAccessException("Usu√°rio sem permiss√£o para atualizar tipos de ativos")
            End If

            Using conn As New SqlConnection(connectionString)
                conn.Open()

                ' Buscar dados anteriores para auditoria
                Dim cmdAntes As New SqlCommand("SELECT Nm_Tipo, Ds_Tipo, Taxa_Depreciacao_Anual, Vida_Util_Anos FROM Ativo_Tipo WHERE Id_Ativo_Tipo = @IdTipo", conn)
                cmdAntes.Parameters.AddWithValue("@IdTipo", idTipo)
                Dim drAntes As SqlDataReader = cmdAntes.ExecuteReader()

                Dim dadosAntes As String = ""
                If drAntes.Read() Then
                    dadosAntes = JsonConvert.SerializeObject(New With {
                        .NmTipo = drAntes("Nm_Tipo").ToString(),
                        .DsTipo = If(IsDBNull(drAntes("Ds_Tipo")), "", drAntes("Ds_Tipo").ToString()),
                        .TaxaDepreciacao = If(IsDBNull(drAntes("Taxa_Depreciacao_Anual")), Nothing, CDec(drAntes("Taxa_Depreciacao_Anual"))),
                        .VidaUtil = If(IsDBNull(drAntes("Vida_Util_Anos")), Nothing, CInt(drAntes("Vida_Util_Anos")))
                    })
                End If
                drAntes.Close()

                ' Atualizar
                Dim sql As String = "UPDATE Ativo_Tipo SET Nm_Tipo = @NmTipo, Ds_Tipo = @DsTipo, Taxa_Depreciacao_Anual = @TaxaDepreciacao, Vida_Util_Anos = @VidaUtil, Dt_Ult_Atualizacao = GETDATE(), Id_Usuario_Atualizacao = @IdUsuario WHERE Id_Ativo_Tipo = @IdTipo"

                Dim cmd As New SqlCommand(sql, conn)
                cmd.Parameters.AddWithValue("@IdTipo", idTipo)
                cmd.Parameters.AddWithValue("@NmTipo", nmTipo)
                cmd.Parameters.AddWithValue("@DsTipo", If(String.IsNullOrEmpty(dsTipo), DBNull.Value, dsTipo))
                cmd.Parameters.AddWithValue("@TaxaDepreciacao", If(taxaDepreciacaoAnual.HasValue, taxaDepreciacaoAnual.Value, DBNull.Value))
                cmd.Parameters.AddWithValue("@VidaUtil", If(vidaUtilAnos.HasValue, vidaUtilAnos.Value, DBNull.Value))
                cmd.Parameters.AddWithValue("@IdUsuario", usuario.IdUsuario)

                Dim linhasAfetadas As Integer = cmd.ExecuteNonQuery()

                If linhasAfetadas = 0 Then
                    Throw New Exception("Tipo de ativo n√£o encontrado")
                End If

                ' Registrar auditoria
                Dim dadosDepois As String = JsonConvert.SerializeObject(New With {
                    .NmTipo = nmTipo,
                    .DsTipo = dsTipo,
                    .TaxaDepreciacao = taxaDepreciacaoAnual,
                    .VidaUtil = vidaUtilAnos
                })

                RegistrarAuditoriaTipoAtivo(conn, idTipo, "UPDATE", usuario.IdUsuario, usuario.NmUsuario, dadosAntes, dadosDepois)

                Return New OperacaoResult With {
                    .Sucesso = True,
                    .Mensagem = "Tipo de ativo atualizado com sucesso"
                }
            End Using
        Catch ex As Exception
            Return New OperacaoResult With {
                .Sucesso = False,
                .Mensagem = "Erro ao atualizar tipo de ativo: " & ex.Message
            }
        End Try
    End Function

    ' ========================================
    ' M√©todo: ExcluirTipoAtivo
    ' Descri√ß√£o: Exclui tipo de ativo (soft delete)
    ' ========================================
    <WebMethod()>
    Public Function ExcluirTipoAtivo(ByVal token As String, ByVal idTipo As Guid) As OperacaoResult
        Try
            Dim usuario As Usuario = ValidarToken(token)

            If Not TemPermissao(usuario, "cadastros:ativos:tipos:delete") Then
                Throw New UnauthorizedAccessException("Usu√°rio sem permiss√£o para excluir tipos de ativos")
            End If

            Using conn As New SqlConnection(connectionString)
                conn.Open()

                ' Verificar se h√° ativos usando este tipo
                Dim cmdVerif As New SqlCommand("SELECT COUNT(*) FROM Ativo WHERE Id_Ativo_Tipo = @IdTipo AND Fl_Ativo = 1", conn)
                cmdVerif.Parameters.AddWithValue("@IdTipo", idTipo)

                If CInt(cmdVerif.ExecuteScalar()) > 0 Then
                    Throw New Exception("N√£o √© poss√≠vel excluir este tipo pois existem ativos associados")
                End If

                ' Verificar se h√° subtipos
                Dim cmdSubtipos As New SqlCommand("SELECT COUNT(*) FROM Ativo_Tipo WHERE Id_Tipo_Pai = @IdTipo AND Fl_Ativo = 1", conn)
                cmdSubtipos.Parameters.AddWithValue("@IdTipo", idTipo)

                If CInt(cmdSubtipos.ExecuteScalar()) > 0 Then
                    Throw New Exception("N√£o √© poss√≠vel excluir este tipo pois existem subtipos associados")
                End If

                ' Buscar dados para auditoria
                Dim cmdDados As New SqlCommand("SELECT Cd_Tipo, Nm_Tipo FROM Ativo_Tipo WHERE Id_Ativo_Tipo = @IdTipo", conn)
                cmdDados.Parameters.AddWithValue("@IdTipo", idTipo)
                Dim drDados As SqlDataReader = cmdDados.ExecuteReader()

                Dim dadosAntes As String = ""
                If drDados.Read() Then
                    dadosAntes = JsonConvert.SerializeObject(New With {
                        .CdTipo = drDados("Cd_Tipo").ToString(),
                        .NmTipo = drDados("Nm_Tipo").ToString()
                    })
                End If
                drDados.Close()

                ' Soft delete
                Dim sql As String = "UPDATE Ativo_Tipo SET Fl_Ativo = 0, Dt_Ult_Atualizacao = GETDATE(), Id_Usuario_Atualizacao = @IdUsuario WHERE Id_Ativo_Tipo = @IdTipo"

                Dim cmd As New SqlCommand(sql, conn)
                cmd.Parameters.AddWithValue("@IdTipo", idTipo)
                cmd.Parameters.AddWithValue("@IdUsuario", usuario.IdUsuario)
                cmd.ExecuteNonQuery()

                ' Registrar auditoria
                RegistrarAuditoriaTipoAtivo(conn, idTipo, "DELETE", usuario.IdUsuario, usuario.NmUsuario, dadosAntes, Nothing)

                Return New OperacaoResult With {
                    .Sucesso = True,
                    .Mensagem = "Tipo de ativo exclu√≠do com sucesso"
                }
            End Using
        Catch ex As Exception
            Return New OperacaoResult With {
                .Sucesso = False,
                .Mensagem = "Erro ao excluir tipo de ativo: " & ex.Message
            }
        End Try
    End Function

    ' ========================================
    ' Fun√ß√£o auxiliar: Registrar auditoria
    ' ========================================
    Private Sub RegistrarAuditoriaTipoAtivo(ByVal conn As SqlConnection, ByVal idTipo As Guid, _
                                           ByVal tipoOp As String, ByVal idUsuario As Guid, _
                                           ByVal nmUsuario As String, ByVal dadosAntes As String, _
                                           ByVal dadosDepois As String)
        Dim sql As String = "INSERT INTO Ativo_Tipo_Auditoria (Id_Ativo_Tipo, Tipo_Operacao, Id_Usuario, Nm_Usuario, IP_Origem, Dados_Antes, Dados_Depois) VALUES (@IdTipo, @TipoOp, @IdUsuario, @NmUsuario, @IP, @DadosAntes, @DadosDepois)"

        Dim cmd As New SqlCommand(sql, conn)
        cmd.Parameters.AddWithValue("@IdTipo", idTipo)
        cmd.Parameters.AddWithValue("@TipoOp", tipoOp)
        cmd.Parameters.AddWithValue("@IdUsuario", idUsuario)
        cmd.Parameters.AddWithValue("@NmUsuario", nmUsuario)
        cmd.Parameters.AddWithValue("@IP", GetClientIP())
        cmd.Parameters.AddWithValue("@DadosAntes", If(String.IsNullOrEmpty(dadosAntes), DBNull.Value, dadosAntes))
        cmd.Parameters.AddWithValue("@DadosDepois", If(String.IsNullOrEmpty(dadosDepois), DBNull.Value, dadosDepois))
        cmd.ExecuteNonQuery()
    End Sub

    Private Function GetClientIP() As String
        Return HttpContext.Current.Request.UserHostAddress
    End Function

End Class

' ========================================
' Classes de retorno
' ========================================

Public Class AtivoTipoInfo
    Public Property IdAtivoTipo As Guid
    Public Property CdTipo As String
    Public Property NmTipo As String
    Public Property DsTipo As String
    Public Property CategoriaPrincipal As String
    Public Property Subcategoria As String
    Public Property IdTipoPai As Guid?
    Public Property NivelHierarquia As Integer
    Public Property FlInventariavel As Boolean
    Public Property FlDepreciavel As Boolean
    Public Property TaxaDepreciacaoAnual As Decimal?
    Public Property VidaUtilAnos As Integer?
    Public Property Icone As String
    Public Property CorIdentificacao As String
    Public Property OrdemExibicao As Integer
End Class

Public Class OperacaoResult
    Public Property Sucesso As Boolean
    Public Property Mensagem As String
    Public Property Id As Guid?
End Class
```

---

## 3. Regras de Neg√≥cio

### RN-CAD-013-01: C√≥digo √önico por Conglomerado
- **Descri√ß√£o**: O c√≥digo do tipo de ativo deve ser √∫nico dentro do conglomerado
- **Justificativa**: Evitar duplicidade e confus√£o na identifica√ß√£o
- **Implementa√ß√£o**: UNIQUE constraint em (Id_Conglomerado, Cd_Tipo)

### RN-CAD-013-02: Hierarquia de Tipos
- **Descri√ß√£o**: Tipos podem ter hierarquia pai-filho com at√© 5 n√≠veis de profundidade
- **Justificativa**: Organiza√ß√£o l√≥gica (ex: Hardware ‚Üí Computadores ‚Üí Notebooks ‚Üí Notebooks Dell)
- **Implementa√ß√£o**: Campo Id_Tipo_Pai e valida√ß√£o de profundidade m√°xima

### RN-CAD-013-03: Valida√ß√£o de Categoria
- **Descri√ß√£o**: Categoria principal deve ser um dos valores permitidos: Hardware, Software, LinhaMovel, LinhaFixa, Servico, Licenca, Acessorio, Outro
- **Justificativa**: Padroniza√ß√£o e integra√ß√£o com outros m√≥dulos
- **Implementa√ß√£o**: CHECK constraint na coluna Categoria_Principal

### RN-CAD-013-04: Deprecia√ß√£o Obrigat√≥ria para Hardware
- **Descri√ß√£o**: Tipos de categoria "Hardware" devem obrigatoriamente ter taxa de deprecia√ß√£o e vida √∫til definidas
- **Justificativa**: Compliance cont√°bil e fiscal
- **Implementa√ß√£o**: Valida√ß√£o no CriarTipoAtivoCommand para Categoria_Principal = 'Hardware'

### RN-CAD-013-05: N√£o Permitir Exclus√£o com Ativos Associados
- **Descri√ß√£o**: Tipo de ativo n√£o pode ser exclu√≠do se houver ativos cadastrados usando este tipo
- **Justificativa**: Integridade referencial e hist√≥rico
- **Implementa√ß√£o**: Verifica√ß√£o de COUNT em Ativo antes de permitir soft delete

### RN-CAD-013-06: Campos Customizados por Tipo
- **Descri√ß√£o**: Cada tipo pode ter campos customizados espec√≠ficos (ex: tipo "Notebook" pode ter campo "Tamanho da Tela")
- **Justificativa**: Flexibilidade para diferentes necessidades de cataloga√ß√£o
- **Implementa√ß√£o**: Tabela Ativo_Tipo_Campo_Customizado com defini√ß√£o de campos din√¢micos

### RN-CAD-013-07: Taxa de Deprecia√ß√£o V√°lida
- **Descri√ß√£o**: Taxa de deprecia√ß√£o anual deve estar entre 0% e 100%
- **Justificativa**: Valores fora deste range n√£o fazem sentido cont√°bil
- **Implementa√ß√£o**: CHECK constraint (Taxa_Depreciacao_Anual >= 0 AND Taxa_Depreciacao_Anual <= 100)

### RN-CAD-013-08: Tipos de Sistema N√£o Edit√°veis
- **Descri√ß√£o**: Tipos marcados com Fl_Sistema = 1 n√£o podem ser editados ou exclu√≠dos
- **Justificativa**: Preservar tipos padr√£o do sistema
- **Implementa√ß√£o**: Valida√ß√£o em AtualizarTipoAtivoCommand e ExcluirTipoAtivoCommand

### RN-CAD-013-09: Recalcular Hierarquia ao Mudar Pai
- **Descri√ß√£o**: Ao alterar o tipo pai, recalcular Nivel_Hierarquia e Caminho_Hierarquia de todos os descendentes
- **Justificativa**: Manter consist√™ncia da √°rvore hier√°rquica
- **Implementa√ß√£o**: Procedure recursiva ou query CTE para atualiza√ß√£o em cascata

### RN-CAD-013-10: Auditoria Completa de Altera√ß√µes
- **Descri√ß√£o**: Todas as opera√ß√µes (INSERT, UPDATE, DELETE) devem ser auditadas com dados antes/depois
- **Justificativa**: Rastreabilidade e compliance
- **Implementa√ß√£o**: Tabela Ativo_Tipo_Auditoria populada via trigger ou service

### RN-CAD-013-11: √çcone e Cor para Identifica√ß√£o Visual
- **Descri√ß√£o**: Cada tipo deve ter √≠cone (Font Awesome) e cor hex para exibi√ß√£o visual em interfaces
- **Justificativa**: Melhorar UX e identifica√ß√£o r√°pida
- **Implementa√ß√£o**: Campos Icone (varchar) e Cor_Identificacao (varchar(7) hex color)

### RN-CAD-013-12: Ordem de Exibi√ß√£o Customiz√°vel
- **Descri√ß√£o**: Tipos devem ser orden√°veis via campo Ordem_Exibicao para controle de listagens
- **Justificativa**: Permitir que tipos mais usados apare√ßam primeiro
- **Implementa√ß√£o**: Campo Ordem_Exibicao (int) com ORDER BY nas queries

### RN-CAD-013-13: N√£o Permitir Loop Hier√°rquico
- **Descri√ß√£o**: Ao definir tipo pai, validar que n√£o cria loop (ex: A ‚Üí B ‚Üí C ‚Üí A)
- **Justificativa**: Prevenir estrutura inv√°lida
- **Implementa√ß√£o**: Valida√ß√£o recursiva percorrendo a hierarquia at√© a raiz

### RN-CAD-013-14: Importa√ß√£o em Massa com Valida√ß√£o
- **Descri√ß√£o**: Permitir importa√ß√£o de tipos via CSV/Excel com valida√ß√£o de duplicidades e hierarquia
- **Justificativa**: Carga inicial e migra√ß√µes
- **Implementa√ß√£o**: ImportarTiposAtivoCommand com parsing e valida√ß√£o linha a linha

### RN-CAD-013-15: Soft Delete com Possibilidade de Restaura√ß√£o
- **Descri√ß√£o**: Exclus√£o l√≥gica (Fl_Ativo = 0) com possibilidade de restaura√ß√£o posterior
- **Justificativa**: Prevenir perda de dados acidental
- **Implementa√ß√£o**: UPDATE Fl_Ativo ao inv√©s de DELETE f√≠sico

---

## 4. REST API Moderna (.NET 10)

### 4.1 AtivoTipoController

```csharp
using IControlIT.API.Application.Commands.AtivoTipo;
using IControlIT.API.Application.Queries.AtivoTipo;
using MediatR;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

namespace IControlIT.API.Web.Controllers
{
    [ApiController]
    [Route("api/ativos/tipos")]
    [Authorize]
    public class AtivoTipoController : ControllerBase
    {
        private readonly IMediator _mediator;
        private readonly ILogger<AtivoTipoController> _logger;

        public AtivoTipoController(IMediator mediator, ILogger<AtivoTipoController> logger)
        {
            _mediator = mediator;
            _logger = logger;
        }

        /// <summary>
        /// Lista todos os tipos de ativos ativos do conglomerado
        /// </summary>
        [HttpGet]
        [Authorize(Policy = "cadastros:ativos:tipos:read")]
        public async Task<ActionResult<List<AtivoTipoDto>>> ListarTipos([FromQuery] Guid idConglomerado)
        {
            var query = new ListarTiposAtivoQuery(idConglomerado);
            var result = await _mediator.Send(query);
            return Ok(result);
        }

        /// <summary>
        /// Busca tipo de ativo por ID
        /// </summary>
        [HttpGet("{id}")]
        [Authorize(Policy = "cadastros:ativos:tipos:read")]
        public async Task<ActionResult<AtivoTipoDetalhadoDto>> BuscarPorId(Guid id)
        {
            var query = new BuscarTipoAtivoPorIdQuery(id);
            var result = await _mediator.Send(query);

            if (result == null)
                return NotFound(new { mensagem = "Tipo de ativo n√£o encontrado" });

            return Ok(result);
        }

        /// <summary>
        /// Cria novo tipo de ativo
        /// </summary>
        [HttpPost]
        [Authorize(Policy = "cadastros:ativos:tipos:create")]
        public async Task<ActionResult<OperacaoResult>> Criar([FromBody] CriarTipoAtivoCommand command)
        {
            var result = await _mediator.Send(command);

            if (!result.Sucesso)
                return BadRequest(result);

            return CreatedAtAction(nameof(BuscarPorId), new { id = result.Id }, result);
        }

        /// <summary>
        /// Atualiza tipo de ativo existente
        /// </summary>
        [HttpPut("{id}")]
        [Authorize(Policy = "cadastros:ativos:tipos:update")]
        public async Task<ActionResult<OperacaoResult>> Atualizar(Guid id, [FromBody] AtualizarTipoAtivoCommand command)
        {
            command.IdTipo = id;
            var result = await _mediator.Send(command);

            if (!result.Sucesso)
                return BadRequest(result);

            return Ok(result);
        }

        /// <summary>
        /// Exclui tipo de ativo (soft delete)
        /// </summary>
        [HttpDelete("{id}")]
        [Authorize(Policy = "cadastros:ativos:tipos:delete")]
        public async Task<ActionResult<OperacaoResult>> Excluir(Guid id)
        {
            var command = new ExcluirTipoAtivoCommand(id);
            var result = await _mediator.Send(command);

            if (!result.Sucesso)
                return BadRequest(result);

            return Ok(result);
        }

        /// <summary>
        /// Lista hierarquia de tipos (√°rvore)
        /// </summary>
        [HttpGet("hierarquia")]
        [Authorize(Policy = "cadastros:ativos:tipos:read")]
        public async Task<ActionResult<List<AtivoTipoHierarquiaDto>>> ListarHierarquia([FromQuery] Guid idConglomerado)
        {
            var query = new ListarHierarquiaTiposQuery(idConglomerado);
            var result = await _mediator.Send(query);
            return Ok(result);
        }

        /// <summary>
        /// Importa tipos de ativos em massa via CSV
        /// </summary>
        [HttpPost("importar")]
        [Authorize(Policy = "cadastros:ativos:tipos:import")]
        public async Task<ActionResult<ImportacaoResult>> Importar([FromForm] IFormFile arquivo, [FromQuery] Guid idConglomerado)
        {
            var command = new ImportarTiposAtivoCommand(idConglomerado, arquivo);
            var result = await _mediator.Send(command);
            return Ok(result);
        }

        /// <summary>
        /// Lista campos customizados de um tipo
        /// </summary>
        [HttpGet("{id}/campos-customizados")]
        [Authorize(Policy = "cadastros:ativos:tipos:read")]
        public async Task<ActionResult<List<CampoCustomizadoDto>>> ListarCamposCustomizados(Guid id)
        {
            var query = new ListarCamposCustomizadosTipoQuery(id);
            var result = await _mediator.Send(query);
            return Ok(result);
        }

        /// <summary>
        /// Adiciona campo customizado a um tipo
        /// </summary>
        [HttpPost("{id}/campos-customizados")]
        [Authorize(Policy = "cadastros:ativos:tipos:update")]
        public async Task<ActionResult<OperacaoResult>> AdicionarCampoCustomizado(Guid id, [FromBody] AdicionarCampoCustomizadoCommand command)
        {
            command.IdTipo = id;
            var result = await _mediator.Send(command);
            return Ok(result);
        }
    }
}
```

---

### 4.2 CriarTipoAtivoCommand

```csharp
using IControlIT.API.Domain.Entities;
using IControlIT.API.Infrastructure.Data;
using MediatR;

namespace IControlIT.API.Application.Commands.AtivoTipo
{
    public record CriarTipoAtivoCommand(
        Guid IdConglomerado,
        string CdTipo,
        string NmTipo,
        string? DsTipo,
        string CategoriaPrincipal,
        string? Subcategoria,
        Guid? IdTipoPai,
        bool FlInventariavel,
        bool FlDepreciavel,
        decimal? TaxaDepreciacaoAnual,
        int? VidaUtilAnos,
        string? Icone,
        string? CorIdentificacao
    ) : IRequest<OperacaoResult>;

    public class CriarTipoAtivoCommandHandler : IRequestHandler<CriarTipoAtivoCommand, OperacaoResult>
    {
        private readonly IControlITDbContext _context;
        private readonly ICurrentUserService _currentUser;

        public CriarTipoAtivoCommandHandler(IControlITDbContext context, ICurrentUserService currentUser)
        {
            _context = context;
            _currentUser = currentUser;
        }

        public async Task<OperacaoResult> Handle(CriarTipoAtivoCommand request, CancellationToken cancellationToken)
        {
            // Validar permiss√£o
            if (!_currentUser.HasPermission("cadastros:ativos:tipos:create"))
            {
                return new OperacaoResult
                {
                    Sucesso = false,
                    Mensagem = "Usu√°rio sem permiss√£o para criar tipos de ativos"
                };
            }

            // Verificar se c√≥digo j√° existe
            var tipoExistente = await _context.AtivoTipos
                .FirstOrDefaultAsync(t => t.IdConglomerado == request.IdConglomerado
                    && t.CdTipo == request.CdTipo
                    && t.FlAtivo, cancellationToken);

            if (tipoExistente != null)
            {
                return new OperacaoResult
                {
                    Sucesso = false,
                    Mensagem = "J√° existe um tipo de ativo com este c√≥digo"
                };
            }

            // Validar categoria Hardware requer deprecia√ß√£o
            if (request.CategoriaPrincipal == "Hardware" && (!request.FlDepreciavel || !request.TaxaDepreciacaoAnual.HasValue))
            {
                return new OperacaoResult
                {
                    Sucesso = false,
                    Mensagem = "Tipos de categoria Hardware devem ter deprecia√ß√£o e taxa de deprecia√ß√£o definidas"
                };
            }

            // Determinar n√≠vel hier√°rquico e caminho
            int nivelHierarquia = 1;
            string caminhoHierarquia = "/" + request.NmTipo;

            if (request.IdTipoPai.HasValue)
            {
                var tipoPai = await _context.AtivoTipos.FindAsync(request.IdTipoPai.Value);
                if (tipoPai != null)
                {
                    nivelHierarquia = tipoPai.NivelHierarquia + 1;
                    caminhoHierarquia = tipoPai.CaminhoHierarquia + "/" + request.NmTipo;

                    // Validar profundidade m√°xima (5 n√≠veis)
                    if (nivelHierarquia > 5)
                    {
                        return new OperacaoResult
                        {
                            Sucesso = false,
                            Mensagem = "Hierarquia de tipos n√£o pode ter mais de 5 n√≠veis"
                        };
                    }
                }
            }

            // Criar tipo
            var tipo = new Domain.Entities.AtivoTipo
            {
                IdAtivoTipo = Guid.NewGuid(),
                IdConglomerado = request.IdConglomerado,
                CdTipo = request.CdTipo,
                NmTipo = request.NmTipo,
                DsTipo = request.DsTipo,
                CategoriaPrincipal = request.CategoriaPrincipal,
                Subcategoria = request.Subcategoria,
                IdTipoPai = request.IdTipoPai,
                NivelHierarquia = nivelHierarquia,
                CaminhoHierarquia = caminhoHierarquia,
                FlInventariavel = request.FlInventariavel,
                FlDepreciavel = request.FlDepreciavel,
                TaxaDepreciacaoAnual = request.TaxaDepreciacaoAnual,
                VidaUtilAnos = request.VidaUtilAnos,
                Icone = request.Icone,
                CorIdentificacao = request.CorIdentificacao,
                FlAtivo = true,
                DtCriacao = DateTime.Now,
                IdUsuarioCriacao = _currentUser.UserId
            };

            _context.AtivoTipos.Add(tipo);
            await _context.SaveChangesAsync(cancellationToken);

            return new OperacaoResult
            {
                Sucesso = true,
                Mensagem = "Tipo de ativo criado com sucesso",
                Id = tipo.IdAtivoTipo
            };
        }
    }
}
```

---

## 5. Tecnologias Recomendadas

### Backend (.NET 10)
- **ASP.NET Core 8.0**: Framework web moderno
- **Entity Framework Core 10.0**: ORM para acesso ao banco
- **MediatR**: CQRS pattern (Commands/Queries)
- **FluentValidation**: Valida√ß√£o de comandos
- **AutoMapper**: Mapeamento Entity ‚Üí DTO
- **Serilog**: Logging estruturado

### Frontend (Angular 18)
- **Angular Material**: Componentes UI (tables, dialogs, tree)
- **Angular Tree Component**: Exibi√ß√£o hier√°rquica de tipos
- **NGRX**: Gerenciamento de estado
- **RxJS**: Programa√ß√£o reativa
- **ng-select**: Dropdowns com busca

### Banco de Dados
- **SQL Server 2019+**: Banco relacional
- **√çndices**: Performance em queries de hierarquia
- **Triggers**: Auditoria autom√°tica (opcional)

### Ferramentas
- **Swagger/OpenAPI**: Documenta√ß√£o da API
- **xUnit**: Testes unit√°rios
- **Bogus**: Gera√ß√£o de dados de teste

---

## 6. Casos de Uso

### UC-CAD-013-01: Criar Tipo de Ativo

**Ator Principal**: Administrador do Sistema

**Pr√©-condi√ß√µes**:
- Usu√°rio autenticado com permiss√£o `cadastros:ativos:tipos:create`

**Fluxo Principal**:
1. Administrador acessa "Cadastros > Ativos > Tipos de Ativos"
2. Sistema exibe lista de tipos cadastrados em formato de √°rvore hier√°rquica
3. Administrador clica em "Novo Tipo"
4. Sistema exibe formul√°rio:
   - C√≥digo (obrigat√≥rio)
   - Nome (obrigat√≥rio)
   - Descri√ß√£o (opcional)
   - Categoria Principal (dropdown: Hardware, Software, Linha M√≥vel, etc.)
   - Subcategoria (opcional)
   - Tipo Pai (dropdown com tipos existentes, opcional)
   - Inventari√°vel? (checkbox, padr√£o SIM)
   - Depreci√°vel? (checkbox, padr√£o SIM)
   - Taxa de Deprecia√ß√£o Anual (%, obrigat√≥rio se Depreci√°vel)
   - Vida √ötil (anos, obrigat√≥rio se Depreci√°vel)
   - √çcone (seletor de √≠cones Font Awesome)
   - Cor (color picker)
5. Administrador preenche:
   - C√≥digo: "NOTE-CORP"
   - Nome: "Notebook Corporativo"
   - Categoria: Hardware
   - Subcategoria: Notebook
   - Depreci√°vel: SIM
   - Taxa: 20%
   - Vida √ötil: 5 anos
   - √çcone: fa-laptop
   - Cor: #3498db
6. Administrador clica em "Salvar"
7. Sistema valida dados:
   - C√≥digo √∫nico no conglomerado ‚úì
   - Categoria v√°lida ‚úì
   - Taxa entre 0-100% ‚úì
8. Sistema cria tipo de ativo com Id √∫nico
9. Sistema registra auditoria (INSERT)
10. Sistema exibe mensagem: "Tipo de ativo criado com sucesso"
11. Sistema atualiza lista com novo tipo

**Fluxos Alternativos**:
- **FA01**: Se c√≥digo j√° existe:
  - Sistema exibe erro: "J√° existe um tipo com este c√≥digo"
  - Retorna ao passo 5
- **FA02**: Se categoria Hardware sem deprecia√ß√£o:
  - Sistema exibe erro: "Tipos Hardware devem ter deprecia√ß√£o definida"
  - Retorna ao passo 5
- **FA03**: Se hierarquia exceder 5 n√≠veis:
  - Sistema exibe erro: "Hierarquia n√£o pode ter mais de 5 n√≠veis"
  - Retorna ao passo 5

**P√≥s-condi√ß√µes**:
- Tipo de ativo criado e dispon√≠vel para associa√ß√£o a ativos
- Auditoria registrada

---

### UC-CAD-013-02: Listar Tipos em Hierarquia

**Ator Principal**: Usu√°rio do Sistema

**Pr√©-condi√ß√µes**:
- Usu√°rio autenticado com permiss√£o `cadastros:ativos:tipos:read`

**Fluxo Principal**:
1. Usu√°rio acessa "Cadastros > Ativos > Tipos de Ativos"
2. Sistema busca tipos do conglomerado do usu√°rio
3. Sistema monta √°rvore hier√°rquica com base em Id_Tipo_Pai
4. Sistema exibe √°rvore:
   ```
   üì¶ Hardware
      ‚îú‚îÄ üíª Computadores
      ‚îÇ   ‚îú‚îÄ üñ•Ô∏è Desktops
      ‚îÇ   ‚îÇ   ‚îî‚îÄ Desktop Corporativo
      ‚îÇ   ‚îú‚îÄ üíª Notebooks
      ‚îÇ   ‚îÇ   ‚îú‚îÄ Notebook Corporativo
      ‚îÇ   ‚îÇ   ‚îî‚îÄ Notebook Executivo
      ‚îÇ   ‚îî‚îÄ üñ•Ô∏è Servidores
      ‚îú‚îÄ üì± Dispositivos M√≥veis
      ‚îÇ   ‚îú‚îÄ Smartphones
      ‚îÇ   ‚îî‚îÄ Tablets
      ‚îî‚îÄ üñ®Ô∏è Perif√©ricos
   üì± Linhas M√≥veis
      ‚îú‚îÄ Voz + Dados
      ‚îî‚îÄ M2M/IoT
   ```
5. Usu√°rio pode expandir/recolher n√≥s
6. Ao clicar em um tipo, sistema exibe detalhes no painel lateral:
   - C√≥digo
   - Nome
   - Descri√ß√£o
   - Categoria
   - Taxa de deprecia√ß√£o
   - Quantidade de ativos deste tipo
   - Bot√µes: Editar, Excluir, Adicionar Subtipo

**Fluxos Alternativos**:
- **FA01**: Se n√£o houver tipos cadastrados:
  - Sistema exibe mensagem: "Nenhum tipo cadastrado. Clique em 'Novo' para criar"

**P√≥s-condi√ß√µes**:
- Usu√°rio visualiza hierarquia de tipos

---

## 7. Oportunidades de Moderniza√ß√£o

### OM-CAD-013-01: Drag-and-Drop para Reorganizar Hierarquia
- **Descri√ß√£o**: Interface de arrastar e soltar para reorganizar tipos na √°rvore
- **Benef√≠cio**: UX melhorada para gest√£o de hierarquia
- **Tecnologia**: Angular CDK Drag & Drop, NGRX para state management

### OM-CAD-013-02: Sugest√£o Autom√°tica de Taxa de Deprecia√ß√£o
- **Descri√ß√£o**: IA sugere taxa baseada em hist√≥rico de tipos similares
- **Benef√≠cio**: Padroniza√ß√£o e compliance cont√°bil
- **Tecnologia**: Azure ML, regression model treinado com dados hist√≥ricos

### OM-CAD-013-03: Templates de Tipos Prontos
- **Descri√ß√£o**: Biblioteca de templates pr√©-configurados (ex: "Desktop Padr√£o", "Servidor Web")
- **Benef√≠cio**: Acelerar setup inicial
- **Tecnologia**: Seed data JSON, importa√ß√£o one-click

### OM-CAD-013-04: Visualiza√ß√£o Gr√°fica de Hierarquia
- **Descri√ß√£o**: Diagrama visual (D3.js) da √°rvore de tipos com estat√≠sticas
- **Benef√≠cio**: Vis√£o hol√≠stica da taxonomia de ativos
- **Tecnologia**: D3.js, Charts.js

### OM-CAD-013-05: Versionamento de Tipos
- **Descri√ß√£o**: Hist√≥rico de vers√µes de tipos com possibilidade de rollback
- **Benef√≠cio**: Rastreabilidade de mudan√ßas em defini√ß√µes
- **Tecnologia**: Temporal Tables SQL Server

### OM-CAD-013-06: Importa√ß√£o de Taxonomias Padr√£o (UNSPSC)
- **Descri√ß√£o**: Importar classifica√ß√µes padr√£o UNSPSC (United Nations Standard Products and Services Code)
- **Benef√≠cio**: Compliance com padr√µes internacionais de cataloga√ß√£o
- **Tecnologia**: Parser UNSPSC CSV, mapeamento autom√°tico

### OM-CAD-013-07: √çcones Customizados (Upload)
- **Descri√ß√£o**: Permitir upload de √≠cones SVG customizados ao inv√©s de apenas Font Awesome
- **Benef√≠cio**: Identidade visual personalizada
- **Tecnologia**: Azure Blob Storage para SVGs, sanitiza√ß√£o de upload

### OM-CAD-013-08: Relat√≥rio de Tipos Mais Utilizados
- **Descri√ß√£o**: Dashboard mostrando tipos com mais ativos, custos agregados, tend√™ncias
- **Benef√≠cio**: Insights sobre composi√ß√£o do parque de ativos
- **Tecnologia**: Power BI Embedded, queries agregadas

---

## 8. Refer√™ncias ao Legado

### 8.1 Arquivos VB.NET do Sistema Legado

| Arquivo Legado | Descri√ß√£o | Localiza√ß√£o Prov√°vel |
|---|---|---|
| `Ativo_Tipo.aspx` | P√°gina de cadastro de tipos | `/Cadastro/Ativo_Tipo.aspx` |
| `Ativo_Tipo.aspx.vb` | Code-behind | `/Cadastro/Ativo_Tipo.aspx.vb` |
| `clsAtivoTipo.vb` | Classe de neg√≥cio | `/App_Code/clsAtivoTipo.vb` |
| `AtivoTipoDAL.vb` | Data Access Layer | `/App_Code/DAL/AtivoTipoDAL.vb` |

### 8.2 Stored Procedures Legadas

| Stored Procedure | Descri√ß√£o | Substitu√≠da por |
|---|---|---|
| `sp_AtivoTipo_Listar` | Lista tipos ativos | `ListarTiposAtivoQuery` |
| `sp_AtivoTipo_Insert` | Insere tipo | `CriarTipoAtivoCommand` |
| `sp_AtivoTipo_Update` | Atualiza tipo | `AtualizarTipoAtivoCommand` |
| `sp_AtivoTipo_Delete` | Soft delete | `ExcluirTipoAtivoCommand` |
| `sp_AtivoTipo_BuscarPorId` | Busca por ID | `BuscarTipoAtivoPorIdQuery` |

### 8.3 Tabelas Legadas

| Tabela Legada | Tabela Moderna | Observa√ß√µes |
|---|---|---|
| `TB_ATIVO_TIPO` | `Ativo_Tipo` | Adicionados campos de hierarquia, √≠cone, cor, auditoria |
| - | `Ativo_Tipo_Campo_Customizado` | Nova tabela para campos din√¢micos |
| - | `Ativo_Tipo_Auditoria` | Nova tabela para trilha de auditoria |

### 8.4 Mapeamento de Colunas

| Coluna Legado | Coluna Moderna | Altera√ß√£o |
|---|---|---|
| `ID_TIPO` | `Id_Ativo_Tipo` | Renomeado |
| `COD_TIPO` | `Cd_Tipo` | Renomeado |
| `NOME_TIPO` | `Nm_Tipo` | Renomeado |
| `DESCRICAO` | `Ds_Tipo` | Renomeado |
| `TAXA_DEPREC` | `Taxa_Depreciacao_Anual` | Renomeado |
| - | `Id_Tipo_Pai` | **NOVO**: Suporte a hierarquia |
| - | `Nivel_Hierarquia` | **NOVO**: Profundidade na √°rvore |
| - | `Caminho_Hierarquia` | **NOVO**: Path completo |
| - | `Icone` | **NOVO**: Identifica√ß√£o visual |
| - | `Cor_Identificacao` | **NOVO**: Cor hex |
| - | `Template_Campos_Custom` | **NOVO**: Campos din√¢micos JSON |

---

## 9. Testes

### 9.1 Testes Unit√°rios

```csharp
using Xunit;
using Moq;
using FluentAssertions;
using IControlIT.API.Application.Commands.AtivoTipo;

namespace IControlIT.API.Tests.Unit.Commands
{
    public class CriarTipoAtivoCommandHandlerTests
    {
        [Fact]
        public async Task Handle_DeveCriarTipo_QuandoDadosValidos()
        {
            // Arrange
            var mockContext = new Mock<IControlITDbContext>();
            var mockCurrentUser = new Mock<ICurrentUserService>();

            mockCurrentUser.Setup(u => u.HasPermission("cadastros:ativos:tipos:create")).Returns(true);
            mockCurrentUser.Setup(u => u.UserId).Returns(Guid.NewGuid());

            var handler = new CriarTipoAtivoCommandHandler(mockContext.Object, mockCurrentUser.Object);

            var command = new CriarTipoAtivoCommand(
                Guid.NewGuid(),
                "NOTE-01",
                "Notebook Corporativo",
                "Notebooks para uso corporativo",
                "Hardware",
                "Notebook",
                null,
                true,
                true,
                20.00m,
                5,
                "fa-laptop",
                "#3498db"
            );

            // Act
            var result = await handler.Handle(command, CancellationToken.None);

            // Assert
            result.Sucesso.Should().BeTrue();
            result.Mensagem.Should().Be("Tipo de ativo criado com sucesso");
            result.Id.Should().NotBe(Guid.Empty);
        }

        [Fact]
        public async Task Handle_DeveRetornarErro_QuandoCodigoDuplicado()
        {
            // Arrange
            var mockContext = new Mock<IControlITDbContext>();
            var mockCurrentUser = new Mock<ICurrentUserService>();

            // Setup: simular tipo existente com mesmo c√≥digo
            var tipoExistente = new AtivoTipo { CdTipo = "NOTE-01", FlAtivo = true };
            mockContext.Setup(c => c.AtivoTipos.FirstOrDefaultAsync(It.IsAny<Expression>(), It.IsAny<CancellationToken>()))
                       .ReturnsAsync(tipoExistente);

            var handler = new CriarTipoAtivoCommandHandler(mockContext.Object, mockCurrentUser.Object);

            var command = new CriarTipoAtivoCommand(
                Guid.NewGuid(),
                "NOTE-01",
                "Outro Notebook",
                null,
                "Hardware",
                null,
                null,
                true,
                true,
                20m,
                5,
                null,
                null
            );

            // Act
            var result = await handler.Handle(command, CancellationToken.None);

            // Assert
            result.Sucesso.Should().BeFalse();
            result.Mensagem.Should().Contain("J√° existe um tipo");
        }

        [Fact]
        public async Task Handle_DeveRetornarErro_QuandoHardwareSemDepreciacao()
        {
            // Arrange
            var mockContext = new Mock<IControlITDbContext>();
            var mockCurrentUser = new Mock<ICurrentUserService>();

            mockCurrentUser.Setup(u => u.HasPermission("cadastros:ativos:tipos:create")).Returns(true);

            var handler = new CriarTipoAtivoCommandHandler(mockContext.Object, mockCurrentUser.Object);

            var command = new CriarTipoAtivoCommand(
                Guid.NewGuid(),
                "DESK-01",
                "Desktop",
                null,
                "Hardware",
                null,
                null,
                true,
                false,  // Depreci√°vel = false
                null,   // Sem taxa
                null,
                null,
                null
            );

            // Act
            var result = await handler.Handle(command, CancellationToken.None);

            // Assert
            result.Sucesso.Should().BeFalse();
            result.Mensagem.Should().Contain("Hardware devem ter deprecia√ß√£o");
        }

        [Fact]
        public async Task Handle_DeveCalcularNivelHierarquico_QuandoTemTipoPai()
        {
            // Arrange
            var mockContext = new Mock<IControlITDbContext>();
            var mockCurrentUser = new Mock<ICurrentUserService>();

            var tipoPai = new AtivoTipo
            {
                IdAtivoTipo = Guid.NewGuid(),
                NmTipo = "Computadores",
                NivelHierarquia = 1,
                CaminhoHierarquia = "/Computadores"
            };

            mockContext.Setup(c => c.AtivoTipos.FindAsync(It.IsAny<Guid>())).ReturnsAsync(tipoPai);

            var handler = new CriarTipoAtivoCommandHandler(mockContext.Object, mockCurrentUser.Object);

            var command = new CriarTipoAtivoCommand(
                Guid.NewGuid(),
                "NOTE-01",
                "Notebooks",
                null,
                "Hardware",
                null,
                tipoPai.IdAtivoTipo,  // Com tipo pai
                true,
                true,
                20m,
                5,
                null,
                null
            );

            // Act
            var result = await handler.Handle(command, CancellationToken.None);

            // Assert
            result.Sucesso.Should().BeTrue();
            // Verificar que NivelHierarquia = 2 e Caminho = "/Computadores/Notebooks"
        }
    }
}
```

---

### 9.2 Testes de Integra√ß√£o

```csharp
using Xunit;
using Microsoft.AspNetCore.Mvc.Testing;
using System.Net.Http.Json;

namespace IControlIT.API.Tests.Integration
{
    public class AtivoTipoIntegrationTests : IClassFixture<WebApplicationFactory<Program>>
    {
        private readonly HttpClient _client;

        public AtivoTipoIntegrationTests(WebApplicationFactory<Program> factory)
        {
            _client = factory.CreateClient();
        }

        [Fact]
        public async Task GET_ListarTipos_DeveRetornar200_QuandoAutenticado()
        {
            // Arrange
            var idConglomerado = Guid.NewGuid();

            // Act
            var response = await _client.GetAsync($"/api/ativos/tipos?idConglomerado={idConglomerado}");

            // Assert
            response.EnsureSuccessStatusCode();
            var result = await response.Content.ReadFromJsonAsync<List<AtivoTipoDto>>();
            result.Should().NotBeNull();
        }

        [Fact]
        public async Task POST_Criar_DeveCriarTipo_QuandoDadosValidos()
        {
            // Arrange
            var command = new
            {
                IdConglomerado = Guid.NewGuid(),
                CdTipo = "TEST-001",
                NmTipo = "Tipo Teste",
                CategoriaPrincipal = "Hardware",
                FlInventariavel = true,
                FlDepreciavel = true,
                TaxaDepreciacaoAnual = 20.00,
                VidaUtilAnos = 5
            };

            // Act
            var response = await _client.PostAsJsonAsync("/api/ativos/tipos", command);

            // Assert
            response.EnsureSuccessStatusCode();
            var result = await response.Content.ReadFromJsonAsync<OperacaoResult>();
            result.Should().NotBeNull();
            result.Sucesso.Should().BeTrue();
            result.Id.Should().NotBe(Guid.Empty);
        }

        [Fact]
        public async Task DELETE_Excluir_DeveRetornar400_QuandoHaAtivosAssociados()
        {
            // Arrange
            var idTipo = Guid.NewGuid();  // Tipo com ativos associados

            // Act
            var response = await _client.DeleteAsync($"/api/ativos/tipos/{idTipo}");

            // Assert
            response.StatusCode.Should().Be(System.Net.HttpStatusCode.BadRequest);
            var result = await response.Content.ReadFromJsonAsync<OperacaoResult>();
            result.Mensagem.Should().Contain("existem ativos associados");
        }
    }
}
```

---

## 10. Documenta√ß√£o Adicional

### 10.1 Diagrama ER (Entity-Relationship)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Ativo_Tipo                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ PK Id_Ativo_Tipo            ‚îÇ
‚îÇ    Cd_Tipo                  ‚îÇ
‚îÇ    Nm_Tipo                  ‚îÇ
‚îÇ    Categoria_Principal      ‚îÇ
‚îÇ FK Id_Tipo_Pai              ‚îÇ‚îÄ‚îÄ‚îÄ‚îê (self-reference)
‚îÇ    Nivel_Hierarquia         ‚îÇ   ‚îÇ
‚îÇ    Caminho_Hierarquia       ‚îÇ   ‚îÇ
‚îÇ    Fl_Depreciavel           ‚îÇ   ‚îÇ
‚îÇ    Taxa_Depreciacao_Anual   ‚îÇ   ‚îÇ
‚îÇ    Icone                    ‚îÇ   ‚îÇ
‚îÇ    Cor_Identificacao        ‚îÇ   ‚îÇ
‚îÇ    ...                      ‚îÇ   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
         ‚îÇ                        ‚îÇ
         ‚îÇ 1                      ‚îÇ
         ‚îÇ                        ‚îÇ
         ‚îÇ N                      ‚îÇ
         ‚ñº                        ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚óÑ‚îÄ‚îÄ‚îò
‚îÇ  Ativo                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ PK Id_Ativo                 ‚îÇ
‚îÇ FK Id_Ativo_Tipo            ‚îÇ
‚îÇ    Numero_Serie             ‚îÇ
‚îÇ    ...                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

         ‚îÇ 1
         ‚îÇ
         ‚îÇ N
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Ativo_Tipo_Campo_Custom    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ PK Id_Campo                 ‚îÇ
‚îÇ FK Id_Ativo_Tipo            ‚îÇ
‚îÇ    Cd_Campo                 ‚îÇ
‚îÇ    Nm_Campo                 ‚îÇ
‚îÇ    Tipo_Dados               ‚îÇ
‚îÇ    Fl_Obrigatorio           ‚îÇ
‚îÇ    ...                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### 10.2 Exemplo de Hierarquia JSON

```json
{
  "tipos": [
    {
      "id": "guid-hardware",
      "codigo": "HW",
      "nome": "Hardware",
      "nivel": 1,
      "filhos": [
        {
          "id": "guid-computadores",
          "codigo": "HW-COMP",
          "nome": "Computadores",
          "nivel": 2,
          "filhos": [
            {
              "id": "guid-notebooks",
              "codigo": "HW-COMP-NOTE",
              "nome": "Notebooks",
              "nivel": 3,
              "filhos": [
                {
                  "id": "guid-note-corp",
                  "codigo": "NOTE-CORP",
                  "nome": "Notebook Corporativo",
                  "nivel": 4,
                  "taxaDepreciacao": 20.0,
                  "vidaUtil": 5,
                  "icone": "fa-laptop",
                  "cor": "#3498db",
                  "filhos": []
                }
              ]
            }
          ]
        }
      ]
    }
  ]
}
```

---

### 10.3 FAQ (Perguntas Frequentes)

**1. Qual a diferen√ßa entre Categoria e Tipo?**

Categoria √© a classifica√ß√£o macro (Hardware, Software, Linha M√≥vel), enquanto Tipo √© a especifica√ß√£o detalhada (ex: Notebook Corporativo, Servidor Web). Um tipo sempre pertence a uma categoria.

**2. Posso ter hierarquia infinita de tipos?**

N√£o. O sistema limita a 5 n√≠veis de profundidade para evitar complexidade excessiva. Exemplo: Hardware ‚Üí Computadores ‚Üí Notebooks ‚Üí Notebooks Dell ‚Üí Dell Latitude 7490.

**3. O que acontece se eu excluir um tipo que tem ativos associados?**

O sistema impede a exclus√£o retornando erro. Voc√™ deve primeiro reclassificar os ativos para outro tipo.

**4. Como funciona a deprecia√ß√£o por tipo?**

Cada tipo pode ter uma taxa de deprecia√ß√£o anual (%) e vida √∫til (anos). Quando um ativo √© criado com este tipo, essas configura√ß√µes s√£o aplicadas automaticamente para c√°lculo cont√°bil.

**5. Posso criar campos customizados por tipo?**

Sim! Use a tabela `Ativo_Tipo_Campo_Customizado` para definir campos extras. Exemplo: tipo "Notebook" pode ter campo "Tamanho da Tela (polegadas)".

---

### 10.4 Checklist de Implementa√ß√£o

- [ ] **Banco de Dados**
  - [ ] Criar tabela `Ativo_Tipo`
  - [ ] Criar tabela `Ativo_Tipo_Campo_Customizado`
  - [ ] Criar tabela `Ativo_Tipo_Auditoria`
  - [ ] Criar √≠ndices de performance
  - [ ] Criar constraints e valida√ß√µes
  - [ ] Inserir tipos padr√£o do sistema (seed data)

- [ ] **Backend (.NET 10)**
  - [ ] Criar entidade `AtivoTipo`
  - [ ] Implementar `CriarTipoAtivoCommand` + Handler
  - [ ] Implementar `AtualizarTipoAtivoCommand` + Handler
  - [ ] Implementar `ExcluirTipoAtivoCommand` + Handler
  - [ ] Implementar `ListarTiposAtivoQuery` + Handler
  - [ ] Implementar `ListarHierarquiaTiposQuery` + Handler
  - [ ] Implementar `BuscarTipoAtivoPorIdQuery` + Handler
  - [ ] Implementar valida√ß√µes (FluentValidation)
  - [ ] Configurar AutoMapper (Entity ‚Üí DTO)
  - [ ] Configurar permiss√µes policy-based

- [ ] **Frontend (Angular 18)**
  - [ ] Criar componente `ativo-tipo-lista`
  - [ ] Criar componente `ativo-tipo-form` (criar/editar)
  - [ ] Criar componente `ativo-tipo-hierarquia` (tree view)
  - [ ] Criar servi√ßo `ativo-tipo.service.ts`
  - [ ] Criar actions, reducers, effects NGRX
  - [ ] Implementar valida√ß√µes de formul√°rio
  - [ ] Integrar Angular Tree Component
  - [ ] Implementar color picker e icon picker

- [ ] **Testes**
  - [ ] Testes unit√°rios para commands
  - [ ] Testes unit√°rios para queries
  - [ ] Testes de integra√ß√£o para controller
  - [ ] Testes de valida√ß√£o de hierarquia

- [ ] **Documenta√ß√£o**
  - [ ] Atualizar README.md
  - [ ] Documentar API (Swagger)
  - [ ] Criar guia de uso para administradores

- [ ] **Migra√ß√£o de Dados**
  - [ ] Criar script de migra√ß√£o de `TB_ATIVO_TIPO` para `Ativo_Tipo`
  - [ ] Validar integridade p√≥s-migra√ß√£o

---

**FIM DO DOCUMENTO RF-063**

**Vers√£o**: 2.0
**√öltima Atualiza√ß√£o**: 2025-11-04
**Autor**: Equipe IControlIT + Claude AI
**Status**: Completo (10 se√ß√µes)
