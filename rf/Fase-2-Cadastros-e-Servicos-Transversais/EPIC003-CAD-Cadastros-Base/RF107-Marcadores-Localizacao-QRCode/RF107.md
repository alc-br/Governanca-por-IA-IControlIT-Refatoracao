# RF-107: Marcadores Localização QRCode

**Versão**: 2.0
**Data**: 2025-12-31
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC003-CAD-Cadastros-Base
**Fase**: Fase 2 - Cadastros e Serviços Transversais

---

## 1. OBJETIVO DO REQUISITO

Especificar o comportamento esperado do **Módulo de Marcadores Localização QRCode**, responsável por gerar, gerenciar e processar códigos QR únicos para rastreamento de ativos físicos em tempo real, garantindo rastreabilidade completa, conformidade com LGPD e eficiência operacional.

Este documento define **o que o sistema deve fazer** em termos de geração de QR Codes, leitura via mobile, check-in/check-out de ativos, inventário em lote, geolocalização e auditoria completa, sem especificar tecnologia ou implementação.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- Geração automática de QR Code único por ativo com validação de dígito Luhn
- Impressão de etiquetas PDF com QR Code + dados do ativo
- Leitura via aplicativo mobile (PWA) com captura simultânea de GPS
- Check-in/Check-out de ativos entre localizações
- Histórico completo de leituras com timestamps e geolocalização
- Geolocalização em tempo real com precisão mínima de 10 metros
- Inventário bulk (até 1.000 QR Codes por sessão)
- Alertas de desvio quando ativo sai de localização autorizada
- Integração com Gestão de Ativos (RF014) e Locais/Endereços (RF015)
- Relatórios de rastreamento e movimentações
- Auditoria completa com retenção de 24 meses (LGPD)
- Isolamento multi-tenant (ClienteId em todas as operações)

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica ou layout de telas
- Tecnologia de geração de QR Code (ZXing, QRCoder, etc.)
- Provedor de mapas (Google Maps, Azure Maps, etc.)
- Estratégia de armazenamento de imagens (Blob, FileSystem, etc.)
- Framework mobile específico (PWA, React Native, Flutter, etc.)
- Estratégia de deploy ou infraestrutura

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| QR Code Corporativo | Código visual 2D contendo ClienteId, AtivoId e CheckDigit (Algoritmo Luhn), codificado em Base64URL. Diferencia-se de QR Code público por incluir validação e contexto multi-tenant. |
| Check-in | Operação que registra entrada de ativo em localização com GPS e timestamp. |
| Check-out | Operação que registra saída de ativo de localização anterior. |
| Geolocalização | Captura de coordenadas GPS (latitude, longitude) com precisão mínima de 10 metros. |
| Inventário Bulk | Processo de leitura em lote de múltiplos QR Codes (até 1.000) para sincronizar estado físico com estado no sistema. |
| Histórico de Leituras | Registro imutável de todas as interações com QR Code (quem leu, quando, onde). |
| Etiqueta QRCode | Artefato físico impresso contendo QR Code + Nome Ativo + Código Patrimonial, gerado em PDF. |
| CheckDigit | Dígito verificador calculado via Algoritmo de Luhn para validar autenticidade do QR Code. |

---

## 4. FUNCIONALIDADES COBERTAS

1. Gerar QR Code único para ativo
2. Imprimir etiqueta PDF com QR Code
3. Ler QR Code via aplicativo mobile
4. Registrar check-in de ativo em localização
5. Registrar check-out de ativo de localização
6. Consultar histórico de leituras de QR Code
7. Visualizar localização atual de ativo em mapa
8. Executar inventário bulk (até 1.000 QR Codes)
9. Receber alertas quando ativo sai de localização autorizada
10. Exportar relatório de movimentações

---

## 5. REGRAS DE NEGÓCIO

### RN-RF107-001 — QRCode deve ser único (GUID codificado em Base64URL)

**Descrição**: Cada QR Code gerado deve ser único no escopo do Cliente, codificado em Base64URL para segurança e compactação, sem colisões possíveis mesmo após bilhões de gerações.

**Justificativa**: Evita duplicação de QR Codes, garante identificação única de cada ativo e facilita transmissão em URLs/QR Codes comprimidos.

**Critério de Aceite**:
- QR Code gerado deve ter entre 22-44 caracteres Base64URL
- Não pode haver dois QR Codes iguais para o mesmo Cliente
- Caracteres permitidos: `A-Za-z0-9-_` (sem `+`, `/` ou `=`)

---

### RN-RF107-002 — QRCode deve conter ClienteId + AtivoId + CheckDigit

**Descrição**: A estrutura interna do QR Code, quando decodificado, deve ser: `[ClienteId(4)][AtivoId(8)][CheckDigit(2)]`, totalizando 14 dígitos numéricos antes da codificação Base64.

**Justificativa**: Permite validar QR Code sem acessar banco de dados (offline validation). ClienteId garante multi-tenancy. CheckDigit detecta erros de leitura ou QR Codes falsificados.

**Critério de Aceite**:
- Decodificação deve resultar em 14 dígitos numéricos
- Primeiros 4 dígitos = ClienteId
- Dígitos 5-12 = AtivoId
- Últimos 2 dígitos = CheckDigit

---

### RN-RF107-003 — Check-digit calculado via Algoritmo de Luhn

**Descrição**: O dígito verificador dos 12 primeiros dígitos do QR Code (ClienteId + AtivoId) é calculado usando o Algoritmo de Luhn, armazenado nos últimos 2 dígitos.

**Justificativa**: Algoritmo de Luhn é padrão ISO para validação de números de identificação. Detecta erros de transcrição e falsificação.

**Critério de Aceite**:
- QR Code com checksum incorreto deve ser rejeitado
- Validação deve ocorrer antes de qualquer operação no banco de dados
- Erro de validação deve retornar mensagem específica

---

### RN-RF107-004 — Etiqueta deve conter QRCode + Nome Ativo + Código Patrimonial

**Descrição**: Quando impressa, a etiqueta física deve conter: (1) Código QR 40x40mm no mínimo, (2) Nome do Ativo legível, (3) Código Patrimonial (Ativo.Codigo).

**Justificativa**: Permite leitura manual se QR Code estiver danificado. Identifica visualmente o ativo sem precisar decodificar QR Code.

**Critério de Aceite**:
- PDF gerado deve ter QR Code visível (mínimo 40x40mm)
- Nome do ativo deve aparecer abaixo do QR Code
- Código patrimonial deve ser legível
- Data de geração deve estar presente

---

### RN-RF107-005 — Leitura de QRCode deve registrar Usuário, Data/Hora, GPS

**Descrição**: Toda leitura de QR Code via aplicativo mobile deve registrar automaticamente: (1) Usuário autenticado, (2) Data/hora UTC, (3) Coordenadas GPS (latitude, longitude) com precisão mínima 10m.

**Justificativa**: Implementa auditoria completa de rastreamento, essencial para LGPD e investigações de perdas.

**Critério de Aceite**:
- Leitura sem GPS deve ser rejeitada ou marcada como "baixa confiabilidade"
- Data/hora deve ser UTC
- Usuário deve estar autenticado

---

### RN-RF107-006 — Check-in sem check-out prévio deve alertar

**Descrição**: Se um ativo realiza Check-in em localização X sem ter realizado Check-out na localização anterior Y, o sistema deve alertar o usuário indicando possível duplicação ou erro de operação.

**Justificativa**: Previne situação inconsistente onde um ativo está registrado em 2 locais simultaneamente.

**Critério de Aceite**:
- Sistema deve verificar último status do ativo
- Se último status = CHECK_IN, exibir alerta
- Usuário deve poder confirmar ou cancelar operação

---

### RN-RF107-007 — Geolocalização deve ter precisão mínima de 10 metros

**Descrição**: Toda leitura de QR Code capturando geolocalização GPS deve ter precisão (accuracy) de no máximo 10 metros. Leituras com precisão inferior (> 10m) devem ser rejeitadas ou marcadas como "baixa confiabilidade".

**Justificativa**: 10m é padrão industrial para localização GPS em ambientes corporativos. Garante rastreamento significativo sem ruído de dados.

**Critério de Aceite**:
- Accuracy > 10m → marcado como "BAIXA"
- Accuracy <= 10m → marcado como "ALTA"
- Leituras com baixa confiabilidade devem ter alerta visual

---

### RN-RF107-008 — Histórico de leituras mantido por 24 meses

**Descrição**: Todos os registros de leitura de QR Code devem ser mantidos por 24 meses (730 dias) a partir da data da leitura. Após esse período, devem ser anonimizados conforme política LGPD.

**Justificativa**: LGPD Art. 5º define necessidade de propósito legítimo e retenção justificada. 24 meses é padrão corporativo para auditoria.

**Critério de Aceite**:
- Leituras com mais de 24 meses devem ser anonimizadas
- Anonimização deve ocorrer automaticamente (job diário)
- Dados anonimizados: UsuarioId, Latitude, Longitude

---

### RN-RF107-009 — Inventário bulk deve processar até 1000 QRCodes por sessão

**Descrição**: Operação de inventário que lê múltiplos QR Codes (até 1.000) em uma única sessão deve completar em menos de 5 minutos, processando lotes de 100 QR Codes em paralelo.

**Justificativa**: Otimiza operações de auditoria física sem parar operações normais. Limite de 1.000 é baseado em teste de stress.

**Critério de Aceite**:
- Máximo 1.000 QR Codes por sessão
- Processamento em lotes de 100
- Tempo total < 5 minutos

---

### RN-RF107-010 — Auditoria de todas as operações de QRCode

**Descrição**: Todas as operações sobre QR Codes (criação, leitura, check-in, check-out, impressão, exclusão) devem ser registradas em tabela de auditoria com: Usuário, Tipo de Operação, Data/Hora UTC, IP da Requisição, ClienteId.

**Justificativa**: LGPD Art. 12 exige comprovação de consentimento e histórico de acesso. ISO 27001 exige trilha de auditoria de operações críticas.

**Critério de Aceite**:
- Todas as operações devem gerar registro de auditoria
- Registro deve conter: Usuário, Data/Hora, IP, Operação
- Auditoria deve ser imutável (sem deleção)

---

### RN-RF107-011 — Isolamento por tenant

**Descrição**: Um usuário só pode acessar QR Codes do seu próprio Cliente (tenant). Todas as queries devem filtrar por ClienteId automaticamente.

**Critério de Aceite**:
- Tentativa de acesso cruzado entre tenants → não permitido
- Query sem filtro de ClienteId → deve falhar

---

### RN-RF107-012 — Permissões RBAC

**Descrição**: Cada operação exige permissão explícita conforme matriz de permissões.

| Operação | Permissão |
|----------|-----------|
| Criar QRCode | `qrcode:qrcode:create` |
| Ler QRCode | `qrcode:qrcode:read` |
| Imprimir Etiqueta | `qrcode:qrcode:print` |
| Check-in | `qrcode:checkin:execute` |
| Check-out | `qrcode:checkout:execute` |
| Inventário Bulk | `qrcode:inventario:execute` |
| Excluir QRCode | `qrcode:qrcode:delete` |

---

## 6. ESTADOS DA ENTIDADE

| Estado | Descrição |
|--------|-----------|
| ATIVO | QR Code gerado e ativo |
| INATIVO | QR Code desativado |
| EXCLUIDO | Excluído logicamente |

### Transições permitidas

| De | Para |
|----|------|
| ATIVO | INATIVO |
| INATIVO | ATIVO |
| ATIVO | EXCLUIDO |
| INATIVO | EXCLUIDO |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre |
|--------|---------------|
| qrcode.criado | Após criação de QR Code |
| qrcode.lido | Após leitura via mobile |
| qrcode.checkin | Após check-in de ativo |
| qrcode.checkout | Após check-out de ativo |
| qrcode.impresso | Após geração de etiqueta PDF |
| qrcode.excluido | Após exclusão lógica |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant (ClienteId)
- Nenhuma regra de negócio pode ser ignorada
- Erros devem ser previsíveis e rastreáveis
- Auditoria deve registrar quem, quando e o que mudou
- GPS deve ter precisão mínima de 10 metros
- CheckDigit deve ser validado antes de qualquer operação
- Histórico de leituras deve ser mantido por 24 meses

---

## 9. SEGURANÇA

### 9.1 Proteções Implementadas

- Validação CheckDigit (Luhn) antes de acessar banco de dados
- Tenant Isolation (ClienteId) em todas as queries
- HTTPS Obrigatório (TLS 1.3 mínimo)
- Autenticação JWT com renovação a cada 30 minutos
- GPS Spoofing Detection (movimento > 500km em < 1 min)
- Rate Limiting (máximo 1000 leituras/usuário/hora)
- Auditoria Imutável com replicação geográfica
- CORS Restritivo (apenas frontend autorizado)
- SQL Injection Protection (queries parametrizadas)
- XSS Protection (sanitização automática)

### 9.2 Testes de Segurança Obrigatórios

- SQL Injection
- XSS (Cross-Site Scripting)
- CSRF (Cross-Site Request Forgery)
- Validação de permissões entre tenants
- GPS Spoofing
- Rate Limiting
- Tenant Isolation
- Falsificação de CheckDigit
- Token Expiration
- Bruteforce QRCode

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- UC-RF107.md (Casos de Uso)
- MD-RF107.md (Modelo de Dados)
- WF-RF107.md (Fluxos de Tela)
- MT-RF107.yaml (Massas de Teste)
- TC-RF107.yaml (Casos de Teste)
- RL-RF107.md (Referência ao Legado)

---

## 11. RASTREABILIDADE

| Artefato | Status | Gerado |
|----------|--------|--------|
| Casos de Uso | Pendente | Obrigatório |
| Modelo de Dados | Pendente | Obrigatório |
| Fluxos de Tela | Pendente | Obrigatório |
| Massas de Teste | Pendente | Obrigatório |
| Casos de Teste | Pendente | Obrigatório |
| Referência ao Legado | A criar | Obrigatório |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-31 | Migração v1.0 → v2.0: separação estrita RF/RL, 12 RNs, contrato moderno | Agência ALC - alc.dev.br |
| 1.0 | 2025-12-28 | Versão inicial com conteúdo misto (legado + moderno) | Claude Code |
