rf_id: RF107
rf_title: "Marcadores Localização QRCode"
versao_governanca: "2.0"
data_migracao: "2025-12-31"

# ==============================================================================
# ITENS LEGADO RASTREADOS
# ==============================================================================

itens_legado:
  # ----------------------------------------------------------------------------
  # TELAS ASPX
  # ----------------------------------------------------------------------------
  - id: "LEG-RF107-001"
    tipo: "tela"
    titulo: "Patrimonio_QRCode.aspx"
    caminho_legado: "D:\\IC2\\ic1_legado\\IControlIT\\Patrimonio\\Patrimonio_QRCode.aspx"
    descricao: |
      Tela principal de gerenciamento de QR Codes de patrimônios.
      Permitia criar, editar e visualizar QR Codes manualmente.
      Campos: idPatrimonio, CodigoQR, LocalAtual, DataGeracao, UsuarioGeracao.
    regras_implicitas:
      - "Geração de QR Code era manual via botão que chamava Excel/VBA"
      - "Não havia validação de duplicação de código"
      - "Campo LocalAtual era texto livre sem vínculo com tabela de localizações"
      - "Imagem do QR Code era salva em pasta do servidor (\\\\servidor\\qrcodes\\)"
    destino: "SUBSTITUÍDO"
    justificativa: "Substituído por componente Angular com geração automática via API"
    rastreabilidade:
      rf_moderno: "RF-107 - Seção 4: Funcionalidades"
      uc_moderno: "UC-RF107 (a criar)"
    migracao_moderna:
      componente_angular: "qrcodes-list.component.ts"
      rota_frontend: "/assets/qrcodes/list"

  - id: "LEG-RF107-002"
    tipo: "tela"
    titulo: "Patrimonio_QRCode_Gerar.aspx"
    caminho_legado: "D:\\IC2\\ic1_legado\\IControlIT\\Patrimonio\\Patrimonio_QRCode_Gerar.aspx"
    descricao: |
      Tela de geração de novo QR Code para patrimônio.
      Geração via biblioteca antiga sem validação de unicidade.
      Tamanho da imagem fixo, sem customização.
    regras_implicitas:
      - "Geração era feita via biblioteca antiga sem código aberto"
      - "Não havia validação de unicidade"
      - "Imagem salva em BLOB no banco (campo ImagemQRCode tipo IMAGE)"
      - "Não havia auditoria de quem gerou ou quando"
    destino: "SUBSTITUÍDO"
    justificativa: "Substituído por geração automática com ZXing.Net e validação Luhn"
    rastreabilidade:
      rf_moderno: "RF-107 - RN-RF107-001, RN-RF107-002, RN-RF107-003"
      uc_moderno: "UC01-RF107-criar-qrcode (a criar)"
    migracao_moderna:
      componente_angular: "qrcodes-create.component.ts"
      rota_frontend: "/assets/qrcodes/create"

  - id: "LEG-RF107-003"
    tipo: "tela"
    titulo: "Patrimonio_QRCode_Impressao.aspx"
    caminho_legado: "D:\\IC2\\ic1_legado\\IControlIT\\Patrimonio\\Patrimonio_QRCode_Impressao.aspx"
    descricao: |
      Tela de impressão de etiquetas com QR Code.
      Geração de PDF via Crystal Reports (licença proprietária).
      Layout fixo sem customização.
    regras_implicitas:
      - "Geração de PDF era via Crystal Reports"
      - "Layout fixo sem customização"
      - "Não incluía data de geração ou código patrimonial completo"
      - "Impressão em lote não funcionava (travava após 50 etiquetas)"
    destino: "SUBSTITUÍDO"
    justificativa: "Substituído por geração de PDF via iTextSharp (open-source)"
    rastreabilidade:
      rf_moderno: "RF-107 - RN-RF107-004"
      uc_moderno: "UC-RF107-imprimir-etiqueta (a criar)"
    migracao_moderna:
      componente_angular: "qrcodes-print.component.ts"
      rota_frontend: "/assets/qrcodes/{id}/print"

  - id: "LEG-RF107-004"
    tipo: "tela"
    titulo: "Patrimonio_QRCode_Leitura.aspx"
    caminho_legado: "D:\\IC2\\ic1_legado\\IControlIT\\Patrimonio\\Patrimonio_QRCode_Leitura.aspx"
    descricao: |
      Interface manual de leitura de QR Code via scanner externo.
      Leitura via scanner de código de barras (não câmera).
      Não capturava GPS, localização manual.
    regras_implicitas:
      - "Leitura era via scanner externo (não câmera)"
      - "Não capturava GPS (localização manual)"
      - "Não havia registro de quem leu ou quando"
      - "Campo DataUltimaLeitura era atualizado sem auditoria"
    destino: "SUBSTITUÍDO"
    justificativa: "Substituído por PWA mobile com câmera HTML5 e GPS automático"
    rastreabilidade:
      rf_moderno: "RF-107 - RN-RF107-005, RN-RF107-007"
      uc_moderno: "UC-RF107-ler-qrcode (a criar)"
    migracao_moderna:
      componente_angular: "qrcode-reader.component.ts (PWA)"
      rota_frontend: "/mobile/qrcode-reader"

  # ----------------------------------------------------------------------------
  # WEBSERVICES ASMX
  # ----------------------------------------------------------------------------
  - id: "LEG-RF107-005"
    tipo: "webservice"
    titulo: "WSPatrimonioQRCode.asmx"
    caminho_legado: "D:\\IC2\\ic1_legado\\IControlIT\\WebService\\WSPatrimonioQRCode.asmx.vb"
    metodos:
      - nome: "GerarQRCodePatrimonio"
        parametros: "idPatrimonio (INT)"
        retorno: "String (código QR)"
      - nome: "LerQRCode"
        parametros: "codigoQR (String)"
        retorno: "Boolean (sucesso/falha)"
      - nome: "ObterHistoricoQRCode"
        parametros: "idPatrimonio (INT)"
        retorno: "DataSet (vazio no legado)"
      - nome: "ExportarInventario"
        parametros: "Nenhum"
        retorno: "String (CSV)"
    descricao: |
      Web service público (sem autenticação) para operações de QR Code.
      GerarQRCodePatrimonio: Retornava string do QR Code sem validação.
      LerQRCode: Atualizava DataUltimaLeitura sem registrar histórico.
      ObterHistoricoQRCode: Sempre retornava vazio (não implementado).
      ExportarInventario: Gerava CSV sem filtros ou paginação.
    destino: "SUBSTITUÍDO"
    justificativa: "Substituído por REST API com autenticação JWT"
    rastreabilidade:
      rf_moderno: "RF-107 - Seção 5: Endpoints da API"
      endpoint_moderno: "POST /api/qrcodes, GET /api/qrcodes/{id}/historico"
    migracao_moderna:
      command_cqrs: "CreateQRCodeCommand, ReadQRCodeCommand"
      handler: "CreateQRCodeCommandHandler, GetQRCodeHistoryQueryHandler"

  # ----------------------------------------------------------------------------
  # STORED PROCEDURES
  # ----------------------------------------------------------------------------
  - id: "LEG-RF107-006"
    tipo: "stored_procedure"
    titulo: "pa_GerarQRCodePatrimonio"
    caminho_legado: "D:\\IC2\\ic1_legado\\Database\\Procedures\\pa_GerarQRCodePatrimonio.sql"
    parametros_entrada:
      - "@idPatrimonio INT"
      - "@idUsuario INT"
    parametros_saida:
      - "@CodigoQR VARCHAR(255) OUTPUT"
    descricao: |
      Procedure que gerava código QR manual via concatenação de strings.
      Não validava unicidade, não calculava checksum.
      Retornava código no formato: PATRIMONIO-{idPatrimonio}-{RANDOM}.
    destino: "SUBSTITUÍDO"
    justificativa: "Lógica movida para Application Layer (CQRS Handler) com validação Luhn"
    rastreabilidade:
      rf_moderno: "RF-107 - RN-RF107-001, RN-RF107-002, RN-RF107-003"
      regra_moderna: "RN-RF107-001 (GUID + Base64URL + Luhn)"
    migracao_moderna:
      handler: "CreateQRCodeCommandHandler"
      validacao: "QRCodeGenerator.GenerateUniqueQRCode() com Luhn"

  - id: "LEG-RF107-007"
    tipo: "stored_procedure"
    titulo: "pa_RegistrarLeituraQRCode"
    caminho_legado: "D:\\IC2\\ic1_legado\\Database\\Procedures\\pa_RegistrarLeituraQRCode.sql"
    parametros_entrada:
      - "@CodigoQR VARCHAR(255)"
      - "@UsuarioLeitura VARCHAR(50)"
    parametros_saida:
      - "@Sucesso BIT OUTPUT"
    descricao: |
      Procedure que atualizava campo DataUltimaLeitura sem registrar histórico.
      Não validava se código existia, não capturava GPS.
    destino: "SUBSTITUÍDO"
    justificativa: "Substituído por endpoint POST /api/qrcodes/ler com GPS e auditoria"
    rastreabilidade:
      rf_moderno: "RF-107 - RN-RF107-005, RN-RF107-010"
      regra_moderna: "RN-RF107-005 (Registrar Usuário, Data/Hora, GPS)"
    migracao_moderna:
      handler: "ReadQRCodeCommandHandler"
      validacao: "Geolocation API + AuditLog"

  - id: "LEG-RF107-008"
    tipo: "stored_procedure"
    titulo: "pa_ListarHistoricoQRCode"
    caminho_legado: "D:\\IC2\\ic1_legado\\Database\\Procedures\\pa_ListarHistoricoQRCode.sql"
    parametros_entrada:
      - "@idPatrimonio INT"
    parametros_saida:
      - "Nenhum"
    descricao: |
      Procedure que retornava dados da tabela Patrimonio_QRCode_Historico.
      Tabela existia mas NUNCA foi populada, procedure sempre retornava vazio.
    destino: "DESCARTADO"
    justificativa: "Sem dados para migrar, tabela nunca foi usada"
    rastreabilidade:
      rf_moderno: "RF-107 - RN-RF107-008 (Histórico de leituras mantido por 24 meses)"
      regra_moderna: null
    migracao_moderna:
      handler: "GetQRCodeHistoryQueryHandler (nova implementação)"
      validacao: "Tabela QRCodeLeitura com dados reais"

  # ----------------------------------------------------------------------------
  # TABELAS LEGADAS
  # ----------------------------------------------------------------------------
  - id: "LEG-RF107-009"
    tipo: "tabela"
    titulo: "Patrimonio_QRCode"
    schema_legado: "[dbo].[Patrimonio_QRCode]"
    problemas_identificados:
      - "Falta Foreign Key para validar idEmpresa ou idCliente"
      - "Campo ImagemQRCode tipo IMAGE (deprecated no SQL Server)"
      - "Campo UsuarioGeracao sem FK (string livre, dados inconsistentes)"
      - "Sem índices em CodigoQR (queries lentas)"
      - "Sem campos de auditoria (Created, Modified)"
      - "Sem soft delete (flag Ativo era sobrescrita)"
    destino: "SUBSTITUÍDO"
    justificativa: "Tabela redesenhada com multi-tenancy, auditoria e validação"
    rastreabilidade:
      rf_moderno: "RF-107 - Seção 7: Modelo de Dados"
      md_moderno: "MD-RF107 - Tabela QRCode"
    migracao_moderna:
      tabela_moderna: "QRCode"
      migration_ef_core: "20251231_CreateQRCodeTable.cs (a criar)"

  - id: "LEG-RF107-010"
    tipo: "tabela"
    titulo: "Patrimonio_QRCode_Historico"
    schema_legado: "[dbo].[Patrimonio_QRCode_Historico]"
    problemas_identificados:
      - "Tabela criada mas NUNCA POPULADA no legado"
      - "Sem dados históricos para migração"
      - "Campo LocalLeitura texto livre (deveria ser FK)"
      - "Sem campos de GPS (latitude, longitude)"
    destino: "DESCARTADO"
    justificativa: "Sem dados para migrar, estrutura inadequada (sem GPS, sem FK)"
    rastreabilidade:
      rf_moderno: "RF-107 - RN-RF107-008 (Histórico de leituras)"
      md_moderno: "MD-RF107 - Tabela QRCodeLeitura (nova estrutura)"
    migracao_moderna:
      tabela_moderna: "QRCodeLeitura"
      migration_ef_core: "20251231_CreateQRCodeLeituraTable.cs (a criar)"

  # ----------------------------------------------------------------------------
  # REGRAS IMPLÍCITAS
  # ----------------------------------------------------------------------------
  - id: "LEG-RF107-011"
    tipo: "regra_negocio"
    titulo: "QR Code gerado manualmente sem validação"
    localizacao_codigo: "Patrimonio_QRCode_Gerar.aspx.vb - Linhas 45-67"
    descricao: |
      Geração de QR Code era feita manualmente via Excel/VBA ou biblioteca antiga
      sem validação de unicidade, formato ou checksum. Possibilidade de duplicação,
      falsificação e erros de leitura.
    destino: "SUBSTITUÍDO"
    justificativa: "Substituído por geração automática via ZXing.Net com validação Luhn"
    rastreabilidade:
      rf_moderno: "RF-107 - RN-RF107-001, RN-RF107-003"
      regra_moderna: "RN-RF107-001 (GUID + Base64URL), RN-RF107-003 (Luhn)"
    migracao_moderna:
      validador: "QRCodeGenerator.GenerateUniqueQRCode()"
      linha_codigo: "Algoritmo de Luhn implementado em QRCodeValidator"

  - id: "LEG-RF107-012"
    tipo: "regra_negocio"
    titulo: "Localização manual via campo de texto livre"
    localizacao_codigo: "Patrimonio_QRCode_Leitura.aspx.vb - Linhas 89-102"
    descricao: |
      Usuário digitava manualmente o local do ativo sem autocomplete, validação
      ou FK para tabela de locais. Dados inconsistentes, impossível agrupar por
      localização, sem GPS.
    destino: "SUBSTITUÍDO"
    justificativa: "Substituído por captura GPS automática via Geolocation API"
    rastreabilidade:
      rf_moderno: "RF-107 - RN-RF107-005, RN-RF107-007"
      regra_moderna: "RN-RF107-005 (Registrar GPS), RN-RF107-007 (Precisão 10m)"
    migracao_moderna:
      validador: "GeolocalizacaoValidator"
      linha_codigo: "Geolocation API + Azure Maps reverse geocoding"

  - id: "LEG-RF107-013"
    tipo: "regra_negocio"
    titulo: "Sem histórico de movimentações"
    localizacao_codigo: "WSPatrimonioQRCode.asmx.vb - Método LerQRCode - Linhas 123-135"
    descricao: |
      Sistema atualizava apenas DataUltimaLeitura sem registrar histórico de quem leu,
      quando ou onde. Impossível rastrear trilha de movimentações, não atende LGPD.
    destino: "SUBSTITUÍDO"
    justificativa: "Criada tabela QRCodeLeitura com histórico completo"
    rastreabilidade:
      rf_moderno: "RF-107 - RN-RF107-008, RN-RF107-010"
      regra_moderna: "RN-RF107-008 (Histórico 24 meses), RN-RF107-010 (Auditoria)"
    migracao_moderna:
      validador: "AuditoriaQRCodeMiddleware"
      linha_codigo: "Tabela QRCodeLeitura com campos: UsuarioId, DataHoraLeitura, GPS"

  - id: "LEG-RF107-014"
    tipo: "regra_negocio"
    titulo: "Imagens QR Code salvas em servidor local"
    localizacao_codigo: "Patrimonio_QRCode_Gerar.aspx.vb - Linhas 78-84"
    descricao: |
      Imagens geradas eram salvas em pasta do servidor (\\servidor\qrcodes\) sem backup
      ou redundância. Perda de imagens em caso de falha de hardware.
    destino: "SUBSTITUÍDO"
    justificativa: "Migração para Azure Blob Storage com redundância geográfica"
    rastreabilidade:
      rf_moderno: "RF-107 - Seção 2.1: Escopo (Armazenamento de imagens)"
      regra_moderna: null
    migracao_moderna:
      validador: null
      linha_codigo: "Azure Blob Storage + Migration Script PowerShell"

  - id: "LEG-RF107-015"
    tipo: "regra_negocio"
    titulo: "Sem autenticação em Web Service"
    localizacao_codigo: "WSPatrimonioQRCode.asmx.vb - Linhas 1-15"
    descricao: |
      Web Service WSPatrimonioQRCode.asmx era público, sem autenticação ou validação
      de origem. Qualquer aplicação externa poderia chamar e modificar dados.
    destino: "SUBSTITUÍDO"
    justificativa: "Substituído por REST API com JWT obrigatório"
    rastreabilidade:
      rf_moderno: "RF-107 - RN-RF107-012 (Permissões RBAC)"
      regra_moderna: "RN-RF107-012 (Autenticação JWT)"
    migracao_moderna:
      validador: "JwtBearerAuthentication"
      linha_codigo: "Middleware de autenticação JWT em Program.cs"

  - id: "LEG-RF107-016"
    tipo: "regra_negocio"
    titulo: "Retenção de dados indefinida"
    localizacao_codigo: "Sem implementação no legado"
    descricao: |
      Dados de QR Code eram mantidos indefinidamente sem política de retenção ou
      anonimização. Não conformidade com LGPD Art. 5º.
    destino: "ASSUMIDO"
    justificativa: "Criado job diário para anonimizar dados > 24 meses"
    rastreabilidade:
      rf_moderno: "RF-107 - RN-RF107-008 (Histórico 24 meses)"
      regra_moderna: "RN-RF107-008 (Anonimização automática)"
    migracao_moderna:
      validador: null
      linha_codigo: "Hangfire Job: AnonimizarLeiturasExpiradas()"

# ==============================================================================
# BANCOS LEGADOS MAPEADOS
# ==============================================================================

bancos_legados:
  - nome: "IC1Legado_Cliente01"
    servidor: "SQL-LEGADO-01"
    tabelas_relacionadas:
      - "Patrimonio_QRCode"
      - "Patrimonio_QRCode_Historico"
    destino: "CONSOLIDADO"
    justificativa: "Migrado para banco único com multi-tenancy (Row-Level Security)"
    banco_moderno: "IControlIT.db (SQLite dev) / SQL Server moderno (prod)"

  - nome: "IC1Legado_Cliente02"
    servidor: "SQL-LEGADO-02"
    tabelas_relacionadas:
      - "Patrimonio_QRCode"
      - "Patrimonio_QRCode_Historico"
    destino: "CONSOLIDADO"
    justificativa: "Migrado para banco único com multi-tenancy (Row-Level Security)"
    banco_moderno: "IControlIT.db (SQLite dev) / SQL Server moderno (prod)"

# ==============================================================================
# PROBLEMAS LEGADO IDENTIFICADOS
# ==============================================================================

problemas_legado:
  - id: "PROB-RF107-001"
    titulo: "Ausência de validação de QR Code"
    severidade: "CRÍTICA"
    descricao: |
      QR Codes eram gerados manualmente sem validação de unicidade, formato ou checksum.
      Possibilidade de duplicação, falsificação e erros de leitura.
    impacto: "Alto - Dados inconsistentes, risco de segurança"
    solucao_moderna: "Geração automática via ZXing.Net com validação Luhn obrigatória"

  - id: "PROB-RF107-002"
    titulo: "Sem rastreamento GPS"
    severidade: "ALTA"
    descricao: |
      Localização era registrada manualmente via campo de texto livre, sem GPS.
      Impossível rastrear movimentações reais, dados inconsistentes.
    impacto: "Médio - Perda de precisão, impossível mapear trilhas"
    solucao_moderna: "Captura GPS automática via Geolocation API com precisão 10m"

  - id: "PROB-RF107-003"
    titulo: "Sem auditoria de leituras"
    severidade: "CRÍTICA"
    descricao: |
      Sistema não registrava histórico de quem leu, quando ou onde.
      Impossível rastrear movimentações, não atende LGPD.
    impacto: "Alto - Não conformidade com LGPD Art. 5º"
    solucao_moderna: "Tabela QRCodeLeitura com histórico completo (24 meses)"

  - id: "PROB-RF107-004"
    titulo: "Multi-database sem isolamento"
    severidade: "ALTA"
    descricao: |
      Cada cliente tinha banco separado, sem tenant isolation eficiente.
      Queries lentas, manutenção complexa, custo alto de infraestrutura.
    impacto: "Médio - Escalabilidade limitada"
    solucao_moderna: "Consolidação em banco único com ClienteId + Row-Level Security"

  - id: "PROB-RF107-005"
    titulo: "Imagens sem backup"
    severidade: "MÉDIA"
    descricao: |
      QR Codes salvos em servidor local sem redundância ou backup.
      Perda de imagens em caso de falha de hardware.
    impacto: "Médio - Risco de perda de dados"
    solucao_moderna: "Azure Blob Storage com redundância geográfica"

  - id: "PROB-RF107-006"
    titulo: "Performance ruim"
    severidade: "MÉDIA"
    descricao: |
      Queries sem índices, sem paginação. Lentidão em listas grandes.
    impacto: "Médio - Experiência do usuário comprometida"
    solucao_moderna: "Paginação obrigatória + índices em campos críticos"

# ==============================================================================
# METADADOS
# ==============================================================================

metadados:
  total_itens_legado: 16
  itens_assumidos: 1       # LEG-RF107-016 (Retenção LGPD)
  itens_substituidos: 13   # Telas, WebServices, SPs, Tabelas, Regras
  itens_descartados: 2     # LEG-RF107-008 (pa_ListarHistoricoQRCode), LEG-RF107-010 (Patrimonio_QRCode_Historico)
  itens_a_revisar: 0
  cobertura_destinos: "100%"
