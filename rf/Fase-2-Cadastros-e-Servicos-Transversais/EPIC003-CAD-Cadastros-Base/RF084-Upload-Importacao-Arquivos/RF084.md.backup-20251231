# RF084: Upload e Importação de Arquivos

**Versao**: 1.0 | **Data**: 2025-12-28
**RF Relacionado**: RF085 (Importação de Dados), RF084 (Upload/Importação) | **EPIC**: EPIC003-CAD-Cadastros-Base
**Fase**: Fase 2 - Cadastros e Serviços Transversais

---

## 1. RESUMO EXECUTIVO

### 1.1 Descrição Geral

O módulo **Upload e Importação de Arquivos** é responsável por gerenciar o carregamento seguro de arquivos de diversos formatos (CSV, Excel, XML, JSON) para o sistema IControlIT. Este módulo resolve o problema de migração e integração massiva de dados, permitindo importações em lote com validação prévia, antivírus, processamento assíncrono e rollback automático em caso de falha.

Este é um serviço crítico de infraestrutura que suporta todos os módulos que necessitam carga de dados em massa, desde inventário de ativos até faturas e contratos.

### 1.2 Importância Estratégica

O módulo de upload e importação é crítico para:
- **Migração de Dados**: Permite transição ordenada do sistema legado (VB.NET) para modernizado (.NET 10 + Angular)
- **Integração de Sistemas**: Suporta conectores com ERPs, operadoras telecom e sistemas parceiros
- **Conformidade**: Validação e auditoria de todas as importações conforme LGPD (7 anos de retenção)
- **Segurança**: Scan antivírus obrigatório antes do processamento (ClamAV)
- **Performance**: Processamento assíncrono com Hangfire para importações grandes (até 500MB)
- **Transparência**: Relatórios detalhados de erros e preview de dados antes de confirmar

### 1.3 Conceitos Fundamentais

**Upload em Chunks (Chunked Upload)**: Divisão de arquivo grande em fragmentos pequenos (5-10MB) que são enviados sequencialmente, permitindo rastreamento de progresso e recovery em caso de falha de rede.
- Implementado via API REST com resumption capability
- Cliente Angular gerencia envio de chunks em paralelo

**Scan Antivírus (ClamAV)**: Integração obrigatória com ClamAV para detectar malware antes de processar arquivo
- Arquivo não é salvo até passar na validação
- Bloqueio automático de tipos suspeitos

**Processamento Assíncrono (Hangfire)**: Jobs em background que processam importações sem bloquear a interface
- Progresso em tempo real via SignalR
- Notificações ao completar

**Validação de Estrutura**: Verificação de schema (colunas obrigatórias, tipos de dados) antes de inserir registros
- Preview mostra primeiras 100 linhas com erros mapeados
- Usuário pode validar antes de confirmar importação

**Rollback Transacional**: Importação é executada em transação única; se qualquer linha falhar, toda operação é desfeita
- Integridade referencial garantida
- Sem dados parciais no banco

### 1.4 Legado vs Modernizado

| Aspecto | Legado (VB.NET) | Modernizado (.NET 10 + Angular) |
|---------|-----------------|--------------------------------|
| **Upload de Arquivo** | FileUpload ASPX (síncrono, 100MB limit) | Chunk upload (até 500MB, retomável) |
| **Validação** | Manual no code-behind | Schema validation + data validation |
| **Antivírus** | Nenhum | ClamAV obrigatório |
| **Processamento** | Síncrono (bloqueia UI) | Hangfire (background jobs) |
| **Progresso** | Sem feedback | SignalR em tempo real |
| **Armazenamento** | File System local | Azure Blob Storage |
| **Rollback** | Manual ou script | Transação SQL automática |
| **Auditoria** | Nenhuma | Log completo de importação |
| **Formatos** | XLS, CSV | CSV, Excel (XLSX), XML, JSON |
| **Preview** | Nenhum | 100 primeiras linhas com erros |

### 1.5 Funcionalidades Principais

1. **Upload em Chunks com Resumption** - Carregar arquivos até 500MB em fragmentos retomáveis, com progresso em tempo real
2. **Validação de Tipo MIME** - Whitelist de tipos permitidos (text/csv, application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/xml, application/json)
3. **Scan Antivírus (ClamAV)** - Varredura obrigatória antes de processar; bloqueio automático de ameaças
4. **Armazenamento Seguro (Azure Blob)** - Arquivo encriptado em Azure com retenção configurável
5. **Validação de Estrutura** - Verificação de schema (colunas obrigatórias, tipos de dados, ranges)
6. **Preview de Dados** - Visualização das primeiras 100 linhas com mapeamento de erros antes da importação
7. **Processamento Assíncrono (Hangfire)** - Jobs em background para importações massivas
8. **Progresso em Tempo Real (SignalR)** - Notificações ao cliente durante processamento
9. **Importação com Rollback** - Transação única garante consistência; erro em 1 linha = desfeita toda importação
10. **Relatório de Erros Detalhado** - Listagem de todas as linhas com erro, motivo e sugestão de correção

---

## 2. REGRAS DE NEGÓCIO

### RN-UPL-084-01: Limite de Tamanho de Arquivo

**Descrição**: Arquivos maiores que 500MB devem ser rejeitados no envio.

**Justificativa**: Proteção contra esgotamento de recursos e DoS. 500MB é limite prático para processamento em background.

**Implementação**:
```csharp
public class UploadValidator
{
    private const long MAX_FILE_SIZE = 500 * 1024 * 1024; // 500 MB

    public ValidationResult ValidateFileSize(IFormFile file)
    {
        if (file.Length > MAX_FILE_SIZE)
            return ValidationResult.Fail($"Arquivo excede o limite de 500MB (tamanho: {file.Length / (1024 * 1024)}MB)");

        return ValidationResult.Success();
    }
}
```

**Exemplos**:
- ✓ Arquivo de 250MB: Aceito
- ✗ Arquivo de 600MB: Rejeitado com mensagem "Arquivo excede limite de 500MB"

---

### RN-UPL-084-02: Whitelist de Tipos MIME

**Descrição**: Apenas tipos MIME específicos são permitidos: text/csv, application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/xml, application/json.

**Justificativa**: Prevenir upload de tipos maliciosos (exe, dll, bat, etc.) ou inesperados.

**Implementação**:
```csharp
public class MimeTypeValidator
{
    private static readonly HashSet<string> AllowedMimeTypes = new()
    {
        "text/csv",
        "text/plain", // CSV também pode vir como text/plain
        "application/vnd.ms-excel", // .xls
        "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", // .xlsx
        "application/xml",
        "text/xml",
        "application/json"
    };

    public bool IsValidMimeType(string mimeType)
    {
        return AllowedMimeTypes.Contains(mimeType);
    }
}
```

**Exemplos**:
- ✓ application/vnd.openxmlformats-officedocument.spreadsheetml.sheet: Aceito
- ✗ application/x-msdownload (exe): Rejeitado

---

### RN-UPL-084-03: Validação de Extensão de Arquivo

**Descrição**: Extensão do arquivo deve corresponder ao tipo MIME declarado. Extensões permitidas: .csv, .xls, .xlsx, .xml, .json.

**Justificativa**: Prevenir spoofing de tipo (malware disfarçado com extensão falsa).

**Implementação**:
```csharp
public class FileExtensionValidator
{
    private static readonly Dictionary<string, string[]> ExtensionMap = new()
    {
        { "text/csv", new[] { ".csv", ".txt" } },
        { "application/vnd.ms-excel", new[] { ".xls" } },
        { "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", new[] { ".xlsx" } },
        { "application/xml", new[] { ".xml" } },
        { "text/xml", new[] { ".xml" } },
        { "application/json", new[] { ".json" } }
    };

    public bool IsValidExtension(string mimeType, string fileName)
    {
        if (!ExtensionMap.TryGetValue(mimeType, out var validExtensions))
            return false;

        var extension = Path.GetExtension(fileName).ToLower();
        return validExtensions.Contains(extension);
    }
}
```

---

### RN-UPL-084-04: Scan Antivírus Obrigatório (ClamAV)

**Descrição**: Arquivo deve ser scaneado por ClamAV antes de ser salvo em storage. Se detectar ameaça, arquivo é rejeitado e evento é auditado.

**Justificativa**: Conformidade de segurança; prevenir introdução de malware.

**Implementação**:
```csharp
public class AntivirusScanService
{
    private readonly ILogger<AntivirusScanService> _logger;
    private readonly ClamClient _clamClient;

    public async Task<ScanResult> ScanFileAsync(Stream fileStream, string fileName)
    {
        _logger.LogInformation($"Iniciando scan antivírus para: {fileName}");

        var result = await _clamClient.ScanStreamAsync(fileStream);

        if (result.HasVirus)
        {
            _logger.LogError($"Ameaça detectada: {result.VirusName}");
            throw new MalwareDetectedException($"Arquivo contém malware: {result.VirusName}");
        }

        _logger.LogInformation($"Arquivo seguro: {fileName}");
        return result;
    }
}
```

---

### RN-UPL-084-05: Separação de Upload e Processamento

**Descrição**: Arquivo é enviado para preview (validação de estrutura) antes da importação ser confirmada. Usuário revisará primeiras 100 linhas com erros mapeados.

**Justificativa**: Evitar importação de dados inconsistentes; permitir correção antes de processar.

**Implementação**:
Duas endpoints distintas:
- `POST /api/uploads/preview`: Recebe arquivo, valida estrutura, retorna preview
- `POST /api/uploads/{uploadId}/import`: Confirma importação do arquivo já previewado

---

### RN-UPL-084-06: Validação de Schema Obrigatória

**Descrição**: Arquivo deve conter todas as colunas obrigatórias declaradas no schema de importação. Tipos de dados devem bater com tipos esperados (int, datetime, etc.).

**Justificativa**: Garantir consistência de dados antes de inserir.

**Implementação**:
```csharp
public class SchemaValidator
{
    public SchemaValidationResult ValidateColumns(DataTable data, List<ColumnDefinition> requiredColumns)
    {
        var errors = new List<string>();

        foreach (var column in requiredColumns)
        {
            if (!data.Columns.Contains(column.Name))
                errors.Add($"Coluna obrigatória faltando: {column.Name}");

            var actualType = data.Columns[column.Name]?.DataType;
            if (!IsTypeCompatible(actualType, column.ExpectedType))
                errors.Add($"Coluna {column.Name} tem tipo {actualType}, esperado {column.ExpectedType}");
        }

        return new SchemaValidationResult { IsValid = errors.Count == 0, Errors = errors };
    }
}
```

---

### RN-UPL-084-07: Validação de Dados em Linha

**Descrição**: Cada linha é validada contra regras de negócio (ranges de valor, formatos, dependências de FK, etc.) antes de inserção. Linhas com erro aparecem em relatório.

**Justificativa**: Evitar corrupção de dados; feedback claro sobre quais linhas falharam.

**Implementação**: Validação após schema, com mapeamento de linha:coluna → erro esperado

---

### RN-UPL-084-08: Processamento Assíncrono com Hangfire

**Descrição**: Importação de arquivo > 10MB é automaticamente enfileirada em Hangfire como background job. Upload < 10MB pode ser síncrono.

**Justificativa**: Não bloquear interface para importações grandes.

**Implementação**:
```csharp
[ApiController]
[Route("api/[controller]")]
public class ImportsController : ControllerBase
{
    private readonly IBackgroundJobClient _backgroundJobs;

    [HttpPost("{uploadId}/import")]
    public async Task<IActionResult> StartImport(string uploadId)
    {
        var upload = await _uploadRepository.GetAsync(uploadId);

        if (upload.FileSizeBytes > 10 * 1024 * 1024) // > 10MB
        {
            var jobId = _backgroundJobs.Enqueue<ImportJobHandler>(x => x.ProcessAsync(uploadId, CancellationToken.None));
            return Accepted(new { jobId, status = "queued" });
        }
        else
        {
            // Processamento síncrono para arquivos pequenos
            await new ImportJobHandler().ProcessAsync(uploadId, CancellationToken.None);
            return Ok(new { status = "completed" });
        }
    }
}
```

---

### RN-UPL-084-09: Progresso em Tempo Real via SignalR

**Descrição**: Durante processamento (preview ou importação), cliente recebe atualizações de progresso via WebSocket (SignalR): linhas processadas, erros encontrados, percentual completado.

**Justificativa**: Feedback visual ao usuário; permite detecção de travamento.

**Implementação**: Hub SignalR `UploadProgressHub` notifica clientes conectados

---

### RN-UPL-084-10: Rollback Transacional e Auditoria

**Descrição**: Importação é executada em transação SQL única. Se qualquer linha falhar validação, TODA importação é desfeita. Evento é auditado com ID de upload, usuário, timestamp, total de linhas, total de erros.

**Justificativa**: Garantir integridade referencial; prevenir dados parciais.

**Implementação**: Usar `TransactionScope` ou `DbContext.Database.BeginTransaction()` com `RollBack()` em caso de exceção

---

## 3. REFERÊNCIAS AO LEGADO

### 3.1 Banco de Dados Legado

**Banco**: `BDICSYSTEM` (SQL Server 2019)

**Tabela Principal**: `Tb_Importacoes` (conceitual, pode não existir em legado)

```sql
CREATE TABLE [dbo].[Tb_Importacoes](
    [Id_Importacao] [int] IDENTITY(1,1) NOT NULL,
    [Id_Usuario] [int] NOT NULL,
    [Nm_Arquivo] [varchar](255) NOT NULL,
    [Tp_Importacao] [varchar](50) NOT NULL, -- 'Ativo', 'Contrato', 'Fatura', etc.
    [Qt_Linhas_Importadas] [int] NOT NULL,
    [Qt_Linhas_Erros] [int] NOT NULL,
    [Dt_Importacao] [datetime] NOT NULL,
    [Status] [varchar](20) NOT NULL, -- 'Pendente', 'Processando', 'Sucesso', 'Erro'
    [Ds_Erro] [text] NULL,
    CONSTRAINT [PK_Tb_Importacoes] PRIMARY KEY CLUSTERED ([Id_Importacao] ASC)
)
```

**Campos Importantes**:

| Campo Legado | Descrição | Uso no Modernizado |
|--------------|-----------|-------------------|
| `[Id_Importacao]` | ID único | `UploadId` (GUID no moderno) |
| `[Nm_Arquivo]` | Nome do arquivo | `FileName` preservado |
| `[Tp_Importacao]` | Tipo de importação | Mapeado para `ImportType` enum |
| `[Qt_Linhas_Importadas]` | Contador de sucesso | `SuccessCount` |
| `[Dt_Importacao]` | Timestamp de importação | `CreatedAt` |

### 3.2 Stored Procedures Legado

| Procedure | Descrição | Migração |
|-----------|-----------|----------|
| `pa_ImportarArquivo` | Realiza importação (sem validação prévia) | Substituída por `ImportJobHandler` (async) |
| `pa_ValidarDadosImportacao` | Validação pós-envio (incompleta) | Substituída por `SchemaValidator` + `DataValidator` |
| `pa_RelatorioErrosImportacao` | Gera relatório de erros | Substituída por endpoint GET `/api/uploads/{id}/errors` |

### 3.3 Telas ASPX

| Página | Descrição | Tela Moderna |
|--------|-----------|--------------|
| `UploadArquivo.aspx` | Form simples de upload | `/imports/upload` (Angular) |
| `RelatorioImportacoes.aspx` | Lista de importações e status | `/imports/history` (Angular) |
| `ValidarImportacao.aspx` | Preview de dados antes de importar | `/imports/{id}/preview` (Angular) |

### 3.4 WebServices Legado (VB.NET)

**Arquivo**: `D:\IC2\ic1_legado\WebService\WSImport.asmx.vb` (presumido)

| Método | Descrição | Endpoint Moderno |
|--------|-----------|-----------------|
| `UploadArquivo(arquivo, tipo)` | Recebe arquivo base64 | `POST /api/uploads/chunk` |
| `ValidarArquivo(id)` | Valida estrutura | `GET /api/uploads/{id}/preview` |
| `ProcessarImportacao(id)` | Inicia importação | `POST /api/uploads/{id}/import` |
| `ObterStatus(id)` | Obtém status da importação | `GET /api/uploads/{id}/status` (via SignalR) |

---

## 4. INTEGRAÇÕES OBRIGATÓRIAS

### 4.1 Central de Funcionalidades (Feature Flags)

**FeatureKey**: `UPLOADS_IMPORT`

**Configuração**:
```json
{
    "featureKey": "UPLOADS_IMPORT",
    "nome": "Upload e Importação de Arquivos",
    "descricao": "Permite upload de arquivos CSV, Excel, XML, JSON com validação e processamento assíncrono",
    "habilitado": true,
    "isSystemFeature": true,
    "settings": {
        "maxFileSize": 524288000,
        "enableClamAV": true,
        "enableSignalR": true,
        "chunkSizeBytes": 5242880,
        "maxConcurrentChunks": 3
    }
}
```

**Recursos relacionados**:
- `UPLOADS_IMPORT_PREVIEW`: Exibir preview de dados
- `UPLOADS_IMPORT_ASYNC`: Usar processamento assíncrono (Hangfire)
- `UPLOADS_IMPORT_ANTIVIRUS`: Ativar validação antivírus

---

### 4.2 Internacionalização (i18n)

**Chaves de Tradução**:

```json
{
    "uploads": {
        "title": "Upload e Importação de Arquivos",
        "subtitle": "Envie arquivos CSV, Excel, XML ou JSON para importação em massa",
        "form": {
            "selectFile": "Selecionar arquivo",
            "importType": "Tipo de importação",
            "importTypeHint": "Escolha o tipo de dados a importar (Ativos, Contratos, Faturas, etc.)",
            "dragAndDrop": "Arraste arquivos ou clique para selecionar",
            "uploadButton": "Fazer Upload",
            "previewButton": "Preview",
            "importButton": "Confirmar Importação",
            "cancelButton": "Cancelar"
        },
        "messages": {
            "uploadSuccess": "Arquivo enviado com sucesso",
            "uploadError": "Erro ao fazer upload do arquivo",
            "fileTooBig": "Arquivo excede o limite de 500MB",
            "invalidMimeType": "Tipo de arquivo não permitido",
            "antivirusDetected": "Arquivo contém malware (ClamAV)",
            "processingFile": "Processando arquivo...",
            "previewReady": "Preview pronto para revisão",
            "importStarted": "Importação iniciada",
            "importCompleted": "Importação concluída com sucesso",
            "importFailed": "Importação falhou"
        },
        "validation": {
            "fileRequired": "Selecione um arquivo",
            "typeRequired": "Escolha o tipo de importação",
            "missingColumns": "Colunas obrigatórias faltando: {columns}",
            "invalidDataType": "Tipo de dado inválido na coluna {column}: esperado {expected}, recebido {actual}",
            "invalidValue": "Valor inválido na linha {row}, coluna {column}: {error}",
            "duplicateRecord": "Registro duplicado na linha {row}",
            "foreignKeyError": "Registro referenciado não existe (linha {row})"
        },
        "preview": {
            "title": "Preview de Dados",
            "totalLines": "Total de linhas: {count}",
            "errorLines": "Linhas com erro: {count}",
            "successLines": "Linhas válidas: {count}",
            "firstLines": "Primeiras 100 linhas do arquivo",
            "noErrors": "Nenhum erro encontrado",
            "showErrors": "Mostrar apenas linhas com erro",
            "hideErrors": "Mostrar todas as linhas"
        },
        "progress": {
            "uploading": "Enviando... {percent}%",
            "validating": "Validando arquivo...",
            "scanning": "Scaneando antivírus...",
            "processing": "Processando {current} de {total} linhas",
            "completed": "Concluído"
        },
        "history": {
            "title": "Histórico de Importações",
            "columns": {
                "file": "Arquivo",
                "type": "Tipo",
                "date": "Data",
                "user": "Usuário",
                "status": "Status",
                "lines": "Linhas",
                "errors": "Erros",
                "actions": "Ações"
            },
            "viewDetails": "Ver Detalhes",
            "downloadErrors": "Baixar Erros",
            "retry": "Tentar Novamente"
        }
    }
}
```

---

### 4.3 Auditoria

**Operações Auditadas**:

| Operação | Código | Dados Registrados |
|----------|--------|-------------------|
| Upload iniciado | `UPLOADS_UPLOAD_START` | FileName, FileSize, MimeType, ClientId, UserId |
| Upload concluído | `UPLOADS_UPLOAD_COMPLETE` | UploadId, FileHash, TotalChunks, Duration |
| Antivírus validado | `UPLOADS_ANTIVIRUS_SCAN` | UploadId, ScanResult (Safe/Threat), ThreatName |
| Preview gerado | `UPLOADS_PREVIEW_GENERATED` | UploadId, SuccessCount, ErrorCount, Duration |
| Importação iniciada | `UPLOADS_IMPORT_START` | UploadId, ImportType, TotalLines, JobId |
| Importação concluída | `UPLOADS_IMPORT_COMPLETE` | UploadId, SuccessCount, FailCount, Duration, Status |
| Importação com erro | `UPLOADS_IMPORT_ERROR` | UploadId, ErrorDescription, FailedLines, RollbackStatus |
| Arquivo excluído | `UPLOADS_FILE_DELETE` | UploadId, FileName, DeletionReason |
| Relatório de erros baixado | `UPLOADS_ERROR_REPORT_DOWNLOAD` | UploadId, Format, UserId, Timestamp |

**Retenção**: 7 anos (conforme LGPD Artigo 7º)

---

### 4.4 Controle de Acesso (RBAC)

**Permissões**:

| Permissão | Descrição | Perfis |
|-----------|-----------|--------|
| `uploads:file:upload` | Fazer upload de arquivo | Analista, Gerente, Admin |
| `uploads:file:preview` | Visualizar preview antes de importar | Analista, Gerente, Admin |
| `uploads:file:import` | Confirmar e processar importação | Gerente, Admin |
| `uploads:file:retry` | Tentar novamente importação falhada | Gerente, Admin |
| `uploads:file:delete` | Excluir arquivo de upload | Admin |
| `uploads:history:read` | Visualizar histórico de importações | Analista, Gerente, Admin |
| `uploads:errors:download` | Baixar relatório de erros | Analista, Gerente, Admin |
| `uploads:config:manage` | Configurar tipos de importação e schemas | Admin |

**Matriz de Perfis**:

| Perfil | Upload | Preview | Import | Retry | Delete | History | Errors | Config |
|--------|--------|---------|--------|-------|--------|---------|--------|--------|
| Analista | ✓ | ✓ | ✗ | ✗ | ✗ | ✓ | ✓ | ✗ |
| Gerente | ✓ | ✓ | ✓ | ✓ | ✗ | ✓ | ✓ | ✗ |
| Admin | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |

---

## 5. ENDPOINTS DA API

### 5.1 Gerenciamento de Upload

| Método | Endpoint | Descrição | Permissão | Status Esperado |
|--------|----------|-----------|-----------|-----------------|
| POST | `/api/uploads` | Iniciar upload (retorna sessionId) | `uploads:file:upload` | 201 Created |
| POST | `/api/uploads/{sessionId}/chunks` | Enviar chunk do arquivo | `uploads:file:upload` | 202 Accepted |
| GET | `/api/uploads/{uploadId}` | Obter metadados do upload | `uploads:history:read` | 200 OK |
| GET | `/api/uploads` | Listar uploads do usuário (paginado) | `uploads:history:read` | 200 OK |
| DELETE | `/api/uploads/{uploadId}` | Excluir upload | `uploads:file:delete` | 204 No Content |

### 5.2 Validação e Preview

| Método | Endpoint | Descrição | Permissão | Status Esperado |
|--------|----------|-----------|-----------|-----------------|
| POST | `/api/uploads/{uploadId}/validate` | Validar estrutura (schema + antivírus) | `uploads:file:preview` | 200 OK |
| GET | `/api/uploads/{uploadId}/preview` | Obter preview (primeiras 100 linhas) | `uploads:file:preview` | 200 OK |
| GET | `/api/uploads/{uploadId}/errors` | Listar linhas com erro do preview | `uploads:file:preview` | 200 OK |

### 5.3 Importação e Processamento

| Método | Endpoint | Descrição | Permissão | Status Esperado |
|--------|----------|-----------|-----------|-----------------|
| POST | `/api/uploads/{uploadId}/import` | Confirmar e iniciar importação | `uploads:file:import` | 202 Accepted |
| GET | `/api/uploads/{uploadId}/status` | Obter status da importação (síncrono ou job) | `uploads:history:read` | 200 OK |
| POST | `/api/uploads/{uploadId}/retry` | Reprocessar importação falhada | `uploads:file:retry` | 202 Accepted |
| GET | `/api/uploads/{uploadId}/report` | Baixar relatório de erros (JSON/CSV) | `uploads:errors:download` | 200 OK |

### 5.4 Configuração (Admin)

| Método | Endpoint | Descrição | Permissão | Status Esperado |
|--------|----------|-----------|-----------|-----------------|
| GET | `/api/uploads/config/types` | Listar tipos de importação disponíveis | `uploads:config:manage` | 200 OK |
| GET | `/api/uploads/config/types/{type}/schema` | Obter schema de um tipo | `uploads:config:manage` | 200 OK |
| PUT | `/api/uploads/config/types/{type}/schema` | Atualizar schema de um tipo | `uploads:config:manage` | 200 OK |

---

## 6. FLUXOS PRINCIPAIS

### 6.1 Fluxo de Upload com Chunking

```
Usuário seleciona arquivo (até 500MB)
    |
    v
[Validação de tamanho e tipo MIME] --X--> Erro → Mensagem "Tipo inválido ou arquivo muito grande"
    |
    v (OK)
[Iniciando upload] → POST /api/uploads → Recebe sessionId
    |
    v
[Dividir arquivo em chunks 5MB]
    |
    v
[Upload paralelo de chunks] → POST /api/uploads/{sessionId}/chunks
    |
    +---> Chunk 1 → 202 Accepted → Progress: 20%
    |
    +---> Chunk 2 → 202 Accepted → Progress: 40%
    |
    +---> Chunk 3 → 202 Accepted → Progress: 60%
    |
    +---> Chunk 4 → 202 Accepted → Progress: 80%
    |
    v
[Todos chunks recebidos]
    |
    v
[Upload concluído] → UploadId retornado
    |
    v
[Usuário avança para Preview]
```

### 6.2 Fluxo de Validação e Preview

```
Usuário clica em "Preview"
    |
    v
[Montando arquivo a partir de chunks]
    |
    v
[Validação de tipo MIME do arquivo montado]
    |
    v
[Scan ClamAV] --X--> Malware detectado → Rejeitar + Auditar + Excluir arquivo
    |
    v (Seguro)
[Leitura de primeiras 100 linhas]
    |
    v
[Validação de schema] --X--> Coluna obrigatória faltando → Mostrar erro
    |
    v (Schema OK)
[Validação de dados por linha] → Tipagem, ranges, FK
    |
    v
[Separar linhas OK de linhas com erro]
    |
    v
[Mostrar preview ao usuário] com count de erros e opção de continuar ou cancelar
```

### 6.3 Fluxo de Importação com Rollback

```
Usuário confirma importação em Preview
    |
    v
[Iniciar transação SQL]
    |
    v
[Validação final de todos dados]
    |
    v
[Hangfire job enfileirado para processamento assíncrono]
    |
    v (Se arquivo > 10MB)
[Job em background processa linhas]
    |
    +---> Inserir linha 1 → OK → InsertedCount++
    |
    +---> Inserir linha 2 → ERRO (FK) → ErrorCount++ → Marcar linha
    |
    +---> ... (continua processando)
    |
    v
[Fim do processamento]
    |
    +--- Se ErrorCount > 0 → ROLLBACK transação → Desfazer tudo
    |
    +--- Se ErrorCount == 0 → COMMIT transação → Confirmar todos inserts
    |
    v
[Gerar relatório final: X sucesso, Y erros]
    |
    v
[Notificar usuário via SignalR]
    |
    v
[Fim]
```

---

## 7. SEGURANÇA

### 7.1 Proteções Implementadas

| Proteção | Descrição | Implementação |
|----------|-----------|----------------|
| Whitelist MIME Types | Apenas 6 tipos permitidos | Validação em `MimeTypeValidator` |
| Validação de Extensão | Extensão deve bater com tipo MIME | Previne spoofing |
| Limite de Tamanho | Máximo 500MB por arquivo | Validação em upload |
| ClamAV Antivírus | Scan obrigatório antes de processar | Integração com ClamAV daemon |
| Encriptação em Repouso | Arquivo salvo encriptado em Azure Blob | AES-256 |
| HTTPS Obrigatório | API requer HTTPS | TLS 1.2+ |
| Rate Limiting | Max 10 uploads/min por usuário | Middleware de rate limiting |
| CSRF Protection | Token CSRF em todas operações POST/PUT | Atributo `[ValidateAntiForgeryToken]` |
| SQL Injection Prevention | Parametrized queries em todas operações | Entity Framework Core |
| XSS Prevention | Escapar dados em resposta JSON | Framework Angular |

### 7.2 Testes de Segurança Obrigatórios

- [ ] Upload de arquivo .exe com extensão .csv → Deve ser rejeitado
- [ ] Upload de arquivo 600MB → Deve ser rejeitado com erro de tamanho
- [ ] Tentar acessar preview de upload de outro usuário → Deve retornar 403 Forbidden
- [ ] Tentar confirmar importação sem permissão `uploads:file:import` → Deve retornar 403 Forbidden
- [ ] Arquivo contaminado com malware (teste com EICAR) → ClamAV deve detectar
- [ ] Enviar CSV com SQL injection em campo → Validação de data deve rejeitar
- [ ] Enviar JSON malformado → Parser deve falhar com erro claro
- [ ] Null byte injection em nome do arquivo → Sanitizar nome antes de salvar
- [ ] Enviar chunk com tamanho > 10MB → Dividir em chunks menores
- [ ] Concurrent uploads do mesmo usuário → Suportar até 5 uploads paralelos

---

## 8. MÉTRICAS E INDICADORES

### 8.1 KPIs

| KPI | Meta | Medição |
|-----|------|---------|
| Taxa de Sucesso de Upload | > 99% | (Uploads com sucesso / Total uploads) * 100 |
| Tempo Médio de Preview | < 5s | Timestamp fim_validacao - inicio_validacao |
| Tempo de Importação (100K linhas) | < 2 min | Timestamp fim_importacao - inicio_importacao |
| Taxa de Detecção Antivírus | 100% | Testes com EICAR + malware simulado |
| Disponibilidade API Uploads | > 99.9% | Uptime monitorado (SLA) |
| Tamanho Médio de Arquivo Importado | 20MB | Aggregate de todos uploads |
| Taxa de Importação Retry | < 5% | (Imports com retry / Total imports) * 100 |
| Retenção de Auditoria | 7 anos | Validar integridade de registros audit |

### 8.2 Alertas

| Alerta | Condição | Ação |
|--------|----------|------|
| Taxa de Falha Alta | > 10% uploads falhando | Investigar causa raiz, notificar admin |
| ClamAV Offline | Serviço não respondendo | Bloquear uploads até restaurar |
| Armazenamento Azure Cheio | > 90% da quota | Alertar admin para expandir quota |
| Upload Travado | Chunk sem progresso > 10 min | Cancelar job e notificar usuário |
| Transação Longa | Importação > 10 min | Log warning, monitorar deadlocks |
| Malware Detectado | Qualquer detecção ClamAV | Email alert ao security team |
| Acesso Não Autorizado | Tentativa de acessar upload alheio | Log + Alert + Ban IP por 1 hora |

---

## 9. PRÓXIMOS PASSOS

1. **Modelo de Dados**: Criar [MD-RF084](./MD-RF084-Upload-Importacao.md)
2. **Casos de Uso**: Criar [UC-RF084](./UC-RF084-Upload-Importacao.md)
3. **Implementação Backend**: Commands/Queries/Handlers em .NET 10
4. **Implementação Frontend**: Componentes Angular 19 com upload drag-drop
5. **Testes**: Executar cenários (happy path, erros, segurança, performance)
6. **Integração ClamAV**: Configurar daemon na infraestrutura
7. **Integração Azure Blob**: Configurar storage account e containers
8. **Integração Hangfire**: Configurar SQL Server job queue

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 1.0 | 2025-12-28 | Versão inicial com 10 RN, integrações, endpoints e segurança | Claude Code |

---

**Última Atualização**: 2025-12-28
**Autor**: Claude Code - IControlIT Architect Agent
**Revisão**: Pendente
