# Casos de Uso - RF022

**Versão:** 1.0
**Data:** 2025-12-17
**RF Relacionado:** [RF022 - Gestao-de-Fornecedores](./RF022.md)

---

## Índice de Casos de Uso

| UC | Nome | Descrição |
|----|------|-----------|
| UC00 | UC00 - Listar Fornecedores | Caso de uso |
| UC01 | UC01 - Criar Fornecedor | Caso de uso |
| UC02 | UC02 - Visualizar Fornecedor | Caso de uso |
| UC03 | UC03 - Editar Fornecedor | Caso de uso |
| UC04 | UC04 - Inativar Fornecedor | Caso de uso |

---

# UC00 - Listar Fornecedores

**RF:** [RF-008 - Gestão de Fornecedores e Empresas Contratadas](../RF-008-Gestao-de-FornecedoresEmpresas-Contratadas.md)

**Versão:** 1.0
**Data:** 04/11/2025

---

## Descrição

Este caso de uso permite ao usuário **listar, filtrar e pesquisar fornecedores** cadastrados no sistema, com suporte a paginação, ordenação e filtros avançados.

---

## Atores

- **Usuário Autenticado** com permissão `CAD.FORNECEDORES.READ`

---

## Pré-condições

1. Usuário autenticado no sistema
2. Usuário possui permissão `CAD.FORNECEDORES.READ`
3. Sessão válida e não expirada
4. Sistema de backend disponível

---

## Pós-condições

**Sucesso:**
- Lista de fornecedores é exibida conforme filtros aplicados
- Usuário pode navegar entre páginas
- Usuário pode aplicar ordenação

**Falha:**
- Mensagem de erro é exibida
- Sistema mantém estado atual

---

## Fluxo Principal

1. Usuário acessa o menu "Cadastros → Fornecedores"
2. Sistema verifica permissão `CAD.FORNECEDORES.READ`
3. Sistema exibe tela de listagem com filtros
4. Sistema carrega primeira página com 10 fornecedores (padrão)
5. Sistema exibe fornecedores em grid com colunas:
   - Razão Social / Nome Fantasia
   - CNPJ
   - Tipo de Fornecedor
   - Cidade - UF
   - Telefone Principal
   - Avaliação (estrelas)
   - Status
   - Ações (Visualizar, Editar, Avaliar)
6. Usuário visualiza lista de fornecedores
7. Caso de uso encerra

---

## Fluxos Alternativos

### FA01 - Aplicar Filtro de Pesquisa

**Gatilho:** Usuário preenche campo de filtro e clica em "Pesquisar"

1. Usuário preenche um ou mais filtros:
   - Razão Social (texto livre)
   - CNPJ (máscara ##.###.###/####-##)
   - Tipo de Fornecedor (dropdown)
   - Status (dropdown)
   - Cidade/UF
2. Usuário clica em botão "Pesquisar"
3. Sistema valida filtros
4. Sistema executa consulta no backend
5. Sistema exibe resultados filtrados
6. Sistema atualiza contador "X fornecedores encontrados"
7. Retorna ao passo 6 do fluxo principal

### FA02 - Limpar Filtros

**Gatilho:** Usuário clica em "Limpar Filtros"

1. Sistema limpa todos os campos de filtro
2. Sistema recarrega lista completa (primeira página)
3. Retorna ao passo 4 do fluxo principal

### FA03 - Ordenar Coluna

**Gatilho:** Usuário clica no cabeçalho de uma coluna

1. Sistema identifica coluna selecionada
2. Sistema alterna ordenação (ASC ↔ DESC)
3. Sistema recarrega lista com nova ordenação
4. Sistema exibe indicador visual de ordenação (seta)
5. Retorna ao passo 6 do fluxo principal

### FA04 - Navegar entre Páginas

**Gatilho:** Usuário clica em controle de paginação

1. Usuário seleciona:
   - Próxima página
   - Página anterior
   - Número de página específico
   - Quantidade de itens por página (10, 25, 50, 100)
2. Sistema valida página solicitada
3. Sistema carrega dados da página
4. Sistema atualiza indicador de paginação "Página X de Y"
5. Retorna ao passo 6 do fluxo principal

### FA05 - Visualizar Detalhes do Fornecedor

**Gatilho:** Usuário clica em ícone "Visualizar" (olho)

1. Sistema redireciona para UC02-visualizar-fornecedor
2. Caso de uso encerra

### FA06 - Editar Fornecedor

**Gatilho:** Usuário clica em ícone "Editar" (lápis)

**Pré-condição adicional:** Usuário possui permissão `CAD.FORNECEDORES.UPDATE`

1. Sistema redireciona para UC03-editar-fornecedor
2. Caso de uso encerra

### FA07 - Avaliar Fornecedor

**Gatilho:** Usuário clica em ícone "Avaliar" (estrela)

**Pré-condição adicional:** Usuário possui permissão `CAD.FORNECEDORES.AVALIAR`

1. Sistema redireciona para UC06-avaliar-fornecedor
2. Caso de uso encerra

### FA08 - Criar Novo Fornecedor

**Gatilho:** Usuário clica em botão "Novo Fornecedor"

**Pré-condição adicional:** Usuário possui permissão `CAD.FORNECEDORES.CREATE`

1. Sistema redireciona para UC01-criar-fornecedor
2. Caso de uso encerra

### FA09 - Exportar Lista para Excel

**Gatilho:** Usuário clica em botão "Exportar"

**Pré-condição adicional:** Usuário possui permissão `CAD.FORNECEDORES.EXPORT`

1. Sistema gera arquivo Excel com fornecedores filtrados
2. Sistema aplica mesmos filtros da tela
3. Sistema inclui todas as colunas visíveis
4. Sistema faz download do arquivo "fornecedores_YYYYMMDD_HHMMSS.xlsx"
5. Sistema exibe mensagem "Exportação concluída com sucesso"
6. Retorna ao passo 6 do fluxo principal

---

## Fluxos de Exceção

### FE01 - Usuário sem Permissão

**Gatilho:** Usuário não possui permissão `CAD.FORNECEDORES.READ`

1. Sistema valida permissões do usuário
2. Sistema identifica ausência de permissão
3. Sistema registra tentativa de acesso não autorizado em auditoria
4. Sistema retorna HTTP 403 Forbidden
5. Frontend exibe mensagem: "Você não possui permissão para acessar esta funcionalidade"
6. Sistema redireciona para página de acesso negado
7. Caso de uso encerra

### FE02 - Erro na Consulta ao Backend

**Gatilho:** Backend retorna erro (500, timeout, etc.)

1. Frontend detecta erro na resposta HTTP
2. Sistema exibe mensagem: "Erro ao carregar fornecedores. Tente novamente"
3. Sistema registra erro no console
4. Sistema mantém última lista carregada (se houver)
5. Usuário pode tentar novamente
6. Caso de uso encerra

### FE03 - Nenhum Fornecedor Encontrado

**Gatilho:** Consulta retorna 0 resultados

1. Sistema detecta lista vazia
2. Sistema exibe mensagem: "Nenhum fornecedor encontrado com os filtros aplicados"
3. Sistema sugere "Limpar Filtros" ou "Criar Novo Fornecedor"
4. Grid permanece vazio com mensagem centralizada
5. Caso de uso encerra

### FE04 - Sessão Expirada

**Gatilho:** Token de autenticação expirou

1. Backend retorna HTTP 401 Unauthorized
2. Frontend detecta expiração
3. Sistema exibe mensagem: "Sua sessão expirou. Faça login novamente"
4. Sistema redireciona para tela de login
5. Caso de uso encerra

---

## Regras de Negócio

### RN-UC00-001: Verificação de Permissão de Leitura

**Descrição:** Sistema deve verificar se usuário possui permissão `CAD.FORNECEDORES.READ` antes de exibir lista.

**Validação:**
```sql
SELECT COUNT(*) FROM Usuario_Perfil up
JOIN Perfil_Funcionalidade pf ON up.Id_Perfil = pf.Id_Perfil
JOIN Central_Funcionalidade cf ON pf.Id_Funcionalidade = cf.Id_Funcionalidade
WHERE up.Id_Usuario = @Id_Usuario
  AND cf.Cd_Funcionalidade = 'CAD.FORNECEDORES.READ'
  AND pf.Fl_Ler = 1
```

**Exceção:** Se retornar 0, acesso negado (FE01)

### RN-UC00-002: Isolamento Multi-tenant

**Descrição:** Lista deve exibir apenas fornecedores do conglomerado do usuário autenticado.

**Validação:**
```sql
SELECT * FROM Fornecedor
WHERE Id_Conglomerado = @Id_Conglomerado_Usuario
  AND Fl_Excluido = 0
```

### RN-UC00-003: Paginação Obrigatória

**Descrição:** Lista deve ser paginada para evitar sobrecarga.

**Configuração Padrão:**
- Tamanho de página padrão: 10 itens
- Tamanhos permitidos: 10, 25, 50, 100
- Máximo de itens por página: 100

### RN-UC00-004: Ordenação Padrão

**Descrição:** Lista deve ser ordenada por "Razão Social" ascendente por padrão.

**SQL:**
```sql
ORDER BY Razao_Social ASC
```

### RN-UC00-005: Filtros Case-Insensitive

**Descrição:** Pesquisa por texto deve ignorar maiúsculas/minúsculas e acentuação.

**Implementação:**
```sql
WHERE UPPER(REMOVE_ACCENTS(Razao_Social)) LIKE UPPER(REMOVE_ACCENTS('%' + @Filtro + '%'))
```

### RN-UC00-006: Máscara de CNPJ

**Descrição:** CNPJ deve ser exibido com máscara: ##.###.###/####-##

**Exemplo:** `12.345.678/0001-90`

### RN-UC00-007: Exibição de Avaliação

**Descrição:** Avaliação deve ser exibida como estrelas (1-5) com nota média.

**Formato:** ⭐⭐⭐⭐☆ (4.2)

### RN-UC00-008: Badge de Status

**Descrição:** Status deve ser exibido com cores distintas:
- ATIVO: verde
- INATIVO: cinza
- BLOQUEADO: vermelho
- PENDENTE_APROVACAO: amarelo
- PENDENTE_DOCUMENTACAO: laranja

---

## Critérios de Aceitação

| ID | Critério | Validação |
|----|----------|-----------|
| CA01 | Sistema exibe lista de fornecedores do conglomerado | Verificar filtro por Id_Conglomerado |
| CA02 | Sistema aplica paginação com 10 itens por padrão | Verificar quantidade de registros exibidos |
| CA03 | Sistema permite ordenação por qualquer coluna | Clicar em cabeçalhos e verificar ordenação |
| CA04 | Sistema permite filtrar por Razão Social | Digitar texto e verificar resultados |
| CA05 | Sistema permite filtrar por CNPJ | Digitar CNPJ e verificar resultados |
| CA06 | Sistema permite filtrar por Tipo | Selecionar tipo e verificar resultados |
| CA07 | Sistema permite filtrar por Status | Selecionar status e verificar resultados |
| CA08 | Sistema exibe avaliação em estrelas | Verificar coluna de avaliação |
| CA09 | Sistema exibe apenas ações permitidas por permissão | Verificar botões visíveis |
| CA10 | Sistema exporta lista para Excel | Clicar em exportar e verificar download |
| CA11 | Sistema bloqueia acesso sem permissão | Tentar acessar sem permissão READ |
| CA12 | Sistema exibe mensagem quando lista vazia | Aplicar filtro que retorna 0 resultados |

---

## Internacionalização

**Chaves de Tradução:**

| Chave | PT-BR |
|-------|-------|
| `FORNECEDORES.TITLE` | "Fornecedores e Empresas Contratadas" |
| `FORNECEDORES.SUBTITLE` | "Gestão de fornecedores, operadoras e prestadores de serviços" |
| `FORNECEDORES.BUTTON.NEW` | "Novo Fornecedor" |
| `FORNECEDORES.BUTTON.SEARCH` | "Pesquisar" |
| `FORNECEDORES.BUTTON.CLEAR` | "Limpar Filtros" |
| `FORNECEDORES.BUTTON.EXPORT` | "Exportar" |
| `FORNECEDORES.FILTER.RAZAO_SOCIAL` | "Razão Social" |
| `FORNECEDORES.FILTER.CNPJ` | "CNPJ" |
| `FORNECEDORES.FILTER.TIPO` | "Tipo de Fornecedor" |
| `FORNECEDORES.FILTER.STATUS` | "Status" |
| `FORNECEDORES.COLUMN.RAZAO_SOCIAL` | "Razão Social" |
| `FORNECEDORES.COLUMN.CNPJ` | "CNPJ" |
| `FORNECEDORES.COLUMN.TIPO` | "Tipo" |
| `FORNECEDORES.COLUMN.CIDADE` | "Cidade - UF" |
| `FORNECEDORES.COLUMN.TELEFONE` | "Telefone" |
| `FORNECEDORES.COLUMN.AVALIACAO` | "Avaliação" |
| `FORNECEDORES.COLUMN.STATUS` | "Status" |
| `FORNECEDORES.COLUMN.ACOES` | "Ações" |
| `FORNECEDORES.MESSAGE.NO_RECORDS` | "Nenhum fornecedor encontrado" |
| `FORNECEDORES.MESSAGE.EXPORT_SUCCESS` | "Exportação concluída com sucesso" |
| `FORNECEDORES.MESSAGE.COUNT` | "{count} fornecedores encontrados" |
| `FORNECEDORES.TOOLTIP.VIEW` | "Visualizar fornecedor" |
| `FORNECEDORES.TOOLTIP.EDIT` | "Editar fornecedor" |
| `FORNECEDORES.TOOLTIP.RATE` | "Avaliar fornecedor" |

---

## Auditoria

**Operações Auditadas:**
- ❌ **Leitura/Listagem NÃO é auditada** (volume muito alto)
- ✅ **Exportação é auditada** (dados sensíveis)

**Registro de Exportação:**
```json
{
  "operacao": "EXPORT",
  "entidade": "Fornecedor",
  "usuario": "usuario@empresa.com",
  "timestamp": "2025-11-04T10:30:00Z",
  "filtros_aplicados": {
    "tipo": "OPERADORA_TELECOM",
    "status": "ATIVO"
  },
  "quantidade_registros": 25,
  "ip": "192.168.1.100"
}
```

---

## Notas Técnicas

### Performance

- **Cache:** Lista de tipos de fornecedor (cache de 1 dia)
- **Índices:** Razao_Social, CNPJ, Tipo_Fornecedor, Status
- **Lazy Loading:** Carregar apenas dados visíveis
- **Virtual Scroll:** Para listas muito grandes (>1000 registros)

### Segurança

- **SQL Injection:** Usar prepared statements
- **XSS:** Sanitizar campos de texto
- **CSRF:** Token em todas as requisições

### Responsividade

- **Desktop:** Grid com todas as colunas
- **Tablet:** Ocultar colunas Telefone e Avaliação
- **Mobile:** Card list ao invés de grid

---

**Referências:**
- [RF-008 - Gestão de Fornecedores](../RF-008-Gestao-de-FornecedoresEmpresas-Contratadas.md)
- [Manual de Documentação](../../../../MANUAL-DE-DOCUMENTACAO.md)

---

# UC01 - Criar Fornecedor

**RF:** [RF-008 - Gestão de Fornecedores e Empresas Contratadas](../RF-008-Gestao-de-FornecedoresEmpresas-Contratadas.md)

**Versão:** 1.0
**Data:** 04/11/2025

---

## Descrição

Este caso de uso permite ao usuário **cadastrar um novo fornecedor** no sistema, incluindo dados básicos, classificação e informações de contato.

---

## Atores

- **Usuário Autenticado** com permissão `CAD.FORNECEDORES.CREATE`

---

## Pré-condições

1. Usuário autenticado no sistema
2. Usuário possui permissão `CAD.FORNECEDORES.CREATE`
3. Sessão válida e não expirada
4. Sistema de backend disponível

---

## Pós-condições

**Sucesso:**
- Novo fornecedor é criado no banco de dados
- Registro de auditoria é criado
- Usuário é redirecionado para tela de visualização do fornecedor
- Mensagem de sucesso é exibida

**Falha:**
- Fornecedor não é criado
- Mensagem de erro é exibida
- Usuário permanece no formulário com dados preenchidos

---

## Fluxo Principal

1. Usuário acessa tela de listagem de fornecedores (UC00)
2. Usuário clica em botão "Novo Fornecedor"
3. Sistema verifica permissão `CAD.FORNECEDORES.CREATE`
4. Sistema exibe formulário de cadastro com abas:
   - **Dados Principais** (ativa por padrão)
   - Contatos (desabilitada - requer salvar primeiro)
   - Documentos (desabilitada - requer salvar primeiro)
   - Avaliações (desabilitada - requer salvar primeiro)
5. Usuário preenche campos obrigatórios da aba "Dados Principais":
   - Tipo de Fornecedor (dropdown)
   - CNPJ ou CPF (conforme tipo)
   - Razão Social
6. Usuário preenche campos opcionais:
   - Nome Fantasia
   - Tipo de Fornecedor
   - Telefone Principal
   - Email Principal
   - Website
   - Observações
7. Usuário clica em botão "Salvar"
8. Sistema valida dados do formulário (RN-UC01-001 a RN-UC01-015)
9. Sistema verifica unicidade do CNPJ/CPF (RN-UC01-002)
10. Sistema cria registro na tabela `Fornecedor`
11. Sistema registra operação em `Fornecedor_Historico` (auditoria)
12. Sistema exibe mensagem: "Fornecedor criado com sucesso"
13. Sistema redireciona para UC02-visualizar-fornecedor com ID do novo fornecedor
14. Caso de uso encerra

---

## Fluxos Alternativos

### FA01 - Consultar CNPJ na Receita Federal

**Gatilho:** Usuário clica em "Consultar CNPJ" após preencher campo CNPJ

**Pré-condição:** Campo CNPJ válido (14 dígitos)

1. Usuário preenche campo CNPJ (formato ##.###.###/####-##)
2. Sistema valida dígitos verificadores do CNPJ
3. Usuário clica em botão "Consultar CNPJ"
4. Sistema exibe loading no botão
5. Sistema chama API da Receita Federal (ReceitaWS)
6. Sistema recebe dados cadastrais:
   - Razão Social
   - Nome Fantasia
   - CNAE
   - Data de Abertura
   - Situação (ATIVA, BAIXADA, SUSPENSA, INAPTA)
   - Telefone
   - Email
   - Endereço completo
7. Sistema preenche automaticamente os campos do formulário
8. Sistema exibe mensagem: "Dados importados da Receita Federal"
9. Usuário revisa dados preenchidos
10. Retorna ao passo 7 do fluxo principal

**Exceção FA01.1:** API da Receita Federal indisponível
1. Sistema exibe mensagem: "Serviço da Receita Federal temporariamente indisponível. Preencha os dados manualmente"
2. Usuário preenche dados manualmente
3. Retorna ao passo 5 do fluxo principal

**Exceção FA01.2:** CNPJ não encontrado
1. Sistema exibe mensagem: "CNPJ não encontrado na Receita Federal. Verifique o número digitado"
2. Usuário corrige CNPJ
3. Retorna ao passo 1 deste fluxo alternativo

**Exceção FA01.3:** CNPJ com situação BAIXADA ou SUSPENSA
1. Sistema preenche dados mas exibe alerta: "ATENÇÃO: Este CNPJ está com situação {situacao} na Receita Federal"
2. Sistema define Status do fornecedor como "BLOQUEADO" automaticamente
3. Sistema preenche campo "Motivo Status" com "Situação na Receita Federal: {situacao}"
4. Retorna ao passo 7 do fluxo principal

### FA02 - Validar CNPJ Duplicado

**Gatilho:** Usuário preenche CNPJ que já existe no sistema

1. Usuário preenche campo CNPJ
2. Usuário perde foco do campo (blur)
3. Sistema executa validação assíncrona de duplicidade
4. Sistema detecta CNPJ já cadastrado
5. Sistema exibe mensagem de erro no campo: "Este CNPJ já está cadastrado"
6. Sistema exibe link "Visualizar fornecedor existente"
7. Usuário clica no link
8. Sistema abre UC02-visualizar-fornecedor em nova aba
9. Usuário decide:
   - Cancelar criação (vai para FA04)
   - Corrigir CNPJ (volta ao passo 5 do fluxo principal)

### FA03 - Cancelar Criação

**Gatilho:** Usuário clica em botão "Cancelar"

1. Sistema verifica se há dados preenchidos
2. Sistema exibe diálogo de confirmação: "Deseja realmente cancelar? Os dados preenchidos serão perdidos"
3. Usuário confirma cancelamento
4. Sistema descarta dados do formulário
5. Sistema redireciona para UC00-listar-fornecedores
6. Caso de uso encerra

**Exceção FA03.1:** Usuário cancela o cancelamento
1. Sistema fecha diálogo
2. Retorna ao passo onde estava no fluxo principal

### FA04 - Salvar e Continuar Editando

**Gatilho:** Usuário clica em botão "Salvar e Continuar Editando"

1. Sistema executa passos 8 a 11 do fluxo principal
2. Sistema exibe mensagem: "Fornecedor criado com sucesso"
3. Sistema **NÃO redireciona**
4. Sistema habilita abas "Contatos", "Documentos", "Avaliações"
5. Sistema preenche campo ID do fornecedor (hidden)
6. Sistema altera botão "Salvar" para "Atualizar"
7. Usuário pode adicionar contatos, documentos, etc.
8. Caso de uso permanece ativo

### FA05 - Validação em Tempo Real

**Gatilho:** Usuário preenche campos do formulário

**Para cada campo:**
1. Usuário digita no campo
2. Sistema valida formato em tempo real
3. Sistema exibe ícone de validação:
   - ✓ verde se válido
   - ✗ vermelho se inválido
4. Sistema exibe mensagem de erro abaixo do campo (se inválido)
5. Sistema desabilita botão "Salvar" se houver erros

**Validações em tempo real:**
- **CNPJ:** Dígitos verificadores + duplicidade (assíncrona)
- **CPF:** Dígitos verificadores + duplicidade (assíncrona)
- **Email:** Formato RFC 5322
- **Telefone:** Mínimo 10 dígitos
- **Website:** Formato URL válido
- **Razão Social:** Mínimo 3 caracteres

---

## Fluxos de Exceção

### FE01 - Usuário sem Permissão

**Gatilho:** Usuário não possui permissão `CAD.FORNECEDORES.CREATE`

1. Sistema valida permissões ao clicar em "Novo Fornecedor"
2. Sistema identifica ausência de permissão
3. Sistema registra tentativa não autorizada em auditoria
4. Sistema exibe mensagem: "Você não possui permissão para criar fornecedores"
5. Sistema retorna para UC00-listar-fornecedores
6. Caso de uso encerra

### FE02 - Erro de Validação de Dados

**Gatilho:** Usuário submete formulário com dados inválidos

1. Sistema valida todos os campos
2. Sistema identifica campos inválidos
3. Sistema exibe mensagens de erro em cada campo inválido
4. Sistema rola tela até primeiro campo com erro
5. Sistema mantém foco no primeiro campo com erro
6. Usuário corrige dados
7. Retorna ao passo 7 do fluxo principal

**Exemplos de erros de validação:**
- "Razão Social é obrigatória"
- "CNPJ inválido - verifique os dígitos"
- "Email em formato inválido"
- "Telefone deve ter no mínimo 10 dígitos"

### FE03 - Erro ao Criar Fornecedor (Backend)

**Gatilho:** Backend retorna erro ao tentar criar fornecedor

1. Sistema envia request POST para `/api/fornecedor`
2. Backend retorna HTTP 500 (erro interno)
3. Sistema detecta erro na resposta
4. Sistema exibe mensagem: "Erro ao criar fornecedor. Tente novamente"
5. Sistema registra erro no console (para debug)
6. Sistema mantém dados preenchidos no formulário
7. Usuário pode tentar novamente
8. Caso de uso permanece ativo

### FE04 - Sessão Expirada Durante Preenchimento

**Gatilho:** Token de autenticação expira enquanto usuário preenche formulário

1. Usuário clica em "Salvar"
2. Sistema envia request ao backend
3. Backend retorna HTTP 401 Unauthorized
4. Sistema detecta sessão expirada
5. Sistema salva dados do formulário no localStorage (temporário)
6. Sistema exibe mensagem: "Sua sessão expirou. Faça login novamente"
7. Sistema redireciona para tela de login
8. Após login, sistema exibe mensagem: "Deseja recuperar dados do formulário não salvo?"
9. Se usuário aceitar:
   - Sistema restaura dados do localStorage
   - Sistema retorna ao formulário de criação
   - Retorna ao passo 5 do fluxo principal
10. Se usuário recusar:
    - Sistema limpa localStorage
    - Caso de uso encerra

### FE05 - CNPJ Já Cadastrado (Constraint Violation)

**Gatilho:** Backend retorna erro de violação de constraint única

1. Sistema envia request POST com CNPJ duplicado
2. Backend tenta inserir no banco
3. Banco de dados retorna erro de constraint `UQ_Fornecedor_CNPJ_Conglomerado`
4. Backend retorna HTTP 409 Conflict
5. Sistema exibe mensagem: "Este CNPJ já está cadastrado no sistema"
6. Sistema marca campo CNPJ com erro
7. Sistema exibe link "Visualizar fornecedor existente"
8. Retorna ao passo 5 do fluxo principal

---

## Regras de Negócio

### RN-UC01-001: Verificação de Permissão de Criação

**Descrição:** Usuário deve possuir permissão `CAD.FORNECEDORES.CREATE`.

**Validação Backend:**
```csharp
[Authorize]
[RequiresPermission("CAD.FORNECEDORES.CREATE")]
public async Task<IActionResult> Criar([FromBody] CriarFornecedorDto dto)
```

### RN-UC01-002: CNPJ/CPF Único por Conglomerado

**Descrição:** CNPJ ou CPF deve ser único dentro do conglomerado (multi-tenancy).

**Validação SQL:**
```sql
IF EXISTS (
    SELECT 1 FROM Fornecedor
    WHERE CNPJ = @CNPJ
      AND Id_Conglomerado = @Id_Conglomerado
      AND Fl_Excluido = 0
)
BEGIN
    THROW 50001, 'CNPJ já cadastrado para este conglomerado', 1
END
```

### RN-UC01-003: Validação de CNPJ (Dígitos Verificadores)

**Descrição:** CNPJ deve ser válido conforme algoritmo da Receita Federal.

**Implementação:** Ver algoritmo no RF-008 (RN-CAD-010-02)

### RN-UC01-004: Validação de CPF (Dígitos Verificadores)

**Descrição:** CPF deve ser válido conforme algoritmo da Receita Federal.

**Implementação:** Algoritmo similar ao CNPJ

### RN-UC01-005: Razão Social Obrigatória

**Descrição:** Razão Social é campo obrigatório com mínimo 3 e máximo 200 caracteres.

**Validação:**
```csharp
[Required(ErrorMessage = "Razão Social é obrigatória")]
[StringLength(200, MinimumLength = 3)]
public string RazaoSocial { get; set; }
```

### RN-UC01-006: Tipo de Fornecedor Obrigatório

**Descrição:** Tipo de Fornecedor é obrigatório e deve pertencer à lista predefinida.

**Tipos Permitidos:**
- OPERADORA_TELECOM
- FORNECEDOR_TI
- PRESTADOR_SERVICOS
- DISTRIBUIDOR
- FABRICANTE
- OUTROS

### RN-UC01-007: Email Válido (Se Informado)

**Descrição:** Se email informado, deve estar em formato válido (RFC 5322).

**Validação:**
```csharp
[EmailAddress(ErrorMessage = "Email em formato inválido")]
public string EmailPrincipal { get; set; }
```

### RN-UC01-008: Telefone com Mínimo de Dígitos

**Descrição:** Telefone deve ter no mínimo 10 dígitos (DDD + número).

**Validação:**
```csharp
[RegularExpression(@"^\d{10,11}$", ErrorMessage = "Telefone deve ter 10 ou 11 dígitos")]
public string TelefonePrincipal { get; set; }
```

### RN-UC01-009: Website em Formato URL (Se Informado)

**Descrição:** Website deve ser URL válida iniciando com http:// ou https://.

**Validação:**
```csharp
[Url(ErrorMessage = "Website deve ser uma URL válida")]
public string Website { get; set; }
```

### RN-UC01-010: Status Padrão

**Descrição:** Ao criar fornecedor, status padrão é "PENDENTE_APROVACAO".

**Implementação:**
```csharp
fornecedor.Status = StatusFornecedorEnum.PENDENTE_APROVACAO;
```

**Exceção:** Se CNPJ consultado na Receita Federal está BAIXADO ou SUSPENSO, status é "BLOQUEADO".

### RN-UC01-011: Auditoria de Criação

**Descrição:** Sistema deve registrar criação em `Fornecedor_Historico`.

**Registro:**
```json
{
  "Id_Fornecedor": "guid",
  "Tipo_Operacao": "CREATE",
  "Dados_Novos": "{json com todos os campos}",
  "Id_Usuario": "guid do usuário autenticado",
  "Dt_Operacao": "2025-11-04T10:30:00Z",
  "Ip_Usuario": "192.168.1.100"
}
```

### RN-UC01-012: Isolamento Multi-tenant

**Descrição:** Fornecedor deve ser criado com Id_Conglomerado do usuário autenticado.

**Implementação:**
```csharp
fornecedor.IdConglomerado = _currentUser.IdConglomerado;
```

### RN-UC01-013: Preenchimento de Campos de Auditoria

**Descrição:** Sistema deve preencher automaticamente campos de auditoria.

**Campos:**
```csharp
fornecedor.IdUsuarioCriacao = _currentUser.IdUsuario;
fornecedor.DtCriacao = DateTime.UtcNow;
fornecedor.FlExcluido = false;
```

### RN-UC01-014: Nome Fantasia Opcional

**Descrição:** Nome Fantasia é opcional, mas se informado, máximo 150 caracteres.

**Validação:**
```csharp
[StringLength(150)]
public string NomeFantasia { get; set; }
```

### RN-UC01-015: Trimming de Campos de Texto

**Descrição:** Sistema deve remover espaços em branco no início e fim de campos de texto.

**Implementação:**
```csharp
fornecedor.RazaoSocial = dto.RazaoSocial?.Trim();
fornecedor.NomeFantasia = dto.NomeFantasia?.Trim();
```

---

## Critérios de Aceitação

| ID | Critério | Validação |
|----|----------|-----------|
| CA01 | Sistema cria fornecedor com dados válidos | Preencher formulário e salvar |
| CA02 | Sistema valida CNPJ com dígitos verificadores | Informar CNPJ inválido e verificar erro |
| CA03 | Sistema impede criação de CNPJ duplicado | Tentar criar fornecedor com CNPJ existente |
| CA04 | Sistema consulta dados na Receita Federal | Clicar em "Consultar CNPJ" e verificar preenchimento |
| CA05 | Sistema bloqueia fornecedor com CNPJ baixado | Consultar CNPJ baixado e verificar status |
| CA06 | Sistema valida email em formato correto | Informar email inválido e verificar erro |
| CA07 | Sistema valida telefone com mínimo 10 dígitos | Informar telefone com 9 dígitos |
| CA08 | Sistema valida website em formato URL | Informar website sem http:// |
| CA09 | Sistema exige Razão Social obrigatória | Tentar salvar sem Razão Social |
| CA10 | Sistema exige Tipo de Fornecedor obrigatório | Tentar salvar sem tipo |
| CA11 | Sistema registra auditoria de criação | Verificar tabela Fornecedor_Historico |
| CA12 | Sistema isola fornecedores por conglomerado | Criar em conglomerado A, verificar não aparece em B |
| CA13 | Sistema exibe mensagem de sucesso após criação | Verificar toast de sucesso |
| CA14 | Sistema redireciona para visualização após criar | Verificar URL após salvar |
| CA15 | Sistema bloqueia criação sem permissão CREATE | Tentar criar sem permissão |

---

## Internacionalização

**Chaves de Tradução:**

| Chave | PT-BR |
|-------|-------|
| `FORNECEDORES.CREATE.TITLE` | "Novo Fornecedor" |
| `FORNECEDORES.CREATE.TAB.MAIN` | "Dados Principais" |
| `FORNECEDORES.CREATE.TAB.CONTACTS` | "Contatos" |
| `FORNECEDORES.CREATE.TAB.DOCUMENTS` | "Documentos" |
| `FORNECEDORES.CREATE.TAB.RATINGS` | "Avaliações" |
| `FORNECEDORES.CREATE.FIELD.TIPO` | "Tipo de Fornecedor" |
| `FORNECEDORES.CREATE.FIELD.CNPJ` | "CNPJ" |
| `FORNECEDORES.CREATE.FIELD.CPF` | "CPF" |
| `FORNECEDORES.CREATE.FIELD.RAZAO_SOCIAL` | "Razão Social" |
| `FORNECEDORES.CREATE.FIELD.NOME_FANTASIA` | "Nome Fantasia" |
| `FORNECEDORES.CREATE.FIELD.TELEFONE` | "Telefone Principal" |
| `FORNECEDORES.CREATE.FIELD.EMAIL` | "Email Principal" |
| `FORNECEDORES.CREATE.FIELD.WEBSITE` | "Website" |
| `FORNECEDORES.CREATE.BUTTON.CONSULT_CNPJ` | "Consultar CNPJ" |
| `FORNECEDORES.CREATE.BUTTON.SAVE` | "Salvar" |
| `FORNECEDORES.CREATE.BUTTON.SAVE_CONTINUE` | "Salvar e Continuar Editando" |
| `FORNECEDORES.CREATE.BUTTON.CANCEL` | "Cancelar" |
| `FORNECEDORES.CREATE.MESSAGE.SUCCESS` | "Fornecedor criado com sucesso" |
| `FORNECEDORES.CREATE.MESSAGE.CNPJ_DUPLICATED` | "Este CNPJ já está cadastrado" |
| `FORNECEDORES.CREATE.MESSAGE.RF_DATA_IMPORTED` | "Dados importados da Receita Federal" |
| `FORNECEDORES.CREATE.MESSAGE.RF_UNAVAILABLE` | "Serviço da Receita Federal temporariamente indisponível" |
| `FORNECEDORES.CREATE.VALIDATION.RAZAO_SOCIAL_REQUIRED` | "Razão Social é obrigatória" |
| `FORNECEDORES.CREATE.VALIDATION.CNPJ_INVALID` | "CNPJ inválido - verifique os dígitos" |
| `FORNECEDORES.CREATE.VALIDATION.EMAIL_INVALID` | "Email em formato inválido" |

---

## Auditoria

**Operação:** CREATE
**Tabela:** `Fornecedor_Historico`

**Dados Registrados:**
```json
{
  "Tipo_Operacao": "CREATE",
  "Dados_Novos": {
    "Id_Fornecedor": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "Razao_Social": "Fornecedor Exemplo LTDA",
    "CNPJ": "12.345.678/0001-90",
    "Tipo_Fornecedor": "OPERADORA_TELECOM",
    "Status": "PENDENTE_APROVACAO"
  },
  "Id_Usuario": "user-guid",
  "Dt_Operacao": "2025-11-04T10:30:00Z",
  "Ip_Usuario": "192.168.1.100",
  "User_Agent": "Mozilla/5.0..."
}
```

---

**Referências:**
- [RF-008 - Gestão de Fornecedores](../RF-008-Gestao-de-FornecedoresEmpresas-Contratadas.md)
- [UC00 - Listar Fornecedores](UC00-listar-fornecedores.md)
- [Manual de Documentação](../../../../MANUAL-DE-DOCUMENTACAO.md)

---

# UC02 - Visualizar Fornecedor

**RF:** [RF-008 - Gestão de Fornecedores](../RF-008-Gestao-de-FornecedoresEmpresas-Contratadas.md)

**Versão:** 1.0
**Data:** 04/11/2025

---

## Descrição

Permite ao usuário **visualizar todos os detalhes** de um fornecedor cadastrado, incluindo dados principais, contatos, documentos e histórico de avaliações.

---

## Atores

- **Usuário Autenticado** com permissão `CAD.FORNECEDORES.READ`

---

## Pré-condições

1. Usuário autenticado
2. Permissão `CAD.FORNECEDORES.READ`
3. Fornecedor existe no sistema
4. Fornecedor pertence ao conglomerado do usuário

---

## Fluxo Principal

1. Usuário acessa via UC00 ou URL direta `/fornecedores/{id}`
2. Sistema verifica permissão
3. Sistema carrega dados do fornecedor
4. Sistema exibe detalhes em abas:
   - **Dados Principais** (ativa por padrão)
   - Contatos
   - Documentos
   - Avaliações
   - Histórico de Alterações
5. Usuário visualiza informações
6. Caso de uso encerra

---

## Regras de Negócio

### RN-UC02-001: Isolamento Multi-tenant
Fornecedor deve pertencer ao conglomerado do usuário.

### RN-UC02-002: Dados Sensíveis
Telefone e email completos apenas para usuários com permissão específica.

---

## Critérios de Aceitação

- CA01: Sistema exibe todos os dados do fornecedor
- CA02: Sistema exibe lista de contatos
- CA03: Sistema exibe documentos anexados
- CA04: Sistema exibe histórico de avaliações
- CA05: Sistema bloqueia acesso a fornecedor de outro conglomerado

---

**Referências:**
- [RF-008](../RF-008-Gestao-de-FornecedoresEmpresas-Contratadas.md)
- [UC00](UC00-listar-fornecedores.md)
- [UC01](UC01-criar-fornecedor.md)

---

# UC03 - Editar Fornecedor

**RF:** [RF-008 - Gestão de Fornecedores](../RF-008-Gestao-de-FornecedoresEmpresas-Contratadas.md)

**Versão:** 1.0
**Data:** 04/11/2025

---

## Descrição

Permite ao usuário **editar dados** de um fornecedor existente.

---

## Atores

- **Usuário Autenticado** com permissão `CAD.FORNECEDORES.UPDATE`

---

## Pré-condições

1. Usuário autenticado
2. Permissão `CAD.FORNECEDORES.UPDATE`
3. Fornecedor existe
4. Fornecedor pertence ao conglomerado do usuário

---

## Fluxo Principal

1. Usuário acessa via UC00 ou UC02
2. Usuário clica em "Editar"
3. Sistema verifica permissão
4. Sistema carrega formulário com dados atuais
5. Usuário altera campos desejados
6. Usuário clica em "Salvar"
7. Sistema valida dados
8. Sistema atualiza registro
9. Sistema registra auditoria
10. Sistema exibe mensagem de sucesso
11. Sistema redireciona para UC02
12. Caso de uso encerra

---

## Fluxos Alternativos

### FA01 - Alterar CNPJ (Não Permitido com Vínculos)
Se fornecedor possui contratos ativos, CNPJ não pode ser alterado.

### FA02 - Alterar Status para BLOQUEADO
Requer justificativa obrigatória no campo "Motivo Status".

---

## Regras de Negócio

### RN-UC03-001: Não Alterar CNPJ com Contratos Ativos
Fornecedor com contratos não pode ter CNPJ alterado.

### RN-UC03-002: Justificativa Obrigatória ao Bloquear
Ao mudar status para BLOQUEADO, campo "Motivo Status" é obrigatório.

### RN-UC03-003: Auditoria de Alteração
Sistema registra estado anterior vs novo estado (diff).

---

## Critérios de Aceitação

- CA01: Sistema atualiza fornecedor com dados válidos
- CA02: Sistema impede alteração de CNPJ com contratos
- CA03: Sistema exige justificativa ao bloquear
- CA04: Sistema registra auditoria completa
- CA05: Sistema bloqueia edição sem permissão UPDATE

---

**Referências:**
- [RF-008](../RF-008-Gestao-de-FornecedoresEmpresas-Contratadas.md)
- [UC01](UC01-criar-fornecedor.md)

---

# UC04 - Inativar Fornecedor

**RF:** [RF-008 - Gestão de Fornecedores](../RF-008-Gestao-de-FornecedoresEmpresas-Contratadas.md)

**Versão:** 1.0
**Data:** 04/11/2025

---

## Descrição

Permite ao usuário **inativar** (soft delete) um fornecedor.

---

## Atores

- **Usuário Autenticado** com permissão `CAD.FORNECEDORES.DELETE`

---

## Pré-condições

1. Usuário autenticado
2. Permissão `CAD.FORNECEDORES.DELETE`
3. Fornecedor existe e está ATIVO
4. Fornecedor **NÃO possui** contratos ativos

---

## Fluxo Principal

1. Usuário acessa via UC00 ou UC02
2. Usuário clica em "Inativar" (ícone lixeira)
3. Sistema verifica permissão
4. Sistema verifica se há contratos ativos (RN-UC04-001)
5. Sistema exibe diálogo de confirmação
6. Usuário confirma inativação
7. Sistema atualiza `Status` para `INATIVO`
8. Sistema preenche campos de exclusão:
   - `Id_Usuario_Exclusao`
   - `Dt_Exclusao`
   - `Fl_Excluido = 1`
9. Sistema registra auditoria
10. Sistema exibe mensagem de sucesso
11. Sistema redireciona para UC00
12. Caso de uso encerra

---

## Fluxos de Exceção

### FE01 - Fornecedor com Contratos Ativos
**Gatilho:** Fornecedor possui contratos ativos

1. Sistema detecta contratos ativos
2. Sistema exibe mensagem de erro:
   "Não é possível inativar. Fornecedor possui X contrato(s) ativo(s)"
3. Sistema lista contratos ativos
4. Sistema sugere "Bloquear" ao invés de "Inativar"
5. Caso de uso encerra

---

## Regras de Negócio

### RN-UC04-001: Não Inativar com Contratos Ativos
Fornecedor com contratos vigentes não pode ser inativado.

**Validação SQL:**
```sql
IF EXISTS (
    SELECT 1 FROM Contrato
    WHERE Id_Fornecedor = @Id_Fornecedor
      AND Fl_Ativo = 1
      AND Dt_Vigencia_Fim >= GETDATE()
)
BEGIN
    THROW 50002, 'Fornecedor possui contratos ativos', 1
END
```

### RN-UC04-002: Soft Delete
Inativação é lógica (soft delete), não física.

### RN-UC04-003: Auditoria de Exclusão
Sistema registra inativação em auditoria.

---

## Critérios de Aceitação

- CA01: Sistema inativa fornecedor sem vínculos
- CA02: Sistema impede inativação com contratos ativos
- CA03: Sistema mantém dados históricos (soft delete)
- CA04: Sistema registra auditoria de exclusão
- CA05: Sistema bloqueia inativação sem permissão DELETE

---

**Referências:**
- [RF-008](../RF-008-Gestao-de-FornecedoresEmpresas-Contratadas.md)
- [UC00](UC00-listar-fornecedores.md)

---

## Histórico de Alterações

| Versão | Data | Autor | Descrição |
|--------|------|-------|-----------|
| 1.0 | 2025-12-17 | Sistema | Consolidação de 5 casos de uso |
