# RF-022: Gestão de Fornecedores

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC003-CAD - Cadastros Base
**Fase**: Fase 2 - Cadastros e Serviços Transversais

---

## 1. OBJETIVO DO REQUISITO

Especificar o comportamento esperado do sistema para gerenciar fornecedores e empresas contratadas, incluindo operadoras de telecomunicações, fornecedores de TI, prestadores de serviços e fabricantes. Este documento serve como **contrato oficial** entre negócio, desenvolvimento, testes e agentes de IA, definindo **o que o sistema deve fazer**, sem especificar implementação técnica.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Criação de fornecedor com dados cadastrais completos
- [x] Atualização de dados de fornecedor
- [x] Listagem de fornecedores com filtros (tipo, status, categoria)
- [x] Consulta de fornecedor por ID ou CNPJ/CPF
- [x] Inativação lógica de fornecedor
- [x] Validação de CNPJ/CPF (dígitos verificadores)
- [x] Gestão de múltiplos contatos por fornecedor (comercial, técnico, financeiro)
- [x] Avaliação de fornecedores (rating 1-5 estrelas)
- [x] Gestão de documentos obrigatórios (contratos sociais, certidões)
- [x] Controle de acesso por permissões RBAC
- [x] Isolamento por tenant (multi-tenancy)
- [x] Auditoria completa de operações

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (responsabilidade do RF-WF)
- Tecnologia, framework ou linguagem de implementação
- Layout, UX ou identidade visual
- Estratégia de deploy ou infraestrutura
- Integração com sistemas de cotação (RF futuro)
- Gestão de contratos (RF-CTR separado)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-----|---------|
| **Fornecedor** | Entidade externa que fornece produtos, serviços ou ativos para a organização |
| **CNPJ** | Cadastro Nacional de Pessoa Jurídica - identificador único de empresa no Brasil |
| **CPF** | Cadastro de Pessoa Física - identificador único de pessoa física no Brasil |
| **Tenant** | Unidade lógica de isolamento de dados (conglomerado) |
| **Rating** | Avaliação de performance do fornecedor (1-5 estrelas) |
| **Tipo de Fornecedor** | Classificação: OPERADORA_TELECOM, FORNECEDOR_TI, PRESTADOR_SERVICOS, DISTRIBUIDOR, FABRICANTE, OUTROS |
| **Status** | Estado do fornecedor: ATIVO, INATIVO, EM_HOMOLOGACAO, BLOQUEADO |
| **Contato** | Pessoa de contato do fornecedor (comercial, técnico, financeiro, jurídico) |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Criar fornecedor** - Cadastro completo com validações obrigatórias
2. **Atualizar fornecedor** - Edição de dados com auditoria
3. **Consultar fornecedor** - Busca por ID, CNPJ/CPF ou nome
4. **Listar fornecedores** - Listagem com filtros e paginação
5. **Inativar fornecedor** - Exclusão lógica com validação de vínculos
6. **Validar CNPJ/CPF** - Validação de dígitos verificadores
7. **Ger enciar contatos** - Adicionar, editar, excluir contatos do fornecedor
8. **Avaliar fornecedor** - Registrar avaliação de performance
9. **Gerenciar documentos** - Upload e controle de documentos obrigatórios
10. **Alertar vencimentos** - Notificar documentos próximos ao vencimento

---

## 5. REGRAS DE NEGÓCIO

### RN-RF022-001 — CNPJ único por tenant

**Descrição**: Se informado, o CNPJ deve ser único dentro do tenant (conglomerado).

**Justificativa**: Evitar duplicidade de fornecedores.

**Critério de Aceite**:
- Tentativa de cadastrar CNPJ duplicado → rejeição HTTP 409
- Validação executada antes de persistir
- Mensagem: "CNPJ já cadastrado neste conglomerado"

---

### RN-RF022-002 — Validação de CNPJ

**Descrição**: Se informado, CNPJ deve ser válido conforme algoritmo de dígitos verificadores.

**Critério de Aceite**:
- CNPJ com dígitos verificadores incorretos → rejeição HTTP 400
- Validação executada no backend (não confiar apenas no frontend)
- Mensagem: "CNPJ inválido"

---

### RN-RF022-003 — Validação de CPF

**Descrição**: Se informado CPF (fornecedor pessoa física), deve ser válido conforme algoritmo de dígitos verificadores.

**Critério de Aceite**:
- CPF com dígitos verificadores incorretos → rejeição HTTP 400
- Mensagem: "CPF inválido"

---

### RN-RF022-004 — Tipo de fornecedor obrigatório

**Descrição**: Tipo de fornecedor é obrigatório e deve pertencer à lista predefinida.

**Critério de Aceite**:
- Campo tipo ausente ou null → rejeição HTTP 400
- Tipo fora da lista permitida → rejeição HTTP 400
- Tipos permitidos: OPERADORA_TELECOM, FORNECEDOR_TI, PRESTADOR_SERVICOS, DISTRIBUIDOR, FABRICANTE, OUTROS

---

### RN-RF022-005 — Nome obrigatório

**Descrição**: Nome do fornecedor (razão social ou nome fantasia) é obrigatório.

**Critério de Aceite**:
- Campo nome ausente, null ou vazio → rejeição HTTP 400
- Nome deve ter entre 3 e 200 caracteres
- Mensagem: "Nome do fornecedor é obrigatório"

---

### RN-RF022-006 — Status válido

**Descrição**: Status do fornecedor deve pertencer à lista predefinida.

**Critério de Aceite**:
- Status ausente → assumir default "ATIVO"
- Status fora da lista → rejeição HTTP 400
- Status permitidos: ATIVO, INATIVO, EM_HOMOLOGACAO, BLOQUEADO

---

### RN-RF022-007 — Não inativar fornecedor com contratos ativos

**Descrição**: Não permitir inativação de fornecedor com contratos ativos vinculados.

**Critério de Aceite**:
- Tentativa de inativar com contratos ativos → rejeição HTTP 409
- Mensagem: "Não é possível inativar fornecedor com contratos ativos"
- Listar contratos ativos na resposta de erro

---

### RN-RF022-008 — Validação de e-mail

**Descrição**: Se informado, e-mail principal deve ter formato válido.

**Critério de Aceite**:
- E-mail sem @ ou domínio → rejeição HTTP 400
- Validação via regex padrão RFC 5322
- Mensagem: "E-mail inválido"

---

### RN-RF022-009 — Apenas um contato principal por tipo

**Descrição**: Pode haver apenas um contato principal por tipo (Comercial, Técnico, Financeiro, Jurídico).

**Critério de Aceite**:
- Tentativa de marcar segundo contato como principal do mesmo tipo → rejeição HTTP 409
- Ao marcar novo contato como principal, desmarcar o anterior automaticamente
- Mensagem: "Já existe um contato principal do tipo {tipo}"

---

### RN-RF022-010 — Nota de avaliação válida

**Descrição**: Notas de avaliação individual (qualidade, prazo, atendimento, preço) devem estar entre 1 e 5.

**Critério de Aceite**:
- Nota < 1 ou > 5 → rejeição HTTP 400
- Nota ausente → rejeição HTTP 400
- Permitir notas decimais (ex: 4.5)
- Mensagem: "Nota deve estar entre 1 e 5"

---

### RN-RF022-011 — Cálculo automático de nota geral

**Descrição**: Nota geral do fornecedor é calculada automaticamente como média ponderada das avaliações individuais.

**Critério de Aceite**:
- Fórmula: (qualidade * 0.4) + (prazo * 0.3) + (atendimento * 0.2) + (preço * 0.1)
- Nota geral recalculada a cada nova avaliação
- Arredondamento para 2 casas decimais

---

### RN-RF022-012 — Atualização automática de nota do fornecedor

**Descrição**: Ao criar avaliação, atualizar campo nota_geral do fornecedor com a média das últimas 12 avaliações.

**Critério de Aceite**:
- Considerar apenas últimas 12 avaliações (mais recentes)
- Se menos de 12 avaliações, calcular média das existentes
- Atualização executada dentro da mesma transação da avaliação

---

### RN-RF022-013 — Validação de documentos vencidos

**Descrição**: Alertar se documentos obrigatórios (certificados, certidões) estão vencidos ou próximos do vencimento (30 dias).

**Critério de Aceite**:
- Job noturno verifica vencimentos
- Alerta gerado se data_vencimento <= (data_hoje + 30 dias)
- Notificação enviada ao responsável pelo fornecedor
- Badge de alerta exibido na listagem de fornecedores

---

### RN-RF022-014 — Isolamento por tenant (multi-tenancy)

**Descrição**: Todas as consultas devem filtrar por tenant_id (conglomerado) do usuário autenticado.

**Critério de Aceite**:
- Usuário do tenant A não pode acessar fornecedores do tenant B
- Tentativa de acesso cruzado → HTTP 404 (não HTTP 403 para não vazar existência)
- Filtro aplicado automaticamente em todas as queries

---

### RN-RF022-015 — Auditoria completa

**Descrição**: Todas as operações (CREATE, UPDATE, DELETE) devem registrar histórico em tabela de auditoria.

**Critério de Aceite**:
- Registrar: quem (usuário), quando (timestamp), o que (operação), quais campos mudaram
- Retenção mínima: 7 anos (compliance fiscal)
- Tabela de auditoria: Fornecedor_Historico

---

### RN-RF022-016 — Limite de crédito válido

**Descrição**: Se informado, limite de crédito deve ser maior que zero.

**Critério de Aceite**:
- Limite < 0 → rejeição HTTP 400
- Limite = 0 → aceitar (significa sem limite definido)
- Campo opcional

---

### RN-RF022-017 — Telefone obrigatório para contato

**Descrição**: Todo contato de fornecedor deve ter ao menos um telefone (fixo ou celular).

**Critério de Aceite**:
- Contato sem telefone fixo e sem celular → rejeição HTTP 400
- Mensagem: "Contato deve ter ao menos um telefone"

---

### RN-RF022-018 — Validação de tipo de contato

**Descrição**: Tipo de contato deve ser um dos valores permitidos: COMERCIAL, TECNICO, FINANCEIRO, JURIDICO.

**Critério de Aceite**:
- Tipo ausente ou fora da lista → rejeição HTTP 400
- Mensagem: "Tipo de contato inválido"

---

### RN-RF022-019 — Comentário obrigatório em avaliação negativa

**Descrição**: Se nota geral < 3, comentário é obrigatório para justificar.

**Critério de Aceite**:
- Avaliação com nota < 3 e sem comentário → rejeição HTTP 400
- Comentário deve ter no mínimo 20 caracteres
- Mensagem: "Avaliação negativa requer comentário justificativo"

---

### RN-RF022-020 — Busca por nome parcial

**Descrição**: Busca de fornecedor por nome deve aceitar match parcial (LIKE).

**Critério de Aceite**:
- Busca "Dell" → retornar "Dell Computadores Ltda", "Dell Brasil"
- Busca case-insensitive
- Mínimo 3 caracteres para executar busca

---

## 6. ESTADOS DO FORNECEDOR

| Estado | Descrição |
|------|-----------|
| **ATIVO** | Fornecedor ativo e disponível para uso |
| **INATIVO** | Fornecedor inativo, não disponível para novos contratos |
| **EM_HOMOLOGACAO** | Fornecedor em processo de homologação |
| **BLOQUEADO** | Fornecedor bloqueado por compliance/inadimplência |

### Transições permitidas

| De | Para | Condição |
|---|---|---|
| EM_HOMOLOGACAO | ATIVO | Aprovação em checklist de homologação |
| ATIVO | INATIVO | Sem contratos ativos |
| ATIVO | BLOQUEADO | Decisão gerencial ou compliance |
| INATIVO | ATIVO | Reativação manual |
| BLOQUEADO | ATIVO | Resolução de pendências |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre | Payload mínimo |
|------|--------------|----------------|
| `fornecedor.criado` | Após criação bem-sucedida | { fornecedorId, cnpj, nome, tipo } |
| `fornecedor.atualizado` | Após atualização | { fornecedor Id, campos_alterados[] } |
| `fornecedor.inativado` | Após inativação | { fornecedorId, motivo } |
| `fornecedor.avaliado` | Após registro de avaliação | { fornecedorId, nota_geral, avaliadorId } |
| `fornecedor.bloqueado` | Ao bloquear fornecedor | { fornecedorId, motivo, bloqueadoPor } |
| `documento.vencendo` | Documento próximo ao vencimento | { fornecedorId, tipoDocumento, diasRestantes } |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant
- Nenhuma regra de negócio pode ser ignorada
- Erros devem retornar HTTP status code apropriado (400, 404, 409, 422)
- Mensagens de erro devem ser claras e acionáveis
- Auditoria deve registrar quem, quando e o que mudou
- Todas as validações devem executar no backend (não confiar apenas no frontend)
- Dados sensíveis (dados bancários) devem ser criptografados em repouso
- Respostas de API devem respeitar formato padrão de erro/sucesso

---

## 9. SEGURANÇA

### 9.1 Validações obrigatórias

- Validação de entrada para prevenir SQL Injection
- Validação de entrada para prevenir XSS
- Sanitização de campos de texto livre (comentários, observações)
- Validação de arquivos upload (tipo, tamanho, conteúdo)

### 9.2 Controle de acesso

- Autenticação obrigatória para todas as operações
- Autorização baseada em permissões RBAC
- Isolamento multi-tenant rigoroso
- Auditoria de todas as operações de escrita

### 9.3 Permissões RBAC

| Operação | Permissão | Perfis autorizados |
|----------|-----------|---------------------|
| Listar fornecedores | `fornecedor.read` | Todos os usuários autenticados |
| Consultar fornecedor | `fornecedor.read` | Todos os usuários autenticados |
| Criar fornecedor | `fornecedor.create` | Admin, Gestor, Comprador |
| Editar fornecedor | `fornecedor.update` | Admin, Gestor, Comprador |
| Inativar fornecedor | `fornecedor.delete` | Admin, Gestor |
| Avaliar fornecedor | `fornecedor.rate` | Admin, Gestor, Supervisor |
| Gerenciar documentos | `fornecedor.docs.manage` | Admin, Gestor, Comprador |
| Visualizar dados bancários | `fornecedor.banking.read` | Admin, Financeiro |

---

## 10. INTEGRAÇÕES OBRIGATÓRIAS

### 10.1 i18n (Internacionalização)

- Todas as mensagens de erro devem ser traduzíveis
- Idiomas obrigatórios: pt-BR, en, es
- Chaves de tradução: namespace `fornecedores.*`
- Fallback: pt-BR → en → es

### 10.2 Auditoria

- Tabela: `Fornecedor_Historico`
- Operações auditadas: CREATE, UPDATE, DELETE, RATE, BLOCK
- Retenção: 7 anos (compliance fiscal)
- Campos obrigatórios: usuario_id, timestamp, operacao, payload_antes, payload_depois

### 10.3 Central de Funcionalidades

- Feature Key: `FNC-CAD-012`
- Nome: "Gestão de Fornecedores"
- Descrição: "Cadastro, avaliação e gestão completa de fornecedores"
- Habilitado por padrão: true
- Tipo: Funcionalidade de negócio (não sistema)

### 10.4 Notificações

- Alerta de documentos vencendo (30 dias antes)
- Notificação de avaliação negativa (nota < 3)
- Alerta de fornecedor bloqueado
- Canais: e-mail, notificação in-app

---

## 11. API ENDPOINTS (CONTRATO PÚBLICO)

| Método | Endpoint | Descrição | Permissão | Request | Response |
|--------|----------|-----------|-----------|---------|----------|
| GET | `/api/v1/fornecedores` | Listar fornecedores | `fornecedor.read` | Query: page, pageSize, tipo, status | Paginated<FornecedorDto> |
| GET | `/api/v1/fornecedores/{id}` | Obter fornecedor por ID | `fornecedor.read` | Path: id (Guid) | FornecedorDto |
| GET | `/api/v1/fornecedores/buscar-cnpj/{cnpj}` | Buscar por CNPJ | `fornecedor.read` | Path: cnpj (string) | FornecedorDto ou 404 |
| POST | `/api/v1/fornecedores` | Criar fornecedor | `fornecedor.create` | CreateFornecedorCommand | Guid (ID do fornecedor) |
| PUT | `/api/v1/fornecedores/{id}` | Atualizar fornecedor | `fornecedor.update` | UpdateFornecedorCommand | void (204) |
| DELETE | `/api/v1/fornecedores/{id}` | Inativar fornecedor | `fornecedor.delete` | Path: id (Guid) | void (204) |
| POST | `/api/v1/fornecedores/{id}/contatos` | Adicionar contato | `fornecedor.update` | CreateContatoCommand | Guid (ID do contato) |
| PUT | `/api/v1/fornecedores/{id}/contatos/{contatoId}` | Atualizar contato | `fornecedor.update` | UpdateContatoCommand | void (204) |
| DELETE | `/api/v1/fornecedores/{id}/contatos/{contatoId}` | Remover contato | `fornecedor.update` | Path params | void (204) |
| POST | `/api/v1/fornecedores/{id}/avaliacoes` | Avaliar fornecedor | `fornecedor.rate` | CreateAvaliacaoCommand | Guid (ID da avaliação) |
| GET | `/api/v1/fornecedores/{id}/avaliacoes` | Listar avaliações | `fornecedor.read` | Path: id, Query: page | Paginated<AvaliacaoDto> |
| POST | `/api/v1/fornecedores/validar-cnpj` | Validar CNPJ | `fornecedor.read` | { cnpj: string } | { valido: bool, mensagem: string } |
| GET | `/api/v1/fornecedores/search` | Buscar por nome/CNPJ | `fornecedor.read` | Query: q (string), limit | FornecedorDto[] |

### Códigos HTTP retornados

| Código | Quando |
|--------|--------|
| 200 OK | Consulta/listagem bem-sucedida |
| 201 Created | Criação bem-sucedida |
| 204 No Content | Atualização/exclusão bem-sucedida |
| 400 Bad Request | Validação de entrada falhou |
| 401 Unauthorized | Não autenticado |
| 403 Forbidden | Sem permissão |
| 404 Not Found | Recurso não encontrado ou isolamento multi-tenant |
| 409 Conflict | Conflito (CNPJ duplicado, fornecedor com contratos ativos) |
| 422 Unprocessable Entity | Regra de negócio violada |
| 500 Internal Server Error | Erro inesperado no servidor |

---

## 12. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF022.md** - Casos de Uso detalhados
- **MD-RF022.md** - Modelo de Dados (entidades, relacionamentos)
- **WF-RF022.md** - Wireframes e fluxos de tela
- **TC-RF022.yaml** - Casos de Teste automatizados
- **MT-RF022.yaml** - Massas de Teste

---

## 13. RASTREABILIDADE

| Artefato | Status | Localização |
|--------|-------|-------------|
| Casos de Uso (UC) | ✅ Criado | UC-RF022.md |
| Modelo de Dados (MD) | ✅ Criado | MD-RF022.md |
| Wireframes (WF) | ✅ Criado | WF-RF022.md |
| Casos de Teste | ⏳ Pendente | TC-RF022.yaml |
| Massas de Teste | ⏳ Pendente | MT-RF022.yaml |
| Referência ao Legado (RL) | ⏳ Em criação | RL-RF022.md |

---

## 14. DEPENDÊNCIAS

### RFs Upstream (dependências)

- **RF-001** - Parametros e Configurações (tenant_id, configurações globais)
- **RF-006** - Gestão de Clientes (para definir conglomerado/tenant)
- **RF-063** - Motor de Templates (para documentos/relatórios de fornecedor)

### RFs Downstream (que dependem deste)

- **RF-CTR** - Gestão de Contratos (fornecedor é FK em contratos)
- **RF-NF** - Gestão de Notas Fiscais (fornecedor é emissor)
- **RF-PED** - Gestão de Pedidos de Compra (fornecedor é destino)

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|------|------|----------|------|
| 1.0 | 2025-11-03 | Versão inicial com 15 regras de negócio | Architect Agent |
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0 - Separação RF/RL, 20 regras de negócio, contrato moderno | Agência ALC - alc.dev.br |

---

**Última Atualização**: 2025-12-30
**Versão de Governança**: 2.0
**Status**: ✅ Contrato Funcional Moderno (SEM referências ao legado)
