# RF-016: Gest√£o de Categorias de Ativos

**Vers√£o**: 2.0
**Data**: 2025-12-30
**Autor**: Ag√™ncia ALC - alc.dev.br
**EPIC**: EPIC003-CAD - Cadastros Base
**Fase**: Fase 2 - Cadastros e Servi√ßos Transversais

---

## 1. OBJETIVO DO REQUISITO

Especificar o **Sistema de Gest√£o de Categorias** do IControlIT, respons√°vel por classificar e organizar ativos, servi√ßos de telecom, tipos de chamados e demais entidades do sistema atrav√©s de uma estrutura hier√°rquica e customiz√°vel de categorias.

Este documento serve como **contrato oficial** entre neg√≥cio, desenvolvimento, testes e agentes de IA, definindo **o que o sistema deve fazer**, sob quais condi√ß√µes e quais garantias devem ser preservadas, sem especificar detalhes de implementa√ß√£o.

---

## 2. ESCOPO

### 2.1 O que est√° dentro do escopo

- [x] Cria√ß√£o de categorias hier√°rquicas (at√© 10 n√≠veis de profundidade)
- [x] Categoriza√ß√£o por tipo: Ativos, Servi√ßos, Chamados, Contratos
- [x] Atributos customizados por categoria (campos din√¢micos)
- [x] Importa√ß√£o em massa via CSV/Excel
- [x] Valida√ß√£o de hierarquia (impedir loops e inconsist√™ncias)
- [x] Controle de taxa de deprecia√ß√£o por categoria de ativo
- [x] Templates de categoria reutiliz√°veis
- [x] Personaliza√ß√£o visual (√≠cones e cores)
- [x] Migra√ß√£o de ativos entre categorias
- [x] An√°lise de uso (relat√≥rio de categorias mais utilizadas)
- [x] Inativa√ß√£o/exclus√£o l√≥gica de categorias
- [x] Controle de acesso e isolamento por tenant (EmpresaId)
- [x] Auditoria de opera√ß√µes sobre categorias

### 2.2 Fora do escopo (n√£o objetivos)

- Interface visual espec√≠fica (definido em WF-RF016.md)
- Tecnologia, framework ou linguagem de implementa√ß√£o
- Layout, UX ou identidade visual
- Estrat√©gia de deploy ou infraestrutura
- Gest√£o de ativos em si (coberto por outros RFs)
- Integra√ß√£o com sistemas de deprecia√ß√£o cont√°bil (fora do MVP)

---

## 3. CONCEITOS E DEFINI√á√ïES

| Termo | Defini√ß√£o |
|-------|-----------|
| **Categoria** | Classifica√ß√£o hier√°rquica de entidades (ativos, servi√ßos, chamados, contratos) |
| **Hierarquia de Categoria** | Estrutura multin√≠vel (Categoria Pai ‚Üí Subcategoria ‚Üí Subcategoria Filha) com at√© 10 n√≠veis de profundidade |
| **Atributo Customizado** | Campo din√¢mico espec√≠fico de uma categoria (ex: RAM para categoria "Notebooks") |
| **Tipo de Categoria** | Classifica√ß√£o que indica a natureza da categoria: Ativo, Servi√ßo, Chamado, Contrato |
| **Template de Categoria** | Estrutura de categoria reutiliz√°vel com atributos pr√©-definidos |
| **Taxa de Deprecia√ß√£o** | Percentual anual de desvaloriza√ß√£o de ativos (aplic√°vel apenas a categorias do tipo "Ativo") |
| **Categoria de Sistema** | Categoria criada automaticamente pelo sistema, protegida contra exclus√£o (ex: "N√£o Categorizado") |
| **Tenant** | Unidade l√≥gica de isolamento de dados (EmpresaId) |
| **Heran√ßa de Atributos** | Subcategorias herdam atributos da categoria pai |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Criar categoria** - Permitir cria√ß√£o de nova categoria com valida√ß√£o de campos obrigat√≥rios
2. **Atualizar categoria existente** - Editar nome, descri√ß√£o, √≠cone, cor, taxa de deprecia√ß√£o
3. **Consultar categoria por ID** - Retornar detalhes completos de uma categoria espec√≠fica
4. **Listar categorias** - Listar categorias com filtros (tipo, ativa/inativa, pai)
5. **Excluir categoria** - Exclus√£o l√≥gica (soft delete), validando depend√™ncias
6. **Definir hierarquia** - Estabelecer rela√ß√£o pai-filho entre categorias
7. **Configurar atributos customizados** - Adicionar/remover campos espec√≠ficos por categoria
8. **Importar categorias em massa** - Carga via CSV/Excel com valida√ß√£o
9. **Criar template de categoria** - Salvar estrutura como template reutiliz√°vel
10. **Migrar entidades entre categorias** - Mover ativos/servi√ßos de uma categoria para outra
11. **Gerar relat√≥rio de uso** - Identificar categorias mais/menos utilizadas
12. **Validar hierarquia** - Impedir loops circulares e inconsist√™ncias

---

## 5. REGRAS DE NEG√ìCIO

### RN-RF016-01 ‚Äî Hierarquia m√°xima de 10 n√≠veis

**Descri√ß√£o**: A hierarquia de categorias n√£o pode ultrapassar 10 n√≠veis de profundidade.

**Justificativa**: Evitar complexidade excessiva e impacto em performance de consultas recursivas.

**Crit√©rio de Aceite**:
- Tentativa de criar categoria em n√≠vel 11 ‚Üí HTTP 400 com mensagem "Hierarquia m√°xima de 10 n√≠veis atingida"
- Sistema deve calcular n√≠vel automaticamente ao definir categoria pai

---

### RN-RF016-02 ‚Äî Valida√ß√£o de loops na hierarquia

**Descri√ß√£o**: Categoria n√£o pode ser filha de si mesma (direta ou indiretamente).

**Justificativa**: Prevenir estruturas circulares que causam loops infinitos em consultas.

**Crit√©rio de Aceite**:
- Categoria A n√£o pode ter Categoria A como pai ‚Üí HTTP 400 "Categoria n√£o pode ser filha de si mesma"
- Categoria A com filha B n√£o pode ter B como pai ‚Üí HTTP 400 "Loop hier√°rquico detectado"
- Sistema deve validar toda a √°rvore antes de salvar

---

### RN-RF016-03 ‚Äî Taxa de deprecia√ß√£o v√°lida

**Descri√ß√£o**: Taxa de deprecia√ß√£o deve estar entre 0% e 100%, aplic√°vel apenas para categorias do tipo "Ativo".

**Justificativa**: Garantir c√°lculos cont√°beis corretos e coer√™ncia de dados.

**Crit√©rio de Aceite**:
- Taxa < 0% ou > 100% ‚Üí HTTP 400 "Taxa de deprecia√ß√£o deve estar entre 0% e 100%"
- Se n√£o informada para tipo "Ativo" ‚Üí usar valor padr√£o de 20% ao ano
- Se informada para tipo diferente de "Ativo" ‚Üí HTTP 400 "Taxa de deprecia√ß√£o aplic√°vel apenas para categorias de Ativo"

---

### RN-RF016-04 ‚Äî Atributos obrigat√≥rios devem ser preenchidos

**Descri√ß√£o**: Ao criar entidade de categoria X, todos atributos marcados como obrigat√≥rios devem ser informados.

**Justificativa**: Garantir integridade e completude dos dados.

**Crit√©rio de Aceite**:
- Criar ativo sem preencher atributo obrigat√≥rio ‚Üí HTTP 400 "Campo [nome_atributo] √© obrigat√≥rio"
- Mensagem deve indicar claramente qual atributo est√° faltando

---

### RN-RF016-05 ‚Äî Valores √∫nicos devem ser √∫nicos

**Descri√ß√£o**: Atributos marcados como `Fl_Unico = true` n√£o podem ter valores duplicados dentro da mesma categoria.

**Justificativa**: Garantir unicidade de identificadores cr√≠ticos (ex: n√∫mero de s√©rie).

**Crit√©rio de Aceite**:
- Criar ativo com valor duplicado em atributo √∫nico ‚Üí HTTP 400 "Valor '[valor]' j√° existe para o campo [nome_atributo]"
- Valida√ß√£o deve ser case-insensitive
- Valida√ß√£o deve respeitar isolamento de tenant

---

### RN-RF016-06 ‚Äî Tipos de dados validados

**Descri√ß√£o**: Valores de atributos devem respeitar o tipo de dado definido (texto, n√∫mero, data, booleano, lista).

**Justificativa**: Prevenir erros de processamento e inconsist√™ncias.

**Crit√©rio de Aceite**:
- Valor n√£o num√©rico em campo num√©rico ‚Üí HTTP 400 "Campo [nome_atributo] deve ser num√©rico"
- Valor n√£o data em campo data ‚Üí HTTP 400 "Campo [nome_atributo] deve ser uma data v√°lida (YYYY-MM-DD)"
- Valor fora de lista em campo enum ‚Üí HTTP 400 "Valor inv√°lido para [nome_atributo]. Valores aceitos: [lista]"

---

### RN-RF016-07 ‚Äî Categorias de sistema n√£o podem ser exclu√≠das

**Descri√ß√£o**: Categorias com `Fl_Sistema = true` s√£o protegidas contra exclus√£o.

**Justificativa**: Prevenir quebra de funcionalidades cr√≠ticas do sistema.

**Crit√©rio de Aceite**:
- Tentativa de excluir categoria de sistema ‚Üí HTTP 400 "Categoria de sistema n√£o pode ser exclu√≠da"
- Exemplos: "N√£o Categorizado", "Categoria Padr√£o"

---

### RN-RF016-08 ‚Äî Inativa√ß√£o em cascata opcional

**Descri√ß√£o**: Ao inativar categoria pai, sistema deve perguntar se deseja inativar subcategorias.

**Justificativa**: Dar flexibilidade ao usu√°rio para decidir impacto da inativa√ß√£o.

**Crit√©rio de Aceite**:
- Inativar categoria com filhas ‚Üí perguntar "Deseja inativar todas as subcategorias? (Sim/N√£o)"
- Se "Sim" ‚Üí inativar categoria pai e todas as filhas
- Se "N√£o" ‚Üí promover filhas ao n√≠vel da categoria pai (remover v√≠nculo pai-filho)

---

### RN-RF016-09 ‚Äî Atributos herdados

**Descri√ß√£o**: Subcategorias herdam atributos da categoria pai, podem adicionar novos, mas n√£o podem remover herdados.

**Justificativa**: Manter consist√™ncia e evitar perda de dados obrigat√≥rios.

**Crit√©rio de Aceite**:
- Categoria Filha deve ter todos atributos da Categoria Pai
- Categoria Filha pode adicionar novos atributos espec√≠ficos
- Tentativa de remover atributo herdado ‚Üí HTTP 400 "Atributo [nome_atributo] √© herdado e n√£o pode ser removido"

---

### RN-RF016-10 ‚Äî Templates p√∫blicos compartilhados

**Descri√ß√£o**: Templates marcados como `Fl_Publico = true` s√£o vis√≠veis para todos os conglomerados.

**Justificativa**: Facilitar reutiliza√ß√£o de estruturas comuns (ex: Categoria de Notebooks).

**Crit√©rio de Aceite**:
- Template p√∫blico deve aparecer na listagem de todos os tenants
- Template privado (`Fl_Publico = false`) deve aparecer apenas para o tenant criador
- Usu√°rio de outro tenant N√ÉO pode editar template p√∫blico, apenas clonar

---

### RN-RF016-11 ‚Äî Isolamento multi-tenant

**Descri√ß√£o**: Um tenant s√≥ pode acessar categorias do seu pr√≥prio contexto (EmpresaId).

**Justificativa**: Garantir seguran√ßa e isolamento de dados.

**Crit√©rio de Aceite**:
- Tentativa de acesso a categoria de outro tenant ‚Üí HTTP 404 (n√£o revelar exist√™ncia)
- Todas as consultas devem incluir filtro `WHERE EmpresaId = @TenantId` automaticamente

---

## 6. ESTADOS DA ENTIDADE

| Estado | Descri√ß√£o |
|--------|-----------|
| `Ativa` | Categoria dispon√≠vel para uso |
| `Inativa` | Categoria desativada, n√£o aparece em listagens padr√£o |
| `Exclu√≠da` | Exclu√≠da logicamente (soft delete), n√£o pode ser restaurada sem interven√ß√£o t√©cnica |

### Transi√ß√µes permitidas

| De | Para | Condi√ß√£o |
|----|------|----------|
| Ativa | Inativa | Usu√°rio com permiss√£o `categorias.update` |
| Inativa | Ativa | Usu√°rio com permiss√£o `categorias.update` |
| Ativa | Exclu√≠da | Usu√°rio com permiss√£o `categorias.delete`, sem depend√™ncias ativas |
| Inativa | Exclu√≠da | Usu√°rio com permiss√£o `categorias.delete`, sem depend√™ncias ativas |

### Transi√ß√µes proibidas

| De | Para | Motivo |
|----|------|--------|
| Exclu√≠da | Ativa | Exclus√£o l√≥gica √© irrevers√≠vel via interface |
| Exclu√≠da | Inativa | Exclus√£o l√≥gica √© irrevers√≠vel via interface |

---

## 7. EVENTOS DE DOM√çNIO

| Evento | Quando ocorre | Payload |
|--------|---------------|---------|
| `categoria.criada` | Ap√≥s cria√ß√£o bem-sucedida | `{ id, nome, tipo, empresaId, usuarioId, timestamp }` |
| `categoria.atualizada` | Ap√≥s atualiza√ß√£o bem-sucedida | `{ id, camposAlterados[], usuarioId, timestamp }` |
| `categoria.inativada` | Ap√≥s inativa√ß√£o | `{ id, nome, usuarioId, timestamp }` |
| `categoria.excluida` | Ap√≥s exclus√£o l√≥gica | `{ id, nome, usuarioId, timestamp }` |
| `categoria.hierarquia_alterada` | Ap√≥s mudan√ßa de pai | `{ id, paiAntigoId, paiNovoId, usuarioId, timestamp }` |
| `categoria.template_criado` | Ap√≥s cria√ß√£o de template | `{ templateId, categoriaOrigemId, publico, usuarioId, timestamp }` |

---

## 8. CRIT√âRIOS GLOBAIS DE ACEITE

- **Isolamento multi-tenant**: Nenhuma opera√ß√£o pode violar isolamento de EmpresaId
- **Valida√ß√£o de regras**: Nenhuma regra de neg√≥cio (RN-RF016-XX) pode ser ignorada
- **Erros estruturados**: Erros devem retornar HTTP status correto + mensagem descritiva em JSON
- **Auditoria completa**: Todas as opera√ß√µes CUD (Create, Update, Delete) devem ser registradas em AuditLog
- **Performance**: Consultas de listagem devem retornar em < 1s para at√© 10.000 categorias
- **Hierarquia consistente**: Sistema deve impedir loops circulares e profundidade > 10 n√≠veis

---

## 9. SEGURAN√áA

### 9.1 Valida√ß√£o de Entrada

- Sanitiza√ß√£o de campos de texto (prevenir XSS)
- Valida√ß√£o de tipos de dados conforme RN-RF016-06
- Limite de tamanho de campos (nome: 100 chars, descri√ß√£o: 500 chars)

### 9.2 Controle de Acesso (RBAC)

| Opera√ß√£o | Permiss√£o Necess√°ria |
|----------|----------------------|
| Listar categorias | `categorias.view_any` |
| Visualizar categoria | `categorias.view` |
| Criar categoria | `categorias.create` |
| Atualizar categoria | `categorias.update` |
| Excluir categoria | `categorias.delete` |
| Criar template p√∫blico | `categorias.create_public_template` (apenas Super Admin) |

### 9.3 Isolamento Multi-Tenant

- Todas as queries devem incluir filtro `EmpresaId`
- Tentativa de acesso cross-tenant deve retornar HTTP 404 (n√£o revelar exist√™ncia)
- Row-Level Security (RLS) ativo em todas as consultas

### 9.4 Prote√ß√£o contra Ataques

- Prote√ß√£o contra SQL Injection (queries parametrizadas)
- Prote√ß√£o contra XSS (sanitiza√ß√£o de HTML)
- Rate limiting: m√°ximo 100 requisi√ß√µes/minuto por usu√°rio

---

## 10. ARTEFATOS DERIVADOS

Este RF √© base para:

| Artefato | Status | Localiza√ß√£o |
|----------|--------|-------------|
| UC-RF016.md (Casos de Uso) | ‚úÖ Criado | `./UC-RF016.md` |
| MD-RF016.md (Modelo de Dados) | ‚úÖ Criado | `./MD-RF016.md` |
| WF-RF016.md (Wireframes) | ‚úÖ Criado | `./WF-RF016.md` |
| RF016.yaml (Estruturado) | üîÑ A criar | `./RF016.yaml` |
| RL-RF016.md (Refer√™ncias ao Legado) | üîÑ A criar | `./RL-RF016.md` |
| RL-RF016.yaml (Legado Estruturado) | üîÑ A criar | `./RL-RF016.yaml` |
| TC-RF016.yaml (Casos de Teste) | ‚è∏Ô∏è Pendente | `./Testes/TC-RF016.yaml` |
| MT-RF016.yaml (Massas de Teste) | ‚è∏Ô∏è Pendente | `./Testes/MT-RF016.yaml` |

---

## 11. RASTREABILIDADE

### Depend√™ncias (RFs relacionados)

| RF | Tipo | Descri√ß√£o |
|----|------|-----------|
| RF-001 | Depend√™ncia | Configura√ß√µes Gerais (par√¢metros de sistema) |
| RF-AUD-002 | Integra√ß√£o | Auditoria de opera√ß√µes |
| RF-REF-048 | Integra√ß√£o | Internacionaliza√ß√£o (i18n) |
| RF-025 | Dependente | Gest√£o de Ativos (usa categorias) |
| RF-032 | Dependente | Gest√£o de Servi√ßos (usa categorias) |

### Casos de Uso Obrigat√≥rios

| UC | Status | Descri√ß√£o |
|----|--------|-----------|
| UC00-RF016 | ‚úÖ Criado | Vis√£o geral e navega√ß√£o |
| UC01-RF016 | ‚úÖ Criado | Criar e editar categoria |
| UC02-RF016 | ‚úÖ Criado | Gerenciar hierarquia |
| UC03-RF016 | ‚úÖ Criado | Configurar atributos customizados |
| UC04-RF016 | ‚úÖ Criado | Importar categorias em massa |

### Endpoints API (a implementar)

| Endpoint | M√©todo | Descri√ß√£o |
|----------|--------|-----------|
| `/api/categorias` | GET | Listar categorias |
| `/api/categorias/{id}` | GET | Obter categoria por ID |
| `/api/categorias` | POST | Criar categoria |
| `/api/categorias/{id}` | PUT | Atualizar categoria |
| `/api/categorias/{id}` | DELETE | Excluir categoria (soft delete) |
| `/api/categorias/{id}/hierarquia` | PUT | Alterar categoria pai |
| `/api/categorias/{id}/atributos` | POST | Adicionar atributo customizado |
| `/api/categorias/templates` | GET | Listar templates |
| `/api/categorias/templates` | POST | Criar template |
| `/api/categorias/importar` | POST | Importar em massa (CSV/Excel) |
| `/api/categorias/relatorio-uso` | GET | Relat√≥rio de uso de categorias |

---

## CHANGELOG

| Vers√£o | Data | Descri√ß√£o | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-30 | Migra√ß√£o para v2.0: separa√ß√£o RF/RL, 11 se√ß√µes obrigat√≥rias, remo√ß√£o de conte√∫do de outros RFs | Ag√™ncia ALC - alc.dev.br |
| 1.0 | 2025-11-03 | Vers√£o inicial estrutura simplificada (5 se√ß√µes) | Ag√™ncia ALC - alc.dev.br |
