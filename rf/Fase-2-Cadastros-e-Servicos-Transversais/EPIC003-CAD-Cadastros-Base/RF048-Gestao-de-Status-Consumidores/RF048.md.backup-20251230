# RF048 - Gestão de Status Consumidores

**Versão:** 1.0
**Data:** 2025-12-18
**Status:** Rascunho
**Autor:** IControlIT Architect Agent

---

## 1. Resumo Executivo

A Gestão de Status Consumidores é uma funcionalidade estratégica do IControlIT v2 que permite gerenciar o ciclo de vida completo dos status de consumidores (colaboradores, departamentos, dispositivos) através de estados bem definidos e transições controladas. O sistema oferece controle granular sobre ativação, inativação, bloqueio e suspensão de consumidores, com workflow de transições, regras de negócio automáticas, histórico completo e integração com processos de auditoria, faturamento e controle de acessos.

Este RF implementa um motor de workflow de status que garante conformidade regulatória (LGPD, SOX, ISO 27001), rastreabilidade completa de mudanças de status, notificações automáticas para stakeholders, aplicação automática de políticas conforme status, e relatórios gerenciais de ciclo de vida. A funcionalidade é essencial para garantir que apenas consumidores autorizados tenham acesso a recursos, que custos sejam corretamente alocados conforme status operacional, e que exista auditoria completa de todas as transições de status.

O sistema oferece interface moderna em Angular 19 com indicadores visuais de status, timeline de histórico de transições, aprovação multi-nível para operações críticas, e integração completa com RFs de Auditoria (RF034, RF035), Faturamento (RF026, RF030), Permissões (RF006), Consumidores (RF052) e Políticas (RF049).

### 1.1 Objetivo

Implementar sistema completo de gestão de status de consumidores com:
- Estados bem definidos: Ativo, Inativo, Bloqueado, Suspenso, Pendente
- Workflow de transições controladas com regras de negócio
- Histórico completo de mudanças de status (7 anos para LGPD)
- Aplicação automática de políticas conforme status
- Notificações automáticas para stakeholders
- Integração com processos de faturamento e auditoria
- Relatórios gerenciais de ciclo de vida

### 1.2 Escopo

**Incluído:**
- CRUD completo de configurações de status
- Motor de workflow de transições de status
- Validações de transições permitidas/negadas
- Histórico de mudanças com rastreabilidade completa
- Aplicação automática de políticas por status
- Notificações automáticas multi-canal
- Processamento em lote de mudanças de status
- Integração com consumidores, políticas, faturamento
- Dashboard de status com indicadores visuais
- Relatórios de ciclo de vida e transições
- API REST completa com permissões RBAC
- Interface Angular 19 com timeline de histórico
- Auditoria completa de todas as operações
- Suporte multi-tenant com isolamento de dados

**Excluído:**
- Gerenciamento de usuários/perfis (RF006)
- Gerenciamento de permissões (RF006)
- Gerenciamento de políticas de uso (RF049)
- Gerenciamento de consumidores (RF052)
- Faturamento detalhado (RF026)
- Auditoria de bilhetes (RF034, RF035)
- Gestão de contratos (RF023)
- Inventário de ativos (RF025)

---

## 2. Regras de Negócio

### RN01 - Estados de Status Obrigatórios

- **Descrição:** Sistema deve implementar estados de status padrão e permitir customização
- **Regra:** Estados obrigatórios: Ativo, Inativo, Bloqueado, Suspenso, Pendente. Estados podem ter configurações específicas de permissões, limites e restrições
- **Validação:** Sistema não permite desativar status obrigatórios, apenas customizar comportamento
- **Exceção:** Estados customizados adicionais podem ser criados conforme necessidade do negócio

### RN02 - Workflow de Transições Controladas

- **Descrição:** Nem todas as transições de status são permitidas diretamente
- **Regra:** Transições devem seguir matriz de workflow: Pendente→Ativo, Ativo→Inativo/Bloqueado/Suspenso, Suspenso→Ativo, Bloqueado→Ativo (requer aprovação), Inativo→Ativo (requer aprovação). Transições não permitidas devem ser negadas com mensagem explicativa
- **Validação:** Sistema valida matriz de transições antes de aplicar mudança de status
- **Exceção:** Perfis "Super Admin" podem forçar qualquer transição com justificativa obrigatória

### RN03 - Aprovação Multi-Nível para Transições Críticas

- **Descrição:** Transições críticas requerem aprovação de múltiplos níveis gerenciais
- **Regra:** Reativação de Bloqueado/Inativo→Ativo requer aprovação de Gestor + Financeiro. Bloqueio requer aprovação de Gestor. Suspensão pode ser automática (por política) ou manual
- **Validação:** Sistema cria solicitação de aprovação e aguarda aprovadores antes de aplicar transição
- **Exceção:** Em situações emergenciais, Super Admin pode aprovar imediatamente com justificativa

### RN04 - Histórico Completo de Transições (LGPD)

- **Descrição:** Todas as mudanças de status devem ser registradas para auditoria e conformidade
- **Regra:** Sistema registra: Data/Hora, Usuário Responsável, Status Anterior, Status Novo, Justificativa, IP Origem, Aprovadores (se aplicável). Retenção de 7 anos conforme LGPD. Dados não podem ser alterados, apenas visualizados
- **Validação:** Cada mudança de status gera registro imutável na tabela StatusConsumidorHistorico
- **Exceção:** Nenhuma. Histórico é obrigatório para conformidade regulatória

### RN05 - Aplicação Automática de Políticas por Status

- **Descrição:** Cada status tem conjunto de políticas que são aplicadas automaticamente
- **Regra:** Ativo: Todas as políticas normais aplicadas. Suspenso: Bloqueio de novas operações, mantém acesso consulta. Bloqueado: Bloqueio total de operações e acesso. Inativo: Sem acesso, sem faturamento. Pendente: Acesso limitado, sem faturamento
- **Validação:** Sistema aplica/remove políticas automaticamente ao mudar status
- **Exceção:** Políticas customizadas podem ser configuradas por fornecedor/departamento

### RN06 - Notificações Automáticas de Mudança de Status

- **Descrição:** Stakeholders devem ser notificados automaticamente sobre mudanças de status relevantes
- **Regra:** Notificar: Consumidor afetado (se aplicável), Gestor responsável, Financeiro (para Bloqueado/Inativo), TI (para bloqueios técnicos). Canais: E-mail, SMS (crítico), Notificação in-app. Conteúdo: Status anterior/novo, Motivo, Impactos, Próximas ações
- **Validação:** Sistema envia notificações assíncronas via Central de E-mails (RF067)
- **Exceção:** Notificações podem ser desabilitadas para operações em lote (com confirmação)

### RN07 - Processamento em Lote de Mudanças de Status

- **Descrição:** Permitir mudança de status de múltiplos consumidores simultaneamente
- **Regra:** Operação em lote deve: Validar transição permitida para cada consumidor, Processar de forma assíncrona (job em background), Gerar relatório consolidado de sucesso/falha, Permitir rollback em caso de falha crítica, Respeitar limite máximo de 1000 registros por lote
- **Validação:** Sistema processa via Hangfire, gerando relatório detalhado ao final
- **Exceção:** Lotes com mais de 1000 registros devem ser divididos em múltiplos jobs

### RN08 - Cálculo Automático de Métricas de Ciclo de Vida

- **Descrição:** Sistema deve calcular automaticamente métricas de tempo em cada status
- **Regra:** Métricas calculadas: Tempo Total Ativo, Tempo Total Inativo, Tempo Total Bloqueado, Tempo Médio Entre Mudanças, Número Total de Transições, Taxa de Reativação (%). Cálculo: Soma de períodos em cada status baseado no histórico
- **Validação:** Métricas são recalculadas automaticamente a cada mudança de status
- **Exceção:** Métricas históricas (>1 ano) podem ser calculadas sob demanda via job noturno

### RN09 - Bloqueio Automático por Inadimplência

- **Descrição:** Consumidores com faturas vencidas devem ser bloqueados automaticamente
- **Regra:** Job diário verifica faturas vencidas >30 dias. Se encontrado: Notifica Gestor (30 dias), Suspende consumidor (45 dias), Bloqueia consumidor (60 dias). Desbloqueio automático ao regularizar pagamento
- **Validação:** Job executa diariamente às 02:00 AM, gerando relatório de bloqueios
- **Exceção:** Consumidores VIP ou com acordo especial podem ter prazos customizados

### RN10 - Reativação Automática Pós-Regularização

- **Descrição:** Consumidores devem ser reativados automaticamente ao regularizar pendências
- **Regra:** Ao regularizar débito: Sistema verifica se motivo de bloqueio foi resolvido, Se SIM: Cria solicitação de reativação automática, Notifica aprovadores, Reativa após aprovação (ou automaticamente se configurado)
- **Validação:** Sistema monitora eventos de pagamento (via integração RF026)
- **Exceção:** Bloqueios por outros motivos (fraude, segurança) não são reativados automaticamente

### RN11 - Integração com Faturamento (Suspensão de Cobrança)

- **Descrição:** Status deve controlar se consumidor é faturado ou não
- **Regra:** Status com faturamento: Ativo, Suspenso (parcial). Status sem faturamento: Inativo, Bloqueado, Pendente. Sistema notifica módulo de faturamento (RF026) sobre mudanças de status
- **Validação:** Mudança de status gera evento para módulo de faturamento ajustar próxima cobrança
- **Exceção:** Faturamento de períodos já processados não é afetado retroativamente

### RN12 - Dashboard de Status com Indicadores Visuais

- **Descrição:** Interface deve exibir visualmente status de consumidores em tempo real
- **Regra:** Dashboard exibe: Total de consumidores por status (cards coloridos), Gráfico de evolução temporal de status, Lista de consumidores com status crítico (Bloqueado, Suspenso), Timeline de últimas transições. Cores padrão: Verde (Ativo), Amarelo (Suspenso), Vermelho (Bloqueado), Cinza (Inativo), Azul (Pendente)
- **Validação:** Dashboard atualiza em tempo real via SignalR
- **Exceção:** Dados históricos (>3 meses) carregam sob demanda para performance

### RN13 - Auditoria de Todas as Operações de Status

- **Descrição:** Todas as operações sobre status devem ser auditadas
- **Regra:** Operações auditadas: Mudança de status, Visualização de histórico, Aprovação/Rejeição de solicitações, Processamento de lotes. Dados: Usuário, Data/Hora, Ação, Dados antes/depois, IP, Justificativa
- **Validação:** Auditoria via AuditInterceptor automático do EF Core
- **Exceção:** Operações de leitura simples (listagem) não geram auditoria detalhada

### RN14 - Multi-Tenancy com Isolamento de Status

- **Descrição:** Status de consumidores devem ser isolados por fornecedor (tenant)
- **Regra:** Cada fornecedor tem configurações próprias de status, Histórico de transições isolado por Id_Fornecedor, Relatórios filtrados automaticamente pelo fornecedor do usuário logado
- **Validação:** Entity Framework filtra automaticamente por Id_Fornecedor via Query Filter
- **Exceção:** Usuários "Super Admin" podem visualizar status cross-tenant para auditoria

### RN15 - Validação de Permissões RBAC

- **Descrição:** Operações sobre status devem respeitar permissões por perfil
- **Regra:** Permissões: GESTAO.STATUS_CONSUMIDORES.VIEW (visualizar), GESTAO.STATUS_CONSUMIDORES.CHANGE (mudar status), GESTAO.STATUS_CONSUMIDORES.APPROVE (aprovar mudanças), GESTAO.STATUS_CONSUMIDORES.ADMIN (gerenciar configurações)
- **Validação:** Endpoints validam permissões via RequireAuthorization, Commands validam via Authorize(Roles)
- **Exceção:** Nenhuma. Permissões são obrigatórias para segurança

---

## 3. Referências Técnicas

### 3.1 Componentes Relacionados

| Componente | Descrição | Localização |
|------------|-----------|-------------|
| StatusConsumidor (Entity) | Entidade de domínio para status | `backend/Domain/Entities/Gestao/StatusConsumidor.cs` |
| StatusConsumidorHistorico (Entity) | Histórico de mudanças de status | `backend/Domain/Entities/Gestao/StatusConsumidorHistorico.cs` |
| ConfiguracaoStatus (Entity) | Configurações de status por tipo | `backend/Domain/Entities/Gestao/ConfiguracaoStatus.cs` |
| ChangeStatusConsumidorCommand | Command para mudar status | `backend/Application/Gestao/Commands/StatusConsumidores/ChangeStatusConsumidorCommand.cs` |
| ApproveStatusChangeCommand | Command para aprovar mudança | `backend/Application/Gestao/Commands/StatusConsumidores/ApproveStatusChangeCommand.cs` |
| ProcessBatchStatusChangeCommand | Command para processamento em lote | `backend/Application/Gestao/Commands/StatusConsumidores/ProcessBatchStatusChangeCommand.cs` |
| GetStatusConsumidoresQuery | Query para listar status | `backend/Application/Gestao/Queries/StatusConsumidores/GetStatusConsumidoresQuery.cs` |
| GetStatusHistoricoQuery | Query para histórico | `backend/Application/Gestao/Queries/StatusConsumidores/GetStatusHistoricoQuery.cs` |
| StatusConsumidorService | Lógica de negócio de status | `backend/Infrastructure/Services/Gestao/StatusConsumidorService.cs` |
| StatusWorkflowEngine | Motor de workflow de transições | `backend/Infrastructure/Services/Gestao/StatusWorkflowEngine.cs` |
| StatusConsumidoresEndpoints | Endpoints da API | `backend/Web/Endpoints/Gestao/StatusConsumidores.cs` |
| StatusConsumidoresComponent | Componente Angular principal | `frontend/src/app/modules/gestao/status-consumidores/status-consumidores.component.ts` |
| StatusTimelineComponent | Timeline de histórico | `frontend/src/app/modules/gestao/status-consumidores/components/status-timeline.component.ts` |
| StatusDashboardComponent | Dashboard de status | `frontend/src/app/modules/gestao/status-consumidores/components/status-dashboard.component.ts` |

### 3.2 APIs Utilizadas

| API | Método | Endpoint | Descrição |
|-----|--------|----------|-----------|
| Listar Status | GET | /api/gestao/status-consumidores | Lista status de consumidores com filtros |
| Obter Status | GET | /api/gestao/status-consumidores/{id} | Obtém detalhes de um status específico |
| Criar Status | POST | /api/gestao/status-consumidores | Cria novo registro de status |
| Mudar Status | PUT | /api/gestao/status-consumidores/{id}/change | Muda status de um consumidor |
| Aprovar Mudança | PUT | /api/gestao/status-consumidores/{id}/approve | Aprova mudança de status pendente |
| Rejeitar Mudança | PUT | /api/gestao/status-consumidores/{id}/reject | Rejeita mudança de status pendente |
| Obter Histórico | GET | /api/gestao/status-consumidores/{id}/historico | Obtém histórico de mudanças |
| Processamento Lote | POST | /api/gestao/status-consumidores/batch | Processa mudanças em lote |
| Dashboard | GET | /api/gestao/status-consumidores/dashboard | Obtém dados do dashboard |
| Relatório Ciclo de Vida | GET | /api/gestao/status-consumidores/relatorio-ciclo-vida | Gera relatório de ciclo de vida |
| Configurações Status | GET | /api/gestao/status-consumidores/configuracoes | Obtém configurações de status |
| Atualizar Configuração | PUT | /api/gestao/status-consumidores/configuracoes/{id} | Atualiza configuração de status |

### 3.3 Serviços Externos

- **Central de E-mails (RF067):** Envio de notificações de mudança de status
- **Central de Notificações (RF066):** Notificações in-app e push
- **Serviço de Auditoria (RF003):** Registro de todas as operações
- **Serviço de Faturamento (RF026):** Integração para suspensão/reativação de cobrança
- **Serviço de Políticas (RF049):** Aplicação automática de políticas por status
- **Hangfire:** Processamento assíncrono de lotes e jobs noturnos
- **SignalR:** Atualizações em tempo real do dashboard

---

## 4. Dependências

### 4.1 Dependências de Outros RFs

| RF | Nome | Tipo de Dependência |
|----|------|---------------------|
| RF003 | Logs, Monitoramento e Observabilidade | Obrigatória (auditoria) |
| RF006 | Gestão de Usuários | Obrigatória (permissões) |
| RF026 | Gestão de Faturas | Obrigatória (integração faturamento) |
| RF030 | Gestão de Parâmetros de Faturamento | Obrigatória (configurações) |
| RF034 | Gestão de Itens de Auditoria | Opcional (auditoria avançada) |
| RF035 | Gestão de Resumos de Auditoria | Opcional (auditoria avançada) |
| RF049 | Gestão de Políticas de Consumidores | Obrigatória (aplicação automática) |
| RF052 | Gestão de Consumidores | Obrigatória (entidade principal) |
| RF066 | Notificações e Alertas | Obrigatória (notificações) |
| RF067 | Central de E-mails | Obrigatória (notificações e-mail) |

### 4.2 Dependências Externas

- **Entity Framework Core 10:** ORM para persistência
- **MediatR 12.x:** Implementação de CQRS
- **FluentValidation 11.x:** Validação de commands
- **Hangfire 1.8.x:** Jobs em background
- **SignalR:** Comunicação em tempo real
- **Angular 19:** Framework frontend
- **Angular Material 19:** Componentes UI
- **ApexCharts:** Gráficos do dashboard
- **Transloco 6.x:** Internacionalização

---

## 5. Requisitos Não-Funcionais

### 5.1 Performance

- **Tempo de resposta:** Mudança de status individual ≤ 300ms (P95)
- **Throughput:** Suportar até 10.000 mudanças de status/dia
- **Processamento em lote:** Processar até 1.000 registros em ≤ 5 minutos
- **Dashboard:** Carregar dashboard completo em ≤ 2 segundos
- **Histórico:** Consultar histórico de 7 anos em ≤ 1 segundo
- **Caching:** Cache de configurações de status por 5 minutos
- **Índices:** Índices em Id_Fornecedor, Status, DataMudanca para queries otimizadas

### 5.2 Segurança

- **Autenticação:** JWT Bearer Token obrigatório
- **Autorização:** RBAC com permissões granulares (VIEW, CHANGE, APPROVE, ADMIN)
- **Auditoria:** Registro de todas as operações (CREATE, READ, UPDATE, DELETE)
- **Multi-tenancy:** Isolamento por Id_Fornecedor via Query Filter
- **Criptografia:** Dados sensíveis em repouso (AES-256) e em trânsito (TLS 1.3)
- **Rate Limiting:** Máximo 100 requests/minuto por usuário
- **Validação:** Input validation em todos os endpoints

### 5.3 Disponibilidade

- **Uptime:** 99.9% (tempo de inatividade máximo: 8h45min/ano)
- **Backup:** Backup diário com retenção de 30 dias
- **Retenção de dados:** 7 anos para histórico de mudanças (LGPD)
- **Disaster Recovery:** RPO ≤ 1 hora, RTO ≤ 4 horas
- **Monitoramento:** Alertas para falhas em mudanças críticas de status
- **Jobs:** Monitoramento de jobs noturnos via Hangfire Dashboard

---

## 6. Critérios de Aceitação

- [ ] CRUD completo de status consumidores funcionando via API REST
- [ ] Workflow de transições implementado com validação de matriz de transições
- [ ] Histórico de mudanças armazenado com retenção de 7 anos
- [ ] Aplicação automática de políticas ao mudar status
- [ ] Notificações automáticas enviadas via e-mail e in-app
- [ ] Processamento em lote de até 1.000 registros funcionando
- [ ] Dashboard de status atualizando em tempo real via SignalR
- [ ] Aprovação multi-nível para transições críticas implementada
- [ ] Integração com faturamento para suspensão/reativação de cobrança
- [ ] Job noturno de bloqueio por inadimplência executando corretamente
- [ ] Relatórios de ciclo de vida e transições disponíveis
- [ ] Interface Angular 19 com timeline de histórico visual
- [ ] Auditoria completa de todas as operações funcionando
- [ ] Permissões RBAC validadas em todos os endpoints
- [ ] Multi-tenancy com isolamento de dados por fornecedor
- [ ] Todos os cenários de teste (CN-RF048) passando
- [ ] Todos os casos de teste (TC-RF048) executados com sucesso
- [ ] Cobertura de testes ≥ 80%
- [ ] Performance atendendo requisitos (≤300ms P95)
- [ ] Documentação técnica completa (Swagger + README)
- [ ] Logs estruturados e monitoramento configurados

---

## 7. Observações

### 7.1 Considerações de Implementação

**Backend:**
- Usar Entity Framework Interceptors para auditoria automática
- Implementar Query Filters para multi-tenancy transparente
- StatusWorkflowEngine deve validar matriz de transições antes de aplicar
- Jobs Hangfire para processamento assíncrono de lotes e bloqueios
- Usar Domain Events para notificações assíncronas
- Caching de configurações de status para performance

**Frontend:**
- Componentes standalone Angular 19
- Timeline visual de histórico usando Angular Material Stepper
- Dashboard com gráficos ApexCharts
- Indicadores de status com cores semânticas (Material Design)
- Atualização em tempo real via SignalR
- Formulário de mudança de status com validação de transições permitidas

### 7.2 Integrações Críticas

- **RF049 (Políticas):** Aplicação automática de políticas ao mudar status
- **RF052 (Consumidores):** Relacionamento 1:1 entre consumidor e status atual
- **RF026 (Faturamento):** Suspensão/reativação de cobrança conforme status
- **RF066/RF067 (Notificações):** Notificações multi-canal de mudanças de status

### 7.3 Migração de Dados

O sistema legado não possui controle estruturado de status de consumidores. A migração deve:
1. Criar status inicial "Ativo" para todos os consumidores ativos no legado
2. Criar status "Inativo" para consumidores desativados no legado
3. Não há histórico de mudanças para migrar (iniciar do zero)
4. Configurar políticas padrão para cada status

### 7.4 Roadmap Futuro

- **Fase 2:** Machine Learning para prever bloqueios por inadimplência
- **Fase 3:** Integração com sistemas externos de CRM para sincronização de status
- **Fase 4:** Workflow customizável por fornecedor (low-code)
- **Fase 5:** Status hierárquicos (cascata de departamento para consumidores)

---

## Histórico de Alterações

| Versão | Data | Autor | Descrição |
|--------|------|-------|-----------|
| 1.0 | 2025-12-18 | IControlIT Architect Agent | Versão inicial - Especificação completa de Gestão de Status Consumidores |
