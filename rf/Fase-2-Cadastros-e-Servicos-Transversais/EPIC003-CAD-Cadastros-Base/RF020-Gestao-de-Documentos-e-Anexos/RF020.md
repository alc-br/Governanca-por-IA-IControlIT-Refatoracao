# RF-020: Gestão de Documentos e Anexos

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC003-CAD - Cadastros Base
**Fase**: Fase 2 - Cadastros e Serviços Transversais

---

## 1. OBJETIVO DO REQUISITO

Implementar um **Sistema Completo de Gestão de Documentos e Anexos (DMS)** do IControlIT, responsável por armazenar, versionar, controlar acesso e rastrear o ciclo de vida completo de documentos e arquivos do sistema (contratos, notas fiscais, certificados, manuais, fotos de ativos, etc.).

Este RF serve como **contrato oficial** entre negócio, desenvolvimento e testes, definindo **o que o sistema DEVE fazer**, sob quais condições e quais garantias devem ser preservadas. Este documento **NÃO define implementação**, apenas **comportamento esperado**.

**Problema Resolvido**: Centralizar gestão documental corporativa com segurança, versionamento, OCR, compartilhamento seguro e compliance LGPD/GDPR.

**Público Afetado**: Todos os usuários do sistema que precisam anexar documentos (contratos, notas fiscais, fotos de ativos, certificados).

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Upload seguro de documentos (multipart/form-data, drag & drop)
- [x] Scan antivírus obrigatório (ClamAV/VirusTotal)
- [x] Armazenamento escalável (FileSystem, Azure Blob, AWS S3)
- [x] Versionamento automático com rollback
- [x] Controle de acesso granular (ACL por usuário/perfil/departamento)
- [x] Compartilhamento seguro via links temporários com senha
- [x] OCR automático para busca full-text
- [x] Gestão de validade com alertas automáticos
- [x] Auditoria completa de todas as operações
- [x] Visualização embutida (PDF, imagens)
- [x] Criptografia de documentos confidenciais (AES-256)
- [x] Soft delete com recuperação em 30 dias
- [x] Busca full-text avançada (nome, descrição, tags, OCR)
- [x] Metadados customizáveis via JSON
- [x] Multi-tenancy por conglomerado

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (design da UI)
- Tecnologia de armazenamento específica (pode ser FileSystem, Azure Blob ou AWS S3)
- Layout ou identidade visual
- Estratégia de deploy ou infraestrutura
- Editor de documentos (Microsoft Office Online, Google Docs)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| Documento | Arquivo digital (PDF, DOCX, imagem, etc.) armazenado no sistema |
| Entidade Relacionada | Objeto ao qual documento está vinculado (ativo, contrato, fornecedor, fatura) |
| Versão | Iteração de um documento (v1, v2, v3...) |
| Hash SHA-256 | Assinatura criptográfica para garantir integridade do arquivo |
| OCR | Optical Character Recognition - extração de texto de imagens/PDFs escaneados |
| ACL | Access Control List - lista de permissões granulares por documento |
| Soft Delete | Exclusão lógica (marcação como excluído sem deletar fisicamente) |
| Link Temporário | URL única e segura com expiração automática para compartilhamento externo |
| Conglomerado | Unidade lógica de isolamento de dados (multi-tenancy) |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Criar documento** - Upload seguro com scan antivírus e cálculo de hash
2. **Atualizar documento** - Nova versão com versionamento automático
3. **Consultar documento por ID** - Obter metadados completos
4. **Listar documentos** - Filtros por entidade relacionada, categoria, data
5. **Baixar documento** - Download com validação de integridade (hash)
6. **Visualizar documento** - Preview embutido (PDF, imagens)
7. **Compartilhar documento** - Gerar link temporário com senha opcional
8. **Excluir documento** - Soft delete com recuperação em 30 dias
9. **Buscar documentos** - Full-text search em nome, descrição, tags, OCR
10. **Processar OCR** - Extração automática de texto de PDFs escaneados
11. **Gerenciar permissões** - ACL granular por usuário/perfil/departamento
12. **Auditar operações** - Rastreamento completo de uploads, downloads, compartilhamentos
13. **Alertar vencimentos** - Notificações automáticas de documentos próximos ao vencimento
14. **Restaurar versão anterior** - Rollback para qualquer versão histórica
15. **Recuperar documento excluído** - Restauração em até 30 dias (apenas admin)

---

## 5. REGRAS DE NEGÓCIO

### RN-RF020-001 — Scan Antivírus Obrigatório

**Descrição**: TODO arquivo enviado DEVE passar por scan antivírus antes de ser armazenado.

**Justificativa**: Prevenir upload de malware que possa comprometer segurança do sistema e dados de clientes.

**Critério de Aceite**:
- Arquivo rejeitado automaticamente se malware detectado
- Tentativas de upload malicioso registradas em log de segurança
- Admin notificado em caso de ameaça detectada
- Quarentena temporária durante scan (até 30s para arquivos <50MB)

---

### RN-RF020-002 — Hash SHA-256 para Integridade

**Descrição**: Sistema DEVE calcular e armazenar hash SHA-256 de todo arquivo para garantir integridade e detectar duplicatas.

**Justificativa**: Garantir que arquivo não foi corrompido ou alterado maliciosamente após upload.

**Critério de Aceite**:
- Hash calculado imediatamente após upload bem-sucedido
- Hash armazenado em campo `Hash_SHA256` da tabela `Documento`
- Validação de integridade ao download (hash atual == hash armazenado)
- Detecção de duplicatas via hash (evitar armazenar mesmo arquivo duas vezes)
- Alerta ao usuário se integridade comprometida

---

### RN-RF020-003 — Versionamento Automático

**Descrição**: Alteração em documento existente DEVE criar automaticamente nova versão sem deletar anterior.

**Justificativa**: Rastreabilidade completa de mudanças e possibilidade de rollback.

**Critério de Aceite**:
- Campo `Versao` incrementado automaticamente (1, 2, 3...)
- Versão anterior: `Fl_Versao_Atual = 0`
- Nova versão: `Fl_Versao_Atual = 1`
- Campo `Id_Documento_Anterior` aponta para versão prévia (linked list)
- Histórico completo de versões mantido indefinidamente

---

### RN-RF020-004 — Controle de Acesso Granular (ACL)

**Descrição**: Sistema DEVE implementar controle de acesso granular por documento via ACL.

**Justificativa**: Permitir que diferentes usuários/perfis tenham permissões específicas por documento.

**Critério de Aceite**:
- Permissões definidas em `Documento_Permissao` por: usuário, perfil, departamento
- Níveis de acesso: Visualizar, Download, Editar, Excluir, Compartilhar
- **Deny sobrescreve Allow** (se houver permissão de negação, prevalece)
- Suporte a acesso temporário (Dt_Inicio_Acesso, Dt_Fim_Acesso)
- Validação de permissões antes de qualquer operação

---

### RN-RF020-005 — OCR Automático para Documentos Escaneados

**Descrição**: Documentos escaneados (PDFs de imagem, fotos) DEVEM ter OCR processado automaticamente para permitir busca full-text.

**Justificativa**: Permitir busca textual em PDFs escaneados e imagens.

**Critério de Aceite**:
- Sistema detecta se documento é escaneado (não possui texto selecionável)
- OCR processado via Tesseract (local) ou Azure Computer Vision (cloud)
- Texto extraído armazenado em campo `Texto_OCR`
- Campo `Fl_OCR_Processado = 1` marcado após conclusão
- Full-text index criado em `Texto_OCR` para busca eficiente

---

### RN-RF020-006 — Compartilhamento Seguro via Links Temporários

**Descrição**: Sistema DEVE permitir compartilhamento externo via links temporários seguros com expiração, senha e limite de acessos.

**Justificativa**: Permitir compartilhamento seguro com usuários externos sem exigir login no sistema.

**Critério de Aceite**:
- Token único aleatório gerado (GUID ou hash de 32 caracteres)
- Data de expiração obrigatória (máximo: 30 dias)
- Senha opcional para acesso ao link
- Limite de acessos opcional (ex: 5 downloads máximos)
- Cada acesso registrado em `Documento_Compartilhamento_Acesso` (IP, timestamp, user-agent)

---

### RN-RF020-007 — Alertas de Validade de Documentos

**Descrição**: Sistema DEVE enviar alertas automáticos para documentos próximos ao vencimento.

**Justificativa**: Evitar uso de documentos vencidos (certificados digitais, contratos).

**Critério de Aceite**:
- Job diário verifica documentos com `Dt_Validade` próxima (30, 15, 7, 1 dia antes)
- E-mail + notificação push enviados ao responsável pelo documento
- Admin alertado se documento crítico vencer (ex: certificado digital da empresa)
- Dashboard com documentos vencidos/próximos ao vencimento
- Interface permite renovação/substituição rápida de documento vencido

---

### RN-RF020-008 — Soft Delete com Recuperação

**Descrição**: Exclusão de documentos DEVE ser lógica (soft delete) com possibilidade de recuperação.

**Justificativa**: Prevenir perda acidental de documentos importantes.

**Critério de Aceite**:
- Marcar `Fl_Ativo = 3` (excluído) ao invés de deletar registro
- Registrar: `Dt_Exclusao`, `Id_Usuario_Exclusao`, `Motivo_Exclusao`
- Arquivo físico movido para pasta "Lixeira" (não deletado)
- Recuperação permitida em até 30 dias
- Apenas admin pode recuperar documentos excluídos
- Hard delete automático após 30 dias (job background)

---

### RN-RF020-009 — Limite de Tamanho de Upload

**Descrição**: Sistema DEVE impor limites de tamanho de arquivo conforme tipo e contexto.

**Justificativa**: Evitar uploads excessivos que possam sobrecarregar armazenamento ou rede.

**Critério de Aceite**:
- Limite padrão: 50MB por arquivo
- Imagens: 10MB (fotos de ativos, avatares)
- Vídeos: 500MB (treinamentos, demonstrações)
- Documentos: 100MB (contratos, notas fiscais)
- Rejeição de upload se exceder limite com mensagem clara ao usuário

---

### RN-RF020-010 — Tipos de Arquivo Permitidos

**Descrição**: Sistema DEVE validar extensão e MIME type para garantir que apenas arquivos seguros sejam aceitos.

**Justificativa**: Prevenir upload de executáveis maliciosos.

**Critério de Aceite**:
- **Permitidos**: PDF, DOCX, XLSX, PPTX, JPG, PNG, GIF, ZIP, CSV, TXT, XML
- **Bloqueados**: EXE, BAT, CMD, SH, SCR, VBS, JS (executáveis)
- Validar tanto extensão quanto MIME type (não confiar apenas em extensão)
- Rejeitação de uploads com MIME type suspeito
- Log de tentativas de upload de arquivos bloqueados

---

### RN-RF020-011 — Criptografia de Documentos Confidenciais

**Descrição**: Documentos marcados como confidenciais DEVEM ser criptografados em repouso (at-rest).

**Justificativa**: Proteção adicional de documentos sensíveis (contratos, dados financeiros).

**Critério de Aceite**:
- Se `Fl_Confidencial = 1`, arquivo criptografado com AES-256
- Chave de criptografia gerenciada via Azure Key Vault ou AWS KMS
- Arquivo descriptografado apenas em memória (nunca salvo descriptografado)
- Audit log detalhado de acesso a documentos confidenciais

---

### RN-RF020-012 — Auditoria Completa de Operações

**Descrição**: TODA operação em documentos DEVE ser auditada para rastreabilidade e compliance.

**Justificativa**: Conformidade com LGPD/GDPR e rastreabilidade de quem acessou documentos sensíveis.

**Critério de Aceite**:
- Operações auditadas: upload, download, view, edit, delete, share, unshare
- Registrar em `Documento_Auditoria`: operação, usuário, IP, timestamp, dados alterados (JSON)
- Incluir user-agent para identificar dispositivo/browser
- Logs retidos por 7 anos para compliance
- Relatório de auditoria exportável (Excel, PDF)

---

### RN-RF020-013 — Busca Full-Text Avançada

**Descrição**: Sistema DEVE suportar busca full-text em nome, descrição, tags e texto extraído via OCR.

**Justificativa**: Localização rápida de documentos por conteúdo, não apenas nome de arquivo.

**Critério de Aceite**:
- Full-Text Index em SQL Server ou Elasticsearch
- Buscar em: `Nm_Documento`, `Ds_Documento`, `Tags`, `Texto_OCR`
- Suportar busca parcial e com operadores booleanos (AND, OR, NOT)
- Ranking por relevância (nome > descrição > OCR)
- Highlighting de termos encontrados no resultado

---

### RN-RF020-014 — Metadados Customizáveis via JSON

**Descrição**: Sistema DEVE permitir armazenar metadados adicionais específicos por tipo de documento via JSON.

**Justificativa**: Flexibilidade para armazenar informações específicas sem alterar schema de banco.

**Critério de Aceite**:
- Campo `Metadados_JSON` armazena dados customizados
- Exemplo para contrato: `{ "numeroContrato": "CT-2025-001", "valorTotal": 150000, "vigencia": "12 meses" }`
- Validação de estrutura JSON antes de salvar
- Permitir filtros e busca por metadados customizados
- JSON Schema configurável por categoria de documento

---

### RN-RF020-015 — Multi-Tenancy por Conglomerado

**Descrição**: Todos os documentos DEVEM estar isolados por conglomerado (multi-tenancy).

**Justificativa**: Segurança e isolamento de dados entre diferentes clientes.

**Critério de Aceite**:
- Constraint obrigatória: `Id_Conglomerado` em todas as tabelas
- Queries filtram automaticamente por conglomerado do usuário logado
- Usuários não podem acessar documentos de outros conglomerados
- Compartilhamento externo (via link) respeita isolamento de conglomerado

---

## 6. ESTADOS DA ENTIDADE

| Estado | Descrição |
|--------|-----------|
| processing | Upload em andamento (scan antivírus, OCR pendente) |
| active | Documento disponível para uso |
| archived | Arquivado (read-only) |
| deleted | Excluído logicamente (soft delete) |

### Transições Permitidas

| De | Para | Condição |
|----|------|----------|
| processing | active | Scan antivírus OK + upload concluído |
| active | archived | Usuário arquiva manualmente |
| archived | active | Usuário desarquiva |
| active | deleted | Usuário exclui (soft delete) |
| deleted | active | Admin recupera (< 30 dias) |

### Transições Proibidas

| De | Para | Motivo |
|----|------|--------|
| processing | archived | Upload não concluído |
| deleted | archived | Documento excluído não pode ser arquivado |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre | Ação esperada |
|--------|---------------|----------------|
| documento.criado | Após upload bem-sucedido | Iniciar OCR (se aplicável), notificar responsável |
| documento.atualizado | Nova versão criada | Notificar usuários com permissão de visualização |
| documento.compartilhado | Link temporário gerado | Registrar auditoria, enviar e-mail com link |
| documento.vencendo | Documento próximo ao vencimento | Enviar alerta ao responsável |
| documento.excluido | Soft delete executado | Mover para lixeira, registrar auditoria |
| documento.restaurado | Recuperação de documento excluído | Mover de lixeira para storage ativo |
| ocr.processado | OCR concluído com sucesso | Atualizar campo `Texto_OCR`, marcar `Fl_OCR_Processado = 1` |
| malware.detectado | Scan antivírus identifica ameaça | Rejeitar upload, notificar admin, registrar log de segurança |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de conglomerado (multi-tenancy)
- Nenhum arquivo pode ser armazenado sem scan antivírus
- Nenhuma regra de negócio pode ser ignorada
- Erros devem ser previsíveis e rastreáveis
- Auditoria deve registrar quem, quando e o que mudou
- Permissões devem ser validadas antes de qualquer operação (ACL)
- Versionamento nunca pode ser desabilitado (histórico completo obrigatório)
- Soft delete sempre deve permitir recuperação em até 30 dias

---

## 9. SEGURANÇA

### Proteções Implementadas

- **Scan Antivírus Obrigatório**: ClamAV ou VirusTotal antes de armazenar
- **Hash SHA-256**: Integridade garantida + detecção de duplicatas
- **Criptografia AES-256**: Para documentos confidenciais (at-rest)
- **ACL Granular**: Deny sobrescreve Allow, permissões temporárias
- **Rate Limiting**: Máx 100 uploads/min por usuário
- **Soft Delete**: Recuperação em 30 dias
- **Auditoria 7 anos**: Compliance LGPD/GDPR
- **Links Temporários**: Expiração obrigatória (máx 30 dias), senha opcional
- **HTTPS Only**: Todos os endpoints com TLS 1.2+
- **SQL Injection Prevention**: Parameterized queries obrigatório
- **Path Traversal Prevention**: Validação de caminhos de arquivo
- **Zip Bomb Prevention**: Limite de tamanho de arquivo descompactado
- **XSS Prevention**: Sanitização de nomes de arquivo

### Testes de Segurança Obrigatórios

- SQL Injection em busca full-text
- XSS em nomes de arquivo
- CSRF Protection em POST requests
- ACL Bypass (usuário A tentar ver documento de B)
- Path Traversal (../../etc/passwd)
- Zip Bomb (arquivo compactado malicioso)
- Antivírus Bypass (arquivo com dupla extensão .pdf.exe)
- Expiração de Links (acessar link expirado)
- Rate Limiting (spam de uploads)
- Criptografia Confidencial (tentar descriptografar sem chave)

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

| Artefato | Arquivo | Responsável |
|----------|---------|-------------|
| Casos de Uso | UC-RF020.md | Architect Agent |
| Modelo de Dados | MD-RF020.md | Architect Agent |
| Workflows | WF-RF020.md | Architect Agent |
| Casos de Teste | TC-RF020.yaml | QA Agent |
| Massas de Teste | MT-RF020.yaml | QA Agent |

---

## 11. RASTREABILIDADE

| Artefato | Status | Gerado |
|----------|--------|--------|
| Casos de Uso (UC-RF020.md) | ✅ Concluído | 2025-12-28 |
| Modelo de Dados (MD-RF020.md) | ✅ Concluído | 2025-12-28 |
| Workflows (WF-RF020.md) | ✅ Concluído | 2025-12-28 |
| Casos de Teste (TC-RF020.yaml) | ⏳ Pendente | - |
| Massas de Teste (MT-RF020.yaml) | ⏳ Pendente | - |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0: Separação RF/RL completa (apenas contrato moderno) | Agência ALC - alc.dev.br |
| 1.0 | 2025-12-28 | Versão inicial expandida (15 regras, 13 endpoints, 4 integrações) | Architect Agent |
