# RF043 - Gest√£o de Endere√ßos Entrega

**Fase:** 2 - Servi√ßos Essenciais
**EPIC:** EPIC003-GES - Gest√£o
**M√≥dulo:** Gest√£o
**Respons√°vel:** Architect Agent
**Data Cria√ß√£o:** 17/12/2025
**Vers√£o:** 1.0
**Status:** Especifica√ß√£o Completa

---

## SE√á√ÉO 1: RESUMO EXECUTIVO

### 1.1 Descri√ß√£o Geral

O **RF043 - Gest√£o de Endere√ßos Entrega** implementa o sistema completo de gerenciamento de endere√ßos de entrega para solicita√ß√µes de compras, pedidos de ativos e entregas de equipamentos, incluindo valida√ß√£o autom√°tica de CEP via API ViaCEP, geocodifica√ß√£o para c√°lculo de dist√¢ncias, integra√ß√£o com APIs de transportadoras (Correios, Jadlog, Total Express), estimativa de frete e prazo de entrega, hist√≥rico de entregas por endere√ßo, mapeamento visual com Google Maps/OpenStreetMap, e gest√£o de m√∫ltiplos endere√ßos por empresa/filial com endere√ßo padr√£o configur√°vel.

### 1.2 Import√¢ncia Estrat√©gica

A gest√£o eficaz de endere√ßos de entrega √© crucial para:
- **Precis√£o Log√≠stica** garantindo que equipamentos cheguem no local correto sem retrabalho ou devolu√ß√£o
- **Redu√ß√£o de Custos** calculando frete autom√°tico e escolhendo a transportadora mais econ√¥mica
- **Rastreabilidade** mantendo hist√≥rico completo de entregas por endere√ßo com evid√™ncias
- **Compliance** validando CEP, endere√ßo e coordenadas geogr√°ficas antes da entrega
- **Experi√™ncia do Usu√°rio** permitindo busca r√°pida de endere√ßos salvos e reutiliza√ß√£o em novas solicita√ß√µes
- **An√°lise Gerencial** identificando endere√ßos com maior volume de entregas, problemas recorrentes e otimiza√ß√£o de rotas
- **Integra√ß√£o Multicanal** sincronizando endere√ßos com ERP, CRM e sistemas de gest√£o de frotas

### 1.3 Compara√ß√£o Sistema Legado vs. Modernizado

| Aspecto | Sistema Legado | Sistema Modernizado |
|---------|----------------|---------------------|
| **Valida√ß√£o de CEP** | Manual, sem valida√ß√£o | Autom√°tica via ViaCEP com preenchimento de rua/bairro/cidade |
| **Geocodifica√ß√£o** | N√£o suportado | Google Maps Geocoding API (lat/long precisos) |
| **C√°lculo de Frete** | Manual ou planilha externa | Integra√ß√£o com APIs Correios, Jadlog, Total Express |
| **Hist√≥rico de Entregas** | N√£o rastre√°vel | Hist√≥rico completo por endere√ßo com sucesso/falha/devolu√ß√£o |
| **Mapa Visual** | N√£o suportado | Google Maps integrado com marcadores e rotas |
| **M√∫ltiplos Endere√ßos** | 1 endere√ßo por empresa | Ilimitados endere√ßos com tags (Matriz, Filial, Dep√≥sito, etc.) |
| **Endere√ßo Padr√£o** | Configura√ß√£o manual | Sele√ß√£o de endere√ßo padr√£o por tipo de entrega |
| **Notifica√ß√µes Entrega** | E-mails espor√°dicos | Alertas em tempo real via SignalR + SMS |
| **Integra√ß√£o Transportadoras** | N√£o suportado | API REST para rastreamento de pacotes |
| **Auditoria** | Logs b√°sicos | Rastreabilidade completa com timeline visual |
| **Multi-tenant** | N√£o suportado | Isolamento completo por fornecedor |

### 1.4 Principais Funcionalidades

1. **Cadastro e Valida√ß√£o Autom√°tica de CEP**
   - Busca autom√°tica via ViaCEP ao digitar CEP
   - Preenchimento autom√°tico: logradouro, bairro, cidade, UF
   - Valida√ß√£o de CEP inv√°lido com mensagem clara
   - Suporte a CEP sem formato (apenas n√∫meros) ou formatado (12345-678)
   - Fallback: se ViaCEP indispon√≠vel, usar API alternativa (PostMon, BrasilAPI)

2. **Geocodifica√ß√£o e Mapeamento Visual**
   - Convers√£o autom√°tica de endere√ßo ‚Üí coordenadas (lat/long)
   - Exibi√ß√£o no mapa interativo (Google Maps ou OpenStreetMap)
   - Marcador clic√°vel com detalhes do endere√ßo
   - C√°lculo de dist√¢ncia entre origem (matriz) e destino (endere√ßo entrega)
   - Rota otimizada para m√∫ltiplas entregas no mesmo dia

3. **Integra√ß√£o com APIs de Transportadoras**
   - **Correios:** PAC, SEDEX, SEDEX 10, SEDEX Hoje
   - **Jadlog:** .Package, .Com, .Corporate
   - **Total Express:** Convencional, Econ√¥mico, Rodovi√°rio
   - C√°lculo autom√°tico: prazo de entrega, valor do frete, seguros
   - Compara√ß√£o lado a lado das op√ß√µes dispon√≠veis
   - Sele√ß√£o da melhor op√ß√£o (mais barato, mais r√°pido, melhor custo-benef√≠cio)

4. **Gest√£o de M√∫ltiplos Endere√ßos**
   - Ilimitados endere√ßos por empresa/filial
   - Categoriza√ß√£o: Matriz, Filial, Dep√≥sito, Home Office, Tempor√°rio
   - Endere√ßo padr√£o configur√°vel por tipo de solicita√ß√£o
   - Busca r√°pida por CEP, cidade, bairro, nome fantasia
   - Autocomplete ao digitar
   - Favoritos para endere√ßos mais usados

5. **Hist√≥rico de Entregas por Endere√ßo**
   - Todas as entregas realizadas naquele endere√ßo
   - Status: Entregue, Em Tr√¢nsito, Devolvido, Extraviado
   - Evid√™ncias: foto da entrega, assinatura digital, comprovante PDF
   - Avalia√ß√£o do recebedor (1-5 estrelas)
   - Problemas reportados: endere√ßo incorreto, portaria fechada, aus√™ncia

6. **Estimativa de Frete e Prazo**
   - C√°lculo autom√°tico baseado em:
     - Peso do ativo/equipamento
     - Dimens√µes (altura √ó largura √ó profundidade)
     - Valor declarado (para seguro)
     - CEP origem ‚Üí CEP destino
   - Compara√ß√£o de transportadoras com tabela visual
   - Simulador: alterar peso/dimens√µes e recalcular

7. **Notifica√ß√µes de Rastreamento**
   - Webhook de transportadoras integrado
   - Notifica√ß√µes autom√°ticas:
     - Postado ‚Üí Em Tr√¢nsito ‚Üí Saiu para Entrega ‚Üí Entregue
   - Alertas de atraso (prazo vencido sem entrega)
   - SMS/E-mail para destinat√°rio 1 dia antes da entrega prevista

8. **Relat√≥rios e Analytics**
   - Top 10 endere√ßos com mais entregas
   - Mapa de calor: concentra√ß√£o de entregas por regi√£o
   - Taxa de sucesso de entrega por endere√ßo (%)
   - Custo m√©dio de frete por km
   - Tempo m√©dio de entrega por transportadora

9. **Integra√ß√µes Mandat√≥rias**
   - **Central de Funcionalidades** - Registro da feature "Gest√£o de Endere√ßos Entrega"
   - **Internacionaliza√ß√£o (i18n)** - Todas as mensagens em pt-BR, en-US, es-ES
   - **Auditoria** - Log de cria√ß√£o, altera√ß√£o, exclus√£o de endere√ßos
   - **Controle de Acesso (RBAC)** - Permiss√µes: cadastrar, editar, excluir, visualizar

---

## SE√á√ÉO 2: REGRAS DE NEG√ìCIO

### RN001 - Valida√ß√£o Autom√°tica de CEP via ViaCEP

**Descri√ß√£o:**
Ao digitar o CEP, sistema busca automaticamente na API ViaCEP e preenche logradouro, bairro, cidade e UF.

**Justificativa:**
Eliminar erros de digita√ß√£o, padronizar endere√ßos e acelerar o preenchimento de formul√°rios.

**Implementa√ß√£o:**
- API: https://viacep.com.br/ws/{cep}/json/
- Trigger: onChange do campo CEP (ap√≥s 8 d√≠gitos)
- Debounce: 500ms para evitar requisi√ß√µes excessivas
- Fallback: se ViaCEP falhar, usar PostMon (http://api.postmon.com.br/v1/cep/{cep})
- Se ambos falharem: permitir preenchimento manual com aviso "CEP n√£o encontrado - verifique se est√° correto"
- Formata√ß√£o autom√°tica: 12345678 ‚Üí 12345-678

**Exemplo:**
```
Usu√°rio digita CEP: 01310-100

Request ViaCEP:
GET https://viacep.com.br/ws/01310100/json/

Response:
{
  "cep": "01310-100",
  "logradouro": "Avenida Paulista",
  "complemento": "",
  "bairro": "Bela Vista",
  "localidade": "S√£o Paulo",
  "uf": "SP",
  "ibge": "3550308",
  "gia": "1004",
  "ddd": "11",
  "siafi": "7107"
}

Campos Preenchidos Automaticamente:
‚úÖ Logradouro: Avenida Paulista
‚úÖ Bairro: Bela Vista
‚úÖ Cidade: S√£o Paulo
‚úÖ UF: SP
‚úÖ IBGE: 3550308

Usu√°rio completa:
- N√∫mero: 1578
- Complemento: 15¬∫ andar - Sala 1502
- Refer√™ncia: Pr√≥ximo ao metr√¥ Consola√ß√£o
```

**Valida√ß√µes:**
- ‚úÖ CEP deve ter exatamente 8 d√≠gitos (sem tra√ßo)
- ‚úÖ Todos os caracteres devem ser num√©ricos
- ‚úÖ Se ViaCEP retornar `{"erro": true}`, CEP inv√°lido
- ‚úÖ Timeout m√°ximo: 5 segundos

---

### RN002 - Geocodifica√ß√£o Autom√°tica com Google Maps API

**Descri√ß√£o:**
Endere√ßo completo √© convertido automaticamente em coordenadas geogr√°ficas (latitude/longitude) para exibi√ß√£o em mapa e c√°lculo de dist√¢ncias.

**Justificativa:**
Permitir visualiza√ß√£o geogr√°fica, c√°lculo de rotas e an√°lise espacial de entregas.

**Implementa√ß√£o:**
- API: Google Maps Geocoding API
- Entrada: endere√ßo completo formatado (rua, n√∫mero, bairro, cidade, UF, CEP)
- Sa√≠da: latitude, longitude, precis√£o (ROOFTOP, RANGE_INTERPOLATED, GEOMETRIC_CENTER)
- Armazenamento: campos Latitude (DECIMAL(10,8)), Longitude (DECIMAL(11,8))
- Atualiza√ß√£o: sempre que endere√ßo for modificado, recalcular coordenadas
- Fallback: se Google Maps falhar, usar OpenStreetMap Nominatim

**Exemplo:**
```
Endere√ßo Cadastrado:
Avenida Paulista, 1578 - 15¬∫ andar
Bela Vista
S√£o Paulo - SP
CEP: 01310-100

Geocodifica√ß√£o:
Request Google Maps:
GET https://maps.googleapis.com/maps/api/geocode/json?address=Avenida+Paulista,1578,Bela+Vista,S√£o+Paulo,SP,01310-100&key=AIzaSy...

Response:
{
  "results": [
    {
      "address_components": [...],
      "formatted_address": "Av. Paulista, 1578 - Bela Vista, S√£o Paulo - SP, 01310-100, Brasil",
      "geometry": {
        "location": {
          "lat": -23.5613920,
          "lng": -46.6565080
        },
        "location_type": "ROOFTOP",
        "viewport": {...}
      },
      "place_id": "ChIJd...",
      "types": ["street_address"]
    }
  ],
  "status": "OK"
}

Coordenadas Salvas:
‚úÖ Latitude: -23.5613920
‚úÖ Longitude: -46.6565080
‚úÖ Precis√£o: ROOFTOP (m√°xima)
‚úÖ Place ID: ChIJd... (para refer√™ncia futura)

Exibi√ß√£o no Mapa:
[Google Maps com marcador vermelho na Av. Paulista, 1578]
Zoom: 17 (n√≠vel de rua)
Marcador clic√°vel com popup:
"Avenida Paulista, 1578 - 15¬∫ andar
Bela Vista, S√£o Paulo - SP
üìç -23.5613920, -46.6565080"
```

**Valida√ß√µes:**
- ‚úÖ Status da API deve ser "OK"
- ‚úÖ Latitude deve estar entre -90 e +90
- ‚úÖ Longitude deve estar entre -180 e +180
- ‚úÖ Precis√£o "ROOFTOP" ou "RANGE_INTERPOLATED" s√£o aceit√°veis

---

### RN003 - C√°lculo Autom√°tico de Frete com M√∫ltiplas Transportadoras

**Descri√ß√£o:**
Sistema consulta automaticamente APIs de transportadoras (Correios, Jadlog, Total Express) e retorna prazo e valor de frete para cada modalidade.

**Justificativa:**
Permitir escolha da melhor op√ß√£o de entrega baseada em custo, prazo e qualidade.

**Implementa√ß√£o:**
- APIs integradas:
  - Correios: https://webservice.correios.com.br/service/CalcPrecoPrazo
  - Jadlog: https://api.jadlog.com.br/tracking/v1/quote
  - Total Express: https://api.totalexpress.com.br/v1/shipment/quote
- Par√¢metros obrigat√≥rios:
  - CEP origem (empresa)
  - CEP destino (endere√ßo entrega)
  - Peso (kg)
  - Dimens√µes (altura √ó largura √ó profundidade em cm)
  - Valor declarado (para seguro)
- Processamento paralelo (todas as APIs consultadas simultaneamente)
- Ordena√ß√£o: mais barato ‚Üí mais r√°pido ‚Üí melhor custo-benef√≠cio
- Cache: 6 horas para evitar requisi√ß√µes repetidas

**Exemplo:**
```
Solicita√ß√£o de Entrega:
Origem: CEP 01310-100 (S√£o Paulo - SP)
Destino: CEP 22040-000 (Rio de Janeiro - RJ)
Peso: 2,5 kg
Dimens√µes: 40 √ó 30 √ó 15 cm
Valor Declarado: R$ 1.500,00

Consulta Paralela √†s APIs:

1. Correios PAC:
   Prazo: 7 dias √∫teis
   Valor: R$ 35,50
   Seguros: R$ 15,00 (1% valor declarado)
   Total: R$ 50,50

2. Correios SEDEX:
   Prazo: 2 dias √∫teis
   Valor: R$ 78,90
   Seguro: R$ 15,00
   Total: R$ 93,90

3. Jadlog .Package:
   Prazo: 5 dias √∫teis
   Valor: R$ 42,00
   Seguro: R$ 12,00
   Total: R$ 54,00

4. Total Express Econ√¥mico:
   Prazo: 6 dias √∫teis
   Valor: R$ 38,50
   Seguro: R$ 10,00
   Total: R$ 48,50

Resultado Ordenado (Mais Barato):
ü•á Total Express Econ√¥mico - R$ 48,50 (6 dias)
ü•à Correios PAC - R$ 50,50 (7 dias)
ü•â Jadlog .Package - R$ 54,00 (5 dias)
4¬∫ Correios SEDEX - R$ 93,90 (2 dias) ‚ö° Mais R√°pido

Recomenda√ß√£o do Sistema:
"üí° Melhor Custo-Benef√≠cio: Total Express Econ√¥mico
Economize R$ 45,40 vs SEDEX e receba apenas 4 dias depois."
```

**Valida√ß√µes:**
- ‚úÖ CEP origem e destino devem ser v√°lidos
- ‚úÖ Peso deve ser >0 e <100 kg (limite transportadoras)
- ‚úÖ Dimens√µes devem ser >0 e soma ‚â§200 cm (limite transportadoras)
- ‚úÖ Se todas as APIs falharem, exibir aviso e permitir frete manual

---

### RN004 - Endere√ßo Padr√£o por Tipo de Solicita√ß√£o

**Descri√ß√£o:**
Usu√°rio pode marcar um endere√ßo como "Padr√£o" para ser pr√©-selecionado automaticamente em novas solicita√ß√µes de compra/entrega.

**Justificativa:**
Acelerar o processo de solicita√ß√£o, especialmente para usu√°rios que sempre entregam no mesmo local (ex: sede da empresa).

**Implementa√ß√£o:**
- Campo boolean: `FlEnderecoPadrao` na tabela `EnderecoEntrega`
- Regra: apenas 1 endere√ßo pode ser padr√£o por empresa/filial
- Ao marcar novo endere√ßo como padr√£o, desmarcar o anterior automaticamente
- Formul√°rios de solicita√ß√£o pr√©-selecionam endere√ßo padr√£o
- Usu√°rio pode alterar manualmente se necess√°rio

**Exemplo:**
```
Empresa: MINHA EMPRESA LTDA
Filial: S√£o Paulo - Matriz

Endere√ßos Cadastrados:
1. Avenida Paulista, 1578 - SP (Matriz) ‚≠ê PADR√ÉO
2. Rua Augusta, 2690 - SP (Dep√≥sito)
3. Rua dos Pinheiros, 498 - SP (Filial Centro)

Usu√°rio abre formul√°rio "Nova Solicita√ß√£o de Compra":
Campo "Endere√ßo de Entrega" pr√©-preenchido:
üìç Avenida Paulista, 1578 - Bela Vista, S√£o Paulo - SP
CEP: 01310-100 (Endere√ßo Padr√£o)

Usu√°rio pode:
‚úÖ Manter o endere√ßo padr√£o
‚úÖ Selecionar outro endere√ßo do dropdown
‚úÖ Cadastrar novo endere√ßo (fica dispon√≠vel para pr√≥ximas solicita√ß√µes)

Usu√°rio decide marcar outro endere√ßo como padr√£o:
A√ß√£o: Clicar em ‚≠ê ao lado de "Rua Augusta, 2690"

Sistema:
1. Remove ‚≠ê de "Avenida Paulista, 1578" (FlEnderecoPadrao = 0)
2. Adiciona ‚≠ê em "Rua Augusta, 2690" (FlEnderecoPadrao = 1)
3. Exibe toast: "Endere√ßo padr√£o atualizado com sucesso!"

Pr√≥ximas solicita√ß√µes vir√£o com "Rua Augusta, 2690" pr√©-selecionado.
```

**Valida√ß√µes:**
- ‚úÖ Apenas 1 endere√ßo padr√£o por empresa/filial
- ‚úÖ Ao marcar novo padr√£o, desmarcar anterior automaticamente
- ‚úÖ Endere√ßo padr√£o n√£o pode ser exclu√≠do (apenas alterado para outro)

---

### RN005 - Hist√≥rico Completo de Entregas por Endere√ßo

**Descri√ß√£o:**
Sistema registra todas as entregas realizadas em cada endere√ßo com status, evid√™ncias, problemas e avalia√ß√£o do recebedor.

**Justificativa:**
Identificar endere√ßos problem√°ticos, rastrear hist√≥rico de entregas e melhorar processos log√≠sticos.

**Implementa√ß√£o:**
- Tabela: `EntregaHistorico`
- Campos:
  - Id (GUID)
  - EnderecoEntregaId (FK)
  - SolicitacaoId (FK)
  - DataEnvio, DataPrevisao, DataEntrega
  - Status (Entregue, Em Tr√¢nsito, Devolvido, Extraviado)
  - Transportadora, CodigoRastreio
  - EvidenciaFotoUrl, AssinaturaDigitalUrl, ComprovanteUrl
  - AvaliacaoRecebedor (1-5 estrelas)
  - ProblemaReportado (texto livre)
  - CriadoPor, CriadoEm
- Query: listar √∫ltimas 10 entregas ao visualizar endere√ßo
- Filtros: per√≠odo, status, transportadora

**Exemplo:**
```
Endere√ßo: Avenida Paulista, 1578 - S√£o Paulo - SP

Hist√≥rico de Entregas (√∫ltimas 10):

1. Entrega #12345 - ‚úÖ ENTREGUE
   Data: 15/12/2025 14:30
   Solicita√ß√£o: SOL-2025-6789 (Notebook Dell)
   Transportadora: Correios SEDEX
   Rastreio: BR123456789BR
   Evid√™ncias:
     üì∑ Foto da entrega
     ‚úçÔ∏è Assinatura digital: Jo√£o Silva (Recep√ß√£o)
     üìÑ Comprovante PDF
   Avalia√ß√£o: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5.0)
   Coment√°rio: "Entrega r√°pida e em perfeito estado"

2. Entrega #12340 - ‚ö†Ô∏è DEVOLVIDO
   Data: 10/12/2025
   Solicita√ß√£o: SOL-2025-6701 (Monitor LG)
   Transportadora: Jadlog .Package
   Rastreio: JD987654321BR
   Problema: "Portaria fechada - 3 tentativas de entrega sem sucesso"
   A√ß√£o: Solicitante notificado para reagendar

3. Entrega #12330 - ‚úÖ ENTREGUE
   Data: 05/12/2025 09:15
   Solicita√ß√£o: SOL-2025-6650 (Teclado Logitech)
   Transportadora: Total Express
   Rastreio: TE1122334455BR
   Avalia√ß√£o: ‚≠ê‚≠ê‚≠ê‚≠ê (4.0)
   Coment√°rio: "Caixa amassada, mas produto OK"

Estat√≠sticas do Endere√ßo:
‚úÖ Taxa de Sucesso: 90% (9/10 entregas bem-sucedidas)
‚è±Ô∏è Tempo M√©dio de Entrega: 4,2 dias √∫teis
üí∞ Custo M√©dio de Frete: R$ 45,80
‚ö†Ô∏è Problemas Recorrentes:
  - 2 devolu√ß√µes por "Portaria fechada"
  - Sugest√£o: Avisar portaria com anteced√™ncia
```

**Valida√ß√µes:**
- ‚úÖ Registro de entrega obrigat√≥rio ao finalizar solicita√ß√£o
- ‚úÖ Status deve ser um dos valores permitidos (enum)
- ‚úÖ Evid√™ncias opcionais mas recomendadas
- ‚úÖ Avalia√ß√£o de 1-5 estrelas

---

### RN006 - Notifica√ß√µes de Rastreamento em Tempo Real

**Descri√ß√£o:**
Sistema se integra com webhooks de transportadoras e envia notifica√ß√µes autom√°ticas a cada mudan√ßa de status da entrega.

**Justificativa:**
Manter solicitante e destinat√°rio informados sobre o andamento da entrega sem necessidade de consulta manual.

**Implementa√ß√£o:**
- Webhooks configurados nas transportadoras:
  - Correios: https://www.correios.com.br/webhook/rastreamento
  - Jadlog: https://api.jadlog.com.br/webhook
  - Total Express: https://api.totalexpress.com.br/webhook
- Endpoint no IControlIT: POST /api/webhooks/rastreamento
- Eventos capturados:
  - Postado ‚Üí Em Tr√¢nsito ‚Üí Saiu para Entrega ‚Üí Entregue
  - Tentativa de Entrega ‚Üí Endere√ßo Incorreto ‚Üí Devolvido
- Notifica√ß√µes enviadas via:
  - SignalR (push no navegador)
  - E-mail (para solicitante e destinat√°rio)
  - SMS (opcional, apenas para eventos cr√≠ticos)
- Persist√™ncia: tabela `RastreamentoEvento`

**Exemplo:**
```
Entrega #12345
C√≥digo Rastreio: BR123456789BR
Transportadora: Correios SEDEX
Destino: Avenida Paulista, 1578 - S√£o Paulo - SP

Timeline de Rastreamento:

üì¶ 14/12/2025 10:00 - Postado
Local: Ag√™ncia Correios - S√£o Paulo - SP
Notifica√ß√£o Enviada:
  SignalR: Toast no navegador do solicitante
  E-mail: joao.silva@empresa.com
  Mensagem: "Seu pedido SOL-2025-6789 (Notebook Dell) foi postado e est√° em tr√¢nsito."

üöö 14/12/2025 18:30 - Em Tr√¢nsito
Local: Centro de Distribui√ß√£o - Campinas - SP
Notifica√ß√£o Enviada:
  SignalR: Atualiza√ß√£o do card de status
  E-mail: N√ÉO (evento intermedi√°rio)

üìç 15/12/2025 08:00 - Saiu para Entrega
Local: Unidade de Entrega - Bela Vista - SP
Notifica√ß√£o Enviada:
  SignalR: Alerta sonoro + toast
  E-mail: joao.silva@empresa.com + destinatario@empresa.com
  SMS: +55 11 98765-4321 (destinat√°rio)
  Mensagem: "üöö Sua entrega est√° a caminho! Previs√£o: hoje at√© 17h. Rastreio: BR123456789BR"

‚úÖ 15/12/2025 14:30 - Entregue
Local: Avenida Paulista, 1578
Recebido por: Jo√£o Silva (Recep√ß√£o)
Evid√™ncias: Foto + Assinatura digital
Notifica√ß√£o Enviada:
  SignalR: Confete na tela üéâ
  E-mail: joao.silva@empresa.com
  Mensagem: "‚úÖ Entrega conclu√≠da! Recebido por Jo√£o Silva √†s 14:30. Avalie a entrega: [Link]"

Hist√≥rico Completo Salvo no Banco:
Tabela: RastreamentoEvento
4 registros criados (Postado, Em Tr√¢nsito, Saiu, Entregue)
```

**Valida√ß√µes:**
- ‚úÖ Webhook deve conter signature v√°lida (seguran√ßa)
- ‚úÖ C√≥digo de rastreio deve existir no sistema
- ‚úÖ Evento duplicado (mesmo timestamp) √© ignorado
- ‚úÖ Se webhook falhar, fallback para polling a cada 1 hora

---

### RN007 - Mapa de Calor de Entregas por Regi√£o

**Descri√ß√£o:**
Dashboard exibe mapa de calor mostrando concentra√ß√£o de entregas por bairro/cidade para an√°lise estrat√©gica de log√≠stica.

**Justificativa:**
Identificar regi√µes com maior demanda de entregas para otimizar estoque, rotas e parcerias com transportadoras locais.

**Implementa√ß√£o:**
- Biblioteca: Google Maps Heatmap Layer ou Leaflet + Heatmap.js
- Dados: agrega√ß√£o de entregas por coordenadas geogr√°ficas
- Cores:
  - Verde: baixa concentra√ß√£o (<10 entregas/m√™s)
  - Amarelo: m√©dia concentra√ß√£o (10-50 entregas/m√™s)
  - Vermelho: alta concentra√ß√£o (>50 entregas/m√™s)
- Filtros: per√≠odo, status (entregue/devolvido), transportadora
- Clique na regi√£o: lista de endere√ßos e entregas

**Exemplo:**
```
Dashboard - Mapa de Calor de Entregas
Per√≠odo: Dezembro/2025

Mapa do Brasil:
üî¥ S√£o Paulo - SP: 234 entregas (Alta concentra√ß√£o)
üü° Rio de Janeiro - RJ: 45 entregas (M√©dia)
üü¢ Belo Horizonte - MG: 8 entregas (Baixa)
üü¢ Curitiba - PR: 12 entregas (Baixa)

Clique em S√£o Paulo:
Zoom no mapa ‚Üí Bairros:

üî¥ Bela Vista: 67 entregas
   Top Endere√ßo: Avenida Paulista, 1578 (12 entregas)
üü° Pinheiros: 34 entregas
   Top Endere√ßo: Rua dos Pinheiros, 498 (8 entregas)
üü° Itaim Bibi: 29 entregas
üü¢ Vila Mariana: 15 entregas

Insights Autom√°ticos:
üí° "67% das entregas concentram-se na regi√£o da Av. Paulista.
    Considere estabelecer dep√≥sito pr√≥ximo para reduzir custos de frete."

üí° "Taxa de sucesso em Bela Vista: 95% (63/67).
    Taxa de sucesso em Itaim Bibi: 72% (21/29).
    Investigar problemas em Itaim Bibi (endere√ßos incorretos?)."
```

**Valida√ß√µes:**
- ‚úÖ Coordenadas devem estar v√°lidas (lat/long n√£o nulos)
- ‚úÖ Agrega√ß√£o por precis√£o: 3 casas decimais (~100m de raio)
- ‚úÖ Performance: m√°ximo 10.000 pontos no mapa (sen√£o agregar por CEP)

---

### RN008 - Autocomplete de Endere√ßos Salvos

**Descri√ß√£o:**
Campo de busca com autocomplete exibe sugest√µes de endere√ßos salvos conforme usu√°rio digita CEP, cidade, bairro ou nome fantasia.

**Justificativa:**
Reutilizar endere√ßos j√° cadastrados sem necessidade de buscar em lista completa ou cadastrar novamente.

**Implementa√ß√£o:**
- Componente: Angular Material Autocomplete
- Trigger: ap√≥s 3 caracteres digitados
- Busca fuzzy: aceita erros de digita√ß√£o (Levenshtein distance)
- Campos pesquisados: CEP, logradouro, bairro, cidade, nome fantasia, refer√™ncia
- Ordena√ß√£o: endere√ßos mais usados primeiro
- Destaque: termo buscado em negrito no resultado

**Exemplo:**
```
Usu√°rio digita no campo "Endere√ßo de Entrega": "paul"

Autocomplete exibe:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üìç Avenida PAUL‚îÇista, 1578 - Bela Vista, SP             ‚îÇ
‚îÇ    CEP: 01310-100 | Usado 12 vezes                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üìç Rua Dr. PAUL‚îÇo Vieira, 234 - Sumar√©, SP             ‚îÇ
‚îÇ    CEP: 01257-000 | Usado 3 vezes                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üìç Rua PAULista de Medicina, 56 - Vila Clementino, SP  ‚îÇ
‚îÇ    CEP: 04039-020 | Usado 1 vez                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Usu√°rio clica no primeiro resultado:
‚úÖ Todos os campos preenchidos automaticamente:
  - CEP: 01310-100
  - Logradouro: Avenida Paulista
  - N√∫mero: 1578
  - Bairro: Bela Vista
  - Cidade: S√£o Paulo
  - UF: SP
  - Latitude: -23.5613920
  - Longitude: -46.6565080
  - Refer√™ncia: Pr√≥ximo ao metr√¥ Consola√ß√£o

Hist√≥rico de Entregas:
[Bot√£o] Ver 12 entregas anteriores neste endere√ßo
```

**Valida√ß√µes:**
- ‚úÖ M√≠nimo 3 caracteres para acionar autocomplete
- ‚úÖ M√°ximo 10 resultados exibidos
- ‚úÖ Debounce 300ms para evitar buscas excessivas
- ‚úÖ Endere√ßos inativos (FlExcluido=1) n√£o aparecem

---

### RN009 - Valida√ß√£o de Endere√ßo Duplicado

**Descri√ß√£o:**
Antes de salvar novo endere√ßo, sistema verifica se j√° existe endere√ßo id√™ntico ou muito similar (fuzzy match) para evitar duplicatas.

**Justificativa:**
Evitar prolifera√ß√£o de endere√ßos duplicados que dificultam busca e an√°lise de hist√≥rico.

**Implementa√ß√£o:**
- Verifica√ß√£o ao clicar "Salvar":
  - CEP exato
  - Logradouro, n√∫mero, bairro, cidade (fuzzy match 90% similaridade)
- Se encontrado: exibir modal "Endere√ßo similar encontrado. Deseja reutilizar?"
- Op√ß√µes:
  - Reutilizar endere√ßo existente
  - Salvar como novo (se realmente diferente)
  - Cancelar e revisar
- Log de tentativa de duplica√ß√£o para auditoria

**Exemplo:**
```
Usu√°rio preenche novo endere√ßo:
CEP: 01310-100
Logradouro: Avenida Paulista
N√∫mero: 1578
Complemento: 15¬∫ andar - Sala 1502
Bairro: Bela Vista
Cidade: S√£o Paulo
UF: SP

Sistema verifica duplicatas:
Query:
SELECT * FROM EnderecoEntrega
WHERE ClienteId = 'abc-123'
  AND CEP = '01310-100'
  AND Numero = '1578'
  AND FlExcluido = 0

Resultado:
1 endere√ßo encontrado:
  Id: END-2025-0123
  Logradouro: Av. Paulista (97% similar)
  N√∫mero: 1578
  Complemento: 14¬∫ andar (diferente!)
  Bairro: Bela Vista
  Criado em: 15/11/2025
  Usado: 12 vezes

Modal Exibido:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚ö†Ô∏è ENDERE√áO SIMILAR ENCONTRADO                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Existe endere√ßo muito parecido:                   ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ  üìç Avenida Paulista, 1578 - 14¬∫ andar             ‚îÇ
‚îÇ     Bela Vista, S√£o Paulo - SP                     ‚îÇ
‚îÇ     CEP: 01310-100                                 ‚îÇ
‚îÇ     Criado em: 15/11/2025                          ‚îÇ
‚îÇ     Usado em: 12 entregas                          ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ  Diferen√ßa: Complemento (14¬∫ vs 15¬∫ andar)         ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ  O que deseja fazer?                               ‚îÇ
‚îÇ  [Reutilizar Existente] [Salvar Novo] [Cancelar]  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Se usu√°rio clicar "Salvar Novo":
‚úÖ Novo endere√ßo criado (complemento diferente justifica)
  Id: END-2025-0456
  Complemento: 15¬∫ andar - Sala 1502

Se usu√°rio clicar "Reutilizar Existente":
‚úÖ Formul√°rio atualizado com dados do endere√ßo existente
  Complemento alterado: 14¬∫ andar ‚Üí 15¬∫ andar (atualiza√ß√£o)
```

**Valida√ß√µes:**
- ‚úÖ Fuzzy match usa algoritmo Levenshtein (‚â•90% similaridade)
- ‚úÖ CEP + N√∫mero s√£o crit√©rios obrigat√≥rios
- ‚úÖ Endere√ßos exclu√≠dos (FlExcluido=1) ignorados na busca

---

### RN010 - Exporta√ß√£o de Relat√≥rio de Entregas

**Descri√ß√£o:**
Sistema permite exportar relat√≥rio completo de entregas em Excel/PDF com filtros personalizados.

**Justificativa:**
Gestores precisam de relat√≥rios para an√°lise offline, apresenta√ß√µes e auditorias.

**Implementa√ß√£o:**
- Formatos: Excel (.xlsx), PDF (.pdf)
- Filtros:
  - Per√≠odo (data in√≠cio - data fim)
  - Status (Entregue, Em Tr√¢nsito, Devolvido)
  - Endere√ßo (dropdown)
  - Transportadora
  - Solicitante
- Colunas:
  - C√≥digo Solicita√ß√£o
  - Data Envio, Previs√£o, Entrega
  - Endere√ßo Completo
  - Transportadora, Rastreio
  - Status, Avalia√ß√£o
  - Custo Frete
- Totalizadores: total entregas, custo total frete, taxa sucesso

**Exemplo:**
```
Filtros Aplicados:
Per√≠odo: 01/12/2025 - 31/12/2025
Status: Todos
Endere√ßo: Avenida Paulista, 1578
Transportadora: Todas

Relat√≥rio Gerado (Excel):

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ C√≥digo   ‚îÇ Envio      ‚îÇ Previs√£o    ‚îÇ Entrega Real ‚îÇ Endere√ßo     ‚îÇ Transp ‚îÇ Rastr ‚îÇ Status    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇSOL-6789  ‚îÇ15/12/2025  ‚îÇ17/12/2025   ‚îÇ15/12/2025    ‚îÇAv Paulista..‚îÇCorreio ‚îÇBR123..‚îÇ‚úÖ Entregue‚îÇ
‚îÇSOL-6701  ‚îÇ10/12/2025  ‚îÇ15/12/2025   ‚îÇN√£o entregue  ‚îÇAv Paulista..‚îÇJadlog  ‚îÇJD987..‚îÇ‚ö†Ô∏è Devolv. ‚îÇ
‚îÇSOL-6650  ‚îÇ05/12/2025  ‚îÇ11/12/2025   ‚îÇ09/12/2025    ‚îÇAv Paulista..‚îÇTotal Ex‚îÇTE112..‚îÇ‚úÖ Entregue‚îÇ
‚îÇ...       ‚îÇ...         ‚îÇ...          ‚îÇ...           ‚îÇ...           ‚îÇ...     ‚îÇ...    ‚îÇ...        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ TOTALIZADORES                                                                                   ‚îÇ
‚îÇ Total Entregas: 12                                                                              ‚îÇ
‚îÇ Entregues: 10 (83,3%)                                                                           ‚îÇ
‚îÇ Devolvidas: 2 (16,7%)                                                                           ‚îÇ
‚îÇ Custo Total Frete: R$ 548,90                                                                    ‚îÇ
‚îÇ Custo M√©dio: R$ 45,74                                                                           ‚îÇ
‚îÇ Avalia√ß√£o M√©dia: 4,3 ‚≠ê                                                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Gerado em: 17/12/2025 15:30:45
Usu√°rio: Jo√£o Silva (joao.silva@empresa.com)
```

**Valida√ß√µes:**
- ‚úÖ Per√≠odo m√°ximo: 1 ano (365 dias)
- ‚úÖ M√°ximo 10.000 registros por exporta√ß√£o
- ‚úÖ Se >10.000, sugerir filtrar mais ou gerar em lote
- ‚úÖ Excel: formata√ß√£o condicional (verde=entregue, vermelho=devolvido)

---

## SE√á√ÉO 3: REFER√äNCIAS AO SISTEMA LEGADO

### 3.1 Telas Web Forms (ASPX)

| Tela Legada | Funcionalidade | Observa√ß√µes |
|-------------|----------------|-------------|
| `Cadastro/EnderecoEntrega.aspx` | Cadastro manual de endere√ßos | Sem valida√ß√£o CEP, geocodifica√ß√£o manual |
| `Consulta/Enderecos.aspx` | Listagem simples | Substitu√≠da por DataGrid Angular com filtros avan√ßados |

### 3.2 Stored Procedures

| Procedure Legada | Finalidade | Status Moderniza√ß√£o |
|------------------|------------|---------------------|
| `sp_ValidarCEP` | Valida√ß√£o manual | Substitu√≠da por API ViaCEP (tempo real) |
| `sp_BuscarEndereco` | Busca por CEP | Migrado para EnderecoService.cs (C#) |

### 3.3 Tabelas do Banco

| Tabela Legada | Nova Tabela | Mudan√ßas Principais |
|---------------|-------------|---------------------|
| `EnderecoEntrega` | `EnderecoEntrega` | +Latitude, +Longitude, +ClienteId, +FlEnderecoPadrao |
| (n√£o existia) | `EntregaHistorico` | Nova tabela para rastreamento |
| (n√£o existia) | `RastreamentoEvento` | Nova tabela para eventos de tracking |

### 3.4 Mapeamento Funcional

| Funcionalidade | Legado | Modernizado |
|----------------|--------|-------------|
| Valida√ß√£o CEP | Manual | API ViaCEP autom√°tica |
| Geocodifica√ß√£o | N√£o suportado | Google Maps API |
| C√°lculo Frete | Planilha Excel | APIs Correios/Jadlog/Total Express |
| Hist√≥rico Entregas | N√£o rastre√°vel | Completo com evid√™ncias e avalia√ß√µes |
| Mapa Visual | N√£o suportado | Google Maps integrado + heatmap |

---

## SE√á√ÉO 4: IMPACTO E DEPEND√äNCIAS

### 4.1 Depend√™ncias de Outros RFs

| RF Dependente | Tipo Depend√™ncia | Descri√ß√£o |
|---------------|------------------|-----------|
| **RF008 - Gest√£o de Fornecedores** | **M√âDIA** | Empresas/filiais precisam ter endere√ßos de entrega |
| **RF013 - Gest√£o de Locais e Endere√ßos** | **ALTA** | Reutiliza valida√ß√µes e geocodifica√ß√£o |
| **RF019 - Gest√£o de Pedidos de Compra** | **CR√çTICA** | Pedidos vinculam endere√ßos de entrega |
| **RF001 - Par√¢metros e Configura√ß√µes** | **M√âDIA** | Chaves API Google Maps, ViaCEP, transportadoras |

### 4.2 Tecnologias Utilizadas

**Backend:**
- **.NET 10** - Runtime
- **HttpClient + Polly** - Chamadas API externas com retry
- **Hangfire** - Jobs agendados (polling rastreamento)
- **SignalR** - Notifica√ß√µes em tempo real

**Frontend:**
- **Angular 19** - Framework
- **Angular Material** - Autocomplete, Dialogs
- **Google Maps API** - Mapeamento e geocodifica√ß√£o
- **Leaflet** (alternativa) - Mapa open-source

**APIs Externas:**
- **ViaCEP** - Valida√ß√£o CEP
- **Google Maps Geocoding** - Lat/Long
- **Correios, Jadlog, Total Express** - Frete e rastreamento

### 4.3 Complexidade de Implementa√ß√£o

**Complexidade Geral:** ALTA

| Componente | Complexidade | Estimativa |
|------------|--------------|-----------|
| Valida√ß√£o CEP ViaCEP | BAIXA | 8h |
| Geocodifica√ß√£o Google Maps | M√âDIA | 16h |
| Integra√ß√£o Transportadoras | ALTA | 40h |
| Webhooks Rastreamento | M√âDIA | 20h |
| Mapa de Calor | ALTA | 24h |
| Autocomplete Fuzzy Search | M√âDIA | 16h |
| Hist√≥rico Entregas | BAIXA | 12h |
| Testes Automatizados | M√âDIA | 32h |
| **Total** | **ALTA** | **168h** (~4 semanas) |

### 4.4 Riscos Identificados

| Risco | Probabilidade | Impacto | Mitiga√ß√£o |
|-------|---------------|---------|-----------|
| APIs externas indispon√≠veis | M√âDIA | ALTO | Fallbacks, retry, cache |
| Google Maps custo elevado | BAIXA | M√âDIO | Monitorar uso, usar OpenStreetMap se necess√°rio |
| Transportadoras sem API | ALTA | M√âDIO | Permitir cadastro manual de frete |

---

## SE√á√ÉO 5: INTEGRA√á√ÉO COM CENTRAL DE FUNCIONALIDADES

### 5.1 Permiss√µes RBAC

**M√≥dulo:** `GES.ENDERECOS_ENTREGA`

| Permiss√£o | C√≥digo | Roles Padr√£o |
|-----------|--------|--------------|
| **Visualizar** | `GES.ENDERECOS_ENTREGA.VIEW` | Todos |
| **Cadastrar** | `GES.ENDERECOS_ENTREGA.CREATE` | Solicitante, Comprador |
| **Editar** | `GES.ENDERECOS_ENTREGA.EDIT` | Comprador, Gestor |
| **Excluir** | `GES.ENDERECOS_ENTREGA.DELETE` | Gestor, Super Admin |
| **Marcar Padr√£o** | `GES.ENDERECOS_ENTREGA.SET_DEFAULT` | Comprador, Gestor |
| **Ver Hist√≥rico** | `GES.ENDERECOS_ENTREGA.VIEW_HISTORY` | Comprador, Gestor, Auditor |

### 5.2 Chaves i18n

**Namespace:** `ges.enderecosEntrega`

```json
{
  "ges.enderecosEntrega": {
    "title": "Gest√£o de Endere√ßos de Entrega",
    "fields": {
      "cep": "CEP",
      "logradouro": "Logradouro",
      "numero": "N√∫mero",
      "complemento": "Complemento",
      "bairro": "Bairro",
      "cidade": "Cidade",
      "uf": "UF",
      "latitude": "Latitude",
      "longitude": "Longitude",
      "enderecoPadrao": "Endere√ßo Padr√£o"
    },
    "messages": {
      "cepValidado": "CEP validado com sucesso!",
      "cepInvalido": "CEP inv√°lido ou n√£o encontrado",
      "enderecoSalvo": "Endere√ßo salvo com sucesso!",
      "duplicataDetectada": "Endere√ßo similar encontrado. Deseja reutilizar?"
    }
  }
}
```

### 5.3 Campos de Auditoria

| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `CriadoPor` | NVARCHAR(450) | Usu√°rio que cadastrou |
| `CriadoEm` | DATETIME2 | Data/hora cria√ß√£o |
| `AlteradoPor` | NVARCHAR(450) | √öltimo usu√°rio que editou |
| `AlteradoEm` | DATETIME2 | Data/hora √∫ltima edi√ß√£o |

### 5.4 Multi-tenancy

**Discriminador:** `ClienteId` (GUID do fornecedor)

**Filtro Global EF Core:**
```csharp
modelBuilder.Entity<EnderecoEntrega>().HasQueryFilter(e => e.ClienteId == _currentClienteId);
```

---

**FIM DA ESPECIFICA√á√ÉO RF043**
