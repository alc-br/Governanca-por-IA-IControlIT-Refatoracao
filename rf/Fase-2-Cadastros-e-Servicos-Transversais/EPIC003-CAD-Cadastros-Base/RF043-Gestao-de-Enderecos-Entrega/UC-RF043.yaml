# =============================================
# UC - Casos de Uso (Contrato Comportamental)
# Versão: 2.0
# Autor padrão: Agência ALC - alc.dev.br
# =============================================

uc:
  rf: "RF043"
  versao: "2.0"
  data: "2025-12-31"

casos_de_uso:

  - id: "UC00"
    nome: "Listar Endereços de Entrega"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      rf_items:
        - "RN-RF043-008"  # Autocomplete de Endereços Salvos
      uc_items:
        - id: "FP-UC00-001"
          title: "Usuário acessa a funcionalidade Gestão de Endereços de Entrega"
          required: true
        - id: "FP-UC00-002"
          title: "Sistema valida permissão GES.ENDERECOS_ENTREGA.VIEW"
          required: true
        - id: "FP-UC00-003"
          title: "Sistema carrega endereços do tenant (WHERE ClienteId = @currentUserId AND FlExcluido = 0)"
          required: true
        - id: "FP-UC00-004"
          title: "Sistema aplica paginação padrão (20 registros) e ordenação (endereços mais usados primeiro)"
          required: true
        - id: "FP-UC00-005"
          title: "Sistema exibe a lista com colunas: Apelido, CEP, Logradouro, Número, Bairro, Cidade, UF, Categoria, Endereço Padrão"
          required: true
        - id: "FA-UC00-001"
          title: "Buscar por termo (mínimo 3 caracteres) com autocomplete fuzzy"
          required: false
        - id: "FA-UC00-002"
          title: "Ordenar por coluna (CEP, Cidade, Categoria)"
          required: false
        - id: "FA-UC00-003"
          title: "Filtrar por Categoria"
          required: false
        - id: "FA-UC00-004"
          title: "Filtrar por UF"
          required: false
        - id: "FA-UC00-005"
          title: "Visualizar apenas endereços padrão"
          required: false
        - id: "FE-UC00-001"
          title: "Usuário sem permissão → HTTP 403 Acesso negado"
          required: true
        - id: "FE-UC00-002"
          title: "Nenhum registro encontrado → Estado vazio exibido"
          required: true

    precondicoes:
      - permissao: "GES.ENDERECOS_ENTREGA.VIEW"

    gatilho: "Usuario acessa a funcionalidade pelo menu"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessa_menu"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "listar_enderecos_tenant"
      - passo: 4
        ator: "sistema"
        acao: "aplicar_paginacao_ordenacao"
      - passo: 5
        ator: "sistema"
        acao: "exibir_lista"

    fluxos_alternativos:
      - id: "FA-UC00-01"
        condicao: "usuario_digita_busca_minimo_3_caracteres"
        resultado: "autocomplete_fuzzy_ativado"
      - id: "FA-UC00-02"
        condicao: "usuario_ordena_coluna"
        resultado: "lista_reordenada"
      - id: "FA-UC00-03"
        condicao: "usuario_filtra_categoria"
        resultado: "lista_filtrada"

    fluxos_excecao:
      - id: "FE-UC00-01"
        condicao: "sem_permissao"
        resultado: "acesso_negado_http_403"
      - id: "FE-UC00-02"
        condicao: "nenhum_registro"
        resultado: "estado_vazio_exibido"

    regras_aplicadas:
      - "RN-RF043-008"  # Autocomplete após 3 caracteres com debounce 300ms

    resultado_final:
      estado: "lista_exibida"

  - id: "UC01"
    nome: "Criar Endereço de Entrega"
    ator_principal: "usuario_autenticado"
    tipo: "crud"
    impacta_dados: true

    covers:
      rf_items:
        - "RN-RF043-001"  # Validação Automática de CEP via ViaCEP
        - "RN-RF043-002"  # Geocodificação Automática com Google Maps API
        - "RN-RF043-009"  # Validação de Endereço Duplicado
      uc_items:
        - id: "FP-UC01-001"
          title: "Usuário clica em Novo Endereço"
          required: true
        - id: "FP-UC01-002"
          title: "Sistema valida permissão GES.ENDERECOS_ENTREGA.CREATE"
          required: true
        - id: "FP-UC01-003"
          title: "Sistema exibe formulário vazio"
          required: true
        - id: "FP-UC01-004"
          title: "Usuário digita CEP (8 dígitos)"
          required: true
        - id: "FP-UC01-005"
          title: "Sistema aplica formatação automática (12345678 → 12345-678)"
          required: true
        - id: "FP-UC01-006"
          title: "Após 500ms (debounce), sistema dispara requisição para ViaCEP"
          required: true
        - id: "FP-UC01-007"
          title: "API ViaCEP retorna logradouro, bairro, cidade, UF, código IBGE"
          required: true
        - id: "FP-UC01-008"
          title: "Sistema preenche automaticamente os campos retornados"
          required: true
        - id: "FP-UC01-009"
          title: "Usuário preenche Número, Complemento, Categoria, Nome Fantasia, Referência"
          required: true
        - id: "FP-UC01-010"
          title: "Usuário clica em Salvar"
          required: true
        - id: "FP-UC01-011"
          title: "Sistema valida campos obrigatórios"
          required: true
        - id: "FP-UC01-012"
          title: "Sistema verifica duplicatas via fuzzy match"
          required: true
        - id: "FP-UC01-013"
          title: "Sistema envia requisição para Google Maps Geocoding API"
          required: true
        - id: "FP-UC01-014"
          title: "API retorna Latitude, Longitude, Precisão, PlaceId"
          required: true
        - id: "FP-UC01-015"
          title: "Sistema valida coordenadas"
          required: true
        - id: "FP-UC01-016"
          title: "Sistema persiste endereço com ClienteId automático"
          required: true
        - id: "FP-UC01-017"
          title: "Sistema registra auditoria"
          required: true
        - id: "FP-UC01-018"
          title: "Sistema confirma sucesso"
          required: true
        - id: "FA-UC01-001"
          title: "API ViaCEP falha → fallback para PostMon"
          required: false
        - id: "FA-UC01-002"
          title: "Google Maps Geocoding API falha → fallback para OpenStreetMap"
          required: false
        - id: "FA-UC01-003"
          title: "Salvar e criar outro"
          required: false
        - id: "FA-UC01-004"
          title: "Cancelar criação"
          required: false
        - id: "FE-UC01-001"
          title: "Erro de validação → HTTP 400"
          required: true
        - id: "FE-UC01-002"
          title: "Endereço duplicado detectado → HTTP 409"
          required: true
        - id: "FE-UC01-003"
          title: "Erro inesperado → HTTP 500"
          required: true

    precondicoes:
      - permissao: "GES.ENDERECOS_ENTREGA.CREATE"

    gatilho: "Usuario clica em Novo"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "clicar_novo"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "exibir_formulario"
      - passo: 4
        ator: "usuario"
        acao: "digitar_cep"
      - passo: 5
        ator: "sistema"
        acao: "validar_cep_viacep"
      - passo: 6
        ator: "sistema"
        acao: "preencher_campos_automaticamente"
      - passo: 7
        ator: "usuario"
        acao: "preencher_campos_restantes"
      - passo: 8
        ator: "usuario"
        acao: "salvar"
      - passo: 9
        ator: "sistema"
        acao: "validar_campos_obrigatorios"
      - passo: 10
        ator: "sistema"
        acao: "verificar_duplicatas_fuzzy_match"
      - passo: 11
        ator: "sistema"
        acao: "geocodificar_google_maps"
      - passo: 12
        ator: "sistema"
        acao: "persistir_endereco"
      - passo: 13
        ator: "sistema"
        acao: "registrar_auditoria"

    fluxos_alternativos:
      - id: "FA-UC01-01"
        condicao: "viacep_falha"
        resultado: "fallback_postmon"
      - id: "FA-UC01-02"
        condicao: "google_maps_falha"
        resultado: "fallback_openstreetmap"

    fluxos_excecao:
      - id: "FE-UC01-01"
        condicao: "validacao_falhou"
        resultado: "exibir_erros_http_400"
      - id: "FE-UC01-02"
        condicao: "duplicata_detectada"
        resultado: "modal_reutilizar_http_409"

    regras_aplicadas:
      - "RN-RF043-001"  # Validação CEP via ViaCEP com debounce 500ms
      - "RN-RF043-002"  # Geocodificação via Google Maps API
      - "RN-RF043-009"  # Validação de duplicatas via fuzzy match

    resultado_final:
      estado: "endereco_criado"

  - id: "UC02"
    nome: "Visualizar Endereço de Entrega"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      rf_items:
        - "RN-RF043-005"  # Histórico Completo de Entregas por Endereço
      uc_items:
        - id: "FP-UC02-001"
          title: "Usuário clica em um endereço na listagem"
          required: true
        - id: "FP-UC02-002"
          title: "Sistema valida permissão GES.ENDERECOS_ENTREGA.VIEW"
          required: true
        - id: "FP-UC02-003"
          title: "Sistema valida tenant"
          required: true
        - id: "FP-UC02-004"
          title: "Sistema carrega dados completos do endereço"
          required: true
        - id: "FP-UC02-005"
          title: "Sistema carrega histórico de entregas (últimas 10)"
          required: true
        - id: "FP-UC02-006"
          title: "Sistema exibe mapa com marcador (Google Maps)"
          required: true
        - id: "FP-UC02-007"
          title: "Sistema calcula estatísticas (taxa sucesso, tempo médio, custo médio)"
          required: true
        - id: "FP-UC02-008"
          title: "Sistema exibe dados completos + histórico + mapa + estatísticas"
          required: true
        - id: "FA-UC02-001"
          title: "Visualizar histórico completo de entregas"
          required: false
        - id: "FA-UC02-002"
          title: "Ampliar mapa"
          required: false
        - id: "FE-UC02-001"
          title: "Endereço inexistente → HTTP 404"
          required: true
        - id: "FE-UC02-002"
          title: "Endereço de outro tenant → HTTP 404"
          required: true
        - id: "FE-UC02-003"
          title: "Coordenadas ausentes → mapa não exibido"
          required: true

    precondicoes:
      - permissao: "GES.ENDERECOS_ENTREGA.VIEW"

    gatilho: "Usuario clica em endereco"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "clicar_endereco"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "validar_tenant"
      - passo: 4
        ator: "sistema"
        acao: "carregar_dados_completos"
      - passo: 5
        ator: "sistema"
        acao: "carregar_historico_entregas"
      - passo: 6
        ator: "sistema"
        acao: "exibir_mapa_marcador"
      - passo: 7
        ator: "sistema"
        acao: "calcular_estatisticas"
      - passo: 8
        ator: "sistema"
        acao: "exibir_tudo"

    fluxos_excecao:
      - id: "FE-UC02-01"
        condicao: "endereco_inexistente"
        resultado: "http_404"
      - id: "FE-UC02-02"
        condicao: "outro_tenant"
        resultado: "http_404"

    regras_aplicadas:
      - "RN-RF043-005"  # Histórico completo de entregas

    resultado_final:
      estado: "detalhes_exibidos"

  - id: "UC03"
    nome: "Editar Endereço de Entrega"
    ator_principal: "usuario_autenticado"
    tipo: "crud"
    impacta_dados: true

    covers:
      rf_items:
        - "RN-RF043-001"  # Revalidação de CEP via ViaCEP
        - "RN-RF043-002"  # Regeocodificação via Google Maps API
      uc_items:
        - id: "FP-UC03-001"
          title: "Usuário clica em Editar em um endereço"
          required: true
        - id: "FP-UC03-002"
          title: "Sistema valida permissão GES.ENDERECOS_ENTREGA.EDIT"
          required: true
        - id: "FP-UC03-003"
          title: "Sistema valida tenant"
          required: true
        - id: "FP-UC03-004"
          title: "Sistema carrega dados atuais no formulário"
          required: true
        - id: "FP-UC03-005"
          title: "Usuário altera campos desejados"
          required: true
        - id: "FP-UC03-006"
          title: "Se CEP alterado, sistema revalida via ViaCEP"
          required: true
        - id: "FP-UC03-007"
          title: "Usuário clica em Salvar"
          required: true
        - id: "FP-UC03-008"
          title: "Sistema valida alterações"
          required: true
        - id: "FP-UC03-009"
          title: "Se endereço alterado, sistema regeocodifica via Google Maps API"
          required: true
        - id: "FP-UC03-010"
          title: "Sistema persiste alterações"
          required: true
        - id: "FP-UC03-011"
          title: "Sistema registra auditoria (shadow properties)"
          required: true
        - id: "FP-UC03-012"
          title: "Sistema confirma sucesso"
          required: true
        - id: "FA-UC03-001"
          title: "Cancelar edição"
          required: false
        - id: "FE-UC03-001"
          title: "Erro de validação → HTTP 400"
          required: true
        - id: "FE-UC03-002"
          title: "Conflito de edição concorrente → HTTP 409"
          required: true
        - id: "FE-UC03-003"
          title: "Tentativa de editar endereço de outro tenant → HTTP 404"
          required: true

    precondicoes:
      - permissao: "GES.ENDERECOS_ENTREGA.EDIT"

    gatilho: "Usuario clica em Editar"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "clicar_editar"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "validar_tenant"
      - passo: 4
        ator: "sistema"
        acao: "carregar_formulario"
      - passo: 5
        ator: "usuario"
        acao: "alterar_campos"
      - passo: 6
        ator: "sistema"
        acao: "revalidar_cep_se_alterado"
      - passo: 7
        ator: "usuario"
        acao: "salvar"
      - passo: 8
        ator: "sistema"
        acao: "validar_alteracoes"
      - passo: 9
        ator: "sistema"
        acao: "regeocodificar_se_alterado"
      - passo: 10
        ator: "sistema"
        acao: "persistir_alteracoes"
      - passo: 11
        ator: "sistema"
        acao: "registrar_auditoria_shadow_properties"

    fluxos_excecao:
      - id: "FE-UC03-01"
        condicao: "validacao_falhou"
        resultado: "exibir_erros_http_400"
      - id: "FE-UC03-02"
        condicao: "conflito_concorrente"
        resultado: "http_409_recarregar"

    regras_aplicadas:
      - "RN-RF043-001"  # Revalidação CEP se alterado
      - "RN-RF043-002"  # Regeocodificação se endereço alterado

    resultado_final:
      estado: "endereco_atualizado"

  - id: "UC04"
    nome: "Excluir Endereço de Entrega"
    ator_principal: "usuario_autenticado"
    tipo: "crud"
    impacta_dados: true

    covers:
      rf_items:
        - "RN-RF043-004"  # Endereço Padrão não pode ser excluído
      uc_items:
        - id: "FP-UC04-001"
          title: "Usuário clica em Excluir em um endereço"
          required: true
        - id: "FP-UC04-002"
          title: "Sistema valida permissão GES.ENDERECOS_ENTREGA.DELETE"
          required: true
        - id: "FP-UC04-003"
          title: "Sistema verifica se endereço é padrão"
          required: true
        - id: "FP-UC04-004"
          title: "Sistema exibe modal de confirmação"
          required: true
        - id: "FP-UC04-005"
          title: "Usuário confirma exclusão"
          required: true
        - id: "FP-UC04-006"
          title: "Sistema valida tenant"
          required: true
        - id: "FP-UC04-007"
          title: "Sistema verifica dependências (entregas pendentes, pedidos abertos)"
          required: true
        - id: "FP-UC04-008"
          title: "Sistema executa soft delete"
          required: true
        - id: "FP-UC04-009"
          title: "Sistema registra auditoria"
          required: true
        - id: "FP-UC04-010"
          title: "Sistema confirma sucesso"
          required: true
        - id: "FA-UC04-001"
          title: "Cancelar exclusão"
          required: false
        - id: "FA-UC04-002"
          title: "Exclusão em lote (máximo 50)"
          required: false
        - id: "FE-UC04-001"
          title: "Endereço é padrão → HTTP 400"
          required: true
        - id: "FE-UC04-002"
          title: "Endereço possui entregas pendentes → HTTP 400"
          required: true
        - id: "FE-UC04-003"
          title: "Endereço já excluído → HTTP 404"
          required: true

    precondicoes:
      - permissao: "GES.ENDERECOS_ENTREGA.DELETE"

    gatilho: "Usuario clica em Excluir"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "clicar_excluir"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "verificar_se_padrao"
      - passo: 4
        ator: "sistema"
        acao: "exibir_modal_confirmacao"
      - passo: 5
        ator: "usuario"
        acao: "confirmar"
      - passo: 6
        ator: "sistema"
        acao: "validar_tenant"
      - passo: 7
        ator: "sistema"
        acao: "verificar_dependencias"
      - passo: 8
        ator: "sistema"
        acao: "soft_delete"
      - passo: 9
        ator: "sistema"
        acao: "registrar_auditoria"

    fluxos_excecao:
      - id: "FE-UC04-01"
        condicao: "endereco_padrao"
        resultado: "bloquear_exclusao_http_400"
      - id: "FE-UC04-02"
        condicao: "entregas_pendentes"
        resultado: "bloquear_exclusao_http_400"

    regras_aplicadas:
      - "RN-RF043-004"  # Endereço padrão não pode ser excluído

    resultado_final:
      estado: "endereco_excluido"

  - id: "UC05"
    nome: "Definir Endereço Padrão"
    ator_principal: "usuario_autenticado"
    tipo: "acao"
    impacta_dados: true

    covers:
      rf_items:
        - "RN-RF043-004"  # Apenas 1 endereço padrão por ClienteId
      uc_items:
        - id: "FP-UC05-001"
          title: "Usuário clica em ícone Estrela (Definir como Padrão)"
          required: true
        - id: "FP-UC05-002"
          title: "Sistema valida permissão GES.ENDERECOS_ENTREGA.SET_DEFAULT"
          required: true
        - id: "FP-UC05-003"
          title: "Sistema valida tenant"
          required: true
        - id: "FP-UC05-004"
          title: "Sistema exibe modal de confirmação"
          required: true
        - id: "FP-UC05-005"
          title: "Usuário confirma"
          required: true
        - id: "FP-UC05-006"
          title: "Sistema inicia transação"
          required: true
        - id: "FP-UC05-007"
          title: "Sistema desmarca endereço anteriormente padrão"
          required: true
        - id: "FP-UC05-008"
          title: "Sistema marca novo endereço como padrão"
          required: true
        - id: "FP-UC05-009"
          title: "Sistema registra auditoria para ambos endereços"
          required: true
        - id: "FP-UC05-010"
          title: "Sistema confirma transação (COMMIT)"
          required: true
        - id: "FP-UC05-011"
          title: "Sistema confirma sucesso"
          required: true
        - id: "FA-UC05-001"
          title: "Cancelar definição"
          required: false
        - id: "FE-UC05-001"
          title: "Endereço já é padrão → mensagem informativa"
          required: true
        - id: "FE-UC05-002"
          title: "Erro em transação → ROLLBACK → HTTP 500"
          required: true

    precondicoes:
      - permissao: "GES.ENDERECOS_ENTREGA.SET_DEFAULT"

    gatilho: "Usuario clica em Estrela"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "clicar_estrela"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "validar_tenant"
      - passo: 4
        ator: "sistema"
        acao: "exibir_modal_confirmacao"
      - passo: 5
        ator: "usuario"
        acao: "confirmar"
      - passo: 6
        ator: "sistema"
        acao: "iniciar_transacao"
      - passo: 7
        ator: "sistema"
        acao: "desmarcar_anterior"
      - passo: 8
        ator: "sistema"
        acao: "marcar_novo"
      - passo: 9
        ator: "sistema"
        acao: "registrar_auditoria_ambos"
      - passo: 10
        ator: "sistema"
        acao: "commit_transacao"

    fluxos_excecao:
      - id: "FE-UC05-01"
        condicao: "ja_padrao"
        resultado: "mensagem_informativa"
      - id: "FE-UC05-02"
        condicao: "erro_transacao"
        resultado: "rollback_http_500"

    regras_aplicadas:
      - "RN-RF043-004"  # Apenas 1 endereço padrão por ClienteId

    resultado_final:
      estado: "endereco_padrao_definido"

  - id: "UC06"
    nome: "Calcular Frete"
    ator_principal: "usuario_autenticado"
    tipo: "acao"
    impacta_dados: false

    covers:
      rf_items:
        - "RN-RF043-003"  # Cálculo Automático de Frete com Múltiplas Transportadoras
      uc_items:
        - id: "FP-UC06-001"
          title: "Usuário acessa página de cálculo de frete"
          required: true
        - id: "FP-UC06-002"
          title: "Sistema valida permissão"
          required: true
        - id: "FP-UC06-003"
          title: "Sistema exibe formulário (CEP Destino, Peso, Dimensões, Valor Declarado)"
          required: true
        - id: "FP-UC06-004"
          title: "Usuário preenche campos e clica em Calcular Frete"
          required: true
        - id: "FP-UC06-005"
          title: "Sistema valida campos obrigatórios e ranges"
          required: true
        - id: "FP-UC06-006"
          title: "Sistema verifica cache (6 horas)"
          required: true
        - id: "FP-UC06-007"
          title: "Sistema dispara consulta paralela (Task.WhenAll) para APIs de transportadoras"
          required: true
        - id: "FP-UC06-008"
          title: "Sistema aguarda resposta de todas as APIs (timeout 10s cada)"
          required: true
        - id: "FP-UC06-009"
          title: "Sistema agrega resultados e ordena por custo-benefício"
          required: true
        - id: "FP-UC06-010"
          title: "Sistema exibe tabela comparativa"
          required: true
        - id: "FA-UC06-001"
          title: "Cache hit → retornar do cache"
          required: false
        - id: "FA-UC06-002"
          title: "Selecionar transportadora"
          required: false
        - id: "FE-UC06-001"
          title: "Validação falha → HTTP 400"
          required: true
        - id: "FE-UC06-002"
          title: "Todas as APIs falharam → permitir entrada manual"
          required: true
        - id: "FE-UC06-003"
          title: "API parcialmente indisponível → valores parciais"
          required: true

    precondicoes:
      - permissao: "GES.ENDERECOS_ENTREGA.VIEW"

    gatilho: "Usuario acessa calculo de frete"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessar_calculo_frete"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "exibir_formulario"
      - passo: 4
        ator: "usuario"
        acao: "preencher_calcular"
      - passo: 5
        ator: "sistema"
        acao: "validar_campos_ranges"
      - passo: 6
        ator: "sistema"
        acao: "verificar_cache"
      - passo: 7
        ator: "sistema"
        acao: "consultar_apis_paralelo"
      - passo: 8
        ator: "sistema"
        acao: "agregar_ordenar"
      - passo: 9
        ator: "sistema"
        acao: "exibir_tabela_comparativa"

    fluxos_alternativos:
      - id: "FA-UC06-01"
        condicao: "cache_hit"
        resultado: "retornar_cache"

    fluxos_excecao:
      - id: "FE-UC06-01"
        condicao: "validacao_falhou"
        resultado: "http_400"
      - id: "FE-UC06-02"
        condicao: "todas_apis_falharam"
        resultado: "entrada_manual"

    regras_aplicadas:
      - "RN-RF043-003"  # Cálculo de frete paralelo com cache 6h

    resultado_final:
      estado: "frete_calculado"

  - id: "UC07"
    nome: "Rastrear Entrega"
    ator_principal: "usuario_autenticado"
    tipo: "acao"
    impacta_dados: false

    covers:
      rf_items:
        - "RN-RF043-006"  # Notificações de Rastreamento em Tempo Real
      uc_items:
        - id: "FP-UC07-001"
          title: "Usuário acessa página de rastreamento (via histórico de entrega)"
          required: true
        - id: "FP-UC07-002"
          title: "Sistema valida permissão GES.ENDERECOS_ENTREGA.VIEW_HISTORY"
          required: true
        - id: "FP-UC07-003"
          title: "Sistema carrega histórico de entrega"
          required: true
        - id: "FP-UC07-004"
          title: "Sistema carrega eventos de rastreamento ordenados"
          required: true
        - id: "FP-UC07-005"
          title: "Sistema estabelece conexão SignalR para notificações em tempo real"
          required: true
        - id: "FP-UC07-006"
          title: "Sistema exibe timeline visual de eventos"
          required: true
        - id: "FP-UC07-007"
          title: "Sistema exibe dados (Transportadora, Código Rastreio, Status, Última Atualização, Local)"
          required: true
        - id: "FA-UC07-001"
          title: "Receber notificação de novo evento via webhook"
          required: false
        - id: "FA-UC07-002"
          title: "Polling manual (fallback) via Hangfire"
          required: false
        - id: "FE-UC07-001"
          title: "Código de rastreio inválido → HTTP 404"
          required: true
        - id: "FE-UC07-002"
          title: "Webhook com signature inválida → HTTP 401"
          required: true
        - id: "FE-UC07-003"
          title: "Evento duplicado → ignorar (idempotência)"
          required: true

    precondicoes:
      - permissao: "GES.ENDERECOS_ENTREGA.VIEW_HISTORY"

    gatilho: "Usuario acessa rastreamento"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessar_rastreamento"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "carregar_historico"
      - passo: 4
        ator: "sistema"
        acao: "carregar_eventos_rastreamento"
      - passo: 5
        ator: "sistema"
        acao: "conectar_signalr"
      - passo: 6
        ator: "sistema"
        acao: "exibir_timeline"

    fluxos_alternativos:
      - id: "FA-UC07-01"
        condicao: "webhook_recebido"
        resultado: "atualizar_timeline_tempo_real"
      - id: "FA-UC07-02"
        condicao: "webhook_falha"
        resultado: "polling_hangfire_1h"

    fluxos_excecao:
      - id: "FE-UC07-01"
        condicao: "rastreio_invalido"
        resultado: "http_404"
      - id: "FE-UC07-02"
        condicao: "signature_invalida"
        resultado: "http_401"
      - id: "FE-UC07-03"
        condicao: "evento_duplicado"
        resultado: "ignorar_idempotencia"

    regras_aplicadas:
      - "RN-RF043-006"  # Rastreamento em tempo real via webhooks com HMAC-SHA256

    resultado_final:
      estado: "rastreamento_exibido"

  - id: "UC08"
    nome: "Visualizar Mapa de Calor"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      rf_items:
        - "RN-RF043-007"  # Mapa de Calor de Entregas por Região
      uc_items:
        - id: "FP-UC08-001"
          title: "Usuário acessa dashboard Mapa de Calor de Entregas"
          required: true
        - id: "FP-UC08-002"
          title: "Sistema valida permissão GES.ENDERECOS_ENTREGA.VIEW"
          required: true
        - id: "FP-UC08-003"
          title: "Sistema agrega entregas por coordenadas geográficas (3 casas decimais)"
          required: true
        - id: "FP-UC08-004"
          title: "Sistema aplica filtro padrão (último mês, status Entregue)"
          required: true
        - id: "FP-UC08-005"
          title: "Sistema carrega dados agregados (máximo 10.000 pontos)"
          required: true
        - id: "FP-UC08-006"
          title: "Sistema renderiza mapa de calor usando Google Maps Heatmap Layer"
          required: true
        - id: "FP-UC08-007"
          title: "Sistema aplica cores (Verde <10, Amarelo 10-50, Vermelho >50)"
          required: true
        - id: "FP-UC08-008"
          title: "Sistema exibe filtros (Período, Status, Transportadora)"
          required: true
        - id: "FA-UC08-001"
          title: "Aplicar filtros"
          required: false
        - id: "FA-UC08-002"
          title: "Clique em região → exibir estatísticas"
          required: false
        - id: "FE-UC08-001"
          title: "Mais de 10.000 pontos → agregar por CEP"
          required: true
        - id: "FE-UC08-002"
          title: "Nenhuma entrega no período → mapa vazio"
          required: true

    precondicoes:
      - permissao: "GES.ENDERECOS_ENTREGA.VIEW"

    gatilho: "Usuario acessa dashboard mapa calor"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessar_mapa_calor"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "agregar_coordenadas_3_casas_decimais"
      - passo: 4
        ator: "sistema"
        acao: "aplicar_filtro_padrao"
      - passo: 5
        ator: "sistema"
        acao: "carregar_dados_agregados"
      - passo: 6
        ator: "sistema"
        acao: "renderizar_mapa_calor"
      - passo: 7
        ator: "sistema"
        acao: "aplicar_cores"

    fluxos_alternativos:
      - id: "FA-UC08-01"
        condicao: "usuario_aplica_filtros"
        resultado: "recarregar_dados"
      - id: "FA-UC08-02"
        condicao: "clique_regiao"
        resultado: "exibir_estatisticas_modal"

    fluxos_excecao:
      - id: "FE-UC08-01"
        condicao: "mais_10000_pontos"
        resultado: "agregar_por_cep"
      - id: "FE-UC08-02"
        condicao: "nenhuma_entrega"
        resultado: "mapa_vazio"

    regras_aplicadas:
      - "RN-RF043-007"  # Mapa de calor com agregação 3 casas decimais e máximo 10.000 pontos

    resultado_final:
      estado: "mapa_calor_exibido"

  - id: "UC09"
    nome: "Exportar Relatório de Entregas"
    ator_principal: "usuario_autenticado"
    tipo: "acao"
    impacta_dados: false

    covers:
      rf_items:
        - "RN-RF043-010"  # Exportação de Relatório de Entregas
      uc_items:
        - id: "FP-UC09-001"
          title: "Usuário clica em Exportar Relatório na listagem de entregas"
          required: true
        - id: "FP-UC09-002"
          title: "Sistema valida permissão GES.ENDERECOS_ENTREGA.VIEW"
          required: true
        - id: "FP-UC09-003"
          title: "Sistema exibe modal com filtros (Formato, Período, Status, Endereço, Transportadora)"
          required: true
        - id: "FP-UC09-004"
          title: "Usuário seleciona filtros e clica em Gerar Relatório"
          required: true
        - id: "FP-UC09-005"
          title: "Sistema valida filtros (período máximo 1 ano, máximo 10.000 registros)"
          required: true
        - id: "FP-UC09-006"
          title: "Sistema executa query com filtros aplicados"
          required: true
        - id: "FP-UC09-007"
          title: "Se Excel: sistema usa EPPlus para gerar .xlsx com formatação condicional"
          required: true
        - id: "FP-UC09-008"
          title: "Se PDF: sistema usa QuestPDF para gerar .pdf com tabela formatada"
          required: true
        - id: "FP-UC09-009"
          title: "Sistema calcula totalizadores (total entregas, entregues, devolvidas, custos, avaliação)"
          required: true
        - id: "FP-UC09-010"
          title: "Sistema adiciona footer (Gerado em: data | Usuário: nome)"
          required: true
        - id: "FP-UC09-011"
          title: "Sistema retorna arquivo para download (Content-Disposition: attachment)"
          required: true
        - id: "FA-UC09-001"
          title: "Cancelar exportação"
          required: false
        - id: "FE-UC09-001"
          title: "Período maior que 1 ano → HTTP 400"
          required: true
        - id: "FE-UC09-002"
          title: "Mais de 10.000 registros → HTTP 400"
          required: true
        - id: "FE-UC09-003"
          title: "Nenhum registro encontrado → HTTP 400"
          required: true

    precondicoes:
      - permissao: "GES.ENDERECOS_ENTREGA.VIEW"

    gatilho: "Usuario clica em Exportar Relatorio"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "clicar_exportar"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "exibir_modal_filtros"
      - passo: 4
        ator: "usuario"
        acao: "selecionar_filtros_gerar"
      - passo: 5
        ator: "sistema"
        acao: "validar_filtros"
      - passo: 6
        ator: "sistema"
        acao: "executar_query"
      - passo: 7
        ator: "sistema"
        acao: "gerar_arquivo_formato_selecionado"
      - passo: 8
        ator: "sistema"
        acao: "calcular_totalizadores"
      - passo: 9
        ator: "sistema"
        acao: "adicionar_footer"
      - passo: 10
        ator: "sistema"
        acao: "retornar_download"

    fluxos_excecao:
      - id: "FE-UC09-01"
        condicao: "periodo_maior_1ano"
        resultado: "http_400"
      - id: "FE-UC09-02"
        condicao: "mais_10000_registros"
        resultado: "http_400"
      - id: "FE-UC09-03"
        condicao: "nenhum_registro"
        resultado: "http_400"

    regras_aplicadas:
      - "RN-RF043-010"  # Exportação Excel/PDF com período máximo 1 ano e limite 10.000 registros

    resultado_final:
      estado: "relatorio_exportado"

exclusions:
  uc_items: []

historico:
  - versao: "2.0"
    data: "2025-12-31"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Versão canônica orientada a contrato com cobertura completa das 10 regras de negócio do RF043"
