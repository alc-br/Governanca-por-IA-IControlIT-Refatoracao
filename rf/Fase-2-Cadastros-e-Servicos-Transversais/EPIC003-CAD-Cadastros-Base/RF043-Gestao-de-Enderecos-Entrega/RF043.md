# RF043 - Gestão de Endereços de Entrega

**Versão:** 2.0
**Fase:** 2 - Cadastros e Serviços Transversais
**EPIC:** EPIC003-CAD-Cadastros-Base
**Módulo:** Cadastros Base
**Data Criação:** 2025-12-17
**Data Migração v2.0:** 2025-12-30
**Status:** Especificação Completa (Governance v2.0)

---

## SEÇÃO 1: VISÃO GERAL

### 1.1 Objetivo

Implementar sistema completo de gerenciamento de endereços de entrega para solicitações de compras, pedidos de ativos e entregas de equipamentos, com validação automática de CEP via API, geocodificação, integração com transportadoras, cálculo de frete, rastreamento em tempo real e histórico completo de entregas.

### 1.2 Importância Estratégica

A gestão eficaz de endereços de entrega é crucial para:

- **Precisão Logística:** Garantir que equipamentos cheguem no local correto sem retrabalho ou devolução
- **Redução de Custos:** Calcular frete automaticamente e escolher a transportadora mais econômica
- **Rastreabilidade:** Manter histórico completo de entregas por endereço com evidências fotográficas
- **Compliance:** Validar CEP, endereço e coordenadas geográficas antes da entrega
- **Experiência do Usuário:** Permitir busca rápida de endereços salvos e reutilização em novas solicitações
- **Análise Gerencial:** Identificar endereços com maior volume de entregas e otimização de rotas

### 1.3 Escopo

**Inclui:**
- Cadastro de endereços com validação automática de CEP (ViaCEP)
- Geocodificação automática (latitude/longitude) via Google Maps API
- Integração com APIs de transportadoras (Correios, Jadlog, Total Express)
- Cálculo automático de frete e prazo de entrega
- Gestão de múltiplos endereços por empresa com endereço padrão configurável
- Histórico completo de entregas por endereço
- Mapa visual com Google Maps/OpenStreetMap
- Notificações de rastreamento em tempo real via SignalR
- Mapa de calor de entregas por região
- Autocomplete de endereços salvos
- Exportação de relatórios em Excel/PDF

**Exclui:**
- Gestão de rotas de entrega (será abordado em RF futuro)
- Integração com sistemas de frotas (escopo de outro módulo)
- Contratação automática de transportadoras (processo manual)

---

## SEÇÃO 2: FUNCIONALIDADES

### 2.1 Cadastro e Validação Automática de CEP

**Descrição:** Ao digitar o CEP, o sistema busca automaticamente na API ViaCEP e preenche logradouro, bairro, cidade e UF.

**Fluxo:**
1. Usuário digita CEP (8 dígitos)
2. Sistema formata automaticamente (12345678 → 12345-678)
3. Após 500ms (debounce), dispara requisição para ViaCEP
4. Se sucesso: preenche logradouro, bairro, cidade, UF, IBGE
5. Se falha: tenta API alternativa (PostMon, BrasilAPI)
6. Se todas falharem: permite preenchimento manual com aviso

**Exemplo de Resposta ViaCEP:**
```json
{
  "cep": "01310-100",
  "logradouro": "Avenida Paulista",
  "bairro": "Bela Vista",
  "localidade": "São Paulo",
  "uf": "SP",
  "ibge": "3550308"
}
```

### 2.2 Geocodificação e Mapeamento Visual

**Descrição:** Endereço completo é convertido automaticamente em coordenadas geográficas (latitude/longitude) para exibição em mapa e cálculo de distâncias.

**Fluxo:**
1. Após salvar endereço, sistema envia requisição para Google Maps Geocoding API
2. Recebe latitude, longitude e precisão (ROOFTOP, RANGE_INTERPOLATED)
3. Armazena coordenadas no banco de dados
4. Exibe marcador no mapa interativo (Google Maps ou OpenStreetMap)
5. Permite cálculo de distância entre origem (matriz) e destino

**Precisão:**
- ROOFTOP: Máxima precisão (endereço exato)
- RANGE_INTERPOLATED: Interpolação entre dois pontos
- GEOMETRIC_CENTER: Centro geométrico (menos preciso)

### 2.3 Integração com APIs de Transportadoras

**Descrição:** Sistema consulta automaticamente APIs de transportadoras (Correios, Jadlog, Total Express) e retorna prazo e valor de frete para cada modalidade.

**Transportadoras Integradas:**
- **Correios:** PAC, SEDEX, SEDEX 10, SEDEX Hoje
- **Jadlog:** .Package, .Com, .Corporate
- **Total Express:** Convencional, Econômico, Rodoviário

**Parâmetros de Cálculo:**
- CEP origem (empresa matriz)
- CEP destino (endereço de entrega)
- Peso (kg)
- Dimensões (altura × largura × profundidade em cm)
- Valor declarado (para seguro)

**Resultado:**
- Prazo de entrega (dias úteis)
- Valor do frete (R$)
- Valor do seguro (R$)
- Total (frete + seguro)
- Ordenação: mais barato → mais rápido → melhor custo-benefício

### 2.4 Gestão de Múltiplos Endereços

**Descrição:** Permite cadastrar ilimitados endereços por empresa/filial com categorização e endereço padrão configurável.

**Categorias Disponíveis:**
- Matriz
- Filial
- Depósito
- Home Office
- Temporário

**Recursos:**
- Endereço padrão por tipo de solicitação (pré-selecionado automaticamente)
- Busca rápida por CEP, cidade, bairro, nome fantasia
- Autocomplete ao digitar (mínimo 3 caracteres)
- Favoritos para endereços mais usados
- Regra: apenas 1 endereço padrão por empresa/filial

### 2.5 Histórico de Entregas por Endereço

**Descrição:** Registra todas as entregas realizadas em cada endereço com status, evidências, problemas e avaliação do recebedor.

**Informações Rastreadas:**
- Código da solicitação
- Data de envio, previsão e entrega real
- Transportadora e código de rastreio
- Status: Entregue, Em Trânsito, Devolvido, Extraviado
- Evidências: foto da entrega, assinatura digital, comprovante PDF
- Avaliação do recebedor (1-5 estrelas)
- Problemas reportados: endereço incorreto, portaria fechada, ausência

**Estatísticas por Endereço:**
- Taxa de sucesso de entrega (%)
- Tempo médio de entrega (dias úteis)
- Custo médio de frete (R$)
- Problemas recorrentes (alertas)

### 2.6 Notificações de Rastreamento em Tempo Real

**Descrição:** Sistema se integra com webhooks de transportadoras e envia notificações automáticas a cada mudança de status da entrega.

**Eventos Rastreados:**
- Postado → Em Trânsito → Saiu para Entrega → Entregue
- Tentativa de Entrega → Endereço Incorreto → Devolvido

**Canais de Notificação:**
- SignalR (push no navegador em tempo real)
- E-mail (para solicitante e destinatário)
- SMS (opcional, apenas para eventos críticos: "Saiu para Entrega" e "Entregue")

**Segurança:**
- Webhooks validam signature (HMAC) para evitar falsificação
- Fallback: se webhook falhar, polling a cada 1 hora

### 2.7 Mapa de Calor de Entregas por Região

**Descrição:** Dashboard exibe mapa de calor mostrando concentração de entregas por bairro/cidade para análise estratégica de logística.

**Visualização:**
- Verde: baixa concentração (<10 entregas/mês)
- Amarelo: média concentração (10-50 entregas/mês)
- Vermelho: alta concentração (>50 entregas/mês)

**Recursos:**
- Filtros: período, status (entregue/devolvido), transportadora
- Clique na região: lista de endereços e estatísticas
- Insights automáticos: sugestões de depósitos próximos, análise de taxa de sucesso por região

### 2.8 Autocomplete de Endereços Salvos

**Descrição:** Campo de busca com autocomplete exibe sugestões de endereços salvos conforme usuário digita CEP, cidade, bairro ou nome fantasia.

**Características:**
- Trigger: após 3 caracteres digitados
- Busca fuzzy (aceita erros de digitação)
- Campos pesquisados: CEP, logradouro, bairro, cidade, nome fantasia, referência
- Ordenação: endereços mais usados primeiro
- Destaque: termo buscado em negrito
- Máximo 10 resultados exibidos
- Debounce 300ms para evitar buscas excessivas

### 2.9 Validação de Endereço Duplicado

**Descrição:** Antes de salvar novo endereço, sistema verifica se já existe endereço idêntico ou muito similar para evitar duplicatas.

**Critérios de Similaridade:**
- CEP exato
- Logradouro, número, bairro, cidade (fuzzy match ≥90% similaridade)

**Fluxo:**
1. Usuário clica "Salvar"
2. Sistema busca endereços com CEP + número iguais
3. Se encontrado: exibe modal "Endereço similar encontrado. Deseja reutilizar?"
4. Opções: Reutilizar Existente | Salvar Novo | Cancelar
5. Log de tentativa de duplicação para auditoria

### 2.10 Exportação de Relatório de Entregas

**Descrição:** Sistema permite exportar relatório completo de entregas em Excel/PDF com filtros personalizados.

**Formatos:** Excel (.xlsx), PDF (.pdf)

**Filtros Disponíveis:**
- Período (data início - data fim, máximo 1 ano)
- Status (Entregue, Em Trânsito, Devolvido)
- Endereço (dropdown)
- Transportadora
- Solicitante

**Colunas do Relatório:**
- Código Solicitação
- Data Envio, Previsão, Entrega Real
- Endereço Completo
- Transportadora, Código Rastreio
- Status, Avaliação (estrelas)
- Custo Frete (R$)

**Totalizadores:**
- Total de entregas
- Entregues (quantidade e %)
- Devolvidas (quantidade e %)
- Custo total de frete (R$)
- Custo médio (R$)
- Avaliação média (estrelas)

---

## SEÇÃO 3: REGRAS DE NEGÓCIO

### RN-RF043-001: Validação Automática de CEP via ViaCEP

**Descrição:** Ao digitar o CEP, sistema busca automaticamente na API ViaCEP e preenche logradouro, bairro, cidade e UF.

**Regra:**
- CEP deve ter exatamente 8 dígitos numéricos (sem traço)
- Trigger: onChange após 8 dígitos digitados
- Debounce: 500ms para evitar requisições excessivas
- Se ViaCEP retornar `{"erro": true}`, CEP é inválido
- Timeout máximo: 5 segundos
- Fallback: se ViaCEP falhar, usar PostMon (http://api.postmon.com.br/v1/cep/{cep})
- Se ambos falharem: permitir preenchimento manual com aviso "CEP não encontrado - verifique se está correto"
- Formatação automática: 12345678 → 12345-678

**Criticidade:** CRÍTICA

**Implementação:**
- Backend: HttpClient com Polly (retry 3x, timeout 5s)
- Frontend: rxjs debounceTime(500), distinctUntilChanged()

---

### RN-RF043-002: Geocodificação Automática com Google Maps API

**Descrição:** Endereço completo é convertido automaticamente em coordenadas geográficas (latitude/longitude) para exibição em mapa e cálculo de distâncias.

**Regra:**
- Geocodificação ocorre automaticamente após salvar endereço ou ao modificá-lo
- Entrada: endereço completo formatado (rua, número, bairro, cidade, UF, CEP)
- Saída: latitude (DECIMAL(10,8)), longitude (DECIMAL(11,8)), precisão
- Status da API deve ser "OK"
- Latitude deve estar entre -90 e +90
- Longitude deve estar entre -180 e +180
- Precisão "ROOFTOP" ou "RANGE_INTERPOLATED" são aceitáveis
- Fallback: se Google Maps falhar, usar OpenStreetMap Nominatim

**Criticidade:** ALTA

**Implementação:**
- Backend: Google Maps Geocoding API
- Armazenamento: campos Latitude, Longitude, Precisao, PlaceId
- Frontend: Exibição em Google Maps com zoom 17 (nível de rua)

---

### RN-RF043-003: Cálculo Automático de Frete com Múltiplas Transportadoras

**Descrição:** Sistema consulta automaticamente APIs de transportadoras (Correios, Jadlog, Total Express) e retorna prazo e valor de frete para cada modalidade.

**Regra:**
- Consulta paralela a todas as APIs (processamento assíncrono)
- Parâmetros obrigatórios: CEP origem, CEP destino, peso (kg), dimensões (cm), valor declarado (R$)
- CEP origem e destino devem ser válidos (8 dígitos)
- Peso deve ser >0 e <100 kg (limite transportadoras)
- Dimensões devem ser >0 e soma (altura + largura + profundidade) ≤200 cm
- Ordenação: mais barato → mais rápido → melhor custo-benefício
- Cache: 6 horas para evitar requisições repetidas (mesmo CEP origem/destino + peso + dimensões)
- Se todas as APIs falharem, exibir aviso e permitir frete manual

**Criticidade:** ALTA

**Implementação:**
- Backend: HttpClient com Polly (retry, timeout), Task.WhenAll para paralelismo
- Frontend: Tabela comparativa com ordenação dinâmica

---

### RN-RF043-004: Endereço Padrão por Tipo de Solicitação

**Descrição:** Usuário pode marcar um endereço como "Padrão" para ser pré-selecionado automaticamente em novas solicitações de compra/entrega.

**Regra:**
- Campo boolean: `FlEnderecoPadrao` na tabela `EnderecoEntrega`
- Apenas 1 endereço pode ser padrão por empresa/filial (conglomerado)
- Ao marcar novo endereço como padrão, sistema desmarca o anterior automaticamente via UPDATE
- Formulários de solicitação pré-selecionam endereço padrão
- Usuário pode alterar manualmente se necessário
- Endereço padrão não pode ser excluído (validação: se FlEnderecoPadrao=1 e FlExcluido=1, retornar erro 400 "Endereço padrão não pode ser excluído. Defina outro como padrão primeiro")

**Criticidade:** MÉDIA

**Implementação:**
- Backend: FluentValidation custom rule, transação para garantir apenas 1 padrão
- Frontend: Toggle star icon, confirmação ao alterar

---

### RN-RF043-005: Histórico Completo de Entregas por Endereço

**Descrição:** Sistema registra todas as entregas realizadas em cada endereço com status, evidências, problemas e avaliação do recebedor.

**Regra:**
- Tabela: `EntregaHistorico` com FK para `EnderecoEntrega` e `Solicitacao`
- Campos obrigatórios: EnderecoEntregaId, SolicitacaoId, DataEnvio, Status, Transportadora
- Status: ENUM (Entregue, EmTransito, Devolvido, Extraviado)
- Evidências opcionais mas recomendadas: EvidenciaFotoUrl, AssinaturaDigitalUrl, ComprovanteUrl
- Avaliação: 1-5 estrelas (opcional, preenchida após entrega)
- ProblemaReportado: texto livre (máximo 500 caracteres)
- Registro de entrega obrigatório ao finalizar solicitação com entrega física
- Query: listar últimas 10 entregas ao visualizar endereço

**Criticidade:** ALTA

**Implementação:**
- Backend: Entidade EntregaHistorico, Command CreateEntregaHistoricoCommand
- Frontend: Timeline visual com ícones por status

---

### RN-RF043-006: Notificações de Rastreamento em Tempo Real

**Descrição:** Sistema se integra com webhooks de transportadoras e envia notificações automáticas a cada mudança de status da entrega.

**Regra:**
- Webhooks configurados nas transportadoras (URLs: /api/webhooks/rastreamento/correios, /jadlog, /totalexpress)
- Eventos capturados: Postado, EmTransito, SaiuParaEntrega, Entregue, TentativaEntrega, EnderecoIncorreto, Devolvido
- Webhook deve conter signature válida (HMAC-SHA256) para segurança
- Código de rastreio deve existir no sistema (validação)
- Evento duplicado (mesmo timestamp) é ignorado (idempotência)
- Notificações enviadas via SignalR (push), e-mail (eventos importantes), SMS (apenas "SaiuParaEntrega" e "Entregue")
- Persistência: tabela `RastreamentoEvento` com FK para `EntregaHistorico`
- Fallback: se webhook falhar, polling a cada 1 hora via Hangfire

**Criticidade:** MÉDIA

**Implementação:**
- Backend: SignalR Hub, HangfireJob para polling, validação HMAC
- Frontend: Toast notifications, sound alert (configurável)

---

### RN-RF043-007: Mapa de Calor de Entregas por Região

**Descrição:** Dashboard exibe mapa de calor mostrando concentração de entregas por bairro/cidade para análise estratégica de logística.

**Regra:**
- Biblioteca: Google Maps Heatmap Layer ou Leaflet + Heatmap.js
- Dados: agregação de entregas por coordenadas geográficas (lat/long)
- Coordenadas devem estar válidas (não nulas)
- Agregação por precisão: 3 casas decimais (~100m de raio)
- Cores: Verde (<10 entregas/mês), Amarelo (10-50), Vermelho (>50)
- Filtros: período, status (entregue/devolvido), transportadora
- Clique na região: lista de endereços e estatísticas
- Performance: máximo 10.000 pontos no mapa (se >10.000, agregar por CEP)

**Criticidade:** BAIXA

**Implementação:**
- Backend: Query com GROUP BY ROUND(Latitude, 3), ROUND(Longitude, 3)
- Frontend: Google Maps Heatmap Layer, filtros com RxJS

---

### RN-RF043-008: Autocomplete de Endereços Salvos

**Descrição:** Campo de busca com autocomplete exibe sugestões de endereços salvos conforme usuário digita CEP, cidade, bairro ou nome fantasia.

**Regra:**
- Trigger: após 3 caracteres digitados
- Debounce: 300ms para evitar buscas excessivas
- Busca fuzzy: algoritmo Levenshtein (aceita erros de digitação)
- Campos pesquisados: CEP, Logradouro, Bairro, Cidade, NomeFantasia, Referencia
- Ordenação: endereços mais usados primeiro (COUNT entregas DESC)
- Máximo 10 resultados exibidos
- Endereços inativos (FlExcluido=1) não aparecem
- Destaque: termo buscado em negrito no resultado

**Criticidade:** MÉDIA

**Implementação:**
- Backend: Query com LIKE, FuzzySharp library para Levenshtein
- Frontend: Angular Material Autocomplete, rxjs debounceTime

---

### RN-RF043-009: Validação de Endereço Duplicado

**Descrição:** Antes de salvar novo endereço, sistema verifica se já existe endereço idêntico ou muito similar para evitar duplicatas.

**Regra:**
- Verificação ao clicar "Salvar": busca por CEP exato + Número + ClienteId
- Fuzzy match: algoritmo Levenshtein (≥90% similaridade) para Logradouro, Bairro, Cidade
- Se encontrado: exibir modal "Endereço similar encontrado. Deseja reutilizar?"
- Opções: Reutilizar Existente | Salvar Novo | Cancelar
- Log de tentativa de duplicação para auditoria (tabela AuditLog)
- Endereços excluídos (FlExcluido=1) ignorados na busca

**Criticidade:** MÉDIA

**Implementação:**
- Backend: FluentValidation custom rule, FuzzySharp library
- Frontend: Modal de confirmação, destaque das diferenças

---

### RN-RF043-010: Exportação de Relatório de Entregas

**Descrição:** Sistema permite exportar relatório completo de entregas em Excel/PDF com filtros personalizados.

**Regra:**
- Formatos: Excel (.xlsx) via EPPlus, PDF (.pdf) via QuestPDF
- Período máximo: 1 ano (365 dias)
- Máximo 10.000 registros por exportação
- Se >10.000, sugerir filtrar mais ou gerar em lote (paginação)
- Excel: formatação condicional (verde=entregue, vermelho=devolvido, amarelo=em trânsito)
- Colunas: Código, DataEnvio, DataPrevisao, DataEntrega, Endereço, Transportadora, Rastreio, Status, Avaliacao, CustoFrete
- Totalizadores: TotalEntregas, Entregues (qtd e %), Devolvidas (qtd e %), CustoTotal, CustoMedio, AvaliacaoMedia
- Footer: "Gerado em: {DateTime.Now} | Usuário: {userName}"

**Criticidade:** BAIXA

**Implementação:**
- Backend: Query exportação, EPPlus, QuestPDF
- Frontend: Botão "Exportar", modal de confirmação com filtros

---

## SEÇÃO 4: INTEGRAÇÕES OBRIGATÓRIAS

### 4.1 Central de Funcionalidades

**Registro Obrigatório:**
```yaml
feature_code: GES.ENDERECOS_ENTREGA
feature_name: Gestão de Endereços de Entrega
module: Gestão
description: Sistema completo de gerenciamento de endereços com validação CEP, geocodificação e rastreamento
enabled_by_default: true
```

### 4.2 Internacionalização (i18n)

**Namespace:** `ges.enderecosEntrega`

**Chaves Obrigatórias:**
```json
{
  "ges.enderecosEntrega": {
    "title": "Gestão de Endereços de Entrega",
    "subtitle": "Gerencie endereços com validação automática e rastreamento",
    "fields": {
      "cep": "CEP",
      "logradouro": "Logradouro",
      "numero": "Número",
      "complemento": "Complemento",
      "bairro": "Bairro",
      "cidade": "Cidade",
      "uf": "UF",
      "latitude": "Latitude",
      "longitude": "Longitude",
      "enderecoPadrao": "Endereço Padrão"
    },
    "messages": {
      "cepValidado": "CEP validado com sucesso!",
      "cepInvalido": "CEP inválido ou não encontrado",
      "enderecoSalvo": "Endereço salvo com sucesso!",
      "duplicataDetectada": "Endereço similar encontrado. Deseja reutilizar?"
    }
  }
}
```

**Idiomas Suportados:** pt-BR (primário), en-US, es-ES

### 4.3 Auditoria

**Campos Obrigatórios em Todas as Tabelas:**
- `CriadoPor` (NVARCHAR(450)) - Usuário que cadastrou
- `CriadoEm` (DATETIME2) - Data/hora criação
- `AlteradoPor` (NVARCHAR(450)) - Último usuário que editou
- `AlteradoEm` (DATETIME2) - Data/hora última edição
- `FlExcluido` (BIT) - Soft delete (0 = ativo, 1 = excluído)

**Shadow Properties EF Core:**
- Valores antes/depois da modificação (JSON serializado)

### 4.4 Controle de Acesso (RBAC)

**Módulo:** `GES.ENDERECOS_ENTREGA`

**Permissões:**
| Código | Descrição | Roles Padrão |
|--------|-----------|--------------|
| `GES.ENDERECOS_ENTREGA.VIEW` | Visualizar endereços | Todos |
| `GES.ENDERECOS_ENTREGA.CREATE` | Cadastrar endereços | Solicitante, Comprador |
| `GES.ENDERECOS_ENTREGA.EDIT` | Editar endereços | Comprador, Gestor |
| `GES.ENDERECOS_ENTREGA.DELETE` | Excluir endereços (soft delete) | Gestor, Super Admin |
| `GES.ENDERECOS_ENTREGA.SET_DEFAULT` | Marcar endereço padrão | Comprador, Gestor |
| `GES.ENDERECOS_ENTREGA.VIEW_HISTORY` | Ver histórico de entregas | Comprador, Gestor, Auditor |

---

## SEÇÃO 5: PERMISSÕES RBAC

(Detalhamento completo na Seção 4.4)

---

## SEÇÃO 6: API ENDPOINTS

### 6.1 Gestão de Endereços

**GET /api/v1/enderecos-entrega**
- Descrição: Listar endereços com paginação e filtros
- Autenticação: Obrigatória
- Autorização: `GES.ENDERECOS_ENTREGA.VIEW`
- Request DTO: `GetEnderecosEntregaQuery`
- Response DTO: `PaginatedListDto<EnderecoEntregaDto>`

**GET /api/v1/enderecos-entrega/{id}**
- Descrição: Obter endereço por ID
- Autenticação: Obrigatória
- Autorização: `GES.ENDERECOS_ENTREGA.VIEW`
- Response DTO: `EnderecoEntregaDto`

**POST /api/v1/enderecos-entrega**
- Descrição: Criar novo endereço
- Autenticação: Obrigatória
- Autorização: `GES.ENDERECOS_ENTREGA.CREATE`
- Request DTO: `CreateEnderecoEntregaCommand`
- Response DTO: `Guid` (ID do endereço criado)

**PUT /api/v1/enderecos-entrega/{id}**
- Descrição: Atualizar endereço existente
- Autenticação: Obrigatória
- Autorização: `GES.ENDERECOS_ENTREGA.EDIT`
- Request DTO: `UpdateEnderecoEntregaCommand`
- Response DTO: `Unit`

**DELETE /api/v1/enderecos-entrega/{id}**
- Descrição: Excluir endereço (soft delete)
- Autenticação: Obrigatória
- Autorização: `GES.ENDERECOS_ENTREGA.DELETE`
- Response DTO: `Unit`

### 6.2 Validação e Geocodificação

**GET /api/v1/enderecos-entrega/validar-cep/{cep}**
- Descrição: Validar CEP via ViaCEP
- Autenticação: Obrigatória
- Autorização: `GES.ENDERECOS_ENTREGA.VIEW`
- Response DTO: `ValidacaoCepDto` (logradouro, bairro, cidade, uf, ibge)

**POST /api/v1/enderecos-entrega/geocodificar**
- Descrição: Geocodificar endereço (obter lat/long)
- Autenticação: Obrigatória
- Autorização: `GES.ENDERECOS_ENTREGA.CREATE`
- Request DTO: `GeocodificarEnderecoCommand`
- Response DTO: `GeocodificacaoDto` (latitude, longitude, precisao)

### 6.3 Histórico e Rastreamento

**GET /api/v1/enderecos-entrega/{id}/historico**
- Descrição: Obter histórico de entregas do endereço
- Autenticação: Obrigatória
- Autorização: `GES.ENDERECOS_ENTREGA.VIEW_HISTORY`
- Response DTO: `List<EntregaHistoricoDto>`

**POST /api/webhooks/rastreamento/{transportadora}**
- Descrição: Receber webhook de transportadora
- Autenticação: Signature HMAC-SHA256
- Request DTO: `WebhookRastreamentoDto`
- Response DTO: `Unit`

### 6.4 Relatórios e Exportação

**GET /api/v1/enderecos-entrega/relatorio/entregas**
- Descrição: Exportar relatório de entregas (Excel/PDF)
- Autenticação: Obrigatória
- Autorização: `GES.ENDERECOS_ENTREGA.VIEW`
- Request DTO: `ExportarRelatorioEntregasQuery` (formato, filtros)
- Response DTO: `byte[]` (arquivo)

**GET /api/v1/enderecos-entrega/mapa-calor**
- Descrição: Obter dados para mapa de calor
- Autenticação: Obrigatória
- Autorização: `GES.ENDERECOS_ENTREGA.VIEW`
- Request DTO: `GetMapaCalorQuery`
- Response DTO: `MapaCalorDto` (coordenadas agregadas)

---

## SEÇÃO 7: MODELO DE DADOS

### 7.1 Entidade Principal: EnderecoEntrega

```csharp
public class EnderecoEntrega
{
    public Guid Id { get; set; }
    public Guid ClienteId { get; set; }  // Multi-tenancy (Fornecedor/Conglomerado)

    // Dados do Endereço
    public string CEP { get; set; }  // 9 caracteres (12345-678)
    public string Logradouro { get; set; }  // NVARCHAR(200)
    public string Numero { get; set; }  // NVARCHAR(20)
    public string Complemento { get; set; }  // NVARCHAR(100), nullable
    public string Bairro { get; set; }  // NVARCHAR(100)
    public string Cidade { get; set; }  // NVARCHAR(100)
    public string UF { get; set; }  // CHAR(2)
    public string CodigoIBGE { get; set; }  // NVARCHAR(7), nullable

    // Geocodificação
    public decimal? Latitude { get; set; }  // DECIMAL(10,8)
    public decimal? Longitude { get; set; }  // DECIMAL(11,8)
    public string Precisao { get; set; }  // ROOFTOP, RANGE_INTERPOLATED, GEOMETRIC_CENTER
    public string PlaceId { get; set; }  // Google Maps Place ID

    // Categorização
    public string Categoria { get; set; }  // Matriz, Filial, Depósito, HomeOffice, Temporário
    public string NomeFantasia { get; set; }  // NVARCHAR(200), nullable
    public string Referencia { get; set; }  // NVARCHAR(300), nullable (ex: "Próximo ao metrô")
    public bool FlEnderecoPadrao { get; set; }  // Apenas 1 por ClienteId

    // Auditoria
    public string CriadoPor { get; set; }
    public DateTime CriadoEm { get; set; }
    public string AlteradoPor { get; set; }
    public DateTime? AlteradoEm { get; set; }
    public bool FlExcluido { get; set; }

    // Relacionamentos
    public ICollection<EntregaHistorico> Entregas { get; set; }
}
```

### 7.2 Entidade: EntregaHistorico

```csharp
public class EntregaHistorico
{
    public Guid Id { get; set; }
    public Guid EnderecoEntregaId { get; set; }
    public Guid SolicitacaoId { get; set; }

    // Datas
    public DateTime DataEnvio { get; set; }
    public DateTime DataPrevisao { get; set; }
    public DateTime? DataEntrega { get; set; }

    // Rastreamento
    public string Status { get; set; }  // Entregue, EmTransito, Devolvido, Extraviado
    public string Transportadora { get; set; }  // Correios, Jadlog, TotalExpress
    public string CodigoRastreio { get; set; }  // NVARCHAR(50)

    // Evidências
    public string EvidenciaFotoUrl { get; set; }  // NVARCHAR(500), nullable
    public string AssinaturaDigitalUrl { get; set; }  // NVARCHAR(500), nullable
    public string ComprovanteUrl { get; set; }  // NVARCHAR(500), nullable

    // Feedback
    public int? AvaliacaoRecebedor { get; set; }  // 1-5 estrelas
    public string ProblemaReportado { get; set; }  // NVARCHAR(500), nullable

    // Custo
    public decimal CustoFrete { get; set; }  // DECIMAL(10,2)

    // Auditoria
    public string CriadoPor { get; set; }
    public DateTime CriadoEm { get; set; }

    // Relacionamentos
    public EnderecoEntrega EnderecoEntrega { get; set; }
    public ICollection<RastreamentoEvento> EventosRastreamento { get; set; }
}
```

### 7.3 Entidade: RastreamentoEvento

```csharp
public class RastreamentoEvento
{
    public Guid Id { get; set; }
    public Guid EntregaHistoricoId { get; set; }

    public DateTime DataHora { get; set; }
    public string Evento { get; set; }  // Postado, EmTransito, SaiuParaEntrega, Entregue
    public string Local { get; set; }  // NVARCHAR(200)
    public string Observacao { get; set; }  // NVARCHAR(500), nullable

    // Auditoria
    public DateTime CriadoEm { get; set; }

    // Relacionamento
    public EntregaHistorico EntregaHistorico { get; set; }
}
```

### 7.4 Índices (Performance)

```sql
-- Busca por CEP + ClienteId (validação duplicata)
CREATE NONCLUSTERED INDEX IX_EnderecoEntrega_CEP_ClienteId
ON EnderecoEntrega (CEP, ClienteId, FlExcluido)
INCLUDE (Numero, Logradouro);

-- Busca fuzzy por cidade/bairro
CREATE NONCLUSTERED INDEX IX_EnderecoEntrega_Cidade_Bairro
ON EnderecoEntrega (Cidade, Bairro, FlExcluido);

-- Filtro de endereço padrão
CREATE NONCLUSTERED INDEX IX_EnderecoEntrega_Padrao
ON EnderecoEntrega (ClienteId, FlEnderecoPadrao)
WHERE FlEnderecoPadrao = 1 AND FlExcluido = 0;

-- Mapa de calor (lat/long)
CREATE NONCLUSTERED INDEX IX_EnderecoEntrega_Coordenadas
ON EnderecoEntrega (Latitude, Longitude)
WHERE Latitude IS NOT NULL AND Longitude IS NOT NULL;

-- Histórico de entregas por endereço
CREATE NONCLUSTERED INDEX IX_EntregaHistorico_EnderecoId_Data
ON EntregaHistorico (EnderecoEntregaId, DataEnvio DESC);

-- Rastreamento de eventos por código
CREATE NONCLUSTERED INDEX IX_EntregaHistorico_CodigoRastreio
ON EntregaHistorico (CodigoRastreio);
```

---

## SEÇÃO 8: DEPENDÊNCIAS

### 8.1 RFs Dependentes

| RF | Tipo Dependência | Descrição |
|----|------------------|-----------|
| **RF008 - Gestão de Fornecedores** | **MÉDIA** | Fornecedores (clientes) precisam existir antes de cadastrar endereços |
| **RF013 - Gestão de Locais e Endereços** | **ALTA** | Reutiliza validações de CEP e geocodificação |
| **RF019 - Gestão de Pedidos de Compra** | **CRÍTICA** | Pedidos vinculam endereços de entrega obrigatoriamente |
| **RF001 - Parâmetros e Configurações** | **MÉDIA** | Chaves API (Google Maps, ViaCEP, transportadoras) configuradas |

### 8.2 Tecnologias e Bibliotecas

**Backend:**
- .NET 10
- HttpClient + Polly (retry, timeout, circuit breaker)
- Hangfire (polling rastreamento)
- SignalR (notificações em tempo real)
- FuzzySharp (Levenshtein distance para busca fuzzy)
- EPPlus (exportação Excel)
- QuestPDF (exportação PDF)

**Frontend:**
- Angular 19
- Angular Material (Autocomplete, Dialogs)
- Google Maps JavaScript API
- Leaflet (mapa open-source alternativo)
- RxJS (debounce, distinctUntilChanged)

**APIs Externas:**
- ViaCEP (validação CEP)
- Google Maps Geocoding API
- Correios API (frete e rastreamento)
- Jadlog API
- Total Express API

---

## SEÇÃO 9: KPIs E MÉTRICAS

### 9.1 KPIs de Negócio

| KPI | Meta | Descrição |
|-----|------|-----------|
| **Taxa de Sucesso de Entrega** | ≥95% | Percentual de entregas bem-sucedidas (Entregue) |
| **Tempo Médio de Entrega** | ≤5 dias úteis | Tempo entre DataEnvio e DataEntrega |
| **Custo Médio de Frete** | ≤R$ 50,00 | Custo médio por entrega |
| **Taxa de Reuso de Endereços** | ≥70% | Percentual de entregas em endereços já cadastrados |
| **Precisão de Geocodificação** | ≥90% ROOFTOP | Percentual de endereços com precisão ROOFTOP |

### 9.2 KPIs Técnicos

| KPI | Meta | Descrição |
|-----|------|-----------|
| **Tempo de Resposta ViaCEP** | ≤2s | Tempo médio de validação de CEP |
| **Disponibilidade APIs Transportadoras** | ≥99% | Uptime das APIs de frete |
| **Taxa de Sucesso Webhook** | ≥95% | Percentual de webhooks processados com sucesso |
| **Performance Query Autocomplete** | ≤500ms | Tempo de resposta da busca fuzzy |

---

## SEÇÃO 10: ALERTAS CRÍTICOS

### 10.1 Alertas de Sistema

| Evento | Threshold | Severidade | Ação |
|--------|-----------|------------|------|
| **API ViaCEP Indisponível** | 3 falhas consecutivas | ALTA | Trocar para API alternativa (PostMon) |
| **Google Maps Quota Excedida** | >90% da cota mensal | CRÍTICA | Alertar admin, considerar OpenStreetMap |
| **Webhook Falha** | 5 falhas consecutivas | MÉDIA | Ativar polling manual (Hangfire) |
| **Entrega Atrasada** | Prazo vencido >2 dias | ALTA | Notificar solicitante e gestor |

### 10.2 Alertas de Negócio

| Evento | Threshold | Severidade | Ação |
|--------|-----------|------------|------|
| **Taxa de Devolução Alta** | >10% em um endereço | ALTA | Investigar endereço (incorreto, portaria fechada) |
| **Custo Frete Acima da Média** | >R$ 100,00 | MÉDIA | Sugerir renegociação com transportadora |
| **Endereço Sem Geocodificação** | 48h sem lat/long | MÉDIA | Retry automático de geocodificação |

---

## SEÇÃO 11: CENTRAL DE FUNCIONALIDADES

### 11.1 Registro da Feature

```yaml
feature_code: GES.ENDERECOS_ENTREGA
feature_name: Gestão de Endereços de Entrega
module: Gestão
category: Cadastros Base
description: Sistema completo de gerenciamento de endereços com validação automática de CEP, geocodificação via Google Maps, integração com transportadoras (Correios, Jadlog, Total Express), cálculo de frete, histórico de entregas e rastreamento em tempo real
enabled_by_default: true
requires_configuration: true  # Chaves API (Google Maps, ViaCEP, transportadoras)
```

### 11.2 Configurações Necessárias

**Parâmetros de Sistema (RF001):**
```json
{
  "ges.enderecosEntrega": {
    "viacep": {
      "url": "https://viacep.com.br/ws/{cep}/json/",
      "timeout": 5000,
      "fallbackUrl": "http://api.postmon.com.br/v1/cep/{cep}"
    },
    "googleMaps": {
      "apiKey": "{GOOGLE_MAPS_API_KEY}",
      "geocodingUrl": "https://maps.googleapis.com/maps/api/geocode/json"
    },
    "transportadoras": {
      "correios": {
        "apiUrl": "https://webservice.correios.com.br/service/CalcPrecoPrazo",
        "usuario": "{CORREIOS_USER}",
        "senha": "{CORREIOS_PASSWORD}"
      },
      "jadlog": {
        "apiUrl": "https://api.jadlog.com.br/tracking/v1/quote",
        "token": "{JADLOG_API_TOKEN}"
      },
      "totalExpress": {
        "apiUrl": "https://api.totalexpress.com.br/v1/shipment/quote",
        "token": "{TOTALEXPRESS_API_TOKEN}"
      }
    },
    "notificacoes": {
      "smsHabilitado": false,  # SMS apenas para eventos críticos
      "emailHabilitado": true,
      "signalRHabilitado": true
    }
  }
}
```

### 11.3 Menu de Navegação

```yaml
menu_path: Gestão > Endereços de Entrega
icon: location_on
route: /gestao/enderecos-entrega
```

---

**FIM DA ESPECIFICAÇÃO RF043 v2.0**
