# RF-059: Gestão de Status e Tipos Genéricos

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC003-CAD-Cadastros-Base
**Fase**: Fase 2 - Cadastros e Serviços Transversais

**RFs Relacionados**: RF001 (Parâmetros e Configurações), RF028 (Gestão de SLA), RF039 (Gestão de Bilhetes)

---

## 1. OBJETIVO DO REQUISITO

Especificar o sistema de gestão centralizada de listas parametrizáveis de status, tipos e categorias genéricas utilizadas em todo o sistema IControlIT. O módulo permite criar, editar, inativar e configurar domínios de classificação sem necessidade de alteração de código, proporcionando flexibilidade operacional e adaptação por cliente.

Este requisito funcional define o comportamento esperado para gestão de domínios (Status de Chamado, Prioridade, Tipo de Ativo, Categoria de Despesa, etc.) com controle de transições de estado, versionamento, ordenação customizada, internacionalização e histórico completo de alterações.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] CRUD completo de domínios de tipos (Status, Prioridade, Categoria, etc.)
- [x] CRUD completo de itens dentro de cada domínio
- [x] Controle de transições permitidas entre status (workflow)
- [x] Ativação e inativação de itens (soft delete)
- [x] Ordenação customizada para exibição em dropdowns
- [x] Associação de cores hexadecimais e ícones FontAwesome a itens
- [x] Configuração de valores padrão por domínio
- [x] Internacionalização completa (pt-BR, en-US, es-ES)
- [x] Histórico de alterações com versionamento
- [x] Validação de dependências antes de inativação
- [x] Import/Export de configurações em formato JSON
- [x] Multi-tenancy rigoroso (isolamento por ClienteId e ConglomeradoId)
- [x] Auditoria imutável de todas as operações
- [x] Cache in-memory com invalidação automática

### 2.2 Fora do escopo

- Interface visual específica (responsabilidade do frontend)
- Tecnologia, framework ou linguagem de implementação
- Layout, UX ou identidade visual
- Estratégia de deploy ou infraestrutura
- Geração de diagramas visuais de workflow (executado em módulo separado)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Domínio** | Categoria lógica de classificação que agrupa múltiplos itens relacionados (ex: Domínio "Status de Chamado" contém itens "Aberto", "Em Atendimento", "Fechado"). Um domínio define um namespace de valores permitidos para um campo específico do sistema. |
| **Item de Domínio** | Valor específico dentro de um domínio (ex: Item "Crítica" no domínio "Prioridade"). Cada item possui código único, nome, cor, ícone e ordenação. Itens são multi-tenant e podem ser globais (sistema) ou customizados (cliente). |
| **Transição Permitida** | Regra que define qual mudança de status é válida (ex: Status "Aberto" pode transicionar para "Em Atendimento", mas não diretamente para "Fechado"). Controla workflow e previne estados inválidos. Pode exigir justificativa ou aprovação. |
| **Global vs. Customizado** | Itens globais são fornecidos pelo sistema e aplicam-se a todos os clientes. Itens customizados são criados por clientes específicos e visíveis apenas dentro do seu tenant (ClienteId/ConglomeradoId). |
| **Soft Delete** | Itens nunca são excluídos fisicamente. Ao inativar, a coluna Ativo é marcada como false e MotivoInativacao é registrado. Preserva integridade referencial e permite auditoria histórica. |
| **Ordenação Customizada** | Cada item possui campo Ordem que define sua posição em dropdowns e listagens. Permite personalizar sequência de exibição (ex: prioridades de maior para menor: Crítica, Alta, Média, Baixa). |
| **Cache In-Memory** | Domínios e itens são armazenados em cache de memória (Redis ou IMemoryCache) para alta performance. Cache é invalidado automaticamente ao criar, editar ou excluir itens. TTL configurável por domínio. |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Criar Domínio** - Criar nova categoria de classificação (ex: Status de Solicitação)
2. **Atualizar Domínio** - Editar configurações do domínio (nome, descrição, permissões)
3. **Listar Domínios** - Consultar todos os domínios disponíveis com filtros
4. **Criar Item de Domínio** - Adicionar novo valor ao domínio (ex: Status "Pendente")
5. **Atualizar Item** - Editar propriedades do item (nome, cor, ícone, ordem)
6. **Inativar Item** - Desabilitar item com validação de dependências
7. **Reordenar Itens** - Alterar sequência de exibição via drag-and-drop
8. **Configurar Transições** - Definir quais mudanças de status são permitidas
9. **Validar Transição** - Verificar se mudança de estado é válida antes de aplicar
10. **Definir Valor Padrão** - Marcar item como padrão para seleção automática
11. **Exportar Configurações** - Gerar JSON com todos os domínios e itens
12. **Importar Configurações** - Carregar configurações de ambiente anterior
13. **Traduzir Item** - Gerenciar traduções em múltiplos idiomas
14. **Consultar Histórico** - Ver todas as alterações realizadas em domínios/itens

---

## 5. REGRAS DE NEGÓCIO

### RN-RF059-01 — Código de Domínio Único por Cliente

**Descrição**: O código do domínio deve ser único dentro do escopo do cliente (ClienteId). Não é permitido criar dois domínios com o mesmo código para o mesmo cliente. Validação case-insensitive ocorre antes da persistência.

**Justificativa**: Garantir identificação inequívoca de domínios e prevenir conflitos em queries, cache e integrações.

**Critério de Aceite**:
- Código duplicado no mesmo cliente → HTTP 400 "Domínio com código [X] já existe"
- Validação case-insensitive (STATUS_CHAMADO = status_chamado)
- Código ausente ou vazio → HTTP 400
- Código com caracteres especiais ou espaços → HTTP 400
- Máximo 50 caracteres

**Exemplos**:
- ✅ Válido: Cliente A cria "STATUS_CHAMADO", Cliente B cria "STATUS_CHAMADO" (tenants diferentes)
- ❌ Inválido: Cliente A tenta criar segundo domínio "STATUS_CHAMADO"

---

### RN-RF059-02 — Código de Item Único por Domínio

**Descrição**: O código do item deve ser único dentro do domínio. Não é permitido criar dois itens com o mesmo código no mesmo domínio. Validação case-insensitive.

**Justificativa**: Prevenir ambiguidade em queries, garantir integridade referencial e facilitar lookup por código.

**Critério de Aceite**:
- Código duplicado no mesmo domínio → HTTP 400
- Validação case-insensitive
- Código com espaços ou caracteres especiais → HTTP 400
- Máximo 50 caracteres

**Exemplos**:
- ✅ Válido: Domínio "Prioridade" com itens "CRITICA", "ALTA", "MEDIA", "BAIXA"
- ❌ Inválido: Dois itens "CRITICA" no mesmo domínio

---

### RN-RF059-03 — Validação de Transição de Estado

**Descrição**: Antes de aplicar mudança de status em qualquer entidade do sistema, o módulo valida se a transição está configurada na tabela TransicaoPermitida. Transições não configuradas são bloqueadas com erro HTTP 400.

**Justificativa**: Prevenir estados inválidos, garantir workflow consistente e forçar fluxos de aprovação quando necessário.

**Critério de Aceite**:
- Transição não configurada → HTTP 400 "Transição de [X] para [Y] não permitida"
- Se RequerJustificativa = true → Justificativa obrigatória
- Se RequerAprovacao = true → Workflow de aprovação acionado
- Auditoria completa da transição (quem, quando, de qual estado, para qual estado)

**Exemplos**:
- ✅ Válido: Chamado "Aberto" → "Em Atendimento" (transição configurada)
- ❌ Inválido: Chamado "Aberto" → "Fechado" (transição não configurada, pulou etapa)

---

### RN-RF059-04 — Inativação com Validação de Dependências

**Descrição**: Antes de inativar um item de domínio, o sistema verifica se existem registros ativos usando esse item. Se houver dependências, a inativação é bloqueada com erro HTTP 409 Conflict listando quantidade de registros afetados.

**Justificativa**: Garantir integridade referencial e prevenir erros em queries que filtram por status específicos.

**Critério de Aceite**:
- Item em uso → HTTP 409 "Não é possível inativar. Existem [N] registro(s) usando este item"
- Mensagem lista tabelas afetadas (ex: "5 chamados, 3 solicitações")
- Item sem uso → Inativação executada normalmente
- Auditoria registra motivo da inativação

**Exemplos**:
- ✅ Inativação bem-sucedida: Status "Pendente" sem chamados ativos
- ❌ Bloqueado: Status "Em Atendimento" com 15 chamados ativos

---

### RN-RF059-05 — Ordenação Customizada com Reindexação Automática

**Descrição**: Ao alterar a ordem de um item (campo Ordem), o sistema reindexada automaticamente todos os outros itens do domínio para evitar gaps ou duplicatas. Ordenação sempre sequencial (1, 2, 3, 4...).

**Justificativa**: Manter consistência na ordenação exibida em dropdowns e facilitar inserção entre itens existentes.

**Critério de Aceite**:
- Ordem duplicada → Reindexação automática
- Ordem negativa ou zero → HTTP 400
- Inserção entre itens existentes ajusta ordens superiores (+1)
- Ordem > quantidade de itens → Item vai para final da lista

**Exemplos**:
- Itens: A(1), B(2), C(3)
- Inserir item D com Ordem=2 → Resultado: A(1), D(2), B(3), C(4)

---

### RN-RF059-06 — Apenas Um Valor Padrão por Domínio

**Descrição**: Cada domínio pode ter apenas um item marcado como Padrao = true. Ao marcar um item como padrão, o sistema automaticamente desmarca o item anterior que estava como padrão.

**Justificativa**: Garantir comportamento previsível ao criar novos registros sem especificar valor (usa padrão automático).

**Critério de Aceite**:
- Marcar item como padrão → Item anterior perde flag de padrão
- Nenhum item padrão configurado → Sistema permite (não obrigatório)
- Auditoria registra mudança de padrão

**Exemplos**:
- Domínio "Prioridade": Item "MEDIA" marcado como padrão
- Ao marcar "ALTA" como padrão → "MEDIA" perde flag automaticamente

---

### RN-RF059-07 — Internacionalização Obrigatória

**Descrição**: Todos os itens de domínio devem ter traduções cadastradas para pelo menos pt-BR. Traduções para en-US e es-ES são opcionais mas recomendadas. Sistema usa fallback pt-BR → en-US → es-ES se tradução não existir.

**Justificativa**: Suportar operação multinacional e permitir uso do sistema em diferentes idiomas sem redeployment.

**Critério de Aceite**:
- Tradução pt-BR obrigatória (verificação na criação)
- Tradução ausente no idioma solicitado → Fallback para pt-BR
- API retorna tradução conforme header Accept-Language
- Auditoria registra criação/edição de traduções

**Exemplos**:
- Item "Crítica": pt-BR="Crítica", en-US="Critical", es-ES="Crítica"
- Usuário solicita idioma fr-FR (não cadastrado) → Sistema retorna pt-BR

---

### RN-RF059-08 — Multi-tenancy com Itens Globais e Customizados

**Descrição**: Itens podem ser globais (sistema) ou customizados (cliente). Itens globais têm ClienteId = NULL e são visíveis para todos os clientes. Itens customizados têm ClienteId específico e visíveis apenas dentro do tenant. Queries sempre retornam globais + customizados do cliente.

**Justificativa**: Permitir que sistema forneça valores padrão enquanto clientes criam valores específicos para suas necessidades.

**Critério de Aceite**:
- Query retorna WHERE (ClienteId = [cliente] OR ClienteId IS NULL)
- Itens globais não podem ser editados por clientes
- Itens globais podem ser inativados apenas por administradores do sistema
- Auditoria distingue itens globais de customizados

**Exemplos**:
- Domínio "Prioridade": Itens globais (Crítica, Alta, Média, Baixa)
- Cliente XYZ adiciona item customizado "Emergência Nível 1" (visível apenas para XYZ)

---

### RN-RF059-09 — Histórico Completo de Alterações

**Descrição**: Toda criação, edição ou inativação de domínios e itens é registrada na tabela HistoricoDominioTipo com snapshot JSON de DadosAntes e DadosDepois. Histórico é imutável e retido por 7 anos (LGPD).

**Justificativa**: Auditoria completa, rastreabilidade de decisões e compliance com regulações de retenção de dados.

**Critério de Aceite**:
- Toda operação gera registro de histórico
- Snapshot JSON contém estado completo do objeto
- Histórico nunca é deletado (mesmo em soft delete)
- Query de histórico filtra por ClienteId (multi-tenancy)
- Campos auditados: CreatedBy, CreatedAt, TipoAlteracao, Justificativa

**Exemplos**:
- Edição de item "Alta": DadosAntes={Cor:"#FF0000"}, DadosDepois={Cor:"#FF5733"}
- Registro: TipoAlteracao="EDICAO_COR", CreatedBy="user-123", CreatedAt="2025-12-30 10:30:00"

---

### RN-RF059-10 — Cache In-Memory com Invalidação Automática

**Descrição**: Domínios e itens são armazenados em cache de memória distribuído (Redis) com TTL de 24 horas. Ao criar, editar ou excluir qualquer item, o cache do domínio correspondente é invalidado automaticamente. Queries leem do cache quando disponível, senão carregam do banco e populam cache.

**Justificativa**: Otimizar performance em operações de leitura frequentes (dropdowns carregados em múltiplas telas) e reduzir latência de consultas.

**Critério de Aceite**:
- Cache miss → Query no banco + populate cache
- Cache hit → Retorno imediato sem query no banco
- Invalidação após create/update/delete
- TTL configurável via appsettings
- Métricas de cache hit rate (monitoramento)

**Exemplos**:
- Primeira query de "Prioridades": Cache miss → 120ms (query banco)
- Queries seguintes: Cache hit → 5ms (leitura memória)
- Após editar item "Alta": Cache invalidado → Próxima query refaz cache

---

## 6. ESTADOS DA ENTIDADE

### 6.1 Estados de Domínio

| Estado | Descrição | Transições Permitidas |
|--------|-----------|----------------------|
| **Ativo** | Domínio disponível para uso | → Inativo |
| **Inativo** | Domínio desabilitado | → Ativo |

### 6.2 Estados de Item de Domínio

| Estado | Descrição | Transições Permitidas |
|--------|-----------|----------------------|
| **Ativo** | Item disponível para seleção | → Inativo |
| **Inativo** | Item não aparece em dropdowns | → Ativo (se sem dependências) |

**Nota**: Itens inativos permanecem visíveis em registros históricos mas não aparecem em novos cadastros.

---

## 7. PERMISSÕES RBAC

| Operação | Permission Code | Roles Autorizadas |
|----------|----------------|-------------------|
| Listar Domínios | `SIS.DOMINIOS.VIEW` | Super Admin, Admin, Gestor, Operador |
| Criar Domínio | `SIS.DOMINIOS.CREATE` | Super Admin, Admin |
| Editar Domínio | `SIS.DOMINIOS.UPDATE` | Super Admin, Admin |
| Inativar Domínio | `SIS.DOMINIOS.DELETE` | Super Admin |
| Criar Item | `SIS.DOMINIOS.ITEMS.CREATE` | Super Admin, Admin |
| Editar Item | `SIS.DOMINIOS.ITEMS.UPDATE` | Super Admin, Admin |
| Inativar Item | `SIS.DOMINIOS.ITEMS.DELETE` | Super Admin, Admin |
| Configurar Transições | `SIS.DOMINIOS.WORKFLOW.MANAGE` | Super Admin |
| Exportar Configurações | `SIS.DOMINIOS.EXPORT` | Super Admin, Admin |
| Importar Configurações | `SIS.DOMINIOS.IMPORT` | Super Admin |

**Nota**: Operadores e Gestores têm permissão apenas de leitura (VIEW). Apenas Super Admin pode deletar domínios globais.

---

## 8. API ENDPOINTS

### 8.1 Domínios

| Método | Rota | Descrição | Autenticação | Permissão |
|--------|------|-----------|--------------|-----------|
| GET | `/api/dominios` | Listar todos os domínios | Sim | `SIS.DOMINIOS.VIEW` |
| GET | `/api/dominios/{id}` | Obter domínio por ID | Sim | `SIS.DOMINIOS.VIEW` |
| POST | `/api/dominios` | Criar novo domínio | Sim | `SIS.DOMINIOS.CREATE` |
| PUT | `/api/dominios/{id}` | Atualizar domínio | Sim | `SIS.DOMINIOS.UPDATE` |
| DELETE | `/api/dominios/{id}` | Inativar domínio (soft delete) | Sim | `SIS.DOMINIOS.DELETE` |

### 8.2 Itens de Domínio

| Método | Rota | Descrição | Autenticação | Permissão |
|--------|------|-----------|--------------|-----------|
| GET | `/api/dominios/{dominioId}/itens` | Listar itens do domínio | Sim | `SIS.DOMINIOS.VIEW` |
| GET | `/api/dominios/itens/{id}` | Obter item por ID | Sim | `SIS.DOMINIOS.VIEW` |
| POST | `/api/dominios/{dominioId}/itens` | Criar novo item | Sim | `SIS.DOMINIOS.ITEMS.CREATE` |
| PUT | `/api/dominios/itens/{id}` | Atualizar item | Sim | `SIS.DOMINIOS.ITEMS.UPDATE` |
| PATCH | `/api/dominios/itens/{id}/ordem` | Alterar ordem do item | Sim | `SIS.DOMINIOS.ITEMS.UPDATE` |
| DELETE | `/api/dominios/itens/{id}` | Inativar item (soft delete) | Sim | `SIS.DOMINIOS.ITEMS.DELETE` |

### 8.3 Transições

| Método | Rota | Descrição | Autenticação | Permissão |
|--------|------|-----------|--------------|-----------|
| GET | `/api/dominios/{dominioId}/transicoes` | Listar transições permitidas | Sim | `SIS.DOMINIOS.VIEW` |
| POST | `/api/dominios/{dominioId}/transicoes` | Criar transição | Sim | `SIS.DOMINIOS.WORKFLOW.MANAGE` |
| DELETE | `/api/dominios/transicoes/{id}` | Remover transição | Sim | `SIS.DOMINIOS.WORKFLOW.MANAGE` |
| POST | `/api/dominios/transicoes/validar` | Validar se transição é permitida | Sim | `SIS.DOMINIOS.VIEW` |

### 8.4 Configurações

| Método | Rota | Descrição | Autenticação | Permissão |
|--------|------|-----------|--------------|-----------|
| GET | `/api/dominios/export` | Exportar configurações em JSON | Sim | `SIS.DOMINIOS.EXPORT` |
| POST | `/api/dominios/import` | Importar configurações de JSON | Sim | `SIS.DOMINIOS.IMPORT` |

**Request/Response DTOs**:
- `CreateDominioCommand`: { Codigo, Nome, Descricao, PermiteCustomizacao, PermiteTransicoes }
- `CreateItemDominioCommand`: { DominioId, Codigo, Nome, Descricao, Cor, Icone, Ordem, Padrao }
- `DominioDto`: { Id, Codigo, Nome, Descricao, QtdItens, Ativo }
- `ItemDominioDto`: { Id, Codigo, Nome, Descricao, Cor, Icone, Ordem, Padrao, Ativo }

---

## 9. INTEGRAÇÕES OBRIGATÓRIAS

### 9.1 Central de Funcionalidades

```sql
INSERT INTO SistemaFuncionalidade (Codigo, Nome, Modulo, Rota)
VALUES ('SIS.DOMINIOS', 'Gestão de Status e Tipos', 'Sistema', '/sistema/dominios');
```

### 9.2 Internacionalização (i18n)

**Chaves obrigatórias**:
- `dominios.titulo`: "Gestão de Domínios"
- `dominios.criar`: "Criar Domínio"
- `dominios.itens.titulo`: "Itens do Domínio"
- `dominios.transicoes.titulo`: "Transições Permitidas"
- `dominios.validacao.codigo_duplicado`: "Código já existe"

### 9.3 Auditoria

**Códigos de operação**:
- `SIS_DOMINIO_CRIADO`
- `SIS_DOMINIO_EDITADO`
- `SIS_DOMINIO_INATIVADO`
- `SIS_ITEM_CRIADO`
- `SIS_ITEM_EDITADO`
- `SIS_ITEM_INATIVADO`
- `SIS_TRANSICAO_CRIADA`
- `SIS_TRANSICAO_REMOVIDA`

### 9.4 Cache (Redis)

**Chaves de cache**:
- `dominio:{dominioId}`: Cache do domínio completo
- `dominio:{dominioId}:itens`: Cache dos itens do domínio
- TTL: 24 horas (configurável)

---

## 10. SEGURANÇA

- Validação de entrada obrigatória (FluentValidation)
- Proteção contra SQL Injection (queries parametrizadas)
- Controle de permissões RBAC em todos os endpoints
- Isolamento multi-tenant rigoroso (ClienteId obrigatório)
- Auditoria imutável de todas as operações
- Rate limiting para endpoints de importação (max 5 req/min)

---

## 11. MÉTRICAS E INDICADORES

### 11.1 KPIs

| Indicador | Descrição | Meta |
|-----------|-----------|------|
| Taxa de Cache Hit | Percentual de queries atendidas por cache | ≥ 95% |
| Tempo de Resposta API | Tempo médio de resposta dos endpoints | ≤ 100ms |
| Quantidade de Domínios Customizados | Média de domínios criados por cliente | ≥ 3 |
| Taxa de Uso de Traduções | Percentual de itens com 3 idiomas | ≥ 80% |

### 11.2 Alertas

| Evento | Threshold | Severidade | Ação |
|--------|-----------|------------|------|
| Cache hit rate < 90% | 1 hora | MÉDIA | Revisar TTL e padrões de invalidação |
| Tempo resposta > 200ms | 5 minutos | ALTA | Investigar queries lentas |
| Tentativa de exclusão com dependências | > 10/dia | MÉDIA | Revisar UX e documentação |

---

## 12. ARTEFATOS DERIVADOS

Este RF é base para:

- UC-RF059.md (Casos de Uso)
- MD-RF059.md (Modelo de Dados)
- WF-RF059.md (Wireframes)
- TC-RF059.yaml (Casos de Teste Backend)
- TC-RF059-E2E.yaml (Casos de Teste E2E)

---

## 13. RASTREABILIDADE

| Artefato | Status | Localização |
|----------|--------|-------------|
| Casos de Uso | Criado | UC-RF059.md |
| Modelo de Dados | Criado | MD-RF059.md |
| Wireframes | Criado | WF-RF059.md |
| Casos de Teste | Pendente | TC-RF059.yaml |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0: Separação RF/RL completa, 11 seções obrigatórias, sem código, sem legado | Agência ALC - alc.dev.br |
| 1.0 | 2025-12-18 | Versão inicial com código inline e referências ao legado | Equipe IControlIT |
