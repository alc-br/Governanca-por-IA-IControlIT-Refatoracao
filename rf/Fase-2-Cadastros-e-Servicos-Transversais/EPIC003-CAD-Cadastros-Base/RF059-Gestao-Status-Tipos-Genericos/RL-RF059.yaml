rf_id: RF059
rf_title: "Gestão de Status e Tipos Genéricos"
versao_governanca: "2.0"
data_migracao: "2025-12-30"

# ==============================================================================
# ITENS LEGADO RASTREADOS
# ==============================================================================

referencias:
  # ------------------------------------------------------------------------------
  # TELAS ASPX
  # ------------------------------------------------------------------------------
  - id: "LEG-RF059-001"
    tipo: "tela"
    nome: "CadastroStatusChamado.aspx"
    caminho: "ic1_legado/IControlIT/ServiceDesk/CadastroStatusChamado.aspx"
    descricao: |
      Tela para criar e editar status de chamados (Aberto, Em Atendimento, Fechado, Cancelado).
      Permitia configurar Nome, Cor, Ordem e flag Ativo/Inativo.
    regras_implicitas:
      - "Validação de nome único executada no code-behind VB.NET (sem validação backend)"
      - "Ao inativar status, não verificava dependências (causava erros em queries)"
      - "Ordenação manual sem reindexação automática (permitia gaps e duplicatas)"
      - "Sem versionamento (alterações sobrescreviam dados sem histórico)"
      - "Sem auditoria (impossível rastrear quem alterou e quando)"
    destino: "substituido"
    justificativa: "Substituído por módulo unificado de domínios genéricos. Funcionalidade específica de status de chamados agora é um domínio configurável."
    rastreabilidade:
      rf_moderno: "RF-059 - Seção 4 (Funcionalidades) - Criar/Editar Item de Domínio"
      uc_moderno: "UC01-RF059 (Criar Item), UC03-RF059 (Editar Item)"
    migracao_moderna:
      componente_angular: "dominios-items-create.component.ts, dominios-items-edit.component.ts"
      rota_frontend: "/sistema/dominios/{dominioId}/itens"

  - id: "LEG-RF059-002"
    tipo: "tela"
    nome: "CadastroPlioridades.aspx (typo no nome)"
    caminho: "ic1_legado/IControlIT/ServiceDesk/CadastroPlioridades.aspx"
    descricao: |
      Tela para cadastrar prioridades de solicitações (Baixa, Média, Alta, Crítica).
      Estrutura idêntica a CadastroStatusChamado.aspx (código duplicado).
    regras_implicitas:
      - "Typo no nome do arquivo (Plioridades ao invés de Prioridades)"
      - "Código duplicado em relação a CadastroStatusChamado.aspx"
      - "Sem suporte a transições (mudança de prioridade sem validação)"
      - "Valores hard-coded em vários lugares do código"
    destino: "substituido"
    justificativa: "Consolidado no módulo genérico de domínios. Prioridades agora são itens do domínio 'PRIORIDADE'."
    rastreabilidade:
      rf_moderno: "RF-059 - Seção 3 (Conceitos) - Domínio vs Item de Domínio"
      uc_moderno: "UC01-RF059 (Criar Item), UC03-RF059 (Editar Item)"
    migracao_moderna:
      componente_angular: "dominios-items-create.component.ts"
      rota_frontend: "/sistema/dominios/PRIORIDADE/itens"

  # ------------------------------------------------------------------------------
  # WEBSERVICES
  # ------------------------------------------------------------------------------
  - id: "LEG-RF059-003"
    tipo: "webservice"
    nome: "StatusService.asmx"
    caminho: "ic1_legado/IControlIT/WebServices/StatusService.asmx"
    metodos:
      - nome: "ObterStatusAtivos"
        parametros: "moduloId: int"
        retorno: "List<StatusDto>"
      - nome: "ValidarTransicaoStatus"
        parametros: "statusOrigemId: int, statusDestinoId: int"
        retorno: "bool"
      - nome: "ObterCorStatus"
        parametros: "statusId: int"
        retorno: "string (hex color)"
    descricao: |
      Webservice para operações relacionadas a status de módulos específicos.
      Sem cache (queries repetitivas ao banco), sem multi-tenancy (retornava status de todos os clientes),
      transições hard-coded em switch-case VB.NET.
    destino: "substituido"
    justificativa: "Substituído por REST API moderna com autenticação JWT, cache Redis e validação parametrizada de transições."
    rastreabilidade:
      rf_moderno: "RF-059 - Seção 8 (API Endpoints)"
      endpoint_moderno: "GET /api/dominios/{dominioId}/itens, POST /api/dominios/transicoes/validar"
    migracao_moderna:
      command_cqrs: "GetItensDominioQuery, ValidarTransicaoCommand"
      handler: "GetItensDominioQueryHandler, ValidarTransicaoCommandHandler"

  # ------------------------------------------------------------------------------
  # STORED PROCEDURES
  # ------------------------------------------------------------------------------
  - id: "LEG-RF059-004"
    tipo: "stored_procedure"
    nome: "sp_ObterStatusPorModulo"
    caminho: "ic1_legado/BancoDados/Procedures/sp_ObterStatusPorModulo.sql"
    parametros_entrada:
      - "@ModuloId INT"
      - "@ApenasAtivos BIT"
    parametros_saida:
      - "Recordset: Id, Nome, Cor, Ordem, Ativo"
    descricao: |
      Consulta tabela específica do módulo (StatusChamado, StatusAtivo, StatusContrato) e retorna
      status filtrados por flag Ativo. Sem validação de ClienteId (violação de multi-tenancy).
    destino: "substituido"
    justificativa: "Lógica movida para Application Layer (CQRS Query) com filtro multi-tenant e cache Redis."
    rastreabilidade:
      rf_moderno: "RF-059 - RN-RF059-08 (Multi-tenancy com Itens Globais e Customizados)"
      regra_moderna: "RN-RF059-10 (Cache In-Memory)"
    migracao_moderna:
      handler: "GetItensDominioQueryHandler"
      validacao: "Query WHERE (ClienteId = @clienteId OR ClienteId IS NULL) AND Ativo = @apenasAtivos"

  - id: "LEG-RF059-005"
    tipo: "stored_procedure"
    nome: "sp_InativarStatus"
    caminho: "ic1_legado/BancoDados/Procedures/sp_InativarStatus.sql"
    parametros_entrada:
      - "@StatusId INT"
      - "@UsuarioId INT"
    parametros_saida:
      - "@Sucesso BIT OUTPUT"
    descricao: |
      Atualiza campo Ativo = 0 na tabela do status. Não verifica dependências (causava erros de foreign key),
      não registra auditoria e não registra motivo da inativação.
    destino: "substituido"
    justificativa: "Substituído por Command com validação de dependências (HTTP 409 se item em uso), auditoria completa e soft delete."
    rastreabilidade:
      rf_moderno: "RF-059 - RN-RF059-04 (Inativação com Validação de Dependências)"
      regra_moderna: "RN-RF059-09 (Histórico Completo de Alterações)"
    migracao_moderna:
      command_cqrs: "InativarItemDominioCommand"
      handler: "InativarItemDominioCommandHandler"
      validacao: "InativarItemDominioCommandValidator (verifica dependências antes de inativar)"

  # ------------------------------------------------------------------------------
  # TABELAS LEGADAS
  # ------------------------------------------------------------------------------
  - id: "LEG-RF059-006"
    tipo: "tabela"
    nome: "StatusChamado"
    caminho: "[dbo].[StatusChamado]"
    descricao: "Tabela para armazenar status de chamados (Aberto, Em Atendimento, Fechado, Cancelado)"
    problemas_identificados:
      - "Sem campo ClienteId (violação de multi-tenancy)"
      - "Sem campos de auditoria (CreatedAt, CreatedBy, ModifiedAt, ModifiedBy)"
      - "Uso de DELETE físico ao invés de soft delete"
      - "Sem suporte a traduções (apenas pt-BR)"
      - "Sem controle de transições permitidas"
    destino: "substituido"
    justificativa: "Consolidado na tabela genérica ItemDominio com multi-tenancy, auditoria completa e soft delete."
    rastreabilidade:
      rf_moderno: "RF-059 - Seção 13 (Rastreabilidade) - MD-RF059.md"
      md_moderno: "MD-RF059.md - Tabela ItemDominio"
    migracao_moderna:
      tabela_moderna: "ItemDominio (com DominioId = 'STATUS_CHAMADO')"
      migration_ef_core: "20251230_CreateDominioTipoAndItemDominio.cs"

  - id: "LEG-RF059-007"
    tipo: "tabela"
    nome: "Prioridade"
    caminho: "[dbo].[Prioridade]"
    descricao: "Tabela para armazenar prioridades de solicitações (Baixa, Média, Alta, Crítica)"
    problemas_identificados:
      - "Duplicação de estrutura com StatusChamado (campos idênticos)"
      - "Sem campo ClienteId (violação de multi-tenancy)"
      - "Sem auditoria"
      - "Sem soft delete"
      - "Typo em scripts relacionados (Plioridade)"
    destino: "substituido"
    justificativa: "Consolidado na tabela ItemDominio com DominioId = 'PRIORIDADE'."
    rastreabilidade:
      rf_moderno: "RF-059 - Seção 3 (Conceitos) - Domínio vs Item de Domínio"
      md_moderno: "MD-RF059.md - Tabela ItemDominio"
    migracao_moderna:
      tabela_moderna: "ItemDominio (com DominioId = 'PRIORIDADE')"
      migration_ef_core: "20251230_CreateDominioTipoAndItemDominio.cs"

  - id: "LEG-RF059-008"
    tipo: "tabela"
    nome: "StatusAtivo"
    caminho: "[dbo].[StatusAtivo]"
    descricao: "Tabela para armazenar status de ativos (Ativo, Inativo, Manutenção, Descartado)"
    problemas_identificados:
      - "Sem controle de transições (permitia mudar diretamente de Ativo para Descartado)"
      - "Sem histórico de alterações"
      - "Sem ClienteId (multi-tenancy)"
      - "DELETE físico (perda de dados históricos)"
    destino: "substituido"
    justificativa: "Consolidado na tabela ItemDominio com DominioId = 'STATUS_ATIVO' e tabela TransicaoPermitida para workflow."
    rastreabilidade:
      rf_moderno: "RF-059 - RN-RF059-03 (Validação de Transição de Estado)"
      md_moderno: "MD-RF059.md - Tabela ItemDominio + TransicaoPermitida"
    migracao_moderna:
      tabela_moderna: "ItemDominio (com DominioId = 'STATUS_ATIVO')"
      migration_ef_core: "20251230_CreateDominioTipoAndItemDominio.cs"

  - id: "LEG-RF059-009"
    tipo: "tabela"
    nome: "StatusContrato"
    caminho: "[dbo].[StatusContrato]"
    descricao: "Tabela para armazenar status de contratos (Rascunho, Aprovado, Vigente, Expirado)"
    problemas_identificados:
      - "Workflow de aprovação hard-coded em VB.NET (não parametrizável)"
      - "Sem ClienteId (multi-tenancy)"
      - "Sem auditoria completa"
      - "DELETE físico"
    destino: "substituido"
    justificativa: "Consolidado na tabela ItemDominio com DominioId = 'STATUS_CONTRATO'. Workflow agora configurável via TransicaoPermitida."
    rastreabilidade:
      rf_moderno: "RF-059 - Seção 4 (Funcionalidades) - Configurar Transições"
      md_moderno: "MD-RF059.md - Tabela TransicaoPermitida"
    migracao_moderna:
      tabela_moderna: "ItemDominio (com DominioId = 'STATUS_CONTRATO')"
      migration_ef_core: "20251230_CreateDominioTipoAndItemDominio.cs"

  - id: "LEG-RF059-010"
    tipo: "tabela"
    nome: "TipoCategoria"
    caminho: "[dbo].[TipoCategoria]"
    descricao: "Tabela para armazenar tipos e categorias genéricas (Tipo de Ativo, Tipo de Despesa, etc.)"
    problemas_identificados:
      - "Sem multi-tenancy (ClienteId ausente)"
      - "Sem i18n (apenas pt-BR)"
      - "Sem versionamento"
      - "Sem cache (queries repetitivas)"
    destino: "substituido"
    justificativa: "Consolidado na tabela DominioTipo com suporte a multi-tenancy, i18n (tabela TipoTraducao) e cache Redis."
    rastreabilidade:
      rf_moderno: "RF-059 - RN-RF059-07 (Internacionalização Obrigatória)"
      md_moderno: "MD-RF059.md - Tabela DominioTipo + TipoTraducao"
    migracao_moderna:
      tabela_moderna: "DominioTipo"
      migration_ef_core: "20251230_CreateDominioTipoAndItemDominio.cs"

  # ------------------------------------------------------------------------------
  # REGRAS IMPLÍCITAS
  # ------------------------------------------------------------------------------
  - id: "LEG-RF059-011"
    tipo: "regra_negocio"
    nome: "Validação de Nome Único (implícita no VB.NET)"
    caminho: "ic1_legado/IControlIT/ServiceDesk/CadastroStatusChamado.aspx.vb - Linha 145"
    descricao: |
      Ao criar ou editar status, verifica se já existe outro com o mesmo nome (case-insensitive).
      Validação executada apenas no frontend (code-behind VB.NET), sem validação backend.
    destino: "assumido"
    justificativa: "Regra mantida no sistema moderno com validação em ambas as camadas (API + UI)."
    rf_item_relacionado: "RN-RF059-01, RN-RF059-02"
    rastreabilidade:
      rf_moderno: "RF-059 - RN-RF059-01 (Código de Domínio Único por Cliente)"
      regra_moderna: "RN-RF059-02 (Código de Item Único por Domínio)"
    migracao_moderna:
      validador: "CreateItemDominioCommandValidator"
      linha_codigo: "RuleFor(x => x.Codigo).Must(BeUniqueInDomain).WithMessage('Código já existe neste domínio')"

  - id: "LEG-RF059-012"
    tipo: "regra_negocio"
    nome: "Ordenação Manual sem Reindexação (implícita no code-behind)"
    caminho: "ic1_legado/IControlIT/ServiceDesk/CadastroStatusChamado.aspx.vb - Linha 230"
    descricao: |
      Ao alterar ordem de um status, atualiza campo Ordem sem verificar duplicatas.
      Permitia gaps (1, 2, 5, 7) e duplicatas, causando comportamento inconsistente em dropdowns.
    destino: "substituido"
    justificativa: "Sistema moderno implementa reindexação automática ao alterar ordem. Inserção entre itens ajusta ordens superiores (+1)."
    rastreabilidade:
      rf_moderno: "RF-059 - RN-RF059-05 (Ordenação Customizada com Reindexação Automática)"
      regra_moderna: "RN-RF059-05"
    migracao_moderna:
      handler: "AlterarOrdemItemDominioCommandHandler"
      linha_codigo: "await ReindexarItensAsync(dominioId, novaOrdem)"

  - id: "LEG-RF059-013"
    tipo: "regra_negocio"
    nome: "Transições de Status Hard-coded (implícita no webservice)"
    caminho: "ic1_legado/IControlIT/WebServices/StatusService.asmx.vb - Linha 88"
    descricao: |
      Transições validadas via switch-case em VB.NET. Exemplo: Chamado "Aberto" (ID=1) só muda para
      "Em Atendimento" (ID=2) ou "Cancelado" (ID=5). Customização exigia redeployment.
    destino: "substituido"
    justificativa: "Sistema moderno usa tabela TransicaoPermitida parametrizável. Clientes configuram workflows específicos sem código."
    rastreabilidade:
      rf_moderno: "RF-059 - RN-RF059-03 (Validação de Transição de Estado)"
      regra_moderna: "RN-RF059-03"
    migracao_moderna:
      command_cqrs: "ValidarTransicaoCommand"
      handler: "ValidarTransicaoCommandHandler (consulta TransicaoPermitida)"

  - id: "LEG-RF059-014"
    tipo: "regra_negocio"
    nome: "Inativação sem Validação de Dependências (implícita na procedure)"
    caminho: "ic1_legado/BancoDados/Procedures/sp_InativarStatus.sql - Linha 12"
    descricao: |
      Ao inativar status, não verifica se existem chamados/ativos/contratos ativos usando-o.
      Causava erros de integridade referencial e dados órfãos.
    destino: "substituido"
    justificativa: "Sistema moderno valida dependências antes de inativar. HTTP 409 Conflict se item em uso, listando quantidade de registros afetados."
    rastreabilidade:
      rf_moderno: "RF-059 - RN-RF059-04 (Inativação com Validação de Dependências)"
      regra_moderna: "RN-RF059-04"
    migracao_moderna:
      validador: "InativarItemDominioCommandValidator"
      linha_codigo: "RuleFor(x => x.ItemId).MustAsync(NotHaveActiveDependencies).WithMessage('Item em uso')"

  - id: "LEG-RF059-015"
    tipo: "regra_negocio"
    nome: "Ausência de Multi-tenancy (problema arquitetural)"
    caminho: "Todas as tabelas de status (sem campo ClienteId)"
    descricao: |
      Isolamento via bancos separados (IControlIT_Cliente01, IControlIT_Cliente02...).
      Problemas de escalabilidade, backup e manutenção.
    destino: "substituido"
    justificativa: "Sistema moderno implementa Row-Level Security com ClienteId. Banco único consolidado, queries filtram automaticamente por tenant."
    rastreabilidade:
      rf_moderno: "RF-059 - RN-RF059-08 (Multi-tenancy com Itens Globais e Customizados)"
      regra_moderna: "RN-RF059-08"
    migracao_moderna:
      migration_ef_core: "20251230_AddMultiTenancyToAllTables.cs"
      query_filter: "builder.HasQueryFilter(e => e.ClienteId == _currentUser.ClienteId || e.ClienteId == null)"

  - id: "LEG-RF059-016"
    tipo: "regra_negocio"
    nome: "Cores e Ícones Hard-coded (implícita no HTML)"
    caminho: "ic1_legado/IControlIT/ServiceDesk/ListaChamados.aspx - Linha 340"
    descricao: |
      Cores definidas inline no HTML via VB.NET (style="background-color:#FF0000").
      Sem tabela de configuração, customização exigia editar ASPX. Sem suporte a ícones FontAwesome.
    destino: "substituido"
    justificativa: "Sistema moderno armazena cor (hex) e ícone (FontAwesome) na tabela ItemDominio. Customização via UI sem redeployment."
    rastreabilidade:
      rf_moderno: "RF-059 - Seção 2.1 (Escopo) - Associação de cores e ícones"
      md_moderno: "MD-RF059.md - Tabela ItemDominio (campos Cor, Icone)"
    migracao_moderna:
      componente_angular: "item-badge.component.ts (renderiza cor e ícone dinamicamente)"
      css: "Componente usa [ngStyle]='{ backgroundColor: item.cor }' e <i [class]='item.icone'></i>"

# ==============================================================================
# BANCOS LEGADOS MAPEADOS
# ==============================================================================

bancos_legados:
  - nome: "IControlIT_Cliente01"
    servidor: "SQL-LEGADO-01"
    tabelas_relacionadas:
      - "StatusChamado"
      - "Prioridade"
      - "StatusAtivo"
      - "StatusContrato"
      - "TipoCategoria"
    destino: "CONSOLIDADO"
    justificativa: "Migrado para banco único moderno com multi-tenancy (Row-Level Security). Dados preservados com campo ClienteId = 'cliente-01-guid'."
    banco_moderno: "IControlIT.db (SQLite dev) / SQL Server moderno (prod) com RLS"

  - nome: "IControlIT_Cliente02"
    servidor: "SQL-LEGADO-01"
    tabelas_relacionadas:
      - "StatusChamado"
      - "Prioridade"
      - "StatusAtivo"
      - "StatusContrato"
      - "TipoCategoria"
    destino: "CONSOLIDADO"
    justificativa: "Migrado para banco único moderno com ClienteId = 'cliente-02-guid'."
    banco_moderno: "IControlIT.db (SQLite dev) / SQL Server moderno (prod) com RLS"

  - nome: "IControlIT_Cliente03"
    servidor: "SQL-LEGADO-02"
    tabelas_relacionadas:
      - "StatusChamado"
      - "Prioridade"
      - "StatusAtivo"
      - "StatusContrato"
      - "TipoCategoria"
    destino: "CONSOLIDADO"
    justificativa: "Migrado para banco único moderno com ClienteId = 'cliente-03-guid'."
    banco_moderno: "IControlIT.db (SQLite dev) / SQL Server moderno (prod) com RLS"

# ==============================================================================
# PROBLEMAS LEGADO IDENTIFICADOS
# ==============================================================================

problemas_legado:
  - id: "PROB-RF059-001"
    titulo: "Ausência de Multi-tenancy (Bancos Separados)"
    severidade: "CRÍTICA"
    descricao: |
      Sistema legado usava bancos separados por cliente (IControlIT_Cliente01, IControlIT_Cliente02...).
      Isso causava problemas de escalabilidade, backup, deploy e manutenção.
    impacto: "Alto custo operacional, impossibilidade de consolidar dados, dificuldade em upgrades de schema."
    solucao_moderna: "Implementação de Row-Level Security com campo ClienteId em todas as tabelas. Banco único com isolamento via query filters."

  - id: "PROB-RF059-002"
    titulo: "Duplicação de Código e Tabelas"
    severidade: "ALTA"
    descricao: |
      Cada módulo (Chamados, Ativos, Contratos) tinha tabelas e telas separadas para status
      com estrutura idêntica (StatusChamado, StatusAtivo, StatusContrato).
    impacto: "Manutenção triplicada, bugs replicados em múltiplos lugares, impossibilidade de criar novos domínios sem desenvolvimento."
    solucao_moderna: "Consolidação em modelo genérico DominioTipo + ItemDominio. Novos domínios criados via UI sem código."

  - id: "PROB-RF059-003"
    titulo: "Transições Hard-coded em VB.NET"
    severidade: "ALTA"
    descricao: |
      Workflow de transições de status fixo em switch-case VB.NET. Customização de workflow exigia
      redeployment de código e testes completos.
    impacto: "Falta de flexibilidade operacional, lead time de semanas para ajustar workflows."
    solucao_moderna: "Tabela parametrizável TransicaoPermitida. Clientes configuram workflows via UI sem código."

  - id: "PROB-RF059-004"
    titulo: "Ausência de Auditoria e Versionamento"
    severidade: "MÉDIA"
    descricao: |
      Alterações em status não eram auditadas. Impossível rastrear quem mudou o que e quando.
      Dados eram sobrescritos sem histórico.
    impacto: "Violação de compliance (LGPD), dificuldade em troubleshooting, perda de dados históricos."
    solucao_moderna: "Tabela HistoricoDominioTipo com snapshots JSON (DadosAntes/DadosDepois). Retenção de 7 anos."

  - id: "PROB-RF059-005"
    titulo: "Sem Cache (Queries Repetitivas)"
    severidade: "MÉDIA"
    descricao: |
      Cada carregamento de dropdown executava query ao banco. Status eram carregados centenas de vezes
      por minuto sem cache.
    impacto: "Alta latência em telas com múltiplos dropdowns (120ms+ por query), sobrecarga do banco."
    solucao_moderna: "Cache Redis com TTL 24h. Taxa de cache hit >= 95%, latência reduzida para 5ms."

  - id: "PROB-RF059-006"
    titulo: "Inativação sem Validação de Dependências"
    severidade: "MÉDIA"
    descricao: |
      Ao inativar status, sistema não verificava se havia chamados/ativos/contratos ativos usando-o.
      Causava erros de foreign key e dados órfãos.
    impacto: "Erros em produção, necessidade de intervenção manual no banco, inconsistência de dados."
    solucao_moderna: "Validação obrigatória de dependências antes de inativar. HTTP 409 Conflict se item em uso, listando registros afetados."

# ==============================================================================
# METADADOS
# ==============================================================================

metadados:
  total_itens_legado: 16
  itens_assumidos: 1
  itens_substituidos: 15
  itens_descartados: 0
  itens_a_revisar: 0
  cobertura_destinos: "100%"
  total_bancos_legados: 3
  total_problemas_identificados: 6
