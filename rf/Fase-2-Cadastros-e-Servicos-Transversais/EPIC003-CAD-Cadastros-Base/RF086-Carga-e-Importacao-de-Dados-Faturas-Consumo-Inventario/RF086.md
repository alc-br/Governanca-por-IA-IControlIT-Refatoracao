# RF-086: Carga e Importação de Dados - Faturas, Consumo e Inventário

**Versão**: 2.0
**Data**: 2025-12-31
**Autor**: Agente de Migração de Documentação
**RF Relacionado**: RF032 (Gestão de Notas Fiscais), RF001-RF005, RF021 (Catálogo de Serviços)
**EPIC**: EPIC003-CAD-Cadastros-Base
**Fase**: Fase 2 - Cadastros e Serviços Transversais
**Versão de Governança**: 2.0 (Separação RF/RL)

---

## 1. VISÃO GERAL

### 1.1 Objetivo do Requisito

O RF-086 especifica o módulo de **Carga e Importação de Dados** do sistema IControlIT, responsável pela ingestão automatizada, validação, processamento e conciliação de dados provenientes de operadoras de telecomunicações brasileiras (Vivo, Claro, TIM, Oi), incluindo faturas eletrônicas, CDRs (Call Detail Records) e inventário de ativos.

### 1.2 Problema Resolvido

Atualmente, as organizações enfrentam desafios significativos no gerenciamento de faturas de telecomunicações:
- Processamento manual de arquivos, sujeito a erros humanos
- Falta de validação automática de integridade e conciliação
- Dificuldade em identificar cobranças indevidas (glosas)
- Ausência de rastreabilidade completa de importações
- Integração manual com sistemas de faturamento

O RF-086 resolve esses problemas automatizando todo o fluxo desde o upload até a integração com o módulo de Notas Fiscais (RF032).

### 1.3 Público Afetado

- **Gestores de Telecom**: Realizam importações e aprovam glosas
- **Supervisores Financeiros**: Aprovam conciliações e validam valores
- **Administradores de Sistema**: Configuram regras de glosa e monitoram processamentos
- **Auditores**: Consultam histórico de importações e evidências de conciliação
- **Sistemas Integrados**: RF032 (Notas Fiscais) consome dados validados

---

## 2. ESCOPO

### 2.1 Dentro do Escopo

- ✅ Importação de arquivos de fatura com suporte a múltiplos formatos por operadora
- ✅ Validação automática de formato, tamanho, encoding e integridade de dados
- ✅ Parsing específico por operadora (Vivo: XML, Claro: EDI, TIM: PDF, Oi: EDIFACT)
- ✅ Extração e registro de CDRs (Call Detail Records) individualizados
- ✅ Conciliação automática entre fatura e CDRs extraídos
- ✅ Detecção automática de anomalias e cobranças duplicadas
- ✅ Engine de glosa configurável com regras customizáveis
- ✅ Processamento assíncrono via Hangfire com retentativas automáticas
- ✅ Histórico completo de importações com rastreabilidade auditável
- ✅ Integração automática com RF032 (Notas Fiscais)
- ✅ Relatórios de conciliação com identificação de divergências
- ✅ Isolamento multi-tenant com Row-Level Security
- ✅ Auditoria completa de todas as operações

### 2.2 Fora do Escopo

- ❌ Interface de visualização específica (coberto por Frontend)
- ❌ OCR de faturas em PDF não estruturado (apenas PDF estruturado TIM)
- ❌ Integração direta com APIs de operadoras (upload manual apenas)
- ❌ Análise preditiva de consumo ou IA de otimização de custos
- ❌ Disputa automática com operadoras (apenas marcação de glosa)
- ❌ Processamento de faturas de outros tipos (energia, água, gás)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Fatura de Operadora** | Documento eletrônico enviado pela operadora de telecomunicação contendo lista de serviços prestados, consumos realizados, taxas administrativas e valores a cobrar em determinado período |
| **CDR (Call Detail Record)** | Registro granular de cada comunicação realizada, contendo origem, destino, duração, tipo de serviço, data/hora, valor |
| **Inventário de Ativos** | Cadastro de chips, linhas, DDD, planos, terminais associados a cada fatura |
| **Glosa** | Identificação e marcação de cobranças indevidas ou duplicadas, podendo ser automática (por regras) ou manual (por usuário) |
| **Conciliação Fatura vs Consumo** | Validação de que o consumo registrado nos CDRs corresponde exatamente ao consumo cobrado na fatura |
| **Divergência** | Discrepância entre consumo esperado e consumo faturado (valor diferente, item duplicado, consumo não faturado, fatura sem consumo) |
| **Operadora** | Empresa prestadora de serviços de telecomunicação (Vivo, Claro, TIM, Oi) |
| **Parser** | Componente responsável por extrair dados estruturados de arquivos de fatura conforme formato específico da operadora |
| **Multi-tenant** | Arquitetura que garante isolamento lógico de dados entre diferentes clientes/empresas |

---

## 4. FUNCIONALIDADES

### F01 - Importação de Arquivo de Fatura

Permite upload de arquivo de fatura de operadora com validação automática de formato, tamanho, encoding e schema.

**Critérios de Aceite**:
- Suportar arquivos de até 50MB
- Validar extensão conforme operadora (Vivo: .xml, Claro: .txt/.edi, TIM: .pdf, Oi: .txt/.edi)
- Validar encoding (UTF-8 ou ISO-8859-1)
- Rejeitar arquivos vazios ou corrompidos
- Gerar hash SHA256 para detecção de duplicação

### F02 - Parsing de Fatura por Operadora

Extrai dados estruturados do arquivo de fatura de acordo com formato específico da operadora utilizando padrão Strategy.

**Critérios de Aceite**:
- Implementar parser específico para cada operadora
- Extrair todos os campos obrigatórios (número fatura, data, valor total, itens)
- Retornar DTO padronizado independente do formato original
- Registrar erros de parsing com linha/campo específico

### F03 - Validação de Integridade de Dados

Valida que totalizadores da fatura (subtotal, impostos, desconto, total) correspondem exatamente à soma dos itens individuais.

**Critérios de Aceite**:
- Validar subtotal = soma(itens.subtotal)
- Validar total = subtotal + impostos - descontos (margem de ±R$ 0,01)
- Rejeitar fatura com discrepância superior a margem permitida
- Gerar relatório detalhado de erros de integridade

### F04 - Processamento de CDR

Extrai e registra cada item de consumo como um CDR individual com rastreamento completo de origem.

**Critérios de Aceite**:
- Criar registro CDR para cada item da fatura
- Rastrear fatura de origem, linha, serviço, valor, quantidade
- Registrar data/hora de importação e usuário
- Suportar soft delete para auditoria histórica

### F05 - Conciliação Automática Fatura vs CDRs

Compara valor total da fatura com soma dos CDRs extraídos e identifica divergências.

**Critérios de Aceite**:
- Calcular diferença entre valor fatura e soma CDRs
- Marcar conciliação como "Conciliada" se diferença ≤ R$ 0,01
- Marcar como "Divergente" se diferença > R$ 0,01
- Listar itens não encontrados em CDRs e vice-versa
- Gerar relatório de divergências com valores e quantidades

### F06 - Detecção de Cobranças Duplicadas

Identifica automaticamente quando o mesmo item aparece mais de uma vez no arquivo ou em importações diferentes.

**Critérios de Aceite**:
- Gerar fingerprint de cada CDR (hash de descrição+valor+data)
- Comparar com CDRs já existentes no banco (mesmo tenant)
- Detectar duplicação intra-fatura (mesmo item 2x no mesmo arquivo)
- Detectar duplicação inter-faturas (mesmo CDR em meses diferentes)
- Marcar CDRs duplicados com status "Duplicado"

### F07 - Glosa Automática de Cobranças Indevidas

Aplica regras configuráveis para identificar automaticamente cobranças indevidas.

**Critérios de Aceite**:
- Implementar engine de regras plugável (pattern Strategy)
- Suportar regras de duplicação, valor outlier, serviço não autorizado
- Marcar CDRs glosados com status "Bloqueado"
- Gerar registro de Glosa com evidência e motivo
- Permitir aprovação/rejeição manual posterior

### F08 - Histórico de Importações

Registra cada importação com dados completos de execução e estatísticas de processamento.

**Critérios de Aceite**:
- Registrar arquivo original, hash, operadora, usuário, timestamp
- Rastrear status (Validando → Processando → Concluída / ProcessadoComErro)
- Contar itens extraídos, válidos, com erro, glosados
- Permitir consulta de histórico com filtros (operadora, período, status)
- Manter histórico imutável (auditoria)

### F09 - Relatórios de Conciliação

Gera relatórios comparativos entre fatura e consumo com identificação de divergências.

**Critérios de Aceite**:
- Listar faturas conciliadas vs divergentes
- Exibir diferença de valor e quantidade de itens
- Permitir filtros por operadora, período, status
- Suportar exportação em PDF e Excel
- Incluir gráficos de taxa de conciliação

### F10 - Integração com RF032 (Notas Fiscais)

Envia dados de fatura validados para módulo de Notas Fiscais após aprovação.

**Critérios de Aceite**:
- Mapear dados de fatura para comando CreateNotaFiscalCommand
- Enviar para RF032 via REST API após status "Concluída"
- Atualizar importação com ID da Nota Fiscal criada
- Registrar erro se integração falhar (status "ProcessadoComErro")
- Permitir retentativa manual de integração

---

## 5. REGRAS DE NEGÓCIO

### RN-CRG-086-001: Validação de Formato de Arquivo

**Descrição**: Todo arquivo importado DEVE ser validado quanto a formato, encoding, tamanho máximo e conformidade com schema esperado da operadora específica.

**Tipo**: Validação
**Criticidade**: CRÍTICA
**Campos Afetados**: arquivo, operadora
**Implementação**: Backend (FileValidator) + Frontend (validação pré-upload)

**Critério de Aceite**:
- Arquivo > 50MB → rejeição com erro "Arquivo excede tamanho máximo de 50MB"
- Extensão inválida → rejeição com erro "Extensão inválida. Esperado: [extensões]"
- Arquivo vazio → rejeição com erro "Arquivo vazio"
- Encoding inválido → rejeição com erro "Erro ao ler arquivo: [detalhe]"

**Mensagem de Erro**: "Arquivo inválido: {motivo}"
**HTTP Code**: 400

---

### RN-CRG-086-002: Parser Específico por Operadora

**Descrição**: Cada operadora possui formato de fatura distinto. DEVE existir um parser específico que extrai corretamente os campos conforme layout esperado.

**Tipo**: Regra de Negócio
**Criticidade**: CRÍTICA
**Implementação**: Backend (Pattern Strategy com VivoXmlParser, ClaroEdiParser, TimPdfParser, OiEdifactParser)

**Critério de Aceite**:
- Operadora Vivo → usar VivoXmlParser (arquivo XML)
- Operadora Claro → usar ClaroEdiParser (arquivo EDI)
- Operadora TIM → usar TimPdfParser (PDF estruturado)
- Operadora Oi → usar OiEdifactParser (arquivo EDIFACT)
- Operadora não suportada → rejeição com erro "Operadora {nome} não suportada"

**Mensagem de Erro**: "Operadora não suportada: {operadora}"
**HTTP Code**: 400

---

### RN-CRG-086-003: Registro de CDR com Rastreamento Completo

**Descrição**: Cada item de consumo importado DEVE ser registrado como um CDR individual com rastreamento de origem, data/hora, quantidade, valor e referência à fatura de origem.

**Tipo**: Regra de Negócio
**Criticidade**: ALTA
**Implementação**: Backend (CdrEntity com FK para FaturaEntity, campos de auditoria)

**Critério de Aceite**:
- Cada item da fatura → um registro CdrEntity
- CDR deve conter: IdFaturaOrigem, NumeroLinha, Servico, Valor, Quantidade, DataImportacao, IdUsuarioImportacao
- Soft delete obrigatório (FlExcluido = true ao invés de DELETE físico)

---

### RN-CRG-086-004: Validação de Integridade de Totalizações

**Descrição**: Antes de qualquer processamento, DEVE ser validado que os totalizadores da fatura (subtotal, impostos, desconto, total) correspondem exatamente à soma dos itens individuais. Qualquer discrepância DEVE ser rejeitada com erro específico.

**Tipo**: Validação
**Criticidade**: CRÍTICA
**Campos Afetados**: ValorSubtotal, ValorImpostos, ValorDesconto, ValorTotal
**Implementação**: Backend (IntegridadeValidator)

**Critério de Aceite**:
- |subtotalCalculado - fatura.ValorSubtotal| > 0.01 → erro "Subtotal inconsistente"
- |impostosCalculados - fatura.ValorImpostos| > 0.01 → erro "Impostos inconsistentes"
- |totalCalculado - fatura.ValorTotal| > 0.01 → erro "Total inconsistente"
- Margem de tolerância: R$ 0,01 para arredondamentos

**Mensagem de Erro**: "Integridade de totalizações inválida: {detalhes}"
**HTTP Code**: 400

---

### RN-CRG-086-005: Detecção de Cobranças Duplicadas

**Descrição**: DEVE ser detectado automaticamente quando o mesmo item de fatura (mesmo CDR, mesma descrição, mesma data) aparece mais de uma vez no arquivo ou em importações diferentes. Duplicatas DEVEM ser marcadas com status "Duplicado" e DEVEM gerar alerta para revisão do usuário.

**Tipo**: Regra de Negócio
**Criticidade**: ALTA
**Implementação**: Backend (DuplicacaoDetector com cálculo de fingerprint)

**Critério de Aceite**:
- CDR com mesmo fingerprint já existe → marcar como "Duplicado"
- CDR aparece 2x no mesmo arquivo → marcar duplicatas (exceto primeira ocorrência)
- Gerar alerta para usuário com quantidade de duplicatas encontradas

---

### RN-CRG-086-006: Conciliação Automática Fatura vs CDRs

**Descrição**: Para cada fatura importada, DEVE ser executada automaticamente uma conciliação que compara valor total da fatura com soma dos CDRs extraídos. Discrepâncias DEVEM ser identificadas e classificadas (valor, quantidade, item faltante, item extra).

**Tipo**: Regra de Negócio
**Criticidade**: ALTA
**Implementação**: Backend (ConciliadorFaturaVsCdr)

**Critério de Aceite**:
- |ValorFatura - Sum(CDRs.ValorCobrado)| ≤ 0.01 → status "Conciliada"
- |ValorFatura - Sum(CDRs.ValorCobrado)| > 0.01 → status "Divergente"
- QuantidadeItensFatura ≠ QuantidadeCDRs → status "Divergente"
- Gerar lista de itens não encontrados em CDRs e vice-versa

---

### RN-CRG-086-007: Glosa Automática de Cobranças Indevidas

**Descrição**: DEVEM ser definidas regras configuráveis que identificam automaticamente cobranças indevidas (duplicatas, valores outliers, serviços não autorizados). Itens glosados DEVEM ser marcados com status "Glosado" e DEVEM gerar um registro de Glosa com evidência.

**Tipo**: Regra de Negócio
**Criticidade**: ALTA
**Implementação**: Backend (GlosaProcessor + IGlosaRule interface + regras específicas)

**Critério de Aceite**:
- Duplicação detectada → status "Bloqueado" + registro de Glosa
- Valor outlier (> 50% da média histórica) → status "Bloqueado" + registro de Glosa
- Serviço não autorizado → status "Bloqueado" + registro de Glosa
- Registro de Glosa deve conter: Motivo, Evidência, ValorGlosado, DataGlosa

---

### RN-CRG-086-008: Histórico Completo de Importações

**Descrição**: Cada importação DEVE criar um registro de Importação que rastreia arquivo original, data, usuário, quantidade de registros processados, quantidade de erros, quantidade de glosados, e status de processamento. Histórico DEVE ser imutável (auditoria).

**Tipo**: Auditoria
**Criticidade**: CRÍTICA
**Implementação**: Backend (ImportacaoEntity + soft delete obrigatório)

**Critério de Aceite**:
- Registro de importação criado antes de processamento
- Hash SHA256 do arquivo armazenado para detecção de duplicação
- Status atualizado em tempo real (Validando → Processando → Concluída / ProcessadoComErro)
- Soft delete apenas (FlExcluido = true, nunca DELETE físico)

---

### RN-CRG-086-009: Integração com Módulo de Notas Fiscais (RF032)

**Descrição**: Quando uma importação é concluída com sucesso e aprovada, os dados de fatura DEVEM ser automaticamente enviados para o módulo de Notas Fiscais (RF032) para criação de Nota Fiscal correspondente. O status da importação DEVE ser atualizado para refletir sucesso da integração ou falha.

**Tipo**: Integração
**Criticidade**: ALTA
**Implementação**: Backend (IntegradorComRF032 + REST API call para RF032)

**Critério de Aceite**:
- Importação com status "Concluída" → enviar para RF032
- Sucesso integração → atualizar IdFaturaExtraida + manter status "Concluída"
- Falha integração → status "ProcessadoComErro" + DescricaoErroProcessamento preenchida
- Permitir retentativa manual após falha

---

### RN-CRG-086-010: Processamento Assíncrono via Hangfire

**Descrição**: Processamento de importações DEVE ser executado de forma assíncrona via Hangfire, permitindo múltiplos uploads simultâneos. Status DEVE ser atualizado em tempo real e acessível via API. Erros DEVEM gerar retentativas automáticas (máx. 3 vezes) com backoff exponencial.

**Tipo**: Infraestrutura
**Criticidade**: ALTA
**Implementação**: Backend (Hangfire + AutomaticRetry decorator + ProcessadorImportacaoHangfire)

**Critério de Aceite**:
- Upload cria job Hangfire assíncrono
- Falhas geram retentativa automática (máx. 3x)
- Status acessível via GET /api/carga/importacoes/{id}/status
- Timeout de processamento: 30 minutos (após isso, cancelar job)

---

## 6. INTEGRAÇÕES OBRIGATÓRIAS

### 6.1 i18n (Internacionalização - Transloco)

**Idiomas Suportados**: pt-BR (padrão), en, es

**Chaves Obrigatórias**:
- `carga.importacao.titulo`: "Importar Faturas de Operadoras"
- `carga.importacao.labels.*`: Todos os labels de campos
- `carga.importacao.mensagens.*`: Mensagens de sucesso/erro
- `carga.importacao.validacoes.*`: Mensagens de validação
- `carga.importacao.status.*`: Labels de status

**Critério de Aceite**:
- Todas as strings visíveis ao usuário devem usar chaves Transloco
- Fallback automático: pt-BR → en → es
- Mensagens de erro de API devem suportar header Accept-Language

---

### 6.2 Auditoria

**Operações Auditadas**:

| Operação | Código | Dados Registrados |
|----------|--------|-------------------|
| Upload de arquivo | `CARGA_IMPORTACAO_UPLOAD` | Nome arquivo, hash SHA256, tamanho, operadora, usuário, IP |
| Parsing concluído | `CARGA_IMPORTACAO_PARSING` | Quantidade itens extraídos, valor total, período fatura |
| Conciliação executada | `CARGA_IMPORTACAO_CONCILIACAO` | Status conciliação, divergências encontradas, valor diferença |
| Glosa automática aplicada | `CARGA_GLOSA_AUTOMATICA_APLICADA` | Quantidade glosado, itens afetados, regra aplicada |
| Glosa aprovada manualmente | `CARGA_GLOSA_APROVACAO_MANUAL` | Usuário aprovador, data, itens aprovados |
| Integração com RF032 | `CARGA_INTEGRACAO_RF032` | ID Nota Fiscal criada, status integração, data |

**Retenção**: 7 anos (conforme LGPD e requisitos de auditoria fiscal)

---

### 6.3 Controle de Acesso (RBAC)

**Permissões**:

| Código | Descrição | Perfis Padrão |
|--------|-----------|---------------|
| `carga:importacao:create` | Realizar upload de arquivo | Gestor Telecom, Supervisor Financeiro, Admin |
| `carga:importacao:read` | Visualizar histórico de importações | Todos (com filtro por tenant) |
| `carga:importacao:update` | Reprocessar importação | Gestor Telecom, Admin |
| `carga:importacao:delete` | Remover registro de importação | Admin (apenas ambiente desenvolvimento) |
| `carga:glosa:read` | Visualizar glosas | Gestor Telecom, Supervisor Financeiro, Admin |
| `carga:glosa:approve` | Aprovar glosas | Supervisor Financeiro, Admin |
| `carga:glosa:reject` | Rejeitar glosas | Supervisor Financeiro, Admin |
| `carga:configuracao:update` | Alterar regras de glosa | Admin |
| `carga:relatorios:export` | Exportar relatórios | Gestor Telecom, Supervisor Financeiro, Admin |

**Matriz de Perfis**:

| Perfil | Importação | Visualização | Aprovação de Glosa | Configuração |
|--------|-----------|--------------|-------------------|--------------|
| **Gestor Telecom** | ✓ | ✓ | ✗ | ✗ |
| **Supervisor Financeiro** | ✗ | ✓ | ✓ | ✗ |
| **Admin** | ✓ | ✓ | ✓ | ✓ |
| **Auditor** | ✗ | ✓ | ✗ | ✗ |

---

### 6.4 Central de Funcionalidades (Feature Flags)

**Feature Keys**:

**1. CARGA_IMPORTACAO_FATURAS**
```json
{
    "featureKey": "CARGA_IMPORTACAO_FATURAS",
    "nome": "Importação de Faturas de Operadoras",
    "descricao": "Permite upload, validação e processamento de faturas de operadoras de telecom",
    "habilitado": true,
    "isSystemFeature": false,
    "operadorasSuportadas": ["VIVO", "CLARO", "TIM", "OI"],
    "tamanhoMaximoArquivoMb": 50,
    "timeoutProcessamentoMinutos": 30
}
```

**2. CARGA_GLOSA_AUTOMATICA**
```json
{
    "featureKey": "CARGA_GLOSA_AUTOMATICA",
    "nome": "Glosa Automática de Cobranças",
    "descricao": "Ativa aplicação automática de regras de glosa durante processamento",
    "habilitado": true,
    "isSystemFeature": false,
    "requerAprovacaoManual": false
}
```

**Critério de Aceite**:
- Feature desabilitada → bloquear novos uploads com mensagem "Funcionalidade temporariamente indisponível"
- Feature pode ser desabilitada globalmente ou por tenant específico

---

## 7. API ENDPOINTS

### 7.1 Operações de Importação

| Método | Endpoint | Descrição | Permissão | Request | Response |
|--------|----------|-----------|-----------|---------|----------|
| POST | `/api/carga/importacoes` | Criar nova importação (upload) | `carga:importacao:create` | FormFile + OperadoraEnum | ImportacaoDTO |
| GET | `/api/carga/importacoes` | Listar importações com filtros | `carga:importacao:read` | Query params | PaginatedListDto<ImportacaoDTO> |
| GET | `/api/carga/importacoes/{id}` | Obter detalhes de importação | `carga:importacao:read` | id: Guid | ImportacaoDTO |
| GET | `/api/carga/importacoes/{id}/status` | Obter status em tempo real | `carga:importacao:read` | id: Guid | StatusImportacaoDTO |
| POST | `/api/carga/importacoes/{id}/reprocessar` | Reprocessar importação | `carga:importacao:update` | id: Guid | ImportacaoDTO |
| DELETE | `/api/carga/importacoes/{id}` | Deletar importação (soft delete) | `carga:importacao:delete` | id: Guid | void |
| GET | `/api/carga/importacoes/{id}/arquivo` | Download do arquivo original | `carga:importacao:read` | id: Guid | FileResult |
| GET | `/api/carga/importacoes/{id}/cdrs` | Listar CDRs extraídos | `carga:importacao:read` | id: Guid | List<CdrDTO> |

### 7.2 Operações de Glosa

| Método | Endpoint | Descrição | Permissão | Request | Response |
|--------|----------|-----------|-----------|---------|----------|
| GET | `/api/carga/glosas` | Listar glosas pendentes | `carga:glosa:read` | Query params | PaginatedListDto<GlosaDTO> |
| GET | `/api/carga/glosas/{id}` | Obter detalhes da glosa | `carga:glosa:read` | id: Guid | GlosaDTO |
| PUT | `/api/carga/glosas/{id}/aprovar` | Aprovar glosa | `carga:glosa:approve` | id: Guid | GlosaDTO |
| PUT | `/api/carga/glosas/{id}/rejeitar` | Rejeitar glosa | `carga:glosa:reject` | id: Guid + motivo | GlosaDTO |
| POST | `/api/carga/glosas/aprovar-lote` | Aprovar múltiplas glosas | `carga:glosa:approve` | List<Guid> | BatchResultDTO |
| POST | `/api/carga/glosas/rejeitar-lote` | Rejeitar múltiplas glosas | `carga:glosa:reject` | List<Guid> + motivo | BatchResultDTO |

### 7.3 Operações de Conciliação e Relatórios

| Método | Endpoint | Descrição | Permissão | Request | Response |
|--------|----------|-----------|-----------|---------|----------|
| GET | `/api/carga/conciliacao` | Listar conciliações | `carga:relatorios:read` | Query params | PaginatedListDto<ConciliacaoDTO> |
| GET | `/api/carga/conciliacao/{id}` | Obter detalhes conciliação | `carga:relatorios:read` | id: Guid | ResultadoConciliacaoDTO |
| GET | `/api/carga/relatorios/conciliacao/exportar` | Exportar relatório | `carga:relatorios:export` | formato: pdf/excel | FileResult |
| GET | `/api/carga/relatorios/divergencias` | Listar divergências | `carga:relatorios:read` | Query params | List<DivergenciaDTO> |

### 7.4 Operações de Configuração

| Método | Endpoint | Descrição | Permissão | Request | Response |
|--------|----------|-----------|-----------|---------|----------|
| GET | `/api/carga/configuracao/regras-glosa` | Listar regras de glosa | `carga:configuracao:read` | - | List<RegraGlosaDTO> |
| POST | `/api/carga/configuracao/regras-glosa` | Criar nova regra de glosa | `carga:configuracao:update` | RegraGlosaCommand | RegraGlosaDTO |
| PUT | `/api/carga/configuracao/regras-glosa/{id}` | Atualizar regra de glosa | `carga:configuracao:update` | id + RegraGlosaCommand | RegraGlosaDTO |
| DELETE | `/api/carga/configuracao/regras-glosa/{id}` | Deletar regra de glosa | `carga:configuracao:update` | id: Guid | void |
| GET | `/api/carga/configuracao/operadoras` | Listar operadoras suportadas | `carga:configuracao:read` | - | List<OperadoraDTO> |

---

## 8. MODELO DE DADOS

**Referência**: Ver [MD-RF086.md](./MD-RF086.md) para DDL completo, ER diagram e relacionamentos.

**Entidades Principais**:

- **ImportacaoEntity**: Registro de cada importação com rastreamento completo
- **FaturaEntity**: Dados estruturados da fatura importada
- **CdrEntity**: Call Detail Record individual com rastreamento de origem
- **GlosaEntity**: Registro de glosa com evidência e motivo
- **ConciliacaoEntity**: Resultado de conciliação fatura vs CDRs
- **RegraGlosaEntity**: Regra configurável de glosa automática

**Características Obrigatórias**:
- Multi-tenancy: Campo `IdFornecedor` em todas as tabelas
- Auditoria: Campos `Created`, `CreatedBy`, `LastModified`, `LastModifiedBy`
- Soft Delete: Campo `FlExcluido` ao invés de DELETE físico
- Isolamento: Row-Level Security por `IdFornecedor`

---

## 9. DEPENDÊNCIAS

### 9.1 Dependências Upstream (RF-086 depende de)

| RF | Descrição | Tipo de Dependência |
|----|-----------|-------------------|
| RF032 | Gestão de Notas Fiscais | Integração (recebe dados de fatura) |
| RF001-RF005 | Cadastros Base | Dados de Empresa, Filial, Centro de Custo |
| RF021 | Catálogo de Serviços | Validação de serviços autorizados |

### 9.2 Dependências Downstream (Quem depende de RF-086)

| RF/Módulo | Descrição | Tipo de Dependência |
|-----------|-----------|-------------------|
| Dashboards Analytics | Dados de consumo e custo | Consulta de CDRs e conciliações |
| Relatórios Gerenciais | Análise de gastos telecom | Consulta de faturas e glosas |
| Módulo de Otimização | Recomendações de economia | Histórico de consumo |

### 9.3 Bibliotecas Externas

| Biblioteca | Versão | Finalidade |
|-----------|---------|-----------|
| Hangfire | 1.8+ | Processamento assíncrono e retentativas |
| iTextSharp / PDFSharp | Latest | Parsing de PDF estruturado (TIM) |
| System.Xml | .NET 10 | Parsing de XML (Vivo) |
| EPPlus | 7.0+ | Exportação de relatórios Excel |

---

## 10. KPIs E MÉTRICAS

| KPI | Meta | Medição | Periodicidade |
|-----|------|---------|---------------|
| **Taxa de Sucesso de Importação** | ≥ 98% | (Importações Concluídas / Total Importações) × 100 | Diária |
| **Tempo Médio de Processamento** | ≤ 2 min | Tempo desde upload até conciliação concluída | Por importação |
| **Taxa de Glosa Automática** | 5-15% | (Itens Glosados / Total Itens Processados) × 100 | Mensal |
| **Taxa de Conciliação Automática** | ≥ 95% | (Faturas Conciliadas Sem Divergência / Total) × 100 | Mensal |
| **Tempo de Aprovação de Glosa** | ≤ 24h | Intervalo entre criação e aprovação/rejeição | Por glosa |
| **Taxa de Acurácia de Parsing** | ≥ 99,5% | (Itens Extraídos Corretamente / Total) × 100 | Por importação |
| **Disponibilidade do Serviço** | ≥ 99,5% | Uptime do endpoint de importação | Mensal |
| **Taxa de Erros de Integração RF032** | ≤ 0,5% | (Falhas Integração / Total Integrações) × 100 | Mensal |
| **Volume Processado por Hora** | ≥ 500 itens/hora | Total itens CDR processados por hora | Horária |
| **Taxa de Reprocessamento** | ≤ 2% | (Importações Reprocessadas / Total) × 100 | Mensal |

---

## 11. ALERTAS CRÍTICOS

| Alerta | Condição | Threshold | Ação | Severidade |
|--------|----------|-----------|------|-----------|
| **Arquivo Muito Grande** | Tamanho > 40MB | 40MB | Avisar usuário, permitir continuar | BAIXA |
| **Processamento Lento** | Tempo > 5 min | 5 minutos | Notificar admin, verificar gargalo | MÉDIA |
| **Taxa de Erro Alta** | Itens com erro > 50 | 50 itens | Pausar processamento, notificar admin | ALTA |
| **Glosa Excessiva** | Taxa de glosa > 30% | 30% | Alertar supervisor, revisar regras | ALTA |
| **Divergência Alta** | Diferença fatura vs CDR > R$ 1.000 | R$ 1.000 | Requer aprovação manual, notificar supervisor | CRÍTICA |
| **Falha Repetida** | 3 retentativas falhadas | 3 tentativas | Notificar admin, criar ticket suporte | ALTA |
| **Arquivo Duplicado** | Hash SHA256 já existe | Duplicação detectada | Avisar usuário, perguntar se reprocessar | MÉDIA |
| **Timeout de Processamento** | Tempo > 30 min | 30 minutos | Cancelar job, registrar erro, notificar usuário | ALTA |
| **Fila de Hangfire Acumulada** | Jobs pendentes > 100 | 100 jobs | Escalacionar para operações, aumentar workers | CRÍTICA |
| **Indisponibilidade RF032** | Integração falha 3x consecutivas | 3 falhas | Marcar AguardandoAprovacao, notificar admin | ALTA |

**Canais de Notificação**:
- **Email**: Todas as severidades
- **Slack**: ALTA e CRÍTICA
- **SMS**: Apenas CRÍTICA

---

## 12. CENTRAL DE FUNCIONALIDADES

**Código da Funcionalidade**: `FUNC-CRG-086`

**Módulo**: Carga e Importação

**Registro na Central**:
```json
{
    "codigoFuncionalidade": "FUNC-CRG-086",
    "nomeI18nKey": "carga.importacao.titulo",
    "descricaoI18nKey": "carga.importacao.descricao",
    "moduloPai": "CARGA",
    "icone": "upload",
    "rota": "/carga/importar-faturas",
    "ordem": 1,
    "habilitado": true,
    "visivel": true,
    "permissaoRequerida": "carga:importacao:create"
}
```

**Subitens (Menu)**:
- Importar Faturas (`/carga/importar-faturas`)
- Histórico de Importações (`/carga/historico-importacoes`)
- Glosas Pendentes (`/carga/glosa-manual`)
- Relatórios de Conciliação (`/relatorios/conciliacao`)
- Configuração de Regras de Glosa (`/configuracao/regras-glosa`)

---

## ARTEFATOS DERIVADOS

Este RF é base para:

- [UC-RF086.md](./UC-RF086.md) - Casos de Uso (5 UCs obrigatórios)
- [MD-RF086.md](./MD-RF086.md) - Modelo de Dados (DDL completo, ER diagram)
- [WF-RF086.md](./WF-RF086.md) - Fluxos e Wireframes (telas Angular, transições de estado)
- [user-stories.yaml](./user-stories.yaml) - User Stories implementáveis
- [TC-RF086-BACKEND.yaml](./Testes/Backend/TC-RF086-BACKEND.yaml) - Casos de Teste Backend
- [TC-RF086-FRONTEND.yaml](./Testes/Sistema/TC-RF086-FRONTEND.yaml) - Casos de Teste Frontend
- [TC-RF086-SEGURANCA.yaml](./Testes/Outros/TC-RF086-SEGURANCA.yaml) - Casos de Teste Segurança

---

## RASTREABILIDADE

| Artefato | Status | Obrigatório |
|----------|--------|-------------|
| Casos de Uso (UC) | Pendente | Sim |
| Modelo de Dados (MD) | Pendente | Sim |
| Fluxos e Wireframes (WF) | Pendente | Sim |
| User Stories (YAML) | Pendente | Sim |
| Testes Backend (TC) | Pendente | Sim |
| Testes Frontend (TC) | Pendente | Sim |
| Testes Segurança (TC) | Pendente | Sim |
| Referência ao Legado (RL) | Pendente | Sim |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-31 | Migração v1.0 → v2.0: Separação RF/RL, remoção de conteúdo legado, adequação a padrões de Governança v2.0 | Agente de Migração de Documentação |
| 1.0 | 2025-12-28 | Versão inicial - RF086 completo com 9 seções (continha mistura de legado) | Claude Architect |

---

**Última Atualização**: 2025-12-31
**Versão de Governança**: 2.0 (Separação RF/RL)
**Autor**: Agente de Migração de Documentação
**Revisão**: Pendente
