# RF-015: Gestão de Locais e Endereços

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC003-CAD - Cadastros Base
**Fase**: Fase 2 - Cadastros e Serviços Transversais

---

## 1. OBJETIVO DO REQUISITO

Permitir que o sistema gerencie a estrutura física e geográfica da empresa através de uma hierarquia completa de locais (País → Estado → Cidade → Edifício → Andar → Sala → Rack → Posição), integrada com validação automática de endereços e geocodificação, possibilitando rastreamento preciso da localização de ativos, cumprimento de conformidade regulatória, otimização operacional e análise geoespacial.

Este requisito define **o que o sistema deve fazer** em relação à gestão de locais e endereços, sem especificar tecnologias, linguagens ou frameworks de implementação.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] CRUD completo de endereços com validação de CEP
- [x] CRUD de hierarquia de locais (Edifício, Andar, Sala, Rack, Posição)
- [x] Validação automática de CEP via API externa (ViaCEP)
- [x] Geocodificação automática de endereços (latitude/longitude)
- [x] Controle de capacidade de racks (altura, profundidade, peso, potência)
- [x] Controle de ocupação de posições em racks (sem sobreposição)
- [x] Histórico imutável de movimentações de ativos entre locais
- [x] Validação de tipos de sala e compatibilidade com racks
- [x] Endereço principal único por tenant
- [x] Isolamento multi-tenant (cada conglomerado vê apenas seus locais)
- [x] Auditoria completa de todas as operações
- [x] Permissões RBAC granulares por operação

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (componentes Angular, layout, UX)
- Tecnologia de implementação (backend/frontend)
- Estratégia de deploy ou infraestrutura
- Visualização de mapa interativo (feature opcional via feature flag)
- Importação em lote de locais (feature opcional)
- Integração com sistemas de logística ou RTLS
- Cálculo de custo de deslocamento
- Relatórios de distribuição geográfica (features opcionais)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-----|---------|
| **Endereço** | Informação geográfica completa (logradouro, número, complemento, bairro, cidade, estado, CEP, país) associada a um local físico |
| **Local** | Estrutura hierárquica que representa uma posição geográfica ou física dentro da organização |
| **Hierarquia de Locais** | Estrutura em árvore onde cada nível depende do nível anterior: País → Estado → Cidade → Edifício → Andar → Sala → Rack → Posição |
| **Geocodificação** | Processo de conversão de endereço em coordenadas geográficas (latitude/longitude) |
| **Rack** | Armário de TI padronizado em Us (unidades de 1,75 polegadas) para instalação de equipamentos |
| **Posição U** | Unidade de espaço vertical em rack (U1, U2, ..., U48) |
| **Tenant** | Conglomerado (unidade de isolamento multi-tenant) |
| **Movimentação** | Mudança de localização física de um ativo entre dois locais |
| **Histórico de Movimentação** | Registro imutável (append-only) de toda mudança de local de ativo |
| **Endereço Principal** | Único endereço marcado como sede/localização oficial por tenant |

---

## 4. FUNCIONALIDADES COBERTAS

1. Criar endereço com validação automática de CEP
2. Atualizar endereço existente
3. Listar endereços do tenant
4. Inativar endereço (soft delete)
5. Consultar endereço por CEP via API externa
6. Geocodificar endereço automaticamente
7. Criar local (Edifício, Andar, Sala, Rack, Posição)
8. Atualizar local existente
9. Consultar hierarquia de locais
10. Inativar local em cascata
11. Criar rack com validação de capacidade
12. Instalar equipamento em posição de rack
13. Remover equipamento de rack
14. Registrar movimentação de ativo entre locais
15. Validar movimentação registrada
16. Consultar histórico de movimentações

---

## 5. REGRAS DE NEGÓCIO

### RN-RF015-01 — Validação de CEP Obrigatória

**Descrição**: CEPs brasileiros devem ter exatamente 8 dígitos numéricos no formato XXXXX-XXX ou XXXXXXXX. A validação ocorre em duas camadas: formato numérico correto e existência no cadastro de CEPs do Brasil via API externa (ViaCEP).

**Justificativa**: Garante consistência dos dados endereçais, reduz erros de digitação, facilita processamento de correspondência e auditoria.

**Critério de Aceite**:
- CEP no formato inválido → rejeição HTTP 400
- CEP não existente em ViaCEP → rejeição HTTP 400
- CEP válido → campos estado, cidade e bairro autocompletados
- Endereço atualizado sem CEP → campos preenchidos manualmente com validação

---

### RN-RF015-02 — Endereço Principal Único por Tenant

**Descrição**: Apenas um local pode ser marcado como "Principal" (flag Fl_Principal = true) por tenant. Ao marcar novo local como principal, o sistema automaticamente desmarca o anterior.

**Justificativa**: Garante que não haja ambiguidade sobre qual é a sede/localização oficial da empresa.

**Critério de Aceite**:
- Tenant sem endereço principal → permitir marcar qualquer endereço como principal
- Tenant com endereço principal → ao marcar novo como principal, desmarcar automaticamente o anterior
- Tentativa de ter múltiplos principais simultaneamente → rejeição

---

### RN-RF015-03 — Hierarquia de Locais Obrigatória e Integridade Referencial

**Descrição**: A estrutura de hierarquia deve ser respeitada em cascata:
- Sala DEVE pertencer a um Andar (FK obrigatória)
- Andar DEVE pertencer a um Edifício (FK obrigatória)
- Edifício DEVE pertencer a um Endereço (FK obrigatória)
- Endereço DEVE pertencer a um Tenant (FK obrigatória)

**Justificativa**: Garante integridade dos dados, previne orfandade de registros, facilita navegação hierárquica, suporta soft delete em cascata.

**Critério de Aceite**:
- Tentativa de criar Sala sem Andar → rejeição HTTP 400
- Tentativa de criar Andar sem Edifício → rejeição HTTP 400
- Tentativa de criar Edifício sem Endereço → rejeição HTTP 400
- Inativar Edifício → desativar Andares → Salas → Racks em cascata (soft delete)

---

### RN-RF015-04 — Validação de Capacidade de Racks

**Descrição**: Racks de TI devem atender a padrões da indústria:
- Altura: Entre 1U e 48U (onde U = 1,75 polegadas)
- Profundidade: 600mm, 800mm, 1000mm ou customizada (registrada em mm)
- Peso Máximo: Capacidade estrutural em kg (típico: 500kg-1500kg)
- Potência Máxima: Capacidade em watts (típico: 2000W-10000W)

O sistema deve validar que equipamentos instalados não excedem estes limites.

**Justificativa**: Evita sobrecarga de racks, garante segurança da infraestrutura, previne falhas de equipamento.

**Critério de Aceite**:
- Altura fora do range 1-48U → rejeição HTTP 400
- Profundidade < 300mm ou > 2000mm → rejeição HTTP 400
- Peso Máximo <= 0 → rejeição HTTP 400
- Potência Máxima <= 0 → rejeição HTTP 400
- Instalar equipamento que exceda peso/potência disponível → rejeição HTTP 400

---

### RN-RF015-05 — Controle de Ocupação de Posições em Rack (Sem Sobreposição)

**Descrição**: Posições em racks (U1, U2, ..., U48) não podem se sobrepor. Ao instalar equipamento que ocupa U10-U12 (3Us), todas estas posições são marcadas como ocupadas e indisponíveis.

**Justificativa**: Garante utilização correta de espaço em rack, previne instalações incorretas, otimiza planejamento.

**Critério de Aceite**:
- Equipamento instalado em U10-U12 → posições 10, 11, 12 marcadas como ocupadas
- Tentativa de instalar em U11-U13 → rejeição HTTP 400 (sobrepõe com U11, U12)
- Consulta de posições disponíveis → retornar apenas Us livres

---

### RN-RF015-06 — Tipos de Sala e Compatibilidade com Racks

**Descrição**: Diferentes tipos de sala possuem diferentes compatibilidades:
- **Datacenter**: Permite racks
- **Sala de Servidores**: Permite racks
- **CPD**: Permite racks
- **Sala Técnica**: Permite racks
- **Escritório**: NÃO permite racks
- **Reunião**: NÃO permite racks
- **Armazenamento**: NÃO permite racks

**Justificativa**: Garante que infraestrutura crítica esteja em ambientes apropriados, facilita conformidade regulatória.

**Critério de Aceite**:
- Tentativa de criar rack em Sala tipo "Escritório" → rejeição HTTP 400
- Criar rack em Sala tipo "Datacenter" → permitido
- Sala com capacidade máxima de 5 racks, já com 5 → tentativa de criar 6º → rejeição HTTP 400

---

### RN-RF015-07 — Geocodificação Automática de Endereços Completos

**Descrição**: Quando endereço é registrado com logradouro + número + cidade + estado completos, o sistema automaticamente tenta geocodificar via API externa (Google Maps Geocoding API). Geocodificação é assíncrona e não-bloqueante: se falhar, não impede salvamento do endereço.

**Justificativa**: Permite visualização em mapas interativos, cálculo de rotas, análise geoespacial, sem forçar validação bloqueante.

**Critério de Aceite**:
- Endereço completo salvo → geocodificação executada em background
- Geocodificação bem-sucedida → latitude/longitude armazenadas
- Geocodificação falhada → endereço salvo sem coordenadas, log de erro gerado
- Sistema registra timestamp da última tentativa de geocodificação

---

### RN-RF015-08 — Histórico de Movimentações Imutável e Auditável

**Descrição**: Toda mudança de localização de ativo gera registro imutável em tabela de auditoria. Este histórico é append-only (somente INSERT, nunca UPDATE ou DELETE). Cada registro contém:
- Id_Ativo (qual ativo)
- Id_Local_Origem (local anterior)
- Id_Local_Destino (novo local)
- Id_Usuario (quem moveu)
- Dt_Movimentacao (quando)
- Ds_Motivo (por quê)
- Fl_Validado (se foi validado por supervisor)

**Justificativa**: Suporta investigações de segurança, conformidade regulatória (LGPD, SOX), rastreamento de discrepâncias.

**Critério de Aceite**:
- Movimentação registrada → registro criado, imutável
- Tentativa de UPDATE em histórico → rejeição HTTP 403
- Tentativa de DELETE em histórico → rejeição HTTP 403

---

### RN-RF015-09 — Validação de Unidades Federativas (UF) Brasileiras

**Descrição**: Campo Sg_Estado deve conter sigla válida de UF brasileira (27 opções: AC, AL, AM, AP, BA, CE, DF, ES, GO, MA, MG, MS, MT, PA, PB, PE, PI, PR, RJ, RN, RO, RR, RS, SC, SP, TO). Sistema padroniza automaticamente para UPPERCASE.

**Justificativa**: Garante dados consistentes para integração com sistemas de logística, correios e conformidade regulatória.

**Critério de Aceite**:
- Entrada "sp" → normalizado para "SP" → aceito
- Entrada "SP" → aceito como-é
- Entrada "XX" → rejeição HTTP 400
- Entrada "são paulo" → rejeição HTTP 400 (deve ser sigla)

---

### RN-RF015-10 — Timeout e Circuit Breaker para Integrações Externas

**Descrição**: Requisições para APIs externas (ViaCEP, Google Maps) possuem timeout de 5 segundos. Se API estiver indisponível e 3 tentativas consecutivas falhem, circuit breaker ativa modo "aberto" por 60 segundos, rejeitando novas requisições. Sistema continua funcionando sem geolocalização se integração falhar.

**Justificativa**: Garante que falhas de API externa não derrubem sistema, melhora resiliência, respeita SLAs de terceiros.

**Critério de Aceite**:
- API responde em < 5s → sucesso
- API timeout após 5s → retry automático (max 3 tentativas)
- 3 falhas consecutivas → circuit breaker aberto por 60s
- Durante circuit breaker aberto → operações sem integração externa continuam funcionando

---

## 6. ESTADOS DA ENTIDADE

### 6.1 Estados de Endereço

| Estado | Descrição |
|------|-----------|
| active | Endereço ativo e utilizável |
| inactive | Endereço inativo (soft delete) |

### 6.2 Estados de Local

| Estado | Descrição |
|------|-----------|
| active | Local ativo e operacional |
| inactive | Local inativo (soft delete, pode afetar hierarquia) |

### 6.3 Estados de Rack

| Estado | Descrição |
|------|-----------|
| available | Rack disponível para instalação de equipamentos |
| full | Rack com 100% de ocupação |
| maintenance | Rack em manutenção, indisponível temporariamente |
| inactive | Rack inativo (soft delete) |

### Transições permitidas

| Entidade | De | Para |
|----------|---|---|
| Endereço | active | inactive |
| Local | active | inactive |
| Rack | available | full, maintenance, inactive |
| Rack | full | available, maintenance, inactive |
| Rack | maintenance | available, inactive |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre |
|------|--------------|
| endereco.criado | Após criação de novo endereço |
| endereco.atualizado | Após atualização de endereço existente |
| endereco.inativado | Após soft delete de endereço |
| endereco.geocodificado | Após geocodificação bem-sucedida |
| local.criado | Após criação de novo local |
| local.atualizado | Após atualização de local |
| local.inativado | Após soft delete de local |
| rack.criado | Após criação de novo rack |
| rack.atualizado | Após atualização de rack |
| rack.ocupacao_alterada | Após instalação/remoção de equipamento |
| rack.capacidade_atingida | Quando ocupação >= 80% |
| movimentacao.registrada | Após registro de movimentação de ativo |
| movimentacao.validada | Após validação por supervisor |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant
- Nenhuma regra de negócio pode ser ignorada
- Erros devem ser previsíveis e rastreáveis (HTTP status codes corretos)
- Auditoria deve registrar quem, quando e o que mudou
- Geocodificação não pode bloquear operações principais
- Histórico de movimentações é imutável (append-only)
- Hierarquia de locais deve ser consistente (sem loops, sem órfãos)
- Racks não podem exceder capacidades físicas (peso, potência, espaço)

---

## 9. SEGURANÇA

- **Validação de entrada obrigatória**: Todos os campos validados (tipo, comprimento, formato, valores permitidos)
- **Proteção contra injeção**: Queries parametrizadas, sem concatenação de strings
- **Controle de permissões**: RBAC granular por operação (criar, atualizar, visualizar, excluir)
- **Isolamento multi-tenant**: Queries filtram automaticamente por tenant
- **Auditoria imutável**: Histórico de movimentações é append-only
- **Versionamento otimista**: Campo RowVersion em tabelas críticas previne race conditions
- **Criptografia em trânsito**: HTTPS obrigatório
- **Proteção contra escalação de privilégio**: Usuários não podem alterar permissões próprias
- **Rate limiting**: Limitador de taxa em endpoints críticos (max 100 req/min por usuário)

### Testes de Segurança Obrigatórios

- SQL Injection: Tentar passar `'; DROP TABLE Endereco; --` em campo CEP
- XSS Stored: Tentar inserir `<script>alert('XSS')</script>` em campo Logradouro
- CSRF Protection: Enviar POST sem token CSRF → validar rejeição HTTP 403
- Validação de Permissões: Usuário sem permissão tenta acessar endpoint → validar HTTP 403
- Isolamento Multi-tenant: Tenant A tenta acessar dados de Tenant B → validar rejeição
- Auditoria Imutável: Tentar UPDATE em histórico_movimentacao → validar HTTP 403
- Versionamento Otimista: Dois usuários atualizam mesmo endereço simultaneamente → validar conflito HTTP 409

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF015.md** (Casos de Uso) - 5 UCs obrigatórios (UC00-UC04)
- **MD-RF015.yaml** (Modelo de Dados) - DDL completo com auditoria e multi-tenancy
- **TC-RF015.yaml** (Casos de Teste) - Cobertura de CRUD, validações, integrações, segurança
- **MT-RF015.yaml** (Massas de Teste) - Dados de teste para automação
- **WF-RF015.md** (Workflows) - Fluxos de navegação e telas

---

## 11. RASTREABILIDADE

| Artefato | Status | Responsável |
|--------|-------|-------------|
| UC-RF015.md | Gerado | Architect Agent |
| MD-RF015.yaml | Gerado | Architect Agent |
| TC-RF015.yaml | Pendente | QA Agent |
| MT-RF015.yaml | Pendente | QA Agent |
| WF-RF015.md | Gerado | Architect Agent |
| RL-RF015.md | Gerado | Migration Agent |
| RL-RF015.yaml | Gerado | Migration Agent |

### Integr ações Obrigatórias

- **Central de Funcionalidades (Feature Flags)**: LOCAIS_ENDERECOS_CRUD, LOCAIS_GEOCODIFICACAO_AUTOMATICA, LOCAIS_VALIDACAO_VIACEP
- **Internacionalização (i18n)**: Chaves de tradução em pt-BR, en, es para todos os termos do módulo
- **Auditoria**: Registro de todas as operações (CREATE, UPDATE, DELETE, movimentações)
- **Controle de Acesso (RBAC)**: Permissões granulares (locais:endereco:create, locais:rack:update, etc)
- **Multi-tenancy**: Isolamento por tenant em todas as entidades

### Dependências

- **RF-001**: Parâmetros e Configurações (para URLs de APIs externas)
- **RF-002**: Autenticação e Autorização (para RBAC)
- **RF-003**: Auditoria (para histórico imutável)
- **RF-043**: Endereços de Entrega (compartilha validação de CEP)
- **RF-052**: Gestão de Consumidores (usa endereços)

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|------|------|----------|------|
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0: separação RF/RL, adequação ao template canônico de 11 seções, remoção de conteúdo legado | Agência ALC - alc.dev.br |
| 1.0 | 2025-12-28 | Versão inicial com 9 seções, conteúdo legado misturado | IControlIT Architect Agent |
