# Casos de Uso - RF013

**VersÃ£o:** 1.0
**Data:** 2025-12-17
**RF Relacionado:** [RF013 - Gestao-de-Perfis-de-Acesso](./RF013.md)

---

## Ãndice de Casos de Uso

| UC | Nome | DescriÃ§Ã£o |
|----|------|-----------|
| UC01 | Criar Perfil (Role) - EspecificaÃ§Ã£o Completa | Caso de uso |
| UC02 | Visualizar Perfil (Role) - EspecificaÃ§Ã£o Completa | Caso de uso |
| UC03 | Editar Perfil (Role) - EspecificaÃ§Ã£o Completa | Caso de uso |
| UC04 | UC04 - Excluir Perfil de Acesso | Caso de uso |
| UC07 | UC07 - Duplicar Perfil de Acesso | Caso de uso |

---

# UC01: Criar Perfil (Role) - EspecificaÃ§Ã£o Completa

**Data CriaÃ§Ã£o**: 2025-10-20
**Ãšltima AtualizaÃ§Ã£o**: 2025-10-26
**Autor**: Anderson Chipak + Claude Code
**Status**: âœ… Implementado e Corrigido (Backend + Frontend)

---

## ğŸ“¢ AtualizaÃ§Ã£o 2025-10-26 - CorreÃ§Ãµes CrÃ­ticas Implementadas

### âœ… CorreÃ§Ãµes Aplicadas

**A. HierarchyLevel Agora GerenciÃ¡vel via API**
- âœ… Campo `hierarchyLevel` adicionado ao `CreateRoleCommand`
- âœ… Campo `hierarchyLevel` adicionado ao `UpdateRoleCommand`
- âœ… Frontend atualizado: `CreateRoleRequest` e `UpdateRoleRequest` incluem `hierarchyLevel`
- **Arquivos modificados:**
  - [CreateRole.cs](D:\IC2\backend\IControlIT.API\src\Application\RoleManagement\Commands\CreateRole\CreateRole.cs)
  - [UpdateRole.cs](D:\IC2\backend\IControlIT.API\src\Application\RoleManagement\Commands\UpdateRole\UpdateRole.cs)
  - [roles.types.ts](D:\IC2\frontend\icontrolit-app\src\app\modules\admin\management\roles\roles.types.ts)

**B. ValidaÃ§Ã£o de Hierarquia Implementada**
- âœ… `CreateRoleCommandHandler` agora valida se usuÃ¡rio pode criar perfil com nÃ­vel solicitado
- âœ… `UpdateRoleCommandHandler` valida se usuÃ¡rio pode editar perfil com nÃ­vel solicitado
- âœ… Regra: `currentUserLevel >= request.HierarchyLevel` resulta em `UnauthorizedAccessException`
- âœ… Mensagem de erro clara: "VocÃª nÃ£o tem permissÃ£o para criar perfis com nÃ­vel de hierarquia {X}"
- **Impacto:** Admin (nÃ­vel 1) nÃ£o pode mais criar Super Admin (nÃ­vel 0)

**C. Validators Criados**
- âœ… `CreateRoleCommandValidator.cs` criado com validaÃ§Ãµes:
  - Nome obrigatÃ³rio, mÃ¡x 100 caracteres
  - DescriÃ§Ã£o mÃ¡x 500 caracteres
  - HierarchyLevel entre 0-10
  - EmpresaId obrigatÃ³rio quando nÃ£o for perfil de sistema
- âœ… `UpdateRoleCommandValidator.cs` criado com validaÃ§Ãµes similares
- **Arquivos criados:**
  - [CreateRoleCommandValidator.cs](D:\IC2\backend\IControlIT.API\src\Application\RoleManagement\Commands\CreateRole\CreateRoleCommandValidator.cs)
  - [UpdateRoleCommandValidator.cs](D:\IC2\backend\IControlIT.API\src\Application\RoleManagement\Commands\UpdateRole\UpdateRoleCommandValidator.cs)

### ğŸ“Š Impacto nas Regras de NegÃ³cio

**Antes da CorreÃ§Ã£o:**
- âŒ HierarchyLevel nÃ£o era gerenciÃ¡vel via API
- âŒ Todos os perfis criados ficavam com nÃ­vel padrÃ£o = 3
- âŒ NÃ£o havia validaÃ§Ã£o de hierarquia (qualquer usuÃ¡rio podia criar qualquer nÃ­vel)

**Depois da CorreÃ§Ã£o:**
- âœ… HierarchyLevel completamente gerenciÃ¡vel
- âœ… ValidaÃ§Ã£o de hierarquia robusta
- âœ… Sistema de nÃ­veis funcional (0 = Super Admin, 1 = Admin, etc.)
- âœ… ImpossÃ­vel escalar privilÃ©gios indevidamente

---

## ğŸ“‹ SumÃ¡rio Executivo

| Aspecto | Detalhes |
|---------|----------|
| **Objetivo** | Permitir criaÃ§Ã£o de perfis/roles personalizadas com permissÃµes granulares |
| **Atores** | Super Admin, Admin (com permissÃ£o `users:role:create`) |
| **PrÃ©-condiÃ§Ãµes** | UsuÃ¡rio autenticado, permissÃ£o adequada, sistema de permissÃµes configurado |
| **PÃ³s-condiÃ§Ãµes** | Perfil criado, permissÃµes associadas, auditoria registrada |
| **CenÃ¡rios de Teste** | **80 cenÃ¡rios** (validaÃ§Ã£o, permissÃµes, hierarquia, combinaÃ§Ãµes) |
| **Prioridade** | ğŸ”´ CrÃ­tica (base do sistema de autorizaÃ§Ã£o) |

---

## ğŸ¯ DescriÃ§Ã£o do Caso de Uso

### Objetivo
Permitir que administradores criem perfis personalizados de usuÃ¡rios, definindo:
1. **Nome do perfil**: Ex: "Gerente de Documentos", "Auditor Regional"
2. **Hierarquia**: NÃ­vel de autoridade (1 = maior, 10 = menor)
3. **PermissÃµes**: Conjunto de 0 a 23 permissÃµes granulares
4. **DescriÃ§Ã£o**: Finalidade e escopo do perfil
5. **Escopo**: Global (todas empresas) ou especÃ­fico de uma empresa

### Conceitos Importantes

| Conceito | DescriÃ§Ã£o | Exemplo |
|----------|-----------|---------|
| **Role/Perfil** | Conjunto nomeado de permissÃµes | "Gerente de TI" |
| **Hierarquia** | NÃ­vel de autoridade (1-10) | Super Admin = 1, Admin = 2, Gerente = 3, UsuÃ¡rio = 5 |
| **PermissÃ£o** | AÃ§Ã£o especÃ­fica em recurso | `documents:template:create` |
| **Escopo** | AbrangÃªncia do perfil | Global ou por Empresa |

### Atores Principais
- **Super Administrador**: Pode criar perfis globais e de qualquer hierarquia
- **Administrador**: Pode criar perfis especÃ­ficos da empresa (hierarquia >= sua prÃ³pria)

### PermissÃµes NecessÃ¡rias
- **Criar perfil**: `users:role:create`
- **Visualizar permissÃµes**: `users:role:read` (para listar permissÃµes disponÃ­veis)

---

## ğŸ“Š Fluxos

### Fluxo Principal - Criar Perfil Completo

**FP-01: Criar Perfil com PermissÃµes**

1. Admin acessa `/management/roles`
2. Admin clica em botÃ£o "â• Novo Perfil"
3. Sistema valida permissÃ£o `users:role:create`
4. Sistema exibe modal/pÃ¡gina de criaÃ§Ã£o:
   ```
   Criar Novo Perfil

   * Nome do Perfil: [_______________________]
     Exemplo: "Gerente de Documentos"

   * Hierarquia: [â–¼ Selecionar nÃ­vel]
     OpÃ§Ãµes: 2 (Admin), 3 (Gerente), 4 (Coordenador), 5 (UsuÃ¡rio)

   DescriÃ§Ã£o (opcional):
   [_____________________________________________]

   Escopo:
   â˜ Perfil de Sistema (pode ser usado em qualquer empresa) - Apenas Developer/Super Admin
   (â€¢) EspecÃ­fico desta empresa

   PermissÃµes:
   â˜‘ GestÃ£o de UsuÃ¡rios
     â˜ users:user:create   Criar usuÃ¡rios
     â˜‘ users:user:read     Visualizar usuÃ¡rios
     â˜‘ users:user:update   Editar usuÃ¡rios
     â˜ users:user:delete   Excluir usuÃ¡rios

   â˜‘ GestÃ£o de Documentos
     â˜‘ documents:template:create   Criar templates
     â˜‘ documents:template:read     Visualizar templates
     â˜‘ documents:template:update   Editar templates
     ...

   [23 permissÃµes organizadas em 6 grupos]

   [Cancelar]  [Criar Perfil]
   ```
5. Admin preenche:
   - Nome: "Gerente de Documentos"
   - Hierarquia: 3 (Gerente)
   - DescriÃ§Ã£o: "ResponsÃ¡vel por gerenciar templates e geraÃ§Ã£o de documentos"
   - Escopo: EspecÃ­fico da empresa
   - PermissÃµes: Seleciona 8 permissÃµes relacionadas a documentos e templates
6. Admin clica em "Criar Perfil"
7. Sistema valida:
   - Nome nÃ£o estÃ¡ vazio
   - Nome Ã© Ãºnico (nÃ£o existe outro perfil com mesmo nome)
   - Hierarquia Ã© vÃ¡lida (>= hierarquia do criador)
   - Pelo menos 1 permissÃ£o selecionada
   - Escopo global apenas se Super Admin
8. Sistema executa `POST /api/roles`
9. Backend:
   - Cria registro em `Roles`:
     ```sql
     INSERT INTO Roles (Id, Nome, Hierarquia, Descricao, EmpresaId, CriadoPorId)
     VALUES ('{guid}', 'Gerente de Documentos', 3, 'ResponsÃ¡vel...', '{empresaId}', '{adminId}')
     ```
   - Cria registros em `RolePermissions` (8 linhas):
     ```sql
     INSERT INTO RolePermissions (RoleId, PermissionId)
     VALUES ('{roleId}', '{permissionId}')
     ```
   - Registra no audit log
10. Sistema retorna perfil criado com ID
11. Sistema exibe toast: "âœ… Perfil 'Gerente de Documentos' criado com sucesso"
12. Sistema redireciona para lista de perfis (novo perfil aparece)

**Resultado Esperado**:
- âœ… Perfil criado no banco
- âœ… 8 permissÃµes associadas
- âœ… Toast de sucesso
- âœ… Audit log registrado
- âœ… DisponÃ­vel para atribuir a usuÃ¡rios

---

### Fluxo Alternativo 1 - Criar Perfil MÃ­nimo

**FA-01: Perfil com Apenas 1 PermissÃ£o**

1. Admin cria perfil "Visualizador de Logs"
2. Seleciona apenas 1 permissÃ£o: `audit:logs:read`
3. Sistema permite criaÃ§Ã£o
4. Perfil funciona normalmente

**ValidaÃ§Ã£o**: Pelo menos 1 permissÃ£o Ã© obrigatÃ³ria

---

### Fluxo Alternativo 2 - Criar Perfil Global

**FA-02: Perfil de Sistema (Developer/Super Admin)**

1. Developer ou Super Admin cria perfil "Auditor Regional"
2. Marca checkbox: "Perfil de Sistema (pode ser usado em qualquer empresa)"
3. Campo `empresaId` fica NULL no banco e flag `IsSystemRole = true`
4. Perfil disponÃ­vel para atribuir em qualquer empresa

**RestriÃ§Ã£o**: Apenas Developer ou Super Admin podem criar Perfis de Sistema

---

### Fluxo Alternativo 3 - Clonar Perfil Existente

**FA-03: Duplicar e Modificar**

1. Admin visualiza perfil "Gerente"
2. Admin clica em "Duplicar"
3. Sistema cria formulÃ¡rio prÃ©-preenchido:
   - Nome: "Gerente (cÃ³pia)"
   - Mesma hierarquia
   - Mesmas permissÃµes
4. Admin modifica nome para "Gerente Financeiro"
5. Admin adiciona permissÃµes de relatÃ³rios
6. Admin clica em "Criar Perfil"
7. Novo perfil criado independente do original

---

### Fluxo Alternativo 4 - Template de Perfil

**FA-04: Usar Template PrÃ©-Definido**

1. Admin clica em "Novo Perfil > Usar Template"
2. Sistema exibe templates:
   - ğŸ“‹ "Gerente PadrÃ£o" (10 permissÃµes)
   - ğŸ“‹ "UsuÃ¡rio Comum" (3 permissÃµes)
   - ğŸ“‹ "Auditor" (5 permissÃµes)
3. Admin seleciona "Gerente PadrÃ£o"
4. FormulÃ¡rio prÃ©-preenchido
5. Admin ajusta conforme necessÃ¡rio
6. Cria perfil

---

### Fluxos de ExceÃ§Ã£o

**FE-01: Nome Vazio**
- **CondiÃ§Ã£o**: Campo "Nome" em branco
- **AÃ§Ã£o**:
  - Status: 400 Bad Request
  - Erro: "Nome do perfil Ã© obrigatÃ³rio"
  - Campo fica vermelho

---

**FE-02: Nome Duplicado**
- **CondiÃ§Ã£o**: JÃ¡ existe perfil com mesmo nome
- **ValidaÃ§Ã£o**: `SELECT COUNT(*) FROM Roles WHERE Nome = ? AND (EmpresaId = ? OR EmpresaId IS NULL)`
- **AÃ§Ã£o**:
  - Status: 400 Bad Request
  - Erro: "JÃ¡ existe um perfil com este nome"
  - SugestÃ£o: "Gerente de Documentos 2"

---

**FE-03: Nome Muito Curto**
- **CondiÃ§Ã£o**: Nome com menos de 3 caracteres
- **AÃ§Ã£o**: Erro: "Nome deve ter pelo menos 3 caracteres"

---

**FE-04: Nome Muito Longo**
- **CondiÃ§Ã£o**: Nome com mais de 100 caracteres
- **AÃ§Ã£o**: Erro: "Nome deve ter no mÃ¡ximo 100 caracteres"

---

**FE-05: Nenhuma PermissÃ£o Selecionada**
- **CondiÃ§Ã£o**: Array de permissÃµes vazio
- **AÃ§Ã£o**:
  - Status: 400 Bad Request
  - Erro: "Selecione pelo menos 1 permissÃ£o"
  - SeÃ§Ã£o de permissÃµes fica destacada em vermelho

---

**FE-06: Hierarquia InvÃ¡lida - Auto-PromoÃ§Ã£o**
- **CondiÃ§Ã£o**: Admin (h=2) tenta criar perfil com h=1 (Super Admin)
- **ValidaÃ§Ã£o**: `novaHierarquia >= criadorHierarquia`
- **AÃ§Ã£o**:
  - Status: 403 Forbidden
  - Erro: "VocÃª nÃ£o pode criar perfis de hierarquia superior Ã  sua"
  - Dropdown mostra apenas opÃ§Ãµes permitidas (h >= 2)

---

**FE-07: Perfil de Sistema - Admin Comum**
- **CondiÃ§Ã£o**: Admin (nÃ£o Developer/Super Admin) tenta criar Perfil de Sistema
- **AÃ§Ã£o**:
  - Status: 403 Forbidden
  - Erro: "Apenas Developer ou Super Administrador podem criar Perfis de Sistema"
  - Checkbox "Perfil de Sistema" desabilitado no frontend

---

**FE-08: PermissÃ£o Inexistente**
- **CondiÃ§Ã£o**: Frontend envia ID de permissÃ£o invÃ¡lido
- **AÃ§Ã£o**:
  - Status: 400 Bad Request
  - Erro: "PermissÃ£o 'abc123' nÃ£o existe"

---

**FE-09: DescriÃ§Ã£o Muito Longa**
- **CondiÃ§Ã£o**: DescriÃ§Ã£o com > 500 caracteres
- **AÃ§Ã£o**: Erro: "DescriÃ§Ã£o deve ter no mÃ¡ximo 500 caracteres"
- **UI**: Contador de caracteres: "350/500"

---

**FE-10: Hierarquia Fora do Range**
- **CondiÃ§Ã£o**: Hierarquia < 1 ou > 10
- **AÃ§Ã£o**:
  - Status: 400 Bad Request
  - Erro: "Hierarquia deve estar entre 1 e 10"

---

**FE-11: Sem PermissÃ£o para Criar**
- **CondiÃ§Ã£o**: UsuÃ¡rio sem `users:role:create`
- **AÃ§Ã£o**:
  - Status: 403 Forbidden
  - BotÃ£o "Novo Perfil" nÃ£o aparece no frontend
  - Rota protegida: redireciona para `/dashboard`

---

**FE-12: Nome com Caracteres Especiais**
- **CondiÃ§Ã£o**: Nome contÃ©m `<>{}[]|`
- **AÃ§Ã£o**: Permitido, mas escapado ao exibir (proteÃ§Ã£o XSS)
- **Alternativa**: Bloquear caracteres especiais (regex)

---

## ğŸ§ª CenÃ¡rios de Teste (80 Total)

### Categoria 1: ValidaÃ§Ã£o de Campos (20 cenÃ¡rios)

#### CT-001: Criar Perfil - Caminho Feliz
**PrÃ©-condiÃ§Ãµes**:
- Super Admin logado com `users:role:create`

**AÃ§Ã£o**:
```http
POST /api/roles
Authorization: Bearer {token}
Content-Type: application/json

{
  "nome": "Gerente de Documentos",
  "hierarquia": 3,
  "descricao": "ResponsÃ¡vel por gerenciar templates e documentos",
  "empresaId": "5e74ca92-08d5-40f5-a27b-98887f81aa2e",
  "permissoes": [
    "documents:template:create",
    "documents:template:read",
    "documents:template:update",
    "documents:document:generate",
    "documents:document:read",
    "documents:document:download",
    "users:user:read",
    "audit:logs:read"
  ]
}
```

**Resultado Esperado**:
- âœ… Status: **201 Created**
- âœ… Response:
  ```json
  {
    "id": "role-guid",
    "nome": "Gerente de Documentos",
    "hierarquia": 3,
    "descricao": "ResponsÃ¡vel...",
    "empresaId": "5e74ca92-...",
    "permissoes": [...], // 8 permissÃµes
    "dataCriacao": "2025-10-20T15:30:00Z"
  }
  ```
- âœ… Banco:
  ```sql
  SELECT * FROM Roles WHERE Id = 'role-guid'
  SELECT COUNT(*) FROM RolePermissions WHERE RoleId = 'role-guid' -- 8
  ```
- âœ… Audit log criado

---

#### CT-002: Nome ObrigatÃ³rio
**AÃ§Ã£o**: `{ "nome": "" }`

**Resultado Esperado**:
- âœ… Status: **400 Bad Request**
- âœ… Erro: `{ "nome": ["Nome do perfil Ã© obrigatÃ³rio"] }`

---

#### CT-003: Nome Muito Curto
**AÃ§Ã£o**: `{ "nome": "AB" }`

**Resultado Esperado**:
- âœ… Status: 400 Bad Request
- âœ… Erro: "Nome deve ter pelo menos 3 caracteres"

---

#### CT-004: Nome Muito Longo
**AÃ§Ã£o**: `{ "nome": "A" * 101 }`

**Resultado Esperado**:
- âœ… Status: 400 Bad Request
- âœ… Erro: "Nome deve ter no mÃ¡ximo 100 caracteres"

---

#### CT-005: Nome Duplicado
**PrÃ©-condiÃ§Ãµes**: JÃ¡ existe perfil "Gerente"

**AÃ§Ã£o**: Criar outro perfil "Gerente"

**ValidaÃ§Ã£o SQL**:
```sql
SELECT COUNT(*) FROM Roles
WHERE Nome = 'Gerente' AND (EmpresaId = ? OR EmpresaId IS NULL)
```

**Resultado Esperado**:
- âœ… Status: 400 Bad Request
- âœ… Erro: "JÃ¡ existe um perfil com este nome"

---

#### CT-006: Nome Duplicado - Empresas Diferentes (Permitido)
**CenÃ¡rio**: Empresa A tem "Gerente", Empresa B cria "Gerente"

**Resultado Esperado**:
- âœ… Status: 201 Created
- âœ… Permitido (escopos diferentes)

---

#### CT-007: Nome com EspaÃ§os (Trimmed)
**AÃ§Ã£o**: `{ "nome": "  Gerente de TI  " }`

**Resultado Esperado**:
- âœ… Backend faz trim: `Nome = nome.Trim()`
- âœ… Armazenado: "Gerente de TI"

---

#### CT-008: Nome com Caracteres Especiais
**AÃ§Ã£o**: `{ "nome": "Gerente (RegiÃ£o Sul)" }`

**Resultado Esperado**:
- âœ… Aceito (parÃªnteses permitidos)
- âœ… Escapado ao exibir HTML

---

#### CT-009: DescriÃ§Ã£o Opcional (NULL)
**AÃ§Ã£o**: `{ "descricao": null }`

**Resultado Esperado**:
- âœ… Status: 201 Created
- âœ… Campo `descricao` = NULL no banco

---

#### CT-010: DescriÃ§Ã£o Muito Longa
**AÃ§Ã£o**: `{ "descricao": "A" * 501 }`

**Resultado Esperado**:
- âœ… Status: 400 Bad Request
- âœ… Erro: "DescriÃ§Ã£o deve ter no mÃ¡ximo 500 caracteres"

---

#### CT-011: Hierarquia ObrigatÃ³ria
**AÃ§Ã£o**: `{ "hierarquia": null }`

**Resultado Esperado**:
- âœ… Status: 400 Bad Request
- âœ… Erro: "Hierarquia Ã© obrigatÃ³ria"

---

#### CT-012: Hierarquia MÃ­nima
**AÃ§Ã£o**: `{ "hierarquia": 1 }` (Super Admin cria)

**Resultado Esperado**:
- âœ… Status: 201 Created
- âœ… Apenas Super Admin pode criar h=1

---

#### CT-013: Hierarquia MÃ¡xima
**AÃ§Ã£o**: `{ "hierarquia": 10 }`

**Resultado Esperado**:
- âœ… Status: 201 Created
- âœ… Perfil de hierarquia mais baixa

---

#### CT-014: Hierarquia Fora do Range
**AÃ§Ã£o**: `{ "hierarquia": 0 }` ou `{ "hierarquia": 11 }`

**Resultado Esperado**:
- âœ… Status: 400 Bad Request
- âœ… Erro: "Hierarquia deve estar entre 1 e 10"

---

#### CT-015: PermissÃµes - Array Vazio (NEGADO)
**AÃ§Ã£o**: `{ "permissoes": [] }`

**Resultado Esperado**:
- âœ… Status: 400 Bad Request
- âœ… Erro: "Selecione pelo menos 1 permissÃ£o"

---

#### CT-016: PermissÃµes - Apenas 1 (Permitido)
**AÃ§Ã£o**: `{ "permissoes": ["audit:logs:read"] }`

**Resultado Esperado**:
- âœ… Status: 201 Created
- âœ… Perfil com 1 permissÃ£o funciona

---

#### CT-017: PermissÃµes - Todas as 23
**AÃ§Ã£o**: `{ "permissoes": [... todas as 23 ...] }`

**Resultado Esperado**:
- âœ… Status: 201 Created
- âœ… Perfil equivalente a Super Admin (mas com hierarquia diferente)

---

#### CT-018: PermissÃ£o Inexistente
**AÃ§Ã£o**: `{ "permissoes": ["invalid:permission"] }`

**Resultado Esperado**:
- âœ… Status: 400 Bad Request
- âœ… Erro: "PermissÃ£o 'invalid:permission' nÃ£o existe"

---

#### CT-019: PermissÃµes Duplicadas no Request
**AÃ§Ã£o**: `{ "permissoes": ["users:user:read", "users:user:read"] }`

**Resultado Esperado**:
- âœ… Backend remove duplicatas: `permissoes = permissoes.Distinct()`
- âœ… Status: 201 Created
- âœ… Apenas 1 registro em `RolePermissions`

---

#### CT-020: EmpresaId NULL (Perfil Global)
**AÃ§Ã£o**: `{ "empresaId": null }` (Super Admin)

**Resultado Esperado**:
- âœ… Status: 201 Created
- âœ… Perfil disponÃ­vel em todas as empresas

---

### Categoria 2: SeguranÃ§a e Hierarquia (20 cenÃ¡rios)

#### CT-021: Sem PermissÃ£o - Criar Perfil
**PrÃ©-condiÃ§Ãµes**: UsuÃ¡rio SEM `users:role:create`

**AÃ§Ã£o**: `POST /api/roles`

**Resultado Esperado**:
- âœ… Status: **403 Forbidden**
- âœ… Erro: "VocÃª nÃ£o tem permissÃ£o para criar perfis"
- âœ… BotÃ£o "Novo Perfil" nÃ£o aparece no frontend

---

#### CT-022: Hierarquia - Admin Cria Gerente
**CenÃ¡rio**: Admin (h=2) cria perfil Gerente (h=3)

**Resultado Esperado**:
- âœ… Status: 201 Created
- âœ… Hierarquia inferior permitida

---

#### CT-023: Hierarquia - Admin Tenta Criar Super Admin
**CenÃ¡rio**: Admin (h=2) tenta criar perfil com h=1

**ValidaÃ§Ã£o**: `novaHierarquia >= criadorHierarquia`

**Resultado Esperado**:
- âœ… Status: **403 Forbidden**
- âœ… Erro: "VocÃª nÃ£o pode criar perfis de hierarquia superior Ã  sua"

---

#### CT-024: Hierarquia - Gerente Cria UsuÃ¡rio
**CenÃ¡rio**: Gerente (h=3) cria perfil UsuÃ¡rio (h=5)

**Resultado Esperado**:
- âœ… Status: 201 Created

---

#### CT-025: Hierarquia - Mesma Hierarquia
**CenÃ¡rio**: Admin (h=2) cria outro perfil h=2

**Resultado Esperado**:
- âœ… Status: 201 Created
- âœ… Permitido criar perfil de mesma hierarquia

---

#### CT-026: Escopo Global - Apenas Super Admin
**CenÃ¡rio**: Admin (nÃ£o Super) tenta criar perfil global

**AÃ§Ã£o**: `{ "empresaId": null }`

**Resultado Esperado**:
- âœ… Status: **403 Forbidden**
- âœ… Erro: "Apenas Super Administradores podem criar perfis globais"

---

#### CT-027: Escopo Global - Super Admin
**CenÃ¡rio**: Super Admin cria perfil global

**Resultado Esperado**:
- âœ… Status: 201 Created
- âœ… `empresaId = NULL`
- âœ… DisponÃ­vel em todas as empresas

---

#### CT-028: Criar Perfil para Outra Empresa (NEGADO)
**CenÃ¡rio**: Admin Empresa A tenta criar perfil para Empresa B

**AÃ§Ã£o**: `{ "empresaId": "empresa-b-id" }`

**Resultado Esperado**:
- âœ… Status: **403 Forbidden**
- âœ… Erro: "VocÃª nÃ£o pode criar perfis para outras empresas"

---

#### CT-029: Super Admin Cria Perfil para Qualquer Empresa
**Resultado Esperado**:
- âœ… Status: 201 Created
- âœ… Super Admin pode criar para qualquer empresa

---

#### CT-030: Token Expirado
**AÃ§Ã£o**: Request com JWT expirado

**Resultado Esperado**:
- âœ… Status: **401 Unauthorized**
- âœ… Redireciona para login

---

#### CT-031: SQL Injection no Nome
**AÃ§Ã£o**: `{ "nome": "'; DROP TABLE Roles; --" }`

**Resultado Esperado**:
- âœ… Query parametrizada, SQL nÃ£o executa
- âœ… Nome armazenado literalmente
- âœ… Banco intacto

---

#### CT-032: XSS no Nome
**AÃ§Ã£o**: `{ "nome": "<script>alert('XSS')</script>" }`

**Resultado Esperado**:
- âœ… Backend aceita
- âœ… Frontend escapa HTML ao exibir
- âœ… Script NÃƒO executa

---

#### CT-033: Rate Limiting - Muitas CriaÃ§Ãµes
**AÃ§Ã£o**: 50 POST /api/roles em 1 minuto

**Resultado Esperado**:
- âœ… ApÃ³s 20 requests: Status **429 Too Many Requests**
- âœ… Header: `Retry-After: 60`

---

#### CT-034: CSRF Protection
**AÃ§Ã£o**: Request sem token CSRF (se implementado)

**Resultado Esperado**:
- âœ… Status: 403 Forbidden
- âœ… Erro: "CSRF token invÃ¡lido"

---

#### CT-035: Audit Log - Quem Criou
**Resultado Esperado**:
```json
{
  "action": "CREATE",
  "entityType": "Role",
  "entityId": "role-guid",
  "performedBy": "admin-guid",
  "timestamp": "2025-10-20T15:30:00Z",
  "details": {
    "nome": "Gerente de Documentos",
    "hierarquia": 3,
    "permissoes": ["..."]
  }
}
```

---

#### CT-036: PermissÃµes Perigosas - Criar Super Admin
**CenÃ¡rio**: Criar perfil com todas as permissÃµes mas h=2 (nÃ£o Ã© Super Admin)

**Resultado Esperado**:
- âœ… Status: 201 Created
- âœ… Permitido (admin tem controle)
- âœ… Aviso no frontend: "âš ï¸ Este perfil terÃ¡ permissÃµes totais"

---

#### CT-037: Validar EmpresaId Existe
**AÃ§Ã£o**: `{ "empresaId": "guid-inexistente" }`

**Resultado Esperado**:
- âœ… Status: 400 Bad Request
- âœ… Erro: "Empresa nÃ£o encontrada"

---

#### CT-038: Empresa Inativa
**CenÃ¡rio**: Criar perfil para empresa desativada

**Resultado Esperado**:
- âœ… Status: 400 Bad Request
- âœ… Erro: "NÃ£o Ã© possÃ­vel criar perfis para empresas inativas"

---

#### CT-039: Mass Assignment Vulnerability
**AÃ§Ã£o**:
```json
{
  "nome": "Gerente",
  "id": "custom-id", // Tentando definir ID
  "dataCriacao": "2000-01-01" // Tentando manipular data
}
```

**Resultado Esperado**:
- âœ… Backend ignora campos nÃ£o-editÃ¡veis (whitelist)
- âœ… `id` gerado automaticamente (GUID)
- âœ… `dataCriacao` = NOW()

---

#### CT-040: Nomes Reservados (Opcional)
**AÃ§Ã£o**: `{ "nome": "Super Administrador" }` (Admin comum)

**Resultado Esperado**:
- âœ… Status: 400 Bad Request (opcional)
- âœ… Erro: "Nome reservado pelo sistema"
- âœ… OU permitir (nÃ£o hÃ¡ problema tÃ©cnico)

---

### Categoria 3: CombinaÃ§Ãµes de PermissÃµes (20 cenÃ¡rios)

#### CT-041: CRUD Completo de UsuÃ¡rios
**AÃ§Ã£o**: Criar perfil com 4 permissÃµes:
- `users:user:create`
- `users:user:read`
- `users:user:update`
- `users:user:delete`

**Resultado Esperado**:
- âœ… Perfil criado
- âœ… UsuÃ¡rio com esse perfil pode fazer CRUD completo

---

#### CT-042: Apenas Leitura (Read-Only)
**AÃ§Ã£o**: Criar perfil "Visualizador" com:
- `users:user:read`
- `documents:document:read`
- `audit:logs:read`

**Resultado Esperado**:
- âœ… Perfil sem permissÃµes de modificaÃ§Ã£o
- âœ… BotÃµes de criar/editar/deletar nÃ£o aparecem

---

#### CT-043: PermissÃµes Conflitantes (NÃ£o Existe)
**ObservaÃ§Ã£o**: Sistema nÃ£o tem conflitos (todas as permissÃµes sÃ£o aditivas)

**Exemplo**: `users:user:create` + `users:user:delete` = Funciona normalmente

---

#### CT-044: PermissÃµes HierÃ¡rquicas - Update Requer Read
**Regra de NegÃ³cio**: Para editar, deve poder visualizar?

**ValidaÃ§Ã£o**: `if (hasUpdate && !hasRead) â†’ warning`

**Resultado Esperado** (Opcional):
- âœ… Backend permite (nÃ£o hÃ¡ dependÃªncia tÃ©cnica)
- âœ… OU exibe aviso: "Recomendado adicionar permissÃ£o de leitura"

---

#### CT-045: MÃ³dulo Completo - Documentos
**AÃ§Ã£o**: Criar perfil "Gerente de Documentos" com:
- Todas as 9 permissÃµes de `documents:*`

**Resultado Esperado**:
- âœ… Controle total sobre templates e documentos

---

#### CT-046: MÃ³dulo Completo - UsuÃ¡rios
**AÃ§Ã£o**: Todas as 8 permissÃµes de `users:*`

**Resultado Esperado**:
- âœ… Pode gerenciar usuÃ¡rios e perfis

---

#### CT-047: PermissÃ£o de Audit Logs
**AÃ§Ã£o**: `audit:logs:read` + `audit:logs:export`

**Resultado Esperado**:
- âœ… Pode visualizar e exportar logs
- âœ… Perfil "Auditor"

---

#### CT-048: PermissÃµes de Empresas
**AÃ§Ã£o**: 4 permissÃµes de `companies:*`

**Resultado Esperado**:
- âœ… Pode gerenciar empresas (CRUD)

---

#### CT-049: Cross-Module - Gerente Geral
**AÃ§Ã£o**: Misturar permissÃµes de diferentes mÃ³dulos:
- `users:user:*` (4)
- `documents:template:*` (5)
- `audit:logs:read` (1)
- Total: 10 permissÃµes

**Resultado Esperado**:
- âœ… Perfil funciona normalmente
- âœ… UniÃ£o de permissÃµes

---

#### CT-050: Perfil MÃ­nimo ViÃ¡vel
**AÃ§Ã£o**: Criar perfil com apenas `users:user:read`

**Resultado Esperado**:
- âœ… UsuÃ¡rio pode fazer login
- âœ… Pode ver lista de usuÃ¡rios
- âœ… Nenhuma outra aÃ§Ã£o disponÃ­vel

---

#### CT-051: Todas as PermissÃµes Exceto 1
**AÃ§Ã£o**: 22 de 23 permissÃµes (falta `users:role:delete`)

**Resultado Esperado**:
- âœ… Perfil quase completo
- âœ… NÃ£o pode deletar perfis

---

#### CT-052: PermissÃµes SimÃ©tricas
**CenÃ¡rio**: Criar 2 perfis com mesmas permissÃµes mas nomes diferentes

**Resultado Esperado**:
- âœ… Permitido (nomes Ãºnicos)
- âœ… Ambos funcionam igualmente

---

#### CT-053: Incremento de PermissÃµes
**Teste**: Criar perfis crescentes:
- Perfil 1: 1 permissÃ£o
- Perfil 2: 5 permissÃµes
- Perfil 3: 10 permissÃµes
- Perfil 4: 23 permissÃµes

**Resultado Esperado**:
- âœ… Todos criados com sucesso

---

#### CT-054: Ordem das PermissÃµes Irrelevante
**AÃ§Ã£o**: Enviar permissÃµes em ordem aleatÃ³ria

**Resultado Esperado**:
- âœ… Backend nÃ£o depende de ordem
- âœ… Todas armazenadas corretamente

---

#### CT-055: Remover Duplicatas
**AÃ§Ã£o**: `["users:user:read", "users:user:read", "users:user:create"]`

**Resultado Esperado**:
- âœ… Backend: `permissoes.Distinct().ToList()`
- âœ… Apenas 2 registros em `RolePermissions`

---

#### CT-056: ValidaÃ§Ã£o de Formato de PermissÃ£o
**AÃ§Ã£o**: `["users-user-read"]` (hÃ­fen em vez de dois pontos)

**Resultado Esperado**:
- âœ… Status: 400 Bad Request
- âœ… Erro: "Formato invÃ¡lido: 'users-user-read'"
- âœ… Formato correto: `module:entity:action`

---

#### CT-057: Case Sensitivity
**AÃ§Ã£o**: `["Users:User:Read"]` (maiÃºsculas)

**Resultado Esperado**:
- âœ… ValidaÃ§Ã£o case-insensitive: `ToLower()`
- âœ… Convertido para: `users:user:read`

---

#### CT-058: PermissÃµes Futuras (Extensibilidade)
**CenÃ¡rio**: Sistema adiciona nova permissÃ£o `reports:report:generate`

**Resultado Esperado**:
- âœ… Perfis antigos continuam funcionando
- âœ… Nova permissÃ£o disponÃ­vel para novos perfis

---

#### CT-059: Limitar PermissÃµes por Hierarquia (Opcional)
**Regra**: h=3 nÃ£o pode ter `users:role:delete`?

**Resultado Esperado** (Se implementado):
- âœ… ValidaÃ§Ã£o: Certas permissÃµes restritas a h <= 2
- âœ… Status: 400 Bad Request se violar

---

#### CT-060: Perfil "Clonar" - Mesmas PermissÃµes
**AÃ§Ã£o**: Criar perfil com mesmas permissÃµes de "Gerente" existente

**Resultado Esperado**:
- âœ… Permitido
- âœ… Nomes diferentes, mesmas permissÃµes

---

### Categoria 4: Performance e IntegraÃ§Ã£o (10 cenÃ¡rios)

#### CT-061: Performance - Criar Perfil Simples
**AÃ§Ã£o**: Perfil com 3 permissÃµes

**Resultado Esperado**:
- âœ… Response time < 500ms
- âœ… 1 INSERT em `Roles`
- âœ… 3 INSERTs em `RolePermissions`

---

#### CT-062: Performance - Perfil com 23 PermissÃµes
**AÃ§Ã£o**: Todas as permissÃµes

**Resultado Esperado**:
- âœ… Response time < 1 segundo
- âœ… Bulk insert em `RolePermissions`

---

#### CT-063: Transaction Rollback
**CenÃ¡rio**: Erro ao inserir permissÃµes (constraint violation)

**Resultado Esperado**:
- âœ… Transaction rollback
- âœ… Perfil NÃƒO Ã© criado (atomicidade)
- âœ… Banco consistente

---

#### CT-064: ValidaÃ§Ã£o de PermissÃµes - Query
**ValidaÃ§Ã£o**: Verificar que todas as permissÃµes existem

**Query**:
```sql
SELECT COUNT(*) FROM Permissions WHERE Id IN (...)
-- Deve retornar count = permissoes.length
```

**Resultado Esperado**:
- âœ… Se count diferente: Erro "PermissÃµes invÃ¡lidas"

---

#### CT-065: Cache de PermissÃµes
**Resultado Esperado**:
- âœ… Lista de permissÃµes disponÃ­veis em cache (Redis)
- âœ… TTL: 1 hora
- âœ… Invalidado ao adicionar nova permissÃ£o no sistema

---

#### CT-066: Concurrent Creation - Nomes Ãšnicos
**CenÃ¡rio**: 2 admins criam perfil "Gerente" ao mesmo tempo

**Resultado Esperado**:
- âœ… Primeiro: 201 Created
- âœ… Segundo: 400 Bad Request (nome duplicado)
- âœ… Unique constraint no banco previne duplicata

---

#### CT-067: Audit Log - PermissÃµes Criadas
**Resultado Esperado**:
- âœ… Log registra quais permissÃµes foram associadas
- âœ… Array no campo `details.permissoes`

---

#### CT-068: IntegraÃ§Ã£o - Perfil Imediatamente DisponÃ­vel
**AÃ§Ã£o**: Criar perfil "Gerente"

**ValidaÃ§Ã£o**: `GET /api/roles` imediatamente apÃ³s

**Resultado Esperado**:
- âœ… Novo perfil aparece na lista
- âœ… Cache invalidado

---

#### CT-069: Database Indexes
**ValidaÃ§Ã£o**: Verificar query plan

**Resultado Esperado**:
- âœ… Ãndice em `Roles.Nome` (unicidade)
- âœ… Ãndice em `Roles.EmpresaId` (filtro)
- âœ… Ãndice composto em `RolePermissions(RoleId, PermissionId)`

---

#### CT-070: Memory Leak Test
**Teste**: Criar 1000 perfis

**Resultado Esperado**:
- âœ… MemÃ³ria estÃ¡vel
- âœ… GC libera objetos
- âœ… Sem memory leaks

---

### Categoria 5: UX e Frontend (10 cenÃ¡rios)

#### CT-071: FormulÃ¡rio - Grupos de PermissÃµes
**Resultado Esperado**:
- âœ… 23 permissÃµes organizadas em 6 grupos:
  - GestÃ£o de UsuÃ¡rios (4)
  - GestÃ£o de Perfis (4)
  - GestÃ£o de Empresas (4)
  - Templates (5)
  - Documentos (4)
  - Auditoria (2)
- âœ… Checkbox "Selecionar Todos" por grupo

---

#### CT-072: ValidaÃ§Ã£o em Tempo Real
**AÃ§Ã£o**: Digitar nome no campo

**Resultado Esperado**:
- âœ… ValidaÃ§Ã£o de unicidade com debounce (500ms)
- âœ… âœ— "Nome jÃ¡ existe" (vermelho)
- âœ… âœ“ "Nome disponÃ­vel" (verde)

---

#### CT-073: PrÃ©-visualizaÃ§Ã£o de PermissÃµes
**Resultado Esperado**:
- âœ… Contador: "8 permissÃµes selecionadas"
- âœ… Lista expandÃ­vel com nomes legÃ­veis:
  - `users:user:create` â†’ "Criar usuÃ¡rios"

---

#### CT-074: Hierarquia - Dropdown Filtrado
**CenÃ¡rio**: Admin (h=2) cria perfil

**Resultado Esperado**:
- âœ… Dropdown mostra apenas: 2, 3, 4, 5, 6, 7, 8, 9, 10
- âœ… h=1 nÃ£o aparece (nÃ£o pode criar Super Admin)

---

#### CT-075: Loading State
**Resultado Esperado**:
- âœ… BotÃ£o "Criar Perfil" mostra spinner: "Criando..."
- âœ… BotÃ£o desabilitado (previne duplo clique)

---

#### CT-076: Toast de Sucesso
**Resultado Esperado**:
- âœ… Toast verde com âœ“
- âœ… Mensagem: "Perfil 'Gerente de Documentos' criado com sucesso"
- âœ… AÃ§Ã£o: "Atribuir a usuÃ¡rios"
- âœ… Auto-dismiss em 5 segundos

---

#### CT-077: Toast de Erro
**Resultado Esperado**:
- âœ… Toast vermelho com âœ—
- âœ… Mensagem: "Erro ao criar perfil: Nome jÃ¡ existe"
- âœ… NÃ£o auto-dismiss

---

#### CT-078: Acessibilidade - FormulÃ¡rio
**Resultado Esperado**:
- âœ… NavegaÃ§Ã£o por teclado (Tab)
- âœ… Labels associados a inputs (`for` attribute)
- âœ… Checkboxes acessÃ­veis por Space
- âœ… Screen reader anuncia erros

---

#### CT-079: Mobile - FormulÃ¡rio Responsivo
**Resultado Esperado**:
- âœ… PermissÃµes em lista vertical (nÃ£o grid)
- âœ… Campos ocupam 100% da largura
- âœ… BotÃµes grandes (touch-friendly)

---

#### CT-080: ConfirmaÃ§Ã£o ao Sair (Dados NÃ£o Salvos)
**CenÃ¡rio**: Admin preenche formulÃ¡rio e tenta sair

**Resultado Esperado**:
- âœ… Modal: "Deseja descartar alteraÃ§Ãµes?"
- âœ… [Cancelar] [Descartar]

---

## ğŸ”’ Matriz de PermissÃµes

| Perfil | Criar Perfil | Hierarquia Permitida | Perfil de Sistema | PermissÃµes AtribuÃ­veis |
|--------|-------------|---------------------|-------------------|----------------------|
| **Developer** | âœ… | 1-10 (qualquer) | âœ… | Todas (23) |
| **Super Admin** | âœ… | 1-10 (qualquer) | âœ… | Todas (23) |
| **Admin** | âœ… | 2-10 (>= sua) | âŒ | Todas (23) |
| **Gerente** | âŒ | N/A | âŒ | N/A |
| **UsuÃ¡rio** | âŒ | N/A | âŒ | N/A |

---

## ğŸ“ˆ CritÃ©rios de AceitaÃ§Ã£o

### Backend
- [ ] Endpoint `POST /api/roles` com validaÃ§Ã£o completa
- [ ] ValidaÃ§Ã£o de hierarquia (nÃ£o pode criar superior Ã  sua)
- [ ] ValidaÃ§Ã£o de unicidade de nome (por escopo)
- [ ] Escopo global apenas para Super Admin
- [ ] MÃ­nimo 1 permissÃ£o obrigatÃ³ria
- [ ] Todas as permissÃµes validadas (existem no sistema)
- [ ] Transaction atÃ´mica (Role + RolePermissions)
- [ ] Audit log completo
- [ ] Response time < 1s (mesmo com 23 permissÃµes)

### Frontend
- [ ] FormulÃ¡rio com validaÃ§Ã£o em tempo real
- [ ] PermissÃµes organizadas em grupos
- [ ] Checkbox "Selecionar Todos" por grupo
- [ ] Dropdown de hierarquia filtrado conforme usuÃ¡rio
- [ ] Campo escopo desabilitado para nÃ£o-Super Admin
- [ ] Contador de permissÃµes selecionadas
- [ ] Loading state durante criaÃ§Ã£o
- [ ] Toast de sucesso/erro
- [ ] ValidaÃ§Ã£o de unicidade de nome (debounce 500ms)
- [ ] Acessibilidade (WCAG 2.1 AA)

---

## ğŸ§© DependÃªncias

### Backend
- `RolesController.Create(request)` âœ… Implementado
- `PermissionsService.GetAll()` âœ… Implementado
- `AuthorizationService.ValidateHierarchy()` âœ… Implementado
- `AuditLogService.LogCreate()` âœ… Implementado

### Frontend
- `RolesListComponent` âœ… Implementado ([roles.component.ts](../../../frontend/icontrolit-app/src/app/modules/admin/management/roles/roles.component.ts))
- `RolesService.createRole()` âœ… Implementado ([roles.service.ts](../../../frontend/icontrolit-app/src/app/modules/admin/management/roles/roles.service.ts))
- `RolesDetailsComponent` âœ… Implementado
- `PermissionsService` âœ… Implementado

---

## ğŸ“ Notas de ImplementaÃ§Ã£o

### Estrutura de Dados
```csharp
public class Role
{
    public Guid Id { get; set; }
    public string Nome { get; set; } // max 100 chars
    public int Hierarquia { get; set; } // 1-10
    public string? Descricao { get; set; } // max 500 chars
    public Guid? EmpresaId { get; set; } // NULL = global
    public Guid CriadoPorId { get; set; }
    public DateTime DataCriacao { get; set; }

    // Navigation
    public List<RolePermission> RolePermissions { get; set; }
}

public class RolePermission
{
    public Guid RoleId { get; set; }
    public Guid PermissionId { get; set; }

    public Role Role { get; set; }
    public Permission Permission { get; set; }
}
```

### ValidaÃ§Ã£o de Unicidade
```csharp
// Nome Ãºnico por escopo (empresa ou global)
var exists = await _context.Roles.AnyAsync(r =>
    r.Nome == request.Nome &&
    (r.EmpresaId == request.EmpresaId || r.EmpresaId == null)
);
if (exists) return BadRequest("Nome jÃ¡ existe");
```

### Bulk Insert de PermissÃµes
```csharp
var rolePermissions = request.Permissoes.Select(p => new RolePermission
{
    RoleId = role.Id,
    PermissionId = p
});

await _context.RolePermissions.AddRangeAsync(rolePermissions);
await _context.SaveChangesAsync(); // Transaction atÃ´mica
```

---

## âœ… Checklist de Completude

- [x] Todos os fluxos documentados (4 alternativos, 12 exceÃ§Ã£o)
- [x] 80 cenÃ¡rios de teste criados
- [x] ValidaÃ§Ã£o de hierarquia
- [x] ValidaÃ§Ã£o de escopo (global/empresa)
- [x] CombinaÃ§Ãµes de permissÃµes (20 cenÃ¡rios)
- [x] Performance e integraÃ§Ã£o
- [x] UX e acessibilidade
- [x] Matriz de permissÃµes
- [x] CritÃ©rios de aceitaÃ§Ã£o

---

**Status Final**: âœ… **UC05 100% ESPECIFICADO**

**Complexidade**: ğŸ”´ Alta (base do sistema de autorizaÃ§Ã£o)

**PrÃ³ximos Passos**:
1. Executar todos os 80 cenÃ¡rios de teste
2. Validar hierarquia com casos extremos
3. Testar todas as 784 combinaÃ§Ãµes de permissÃµes
4. Performance test com 1000 perfis
5. Teste de concorrÃªncia (criaÃ§Ã£o simultÃ¢nea)

**Ãšltima AtualizaÃ§Ã£o**: 2025-10-20
**Revisado por**: Anderson Chipak + Claude Code

---

# UC06: Visualizar Perfil (Role) - EspecificaÃ§Ã£o Completa

**Autor**: Anderson Chipak + Claude Code
**Status**: âœ… Implementado (Backend + Frontend)

---

## ğŸ“‹ SumÃ¡rio Executivo

| Aspecto | Detalhes |
|---------|----------|
| **Objetivo** | Permitir visualizaÃ§Ã£o de perfis/roles existentes e suas permissÃµes |
| **Atores** | Super Admin, Admin, Gerente (com permissÃ£o `users:role:read`) |
| **PrÃ©-condiÃ§Ãµes** | UsuÃ¡rio autenticado com permissÃ£o `users:role:read` |
| **PÃ³s-condiÃ§Ãµes** | Dados do perfil exibidos corretamente |
| **CenÃ¡rios de Teste** | **40 cenÃ¡rios** (validaÃ§Ã£o, seguranÃ§a, performance, UX) |
| **Prioridade** | ğŸŸ¢ Baixa (funcionalidade de leitura) |

---

## ğŸ¯ DescriÃ§Ã£o do Caso de Uso

### Objetivo
Permitir que usuÃ¡rios autorizados:
1. **Visualizem lista** de todos os perfis disponÃ­veis
2. **Visualizem detalhes** de um perfil especÃ­fico
3. **Filtrem e ordenem** perfis por hierarquia, empresa, etc.
4. **Vejam usuÃ¡rios** associados a cada perfil

### Atores Principais
- **Super Administrador**: Visualiza todos os perfis (globais e de todas as empresas)
- **Administrador**: Visualiza perfis da prÃ³pria empresa + perfis globais
- **Gerente**: Visualiza perfis disponÃ­veis (se tiver permissÃ£o)
- **UsuÃ¡rio**: Pode visualizar apenas prÃ³prios perfis atribuÃ­dos

### PermissÃµes NecessÃ¡rias
- **Visualizar lista**: `users:role:read`
- **Visualizar detalhes**: `users:role:read`
- **Ver usuÃ¡rios do perfil**: `users:role:read` + `users:user:read`

---

## ğŸ“Š Fluxos

### Fluxo Principal - Visualizar Lista

**FP-01: Listar Todos os Perfis**

1. UsuÃ¡rio acessa pÃ¡gina `/management/roles`
2. Sistema valida permissÃ£o `users:role:read`
3. Sistema carrega lista de perfis:
   - **Super Admin**: Todos os perfis (globais + todas empresas)
   - **Admin**: Perfis da empresa + globais
   - **Outros**: Perfis disponÃ­veis conforme escopo
4. Sistema exibe tabela/cards com:
   - Nome do perfil
   - Hierarquia (nÃºmero + badge colorido)
   - Quantidade de permissÃµes
   - Quantidade de usuÃ¡rios
   - Escopo (Global ou nome da empresa)
   - AÃ§Ãµes (visualizar, editar, excluir - conforme permissÃµes)
5. Sistema exibe total de registros
6. Sistema exibe controles de filtro e ordenaÃ§Ã£o

**Resultado Esperado**:
- âœ… Lista carregada em < 2 segundos
- âœ… Perfis exibidos conforme escopo do usuÃ¡rio
- âœ… Badges coloridos por hierarquia
- âœ… BotÃµes de aÃ§Ã£o corretos

---

### Fluxo Principal - Visualizar Detalhes

**FP-02: Visualizar Detalhes de Perfil EspecÃ­fico**

1. UsuÃ¡rio clica em perfil "Gerente de Documentos"
2. Sistema redireciona para `/management/roles/{id}`
3. Sistema valida permissÃ£o `users:role:read`
4. Sistema valida que perfil estÃ¡ no escopo do usuÃ¡rio
5. Sistema busca dados via `GET /api/roles/{id}`
6. Sistema exibe painel de detalhes com seÃ§Ãµes:
   ```
   Gerente de Documentos
   [Badge: Hierarquia 3 - Gerente]
   [Badge: Empresa XYZ] ou [Badge: Global]

   DescriÃ§Ã£o:
   ResponsÃ¡vel por gerenciar templates e geraÃ§Ã£o de documentos

   PermissÃµes (8):
   âœ“ Criar templates (documents:template:create)
   âœ“ Visualizar templates (documents:template:read)
   âœ“ Editar templates (documents:template:update)
   âœ“ Publicar templates (documents:template:publish)
   âœ“ Gerar documentos (documents:document:generate)
   âœ“ Visualizar documentos (documents:document:read)
   âœ“ Baixar documentos (documents:document:download)
   âœ“ Visualizar logs (audit:logs:read)

   UsuÃ¡rios com este perfil (5):
   â€¢ JoÃ£o Silva
   â€¢ Maria Santos
   â€¢ Pedro Oliveira
   â€¢ Ana Costa
   â€¢ Carlos Ferreira
   [Ver todos os usuÃ¡rios â†’]

   InformaÃ§Ãµes:
   Criado em: 15/09/2025 por Admin Master
   Ãšltima atualizaÃ§Ã£o: 20/10/2025 por Admin Master
   ```
7. Sistema exibe botÃµes de aÃ§Ã£o (se autorizado):
   - "Editar" (requer `users:role:update`)
   - "Excluir" (requer `users:role:delete`)
   - "Duplicar" (requer `users:role:create`)

**Resultado Esperado**:
- âœ… Detalhes carregados em < 1 segundo
- âœ… PermissÃµes exibidas com nomes legÃ­veis
- âœ… Lista de usuÃ¡rios visÃ­vel
- âœ… BotÃµes aparecem conforme permissÃµes

---

### Fluxos Alternativos

**FA-01: Filtrar por Hierarquia**
1. UsuÃ¡rio seleciona "Apenas Gerentes (h=3)"
2. Sistema aplica filtro `hierarquia=3`
3. Lista atualizada

**FA-02: Filtrar por Empresa**
1. Super Admin seleciona empresa no dropdown
2. Sistema filtra perfis daquela empresa + globais
3. Contador atualizado

**FA-03: Ordenar por Nome**
1. UsuÃ¡rio clica em coluna "Nome"
2. Sistema ordena alfabeticamente
3. Indicador visual (â†‘â†“)

**FA-04: Ordenar por Hierarquia**
1. OrdenaÃ§Ã£o por nÃ­vel (1 â†’ 10)
2. Super Admin aparece primeiro

**FA-05: Buscar por Nome**
1. UsuÃ¡rio digita "documento" no campo de busca
2. Sistema filtra: "Gerente de Documentos", "Auditor de Documentos"
3. Busca case-insensitive e parcial

**FA-06: Ver UsuÃ¡rios do Perfil**
1. UsuÃ¡rio clica em "5 usuÃ¡rios" no card
2. Modal/pÃ¡gina exibe lista completa
3. Link para perfil de cada usuÃ¡rio

**FA-07: Visualizar PrÃ³prios Perfis (UsuÃ¡rio Comum)**
1. UsuÃ¡rio comum acessa `/profile/my-roles`
2. Sistema exibe apenas perfis atribuÃ­dos a ele
3. NÃ£o pode ver outros perfis

---

### Fluxos de ExceÃ§Ã£o

**FE-01: PermissÃ£o Negada**
- **CondiÃ§Ã£o**: UsuÃ¡rio sem `users:role:read`
- **AÃ§Ã£o**: Redirecionar para `/dashboard` com toast "Acesso negado"

**FE-02: Perfil NÃ£o Encontrado**
- **CondiÃ§Ã£o**: `GET /api/roles/{id-inexistente}`
- **AÃ§Ã£o**: PÃ¡gina 404 com botÃ£o "Voltar para lista"

**FE-03: Acesso a Perfil de Outra Empresa**
- **CondiÃ§Ã£o**: Admin Empresa A tenta ver perfil especÃ­fico da Empresa B
- **AÃ§Ã£o**: 403 Forbidden ou 404 (obscuridade)

**FE-04: Lista Vazia**
- **CondiÃ§Ã£o**: Nenhum perfil encontrado
- **AÃ§Ã£o**: Estado vazio: "Nenhum perfil encontrado. Crie o primeiro!"

**FE-05: Erro de ConexÃ£o**
- **CondiÃ§Ã£o**: Backend inacessÃ­vel
- **AÃ§Ã£o**: Skeleton loader por 30s, depois mensagem de erro

---

## ğŸ§ª CenÃ¡rios de Teste (40 Total)

### Categoria 1: ValidaÃ§Ã£o BÃ¡sica (10 cenÃ¡rios)

#### CT-001: Listar Perfis - Caminho Feliz
**PrÃ©-condiÃ§Ãµes**: Admin logado com `users:role:read`

**AÃ§Ã£o**:
```http
GET /api/roles
Authorization: Bearer {token}
```

**Resultado Esperado**:
- âœ… Status: **200 OK**
- âœ… Response:
  ```json
  [
    {
      "id": "role-guid-1",
      "nome": "Super Administrador",
      "hierarquia": 1,
      "descricao": "Controle total do sistema",
      "empresaId": null,
      "empresaNome": "Global",
      "quantidadePermissoes": 23,
      "quantidadeUsuarios": 2,
      "dataCriacao": "2025-01-01T00:00:00Z"
    },
    {
      "id": "role-guid-2",
      "nome": "Gerente de Documentos",
      "hierarquia": 3,
      "descricao": "...",
      "empresaId": "empresa-guid",
      "empresaNome": "Acme Corp",
      "quantidadePermissoes": 8,
      "quantidadeUsuarios": 5,
      "dataCriacao": "2025-09-15T10:30:00Z"
    }
  ]
  ```
- âœ… Response time < 2 segundos

---

#### CT-002: Visualizar Detalhes de Perfil
**AÃ§Ã£o**:
```http
GET /api/roles/role-guid-2
```

**Resultado Esperado**:
- âœ… Status: 200 OK
- âœ… Response:
  ```json
  {
    "id": "role-guid-2",
    "nome": "Gerente de Documentos",
    "hierarquia": 3,
    "descricao": "ResponsÃ¡vel por gerenciar templates...",
    "empresaId": "empresa-guid",
    "empresaNome": "Acme Corp",
    "permissoes": [
      {
        "id": "perm-guid-1",
        "codigo": "documents:template:create",
        "nome": "Criar templates",
        "descricao": "Permite criar novos templates de documentos"
      },
      // ... 7 mais
    ],
    "usuarios": [
      {
        "id": "user-guid-1",
        "nome": "JoÃ£o Silva",
        "email": "joao@acme.com"
      },
      // ... 4 mais
    ],
    "dataCriacao": "2025-09-15T10:30:00Z",
    "criadoPor": "Admin Master",
    "dataUltimaAtualizacao": "2025-10-20T14:22:00Z",
    "modificadoPor": "Admin Master"
  }
  ```

---

#### CT-003: Super Admin VÃª Todos os Perfis
**Resultado Esperado**:
- âœ… Retorna perfis globais + de todas as empresas
- âœ… Sem filtro de `empresaId` aplicado

---

#### CT-004: Admin VÃª Perfis da Empresa + Globais
**Resultado Esperado**:
- âœ… Query:
  ```sql
  SELECT * FROM Roles
  WHERE EmpresaId = '{empresaDoAdmin}' OR EmpresaId IS NULL
  ```
- âœ… NÃ£o vÃª perfis de outras empresas

---

#### CT-005: Perfis Ordenados por Hierarquia (PadrÃ£o)
**Resultado Esperado**:
- âœ… Ordem: h=1, h=2, h=3, ..., h=10
- âœ… Super Admin sempre primeiro

---

#### CT-006: Filtrar por Nome (Busca Parcial)
**AÃ§Ã£o**: `GET /api/roles?nome=gerente`

**Resultado Esperado**:
- âœ… Retorna: "Gerente de Documentos", "Gerente de TI", "Gerente Financeiro"
- âœ… Case-insensitive
- âœ… Busca parcial funciona

---

#### CT-007: Filtrar por Hierarquia
**AÃ§Ã£o**: `GET /api/roles?hierarquia=3`

**Resultado Esperado**:
- âœ… Retorna apenas perfis com h=3
- âœ… Contador correto

---

#### CT-008: Filtrar por Empresa
**AÃ§Ã£o**: `GET /api/roles?empresaId=empresa-guid`

**Resultado Esperado**:
- âœ… Retorna perfis da empresa + globais
- âœ… NÃ£o retorna de outras empresas

---

#### CT-009: Filtrar Apenas Perfis Globais
**AÃ§Ã£o**: `GET /api/roles?escopo=global`

**Resultado Esperado**:
- âœ… Query: `WHERE EmpresaId IS NULL`
- âœ… Apenas perfis multi-empresa

---

#### CT-010: Ordenar por Nome
**AÃ§Ã£o**: `GET /api/roles?sortBy=nome&sortOrder=asc`

**Resultado Esperado**:
- âœ… Ordem alfabÃ©tica A-Z
- âœ… "Admin" antes de "Gerente"

---

### Categoria 2: SeguranÃ§a e PermissÃµes (10 cenÃ¡rios)

#### CT-011: Sem PermissÃ£o - Listar
**PrÃ©-condiÃ§Ãµes**: UsuÃ¡rio SEM `users:role:read`

**AÃ§Ã£o**: `GET /api/roles`

**Resultado Esperado**:
- âœ… Status: **403 Forbidden**
- âœ… Frontend redireciona para `/dashboard`
- âœ… Toast: "Acesso negado"

---

#### CT-012: Sem PermissÃ£o - Visualizar Detalhes
**AÃ§Ã£o**: `GET /api/roles/{id}`

**Resultado Esperado**:
- âœ… Status: 403 Forbidden

---

#### CT-013: Token Expirado
**AÃ§Ã£o**: Request com JWT expirado

**Resultado Esperado**:
- âœ… Status: **401 Unauthorized**
- âœ… Redireciona para login

---

#### CT-014: IDOR - Ver Perfil de Outra Empresa
**CenÃ¡rio**: Admin Empresa A tenta `GET /api/roles/{perfil-empresa-b}`

**Resultado Esperado**:
- âœ… Status: **404 Not Found** (seguranÃ§a por obscuridade)
- âœ… Mensagem: "Perfil nÃ£o encontrado"

---

#### CT-015: SQL Injection na Busca
**AÃ§Ã£o**: `GET /api/roles?nome='; DROP TABLE Roles; --`

**Resultado Esperado**:
- âœ… Query parametrizada, SQL nÃ£o executa
- âœ… Lista vazia ou erro genÃ©rico
- âœ… Banco intacto

---

#### CT-016: XSS no Nome do Perfil
**CenÃ¡rio**: Perfil criado com nome `<script>alert('XSS')</script>`

**AÃ§Ã£o**: Visualizar detalhes

**Resultado Esperado**:
- âœ… Frontend escapa HTML
- âœ… Nome exibido como texto: `&lt;script&gt;...`
- âœ… Script NÃƒO executa

---

#### CT-017: Acesso Direto por URL (Sem Auth)
**AÃ§Ã£o**: Navegar para `/management/roles` sem login

**Resultado Esperado**:
- âœ… Route guard bloqueia
- âœ… Redireciona para `/sign-in`
- âœ… Salva URL para redirecionar apÃ³s login

---

#### CT-018: Ver UsuÃ¡rios Requer PermissÃ£o Extra
**CenÃ¡rio**: UsuÃ¡rio com `users:role:read` mas SEM `users:user:read`

**Resultado Esperado**:
- âœ… VÃª detalhes do perfil
- âœ… SeÃ§Ã£o "UsuÃ¡rios" mostra: "5 usuÃ¡rios (requer permissÃ£o para visualizar)"
- âœ… Ou apenas contador, sem nomes

---

#### CT-019: Rate Limiting
**AÃ§Ã£o**: 100 requisiÃ§Ãµes GET em 1 minuto

**Resultado Esperado**:
- âœ… ApÃ³s 50 requests: Status **429 Too Many Requests**
- âœ… Header: `Retry-After: 60`

---

#### CT-020: Auditoria - VisualizaÃ§Ã£o NÃ£o Ã© Logada
**Resultado Esperado**:
- âœ… Listagem NÃƒO cria log de auditoria (evitar spam)
- âœ… VisualizaÃ§Ã£o de detalhes PODE criar log (opcional)

---

### Categoria 3: Performance (5 cenÃ¡rios)

#### CT-021: Performance - Listar 50 Perfis
**AÃ§Ã£o**: `GET /api/roles` (sistema com 50 perfis)

**Resultado Esperado**:
- âœ… Response time < 500ms
- âœ… Eager loading: `.Include(r => r.RolePermissions).Include(r => r.Usuarios)`

---

#### CT-022: Performance - Detalhes com 23 PermissÃµes
**AÃ§Ã£o**: `GET /api/roles/{super-admin-id}`

**Resultado Esperado**:
- âœ… Response time < 1 segundo
- âœ… Join eficiente: `RolePermissions JOIN Permissions`

---

#### CT-023: Performance - Contar UsuÃ¡rios
**ValidaÃ§Ã£o**: Query otimizada

**Query Ideal**:
```sql
SELECT r.*, COUNT(ur.UsuarioId) AS QuantidadeUsuarios
FROM Roles r
LEFT JOIN UsuarioRoles ur ON r.Id = ur.RoleId
GROUP BY r.Id
```

**Resultado Esperado**:
- âœ… NÃ£o faz N+1 queries
- âœ… AgregaÃ§Ã£o no banco (nÃ£o na aplicaÃ§Ã£o)

---

#### CT-024: Cache - RequisiÃ§Ãµes Repetidas
**AÃ§Ã£o**: Fazer 10 requests idÃªnticos seguidos

**Resultado Esperado**:
- âœ… Primeira requisiÃ§Ã£o: 500ms
- âœ… Demais requisiÃ§Ãµes: < 50ms (cache)
- âœ… Header: `X-Cache: HIT`
- âœ… TTL: 5 minutos

---

#### CT-025: Database Indexes
**ValidaÃ§Ã£o**: Verificar query plan

**Resultado Esperado**:
- âœ… Ãndice em `Roles.Nome` (busca)
- âœ… Ãndice em `Roles.Hierarquia` (filtro)
- âœ… Ãndice em `Roles.EmpresaId` (filtro de escopo)

---

### Categoria 4: UX e Frontend (10 cenÃ¡rios)

#### CT-026: Loading State - Skeleton Loader
**AÃ§Ã£o**: Acessar pÃ¡gina com conexÃ£o lenta

**Resultado Esperado**:
- âœ… Skeleton cards aparecem imediatamente
- âœ… 10 placeholders de loading
- âœ… Desaparecem quando dados carregam

---

#### CT-027: Empty State - Nenhum Perfil
**CenÃ¡rio**: Empresa nova sem perfis customizados

**Resultado Esperado**:
- âœ… IlustraÃ§Ã£o: "Nenhum perfil encontrado"
- âœ… Mensagem: "Crie perfis personalizados para organizar permissÃµes"
- âœ… BotÃ£o: "â• Criar Primeiro Perfil" (se autorizado)

---

#### CT-028: Error State - Falha ao Carregar
**AÃ§Ã£o**: Desconectar backend

**Resultado Esperado**:
- âœ… Mensagem: "Erro ao carregar perfis"
- âœ… BotÃ£o "Tentar novamente"
- âœ… NÃ£o mostra stack trace

---

#### CT-029: Badges de Hierarquia Coloridos
**Resultado Esperado**:
- âœ… h=1: Badge vermelho "Super Admin"
- âœ… h=2: Badge laranja "Admin"
- âœ… h=3: Badge azul "Gerente"
- âœ… h=4: Badge verde "Coordenador"
- âœ… h>=5: Badge cinza "UsuÃ¡rio"

---

#### CT-030: Ãcones de PermissÃµes
**Resultado Esperado**:
- âœ… `users:*` â†’ ğŸ‘¤ Ã­cone de pessoa
- âœ… `documents:*` â†’ ğŸ“„ Ã­cone de documento
- âœ… `audit:*` â†’ ğŸ” Ã­cone de lupa
- âœ… `companies:*` â†’ ğŸ¢ Ã­cone de prÃ©dio

---

#### CT-031: Tooltip com DescriÃ§Ã£o
**AÃ§Ã£o**: Hover sobre nome da permissÃ£o

**Resultado Esperado**:
- âœ… Tooltip: "Criar templates - Permite criar novos templates de documentos"
- âœ… Delay de 500ms

---

#### CT-032: ExpansÃ£o de PermissÃµes
**Resultado Esperado**:
- âœ… Card mostra: "8 permissÃµes"
- âœ… Clique expande lista completa
- âœ… Ãcone: â–¼ (expandido) / â–¶ (colapsado)

---

#### CT-033: Lista de UsuÃ¡rios Limitada
**CenÃ¡rio**: Perfil com 50 usuÃ¡rios

**Resultado Esperado**:
- âœ… Card mostra: "50 usuÃ¡rios (ver todos)"
- âœ… Detalhes mostram primeiros 10
- âœ… BotÃ£o: "Ver todos os 50 usuÃ¡rios"

---

#### CT-034: Busca com Debounce
**AÃ§Ã£o**: Digitar "gerente" no campo de busca

**Resultado Esperado**:
- âœ… RequisiÃ§Ã£o sÃ³ apÃ³s 500ms sem digitaÃ§Ã£o
- âœ… NÃ£o faz 7 requisiÃ§Ãµes (uma por letra)
- âœ… Indicador: "Buscando..."

---

#### CT-035: Acessibilidade - NavegaÃ§Ã£o por Teclado
**AÃ§Ã£o**: Usar Tab, Enter, Arrows

**Resultado Esperado**:
- âœ… PossÃ­vel navegar por todos os cards
- âœ… Enter abre detalhes
- âœ… Focus visÃ­vel

---

### Categoria 5: IntegraÃ§Ã£o (5 cenÃ¡rios)

#### CT-036: Perfil com Zero UsuÃ¡rios
**CenÃ¡rio**: Perfil recÃ©m-criado, ainda nÃ£o atribuÃ­do

**Resultado Esperado**:
- âœ… `quantidadeUsuarios: 0`
- âœ… Mensagem: "Nenhum usuÃ¡rio com este perfil"
- âœ… Link: "Atribuir a usuÃ¡rios"

---

#### CT-037: Perfil Global - Badge Especial
**Resultado Esperado**:
- âœ… Badge: "ğŸŒ Global"
- âœ… Tooltip: "DisponÃ­vel em todas as empresas"
- âœ… Cor diferenciada (azul claro)

---

#### CT-038: PermissÃµes Herdadas (NÃ£o AplicÃ¡vel)
**ObservaÃ§Ã£o**: Sistema nÃ£o tem heranÃ§a de perfis (flat structure)

**Resultado Esperado**:
- âœ… Cada perfil tem permissÃµes explÃ­citas
- âœ… Sem heranÃ§a de "perfil pai"

---

#### CT-039: SincronizaÃ§Ã£o com UsuÃ¡rios
**CenÃ¡rio**: Admin edita perfil enquanto Admin B estÃ¡ vendo lista

**Resultado Esperado**:
- âœ… Lista de Admin B nÃ£o atualiza automaticamente (sem WebSocket)
- âœ… BotÃ£o "Atualizar" disponÃ­vel
- âœ… Cache expira em 5 minutos

---

#### CT-040: Exportar Lista de Perfis (CSV)
**AÃ§Ã£o**: `GET /api/roles/export`

**Resultado Esperado**:
- âœ… Arquivo CSV:
  ```csv
  Nome,Hierarquia,Empresa,PermissÃµes,UsuÃ¡rios
  Super Administrador,1,Global,23,2
  Gerente de Documentos,3,Acme Corp,8,5
  ```
- âœ… Encoding UTF-8 com BOM

---

## ğŸ”’ Matriz de PermissÃµes

| Perfil | Listar Perfis | Ver Detalhes | Ver UsuÃ¡rios | Ver Todas Empresas |
|--------|--------------|--------------|--------------|-------------------|
| **Super Admin** | âœ… Todos | âœ… Todos | âœ… | âœ… |
| **Admin** | âœ… Empresa + Globais | âœ… Empresa + Globais | âœ… | âŒ |
| **Gerente** | âœ… (se tem permissÃ£o) | âœ… | âš ï¸ Requer `users:user:read` | âŒ |
| **UsuÃ¡rio** | âŒ | âŒ Apenas prÃ³prios | âŒ | âŒ |

---

## ğŸ“ˆ CritÃ©rios de AceitaÃ§Ã£o

### Backend
- [ ] Endpoint `GET /api/roles` com filtros e ordenaÃ§Ã£o
- [ ] Endpoint `GET /api/roles/{id}` com detalhes completos
- [ ] Filtro automÃ¡tico por escopo (empresa/global)
- [ ] Eager loading de permissÃµes e usuÃ¡rios
- [ ] Contadores calculados (quantidadePermissoes, quantidadeUsuarios)
- [ ] Response time < 1s para 100 perfis
- [ ] Cache de 5 minutos

### Frontend
- [ ] PÃ¡gina de listagem com cards/tabela
- [ ] Filtros: nome, hierarquia, empresa
- [ ] OrdenaÃ§Ã£o por nome, hierarquia
- [ ] Busca com debounce (500ms)
- [ ] Skeleton loader durante carregamento
- [ ] Empty state quando sem resultados
- [ ] Error state com retry
- [ ] PÃ¡gina de detalhes com todas as permissÃµes
- [ ] Lista de usuÃ¡rios do perfil
- [ ] Badges coloridos por hierarquia
- [ ] AcessÃ­vel (WCAG 2.1 AA)

---

## ğŸ§© DependÃªncias

### Backend
- `RolesController.GetAll()` âœ… Implementado
- `RolesController.GetById(id)` âœ… Implementado
- `AuthorizationService` âœ… Implementado

### Frontend
- `RolesListComponent` âœ… Implementado ([roles.component.ts](../../../frontend/icontrolit-app/src/app/modules/admin/management/roles/roles.component.ts))
- `RolesService` âœ… Implementado ([roles.service.ts](../../../frontend/icontrolit-app/src/app/modules/admin/management/roles/roles.service.ts))
- `RolesDetailsComponent` âœ… Implementado
- `PermissionService` âœ… Implementado

---

## ğŸ“ Notas de ImplementaÃ§Ã£o

### Query Otimizada
```csharp
public async Task<List<RoleDto>> GetAll(string? empresaId)
{
    var query = _context.Roles
        .Include(r => r.RolePermissions)
            .ThenInclude(rp => rp.Permission)
        .Include(r => r.UsuarioRoles)
        .AsQueryable();

    // Filtro de escopo
    if (empresaId != null)
    {
        query = query.Where(r => r.EmpresaId == empresaId || r.EmpresaId == null);
    }

    var roles = await query.ToListAsync();

    return roles.Select(r => new RoleDto
    {
        Id = r.Id,
        Nome = r.Nome,
        Hierarquia = r.Hierarquia,
        QuantidadePermissoes = r.RolePermissions.Count,
        QuantidadeUsuarios = r.UsuarioRoles.Count
    }).ToList();
}
```

### Cache Strategy
```csharp
var cacheKey = $"roles:empresa:{empresaId}";
var cached = await _cache.GetAsync<List<RoleDto>>(cacheKey);

if (cached != null) return cached;

var roles = await GetRolesFromDatabase(empresaId);
await _cache.SetAsync(cacheKey, roles, TimeSpan.FromMinutes(5));

return roles;
```

---

## âœ… Checklist de Completude

- [x] Todos os fluxos documentados (7 alternativos, 5 exceÃ§Ã£o)
- [x] 40 cenÃ¡rios de teste criados
- [x] ValidaÃ§Ã£o de escopo (empresa/global)
- [x] Performance otimizada (eager loading)
- [x] Cache strategy definida
- [x] UX completa (loading, empty, error states)
- [x] Acessibilidade considerada
- [x] Matriz de permissÃµes

---

**Status Final**: âœ… **UC06 100% ESPECIFICADO**

**Complexidade**: ğŸŸ¢ Baixa (operaÃ§Ã£o de leitura)

**PrÃ³ximos Passos**:
1. Executar todos os 40 cenÃ¡rios de teste
2. Validar performance com 1000 perfis
3. Testar filtros e ordenaÃ§Ã£o
4. Validar cache (hit rate > 80%)
5. Teste de acessibilidade

**Ãšltima AtualizaÃ§Ã£o**: 2025-10-20
**Revisado por**: Anderson Chipak + Claude Code

---

# UC03: Editar Perfil (Role) - EspecificaÃ§Ã£o Completa

**Data CriaÃ§Ã£o**: 2025-10-20
**Ãšltima AtualizaÃ§Ã£o**: 2025-10-26
**Autor**: Anderson Chipak + Claude Code
**Status**: âœ… Implementado e Corrigido (Backend + Frontend)

---

## ğŸ“¢ AtualizaÃ§Ã£o 2025-10-26 - CorreÃ§Ãµes CrÃ­ticas Implementadas

### âœ… CorreÃ§Ãµes Aplicadas

**A. HierarchyLevel Agora EditÃ¡vel via API**
- âœ… Campo `hierarchyLevel` adicionado ao `UpdateRoleCommand`
- âœ… Frontend atualizado: `UpdateRoleRequest` inclui `hierarchyLevel`
- âœ… UsuÃ¡rios agora podem alterar o nÃ­vel de hierarquia de perfis existentes
- **Arquivos modificados:**
  - [UpdateRole.cs](D:\IC2\backend\IControlIT.API\src\Application\RoleManagement\Commands\UpdateRole\UpdateRole.cs)
  - [roles.types.ts](D:\IC2\frontend\icontrolit-app\src\app\modules\admin\management\roles\roles.types.ts)

**B. ValidaÃ§Ã£o de Hierarquia na EdiÃ§Ã£o**
- âœ… `UpdateRoleCommandHandler` valida se usuÃ¡rio pode atribuir o nÃ­vel solicitado
- âœ… Regra: `currentUserLevel >= request.HierarchyLevel` resulta em `UnauthorizedAccessException`
- âœ… Mensagem de erro clara: "VocÃª nÃ£o tem permissÃ£o para atribuir nÃ­vel de hierarquia {X}"
- âœ… Previne que Admin (nÃ­vel 1) edite perfil para Super Admin (nÃ­vel 0)
- **Impacto:** ImpossÃ­vel escalar privilÃ©gios ao editar perfis

**C. Validator para Update Criado**
- âœ… `UpdateRoleCommandValidator.cs` criado com validaÃ§Ãµes:
  - ID obrigatÃ³rio
  - Nome obrigatÃ³rio, mÃ¡x 100 caracteres
  - DescriÃ§Ã£o mÃ¡x 500 caracteres
  - HierarchyLevel entre 0-10
- **Arquivo criado:**
  - [UpdateRoleCommandValidator.cs](D:\IC2\backend\IControlIT.API\src\Application\RoleManagement\Commands\UpdateRole\UpdateRoleCommandValidator.cs)

### ğŸ“Š Impacto nas Regras de NegÃ³cio

**Antes da CorreÃ§Ã£o:**
- âŒ HierarchyLevel nÃ£o podia ser alterado via API
- âŒ Perfis criados com nÃ­vel errado ficavam "travados"
- âŒ NÃ£o havia validaÃ§Ã£o de hierarquia na ediÃ§Ã£o

**Depois da CorreÃ§Ã£o:**
- âœ… HierarchyLevel completamente editÃ¡vel (com validaÃ§Ã£o)
- âœ… ValidaÃ§Ã£o de hierarquia robusta na ediÃ§Ã£o
- âœ… Sistema de nÃ­veis totalmente funcional
- âœ… ImpossÃ­vel escalar privilÃ©gios indevidamente ao editar

---

## ğŸ“‹ SumÃ¡rio Executivo

| Aspecto | Detalhes |
|---------|----------|
| **Objetivo** | Permitir modificaÃ§Ã£o de perfis/roles existentes e suas permissÃµes |
| **Atores** | Super Admin, Admin (com permissÃ£o `users:role:update`) |
| **PrÃ©-condiÃ§Ãµes** | UsuÃ¡rio autenticado, perfil existe, permissÃ£o adequada |
| **PÃ³s-condiÃ§Ãµes** | Perfil atualizado, permissÃµes recalculadas para usuÃ¡rios, auditoria registrada |
| **CenÃ¡rios de Teste** | **90 cenÃ¡rios** (validaÃ§Ã£o, permissÃµes, impacto em usuÃ¡rios, concorrÃªncia) |
| **Prioridade** | ğŸ”´ CrÃ­tica (impacta mÃºltiplos usuÃ¡rios simultaneamente) |

---

## ğŸ¯ DescriÃ§Ã£o do Caso de Uso

### Objetivo
Permitir que administradores modifiquem perfis existentes, incluindo:
1. **Nome e descriÃ§Ã£o**: Renomear perfil
2. **Hierarquia**: Ajustar nÃ­vel (com restriÃ§Ãµes)
3. **PermissÃµes**: Adicionar, remover ou modificar permissÃµes
4. **Escopo**: Alterar de especÃ­fico para global (Super Admin only)

### âš ï¸ Impactos CrÃ­ticos
Editar um perfil afeta **TODOS** os usuÃ¡rios que possuem esse perfil:
- Adicionar permissÃ£o â†’ Todos ganham acesso imediatamente
- Remover permissÃ£o â†’ Todos perdem acesso imediatamente
- Mudar hierarquia â†’ Pode afetar validaÃ§Ãµes de autorizaÃ§Ã£o

### Atores Principais
- **Super Administrador**: Pode editar qualquer perfil (inclusive hierarquia)
- **Administrador**: Pode editar perfis da empresa (hierarquia >= sua prÃ³pria)

### PermissÃµes NecessÃ¡rias
- **Editar perfil**: `users:role:update`
- **Ver permissÃµes**: `users:role:read` (para listar disponÃ­veis)

---

## ğŸ“Š Fluxos

### Fluxo Principal - Editar Perfil Completo

**FP-01: Modificar Nome, DescriÃ§Ã£o e PermissÃµes**

1. Admin acessa `/management/roles/{id}`
2. Sistema valida permissÃ£o `users:role:update`
3. Sistema valida que perfil estÃ¡ no escopo do usuÃ¡rio
4. Sistema valida hierarquia (editor >= perfil)
5. Sistema carrega dados atuais do perfil
6. Admin clica em botÃ£o "âœï¸ Editar"
7. Sistema exibe formulÃ¡rio editÃ¡vel (campos prÃ©-preenchidos):
   ```
   Editar Perfil: Gerente de Documentos

   * Nome: [Gerente de Documentos_______]

   * Hierarquia: [â–¼ 3 - Gerente]
     âš ï¸ 5 usuÃ¡rios serÃ£o afetados

   DescriÃ§Ã£o:
   [ResponsÃ¡vel por gerenciar templates...]

   Escopo:
   (â€¢) Empresa: Acme Corp
   ( ) Global (apenas Super Admin)

   PermissÃµes (8 selecionadas):
   â˜‘ GestÃ£o de Documentos
     â˜‘ documents:template:create
     â˜‘ documents:template:read
     â˜‘ documents:template:update
     â˜‘ documents:template:publish
     â˜ documents:template:delete   [ADICIONAR]
     â˜‘ documents:document:generate
     â˜‘ documents:document:read
     â˜‘ documents:document:download
     â˜ documents:document:delete   [ADICIONAR]

   [23 permissÃµes disponÃ­veis]

   âš ï¸ AlteraÃ§Ãµes afetarÃ£o 5 usuÃ¡rios imediatamente:
   â€¢ JoÃ£o Silva
   â€¢ Maria Santos
   â€¢ Pedro Oliveira
   â€¢ Ana Costa
   â€¢ Carlos Ferreira

   [Cancelar]  [Salvar AlteraÃ§Ãµes]
   ```
8. Admin modifica:
   - Nome: "Gerente de Documentos e Templates"
   - Adiciona 2 permissÃµes: `documents:template:delete`, `documents:document:delete`
   - DescriÃ§Ã£o atualizada
9. Admin clica em "Salvar AlteraÃ§Ãµes"
10. Sistema exibe confirmaÃ§Ã£o (se mudanÃ§as impactantes):
    ```
    âš ï¸ Confirmar AlteraÃ§Ãµes

    VocÃª estÃ¡ prestes a:
    âœ“ Adicionar 2 permissÃµes (template:delete, document:delete)

    Isso afetarÃ¡ 5 usuÃ¡rios imediatamente.

    [Cancelar]  [Confirmar e Salvar]
    ```
11. Admin confirma
12. Sistema valida:
    - Nome Ãºnico (se alterado)
    - Hierarquia vÃ¡lida
    - Pelo menos 1 permissÃ£o selecionada
    - Editor tem hierarquia >= perfil
13. Sistema executa `PUT /api/roles/{id}`
14. Backend:
    - Atualiza registro em `Roles`
    - Calcula diff de permissÃµes (adicionadas/removidas)
    - Remove permissÃµes antigas: `DELETE FROM RolePermissions WHERE RoleId = ?`
    - Insere permissÃµes novas: `INSERT INTO RolePermissions...`
    - **Invalida cache de permissÃµes** de todos os usuÃ¡rios com esse perfil
    - **Invalida tokens JWT** (forÃ§a recÃ¡lculo de permissÃµes)
    - Registra no audit log (before/after)
    - Envia notificaÃ§Ãµes assÃ­ncronas aos usuÃ¡rios afetados
15. Sistema retorna perfil atualizado
16. Sistema exibe toast: "âœ… Perfil atualizado. 5 usuÃ¡rios afetados."
17. Sistema atualiza lista de perfis
18. Sistema envia emails aos usuÃ¡rios (opcional):
    ```
    Assunto: Suas permissÃµes foram atualizadas

    OlÃ¡ JoÃ£o Silva,

    O perfil "Gerente de Documentos" foi atualizado.

    Novas permissÃµes adicionadas:
    â€¢ Excluir templates
    â€¢ Excluir documentos

    Estas alteraÃ§Ãµes jÃ¡ estÃ£o ativas.

    Equipe IControlIT
    ```

**Resultado Esperado**:
- âœ… Perfil atualizado no banco
- âœ… PermissÃµes recalculadas para 5 usuÃ¡rios
- âœ… Tokens JWT invalidados
- âœ… Cache limpo
- âœ… Audit log com diff completo
- âœ… NotificaÃ§Ãµes enviadas

---

### Fluxo Alternativo 1 - Editar Apenas Nome

**FA-01: Renomear Perfil**

1. Admin edita apenas campo "Nome"
2. Sistema valida unicidade
3. Sistema atualiza apenas nome
4. PermissÃµes nÃ£o sÃ£o recalculadas (nÃ£o mudaram)
5. Tokens JWT nÃ£o sÃ£o invalidados

**Performance**: Mais rÃ¡pido (sem recÃ¡lculo de permissÃµes)

---

### Fluxo Alternativo 2 - Adicionar PermissÃµes

**FA-02: Expandir Acesso**

1. Admin adiciona 3 permissÃµes ao perfil
2. Sistema insere novos registros em `RolePermissions`
3. Todos os usuÃ¡rios ganham acesso imediatamente
4. Tokens invalidados (recalcular permissÃµes)

**Impacto**: Positivo (mais acesso)

---

### Fluxo Alternativo 3 - Remover PermissÃµes

**FA-03: Restringir Acesso**

1. Admin remove permissÃ£o `users:user:delete`
2. Sistema exibe aviso crÃ­tico:
   ```
   âš ï¸âš ï¸ ATENÃ‡ÃƒO âš ï¸âš ï¸

   Remover "users:user:delete" farÃ¡ com que 5 usuÃ¡rios
   PERCAM a capacidade de excluir usuÃ¡rios.

   Tem certeza?

   [Cancelar]  [Sim, Remover PermissÃ£o]
   ```
3. Admin confirma
4. Sistema remove permissÃ£o
5. UsuÃ¡rios perdem acesso imediatamente
6. BotÃ£o "Excluir" desaparece da UI para eles

**Impacto**: CrÃ­tico (perda de acesso)

---

### Fluxo Alternativo 4 - Mudar Hierarquia

**FA-04: Rebaixar ou Promover Perfil**

1. Admin muda hierarquia de 3 para 4
2. Sistema valida que editor tem h >= 4
3. Sistema exibe aviso:
   ```
   Alterar hierarquia afetarÃ¡ validaÃ§Ãµes de autorizaÃ§Ã£o.

   UsuÃ¡rios com este perfil (h=4) nÃ£o poderÃ£o mais
   gerenciar usuÃ¡rios de h=5 que antes podiam.
   ```
4. Impactos recalculados
5. Hierarquia atualizada

**RestriÃ§Ã£o**: NÃ£o pode elevar perfil acima da prÃ³pria hierarquia

---

### Fluxo Alternativo 5 - Converter para Global

**FA-05: Tornar Perfil Multi-Empresa (Super Admin Only)**

1. Super Admin edita perfil especÃ­fico de Empresa A
2. Muda escopo para "Global"
3. Sistema seta `empresaId = NULL`
4. Perfil agora disponÃ­vel em todas as empresas
5. UsuÃ¡rios da Empresa A mantÃªm o perfil
6. Admins de outras empresas podem atribuir

**RestriÃ§Ã£o**: Apenas Super Admin pode fazer isso

---

### Fluxo Alternativo 6 - Converter para EspecÃ­fico

**FA-06: Tornar Perfil Global em EspecÃ­fico**

1. Super Admin converte perfil global para Empresa A
2. Sistema valida: Nenhum usuÃ¡rio de outras empresas tem esse perfil
3. Sistema seta `empresaId = empresa-a-guid`
4. Perfil agora especÃ­fico da Empresa A

**ValidaÃ§Ã£o CrÃ­tica**: Se usuÃ¡rios de outras empresas tiverem o perfil â†’ Erro

---

### Fluxos de ExceÃ§Ã£o

**FE-01: Nome Duplicado**
- **CondiÃ§Ã£o**: Novo nome jÃ¡ existe
- **AÃ§Ã£o**:
  - Status: 400 Bad Request
  - Erro: "JÃ¡ existe um perfil com este nome"
  - Campo fica vermelho

---

**FE-02: PermissÃ£o Negada - Hierarquia**
- **CondiÃ§Ã£o**: Admin (h=2) tenta editar Super Admin (h=1)
- **ValidaÃ§Ã£o**: `editorHierarquia >= perfilHierarquia`
- **AÃ§Ã£o**:
  - Status: 403 Forbidden
  - Erro: "VocÃª nÃ£o pode editar perfis de hierarquia superior"
  - BotÃ£o "Editar" nÃ£o aparece no frontend

---

**FE-03: Remover Todas as PermissÃµes**
- **CondiÃ§Ã£o**: UsuÃ¡rio desmarca todas as permissÃµes
- **AÃ§Ã£o**:
  - Status: 400 Bad Request
  - Erro: "Perfil deve ter pelo menos 1 permissÃ£o"
  - Checkbox de Ãºltima permissÃ£o nÃ£o pode ser desmarcado

---

**FE-04: Elevar Hierarquia Acima da PrÃ³pria**
- **CondiÃ§Ã£o**: Admin (h=2) tenta mudar perfil para h=1
- **AÃ§Ã£o**:
  - Status: 403 Forbidden
  - Erro: "VocÃª nÃ£o pode elevar perfis acima da sua hierarquia"
  - Dropdown mostra apenas h >= 2

---

**FE-05: Converter Global com UsuÃ¡rios de MÃºltiplas Empresas**
- **CondiÃ§Ã£o**: Perfil global tem usuÃ¡rios de 3 empresas, tentando tornar especÃ­fico da Empresa A
- **ValidaÃ§Ã£o**: `SELECT DISTINCT EmpresaId FROM Usuarios WHERE Perfis CONTAINS ?`
- **AÃ§Ã£o**:
  - Status: 400 Bad Request
  - Erro: "Perfil estÃ¡ sendo usado por 15 usuÃ¡rios de 3 empresas diferentes"
  - SoluÃ§Ã£o: "Remova o perfil desses usuÃ¡rios primeiro"

---

**FE-06: Editar Perfil de Outra Empresa**
- **CondiÃ§Ã£o**: Admin Empresa A tenta editar perfil da Empresa B
- **AÃ§Ã£o**:
  - Status: 403 Forbidden ou 404 Not Found
  - Mensagem: "Perfil nÃ£o encontrado"

---

**FE-07: ConcorrÃªncia - EdiÃ§Ã£o SimultÃ¢nea**
- **CondiÃ§Ã£o**: Admin A e Admin B editam mesmo perfil
- **DetecÃ§Ã£o**: `rowVersion` ou `dataUltimaAtualizacao`
- **AÃ§Ã£o**:
  - Status: 409 Conflict
  - Erro: "Este perfil foi modificado por outro usuÃ¡rio"
  - OpÃ§Ã£o: "Recarregar" ou "Sobrescrever"

---

**FE-08: Perfil com UsuÃ¡rios Ativos**
- **CondiÃ§Ã£o**: Tentar remover permissÃµes crÃ­ticas de perfil com 100 usuÃ¡rios
- **AÃ§Ã£o**: ConfirmaÃ§Ã£o extra:
  ```
  âš ï¸âš ï¸ IMPACTO MASSIVO âš ï¸âš ï¸

  Esta alteraÃ§Ã£o afetarÃ¡ 100 usuÃ¡rios!

  Digite "CONFIRMAR" para prosseguir:
  [____________]
  ```

---

**FE-09: Perfil Sistema (Reservado)**
- **CondiÃ§Ã£o**: Tentar editar "Super Administrador" ou "Admin" (se reservados)
- **AÃ§Ã£o**:
  - Status: 400 Bad Request
  - Erro: "Perfis do sistema nÃ£o podem ser editados"
  - OU permitir (nÃ£o hÃ¡ problema tÃ©cnico)

---

**FE-10: Escopo Global - Admin Comum**
- **CondiÃ§Ã£o**: Admin (nÃ£o Super) tenta tornar perfil global
- **AÃ§Ã£o**:
  - Status: 403 Forbidden
  - Erro: "Apenas Super Administradores podem criar perfis globais"
  - Radio button desabilitado

---

## ğŸ§ª CenÃ¡rios de Teste (90 Total)

### Categoria 1: ValidaÃ§Ã£o de Campos (20 cenÃ¡rios)

#### CT-001: Editar Nome - Caminho Feliz
**PrÃ©-condiÃ§Ãµes**: Admin logado, perfil "Gerente" existe

**AÃ§Ã£o**:
```http
PUT /api/roles/role-guid
Authorization: Bearer {token}

{
  "nome": "Gerente de OperaÃ§Ãµes",
  "hierarquia": 3,
  "descricao": "...",
  "empresaId": "...",
  "permissoes": [...]
}
```

**Resultado Esperado**:
- âœ… Status: **200 OK**
- âœ… Banco: `UPDATE Roles SET Nome = 'Gerente de OperaÃ§Ãµes', DataUltimaAtualizacao = NOW()`
- âœ… Audit log:
  ```json
  {
    "action": "UPDATE",
    "changes": {
      "nome": { "old": "Gerente", "new": "Gerente de OperaÃ§Ãµes" }
    }
  }
  ```

---

#### CT-002: Nome Duplicado
**AÃ§Ã£o**: Renomear para nome jÃ¡ existente

**Resultado Esperado**:
- âœ… Status: **400 Bad Request**
- âœ… Erro: "JÃ¡ existe um perfil com este nome"

---

#### CT-003: Nome Vazio
**AÃ§Ã£o**: `{ "nome": "" }`

**Resultado Esperado**:
- âœ… Status: 400 Bad Request
- âœ… Erro: "Nome Ã© obrigatÃ³rio"

---

#### CT-004: Editar Apenas DescriÃ§Ã£o
**AÃ§Ã£o**: Alterar apenas campo `descricao`

**Resultado Esperado**:
- âœ… Status: 200 OK
- âœ… PermissÃµes nÃ£o recalculadas (performance)
- âœ… Tokens nÃ£o invalidados

---

#### CT-005: DescriÃ§Ã£o Muito Longa
**AÃ§Ã£o**: `{ "descricao": "A" * 501 }`

**Resultado Esperado**:
- âœ… Status: 400 Bad Request
- âœ… Erro: "DescriÃ§Ã£o deve ter no mÃ¡ximo 500 caracteres"

---

#### CT-006: Adicionar 1 PermissÃ£o
**AÃ§Ã£o**: Perfil tinha 8 permissÃµes, agora tem 9

**Resultado Esperado**:
- âœ… Status: 200 OK
- âœ… `INSERT INTO RolePermissions` (1 registro)
- âœ… Cache invalidado para usuÃ¡rios com esse perfil
- âœ… Tokens JWT invalidados

---

#### CT-007: Remover 1 PermissÃ£o
**AÃ§Ã£o**: Perfil tinha 8, agora tem 7

**Resultado Esperado**:
- âœ… Status: 200 OK
- âœ… `DELETE FROM RolePermissions WHERE RoleId = ? AND PermissionId = ?`
- âœ… UsuÃ¡rios perdem acesso imediatamente

---

#### CT-008: Substituir Todas as PermissÃµes
**AÃ§Ã£o**: Perfil tinha 8 permissÃµes de documentos, agora tem 4 de usuÃ¡rios

**Resultado Esperado**:
- âœ… `DELETE FROM RolePermissions WHERE RoleId = ?`
- âœ… `INSERT INTO RolePermissions` (4 novos)
- âœ… Impacto crÃ­tico: UsuÃ¡rios perdem acesso a documentos, ganham acesso a usuÃ¡rios

---

#### CT-009: Remover Todas as PermissÃµes (NEGADO)
**AÃ§Ã£o**: `{ "permissoes": [] }`

**Resultado Esperado**:
- âœ… Status: **400 Bad Request**
- âœ… Erro: "Perfil deve ter pelo menos 1 permissÃ£o"

---

#### CT-010: PermissÃµes IdÃªnticas (Sem MudanÃ§a)
**AÃ§Ã£o**: Enviar mesmas permissÃµes que jÃ¡ existem

**Resultado Esperado**:
- âœ… Status: 200 OK
- âœ… Nenhum `DELETE` ou `INSERT` em `RolePermissions`
- âœ… Performance otimizada

---

#### CT-011: Hierarquia - Manter
**AÃ§Ã£o**: `{ "hierarquia": 3 }` (jÃ¡ Ã© 3)

**Resultado Esperado**:
- âœ… Status: 200 OK
- âœ… Sem mudanÃ§as na hierarquia

---

#### CT-012: Hierarquia - Rebaixar
**AÃ§Ã£o**: h=3 â†’ h=4

**Resultado Esperado**:
- âœ… Status: 200 OK
- âœ… ValidaÃ§Ãµes de autorizaÃ§Ã£o afetadas
- âœ… UsuÃ¡rios com este perfil perdem capacidade de gerenciar h=5

---

#### CT-013: Hierarquia - Promover
**AÃ§Ã£o**: h=4 â†’ h=3 (Admin h=2 faz isso)

**Resultado Esperado**:
- âœ… Status: 200 OK
- âœ… Permitido (editor h=2 >= nova h=3)

---

#### CT-014: Hierarquia - Elevar Acima da PrÃ³pria (NEGADO)
**AÃ§Ã£o**: Admin (h=2) tenta h=3 â†’ h=1

**Resultado Esperado**:
- âœ… Status: **403 Forbidden**
- âœ… Erro: "VocÃª nÃ£o pode elevar perfis acima da sua hierarquia"

---

#### CT-015: Hierarquia Fora do Range
**AÃ§Ã£o**: `{ "hierarquia": 0 }` ou `{ "hierarquia": 11 }`

**Resultado Esperado**:
- âœ… Status: 400 Bad Request
- âœ… Erro: "Hierarquia deve estar entre 1 e 10"

---

#### CT-016: Escopo - Manter EspecÃ­fico
**AÃ§Ã£o**: `{ "empresaId": "empresa-guid" }` (jÃ¡ Ã© essa empresa)

**Resultado Esperado**:
- âœ… Status: 200 OK
- âœ… Sem mudanÃ§as

---

#### CT-017: Escopo - Tornar Global (Super Admin)
**AÃ§Ã£o**: Super Admin: `{ "empresaId": null }`

**Resultado Esperado**:
- âœ… Status: 200 OK
- âœ… Perfil agora disponÃ­vel em todas as empresas

---

#### CT-018: Escopo - Tornar Global (Admin Comum) - NEGADO
**AÃ§Ã£o**: Admin comum: `{ "empresaId": null }`

**Resultado Esperado**:
- âœ… Status: **403 Forbidden**
- âœ… Erro: "Apenas Super Administradores podem criar perfis globais"

---

#### CT-019: Escopo - Tornar EspecÃ­fico (com UsuÃ¡rios em Outras Empresas)
**AÃ§Ã£o**: Perfil global â†’ especÃ­fico, mas hÃ¡ usuÃ¡rios em 3 empresas

**ValidaÃ§Ã£o**:
```sql
SELECT COUNT(DISTINCT u.EmpresaId) FROM Usuarios u
JOIN UsuarioRoles ur ON u.Id = ur.UsuarioId
WHERE ur.RoleId = ?
-- Se > 1, erro
```

**Resultado Esperado**:
- âœ… Status: **400 Bad Request**
- âœ… Erro: "Perfil estÃ¡ sendo usado por usuÃ¡rios de 3 empresas"

---

#### CT-020: Escopo - Tornar EspecÃ­fico (sem Conflitos)
**AÃ§Ã£o**: Perfil global, mas apenas usuÃ¡rios da Empresa A o tÃªm

**Resultado Esperado**:
- âœ… Status: 200 OK
- âœ… `empresaId` atualizado
- âœ… Perfil agora especÃ­fico

---

### Categoria 2: Impacto em UsuÃ¡rios (20 cenÃ¡rios)

#### CT-021: Editar Perfil com 1 UsuÃ¡rio
**Resultado Esperado**:
- âœ… 1 usuÃ¡rio afetado
- âœ… Token invalidado
- âœ… Cache limpo
- âœ… PrÃ³ximo request recalcula permissÃµes

---

#### CT-022: Editar Perfil com 100 UsuÃ¡rios
**Resultado Esperado**:
- âœ… 100 usuÃ¡rios afetados
- âœ… ConfirmaÃ§Ã£o extra no frontend: "Impacto massivo!"
- âœ… Batch invalidation de tokens
- âœ… Performance: < 5 segundos

---

#### CT-023: Adicionar PermissÃ£o - UsuÃ¡rio Ganha Acesso
**CenÃ¡rio**: Adicionar `users:user:delete` ao perfil

**Resultado Esperado**:
- âœ… PrÃ³ximo request do usuÃ¡rio: novo token com permissÃ£o extra
- âœ… BotÃ£o "Excluir" aparece na UI

---

#### CT-024: Remover PermissÃ£o - UsuÃ¡rio Perde Acesso
**CenÃ¡rio**: Remover `users:user:delete`

**Resultado Esperado**:
- âœ… Tokens invalidados imediatamente
- âœ… PrÃ³ximo request: 403 Forbidden ao tentar deletar
- âœ… BotÃ£o "Excluir" desaparece

---

#### CT-025: UsuÃ¡rio Online Durante EdiÃ§Ã£o
**CenÃ¡rio**: JoÃ£o estÃ¡ logado e usando sistema, Admin edita perfil dele

**Resultado Esperado**:
- âœ… Token de JoÃ£o invalidado
- âœ… PrÃ³ximo request de JoÃ£o: 401 Unauthorized (token invÃ¡lido)
- âœ… Frontend forÃ§a re-login ou refresh token
- âœ… JoÃ£o recebe novo token com permissÃµes atualizadas

---

#### CT-026: MÃºltiplos Perfis - UsuÃ¡rio MantÃ©m PermissÃ£o
**CenÃ¡rio**: JoÃ£o tem perfis "Gerente" e "Auditor". Admin remove permissÃ£o `audit:logs:read` de "Gerente"

**Resultado Esperado**:
- âœ… JoÃ£o ainda tem `audit:logs:read` (vem de "Auditor")
- âœ… UniÃ£o de permissÃµes mantida

---

#### CT-027: MÃºltiplos Perfis - UsuÃ¡rio Perde PermissÃ£o
**CenÃ¡rio**: JoÃ£o tem apenas "Gerente". Admin remove `audit:logs:read`

**Resultado Esperado**:
- âœ… JoÃ£o perde acesso completamente
- âœ… Nenhum outro perfil fornece essa permissÃ£o

---

#### CT-028: UsuÃ¡rio com Perfil Exclusivo
**CenÃ¡rio**: JoÃ£o Ã© o Ãºnico com perfil "Gerente Especial"

**Resultado Esperado**:
- âœ… Aviso no frontend: "Apenas 1 usuÃ¡rio possui este perfil"
- âœ… AlteraÃ§Ãµes afetam apenas JoÃ£o

---

#### CT-029: NotificaÃ§Ãµes por Email
**Resultado Esperado** (Opcional):
- âœ… Email assÃ­ncrono para cada usuÃ¡rio afetado
- âœ… Enfileirado (RabbitMQ/Hangfire)
- âœ… NÃ£o bloqueia response do PUT

---

#### CT-030: Perfil Sem UsuÃ¡rios
**CenÃ¡rio**: Perfil recÃ©m-criado, ainda nÃ£o atribuÃ­do

**Resultado Esperado**:
- âœ… Status: 200 OK
- âœ… Nenhum usuÃ¡rio afetado
- âœ… Sem invalidaÃ§Ã£o de tokens

---

#### CT-031: InvalidaÃ§Ã£o de Cache - Redis
**Resultado Esperado**:
```redis
DEL cache:user:{userId1}:permissions
DEL cache:user:{userId2}:permissions
...
DEL cache:role:{roleId}
```
- âœ… Cache limpo para todos os usuÃ¡rios com esse perfil
- âœ… PrÃ³xima requisiÃ§Ã£o busca do banco

---

#### CT-032: InvalidaÃ§Ã£o de Tokens - Blacklist
**Resultado Esperado**:
```redis
SADD blacklist:role:{roleId} {userId1} {userId2} ...
EXPIRE blacklist:role:{roleId} 86400  # 24h
```
- âœ… Tokens de usuÃ¡rios com esse perfil adicionados ao blacklist
- âœ… Middleware valida blacklist em cada request

---

#### CT-033: Webhook - Sistema Externo
**Resultado Esperado** (Opcional):
```http
POST https://external-system.com/webhook
{
  "event": "role.updated",
  "roleId": "...",
  "affectedUsers": 5,
  "changes": ["permissions"]
}
```

---

#### CT-034: Auditoria - Lista de UsuÃ¡rios Afetados
**Resultado Esperado**:
```json
{
  "action": "UPDATE",
  "entityType": "Role",
  "entityId": "role-guid",
  "affectedUsers": [
    "user-guid-1",
    "user-guid-2",
    ...
  ],
  "affectedUsersCount": 5
}
```

---

#### CT-035: Hierarquia - Impacto em ValidaÃ§Ãµes
**CenÃ¡rio**: Rebaixar perfil h=3 â†’ h=4

**Resultado Esperado**:
- âœ… UsuÃ¡rios com esse perfil nÃ£o podem mais gerenciar h=5
- âœ… ValidaÃ§Ã£o: `editorHierarquia < targetHierarquia` falha

---

#### CT-036: PermissÃµes Calculadas - Performance
**CenÃ¡rio**: UsuÃ¡rio com 3 perfis, 1 Ã© editado

**Resultado Esperado**:
- âœ… RecÃ¡lculo de permissÃµes: UniÃ£o de 3 perfis
- âœ… Query otimizada:
  ```sql
  SELECT DISTINCT p.* FROM Permissions p
  JOIN RolePermissions rp ON p.Id = rp.PermissionId
  JOIN UsuarioRoles ur ON rp.RoleId = ur.RoleId
  WHERE ur.UsuarioId = ?
  ```

---

#### CT-037: ReversÃ£o Manual (Desfazer)
**Funcionalidade**: Admin percebe erro e quer reverter

**Resultado Esperado**:
- âœ… BotÃ£o "Desfazer" (10 segundos)
- âœ… OU usar audit log para restaurar versÃ£o anterior
- âœ… Endpoint: `POST /api/roles/{id}/restore/{auditId}`

---

#### CT-038: ComparaÃ§Ã£o Before/After
**Frontend**: Modal mostrando diff

**Resultado Esperado**:
```
PermissÃµes Adicionadas (2):
+ documents:template:delete
+ documents:document:delete

PermissÃµes Removidas (0):
(nenhuma)

UsuÃ¡rios Afetados: 5
```

---

#### CT-039: Teste com UsuÃ¡rio Real
**CenÃ¡rio**: Admin edita perfil, depois testa com usuÃ¡rio afetado

**Resultado Esperado**:
- âœ… Login como JoÃ£o
- âœ… Verificar permissÃµes efetivas
- âœ… Confirmar botÃµes aparecem/desaparecem conforme esperado

---

#### CT-040: Performance - InvalidaÃ§Ã£o em Lote
**CenÃ¡rio**: 100 usuÃ¡rios afetados

**Resultado Esperado**:
- âœ… Batch invalidation (nÃ£o 100 operaÃ§Ãµes individuais)
- âœ… SQL: `DELETE FROM UserTokens WHERE UserId IN (...)`
- âœ… Redis: `DEL` com pipeline
- âœ… Performance: < 2 segundos

---

### Categoria 3: SeguranÃ§a e PermissÃµes (20 cenÃ¡rios)

#### CT-041: Sem PermissÃ£o - Editar
**PrÃ©-condiÃ§Ãµes**: UsuÃ¡rio SEM `users:role:update`

**AÃ§Ã£o**: `PUT /api/roles/{id}`

**Resultado Esperado**:
- âœ… Status: **403 Forbidden**
- âœ… BotÃ£o "Editar" nÃ£o aparece no frontend

---

#### CT-042: Hierarquia - Admin Edita Gerente
**CenÃ¡rio**: Admin (h=2) edita perfil Gerente (h=3)

**Resultado Esperado**:
- âœ… Status: 200 OK
- âœ… Permitido

---

#### CT-043: Hierarquia - Gerente Tenta Editar Admin
**CenÃ¡rio**: Gerente (h=3) tenta editar Admin (h=2)

**Resultado Esperado**:
- âœ… Status: **403 Forbidden**
- âœ… Erro: "VocÃª nÃ£o pode editar perfis de hierarquia superior"

---

#### CT-044: IDOR - Editar Perfil de Outra Empresa
**CenÃ¡rio**: Admin Empresa A tenta editar perfil da Empresa B

**Resultado Esperado**:
- âœ… Status: **404 Not Found** (obscuridade)
- âœ… Mensagem: "Perfil nÃ£o encontrado"

---

#### CT-045: Token Expirado
**AÃ§Ã£o**: Request com JWT expirado

**Resultado Esperado**:
- âœ… Status: **401 Unauthorized**
- âœ… Frontend redireciona para login

---

#### CT-046: SQL Injection no Nome
**AÃ§Ã£o**: `{ "nome": "'; DROP TABLE Roles; --" }`

**Resultado Esperado**:
- âœ… Query parametrizada
- âœ… Nome armazenado literalmente
- âœ… Banco intacto

---

#### CT-047: XSS no Nome
**AÃ§Ã£o**: `{ "nome": "<script>alert('XSS')</script>" }`

**Resultado Esperado**:
- âœ… Backend aceita
- âœ… Frontend escapa HTML
- âœ… Script NÃƒO executa

---

#### CT-048: Rate Limiting
**AÃ§Ã£o**: 50 PUT requests em 1 minuto

**Resultado Esperado**:
- âœ… ApÃ³s 20 requests: Status **429 Too Many Requests**

---

#### CT-049: CSRF Protection
**AÃ§Ã£o**: Request sem token CSRF

**Resultado Esperado**:
- âœ… Status: 403 Forbidden

---

#### CT-050: Audit Log Completo
**Resultado Esperado**:
```json
{
  "action": "UPDATE",
  "entityType": "Role",
  "entityId": "role-guid",
  "performedBy": "admin-guid",
  "timestamp": "2025-10-20T15:30:00Z",
  "changes": {
    "nome": { "old": "Gerente", "new": "Gerente de OperaÃ§Ãµes" },
    "permissoes": {
      "added": ["documents:template:delete"],
      "removed": []
    }
  },
  "affectedUsers": 5
}
```

---

#### CT-051: Super Admin Edita Super Admin
**CenÃ¡rio**: Super Admin A edita perfil "Super Administrador"

**Resultado Esperado**:
- âœ… Status: 200 OK
- âœ… Permitido (mesma hierarquia)
- âœ… âš ï¸ Cuidado: Pode impactar a si mesmo!

---

#### CT-052: Editar PrÃ³prio Perfil (Indireto)
**CenÃ¡rio**: Admin tem perfil "Admin", edita esse perfil

**Resultado Esperado**:
- âœ… Permitido (sem restriÃ§Ã£o tÃ©cnica)
- âœ… Aviso: "VocÃª possui este perfil e serÃ¡ afetado"
- âœ… PrÃ³prio token invalidado

---

#### CT-053: Ãšltimo Super Admin - Remover PermissÃµes
**CenÃ¡rio**: Ãšnico perfil h=1, tentar remover todas as permissÃµes

**Resultado Esperado** (Opcional):
- âœ… Status: 400 Bad Request
- âœ… Erro: "Sistema deve ter pelo menos 1 Super Admin com permissÃµes totais"

---

#### CT-054: Mass Assignment Vulnerability
**AÃ§Ã£o**:
```json
{
  "nome": "Gerente",
  "id": "custom-id",  // Tentando mudar ID
  "dataCriacao": "2000-01-01"
}
```

**Resultado Esperado**:
- âœ… Backend ignora campos nÃ£o-editÃ¡veis (whitelist)
- âœ… `id` e `dataCriacao` nÃ£o mudam

---

#### CT-055: PermissÃ£o Inexistente
**AÃ§Ã£o**: `{ "permissoes": ["invalid:permission"] }`

**Resultado Esperado**:
- âœ… Status: 400 Bad Request
- âœ… Erro: "PermissÃ£o 'invalid:permission' nÃ£o existe"

---

#### CT-056: Validar PermissÃµes Antes de Salvar
**ValidaÃ§Ã£o SQL**:
```sql
SELECT COUNT(*) FROM Permissions WHERE Id IN (...)
-- Deve retornar count = permissoes.length
```

**Resultado Esperado**:
- âœ… Se count diferente: Erro antes de salvar

---

#### CT-057: Perfil Sistema Protegido (Opcional)
**CenÃ¡rio**: Tentar editar perfil "Super Administrador" (se reservado)

**Resultado Esperado** (Opcional):
- âœ… Status: 400 Bad Request
- âœ… Erro: "Perfis do sistema nÃ£o podem ser editados"

---

#### CT-058: HistÃ³rico de AlteraÃ§Ãµes
**AÃ§Ã£o**: Editar perfil pela 5Âª vez

**Resultado Esperado**:
- âœ… 5 registros de auditoria
- âœ… Diff de cada alteraÃ§Ã£o preservado
- âœ… PossÃ­vel reverter para qualquer versÃ£o

---

#### CT-059: Comparar VersÃµes
**Funcionalidade**: Ver diferenÃ§a entre versÃ£o atual e anterior

**Resultado Esperado**:
```
VersÃ£o 5 (atual) vs VersÃ£o 4

AlteraÃ§Ãµes:
â€¢ Nome: "Gerente" â†’ "Gerente de OperaÃ§Ãµes"
â€¢ PermissÃµes: +1 (documents:template:delete)
â€¢ UsuÃ¡rios afetados: 5
```

---

#### CT-060: Super Admin Bypass (Cuidado)
**CenÃ¡rio**: Super Admin edita qualquer perfil sem restriÃ§Ãµes

**Resultado Esperado**:
- âœ… Sem validaÃ§Ã£o de hierarquia
- âœ… Pode editar atÃ© h=1
- âœ… Pode tornar global/especÃ­fico livremente

---

### Categoria 4: ConcorrÃªncia (15 cenÃ¡rios)

#### CT-061: EdiÃ§Ã£o SimultÃ¢nea - Mesmo Campo
**CenÃ¡rio**: Admin A e Admin B editam nome do mesmo perfil

**ImplementaÃ§Ã£o**: `rowVersion` ou `timestamp`

**Resultado Esperado**:
- âœ… Admin A: 200 OK
- âœ… Admin B: **409 Conflict**
  - Erro: "Perfil foi modificado por outro usuÃ¡rio"
  - OpÃ§Ã£o: "Recarregar" ou "Sobrescrever"

---

#### CT-062: EdiÃ§Ã£o SimultÃ¢nea - Campos Diferentes
**CenÃ¡rio**: Admin A edita nome, Admin B edita descriÃ§Ã£o

**EstratÃ©gia**: Merge automÃ¡tico (opcional) ou sempre conflict

**Resultado Esperado**:
- âœ… Merge: Ambas as alteraÃ§Ãµes aplicadas
- âœ… OU sempre conflict (mais seguro)

---

#### CT-063: Adicionar e Remover PermissÃµes Simultaneamente
**CenÃ¡rio**: Admin A adiciona permissÃ£o X, Admin B remove permissÃ£o Y

**Resultado Esperado**:
- âœ… Conflict (nÃ£o fazer merge automÃ¡tico de permissÃµes)
- âœ… Ãšltimo a salvar sobrescreve tudo

---

#### CT-064: Atribuir Perfil Durante EdiÃ§Ã£o
**CenÃ¡rio**: Admin A edita perfil, Admin B atribui a novo usuÃ¡rio

**Resultado Esperado**:
- âœ… Ambas operaÃ§Ãµes permitidas
- âœ… Novo usuÃ¡rio recebe permissÃµes atualizadas (apÃ³s ediÃ§Ã£o)

---

#### CT-065: Deletar Perfil Durante EdiÃ§Ã£o
**CenÃ¡rio**: Admin A edita perfil, Admin B deleta

**Resultado Esperado**:
- âœ… Se delete primeiro: PUT retorna 404
- âœ… Se PUT primeiro: DELETE funciona (perfil editado Ã© deletado)

---

#### CT-066: MÃºltiplos Admins Editando Perfis Diferentes
**CenÃ¡rio**: Admin A edita "Gerente", Admin B edita "Auditor"

**Resultado Esperado**:
- âœ… Sem conflito (perfis diferentes)
- âœ… Ambas operaÃ§Ãµes bem-sucedidas

---

#### CT-067: Transaction Rollback
**CenÃ¡rio**: Erro ao inserir permissÃµes (constraint violation)

**Resultado Esperado**:
- âœ… Transaction rollback
- âœ… Perfil NÃƒO Ã© atualizado
- âœ… Banco consistente

---

#### CT-068: IdempotÃªncia - RequisiÃ§Ãµes Duplicadas
**CenÃ¡rio**: UsuÃ¡rio clica "Salvar" 2 vezes rÃ¡pido

**Resultado Esperado**:
- âœ… Primeira: 200 OK
- âœ… Segunda: 200 OK (mesma resposta) OU 409 Conflict
- âœ… Banco atualizado apenas 1 vez
- âœ… Usar `Idempotency-Key` header

---

#### CT-069: Lock Otimista - RowVersion
**ImplementaÃ§Ã£o**:
```csharp
public class Role
{
    [Timestamp]
    public byte[] RowVersion { get; set; }
}

// No update
try {
    context.SaveChanges();
} catch (DbUpdateConcurrencyException) {
    return Conflict("Perfil foi modificado por outro usuÃ¡rio");
}
```

**Resultado Esperado**:
- âœ… Detecta ediÃ§Ãµes concorrentes
- âœ… Retorna 409 Conflict

---

#### CT-070: Refresh AutomÃ¡tico (Frontend)
**CenÃ¡rio**: Frontend detecta 409 Conflict

**Resultado Esperado**:
- âœ… Modal: "Perfil foi modificado por Admin XYZ"
- âœ… Mostrar diff das alteraÃ§Ãµes externas
- âœ… OpÃ§Ãµes: "Descartar minhas alteraÃ§Ãµes" ou "Sobrescrever"

---

#### CT-071: Queue de InvalidaÃ§Ã£o
**CenÃ¡rio**: 3 admins editam 3 perfis ao mesmo tempo

**Resultado Esperado**:
- âœ… InvalidaÃ§Ãµes enfileiradas (nÃ£o bloqueiam responses)
- âœ… Worker processa em background
- âœ… Performance mantida

---

#### CT-072: Deadlock Prevention
**CenÃ¡rio**: Admin A: UPDATE Role, DELETE RolePermissions
Admin B: UPDATE Role, DELETE RolePermissions

**Resultado Esperado**:
- âœ… Ordem consistente de operaÃ§Ãµes
- âœ… Lock em ordem: Roles â†’ RolePermissions
- âœ… Sem deadlocks

---

#### CT-073: Timeout em Transaction
**CenÃ¡rio**: AtualizaÃ§Ã£o demora > 30 segundos

**Resultado Esperado**:
- âœ… Transaction timeout
- âœ… Rollback automÃ¡tico
- âœ… Erro: "OperaÃ§Ã£o demorou muito"

---

#### CT-074: Race Condition - Ãšltimo UsuÃ¡rio com Perfil
**CenÃ¡rio**: Perfil tem 1 usuÃ¡rio. Admin A remove usuÃ¡rio, Admin B edita perfil

**Resultado Esperado**:
- âœ… Ambas operaÃ§Ãµes permitidas
- âœ… Sem constraint violation

---

#### CT-075: Concurrent Cache Invalidation
**CenÃ¡rio**: 2 admins editam perfis ao mesmo tempo

**Resultado Esperado**:
- âœ… Cache invalidations nÃ£o conflitam
- âœ… Redis operations sÃ£o atÃ´micas
- âœ… Ambas invalidaÃ§Ãµes aplicadas

---

### Categoria 5: Performance e UX (15 cenÃ¡rios)

#### CT-076: Performance - Update Simples
**AÃ§Ã£o**: Apenas nome

**Resultado Esperado**:
- âœ… Response time < 500ms
- âœ… Sem recÃ¡lculo de permissÃµes

---

#### CT-077: Performance - Update com PermissÃµes
**AÃ§Ã£o**: Adicionar 5 permissÃµes

**Resultado Esperado**:
- âœ… Response time < 2 segundos (inclui invalidaÃ§Ã£o de 50 usuÃ¡rios)
- âœ… Bulk operations

---

#### CT-078: Performance - 100 UsuÃ¡rios Afetados
**Resultado Esperado**:
- âœ… Response time < 5 segundos
- âœ… Batch invalidation de tokens
- âœ… NÃ£o bloqueia thread principal

---

#### CT-079: Loading State
**Resultado Esperado**:
- âœ… BotÃ£o "Salvar" â†’ "Salvando..."
- âœ… Spinner
- âœ… BotÃ£o desabilitado

---

#### CT-080: Toast de Sucesso
**Resultado Esperado**:
- âœ… Toast verde: "Perfil atualizado. 5 usuÃ¡rios afetados."
- âœ… AÃ§Ã£o: "Ver usuÃ¡rios"
- âœ… Auto-dismiss em 5 segundos

---

#### CT-081: ConfirmaÃ§Ã£o de Impacto
**CenÃ¡rio**: > 10 usuÃ¡rios afetados

**Resultado Esperado**:
- âœ… Modal extra de confirmaÃ§Ã£o
- âœ… Lista de usuÃ¡rios afetados
- âœ… Checkbox: "Entendo que isso afetarÃ¡ 50 usuÃ¡rios"

---

#### CT-082: Preview de AlteraÃ§Ãµes
**Resultado Esperado**:
- âœ… BotÃ£o "Preview" antes de salvar
- âœ… Modal mostrando diff
- âœ… "8 permissÃµes atuais â†’ 10 permissÃµes novas"

---

#### CT-083: ValidaÃ§Ã£o em Tempo Real
**AÃ§Ã£o**: Digitar nome no campo

**Resultado Esperado**:
- âœ… ValidaÃ§Ã£o de unicidade com debounce (500ms)
- âœ… âœ— "Nome jÃ¡ existe" (vermelho)
- âœ… âœ“ "Nome disponÃ­vel" (verde)

---

#### CT-084: Contador de PermissÃµes
**Resultado Esperado**:
- âœ… "8 de 23 permissÃµes selecionadas"
- âœ… Barra de progresso visual

---

#### CT-085: Acessibilidade - FormulÃ¡rio
**Resultado Esperado**:
- âœ… NavegaÃ§Ã£o por teclado
- âœ… Checkboxes acessÃ­veis
- âœ… Screen reader anuncia mudanÃ§as
- âœ… Focus visÃ­vel

---

#### CT-086: Mobile - FormulÃ¡rio Responsivo
**Resultado Esperado**:
- âœ… PermissÃµes em lista vertical
- âœ… BotÃµes grandes (touch-friendly)
- âœ… Modal de confirmaÃ§Ã£o full-screen

---

#### CT-087: Dirty Form Warning
**CenÃ¡rio**: Admin preenche formulÃ¡rio e tenta sair

**Resultado Esperado**:
- âœ… Modal: "Deseja descartar alteraÃ§Ãµes?"
- âœ… [Cancelar] [Descartar]

---

#### CT-088: Undo/Desfazer (10 segundos)
**Resultado Esperado**:
- âœ… Toast com botÃ£o "Desfazer"
- âœ… Se clicar: Restaura versÃ£o anterior
- âœ… Se nÃ£o clicar em 10s: AlteraÃ§Ã£o confirmada

---

#### CT-089: Database Indexes
**ValidaÃ§Ã£o**: Query plan

**Resultado Esperado**:
- âœ… Ãndice em `Roles.Nome` (unicidade)
- âœ… Ãndice em `RolePermissions(RoleId, PermissionId)`
- âœ… UPDATE usa Ã­ndice de primary key

---

#### CT-090: Memory Leak Test
**Teste**: Executar 1000 updates

**Resultado Esperado**:
- âœ… MemÃ³ria estabiliza
- âœ… GC libera objetos
- âœ… Heap size constante

---

## ğŸ”’ Matriz de PermissÃµes

| Perfil | Editar PrÃ³prio Perfil | Editar Subordinados | Editar Mesma Hierarquia | Editar Qualquer |
|--------|--------------------|---------------------|------------------------|----------------|
| **Super Admin** | âš ï¸ Sim (cuidado) | âœ… | âœ… | âœ… |
| **Admin** | âš ï¸ Sim (cuidado) | âœ… h >= 2 | âœ… | âŒ |
| **Gerente** | âŒ | âœ… h >= 3 | âŒ | âŒ |

---

## ğŸ“ˆ CritÃ©rios de AceitaÃ§Ã£o

### Backend
- [ ] Endpoint `PUT /api/roles/{id}` com validaÃ§Ã£o completa
- [ ] ValidaÃ§Ã£o de hierarquia (nÃ£o pode editar superior)
- [ ] ValidaÃ§Ã£o de unicidade de nome (se alterado)
- [ ] RecÃ¡lculo de permissÃµes para usuÃ¡rios afetados
- [ ] InvalidaÃ§Ã£o de tokens JWT (todos os usuÃ¡rios com esse perfil)
- [ ] InvalidaÃ§Ã£o de cache (Redis)
- [ ] Optimistic locking (rowVersion)
- [ ] Audit log com diff completo (before/after)
- [ ] Transaction atÃ´mica
- [ ] Response time < 2s (mesmo com 100 usuÃ¡rios afetados)

### Frontend
- [ ] FormulÃ¡rio com validaÃ§Ã£o em tempo real
- [ ] Preview de alteraÃ§Ãµes (diff)
- [ ] ConfirmaÃ§Ã£o de impacto (se > 10 usuÃ¡rios)
- [ ] Lista de usuÃ¡rios afetados
- [ ] ValidaÃ§Ã£o de unicidade de nome (debounce 500ms)
- [ ] Loading state durante save
- [ ] Toast de sucesso com contador de usuÃ¡rios afetados
- [ ] Tratamento de 409 Conflict (refresh automÃ¡tico)
- [ ] Dirty form warning
- [ ] Acessibilidade (WCAG 2.1 AA)

---

## ğŸ§© DependÃªncias

### Backend
- `RolesController.Update(id, request)` âœ… Implementado
- `AuthorizationService.ValidateHierarchy()` âœ… Implementado
- `PermissionCalculator.RecalculateForUsers()` âš ï¸ Verificar
- `TokenRevocationService.InvalidateByRole()` âš ï¸ Implementar
- `CacheService.InvalidateByRole()` âš ï¸ Implementar
- `AuditLogService.LogUpdate()` âœ… Implementado

### Frontend
- `RolesDetailsComponent` âœ… Implementado
- `RolesService.updateRole()` âœ… Implementado
- `ConfirmationDialogComponent` âœ… Implementado
- `DiffViewerComponent` âš ï¸ Criar

---

## ğŸ“ Notas de ImplementaÃ§Ã£o

### Optimistic Locking
```csharp
[Timestamp]
public byte[] RowVersion { get; set; }

try {
    await _context.SaveChangesAsync();
} catch (DbUpdateConcurrencyException) {
    return Conflict(new {
        error = "Perfil foi modificado por outro usuÃ¡rio",
        currentData = await GetCurrentRole(id)
    });
}
```

### InvalidaÃ§Ã£o de Tokens por Perfil
```csharp
public async Task InvalidateTokensByRole(Guid roleId)
{
    var userIds = await _context.UsuarioRoles
        .Where(ur => ur.RoleId == roleId)
        .Select(ur => ur.UsuarioId)
        .ToListAsync();

    foreach (var userId in userIds)
    {
        await _redis.SetAsync($"blacklist:user:{userId}", "revoked", TimeSpan.FromDays(1));
    }
}
```

### Diff de PermissÃµes
```csharp
var permissoesAntigas = await GetCurrentPermissions(roleId);
var permissoesNovas = request.Permissoes;

var adicionadas = permissoesNovas.Except(permissoesAntigas).ToList();
var removidas = permissoesAntigas.Except(permissoesNovas).ToList();

// Audit log
await _auditLog.LogUpdate(roleId, new {
    permissoes = new {
        added = adicionadas,
        removed = removidas
    }
});
```

---

## âœ… Checklist de Completude

- [x] Todos os fluxos documentados (6 alternativos, 10 exceÃ§Ã£o)
- [x] 90 cenÃ¡rios de teste criados
- [x] ValidaÃ§Ã£o de hierarquia
- [x] Impacto em usuÃ¡rios (20 cenÃ¡rios)
- [x] ConcorrÃªncia e optimistic locking (15 cenÃ¡rios)
- [x] Performance e UX (15 cenÃ¡rios)
- [x] SeguranÃ§a completa (20 cenÃ¡rios)
- [x] Matriz de permissÃµes
- [x] CritÃ©rios de aceitaÃ§Ã£o

---

**Status Final**: âœ… **UC07 100% ESPECIFICADO**

**Complexidade**: ğŸ”´ CrÃ­tica (impacta mÃºltiplos usuÃ¡rios, concorrÃªncia, invalidaÃ§Ã£o massiva)

**PrÃ³ximos Passos**:
1. Implementar optimistic locking
2. Implementar invalidaÃ§Ã£o de tokens por perfil
3. Criar componente de diff/preview
4. Testes de concorrÃªncia (2 admins editando)
5. Teste de impacto (editar perfil com 100 usuÃ¡rios)
6. Executar todos os 90 cenÃ¡rios de teste

**Ãšltima AtualizaÃ§Ã£o**: 2025-10-20
**Revisado por**: Anderson Chipak + Claude Code

---

# UC04 - Excluir Perfil de Acesso
## ğŸ“‹ Objetivo
Permitir que administradores removam perfis (incluindo Perfis de Sistema) atravÃ©s de soft delete, validando que o perfil nÃ£o possui usuÃ¡rios ativos vinculados.

## ğŸ‘¤ Atores
- Ator Principal: Administrador com permissÃ£o perfis:perfil:delete
- Atores SecundÃ¡rios: Sistema de Auditoria, Sistema de Cache

## ğŸ¯ PrÃ©-condiÃ§Ãµes
- â˜’ UsuÃ¡rio autenticado no sistema
- â˜’ UsuÃ¡rio possui permissÃ£o perfis:perfil:delete (Developer, Super Administrador ou Administrador)
- â˜’ Perfil existe no sistema
- â˜’ Perfil nÃ£o possui usuÃ¡rios ativos vinculados (Ãºnica restriÃ§Ã£o, aplica-se tambÃ©m a Perfis de Sistema)

## â–¶ï¸ Fluxo Principal
- UsuÃ¡rio acessa detalhes do perfil e clica em "Excluir"
- Sistema valida que nÃ£o hÃ¡ usuÃ¡rios vinculados (ativos ou inativos):
  - Query: SELECT COUNT(*) FROM UsuarioRole WHERE RoleId = @id
  - **Nota**: Esta Ã© a ÃšNICA validaÃ§Ã£o. Perfis de Sistema PODEM ser excluÃ­dos se nÃ£o tiverem usuÃ¡rios.
- Sistema exibe modal de confirmaÃ§Ã£o:
  - "Tem certeza que deseja excluir este perfil?"
  - Se for Perfil de Sistema (IsSystemRole = true): "ATENÃ‡ÃƒO: Este Ã© um Perfil de Sistema!"
  - "AÃ§Ã£o nÃ£o pode ser desfeita (soft delete)."
  - BotÃµes: "Cancelar" | "Confirmar ExclusÃ£o"
- UsuÃ¡rio clica "Confirmar ExclusÃ£o"
- Sistema marca perfil como deletado:
  - Atualiza Deletado = true (soft delete)
  - Atualiza DataDelecao = GETDATE()
- Sistema invalida cache Redis
- Sistema registra auditoria (inclui informaÃ§Ã£o se era Perfil de Sistema)
- Resultado: Perfil excluÃ­do com sucesso

## ğŸ”€ Fluxos Alternativos
### FA01 - Cancelar ExclusÃ£o
UsuÃ¡rio clica â€œCancelarâ€ no modal de confirmaÃ§Ã£o e retorna aos detalhes do perfil.
### FA02 - ForÃ§ar RemoÃ§Ã£o de UsuÃ¡rios Primeiro
Se houver usuÃ¡rios ativos, sistema exibe opÃ§Ã£o: â€œRemover {n} usuÃ¡rios deste perfil antes?â€

## âš ï¸ Fluxos de ExceÃ§Ã£o
### FE01 - UsuÃ¡rios Vinculados (ÃšNICA RESTRIÃ‡ÃƒO)
- **CondiÃ§Ã£o**: Sistema detecta COUNT > 0 (usuÃ¡rios ativos ou inativos vinculados)
- **AÃ§Ã£o**: Erro 400 Bad Request
- **Mensagem**: "NÃ£o Ã© possÃ­vel excluir este perfil pois existem {n} usuÃ¡rio(s) vinculado(s) a ele. Remova os usuÃ¡rios deste perfil antes de excluÃ­-lo."
- **Nota**: Esta regra se aplica TAMBÃ‰M a Perfis de Sistema. Ã‰ a ÃšNICA validaÃ§Ã£o que impede exclusÃ£o.

### FE02 - Perfis Filhos Existem
Se houver perfis filhos, sistema exibe aviso mas permite exclusÃ£o (filhos se tornam Ã³rfÃ£os).

### FE03 - Sem PermissÃ£o
Sistema retorna erro 403 Forbidden se usuÃ¡rio nÃ£o tem perfis:perfil:delete.

## âœ… PÃ³s-condiÃ§Ãµes
- âœ… Perfil marcado como deletado (soft delete)
- âœ… Data de exclusÃ£o registrada
- âœ… Auditoria completa registrada
- âœ… Perfil ocultado das listagens (exceto modo admin)
- âœ… Cache Redis invalidado

## ğŸ“ Regras de NegÃ³cio

## ğŸ§ª CenÃ¡rios de Teste
- CEN401 - Excluir perfil sem usuÃ¡rios (sucesso)
- CEN402 - Tentar excluir perfil com usuÃ¡rios vinculados (HTTP 400)
- CEN403 - **NOVO**: Excluir Perfil de Sistema sem usuÃ¡rios (sucesso - validar modal com aviso)
- CEN404 - **NOVO**: Tentar excluir Perfil de Sistema com usuÃ¡rios (HTTP 400 - mesma regra)
- CEN405 - Cancelar exclusÃ£o no modal
- CEN406 - Excluir perfil com filhos (filhos ficam Ã³rfÃ£os)
- CEN407 - Tentar excluir sem permissÃ£o (HTTP 403)
- CEN408 - Excluir perfil expirado
- CEN409 - Verificar auditoria apÃ³s exclusÃ£o (incluindo flag IsSystemRole)
- CEN410 - Verificar que perfil nÃ£o aparece mais na listagem
- CEN411 - Tentar acessar perfil deletado (HTTP 404)
Total: 11 cenÃ¡rios | Status: Atualizado (2025-11-16)

## ğŸ“Š Rastreabilidade

Ãšltima AtualizaÃ§Ã£o: 2025-11-16 - Perfis de Sistema agora PODEM ser excluÃ­dos (Ãºnica restriÃ§Ã£o: usuÃ¡rios vinculados)

---

# UC07 - Duplicar Perfil de Acesso

**Data AtualizaÃ§Ã£o**: 2025-11-15
**Changelog v2.0**: Simplificado - removidas referÃªncias a cÃ³digo, hierarquia, limite de usuÃ¡rios e heranÃ§a

---

## ğŸ“‹ Objetivo
Permitir que administradores criem uma cÃ³pia simples de um perfil existente, incluindo todas as suas permissÃµes, com a opÃ§Ã£o de modificar nome e descriÃ§Ã£o.

## ğŸ‘¤ Atores
- Ator Principal: Administrador com permissÃ£o `perfis:perfil:create` e `perfis:perfil:read`
- Atores SecundÃ¡rios: Sistema de ValidaÃ§Ã£o, Sistema de Auditoria

## ğŸ¯ PrÃ©-condiÃ§Ãµes
- â˜’ UsuÃ¡rio autenticado no sistema
- â˜’ UsuÃ¡rio possui permissÃµes `perfis:perfil:create` e `perfis:perfil:read`
- â˜’ Perfil a ser duplicado existe
- â˜’ Banco de dados acessÃ­vel

## â–¶ï¸ Fluxo Principal
1. UsuÃ¡rio acessa detalhes de um perfil e clica em "Duplicar"
2. Sistema carrega modal "Duplicar Perfil":
   - Nome original: "Gestor TI" â†’ Novo: "Gestor TI - CÃ³pia" (auto-preenchido)
   - DescriÃ§Ã£o: cÃ³pia da original (editÃ¡vel)
3. UsuÃ¡rio modifica nome e descriÃ§Ã£o (opcional)
4. Sistema valida:
   - Nome Ãºnico para a empresa
   - Nome nÃ£o estÃ¡ vazio
5. UsuÃ¡rio clica "Criar CÃ³pia"
6. Sistema cria novo perfil com:
   - Dados modificados (nome/descriÃ§Ã£o)
   - Todas as permissÃµes do perfil original (cÃ³pias independentes)
   - Mesma empresa (EmpresaId)
7. Sistema registra auditoria: "Duplicado do perfil [ORIGINAL_ID]"
8. Resultado: Perfil duplicado com sucesso

## ğŸ”€ Fluxos Alternativos
### FA01 - Manter Nome Original
UsuÃ¡rio altera apenas descriÃ§Ã£o, mantendo nome sugerido.

### FA02 - Resetar SugestÃ£o
UsuÃ¡rio clica "Reset" para usar sugestÃ£o automÃ¡tica novamente.

## âš ï¸ Fluxos de ExceÃ§Ã£o
### FE01 - Nome Duplicado
Sistema exibe: "Nome jÃ¡ existe para esta empresa. Use outro nome."

### FE02 - Nome Vazio
Sistema exibe: "Nome Ã© obrigatÃ³rio."

### FE03 - Perfil Original NÃ£o AcessÃ­vel
Se perfil foi deletado, sistema exibe erro 404: "Perfil nÃ£o encontrado."

## âœ… PÃ³s-condiÃ§Ãµes
- âœ… Novo perfil criado com dados do original
- âœ… Todas as permissÃµes copiadas (registros independentes)
- âœ… Auditoria registrada com referÃªncia ao original
- âœ… Novo perfil disponÃ­vel imediatamente para uso

## ğŸ“ Regras de NegÃ³cio
### RN-UC07-001: Nome Ãšnico
Nome do perfil duplicado deve ser Ãºnico dentro da empresa.

### RN-UC07-002: PermissÃµes Independentes
PermissÃµes do perfil duplicado sÃ£o cÃ³pias independentes. AlteraÃ§Ãµes em um perfil nÃ£o afetam o outro.

### RN-UC07-003: Mesmo Escopo
Perfil duplicado Ã© criado no mesmo escopo (empresa) do perfil original. Apenas Super Admin pode duplicar perfis globais.

## ğŸ§ª CenÃ¡rios de Teste
- CEN701 - Duplicar perfil simples
- CEN702 - Duplicar com modificaÃ§Ã£o de nome
- CEN703 - Duplicar com modificaÃ§Ã£o de descriÃ§Ã£o
- CEN704 - Duplicar com mÃºltiplas permissÃµes
- CEN705 - Tentar duplicar com nome jÃ¡ existente (HTTP 400)
- CEN706 - Duplicar perfil com descriÃ§Ã£o vazia
- CEN707 - Verificar que permissÃµes foram copiadas corretamente
- CEN708 - Verificar auditoria com referÃªncia ao original
- CEN709 - Tentar duplicar sem permissÃ£o `perfis:perfil:create` (HTTP 403)
- CEN710 - Duplicar perfil de outra empresa (bloqueado por multi-tenancy)

Total: 10 cenÃ¡rios | Status: Documentado

## ğŸ“Š Rastreabilidade
- - **DependÃªncias**: UC01 (Criar Perfil), UC02 (Visualizar Perfil)

---

Ãšltima AtualizaÃ§Ã£o: 2025-11-15

---

## HistÃ³rico de AlteraÃ§Ãµes

| VersÃ£o | Data | Autor | DescriÃ§Ã£o |
|--------|------|-------|-----------|
| 1.0 | 2025-12-17 | Sistema | ConsolidaÃ§Ã£o de 5 casos de uso |
