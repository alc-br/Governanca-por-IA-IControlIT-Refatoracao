# =============================================
# UC-RF013 - Casos de Uso: Gestão de Perfis de Acesso (RBAC)
# Versão: 2.0
# Data: 2025-12-31
# Autor: Agência ALC - alc.dev.br
# =============================================

uc:
  rf: "RF013"
  versao: "2.0"
  data: "2025-12-31"
  descricao: "Gestão de Perfis de Acesso (RBAC)"
  cobertura_rn: "10/10"
  cobertura_percentual: "100%"

casos_de_uso:

  - id: "UC00"
    nome: "Listar Perfis de Acesso"
    ator_principal: "Administrador"
    tipo: "leitura"

    covers:
      rf_items:
        - "RN-RF013-01"
        - "RN-RF013-10"
      uc_items:
        - id: "UC00-FP-01"
          title: "Listar perfis com paginação (20 registros)"
          required: true
        - id: "UC00-FA-01"
          title: "Buscar por nome"
          required: true
        - id: "UC00-FA-02"
          title: "Filtrar por tipo (Sistema/Personalizado)"
          required: true
        - id: "UC00-FA-03"
          title: "Filtrar por status (Ativo/Inativo)"
          required: true
        - id: "UC00-FA-04"
          title: "Ordenar por coluna"
          required: false
        - id: "UC00-FE-01"
          title: "Usuário sem permissão perfis:perfil:view_any"
          required: true
        - id: "UC00-FE-02"
          title: "Nenhum perfil encontrado"
          required: true
        - id: "UC00-FE-03"
          title: "Erro de conexão com banco"
          required: true

    precondicoes:
      - permissao: "perfis:perfil:view_any"
      - contexto: "Tenant_Id válido"

    gatilho: "Usuário acessa menu Perfis de Acesso"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessa_menu_perfis"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao_perfis_perfil_view_any"
      - passo: 3
        ator: "sistema"
        acao: "carregar_perfis_WHERE_EmpresaId_OR_NULL"
      - passo: 4
        ator: "sistema"
        acao: "aplicar_paginacao_20_registros"
      - passo: 5
        ator: "sistema"
        acao: "ordenar_Nome_ASC"
      - passo: 6
        ator: "sistema"
        acao: "exibir_lista"

    fluxos_alternativos:
      - id: "FA-UC00-01"
        condicao: "usuario_busca_nome"
        resultado: "filtro_LIKE_aplicado"
      - id: "FA-UC00-02"
        condicao: "usuario_filtra_tipo"
        resultado: "WHERE_IsSystemRole_aplicado"
      - id: "FA-UC00-03"
        condicao: "usuario_filtra_status"
        resultado: "WHERE_Fl_Ativo_aplicado"

    fluxos_excecao:
      - id: "FE-UC00-01"
        condicao: "sem_permissao"
        resultado: "HTTP_403_Forbidden"
      - id: "FE-UC00-02"
        condicao: "nenhum_perfil"
        resultado: "estado_vazio_exibido"
      - id: "FE-UC00-03"
        condicao: "erro_conexao"
        resultado: "mensagem_generica_e_log_tecnico"

    regras_aplicadas:
      - "RN-RF013-01"
      - "RN-RF013-10"
      - "RN-UC00-001"
      - "RN-UC00-002"
      - "RN-UC00-003"

    resultado_final:
      estado: "lista_perfis_exibida"

  - id: "UC01"
    nome: "Criar Perfil de Acesso"
    ator_principal: "Super Admin, Administrador"
    tipo: "crud"
    impacta_dados: true

    covers:
      rf_items:
        - "RN-RF013-01"
        - "RN-RF013-02"
        - "RN-RF013-04"
        - "RN-RF013-09"
      uc_items:
        - id: "UC01-FP-01"
          title: "Criar perfil com permissões"
          required: true
        - id: "UC01-FA-01"
          title: "Salvar e criar outro"
          required: false
        - id: "UC01-FA-02"
          title: "Cancelar criação"
          required: false
        - id: "UC01-FE-01"
          title: "Nome duplicado no tenant"
          required: true
        - id: "UC01-FE-02"
          title: "Permissão com formato inválido"
          required: true
        - id: "UC01-FE-03"
          title: "Nome vazio ou maior que 100 caracteres"
          required: true
        - id: "UC01-FE-04"
          title: "Descrição maior que 500 caracteres"
          required: true

    precondicoes:
      - permissao: "perfis:perfil:create"
      - contexto: "Tenant_Id válido"

    gatilho: "Usuário clica Novo Perfil"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "clica_novo_perfil"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao_perfis_perfil_create"
      - passo: 3
        ator: "sistema"
        acao: "exibir_formulario"
      - passo: 4
        ator: "usuario"
        acao: "preencher_dados_selecionar_permissoes"
      - passo: 5
        ator: "usuario"
        acao: "clicar_salvar"
      - passo: 6
        ator: "sistema"
        acao: "validar_dados_RN_RF013_01_RN_RF013_04"
      - passo: 7
        ator: "sistema"
        acao: "INSERT_Role"
      - passo: 8
        ator: "sistema"
        acao: "INSERT_RolePermission"
      - passo: 9
        ator: "sistema"
        acao: "registrar_auditoria_Created_CreatedBy"
      - passo: 10
        ator: "sistema"
        acao: "exibir_mensagem_sucesso"
      - passo: 11
        ator: "sistema"
        acao: "redirecionar_listagem"

    fluxos_alternativos:
      - id: "FA-UC01-01"
        condicao: "usuario_salva_criar_outro"
        resultado: "mantém_formulario_aberto"
      - id: "FA-UC01-02"
        condicao: "usuario_cancela"
        resultado: "retorna_listagem"

    fluxos_excecao:
      - id: "FE-UC01-01"
        condicao: "nome_duplicado_tenant"
        resultado: "HTTP_400_mensagem_especifica"
      - id: "FE-UC01-02"
        condicao: "permissao_formato_invalido"
        resultado: "HTTP_400_formato_modulo_recurso_acao"
      - id: "FE-UC01-03"
        condicao: "nome_invalido"
        resultado: "HTTP_400"
      - id: "FE-UC01-04"
        condicao: "descricao_invalida"
        resultado: "HTTP_400"

    regras_aplicadas:
      - "RN-RF013-01"
      - "RN-RF013-02"
      - "RN-RF013-04"
      - "RN-RF013-09"
      - "RN-UC01-001"
      - "RN-UC01-002"
      - "RN-UC01-003"

    resultado_final:
      estado: "perfil_criado"

  - id: "UC02"
    nome: "Visualizar Perfil de Acesso"
    ator_principal: "Administrador"
    tipo: "leitura"

    covers:
      rf_items:
        - "RN-RF013-03"
        - "RN-RF013-10"
      uc_items:
        - id: "UC02-FP-01"
          title: "Visualizar perfil com 3 painéis (Geral, Permissões, Usuários)"
          required: true
        - id: "UC02-FA-01"
          title: "Editar perfil (redireciona UC03)"
          required: false
        - id: "UC02-FA-02"
          title: "Ver histórico de auditoria (RF-004)"
          required: false
        - id: "UC02-FE-01"
          title: "Perfil não encontrado"
          required: true
        - id: "UC02-FE-02"
          title: "Perfil de outro tenant"
          required: true
        - id: "UC02-FE-03"
          title: "Erro ao carregar permissões"
          required: true

    precondicoes:
      - permissao: "perfis:perfil:view"
      - contexto: "Tenant_Id válido, Perfil existe"

    gatilho: "Usuário clica Visualizar em perfil"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "seleciona_perfil_UC00"
      - passo: 2
        ator: "usuario"
        acao: "clica_visualizar"
      - passo: 3
        ator: "sistema"
        acao: "validar_permissao_perfis_perfil_view"
      - passo: 4
        ator: "sistema"
        acao: "validar_isolamento_tenant"
      - passo: 5
        ator: "sistema"
        acao: "carregar_dados_perfil"
      - passo: 6
        ator: "sistema"
        acao: "JOIN_RolePermission_Permission"
      - passo: 7
        ator: "sistema"
        acao: "COUNT_UsuarioRoles"
      - passo: 8
        ator: "sistema"
        acao: "exibir_3_paineis"

    fluxos_alternativos:
      - id: "FA-UC02-01"
        condicao: "usuario_editar_perfil"
        resultado: "redireciona_UC03"
      - id: "FA-UC02-02"
        condicao: "usuario_ver_auditoria"
        resultado: "redireciona_RF004"

    fluxos_excecao:
      - id: "FE-UC02-01"
        condicao: "perfil_nao_encontrado"
        resultado: "HTTP_404"
      - id: "FE-UC02-02"
        condicao: "perfil_outro_tenant"
        resultado: "HTTP_404"
      - id: "FE-UC02-03"
        condicao: "erro_carregar_permissoes"
        resultado: "mensagem_generica_log_tecnico"

    regras_aplicadas:
      - "RN-RF013-03"
      - "RN-RF013-10"
      - "RN-UC02-001"
      - "RN-UC02-002"

    resultado_final:
      estado: "perfil_visualizado"

  - id: "UC03"
    nome: "Editar Perfil de Acesso"
    ator_principal: "Super Admin, Administrador"
    tipo: "crud"
    impacta_dados: true

    covers:
      rf_items:
        - "RN-RF013-01"
        - "RN-RF013-02"
        - "RN-RF013-05"
        - "RN-RF013-07"
        - "RN-RF013-09"
      uc_items:
        - id: "UC03-FP-01"
          title: "Editar perfil e permissões"
          required: true
        - id: "UC03-FA-01"
          title: "Cancelar edição"
          required: false
        - id: "UC03-FA-02"
          title: "Adicionar justificativa para permissão crítica"
          required: true
        - id: "UC03-FE-01"
          title: "Nome duplicado"
          required: true
        - id: "UC03-FE-02"
          title: "Tentativa editar nome/descrição perfil sistema"
          required: true
        - id: "UC03-FE-03"
          title: "Permissão crítica sem justificativa"
          required: true
        - id: "UC03-FE-04"
          title: "Perfil de outro tenant"
          required: true

    precondicoes:
      - permissao: "perfis:perfil:update"
      - contexto: "Tenant_Id válido, Perfil existe"

    gatilho: "Usuário clica Editar em perfil"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "seleciona_perfil_UC00"
      - passo: 2
        ator: "usuario"
        acao: "clica_editar"
      - passo: 3
        ator: "sistema"
        acao: "validar_permissao_perfis_perfil_update"
      - passo: 4
        ator: "sistema"
        acao: "validar_se_editavel_RN_RF013_02"
      - passo: 5
        ator: "sistema"
        acao: "carregar_dados_perfil"
      - passo: 6
        ator: "sistema"
        acao: "exibir_formulario_preenchido"
      - passo: 7
        ator: "usuario"
        acao: "alterar_dados_permissoes"
      - passo: 8
        ator: "usuario"
        acao: "clicar_salvar"
      - passo: 9
        ator: "sistema"
        acao: "validar_dados_RN_RF013_01_04_05"
      - passo: 10
        ator: "sistema"
        acao: "UPDATE_Role"
      - passo: 11
        ator: "sistema"
        acao: "DELETE_INSERT_RolePermission"
      - passo: 12
        ator: "sistema"
        acao: "registrar_auditoria_LastModified_LastModifiedBy"
      - passo: 13
        ator: "sistema"
        acao: "invalidar_cache_permissoes_RN_RF013_07"
      - passo: 14
        ator: "sistema"
        acao: "exibir_mensagem_sucesso"

    fluxos_alternativos:
      - id: "FA-UC03-01"
        condicao: "usuario_cancela_edicao"
        resultado: "descarta_alteracoes"
      - id: "FA-UC03-02"
        condicao: "permissao_critica_sendo_atribuida"
        resultado: "exibe_campo_justificativa_obrigatorio"

    fluxos_excecao:
      - id: "FE-UC03-01"
        condicao: "nome_duplicado"
        resultado: "HTTP_400"
      - id: "FE-UC03-02"
        condicao: "tentar_editar_nome_descricao_perfil_sistema"
        resultado: "HTTP_400_mensagem_especifica"
      - id: "FE-UC03-03"
        condicao: "permissao_critica_sem_justificativa"
        resultado: "HTTP_400_justificativa_obrigatoria"
      - id: "FE-UC03-04"
        condicao: "perfil_outro_tenant"
        resultado: "HTTP_404"

    regras_aplicadas:
      - "RN-RF013-01"
      - "RN-RF013-02"
      - "RN-RF013-05"
      - "RN-RF013-07"
      - "RN-RF013-09"
      - "RN-UC03-001"
      - "RN-UC03-002"

    resultado_final:
      estado: "perfil_atualizado"

  - id: "UC04"
    nome: "Excluir Perfil de Acesso"
    ator_principal: "Super Admin, Administrador"
    tipo: "crud"
    impacta_dados: true

    covers:
      rf_items:
        - "RN-RF013-08"
        - "RN-RF013-09"
      uc_items:
        - id: "UC04-FP-01"
          title: "Excluir perfil (soft delete)"
          required: true
        - id: "UC04-FA-01"
          title: "Cancelar exclusão"
          required: false
        - id: "UC04-FE-01"
          title: "Perfil com usuários vinculados"
          required: true
        - id: "UC04-FE-02"
          title: "Perfil já excluído"
          required: true
        - id: "UC04-FE-03"
          title: "Perfil de outro tenant"
          required: true

    precondicoes:
      - permissao: "perfis:perfil:delete"
      - contexto: "Tenant_Id válido, Perfil existe, SEM usuários vinculados"

    gatilho: "Usuário clica Excluir em perfil"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "seleciona_perfil_UC00"
      - passo: 2
        ator: "usuario"
        acao: "clica_excluir"
      - passo: 3
        ator: "sistema"
        acao: "exibir_confirmacao"
      - passo: 4
        ator: "usuario"
        acao: "confirma_exclusao"
      - passo: 5
        ator: "sistema"
        acao: "validar_permissao_perfis_perfil_delete"
      - passo: 6
        ator: "sistema"
        acao: "verificar_usuarios_vinculados_RN_RF013_08"
      - passo: 7
        ator: "sistema"
        acao: "validar_isolamento_tenant"
      - passo: 8
        ator: "sistema"
        acao: "UPDATE_Fl_Ativo_0"
      - passo: 9
        ator: "sistema"
        acao: "registrar_auditoria_LastModified_LastModifiedBy"
      - passo: 10
        ator: "sistema"
        acao: "invalidar_cache"
      - passo: 11
        ator: "sistema"
        acao: "exibir_mensagem_sucesso"
      - passo: 12
        ator: "sistema"
        acao: "remover_perfil_da_listagem"

    fluxos_alternativos:
      - id: "FA-UC04-01"
        condicao: "usuario_cancela"
        resultado: "fecha_modal_sem_alterar"

    fluxos_excecao:
      - id: "FE-UC04-01"
        condicao: "perfil_com_usuarios_vinculados"
        resultado: "HTTP_400_mensagem_com_contagem"
      - id: "FE-UC04-02"
        condicao: "perfil_ja_excluido"
        resultado: "HTTP_404"
      - id: "FE-UC04-03"
        condicao: "perfil_outro_tenant"
        resultado: "HTTP_404"

    regras_aplicadas:
      - "RN-RF013-08"
      - "RN-RF013-09"
      - "RN-RF013-10"
      - "RN-UC04-001"
      - "RN-UC04-002"

    resultado_final:
      estado: "perfil_excluido_logicamente"

  - id: "UC05"
    nome: "Gerenciar Permissões do Perfil"
    ator_principal: "Super Admin, Administrador"
    tipo: "acao"
    impacta_dados: true

    covers:
      rf_items:
        - "RN-RF013-04"
        - "RN-RF013-05"
        - "RN-RF013-06"
        - "RN-RF013-07"
      uc_items:
        - id: "UC05-FP-01"
          title: "Atribuir e remover permissões"
          required: true
        - id: "UC05-FA-01"
          title: "Selecionar todas do módulo"
          required: false
        - id: "UC05-FA-02"
          title: "Buscar permissão"
          required: false
        - id: "UC05-FA-03"
          title: "Ver descrição da permissão (tooltip)"
          required: false
        - id: "UC05-FE-01"
          title: "Permissão crítica sem justificativa"
          required: true
        - id: "UC05-FE-02"
          title: "Formato de permissão inválido"
          required: true
        - id: "UC05-FE-03"
          title: "Erro ao invalidar cache"
          required: false

    precondicoes:
      - permissao: "perfis:permissao:assign OU perfis:permissao:revoke"
      - contexto: "Tenant_Id válido, Perfil existe"

    gatilho: "Usuário acessa edição de perfil (UC03)"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessa_edicao_perfil_UC03"
      - passo: 2
        ator: "usuario"
        acao: "visualiza_painel_permissoes_disponiveis"
      - passo: 3
        ator: "sistema"
        acao: "exibir_permissoes_agrupadas_por_modulo"
      - passo: 4
        ator: "usuario"
        acao: "selecionar_desmarcar_permissoes_checkboxes"
      - passo: 5
        ator: "sistema"
        acao: "validar_formato_RN_RF013_04"
      - passo: 6
        ator: "sistema"
        acao: "identificar_permissoes_criticas_RN_RF013_05"
      - passo: 7
        ator: "sistema"
        acao: "SE_critica_exibir_campo_justificativa"
      - passo: 8
        ator: "usuario"
        acao: "clicar_salvar_permissoes"
      - passo: 9
        ator: "sistema"
        acao: "validar_permissoes_selecionadas"
      - passo: 10
        ator: "sistema"
        acao: "DELETE_INSERT_RolePermission"
      - passo: 11
        ator: "sistema"
        acao: "registrar_auditoria_detalhada"
      - passo: 12
        ator: "sistema"
        acao: "invalidar_cache_RN_RF013_07"
      - passo: 13
        ator: "sistema"
        acao: "SE_critica_enviar_notificacao_gestor"
      - passo: 14
        ator: "sistema"
        acao: "exibir_mensagem_sucesso"

    fluxos_alternativos:
      - id: "FA-UC05-01"
        condicao: "usuario_seleciona_todas_modulo"
        resultado: "checkbox_master_por_modulo"
      - id: "FA-UC05-02"
        condicao: "usuario_busca_permissao"
        resultado: "filtro_por_nome_codigo"
      - id: "FA-UC05-03"
        condicao: "usuario_ver_descricao"
        resultado: "tooltip_com_descricao_detalhada"

    fluxos_excecao:
      - id: "FE-UC05-01"
        condicao: "permissao_critica_sem_justificativa"
        resultado: "HTTP_400_justificativa_obrigatoria"
      - id: "FE-UC05-02"
        condicao: "formato_permissao_invalido"
        resultado: "HTTP_400_formato_modulo_recurso_acao"
      - id: "FE-UC05-03"
        condicao: "erro_invalidar_cache"
        resultado: "log_tecnico_continua_operacao"

    regras_aplicadas:
      - "RN-RF013-04"
      - "RN-RF013-05"
      - "RN-RF013-06"
      - "RN-RF013-07"
      - "RN-UC05-001"
      - "RN-UC05-002"
      - "RN-UC05-003"

    resultado_final:
      estado: "permissoes_atualizadas"

  - id: "UC06"
    nome: "Duplicar Perfil de Acesso"
    ator_principal: "Administrador"
    tipo: "acao"
    impacta_dados: true

    covers:
      rf_items:
        - "RN-RF013-01"
        - "RN-RF013-09"
      uc_items:
        - id: "UC06-FP-01"
          title: "Duplicar perfil com permissões"
          required: true
        - id: "UC06-FA-01"
          title: "Cancelar duplicação"
          required: false
        - id: "UC06-FE-01"
          title: "Nome duplicado"
          required: true
        - id: "UC06-FE-02"
          title: "Perfil origem não encontrado"
          required: true
        - id: "UC06-FE-03"
          title: "Erro ao copiar permissões (rollback)"
          required: true

    precondicoes:
      - permissao: "perfis:perfil:duplicate"
      - contexto: "Tenant_Id válido, Perfil origem existe"

    gatilho: "Usuário clica Duplicar em perfil"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "seleciona_perfil_UC00"
      - passo: 2
        ator: "usuario"
        acao: "clica_duplicar"
      - passo: 3
        ator: "sistema"
        acao: "validar_permissao_perfis_perfil_duplicate"
      - passo: 4
        ator: "sistema"
        acao: "exibir_modal_novo_nome_preenchido"
      - passo: 5
        ator: "usuario"
        acao: "ajustar_nome_clicar_duplicar"
      - passo: 6
        ator: "sistema"
        acao: "validar_nome_unico_RN_RF013_01"
      - passo: 7
        ator: "sistema"
        acao: "INSERT_Role_novo_perfil"
      - passo: 8
        ator: "sistema"
        acao: "INSERT_RolePermission_SELECT_origem"
      - passo: 9
        ator: "sistema"
        acao: "registrar_auditoria"
      - passo: 10
        ator: "sistema"
        acao: "exibir_mensagem_sucesso"
      - passo: 11
        ator: "sistema"
        acao: "redirecionar_edicao_novo_perfil_UC03"

    fluxos_alternativos:
      - id: "FA-UC06-01"
        condicao: "usuario_cancela"
        resultado: "fecha_modal_sem_criar"

    fluxos_excecao:
      - id: "FE-UC06-01"
        condicao: "nome_duplicado"
        resultado: "HTTP_400_mensagem_especifica"
      - id: "FE-UC06-02"
        condicao: "perfil_origem_nao_encontrado"
        resultado: "HTTP_404"
      - id: "FE-UC06-03"
        condicao: "erro_copiar_permissoes"
        resultado: "rollback_mensagem_generica_log_tecnico"

    regras_aplicadas:
      - "RN-RF013-01"
      - "RN-RF013-09"
      - "RN-UC06-001"
      - "RN-UC06-002"
      - "RN-UC06-003"

    resultado_final:
      estado: "perfil_duplicado"

exclusions:
  uc_items: []

rastreabilidade:
  total_rns: 10
  rns_cobertas: 10
  percentual_cobertura: "100%"
  matriz:
    - rn: "RN-RF013-01"
      ucs: ["UC00", "UC01", "UC03", "UC06"]
    - rn: "RN-RF013-02"
      ucs: ["UC01", "UC03"]
    - rn: "RN-RF013-03"
      ucs: ["UC02"]
    - rn: "RN-RF013-04"
      ucs: ["UC01", "UC03", "UC05"]
    - rn: "RN-RF013-05"
      ucs: ["UC03", "UC05"]
    - rn: "RN-RF013-06"
      ucs: ["UC05"]
    - rn: "RN-RF013-07"
      ucs: ["UC03", "UC05"]
    - rn: "RN-RF013-08"
      ucs: ["UC04"]
    - rn: "RN-RF013-09"
      ucs: ["UC01", "UC03", "UC04", "UC06"]
    - rn: "RN-RF013-10"
      ucs: ["UC00", "UC02", "UC04"]

historico:
  - versao: "2.0"
    data: "2025-12-31"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Versão completa com 7 UCs cobrindo 100% das 10 RNs (v2.0 Governance)"
  - versao: "1.0"
    data: "2025-12-17"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Versão inicial (DEPRECIADA)"
