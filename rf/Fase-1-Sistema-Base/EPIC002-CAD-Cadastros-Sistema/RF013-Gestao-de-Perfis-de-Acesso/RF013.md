# RF-013: Gest√£o de Perfis de Acesso (RBAC)

**Vers√£o**: 2.0
**Data**: 2025-12-30
**Autor**: Ag√™ncia ALC - alc.dev.br
**EPIC**: EPIC002-CAD-Cadastros-Sistema
**Fase**: Fase 1 - Sistema Base

---

## 1. OBJETIVO DO REQUISITO

Implementar um sistema completo de **Gest√£o de Perfis de Acesso** baseado em RBAC (Role-Based Access Control) para controlar o que cada usu√°rio pode fazer no sistema IControlIT atrav√©s de perfis (roles) e permiss√µes granulares.

Este RF define **o que o sistema deve fazer** em termos de:
- Cria√ß√£o e gest√£o de perfis de acesso
- Atribui√ß√£o de permiss√µes granulares aos perfis
- Valida√ß√£o de permiss√µes em tempo de execu√ß√£o
- Auditoria completa de altera√ß√µes
- Isolamento multi-tenant

**Conceitos Fundamentais**:
- **Perfil (Role)**: Conjunto de permiss√µes agrupadas logicamente (ex: "Administrador", "Gestor Financeiro", "Operador")
- **Permiss√£o**: A√ß√£o espec√≠fica em um recurso (formato: `modulo:recurso:acao`, ex: `contratos:contrato:create`)

---

## 2. ESCOPO

### 2.1 O que est√° dentro do escopo

- [x] Cria√ß√£o de perfis de acesso (roles)
- [x] Atualiza√ß√£o de perfis existentes
- [x] Listagem de perfis com filtros
- [x] Exclus√£o l√≥gica de perfis
- [x] Valida√ß√µes funcionais e regras de neg√≥cio
- [x] Controle de acesso e isolamento por tenant (multi-tenancy)
- [x] Auditoria autom√°tica de opera√ß√µes
- [x] Gest√£o de permiss√µes granulares (atribuir/remover)
- [x] Cat√°logo centralizado de permiss√µes
- [x] Valida√ß√£o de permiss√µes em runtime (middleware)
- [x] Cache de permiss√µes para performance
- [x] Perfis pr√©-definidos de sistema
- [x] Duplica√ß√£o de perfis existentes
- [x] Visualiza√ß√£o de usu√°rios por perfil
- [x] Interface Angular moderna
- [x] API RESTful com CQRS

### 2.2 Fora do escopo (n√£o objetivos)

- Interface visual espec√≠fica (layout/UX)
- Tecnologia, framework ou linguagem de implementa√ß√£o
- Estrat√©gia de deploy ou infraestrutura
- Heran√ßa de permiss√µes entre perfis
- Permiss√µes tempor√°rias com expira√ß√£o
- Segrega√ß√£o de Fun√ß√µes (SoD - Separation of Duties)
- Limite de usu√°rios por perfil
- Revis√£o peri√≥dica autom√°tica de perfis

---

## 3. CONCEITOS E DEFINI√á√ïES

| Termo | Defini√ß√£o |
|-----|---------|
| Perfil (Role) | Conjunto nomeado de permiss√µes que pode ser atribu√≠do a usu√°rios |
| Permiss√£o | Direito de executar uma a√ß√£o espec√≠fica em um recurso do sistema |
| Tenant | Unidade l√≥gica de isolamento de dados (empresa/Fornecedor) |
| Usu√°rio | Agente autenticado que executa a√ß√µes no sistema |
| Opera√ß√£o | A√ß√£o execut√°vel sobre uma entidade (create, read, update, delete, etc.) |
| RBAC | Role-Based Access Control - modelo de controle de acesso baseado em perfis |
| Perfil de Sistema | Perfil pr√©-definido n√£o edit√°vel (mas delet√°vel se sem usu√°rios vinculados) |
| Super Admin | Perfil com acesso total irrestrito que bypassa todas as valida√ß√µes |
| Permiss√£o Cr√≠tica | Permiss√£o que exige auditoria detalhada e justificativa (ex: approve, delete) |

---

## 4. FUNCIONALIDADES COBERTAS

1. **CRUD de Perfis**
   - Criar novo perfil com nome, descri√ß√£o e permiss√µes
   - Atualizar perfil existente (nome, descri√ß√£o, permiss√µes)
   - Consultar perfil por ID
   - Listar perfis com filtros (nome, status, tipo)
   - Desativar perfil (exclus√£o l√≥gica)
   - Duplicar perfil existente (c√≥pia simples)

2. **Gest√£o de Permiss√µes**
   - Cat√°logo centralizado de permiss√µes dispon√≠veis
   - Atribuir permiss√µes ao perfil
   - Remover permiss√µes do perfil
   - Buscar/filtrar permiss√µes por m√≥dulo, recurso ou a√ß√£o
   - Interface de sele√ß√£o m√∫ltipla de permiss√µes

3. **Valida√ß√£o em Runtime**
   - Middleware valida permiss√µes em toda requisi√ß√£o √† API
   - Cache de permiss√µes (5 minutos) para performance
   - Bypass autom√°tico para Super Admin
   - Logs de tentativas de acesso negado

4. **Auditoria Completa**
   - Hist√≥rico de altera√ß√µes em perfis (cria√ß√£o, edi√ß√£o, desativa√ß√£o)
   - Hist√≥rico de atribui√ß√µes/remo√ß√µes de permiss√µes
   - Rastreamento de quem/quando/por qu√™
   - Auditoria detalhada para permiss√µes cr√≠ticas

5. **Perfis Pr√©-definidos**
   - **Super Administrador**: Acesso total irrestrito (bypassa valida√ß√µes)
   - **Administrador**: Gest√£o completa do sistema
   - **Gestor**: Opera√ß√µes gerenciais e aprova√ß√µes
   - **Operador**: Opera√ß√µes di√°rias
   - **Visualizador**: Somente leitura

6. **Multi-tenancy**
   - Perfis isolados por empresa (tenant)
   - Mesmos nomes permitidos em empresas diferentes
   - Usu√°rio acessa apenas perfis do seu tenant

7. **Interface Angular Moderna**
   - Lista de perfis com filtros, ordena√ß√£o e pagina√ß√£o
   - Formul√°rio de cria√ß√£o/edi√ß√£o responsivo
   - Sele√ß√£o de permiss√µes com checkboxes organizados por m√≥dulo
   - Visualiza√ß√£o de usu√°rios vinculados ao perfil
   - Dashboard com m√©tricas b√°sicas

8. **API RESTful Segura**
   - Endpoints com CQRS (Commands/Queries via MediatR)
   - Autoriza√ß√£o via atributos `[Authorize]` com pol√≠ticas
   - Valida√ß√£o de input (FluentValidation)
   - Respostas padronizadas (Result pattern)

9. **Gest√£o de Usu√°rios por Perfil**
   - Listar usu√°rios com perfil espec√≠fico
   - Visualizar quantos usu√°rios possuem cada perfil
   - Impedir exclus√£o de perfil com usu√°rios vinculados

---

## 5. REGRAS DE NEG√ìCIO

### RN-RF013-01 ‚Äî Nome de Perfil √önico por Tenant

**Descri√ß√£o**: Nome do perfil deve ser √∫nico dentro do tenant (Fornecedor).

**Justificativa**: Evitar confus√£o e garantir que cada perfil seja identific√°vel de forma √∫nica dentro da empresa.

**Crit√©rio de Aceite**:
- Tentativa de criar perfil com nome duplicado no mesmo tenant ‚Üí rejei√ß√£o HTTP 400
- Mesmo nome em tenants diferentes ‚Üí permitido
- Valida√ß√£o case-insensitive (ex: "Administrador" = "administrador")

**Implementa√ß√£o**:
```sql
UNIQUE INDEX UQ_Perfil_Nome_Tenant (Nome, TenantId)
WHERE Fl_Ativo = 1;
```

---

### RN-RF013-02 ‚Äî Perfis de Sistema S√£o N√£o-Edit√°veis

**Descri√ß√£o**: Perfis com `IsSystemRole = true` n√£o podem ter nome ou descri√ß√£o editados, mas permiss√µes podem ser ajustadas.

**Perfis de Sistema**:
- Super Administrador
- Administrador
- Gestor
- Operador
- Visualizador

**Justificativa**: Garantir que perfis fundamentais do sistema mantenham identidade consistente.

**Crit√©rio de Aceite**:
- Tentativa de editar nome/descri√ß√£o de perfil de sistema ‚Üí rejei√ß√£o HTTP 400
- Edi√ß√£o de permiss√µes de perfil de sistema ‚Üí permitido
- Exclus√£o de perfil de sistema sem usu√°rios vinculados ‚Üí permitido

---

### RN-RF013-03 ‚Äî Super Admin Tem Acesso Total

**Descri√ß√£o**: Perfis com `Fl_Super_Admin = true` bypassam todas as verifica√ß√µes de permiss√£o.

**Justificativa**: Garantir que sempre haja um perfil com acesso total para recupera√ß√£o de sistema e manuten√ß√£o cr√≠tica.

**Crit√©rio de Aceite**:
- Super Admin pode executar qualquer opera√ß√£o sem valida√ß√£o de permiss√£o espec√≠fica
- Bypass ocorre antes da valida√ß√£o de permiss√µes no middleware
- Auditoria registra opera√ß√µes de Super Admin normalmente

---

### RN-RF013-04 ‚Äî Formato de Permiss√£o Padronizado

**Descri√ß√£o**: Permiss√µes seguem formato obrigat√≥rio `modulo:recurso:acao`.

**Justificativa**: Padroniza√ß√£o facilita valida√ß√£o, logs e auditoria.

**Exemplos v√°lidos**:
- `usuarios:usuario:create`
- `contratos:contrato:approve`
- `faturas:fatura:import`
- `perfis:perfil:delete`

**Crit√©rio de Aceite**:
- Permiss√£o que n√£o segue formato ‚Üí rejei√ß√£o
- Valida√ß√£o via regex: `^[a-z]+:[a-z]+:(create|read|update|delete|approve|import|export|view|view_any)$`
- A√ß√µes permitidas: create, read, update, delete, approve, import, export, view, view_any

---

### RN-RF013-05 ‚Äî Auditoria de Altera√ß√µes Cr√≠ticas

**Descri√ß√£o**: Altera√ß√µes em permiss√µes cr√≠ticas (`Fl_Critica = true`) exigem auditoria detalhada com justificativa.

**Permiss√µes Cr√≠ticas**:
- `usuarios:usuario:create/update/delete`
- `perfis:perfil:create/update/delete`
- `contratos:contrato:approve`
- `faturas:fatura:import`

**Crit√©rio de Aceite**:
- Atribuir permiss√£o cr√≠tica sem justificativa ‚Üí rejei√ß√£o HTTP 400
- Auditoria deve registrar: usu√°rio, timestamp, permiss√£o, justificativa, IP
- Notifica√ß√£o autom√°tica para gestor quando permiss√£o cr√≠tica √© atribu√≠da

---

### RN-RF013-06 ‚Äî Valida√ß√£o em Tempo de Execu√ß√£o

**Descri√ß√£o**: Middleware valida permiss√µes em TODA requisi√ß√£o √† API (exceto endpoints p√∫blicos).

**Justificativa**: Garantir que permiss√µes sejam sempre verificadas, mesmo se cache estiver desatualizado.

**Crit√©rio de Aceite**:
- Requisi√ß√£o sem token JWT ‚Üí HTTP 401
- Requisi√ß√£o sem permiss√£o necess√°ria ‚Üí HTTP 403
- Super Admin bypassa valida√ß√£o
- Log de tentativas de acesso negado (auditoria)

**Implementa√ß√£o**:
```csharp
[Authorize(Policy = "contratos:contrato:create")]
public async Task<IActionResult> CriarContrato([FromBody] ContratoDto dto) { }
```

---

### RN-RF013-07 ‚Äî Cache de Permiss√µes

**Descri√ß√£o**: Permiss√µes do usu√°rio s√£o cacheadas por 5 minutos para melhorar performance.

**Justificativa**: Reduzir consultas ao banco de dados em requisi√ß√µes frequentes.

**Crit√©rio de Aceite**:
- Cache key: `permissions:{userId}`
- TTL (Time-To-Live): 5 minutos
- Invalida√ß√£o autom√°tica ao alterar perfil ou permiss√µes do usu√°rio
- Invalida√ß√£o manual via endpoint (Admin)

---

### RN-RF013-08 ‚Äî N√£o Pode Deletar Perfil com Usu√°rios Vinculados

**Descri√ß√£o**: Perfil com usu√°rios vinculados (ativos ou inativos) n√£o pode ser deletado.

**Justificativa**: Evitar perda de refer√™ncia de permiss√µes hist√≥ricas e garantir integridade de auditoria.

**Crit√©rio de Aceite**:
- Tentativa de deletar perfil com usu√°rios vinculados ‚Üí HTTP 400 com mensagem clara
- Mensagem deve indicar quantidade de usu√°rios vinculados
- Sugest√£o: "Remova os usu√°rios deste perfil antes de exclu√≠-lo"
- Esta regra se aplica TAMB√âM a Perfis de Sistema

**Valida√ß√£o**:
```csharp
var usuariosVinculados = await _context.UsuarioRoles
    .CountAsync(ur => ur.RoleId == perfilId);
if (usuariosVinculados > 0)
    throw new ValidationException(
        $"N√£o √© poss√≠vel excluir este perfil pois existem {usuariosVinculados} usu√°rio(s) vinculado(s). " +
        "Remova os usu√°rios deste perfil antes de exclu√≠-lo.");
```

---

### RN-RF013-09 ‚Äî Auditoria Autom√°tica de Altera√ß√µes

**Descri√ß√£o**: Todas as entidades devem herdar de `BaseAuditableEntity` para rastreamento autom√°tico de cria√ß√£o e modifica√ß√£o.

**Justificativa**: Conformidade com LGPD, rastreabilidade de opera√ß√µes, troubleshooting e auditoria de compliance.

**Campos Autom√°ticos**:
- `Created` (DateTimeOffset): Data/hora UTC de cria√ß√£o do registro
- `CreatedBy` (string?): ID do usu√°rio que criou o registro
- `LastModified` (DateTimeOffset): Data/hora UTC da √∫ltima modifica√ß√£o
- `LastModifiedBy` (string?): ID do usu√°rio que modificou por √∫ltimo

**Crit√©rio de Aceite**:
- Campos de auditoria preenchidos automaticamente via interceptor EF Core
- Timestamps em UTC
- CreatedBy/LastModifiedBy preenchidos com ID do usu√°rio autenticado
- Valores n√£o podem ser alterados manualmente pelo c√≥digo de aplica√ß√£o

**Implementa√ß√£o**:
```csharp
public abstract class BaseAuditableGuidEntity : BaseGuidEntity
{
    public DateTimeOffset Created { get; set; }
    public string? CreatedBy { get; set; }
    public DateTimeOffset LastModified { get; set; }
    public string? LastModifiedBy { get; set; }
}

public class Role : BaseAuditableGuidEntity
{
    public string Nome { get; set; } = string.Empty;
    public bool Ativo { get; set; } = true;
    // ...
}
```

---

### RN-RF013-10 ‚Äî Uso de Fl_Ativo ao Inv√©s de Fl_Desativado

**Descri√ß√£o**: Utilizar campo `Fl_Ativo` do tipo BIT (0 ou 1) para indicar status do registro.

**Justificativa**:
- Clareza sem√¢ntica: `Fl_Ativo = 1` √© intuitivo (ativo)
- Economia de espa√ßo: BIT (1 byte) vs INT (4 bytes)
- Padr√£o da ind√∫stria: BIT √© o tipo padr√£o para flags booleanas

**Crit√©rio de Aceite**:
- Campo `Fl_Ativo BIT NOT NULL DEFAULT 1`
- 0 = Inativo, 1 = Ativo
- Queries claras: `WHERE Fl_Ativo = 1`
- Soft delete atualiza `Fl_Ativo` para 0

**Implementa√ß√£o**:
```sql
Fl_Ativo BIT NOT NULL DEFAULT 1;
```

---

## 6. ESTADOS DA ENTIDADE

| Estado | Descri√ß√£o | Valor Fl_Ativo |
|------|-----------|----------------|
| Ativo | Perfil em uso normal | 1 |
| Inativo | Perfil desativado (soft delete) | 0 |

### Transi√ß√µes permitidas

| De | Para | Condi√ß√£o |
|---|---|---------|
| Ativo | Inativo | Sem usu√°rios vinculados OU desativa√ß√£o for√ßada (move usu√°rios) |
| Inativo | Ativo | Usu√°rio com permiss√£o adequada |

**Nota**: N√£o h√° estado intermedi√°rio. Perfil est√° ativo ou inativo.

---

## 7. EVENTOS DE DOM√çNIO

| Evento | Quando ocorre | A√ß√µes Autom√°ticas |
|------|--------------|-------------------|
| perfil.criado | Ap√≥s cria√ß√£o de perfil | Auditoria, Notifica√ß√£o (se cr√≠tico) |
| perfil.atualizado | Ap√≥s atualiza√ß√£o de perfil | Auditoria, Invalida√ß√£o de cache |
| perfil.desativado | Ap√≥s desativa√ß√£o (soft delete) | Auditoria, Invalida√ß√£o de cache |
| perfil.permissao_atribuida | Ap√≥s atribuir permiss√£o | Auditoria, Invalida√ß√£o de cache, Notifica√ß√£o (se cr√≠tica) |
| perfil.permissao_removida | Ap√≥s remover permiss√£o | Auditoria, Invalida√ß√£o de cache |

---

## 8. CRIT√âRIOS GLOBAIS DE ACEITE

- ‚úÖ Nenhuma opera√ß√£o pode violar isolamento de tenant
- ‚úÖ Nenhuma regra de neg√≥cio pode ser ignorada
- ‚úÖ Erros devem ser previs√≠veis, estruturados e rastre√°veis
- ‚úÖ Auditoria deve registrar quem, quando e o que mudou
- ‚úÖ Cache deve ser invalidado ao alterar permiss√µes
- ‚úÖ Super Admin sempre tem acesso total
- ‚úÖ Permiss√µes cr√≠ticas exigem justificativa
- ‚úÖ Perfis de sistema n√£o s√£o edit√°veis (nome/descri√ß√£o)
- ‚úÖ Perfil com usu√°rios vinculados n√£o pode ser deletado
- ‚úÖ Formato de permiss√£o sempre `modulo:recurso:acao`

---

## 9. SEGURAN√áA

### Valida√ß√µes Obrigat√≥rias
1. ‚úÖ JWT Bearer Token v√°lido em todas as requisi√ß√µes
2. ‚úÖ Usu√°rio autenticado com perfil ativo
3. ‚úÖ Permiss√£o espec√≠fica para cada opera√ß√£o
4. ‚úÖ N√£o permitir atribuir permiss√µes maiores que as pr√≥prias (exceto Super Admin)
5. ‚úÖ Justificativa obrigat√≥ria para permiss√µes cr√≠ticas
6. ‚úÖ Confirmar senha ao editar perfis de sistema (opcional, recomendado)

### Prote√ß√µes Implementadas
- **Rate limiting**: 10 req/min por usu√°rio em endpoints de gest√£o de perfis
- **Log de acesso negado**: Toda tentativa de acesso sem permiss√£o √© logada
- **Bloqueio de escala√ß√£o**: Ap√≥s 5 tentativas de escala√ß√£o de privil√©gios, usu√°rio √© bloqueado temporariamente
- **2FA obrigat√≥rio**: Super Admin deve ter autentica√ß√£o de dois fatores habilitada

### Prote√ß√£o contra ataques
- ‚úÖ Valida√ß√£o de entrada obrigat√≥ria (FluentValidation)
- ‚úÖ Prote√ß√£o contra inje√ß√£o SQL (EF Core parametrizado)
- ‚úÖ CORS configurado corretamente
- ‚úÖ Headers de seguran√ßa (X-Frame-Options, X-Content-Type-Options, etc.)

---

## 10. ARTEFATOS DERIVADOS

Este RF √© base para:

| Artefato | Status | Descri√ß√£o |
|---------|--------|-----------|
| **UC-RF013.md** | Obrigat√≥rio | Casos de Uso detalhados (UC00-UC04) |
| **MD-RF013.yaml** | Obrigat√≥rio | Modelo de Dados (tabelas, √≠ndices, relacionamentos) |
| **MT-RF013.yaml** | Obrigat√≥rio | Massas de Teste (cen√°rios de dados) |
| **TC-RF013-BACKEND.md** | Obrigat√≥rio | Casos de Teste Backend (API, valida√ß√µes) |
| **TC-RF013-FRONTEND.md** | Obrigat√≥rio | Casos de Teste Frontend (UI, fluxos) |
| **TC-RF013-SEGURANCA.md** | Obrigat√≥rio | Casos de Teste de Seguran√ßa (RBAC, injection) |
| **TC-RF013-E2E.md** | Obrigat√≥rio | Casos de Teste E2E (Playwright) |

---

## 11. RASTREABILIDADE

### Integra√ß√µes com outros RFs

| RF Relacionado | Tipo de Integra√ß√£o | Descri√ß√£o |
|----------------|-------------------|-----------|
| **RF-004** | Auditoria | Todas as altera√ß√µes em perfis/permiss√µes s√£o auditadas |
| **RF-005** | i18n | Nomes de perfis e descri√ß√µes traduzidos |
| **RF-008** | Usu√°rios | Perfis s√£o atribu√≠dos aos usu√°rios |
| **Sistema de Notifica√ß√µes** | Eventos | Notifica√ß√µes ao atribuir permiss√µes cr√≠ticas |

### Artefatos Gerados

| Artefato | Status | Data Prevista |
|---------|--------|--------------|
| Casos de Uso (UC) | Obrigat√≥rio | - |
| Modelo de Dados (MD) | Obrigat√≥rio | - |
| Massas de Teste (MT) | Obrigat√≥rio | - |
| Casos de Teste (TC) | Obrigat√≥rio | - |

### KPIs do Dashboard

1. **Total de Perfis Ativos**: Contagem de perfis com `Fl_Ativo = 1`
2. **Total de Usu√°rios por Perfil**: Gr√°fico de distribui√ß√£o
3. **Permiss√µes Mais Usadas**: Top 10 permiss√µes atribu√≠das
4. **Perfis de Sistema vs. Personalizados**: Comparativo percentual

### Alertas Configurados

- üî¥ **Cr√≠tico**: Perfil com 0 usu√°rios h√° mais de 90 dias (sugest√£o: desativar)
- üü† **Importante**: Permiss√£o cr√≠tica atribu√≠da sem justificativa adequada
- üîµ **Info**: Tentativas de acesso negado (√∫ltimas 24h) acima de 10

---

## CHANGELOG

| Vers√£o | Data | Descri√ß√£o | Autor |
|------|------|----------|------|
| 2.0 | 2025-12-30 | Migra√ß√£o para formato v2.0 - separa√ß√£o RF/RL, estrutura can√¥nica | Ag√™ncia ALC - alc.dev.br |
| 1.0 | 2025-11-15 | Vers√£o inicial (misturada RF + RL) | Ag√™ncia ALC - alc.dev.br |
