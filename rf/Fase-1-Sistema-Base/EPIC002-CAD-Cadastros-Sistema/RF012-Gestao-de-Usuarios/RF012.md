# RF-012: Gestão de Usuários do Sistema

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC002-CAD - Cadastros Sistema
**Fase**: Fase 1 - Sistema Base

---

## 1. OBJETIVO DO REQUISITO

Descrever de forma clara, objetiva e verificável o comportamento esperado do **RF-012: Gestão de Usuários do Sistema**, servindo como **contrato oficial** entre negócio, desenvolvimento, testes e agentes de IA.

Este RF especifica o gerenciamento completo de usuários administrativos e operacionais do sistema IControlIT, incluindo autenticação, autorização, gestão de perfis, senhas, sessões, integração com Active Directory e auditoria de acessos.

**Diferença fundamental**: Este módulo gerencia **Usuários do Sistema** (pessoas que acessam o IControlIT), diferente do módulo de **Consumidores** (usuários finais que consomem recursos de TI/Telecom mas não acessam o sistema).

Este documento **não define implementação**, apenas **o que o sistema deve fazer**, sob quais condições e quais garantias devem ser preservadas.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Autenticação de usuários com credenciais (login/senha)
- [x] Tokens JWT com refresh token (access token 8h, refresh 30 dias)
- [x] Multi-Factor Authentication (MFA) via TOTP
- [x] Gestão de senhas (criação, alteração, reset via e-mail, expiração 90 dias)
- [x] Histórico de senhas (últimas 12 senhas não podem ser reutilizadas)
- [x] Bloqueio automático após 5 tentativas falhas em 15 minutos
- [x] Perfis de acesso RBAC com permissões granulares
- [x] Permissões customizadas por usuário (adicionam às permissões do perfil)
- [x] Integração com Active Directory (autenticação LDAP, sincronização de dados)
- [x] Sessões múltiplas simultâneas (máximo 5 por usuário)
- [x] Detecção de login suspeito (IP/país/horário incomum)
- [x] Auditoria completa de acessos (sucesso/falha, IP, geolocalização, dispositivo)
- [x] Primeiro acesso força troca de senha
- [x] Isolamento multi-tenant (login e email únicos por Fornecedor)
- [x] Níveis de detalhamento de visualização (contas e contatos)
- [x] Status de desativação administrativa
- [x] CRUD completo de usuários

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (Angular implementará conforme UX)
- Tecnologia de hash de senha (BCrypt é implementação, não contrato)
- Layout, design ou identidade visual
- Estratégia de deploy ou infraestrutura
- Gestão de Consumidores (RF separado)
- SSO com provedores externos OAuth2/SAML (fase futura)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Usuário** | Pessoa física autenticada que acessa o sistema IControlIT com credenciais próprias |
| **Consumidor** | Usuário final que consome recursos de TI/Telecom mas não acessa o sistema (RF separado) |
| **Fornecedor** | Unidade lógica de isolamento de dados (multi-tenancy) |
| **Perfil** | Conjunto de permissões RBAC atribuídas a um ou mais usuários |
| **Permissões Customizadas** | Permissões adicionais específicas de um usuário, complementando as do perfil |
| **MFA (Multi-Factor Authentication)** | Segundo fator de autenticação via TOTP (Google Authenticator, Authy) |
| **TOTP (Time-based One-Time Password)** | Código de 6 dígitos gerado a cada 30 segundos |
| **Access Token (JWT)** | Token de acesso válido por 8 horas contendo claims do usuário |
| **Refresh Token** | Token opaco válido por 30 dias para renovar access token sem novo login |
| **Login Suspeito** | Acesso detectado como anômalo (IP/país/horário incomum) |
| **Active Directory (AD)** | Diretório corporativo Microsoft para gestão centralizada de usuários |
| **LDAP** | Protocolo de comunicação com Active Directory |
| **Detalhamento** | Nível de visibilidade de dados sensíveis (Básico=1, Intermediário=2, Completo=3) |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Autenticação de Usuários**
   - Login com credenciais (login/senha)
   - Geração de access token JWT (8h) e refresh token (30 dias)
   - Validação de MFA se habilitado
   - Bloqueio após 5 tentativas falhas
   - Detecção de login suspeito

2. **Gestão de Senhas**
   - Política de senha forte (mínimo 8 caracteres, maiúsculas, minúsculas, números, especiais)
   - Histórico de 12 senhas (não permite reutilização)
   - Expiração após 90 dias com notificação 7 dias antes
   - Reset via e-mail com token temporário (1 hora)
   - Primeiro acesso força troca de senha

3. **Autorização RBAC**
   - Atribuição de perfil ao usuário
   - Permissões efetivas = Permissões do Perfil + Permissões Customizadas
   - Verificação em tempo de execução via middleware

4. **Multi-Factor Authentication (MFA)**
   - Habilitação/desabilitação por usuário
   - QR Code para configuração em app TOTP
   - Validação de código de 6 dígitos (janela 30s)
   - Backup via SMS (opcional)

5. **Integração Active Directory**
   - Autenticação via LDAP (senha não armazenada no IControlIT)
   - Sincronização automática de dados (nome, email, grupos)
   - Vinculação via AD_Object_GUID

6. **Gestão de Sessões**
   - Múltiplas sessões simultâneas (máximo 5)
   - Visualização de sessões ativas (dispositivo, IP, última atividade)
   - Revogação manual de sessões
   - Invalidação automática da sessão mais antiga ao atingir 6ª sessão

7. **Auditoria e Detecção**
   - Log de todos os acessos (sucesso/falha)
   - Registro de IP, User-Agent, geolocalização
   - Detecção de login suspeito (IP/país/horário anômalo)
   - Notificação por e-mail em caso de suspeita

8. **CRUD de Usuários**
   - Criar usuário com senha temporária
   - Atualizar dados do usuário
   - Consultar usuário por ID
   - Listar usuários com filtros (perfil, status)
   - Desativar usuário (soft delete)
   - Bloquear/desbloquear manualmente

9. **Controles de Visibilidade**
   - Detalhamento de Conta (1=Básico, 2=Intermediário, 3=Completo)
   - Detalhamento de Contato (1=Básico, 2=Intermediário, 3=Completo)

10. **Status e Estados**
    - Ativo/Inativo (soft delete)
    - Bloqueado/Desbloqueado
    - Desativado Permanentemente (requer aprovação master)

---

## 5. REGRAS DE NEGÓCIO

### RN-RF012-01 — Login Único por Fornecedor

**Descrição**: O login do usuário deve ser único dentro do Fornecedor (multi-tenancy).

**Justificativa**: Garantir identificação inequívoca do usuário dentro do tenant, permitindo mesmo login em Fornecedores diferentes.

**Critério de Aceite**:
- Constraint no banco: `UNIQUE (Login, Id_Fornecedor)`
- Validação case-insensitive
- Formato permitido: letras, números, '.', '_' ou '-'
- Tentativa de criar login duplicado no mesmo Fornecedor → rejeição HTTP 409

---

### RN-RF012-02 — Política de Senha Forte

**Descrição**: Senhas devem atender critérios de segurança mínimos.

**Critérios Obrigatórios**:
- Mínimo **8 caracteres**
- Pelo menos **1 letra maiúscula**
- Pelo menos **1 letra minúscula**
- Pelo menos **1 número**
- Pelo menos **1 caractere especial** (@, #, $, %, &, *, etc.)
- **Não** pode conter o login do usuário
- **Não** pode estar no histórico das últimas 12 senhas

**Critério de Aceite**:
- Senha que não atende qualquer critério → rejeição HTTP 400 com mensagem específica
- Validação implementada via FluentValidation (backend) e Reactive Forms (frontend)

---

### RN-RF012-03 — Bloqueio por Tentativas Falhas

**Descrição**: Usuário é bloqueado automaticamente após **5 tentativas falhas** consecutivas em **15 minutos**.

**Regra**:
- A cada falha de autenticação: incrementar `Tentativas_Falhas`
- Ao atingir 5 tentativas: `Fl_Bloqueado = 1`, `Dt_Bloqueio = GETDATE()`
- Reset automático após 15 minutos sem novas tentativas
- Administrador pode desbloquear manualmente via endpoint `POST /api/usuarios/{id}/unlock`
- Envio de e-mail de notificação ao usuário bloqueado

**Critério de Aceite**:
- 5ª tentativa falha → usuário bloqueado
- Login com usuário bloqueado → HTTP 403 com mensagem "Usuário bloqueado"
- Tentativa de login após 15 minutos do bloqueio → reset automático do contador

---

### RN-RF012-04 — Expiração de Senha

**Descrição**: Senhas expiram após **90 dias** e devem ser alteradas obrigatoriamente.

**Regra**:
- `Dt_Expiracao_Senha` calculada automaticamente: `Dt_Alteracao_Senha + 90 dias`
- Ao fazer login com senha expirada: retornar flag `RequireTrocaSenha = true`
- Frontend redireciona para tela de troca de senha obrigatória
- Sistema não permite acesso a outras funcionalidades até troca
- Job diário verifica senhas próximas de expirar (7 dias antes)
- Notificação por e-mail **7 dias antes** da expiração

**Critério de Aceite**:
- Login com senha expirada → access token não emitido, flag `RequireTrocaSenha = true`
- Usuário com senha expirada tenta acessar endpoint protegido → HTTP 403
- E-mail de alerta enviado 7 dias antes → verificável em log de auditoria

---

### RN-RF012-05 — Token JWT com Expiração

**Descrição**: Tokens JWT expiram após **8 horas** de emissão. Refresh tokens expiram após **30 dias**.

**Regra**:
- **Access Token (JWT)**: Válido por 8 horas, contém claims (ID usuário, perfil, Fornecedor, permissões)
- **Refresh Token**: Válido por 30 dias, token opaco armazenado em `Usuario_Sessao`
- Refresh token pode gerar novo access token sem novo login (endpoint `POST /api/auth/refresh`)
- Se refresh token expirado: usuário deve fazer login novamente
- Sessões armazenam informações de dispositivo, IP e geolocalização

**Critério de Aceite**:
- Access token após 8 horas → inválido, HTTP 401
- Refresh token válido → gera novo access token com sucesso
- Refresh token após 30 dias → inválido, HTTP 401, requer novo login

---

### RN-RF012-06 — Permissões Baseadas em Perfis (RBAC)

**Descrição**: Usuários herdam permissões do perfil atribuído, mas podem ter permissões customizadas adicionais.

**Regra**:
- Permissões efetivas = **Permissões do Perfil + Permissões Customizadas**
- Permissões customizadas **apenas adicionam** (não removem permissões do perfil)
- Formato JSON armazenado em coluna `Permissoes_Customizadas` (tipo NVARCHAR(MAX))
- Verificação em tempo de execução via middleware de autorização
- Exemplo de permissão: `"contratos:contrato:aprovar"` (padrão: `recurso:acao:operacao`)

**Critério de Aceite**:
- Usuário com perfil "Operador" (permissões A, B) + customizadas (C) → efetivas = A, B, C
- Tentativa de remover permissão do perfil via customizadas → ignorado
- Endpoint protegido com permissão não efetiva → HTTP 403

---

### RN-RF012-07 — Histórico de Senhas

**Descrição**: Sistema armazena últimas **12 senhas** para prevenir reutilização.

**Regra**:
- Ao alterar senha, nova senha **não pode** estar nas últimas 12
- Hash BCrypt armazenado em tabela `Usuario_Historico_Senha`
- Limite: 12 registros por usuário (mais antigos automaticamente deletados via trigger ou lógica)
- Verificação usando BCrypt.Verify para cada hash histórico

**Critério de Aceite**:
- Tentativa de reutilizar senha das últimas 12 → rejeição HTTP 400 com mensagem específica
- 13ª senha criada → senha mais antiga do histórico removida automaticamente
- Histórico consultável via endpoint administrativo (somente admin)

---

### RN-RF012-08 — MFA (Multi-Factor Authentication)

**Descrição**: Usuários podem habilitar MFA via TOTP (Google Authenticator, Authy, etc.).

**Regra**:
- `Fl_MFA_Habilitado = 1`: MFA obrigatório após login com senha
- Secret TOTP armazenado em `MFA_Secret` (Base32-encoded)
- Código TOTP válido por **30 segundos** (padrão TOTP RFC 6238)
- QR Code gerado via formato: `otpauth://totp/IControlIT:{email}?secret={secret}&issuer=IControlIT`
- Backup via SMS em `Telefone_MFA` (opcional, configurável)
- Tolerância de janela: aceitar código anterior/posterior (±1 janela = 90s total)

**Critério de Aceite**:
- Login com MFA habilitado sem código → rejeição, requer código TOTP
- Código TOTP inválido → HTTP 401
- QR Code gerado válido para escaneamento em apps TOTP
- Desabilitação de MFA requer confirmação de senha atual

---

### RN-RF012-09 — Integração com Active Directory

**Descrição**: Usuários podem ser sincronizados e autenticados via Active Directory corporativo.

**Regra**:
- `Fl_Usuario_AD = 1`: Usuário gerenciado pelo AD
- Login/senha **não armazenados** no IControlIT, validados contra AD LDAP
- Sincronização automática de dados: nome, email, grupos AD
- `AD_Object_GUID` vincula usuário IControlIT com objeto AD (unicidade)
- `AD_Sam_Account_Name` armazena login do AD
- Sincronização via PrincipalContext (.NET) ou Microsoft Graph API
- Desligamento no AD → flag `Fl_Ativo = 0` no IControlIT (job diário)

**Critério de Aceite**:
- Usuário AD tenta login → autenticação via LDAP (não valida hash local)
- Sincronização bem-sucedida → dados atualizados no IControlIT
- Usuário removido do AD → marcado como inativo no próximo job de sincronização

---

### RN-RF012-10 — Detecção de Login Suspeito

**Descrição**: Sistema detecta logins suspeitos e notifica usuário via e-mail.

**Critérios de Suspeita**:
- Login de **IP desconhecido** (não usado nos últimos 30 dias)
- Login de **país diferente** do usual (detectado via geolocalização de IP)
- Login em **horário incomum** (ex: 00h-06h e usuário nunca acessou nesse horário)
- Múltiplos logins **simultâneos** de IPs diferentes

**Ação**:
- Registro em `Usuario_Historico_Acesso` com `Fl_Login_Suspeito = 1`
- Envio de e-mail ao usuário com detalhes (IP, localização, dispositivo, data/hora)
- Link no e-mail para revogar sessão suspeita

**Critério de Aceite**:
- Login de IP novo → marcado como suspeito, e-mail enviado
- E-mail contém informações completas do acesso
- Usuário pode revogar sessão via link no e-mail

---

### RN-RF012-11 — Reset de Senha via E-mail

**Descrição**: Usuários podem solicitar reset de senha via e-mail com token temporário.

**Regra**:
- Token gerado criptograficamente seguro (256 bits, Base64URL-encoded)
- Válido por **1 hora**
- Uso único: `Fl_Utilizado = 1` após uso, token não pode ser reutilizado
- E-mail contém link: `https://app.icontrolit.com/reset-senha?token={token}`
- Token armazenado em `Usuario_Reset_Senha` com hash SHA256 (não plaintext)
- Após expiração (1h), token não pode ser usado mesmo se não utilizado

**Critério de Aceite**:
- Solicitação de reset → e-mail enviado com link válido
- Token usado → senha alterada com sucesso, token marcado como utilizado
- Tentativa de reutilizar token → HTTP 400 "Token já utilizado"
- Token após 1h → HTTP 400 "Token expirado"

---

### RN-RF012-12 — Sessões Múltiplas Simultâneas

**Descrição**: Sistema permite múltiplas sessões simultâneas por usuário com limite de **5 sessões ativas**.

**Regra**:
- Usuário pode ter até **5 sessões ativas** simultaneamente
- Ao atingir 6ª sessão: **sessão mais antiga** (por `Dt_Ultimo_Acesso`) é invalidada automaticamente
- Usuário pode visualizar todas as sessões ativas via endpoint `GET /api/usuarios/me/sessoes`
- Retorno inclui: dispositivo, navegador, IP, localização, última atividade
- Usuário pode revogar qualquer sessão manualmente via `DELETE /api/usuarios/me/sessoes/{sessaoId}`

**Critério de Aceite**:
- 6º login simultâneo → sessão mais antiga invalidada, nova sessão criada
- Endpoint de listagem → retorna máximo 5 sessões
- Revogação manual → sessão removida, refresh token invalidado

---

### RN-RF012-13 — Auditoria Completa de Acessos

**Descrição**: Todo acesso (sucesso ou falha) é registrado para auditoria e compliance.

**Informações Registradas**:
- Login tentado
- Resultado (sucesso / falha_senha_incorreta / falha_usuario_bloqueado / falha_mfa)
- IP de origem
- User-Agent (navegador/versão)
- Device Type (Web / Mobile / API)
- Geolocalização (cidade, estado, país) via API externa (ipapi.co, GeoIP)
- Data/hora UTC
- Motivo de falha (se aplicável)
- Duração da sessão (para logouts)

**Tabela**: `Usuario_Historico_Acesso`

**Critério de Aceite**:
- Toda tentativa de login → registro criado independente de sucesso/falha
- Dados de geolocalização preenchidos quando IP público
- Consulta de auditoria via endpoint administrativo com filtros (usuário, data, resultado)

---

### RN-RF012-14 — Primeiro Acesso Força Troca de Senha

**Descrição**: Usuário criado por administrador com senha temporária deve trocar senha no primeiro acesso.

**Regra**:
- `Fl_Primeiro_Acesso = 1`: Indica senha temporária criada por admin
- Ao fazer login: sistema retorna flag `RequireTrocaSenha = true` no payload
- Frontend redireciona para tela de troca de senha obrigatória
- Sistema não emite access token completo até troca (ou emite token limitado apenas para troca)
- Após troca de senha com sucesso: `Fl_Primeiro_Acesso = 0`, `Dt_Alteracao_Senha = GETDATE()`

**Critério de Aceite**:
- Login com `Fl_Primeiro_Acesso = 1` → flag `RequireTrocaSenha = true`
- Tentativa de acessar endpoint protegido antes de trocar → HTTP 403
- Troca de senha bem-sucedida → flag resetada, acesso liberado

---

### RN-RF012-15 — E-mail Único por Fornecedor

**Descrição**: E-mail do usuário deve ser único dentro do Fornecedor.

**Regra**:
- Constraint no banco: `UNIQUE (Email, Id_Fornecedor)`
- Validação case-insensitive
- Formato válido conforme RFC 5322 (regex: `^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$`)
- Usado para recuperação de senha e notificações críticas

**Critério de Aceite**:
- Tentativa de criar usuário com e-mail duplicado no mesmo Fornecedor → HTTP 409
- E-mail inválido → HTTP 400 com mensagem específica
- E-mails em Fornecedores diferentes → permitido

---

### RN-RF012-16 — Detalhamento de Contas e Contatos (Níveis de Visibilidade)

**Descrição**: Usuário pode ter diferentes níveis de detalhamento para visualização de contas financeiras e contatos/consumidores.

**Regra**:
- `Usuario.Detalhamento_Conta` (INT): Nível de detalhamento das contas financeiras
  - **1 = Básico**: Visualiza apenas informações resumidas (saldo, nome conta)
  - **2 = Intermediário**: Visualiza transações e categorias
  - **3 = Completo**: Visualiza todos os detalhes financeiros, incluindo dados sensíveis
  - Default: 1 (Básico)

- `Usuario.Detalhamento_Contato` (INT): Nível de detalhamento dos contatos/consumidores
  - **1 = Básico**: Visualiza apenas nome e identificador
  - **2 = Intermediário**: Visualiza telefone, e-mail, departamento
  - **3 = Completo**: Visualiza todos os dados pessoais e histórico
  - Default: 1 (Básico)

- Validação: Valores aceitos são **apenas 1, 2 ou 3**
- Controla visibilidade em endpoints de consulta (filtros aplicados no backend)

**Critério de Aceite**:
- Usuário com Detalhamento_Conta = 1 consulta conta → retorno contém apenas campos básicos
- Tentativa de definir Detalhamento_Conta = 4 → HTTP 400
- Frontend adapta interface conforme nível de detalhamento retornado

---

### RN-RF012-17 — Status de Desativação do Usuário

**Descrição**: Usuário pode ter status de desativação além dos flags de ativo/bloqueado.

**Regra**:
- `Usuario.Fl_Desativado` (INT): Flag de desativação manual do usuário
  - **1 = Ativo**: Usuário em operação normal
  - **2 = Inativo**: Desativado temporariamente (ex: licença, afastamento)
  - **3 = Desativado Permanentemente**: Desligamento definitivo (ex: funcionário demitido)
  - Default: 1 (Ativo)

- Diferenças:
  - `Fl_Ativo` (soft delete): Marca exclusão lógica
  - `Fl_Bloqueado`: Bloqueio temporário por tentativas falhas ou admin
  - `Fl_Desativado = 3`: Desativação permanente por motivo administrativo

- Usuários com `Fl_Desativado = 3` **não podem ser reativados** sem aprovação do administrador master (role "Super Admin")
- Login com usuário desativado (Fl_Desativado = 2 ou 3) → HTTP 403 "Usuário desativado"

**Critério de Aceite**:
- Tentativa de login com `Fl_Desativado = 2` → HTTP 403
- Tentativa de login com `Fl_Desativado = 3` → HTTP 403
- Reativação de usuário com `Fl_Desativado = 3` sem permissão "usuarios:reativar_permanente" → HTTP 403

---

## 6. ESTADOS DA ENTIDADE

| Estado | Descrição | `Fl_Ativo` | `Fl_Bloqueado` | `Fl_Desativado` |
|--------|-----------|------------|----------------|-----------------|
| **active** | Usuário ativo e operacional | 1 | 0 | 1 |
| **blocked** | Bloqueado por tentativas falhas ou admin | 1 | 1 | 1 |
| **inactive** | Desativado temporariamente | 1 | 0 | 2 |
| **deactivated_permanent** | Desativado permanentemente | 1 | 0 | 3 |
| **deleted** | Excluído logicamente (soft delete) | 0 | 0 | 1 |
| **first_access** | Senha temporária, requer troca | 1 | 0 | 1 (com `Fl_Primeiro_Acesso = 1`) |

### Transições Permitidas

| De | Para | Condição |
|---|---|---|
| first_access | active | Troca de senha bem-sucedida |
| active | blocked | 5 tentativas falhas ou bloqueio manual |
| blocked | active | Desbloqueio manual ou timeout 15 minutos |
| active | inactive | Desativação temporária por admin |
| inactive | active | Reativação por admin |
| active | deactivated_permanent | Desativação permanente por admin master |
| deactivated_permanent | active | Reativação por Super Admin (requer aprovação) |
| active | deleted | Exclusão lógica (soft delete) |

**Transições Proibidas**:
- `deleted` → qualquer outro estado (soft delete é irreversível sem restore manual)
- `deactivated_permanent` → `active` sem permissão "usuarios:reativar_permanente"

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre | Payload |
|--------|---------------|---------|
| **usuario.criado** | Após criação de usuário | `{ id, login, email, Fornecedor_id, perfil_id }` |
| **usuario.atualizado** | Após atualização de dados | `{ id, campos_alterados[], usuario_alterou_id }` |
| **usuario.senha_alterada** | Após troca de senha | `{ id, data_expiracao_nova }` |
| **usuario.senha_resetada** | Após reset via e-mail | `{ id, token_gerado, data_expiracao_token }` |
| **usuario.bloqueado** | Após bloqueio automático ou manual | `{ id, motivo, tentativas_falhas }` |
| **usuario.desbloqueado** | Após desbloqueio | `{ id, desbloqueado_por_id }` |
| **usuario.desativado** | Após desativação | `{ id, fl_desativado, motivo }` |
| **usuario.excluido** | Após soft delete | `{ id, excluido_por_id }` |
| **usuario.login_sucesso** | Após autenticação bem-sucedida | `{ id, ip, geolocation, dispositivo, mfa_usado }` |
| **usuario.login_falha** | Após tentativa de login falha | `{ login, motivo, ip, tentativas_restantes }` |
| **usuario.login_suspeito** | Após detecção de login anômalo | `{ id, ip, pais, horario, criterio_suspeita }` |
| **usuario.mfa_habilitado** | Após habilitar MFA | `{ id, secret_gerado }` |
| **usuario.mfa_desabilitado** | Após desabilitar MFA | `{ id }` |
| **usuario.sessao_criada** | Após novo login | `{ id, sessao_id, ip, dispositivo }` |
| **usuario.sessao_revogada** | Após logout ou revogação | `{ id, sessao_id, revogado_por }` |
| **usuario.ad_sincronizado** | Após sincronização com AD | `{ id, ad_object_guid, dados_sincronizados[] }` |

**Observação**: Eventos são publicados via bus de eventos (ex: MediatR Notifications, RabbitMQ) para permitir auditoria, notificações e integrações assíncronas.

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- **Isolamento Multi-Tenant**: Nenhuma operação pode violar isolamento de Fornecedor
- **Regras de Negócio Invioláveis**: Nenhuma RN pode ser ignorada ou flexibilizada sem alteração formal deste RF
- **Erros Previsíveis**: Todo erro retorna HTTP status code apropriado + mensagem estruturada em JSON
- **Auditoria Completa**: Toda operação sensível (criar, alterar senha, bloquear, excluir) registra quem, quando e o que mudou
- **Segurança por Padrão**: Validação de entrada obrigatória, proteção contra SQL Injection, XSS, CSRF
- **Performance**: Endpoints de listagem com paginação (50 itens por página), filtros otimizados com índices
- **Compatibilidade**: Endpoints RESTful seguindo padrões HTTP (GET, POST, PUT, DELETE, PATCH)
- **Testabilidade**: 100% das RNs devem ter casos de teste automatizados correspondentes

---

## 9. SEGURANÇA

### 9.1 Validação de Entrada
- Todos os inputs validados via FluentValidation (backend)
- Sanitização de strings para prevenir XSS
- Validação de formato de e-mail (RFC 5322)
- Validação de CPF/CNPJ se aplicável

### 9.2 Proteção contra Ataques
- **SQL Injection**: Uso exclusivo de queries parametrizadas (Entity Framework Core)
- **XSS**: Sanitização de outputs, Content-Security-Policy headers
- **CSRF**: Tokens CSRF em operações state-changing
- **Brute Force**: Bloqueio após 5 tentativas (RN-RF012-03)
- **Timing Attacks**: Respostas de autenticação com tempo constante

### 9.3 Controle de Permissões
- Autorização RBAC obrigatória em todos os endpoints
- Permissões granulares por operação (view, create, update, delete)
- Validação de permissões em cada request (middleware)
- Logs de tentativas de acesso não autorizado

### 9.4 Isolamento Multi-Tenant
- Filtro automático por `Id_Fornecedor` em todas as queries
- Row-Level Security (RLS) no banco de dados
- Impossibilidade de acesso cruzado entre Fornecedores
- Validação de tenant em cada endpoint

### 9.5 Criptografia
- Senhas: BCrypt com work factor 12 (custo computacional alto)
- Tokens JWT: Assinados com chave secreta (HS256) ou certificado (RS256)
- Refresh Tokens: Armazenados com hash SHA256 (não plaintext)
- MFA Secrets: Armazenados com criptografia AES256 (opcional, se extremamente sensível)

---

## 10. ARTEFATOS DERIVADOS

Este RF é base obrigatória para os seguintes artefatos:

- **UC-RF012.md**: Casos de Uso detalhados (UC00 a UC04)
- **MT-RF012.yaml**: Massas de Teste para validação automatizada
- **TC-RF012.yaml**: Casos de Teste (backend, frontend, segurança, E2E)
- **MD-RF012.md**: Modelo de Dados (tabelas Usuario, Usuario_Sessao, Usuario_Historico_Senha, Usuario_Historico_Acesso, Usuario_Reset_Senha)
- **WF-RF012.md**: Wireframes e fluxos de tela (Angular)
- **API Specification**: OpenAPI/Swagger para endpoints REST

---

## 11. RASTREABILIDADE

| Artefato | Status | Obrigatório |
|----------|--------|-------------|
| **UC-RF012.md** | Pendente | ✅ Sim |
| **MT-RF012.yaml** | Pendente | ✅ Sim |
| **TC-RF012.yaml** | Pendente | ✅ Sim |
| **MD-RF012.md** | Pendente | ✅ Sim |
| **WF-RF012.md** | Pendente | ✅ Sim |
| **RF012.yaml** | Pendente | ✅ Sim |
| **RL-RF012.md** | Pendente | ✅ Sim |
| **RL-RF012.yaml** | Pendente | ✅ Sim |
| **Endpoints API** | Não Iniciado | ✅ Sim |
| **Testes Backend** | Não Iniciado | ✅ Sim |
| **Testes Frontend** | Não Iniciado | ✅ Sim |
| **Testes E2E** | Não Iniciado | ✅ Sim |

**Casos de Uso Esperados** (mínimo obrigatório):
- **UC00-RF012**: Visão Geral e Navegação
- **UC01-RF012**: Criar Usuário com Senha Temporária
- **UC02-RF012**: Autenticar Usuário (Login com MFA)
- **UC03-RF012**: Gerenciar Perfis e Permissões
- **UC04-RF012**: Auditoria de Acessos e Sessões

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-30 | Migração para formato v2.0 canônico (11 seções obrigatórias). Separação completa de conteúdo legado para RL-RF012.md. Reestruturação de RNs com critérios de aceite explícitos. | Agência ALC - alc.dev.br |
| 1.0 | 2025-11-02 | Versão inicial com estrutura simplificada (5 seções). Continha mistura de conteúdo moderno e referências ao legado. | [Autor Original] |

---

[← Voltar ao Índice](./README.md)
