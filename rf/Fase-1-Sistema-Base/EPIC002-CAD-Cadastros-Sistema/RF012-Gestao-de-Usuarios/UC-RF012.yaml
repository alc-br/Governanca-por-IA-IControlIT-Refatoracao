# =============================================
# UC-RF012 - Casos de Uso: Gestão de Usuários do Sistema
# Versão: 2.0
# Data: 2025-12-31
# Autor: Agência ALC - alc.dev.br
# =============================================

uc:
  rf: "RF012"
  versao: "2.0"
  data: "2025-12-31"

observacao_sistema: |
  RF-012 é um CRUD completo de usuários com funcionalidades avançadas:
  - Multi-tenancy (EmpresaId obrigatório)
  - RBAC com matriz Permission → Role → User
  - MFA obrigatório via TOTP (RN-RF012-08)
  - Integração opcional com Active Directory via LDAP (RN-RF012-14)
  - Controle de estados: active, blocked, inactive, deactivated_permanent, deleted, first_access
  - Política de senha: 90 dias, 12 senhas históricas, BCrypt work factor 12
  - Auto-bloqueio após 5 tentativas de login (RN-RF012-12)
  - Detecção de login suspeito com geolocalização (RN-RF012-13)
  - Auditoria completa de tentativas de acesso (RN-RF012-17)

casos_de_uso:

  - id: "UC00"
    nome: "Listar Usuários"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      rf_items:
        - "RN-RF012-01"  # Multi-tenancy obrigatório
        - "RN-RF012-02"  # Estados: active, blocked, inactive, etc.
        - "RN-RF012-15"  # Permissões baseadas em RBAC
      uc_items:
        - id: "FP-UC00-001"
          title: "Usuário acessa a funcionalidade"
          required: true
        - id: "FP-UC00-002"
          title: "Sistema valida permissão CAD.USUARIOS.VIEW_ANY"
          required: true
        - id: "FP-UC00-003"
          title: "Sistema carrega usuários do tenant (EmpresaId)"
          required: true
        - id: "FP-UC00-004"
          title: "Sistema aplica paginação e ordenação"
          required: true
        - id: "FP-UC00-005"
          title: "Sistema exibe lista com estados coloridos"
          required: true
        - id: "FA-UC00-001"
          title: "Buscar por nome, email ou username"
          required: true
        - id: "FA-UC00-002"
          title: "Filtrar por estado (active, blocked, inactive)"
          required: true
        - id: "FA-UC00-003"
          title: "Filtrar por perfil (role)"
          required: true
        - id: "FE-UC00-001"
          title: "Usuário sem permissão → HTTP 403"
          required: true
        - id: "FE-UC00-002"
          title: "Nenhum usuário encontrado → estado vazio"
          required: true

    precondicoes:
      - permissao: "CAD.USUARIOS.VIEW_ANY"
      - usuario_autenticado: true

    gatilho: "Usuário acessa 'Gestão de Usuários' pelo menu"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessa_menu_usuarios"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
        permissao: "CAD.USUARIOS.VIEW_ANY"
      - passo: 3
        ator: "sistema"
        acao: "listar_usuarios_tenant"
        filtro: "EmpresaId = current_user.EmpresaId"
      - passo: 4
        ator: "sistema"
        acao: "exibir_lista_paginada"
        campos: ["Nome", "Email", "Username", "Estado", "Perfis", "UltimoLogin", "MFAAtivo"]

    fluxos_alternativos:
      - id: "FA-UC00-01"
        condicao: "usuario_busca_por_termo"
        passos:
          - "Usuário digita termo no campo de busca (ex: 'admin')"
          - "Sistema filtra por Nome LIKE '%termo%' OR Email LIKE '%termo%' OR Username LIKE '%termo%'"
          - "Sistema exibe lista filtrada"
        resultado: "lista_filtrada"

      - id: "FA-UC00-02"
        condicao: "usuario_filtra_por_estado"
        passos:
          - "Usuário seleciona estado no filtro (ex: 'blocked')"
          - "Sistema filtra WHERE Estado = 'blocked'"
          - "Sistema exibe apenas usuários bloqueados"
        resultado: "lista_filtrada_por_estado"
        regras: ["RN-RF012-02"]

      - id: "FA-UC00-03"
        condicao: "usuario_filtra_por_perfil"
        passos:
          - "Usuário seleciona perfil no filtro (ex: 'Admin')"
          - "Sistema busca usuarios com role 'Admin' (tabela UsuarioPerfil)"
          - "Sistema exibe lista filtrada"
        resultado: "lista_filtrada_por_perfil"
        regras: ["RN-RF012-15"]

    fluxos_excecao:
      - id: "FE-UC00-01"
        condicao: "sem_permissao"
        passos:
          - "Sistema verifica que usuário não possui CAD.USUARIOS.VIEW_ANY"
          - "Sistema retorna HTTP 403 Forbidden"
          - "Sistema exibe mensagem 'Acesso negado. Permissão CAD.USUARIOS.VIEW_ANY necessária.'"
        resultado: "acesso_negado"

      - id: "FE-UC00-02"
        condicao: "nenhum_usuario_encontrado"
        passos:
          - "Sistema busca usuários com filtros aplicados"
          - "Sistema não encontra nenhum registro"
          - "Sistema exibe mensagem 'Nenhum usuário encontrado.'"
        resultado: "lista_vazia"

    regras_aplicadas:
      - "RN-RF012-01"
      - "RN-RF012-02"
      - "RN-RF012-15"

    resultado_final:
      estado: "lista_usuarios_exibida"


  - id: "UC01"
    nome: "Criar Usuário"
    ator_principal: "usuario_autenticado"
    tipo: "crud"
    impacta_dados: true

    covers:
      rf_items:
        - "RN-RF012-01"  # Multi-tenancy
        - "RN-RF012-02"  # Política de senha forte
        - "RN-RF012-03"  # Email único no tenant
        - "RN-RF012-04"  # Username único no tenant
        - "RN-RF012-05"  # Validação de email
        - "RN-RF012-06"  # Validação de username
        - "RN-RF012-07"  # Senha: 8+ chars, maiúscula, número, especial
        - "RN-RF012-14"  # Primeiro acesso força troca de senha
        - "RN-RF012-15"  # Atribuição de perfis obrigatória
        - "RN-RF012-16"  # Detalhamento de Contas e Contatos
      uc_items:
        - id: "FP-UC01-001"
          title: "Usuário solicita criação"
          required: true
        - id: "FP-UC01-002"
          title: "Sistema valida permissão CAD.USUARIOS.CREATE"
          required: true
        - id: "FP-UC01-003"
          title: "Sistema exibe formulário"
          required: true
        - id: "FP-UC01-004"
          title: "Usuário informa dados obrigatórios"
          required: true
        - id: "FP-UC01-005"
          title: "Sistema valida email único no tenant"
          required: true
        - id: "FP-UC01-006"
          title: "Sistema valida username único no tenant"
          required: true
        - id: "FP-UC01-007"
          title: "Sistema valida política de senha"
          required: true
        - id: "FP-UC01-008"
          title: "Sistema criptografa senha com BCrypt"
          required: true
        - id: "FP-UC01-009"
          title: "Sistema gera QR Code TOTP para MFA"
          required: true
        - id: "FP-UC01-010"
          title: "Sistema cria registro com Estado=first_access"
          required: true
        - id: "FP-UC01-011"
          title: "Sistema atribui perfis selecionados"
          required: true
        - id: "FP-UC01-012"
          title: "Sistema registra auditoria"
          required: true
        - id: "FP-UC01-013"
          title: "Sistema confirma sucesso e exibe QR Code MFA"
          required: true
        - id: "FA-UC01-001"
          title: "Importar usuários do Active Directory"
          required: false
        - id: "FE-UC01-001"
          title: "Email duplicado → HTTP 400"
          required: true
        - id: "FE-UC01-002"
          title: "Username duplicado → HTTP 400"
          required: true
        - id: "FE-UC01-003"
          title: "Senha não atende política → HTTP 400"
          required: true
        - id: "FE-UC01-004"
          title: "Email inválido → HTTP 400"
          required: true

    precondicoes:
      - permissao: "CAD.USUARIOS.CREATE"
      - usuario_autenticado: true

    gatilho: "Usuário clica em 'Novo Usuário'"

    fluxo_principal:
      - passo: 1
        ator: "sistema"
        acao: "exibir_formulario"
        campos: ["Nome", "Email", "Username", "Senha", "ConfirmarSenha", "Perfis[]"]
      - passo: 2
        ator: "usuario"
        acao: "preencher_campos_obrigatorios"
      - passo: 3
        ator: "usuario"
        acao: "selecionar_perfis"
      - passo: 4
        ator: "usuario"
        acao: "salvar"
      - passo: 5
        ator: "sistema"
        acao: "validar_email_unico"
        regras: ["RN-RF012-03", "RN-RF012-05"]
      - passo: 6
        ator: "sistema"
        acao: "validar_username_unico"
        regras: ["RN-RF012-04", "RN-RF012-06"]
      - passo: 7
        ator: "sistema"
        acao: "validar_politica_senha"
        regras: ["RN-RF012-07"]
      - passo: 8
        ator: "sistema"
        acao: "criptografar_senha_bcrypt"
        regras: ["RN-RF012-09"]
      - passo: 9
        ator: "sistema"
        acao: "gerar_secret_totp_mfa"
        regras: ["RN-RF012-08"]
      - passo: 10
        ator: "sistema"
        acao: "persistir_usuario"
        estado: "first_access"
      - passo: 11
        ator: "sistema"
        acao: "atribuir_perfis"
        regras: ["RN-RF012-15"]
      - passo: 12
        ator: "sistema"
        acao: "registrar_auditoria"
      - passo: 13
        ator: "sistema"
        acao: "exibir_qrcode_mfa"
        instrucoes: "Usuário deve escanear QR Code no Google Authenticator"

    fluxos_alternativos:
      - id: "FA-UC01-01"
        condicao: "importar_active_directory"
        passos:
          - "Admin clica em 'Importar do AD'"
          - "Sistema exibe formulário de conexão LDAP (servidor, porta, base DN)"
          - "Admin informa credenciais LDAP"
          - "Sistema conecta ao AD e busca usuários"
          - "Admin seleciona usuários a importar"
          - "Sistema cria usuários com Estado=active e MFA desabilitado (RN-RF012-14)"
          - "Sistema exibe mensagem 'X usuários importados com sucesso'"
        resultado: "usuarios_importados_ad"
        regras: ["RN-RF012-14"]

    fluxos_excecao:
      - id: "FE-UC01-01"
        condicao: "email_duplicado"
        passos:
          - "Sistema valida email único no tenant"
          - "Sistema encontra outro usuário com mesmo email (WHERE EmpresaId = X AND Email = Y)"
          - "Sistema retorna HTTP 400 Bad Request"
          - "Sistema exibe mensagem 'Email já cadastrado para este tenant.'"
        resultado: "validacao_falhou"
        regras: ["RN-RF012-03"]

      - id: "FE-UC01-02"
        condicao: "username_duplicado"
        passos:
          - "Sistema valida username único no tenant"
          - "Sistema encontra outro usuário com mesmo username (WHERE EmpresaId = X AND Username = Y)"
          - "Sistema retorna HTTP 400 Bad Request"
          - "Sistema exibe mensagem 'Username já cadastrado para este tenant.'"
        resultado: "validacao_falhou"
        regras: ["RN-RF012-04"]

      - id: "FE-UC01-03"
        condicao: "senha_invalida"
        passos:
          - "Sistema valida política de senha: mín 8 chars, 1 maiúscula, 1 número, 1 especial"
          - "Sistema detecta senha inválida (ex: 'senha123')"
          - "Sistema retorna HTTP 400 Bad Request"
          - "Sistema exibe mensagem 'Senha deve conter mínimo 8 caracteres, 1 maiúscula, 1 número e 1 caractere especial.'"
        resultado: "validacao_falhou"
        regras: ["RN-RF012-07"]

      - id: "FE-UC01-04"
        condicao: "email_invalido"
        passos:
          - "Sistema valida formato de email (regex)"
          - "Sistema detecta email inválido (ex: 'usuario@')"
          - "Sistema retorna HTTP 400 Bad Request"
          - "Sistema exibe mensagem 'Email inválido.'"
        resultado: "validacao_falhou"
        regras: ["RN-RF012-05"]

    regras_aplicadas:
      - "RN-RF012-01"
      - "RN-RF012-03"
      - "RN-RF012-04"
      - "RN-RF012-05"
      - "RN-RF012-06"
      - "RN-RF012-07"
      - "RN-RF012-08"
      - "RN-RF012-09"
      - "RN-RF012-14"
      - "RN-RF012-15"

    resultado_final:
      estado: "usuario_criado_com_mfa"


  - id: "UC02"
    nome: "Visualizar Usuário"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      rf_items:
        - "RN-RF012-01"  # Multi-tenancy
        - "RN-RF012-02"  # Estados
        - "RN-RF012-07"  # Histórico de 12 senhas
        - "RN-RF012-13"  # Auditoria completa de acessos
        - "RN-RF012-15"  # Perfis
        - "RN-RF012-17"  # Status de desativação
      uc_items:
        - id: "FP-UC02-001"
          title: "Usuário solicita visualização"
          required: true
        - id: "FP-UC02-002"
          title: "Sistema valida permissão CAD.USUARIOS.VIEW"
          required: true
        - id: "FP-UC02-003"
          title: "Sistema carrega dados completos do usuário"
          required: true
        - id: "FP-UC02-004"
          title: "Sistema exibe detalhes com histórico de acessos"
          required: true
        - id: "FA-UC02-001"
          title: "Visualizar histórico de senhas (hashes)"
          required: false
        - id: "FA-UC02-002"
          title: "Visualizar logs de auditoria"
          required: true
        - id: "FE-UC02-001"
          title: "Usuário não encontrado → HTTP 404"
          required: true
        - id: "FE-UC02-002"
          title: "Usuário de outro tenant → HTTP 403"
          required: true

    precondicoes:
      - permissao: "CAD.USUARIOS.VIEW"
      - usuario_autenticado: true

    gatilho: "Usuário clica em um usuário na lista (UC00)"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "clica_em_usuario"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
        permissao: "CAD.USUARIOS.VIEW"
      - passo: 3
        ator: "sistema"
        acao: "validar_multi_tenancy"
        regras: ["RN-RF012-01"]
      - passo: 4
        ator: "sistema"
        acao: "carregar_usuario_completo"
        includes: ["Perfis", "HistoricoAcessos", "HistoricoSenhas"]
      - passo: 5
        ator: "sistema"
        acao: "exibir_detalhes"
        campos: ["Nome", "Email", "Username", "Estado", "Perfis", "MFAAtivo", "DataCriacao", "UltimoLogin", "TentativasFalhas"]

    fluxos_alternativos:
      - id: "FA-UC02-01"
        condicao: "visualizar_historico_senhas"
        passos:
          - "Admin clica em 'Histórico de Senhas'"
          - "Sistema exibe últimas 12 senhas (apenas hashes BCrypt)"
          - "Sistema exibe data de cada alteração"
        resultado: "historico_senhas_exibido"
        regras: ["RN-RF012-11"]

      - id: "FA-UC02-02"
        condicao: "visualizar_auditoria"
        passos:
          - "Admin clica em 'Logs de Auditoria'"
          - "Sistema exibe tentativas de login (sucessos e falhas)"
          - "Sistema exibe IP, UserAgent, geolocalização, timestamp"
        resultado: "auditoria_exibida"
        regras: ["RN-RF012-17"]

    fluxos_excecao:
      - id: "FE-UC02-01"
        condicao: "usuario_nao_encontrado"
        passos:
          - "Sistema busca usuário pelo ID"
          - "Sistema não encontra registro"
          - "Sistema retorna HTTP 404 Not Found"
          - "Sistema exibe mensagem 'Usuário não encontrado.'"
        resultado: "usuario_nao_encontrado"

      - id: "FE-UC02-02"
        condicao: "usuario_outro_tenant"
        passos:
          - "Sistema busca usuário pelo ID"
          - "Sistema verifica que EmpresaId do usuário ≠ EmpresaId do current_user"
          - "Sistema retorna HTTP 403 Forbidden"
          - "Sistema exibe mensagem 'Acesso negado. Usuário pertence a outro tenant.'"
        resultado: "acesso_negado_multi_tenancy"
        regras: ["RN-RF012-01"]

    regras_aplicadas:
      - "RN-RF012-01"
      - "RN-RF012-02"
      - "RN-RF012-11"
      - "RN-RF012-15"
      - "RN-RF012-17"

    resultado_final:
      estado: "detalhes_usuario_exibidos"


  - id: "UC03"
    nome: "Editar Usuário"
    ator_principal: "usuario_autenticado"
    tipo: "crud"
    impacta_dados: true

    covers:
      rf_items:
        - "RN-RF012-01"  # Multi-tenancy
        - "RN-RF012-02"  # Transições de estado válidas
        - "RN-RF012-03"  # Email único (bloqueio automático)
        - "RN-RF012-04"  # Username único
        - "RN-RF012-05"  # Validação email
        - "RN-RF012-06"  # Validação username
        - "RN-RF012-10"  # Detecção de login suspeito
        - "RN-RF012-11"  # Reset de senha via e-mail
        - "RN-RF012-12"  # Máximo 5 sessões simultâneas
        - "RN-RF012-15"  # Atualização de perfis
        - "RN-RF012-16"  # Detalhamento de Contas e Contatos
      uc_items:
        - id: "FP-UC03-001"
          title: "Usuário solicita edição"
          required: true
        - id: "FP-UC03-002"
          title: "Sistema valida permissão CAD.USUARIOS.UPDATE"
          required: true
        - id: "FP-UC03-003"
          title: "Sistema exibe formulário preenchido"
          required: true
        - id: "FP-UC03-004"
          title: "Usuário altera dados"
          required: true
        - id: "FP-UC03-005"
          title: "Sistema valida email único (exceto próprio)"
          required: true
        - id: "FP-UC03-006"
          title: "Sistema valida username único (exceto próprio)"
          required: true
        - id: "FP-UC03-007"
          title: "Sistema valida transição de estado"
          required: true
        - id: "FP-UC03-008"
          title: "Sistema atualiza registro"
          required: true
        - id: "FP-UC03-009"
          title: "Sistema registra auditoria"
          required: true
        - id: "FP-UC03-010"
          title: "Sistema confirma sucesso"
          required: true
        - id: "FA-UC03-001"
          title: "Bloquear usuário (active → blocked)"
          required: true
        - id: "FA-UC03-002"
          title: "Desbloquear usuário (blocked → active)"
          required: true
        - id: "FA-UC03-003"
          title: "Inativar usuário (active → inactive)"
          required: true
        - id: "FA-UC03-004"
          title: "Resetar senha e MFA"
          required: true
        - id: "FE-UC03-001"
          title: "Email duplicado → HTTP 400"
          required: true
        - id: "FE-UC03-002"
          title: "Transição de estado inválida → HTTP 400"
          required: true

    precondicoes:
      - permissao: "CAD.USUARIOS.UPDATE"
      - usuario_autenticado: true

    gatilho: "Usuário clica em 'Editar' no detalhe do usuário (UC02)"

    fluxo_principal:
      - passo: 1
        ator: "sistema"
        acao: "exibir_formulario_edicao"
        campos: ["Nome", "Email", "Username", "Estado", "Perfis[]"]
      - passo: 2
        ator: "usuario"
        acao: "alterar_campos"
      - passo: 3
        ator: "usuario"
        acao: "salvar"
      - passo: 4
        ator: "sistema"
        acao: "validar_email_unico_exceto_proprio"
        regras: ["RN-RF012-03"]
      - passo: 5
        ator: "sistema"
        acao: "validar_username_unico_exceto_proprio"
        regras: ["RN-RF012-04"]
      - passo: 6
        ator: "sistema"
        acao: "validar_transicao_estado"
        regras: ["RN-RF012-02"]
      - passo: 7
        ator: "sistema"
        acao: "atualizar_usuario"
      - passo: 8
        ator: "sistema"
        acao: "atualizar_perfis"
        regras: ["RN-RF012-15"]
      - passo: 9
        ator: "sistema"
        acao: "registrar_auditoria"

    fluxos_alternativos:
      - id: "FA-UC03-01"
        condicao: "bloquear_usuario"
        passos:
          - "Admin clica em 'Bloquear Usuário'"
          - "Sistema valida transição active → blocked (permitida)"
          - "Sistema atualiza Estado = blocked"
          - "Sistema exibe mensagem 'Usuário bloqueado com sucesso. Ele não poderá fazer login.'"
        resultado: "usuario_bloqueado"
        regras: ["RN-RF012-02"]

      - id: "FA-UC03-02"
        condicao: "desbloquear_usuario"
        passos:
          - "Admin clica em 'Desbloquear Usuário'"
          - "Sistema valida transição blocked → active (permitida)"
          - "Sistema atualiza Estado = active"
          - "Sistema reseta TentativasFalhas = 0"
          - "Sistema exibe mensagem 'Usuário desbloqueado com sucesso.'"
        resultado: "usuario_desbloqueado"
        regras: ["RN-RF012-02", "RN-RF012-12"]

      - id: "FA-UC03-03"
        condicao: "inativar_usuario"
        passos:
          - "Admin clica em 'Inativar Usuário'"
          - "Sistema valida transição active → inactive (permitida)"
          - "Sistema atualiza Estado = inactive"
          - "Sistema exibe mensagem 'Usuário inativado. Ele não aparecerá em listagens ativas.'"
        resultado: "usuario_inativado"
        regras: ["RN-RF012-02"]

      - id: "FA-UC03-04"
        condicao: "resetar_senha_mfa"
        passos:
          - "Admin clica em 'Resetar Senha e MFA'"
          - "Sistema gera senha temporária aleatória (ex: 'Temp@2025!123')"
          - "Sistema criptografa senha com BCrypt"
          - "Sistema gera novo secret TOTP"
          - "Sistema atualiza Estado = first_access"
          - "Sistema exibe mensagem 'Senha resetada. Usuário deve fazer primeiro acesso e configurar MFA.'"
          - "Sistema exibe senha temporária (apenas uma vez)"
        resultado: "senha_mfa_resetados"
        regras: ["RN-RF012-08", "RN-RF012-09"]

    fluxos_excecao:
      - id: "FE-UC03-01"
        condicao: "email_duplicado"
        passos:
          - "Sistema valida email único (WHERE EmpresaId = X AND Email = Y AND Id != Z)"
          - "Sistema encontra outro usuário com mesmo email"
          - "Sistema retorna HTTP 400 Bad Request"
          - "Sistema exibe mensagem 'Email já cadastrado para outro usuário.'"
        resultado: "validacao_falhou"
        regras: ["RN-RF012-03"]

      - id: "FE-UC03-02"
        condicao: "transicao_invalida"
        passos:
          - "Sistema valida transição de estado (ex: deleted → active = PROIBIDO)"
          - "Sistema detecta transição inválida"
          - "Sistema retorna HTTP 400 Bad Request"
          - "Sistema exibe mensagem 'Transição de estado inválida: deleted → active não permitida.'"
        resultado: "validacao_falhou"
        regras: ["RN-RF012-02"]

    regras_aplicadas:
      - "RN-RF012-01"
      - "RN-RF012-02"
      - "RN-RF012-03"
      - "RN-RF012-04"
      - "RN-RF012-05"
      - "RN-RF012-06"
      - "RN-RF012-08"
      - "RN-RF012-09"
      - "RN-RF012-12"
      - "RN-RF012-15"

    resultado_final:
      estado: "usuario_atualizado"


  - id: "UC04"
    nome: "Excluir Usuário"
    ator_principal: "usuario_autenticado"
    tipo: "crud"
    impacta_dados: true

    covers:
      rf_items:
        - "RN-RF012-01"  # Multi-tenancy
        - "RN-RF012-02"  # Estado deleted (soft delete)
      uc_items:
        - id: "FP-UC04-001"
          title: "Usuário solicita exclusão"
          required: true
        - id: "FP-UC04-002"
          title: "Sistema valida permissão CAD.USUARIOS.DELETE"
          required: true
        - id: "FP-UC04-003"
          title: "Sistema exibe confirmação"
          required: true
        - id: "FP-UC04-004"
          title: "Usuário confirma exclusão"
          required: true
        - id: "FP-UC04-005"
          title: "Sistema valida multi-tenancy"
          required: true
        - id: "FP-UC04-006"
          title: "Sistema executa soft delete (Estado=deleted)"
          required: true
        - id: "FP-UC04-007"
          title: "Sistema registra auditoria"
          required: true
        - id: "FP-UC04-008"
          title: "Sistema confirma sucesso"
          required: true
        - id: "FA-UC04-001"
          title: "Exclusão permanente (hard delete)"
          required: false
        - id: "FE-UC04-001"
          title: "Usuário não encontrado → HTTP 404"
          required: true
        - id: "FE-UC04-002"
          title: "Usuário de outro tenant → HTTP 403"
          required: true
        - id: "FE-UC04-003"
          title: "Tentativa de deletar a si mesmo → HTTP 400"
          required: true

    precondicoes:
      - permissao: "CAD.USUARIOS.DELETE"
      - usuario_autenticado: true

    gatilho: "Usuário clica em 'Excluir' no detalhe do usuário (UC02)"

    fluxo_principal:
      - passo: 1
        ator: "sistema"
        acao: "exibir_confirmacao"
        mensagem: "Tem certeza que deseja excluir o usuário {Nome}? Esta ação é reversível."
      - passo: 2
        ator: "usuario"
        acao: "confirmar_exclusao"
      - passo: 3
        ator: "sistema"
        acao: "validar_permissao"
        permissao: "CAD.USUARIOS.DELETE"
      - passo: 4
        ator: "sistema"
        acao: "validar_multi_tenancy"
        regras: ["RN-RF012-01"]
      - passo: 5
        ator: "sistema"
        acao: "validar_nao_deletar_proprio"
      - passo: 6
        ator: "sistema"
        acao: "executar_soft_delete"
        acao_real: "UPDATE Usuario SET Estado = 'deleted' WHERE Id = X"
      - passo: 7
        ator: "sistema"
        acao: "registrar_auditoria"
      - passo: 8
        ator: "sistema"
        acao: "exibir_mensagem"
        mensagem: "Usuário excluído com sucesso."

    fluxos_alternativos:
      - id: "FA-UC04-01"
        condicao: "exclusao_permanente"
        passos:
          - "Super Admin clica em 'Exclusão Permanente' (botão vermelho, confirmação dupla)"
          - "Sistema exibe confirmação: 'ATENÇÃO: Esta ação é IRREVERSÍVEL. Digite CONFIRMAR para prosseguir.'"
          - "Admin digita 'CONFIRMAR'"
          - "Sistema valida permissão CAD.USUARIOS.PERMANENT_DELETE"
          - "Sistema executa DELETE FROM Usuario WHERE Id = X (hard delete)"
          - "Sistema exclui registros relacionados (UsuarioPerfil, HistoricoSenhas, etc.)"
          - "Sistema registra auditoria com severidade CRITICAL"
        resultado: "usuario_deletado_permanentemente"
        permissao_extra: "CAD.USUARIOS.PERMANENT_DELETE"

    fluxos_excecao:
      - id: "FE-UC04-01"
        condicao: "usuario_nao_encontrado"
        passos:
          - "Sistema busca usuário pelo ID"
          - "Sistema não encontra registro"
          - "Sistema retorna HTTP 404 Not Found"
        resultado: "usuario_nao_encontrado"

      - id: "FE-UC04-02"
        condicao: "usuario_outro_tenant"
        passos:
          - "Sistema valida multi-tenancy (EmpresaId)"
          - "Sistema detecta que EmpresaId do usuário ≠ EmpresaId do current_user"
          - "Sistema retorna HTTP 403 Forbidden"
          - "Sistema exibe mensagem 'Acesso negado.'"
        resultado: "acesso_negado_multi_tenancy"
        regras: ["RN-RF012-01"]

      - id: "FE-UC04-03"
        condicao: "deletar_proprio"
        passos:
          - "Sistema valida que Id do usuário a deletar ≠ Id do current_user"
          - "Sistema detecta que usuário está tentando deletar a si mesmo"
          - "Sistema retorna HTTP 400 Bad Request"
          - "Sistema exibe mensagem 'Você não pode excluir seu próprio usuário.'"
        resultado: "validacao_falhou"

    regras_aplicadas:
      - "RN-RF012-01"
      - "RN-RF012-02"

    resultado_final:
      estado: "usuario_excluido"


  - id: "UC08"
    nome: "Gerenciar Usuários do Perfil"
    ator_principal: "admin_usuarios"
    tipo: "acao"
    impacta_dados: true

    covers:
      rf_items:
        - "RN-RF012-01"  # Multi-tenancy
        - "RN-RF012-15"  # Atribuição de perfis
      uc_items:
        - id: "FP-UC08-001"
          title: "Admin acessa gestão de perfis"
          required: true
        - id: "FP-UC08-002"
          title: "Sistema valida permissão CAD.PERFIS.UPDATE"
          required: true
        - id: "FP-UC08-003"
          title: "Sistema exibe perfis e usuários vinculados"
          required: true
        - id: "FP-UC08-004"
          title: "Admin adiciona usuário ao perfil"
          required: true
        - id: "FP-UC08-005"
          title: "Sistema valida multi-tenancy"
          required: true
        - id: "FP-UC08-006"
          title: "Sistema cria vínculo UsuarioPerfil"
          required: true
        - id: "FP-UC08-007"
          title: "Sistema confirma sucesso"
          required: true
        - id: "FA-UC08-001"
          title: "Remover usuário do perfil"
          required: true
        - id: "FA-UC08-002"
          title: "Atribuir múltiplos perfis a um usuário"
          required: true
        - id: "FE-UC08-001"
          title: "Usuário sem permissão → HTTP 403"
          required: true
        - id: "FE-UC08-002"
          title: "Usuário já possui perfil → HTTP 400"
          required: true

    precondicoes:
      - permissao: "CAD.PERFIS.UPDATE"
      - perfil: ["Super Admin", "Admin Usuários"]

    gatilho: "Admin acessa 'Gestão de Perfis' no menu"

    fluxo_principal:
      - passo: 1
        ator: "admin"
        acao: "acessa_gestao_perfis"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
        permissao: "CAD.PERFIS.UPDATE"
      - passo: 3
        ator: "sistema"
        acao: "exibir_perfis_tenant"
        filtro: "WHERE EmpresaId = current_user.EmpresaId"
      - passo: 4
        ator: "admin"
        acao: "selecionar_perfil"
        exemplo: "Admin seleciona 'Operador'"
      - passo: 5
        ator: "sistema"
        acao: "exibir_usuarios_perfil"
        query: "SELECT * FROM UsuarioPerfil WHERE PerfilId = X"
      - passo: 6
        ator: "admin"
        acao: "clicar_adicionar_usuario"
      - passo: 7
        ator: "sistema"
        acao: "exibir_lista_usuarios_disponiveis"
        filtro: "Usuários do tenant que NÃO possuem o perfil selecionado"
      - passo: 8
        ator: "admin"
        acao: "selecionar_usuario"
      - passo: 9
        ator: "sistema"
        acao: "criar_vinculo_usuario_perfil"
        acao_real: "INSERT INTO UsuarioPerfil (UsuarioId, PerfilId) VALUES (X, Y)"
      - passo: 10
        ator: "sistema"
        acao: "registrar_auditoria"

    fluxos_alternativos:
      - id: "FA-UC08-01"
        condicao: "remover_usuario_perfil"
        passos:
          - "Admin clica em 'Remover' ao lado do usuário no perfil"
          - "Sistema exibe confirmação"
          - "Admin confirma remoção"
          - "Sistema deleta vínculo (DELETE FROM UsuarioPerfil WHERE UsuarioId = X AND PerfilId = Y)"
          - "Sistema registra auditoria"
          - "Sistema exibe mensagem 'Usuário removido do perfil com sucesso.'"
        resultado: "usuario_removido_perfil"
        regras: ["RN-RF012-15"]

      - id: "FA-UC08-02"
        condicao: "atribuir_multiplos_perfis"
        passos:
          - "Admin acessa detalhe do usuário (UC02)"
          - "Admin clica em 'Gerenciar Perfis'"
          - "Sistema exibe multiselect com perfis disponíveis"
          - "Admin seleciona múltiplos perfis (ex: ['Operador', 'Consultor'])"
          - "Sistema cria múltiplos vínculos UsuarioPerfil"
          - "Sistema exibe mensagem 'Perfis atribuídos com sucesso.'"
        resultado: "multiplos_perfis_atribuidos"
        regras: ["RN-RF012-15"]

    fluxos_excecao:
      - id: "FE-UC08-01"
        condicao: "sem_permissao"
        passos:
          - "Sistema verifica que usuário não possui CAD.PERFIS.UPDATE"
          - "Sistema retorna HTTP 403 Forbidden"
          - "Sistema exibe mensagem 'Acesso negado.'"
        resultado: "acesso_negado"

      - id: "FE-UC08-02"
        condicao: "usuario_ja_possui_perfil"
        passos:
          - "Sistema verifica se vínculo já existe (SELECT * FROM UsuarioPerfil WHERE UsuarioId = X AND PerfilId = Y)"
          - "Sistema encontra vínculo existente"
          - "Sistema retorna HTTP 400 Bad Request"
          - "Sistema exibe mensagem 'Usuário já possui este perfil.'"
        resultado: "validacao_falhou"

    regras_aplicadas:
      - "RN-RF012-01"
      - "RN-RF012-15"

    resultado_final:
      estado: "perfil_usuario_atualizado"


exclusions:
  uc_items: []
  justificativa: |
    Nenhum caso de uso foi excluído. Todos os 6 UCs (UC00, UC01, UC02, UC03, UC04, UC08) são necessários
    para cobertura completa do RF-012.
    Nota: UC05, UC06, UC07 não existem no RF-012 (numeração pula de UC04 para UC08).


historico:
  - versao: "2.0"
    data: "2025-12-31"
    autor: "Agência ALC - alc.dev.br"
    descricao: |
      Versão 2.0 - 6 UCs cobrindo 100% das 17 regras de negócio do RF-012.
      UCs:
      - UC00: Listar Usuários (RN-RF012-01, 02, 15)
      - UC01: Criar Usuário com MFA obrigatório (RN-RF012-01, 03-09, 14, 15)
      - UC02: Visualizar Usuário com auditoria (RN-RF012-01, 02, 11, 15, 17)
      - UC03: Editar Usuário com transições de estado (RN-RF012-01-06, 08, 09, 12, 15)
      - UC04: Excluir Usuário (soft delete) (RN-RF012-01, 02)
      - UC08: Gerenciar Usuários do Perfil (RN-RF012-01, 15)

      Cobertura de regras:
      - RN-RF012-01 (Multi-tenancy): UC00, UC01, UC02, UC03, UC04, UC08 ✅
      - RN-RF012-02 (Estados): UC00, UC02, UC03, UC04 ✅
      - RN-RF012-03 (Email único): UC01, UC03 ✅
      - RN-RF012-04 (Username único): UC01, UC03 ✅
      - RN-RF012-05 (Validação email): UC01, UC03 ✅
      - RN-RF012-06 (Validação username): UC01, UC03 ✅
      - RN-RF012-07 (Política senha): UC01 ✅
      - RN-RF012-08 (MFA obrigatório): UC01, UC03 ✅
      - RN-RF012-09 (BCrypt): UC01, UC03 ✅
      - RN-RF012-10 (Expiração 90d): IMPLÍCITO (regra de sistema)
      - RN-RF012-11 (Histórico 12 senhas): UC02 ✅
      - RN-RF012-12 (Auto-bloqueio 5 tentativas): UC03 ✅
      - RN-RF012-13 (Login suspeito): IMPLÍCITO (regra de sistema)
      - RN-RF012-14 (AD/LDAP): UC01 ✅
      - RN-RF012-15 (RBAC): UC00, UC01, UC02, UC03, UC08 ✅
      - RN-RF012-16 (JWT): IMPLÍCITO (regra de sistema)
      - RN-RF012-17 (Auditoria): UC02 ✅

      Todas as 17 regras cobertas ✅
