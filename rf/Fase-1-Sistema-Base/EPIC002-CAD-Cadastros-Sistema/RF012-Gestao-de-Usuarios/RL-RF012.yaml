# =============================================
# RL-RF012 ‚Äî Refer√™ncia ao Legado
# Gest√£o de Usu√°rios do Sistema
# Vers√£o: 1.0
# Data: 2025-12-30
# Autor: Ag√™ncia ALC - alc.dev.br
# =============================================

rf_id: RF012
titulo: "Gest√£o de Usu√°rios do Sistema"

legado:
  sistema: "VB.NET + ASP.NET Web Forms (IControlIT v1.0)"
  versao: "1.0"
  arquitetura: "Monol√≠tica ASP.NET Web Forms"
  banco_dados: "SQL Server"
  multi_tenant: true
  auditoria: "partial"  # Apenas Dt_Ultimo_Acesso, sem logs detalhados

# =============================================
# PROBLEMAS IDENTIFICADOS NO LEGADO (10)
# =============================================
problemas_legado:
  - id: "PROB-001"
    titulo: "Seguran√ßa de Senhas (MD5 Inseguro)"
    descricao: "MD5 √© algoritmo quebrado desde 2004, facilmente revers√≠vel com rainbow tables. N√£o oferece seguran√ßa adequada para senhas."
    gravidade: "critica"
    destino: "substituido"
    justificativa: "Substitu√≠do por BCrypt work factor 12. Migra√ß√£o obrigat√≥ria for√ßando troca de senha no primeiro login p√≥s-migra√ß√£o."

  - id: "PROB-002"
    titulo: "SQL Injection"
    descricao: "Uso de SQL din√¢mico via classe cls_DB sem parametriza√ß√£o adequada. Vulner√°vel a ataques SQL Injection."
    gravidade: "critica"
    destino: "substituido"
    justificativa: "Substitu√≠do por Entity Framework Core com queries parametrizadas (LINQ, Raw SQL parametrizado)."

  - id: "PROB-003"
    titulo: "Performance (ViewState Pesado)"
    descricao: "ViewState do ASP.NET Web Forms adiciona 50-200KB por request. PostBacks constantes degradam UX."
    gravidade: "alta"
    destino: "substituido"
    justificativa: "Substitu√≠do por Angular SPA sem ViewState. Comunica√ß√£o via API REST."

  - id: "PROB-004"
    titulo: "Auditoria Limitada"
    descricao: "Apenas campo Dt_Ultimo_Acesso na tabela Usuario. Sem hist√≥rico de altera√ß√µes, sem logs de acesso (sucesso/falha), sem IP/geolocaliza√ß√£o."
    gravidade: "alta"
    destino: "substituido"
    justificativa: "Criada tabela Usuario_Historico_Acesso com auditoria completa (IP, geolocaliza√ß√£o, dispositivo, motivo falha)."

  - id: "PROB-005"
    titulo: "Permiss√µes Simplificadas"
    descricao: "RadioButtonLists com apenas 2 valores (Revogar/Permitir). Falta granularidade. Permiss√µes armazenadas em campos separados (n√£o extens√≠vel)."
    gravidade: "media"
    destino: "substituido"
    justificativa: "Substitu√≠do por campo Permissoes_Customizadas (JSON) permitindo permiss√µes granulares extens√≠veis."

  - id: "PROB-006"
    titulo: "Falta MFA"
    descricao: "Nenhuma autentica√ß√£o de dois fatores. Vulner√°vel a roubo de credenciais."
    gravidade: "alta"
    destino: "substituido"
    justificativa: "Implementado MFA via TOTP (RFC 6238) com QR Code para Google Authenticator/Authy."

  - id: "PROB-007"
    titulo: "Falta Detec√ß√£o de Login Suspeito"
    descricao: "Sem geolocaliza√ß√£o de IP, sem alertas de login an√¥malo (pa√≠s diferente, hor√°rio incomum)."
    gravidade: "media"
    destino: "substituido"
    justificativa: "Implementado detec√ß√£o com geolocaliza√ß√£o via API ipapi.co. Notifica√ß√£o por e-mail em caso de suspeita."

  - id: "PROB-008"
    titulo: "Sem Hist√≥rico de Senhas (Reutiliza√ß√£o Infinita)"
    descricao: "Tabela Usuario_Historico_Senha existe mas sem limite de registros e sem valida√ß√£o de reutiliza√ß√£o."
    gravidade: "media"
    destino: "substituido"
    justificativa: "Implementado limite de 12 senhas com valida√ß√£o obrigat√≥ria de n√£o-reutiliza√ß√£o."

  - id: "PROB-009"
    titulo: "Sem Integra√ß√£o Active Directory"
    descricao: "Cada usu√°rio deve ser criado manualmente no IControlIT. Duplica√ß√£o de esfor√ßo em empresas com AD corporativo."
    gravidade: "baixa"
    destino: "substituido"
    justificativa: "Implementada integra√ß√£o AD via LDAP (PrincipalContext) com sincroniza√ß√£o autom√°tica de dados."

  - id: "PROB-010"
    titulo: "Sess√µes sem Limite"
    descricao: "N√£o h√° controle de m√∫ltiplas sess√µes simult√¢neas por usu√°rio. Usu√°rio pode logar em infinitos dispositivos."
    gravidade: "baixa"
    destino: "substituido"
    justificativa: "Implementado limite de 5 sess√µes simult√¢neas (6¬™ sess√£o invalida a mais antiga)."

# =============================================
# REFER√äNCIAS AO LEGADO (Destino Obrigat√≥rio)
# =============================================
referencias:
  - id: "LEG-RF012-001"
    tipo: "webservice"
    nome: "WSAuth.asmx.vb::Login()"
    caminho: "ic1_legado/IControlIT/WS/WSAuth.asmx.vb"
    descricao: |
      Autentica usu√°rio via credenciais (login/senha MD5).
      Retorna session cookie ASP.NET.
      Wrapper para WSUsuario.Autenticar().
    destino: "substituido"
    justificativa: "Substitu√≠do por endpoint REST POST /api/auth/login retornando JWT tokens (access + refresh)."
    rf_item_relacionado: "RN-RF012-05"
    uc_relacionado: "UC02-RF012"

  - id: "LEG-RF012-002"
    tipo: "webservice"
    nome: "WSAuth.asmx.vb::Logout()"
    caminho: "ic1_legado/IControlIT/WS/WSAuth.asmx.vb"
    descricao: |
      Invalida sess√£o ASP.NET e limpa cookies de autentica√ß√£o.
    destino: "substituido"
    justificativa: "Substitu√≠do por endpoint REST POST /api/auth/logout que revoga refresh token."
    rf_item_relacionado: "RN-RF012-12"
    uc_relacionado: "UC02-RF012"

  - id: "LEG-RF012-003"
    tipo: "webservice"
    nome: "WSUsuario.asmx.vb::Autenticar()"
    caminho: "ic1_legado/IControlIT/WS/WSUsuario.asmx.vb"
    descricao: |
      Valida credenciais usando MD5 hash.
      Incrementa Tentativas_Falhas, bloqueia ap√≥s 5 tentativas.
      Atualiza Dt_Ultimo_Acesso em caso de sucesso.
      Retorna DataSet com dados do usu√°rio.
    destino: "substituido"
    justificativa: "Substitu√≠do por endpoint POST /api/auth/login com BCrypt, JWT e auditoria completa em Usuario_Historico_Acesso."
    rf_item_relacionado: "RN-RF012-02, RN-RF012-03, RN-RF012-13"
    uc_relacionado: "UC02-RF012"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF012-004"
    tipo: "webservice"
    nome: "WSUsuario.asmx.vb::Listar_Usuarios()"
    caminho: "ic1_legado/IControlIT/WS/WSUsuario.asmx.vb"
    descricao: |
      Lista usu√°rios com filtros opcionais (perfil, status).
      Retorna DataSet com campos: Id_Usuario, Nm_Usuario, Email, Login, Nm_Perfil, Fl_Ativo, Fl_Bloqueado.
    destino: "substituido"
    justificativa: "Substitu√≠do por endpoint REST GET /api/usuarios com pagina√ß√£o, filtros avan√ßados e resposta JSON."
    rf_item_relacionado: "Funcionalidade CRUD (Se√ß√£o 4)"
    uc_relacionado: "UC00-RF012"

  - id: "LEG-RF012-005"
    tipo: "webservice"
    nome: "WSUsuario.asmx.vb::Criar_Usuario()"
    caminho: "ic1_legado/IControlIT/WS/WSUsuario.asmx.vb"
    descricao: |
      Cria novo usu√°rio com senha tempor√°ria.
      Define Fl_Primeiro_Acesso = 1 para for√ßar troca.
      Valida unicidade de login e email no conglomerado.
    destino: "substituido"
    justificativa: "Substitu√≠do por endpoint REST POST /api/usuarios com valida√ß√£o FluentValidation e senha tempor√°ria BCrypt."
    rf_item_relacionado: "RN-RF012-01, RN-RF012-14"
    uc_relacionado: "UC01-RF012"

  - id: "LEG-RF012-006"
    tipo: "webservice"
    nome: "WSUsuario.asmx.vb::Alterar_Senha()"
    caminho: "ic1_legado/IControlIT/WS/WSUsuario.asmx.vb"
    descricao: |
      Valida senha atual (MD5), atualiza com novo MD5.
      Registra no hist√≥rico Usuario_Historico_Senha (sem limite).
      Define Dt_Expiracao_Senha para 90 dias no futuro.
    destino: "substituido"
    justificativa: "Substitu√≠do por endpoint REST PUT /api/usuarios/{id}/senha com BCrypt, valida√ß√£o de for√ßa de senha e hist√≥rico limitado (12 senhas)."
    rf_item_relacionado: "RN-RF012-02, RN-RF012-07, RN-RF012-04"
    uc_relacionado: "UC02-RF012"
    complexidade: "alta"
    risco_migracao: "medio"

  - id: "LEG-RF012-007"
    tipo: "webservice"
    nome: "WSUsuario.asmx.vb::Desbloquear_Usuario()"
    caminho: "ic1_legado/IControlIT/WS/WSUsuario.asmx.vb"
    descricao: |
      Desbloqueia usu√°rio bloqueado por tentativas falhas.
      Zera Tentativas_Falhas, define Fl_Bloqueado = 2, limpa Dt_Bloqueio.
    destino: "substituido"
    justificativa: "Substitu√≠do por endpoint REST POST /api/usuarios/{id}/unlock com adi√ß√£o de desbloqueio autom√°tico ap√≥s 15 minutos."
    rf_item_relacionado: "RN-RF012-03"
    uc_relacionado: "UC03-RF012"

  - id: "LEG-RF012-008"
    tipo: "tela"
    nome: "Usuario.aspx"
    caminho: "ic1_legado/IControlIT/Cadastro/Usuario.aspx"
    descricao: |
      Tela de CRUD de usu√°rios usando ASP.NET Web Forms com AjaxControlToolkit.
      15 campos (Login, Senha, Idioma, Grupo, Perfil, Acesso, Permiss√µes, Detalhamento, Status, Nome, Chave).
      Valida√ß√£o RequiredFieldValidator + ValidatorCalloutExtender.
      AutoPostBack no campo Perfil (reload p√°gina).
      ViewState pesado (50-100KB).
    destino: "substituido"
    justificativa: "Substitu√≠do por telas Angular 19 Standalone Components com Reactive Forms, valida√ß√£o client-side e comunica√ß√£o API REST."
    rf_item_relacionado: "Funcionalidade CRUD (Se√ß√£o 4), WF-RF012.md"
    uc_relacionado: "UC00-RF012, UC01-RF012, UC03-RF012"
    complexidade: "alta"
    risco_migracao: "medio"

  - id: "LEG-RF012-009"
    tipo: "stored_procedure"
    nome: "sp_Validar_Usuario_Login"
    caminho: "Database/dbo.sp_Validar_Usuario_Login"
    descricao: |
      Stored procedure que valida login/senha usando MD5.
      Chamada por WSUsuario.Autenticar().
    destino: "descartado"
    justificativa: "L√≥gica migrada para Application Layer (.NET 10) usando Entity Framework Core e BCrypt. Stored procedures de l√≥gica de neg√≥cio violam Clean Architecture."
    rf_item_relacionado: null
    uc_relacionado: null

  - id: "LEG-RF012-010"
    tipo: "stored_procedure"
    nome: "sp_Bloquear_Usuario_Automatico"
    caminho: "Database/dbo.sp_Bloquear_Usuario_Automatico"
    descricao: |
      Stored procedure que bloqueia usu√°rio ap√≥s 5 tentativas falhas.
      Chamada por WSUsuario.Autenticar().
    destino: "descartado"
    justificativa: "L√≥gica migrada para Application Layer usando Commands/Handlers (MediatR). Manutenibilidade superior."
    rf_item_relacionado: null
    uc_relacionado: null

  - id: "LEG-RF012-011"
    tipo: "stored_procedure"
    nome: "sp_Sincronizar_Usuario_AD"
    caminho: "Database/dbo.sp_Sincronizar_Usuario_AD"
    descricao: |
      Stored procedure que sincroniza dados do Active Directory.
      (Se existir no legado - verificar).
    destino: "descartado"
    justificativa: "L√≥gica migrada para Application Layer usando PrincipalContext (.NET) ou Microsoft Graph API."
    rf_item_relacionado: null
    uc_relacionado: null

# =============================================
# TELAS LEGADAS (Detalhamento)
# =============================================
telas:
  - id: "LEG-RF012-008"
    nome: "Usuario.aspx"
    caminho: "ic1_legado/IControlIT/Cadastro/Usuario.aspx"
    responsabilidade: "CRUD de usu√°rios do sistema com gest√£o b√°sica de permiss√µes"
    campos:
      - nome: "Login (txtDescricao)"
        tipo: "TextBox"
        obrigatorio: true
        validacao: "RequiredFieldValidator, MaxLength=50, √∫nico por conglomerado"

      - nome: "Senha (btnReiniciarSenha)"
        tipo: "Button"
        obrigatorio: false
        validacao: "Confirma√ß√£o JavaScript, gera senha tempor√°ria"

      - nome: "Idioma (cboIdioma)"
        tipo: "DropDownList"
        obrigatorio: true
        validacao: "RequiredFieldValidator"

      - nome: "Grupo (cboUsuarioGrupo)"
        tipo: "DropDownList"
        obrigatorio: true
        validacao: "RequiredFieldValidator"

      - nome: "Perfil (cboUsuarioPerfil)"
        tipo: "DropDownList"
        obrigatorio: true
        validacao: "RequiredFieldValidator, AutoPostBack=true (reload p√°gina)"

      - nome: "Acesso (cboUsuarioPerfilAcesso)"
        tipo: "DropDownList"
        obrigatorio: true
        validacao: "RequiredFieldValidator"

      - nome: "Permiss√£o de Incluir (optIncluir)"
        tipo: "RadioButtonList"
        obrigatorio: false
        validacao: "1=Revogar, 2=Permitir"

      - nome: "Permiss√£o de Alterar (optAlterar)"
        tipo: "RadioButtonList"
        obrigatorio: false
        validacao: "1=Revogar, 2=Permitir"

      - nome: "Permiss√£o de Excluir (optExcluir)"
        tipo: "RadioButtonList"
        obrigatorio: false
        validacao: "1=Revogar, 2=Permitir"

      - nome: "Conta de outro usu√°rio (optDetalhamentoConta)"
        tipo: "RadioButtonList"
        obrigatorio: false
        validacao: "1=Revogar, 2=Permitir (controla Detalhamento_Conta)"

      - nome: "Contatos de outro usu√°rio (optDetalhamentoContato)"
        tipo: "RadioButtonList"
        obrigatorio: false
        validacao: "1=Revogar, 2=Permitir (controla Detalhamento_Contato)"

      - nome: "Status para acesso (optStatusUsuario)"
        tipo: "RadioButtonList"
        obrigatorio: false
        validacao: "1=Revogar, 3=Permitir (valor 3 espec√≠fico legado)"

      - nome: "Permiss√£o para Requisi√ß√£o"
        tipo: "ListBox Duplo"
        obrigatorio: false
        validacao: "Origem/Destino com bot√µes de mover (UI antiga)"

      - nome: "Nome (txtNmConsumidor)"
        tipo: "TextBox"
        obrigatorio: false
        validacao: "Readonly, vincula√ß√£o opcional com consumidor"

      - nome: "Chave do banco (txtIdentificacao)"
        tipo: "TextBox"
        obrigatorio: false
        validacao: "Readonly, exibe GUID do usu√°rio"

    comportamentos_implicitos:
      - "AutoPostBack no Perfil recarrega p√°gina (ruim para UX)"
      - "Senha Tempor√°ria gerada ao clicar bot√£o Reiniciar com confirm() JS"
      - "ViewState pesado (50-100KB) em todos os DropDownLists e RadioButtonLists"
      - "ValidatorCalloutExtender (AjaxControlToolkit) para feedback visual de erros"

# =============================================
# TABELAS LEGADAS
# =============================================
tabelas:
  - nome: "Usuario"
    finalidade: "Armazenar dados de usu√°rios do sistema com autentica√ß√£o e permiss√µes"
    problemas:
      - "Password_Hash usa MD5 (inseguro)"
      - "Falta campos MFA (MFA_Secret, Fl_MFA_Habilitado, Telefone_MFA)"
      - "Falta campos Active Directory (AD_Object_GUID, AD_Sam_Account_Name, Fl_Usuario_AD)"
      - "Falta campo Permissoes_Customizadas (JSON)"
      - "Fl_Ativo usa valores 1/2 (esperado 0/1 boolean)"
      - "Fl_Bloqueado usa valores 1/2 (esperado 0/1 boolean)"
      - "Fl_Desativado usa valores 1/2/3 (sem valida√ß√£o CHECK)"
      - "Detalhamento_Conta e Detalhamento_Contato sem valida√ß√£o CHECK (aceita qualquer INT)"

  - nome: "Usuario_Historico_Senha"
    finalidade: "Hist√≥rico de senhas alteradas (prevenir reutiliza√ß√£o)"
    problemas:
      - "Sem limite de registros (pode crescer infinitamente)"
      - "N√£o h√° valida√ß√£o no c√≥digo legado para prevenir reutiliza√ß√£o das √∫ltimas 12 senhas"
      - "Hashes armazenados em MD5 (inseguro)"

  - nome: "(inexistente) Usuario_Sessao"
    finalidade: "[Nova] Armazenar sess√µes ativas (JWT refresh tokens, dispositivo, geolocaliza√ß√£o)"
    problemas:
      - "N√£o existe no legado. Legado usa ASP.NET Session State (in-memory ou SQL Server)"

  - nome: "(inexistente) Usuario_Historico_Acesso"
    finalidade: "[Nova] Auditoria de todos os acessos (sucesso/falha, IP, geolocaliza√ß√£o)"
    problemas:
      - "N√£o existe no legado. Apenas campo Dt_Ultimo_Acesso na tabela Usuario"

  - nome: "(inexistente) Usuario_Reset_Senha"
    finalidade: "[Nova] Tokens de reset de senha via e-mail (v√°lido 1h, uso √∫nico)"
    problemas:
      - "N√£o existe no legado. Reset feito manualmente por admin via bot√£o Reiniciar Senha"

# =============================================
# REGRAS DE NEG√ìCIO IMPL√çCITAS NO LEGADO
# =============================================
regras_implicitas:
  - id: "RL-RN-001"
    descricao: "Bloqueio ap√≥s 5 tentativas falhas (sem desbloqueio autom√°tico, apenas manual)"
    fonte: "WSUsuario.asmx.vb::Autenticar() linhas 45-60"
    destino: "substituido"
    justificativa: "Substitu√≠do com desbloqueio autom√°tico ap√≥s 15 minutos (RN-RF012-03)"

  - id: "RL-RN-002"
    descricao: "Senha MD5 sem valida√ß√£o de for√ßa (aceita qualquer senha, inclusive '123')"
    fonte: "WSUsuario.asmx.vb::Alterar_Senha() linhas 120-135"
    destino: "substituido"
    justificativa: "Substitu√≠do com pol√≠tica de senha forte: m√≠nimo 8 chars, mai√∫scula, min√∫scula, n√∫mero, especial (RN-RF012-02)"

  - id: "RL-RN-003"
    descricao: "Expira√ß√£o de senha 90 dias (sem notifica√ß√£o antecipada)"
    fonte: "WSUsuario.asmx.vb::Alterar_Senha() linha 145"
    destino: "assumido"
    justificativa: "Assumido com adi√ß√£o de notifica√ß√£o 7 dias antes da expira√ß√£o (RN-RF012-04)"

  - id: "RL-RN-004"
    descricao: "Detalhamento de Conta/Contato (valores 1=B√°sico, 2=Intermedi√°rio, 3=Completo)"
    fonte: "Stored procedure pa_Usuario linhas 78-92"
    destino: "assumido"
    justificativa: "Assumido com adi√ß√£o de constraint CHECK no banco (valores 1, 2 ou 3 apenas) (RN-RF012-16)"

  - id: "RL-RN-005"
    descricao: "Status Desativado (1=Ativo, 2=Inativo, 3=Desativado Permanente sem valida√ß√£o de permiss√£o)"
    fonte: "Stored procedure pa_Usuario linhas 103-115"
    destino: "substituido"
    justificativa: "Substitu√≠do com permiss√£o espec√≠fica usuarios:reativar_permanente (apenas Super Admin) (RN-RF012-17)"

  - id: "RL-RN-006"
    descricao: "Permiss√µes customizadas via RadioButtonList (Incluir/Alterar/Excluir) em campos separados"
    fonte: "Tela Usuario.aspx controles optIncluir, optAlterar, optExcluir"
    destino: "substituido"
    justificativa: "Substitu√≠do com campo Permissoes_Customizadas (JSON) permitindo permiss√µes granulares extens√≠veis (RN-RF012-06)"

# =============================================
# GAP ANALYSIS (LEGADO x MODERNO)
# =============================================
gap_analysis:
  - item: "Hash de Senha"
    existe_legado: true
    valor_legado: "MD5 (inseguro)"
    existe_moderno: true
    valor_moderno: "BCrypt work factor 12"
    notas: "‚ö†Ô∏è Migra√ß√£o obrigat√≥ria for√ßando troca de senha no primeiro login"

  - item: "MFA"
    existe_legado: false
    existe_moderno: true
    valor_moderno: "TOTP via Google Authenticator/Authy"
    notas: "üÜï Nova funcionalidade"

  - item: "Hist√≥rico de Senhas"
    existe_legado: true
    valor_legado: "Sem limite de registros"
    existe_moderno: true
    valor_moderno: "√öltimas 12 senhas (limite fixo)"
    notas: "‚ö†Ô∏è Limpeza de hist√≥rico legado + migra√ß√£o MD5‚ÜíBCrypt"

  - item: "Preven√ß√£o Reutiliza√ß√£o Senha"
    existe_legado: false
    existe_moderno: true
    valor_moderno: "Pro√≠be reutiliza√ß√£o das √∫ltimas 12"
    notas: "üÜï Nova regra (RN-RF012-07)"

  - item: "Active Directory"
    existe_legado: false
    existe_moderno: true
    valor_moderno: "Autentica√ß√£o LDAP + sincroniza√ß√£o autom√°tica"
    notas: "üÜï Nova integra√ß√£o (RN-RF012-09)"

  - item: "Detec√ß√£o Login Suspeito"
    existe_legado: false
    existe_moderno: true
    valor_moderno: "IP/pa√≠s/hor√°rio an√¥malo com notifica√ß√£o e-mail"
    notas: "üÜï Nova funcionalidade (RN-RF012-10)"

  - item: "Auditoria"
    existe_legado: true
    valor_legado: "Apenas Dt_Ultimo_Acesso"
    existe_moderno: true
    valor_moderno: "Hist√≥rico completo (sucesso/falha, IP, geolocaliza√ß√£o, dispositivo)"
    notas: "üÜï Nova tabela Usuario_Historico_Acesso (RN-RF012-13)"

  - item: "Sess√µes M√∫ltiplas"
    existe_legado: true
    valor_legado: "Sem limite"
    existe_moderno: true
    valor_moderno: "M√°ximo 5 sess√µes simult√¢neas"
    notas: "üÜï Nova regra (RN-RF012-12)"

  - item: "Reset Senha"
    existe_legado: true
    valor_legado: "Manual (bot√£o admin)"
    existe_moderno: true
    valor_moderno: "Autom√°tico via e-mail com token (1h v√°lido)"
    notas: "üÜï Nova tabela Usuario_Reset_Senha (RN-RF012-11)"

  - item: "Tokens JWT"
    existe_legado: false
    valor_legado: "Session cookies ASP.NET"
    existe_moderno: true
    valor_moderno: "Access token (8h) + Refresh token (30 dias)"
    notas: "‚ö†Ô∏è Arquitetura completamente diferente"

  - item: "Permiss√µes Customizadas"
    existe_legado: true
    valor_legado: "Campos separados (optIncluir, optAlterar, optExcluir)"
    existe_moderno: true
    valor_moderno: "JSON estruturado em Permissoes_Customizadas"
    notas: "‚ö†Ô∏è Migra√ß√£o de dados necess√°ria"

  - item: "Desbloqueio Autom√°tico"
    existe_legado: false
    existe_moderno: true
    valor_moderno: "Timeout 15 minutos"
    notas: "üÜï Nova regra (RN-RF012-03)"

  - item: "Notifica√ß√£o Senha Expirada"
    existe_legado: false
    existe_moderno: true
    valor_moderno: "E-mail 7 dias antes da expira√ß√£o"
    notas: "üÜï Nova funcionalidade (RN-RF012-04)"

  - item: "Valida√ß√£o For√ßa Senha"
    existe_legado: false
    existe_moderno: true
    valor_moderno: "M√≠nimo 8 chars, mai√∫scula, min√∫scula, n√∫mero, especial"
    notas: "üÜï Nova valida√ß√£o (RN-RF012-02)"

# =============================================
# DECIS√ïES DE MODERNIZA√á√ÉO
# =============================================
decisoes_modernizacao:
  - decisao: "Migra√ß√£o de Senhas MD5 ‚Üí BCrypt"
    motivo: |
      MD5 √© inseguro (quebrado desde 2004), facilmente revers√≠vel com rainbow tables.
      BCrypt √© padr√£o moderno com custo computacional ajust√°vel (work factor 12).
      Estrat√©gia: criar coluna tempor√°ria Password_Hash_MD5, marcar Fl_Primeiro_Acesso=1,
      validar via MD5 no primeiro login p√≥s-migra√ß√£o e gerar BCrypt, limpar backup ap√≥s 90 dias.
    impacto: "alto"
    data: "2025-12-30"

  - decisao: "Substituir Session Cookies por JWT"
    motivo: |
      Session State ASP.NET n√£o escala (depend√™ncia de servidor espec√≠fico).
      JWT permite stateless authentication e suporte a m√∫ltiplos dispositivos.
      Implementar endpoints /api/auth/login (emite JWT) e /api/auth/refresh (renova token).
      Access token 8h, Refresh token 30 dias armazenado em Usuario_Sessao.
    impacto: "alto"
    data: "2025-12-30"

  - decisao: "Criar Tabela Usuario_Historico_Acesso"
    motivo: |
      Legado n√£o possui auditoria de acessos (apenas Dt_Ultimo_Acesso).
      Compliance e seguran√ßa exigem logs detalhados.
      Registrar TODOS os acessos (sucesso/falha) via middleware.
      Integrar com API de geolocaliza√ß√£o (ipapi.co) para detectar pa√≠s/cidade.
      Enviar e-mail se login suspeito.
    impacto: "medio"
    data: "2025-12-30"

  - decisao: "Limite de 12 Senhas no Hist√≥rico"
    motivo: |
      Legado n√£o limita hist√≥rico (pode crescer infinitamente).
      NIST recomenda 12-24 senhas anteriores.
      Ao alterar senha: deletar hash mais antigo se j√° existirem 12 registros.
      Trigger ou l√≥gica aplica√ß√£o para garantir limite.
    impacto: "baixo"
    data: "2025-12-30"

  - decisao: "Integra√ß√£o Active Directory (Opcional)"
    motivo: |
      Empresas grandes possuem AD corporativo.
      Duplicar usu√°rios √© retrabalho.
      Sincroniza√ß√£o autom√°tica reduz overhead administrativo.
      Campo Fl_Usuario_AD=1 indica usu√°rio gerenciado pelo AD.
      Autentica√ß√£o via LDAP (PrincipalContext ou Microsoft Graph API).
      Sincroniza√ß√£o di√°ria (job): atualiza nome, email, grupos.
      Desligamento no AD marca Fl_Ativo=0 no IControlIT.
    impacto: "medio"
    data: "2025-12-30"

  - decisao: "MFA via TOTP (Opcional)"
    motivo: |
      Aumentar seguran√ßa para administradores.
      TOTP √© padr√£o (RFC 6238), compat√≠vel com Google Authenticator, Authy.
      Campo Fl_MFA_Habilitado=1 exige c√≥digo TOTP ap√≥s login com senha.
      Secret armazenado em MFA_Secret (Base32-encoded).
      QR Code gerado via formato otpauth://totp/...
      Janela de valida√ß√£o: ¬±1 per√≠odo (90 segundos total).
    impacto: "baixo"
    data: "2025-12-30"

# =============================================
# RISCOS DE MIGRA√á√ÉO
# =============================================
riscos_migracao:
  - risco: "Usu√°rios n√£o conseguem logar ap√≥s migra√ß√£o MD5‚ÜíBCrypt"
    impacto: "alto"
    probabilidade: "baixa"
    mitigacao: "Testes paralelos, valida√ß√£o MD5 legado no 1¬∫ login, for√ßar troca senha"

  - risco: "Performance degradada (BCrypt mais lento que MD5)"
    impacto: "medio"
    probabilidade: "media"
    mitigacao: "Work factor 12 balanceado, usar async/await, cache em mem√≥ria para permiss√µes"

  - risco: "Hist√≥rico de senhas legado corrompido"
    impacto: "medio"
    probabilidade: "baixa"
    mitigacao: "Validar integridade antes de migrar, manter backup por 90 dias"

  - risco: "API de Geolocaliza√ß√£o indispon√≠vel"
    impacto: "baixo"
    probabilidade: "media"
    mitigacao: "Fallback: registrar apenas IP sem geolocaliza√ß√£o, retry com backoff exponencial"

  - risco: "Active Directory inacess√≠vel"
    impacto: "medio"
    probabilidade: "baixa"
    mitigacao: "Fallback: autentica√ß√£o local (senha BCrypt), job de sincroniza√ß√£o com retry"

  - risco: "JWT tokens roubados (XSS)"
    impacto: "alto"
    probabilidade: "baixa"
    mitigacao: "httpOnly cookies para refresh token, sanitiza√ß√£o de outputs, CSP headers"

  - risco: "Crescimento r√°pido da tabela Usuario_Historico_Acesso"
    impacto: "medio"
    probabilidade: "alta"
    mitigacao: "Particionamento por m√™s, reten√ß√£o de 12 meses, archive para cold storage"

  - risco: "Usu√°rios n√£o entendem MFA"
    impacto: "baixo"
    probabilidade: "media"
    mitigacao: "Tutorial guiado (tooltips), suporte t√©cnico, SMS como backup"

  - risco: "Sess√µes simult√¢neas n√£o invalidadas corretamente"
    impacto: "medio"
    probabilidade: "baixa"
    mitigacao: "Testes E2E, valida√ß√£o de revoga√ß√£o de refresh tokens"

# =============================================
# RASTREABILIDADE (LEGADO ‚Üí MODERNO)
# =============================================
rastreabilidade:
  - elemento_legado: "WSAuth.asmx.vb::Login()"
    referencia_rf: "RN-RF012-02, RN-RF012-05"
    referencia_uc: "UC02-RF012"
    status: "migrado"

  - elemento_legado: "WSAuth.asmx.vb::Logout()"
    referencia_rf: "RN-RF012-12"
    referencia_uc: "UC02-RF012"
    status: "migrado"

  - elemento_legado: "WSUsuario.asmx.vb::Autenticar()"
    referencia_rf: "RN-RF012-02, RN-RF012-03, RN-RF012-13"
    referencia_uc: "UC02-RF012"
    status: "migrado"

  - elemento_legado: "WSUsuario.asmx.vb::Listar_Usuarios()"
    referencia_rf: "Funcionalidade CRUD (Se√ß√£o 4)"
    referencia_uc: "UC00-RF012"
    status: "migrado"

  - elemento_legado: "WSUsuario.asmx.vb::Criar_Usuario()"
    referencia_rf: "RN-RF012-01, RN-RF012-14"
    referencia_uc: "UC01-RF012"
    status: "migrado"

  - elemento_legado: "WSUsuario.asmx.vb::Alterar_Senha()"
    referencia_rf: "RN-RF012-02, RN-RF012-07, RN-RF012-04"
    referencia_uc: "UC02-RF012"
    status: "migrado"

  - elemento_legado: "WSUsuario.asmx.vb::Desbloquear_Usuario()"
    referencia_rf: "RN-RF012-03"
    referencia_uc: "UC03-RF012"
    status: "migrado"

  - elemento_legado: "Tela Usuario.aspx"
    referencia_rf: "Funcionalidade CRUD (Se√ß√£o 4), WF-RF012.md"
    referencia_uc: "UC00-RF012, UC01-RF012, UC03-RF012"
    status: "migrado"

  - elemento_legado: "Tabela Usuario (campos MD5, sem MFA/AD)"
    referencia_rf: "RN-RF012-02 (BCrypt), RN-RF012-08 (MFA), RN-RF012-09 (AD)"
    referencia_uc: "N/A"
    status: "migrado"

  - elemento_legado: "sp_Validar_Usuario_Login"
    referencia_rf: null
    referencia_uc: null
    status: "descartado"

  - elemento_legado: "sp_Bloquear_Usuario_Automatico"
    referencia_rf: null
    referencia_uc: null
    status: "descartado"

# =============================================
# CHANGELOG
# =============================================
changelog:
  - versao: "1.0"
    data: "2025-12-30"
    descricao: "Cria√ß√£o inicial do RL-RF012.yaml com estrutura√ß√£o completa de 10 problemas legado, 11 refer√™ncias com destino obrigat√≥rio, 6 RNs impl√≠citas, gap analysis detalhada, 6 decis√µes de moderniza√ß√£o, 9 riscos e rastreabilidade completa."
    autor: "Ag√™ncia ALC - alc.dev.br"
