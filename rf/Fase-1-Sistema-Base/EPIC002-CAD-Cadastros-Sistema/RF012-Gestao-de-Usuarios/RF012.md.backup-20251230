# RF-008: Gestão de Usuários do Sistema

**Versão**: 2.0
**Última Atualização**: 2025-11-02
**Status**: ✅ Estrutura Simplificada (5 seções)
**Fase**: Fase 1 - Fundação e Cadastros Base

---

[← Voltar ao Índice](./README.md)

---

## RESUMO EXECUTIVO

### Descrição Geral

Este requisito especifica a **Gestão de Usuários do Sistema** IControlIT, responsável pelo cadastro, autenticação e controle de acesso de todos os usuários que utilizam o sistema. Diferente do módulo de Consumidores (usuários finais que consomem recursos de TI/Telecom), este módulo gerencia usuários administrativos e operacionais que acessam o sistema para:

- **Administração**: Configurar sistema, gerenciar outros usuários
- **Operação**: Cadastrar ativos, processar faturas, gerar relatórios
- **Gestão**: Aprovar solicitações, visualizar dashboards
- **Auditoria**: Consultar logs, gerar relatórios de compliance

### Diferença: Usuário vs. Consumidor

| Aspecto | **Usuário (Usuario)** | **Consumidor (Consumidor)** |
|---------|------------------------|------------------------------|
| **Propósito** | Acessa o sistema IControlIT | Consome recursos de TI/Telecom |
| **Credenciais** | Login + Senha + MFA | Não possui acesso ao sistema |
| **Permissões** | Perfis de acesso (RBAC) | Não aplicável |
| **Exemplo** | Analista de TI, Gestor Financeiro | Colaborador que usa celular corporativo |
| **Tabela** | `Usuario` | `Consumidor` |

### Funcionalidades Principais

1. ✅ **Autenticação**: Login, senha, tokens JWT, MFA
2. ✅ **Autorização**: Perfis de acesso (RBAC), permissões granulares
3. ✅ **CRUD de Usuários**: Criar, ler, atualizar, desativar
4. ✅ **Gestão de Senhas**: Políticas de senha, reset, expiração
5. ✅ **Integração AD/LDAP**: Sincronização com Active Directory
6. ✅ **Multi-tenancy**: Isolamento por Conglomerado
7. ✅ **Auditoria**: Log completo de acessos e ações
8. ✅ **Notificações**: Alertas de login suspeito, senha expirada
9. ✅ **API de Autenticação**: Endpoints REST seguros
10. ✅ **Interface Angular**: Telas de login, perfil, configurações

---

## REGRAS DE NEGÓCIO

### RN-CAD-005-01: Login Único por Conglomerado

**Descrição**: O login do usuário deve ser único dentro do conglomerado (multi-tenancy).

**Regra**:
- Constraint no banco: Login + Id_Conglomerado devem ser únicos
- Permite mesmo login em conglomerados diferentes
- Validação case-insensitive
- Formato permitido: letras, números, '.', '_' ou '-'

---

### RN-CAD-005-02: Política de Senha Forte

**Descrição**: Senhas devem atender critérios de segurança mínimos.

**Critérios**:
- Mínimo **8 caracteres**
- Pelo menos **1 letra maiúscula**
- Pelo menos **1 letra minúscula**
- Pelo menos **1 número**
- Pelo menos **1 caractere especial** (@, #, $, %, etc.)
- **Não** pode conter o login do usuário
- **Não** pode estar no histórico das últimas 12 senhas

**Validação**: Implementada via FluentValidation no backend e reactive forms no Angular

---

### RN-CAD-005-03: Bloqueio por Tentativas Falhas

**Descrição**: Usuário é bloqueado após **5 tentativas falhas** consecutivas em **15 minutos**.

**Regra**:
- Incrementa contador `Tentativas_Falhas` a cada falha
- Ao atingir 5 tentativas: `Fl_Bloqueado = 1` e `Dt_Bloqueio = GETDATE()`
- Reset automático após 15 minutos sem novas tentativas
- Administrador pode desbloquear manualmente via webservice `Desbloquear_Usuario`
- Notificação por e-mail ao usuário quando bloqueado

---

### RN-CAD-005-04: Expiração de Senha

**Descrição**: Senhas expiram após **90 dias** e devem ser alteradas.

**Regra**:
- `Dt_Expiracao_Senha` calculada automaticamente: `Dt_Alteracao + 90 dias`
- Ao fazer login com senha expirada, sistema força alteração
- Usuário não pode acessar sistema até alterar senha
- Sistema envia notificação **7 dias antes** da expiração
- Job diário verifica senhas próximas de expirar

---

### RN-CAD-005-05: Token JWT com Expiração

**Descrição**: Tokens JWT expiram após **8 horas** de inatividade. Refresh tokens expiram após **30 dias**.

**Regra**:
- **Access Token (JWT)**: Válido por 8 horas, contém claims do usuário (ID, perfil, conglomerado)
- **Refresh Token**: Válido por 30 dias, token opaco armazenado em `Usuario_Sessao`
- Refresh token pode gerar novo access token sem novo login
- Se refresh token expirado, usuário deve fazer login novamente
- Sessões armazenadas com informações de dispositivo, IP e geolocalização

---

### RN-CAD-005-06: Permissões Baseadas em Perfis (RBAC)

**Descrição**: Usuários herdam permissões do perfil atribuído, mas podem ter permissões customizadas adicionais.

**Regra**:
- Permissões efetivas = Permissões do Perfil + Permissões Customizadas
- Permissões customizadas **apenas adicionam** (não removem)
- Formato JSON armazenado em coluna `Permissoes_Customizadas`
- Verificação em tempo de execução via middleware de autorização
- Exemplo de permissão: `"contratos:contrato:aprovar"`

---

### RN-CAD-005-07: Histórico de Senhas

**Descrição**: Sistema armazena últimas **12 senhas** para prevenir reutilização.

**Regra**:
- Ao alterar senha, nova senha **não pode** estar nas últimas 12
- Hash armazenado em tabela `Usuario_Historico_Senha`
- Limite: 12 registros por usuário (mais antigos automaticamente deletados)
- Verificação usando BCrypt.Verify para cada hash histórico

---

### RN-CAD-005-08: MFA (Multi-Factor Authentication)

**Descrição**: Usuários podem habilitar MFA via TOTP (Google Authenticator, Authy, etc.).

**Regra**:
- `Fl_MFA_Habilitado = 1`: MFA obrigatório no login
- Secret TOTP armazenado em `MFA_Secret` (Base32-encoded)
- Código TOTP válido por 30 segundos (padrão TOTP)
- QR Code gerado via formato: `otpauth://totp/IControlIT:{email}?secret={secret}&issuer=IControlIT`
- Backup via SMS em `Telefone_MFA` (opcional)

---

### RN-CAD-005-09: Integração com Active Directory

**Descrição**: Usuários podem ser sincronizados do Active Directory corporativo.

**Regra**:
- `Fl_Usuario_AD = 1`: Usuário gerenciado pelo AD
- Login/senha validados contra AD LDAP (não armazenados no IControlIT)
- Sincronização automática de dados: nome, email, grupos
- `AD_Object_GUID` vincula usuário IControlIT com objeto AD
- Sincronização via PrincipalContext (.NET) conectado ao domínio

---

### RN-CAD-005-10: Detecção de Login Suspeito

**Descrição**: Sistema detecta logins suspeitos e notifica usuário.

**Critérios de Suspeita**:
- Login de **IP desconhecido** (não usado nos últimos 30 dias)
- Login de **país diferente** do usual
- Login em **horário incomum** (ex: 00h-06h)
- Múltiplos logins **simultâneos** de IPs diferentes

**Ação**: Registro em `Usuario_Historico_Acesso` com `Fl_Login_Suspeito = 1` e envio de e-mail ao usuário

---

### RN-CAD-005-11: Reset de Senha via E-mail

**Descrição**: Usuários podem solicitar reset de senha via e-mail com token temporário.

**Regra**:
- Token gerado criptograficamente seguro (256 bits, Base64)
- Válido por **1 hora**
- Uso único: `Fl_Utilizado = 1` após uso
- E-mail contém link: `https://app.icontrolit.com/reset-senha?token={token}`
- Token armazenado em `Usuario_Reset_Senha`

---

### RN-CAD-005-12: Sessões Múltiplas Simultâneas

**Descrição**: Sistema permite múltiplas sessões simultâneas por usuário (máximo 5).

**Regra**:
- Usuário pode ter até **5 sessões ativas** simultaneamente
- Ao atingir 6ª sessão, **sessão mais antiga** é invalidada automaticamente
- Usuário pode visualizar todas as sessões ativas (dispositivo, IP, última atividade)
- Usuário pode revogar qualquer sessão manualmente

---

### RN-CAD-005-13: Auditoria Completa de Acessos

**Descrição**: Todo acesso (sucesso ou falha) é registrado para auditoria.

**Informações Registradas**:
- Login tentado
- Resultado (sucesso/falha)
- IP, User-Agent, Device Type (Web/Mobile/API)
- Geolocalização (cidade, país) via API externa
- Data/hora UTC
- Motivo de falha (se aplicável)

**Tabela**: `Usuario_Historico_Acesso`

---

### RN-CAD-005-14: Primeiro Acesso Força Troca de Senha

**Descrição**: Usuário criado por administrador deve trocar senha no primeiro acesso.

**Regra**:
- `Fl_Primeiro_Acesso = 1`: Indica senha temporária
- Ao fazer login, sistema retorna flag `RequireTrocaSenha = true`
- Frontend redireciona para tela de troca de senha
- Sistema não permite acesso a outras funcionalidades até troca
- Após troca: `Fl_Primeiro_Acesso = 2`

---

### RN-CAD-005-15: E-mail Único por Conglomerado

**Descrição**: E-mail do usuário deve ser único dentro do conglomerado.

**Regra**:
- Constraint no banco: Email + Id_Conglomerado devem ser únicos
- Validação case-insensitive
- Formato válido conforme RFC 5322
- Usado para recuperação de senha e notificações

---

### RN-CAD-005-16: Detalhamento de Contas e Contatos (Níveis de Visibilidade)

**Descrição**: Usuário pode ter diferentes níveis de detalhamento para visualização de contas e contatos.

**Regra**:
- `Usuario.Detalhamento_Conta` (INT): Nível de detalhamento das contas financeiras
  - Valores possíveis: 1=Básico, 2=Intermediário, 3=Completo
  - Controla quais campos financeiros o usuário pode visualizar
  - Default: 1 (Básico)
- `Usuario.Detalhamento_Contato` (INT): Nível de detalhamento dos contatos/consumidores
  - Valores possíveis: 1=Básico, 2=Intermediário, 3=Completo
  - Controla quais campos de contatos o usuário pode visualizar
  - Default: 1 (Básico)
- Validação: Valores aceitos são apenas 1, 2 ou 3

**Observação**: Regra extraída do código legado (`pa_Usuario` stored procedure), utilizada para controle de visibilidade granular de dados sensíveis.

---

### RN-CAD-005-17: Status de Desativação do Usuário

**Descrição**: Usuário pode ter status de desativação além dos flags de ativo/bloqueado.

**Regra**:
- `Usuario.Fl_Desativado` (INT): Flag de desativação manual do usuário
  - Valores possíveis: 1=Ativo, 2=Inativo, 3=Desativado Permanentemente
  - Diferença entre `Fl_Ativo` (soft delete) e `Fl_Desativado` (desativação administrativa)
  - Valor 3 indica desativação permanente (ex: funcionário desligado, não apenas bloqueado)
  - Default: 1 (Ativo)
- Usuários com `Fl_Desativado = 3` não podem ser reativados sem aprovação do administrador master
- Diferente de `Fl_Bloqueado` (bloqueio por tentativas falhas), este campo representa desativação manual

**Observação**: Regra extraída do código legado (`pa_Usuario` stored procedure). O valor 3 é específico para casos de desligamento definitivo.

---

## REFERÊNCIAS AO LEGADO

### Mapeamento de Webservices

| Legado (VB.NET) | Moderno (.NET 10) |
|-----------------|------------------|
| `WSAuth.asmx.vb::Login()` | `POST /api/auth/login` |
| `WSAuth.asmx.vb::Logout()` | `POST /api/auth/logout` |
| `WSUsuario.asmx.vb::Criar_Usuario()` | `POST /api/usuarios` |
| `WSUsuario.asmx.vb::Listar_Usuarios()` | `GET /api/usuarios` |
| `WSUsuario.asmx.vb::Alterar_Senha()` | `PUT /api/usuarios/{id}/senha` |
| `WSUsuario.asmx.vb::Desbloquear_Usuario()` | `POST /api/usuarios/{id}/unlock` |

### Tabelas Legado vs Moderno

| Legado | Moderno | Mudanças |
|--------|---------|----------|
| `Usuario` | `Usuario` | ✅ + campos MFA/AD |
| - | `Usuario_Sessao` | 🆕 Gestão JWT tokens |
| - | `Usuario_Historico_Senha` | 🆕 Histórico senhas |
| - | `Usuario_Historico_Acesso` | 🆕 Auditoria logins |
| - | `Usuario_Reset_Senha` | 🆕 Reset via e-mail |

### Estratégia de Migração

1. **Análise**: Documentar webservices legado (WSUsuario.asmx.vb, WSAuth.asmx.vb)
2. **Hash Migration**: Migrar senhas MD5 para BCrypt (forçar troca no primeiro acesso)
3. **Testes Paralelos**: Validar autenticação em ambos os sistemas durante transição
4. **Cutover**: Desativar webservices legado após migração completa
5. **Validação**: Garantir que todos os usuários conseguem autenticar no sistema moderno

---

## BANCO DE DADOS LEGADO

### Tabela Principal: Usuario

**Localização**: SQL Server, database `IControlIT`, schema `dbo`

**Campos Principais**:
- `Id_Usuario` (UNIQUEIDENTIFIER, PK): Identificador único
- `Id_Conglomerado` (UNIQUEIDENTIFIER, FK): Multi-tenancy
- `Nm_Usuario` (NVARCHAR(120)): Nome completo
- `Email` (NVARCHAR(100)): E-mail para notificações
- `Login` (NVARCHAR(50)): Login único por conglomerado
- `Password_Hash` (NVARCHAR(255)): Hash MD5 no legado, BCrypt no moderno
- `Id_Perfil` (UNIQUEIDENTIFIER, FK): Perfil RBAC
- `Fl_Ativo` (INT): 1=Ativo, 2=Inativo
- `Fl_Bloqueado` (INT): 1=Bloqueado, 2=Desbloqueado
- `Tentativas_Falhas` (INT): Contador de tentativas falhas
- `Dt_Ultimo_Acesso` (DATETIME): Último login bem-sucedido
- `Dt_Expiracao_Senha` (DATETIME): Data de expiração da senha

**Campos Novos (Modernização)**:
- `MFA_Secret` (NVARCHAR(100)): Secret TOTP para MFA
- `Fl_MFA_Habilitado` (INT): Flag MFA ativo
- `AD_Object_GUID` (UNIQUEIDENTIFIER): GUID do usuário no AD
- `AD_Sam_Account_Name` (NVARCHAR(50)): Login do AD
- `Permissoes_Customizadas` (NVARCHAR(MAX)): JSON com permissões extras

**Constraints**:
- `UQ_Usuario_Login_Conglomerado`: Login único por conglomerado
- `UQ_Usuario_Email_Conglomerado`: Email único por conglomerado
- `FK_Usuario_Conglomerado`: Relação com tabela Conglomerado
- `FK_Usuario_Perfil`: Relação com tabela Perfil

**Índices**:
- `IX_Usuario_Login`: Busca por login (autenticação)
- `IX_Usuario_Email`: Busca por email (reset senha)
- `IX_Usuario_Conglomerado`: Filtro por conglomerado
- `IX_Usuario_AD_GUID`: Sincronização AD

### Tabelas Relacionadas

**Usuario_Sessao** (Nova): Armazena sessões ativas (JWT tokens, refresh tokens, device info, geolocalização)

**Usuario_Historico_Senha** (Nova): Histórico das últimas 12 senhas (BCrypt hash, data de alteração)

**Usuario_Historico_Acesso** (Nova): Log de todos os acessos (sucesso/falha, IP, User-Agent, país, motivo de suspeita)

**Usuario_Reset_Senha** (Nova): Tokens de reset de senha (token, expiração 1h, flag utilizado)

### Stored Procedures Relevantes

- `sp_Validar_Usuario_Login`: Valida login/senha (legado usa MD5)
- `sp_Bloquear_Usuario_Automatico`: Bloqueio após 5 tentativas falhas
- `sp_Sincronizar_Usuario_AD`: Sincronização com Active Directory

---

## WEBSERVICES LEGADO (VB.NET)

### Arquivo: WSUsuario.asmx.vb

**Localização**: `D:\IC2\ic1_legado\IControlIT\IControlIT\WS\WSUsuario.asmx.vb`

**Métodos Principais**:

1. **Autenticar**(pLogin, pSenha, pId_Conglomerado)
   - Valida credenciais usando MD5 hash
   - Retorna DataSet com dados do usuário se sucesso
   - Incrementa tentativas falhas e bloqueia após 5 tentativas
   - Atualiza `Dt_Ultimo_Acesso` em caso de sucesso

2. **Listar_Usuarios**(pPakage, pId_Conglomerado, pId_Perfil, pFl_Ativo)
   - Lista usuários com filtros opcionais por perfil e status
   - Retorna DataSet com campos: Id_Usuario, Nm_Usuario, Email, Login, Nm_Perfil, Fl_Ativo, Fl_Bloqueado

3. **Alterar_Senha**(pPakage, pId_Usuario, pSenha_Atual, pSenha_Nova)
   - Valida senha atual antes de alterar
   - Atualiza senha com novo MD5 hash
   - Registra no histórico `Usuario_Historico_Senha`
   - Define `Dt_Expiracao_Senha` para 90 dias no futuro

4. **Desbloquear_Usuario**(pPakage, pId_Usuario)
   - Desbloqueia usuário bloqueado por tentativas falhas
   - Zera contador `Tentativas_Falhas`
   - Define `Fl_Bloqueado = 2` e `Dt_Bloqueio = NULL`

5. **Criar_Usuario**(pPakage, pNm_Usuario, pEmail, pLogin, pId_Perfil, pId_Conglomerado)
   - Cria novo usuário com senha temporária
   - Define `Fl_Primeiro_Acesso = 1` para forçar troca
   - Valida unicidade de login e email no conglomerado

**Observações Técnicas**:
- Usa classe `cls_DB` para execução de SQL dinâmico (vulnerável a SQL Injection)
- Autenticação via `pPakage` validado por `cls_Config.Validar_Pakage()`
- MD5 usado para senhas (inseguro, migrar para BCrypt)
- Retorno em DataSet (legado ASP.NET Web Forms)

### Arquivo: WSAuth.asmx.vb

**Localização**: `D:\IC2\ic1_legado\IControlIT\IControlIT\WS\WSAuth.asmx.vb`

**Métodos Principais**:

1. **Login**(pLogin, pSenha, pId_Conglomerado)
   - Wrapper para `WSUsuario.Autenticar`
   - Retorna token de sessão (session cookie ASP.NET)

2. **Logout**(pSession_Token)
   - Invalida sessão ASP.NET
   - Limpa cookies de autenticação

---

## TELAS DO LEGADO

### Tela: Usuario.aspx
**Localização**: `D:\IC2\ic1_legado\IControlIT\IControlIT\Cadastro\Usuario.aspx`

**Descrição**: Tela de cadastro/edição de usuários do sistema usando ASP.NET Web Forms com AjaxControlToolkit.

**Campos da Tela**:
1. **Login** (txtDescricao) - TextBox obrigatório, MaxLength=50
2. **Senha** - Botão "Reiniciar Senha" com confirmação JavaScript
3. **Idioma** (cboIdioma) - DropDownList obrigatório
4. **Grupo** (cboUsuarioGrupo) - DropDownList obrigatório
5. **Perfil** (cboUsuarioPerfil) - DropDownList obrigatório com AutoPostBack
6. **Acesso** (cboUsuarioPerfilAcesso) - DropDownList obrigatório
7. **Permissão de Incluir** (optIncluir) - RadioButtonList (1=Revogar, 2=Permitir)
8. **Permissão de Alterar** (optAlterar) - RadioButtonList (1=Revogar, 2=Permitir)
9. **Permissão de Excluir** (optExcluir) - RadioButtonList (1=Revogar, 2=Permitir)
10. **Conta de outro usuário** (optDetalhamentoConta) - RadioButtonList (1=Revogar, 2=Permitir)
11. **Contatos de outro usuário** (optDetalhamentoContato) - RadioButtonList (1=Revogar, 2=Permitir)
12. **Status para acesso** (optStatusUsuario) - RadioButtonList (1=Revogar, 3=Permitir)
13. **Permissão para Requisição** - ListBox duplo (Origem/Destino) com botões de mover
14. **Nome** (txtNmConsumidor) - TextBox readonly (vinculação com consumidor)
15. **Chave do banco** (txtIdentificacao) - TextBox readonly (ID do usuário)

**Validações**:
- RequiredFieldValidator para Login, Idioma, Grupo, Perfil e Acesso
- ValidatorCalloutExtender usando AjaxControlToolkit para feedback visual
- Confirmação JavaScript ao reiniciar senha

**Botões**:
- **Voltar** - Retorna à tela anterior
- **Novo** - Limpa formulário
- **Salvar** - Persiste dados (com validação)
- **Config** - Configurações adicionais
- **PDF** - Exportar para PDF

#### O Que Modernizar

1. **UI/UX Moderna**:
   - ❌ Substituir ASP.NET Web Forms por Angular 18 + PrimeNG
   - ❌ Eliminar PostBacks (AutoPostBack do Perfil) - usar Observables/Signals
   - ❌ Trocar RadioButtonList por PrimeNG TriStateCheckbox ou Dropdown
   - ❌ Substituir ListBox duplo por PrimeNG PickList (component drag-and-drop moderno)
   - ✅ Implementar design responsivo (mobile-first)

2. **Validação e Segurança**:
   - ❌ Substituir validadores server-side ASP.NET por FluentValidation no backend
   - ✅ Adicionar validação client-side com Reactive Forms (Angular)
   - ❌ Eliminar JavaScript inline (`OnClientClick`) - usar eventos Angular
   - ✅ Implementar força de senha visual (barra de progresso)
   - ✅ Adicionar CAPTCHA em reset de senha
   - ✅ Implementar MFA (TOTP) obrigatório para admins

3. **Gestão de Senhas**:
   - ❌ Substituir botão "Reiniciar Senha" por workflow de email com token
   - ✅ Permitir usuário trocar própria senha (self-service)
   - ✅ Adicionar histórico de senhas (últimas 12)
   - ✅ Política de expiração (90 dias) com notificações antecipadas
   - ✅ Gerador de senha forte (sugestão automática)

4. **Permissões Granulares**:
   - ❌ Simplificar permissões Incluir/Alterar/Excluir (herdadas do perfil)
   - ✅ Implementar RBAC moderno com permissões customizadas em JSON
   - ❌ Remover "Conta/Contatos de outro usuário" - migrar para perfil-based
   - ✅ Adicionar preview de permissões efetivas (perfil + custom)

5. **Integração e Sincronização**:
   - ✅ Integrar com Active Directory (Microsoft Graph API)
   - ✅ Sincronização bidirecional (AD → IControlIT → AD)
   - ✅ SSO (Single Sign-On) com Azure AD
   - ✅ Detecção automática de desligamento (remoção do AD)

6. **Auditoria e Rastreamento**:
   - ✅ Event sourcing completo (quem alterou, quando, campo, valor antes/depois)
   - ✅ Timeline visual de alterações do usuário
   - ✅ Log de acessos (sucesso/falha, IP, geolocalização)
   - ✅ Alertas de login suspeito (IP desconhecido, país diferente)

7. **Performance**:
   - ❌ Eliminar ViewState do Web Forms (economiza 50-200KB por request)
   - ✅ Implementar lazy loading para listas grandes
   - ✅ Paginação server-side (50 itens por vez)
   - ✅ Cache Redis para dropdowns (Idioma, Grupo, Perfil)
   - ✅ Debounce em campos de autocomplete

8. **Usabilidade**:
   - ✅ Busca por nome/login/email com typo tolerance (Elasticsearch)
   - ✅ Autocomplete em campo Login (sugere padrão: nome.sobrenome)
   - ✅ Validação de unicidade em tempo real (sem submeter formulário)
   - ✅ Stepper wizard para criação de usuário (3 passos: Dados → Permissões → Revisão)
   - ✅ Tour guiado (tooltips) para administradores novatos

---

[← Voltar ao Índice](./README.md)
