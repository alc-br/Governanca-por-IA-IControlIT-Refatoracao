# =============================================
# RF-012 — Gestão de Usuários do Sistema
# Versão: 2.0
# Data: 2025-12-30
# Autor: Agência ALC - alc.dev.br
# =============================================

rf:
  id: "RF012"
  nome: "Gestão de Usuários do Sistema"
  versao: "2.0"
  data: "2025-12-30"
  fase: "Fase 1 - Sistema Base"
  epic: "EPIC002-CAD"
  status: "aprovado"

descricao:
  objetivo: "Gerenciar usuários administrativos e operacionais do sistema IControlIT, incluindo autenticação, autorização, gestão de perfis, senhas, sessões, integração com Active Directory e auditoria de acessos."
  problema_resolvido: "Controle centralizado de acesso ao sistema com segurança robusta (MFA, políticas de senha, bloqueio automático), auditoria completa e gestão de permissões granulares RBAC."
  publico_afetado: "Administradores de sistema, gestores, operadores, auditores e todos os usuários que acessam o IControlIT (diferente de Consumidores que não possuem acesso)."

escopo:
  incluso:
    - "Autenticação com credenciais (login/senha)"
    - "Tokens JWT (access 8h, refresh 30 dias)"
    - "Multi-Factor Authentication (MFA) via TOTP"
    - "Gestão de senhas (criação, alteração, reset, expiração 90 dias)"
    - "Histórico de 12 senhas"
    - "Bloqueio automático após 5 tentativas falhas"
    - "Perfis RBAC com permissões granulares"
    - "Permissões customizadas por usuário"
    - "Integração Active Directory (LDAP, sincronização)"
    - "Sessões múltiplas (máximo 5)"
    - "Detecção de login suspeito"
    - "Auditoria completa de acessos"
    - "Primeiro acesso força troca de senha"
    - "Isolamento multi-tenant (login e email únicos por Fornecedor)"
    - "Níveis de detalhamento de visualização (contas e contatos)"
    - "Status de desativação administrativa"
    - "CRUD completo de usuários"
  fora:
    - "Interface visual específica"
    - "Tecnologia de hash de senha (implementação)"
    - "Layout e design"
    - "Estratégia de deploy"
    - "Gestão de Consumidores (RF separado)"
    - "SSO com OAuth2/SAML (fase futura)"

entidades:
  - nome: "Usuario"
    descricao: "Usuário do sistema IControlIT com credenciais de acesso"
    multi_tenant: true
    soft_delete: true
    auditoria: true

  - nome: "Usuario_Sessao"
    descricao: "Sessões ativas do usuário (refresh tokens, dispositivo, geolocalização)"
    multi_tenant: true
    soft_delete: false
    auditoria: true

  - nome: "Usuario_Historico_Senha"
    descricao: "Histórico das últimas 12 senhas (BCrypt hash)"
    multi_tenant: true
    soft_delete: false
    auditoria: false

  - nome: "Usuario_Historico_Acesso"
    descricao: "Auditoria de todos os acessos (sucesso/falha, IP, geolocalização)"
    multi_tenant: true
    soft_delete: false
    auditoria: false

  - nome: "Usuario_Reset_Senha"
    descricao: "Tokens de reset de senha via e-mail (válido 1h)"
    multi_tenant: true
    soft_delete: false
    auditoria: true

regras_negocio:
  - id: "RN-RF012-01"
    descricao: "Login único por Fornecedor (multi-tenancy)"
    tipo: "unicidade"
    campos_afetados: ["Login", "Id_Fornecedor"]
    obrigatorio: true

  - id: "RN-RF012-02"
    descricao: "Política de senha forte (mínimo 8 caracteres, maiúscula, minúscula, número, especial)"
    tipo: "validacao"
    campos_afetados: ["Password_Hash"]
    obrigatorio: true

  - id: "RN-RF012-03"
    descricao: "Bloqueio automático após 5 tentativas falhas em 15 minutos"
    tipo: "seguranca"
    campos_afetados: ["Tentativas_Falhas", "Fl_Bloqueado", "Dt_Bloqueio"]
    obrigatorio: true

  - id: "RN-RF012-04"
    descricao: "Expiração de senha após 90 dias com notificação 7 dias antes"
    tipo: "regra_negocio"
    campos_afetados: ["Dt_Expiracao_Senha", "Dt_Alteracao_Senha"]
    obrigatorio: true

  - id: "RN-RF012-05"
    descricao: "Token JWT expira após 8 horas, refresh token após 30 dias"
    tipo: "seguranca"
    campos_afetados: ["Usuario_Sessao.Access_Token", "Usuario_Sessao.Refresh_Token"]
    obrigatorio: true

  - id: "RN-RF012-06"
    descricao: "Permissões efetivas = Permissões do Perfil + Permissões Customizadas (apenas adicionam)"
    tipo: "regra_negocio"
    campos_afetados: ["Id_Perfil", "Permissoes_Customizadas"]
    obrigatorio: true

  - id: "RN-RF012-07"
    descricao: "Histórico de 12 senhas previne reutilização"
    tipo: "seguranca"
    campos_afetados: ["Usuario_Historico_Senha.Password_Hash"]
    obrigatorio: true

  - id: "RN-RF012-08"
    descricao: "MFA via TOTP (código 6 dígitos, janela 30s)"
    tipo: "seguranca"
    campos_afetados: ["Fl_MFA_Habilitado", "MFA_Secret", "Telefone_MFA"]
    obrigatorio: false

  - id: "RN-RF012-09"
    descricao: "Integração Active Directory (autenticação LDAP, sincronização automática)"
    tipo: "integracao"
    campos_afetados: ["Fl_Usuario_AD", "AD_Object_GUID", "AD_Sam_Account_Name"]
    obrigatorio: false

  - id: "RN-RF012-10"
    descricao: "Detecção de login suspeito (IP/país/horário anômalo) com notificação por e-mail"
    tipo: "seguranca"
    campos_afetados: ["Usuario_Historico_Acesso.Fl_Login_Suspeito"]
    obrigatorio: true

  - id: "RN-RF012-11"
    descricao: "Reset de senha via e-mail com token temporário (válido 1 hora, uso único)"
    tipo: "regra_negocio"
    campos_afetados: ["Usuario_Reset_Senha.Token", "Usuario_Reset_Senha.Dt_Expiracao"]
    obrigatorio: true

  - id: "RN-RF012-12"
    descricao: "Máximo 5 sessões simultâneas por usuário (6ª sessão invalida a mais antiga)"
    tipo: "regra_negocio"
    campos_afetados: ["Usuario_Sessao.Id_Usuario"]
    obrigatorio: true

  - id: "RN-RF012-13"
    descricao: "Auditoria completa de todos os acessos (sucesso/falha, IP, geolocalização, dispositivo)"
    tipo: "auditoria"
    campos_afetados: ["Usuario_Historico_Acesso.*"]
    obrigatorio: true

  - id: "RN-RF012-14"
    descricao: "Primeiro acesso força troca de senha"
    tipo: "regra_negocio"
    campos_afetados: ["Fl_Primeiro_Acesso"]
    obrigatorio: true

  - id: "RN-RF012-15"
    descricao: "E-mail único por Fornecedor (multi-tenancy)"
    tipo: "unicidade"
    campos_afetados: ["Email", "Id_Fornecedor"]
    obrigatorio: true

  - id: "RN-RF012-16"
    descricao: "Detalhamento de Contas e Contatos (níveis 1=Básico, 2=Intermediário, 3=Completo)"
    tipo: "regra_negocio"
    campos_afetados: ["Detalhamento_Conta", "Detalhamento_Contato"]
    obrigatorio: true

  - id: "RN-RF012-17"
    descricao: "Status de desativação (1=Ativo, 2=Inativo, 3=Desativado Permanentemente)"
    tipo: "regra_negocio"
    campos_afetados: ["Fl_Desativado"]
    obrigatorio: true

estados:
  - id: "active"
    descricao: "Usuário ativo e operacional"
    flags: { Fl_Ativo: 1, Fl_Bloqueado: 0, Fl_Desativado: 1 }

  - id: "blocked"
    descricao: "Bloqueado por tentativas falhas ou admin"
    flags: { Fl_Ativo: 1, Fl_Bloqueado: 1, Fl_Desativado: 1 }

  - id: "inactive"
    descricao: "Desativado temporariamente"
    flags: { Fl_Ativo: 1, Fl_Bloqueado: 0, Fl_Desativado: 2 }

  - id: "deactivated_permanent"
    descricao: "Desativado permanentemente (requer aprovação master para reativar)"
    flags: { Fl_Ativo: 1, Fl_Bloqueado: 0, Fl_Desativado: 3 }

  - id: "deleted"
    descricao: "Excluído logicamente (soft delete)"
    flags: { Fl_Ativo: 0, Fl_Bloqueado: 0, Fl_Desativado: 1 }

  - id: "first_access"
    descricao: "Senha temporária, requer troca obrigatória"
    flags: { Fl_Ativo: 1, Fl_Bloqueado: 0, Fl_Desativado: 1, Fl_Primeiro_Acesso: 1 }

transicoes:
  permitidas:
    - de: "first_access"
      para: "active"
      condicao: "Troca de senha bem-sucedida"

    - de: "active"
      para: "blocked"
      condicao: "5 tentativas falhas ou bloqueio manual"

    - de: "blocked"
      para: "active"
      condicao: "Desbloqueio manual ou timeout 15 minutos"

    - de: "active"
      para: "inactive"
      condicao: "Desativação temporária por admin"

    - de: "inactive"
      para: "active"
      condicao: "Reativação por admin"

    - de: "active"
      para: "deactivated_permanent"
      condicao: "Desativação permanente por admin master"

    - de: "deactivated_permanent"
      para: "active"
      condicao: "Reativação por Super Admin (requer permissão usuarios:reativar_permanente)"

    - de: "active"
      para: "deleted"
      condicao: "Exclusão lógica (soft delete)"

  proibidas:
    - de: "deleted"
      para: "*"
      motivo: "Soft delete é irreversível sem restore manual"

    - de: "deactivated_permanent"
      para: "active"
      motivo: "Requer permissão usuarios:reativar_permanente"

permissoes:
  # Permissões CRUD básicas
  - codigo: "usuarios.view_any"
    descricao: "Listar usuários"
    operacao: "read"

  - codigo: "usuarios.view"
    descricao: "Visualizar detalhes de um usuário"
    operacao: "read"

  - codigo: "usuarios.create"
    descricao: "Criar novo usuário"
    operacao: "create"

  - codigo: "usuarios.update"
    descricao: "Atualizar dados do usuário"
    operacao: "update"

  - codigo: "usuarios.delete"
    descricao: "Excluir usuário (soft delete)"
    operacao: "delete"

  # Permissões de gestão de senha
  - codigo: "usuarios.alterar_senha"
    descricao: "Alterar senha do usuário"
    operacao: "update"

  - codigo: "usuarios.resetar_senha"
    descricao: "Resetar senha via e-mail"
    operacao: "update"

  - codigo: "usuarios.forcar_troca_senha"
    descricao: "Forçar troca de senha no próximo login"
    operacao: "update"

  # Permissões de bloqueio/desativação
  - codigo: "usuarios.bloquear"
    descricao: "Bloquear usuário manualmente"
    operacao: "update"

  - codigo: "usuarios.desbloquear"
    descricao: "Desbloquear usuário bloqueado"
    operacao: "update"

  - codigo: "usuarios.desativar"
    descricao: "Desativar usuário temporariamente"
    operacao: "update"

  - codigo: "usuarios.desativar_permanente"
    descricao: "Desativar usuário permanentemente (Fl_Desativado=3)"
    operacao: "update"

  - codigo: "usuarios.reativar_permanente"
    descricao: "Reativar usuário com Fl_Desativado=3 (requer Super Admin)"
    operacao: "update"

  # Permissões de MFA
  - codigo: "usuarios.habilitar_mfa"
    descricao: "Habilitar MFA para usuário"
    operacao: "update"

  - codigo: "usuarios.desabilitar_mfa"
    descricao: "Desabilitar MFA do usuário"
    operacao: "update"

  # Permissões de perfil e permissões
  - codigo: "usuarios.atribuir_perfil"
    descricao: "Atribuir/alterar perfil RBAC do usuário"
    operacao: "update"

  - codigo: "usuarios.gerenciar_permissoes_customizadas"
    descricao: "Adicionar/remover permissões customizadas do usuário"
    operacao: "update"

  # Permissões de sessões
  - codigo: "usuarios.visualizar_sessoes"
    descricao: "Visualizar sessões ativas do usuário"
    operacao: "read"

  - codigo: "usuarios.revogar_sessoes"
    descricao: "Revogar sessões de usuário"
    operacao: "update"

  # Permissões de auditoria
  - codigo: "usuarios.visualizar_auditoria"
    descricao: "Visualizar histórico de acessos e auditoria"
    operacao: "read"

  - codigo: "usuarios.exportar_auditoria"
    descricao: "Exportar relatórios de auditoria"
    operacao: "read"

  # Permissões de Active Directory
  - codigo: "usuarios.sincronizar_ad"
    descricao: "Sincronizar usuário com Active Directory"
    operacao: "update"

  - codigo: "usuarios.vincular_ad"
    descricao: "Vincular usuário a conta do AD"
    operacao: "update"

integracoes:
  internas:
    - "Autenticacao (JWT Tokens)"
    - "Multi-Tenancy (isolamento por Fornecedor)"
    - "Auditoria (AuditInterceptor)"
    - "Perfis RBAC"
    - "Notificações (e-mail, SMS)"
    - "Central de Funcionalidades"
    - "i18n (traduções)"

  externas:
    - sistema: "Active Directory"
      tipo: "LDAP"
      obrigatoria: false
      descricao: "Autenticação e sincronização de usuários corporativos"

    - sistema: "Serviço de Geolocalização IP"
      tipo: "API REST"
      obrigatoria: false
      descricao: "Detecção de localização para login suspeito (ipapi.co, GeoIP)"

    - sistema: "Serviço de E-mail (SMTP)"
      tipo: "SMTP"
      obrigatoria: true
      descricao: "Envio de notificações (reset senha, login suspeito, senha expirada)"

    - sistema: "Serviço de SMS"
      tipo: "API"
      obrigatoria: false
      descricao: "Backup MFA via SMS"

seguranca:
  isolamento_tenant: true
  auditoria_obrigatoria: true
  soft_delete: true
  validacoes:
    - "SQL Injection: queries parametrizadas (EF Core)"
    - "XSS: sanitização de outputs, CSP headers"
    - "CSRF: tokens CSRF em operações state-changing"
    - "Brute Force: bloqueio após 5 tentativas (RN-RF012-03)"
    - "Timing Attacks: respostas com tempo constante"
  criptografia:
    - "Senhas: BCrypt work factor 12"
    - "Tokens JWT: HS256 ou RS256"
    - "Refresh Tokens: SHA256 hash"
    - "MFA Secrets: Base32-encoded (opcional AES256)"

rastreabilidade:
  ucs_esperados:
    - "UC00-RF012"
    - "UC01-RF012"
    - "UC02-RF012"
    - "UC03-RF012"
    - "UC04-RF012"

  artefatos_obrigatorios:
    - "UC-RF012.md"
    - "MT-RF012.yaml"
    - "TC-RF012.yaml"
    - "MD-RF012.md"
    - "WF-RF012.md"
    - "RL-RF012.md"
    - "RL-RF012.yaml"

eventos_dominio:
  - evento: "usuario.criado"
    quando: "Após criação de usuário"
    payload: "{ id, login, email, Fornecedor_id, perfil_id }"

  - evento: "usuario.atualizado"
    quando: "Após atualização de dados"
    payload: "{ id, campos_alterados[], usuario_alterou_id }"

  - evento: "usuario.senha_alterada"
    quando: "Após troca de senha"
    payload: "{ id, data_expiracao_nova }"

  - evento: "usuario.senha_resetada"
    quando: "Após reset via e-mail"
    payload: "{ id, token_gerado, data_expiracao_token }"

  - evento: "usuario.bloqueado"
    quando: "Após bloqueio automático ou manual"
    payload: "{ id, motivo, tentativas_falhas }"

  - evento: "usuario.desbloqueado"
    quando: "Após desbloqueio"
    payload: "{ id, desbloqueado_por_id }"

  - evento: "usuario.desativado"
    quando: "Após desativação"
    payload: "{ id, fl_desativado, motivo }"

  - evento: "usuario.excluido"
    quando: "Após soft delete"
    payload: "{ id, excluido_por_id }"

  - evento: "usuario.login_sucesso"
    quando: "Após autenticação bem-sucedida"
    payload: "{ id, ip, geolocation, dispositivo, mfa_usado }"

  - evento: "usuario.login_falha"
    quando: "Após tentativa de login falha"
    payload: "{ login, motivo, ip, tentativas_restantes }"

  - evento: "usuario.login_suspeito"
    quando: "Após detecção de login anômalo"
    payload: "{ id, ip, pais, horario, criterio_suspeita }"

  - evento: "usuario.mfa_habilitado"
    quando: "Após habilitar MFA"
    payload: "{ id, secret_gerado }"

  - evento: "usuario.mfa_desabilitado"
    quando: "Após desabilitar MFA"
    payload: "{ id }"

  - evento: "usuario.sessao_criada"
    quando: "Após novo login"
    payload: "{ id, sessao_id, ip, dispositivo }"

  - evento: "usuario.sessao_revogada"
    quando: "Após logout ou revogação"
    payload: "{ id, sessao_id, revogado_por }"

  - evento: "usuario.ad_sincronizado"
    quando: "Após sincronização com AD"
    payload: "{ id, ad_object_guid, dados_sincronizados[] }"

catalog:
  funcionalidades:
    - id: "RN-RF012-01"
      title: "Login único por Fornecedor (multi-tenancy)"
      required: true
      origem: "regras_negocio"

    - id: "RN-RF012-02"
      title: "Política de senha forte (mínimo 8 caracteres, maiúscula, minúscula, número, especial)"
      required: true
      origem: "regras_negocio"

    - id: "RN-RF012-03"
      title: "Bloqueio automático após 5 tentativas falhas em 15 minutos"
      required: true
      origem: "regras_negocio"

    - id: "RN-RF012-04"
      title: "Expiração de senha após 90 dias com notificação 7 dias antes"
      required: true
      origem: "regras_negocio"

    - id: "RN-RF012-05"
      title: "Token JWT expira após 8 horas, refresh token após 30 dias"
      required: true
      origem: "regras_negocio"

    - id: "RN-RF012-06"
      title: "Permissões efetivas = Permissões do Perfil + Permissões Customizadas"
      required: true
      origem: "regras_negocio"

    - id: "RN-RF012-07"
      title: "Histórico de 12 senhas previne reutilização"
      required: true
      origem: "regras_negocio"

    - id: "RN-RF012-08"
      title: "MFA via TOTP (código 6 dígitos, janela 30s)"
      required: false
      origem: "regras_negocio"

    - id: "RN-RF012-09"
      title: "Integração Active Directory (autenticação LDAP, sincronização automática)"
      required: false
      origem: "regras_negocio"

    - id: "RN-RF012-10"
      title: "Detecção de login suspeito (IP/país/horário anômalo) com notificação por e-mail"
      required: true
      origem: "regras_negocio"

    - id: "RN-RF012-11"
      title: "Reset de senha via e-mail com token temporário (válido 1 hora, uso único)"
      required: true
      origem: "regras_negocio"

    - id: "RN-RF012-12"
      title: "Máximo 5 sessões simultâneas por usuário"
      required: true
      origem: "regras_negocio"

    - id: "RN-RF012-13"
      title: "Auditoria completa de todos os acessos"
      required: true
      origem: "regras_negocio"

    - id: "RN-RF012-14"
      title: "Primeiro acesso força troca de senha"
      required: true
      origem: "regras_negocio"

    - id: "RN-RF012-15"
      title: "E-mail único por Fornecedor (multi-tenancy)"
      required: true
      origem: "regras_negocio"

    - id: "RN-RF012-16"
      title: "Detalhamento de Contas e Contatos (níveis 1=Básico, 2=Intermediário, 3=Completo)"
      required: true
      origem: "regras_negocio"

    - id: "RN-RF012-17"
      title: "Status de desativação (1=Ativo, 2=Inativo, 3=Desativado Permanentemente)"
      required: true
      origem: "regras_negocio"

exclusions:
  rf_items:
    - id: "EX-RF012-01"
      justificativa: "SSO com provedores OAuth2/SAML (planejado para fase futura)"
    - id: "EX-RF012-02"
      justificativa: "Biometria (não previsto)"
    - id: "EX-RF012-03"
      justificativa: "Login social (Google, Facebook) - não previsto"

historico:
  - versao: "2.0"
    data: "2025-12-30"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Migração para formato v2.0 canônico estruturado. Sincronização 100% com RF012.md. 17 RNs, 22 permissões, 6 estados, 16 eventos de domínio."

  - versao: "1.0"
    data: "2025-11-02"
    autor: "[Autor Original]"
    descricao: "Versão inicial (sem YAML estruturado)"
