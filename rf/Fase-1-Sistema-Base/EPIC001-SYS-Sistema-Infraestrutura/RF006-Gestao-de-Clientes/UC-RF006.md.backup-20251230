# Casos de Uso - RF006

**Versao:** 1.0
**Data:** 2025-12-26
**RF Relacionado:** [RF006 - Gestao de Clientes](./RF006.md)

---

## Indice de Casos de Uso

| UC | Nome | Descricao |
|----|------|-----------|
| UC00 | Listar Clientes | Permite que administradores visualizem lista paginada de Clientes com filtros |
| UC01 | Criar Cliente | Permite que Super Admins criem novos Clientes (tenants raiz) com valida칞칚o CNPJ e consulta Receita Federal |
| UC02 | Visualizar Cliente | Permite que administradores visualizem detalhes completos de um Cliente incluindo Empresas, Usu치rios e Auditoria |
| UC03 | Editar Cliente | Permite que Super Admins editem dados de Clientes existentes com restri칞칫es para CNPJ |
| UC04 | Desativar/Excluir Cliente | Permite que Super Admins desativem Clientes (soft delete) bloqueando acesso de todos os usu치rios vinculados |

---

## UC00 - Listar Clientes

### Descricao
Permite que administradores visualizem lista paginada de Clientes cadastrados no sistema com filtros por CNPJ, Raz칚o Social e Status.

### Atores
- Administrador do Sistema
- Super Admin

### Pre-condicoes
- Usu치rio autenticado no sistema
- Usu치rio com permiss칚o `clientes:cliente:read`

### Fluxo Principal

| Passo | Ator | Sistema |
|-------|------|---------|
| 1 | Acessa menu Admin > Clientes | - |
| 2 | - | Carrega lista paginada de Clientes (20 por p치gina) |
| 3 | - | Exibe tabela com: CNPJ, Raz칚o Social, Nome Fantasia, Status, A칞칫es |
| 4 | Pode aplicar filtros ou ordena칞칚o | Sistema atualiza lista conforme filtros |
| 5 | Pode clicar em Visualizar, Editar ou Desativar | Sistema redireciona para UC correspondente |

### Fluxos Alternativos

**FA01 - Filtrar por CNPJ ou Raz칚o Social**
- **Condicao:** Usu치rio digita no campo de busca
- **Acao:** Sistema filtra lista em tempo real mostrando apenas Clientes que correspondem

**FA02 - Ordenar Lista**
- **Condicao:** Usu치rio clica em cabe칞alho de coluna
- **Acao:** Sistema reordena lista (ASC/DESC) pela coluna clicada

**FA03 - Exportar Lista**
- **Condicao:** Usu치rio clica em "Exportar"
- **Acao:** Sistema gera arquivo CSV ou Excel com lista filtrada (m치ximo 10.000 registros)

### Excecoes

**EX01 - Nenhum Cliente Cadastrado**
- **Condicao:** Banco de dados vazio (0 clientes)
- **Acao:** Sistema exibe mensagem "Nenhum cliente cadastrado" e bot칚o "Cadastrar Primeiro"

**EX02 - Erro de Conex칚o**
- **Condicao:** Falha ao consultar banco de dados
- **Acao:** Sistema exibe mensagem de erro e bot칚o "Tentar Novamente"

### Pos-condicoes
- Lista de Clientes exibida com sucesso
- Log de consulta registrado para auditoria

### Regras de Negocio Aplicaveis
- RN-CLI-006-08: Multi-tenancy n칚o se aplica a tabela Clientes (Super Admin v칡 todos)
- RN-CLI-006-07: Soft delete aplicado (Clientes exclu칤dos n칚o aparecem na lista)

---

## UC01 - Criar Cliente

### Descricao
Permite que Super Admins criem novos Clientes no sistema incluindo valida칞칚o de CNPJ, consulta autom치tica  Receita Federal para preenchimento de dados e upload de logo.

### Atores
- Super Admin

### Pre-condicoes
- Usu치rio autenticado no sistema
- Usu치rio com permiss칚o `clientes:cliente:create`

### Fluxo Principal

| Passo | Ator | Sistema |
|-------|------|---------|
| 1 | Acessa Admin > Clientes | - |
| 2 | Clica em "Novo Cliente" | - |
| 3 | - | Exibe formul치rio de cria칞칚o com abas: Dados B치sicos, Endere칞o, Contato, Branding |
| 4 | Preenche CNPJ: 33.592.510/0001-54 | - |
| 5 | - | Valida d칤gitos verificadores do CNPJ (algoritmo Receita Federal) |
| 6 | Clica em "Consultar Receita" | - |
| 7 | - | Consulta API ReceitaWS com CNPJ |
| 8 | - | Preenche automaticamente: Raz칚o Social, Nome Fantasia, Endere칞o, Telefone, Email |
| 9 | Revisa/ajusta dados preenchidos | - |
| 10 | (Opcional) Faz upload de logo do Cliente | Sistema valida formato (JPG/PNG/SVG) e tamanho (max 2MB) |
| 11 | Clica em "Salvar" | - |
| 12 | - | Valida campos obrigat칩rios (Raz칚o Social, CNPJ) |
| 13 | - | Verifica unicidade do CNPJ (n칚o pode duplicar) |
| 14 | - | Salva Cliente no banco (FlAtivo = true, FlExcluido = false) |
| 15 | - | Registra auditoria CLI_CREATE |
| 16 | - | Retorna HTTP 201 Created com ID do Cliente |
| 17 | - | Exibe toast "Cliente criado com sucesso" |
| 18 | - | Redireciona para UC02 (Visualizar Cliente) |

### Fluxos Alternativos

**FA01 - Cadastro Manual (ReceitaWS Indispon칤vel)**
- **Condicao:** API ReceitaWS retorna timeout ou erro
- **Acao:** Sistema exibe warning e permite preenchimento manual dos campos

**FA02 - Cliente Inativo desde Cria칞칚o**
- **Condicao:** Usu치rio desmarca checkbox "Cliente Ativo"
- **Acao:** Cliente criado com FlAtivo = false (n칚o bloqueia cria칞칚o)

### Excecoes

**EX01 - CNPJ Inv치lido**
- **Condicao:** D칤gitos verificadores incorretos
- **Acao:** Sistema exibe erro "CNPJ inv치lido (d칤gitos verificadores incorretos)" e bloqueia salvamento

**EX02 - CNPJ Duplicado**
- **Condicao:** J치 existe Cliente com mesmo CNPJ
- **Acao:** Sistema exibe erro "CNPJ 33.592.510/0001-54 j치 cadastrado" e bloqueia salvamento

**EX03 - Campos Obrigat칩rios N칚o Preenchidos**
- **Condicao:** Raz칚o Social ou CNPJ vazios
- **Acao:** Sistema destaca campos com erro e exibe mensagem "Preencha todos os campos obrigat칩rios"

**EX04 - Upload de Logo Falhou**
- **Condicao:** Arquivo muito grande (> 2MB) ou formato inv치lido
- **Acao:** Sistema exibe erro espec칤fico mas permite salvar Cliente sem logo

### Pos-condicoes
- Novo Cliente criado no banco de dados
- Logo salva em storage (se upload realizado)
- Log de auditoria registrado
- Cliente dispon칤vel imediatamente para vincula칞칚o com Empresas e Usu치rios

### Regras de Negocio Aplicaveis
- RN-CLI-006-02: CNPJ 칔nico por Cliente
- RN-CLI-006-03: Valida칞칚o de D칤gitos Verificadores do CNPJ
- RN-CLI-006-04: Raz칚o Social Obrigat칩ria
- RN-CLI-006-05: Consulta Autom치tica Receita Federal via CNPJ
- RN-CLI-006-09: Logo Personalizada por Cliente
- RN-CLI-006-10: CNPJ com M치scara Opcional

---

## UC02 - Visualizar Cliente

### Descricao
Permite que administradores visualizem detalhes completos de um Cliente incluindo dados cadastrais, endere칞o, contato, empresas vinculadas, usu치rios vinculados e hist칩rico de auditoria.

### Atores
- Administrador do Sistema
- Super Admin
- Gerente

### Pre-condicoes
- Usu치rio autenticado no sistema
- Usu치rio com permiss칚o `clientes:cliente:read`
- Cliente existe no sistema

### Fluxo Principal

| Passo | Ator | Sistema |
|-------|------|---------|
| 1 | Acessa lista de Clientes (UC00) | - |
| 2 | Clica em 칤cone "Visualizar" (游녜) de um Cliente | - |
| 3 | - | Carrega dados completos do Cliente por ID |
| 4 | - | Exibe tela com logo do Cliente (se configurado) |
| 5 | - | Exibe abas: Geral, Empresas, Usu치rios, Auditoria |
| 6 | - | Aba Geral: Raz칚o Social, Nome Fantasia, CNPJ, Endere칞o, Contato, Status |
| 7 | Pode navegar entre abas para ver informa칞칫es detalhadas | Sistema carrega dados da aba selecionada |
| 8 | (Opcional) Clica em "Editar" | Sistema redireciona para UC03 |
| 9 | (Opcional) Clica em "Desativar" | Sistema redireciona para UC04 |

### Informacoes Exibidas

**Aba Geral:**
- Raz칚o Social
- Nome Fantasia
- CNPJ (formatado com m치scara)
- Inscri칞칚o Estadual
- Email
- Telefone
- Site
- Endere칞o completo
- Status (Ativo/Inativo)
- Data de cria칞칚o
- Usu치rio que criou
- Data de 칰ltima altera칞칚o
- Usu치rio que alterou

**Aba Empresas:**
- Lista de Empresas vinculadas a este Cliente
- Contador: "12 Empresas vinculadas"
- A칞칫es: Visualizar, Editar cada Empresa

**Aba Usu치rios:**
- Lista de Usu치rios vinculados a este Cliente
- Contador: "500 Usu치rios vinculados"
- A칞칫es: Visualizar, Editar cada Usu치rio

**Aba Auditoria:**
- Hist칩rico completo de altera칞칫es
- Timeline: Data, Hora, Usu치rio, A칞칚o, Campos Alterados

### Fluxos Alternativos

**FA01 - Editar a Partir da Visualiza칞칚o**
- **Condicao:** Usu치rio clica em "Editar"
- **Acao:** Sistema redireciona para UC03 (Editar Cliente)

**FA02 - Visualizar Empresa Vinculada**
- **Condicao:** Usu치rio clica em "Visualizar" em uma Empresa na aba Empresas
- **Acao:** Sistema redireciona para UC de Visualizar Empresa (RF-008)

### Excecoes

**EX01 - Cliente N칚o Encontrado**
- **Condicao:** ID inv치lido ou Cliente foi exclu칤do
- **Acao:** Sistema exibe erro "Cliente n칚o encontrado" e redireciona para listagem

### Pos-condicoes
- Nenhuma altera칞칚o no sistema (apenas visualiza칞칚o)
- Log de consulta registrado para auditoria (opcional)

### Regras de Negocio Aplicaveis
- RN-CLI-006-07: Soft Delete (Clientes exclu칤dos n칚o s칚o visualiz치veis)

---

## UC03 - Editar Cliente

### Descricao
Permite que Super Admins editem dados de Clientes existentes com restri칞칫es: CNPJ n칚o pode ser alterado ap칩s cria칞칚o.

### Atores
- Super Admin

### Pre-condicoes
- Usu치rio autenticado no sistema
- Usu치rio com permiss칚o `clientes:cliente:update`
- Cliente existe no sistema
- Cliente n칚o est치 exclu칤do

### Fluxo Principal

| Passo | Ator | Sistema |
|-------|------|---------|
| 1 | Acessa visualiza칞칚o de Cliente (UC02) | - |
| 2 | Clica em "Editar" | - |
| 3 | - | Carrega formul치rio preenchido com dados atuais do Cliente |
| 4 | - | Campo CNPJ exibido como DESABILITADO (n칚o edit치vel) |
| 5 | - | Exibe warning: "CNPJ n칚o pode ser alterado ap칩s cria칞칚o" |
| 6 | Altera campos desejados (Raz칚o Social, Nome Fantasia, Email, etc) | - |
| 7 | (Opcional) Altera status Ativo/Inativo | - |
| 8 | (Opcional) Faz novo upload de logo | Sistema valida formato e tamanho |
| 9 | Clica em "Salvar Altera칞칫es" | - |
| 10 | - | Valida campos obrigat칩rios (Raz칚o Social) |
| 11 | - | Atualiza registro no banco (UpdatedAt = now, UpdatedBy = usu치rio logado) |
| 12 | - | Registra auditoria CLI_UPDATE com campos alterados (before/after) |
| 13 | - | Retorna HTTP 200 OK |
| 14 | - | Exibe toast "Cliente atualizado com sucesso" |
| 15 | - | Redireciona para UC02 (Visualizar Cliente) |

### Fluxos Alternativos

**FA01 - Cancelar Edi칞칚o**
- **Condicao:** Usu치rio clica em "Cancelar"
- **Acao:** Sistema descarta altera칞칫es e retorna para UC02 sem salvar

**FA02 - Desativar Cliente Durante Edi칞칚o**
- **Condicao:** Usu치rio desmarca checkbox "Cliente Ativo" e salva
- **Acao:** Sistema marca FlAtivo = false e TODOS os usu치rios vinculados perdem acesso imediatamente

### Excecoes

**EX01 - Cliente N칚o Encontrado**
- **Condicao:** Cliente foi exclu칤do por outro usu치rio durante edi칞칚o
- **Acao:** Sistema exibe erro "Cliente n칚o encontrado" e redireciona para listagem

**EX02 - Campos Obrigat칩rios Vazios**
- **Condicao:** Raz칚o Social em branco
- **Acao:** Sistema destaca campo com erro e bloqueia salvamento

### Pos-condicoes
- Cliente atualizado no banco de dados
- Log de auditoria registrado com campos alterados
- Se Cliente desativado: Todos os usu치rios vinculados bloqueados

### Regras de Negocio Aplicaveis
- RN-CLI-006-04: Raz칚o Social Obrigat칩ria
- RN-CLI-006-06: Cliente Inativo Bloqueia Todos os Usu치rios
- RN-CLI-006-09: Logo Personalizada por Cliente

---

## UC04 - Desativar/Excluir Cliente

### Descricao
Permite que Super Admins desativem Clientes (soft delete) bloqueando acesso de TODOS os usu치rios vinculados. Exclus칚o 칠 sempre l칩gica (FlExcluido = true), nunca f칤sica.

### Atores
- Super Admin

### Pre-condicoes
- Usu치rio autenticado no sistema
- Usu치rio com permiss칚o `clientes:cliente:delete`
- Cliente existe no sistema
- Cliente n칚o est치 exclu칤do

### Fluxo Principal

| Passo | Ator | Sistema |
|-------|------|---------|
| 1 | Acessa visualiza칞칚o de Cliente (UC02) | - |
| 2 | Clica em "Desativar" | - |
| 3 | - | Carrega dados do Cliente: CNPJ, Raz칚o Social, Total de Empresas vinculadas, Total de Usu치rios vinculados |
| 4 | - | Exibe modal de confirma칞칚o com warning CR칈TICO |
| 5 | - | Mensagem: "TODOS OS 500 USU츼RIOS PERDER츾O ACESSO AO SISTEMA IMEDIATAMENTE!" |
| 6 | L칡 aviso e digita motivo da desativa칞칚o (opcional) | - |
| 7 | Confirma desativa칞칚o clicando em "Sim, Desativar" | - |
| 8 | - | Marca FlExcluido = true (soft delete) |
| 9 | - | Marca FlAtivo = false |
| 10 | - | Registra auditoria CLI_DELETE com usu치rio, data/hora e motivo |
| 11 | - | Middleware de autentica칞칚o detecta Cliente inativo |
| 12 | - | TODOS os usu치rios deste Cliente s칚o deslogados imediatamente |
| 13 | - | Tentativas de login retornam HTTP 401: "Cliente inativo. Contate o suporte." |
| 14 | - | Retorna HTTP 200 OK |
| 15 | - | Exibe toast "Cliente desativado com sucesso" |
| 16 | - | Redireciona para listagem (UC00) |

### Fluxos Alternativos

**FA01 - Cancelar Desativa칞칚o**
- **Condicao:** Usu치rio clica em "Cancelar" no modal de confirma칞칚o
- **Acao:** Sistema fecha modal e mant칠m Cliente ativo

**FA02 - Reativar Cliente Exclu칤do**
- **Condicao:** Super Admin acessa Cliente exclu칤do via query especial
- **Acao:** Sistema permite reverter FlExcluido = false, FlAtivo = true, restaurando acesso

### Excecoes

**EX01 - Cliente N칚o Encontrado**
- **Condicao:** Cliente foi exclu칤do por outro usu치rio simultaneamente
- **Acao:** Sistema exibe erro "Cliente n칚o encontrado" e redireciona para listagem

### Pos-condicoes
- Cliente marcado como exclu칤do logicamente (FlExcluido = true, FlAtivo = false)
- Dados preservados no banco para auditoria
- TODOS os usu치rios vinculados bloqueados instantaneamente
- Log de auditoria registrado

### Regras de Negocio Aplicaveis
- RN-CLI-006-06: Cliente Inativo Bloqueia Todos os Usu치rios
- RN-CLI-006-07: Soft Delete Obrigat칩rio (N칚o Exclui Fisicamente)

---

## Historico de Alteracoes

| Versao | Data | Autor | Descricao |
|--------|------|-------|-----------|
| 1.0 | 2025-12-26 | Claude Code Assistant | Versao inicial - Casos de Uso para RF006 Gest칚o de Clientes (TENANT RAIZ) |
