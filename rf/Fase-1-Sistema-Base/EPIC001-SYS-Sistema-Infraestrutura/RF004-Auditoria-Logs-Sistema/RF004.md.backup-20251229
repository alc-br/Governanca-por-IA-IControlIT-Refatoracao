# RF-004: Auditoria e Logs do Sistema

**Vers√£o**: 1.0
**√öltima Atualiza√ß√£o**: 2025-11-04
**Status**: ‚úÖ Documenta√ß√£o Completa
**Fase**: Fase 1 - Funda√ß√£o e Cadastros Base

---

## üìã RESUMO EXECUTIVO

### Descri√ß√£o Geral

O RF-004 implementa o **Sistema de Auditoria Completa** do IControlIT, registrando todas as opera√ß√µes cr√≠ticas do sistema para compliance (LGPD, SOX, ISO 27001), troubleshooting, seguran√ßa e an√°lise forense.

### Import√¢ncia Estrat√©gica

Este √© um RF **CR√çTICO PARA COMPLIANCE** pois:

1. **LGPD Compliance**: Art. 37, 38, 46 - Registro de acesso e tratamento de dados pessoais
2. **SOX Compliance**: Se√ß√£o 404 - Auditoria de transa√ß√µes financeiras (7 anos de reten√ß√£o)
3. **ISO 27001**: Requisitos de auditoria de seguran√ßa da informa√ß√£o
4. **Seguran√ßa**: Detec√ß√£o de atividades suspeitas e ataques
5. **Troubleshooting**: Rastreamento de problemas via hist√≥rico de a√ß√µes
6. **An√°lise Forense**: Investiga√ß√£o de incidentes de seguran√ßa

### Diferen√ßa: RF-003 (Logs) vs RF-004 (Auditoria)

| Aspecto | RF-003 (Logs T√©cnicos) | RF-004 (Auditoria de Neg√≥cio) |
|---------|------------------------|-------------------------------|
| **Foco** | Logs de aplica√ß√£o, performance, erros | Auditoria de a√ß√µes de usu√°rios e mudan√ßas de dados |
| **Exemplos** | Exception logs, response time, queries SQL | Usu√°rio criou fatura, alterou perfil, exportou relat√≥rio |
| **Armazenamento** | Seq/Elasticsearch (otimizado para volume) | SQL Server (estruturado, relacional, imut√°vel) |
| **Reten√ß√£o** | 90 dias (padr√£o), 7 anos (seguran√ßa) | **7 anos obrigat√≥rio** (compliance SOX/LGPD) |
| **Granularidade** | Request/Response HTTP, exceptions | Opera√ß√£o de neg√≥cio (CRUD em entidades) |
| **Busca** | Full-text search (Seq/Elasticsearch) | SQL queries (filtros estruturados) |
| **Usu√°rio Final** | Desenvolvedores, DevOps | Auditores, Compliance, Gerentes |

### 15 Funcionalidades Principais

1. ‚úÖ **Auditoria Autom√°tica**: Interceptor MediatR registra todas as opera√ß√µes
2. ‚úÖ **Snapshot de Dados**: Armazena estado anterior e novo (diff JSON)
3. ‚úÖ **Rastreamento de Usu√°rio**: Quem fez, quando, de onde (IP), com qual dispositivo
4. ‚úÖ **Categoriza√ß√£o**: Opera√ß√µes categorizadas (CRUD, EXPORT, ACCESS, LOGIN, etc.)
5. ‚úÖ **Reten√ß√£o Configur√°vel**: 7 anos (SOX/LGPD), 90 dias (opera√ß√µes n√£o cr√≠ticas)
6. ‚úÖ **Busca Avan√ßada**: Filtros por usu√°rio, entidade, per√≠odo, tipo de opera√ß√£o
7. ‚úÖ **Timeline de Entidade**: Hist√≥rico completo de mudan√ßas de uma entidade
8. ‚úÖ **Relat√≥rios de Compliance**: Exporta√ß√£o formatada para auditores
9. ‚úÖ **Detec√ß√£o de Anomalias**: Padr√µes suspeitos (ex: 100 exporta√ß√µes em 1h)
10. ‚úÖ **Auditoria de LGPD**: Registro de acesso, consentimento, exclus√£o de dados
11. ‚úÖ **Segrega√ß√£o de Fun√ß√µes**: Auditoria de acesso a fun√ß√µes cr√≠ticas (SOX)
12. ‚úÖ **Imutabilidade**: Registros de auditoria N√ÉO podem ser alterados/deletados
13. ‚úÖ **Assinatura Digital**: Hash SHA-256 para garantir integridade
14. ‚úÖ **Arquivamento Autom√°tico**: Cold storage ap√≥s 1 ano (Azure Blob)
15. ‚úÖ **Alertas de Compliance**: Notificar quando retention expira

---

## üîó INTEGRA√á√ïES OBRIGAT√ìRIAS

### 1Ô∏è‚É£ Central de Funcionalidades

**C√≥digo da Funcionalidade**: `FNC-SYS-004`
**Nome**: Sistema de Auditoria
**Categoria**: Sistema / Infraestrutura
**Tipo**: Tela + API
**Descri√ß√£o**: Permite aos auditores e administradores visualizar e exportar registros de auditoria do sistema.

**Permiss√µes Requeridas**:
- `SYS.AUDITORIA.READ` - Visualizar registros de auditoria
- `SYS.AUDITORIA.SEARCH` - Buscar com filtros avan√ßados
- `SYS.AUDITORIA.EXPORT` - Exportar relat√≥rios de auditoria
- `SYS.AUDITORIA.TIMELINE` - Visualizar timeline de entidade
- `SYS.AUDITORIA.COMPLIANCE` - Acessar relat√≥rios de compliance (LGPD, SOX)
- `SYS.AUDITORIA.ANALYTICS` - Visualizar dashboards anal√≠ticos

### 2Ô∏è‚É£ Internacionaliza√ß√£o (i18n)

**Chaves de Tradu√ß√£o Necess√°rias**:

```json
{
  "AUDITORIA": {
    "TITLE": "Auditoria do Sistema",
    "SUBTITLE": "Registros de a√ß√µes e mudan√ßas de dados",
    "SEARCH_PLACEHOLDER": "Buscar por usu√°rio, entidade ou opera√ß√£o...",
    "FIELDS": {
      "TIMESTAMP": "Data/Hora",
      "USER": "Usu√°rio",
      "OPERATION": "Opera√ß√£o",
      "ENTITY": "Entidade",
      "ENTITY_ID": "ID da Entidade",
      "IP_ADDRESS": "Endere√ßo IP",
      "USER_AGENT": "Dispositivo/Navegador",
      "CHANGES": "Altera√ß√µes",
      "PREVIOUS_VALUE": "Valor Anterior",
      "NEW_VALUE": "Novo Valor"
    },
    "OPERATIONS": {
      "CREATE": "Cria√ß√£o",
      "READ": "Leitura",
      "UPDATE": "Atualiza√ß√£o",
      "DELETE": "Exclus√£o",
      "EXPORT": "Exporta√ß√£o",
      "LOGIN": "Login",
      "LOGOUT": "Logout",
      "ACCESS": "Acesso",
      "PRINT": "Impress√£o",
      "DOWNLOAD": "Download"
    },
    "FILTERS": {
      "USER": "Usu√°rio",
      "ENTITY": "Entidade",
      "OPERATION": "Tipo de Opera√ß√£o",
      "PERIOD": "Per√≠odo",
      "IP_ADDRESS": "Endere√ßo IP"
    },
    "TIMELINE": {
      "TITLE": "Timeline de Altera√ß√µes",
      "SUBTITLE": "Hist√≥rico completo de mudan√ßas",
      "NO_CHANGES": "Nenhuma altera√ß√£o registrada"
    },
    "COMPLIANCE": {
      "TITLE": "Relat√≥rios de Compliance",
      "LGPD_REPORT": "Relat√≥rio LGPD",
      "SOX_REPORT": "Relat√≥rio SOX",
      "ISO_REPORT": "Relat√≥rio ISO 27001",
      "ACCESS_LOG": "Log de Acesso a Dados Pessoais",
      "DATA_DELETION": "Registro de Exclus√£o de Dados"
    },
    "MESSAGES": {
      "EXPORT_SUCCESS": "Relat√≥rio de auditoria exportado com sucesso",
      "NO_RECORDS": "Nenhum registro de auditoria encontrado",
      "RETENTION_WARNING": "Alguns registros est√£o pr√≥ximos do fim da reten√ß√£o"
    }
  }
}
```

### 3Ô∏è‚É£ Auditoria (Recursiva)

**Nota**: Este pr√≥prio RF registra suas opera√ß√µes em auditoria.

**Opera√ß√µes Auditadas**:

| Opera√ß√£o | Tipo | Dados Registrados | Reten√ß√£o |
|----------|------|-------------------|----------|
| Visualizar Auditoria | ACCESS | Filtros utilizados, quantidade de registros | 7 anos |
| Exportar Relat√≥rio | EXPORT | Tipo de relat√≥rio, per√≠odo, filtros | 7 anos |
| Buscar Dados Sens√≠veis | SEARCH | Crit√©rios de busca (se incluem CPF, emails) | 7 anos |

### 4Ô∏è‚É£ Controle de Acesso (RBAC)

**Matriz de Permiss√µes por Perfil**:

| Perfil | READ | SEARCH | EXPORT | TIMELINE | COMPLIANCE | ANALYTICS |
|--------|------|--------|--------|----------|------------|-----------|
| **Super Administrador** | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| **Auditor** | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| **Gerente de Opera√ß√µes** | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚úÖ |
| **Administrador de Sistema** | ‚úÖ | ‚úÖ | ‚ùå | ‚úÖ | ‚ùå | ‚ùå |
| **Desenvolvedor** | ‚úÖ | ‚úÖ | ‚ùå | ‚úÖ | ‚ùå | ‚ùå |
| **Usu√°rio Final** | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå |

**Nota**: Usu√°rios podem visualizar apenas sua pr√≥pria auditoria (via permiss√£o especial `SYS.AUDITORIA.READ_OWN`).

---

## üìê REGRAS DE NEG√ìCIO

**Nota**: Este RF possui 15 regras de neg√≥cio. Apresenta√ß√£o resumida por brevidade.

### RN-AUD-001: Auditoria Autom√°tica via Interceptor
**Descri√ß√£o**: Todo Command/Query do MediatR que altere dados registra auditoria automaticamente
**Implementa√ß√£o**: `AuditingBehaviour<TRequest, TResponse>`

### RN-AUD-002: Snapshot Completo (Antes/Depois)
**Descri√ß√£o**: Armazenar estado completo antes e depois da opera√ß√£o
**Justificativa**: Permite reconstruir estado da entidade em qualquer ponto do tempo

### RN-AUD-003: Diff Estruturado (JSON Patch)
**Descri√ß√£o**: Calcular diff usando JSON Patch (RFC 6902)

### RN-AUD-004: Reten√ß√£o por Categoria (SOX/LGPD)
**Descri√ß√£o**:
- **7 anos**: Transa√ß√µes financeiras (SOX), dados pessoais (LGPD)
- **5 anos**: Contratos, documentos fiscais
- **1 ano**: Opera√ß√µes administrativas
- **90 dias**: Acessos de leitura n√£o cr√≠ticos

### RN-AUD-005: Imutabilidade Garantida
**Descri√ß√£o**: Tabela `Sistema_Auditoria` √© **append-only**. Sem UPDATE, sem DELETE.

### RN-AUD-006: Assinatura Digital (Integridade)
**Descri√ß√£o**: Calcular hash SHA-256 de cada registro

### RN-AUD-007: Detec√ß√£o de Anomalias
**Descri√ß√£o**: Detectar padr√µes suspeitos:
- Mais de 100 exporta√ß√µes em 1 hora
- Acesso a dados de mais de 50 empresas em 1 dia
- Opera√ß√µes fora do hor√°rio comercial (22h-6h)

### RN-AUD-008: Auditoria de LGPD
**Descri√ß√£o**: Registrar especificamente:
- **LGPD_ACCESS**: Acesso a CPF, emails, telefones
- **LGPD_EXPORT**: Exporta√ß√£o de dados pessoais
- **LGPD_CONSENT**: Registro de consentimento
- **LGPD_DELETION**: Solicita√ß√£o de exclus√£o
- **LGPD_PORTABILITY**: Exporta√ß√£o de dados

### RN-AUD-009: Timeline de Entidade
**Descri√ß√£o**: Endpoint `/api/auditoria/timeline/{entidade}/{id}` retorna todas as mudan√ßas

### RN-AUD-010: Contexto Enriquecido
**Descri√ß√£o**: Capturar:
- IP origem
- User-Agent completo
- Correlation ID
- Tenant (Empresa/Departamento)
- Request ID

### RN-AUD-011: Arquivamento Autom√°tico (Cold Storage)
**Descri√ß√£o**: Job mensal move registros > 1 ano para Azure Blob Storage

### RN-AUD-012: Segrega√ß√£o de Fun√ß√µes (SOX)
**Descri√ß√£o**: Detectar viola√ß√µes:
- Mesmo usu√°rio criou e aprovou transa√ß√£o financeira
- Desenvolvedor acessou produ√ß√£o sem ticket

### RN-AUD-013: Auditoria de Configura√ß√µes Cr√≠ticas
**Descri√ß√£o**: Mudan√ßas em configura√ß√µes cr√≠ticas exigem justificativa obrigat√≥ria

### RN-AUD-014: Busca Full-Text Otimizada
**Descri√ß√£o**: √çndice Full-Text em campos `Descricao`, `Dados_Antes`, `Dados_Depois`

### RN-AUD-015: Alertas de Retention Expirando
**Descri√ß√£o**: Enviar alerta 30 dias antes da expira√ß√£o de reten√ß√£o

---

## üóÉÔ∏è REFER√äNCIAS AO LEGADO

### Sistema Legado: Auditoria Limitada

**Tabela Legada**:
```sql
CREATE TABLE Auditoria (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    Usuario VARCHAR(200),
    Acao VARCHAR(500),
    Data DATETIME DEFAULT GETDATE()
);
```

**Problemas do Legado**:
1. ‚ùå **Sem Estrutura**: A√ß√£o armazenada como texto livre
2. ‚ùå **Sem Snapshot**: N√£o armazena estado antes/depois
3. ‚ùå **Sem IP/User-Agent**: N√£o registra origem
4. ‚ùå **Sem Reten√ß√£o Configur√°vel**: Todos com mesma reten√ß√£o
5. ‚ùå **Sem Imutabilidade**: Registros podem ser deletados
6. ‚ùå **Sem Diff**: Imposs√≠vel ver o que mudou
7. ‚ùå **Sem Categoriza√ß√£o**: Tudo misturado
8. ‚ùå **Sem Compliance**: N√£o atende LGPD, SOX, ISO 27001

---

## üõ†Ô∏è IMPLEMENTA√á√ÉO ATUAL

**Status**: ‚úÖ **Sistema j√° implementado e em produ√ß√£o**

**Arquivos Existentes**:
- `AuditingBehaviour.cs`: MediatR pipeline
- `AuditService.cs`: Servi√ßo de auditoria
- `AuditRepository.cs`: Acesso aos dados
- `Sistema_Auditoria` (tabela): 50+ milh√µes de registros

**Exemplo de Uso**:

```csharp
// Registro autom√°tico via MediatR
public class CriarUsuarioCommand : IRequest<UsuarioDto>
{
    public string Nome { get; set; }
    public string Email { get; set; }
}

// Registro manual (casos especiais)
await _auditService.Registrar(new AuditoriaDto {
    Tipo = "LGPD_CONSENT",
    Descricao = "Usu√°rio aceitou termos LGPD",
    Entidade = "Usuario",
    EntidadeId = usuario.Id_Usuario,
    Dados = new {
        TermoId = termo.Id_Termo,
        TermoVersao = termo.Versao,
        IpOrigem = HttpContext.Connection.RemoteIpAddress.ToString()
    },
    Retention = TimeSpan.FromDays(2555) // 7 anos
});
```

---

## üìä Categorias de Auditoria

| Categoria | Descri√ß√£o | Reten√ß√£o | Exemplos |
|-----------|-----------|----------|----------|
| **CRUD** | Criar, Ler, Atualizar, Deletar | 7 anos | Usuario criado, Fatura editada |
| **AUTH** | Autentica√ß√£o e autoriza√ß√£o | 1 ano | Login, Logout, Troca de senha |
| **EXPORT** | Exporta√ß√£o de dados | 7 anos | Relat√≥rio exportado, Dados baixados |
| **ACCESS** | Acesso a dados sens√≠veis | 7 anos | Visualizou CPF, Acessou dados financeiros |
| **CONFIG** | Mudan√ßas em configura√ß√µes | 7 anos | Par√¢metro alterado, Feature flag ativada |
| **LGPD** | Opera√ß√µes LGPD | 7 anos | Consentimento, Exclus√£o, Portabilidade |
| **FINANCIAL** | Transa√ß√µes financeiras | 7 anos | Fatura aprovada, Pagamento processado |
| **SECURITY** | Eventos de seguran√ßa | 7 anos | Falha de login, Acesso negado |
| **ADMIN** | Opera√ß√µes administrativas | 1 ano | Backup executado, Job agendado |
| **PRINT** | Impress√£o de documentos | 1 ano | Relat√≥rio impresso, Nota fiscal impressa |

---

**Pr√≥ximos Passos**: Criar MD-004 (Modelo de Dados) e Casos de Uso (UC00-UC02)
