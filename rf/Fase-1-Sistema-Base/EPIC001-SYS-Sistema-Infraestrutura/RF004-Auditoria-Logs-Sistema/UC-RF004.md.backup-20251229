# UC-RF004 ‚Äî Casos de Uso: Sistema de Auditoria e Logs do Sistema

**RF:** RF004 ‚Äî Sistema de Auditoria e Logs do Sistema
**Vers√£o:** 2.0
**Data:** 2025-12-29
**Autor:** Ag√™ncia ALC - alc.dev.br

---

## 1. OBJETIVO DO DOCUMENTO

Este documento descreve **todos os Casos de Uso (UC)** derivados do **RF004 ‚Äî Sistema de Auditoria e Logs do Sistema**, cobrindo integralmente o comportamento funcional esperado.

Os UCs aqui definidos servem como **contrato comportamental**, sendo a **fonte prim√°ria** para gera√ß√£o de:
- Casos de Teste (TC-RF004.yaml)
- Massas de Teste (MT-RF004.yaml)
- Evid√™ncias de auditoria e valida√ß√£o funcional
- Execu√ß√£o por agentes de IA (tester, QA, E2E)

**IMPORTANTE**: RF004 **N√ÉO √© um CRUD tradicional**. Registros de auditoria s√£o **eventos imut√°veis append-only**. N√£o h√° opera√ß√µes de CREATE, UPDATE ou DELETE pelo usu√°rio. Os UCs focam em **consulta, an√°lise e visualiza√ß√£o** de registros j√° criados automaticamente pelo sistema.

---

## 2. SUM√ÅRIO DE CASOS DE USO

| ID | Nome | Ator Principal | Regras Cobertas |
|----|------|----------------|-----------------|
| UC00 | Listar Registros de Auditoria | Auditor, Super Admin | RN-AUD-001, RN-AUD-010 |
| UC01 | Buscar com Filtros Avan√ßados | Auditor, Super Admin | RN-AUD-003, RN-AUD-010, RN-AUD-014 |
| UC02 | Visualizar Timeline de Entidade | Auditor, Super Admin | RN-AUD-002, RN-AUD-003, RN-AUD-009 |
| UC03 | Exportar Relat√≥rios de Compliance | Auditor, Super Admin | RN-AUD-004, RN-AUD-008 |
| UC04 | Visualizar Dashboards Anal√≠ticos | Gerente Opera√ß√µes, Super Admin | RN-AUD-004 |
| UC05 | Detectar e Visualizar Anomalias | Analista Seguran√ßa, Super Admin | RN-AUD-007, RN-AUD-012, RN-AUD-013 |
| UC06 | Validar Integridade (Hash SHA-256) | Auditor, Super Admin | RN-AUD-005, RN-AUD-006 |
| UC07 | Visualizar Detalhes de Registro | Auditor, Super Admin | RN-AUD-001, RN-AUD-002, RN-AUD-010, RN-AUD-011 |
| UC08 | Gerenciar Reten√ß√£o e Alertas | Administrador Sistema, Super Admin | RN-AUD-015 |

**Cobertura**: 15/15 Regras de Neg√≥cio (100%)

## 3. PADR√ïES GERAIS APLIC√ÅVEIS A TODOS OS UCs

- Todos os acessos respeitam **isolamento por tenant** (Tenant_Id)
- Todas as a√ß√µes exigem **permiss√£o expl√≠cita** (RBAC)
- Registros de auditoria s√£o **imut√°veis** (append-only, sem UPDATE/DELETE)
- Erros n√£o devem vazar informa√ß√µes sens√≠veis
- Mensagens devem ser claras, previs√≠veis e rastre√°veis
- Compliance obrigat√≥rio: **LGPD (Art. 37, 38, 46)**, **SOX (Se√ß√£o 404)**, **ISO 27001**

---

## UC00 ‚Äî Listar Registros de Auditoria

## üìã Informa√ß√µes B√°sicas

| Atributo | Valor |
|----------|-------|
| **Ator Principal** | Auditor, Super Administrador, Gerente de Opera√ß√µes |
| **Objetivo** | Visualizar registros de auditoria com filtros avan√ßados para compliance e investiga√ß√£o |
| **Pr√©-condi√ß√µes** | Usu√°rio autenticado com permiss√£o `SYS.AUDITORIA.READ` |
| **P√≥s-condi√ß√µes** | Lista de registros de auditoria exibida conforme filtros aplicados |
| **Complexidade** | Alta |

---

## üéØ Fluxo Principal

1. Usu√°rio acessa menu "Sistema ‚Üí Auditoria"
2. Sistema verifica permiss√£o `SYS.AUDITORIA.READ`
3. Sistema carrega √∫ltimos 1000 registros de auditoria (padr√£o: √∫ltimas 24h)
4. Sistema exibe grid com colunas:
   - **Data/Hora** (timestamp preciso)
   - **Usu√°rio** (nome + email)
   - **Opera√ß√£o** (badge colorido: CREATE=verde, UPDATE=azul, DELETE=vermelho, etc.)
   - **Entidade** (ex: Usuario, Fatura, Ativo)
   - **ID da Entidade**
   - **IP Origem**
   - **Dispositivo** (desktop/mobile/tablet)
   - **A√ß√µes**: Visualizar Detalhes, Ver Timeline
5. Usu√°rio pode:
   - Filtrar por per√≠odo (hoje, √∫ltima semana, √∫ltimo m√™s, customizado)
   - Filtrar por usu√°rio
   - Filtrar por tipo de opera√ß√£o
   - Filtrar por entidade
   - Buscar por ID da entidade espec√≠fica
   - Buscar full-text na descri√ß√£o
   - Paginar resultados (100 por p√°gina)

---

## üîÄ Fluxos Alternativos

### FA01: Filtrar por Per√≠odo Customizado
1. Usu√°rio clica em "Per√≠odo Customizado"
2. Sistema exibe calend√°rio date range picker
3. Usu√°rio seleciona data inicial e final
4. Sistema valida que per√≠odo <= 90 dias
5. Sistema recarrega grid com registros do per√≠odo

### FA02: Filtrar por Usu√°rio Espec√≠fico
1. Usu√°rio digita nome/email no campo "Usu√°rio"
2. Sistema exibe autocomplete com sugest√µes
3. Usu√°rio seleciona usu√°rio
4. Sistema filtra auditoria apenas desse usu√°rio

### FA03: Filtrar por Tipo de Opera√ß√£o
1. Usu√°rio seleciona tipo no dropdown (CREATE, UPDATE, DELETE, EXPORT, ACCESS, etc.)
2. Sistema filtra auditoria apenas desse tipo

### FA04: Buscar por ID de Entidade
1. Usu√°rio digita GUID no campo "ID da Entidade"
2. Sistema busca todos os registros relacionados a esse ID
3. Sistema exibe timeline de mudan√ßas

### FA05: Full-Text Search
1. Usu√°rio digita termo na busca global
2. Sistema busca em campos `Descricao`, `Dados_Antes`, `Dados_Depois`
3. Sistema destaca termo encontrado nos resultados

---

## üö´ Fluxos de Exce√ß√£o

### FE01: Usu√°rio Sem Permiss√£o
1. Sistema verifica que usu√°rio N√ÉO possui `SYS.AUDITORIA.READ`
2. Sistema exibe mensagem: "Voc√™ n√£o possui permiss√£o para acessar auditoria"
3. Sistema registra tentativa de acesso negado em auditoria
4. Sistema redireciona para dashboard

### FE02: Per√≠odo Muito Longo (> 90 dias)
1. Usu√°rio tenta selecionar per√≠odo > 90 dias
2. Sistema exibe erro: "Per√≠odo m√°ximo: 90 dias. Para per√≠odos maiores, use Export."
3. Sistema mant√©m sele√ß√£o anterior

### FE03: Nenhum Registro Encontrado
1. Filtros aplicados n√£o retornam nenhum resultado
2. Sistema exibe mensagem: "Nenhum registro de auditoria encontrado com os filtros aplicados"
3. Sistema sugere: "Tente ampliar o per√≠odo ou remover filtros"

### FE04: Timeout de Query (> 30 segundos)
1. Query SQL demora > 30 segundos
2. Sistema cancela query
3. Sistema exibe erro: "Busca muito abrangente. Por favor, refine os filtros."
4. Sistema sugere filtros espec√≠ficos

---

## üìä Detalhes de Um Registro

Ao clicar em "Visualizar Detalhes", sistema exibe modal com:

### Informa√ß√µes B√°sicas
- Data/Hora (com timezone)
- Usu√°rio (avatar + nome + email)
- IP Origem
- User-Agent completo
- Correlation ID (para rastrear request completo)
- Categoria (CRUD, LGPD, FINANCIAL, etc.)

### Dados da Opera√ß√£o
- Entidade afetada
- ID da entidade
- Tipo de opera√ß√£o

### Diff Estruturado (se UPDATE)
- **Antes**: JSON formatado com campos anteriores
- **Depois**: JSON formatado com campos novos
- **Diff Visual**: Campos alterados destacados em amarelo

### Contexto Adicional
- Tenant (Conglomerado/Empresa/Departamento)
- Motivo da opera√ß√£o (se fornecido)
- Ticket de refer√™ncia (para opera√ß√µes cr√≠ticas)

### Integridade
- Hash SHA-256 do registro
- Status de verifica√ß√£o (‚úÖ √çntegro | ‚ö†Ô∏è Modificado)

---

## üé® Elementos de Interface

### Grid de Auditoria
- **Linhas zebradas** (melhor leitura)
- **Badges coloridos** por tipo de opera√ß√£o:
  - CREATE: verde üü¢
  - UPDATE: azul üîµ
  - DELETE: vermelho üî¥
  - EXPORT: laranja üü†
  - ACCESS: roxo üü£
  - LOGIN: cinza ‚ö´
- **√çcones** por entidade (Usuario üë§, Fatura üìÑ, Ativo üíº, etc.)
- **Hover** exibe tooltip com descri√ß√£o completa

### Filtros
- **Per√≠odo**: Bot√µes r√°pidos (Hoje, √öltima Semana, √öltimo M√™s) + Date Range Picker
- **Usu√°rio**: Autocomplete com avatar
- **Opera√ß√£o**: Dropdown multi-select
- **Entidade**: Dropdown com √≠cones

### Pagina√ß√£o
- Exibir: "Mostrando 1-100 de 12,543 registros"
- Controles: ¬´ Primeira | ‚Äπ Anterior | 1 2 3 ... 126 | Pr√≥xima ‚Ä∫ | √öltima ¬ª
- Op√ß√£o de mudar page size (50, 100, 200)

---

## üìè Regras de Neg√≥cio Aplicadas

- **RN-AUD-001**: Auditoria autom√°tica j√° registrada via interceptor
- **RN-AUD-004**: Reten√ß√£o configur√°vel (registros expirados n√£o aparecem)
- **RN-AUD-005**: Imutabilidade garantida (sem bot√µes editar/deletar)
- **RN-AUD-006**: Hash SHA-256 exibido e verificado
- **RN-AUD-010**: Contexto enriquecido exibido (IP, User-Agent, etc.)
- **RN-AUD-014**: Busca full-text otimizada via √≠ndice

---

## üîí Seguran√ßa e Compliance

### LGPD
- Dados pessoais (CPF, emails) em auditoria s√£o mascarados para usu√°rios sem permiss√£o `LGPD_COMPLIANCE`
- Acesso √† auditoria √© auditado (recursivo)

### SOX
- Registros financeiros s√£o destacados com badge "SOX"
- Reten√ß√£o m√≠nima de 7 anos garantida

### ISO 27001
- Logs de seguran√ßa (falhas de login, acessos negados) filtr√°veis

---

**√öltima Atualiza√ß√£o:** 04/11/2025

---

# UC01: Exportar Relat√≥rios de Compliance

**Modelo de Dados**: [MD-004](../MD-004-Auditoria-Logs-Sistema.md)

---

## üìã Informa√ß√µes B√°sicas

| Atributo | Valor |
|----------|-------|
| **Ator Principal** | Auditor, Compliance Officer |
| **Objetivo** | Exportar relat√≥rios formatados de auditoria para compliance (LGPD, SOX, ISO 27001) |
| **Pr√©-condi√ß√µes** | Usu√°rio autenticado com permiss√£o `SYS.AUDITORIA.EXPORT` |
| **P√≥s-condi√ß√µes** | Relat√≥rio exportado em formato solicitado (PDF/Excel/CSV) |
| **Complexidade** | M√©dia |

---

## üéØ Fluxo Principal

1. Usu√°rio acessa "Sistema ‚Üí Auditoria"
2. Usu√°rio clica em bot√£o "Exportar Relat√≥rio"
3. Sistema exibe wizard de exporta√ß√£o com 4 etapas:

### Etapa 1: Tipo de Relat√≥rio
Sistema apresenta op√ß√µes:
- ‚úÖ **Relat√≥rio LGPD**: Acesso a dados pessoais, consentimentos, exclus√µes
- ‚úÖ **Relat√≥rio SOX**: Transa√ß√µes financeiras, segrega√ß√£o de fun√ß√µes
- ‚úÖ **Relat√≥rio ISO 27001**: Logs de seguran√ßa, acessos negados
- ‚úÖ **Relat√≥rio Customizado**: Filtros personalizados

### Etapa 2: Per√≠odo e Filtros
- **Per√≠odo**: Date range picker (obrigat√≥rio)
- **Filtros opcionais**:
  - Usu√°rio espec√≠fico
  - Tipo de opera√ß√£o
  - Entidade
  - Categoria (CRUD, EXPORT, ACCESS, etc.)

### Etapa 3: Formato de Sa√≠da
- üìÑ **PDF**: Relat√≥rio formatado para impress√£o/assinatura
- üìä **Excel**: Planilha com m√∫ltiplas abas (detalhes + sum√°rio)
- üìã **CSV**: Dados brutos para an√°lise
- üîó **JSON**: Formato estruturado para integra√ß√£o

### Etapa 4: Confirma√ß√£o
Sistema exibe preview:
- Total de registros: 1,234
- Per√≠odo: 01/01/2025 - 31/01/2025
- Formato: PDF
- Estimativa de tempo: ~2 minutos

4. Usu√°rio clica em "Gerar Relat√≥rio"
5. Sistema processa em background (job ass√≠ncrono)
6. Sistema exibe: "Relat√≥rio sendo gerado. Voc√™ receber√° um email quando estiver pronto."
7. Ao finalizar, sistema:
   - Envia email com link de download
   - Notifica via toast na interface (se usu√°rio ainda logado)
   - Registra exporta√ß√£o em auditoria

---

## üîÄ Fluxos Alternativos

### FA01: Relat√≥rio LGPD
**Conte√∫do espec√≠fico**:
- Se√ß√£o 1: **Acessos a Dados Pessoais**
  - CPFs acessados, por quem, quando
  - Emails consultados
  - Telefones visualizados
- Se√ß√£o 2: **Consentimentos**
  - Termos aceitos
  - Datas de aceite
  - Vers√µes dos termos
- Se√ß√£o 3: **Exclus√µes de Dados** (Art. 18 LGPD)
  - Solicita√ß√µes de exclus√£o
  - Dados deletados
  - Data de execu√ß√£o
- Se√ß√£o 4: **Portabilidade** (Art. 18 LGPD)
  - Exporta√ß√µes de dados pessoais solicitadas
- **Assinatura digital**: Hash SHA-256 do relat√≥rio

### FA02: Relat√≥rio SOX
**Conte√∫do espec√≠fico**:
- Se√ß√£o 1: **Transa√ß√µes Financeiras**
  - Faturas criadas/editadas/aprovadas
  - Pagamentos processados
  - Concilia√ß√µes banc√°rias
- Se√ß√£o 2: **Segrega√ß√£o de Fun√ß√µes**
  - Viola√ß√µes detectadas (ex: mesmo usu√°rio criou e aprovou)
  - Acessos a fun√ß√µes cr√≠ticas
- Se√ß√£o 3: **Mudan√ßas em Configura√ß√µes Cr√≠ticas**
  - Par√¢metros financeiros alterados
  - Justificativas obrigat√≥rias
- **Per√≠odo de reten√ß√£o**: M√≠nimo 7 anos

### FA03: Relat√≥rio ISO 27001
**Conte√∫do espec√≠fico**:
- Se√ß√£o 1: **Eventos de Seguran√ßa**
  - Falhas de login
  - Acessos negados
  - Tentativas de SQL injection detectadas
- Se√ß√£o 2: **Acessos Privilegiados**
  - Logins de Super Admin
  - Opera√ß√µes cr√≠ticas executadas
- Se√ß√£o 3: **Anomalias Detectadas**
  - Padr√µes suspeitos (RN-AUD-007)
  - Acessos fora do hor√°rio comercial

### FA04: Agendamento de Relat√≥rio Recorrente
1. Usu√°rio marca checkbox "Agendar recorr√™ncia"
2. Sistema exibe op√ß√µes:
   - Frequ√™ncia: Di√°ria, Semanal, Mensal
   - Dia da semana/m√™s
   - Hora de execu√ß√£o
   - Destinat√°rios de email
3. Sistema salva agendamento
4. Job executa automaticamente e envia por email

---

## üö´ Fluxos de Exce√ß√£o

### FE01: Per√≠odo Muito Longo (> 1 ano)
1. Usu√°rio seleciona per√≠odo > 1 ano
2. Sistema exibe warning: "Relat√≥rios muito longos podem demorar. Considere dividir em per√≠odos menores."
3. Sistema permite continuar (com confirma√ß√£o adicional)

### FE02: Nenhum Registro no Per√≠odo
1. Filtros aplicados n√£o retornam registros
2. Sistema exibe: "Nenhum registro encontrado no per√≠odo selecionado"
3. Sistema n√£o gera relat√≥rio vazio

### FE03: Falha na Gera√ß√£o do PDF
1. Job de gera√ß√£o falha (ex: timeout, memory limit)
2. Sistema envia email: "Falha ao gerar relat√≥rio. Por favor, reduza o per√≠odo ou filtros."
3. Sistema registra erro em logs

### FE04: Usu√°rio Sem Permiss√£o para Tipo Espec√≠fico
1. Usu√°rio tenta gerar "Relat√≥rio LGPD" sem permiss√£o `SYS.AUDITORIA.COMPLIANCE`
2. Sistema exibe: "Voc√™ n√£o possui permiss√£o para gerar relat√≥rios de compliance"
3. Sistema oculta op√ß√£o na UI

---

## üìä Formatos de Sa√≠da

### PDF
- **Cabe√ßalho**: Logo empresa, t√≠tulo, per√≠odo, data de gera√ß√£o
- **Rodap√©**: P√°gina X de Y, gerado por {usu√°rio}, hash SHA-256
- **Estilo**: Profissional, pronto para impress√£o
- **Assinatura digital**: QR Code com hash para verifica√ß√£o

### Excel
- **Aba 1**: Sum√°rio executivo (gr√°ficos, KPIs)
- **Aba 2**: Detalhes (grid com todos os registros)
- **Aba 3**: Metadados (filtros aplicados, usu√°rio gerador)
- **Formata√ß√£o**: Tabelas com auto-filter, freeze panes

### CSV
- **Encoding**: UTF-8 com BOM
- **Separador**: V√≠rgula (,)
- **Escape**: Aspas duplas para campos com v√≠rgula
- **Primeira linha**: Headers

### JSON
- **Formato**: JSON Lines (cada linha = 1 registro)
- **Estrutura**: Flat (sem nested objects profundos)
- **Metadados**: Inclu√≠dos no in√≠cio do arquivo

---

## üé® Elementos de Interface

### Wizard de Exporta√ß√£o
- **Stepper visual**: 4 etapas numeradas
- **Bot√µes**: Voltar, Pr√≥ximo, Cancelar, Gerar
- **Preview**: Resumo antes de gerar
- **Progress bar**: Durante gera√ß√£o (se s√≠ncrono)

### Hist√≥rico de Exporta√ß√µes
- Grid com exporta√ß√µes anteriores:
  - Data/hora
  - Tipo de relat√≥rio
  - Per√≠odo
  - Formato
  - Status (‚úÖ Conclu√≠do | ‚è≥ Processando | ‚ùå Falhou)
  - A√ß√£o: Download (dispon√≠vel por 30 dias)

---

## üìè Regras de Neg√≥cio Aplicadas

- **RN-AUD-004**: Reten√ß√£o configur√°vel (apenas registros dentro do per√≠odo de reten√ß√£o)
- **RN-AUD-006**: Assinatura digital SHA-256 em todos os relat√≥rios
- **RN-AUD-008**: Relat√≥rios LGPD seguem Art. 18 (acesso, exclus√£o, portabilidade)
- **RN-AUD-012**: Relat√≥rios SOX detectam viola√ß√µes de segrega√ß√£o de fun√ß√µes

---

## üîí Seguran√ßa e Compliance

### Auditoria da Exporta√ß√£o
Toda exporta√ß√£o √© registrada com:
- Tipo de relat√≥rio
- Per√≠odo exportado
- Filtros aplicados
- Formato
- Quantidade de registros
- Usu√°rio solicitante
- IP origem

### Dados Sens√≠veis
- Relat√≥rios incluindo dados pessoais exigem permiss√£o especial
- Email de download tem link com token de seguran√ßa (expira em 24h)
- Arquivos armazenados temporariamente (30 dias) em Azure Blob Storage privado

---

**√öltima Atualiza√ß√£o:** 04/11/2025

---

# UC02: Visualizar Timeline de Entidade

**Modelo de Dados**: [MD-004](../MD-004-Auditoria-Logs-Sistema.md)

---

## üìã Informa√ß√µes B√°sicas

| Atributo | Valor |
|----------|-------|
| **Ator Principal** | Auditor, Administrador, Gerente de Opera√ß√µes |
| **Objetivo** | Visualizar hist√≥rico completo de mudan√ßas de uma entidade espec√≠fica |
| **Pr√©-condi√ß√µes** | Usu√°rio autenticado com permiss√£o `SYS.AUDITORIA.TIMELINE` |
| **P√≥s-condi√ß√µes** | Timeline visual exibida com todas as mudan√ßas da entidade |
| **Complexidade** | M√©dia |

---

## üéØ Fluxo Principal

1. Usu√°rio acessa detalhes de uma entidade (ex: Usu√°rio, Fatura, Ativo)
2. Usu√°rio clica em bot√£o "Ver Hist√≥rico" ou aba "Timeline"
3. Sistema chama API: `GET /api/auditoria/timeline/{entidade}/{id}`
4. Sistema carrega todos os registros de auditoria dessa entidade
5. Sistema exibe timeline visual:
   - **Formato**: Linha do tempo vertical (mais recente no topo)
   - **Cada evento** cont√©m:
     - Data/hora
     - Usu√°rio que fez a mudan√ßa (avatar + nome)
     - Tipo de opera√ß√£o (badge colorido)
     - Descri√ß√£o da mudan√ßa
     - Diff visual (campos alterados)
     - A√ß√µes: Ver Detalhes Completos

---

## üé® Visualiza√ß√£o da Timeline

### Exemplo: Timeline de Um Usu√°rio

```
üìÖ 2025-11-04 14:30:25 | Jo√£o Silva üë§ | UPDATE üîµ
‚îú‚îÄ Email alterado:
‚îÇ  ‚îú‚îÄ Antes: joao@old.com
‚îÇ  ‚îî‚îÄ Depois: joao.silva@empresa.com
‚îî‚îÄ Departamento alterado:
   ‚îú‚îÄ Antes: Vendas
   ‚îî‚îÄ Depois: Marketing

üìÖ 2025-11-03 09:15:10 | Maria Santos üë§ | UPDATE üîµ
‚îú‚îÄ Perfil de acesso alterado:
‚îÇ  ‚îú‚îÄ Antes: Usu√°rio Padr√£o
‚îÇ  ‚îî‚îÄ Depois: Administrador
‚îî‚îÄ ‚ö†Ô∏è Mudan√ßa cr√≠tica detectada

üìÖ 2025-10-15 16:45:00 | Sistema ü§ñ | UPDATE üîµ
‚îî‚îÄ Senha alterada (reset via email)

üìÖ 2025-10-01 10:00:00 | Admin Master üë§ | CREATE üü¢
‚îî‚îÄ Usu√°rio criado
   ‚îú‚îÄ Nome: Jo√£o Silva
   ‚îú‚îÄ Email: joao@old.com
   ‚îú‚îÄ Departamento: Vendas
   ‚îî‚îÄ Perfil: Usu√°rio Padr√£o
```

---

## üîÄ Fluxos Alternativos

### FA01: Filtrar Timeline por Tipo de Opera√ß√£o
1. Usu√°rio seleciona filtro "Apenas Atualiza√ß√µes" (UPDATE)
2. Sistema oculta eventos CREATE, DELETE
3. Timeline exibe apenas UPDATEs

### FA02: Filtrar por Per√≠odo
1. Usu√°rio seleciona "√öltimos 30 dias"
2. Sistema filtra eventos do per√≠odo
3. Exibe contador: "Mostrando 12 de 45 eventos"

### FA03: Filtrar por Usu√°rio que Fez a Mudan√ßa
1. Usu√°rio clica em avatar de um usu√°rio espec√≠fico
2. Sistema filtra apenas mudan√ßas feitas por esse usu√°rio

### FA04: Expandir/Colapsar Todos os Eventos
1. Usu√°rio clica em "Colapsar Todos"
2. Sistema oculta detalhes dos diffs, mostra apenas t√≠tulos
3. Timeline fica mais compacta

### FA05: Comparar Duas Vers√µes
1. Usu√°rio seleciona checkbox em 2 eventos diferentes
2. Usu√°rio clica em "Comparar Vers√µes"
3. Sistema exibe modal side-by-side:
   - Coluna esquerda: Vers√£o 1
   - Coluna direita: Vers√£o 2
   - Diff destacado em cores

---

## üö´ Fluxos de Exce√ß√£o

### FE01: Entidade Sem Hist√≥rico
1. Entidade foi criada mas nunca modificada
2. Sistema exibe apenas evento CREATE
3. Mensagem: "Nenhuma altera√ß√£o desde a cria√ß√£o"

### FE02: Entidade N√£o Encontrada
1. ID da entidade n√£o existe
2. Sistema exibe: "Entidade n√£o encontrada"
3. Timeline vazia

### FE03: Muitos Eventos (> 1000)
1. Entidade tem > 1000 eventos de auditoria
2. Sistema carrega apenas √∫ltimos 1000
3. Exibe aviso: "Exibindo √∫ltimos 1000 eventos. Use filtros para ver mais."
4. Oferece bot√£o "Carregar Mais"

### FE04: Dados Deletados (Soft Delete)
1. Entidade foi exclu√≠da (soft delete: Fl_Ativo=0)
2. Timeline mostra evento DELETE no topo
3. Badge vermelho: "‚ùå Entidade Exclu√≠da"
4. Op√ß√£o: "Ver Estado Antes da Exclus√£o"

---

## üìä Elementos de Interface

### Timeline Visual
- **Linha vertical** conectando todos os eventos
- **C√≠rculos** coloridos por tipo de opera√ß√£o
- **Cards expand√≠veis** para cada evento
- **Avatares** dos usu√°rios que fizeram mudan√ßas
- **Timestamps relativos**: "h√° 2 horas", "ontem", "15 dias atr√°s"

### Diff Visual (Dentro de Cada Evento)
- **Campos inalterados**: Cinza claro (collapsed por padr√£o)
- **Campos alterados**: Destacados em amarelo
- **Valor anterior**: Tachado, vermelho claro
- **Valor novo**: Verde claro, negrito

### Controles
- **Filtros**: Per√≠odo, Tipo de Opera√ß√£o, Usu√°rio
- **Busca**: Full-text dentro dos eventos
- **Exportar**: Timeline completa em PDF
- **Scroll infinito**: Carrega mais eventos ao rolar

---

## üîç Detalhes de Um Evento

Ao clicar em "Ver Detalhes Completos", modal exibe:

### Cabe√ßalho
- Data/hora precisa (com timezone)
- Usu√°rio (avatar + nome + email + departamento)
- IP origem
- User-Agent (navegador + SO)
- Correlation ID

### Corpo
- **Tipo de opera√ß√£o**: Badge grande colorido
- **Descri√ß√£o**: Texto leg√≠vel (ex: "Email alterado de X para Y")
- **Entidade**: Nome + ID + link para a entidade (se ainda existe)

### Mudan√ßas (se UPDATE)
- Tabela comparativa:
  | Campo | Valor Anterior | Valor Novo |
  |-------|----------------|------------|
  | Email | joao@old.com | joao.silva@empresa.com |
  | Depto | Vendas | Marketing |

### JSON Raw (Toggle)
- **Dados Antes**: JSON formatado
- **Dados Depois**: JSON formatado
- Bot√£o "Copiar JSON"

### Metadados
- Categoria (CRUD, LGPD, FINANCIAL, etc.)
- Reten√ß√£o (7 anos para financeiro, 1 ano para admin, etc.)
- Hash SHA-256
- Status de integridade

---

## üìè Regras de Neg√≥cio Aplicadas

- **RN-AUD-002**: Snapshot completo (antes/depois) exibido
- **RN-AUD-003**: Diff estruturado (JSON Patch) calculado e exibido
- **RN-AUD-005**: Imutabilidade (sem bot√µes editar/deletar na timeline)
- **RN-AUD-006**: Hash SHA-256 verificado e exibido
- **RN-AUD-009**: Endpoint `/api/auditoria/timeline/{entidade}/{id}` implementado
- **RN-AUD-010**: Contexto enriquecido (IP, User-Agent) exibido

---

## üîí Seguran√ßa e Compliance

### Controle de Acesso
- Usu√°rios s√≥ veem timeline de entidades que t√™m permiss√£o para acessar
- Ex: Usu√°rio do Depto A n√£o v√™ timeline de entidades do Depto B (multi-tenant)

### Dados Sens√≠veis
- CPF, senhas, tokens s√£o mascarados na timeline
- Apenas Super Admin com `SYS.AUDITORIA.DECRYPT` v√™ valores reais

### LGPD
- Timeline de dados pessoais marca eventos LGPD (consentimento, acesso, exclus√£o)
- Badge especial "LGPD" para esses eventos

---

## üéØ Casos de Uso Pr√°ticos

### Investiga√ß√£o de Fraude
> Auditor suspeita que fatura foi alterada ap√≥s aprova√ß√£o
> - Acessa timeline da fatura
> - V√™ que campo "Valor" foi alterado de R$ 1.000 para R$ 10.000
> - Identifica usu√°rio e timestamp da mudan√ßa
> - Exporta timeline como evid√™ncia

### Troubleshooting de Bug
> Desenvolvedor investiga por que usu√°rio n√£o consegue logar
> - Acessa timeline do usu√°rio
> - V√™ evento: "Senha alterada pelo Sistema (3 tentativas falhadas)"
> - Identifica que conta foi bloqueada automaticamente
> - Soluciona desbloqueando a conta

### Compliance SOX
> Auditor externo pede prova de quem aprovou transa√ß√£o financeira
> - Acessa timeline da transa√ß√£o
> - V√™ evento: "Aprovada por Maria Santos em 15/10/2025 10:30"
> - Exporta timeline formatada em PDF
> - Entrega para auditor externo

---

**√öltima Atualiza√ß√£o:** 04/11/2025

---

## Hist√≥rico de Altera√ß√µes

| Vers√£o | Data | Autor | Descri√ß√£o |
|--------|------|-------|-----------|
| 1.0 | 2025-12-17 | Sistema | Consolida√ß√£o de 3 casos de uso |
