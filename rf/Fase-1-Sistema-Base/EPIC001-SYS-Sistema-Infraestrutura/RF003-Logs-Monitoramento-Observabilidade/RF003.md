# RF-003: Sistema de Logs, Monitoramento e Observabilidade

**Versão**: 2.0
**Data**: 2025-12-29
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC001-SYS - Sistema e Infraestrutura
**Fase**: Fase 1 - Fundação e Cadastros Base

---

## 1. OBJETIVO DO REQUISITO

Implementar o **Sistema de Logs, Monitoramento e Observabilidade** do IControlIT, fornecendo visibilidade completa da saúde do sistema, troubleshooting rápido de problemas, métricas de performance e compliance com requisitos de auditoria (LGPD, SOX, ISO 27001).

Este é um requisito **CRÍTICO EM PRODUÇÃO** pois permite:

1. **Troubleshooting Rápido**: Diagnosticar problemas em minutos (não horas)
2. **SLA 99.9%**: Detectar e resolver incidentes antes de afetar usuários
3. **Compliance**: Auditoria de logs para LGPD, SOX, ISO 27001
4. **Performance**: Identificar gargalos (queries lentas, memory leaks)
5. **Segurança**: Detectar ataques (SQL injection, XSS, DDoS)
6. **DevOps**: Integração com CI/CD, alertas em produção

Este documento **não define implementação técnica** (Serilog, Seq, Elasticsearch), apenas **o que o sistema deve fazer**, sob quais condições e quais garantias devem ser preservadas.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- ✅ Logs estruturados JSON (pesquisáveis)
- ✅ Níveis configuráveis de log (Verbose, Debug, Info, Warning, Error, Fatal)
- ✅ Agregação centralizada de logs (todos os servidores)
- ✅ Correlation IDs (rastreamento end-to-end de requests)
- ✅ Mascaramento automático de dados sensíveis (CPF, senhas, cartões)
- ✅ Métricas de performance (response time, throughput, error rate)
- ✅ Dashboards visuais de saúde do sistema
- ✅ Health checks (liveness e readiness probes)
- ✅ Tracing distribuído entre microservices
- ✅ Alertas proativos quando métricas excedem limites
- ✅ Log sampling para otimização de custos
- ✅ Circuit breaker (logging não derruba aplicação)
- ✅ Busca full-text em logs
- ✅ Export de logs para compliance (CSV/JSON)
- ✅ Retenção automática de logs (LGPD + SOX)

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (Seq UI, Grafana são sugestões técnicas, não contrato)
- Tecnologia de logging (Serilog é sugestão, não obrigação)
- Tecnologia de agregação (Seq vs Elasticsearch é decisão de infraestrutura)
- Layout de dashboards (design visual)
- Estratégia de deploy de Prometheus/Grafana (infraestrutura)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Log** | Registro de evento do sistema com timestamp, nível, mensagem e metadados |
| **Nível de Log** | Classificação de severidade: Verbose, Debug, Info, Warning, Error, Fatal |
| **Correlation ID** | GUID único que rastreia um request end-to-end através de múltiplos serviços |
| **Structured Logging** | Logs em formato JSON com campos pesquisáveis (não texto plano) |
| **Mascaramento** | Substituição automática de dados sensíveis por asteriscos antes de logar |
| **Sampling** | Estratégia de logar apenas % de requests bem-sucedidos para reduzir custos |
| **Circuit Breaker** | Padrão que garante que falha de logging não derruba aplicação principal |
| **RED Metrics** | Rate (requests/s), Errors (%), Duration (latency P50/P95/P99) |
| **Health Check** | Endpoint que retorna status de dependências (DB, Redis, Azure Blob) |
| **Tracing Distribuído** | Rastreamento de latência de cada microservice em request distribuído |
| **Retention Policy** | Política de retenção de logs (90 dias, 1 ano, 7 anos) conforme tipo |

---

## 4. FUNCIONALIDADES COBERTAS

### 4.1 Logging Estruturado

1. ✅ Logar eventos do sistema em formato JSON estruturado
2. ✅ Incluir metadados automaticamente (timestamp, nível, correlation ID, usuário, IP)
3. ✅ Mascarar dados sensíveis antes de logar (CPF, senhas, cartões)
4. ✅ Aplicar sampling (10% de requests bem-sucedidos)
5. ✅ Logar 100% de erros (sem sampling)

### 4.2 Agregação e Busca

6. ✅ Centralizar logs de todos os servidores em único local
7. ✅ Permitir busca full-text por mensagem, erro, correlation ID, usuário
8. ✅ Filtrar logs por nível, período, servidor, tenant
9. ✅ Exportar logs filtrados para CSV/JSON

### 4.3 Métricas de Performance

10. ✅ Coletar métricas RED automaticamente (Rate, Errors, Duration)
11. ✅ Exibir dashboards visuais de saúde do sistema
12. ✅ Alertar quando métricas excedem limites (error rate > 5%, P95 latency > 3s)

### 4.4 Health Checks e Tracing

13. ✅ Expor endpoint `/health` retornando status de dependências
14. ✅ Rastrear latência de cada microservice em requests distribuídos
15. ✅ Propagar trace context via W3C Trace Context standard

---

## 5. REGRAS DE NEGÓCIO

### RN-LOG-001 — Logs Estruturados JSON

**Descrição**: Todos os logs devem ser gerados em formato JSON estruturado (não texto plano) para permitir queries e análises complexas.

**Justificativa**: Texto plano é impossível de buscar por campos específicos. JSON permite queries como "todos os erros do usuário X entre 10h-11h com correlation ID Y".

**Critério de Aceite**:
- Log em texto plano (ex: `"2023-10-15 - Erro"`) → rejeição
- Log em JSON com campos obrigatórios (Timestamp, Level, Message, CorrelationId) → aceito

**Campos Obrigatórios do Log**:
- `Timestamp` (ISO 8601)
- `Level` (Verbose/Debug/Information/Warning/Error/Fatal)
- `Message` (string)
- `CorrelationId` (GUID)
- `UserId` (se request autenticado)
- `TenantId` (se multi-tenant)
- `IP` (endereço IP do cliente)
- `UserAgent` (navegador/app)

**Exemplo de Log Estruturado**:
```json
{
  "Timestamp": "2025-12-29T14:23:45.123Z",
  "Level": "Error",
  "Message": "Erro ao salvar usuário: FK constraint violation",
  "CorrelationId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "UserId": "user@example.com",
  "TenantId": "tenant-123",
  "IP": "192.168.1.100",
  "UserAgent": "Mozilla/5.0",
  "Exception": {
    "Type": "DbUpdateException",
    "Message": "FK constraint violation",
    "StackTrace": "..."
  }
}
```

---

### RN-LOG-002 — Níveis de Log por Ambiente

**Descrição**: Nível mínimo de log configurável por ambiente para reduzir ruído em produção.

**Justificativa**: Logs `Debug` em produção geram volume massivo de dados (custos altos, difícil buscar). Em desenvolvimento, `Debug` é essencial para troubleshooting.

**Critério de Aceite**:
- **DEV**: Nível mínimo `Debug` (todos os logs)
- **HOM**: Nível mínimo `Information` (sem Verbose/Debug)
- **PRD**: Nível mínimo `Warning` (sem Verbose/Debug/Information de sucesso)

**Exceção**: Erros (4xx, 5xx) SEMPRE logados em todos os ambientes (RN-LOG-006).

---

### RN-LOG-003 — Correlation IDs Obrigatórios

**Descrição**: Todo request recebe GUID único (`Correlation-ID` header) propagado em toda a cadeia de execução (API → Command → Query → Database → External API).

**Justificativa**: Permite rastrear request end-to-end mesmo em arquitetura distribuída. Essencial para debugging de problemas intermitentes.

**Critério de Aceite**:
- Request sem `Correlation-ID` header → sistema gera GUID automaticamente
- `Correlation-ID` propagado em todos os logs daquele request
- `Correlation-ID` propagado para chamadas de APIs externas (header `Correlation-ID`)

**Exemplo de Propagação**:
```
Request → API (log: "Request recebido", CorrelationId: "abc123")
        → Command (log: "Executando CreateUsuarioCommand", CorrelationId: "abc123")
        → Database (log: "INSERT INTO Usuario", CorrelationId: "abc123")
        → External API (header: "Correlation-ID: abc123", log: "Chamando Azure Blob", CorrelationId: "abc123")
```

Buscar por `CorrelationId: "abc123"` retorna TODOS os logs desse request.

---

### RN-LOG-004 — Mascaramento Automático de Dados Sensíveis

**Descrição**: CPF, senhas, cartões de crédito e outros dados sensíveis devem ser mascarados ANTES de logar (substituição por `***`).

**Justificativa**: Compliance LGPD (não logar dados pessoais), PCI-DSS (não logar dados de cartão).

**Critério de Aceite**:
- Log contendo CPF `123.456.789-00` → mascarado como `***.***.*89-**`
- Log contendo senha → mascarado como `***`
- Log contendo cartão `4111 1111 1111 1111` → mascarado como `**** **** **** 1111`

**Dados a Mascarar**:
- CPF (regex: `\d{3}\.\d{3}\.\d{3}-\d{2}`)
- Senhas (campos: `password`, `senha`, `pwd`)
- Cartões de crédito (regex: `\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}`)
- Tokens de API (campos: `api_key`, `token`, `secret`)

---

### RN-LOG-005 — Sampling em Produção (10%)

**Descrição**: Em produção, logar apenas **10% dos requests bem-sucedidos** (HTTP 200 OK) para reduzir custos de armazenamento (Elasticsearch/Seq).

**Justificativa**: Sistema com 1M requests/dia geraria 1M logs. Com sampling 10%, gera apenas 100k logs (redução 90% de custos), mantendo visibilidade estatística.

**Critério de Aceite**:
- Request bem-sucedido (HTTP 200) → 10% de probabilidade de logar
- Request com erro (4xx, 5xx) → SEMPRE logar (RN-LOG-006)
- Sampling calculado via `Random(0-100) < 10`

**Nota**: Sampling NUNCA se aplica a erros.

---

### RN-LOG-006 — 100% de Erros Sempre Logados

**Descrição**: Erros (HTTP 4xx, 5xx, exceções não tratadas) SEMPRE são logados, **independente de sampling**.

**Justificativa**: Não perder nenhum erro crítico que possa impactar SLA ou experiência do usuário.

**Critério de Aceite**:
- Request com HTTP 400 → log criado (mesmo com sampling 10%)
- Request com HTTP 500 → log criado
- Exceção não tratada → log criado
- Request com HTTP 200 → log criado apenas se passar no sampling (10%)

---

### RN-LOG-007 — Circuit Breaker para Logging

**Descrição**: Se sistema de logging (Seq/Elasticsearch) falhar, aplicação continua funcionando normalmente, gravando logs em arquivo local temporário.

**Justificativa**: Logging nunca deve derrubar a aplicação principal. Logs são importantes, mas não críticos para funcionamento do sistema.

**Critério de Aceite**:
- Seq/Elasticsearch indisponível → logs vão para `logs/log-YYYY-MM-DD.txt`
- Seq/Elasticsearch volta → logs voltam para Seq/Elasticsearch
- Aplicação NUNCA lança exceção por falha de logging

**Padrão Circuit Breaker**:
- 5 falhas consecutivas → abre circuit breaker (usa fallback)
- 30 segundos no estado "open" → tenta 1 request (half-open)
- Request bem-sucedido → fecha circuit breaker (volta ao normal)

---

### RN-LOG-008 — Retenção Automática por Tipo

**Descrição**: Logs têm retenção automática baseada em tipo e severidade, conforme compliance LGPD e SOX.

**Justificativa**: LGPD exige não reter dados pessoais além do necessário. SOX exige reter logs de auditoria por 7 anos.

**Critério de Aceite**:

| Tipo de Log | Retenção | Justificativa |
|-------------|----------|---------------|
| Info/Debug | 90 dias | LGPD (dados pessoais) |
| Warning/Error | 1 ano | Troubleshooting histórico |
| Logs de Segurança (login, acesso, permissão) | 7 anos | SOX/ISO 27001 |
| Logs de Auditoria (create/update/delete) | 7 anos | SOX |

**Automação**: Job diário deleta logs expirados.

---

### RN-LOG-009 — Métricas RED (Rate, Errors, Duration)

**Descrição**: Sistema deve coletar automaticamente métricas RED para todos os endpoints:
- **Rate**: Requests por segundo
- **Errors**: % de erros (4xx + 5xx)
- **Duration**: Latência (P50, P95, P99)

**Justificativa**: Padrão da indústria para monitoramento. Permite detectar degradação de performance antes de afetar usuários.

**Critério de Aceite**:
- **Rate**: Contador incrementado a cada request (endpoint `/metrics`)
- **Errors**: Contador incrementado em 4xx/5xx
- **Duration**: Histogram com buckets (< 100ms, < 500ms, < 1s, < 3s, > 3s)
- Métricas expostas em formato Prometheus
- Dashboards Grafana pré-configurados

---

### RN-LOG-010 — Health Checks /health Endpoint

**Descrição**: Endpoint `/health` retorna status de todas as dependências (Database, Redis, Azure Blob Storage, APIs Externas).

**Justificativa**: Kubernetes liveness/readiness probes. Load balancer remove instância unhealthy do pool.

**Critério de Aceite**:
- **Healthy**: Todas as dependências OK → HTTP 200
- **Degraded**: Algumas dependências falham mas sistema funcional → HTTP 200 com warning
- **Unhealthy**: Dependências críticas falham → HTTP 503

**Exemplo de Resposta**:
```json
{
  "status": "Healthy",
  "checks": {
    "database": { "status": "Healthy", "responseTime": "15ms" },
    "redis": { "status": "Healthy", "responseTime": "5ms" },
    "azure_blob": { "status": "Degraded", "responseTime": "3000ms", "warning": "Slow response" },
    "external_api": { "status": "Unhealthy", "error": "Connection timeout" }
  }
}
```

---

### RN-LOG-011 — Alertas Automáticos

**Descrição**: Sistema dispara alertas (PagerDuty/Opsgenie/Slack/Teams) quando métricas excedem limites pré-configurados.

**Justificativa**: Detecção proativa de problemas antes de afetar usuários. SLA 99.9% exige resposta em < 5 minutos.

**Critério de Aceite**:

| Métrica | Limite | Ação |
|---------|--------|------|
| Error rate | > 5% por 5 minutos | Alerta crítico (PagerDuty) |
| P95 latency | > 3 segundos | Alerta warning (Slack) |
| CPU | > 80% por 10 minutos | Alerta warning (Slack) |
| Memória | > 90% | Alerta crítico (PagerDuty) |
| Database connections | > 90% do pool | Alerta warning (Slack) |
| Health check unhealthy | Qualquer dependência | Alerta crítico (PagerDuty) |

**Configurabilidade**: Limites e canais de notificação devem ser configuráveis por ambiente (DEV/HOM/PRD).

---

### RN-LOG-012 — Tracing Distribuído OpenTelemetry

**Descrição**: Sistema propaga trace context entre serviços via W3C Trace Context standard, permitindo visualizar latência de cada microservice.

**Justificativa**: Em arquitetura de microservices, request passa por múltiplos serviços. Tracing distribuído permite identificar qual serviço está lento.

**Critério de Aceite**:
- Trace context propagado via headers `traceparent` e `tracestate`
- Cada span registra: service name, operation name, start time, duration, tags, logs
- Spans exportados para Jaeger/Zipkin/Application Insights
- Correlação automática com `CorrelationId` (RN-LOG-003)

**Exemplo de Trace**:
```
Request (total: 500ms)
├─ API Gateway (50ms)
├─ Auth Service (30ms)
├─ Business Logic (200ms)
│  ├─ Database Query (150ms) ← GARGALO IDENTIFICADO
│  └─ Cache Lookup (50ms)
└─ Response Serialization (20ms)
```

---

## 6. ESTADOS DA ENTIDADE

Não aplicável. Este RF não gerencia estados de entidades, apenas registra eventos do sistema.

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre | Subscribers | Ação |
|--------|---------------|-------------|------|
| `LogRecordedEvent` | Ao logar qualquer evento | Agregação (Seq/Elasticsearch), Alertas | Persiste log, dispara alerta se necessário |
| `ErrorRateThresholdExceededEvent` | Quando error rate > 5% | Alertas (PagerDuty) | Dispara alerta crítico |
| `HealthCheckUnhealthyEvent` | Quando dependência crítica falha | Alertas (PagerDuty), Kubernetes | Dispara alerta, remove instância do pool |
| `CircuitBreakerOpenedEvent` | Quando logging falha 5x consecutivas | Monitoramento | Notifica DevOps via Slack |

---

## 8. INTEGRAÇÕES OBRIGATÓRIAS

### 8.1 Central de Funcionalidades

**Código**: `FNC-SYS-003`
**Nome**: Sistema de Logs, Monitoramento e Observabilidade
**Categoria**: Sistema / Infraestrutura
**Tipo**: Tela + API + Dashboard

**Permissões Requeridas**:
- `SYS.LOGS.READ` - Visualizar logs do sistema
- `SYS.LOGS.SEARCH` - Buscar logs com filtros avançados
- `SYS.LOGS.EXPORT` - Exportar logs para CSV/JSON
- `SYS.METRICS.READ` - Visualizar métricas e dashboards
- `SYS.HEALTH.READ` - Verificar health checks
- `SYS.ALERTS.READ` - Visualizar alertas configurados
- `SYS.ALERTS.UPDATE` - Configurar alertas e thresholds

### 8.2 Auditoria

**Operações Auditadas**:

| Operação | Tipo | Dados Registrados | Retenção |
|----------|------|-------------------|----------|
| Visualizar Logs | ACCESS | Filtros utilizados, quantidade de registros | 90 dias |
| Exportar Logs | EXPORT | Período exportado, formato, filtros | 7 anos |
| Configurar Alerta | UPDATE | Configuração anterior vs nova | 7 anos |
| Desabilitar Alerta Crítico | UPDATE | Motivo, usuário, timestamp | 7 anos |
| Acesso a Logs de Segurança | ACCESS | IP, user-agent, logs acessados | 7 anos |

**Nota**: Os próprios logs do sistema já são auditoria. Esta seção registra acesso/manipulação dos logs.

---

## 9. SEGURANÇA

### 9.1 Isolamento de Tenant

Logs **não possuem isolamento por tenant**, pois são visíveis apenas para perfis de infraestrutura (DevOps, Super Admin). Usuários finais **não têm acesso** a logs do sistema.

**Exceção**: Logs de auditoria de operações de usuários (create/update/delete) são filtrados por tenant quando exibidos via telas de auditoria funcional (RF-004).

### 9.2 Controle de Permissões

| Operação | Permissão Necessária | Perfis com Acesso |
|----------|---------------------|-------------------|
| Visualizar logs | `SYS.LOGS.READ` | Super Admin, Admin DevOps, Admin Sistema, Gerente Operações, Desenvolvedor, Auditor |
| Buscar logs | `SYS.LOGS.SEARCH` | Super Admin, Admin DevOps, Admin Sistema, Gerente Operações, Desenvolvedor, Auditor |
| Exportar logs | `SYS.LOGS.EXPORT` | Super Admin, Admin DevOps, Admin Sistema, Gerente Operações, Auditor |
| Visualizar métricas | `SYS.METRICS.READ` | Super Admin, Admin DevOps, Admin Sistema, Gerente Operações, Desenvolvedor |
| Verificar health checks | `SYS.HEALTH.READ` | Super Admin, Admin DevOps, Admin Sistema, Gerente Operações, Desenvolvedor |
| Visualizar alertas | `SYS.ALERTS.READ` | Super Admin, Admin DevOps, Admin Sistema, Gerente Operações, Desenvolvedor |
| Configurar alertas | `SYS.ALERTS.UPDATE` | Super Admin, Admin DevOps |

---

## 10. DEPENDÊNCIAS TÉCNICAS

**Integrações Externas Sugeridas** (não obrigatórias, sugestões técnicas):
- **Serilog**: Biblioteca de logging estruturado (.NET)
- **Seq**: Agregação centralizada de logs (dev/hom)
- **Elasticsearch**: Agregação centralizada de logs (produção)
- **Prometheus**: Coleta de métricas
- **Grafana**: Dashboards visuais
- **OpenTelemetry**: Tracing distribuído
- **Application Insights**: Integração Azure (opcional)
- **PagerDuty/Opsgenie**: Alertas críticos (opcional)

**Nota**: Tecnologias acima são **sugestões**, não **requisitos**. Qualquer solução que atenda às regras de negócio (RN-LOG-001 a RN-LOG-012) é válida.

---

## 11. OBSERVAÇÕES COMPLEMENTARES

### Importância Estratégica

Este é um RF **CRÍTICO EM PRODUÇÃO** pois:

1. **Troubleshooting Rápido**: Reduz MTTR (Mean Time To Resolution) de horas para minutos
2. **SLA 99.9%**: Detecta e resolve incidentes antes de afetar usuários (uptime > 99.9%)
3. **Compliance**: Atende LGPD (retenção 90 dias), SOX (retenção 7 anos), ISO 27001 (auditoria)
4. **Performance**: Identifica gargalos (queries lentas > 1s, memory leaks, N+1 queries)
5. **Segurança**: Detecta ataques (SQL injection, XSS, DDoS, tentativas de login)
6. **DevOps**: Integração com CI/CD, alertas em produção, rollback automático

### Custos vs Benefícios

**Custos**:
- Armazenamento de logs (Elasticsearch/Seq): ~$500/mês (produção com 1M requests/dia)
- Prometheus/Grafana (self-hosted): ~$100/mês (servidor dedicado)
- PagerDuty: ~$50/usuário/mês

**Benefícios**:
- Redução de downtime: 99.9% SLA (8.7h/ano) vs 99% SLA (3.65 dias/ano) → **economia de $50k/ano** (custo de downtime)
- Redução de MTTR: 5 min vs 2 horas → **economia de $20k/ano** (custo de horas de engenharia)
- Compliance: Evita multas LGPD (até 2% do faturamento) → **economia de $100k+/ano** (potencial)

**ROI**: ~$170k/ano de benefícios vs ~$8k/ano de custos → **ROI de 2125%**

---

**Changelog**:

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-29 | Migração para template v2.0 - Separação estrita RF (contrato moderno) vs RL (legado). 12 regras de negócio estruturadas, 7 permissões RBAC, integrações obrigatórias, eventos de domínio. | Agência ALC - alc.dev.br |
| 3.0 | 2025-11-04 | Versão anterior (misturava contrato moderno + legado) - DEPRECIADA | Equipe Projeto |
