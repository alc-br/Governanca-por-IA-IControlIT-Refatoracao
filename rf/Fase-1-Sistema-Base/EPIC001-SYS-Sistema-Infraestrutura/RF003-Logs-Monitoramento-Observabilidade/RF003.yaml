rf:
  id: "RF003"
  nome: "Sistema de Logs, Monitoramento e Observabilidade"
  versao: "1.0"
  data: "2025-12-29"
  fase: "Fase 1 - Fundação e Cadastros Base"
  epic: "EPIC001-SYS"
  status: "concluido"

descricao:
  objetivo: >
    Implementar o Sistema de Logs, Monitoramento e Observabilidade do IControlIT,
    fornecendo visibilidade completa da saúde do sistema, troubleshooting rápido de problemas,
    métricas de performance e compliance com requisitos de auditoria (LGPD, SOX, ISO 27001).
  problema_resolvido: >
    Sistema legado tinha logs em texto plano não estruturado, sem agregação centralizada,
    sem busca, sem métricas, sem alertas, com CPF e senhas em texto claro (violação LGPD),
    sem correlation IDs (impossível rastrear requests), descoberta de problemas apenas quando
    usuários reportavam (reativa, não proativa). Diagnóstico demorava horas/dias com acesso
    manual RDP + Notepad aos arquivos .log em cada servidor.
  publico_afetado: >
    Equipes de DevOps, Desenvolvedores, Suporte, Auditores, Segurança, Gerência Operacional.
    Impacto indireto em todos os usuários do sistema (SLA 99.9%, troubleshooting rápido).

escopo:
  incluso:
    - "Logs estruturados JSON (pesquisáveis por campos)"
    - "Níveis configuráveis de log (Verbose, Debug, Info, Warning, Error, Fatal)"
    - "Agregação centralizada de logs (todos os servidores)"
    - "Correlation IDs (rastreamento end-to-end de requests)"
    - "Mascaramento automático de dados sensíveis (CPF, senhas, cartões)"
    - "Métricas de performance (response time, throughput, error rate)"
    - "Dashboards visuais de saúde do sistema"
    - "Health checks (liveness e readiness probes)"
    - "Tracing distribuído entre microservices"
    - "Alertas proativos quando métricas excedem limites"
    - "Log sampling para otimização de custos (10% em produção)"
    - "Circuit breaker (logging não derruba aplicação se sistema de logs falhar)"
    - "Busca full-text em logs com queries complexas"
    - "Export de logs para compliance (CSV/JSON)"
    - "Retenção automática de logs (90 dias LGPD, 1 ano troubleshooting, 7 anos SOX)"
  fora:
    - "Interface visual específica (Seq UI, Grafana são sugestões técnicas, não contrato)"
    - "Tecnologia específica de armazenamento (Elasticsearch, SQL, MongoDB)"
    - "Escolha de biblioteca (Serilog, NLog, Log4Net)"
    - "Infraestrutura (Kubernetes, Docker, VMs)"
    - "APM comercial (New Relic, Datadog, Dynatrace) - Application Insights é preferência Azure"

entidades:
  - nome: "log_event"
    descricao: >
      RF003 não gerencia entidades persistentes em banco de dados.
      Ele registra eventos de log estruturados (JSON) que são enviados para sistemas
      de agregação (Seq, Elasticsearch) e posteriormente purgados conforme política de retenção.
      Logs não têm CRUD - são apenas escritos (append-only) e consultados (read-only).
    multi_tenant: true
    soft_delete: false
    auditoria: false

regras_negocio:
  - id: "RN-LOG-001"
    descricao: >
      Logs Estruturados JSON - Todos os logs devem ser gerados em formato JSON estruturado
      (não texto plano) para permitir queries e análises complexas. Campos obrigatórios:
      Timestamp (ISO 8601), Level, Message, CorrelationId, UserId (se autenticado),
      TenantId (se multi-tenant), IP, UserAgent.
    tipo: "regra_negocio"
    campos_afetados: ["Timestamp", "Level", "Message", "CorrelationId", "UserId", "TenantId", "IP", "UserAgent"]
    obrigatorio: true

  - id: "RN-LOG-002"
    descricao: >
      Níveis de Log por Ambiente - Níveis configuráveis por ambiente: DEV=Debug (tudo),
      HOM=Info (ações importantes), PRD=Warning (apenas problemas potenciais e erros).
      Objetivo: reduzir volume em produção sem perder diagnóstico essencial.
    tipo: "regra_negocio"
    campos_afetados: ["Level"]
    obrigatorio: true

  - id: "RN-LOG-003"
    descricao: >
      Correlation IDs Obrigatórios - Todo request HTTP/API deve ter correlation ID (GUID)
      propagado em todos os logs relacionados (frontend → API → banco → filas → jobs).
      Permite rastrear request completo mesmo em sistemas distribuídos.
    tipo: "regra_negocio"
    campos_afetados: ["CorrelationId"]
    obrigatorio: true

  - id: "RN-LOG-004"
    descricao: >
      Mascaramento Automático de Dados Sensíveis - CPF, senhas, cartões de crédito e
      tokens de API devem ser mascarados ANTES de logar (substituição por ***).
      Compliance LGPD (não logar dados pessoais) e PCI-DSS (não logar dados de cartão).
      CPF: ***.***.*89-**, Senha: ***, Cartão: **** **** **** 1111.
    tipo: "seguranca"
    campos_afetados: ["Message", "Exception.Message"]
    obrigatorio: true

  - id: "RN-LOG-005"
    descricao: >
      Sampling em Produção - Em produção, apenas 10% dos requests bem-sucedidos (HTTP 2xx)
      devem ser logados (Info/Debug), mas 100% dos erros (HTTP 4xx/5xx) devem ser sempre logados.
      Reduz volume/custo mantendo capacidade de diagnóstico completa em falhas.
    tipo: "regra_negocio"
    campos_afetados: ["Level"]
    obrigatorio: true

  - id: "RN-LOG-006"
    descricao: >
      100% de Erros Sempre Logados - Erros (Level=Error ou Fatal) devem ser SEMPRE logados,
      independente de sampling ou ambiente. Nunca suprimir logs de exceções, validações
      falhadas, timeout, acesso negado, etc. Crítico para troubleshooting.
    tipo: "regra_negocio"
    campos_afetados: ["Level"]
    obrigatorio: true

  - id: "RN-LOG-007"
    descricao: >
      Circuit Breaker para Logging - Se sistema de logs centralizado falhar (Seq/Elasticsearch
      indisponível), aplicação deve degradar graciosamente: escrever logs em arquivo local
      temporário e NÃO travar/lançar exceção. Logging não pode derrubar aplicação principal.
    tipo: "regra_negocio"
    campos_afetados: []
    obrigatorio: true

  - id: "RN-LOG-008"
    descricao: >
      Retenção Automática por Tipo - Logs têm retenção automática baseada em tipo e severidade:
      Info/Debug = 90 dias (LGPD), Warning/Error = 1 ano (troubleshooting histórico),
      Logs de Segurança/Auditoria = 7 anos (SOX/ISO 27001). Job diário deleta logs expirados.
    tipo: "regra_negocio"
    campos_afetados: ["Timestamp", "Level", "Category"]
    obrigatorio: true

  - id: "RN-LOG-009"
    descricao: >
      Métricas RED (Rate, Errors, Duration) - Coletar métricas RED para todos os endpoints:
      Rate (requests/segundo), Errors (% de erros), Duration (P50/P95/P99 latency).
      Expor endpoint /metrics (Prometheus format) para monitoramento externo.
    tipo: "regra_negocio"
    campos_afetados: []
    obrigatorio: true

  - id: "RN-LOG-010"
    descricao: >
      Health Checks /health Endpoint - Implementar endpoint /health que valida dependências
      críticas (banco, cache, filas, APIs externas) e retorna HTTP 200 (healthy) ou 503 (unhealthy).
      Usado por Kubernetes liveness/readiness probes e load balancers.
    tipo: "regra_negocio"
    campos_afetados: []
    obrigatorio: true

  - id: "RN-LOG-011"
    descricao: >
      Alertas Automáticos - Gerar alertas proativos para condições críticas:
      error rate > 5% (últimos 5 min), P95 latency > 3s, disco > 85%, memória > 90%,
      dependência crítica offline. Integrar com PagerDuty/Opsgenie para notificar equipe 24/7.
    tipo: "regra_negocio"
    campos_afetados: []
    obrigatorio: true

  - id: "RN-LOG-012"
    descricao: >
      Tracing Distribuído OpenTelemetry - Implementar tracing distribuído seguindo padrão
      OpenTelemetry (W3C Trace Context). Propagar Trace-Id e Span-Id entre serviços para
      reconstruir chamadas completas (frontend → API → banco → filas → jobs).
      Exportar traces para Jaeger/Zipkin ou Application Insights.
    tipo: "regra_negocio"
    campos_afetados: ["TraceId", "SpanId", "ParentSpanId"]
    obrigatorio: true

estados:
  observacao: >
    RF003 não gerencia entidades com estados. Logs são eventos append-only (somente escrita + leitura),
    sem transições de estado. Não aplicável.

transicoes:
  permitidas: []
  observacao: "Não aplicável - logs não têm ciclo de vida com transições."

permissoes:
  - codigo: "SYS.LOGS.READ"
    descricao: "Visualizar logs do sistema (query, busca básica)"
    perfis: ["Super Admin", "Admin DevOps", "Admin Sistema", "Gerente Operações", "Desenvolvedor", "Auditor"]

  - codigo: "SYS.LOGS.SEARCH"
    descricao: "Buscar logs com filtros avançados (correlation ID, user, IP, time range, regex)"
    perfis: ["Super Admin", "Admin DevOps", "Admin Sistema", "Gerente Operações", "Desenvolvedor", "Auditor"]

  - codigo: "SYS.LOGS.EXPORT"
    descricao: "Exportar logs para CSV/JSON (compliance, auditoria externa)"
    perfis: ["Super Admin", "Admin DevOps", "Admin Sistema", "Gerente Operações", "Auditor"]

  - codigo: "SYS.METRICS.READ"
    descricao: "Visualizar métricas de performance e dashboards (Grafana, Application Insights)"
    perfis: ["Super Admin", "Admin DevOps", "Admin Sistema", "Gerente Operações", "Desenvolvedor"]

  - codigo: "SYS.HEALTH.READ"
    descricao: "Verificar health checks e status de dependências (banco, cache, APIs)"
    perfis: ["Super Admin", "Admin DevOps", "Admin Sistema", "Gerente Operações", "Desenvolvedor"]

  - codigo: "SYS.ALERTS.READ"
    descricao: "Visualizar alertas configurados e histórico de disparos"
    perfis: ["Super Admin", "Admin DevOps", "Admin Sistema", "Gerente Operações", "Desenvolvedor"]

  - codigo: "SYS.ALERTS.UPDATE"
    descricao: "Configurar thresholds de alertas (error rate, latency, disco, memória)"
    perfis: ["Super Admin", "Admin DevOps"]

integracoes:
  internas:
    - nome: "Autenticacao"
      descricao: "Logs devem incluir UserId de usuário autenticado (se request autenticado)"
      obrigatoria: true

    - nome: "Multi-Tenancy"
      descricao: "Logs devem incluir TenantId/EmpresaId para filtrar por cliente (isolamento)"
      obrigatoria: true

    - nome: "Auditoria"
      descricao: "Logs de segurança (login, logout, acesso negado, alteração de permissão) têm retenção 7 anos (SOX)"
      obrigatoria: true

  externas:
    - sistema: "Seq"
      tipo: "Log Aggregation"
      descricao: "Agregação centralizada de logs em DEV/HOM (interface web para busca)"
      obrigatoria: false

    - sistema: "Elasticsearch"
      tipo: "Log Aggregation"
      descricao: "Agregação centralizada de logs em PRD (alta escala, retenção longa)"
      obrigatoria: false

    - sistema: "Prometheus"
      tipo: "Metrics Collection"
      descricao: "Coleta de métricas RED (Rate, Errors, Duration) via endpoint /metrics"
      obrigatoria: false

    - sistema: "Grafana"
      tipo: "Metrics Visualization"
      descricao: "Dashboards visuais de métricas (response time, throughput, error rate)"
      obrigatoria: false

    - sistema: "OpenTelemetry"
      tipo: "Distributed Tracing"
      descricao: "Rastreamento distribuído (W3C Trace Context) entre microservices"
      obrigatoria: false

    - sistema: "Application Insights"
      tipo: "APM (Azure)"
      descricao: "Application Performance Monitoring nativo Azure (logs, métricas, traces)"
      obrigatoria: false

    - sistema: "PagerDuty / Opsgenie"
      tipo: "Alerting"
      descricao: "Notificação proativa de alertas críticos (SMS, email, push) 24/7"
      obrigatoria: false

catalog:
  funcionalidades_logs:
    - id: "RN-LOG-001"
      title: "Logs Estruturados JSON"
      description: >
        Todos os logs devem ser gerados em formato JSON estruturado (não texto plano)
        para permitir queries e análises complexas. Campos obrigatórios: Timestamp, Level,
        Message, CorrelationId, UserId, TenantId, IP, UserAgent.
      required: true

    - id: "RN-LOG-002"
      title: "Níveis de Log por Ambiente"
      description: >
        Níveis configuráveis por ambiente: DEV=Debug (tudo), HOM=Info (ações importantes),
        PRD=Warning (apenas problemas potenciais e erros). Reduz volume sem perder diagnóstico.
      required: true

    - id: "RN-LOG-003"
      title: "Correlation IDs Obrigatórios"
      description: >
        Todo request HTTP/API deve ter correlation ID (GUID) propagado em todos os logs relacionados
        (frontend → API → banco → filas → jobs). Rastreamento end-to-end.
      required: true

    - id: "RN-LOG-004"
      title: "Mascaramento Automático de Dados Sensíveis"
      description: >
        CPF, senhas, cartões e tokens devem ser mascarados ANTES de logar.
        Compliance LGPD e PCI-DSS. CPF: ***.***.*89-**, Senha: ***, Cartão: **** **** **** 1111.
      required: true

    - id: "RN-LOG-005"
      title: "Sampling em Produção"
      description: >
        Em produção, apenas 10% dos requests bem-sucedidos (HTTP 2xx) são logados (Info/Debug),
        mas 100% dos erros (HTTP 4xx/5xx) sempre logados. Reduz volume/custo mantendo diagnóstico.
      required: true

    - id: "RN-LOG-006"
      title: "100% de Erros Sempre Logados"
      description: >
        Erros (Level=Error ou Fatal) são SEMPRE logados, independente de sampling ou ambiente.
        Nunca suprimir logs de exceções, validações falhadas, timeout, acesso negado.
      required: true

    - id: "RN-LOG-007"
      title: "Circuit Breaker para Logging"
      description: >
        Se sistema de logs centralizado falhar (Seq/Elasticsearch indisponível), aplicação degrada
        graciosamente: escreve logs em arquivo local temporário e NÃO trava/lança exceção.
      required: true

    - id: "RN-LOG-008"
      title: "Retenção Automática por Tipo"
      description: >
        Logs têm retenção automática: Info/Debug = 90 dias (LGPD), Warning/Error = 1 ano
        (troubleshooting), Logs de Segurança/Auditoria = 7 anos (SOX/ISO 27001).
        Job diário deleta logs expirados.
      required: true

  funcionalidades_metricas:
    - id: "RN-LOG-009"
      title: "Métricas RED (Rate, Errors, Duration)"
      description: >
        Coletar métricas RED para todos os endpoints: Rate (requests/segundo), Errors (% de erros),
        Duration (P50/P95/P99 latency). Endpoint /metrics (Prometheus format) para monitoramento externo.
      required: true

    - id: "RN-LOG-010"
      title: "Health Checks /health Endpoint"
      description: >
        Endpoint /health que valida dependências críticas (banco, cache, filas, APIs externas)
        e retorna HTTP 200 (healthy) ou 503 (unhealthy). Para Kubernetes liveness/readiness probes.
      required: true

    - id: "RN-LOG-011"
      title: "Alertas Automáticos"
      description: >
        Gerar alertas proativos para: error rate > 5% (5 min), P95 latency > 3s, disco > 85%,
        memória > 90%, dependência crítica offline. Integração PagerDuty/Opsgenie para 24/7.
      required: true

  funcionalidades_tracing:
    - id: "RN-LOG-012"
      title: "Tracing Distribuído OpenTelemetry"
      description: >
        Tracing distribuído seguindo padrão OpenTelemetry (W3C Trace Context). Propagar Trace-Id
        e Span-Id entre serviços para reconstruir chamadas completas. Export para Jaeger/Zipkin/App Insights.
      required: true

  observacoes:
    - id: "OBS-LOG-01"
      title: "RF003 não tem CRUD tradicional"
      description: >
        Logs são eventos append-only (write-only + read-only). Não há criação, edição ou
        exclusão manual de logs. Logs são gerados automaticamente pelo sistema e purgados
        automaticamente por job conforme política de retenção.
      required: false

    - id: "OBS-LOG-02"
      title: "Busca de logs"
      description: >
        Interface de busca permite queries por: correlation ID, user, IP, time range,
        level (Error/Warning/Info), text search (regex), campos customizados.
      required: false

    - id: "OBS-LOG-03"
      title: "Exportação para compliance"
      description: >
        Exportação de logs em CSV/JSON para auditoria externa (LGPD, SOX, ISO 27001).
        Filtros aplicáveis: período, usuário, ação, resultado.
      required: false

    - id: "OBS-LOG-04"
      title: "Configuração de alertas"
      description: >
        Interface para configurar thresholds de alertas: error rate (%), latency P95 (ms),
        disco (%), memória (%), status de dependência (online/offline).
      required: false

exclusions:
  rf_items:
    - id: "RN-LOG-005"
      justificativa: >
        Sampling é implementação técnica de backend, invisível ao usuário.
        Ocorre automaticamente em background (10% requests 2xx logados, 100% erros logados).
        NÃO requer UC porque usuário não interage com esta funcionalidade.
    - id: "RN-LOG-007"
      justificativa: >
        Circuit Breaker é mecanismo de resiliência técnica, invisível ao usuário.
        Degrada graciosamente se sistema de logs centralizado falhar (escreve em arquivo local).
        NÃO requer UC porque usuário não interage com esta funcionalidade.

rastreabilidade:
  ucs_esperados:
    - "UC00"  # Listar Logs
    - "UC01"  # Buscar Logs (filtros avançados)
    - "UC02"  # Visualizar Detalhes de Log
    - "UC03"  # Exportar Logs (CSV/JSON)
    - "UC04"  # Configurar Alertas
    - "UC05"  # Visualizar Dashboards de Métricas
    - "UC06"  # Verificar Health Checks
    - "UC07"  # Visualizar Tracing Distribuído (opcional)

historico:
  - versao: "1.0"
    data: "2025-12-29"
    autor: "Agência ALC - alc.dev.br"
    descricao: >
      Versão inicial estruturada em YAML. Migração de RF003.md v3.0 (410 linhas)
      para nova governança v2.0 com separação estrita RF (contrato moderno) / RL (referência ao legado).
      12 regras de negócio, 7 permissões RBAC, 7-8 UCs esperados para cobertura 100%.
