# RF-003: Logs, Monitoramento e Observabilidade

**Vers√£o**: 3.0
**√öltima Atualiza√ß√£o**: 2025-11-04
**Status**: ‚úÖ Documenta√ß√£o Completa
**Fase**: Fase 1 - Funda√ß√£o e Cadastros Base

---

[‚Üê Voltar ao √çndice](./README.md)

---

## üìã RESUMO EXECUTIVO

### Descri√ß√£o Geral

O RF-003 implementa o **Sistema de Logs, Monitoramento e Observabilidade** do IControlIT, fornecendo visibilidade completa da sa√∫de do sistema, troubleshooting r√°pido de problemas, m√©tricas de performance e compliance com requisitos de auditoria.

### Import√¢ncia Estrat√©gica

Este √© um RF **CR√çTICO EM PRODU√á√ÉO** pois:

1. **Troubleshooting R√°pido**: Diagnosticar problemas em minutos (n√£o horas)
2. **SLA 99.9%**: Detectar e resolver incidentes antes de afetar usu√°rios
3. **Compliance**: Auditoria de logs para LGPD, SOX, ISO 27001
4. **Performance**: Identificar gargalos (queries lentas, memory leaks)
5. **Seguran√ßa**: Detectar ataques (SQL injection, XSS, DDoS)
6. **DevOps**: Integra√ß√£o com CI/CD, alertas em produ√ß√£o

### 15 Funcionalidades Principais

1. ‚úÖ **Logs Estruturados JSON**: Serilog com formato pesquis√°vel
2. ‚úÖ **N√≠veis Configur√°veis**: Verbose, Debug, Info, Warning, Error, Fatal
3. ‚úÖ **Agrega√ß√£o Centralizada**: Seq (dev) + Elasticsearch (prod)
4. ‚úÖ **Correlation IDs**: Rastrear requests end-to-end
5. ‚úÖ **Mascaramento Autom√°tico**: CPF, senhas, cart√µes de cr√©dito
6. ‚úÖ **M√©tricas Prometheus**: Response time, throughput, error rate
7. ‚úÖ **Dashboards Grafana**: Pr√©-configurados (RED metrics)
8. ‚úÖ **Health Checks**: `/health` liveness + readiness probes
9. ‚úÖ **Tracing Distribu√≠do**: OpenTelemetry (Jaeger/Zipkin)
10. ‚úÖ **Alertas Proativos**: PagerDuty/Opsgenie quando error rate > 5%
11. ‚úÖ **Log Sampling**: 10% em produ√ß√£o (otimiza√ß√£o de custos)
12. ‚úÖ **Circuit Breaker**: Logging n√£o bloqueia aplica√ß√£o se falhar
13. ‚úÖ **Busca Full-Text**: Queries avan√ßadas em Seq/Elasticsearch
14. ‚úÖ **Export Compliance**: CSV/JSON para auditoria
15. ‚úÖ **Application Insights**: Integra√ß√£o Azure nativa

### Diferen√ßa: Legado vs. Modernizado

| Aspecto | Sistema Legado (VB.NET) | Sistema Modernizado (.NET 10) |
|---------|-------------------------|------------------------------|
| **Logs** | Arquivo texto plano `app.log` | Serilog estruturado JSON |
| **Busca** | `grep` manual | Seq/Elasticsearch full-text search |
| **Formato** | Texto n√£o estruturado | JSON estruturado com metadados |
| **Agrega√ß√£o** | Nenhuma (logs locais) | Seq centralizado para todos os servidores |
| **M√©tricas** | Nenhuma | Prometheus + Grafana (RED metrics) |
| **Tracing** | Nenhum | OpenTelemetry distribu√≠do entre microservices |
| **Health Checks** | Nenhum | Endpoints `/health` para Kubernetes |
| **Alertas** | Email manual | PagerDuty autom√°tico quando error rate > 5% |
| **Retention** | Manual (disk full) | Autom√°tico: 90 dias (LGPD) a 7 anos (SOX) |
| **Sensibilidade** | CPF/senhas em texto claro ‚ùå | Mascaramento autom√°tico ‚úÖ |
| **Correlation** | Imposs√≠vel rastrear requests | Correlation ID em todos os logs |
| **Performance** | Logs s√≠ncronos (bloqueia thread) | Logs ass√≠ncronos (background) |

---

## üîó INTEGRA√á√ïES OBRIGAT√ìRIAS

### 1Ô∏è‚É£ Central de Funcionalidades

**C√≥digo da Funcionalidade**: `FNC-SYS-003`
**Nome**: Sistema de Logs, Monitoramento e Observabilidade
**Categoria**: Sistema / Infraestrutura
**Tipo**: Tela + API + Dashboard
**Descri√ß√£o**: Permite aos administradores e equipe DevOps visualizar logs do sistema, m√©tricas de performance, health checks e configurar alertas.

**Permiss√µes Requeridas**:
- `SYS.LOGS.READ` - Visualizar logs do sistema
- `SYS.LOGS.SEARCH` - Buscar logs com filtros avan√ßados
- `SYS.LOGS.EXPORT` - Exportar logs para CSV/JSON
- `SYS.METRICS.READ` - Visualizar m√©tricas e dashboards
- `SYS.HEALTH.READ` - Verificar health checks
- `SYS.ALERTS.READ` - Visualizar alertas configurados
- `SYS.ALERTS.UPDATE` - Configurar alertas e thresholds

### 2Ô∏è‚É£ Internacionaliza√ß√£o (i18n)

**Chaves de Tradu√ß√£o Necess√°rias** (arquivo `src/assets/i18n/pt-BR.json`):

```json
{
  "LOGS": {
    "TITLE": "Logs do Sistema",
    "SUBTITLE": "Visualizar e buscar logs de aplica√ß√£o",
    "SEARCH_PLACEHOLDER": "Buscar por mensagem, erro ou correlation ID...",
    "FIELDS": {
      "TIMESTAMP": "Data/Hora",
      "LEVEL": "N√≠vel",
      "MESSAGE": "Mensagem",
      "EXCEPTION": "Exce√ß√£o",
      "USER": "Usu√°rio",
      "IP": "Endere√ßo IP",
      "CORRELATION_ID": "Correlation ID",
      "DURATION": "Dura√ß√£o (ms)"
    },
    "LEVELS": {
      "VERBOSE": "Verbose",
      "DEBUG": "Debug",
      "INFORMATION": "Informa√ß√£o",
      "WARNING": "Aviso",
      "ERROR": "Erro",
      "FATAL": "Fatal"
    },
    "MESSAGES": {
      "EXPORT_SUCCESS": "Logs exportados com sucesso",
      "SEARCH_NO_RESULTS": "Nenhum log encontrado com os filtros aplicados"
    }
  },
  "METRICS": {
    "TITLE": "M√©tricas de Performance",
    "SUBTITLE": "Monitorar sa√∫de e desempenho do sistema",
    "DASHBOARDS": {
      "RED_METRICS": "RED Metrics (Rate, Errors, Duration)",
      "SYSTEM_HEALTH": "Sa√∫de do Sistema",
      "API_PERFORMANCE": "Performance de APIs",
      "DATABASE": "Banco de Dados"
    },
    "FIELDS": {
      "REQUEST_RATE": "Taxa de Requisi√ß√µes",
      "ERROR_RATE": "Taxa de Erros",
      "RESPONSE_TIME": "Tempo de Resposta",
      "CPU_USAGE": "Uso de CPU",
      "MEMORY_USAGE": "Uso de Mem√≥ria",
      "DATABASE_CONNECTIONS": "Conex√µes com Banco"
    }
  },
  "HEALTH": {
    "TITLE": "Health Checks",
    "STATUS": {
      "HEALTHY": "Saud√°vel",
      "DEGRADED": "Degradado",
      "UNHEALTHY": "N√£o Saud√°vel"
    },
    "CHECKS": {
      "DATABASE": "Banco de Dados",
      "REDIS": "Redis Cache",
      "AZURE_BLOB": "Azure Blob Storage",
      "EXTERNAL_API": "APIs Externas"
    }
  },
  "ALERTS": {
    "TITLE": "Alertas e Notifica√ß√µes",
    "SUBTITLE": "Configurar alertas proativos",
    "FIELDS": {
      "NAME": "Nome do Alerta",
      "CONDITION": "Condi√ß√£o",
      "THRESHOLD": "Limite",
      "NOTIFICATION_CHANNEL": "Canal de Notifica√ß√£o",
      "ENABLED": "Ativo"
    },
    "CHANNELS": {
      "EMAIL": "E-mail",
      "SLACK": "Slack",
      "PAGERDUTY": "PagerDuty",
      "TEAMS": "Microsoft Teams"
    },
    "MESSAGES": {
      "ALERT_TRIGGERED": "Alerta disparado",
      "ALERT_RESOLVED": "Alerta resolvido"
    }
  }
}
```

### 3Ô∏è‚É£ Auditoria

**Opera√ß√µes Auditadas**:

| Opera√ß√£o | Tipo | Dados Registrados | Reten√ß√£o |
|----------|------|-------------------|----------|
| Visualizar Logs | ACCESS | Filtros utilizados, quantidade de registros | 90 dias |
| Exportar Logs | EXPORT | Per√≠odo exportado, formato, filtros | 7 anos |
| Configurar Alerta | UPDATE | Configura√ß√£o anterior vs nova | 7 anos |
| Desabilitar Alerta Cr√≠tico | UPDATE | Motivo, usu√°rio, timestamp | 7 anos |
| Acesso a Logs de Seguran√ßa | ACCESS | IP, user-agent, logs acessados | 7 anos |

**Nota**: Os pr√≥prios logs do sistema j√° s√£o auditoria. Esta se√ß√£o registra acesso/manipula√ß√£o dos logs.

### 4Ô∏è‚É£ Controle de Acesso (RBAC)

**Matriz de Permiss√µes por Perfil**:

| Perfil | READ | SEARCH | EXPORT | METRICS | HEALTH | ALERTS_READ | ALERTS_UPDATE |
|--------|------|--------|--------|---------|--------|-------------|---------------|
| **Super Administrador** | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| **Administrador DevOps** | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| **Administrador de Sistema** | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| **Gerente de Opera√ß√µes** | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| **Desenvolvedor** | ‚úÖ | ‚úÖ | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| **Auditor** | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| **Usu√°rio Final** | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå |

---

## üìê REGRAS DE NEG√ìCIO

**Nota**: Este RF possui 12 regras de neg√≥cio. Apresenta√ß√£o resumida por brevidade.

### RN-LOG-001: Logs Estruturados JSON
**Descri√ß√£o**: Todos os logs em formato JSON para busca e an√°lise
**Justificativa**: Permite queries SQL/Elasticsearch complexas

### RN-LOG-002: N√≠veis de Log por Ambiente
**Descri√ß√£o**: DEV=Debug, HOM=Info, PRD=Warning
**Justificativa**: Reduzir ru√≠do em produ√ß√£o

### RN-LOG-003: Correlation IDs Obrigat√≥rios
**Descri√ß√£o**: Todo request recebe GUID √∫nico propagado em toda cadeia
**Justificativa**: Rastrear requests distribu√≠dos end-to-end

### RN-LOG-004: Mascaramento Autom√°tico de Dados Sens√≠veis
**Descri√ß√£o**: CPF, senhas, cart√µes mascarados automaticamente antes de logar
**Justificativa**: Compliance LGPD (n√£o logar dados pessoais)

### RN-LOG-005: Sampling em Produ√ß√£o (10%)
**Descri√ß√£o**: Logar apenas 10% dos requests bem-sucedidos (200 OK)
**Justificativa**: Reduzir custos (Elasticsearch/Seq) sem perder visibilidade

### RN-LOG-006: 100% de Erros Sempre Logados
**Descri√ß√£o**: Erros (4xx, 5xx) s√£o SEMPRE logados (sem sampling)
**Justificativa**: N√£o perder nenhum erro cr√≠tico

### RN-LOG-007: Circuit Breaker para Logging
**Descri√ß√£o**: Se Seq/Elasticsearch falhar, logs v√£o para arquivo local
**Justificativa**: Logging nunca deve derrubar a aplica√ß√£o

### RN-LOG-008: Reten√ß√£o Autom√°tica por Tipo
**Descri√ß√£o**:
- Logs Info/Debug: 90 dias
- Logs Warning/Error: 1 ano
- Logs de Seguran√ßa: 7 anos
**Justificativa**: Compliance LGPD + SOX

### RN-LOG-009: M√©tricas RED (Rate, Errors, Duration)
**Descri√ß√£o**: Coletar automaticamente via Prometheus:
- **Rate**: Requests/segundo
- **Errors**: % de erros
- **Duration**: P50, P95, P99 latency
**Justificativa**: Padr√£o da ind√∫stria para monitoramento

### RN-LOG-010: Health Checks /health Endpoint
**Descri√ß√£o**: Endpoint retorna status de depend√™ncias (DB, Redis, Azure)
**Justificativa**: Kubernetes liveness/readiness probes

### RN-LOG-011: Alertas Autom√°ticos
**Descri√ß√£o**: Disparar PagerDuty se:
- Error rate > 5% por 5 minutos
- P95 latency > 3 segundos
- CPU > 80% por 10 minutos
- Mem√≥ria > 90%
**Justificativa**: Detec√ß√£o proativa de problemas

### RN-LOG-012: Tracing Distribu√≠do OpenTelemetry
**Descri√ß√£o**: Propagar trace context entre servi√ßos (W3C standard)
**Justificativa**: Visualizar lat√™ncia em cada microservice

---

## üóÉÔ∏è REFER√äNCIAS AO LEGADO

### Sistema Legado: Arquivo de Log Texto Plano

**Localiza√ß√£o**: `D:\IC2\ic1_legado\IControlIT\IControlIT\logs\app.log`

```
2023-10-15 14:23:45 - Usu√°rio admin@test.com fez login
2023-10-15 14:24:12 - Erro ao salvar usu√°rio: Object reference not set to an instance of an object
2023-10-15 14:25:33 - CPF 123.456.789-00 consultado
2023-10-15 14:26:01 - Senha do usu√°rio: Admin@123
```

**Problemas do Legado**:
1. ‚ùå **Formato texto n√£o estruturado** (imposs√≠vel buscar por campos)
2. ‚ùå **CPF e senhas em texto claro** (viola√ß√£o LGPD)
3. ‚ùå **Sem correlation ID** (imposs√≠vel rastrear request)
4. ‚ùå **Sem n√≠veis de log** (tudo √© informa√ß√£o)
5. ‚ùå **Sem agrega√ß√£o** (cada servidor tem log separado)
6. ‚ùå **Sem busca** (apenas `grep` manual)
7. ‚ùå **Sem m√©tricas** (n√£o sabe response time, error rate)
8. ‚ùå **Sem alertas** (problemas descobertos por usu√°rios)

### C√≥digo Legado: Logging

```vb.net
' C√≥digo VB.NET legado
Public Sub LogError(mensagem As String)
    Dim logFile As String = Server.MapPath("~/logs/app.log")
    Dim writer As New StreamWriter(logFile, True)
    writer.WriteLine($"{DateTime.Now} - {mensagem}")
    writer.Close()
End Sub

' Uso (com dados sens√≠veis!)
LogError($"Erro ao processar CPF {cpf}: {ex.Message}")
LogError($"Senha do usu√°rio: {senha}")
```

---

## üñ•Ô∏è TELAS DO LEGADO

N√£o havia tela de visualiza√ß√£o de logs no sistema legado. Administradores acessavam servidor via RDP e abriam arquivos `.log` com Notepad.

**Moderniza√ß√£o Implementada**:
- ‚úÖ Interface web para visualizar logs (Seq UI)
- ‚úÖ Busca full-text com filtros
- ‚úÖ Dashboards Grafana para m√©tricas
- ‚úÖ Health checks endpoint
- ‚úÖ Integra√ß√£o com PagerDuty
- ‚úÖ Export para CSV/JSON

---

## üõ†Ô∏è IMPLEMENTA√á√ÉO ATUAL

**Status**: ‚úÖ **Sistema j√° implementado e em produ√ß√£o**

**Arquivos Existentes**:
- `LoggingBehaviour.cs`: MediatR pipeline para logar commands/queries
- `DiagnosticsLogWriter.cs`: Writer customizado de diagn√≥stico
- `AuditService.cs`: Integra√ß√£o com auditoria
- `appsettings.json`: Configura√ß√£o Serilog

**Stack Tecnol√≥gico**:
- **Serilog**: Logging estruturado
- **Seq**: Agrega√ß√£o centralizada (dev/hom)
- **Elasticsearch**: Agrega√ß√£o produ√ß√£o
- **Prometheus**: M√©tricas
- **Grafana**: Dashboards
- **OpenTelemetry**: Tracing distribu√≠do
- **Application Insights**: Integra√ß√£o Azure

**Configura√ß√£o Serilog** (`appsettings.json`):
```json
{
  "Serilog": {
    "Using": ["Serilog.Sinks.Console", "Serilog.Sinks.Seq", "Serilog.Sinks.File"],
    "MinimumLevel": {
      "Default": "Information",
      "Override": {
        "Microsoft": "Warning",
        "System": "Warning"
      }
    },
    "WriteTo": [
      {
        "Name": "Console",
        "Args": {
          "outputTemplate": "[{Timestamp:HH:mm:ss} {Level:u3}] {Message:lj} {Properties:j}{NewLine}{Exception}"
        }
      },
      {
        "Name": "Seq",
        "Args": {
          "serverUrl": "http://localhost:5341",
          "apiKey": "YOUR_SEQ_API_KEY"
        }
      },
      {
        "Name": "File",
        "Args": {
          "path": "logs/log-.txt",
          "rollingInterval": "Day",
          "retainedFileCountLimit": 90,
          "outputTemplate": "{Timestamp:yyyy-MM-dd HH:mm:ss.fff zzz} [{Level:u3}] {Message:lj}{NewLine}{Exception}"
        }
      }
    ],
    "Enrich": ["FromLogContext", "WithMachineName", "WithThreadId"],
    "Properties": {
      "Application": "IControlIT",
      "Environment": "Production"
    }
  }
}
```

**Health Checks** (`Program.cs`):
```csharp
builder.Services.AddHealthChecks()
    .AddSqlServer(connectionString, name: "database")
    .AddRedis(redisConnection, name: "redis")
    .AddAzureBlobStorage(azureConnection, name: "azure-blob")
    .AddCheck<ExternalApiHealthCheck>("external-api");

app.MapHealthChecks("/health", new HealthCheckOptions
{
    ResponseWriter = UIResponseWriter.WriteHealthCheckUIResponse
});
```

---

[‚Üê Voltar ao √çndice](./README.md)

---

**Pr√≥ximos Passos**: Criar MD-003 (Modelo de Dados) e Casos de Uso (UC00-UC02)
