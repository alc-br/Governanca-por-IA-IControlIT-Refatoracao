# RF-SYS-001: Login e Autenticacao

**Versao**: 1.0 | **Data**: 2025-11-19
**RF Relacionado**: RF-SYS-001 | **EPIC**: SYS-Sistema-Infraestrutura
**Fase**: Fase 1 - Fundacao e Cadastros Base

---

## 1. RESUMO EXECUTIVO

### 1.1 Descricao Geral

Este requisito especifica o **Modulo de Login e Autenticacao** do sistema IControlIT, responsavel por controlar o acesso seguro dos usuarios ao sistema atraves de autenticacao JWT (JSON Web Token), gerenciamento de sessoes, recuperacao de senha e protecao contra ataques de forca bruta.

### 1.2 Importancia Estrategica

O modulo de autenticacao e a **porta de entrada** do sistema, sendo critico para:
- **Seguranca**: Protecao de dados sensiveis contra acessos nao autorizados
- **Conformidade**: LGPD e politicas de seguranca corporativas
- **Auditoria**: Rastreabilidade de todas as acoes no sistema
- **Experiencia do Usuario**: Login fluido e recuperacao de senha eficiente

### 1.3 Legado vs Modernizado

| Aspecto | Legado (VB.NET) | Modernizado (.NET 10 + Angular) |
|---------|-----------------|--------------------------------|
| **Autenticacao** | Session-based | JWT Bearer Token |
| **Criptografia** | Funcao customizada `Fu_Criptografa` | BCrypt + SHA-256 |
| **Sessao** | ASP.NET Session | Token com Refresh |
| **Timeout** | Configuravel no IIS | JWT Expiration + Inatividade |
| **Recuperacao** | Email com senha | Link com token temporario |
| **Bloqueio** | Nao implementado | 5 tentativas = 30 min bloqueio |
| **Auditoria** | Log manual | Automatica via Middleware |

### 1.4 Funcionalidades Principais

1. **Login no Sistema** - Autenticacao por email + senha com JWT
2. **Esqueci Minha Senha** - Solicitacao de recuperacao via email
3. **Redefinir Senha** - Definicao de nova senha com token
4. **Primeiro Acesso** - Troca obrigatoria de senha temporaria
5. **Logout** - Invalidacao de token e limpeza de sessao
6. **Renovacao de Sessao** - Refresh token automatico
7. **Bloqueio por Tentativas** - Protecao contra brute force

---

## 2. REGRAS DE NEGOCIO

### RN-AUTH-001: Autenticacao por Email e Senha

**Descricao**: O login deve ser feito com email corporativo e senha.

**Justificativa**: Email e identificador unico e facil de lembrar.

**Implementacao**:
```csharp
public record LoginCommand(string Email, string Senha) : IRequest<LoginResult>;
```

**Exemplos**:
- Email: `usuario@empresa.com.br`
- Senha: `Senh@Segur@123`

---

### RN-AUTH-002: JWT Token com Expiracao de 8 Horas

**Descricao**: O token JWT expira em 8 horas de trabalho (jornada padrao).

**Justificativa**: Balanco entre seguranca e usabilidade.

**Implementacao**:
```csharp
var token = new JwtSecurityToken(
    expires: DateTime.UtcNow.AddHours(8),
    claims: claims,
    signingCredentials: credentials
);
```

**Refresh**: Token pode ser renovado se houver atividade nos ultimos 5 minutos.

---

### RN-AUTH-003: Maximo 5 Tentativas de Login

**Descricao**: Apos 5 tentativas falhas em 15 minutos, usuario e bloqueado por 30 minutos.

**Justificativa**: Protecao contra ataques de forca bruta.

**Implementacao**:
```csharp
if (tentativasFalhas >= 5 && ultimaTentativa > DateTime.UtcNow.AddMinutes(-15))
{
    throw new UserLockedException("Conta bloqueada por 30 minutos");
}
```

**Contador**: Resetado apos login bem-sucedido.

---

### RN-AUTH-004: Senha com Requisitos Minimos

**Descricao**: Senha deve ter no minimo:
- 8 caracteres
- 1 letra maiuscula
- 1 letra minuscula
- 1 numero
- 1 caractere especial (!@#$%^&*)

**Justificativa**: Conformidade com politicas de seguranca.

**Validacao**:
```csharp
public class PasswordValidator
{
    public bool Validate(string password)
    {
        return password.Length >= 8 &&
               Regex.IsMatch(password, @"[A-Z]") &&
               Regex.IsMatch(password, @"[a-z]") &&
               Regex.IsMatch(password, @"[0-9]") &&
               Regex.IsMatch(password, @"[!@#$%^&*]");
    }
}
```

---

### RN-AUTH-005: Senha Case-Sensitive

**Descricao**: A comparacao de senhas e case-sensitive.

**Justificativa**: Aumenta a seguranca significativamente.

**Exemplo**: `Senh@123` e diferente de `senh@123`.

---

### RN-AUTH-006: Token de Recuperacao Valido por 24 Horas

**Descricao**: O link de recuperacao de senha expira em 24 horas.

**Justificativa**: Seguranca - tokens antigos nao devem funcionar.

**Implementacao**:
```csharp
var token = new TokenRecuperacaoSenha
{
    Token = Guid.NewGuid().ToString(),
    DataExpiracao = DateTime.UtcNow.AddHours(24),
    Utilizado = false
};
```

---

### RN-AUTH-007: Nao Reutilizar Ultimas 5 Senhas

**Descricao**: Nova senha nao pode ser igual as 5 ultimas utilizadas.

**Justificativa**: Impede usuarios de alternar entre poucas senhas.

**Implementacao**:
```csharp
var historicoSenhas = await _context.HistoricoSenhas
    .Where(h => h.UsuarioId == userId)
    .OrderByDescending(h => h.DataAlteracao)
    .Take(5)
    .ToListAsync();

if (historicoSenhas.Any(h => BCrypt.Verify(novaSenha, h.SenhaHash)))
    throw new ValidationException("Senha ja utilizada anteriormente");
```

---

### RN-AUTH-008: Primeiro Acesso Obrigatorio Troca de Senha

**Descricao**: Usuarios com senha temporaria devem trocar no primeiro login.

**Justificativa**: Senhas temporarias sao geradas pelo sistema e conhecidas por terceiros.

**Flag**: `Usuario.Fl_Primeiro_Acesso = true`

---

### RN-AUTH-009: Timeout por Inatividade de 30 Minutos

**Descricao**: Sessao expira apos 30 minutos sem atividade.

**Justificativa**: Protege terminais deixados logados.

**Implementacao**: Frontend monitora atividade e renova token automaticamente.

---

### RN-AUTH-010: Auditoria de Todas as Tentativas de Login

**Descricao**: Registrar TODAS as tentativas de login (sucesso e falha).

**Dados Registrados**:
- Email tentado
- IP de origem
- User-Agent
- Data/Hora
- Resultado (sucesso/falha)
- Motivo da falha

**Retencao**: 7 anos conforme LGPD.

---

### RN-AUTH-011: Mensagem Generica para Credenciais Invalidas

**Descricao**: Nao informar se o problema e no email ou na senha.

**Justificativa**: Impede enumeracao de usuarios.

**Mensagem**: "Email ou senha incorretos"

**Nunca usar**: "Usuario nao encontrado" ou "Senha incorreta"

---

### RN-AUTH-012: Email de Notificacao de Login em Novo Dispositivo

**Descricao**: Enviar email quando detectado login de IP/dispositivo desconhecido.

**Justificativa**: Alerta usuario sobre possivel acesso nao autorizado.

**Conteudo**: IP, Navegador, Localizacao aproximada, Data/Hora.

---

## 3. REFERENCIAS AO LEGADO

### 3.1 Banco de Dados Legado

**Banco**: `Ativvus_Login`

**Tabela Principal**: `Usuario_Global`
```sql
CREATE TABLE [dbo].[Usuario_Global](
    [Id_Usuario] [int] IDENTITY(1,1) NOT NULL,
    [Nm_Usuario] [varchar](50) NOT NULL,
    [Senha] [varchar](50) NOT NULL,
    [Empresa] [varchar](50) NOT NULL,
    [EMail] [varchar](50) NULL,
    [Id_Facebook] [varchar](50) NULL,
    [Chave_Validacao] [varchar](50) NULL,
    [Chave_Validacao_App] [varchar](50) NULL,
    [Fl_Validacao_App] [int] NULL,
    [Fl_Validacao] [int] NOT NULL,
    [Token] [varchar](250) NULL,
    [Token_Validade] [datetime] NULL,
    [Senha_Segura] [smallint] NULL
)
```

### 3.2 Funcao de Criptografia Legado

**Funcao**: `dbo.Fu_Criptografa`
- Usa chave fixa `'GUA@123'`
- Criptografia customizada baseada em ASCII
- Sera substituida por BCrypt no sistema modernizado

### 3.3 Stored Procedure de Validacao

**Procedure**: `pa_si_Validacao_Global`
- Package `Sd_SF_ValidaPrimeiroAcesso`: Valida primeiro acesso
- Package `Sd_SF_UpdateSenhaFortePrimeiroAcesso`: Atualiza senha forte

### 3.4 Telas ASPX

| Pagina | Descricao |
|--------|-----------|
| `Login.aspx` | Tela de login principal |
| `EsqueciSenha.aspx` | Solicitacao de recuperacao |
| `NovaSenha.aspx` | Definicao de nova senha |

---

## 4. BANCO DE DADOS LEGADO (DDL Original)

### 4.1 Tabela Usuario_Global

```sql
-- Tabela original do sistema legado
CREATE TABLE [dbo].[Usuario_Global](
    [Id_Usuario] [int] IDENTITY(1,1) NOT NULL,
    [Nm_Usuario] [varchar](50) NOT NULL,
    [Senha] [varchar](50) NOT NULL,
    [Empresa] [varchar](50) NOT NULL,
    [EMail] [varchar](50) NULL,
    [Id_Facebook] [varchar](50) NULL,
    [Chave_Validacao] [varchar](50) NULL,
    [Chave_Validacao_App] [varchar](50) NULL,
    [Fl_Validacao_App] [int] NULL,
    [Fl_Validacao] [int] NOT NULL,
    [Token] [varchar](250) NULL,
    [Token_Validade] [datetime] NULL,
    [Senha_Segura] [smallint] NULL,
    CONSTRAINT [PK_Usuario_Global] PRIMARY KEY CLUSTERED ([Id_Usuario] ASC)
)

-- Indices
CREATE UNIQUE NONCLUSTERED INDEX [IX_Usuario_Global]
ON [dbo].[Usuario_Global] ([Nm_Usuario] ASC, [Senha] ASC)

CREATE NONCLUSTERED INDEX [ix_usuario_global_email]
ON [dbo].[Usuario_Global] ([EMail] ASC)

CREATE NONCLUSTERED INDEX [idx_Usuario_Global_Token]
ON [dbo].[Usuario_Global] ([Token] ASC, [Token_Validade] ASC)
```

### 4.2 Campos Importantes

| Campo | Descricao | Uso no Modernizado |
|-------|-----------|-------------------|
| `Nm_Usuario` | Nome de login | Migrar para `Email` |
| `Senha` | Senha criptografada | Recriptografar com BCrypt |
| `EMail` | Email do usuario | Usar como login |
| `Token` | Token de sessao | Substituir por JWT |
| `Token_Validade` | Expiracao do token | Claim `exp` no JWT |
| `Senha_Segura` | Flag de senha forte | `Fl_Primeiro_Acesso` |

---

## 5. INTEGRACOES OBRIGATORIAS

### 5.1 Central de Funcionalidades

**FeatureKey**: `AUTH_LOGIN`

**Configuracao**:
```json
{
    "featureKey": "AUTH_LOGIN",
    "nome": "Login e Autenticacao",
    "descricao": "Modulo de autenticacao de usuarios",
    "habilitado": true,
    "isSystemFeature": true
}
```

**Nota**: Esta e uma feature de sistema (sempre habilitada).

---

### 5.2 Internacionalizacao (i18n)

**Chaves de Traducao**:

```json
{
    "auth": {
        "login": {
            "title": "Entrar no Sistema",
            "email": "E-mail",
            "password": "Senha",
            "rememberMe": "Lembrar-me",
            "forgotPassword": "Esqueceu a senha?",
            "signIn": "Entrar",
            "invalidCredentials": "E-mail ou senha incorretos",
            "accountLocked": "Conta bloqueada. Tente novamente em {minutes} minutos",
            "firstAccess": "Primeiro acesso detectado. Por favor, altere sua senha."
        },
        "forgotPassword": {
            "title": "Esqueci Minha Senha",
            "description": "Informe seu e-mail para receber as instrucoes",
            "email": "E-mail",
            "send": "Enviar",
            "success": "Se o e-mail estiver cadastrado, voce recebera as instrucoes",
            "backToLogin": "Voltar ao login"
        },
        "resetPassword": {
            "title": "Redefinir Senha",
            "newPassword": "Nova Senha",
            "confirmPassword": "Confirmar Senha",
            "requirements": "Requisitos da senha:",
            "minLength": "Minimo 8 caracteres",
            "uppercase": "Uma letra maiuscula",
            "lowercase": "Uma letra minuscula",
            "number": "Um numero",
            "special": "Um caractere especial",
            "save": "Salvar Nova Senha",
            "success": "Senha alterada com sucesso!",
            "tokenExpired": "Link expirado. Solicite um novo.",
            "passwordMismatch": "As senhas nao coincidem"
        },
        "logout": {
            "title": "Sair",
            "message": "Deseja realmente sair do sistema?",
            "confirm": "Sim, sair",
            "cancel": "Cancelar"
        },
        "session": {
            "expired": "Sua sessao expirou. Por favor, faca login novamente.",
            "inactivity": "Voce sera desconectado por inatividade em {seconds} segundos"
        }
    }
}
```

---

### 5.3 Auditoria

**Operacoes Auditadas**:

| Operacao | Codigo | Dados Registrados |
|----------|--------|-------------------|
| Login Sucesso | `AUTH_LOGIN_SUCCESS` | Email, IP, UserAgent, Timestamp |
| Login Falha | `AUTH_LOGIN_FAILURE` | Email, IP, UserAgent, Motivo |
| Logout | `AUTH_LOGOUT` | UsuarioId, IP, Duracao Sessao |
| Solicitar Recuperacao | `AUTH_PASSWORD_RESET_REQUEST` | Email, IP |
| Senha Alterada | `AUTH_PASSWORD_CHANGED` | UsuarioId, IP |
| Conta Bloqueada | `AUTH_ACCOUNT_LOCKED` | Email, IP, Tentativas |
| Conta Desbloqueada | `AUTH_ACCOUNT_UNLOCKED` | Email, AdminId |

**Retencao**: 7 anos (LGPD)

---

### 5.4 Controle de Acesso (RBAC)

**Permissoes**:

| Permissao | Descricao | Perfis |
|-----------|-----------|--------|
| `auth:user:unlock` | Desbloquear usuario | Admin, Super Admin |
| `auth:session:view` | Visualizar sessoes ativas | Admin, Super Admin |
| `auth:session:invalidate` | Invalidar sessao | Admin, Super Admin |
| `auth:logs:view` | Visualizar logs de acesso | Admin, Super Admin, Auditor |

**Nota**: Login/Logout nao requerem permissoes especificas (acesso publico/autenticado).

---

## 6. ENDPOINTS DA API

### 6.1 Autenticacao

| Metodo | Endpoint | Descricao |
|--------|----------|-----------|
| POST | `/api/auth/login` | Realizar login |
| POST | `/api/auth/logout` | Encerrar sessao |
| POST | `/api/auth/refresh` | Renovar token |
| POST | `/api/auth/forgot-password` | Solicitar recuperacao |
| POST | `/api/auth/reset-password` | Redefinir senha |
| POST | `/api/auth/change-password` | Alterar senha (logado) |

### 6.2 Administracao

| Metodo | Endpoint | Descricao | Permissao |
|--------|----------|-----------|-----------|
| POST | `/api/auth/users/{id}/unlock` | Desbloquear usuario | `auth:user:unlock` |
| GET | `/api/auth/sessions` | Listar sessoes ativas | `auth:session:view` |
| DELETE | `/api/auth/sessions/{id}` | Invalidar sessao | `auth:session:invalidate` |
| GET | `/api/auth/logs` | Logs de acesso | `auth:logs:view` |

---

## 7. METRICAS E INDICADORES

### 7.1 KPIs de Seguranca

| KPI | Meta | Medicao |
|-----|------|---------|
| Taxa de Login Falho | < 5% | Tentativas falhas / Total |
| Contas Bloqueadas | < 1% | Bloqueios / Usuarios ativos |
| Tempo Medio de Login | < 2s | Response time medio |
| Recuperacoes de Senha | Monitorar | Por periodo |

### 7.2 Alertas

| Alerta | Condicao | Acao |
|--------|----------|------|
| Ataque Brute Force | > 50 falhas/min do mesmo IP | Bloquear IP temporariamente |
| Conta Admin Bloqueada | Bloqueio de Super Admin | Notificar equipe de seguranca |
| Token Comprometido | Uso de token em IPs diferentes | Invalidar todas as sessoes |

---

## 8. FLUXOS PRINCIPAIS

### 8.1 Fluxo de Login

```
Usuario acessa /sign-in
    |
    v
Preenche email e senha
    |
    v
Frontend valida campos
    |
    v
POST /api/auth/login
    |
    v
Backend valida credenciais
    |
    +--- Invalidas ---> Incrementa contador de falhas
    |                   Retorna erro generico
    |
    v (Validas)
Verifica se conta esta bloqueada
    |
    +--- Bloqueada ---> Retorna erro com tempo restante
    |
    v (Desbloqueada)
Verifica primeiro acesso
    |
    +--- Primeiro Acesso ---> Redireciona para troca de senha
    |
    v (Acesso normal)
Gera JWT Token + Refresh Token
    |
    v
Registra auditoria
    |
    v
Retorna tokens e dados do usuario
    |
    v
Frontend armazena tokens
    |
    v
Redireciona para dashboard
```

### 8.2 Fluxo de Recuperacao de Senha

```
Usuario clica "Esqueci minha senha"
    |
    v
Preenche email
    |
    v
POST /api/auth/forgot-password
    |
    v
Backend verifica email
    |
    +--- Nao encontrado ---> Retorna sucesso (nao revelar)
    |
    v (Encontrado)
Gera token de recuperacao (24h)
    |
    v
Envia email com link
    |
    v
Registra auditoria
    |
    v
Usuario clica no link
    |
    v
GET /reset-password?token=xxx
    |
    v
Frontend valida token
    |
    +--- Expirado/Invalido ---> Mostra erro
    |
    v (Valido)
Usuario define nova senha
    |
    v
POST /api/auth/reset-password
    |
    v
Backend valida requisitos de senha
    |
    v
Atualiza senha (BCrypt)
    |
    v
Invalida token de recuperacao
    |
    v
Registra auditoria
    |
    v
Redireciona para login
```

---

## 9. SEGURANCA

### 9.1 Protecoes Implementadas

| Protecao | Descricao |
|----------|-----------|
| BCrypt | Hash de senhas com salt |
| JWT com RS256 | Assinatura assimetrica |
| Rate Limiting | 10 logins/min por IP |
| CORS | Origem permitida configuravel |
| HTTPS | Obrigatorio em producao |
| HttpOnly Cookies | Refresh token |
| CSP | Content Security Policy |

### 9.2 Testes de Seguranca Obrigatorios

- SQL Injection no campo email
- XSS em todos os campos
- Brute Force Protection
- Token Tampering
- Session Fixation
- CSRF Protection

---

## 10. PROXIMOS PASSOS

1. **Implementacao Backend**: Criar Commands/Queries/Handlers
2. **Implementacao Frontend**: Telas Angular com Fuse
3. **Migracao de Dados**: Script para migrar senhas do legado
4. **Testes**: Executar todos os cenarios documentados
5. **Documentacao**: Guia do usuario

---

**Ultima Atualizacao**: 2025-11-19
**Autor**: Claude Code (Architect Agent)
**Revisao**: Pendente
