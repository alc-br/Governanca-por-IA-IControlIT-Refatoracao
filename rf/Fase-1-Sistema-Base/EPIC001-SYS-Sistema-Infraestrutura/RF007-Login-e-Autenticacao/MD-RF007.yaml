# =============================================
# MD-RF007 - Modelo de Dados Login e Autenticação
# Versão: 2.0
# Autor: Agência ALC - alc.dev.br
# Data: 2026-01-04
# =============================================

# =============================================
# 1. METADADOS DO DOCUMENTO (OBRIGATÓRIO)
# =============================================
metadata:
  versao: "2.0"
  data: "2026-01-04"
  autor: "Agência ALC - alc.dev.br"

  rf_relacionado:
    id: "RF007"
    nome: "Login e Autenticação"

  sistema_modulo: "Autenticação e Segurança"
  banco_de_dados:
    engine: "logico"  # Modelo lógico (independente de engine física)
    schema: "logico"  # Abstração de schema
  padroes:
    multi_tenancy: true
    auditoria: true
    soft_delete: true

# =============================================
# 2. ENTIDADES (OBRIGATÓRIO)
# =============================================
entidades:
  # =============================================
  # 2.1 TABELA: token_recuperacao_senha
  # =============================================
  - nome: "token_recuperacao_senha"
    descricao: "Token temporário para redefinição de senha via email"

    campos:
      # CHAVE PRIMÁRIA (OBRIGATÓRIO)
      - nome: "id"
        tipo: "GUID"
        nulo: false
        default: "NEWID()"
        descricao: "Chave primária"
        pk: true

      # MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "cliente_id"
        tipo: "GUID"
        nulo: false
        descricao: "FK para cliente (multi-tenancy)"
        fk:
          tabela: "cliente"
          coluna: "id"
          on_delete: "CASCADE"
        index: true
        origem:
          rf: "RF007"
          uc: "UC01"
          regra: "RN-AUTH-006"
          observacao: "Multi-tenancy obrigatório para isolamento de dados"

      # CAMPOS DE NEGÓCIO
      - nome: "usuario_id"
        tipo: "GUID"
        nulo: false
        descricao: "FK para usuário que solicitou recuperação"
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "CASCADE"
        index: true
        origem:
          rf: "RF007"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-003"

      - nome: "token"
        tipo: "GUID"
        nulo: false
        descricao: "Token único de recuperação"
        unique: true
        index: true
        origem:
          rf: "RF007"
          uc: "UC01, UC02"
          regra: "RN-AUTH-006"
          observacao: "Token único gerado para recuperação de senha"

      - nome: "data_expiracao"
        tipo: "DATETIME"
        nulo: false
        descricao: "Data de expiração do token (UTC + 24h)"
        index: true
        origem:
          rf: "RF007"
          uc: "UC02"
          regra: "RN-AUTH-006"
          observacao: "Token válido por 24 horas"

      - nome: "utilizado"
        tipo: "BOOLEAN"
        nulo: false
        default: false
        descricao: "Flag indicando se token já foi utilizado"
        index: true
        origem:
          rf: "RF007"
          uc: "UC02"
          regra: "RN-AUTH-006"
          observacao: "Token só pode ser usado uma vez"

      - nome: "data_utilizacao"
        tipo: "DATETIME"
        nulo: true
        default: null
        descricao: "Data em que token foi utilizado"
        origem:
          rf: "RF007"
          uc: "UC02"
          observacao: "Auditoria de uso do token"

      - nome: "ip_solicitacao"
        tipo: "VARCHAR(45)"
        nulo: true
        default: null
        descricao: "IP de origem da solicitação (IPv4/IPv6)"
        origem:
          rf: "RF007"
          uc: "UC01"
          regra: "RN-AUTH-010"
          observacao: "Auditoria de segurança"

      - nome: "user_agent_solicitacao"
        tipo: "VARCHAR(500)"
        nulo: true
        default: null
        descricao: "User-Agent do navegador na solicitação"
        origem:
          rf: "RF007"
          uc: "UC01"
          regra: "RN-AUTH-010"
          observacao: "Auditoria de segurança"

      # AUDITORIA (OBRIGATÓRIO - 5 campos)
      - nome: "created_at"
        tipo: "DATETIME"
        nulo: true
        default: "GETDATE()"
        descricao: "Data de criação"
        audit: true
        mutavel: false

      - nome: "created_by"
        tipo: "GUID"
        nulo: true
        default: null
        descricao: "Usuário que criou (sistema automático)"
        audit: true
        mutavel: false
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "SET NULL"

      - nome: "updated_at"
        tipo: "DATETIME"
        nulo: true
        default: null
        descricao: "Data de atualização"
        audit: true
        mutavel: false

      - nome: "updated_by"
        tipo: "GUID"
        nulo: true
        default: null
        descricao: "Usuário que atualizou"
        audit: true
        mutavel: false
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "SET NULL"

      # SOFT DELETE (OBRIGATÓRIO)
      - nome: "deleted_at"
        tipo: "DATETIME"
        nulo: true
        default: null
        descricao: "Soft delete (não aplicável para tokens temporários)"
        audit: true
        mutavel: false

    indices:
      # ÍNDICE PRIMÁRIO (OBRIGATÓRIO)
      - nome: "pk_token_recuperacao_senha"
        tipo: "PRIMARY"
        colunas: ["id"]
        descricao: "Chave primária"

      # ÍNDICE MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "idx_token_recuperacao_senha_cliente"
        tipo: "BTREE"
        colunas: ["cliente_id"]
        descricao: "Performance multi-tenant"

      # ÍNDICES DE PERFORMANCE
      - nome: "idx_token_recuperacao_senha_usuario"
        tipo: "BTREE"
        colunas: ["usuario_id"]
        descricao: "Performance em queries por usuário"

      - nome: "idx_token_recuperacao_senha_token"
        tipo: "BTREE"
        colunas: ["token"]
        descricao: "Performance em validação de token (único)"

      - nome: "idx_token_recuperacao_senha_expiracao"
        tipo: "BTREE"
        colunas: ["data_expiracao"]
        descricao: "Performance em limpeza de tokens expirados"

      - nome: "idx_token_recuperacao_senha_utilizado"
        tipo: "BTREE"
        colunas: ["utilizado"]
        descricao: "Performance em filtro de tokens válidos"

    constraints:
      # FK MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "fk_token_recuperacao_senha_cliente"
        tipo: "FOREIGN KEY"
        definicao: "cliente_id REFERENCES cliente(id)"
        on_delete: "CASCADE"
        descricao: "Multi-tenancy"

      # FK USUÁRIO
      - nome: "fk_token_recuperacao_senha_usuario"
        tipo: "FOREIGN KEY"
        definicao: "usuario_id REFERENCES usuario(id)"
        on_delete: "CASCADE"
        descricao: "Usuário solicitante"

      # UNIQUE TOKEN
      - nome: "uq_token_recuperacao_senha_token"
        tipo: "UNIQUE"
        definicao: "token"
        descricao: "Token único global"

      # FKs DE AUDITORIA (OBRIGATÓRIO)
      - nome: "fk_token_recuperacao_senha_created_by"
        tipo: "FOREIGN KEY"
        definicao: "created_by REFERENCES usuario(id)"
        on_delete: "SET NULL"
        descricao: "Auditoria - criador"

      - nome: "fk_token_recuperacao_senha_updated_by"
        tipo: "FOREIGN KEY"
        definicao: "updated_by REFERENCES usuario(id)"
        on_delete: "SET NULL"
        descricao: "Auditoria - editor"

  # =============================================
  # 2.2 TABELA: sessao_ativa
  # =============================================
  - nome: "sessao_ativa"
    descricao: "Sessão JWT ativa de um usuário autenticado"

    campos:
      # CHAVE PRIMÁRIA (OBRIGATÓRIO)
      - nome: "id"
        tipo: "GUID"
        nulo: false
        default: "NEWID()"
        descricao: "Chave primária"
        pk: true

      # MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "cliente_id"
        tipo: "GUID"
        nulo: false
        descricao: "FK para cliente (multi-tenancy)"
        fk:
          tabela: "cliente"
          coluna: "id"
          on_delete: "CASCADE"
        index: true
        origem:
          rf: "RF007"
          uc: "UC00"
          observacao: "Multi-tenancy obrigatório para isolamento de dados"

      # CAMPOS DE NEGÓCIO
      - nome: "usuario_id"
        tipo: "GUID"
        nulo: false
        descricao: "FK para usuário autenticado"
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "CASCADE"
        index: true
        origem:
          rf: "RF007"
          uc: "UC00"
          wf: "WF-01"

      - nome: "access_token_jti"
        tipo: "GUID"
        nulo: false
        descricao: "JTI (JWT ID) do access token"
        unique: true
        index: true
        origem:
          rf: "RF007"
          uc: "UC00"
          regra: "RN-AUTH-002"
          observacao: "Identificador único do JWT"

      - nome: "refresh_token_jti"
        tipo: "GUID"
        nulo: false
        descricao: "JTI do refresh token"
        unique: true
        index: true
        origem:
          rf: "RF007"
          uc: "UC05"
          observacao: "Permite renovação de sessão"

      - nome: "data_login"
        tipo: "DATETIME"
        nulo: false
        default: "GETDATE()"
        descricao: "Data/hora do login (UTC)"
        index: true
        origem:
          rf: "RF007"
          uc: "UC00"
          regra: "RN-AUTH-010"

      - nome: "data_expiracao_access"
        tipo: "DATETIME"
        nulo: false
        descricao: "Data de expiração do access token (UTC + 8h)"
        index: true
        origem:
          rf: "RF007"
          uc: "UC00"
          regra: "RN-AUTH-002"
          observacao: "Token JWT válido por 8 horas"

      - nome: "data_expiracao_refresh"
        tipo: "DATETIME"
        nulo: false
        descricao: "Data de expiração do refresh token (UTC + 7 dias)"
        index: true
        origem:
          rf: "RF007"
          uc: "UC05"
          observacao: "Refresh token válido por 7 dias"

      - nome: "data_ultima_atividade"
        tipo: "DATETIME"
        nulo: true
        default: null
        descricao: "Data da última atividade do usuário"
        index: true
        origem:
          rf: "RF007"
          uc: "UC05"
          regra: "RN-AUTH-009"
          observacao: "Para timeout de 30 minutos"

      - nome: "ip_login"
        tipo: "VARCHAR(45)"
        nulo: true
        default: null
        descricao: "IP de origem do login (IPv4/IPv6)"
        index: true
        origem:
          rf: "RF007"
          uc: "UC00"
          regra: "RN-AUTH-010"

      - nome: "user_agent"
        tipo: "VARCHAR(500)"
        nulo: true
        default: null
        descricao: "User-Agent do navegador"
        origem:
          rf: "RF007"
          uc: "UC00"
          regra: "RN-AUTH-010, RN-AUTH-012"

      - nome: "dispositivo"
        tipo: "VARCHAR(100)"
        nulo: true
        default: null
        descricao: "Tipo de dispositivo (mobile, tablet, desktop)"
        origem:
          rf: "RF007"
          uc: "UC00"
          regra: "RN-AUTH-012"

      - nome: "status"
        tipo: "VARCHAR(30)"
        nulo: false
        default: "ativa"
        descricao: "Status da sessão (ativa, expirada, invalidada)"
        index: true
        check:
          definicao: "status IN ('ativa','expirada','invalidada')"
          descricao: "Status permitido"
        origem:
          rf: "RF007"
          uc: "UC04"

      - nome: "data_invalidacao"
        tipo: "DATETIME"
        nulo: true
        default: null
        descricao: "Data em que sessão foi invalidada (logout manual/forçado)"
        origem:
          rf: "RF007"
          uc: "UC04"

      - nome: "motivo_invalidacao"
        tipo: "VARCHAR(100)"
        nulo: true
        default: null
        descricao: "Motivo da invalidação (logout, admin, timeout, security)"
        origem:
          rf: "RF007"
          uc: "UC04"

      # AUDITORIA (OBRIGATÓRIO - 5 campos)
      - nome: "created_at"
        tipo: "DATETIME"
        nulo: true
        default: "GETDATE()"
        descricao: "Data de criação"
        audit: true
        mutavel: false

      - nome: "created_by"
        tipo: "GUID"
        nulo: true
        default: null
        descricao: "Usuário que criou (sistema automático)"
        audit: true
        mutavel: false
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "SET NULL"

      - nome: "updated_at"
        tipo: "DATETIME"
        nulo: true
        default: null
        descricao: "Data de atualização"
        audit: true
        mutavel: false

      - nome: "updated_by"
        tipo: "GUID"
        nulo: true
        default: null
        descricao: "Usuário que atualizou"
        audit: true
        mutavel: false
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "SET NULL"

      # SOFT DELETE (OBRIGATÓRIO)
      - nome: "deleted_at"
        tipo: "DATETIME"
        nulo: true
        default: null
        descricao: "Soft delete (não aplicável para sessões temporárias)"
        audit: true
        mutavel: false

    indices:
      # ÍNDICE PRIMÁRIO (OBRIGATÓRIO)
      - nome: "pk_sessao_ativa"
        tipo: "PRIMARY"
        colunas: ["id"]
        descricao: "Chave primária"

      # ÍNDICE MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "idx_sessao_ativa_cliente"
        tipo: "BTREE"
        colunas: ["cliente_id"]
        descricao: "Performance multi-tenant"

      # ÍNDICES DE PERFORMANCE
      - nome: "idx_sessao_ativa_usuario"
        tipo: "BTREE"
        colunas: ["usuario_id"]
        descricao: "Performance em listagem de sessões por usuário"

      - nome: "idx_sessao_ativa_access_token"
        tipo: "BTREE"
        colunas: ["access_token_jti"]
        descricao: "Performance em validação de access token"

      - nome: "idx_sessao_ativa_refresh_token"
        tipo: "BTREE"
        colunas: ["refresh_token_jti"]
        descricao: "Performance em validação de refresh token"

      - nome: "idx_sessao_ativa_status"
        tipo: "BTREE"
        colunas: ["status"]
        descricao: "Performance em filtro por status"

      - nome: "idx_sessao_ativa_expiracao_access"
        tipo: "BTREE"
        colunas: ["data_expiracao_access"]
        descricao: "Performance em limpeza de sessões expiradas"

      - nome: "idx_sessao_ativa_ultima_atividade"
        tipo: "BTREE"
        colunas: ["data_ultima_atividade"]
        descricao: "Performance em detecção de timeout"

    constraints:
      # FK MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "fk_sessao_ativa_cliente"
        tipo: "FOREIGN KEY"
        definicao: "cliente_id REFERENCES cliente(id)"
        on_delete: "CASCADE"
        descricao: "Multi-tenancy"

      # FK USUÁRIO
      - nome: "fk_sessao_ativa_usuario"
        tipo: "FOREIGN KEY"
        definicao: "usuario_id REFERENCES usuario(id)"
        on_delete: "CASCADE"
        descricao: "Usuário autenticado"

      # UNIQUE ACCESS TOKEN
      - nome: "uq_sessao_ativa_access_token"
        tipo: "UNIQUE"
        definicao: "access_token_jti"
        descricao: "Access token JTI único global"

      # UNIQUE REFRESH TOKEN
      - nome: "uq_sessao_ativa_refresh_token"
        tipo: "UNIQUE"
        definicao: "refresh_token_jti"
        descricao: "Refresh token JTI único global"

      # CHECK STATUS
      - nome: "chk_sessao_ativa_status"
        tipo: "CHECK"
        definicao: "status IN ('ativa','expirada','invalidada')"
        descricao: "Status permitido"

      # FKs DE AUDITORIA (OBRIGATÓRIO)
      - nome: "fk_sessao_ativa_created_by"
        tipo: "FOREIGN KEY"
        definicao: "created_by REFERENCES usuario(id)"
        on_delete: "SET NULL"
        descricao: "Auditoria - criador"

      - nome: "fk_sessao_ativa_updated_by"
        tipo: "FOREIGN KEY"
        definicao: "updated_by REFERENCES usuario(id)"
        on_delete: "SET NULL"
        descricao: "Auditoria - editor"

  # =============================================
  # 2.3 TABELA: historico_senhas
  # =============================================
  - nome: "historico_senhas"
    descricao: "Histórico das últimas 5 senhas de cada usuário (hash BCrypt)"

    campos:
      # CHAVE PRIMÁRIA (OBRIGATÓRIO)
      - nome: "id"
        tipo: "GUID"
        nulo: false
        default: "NEWID()"
        descricao: "Chave primária"
        pk: true

      # MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "cliente_id"
        tipo: "GUID"
        nulo: false
        descricao: "FK para cliente (multi-tenancy)"
        fk:
          tabela: "cliente"
          coluna: "id"
          on_delete: "CASCADE"
        index: true
        origem:
          rf: "RF007"
          uc: "UC02, UC03"
          observacao: "Multi-tenancy obrigatório para isolamento de dados"

      # CAMPOS DE NEGÓCIO
      - nome: "usuario_id"
        tipo: "GUID"
        nulo: false
        descricao: "FK para usuário"
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "CASCADE"
        index: true
        origem:
          rf: "RF007"
          uc: "UC02, UC03"
          regra: "RN-AUTH-007"

      - nome: "senha_hash"
        tipo: "VARCHAR(255)"
        nulo: false
        descricao: "Hash BCrypt da senha (60-72 caracteres)"
        origem:
          rf: "RF007"
          uc: "UC02, UC03"
          regra: "RN-AUTH-007"
          observacao: "Hash BCrypt da senha para comparação"

      - nome: "data_alteracao"
        tipo: "DATETIME"
        nulo: false
        default: "GETDATE()"
        descricao: "Data em que senha foi alterada"
        index: true
        origem:
          rf: "RF007"
          uc: "UC02, UC03"
          regra: "RN-AUTH-007"

      - nome: "ip_alteracao"
        tipo: "VARCHAR(45)"
        nulo: true
        default: null
        descricao: "IP de origem da alteração (IPv4/IPv6)"
        origem:
          rf: "RF007"
          uc: "UC02, UC03"
          regra: "RN-AUTH-010"

      - nome: "user_agent_alteracao"
        tipo: "VARCHAR(500)"
        nulo: true
        default: null
        descricao: "User-Agent do navegador na alteração"
        origem:
          rf: "RF007"
          uc: "UC02, UC03"
          regra: "RN-AUTH-010"

      # AUDITORIA (OBRIGATÓRIO - 5 campos)
      - nome: "created_at"
        tipo: "DATETIME"
        nulo: true
        default: "GETDATE()"
        descricao: "Data de criação"
        audit: true
        mutavel: false

      - nome: "created_by"
        tipo: "GUID"
        nulo: true
        default: null
        descricao: "Usuário que criou (sistema automático)"
        audit: true
        mutavel: false
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "SET NULL"

      - nome: "updated_at"
        tipo: "DATETIME"
        nulo: true
        default: null
        descricao: "Data de atualização"
        audit: true
        mutavel: false

      - nome: "updated_by"
        tipo: "GUID"
        nulo: true
        default: null
        descricao: "Usuário que atualizou"
        audit: true
        mutavel: false
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "SET NULL"

      # SOFT DELETE (OBRIGATÓRIO)
      - nome: "deleted_at"
        tipo: "DATETIME"
        nulo: true
        default: null
        descricao: "Soft delete (não aplicável para histórico)"
        audit: true
        mutavel: false

    indices:
      # ÍNDICE PRIMÁRIO (OBRIGATÓRIO)
      - nome: "pk_historico_senhas"
        tipo: "PRIMARY"
        colunas: ["id"]
        descricao: "Chave primária"

      # ÍNDICE MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "idx_historico_senhas_cliente"
        tipo: "BTREE"
        colunas: ["cliente_id"]
        descricao: "Performance multi-tenant"

      # ÍNDICES DE PERFORMANCE
      - nome: "idx_historico_senhas_usuario"
        tipo: "BTREE"
        colunas: ["usuario_id"]
        descricao: "Performance em validação de histórico por usuário"

      - nome: "idx_historico_senhas_data"
        tipo: "BTREE"
        colunas: ["data_alteracao"]
        descricao: "Performance em ordenação para pegar últimas 5"

      - nome: "idx_historico_senhas_usuario_data"
        tipo: "BTREE"
        colunas: ["usuario_id", "data_alteracao"]
        descricao: "Performance em query de últimas 5 senhas por usuário"

    constraints:
      # FK MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "fk_historico_senhas_cliente"
        tipo: "FOREIGN KEY"
        definicao: "cliente_id REFERENCES cliente(id)"
        on_delete: "CASCADE"
        descricao: "Multi-tenancy"

      # FK USUÁRIO
      - nome: "fk_historico_senhas_usuario"
        tipo: "FOREIGN KEY"
        definicao: "usuario_id REFERENCES usuario(id)"
        on_delete: "CASCADE"
        descricao: "Usuário proprietário do histórico"

      # FKs DE AUDITORIA (OBRIGATÓRIO)
      - nome: "fk_historico_senhas_created_by"
        tipo: "FOREIGN KEY"
        definicao: "created_by REFERENCES usuario(id)"
        on_delete: "SET NULL"
        descricao: "Auditoria - criador"

      - nome: "fk_historico_senhas_updated_by"
        tipo: "FOREIGN KEY"
        definicao: "updated_by REFERENCES usuario(id)"
        on_delete: "SET NULL"
        descricao: "Auditoria - editor"

# =============================================
# 3. RELACIONAMENTOS GLOBAIS
# =============================================
relacionamentos_globais:
  - origem: "cliente"
    cardinalidade: "1:N"
    destino: "token_recuperacao_senha"
    descricao: "Um cliente possui muitos tokens de recuperação"

  - origem: "usuario"
    cardinalidade: "1:N"
    destino: "token_recuperacao_senha"
    descricao: "Um usuário pode ter múltiplos tokens de recuperação (histórico)"

  - origem: "cliente"
    cardinalidade: "1:N"
    destino: "sessao_ativa"
    descricao: "Um cliente possui muitas sessões ativas"

  - origem: "usuario"
    cardinalidade: "1:N"
    destino: "sessao_ativa"
    descricao: "Um usuário pode ter múltiplas sessões ativas (diferentes dispositivos)"

  - origem: "cliente"
    cardinalidade: "1:N"
    destino: "historico_senhas"
    descricao: "Um cliente possui muitos registros de histórico de senhas"

  - origem: "usuario"
    cardinalidade: "1:N"
    destino: "historico_senhas"
    descricao: "Um usuário possui histórico de últimas 5 senhas"

# =============================================
# 4. OBSERVAÇÕES E DECISÕES (OBRIGATÓRIO)
# =============================================
observacoes:
  - categoria: "Modelagem"
    descricao: "Modelo derivado 100% do RF007, UC-RF007 e WF-RF007. Entidades criadas: token_recuperacao_senha (UC01, UC02), sessao_ativa (UC00, UC04, UC05), historico_senhas (UC02, UC03)"

  - categoria: "Modelagem"
    descricao: "Campos de auditoria (IP, User-Agent) incluídos em todas as tabelas para rastreabilidade e segurança (RN-AUTH-010, RN-AUTH-012)"

  - categoria: "Performance"
    descricao: "Índices criados para queries principais: validação de tokens (token, data_expiracao), validação de sessões (access_token_jti, refresh_token_jti, status), validação de histórico de senhas (usuario_id, data_alteracao)"

  - categoria: "Performance"
    descricao: "Índice composto (usuario_id, data_alteracao) em historico_senhas para performance na query de últimas 5 senhas por usuário (RN-AUTH-007)"

  - categoria: "Segurança"
    descricao: "Multi-tenancy (cliente_id) obrigatório em todas as tabelas para isolamento de dados entre tenants. Cascade delete para garantir limpeza de dados ao excluir cliente"

  - categoria: "Segurança"
    descricao: "Histórico de senhas armazena apenas hashes BCrypt (60-72 caracteres), nunca senhas em texto plano. Comparação via BCrypt.Verify() no backend"

  - categoria: "Segurança"
    descricao: "Tokens (token_recuperacao_senha e sessao_ativa) utilizam GUID para evitar enumeração e garantir unicidade global"

  - categoria: "Segurança"
    descricao: "Campo 'utilizado' em token_recuperacao_senha impede reutilização de tokens (one-time use). Campo 'status' em sessao_ativa permite invalidação manual/forçada"

  - categoria: "Migração"
    descricao: "Tabelas novas (não existem no legado). Implementação será feita do zero no backend .NET (RF007 skeleton 71% completo)"

  - categoria: "Migração"
    descricao: "Limpeza automática (Job Hangfire) deve ser implementada para remover tokens expirados (> 24h) e sessões expiradas (> 7 dias) periodicamente"

  - categoria: "Auditoria"
    descricao: "Todas as tabelas possuem campos obrigatórios de auditoria (created_at, created_by, updated_at, updated_by, deleted_at) para rastreabilidade completa"

  - categoria: "Auditoria"
    descricao: "Soft delete (deleted_at) incluído mas não aplicável para tabelas temporárias (tokens e sessões). Hard delete via Jobs de limpeza"

  - categoria: "Derivação RF → UC → WF → MD"
    descricao: "token_recuperacao_senha: derivado de UC01 (solicitar recuperação) e UC02 (redefinir senha), WF-02 (esqueci senha), WF-03 (redefinir senha)"

  - categoria: "Derivação RF → UC → WF → MD"
    descricao: "sessao_ativa: derivado de UC00 (login), UC04 (logout), UC05 (renovar sessão), UC09 (logo corporativa), WF-01 (login)"

  - categoria: "Derivação RF → UC → WF → MD"
    descricao: "historico_senhas: derivado de UC02 (redefinir senha), UC03 (primeiro acesso), RN-AUTH-007 (não reutilizar últimas 5 senhas)"

  - categoria: "Regras de Negócio"
    descricao: "RN-AUTH-002: JWT Token com expiração de 8 horas (data_expiracao_access = UTC + 8h)"

  - categoria: "Regras de Negócio"
    descricao: "RN-AUTH-006: Token de recuperação válido por 24 horas (data_expiracao = UTC + 24h), one-time use (utilizado = true após uso)"

  - categoria: "Regras de Negócio"
    descricao: "RN-AUTH-007: Não reutilizar últimas 5 senhas (tabela historico_senhas mantém últimas 5 por usuário)"

  - categoria: "Regras de Negócio"
    descricao: "RN-AUTH-009: Timeout por inatividade de 30 minutos (data_ultima_atividade atualizada a cada requisição, validação no backend)"

  - categoria: "Regras de Negócio"
    descricao: "RN-AUTH-010: Auditoria completa de tentativas de login (campos IP, User-Agent em todas as tabelas)"

  - categoria: "Jobs Background"
    descricao: "Job 1: Limpeza de tokens expirados (token_recuperacao_senha WHERE data_expiracao < GETDATE() OR utilizado = true). Execução: diária (3h da manhã)"

  - categoria: "Jobs Background"
    descricao: "Job 2: Limpeza de sessões expiradas (sessao_ativa WHERE data_expiracao_refresh < GETDATE() OR status IN ('expirada','invalidada')). Execução: diária (3h da manhã)"

  - categoria: "Jobs Background"
    descricao: "Job 3: Notificação de login em novo dispositivo (RN-AUTH-012 - opcional). Execução: assíncrona via Hangfire ao detectar IP/User-Agent novo"

# =============================================
# 5. HISTÓRICO DE ALTERAÇÕES (OBRIGATÓRIO)
# =============================================
historico:
  - versao: "2.0"
    data: "2026-01-04"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Versão inicial derivada do RF007, UC-RF007 e WF-RF007. Entidades: token_recuperacao_senha, sessao_ativa, historico_senhas. Multi-tenancy, auditoria e soft delete implementados conforme contrato. Cobertura 100% dos UCs (UC00, UC01, UC02, UC03, UC04, UC05, UC06, UC09)"
