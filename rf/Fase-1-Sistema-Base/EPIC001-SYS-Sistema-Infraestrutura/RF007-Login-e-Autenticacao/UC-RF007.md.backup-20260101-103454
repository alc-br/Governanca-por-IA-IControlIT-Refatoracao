# Casos de Uso - RF007

**RF:** RF007 — Login e Autenticação
**Versão:** 2.0
**Data:** 2025-12-31
**Autor:** Agência ALC - alc.dev.br
**Epic:** EPIC001-SYS - Sistema Infraestrutura
**Fase:** Fase 1 - Sistema Base
**RF Relacionado:** [RF007 - Login-e-Autenticacao](./RF007.md)

---

## Índice de Casos de Uso

| UC | Nome | Descrição |
|----|------|-----------|
| UC00 | Realizar Login | Caso de uso |
| UC01 | Esqueci Minha Senha | Caso de uso |
| UC02 | Redefinir Senha | Caso de uso |
| UC03 | Primeiro Acesso | Caso de uso |
| UC04 | Logout | Caso de uso |
| UC05 | Renovar Sessao | Caso de uso |
| UC06 | Bloqueio por Tentativas | Caso de uso |

---

# UC00: Realizar Login

**Data Criacao**: 2025-11-19
**Ultima Atualizacao**: 2025-11-19
**Autor**: Claude Code
**Status**: Documentado

---

## Sumario Executivo

| Aspecto | Detalhes |
|---------|----------|
| **Objetivo** | Autenticar usuario no sistema com email e senha |
| **Atores** | Usuario (qualquer pessoa com credenciais) |
| **Pre-condicoes** | Usuario cadastrado, conta ativa, sistema disponivel |
| **Pos-condicoes** | Token JWT gerado, sessao criada, auditoria registrada |
| **Cenarios de Teste** | 100 cenarios (validacao, seguranca, performance) |
| **Prioridade** | Critica (porta de entrada do sistema) |

---

## Descricao do Caso de Uso

### Objetivo

Permitir que usuarios autenticados acessem o sistema IControlIT atraves de:
1. **Validacao de Credenciais**: Email e senha
2. **Geracao de Token JWT**: Para autorizacao de requests
3. **Controle de Sessao**: Refresh token e timeout
4. **Protecao contra Ataques**: Bloqueio por tentativas

### Atores

- **Usuario**: Qualquer pessoa com credenciais validas
- **Sistema**: Valida, gera tokens, registra auditoria

### Permissoes

- Login nao requer permissoes especificas (acesso publico)
- Apos login, permissoes sao carregadas do perfil

---

## Fluxo Principal - Login com Sucesso

**FP-01: Login Padrao**

1. Usuario acessa `/sign-in`
2. Sistema exibe formulario de login:
   ```
   +--------------------------------+
   |         IControlIT             |
   |                                |
   |  E-mail:                       |
   |  [________________________]    |
   |                                |
   |  Senha:                        |
   |  [________________________] [O]|
   |                                |
   |  [ ] Lembrar-me                |
   |                                |
   |  [      Entrar      ]          |
   |                                |
   |  Esqueceu a senha?             |
   +--------------------------------+
   ```
3. Usuario preenche:
   - Email: `usuario@empresa.com.br`
   - Senha: `Senh@123`
4. Usuario clica em "Entrar"
5. Frontend valida campos:
   - Email: formato valido
   - Senha: nao vazio
6. Sistema envia `POST /api/auth/login`:
   ```json
   {
     "email": "usuario@empresa.com.br",
     "password": "Senh@123"
   }
   ```
7. Backend valida credenciais:
   - Busca usuario por email
   - Verifica se conta esta ativa
   - Verifica se conta esta bloqueada
   - Compara hash da senha (BCrypt)
8. Backend gera tokens:
   ```json
   {
     "accessToken": "eyJhbGciOiJSUzI1NiIs...",
     "refreshToken": "dGhpcyBpcyBhIHJlZnJl...",
     "expiresIn": 28800,
     "tokenType": "Bearer"
   }
   ```
9. Backend cria sessao em `SessaoUsuario`
10. Backend reseta contador de tentativas falhas
11. Backend registra auditoria `AUTH_LOGIN_SUCCESS`
12. Frontend armazena tokens:
    - `accessToken` no localStorage
    - `refreshToken` em cookie HttpOnly (se disponivel)
13. Frontend redireciona para `/dashboards/project`
14. Sistema exibe dashboard com nome do usuario

**Resultado Esperado**:
- Token JWT valido por 8 horas
- Refresh token valido por 7 dias
- Sessao ativa registrada
- Auditoria completa

---

## Fluxos Alternativos

### FA-01: Credenciais Invalidas

1. Usuario preenche email ou senha incorretos
2. Sistema valida e nao encontra correspondencia
3. Sistema incrementa contador de tentativas
4. Sistema registra `AUTH_LOGIN_FAILURE`
5. Sistema retorna erro generico:
   ```json
   {
     "error": "InvalidCredentials",
     "message": "E-mail ou senha incorretos"
   }
   ```
6. Frontend exibe mensagem de erro
7. Usuario pode tentar novamente

**Importante**: Nunca informar se o problema e no email ou na senha.

---

### FA-02: Usuario Bloqueado

1. Usuario preenche credenciais
2. Sistema verifica que conta esta bloqueada
3. Sistema calcula tempo restante:
   ```csharp
   var minutosRestantes = 30 - (DateTime.UtcNow - DataBloqueio).TotalMinutes;
   ```
4. Sistema retorna:
   ```json
   {
     "error": "AccountLocked",
     "message": "Conta bloqueada. Tente novamente em 25 minutos.",
     "minutesRemaining": 25
   }
   ```
5. Frontend exibe mensagem com countdown
6. Usuario deve aguardar desbloqueio automatico

---

### FA-03: Empresa Inativa

1. Usuario preenche credenciais validas
2. Sistema verifica que empresa esta inativa
3. Sistema retorna:
   ```json
   {
     "error": "CompanyInactive",
     "message": "Sua empresa esta temporariamente inativa. Contate o administrador."
   }
   ```
4. Usuario nao pode acessar ate empresa ser reativada

---

### FA-04: Primeiro Acesso

1. Usuario preenche credenciais validas
2. Sistema detecta `Fl_Primeiro_Acesso = true`
3. Sistema gera token temporario (1 hora)
4. Sistema retorna:
   ```json
   {
     "requirePasswordChange": true,
     "temporaryToken": "...",
     "message": "Primeiro acesso detectado. Por favor, altere sua senha."
   }
   ```
5. Frontend redireciona para `/change-password`
6. Apos trocar senha, usuario faz login novamente

---

### FA-05: Maximo de Tentativas Excedido

1. Usuario erra senha pela 5a vez em 15 minutos
2. Sistema bloqueia conta:
   ```csharp
   usuario.Bloqueado = true;
   usuario.DataBloqueio = DateTime.UtcNow;
   ```
3. Sistema registra `AUTH_ACCOUNT_LOCKED`
4. Sistema envia email de notificacao ao usuario
5. Sistema retorna erro de conta bloqueada (FA-02)

---

### FA-06: Lembrar-me Marcado

1. Usuario marca checkbox "Lembrar-me"
2. Sistema gera refresh token com validade estendida (30 dias)
3. Frontend armazena em cookie persistente
4. Proximo acesso nao requer login (se token valido)

---

### FA-07: Login de Novo Dispositivo

1. Sistema detecta IP/UserAgent desconhecido
2. Sistema gera tokens normalmente
3. Sistema envia email de alerta:
   ```
   Novo acesso detectado

   Detectamos um acesso a sua conta de um novo dispositivo:

   - Data/Hora: 19/11/2025 15:30
   - IP: 189.100.50.25
   - Navegador: Chrome 119
   - Localizacao: Sao Paulo, SP

   Se nao foi voce, altere sua senha imediatamente.
   ```

---

## Fluxos de Excecao

### FE-01: Email Vazio

**Condicao**: Campo email em branco

**Acao**:
- Status: 400 Bad Request
- Erro: `{ "email": ["E-mail e obrigatorio"] }`
- Campo fica vermelho

---

### FE-02: Email Formato Invalido

**Condicao**: Email sem @ ou dominio

**Acao**:
- Status: 400 Bad Request
- Erro: `{ "email": ["Formato de e-mail invalido"] }`

---

### FE-03: Senha Vazia

**Condicao**: Campo senha em branco

**Acao**:
- Status: 400 Bad Request
- Erro: `{ "password": ["Senha e obrigatoria"] }`

---

### FE-04: Usuario Nao Encontrado

**Condicao**: Email nao existe no banco

**Acao**:
- Status: 401 Unauthorized
- Erro: "E-mail ou senha incorretos" (generico)
- Registrar `AUTH_LOGIN_FAILURE` com motivo `USER_NOT_FOUND`

**Importante**: Nao revelar que usuario nao existe.

---

### FE-05: Senha Incorreta

**Condicao**: Senha nao corresponde ao hash

**Acao**:
- Status: 401 Unauthorized
- Erro: "E-mail ou senha incorretos" (generico)
- Incrementar contador de tentativas
- Registrar `AUTH_LOGIN_FAILURE` com motivo `INVALID_PASSWORD`

---

### FE-06: Usuario Inativo

**Condicao**: `Usuario.Ativo = false`

**Acao**:
- Status: 401 Unauthorized
- Erro: "Sua conta esta inativa. Contate o administrador."
- Registrar `AUTH_LOGIN_FAILURE` com motivo `USER_INACTIVE`

---

### FE-07: Erro de Servidor

**Condicao**: Excecao nao tratada

**Acao**:
- Status: 500 Internal Server Error
- Erro: "Erro interno. Tente novamente mais tarde."
- Log completo no servidor
- Alerta para equipe de operacoes

---

### FE-08: Rate Limiting

**Condicao**: Muitas requisicoes do mesmo IP

**Acao**:
- Status: 429 Too Many Requests
- Erro: "Muitas tentativas. Aguarde 1 minuto."
- Header: `Retry-After: 60`

---

## Regras de Negocio Aplicaveis

| Codigo | Descricao | Aplicacao no UC |
|--------|-----------|-----------------|
| RN-AUTH-001 | Email e senha | Campos do formulario |
| RN-AUTH-002 | Token 8 horas | Geracao do JWT |
| RN-AUTH-003 | 5 tentativas | Bloqueio de conta |
| RN-AUTH-005 | Case-sensitive | Comparacao de senha |
| RN-AUTH-008 | Primeiro acesso | Redirect para troca |
| RN-AUTH-010 | Auditoria | Log de todas tentativas |
| RN-AUTH-011 | Mensagem generica | Erro de credenciais |

---

## Validacoes

### Campos de Entrada

| Campo | Tipo | Obrigatorio | Validacao |
|-------|------|-------------|-----------|
| email | string | Sim | Formato email valido, max 256 chars |
| password | string | Sim | Min 1 char, max 100 chars |
| rememberMe | boolean | Nao | Default false |

### Validacoes de Backend

1. Email existe no banco
2. Usuario esta ativo
3. Empresa esta ativa
4. Conta nao esta bloqueada
5. Senha corresponde ao hash
6. Nao e primeiro acesso (ou redirecionar)

---

## Integracao i18n

### Chaves de Traducao

```json
{
    "auth.login.title": "Entrar no Sistema",
    "auth.login.email": "E-mail",
    "auth.login.email.placeholder": "seu@email.com.br",
    "auth.login.password": "Senha",
    "auth.login.password.placeholder": "Digite sua senha",
    "auth.login.rememberMe": "Lembrar-me",
    "auth.login.submit": "Entrar",
    "auth.login.forgotPassword": "Esqueceu a senha?",
    "auth.login.error.required.email": "E-mail e obrigatorio",
    "auth.login.error.required.password": "Senha e obrigatoria",
    "auth.login.error.invalid.email": "Formato de e-mail invalido",
    "auth.login.error.invalidCredentials": "E-mail ou senha incorretos",
    "auth.login.error.accountLocked": "Conta bloqueada. Tente novamente em {minutes} minutos",
    "auth.login.error.userInactive": "Sua conta esta inativa. Contate o administrador",
    "auth.login.error.companyInactive": "Sua empresa esta temporariamente inativa",
    "auth.login.error.server": "Erro interno. Tente novamente mais tarde"
}
```

---

## Operacoes de Auditoria

| Operacao | Codigo | Quando | Dados |
|----------|--------|--------|-------|
| Login Sucesso | AUTH_LOGIN_SUCCESS | Credenciais validas | email, ip, userAgent, timestamp |
| Login Falha | AUTH_LOGIN_FAILURE | Credenciais invalidas | email, ip, userAgent, motivo |
| Conta Bloqueada | AUTH_ACCOUNT_LOCKED | 5 tentativas | email, ip, tentativas |

---

## Requisitos Nao Funcionais

### Performance

- Response time: < 500ms (P95)
- Throughput: 100 logins/segundo

### Seguranca

- HTTPS obrigatorio
- Rate limiting: 10/min por IP
- Tokens assinados com RS256
- Senhas hasheadas com BCrypt (cost 12)

### Disponibilidade

- SLA: 99.9%
- Failover automatico

### Usabilidade

- Tab order logico
- Enter submete formulario
- Mensagens claras
- Suporte a screen readers

---

## Cenarios de Teste (100 Cenarios)

### Categoria 1: Validacao de Campos (20 cenarios)

| ID | Cenario | Entrada | Resultado Esperado |
|----|---------|---------|-------------------|
| CT-001 | Login com sucesso | email valido, senha correta | 200 OK, tokens retornados |
| CT-002 | Email vazio | email: "" | 400, "E-mail e obrigatorio" |
| CT-003 | Senha vazia | password: "" | 400, "Senha e obrigatoria" |
| CT-004 | Email invalido | email: "teste" | 400, "Formato invalido" |
| CT-005 | Email sem dominio | email: "teste@" | 400, "Formato invalido" |
| CT-006 | Email muito longo | email: 257 chars | 400, "Max 256 caracteres" |
| CT-007 | Senha muito longa | password: 101 chars | 400, "Max 100 caracteres" |
| CT-008 | Email com espacos | email: " teste@email.com " | Trimmed, processa normalmente |
| CT-009 | Email uppercase | email: "TESTE@EMAIL.COM" | Case-insensitive, encontra |
| CT-010 | Senha case-sensitive | senha errada em casing | 401, "E-mail ou senha incorretos" |
| CT-011 | Caracteres especiais no email | email: "user+tag@email.com" | Valido, processa |
| CT-012 | Unicode no email | email: "usuário@email.com" | 400, "Caracteres invalidos" |
| CT-013 | SQL Injection no email | email: "'; DROP TABLE --" | Sanitizado, 401 |
| CT-014 | XSS no email | email: "&lt;script&gt;" | Sanitizado, 401 |
| CT-015 | Email null | email: null | 400, "E-mail e obrigatorio" |
| CT-016 | Password null | password: null | 400, "Senha e obrigatoria" |
| CT-017 | Ambos vazios | email: "", password: "" | 400, erros para ambos |
| CT-018 | JSON malformado | { invalido } | 400, "JSON invalido" |
| CT-019 | Content-Type errado | text/plain | 415, "Unsupported Media Type" |
| CT-020 | Body vazio | {} | 400, campos obrigatorios |

### Categoria 2: Autenticacao (20 cenarios)

| ID | Cenario | Condicao | Resultado Esperado |
|----|---------|----------|-------------------|
| CT-021 | Usuario nao existe | email nao cadastrado | 401, mensagem generica |
| CT-022 | Senha incorreta | senha errada | 401, mensagem generica |
| CT-023 | Usuario inativo | Ativo = false | 401, "conta inativa" |
| CT-024 | Empresa inativa | Empresa.Ativo = false | 401, "empresa inativa" |
| CT-025 | Conta bloqueada | Bloqueado = true | 401, minutos restantes |
| CT-026 | Primeiro acesso | Fl_Primeiro_Acesso = true | 200, requirePasswordChange |
| CT-027 | Senha legado | hash com prefixo LEGACY: | 200, compativel |
| CT-028 | Multiplos perfis | usuario com 2 perfis | 200, retorna todos |
| CT-029 | Sem perfil | usuario sem perfil | 401, "sem permissoes" |
| CT-030 | Perfil inativo | perfil desativado | 401, "perfil inativo" |
| CT-031 | Token anterior ativo | sessao existente | 200, nova sessao criada |
| CT-032 | Remember me | rememberMe: true | Refresh token 30 dias |
| CT-033 | Sem remember me | rememberMe: false | Refresh token 7 dias |
| CT-034 | IP diferente | mesmo usuario, IP novo | 200, email de alerta |
| CT-035 | UserAgent diferente | mesmo usuario, browser novo | 200, registrar dispositivo |
| CT-036 | Horario restrito | fora do horario permitido | 401, "fora do horario" |
| CT-037 | Dia restrito | fim de semana bloqueado | 401, "acesso restrito" |
| CT-038 | Localizacao restrita | IP de pais bloqueado | 401, "regiao bloqueada" |
| CT-039 | Sessoes simultaneas | atingiu limite | 200, encerra mais antiga |
| CT-040 | Token expirado | refresh token expirado | 401, fazer login novamente |

### Categoria 3: Bloqueio de Conta (20 cenarios)

| ID | Cenario | Condicao | Resultado Esperado |
|----|---------|----------|-------------------|
| CT-041 | 1a tentativa falha | primeira falha | 401, contador = 1 |
| CT-042 | 2a tentativa falha | segunda falha | 401, contador = 2 |
| CT-043 | 3a tentativa falha | terceira falha | 401, contador = 3 |
| CT-044 | 4a tentativa falha | quarta falha | 401, aviso "1 restante" |
| CT-045 | 5a tentativa falha | quinta falha | 401, conta bloqueada |
| CT-046 | Tentativa apos bloqueio | conta bloqueada | 401, minutos restantes |
| CT-047 | Desbloqueio automatico | apos 30 minutos | Conta desbloqueada |
| CT-048 | Login apos desbloqueio | credenciais corretas | 200, contador zerado |
| CT-049 | Reset por sucesso | login correto apos 3 falhas | 200, contador zerado |
| CT-050 | Tentativas em 15min | 5 falhas em 15min | 401, bloqueio |
| CT-051 | Tentativas esparsas | 5 falhas em 30min | Sem bloqueio (janela expirada) |
| CT-052 | IPs diferentes | 5 falhas de IPs diferentes | Bloqueio por email |
| CT-053 | Bloqueio + desbloqueio manual | admin desbloqueia | Conta ativa |
| CT-054 | Multiplos bloqueios | segundo bloqueio | 30 min novamente |
| CT-055 | Email de bloqueio | conta bloqueada | Email enviado ao usuario |
| CT-056 | Log de bloqueio | conta bloqueada | Auditoria registrada |
| CT-057 | Tentativa durante bloqueio | 6a tentativa | 401, nao incrementa |
| CT-058 | Contador persistente | restart do servidor | Contador mantido |
| CT-059 | Bloqueio por admin | admin bloqueia manualmente | Conta bloqueada |
| CT-060 | Tentativa em conta inexistente | 5 tentativas | Sem bloqueio (nao existe) |

### Categoria 4: Tokens e Sessao (20 cenarios)

| ID | Cenario | Verificacao | Resultado Esperado |
|----|---------|-------------|-------------------|
| CT-061 | Token JWT valido | assinatura RS256 | Verificavel |
| CT-062 | Claims corretos | userId, email, roles | Presentes no token |
| CT-063 | Expiracao 8h | claim exp | Correto |
| CT-064 | Refresh token unico | multiplos logins | Tokens diferentes |
| CT-065 | Sessao criada | tabela SessaoUsuario | Registro existe |
| CT-066 | IP registrado | sessao.IP | IP correto |
| CT-067 | UserAgent registrado | sessao.UserAgent | Browser/App correto |
| CT-068 | Sessao anterior invalidada | novo login | Sessao antiga inativa |
| CT-069 | Token nao reutilizavel | mesmo refresh duas vezes | Segunda falha |
| CT-070 | Token rotation | refresh bem sucedido | Novo refresh gerado |
| CT-071 | Issuer correto | claim iss | URL do sistema |
| CT-072 | Audience correto | claim aud | Client ID |
| CT-073 | JTI unico | claim jti | GUID unico |
| CT-074 | Not Before correto | claim nbf | Momento atual |
| CT-075 | Permissions no token | claim permissions | Array de permissoes |
| CT-076 | EmpresaId no token | claim empresaId | GUID da empresa |
| CT-077 | Nome no token | claim name | Nome do usuario |
| CT-078 | Token nao modificado | alterar payload | Assinatura invalida |
| CT-079 | Token de outro sistema | JWT de outro app | 401, issuer invalido |
| CT-080 | Refresh apos logout | token invalidado | 401 |

### Categoria 5: Seguranca e Performance (20 cenarios)

| ID | Cenario | Teste | Resultado Esperado |
|----|---------|-------|-------------------|
| CT-081 | SQL Injection | ' OR '1'='1 | Sem efeito |
| CT-082 | XSS | &lt;script&gt;alert&lt;/script&gt; | Escapado |
| CT-083 | CSRF | sem token CSRF | 403 ou ignorado |
| CT-084 | Rate limiting | 20 requests em 1min | 429 apos 10 |
| CT-085 | Brute force distribuido | 100 IPs, 5 tentativas cada | Detectado |
| CT-086 | Timing attack | medir tempo de resposta | Tempo constante |
| CT-087 | Response time P50 | carga normal | < 200ms |
| CT-088 | Response time P95 | carga alta | < 500ms |
| CT-089 | Response time P99 | pico | < 1000ms |
| CT-090 | Concurrent logins | 100 simultaneos | Todos processados |
| CT-091 | HTTPS obrigatorio | HTTP request | Redirect para HTTPS |
| CT-092 | Headers de seguranca | response headers | CSP, HSTS presentes |
| CT-093 | Sensitive data | response body | Sem senha, tokens parciais |
| CT-094 | Log sanitizado | logs do servidor | Sem senhas em texto |
| CT-095 | Memory leak | 1000 logins | Memoria estavel |
| CT-096 | Connection pool | muitas conexoes | Pool gerenciado |
| CT-097 | Database timeout | DB lento | Timeout graceful |
| CT-098 | Failover | servidor principal down | Replica assume |
| CT-099 | Metricas | Prometheus/Grafana | Coletadas |
| CT-100 | Alertas | erro 500 | Notificacao enviada |

---

## Criterios de Aceitacao

### Backend
- [ ] Endpoint POST /api/auth/login funcional
- [ ] Validacao de email e senha
- [ ] Geracao de JWT com claims corretos
- [ ] Geracao de refresh token
- [ ] Criacao de sessao no banco
- [ ] Incremento de tentativas falhas
- [ ] Bloqueio apos 5 tentativas
- [ ] Desbloqueio automatico apos 30 minutos
- [ ] Deteccao de primeiro acesso
- [ ] Auditoria de todas as tentativas
- [ ] Response time < 500ms

### Frontend
- [ ] Formulario responsivo
- [ ] Validacao em tempo real
- [ ] Mensagens de erro claras
- [ ] Loading state durante login
- [ ] Redirecionamento apos sucesso
- [ ] Armazenamento seguro de tokens
- [ ] Acessibilidade (WCAG 2.1 AA)
- [ ] i18n completo

---

## API Request/Response

### Request

```http
POST /api/auth/login HTTP/1.1
Host: api.icontrolit.com.br
Content-Type: application/json
Ocp-Apim-Subscription-Key: {subscription-key}

{
    "email": "usuario@empresa.com.br",
    "password": "Senh@123",
    "rememberMe": false
}
```

### Response - Sucesso

```http
HTTP/1.1 200 OK
Content-Type: application/json

{
    "accessToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "dGhpcyBpcyBhIHJlZnJlc2ggdG9rZW4...",
    "expiresIn": 28800,
    "tokenType": "Bearer",
    "user": {
        "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
        "nome": "Usuario Teste",
        "email": "usuario@empresa.com.br",
        "empresaId": "5e74ca92-08d5-40f5-a27b-98887f81aa2e",
        "empresaNome": "Empresa Teste",
        "roles": ["Administrador"],
        "permissions": [
            "users:user:read",
            "users:user:create",
            "documents:template:read"
        ]
    }
}
```

### Response - Erro

```http
HTTP/1.1 401 Unauthorized
Content-Type: application/json

{
    "error": "InvalidCredentials",
    "message": "E-mail ou senha incorretos",
    "timestamp": "2025-11-19T15:30:00Z",
    "requestId": "abc123"
}
```

---

**Ultima Atualizacao**: 2025-11-19
**Autor**: Claude Code (Architect Agent)

---

# UC01: Esqueci Minha Senha


---

## Sumario

| Aspecto | Detalhes |
|---------|----------|
| **Objetivo** | Solicitar recuperacao de senha via email |
| **Atores** | Usuario (com email cadastrado) |
| **Endpoint** | POST /api/auth/forgot-password |
| **Cenarios** | 40 cenarios de teste |

---

## Fluxo Principal

1. Usuario clica em "Esqueci minha senha" na tela de login
2. Sistema exibe formulario com campo email
3. Usuario preenche email
4. Sistema valida formato do email
5. Sistema envia POST /api/auth/forgot-password
6. Backend verifica se email existe
7. Se existe: gera token (24h), envia email com link
8. Se nao existe: nao faz nada (seguranca)
9. Sistema sempre retorna mensagem generica:
   "Se o e-mail estiver cadastrado, voce recebera as instrucoes"
10. Usuario recebe email com link para redefinir

---

## Fluxos Alternativos

### FA-01: Email Nao Cadastrado
- Sistema nao revela que email nao existe
- Retorna mesma mensagem de sucesso
- Auditoria registra tentativa

### FA-02: Email Ja Enviado Recentemente
- Se solicitou ha menos de 5 minutos: aguardar
- Evita spam de emails

### FA-03: Usuario Bloqueado
- Usuario bloqueado tambem recebe email
- Pode redefinir senha e desbloquear

---

## Fluxos de Excecao

| FE | Condicao | Resposta |
|----|----------|----------|
| FE-01 | Email vazio | 400, "E-mail e obrigatorio" |
| FE-02 | Email invalido | 400, "Formato invalido" |
| FE-03 | Rate limit | 429, "Muitas solicitacoes" |

---

## Regras de Negocio

- RN-AUTH-006: Token valido por 24 horas
- RN-AUTH-011: Mensagem generica (seguranca)
- RN-AUTH-010: Auditoria de todas solicitacoes

---

## Request/Response

**Request:**
```json
{
    "email": "usuario@empresa.com.br"
}
```

**Response:**
```json
{
    "success": true,
    "message": "Se o e-mail estiver cadastrado, voce recebera as instrucoes"
}
```

---

## Email Enviado

**Assunto**: Recuperacao de Senha - IControlIT

**Corpo**:
```
Ola {nome},

Recebemos uma solicitacao para redefinir sua senha.

Clique no link abaixo para criar uma nova senha:
{link}

Este link e valido por 24 horas.

Se voce nao solicitou esta alteracao, ignore este email.

Atenciosamente,
Equipe IControlIT
```

---

## i18n Keys

- auth.forgotPassword.title
- auth.forgotPassword.description
- auth.forgotPassword.email
- auth.forgotPassword.send
- auth.forgotPassword.success
- auth.forgotPassword.backToLogin

---

**Ultima Atualizacao**: 2025-11-19

---

# UC02: Redefinir Senha


---

## Sumario

| Aspecto | Detalhes |
|---------|----------|
| **Objetivo** | Definir nova senha usando token de recuperacao |
| **Atores** | Usuario (com token valido) |
| **Endpoint** | POST /api/auth/reset-password |
| **Cenarios** | 50 cenarios de teste |

---

## Fluxo Principal

1. Usuario clica no link do email
2. Sistema carrega pagina /reset-password?token=xxx
3. Frontend valida token com backend
4. Sistema exibe formulario:
   - Nova senha
   - Confirmar senha
   - Indicador de requisitos
5. Usuario preenche nova senha
6. Frontend valida requisitos em tempo real
7. Usuario clica em "Salvar Nova Senha"
8. Backend valida:
   - Token existe e nao expirou
   - Token nao foi utilizado
   - Senha atende requisitos
   - Senha diferente das ultimas 5
9. Backend atualiza senha (BCrypt)
10. Backend invalida token
11. Backend registra em HistoricoSenha
12. Sistema exibe sucesso e redireciona para login

---

## Validacoes de Senha

| Requisito | Validacao |
|-----------|-----------|
| Minimo 8 caracteres | length >= 8 |
| Letra maiuscula | /[A-Z]/ |
| Letra minuscula | /[a-z]/ |
| Numero | /[0-9]/ |
| Caractere especial | /[!@#$%^&*]/ |
| Nao igual as ultimas 5 | BCrypt.Verify |
| Confirmacao igual | password === confirm |

---

## Fluxos de Excecao

| FE | Condicao | Resposta |
|----|----------|----------|
| FE-01 | Token expirado | 400, "Link expirado" |
| FE-02 | Token ja usado | 400, "Link ja utilizado" |
| FE-03 | Token invalido | 400, "Link invalido" |
| FE-04 | Senha fraca | 400, "Requisitos nao atendidos" |
| FE-05 | Senhas diferentes | 400, "Senhas nao coincidem" |
| FE-06 | Senha reutilizada | 400, "Ja utilizada anteriormente" |

---

## Request/Response

**Request:**
```json
{
    "token": "abc123-def456-ghi789",
    "newPassword": "NovaSenha@123",
    "confirmPassword": "NovaSenha@123"
}
```

**Response Sucesso:**
```json
{
    "success": true,
    "message": "Senha alterada com sucesso!"
}
```

---

## i18n Keys

- auth.resetPassword.title
- auth.resetPassword.newPassword
- auth.resetPassword.confirmPassword
- auth.resetPassword.requirements
- auth.resetPassword.minLength
- auth.resetPassword.uppercase
- auth.resetPassword.lowercase
- auth.resetPassword.number
- auth.resetPassword.special
- auth.resetPassword.save
- auth.resetPassword.success
- auth.resetPassword.tokenExpired
- auth.resetPassword.passwordMismatch

---

**Ultima Atualizacao**: 2025-11-19

---

# UC03: Primeiro Acesso


---

## Sumario

| Aspecto | Detalhes |
|---------|----------|
| **Objetivo** | Troca obrigatoria de senha temporaria |
| **Atores** | Usuario (novo ou com senha resetada) |
| **Endpoint** | POST /api/auth/change-password |
| **Cenarios** | 30 cenarios de teste |

---

## Fluxo Principal

1. Usuario faz login com senha temporaria
2. Sistema detecta Fl_Primeiro_Acesso = true
3. Sistema retorna requirePasswordChange = true
4. Frontend redireciona para /change-password
5. Sistema exibe formulario:
   - Senha atual (temporaria)
   - Nova senha
   - Confirmar senha
6. Usuario preenche campos
7. Sistema valida:
   - Senha atual correta
   - Nova senha atende requisitos
   - Nova senha diferente da atual
8. Sistema atualiza senha
9. Sistema marca Fl_Primeiro_Acesso = false
10. Sistema redireciona para login
11. Usuario faz login com nova senha

---

## Regras de Negocio

- RN-AUTH-008: Primeiro acesso obriga troca
- RN-AUTH-004: Requisitos minimos de senha
- RN-AUTH-007: Nao reutilizar ultimas 5

---

## Fluxos de Excecao

| FE | Condicao | Resposta |
|----|----------|----------|
| FE-01 | Senha atual incorreta | 400, "Senha atual incorreta" |
| FE-02 | Nova igual a atual | 400, "Nova senha deve ser diferente" |
| FE-03 | Requisitos nao atendidos | 400, lista de requisitos faltantes |
| FE-04 | Token temporario expirado | 401, redireciona para login |

---

## Request/Response

**Request:**
```json
{
    "currentPassword": "Temp123!",
    "newPassword": "NovaSenha@123",
    "confirmPassword": "NovaSenha@123"
}
```

**Response:**
```json
{
    "success": true,
    "message": "Senha alterada com sucesso! Faca login novamente."
}
```

---

**Ultima Atualizacao**: 2025-11-19

---

# UC04: Logout


---

## Sumario

| Aspecto | Detalhes |
|---------|----------|
| **Objetivo** | Encerrar sessao do usuario |
| **Atores** | Usuario autenticado |
| **Endpoint** | POST /api/auth/logout |
| **Cenarios** | 20 cenarios de teste |

---

## Fluxo Principal

1. Usuario clica no menu de usuario
2. Usuario clica em "Sair"
3. Sistema exibe confirmacao (opcional)
4. Usuario confirma
5. Frontend envia POST /api/auth/logout
6. Backend invalida sessao atual
7. Backend marca sessao como encerrada
8. Backend registra auditoria AUTH_LOGOUT
9. Frontend limpa tokens do storage
10. Frontend redireciona para /sign-in
11. Sistema exibe tela de login

---

## Fluxos Alternativos

### FA-01: Logout de Todas Sessoes
- Endpoint: POST /api/auth/logout-all
- Invalida todas as sessoes do usuario
- Util quando suspeita de comprometimento

### FA-02: Logout por Timeout
- Sistema detecta inatividade de 30 min
- Exibe modal de aviso
- Faz logout automatico

---

## Request/Response

**Request:**
```http
POST /api/auth/logout
Authorization: Bearer {accessToken}
```

**Response:**
```json
{
    "success": true,
    "message": "Sessao encerrada com sucesso"
}
```

---

## Auditoria

| Operacao | Dados |
|----------|-------|
| AUTH_LOGOUT | usuarioId, ip, duracaoSessao, motivo |

---

## i18n Keys

- auth.logout.title
- auth.logout.message
- auth.logout.confirm
- auth.logout.cancel

---

**Ultima Atualizacao**: 2025-11-19

---

# UC05: Renovar Sessao


---

## Sumario

| Aspecto | Detalhes |
|---------|----------|
| **Objetivo** | Renovar token JWT automaticamente |
| **Atores** | Sistema (automatico) |
| **Endpoint** | POST /api/auth/refresh |
| **Cenarios** | 25 cenarios de teste |

---

## Fluxo Principal

1. Frontend detecta token proximo de expirar (5 min)
2. Frontend verifica atividade recente
3. Se ativo: envia POST /api/auth/refresh
4. Backend valida refresh token
5. Backend gera novo access token
6. Backend gera novo refresh token (rotation)
7. Backend atualiza sessao
8. Frontend atualiza tokens armazenados
9. Usuario continua trabalhando sem interrupcao

---

## Fluxos Alternativos

### FA-01: Usuario Inativo
- Sem atividade por 30 min
- Nao renova token
- Faz logout por timeout

### FA-02: Refresh Token Expirado
- Token de 7 dias expirou
- Usuario deve fazer login novamente

---

## Fluxos de Excecao

| FE | Condicao | Resposta |
|----|----------|----------|
| FE-01 | Refresh token invalido | 401, fazer login |
| FE-02 | Refresh token ja usado | 401, possivel ataque |
| FE-03 | Sessao invalidada | 401, fazer login |
| FE-04 | Usuario bloqueado | 401, conta bloqueada |

---

## Request/Response

**Request:**
```json
{
    "refreshToken": "dGhpcyBpcyBhIHJlZnJlc2g..."
}
```

**Response:**
```json
{
    "accessToken": "eyJhbGciOiJSUzI1NiIs...",
    "refreshToken": "bmV3IHJlZnJlc2ggdG9rZW4...",
    "expiresIn": 28800
}
```

---

## Seguranca

- Token rotation: refresh token invalidado apos uso
- Deteccao de roubo: se token ja usado, invalida todas sessoes
- Binding: refresh token vinculado ao dispositivo

---

**Ultima Atualizacao**: 2025-11-19

---

# UC06: Bloqueio por Tentativas


---

## Sumario

| Aspecto | Detalhes |
|---------|----------|
| **Objetivo** | Proteger conta contra ataques brute force |
| **Atores** | Sistema (automatico), Admin (desbloqueio manual) |
| **Cenarios** | 35 cenarios de teste |

---

## Mecanismo de Bloqueio

### Contador de Tentativas

```
Tentativa 1: contador = 1
Tentativa 2: contador = 2
Tentativa 3: contador = 3
Tentativa 4: contador = 4, aviso "1 tentativa restante"
Tentativa 5: contador = 5, BLOQUEIO
```

### Janela de Tempo

- Tentativas contadas em janela de 15 minutos
- Apos 15 min sem tentativa, contador reseta
- Bloqueio dura 30 minutos

---

## Fluxo de Bloqueio

1. Usuario erra senha pela 5a vez
2. Sistema bloqueia conta
3. Sistema registra auditoria AUTH_ACCOUNT_LOCKED
4. Sistema envia email de notificacao
5. Sistema retorna erro com tempo restante
6. Usuario deve aguardar ou contatar admin

---

## Fluxo de Desbloqueio Automatico

1. 30 minutos se passam
2. Usuario tenta login
3. Sistema verifica tempo decorrido
4. Sistema desbloqueia automaticamente
5. Sistema zera contador
6. Login procede normalmente

---

## Fluxo de Desbloqueio Manual

1. Usuario contata administrador
2. Admin acessa /management/users
3. Admin localiza usuario bloqueado
4. Admin clica em "Desbloquear"
5. Sistema valida permissao auth:user:unlock
6. Sistema desbloqueia conta
7. Sistema registra auditoria AUTH_ACCOUNT_UNLOCKED
8. Sistema notifica usuario por email

---

## API de Desbloqueio

**Endpoint:** POST /api/auth/users/{id}/unlock

**Request:**
```http
POST /api/auth/users/3fa85f64.../unlock
Authorization: Bearer {adminToken}
```

**Response:**
```json
{
    "success": true,
    "message": "Usuario desbloqueado com sucesso"
}
```

---

## Auditoria

| Operacao | Dados |
|----------|-------|
| AUTH_ACCOUNT_LOCKED | email, ip, tentativas, timestamp |
| AUTH_ACCOUNT_UNLOCKED | email, adminId, motivo |

---

## Email de Notificacao

**Para Usuario (bloqueio):**
```
Sua conta foi bloqueada

Detectamos varias tentativas de acesso malsucedidas:
- Data/Hora: 19/11/2025 15:30
- IP: 189.100.50.25
- Tentativas: 5

Sua conta sera desbloqueada automaticamente em 30 minutos.

Se nao foi voce, recomendamos alterar sua senha.
```

---

## Regras de Negocio

- RN-AUTH-003: 5 tentativas em 15 min = bloqueio
- RN-AUTH-010: Auditoria completa
- Permissao: auth:user:unlock para desbloqueio manual

---

**Ultima Atualizacao**: 2025-11-19

---

## Histórico de Alterações

| Versão | Data | Autor | Descrição |
|--------|------|-------|-----------|
| 1.0 | 2025-12-17 | Sistema | Consolidação de 7 casos de uso |
