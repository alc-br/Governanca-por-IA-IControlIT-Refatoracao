# =============================================
# RF - Requisito Funcional (Contrato Canônico)
# Versão: 1.0
# Autor: Agência ALC - alc.dev.br
# =============================================

rf:
  id: "RF002"
  nome: "Sistema de Configurações e Parametrização Avançada"
  versao: "2.0"
  data: "2025-12-29"
  fase: "Fase 1 - Fundação e Cadastros Base"
  epic: "EPIC001-SYS"
  status: "aprovado"

descricao:
  objetivo: "Estabelecer um sistema centralizado de configurações infraestruturais e de integração que permita ao IControlIT gerenciar dinamicamente (sem restart) todas as configurações críticas do sistema."
  problema_resolvido: "Eliminar a necessidade de restart da aplicação para aplicar mudanças de configuração, reduzir riscos de vazamento de credenciais em arquivos plaintext (web.config), e permitir rollback 1-click em caso de erros."
  publico_afetado: "Desenvolvedores, DevOps, Administradores de Sistema, Gerentes de Operações, Auditores, Usuários finais impactados por feature flags."

escopo:
  incluso:
    - "CRUD completo de configurações (criar, atualizar, listar, visualizar, excluir)"
    - "Hierarquia multi-tenant (Global → Conglomerado → Empresa → Departamento → Usuário)"
    - "Suporte a 7 tipos de dados (String, Integer, Decimal, Boolean, JSON, Enum, DateTime)"
    - "Validação de tipo e validação customizada (regex, ranges, valores permitidos)"
    - "Criptografia automática com Azure Key Vault (AES-256-GCM)"
    - "Cache distribuído Redis com hot-reload (pub/sub para invalidação)"
    - "Versionamento completo com histórico imutável e diff visual"
    - "Rollback 1-click para qualquer versão anterior"
    - "Feature flags com 4 estratégias de rollout (Percentual, Usuário, Perfil, Empresa)"
    - "Export/Import de configurações (JSON/YAML) para migração entre ambientes"
    - "Auditoria SOX completa (quem, quando, IP, motivo, ticket de mudança)"
    - "Notificações automáticas (Slack/Teams) para mudanças críticas"
    - "API REST securizada para consulta e alteração"
    - "Dry-run (simulação de impacto antes de aplicar mudança)"
    - "Configurações somente leitura (proteção de configurações críticas)"
    - "Valores padrão inteligentes (sistema funciona 'out of the box')"
    - "Documentação inline (tooltips e descrição detalhada)"
    - "Agrupamento visual por categoria (10 categorias)"
    - "Expiração automática de feature flags (job desabilita flags vencidas)"
    - "Controle de acesso RBAC granular (8 permissões diferentes)"
  fora:
    - "Gerenciamento de parâmetros de negócio (RF-001)"
    - "Gestão de senhas de usuários (RF-006)"
    - "Deploy de infrastructure as code (fora do escopo funcional)"
    - "Controle de versão de código-fonte (Git, Azure DevOps)"

entidades:
  - nome: "SistemaConfiguracaoGeral"
    descricao: "Entidade central que armazena todas as configurações do sistema com suporte a hierarquia multi-tenant, tipos de dados variados, criptografia, cache, versionamento e feature flags."
    multi_tenant: true
    soft_delete: true
    auditoria: true

regras_negocio:
  - id: "RN-RF002-01"
    descricao: "Configurações seguem hierarquia de precedência: Usuário → Departamento → Empresa → Conglomerado → Global."
    tipo: "regra_negocio"
    campos_afetados: ["Id_Usuario", "Id_Departamento", "Id_Empresa", "Id_Conglomerado"]
    obrigatorio: true

  - id: "RN-RF002-02"
    descricao: "Valores marcados como sensíveis (Fl_Criptografado = 1) são automaticamente criptografados com AES-256-GCM usando Azure Key Vault antes de persistir."
    tipo: "seguranca"
    campos_afetados: ["Ds_Valor", "Fl_Criptografado"]
    obrigatorio: true

  - id: "RN-RF002-03"
    descricao: "Ao alterar configuração, sistema valida tipo de dado antes de persistir. Tipos suportados: String, Integer, Decimal, Boolean, JSON, Enum, DateTime."
    tipo: "validacao"
    campos_afetados: ["Tp_Dado", "Ds_Valor"]
    obrigatorio: true

  - id: "RN-RF002-04"
    descricao: "Sistema suporta validações customizadas: regex (emails, URLs), ranges (min/max para números), valores permitidos (enum), datas futuras/passadas."
    tipo: "validacao"
    campos_afetados: ["Ds_ValidacaoCustomizada"]
    obrigatorio: false

  - id: "RN-RF002-05"
    descricao: "Ao criar ou atualizar configuração, sistema automaticamente invalida cache Redis via pub/sub (zero downtime)."
    tipo: "regra_negocio"
    campos_afetados: []
    obrigatorio: true

  - id: "RN-RF002-06"
    descricao: "Toda alteração de configuração gera versionamento automático com diff JSON completo (valor anterior vs novo), preservando histórico imutável."
    tipo: "regra_negocio"
    campos_afetados: []
    obrigatorio: true

  - id: "RN-RF002-07"
    descricao: "Rollback executa restauração completa do valor anterior em 1-click, gerando nova versão no histórico (não altera versões antigas)."
    tipo: "regra_negocio"
    campos_afetados: []
    obrigatorio: true

  - id: "RN-RF002-08"
    descricao: "Feature flags suportam 4 estratégias de rollout progressivo: Percentual (ex: 10% dos usuários), Usuário (lista de IDs), Perfil (ex: apenas Desenvolvedores), Empresa (lista de empresas)."
    tipo: "regra_negocio"
    campos_afetados: ["Fl_FeatureFlag", "Nm_EstrategiaRollout", "Ds_ConfiguracaoEstrategia"]
    obrigatorio: false

  - id: "RN-RF002-09"
    descricao: "Configurações sensíveis (Fl_Criptografado = 1) aparecem como ******** para todos os perfis exceto Super Admin com permissão SYS.CONFIGURACOES.DECRYPT."
    tipo: "seguranca"
    campos_afetados: ["Fl_Criptografado"]
    obrigatorio: true

  - id: "RN-RF002-10"
    descricao: "Export/Import de configurações valida schema YAML antes de importar, executa dry-run obrigatório, e registra auditoria completa de migração."
    tipo: "validacao"
    campos_afetados: []
    obrigatorio: true

  - id: "RN-RF002-11"
    descricao: "Auditoria SOX completa registra: quem alterou, quando, IP, user-agent, motivo da mudança, ticket de mudança (obrigatório para PRD), diff JSON."
    tipo: "seguranca"
    campos_afetados: []
    obrigatorio: true

  - id: "RN-RF002-12"
    descricao: "Notificações automáticas enviadas via Slack/Teams quando configuração crítica (Fl_Critica = 1) é alterada, incluindo diff, autor e motivo."
    tipo: "regra_negocio"
    campos_afetados: ["Fl_Critica"]
    obrigatorio: false

  - id: "RN-RF002-13"
    descricao: "Configurações marcadas como somente leitura (Fl_SomenteLeitura = 1) bloqueiam edição e exclusão, retornando HTTP 403 Forbidden."
    tipo: "seguranca"
    campos_afetados: ["Fl_SomenteLeitura"]
    obrigatorio: true

  - id: "RN-RF002-14"
    descricao: "Dry-run simula impacto da mudança sem persistir, retornando: quantos usuários/empresas serão afetados, quais serviços precisam invalidar cache, e riscos conhecidos."
    tipo: "regra_negocio"
    campos_afetados: []
    obrigatorio: true

  - id: "RN-RF002-15"
    descricao: "Feature flags com data de expiração (Dt_Expiracao) são automaticamente desabilitadas por job diário, gerando notificação para desenvolvedores responsáveis."
    tipo: "regra_negocio"
    campos_afetados: ["Dt_Expiracao"]
    obrigatorio: false

  - id: "RF002-FUNC-001"
    descricao: "Criar configuração"
    tipo: "funcionalidade"
    obrigatorio: true

  - id: "RF002-FUNC-002"
    descricao: "Listar configurações"
    tipo: "funcionalidade"
    obrigatorio: true

  - id: "RF002-FUNC-003"
    descricao: "Visualizar configuração"
    tipo: "funcionalidade"
    obrigatorio: true

  - id: "RF002-FUNC-004"
    descricao: "Atualizar configuração"
    tipo: "funcionalidade"
    obrigatorio: true

  - id: "RF002-FUNC-005"
    descricao: "Excluir configuração (soft delete)"
    tipo: "funcionalidade"
    obrigatorio: true

  - id: "RF002-FUNC-006"
    descricao: "Validar tipo de dado antes de persistir"
    tipo: "validacao"
    obrigatorio: true

  - id: "RF002-FUNC-007"
    descricao: "Validar unicidade de chave por tenant"
    tipo: "validacao"
    obrigatorio: true

  - id: "RF002-FUNC-008"
    descricao: "Validar regex/ranges/valores permitidos"
    tipo: "validacao"
    obrigatorio: false

  - id: "RF002-FUNC-009"
    descricao: "Validar schema YAML em import"
    tipo: "validacao"
    obrigatorio: true

  - id: "RF002-FUNC-010"
    descricao: "Isolamento de tenant (multi-tenancy)"
    tipo: "seguranca"
    obrigatorio: true

  - id: "RF002-FUNC-011"
    descricao: "Permissões RBAC granulares"
    tipo: "seguranca"
    obrigatorio: true

  - id: "RF002-FUNC-012"
    descricao: "Criptografia AES-256-GCM via Azure Key Vault"
    tipo: "seguranca"
    obrigatorio: true

  - id: "RF002-FUNC-013"
    descricao: "Auditoria SOX completa"
    tipo: "seguranca"
    obrigatorio: true

  - id: "RF002-FUNC-014"
    descricao: "Proteção de configurações somente leitura"
    tipo: "seguranca"
    obrigatorio: true

  - id: "RF002-FUNC-015"
    descricao: "Versionamento automático com diff JSON"
    tipo: "funcionalidade"
    obrigatorio: true

  - id: "RF002-FUNC-016"
    descricao: "Rollback 1-click para qualquer versão"
    tipo: "funcionalidade"
    obrigatorio: true

  - id: "RF002-FUNC-017"
    descricao: "Cache hot-reload (pub/sub Redis)"
    tipo: "funcionalidade"
    obrigatorio: true

  - id: "RF002-FUNC-018"
    descricao: "Feature flags com 4 estratégias de rollout"
    tipo: "funcionalidade"
    obrigatorio: false

  - id: "RF002-FUNC-019"
    descricao: "Export/Import YAML/JSON entre ambientes"
    tipo: "funcionalidade"
    obrigatorio: true

  - id: "RF002-FUNC-020"
    descricao: "Dry-run de impacto antes de aplicar mudança"
    tipo: "funcionalidade"
    obrigatorio: true

  - id: "RF002-FUNC-021"
    descricao: "Notificações automáticas Slack/Teams"
    tipo: "funcionalidade"
    obrigatorio: false

  - id: "RF002-FUNC-022"
    descricao: "Expiração automática de feature flags"
    tipo: "funcionalidade"
    obrigatorio: false

  - id: "RF002-FUNC-023"
    descricao: "Hierarquia multi-tenant com precedência"
    tipo: "funcionalidade"
    obrigatorio: true

  - id: "RF002-FUNC-024"
    descricao: "Documentação inline e tooltips"
    tipo: "funcionalidade"
    obrigatorio: true

estados:
  - id: "draft"
    descricao: "Configuração criada mas não ativada (apenas Dev/HOM)"
  - id: "active"
    descricao: "Configuração ativa e em uso pelo sistema"
  - id: "inactive"
    descricao: "Configuração desativada temporariamente"
  - id: "archived"
    descricao: "Configuração arquivada (histórico apenas)"
  - id: "rollback_pending"
    descricao: "Rollback solicitado aguardando aprovação"

transicoes:
  permitidas:
    - de: "draft"
      para: "active"
    - de: "active"
      para: "inactive"
    - de: "inactive"
      para: "active"
    - de: "active"
      para: "archived"
    - de: "inactive"
      para: "archived"
  proibidas:
    - de: "archived"
      para: "active"
    - de: "archived"
      para: "inactive"

permissoes:
  - codigo: "SYS.CONFIGURACOES.READ"
    descricao: "Visualizar configurações do sistema"
  - codigo: "SYS.CONFIGURACOES.CREATE"
    descricao: "Criar novas configurações"
  - codigo: "SYS.CONFIGURACOES.UPDATE"
    descricao: "Atualizar configurações existentes"
  - codigo: "SYS.CONFIGURACOES.DELETE"
    descricao: "Excluir configurações (soft delete)"
  - codigo: "SYS.CONFIGURACOES.EXPORT"
    descricao: "Exportar configurações para YAML/JSON"
  - codigo: "SYS.CONFIGURACOES.IMPORT"
    descricao: "Importar configurações de YAML/JSON"
  - codigo: "SYS.CONFIGURACOES.ROLLBACK"
    descricao: "Executar rollback de configurações"
  - codigo: "SYS.CONFIGURACOES.DECRYPT"
    descricao: "Descriptografar valores sensíveis (Super Admin apenas)"

integracoes:
  internas:
    - "Autenticacao (JWT Bearer Token)"
    - "Multi-Tenancy (Isolamento por Id_Conglomerado/Id_Empresa)"
    - "Auditoria (Registro completo de mudanças)"
    - "Cache Redis (Pub/Sub para invalidação)"
    - "Sistema de Notificações (Eventos de domínio)"
    - "Sistema de Permissões (RBAC)"
  externas:
    - sistema: "Azure Key Vault"
      tipo: "API REST"
      obrigatoria: true
      descricao: "Criptografia AES-256-GCM de valores sensíveis"
    - sistema: "Slack/Microsoft Teams"
      tipo: "Webhook"
      obrigatoria: false
      descricao: "Notificações de mudanças críticas"
    - sistema: "Redis Cloud"
      tipo: "Cache Distribuído"
      obrigatoria: true
      descricao: "Cache hot-reload com pub/sub"

seguranca:
  isolamento_tenant: true
  auditoria_obrigatoria: true
  soft_delete: true
  criptografia_em_repouso: true
  criptografia_em_transito: true
  validacao_entrada: true
  protecao_injection: true

rastreabilidade:
  ucs_esperados:
    - "UC00"
    - "UC01"
    - "UC02"
    - "UC03"
    - "UC04"

catalog:
  functional_items:
    - id: "RF002-FUNC-001"
      title: "Criar configuração"
      description: "Permitir criação de nova configuração com validação de tipo, criptografia automática e auditoria"
      required: true
    - id: "RF002-FUNC-002"
      title: "Listar configurações"
      description: "Exibir configurações com hierarquia multi-tenant, paginação e mascaramento de valores sensíveis"
      required: true
    - id: "RF002-FUNC-003"
      title: "Visualizar configuração"
      description: "Exibir detalhes de configuração com histórico de versões e valores mascarados"
      required: true
    - id: "RF002-FUNC-004"
      title: "Atualizar configuração"
      description: "Permitir alteração com versionamento automático, dry-run e notificações para configurações críticas"
      required: true
    - id: "RF002-FUNC-005"
      title: "Excluir configuração (soft delete)"
      description: "Executar exclusão lógica com invalidação de cache e auditoria"
      required: true
    - id: "RF002-FUNC-006"
      title: "Validar tipo de dado antes de persistir"
      description: "Garantir que valor informado é compatível com tipo selecionado (String, Integer, Decimal, Boolean, JSON, Enum, DateTime)"
      required: true
    - id: "RF002-FUNC-007"
      title: "Validar unicidade de chave por tenant"
      description: "Impedir configurações duplicadas para mesmo tenant (Id_Conglomerado + Nm_Codigo único)"
      required: true
    - id: "RF002-FUNC-008"
      title: "Validar regex/ranges/valores permitidos"
      description: "Aplicar validações customizadas (regex para emails/URLs, ranges min/max, enums)"
      required: false
    - id: "RF002-FUNC-009"
      title: "Validar schema YAML em import"
      description: "Garantir que arquivo de importação está em formato válido antes de aplicar"
      required: true
    - id: "RF002-FUNC-010"
      title: "Isolamento de tenant (multi-tenancy)"
      description: "Garantir que usuário só acessa configurações do próprio tenant (Id_Conglomerado/Id_Empresa)"
      required: true
    - id: "RF002-FUNC-011"
      title: "Permissões RBAC granulares"
      description: "Controlar acesso via 8 permissões (READ, CREATE, UPDATE, DELETE, EXPORT, IMPORT, ROLLBACK, DECRYPT)"
      required: true
    - id: "RF002-FUNC-012"
      title: "Criptografia AES-256-GCM via Azure Key Vault"
      description: "Criptografar automaticamente valores sensíveis (Fl_Criptografado = 1) antes de persistir"
      required: true
    - id: "RF002-FUNC-013"
      title: "Auditoria SOX completa"
      description: "Registrar quem, quando, IP, motivo, diff JSON e ticket de mudança para todas operações"
      required: true
    - id: "RF002-FUNC-014"
      title: "Proteção de configurações somente leitura"
      description: "Bloquear edição/exclusão de configurações críticas marcadas como Fl_SomenteLeitura = 1"
      required: true
    - id: "RF002-FUNC-015"
      title: "Versionamento automático com diff JSON"
      description: "Criar nova versão no histórico a cada alteração com comparação antes/depois"
      required: true
    - id: "RF002-FUNC-016"
      title: "Rollback 1-click para qualquer versão"
      description: "Restaurar configuração para versão anterior sem alterar histórico (cria nova versão)"
      required: true
    - id: "RF002-FUNC-017"
      title: "Cache hot-reload (pub/sub Redis)"
      description: "Invalidar cache automaticamente via pub/sub após alterações (zero downtime)"
      required: true
    - id: "RF002-FUNC-018"
      title: "Feature flags com 4 estratégias de rollout"
      description: "Habilitar feature flags com rollout progressivo (Percentual, Usuário, Perfil, Empresa)"
      required: false
    - id: "RF002-FUNC-019"
      title: "Export/Import YAML/JSON entre ambientes"
      description: "Exportar/importar configurações para migração DEV → HOM → PRD"
      required: true
    - id: "RF002-FUNC-020"
      title: "Dry-run de impacto antes de aplicar mudança"
      description: "Simular alteração sem persistir para avaliar impacto (usuários afetados, serviços, riscos)"
      required: true
    - id: "RF002-FUNC-021"
      title: "Notificações automáticas Slack/Teams"
      description: "Enviar alerta quando configuração crítica (Fl_Critica = 1) é alterada"
      required: false
    - id: "RF002-FUNC-022"
      title: "Expiração automática de feature flags"
      description: "Desabilitar automaticamente flags após data de expiração (job diário)"
      required: false
    - id: "RF002-FUNC-023"
      title: "Hierarquia multi-tenant com precedência"
      description: "Aplicar precedência: Usuário → Departamento → Empresa → Conglomerado → Global"
      required: true
    - id: "RF002-FUNC-024"
      title: "Documentação inline e tooltips"
      description: "Exibir tooltips e descrições detalhadas para cada configuração"
      required: true

exclusions:
  rf_items: []

historico:
  - versao: "2.0"
    data: "2025-12-29"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Migração para template v2.0 - Estruturação completa em YAML com 15 regras de negócio, 8 permissões RBAC, 5 estados, catalog completo de funcionalidades, integrações internas e externas detalhadas"
  - versao: "1.0"
    data: "2025-11-04"
    autor: "Equipe Projeto"
    descricao: "Versão inicial (DESCONTINUADA)"
