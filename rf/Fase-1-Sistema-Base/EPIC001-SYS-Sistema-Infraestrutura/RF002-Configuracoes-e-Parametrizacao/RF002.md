# RF-002: Sistema de Configurações e Parametrização Avançada

**Versão**: 2.0
**Data**: 2025-12-29
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC001-SYS - Sistema e Infraestrutura
**Fase**: Fase 1 - Fundação e Cadastros Base

---

## 1. OBJETIVO DO REQUISITO

Estabelecer um **sistema centralizado de configurações infraestruturais e de integração** que permita ao IControlIT gerenciar dinamicamente (sem restart) todas as configurações críticas do sistema, incluindo:

- Configurações de SMTP e e-mail
- Credenciais de serviços externos (Azure, AWS, ERPs)
- Parâmetros de cache e performance
- Políticas de segurança e compliance
- Feature flags com rollout progressivo
- Integrações com APIs externas

Este RF **define o contrato funcional** entre configurações armazenadas e comportamento do sistema, servindo como **fonte única de verdade** para:
- Desenvolvimento (backend/frontend)
- Testes (validação de contratos)
- Operações (gestão de ambientes DEV/HOM/PRD)
- Auditoria (rastreabilidade SOX completa)

**Diferença crítica do RF-001**:
- RF-001 (Parâmetros): Foco em regras de negócio e limites operacionais
- RF-002 (Configurações): Foco em infraestrutura e integrações de sistema

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [X] CRUD completo de configurações (criar, atualizar, listar, visualizar, excluir)
- [X] Hierarquia multi-tenant (Global → Conglomerado → Empresa → Departamento → Usuário)
- [X] Suporte a 7 tipos de dados (String, Integer, Decimal, Boolean, JSON, Enum, DateTime)
- [X] Validação de tipo antes de persistir
- [X] Validação customizada (regex, ranges min/max, valores permitidos)
- [X] Criptografia automática com Azure Key Vault (AES-256-GCM)
- [X] Cache distribuído Redis com hot-reload (pub/sub para invalidação)
- [X] Versionamento completo com histórico imutável e diff visual
- [X] Rollback 1-click para qualquer versão anterior
- [X] Feature flags com 4 estratégias de rollout (Percentual, Usuário, Perfil, Empresa)
- [X] Export/Import de configurações (JSON/YAML) para migração entre ambientes
- [X] Auditoria SOX completa (quem, quando, IP, motivo, ticket de mudança)
- [X] Notificações automáticas (Slack/Teams) para mudanças críticas
- [X] API REST securizada para consulta e alteração
- [X] Dry-run (simulação de impacto antes de aplicar mudança)
- [X] Configurações somente leitura (proteção de configurações críticas)
- [X] Valores padrão inteligentes (sistema funciona "out of the box")
- [X] Documentação inline (tooltips e descrição detalhada)
- [X] Agrupamento visual por categoria (10 categorias: Sistema, Email, Integração, Segurança, Notificação, Cache, Storage, Auditoria, Performance, Features)
- [X] Expiração automática de feature flags (job desabilita flags vencidas)
- [X] Controle de acesso RBAC granular (8 permissões diferentes)

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (wireframes, mockups, UX)
- Tecnologia, framework ou linguagem de implementação
- Estratégia de deploy ou infraestrutura (Kubernetes, Docker, etc)
- Gerenciamento de parâmetros operacionais (RF-001)
- Configuração de infraestrutura de rede (firewalls, load balancers)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Configuração** | Par chave-valor que define comportamento infraestrutural do sistema |
| **Configuração Global** | Aplica-se a TODOS os tenants (ex: Redis host, JWT secret) |
| **Configuração Multi-Tenant** | Específica por conglomerado (ex: SMTP por cliente) |
| **Valor Sensível** | Dado que deve ser criptografado (senhas, API keys, secrets, tokens) |
| **Configuração Somente Leitura** | Protegida contra edição via interface (apenas via migração ou script DevOps) |
| **Feature Flag** | Controle de ativação/desativação de funcionalidades em produção |
| **Rollout Progressivo** | Ativação gradual de feature (0% → 25% → 50% → 100%) |
| **Categoria** | Agrupamento lógico de configurações (10 categorias definidas) |
| **Grupo Visual** | Subagrupamento dentro de categoria para organização hierárquica na UI |
| **Dry-Run** | Simulação de mudança para avaliar impacto antes de aplicar |
| **Versionamento** | Histórico imutável de todas as alterações com diff JSON |
| **Rollback** | Reversão para versão anterior de configuração |
| **Cache Hot-Reload** | Invalidação automática de cache sem restart do sistema |
| **Ticket de Mudança** | Identificador de change request (ex: CHG-2025-001234) obrigatório para configs críticas |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Criar configuração**: Adicionar nova configuração ao sistema com validação de tipo, regex, range e criptografia automática se sensível
2. **Atualizar configuração**: Modificar valor existente com versionamento automático, diff JSON e notificação de mudança crítica
3. **Consultar configuração por código**: Buscar configuração específica com descriptografia automática (se autorizado)
4. **Listar configurações**: Visualizar todas as configurações filtradas por categoria, grupo visual e multi-tenant
5. **Excluir configuração**: Soft delete com registro de auditoria e motivo
6. **Visualizar histórico de configuração**: Ver todas as versões anteriores com diff visual e possibilidade de rollback
7. **Reverter configuração (rollback)**: Restaurar versão anterior com criação de nova versão (não deleta histórico)
8. **Exportar configurações**: Gerar JSON/YAML para migração entre ambientes (DEV→HOM→PRD) com opção de incluir/excluir sensíveis
9. **Importar configurações**: Aplicar JSON/YAML com estratégias de conflito (Overwrite, Ignore, Merge)
10. **Invalidar cache**: Forçar recarregamento de configuração em todos os nós (Redis pub/sub)
11. **Criar feature flag**: Adicionar controle de ativação de funcionalidade com estratégia de rollout
12. **Configurar rollout progressivo**: Definir percentual de ativação ou targeting (usuários, perfis, empresas)
13. **Alternar feature flag**: Ligar/desligar feature com registro de auditoria
14. **Simular impacto (dry-run)**: Validar mudança sem aplicar para avaliar riscos
15. **Notificar mudança crítica**: Enviar alerta automático para Slack/Teams quando configuração crítica muda

---

## 5. REGRAS DE NEGÓCIO

### RN-RF002-01 — Hierarquia Multi-Tenant

**Descrição**: Configurações seguem hierarquia de precedência: Usuário → Departamento → Empresa → Conglomerado → Global.

**Justificativa**: Permite personalização granular mantendo valores padrão sensatos em cada nível.

**Critério de Aceite**:
- Se configuração existe em nível mais específico (ex: Usuário), prevalece sobre níveis mais genéricos
- Se não existe em nível específico, sistema busca no próximo nível acima até Global
- Tentativa de acessar configuração de outro tenant → retorna HTTP 403 Forbidden

---

### RN-RF002-02 — Criptografia Automática com Azure Key Vault

**Descrição**: Valores marcados como sensíveis (`Fl_Criptografado = 1`) são automaticamente criptografados com AES-256-GCM usando Azure Key Vault antes de persistir.

**Justificativa**: Compliance com LGPD, PCI-DSS, SOX e prevenção de vazamento de credenciais.

**Critério de Aceite**:
- Valor sensível nunca é armazenado em texto claro no banco
- Descriptografia ocorre apenas em runtime para Super Admin com permissão `SYS.CONFIGURACOES.DECRYPT`
- Todos os demais usuários veem `********` (mascarado)
- Auditoria registra quando valor sensível é descriptografado (quem, quando, IP)

---

### RN-RF002-03 — Validação Antes de Salvar

**Descrição**: Sistema valida tipo de dado, regex, ranges (min/max) e valores permitidos (enum) antes de persistir qualquer configuração.

**Justificativa**: Prevenir configurações inválidas que quebrariam funcionalidades do sistema.

**Critério de Aceite**:
- Valor incompatível com tipo → retorna HTTP 400 com mensagem clara
- Valor não passa validação regex → retorna HTTP 400
- Valor fora do range min/max → retorna HTTP 400
- Valor não está em lista de valores permitidos → retorna HTTP 400
- Validação ocorre ANTES de salvar (fail-fast)

---

### RN-RF002-04 — Cache Redis Hot-Reload com Pub/Sub

**Descrição**: Configurações são cacheadas no Redis com TTL configurável. Ao alterar configuração, sistema invalida cache em TODOS os nós via Redis Pub/Sub, forçando recarregamento sem restart.

**Justificativa**: Performance (consulta cache em vez de banco) e zero downtime (mudanças aplicadas instantaneamente).

**Critério de Aceite**:
- Primeira leitura de configuração consulta banco e popula cache
- Leituras subsequentes consultam cache (TTL padrão: 1 hora)
- Ao atualizar configuração, sistema publica mensagem de invalidação no canal Redis
- Todos os nós subscrevem no canal e invalidam cache local
- Próxima leitura recarrega do banco (cache miss)
- Se Redis estiver indisponível, sistema continua funcionando consultando banco diretamente

---

### RN-RF002-05 — Versionamento e Auditoria SOX Completa

**Descrição**: Cada alteração de configuração cria nova versão no histórico imutável, registrando diff JSON completo, usuário, data/hora, IP, user-agent, motivo e ticket de mudança.

**Justificativa**: Compliance SOX, rastreabilidade completa e possibilidade de rollback.

**Critério de Aceite**:
- Histórico nunca é deletado (imutável)
- Cada versão contém diff JSON estruturado (valor anterior vs novo)
- Motivo da alteração é obrigatório para configurações críticas
- Ticket de mudança (CHG-YYYY-NNNNNN) é obrigatório para configurações de segurança ou integração
- Auditoria retém dados por 7 anos (conformidade SOX)

---

### RN-RF002-06 — Rollback 1-Click

**Descrição**: Sistema permite reverter configuração para qualquer versão anterior com 1 clique. Rollback cria nova versão (não deleta histórico).

**Justificativa**: Recuperação rápida de incidentes causados por configuração incorreta.

**Critério de Aceite**:
- Interface exibe lista de versões anteriores com diff visual
- Usuário seleciona versão desejada e confirma rollback
- Sistema cria nova versão com valor da versão selecionada
- Histórico registra operação de ROLLBACK com versão de origem
- Cache é invalidado automaticamente após rollback
- Notificação é enviada para Slack/Teams

---

### RN-RF002-07 — Feature Flags Progressivos (Canary Release)

**Descrição**: Feature flags suportam 4 estratégias de rollout:
1. **Percentual Aleatório**: 0% → 25% → 50% → 75% → 100% dos usuários
2. **Usuário Específico**: Lista de IDs de usuários alvos
3. **Perfil Específico**: Lista de perfis (roles) alvos
4. **Empresa Específica**: Lista de empresas piloto

**Justificativa**: Reduzir risco de bugs em produção através de ativação gradual.

**Critério de Aceite**:
- Sistema verifica se feature está ativa para o contexto atual (usuário/perfil/empresa)
- Percentual é avaliado com hash consistente (mesmo usuário sempre tem mesmo resultado)
- Mudança de estratégia de rollout invalida cache de decisões de feature flags
- Feature flag expirada (`Dt_Expiracao < GETDATE()`) retorna automaticamente `false`

---

### RN-RF002-08 — Export/Import para Migração de Ambientes

**Descrição**: Sistema permite exportar configurações para JSON/YAML e importar em outro ambiente com 3 estratégias de conflito:
1. **Overwrite**: Sobrescrever configurações existentes
2. **Ignore**: Ignorar configurações que já existem
3. **Merge**: Importar apenas configurações novas

**Justificativa**: Facilitar deploys controlados (DEV→HOM→PRD) e disaster recovery.

**Critério de Aceite**:
- Exportação pode incluir ou excluir valores sensíveis (checkbox)
- Importação cria backup automático antes de aplicar mudanças
- Validação de schema antes de importar (fail-fast)
- Relatório de importação detalha: quantas criadas, atualizadas, ignoradas, erros
- Auditoria registra operação completa (arquivo importado, estratégia, configs alteradas)

---

### RN-RF002-09 — Notificações de Mudanças Críticas

**Descrição**: Quando configuração marcada como crítica (`Fl_Critica = 1`) é alterada, sistema envia notificação automática para canais configurados (Slack/Teams).

**Justificativa**: Equipe DevOps/Operações precisa saber imediatamente de mudanças críticas para monitorar impacto.

**Critério de Aceite**:
- Notificação contém: nome da configuração, valor anterior, valor novo, usuário que alterou, timestamp, motivo
- Notificação é enviada de forma assíncrona (não bloqueia operação)
- Se envio falhar, sistema registra erro em log mas NÃO falha a operação
- Usuário pode configurar quais canais recebem notificação (Slack, Teams, ambos)

---

### RN-RF002-10 — Validação de Impacto (Dry Run)

**Descrição**: Antes de aplicar mudança crítica, sistema permite simular impacto via dry-run, retornando lista de funcionalidades/módulos que serão afetados.

**Justificativa**: Prevenir indisponibilidade por mudanças não planejadas.

**Critério de Aceite**:
- Dry-run NÃO altera dados (apenas simulação)
- Retorna lista de serviços/funcionalidades dependentes da configuração
- Retorna estimativa de usuários/empresas impactados
- Retorna recomendações (ex: "Execute em horário de manutenção")

---

### RN-RF002-11 — Configurações Somente Leitura

**Descrição**: Configurações marcadas como somente leitura (`Fl_Somente_Leitura = 1`) não podem ser editadas via interface web, apenas via script DevOps ou migração.

**Justificativa**: Proteger configurações críticas do sistema que podem quebrar funcionalidades se alteradas incorretamente.

**Critério de Aceite**:
- Tentativa de editar configuração somente leitura → retorna HTTP 403 Forbidden
- Interface exibe ícone de cadeado em configurações somente leitura
- Tooltip explica: "Esta configuração é protegida e só pode ser alterada via script DevOps"

---

### RN-RF002-12 — Valores Padrão Inteligentes

**Descrição**: Toda configuração possui valor padrão sensato (`Valor_Padrao`). Se valor customizado não estiver definido, sistema usa valor padrão.

**Justificativa**: Sistema funciona "out of the box" sem precisar configurar tudo manualmente.

**Critério de Aceite**:
- Ao criar configuração, campo `Valor_Padrao` é obrigatório
- Se `Valor` for NULL ou vazio, sistema usa `Valor_Padrao`
- Interface exibe valor padrão com estilo diferenciado (ex: itálico cinza)

---

### RN-RF002-13 — Documentação Inline (Tooltips)

**Descrição**: Cada configuração possui descrição breve (`Descricao`) e detalhada (`Descricao_Detalhada`) exibidas em tooltips/help text.

**Justificativa**: Usuários entendem impacto de mudanças sem consultar documentação externa.

**Critério de Aceite**:
- Descrição breve: máximo 200 caracteres
- Descrição detalhada: markdown suportado, com exemplos de valores válidos
- Tooltip exibe ao passar mouse sobre ícone de ajuda

---

### RN-RF002-14 — Agrupamento Visual por Categoria

**Descrição**: Configurações são agrupadas em 10 categorias e subagrupadas por `Grupo_Visual` para organização hierárquica na UI.

**Categorias**: Sistema, Email, Integração, Segurança, Notificação, Cache, Storage, Auditoria, Performance, Features.

**Justificativa**: Interface hierárquica mais intuitiva, facilita navegação.

**Critério de Aceite**:
- Interface exibe árvore de categorias → grupos visuais → configurações
- Busca global pesquisa em categoria, grupo visual, código e nome
- Filtro permite selecionar múltiplas categorias simultaneamente

---

### RN-RF002-15 — Feature Flag Expiração Automática

**Descrição**: Job Hangfire executa diariamente às 02:00 UTC, desabilitando feature flags expiradas (`Dt_Expiracao < GETDATE()`) e notificando desenvolvedores para remover código obsoleto.

**Justificativa**: Prevenir acúmulo de technical debt (feature flags que ficam no código para sempre).

**Critério de Aceite**:
- Job identifica flags expiradas há mais de 30 dias
- Desabilita flags automaticamente (`Fl_Enabled = 0`)
- Envia notificação para canal #dev-alerts com lista de flags expiradas
- Mensagem sugere: "Remover `if (featureFlag)` do código para [lista de flags]"
- Flag expirada exibe aviso vermelho na interface

---

## 6. ESTADOS DA ENTIDADE

| Estado | Descrição |
|--------|-----------|
| `active` | Configuração ativa e em uso |
| `inactive` | Configuração temporariamente desabilitada |
| `readonly` | Configuração protegida contra edição via interface |
| `deleted` | Configuração excluída logicamente (soft delete) |

### Transições permitidas

| De | Para | Condição |
|----|------|----------|
| `active` | `inactive` | Usuário com permissão `SYS.CONFIGURACOES.UPDATE` |
| `inactive` | `active` | Usuário com permissão `SYS.CONFIGURACOES.UPDATE` |
| `active` | `readonly` | Apenas via script DevOps |
| `readonly` | `active` | Apenas via script DevOps |
| `active` | `deleted` | Usuário com permissão `SYS.CONFIGURACOES.DELETE` + motivo obrigatório |

**Transições PROIBIDAS**:
- `readonly` → qualquer outro estado via interface (apenas script DevOps)
- `deleted` → qualquer outro estado (soft delete é permanente)

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre | Subscribers | Ação |
|--------|---------------|-------------|------|
| `ConfiguracaoCriadaEvent` | Após criação de configuração | Cache, Auditoria, Notificação | Invalida cache, registra auditoria, envia notificação se crítica |
| `ConfiguracaoAtualizadaEvent` | Após atualização de configuração | Cache, Auditoria, Notificação | Invalida cache, cria versão histórico, envia notificação se crítica |
| `ConfiguracaoExcluidaEvent` | Após exclusão lógica | Cache, Auditoria | Invalida cache, registra exclusão |
| `RollbackExecutadoEvent` | Após rollback de configuração | Cache, Auditoria, Notificação | Invalida cache, registra rollback, notifica equipe |
| `FeatureFlagAlternadaEvent` | Após ligar/desligar feature flag | Cache, Auditoria, Notificação | Invalida cache de decisões, registra alteração |
| `ConfiguracoesImportadasEvent` | Após importação bem-sucedida | Cache, Auditoria, Notificação | Invalida cache global, registra importação |
| `FeatureFlagExpiradaEvent` | Job detecta flag expirada | Notificação, Auditoria | Desabilita flag, notifica desenvolvedores |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento multi-tenant (configuração de um conglomerado não pode ser acessada por outro)
- Nenhuma configuração sensível pode ser armazenada em texto claro
- Nenhuma regra de negócio pode ser ignorada (validações são obrigatórias)
- Erros devem ser previsíveis, estruturados e rastreáveis (HTTP status codes corretos + mensagens i18n)
- Auditoria deve registrar quem, quando, IP, user-agent e motivo para TODAS as operações CUD
- Cache deve ser invalidado automaticamente após QUALQUER alteração
- Sistema deve funcionar "out of the box" com valores padrão sensatos
- Rollback deve funcionar para qualquer versão sem perda de dados
- Feature flags expiradas devem ser automaticamente desabilitadas
- Importação de configurações deve criar backup automático antes de aplicar

---

## 9. SEGURANÇA

### 9.1 Validação de Entrada
- Sanitização de valores antes de salvar (prevenir XSS em valores JSON)
- Validação de tipo estrita (fail-fast se tipo incompatível)
- Proteção contra SQL Injection via ORM (Entity Framework Core)
- Validação de regex antes de compilar (prevenir ReDoS)

### 9.2 Controle de Permissões

| Operação | Permissão Necessária | Perfis com Acesso |
|----------|---------------------|-------------------|
| Visualizar configurações | `SYS.CONFIGURACOES.READ` | Super Admin, Admin DevOps, Admin Sistema, Gerente Operações, Auditor |
| Criar configuração | `SYS.CONFIGURACOES.CREATE` | Super Admin, Admin DevOps |
| Atualizar configuração | `SYS.CONFIGURACOES.UPDATE` | Super Admin, Admin DevOps, Admin Sistema |
| Excluir configuração | `SYS.CONFIGURACOES.DELETE` | Super Admin |
| Exportar configurações | `SYS.CONFIGURACOES.EXPORT` | Super Admin, Admin DevOps, Admin Sistema, Gerente Operações, Auditor |
| Importar configurações | `SYS.CONFIGURACOES.IMPORT` | Super Admin, Admin DevOps |
| Rollback | `SYS.CONFIGURACOES.ROLLBACK` | Super Admin, Admin DevOps |
| Descriptografar valores sensíveis | `SYS.CONFIGURACOES.DECRYPT` | Super Admin, Admin DevOps |

### 9.3 Isolamento Multi-Tenant
- Row-Level Security: `WHERE Id_Conglomerado = @ConglomeradoAtual`
- Configurações globais: `Id_Conglomerado IS NULL`
- Tentativa de cross-tenant access → HTTP 403 Forbidden

### 9.4 Proteção de Dados Sensíveis
- Criptografia AES-256-GCM com Azure Key Vault
- Chaves de criptografia rotacionadas semestralmente
- Valores sensíveis mascarados (`********`) para usuários sem permissão DECRYPT
- Auditoria registra quando valor sensível é descriptografado

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF002.md** (Casos de Uso): 5 casos de uso canônicos (UC00-UC04)
- **MD-RF002.yaml** (Modelo de Dados): Schema completo de tabelas `Sistema_Configuracao`, `Sistema_Configuracao_Historico`, `Sistema_Feature_Flag`
- **TC-RF002.yaml** (Casos de Teste): Cobertura de 100% das regras de negócio
- **MT-RF002.yaml** (Massas de Teste): Dados de teste para 10 categorias de configurações

---

## 11. RASTREABILIDADE

| Artefato | Status | Responsável | Deadline |
|----------|--------|------------|----------|
| UC-RF002.md | Pendente | Architect Agent | Sprint atual |
| MD-RF002.yaml | Pendente | Architect Agent | Sprint atual |
| TC-RF002.yaml | Pendente | QA Agent | Após UC concluído |
| MT-RF002.yaml | Pendente | QA Agent | Após TC concluído |
| Backend Implementation | Não iniciado | Developer Agent | Sprint +1 |
| Frontend Implementation | Não iniciado | Developer Agent | Sprint +2 |
| E2E Tests | Não iniciado | QA Agent | Sprint +2 |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-29 | Migração para template v2.0 - Separação completa de conteúdo moderno (RF) vs legado (RL), 11 seções obrigatórias, 15 regras de negócio detalhadas, 7 eventos de domínio, matriz de permissões completa | Agência ALC - alc.dev.br |
| 1.0 | 2025-11-04 | Versão inicial (DESCONTINUADA - misturava conteúdo moderno e legado) | Equipe Projeto |
