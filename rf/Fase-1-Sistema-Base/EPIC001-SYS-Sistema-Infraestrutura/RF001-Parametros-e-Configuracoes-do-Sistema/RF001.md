# RF-001: Sistema de Parâmetros e Configurações Centralizadas

**Versão**: 2.0
**Data**: 2025-12-29
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC001-SYS-Sistema-Infraestrutura
**Fase**: Fase 1 - Fundação e Cadastros Base

---

## 1. OBJETIVO DO REQUISITO

Implementar o **Sistema de Parâmetros e Configurações Centralizadas** do IControlIT, responsável por gerenciar todas as configurações do sistema de forma flexível, segura e auditável, permitindo que administradores personalizem comportamentos do sistema sem necessidade de alteração de código.

Este RF define **o que o sistema deve fazer** em termos de gerenciamento de parâmetros, feature flags, configurações de e-mail e limites de uso, estabelecendo garantias de multi-tenancy, criptografia, validação e auditoria.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Criar, atualizar, listar e excluir parâmetros de sistema
- [x] Gerenciar feature flags com rollout gradual
- [x] Configurar provedores de e-mail (SMTP, SendGrid, AWS SES)
- [x] Definir e monitorar limites de uso por conglomerado
- [x] Validar valores conforme tipo de dado (String, Integer, Decimal, Boolean, Date, JSON)
- [x] Criptografar dados sensíveis (senhas, API keys, tokens)
- [x] Registrar histórico completo de alterações (auditoria)
- [x] Controle de acesso baseado em permissões (RBAC)
- [x] Isolamento multi-tenant (parâmetros por conglomerado ou globais)
- [x] Configuração dinâmica em runtime (cache invalidation)
- [x] Categorização de parâmetros (Sistema, Segurança, Integração, Notificação, Relatório)
- [x] Proteção de parâmetros críticos (não editáveis via UI)

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (detalhes de layout, cores, fontes)
- Tecnologia, framework ou linguagem de implementação
- Estratégia de deploy ou infraestrutura de hospedagem
- Integração com ferramentas específicas de monitoramento (Application Insights, Grafana)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-----|---------|
| **Parâmetro** | Configuração do sistema com código único, valor tipado e validações |
| **Feature Flag** | Interruptor para ativar/desativar funcionalidades de forma controlada |
| **Configuração de E-mail** | Credenciais e configurações de provedor SMTP/SendGrid/AWS SES |
| **Limite de Uso** | Restrição quantitativa por conglomerado (usuários, ativos, storage, API calls) |
| **Tenant (Conglomerado)** | Unidade lógica de isolamento de dados multi-tenant |
| **Dado Sensível** | Informação que requer criptografia (senhas, API keys, tokens) |
| **Dado de Sistema** | Parâmetro que não pode ser editado por usuários via interface |
| **Rollout Gradual** | Ativação progressiva de feature flag por % usuários ou lista específica |
| **Categoria** | Agrupamento lógico de parâmetros (Sistema, Segurança, Integração, etc) |
| **Validação Tipada** | Verificação de valor conforme tipo declarado (Integer valida numérico, JSON valida estrutura, etc) |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Gerenciamento de Parâmetros**: Criar, atualizar, listar, excluir e visualizar parâmetros do sistema com validação tipada
2. **Feature Flags Avançadas**: Controlar ativação de funcionalidades com rollout gradual (por % usuários, lista, período)
3. **Configuração de E-mail**: Gerenciar provedores SMTP/SendGrid/AWS SES com teste de envio
4. **Limites de Uso**: Definir e monitorar limites por conglomerado (usuários, ativos, storage, API calls/dia)
5. **Validação Robusta**: Regex, min/max, opções válidas, obrigatoriedade, tipos de dados
6. **Criptografia de Dados Sensíveis**: Proteção automática AES-256 para senhas, API keys e tokens
7. **Histórico de Alterações**: Auditoria completa com usuário, IP, user-agent, timestamp e motivo da mudança
8. **Configuração Dinâmica**: Alterações aplicadas em runtime via cache invalidation (sem restart)
9. **Categorização**: Organização por categorias (Sistema, Segurança, Integração, Notificação, Relatório)
10. **Proteção de Parâmetros Críticos**: Parâmetros de sistema não editáveis via UI (somente via SQL direto)

---

## 5. REGRAS DE NEGÓCIO

### RN-SYS-001-01 — Código Único de Parâmetro

**Descrição**: O código do parâmetro (`Cd_Parametro`) deve ser único por conglomerado.

**Justificativa**: Prevenir duplicação de parâmetros e garantir referência inequívoca.

**Critério de Aceite**:
- Tentativa de criar parâmetro com código duplicado no mesmo conglomerado → rejeição HTTP 409 (Conflict)
- Constraint UNIQUE no banco de dados
- Mensagem clara: `"Já existe um parâmetro com o código '{codigo}' neste conglomerado"`

---

### RN-SYS-001-02 — Validação por Tipo de Dado

**Descrição**: O valor do parâmetro deve ser validado de acordo com seu tipo de dado declarado.

**Critério de Aceite**:
- **String**: aceitar qualquer texto; validar regex se `Regex_Validacao` especificado
- **Integer**: aceitar apenas números inteiros; respeitar `Valor_Minimo` e `Valor_Maximo`
- **Decimal**: aceitar números decimais; respeitar `Valor_Minimo` e `Valor_Maximo`
- **Boolean**: aceitar apenas `true` ou `false`
- **Date**: validar se é data válida (formato ISO 8601)
- **JSON**: validar se é JSON válido (deserialização deve ter sucesso)
- Valor inválido → rejeição HTTP 400 com mensagem específica por tipo

---

### RN-SYS-001-03 — Parâmetros de Sistema Não Editáveis

**Descrição**: Parâmetros marcados como sistema (`Fl_Sistema = 1`) não podem ser editados ou excluídos por usuários via interface.

**Critério de Aceite**:
- Tentativa de UPDATE ou DELETE de parâmetro com `Fl_Sistema = 1` → rejeição HTTP 403 (Forbidden)
- Interface deve ocultar botões de edição/exclusão para parâmetros de sistema
- Apenas administradores do sistema podem alterar via SQL direto no banco

---

### RN-SYS-001-04 — Criptografia de Dados Sensíveis

**Descrição**: Parâmetros marcados como sensíveis (`Fl_Sensivel = 1`) devem ter valores criptografados em AES-256.

**Critério de Aceite**:
- Valor sensível é criptografado automaticamente ao salvar (antes de INSERT/UPDATE no banco)
- Valor sensível é descriptografado apenas quando necessário para uso no sistema
- Valores sensíveis NÃO devem aparecer em logs de aplicação ou auditoria
- Interface deve máscarar valores sensíveis (`*****`) ao exibir
- Requisição de leitura retorna valor descriptografado APENAS para Super Administrador com permissão `SYS.PARAMETROS.VIEW_SENSITIVE`

---

### RN-SYS-001-05 — Validação de Opções Válidas

**Descrição**: Se campo `Opcoes_Validas` estiver preenchido, o valor deve estar na lista de opções separadas por vírgula.

**Critério de Aceite**:
- Verificar se valor está entre opções (case-insensitive)
- Valor fora da lista → rejeição HTTP 400 com mensagem: `"Valor '{valor}' inválido. Opções válidas: {opcoes}"`
- Interface deve exibir dropdown com opções válidas quando campo preenchido

---

### RN-SYS-001-06 — Valores Obrigatórios

**Descrição**: Parâmetros marcados como obrigatórios (`Fl_Obrigatorio = 1`) não podem ter valor nulo.

**Critério de Aceite**:
- Ao menos um campo de valor (`Vl_String`, `Vl_Inteiro`, `Vl_Decimal`, `Vl_Boolean`, `Vl_Data`, `Vl_Json`) deve estar preenchido
- Valor ausente ou vazio → rejeição HTTP 400
- Se `Valor_Padrao` especificado, utilizar como fallback ao criar parâmetro obrigatório

---

### RN-SYS-001-07 — Histórico Completo de Alterações

**Descrição**: Todas as operações em parâmetros (CREATE, UPDATE, DELETE, ACCESS para sensíveis) devem ser registradas em `Sistema_Parametro_Historico`.

**Critério de Aceite**:
- Registrar valor anterior e novo (diff JSON para UPDATE)
- Capturar usuário, data/hora, IP do cliente, User-Agent, motivo da alteração (opcional)
- Visualização de parâmetro sensível gera registro de auditoria tipo ACCESS
- Retenção de 7 anos (conforme LGPD)

---

### RN-SYS-001-08 — Feature Flags por Conglomerado

**Descrição**: Feature flags podem ser globais (`Id_Conglomerado = NULL`) ou específicas por conglomerado.

**Critério de Aceite**:
- Ao verificar se feature está ativa, verificar primeiro se existe flag específica do conglomerado
- Caso não exista flag específica, verificar flag global
- Priorizar flag específica sobre flag global (regra de especialização)

---

### RN-SYS-001-09 — Rollout Percentual de Features

**Descrição**: Features com `Tipo_Rollout = 'Percentage'` devem ser habilitadas para % específico de usuários de forma consistente.

**Critério de Aceite**:
- Calcular hash determinístico do `Id_Usuario` (MD5 ou SHA256 mod 100)
- Comparar hash % 100 com `Percentual_Rollout`
- Se `hash % 100 < Percentual_Rollout` → feature ativa para este usuário
- Garantir consistência: mesmo usuário sempre recebe mesmo resultado

---

### RN-SYS-001-10 — Apenas Uma Configuração de E-mail Principal

**Descrição**: Apenas uma configuração de e-mail pode ser marcada como principal (`Fl_Principal = 1`) por conglomerado.

**Critério de Aceite**:
- Ao marcar configuração como principal, desmarcar automaticamente outras do mesmo conglomerado
- Usar trigger no banco ou validação no Command (Application Layer)
- Interface deve indicar claramente qual configuração é principal (ícone de estrela ou badge)

---

### RN-SYS-001-11 — Validação de Servidor SMTP

**Descrição**: Configurações de tipo SMTP devem ter servidor, porta e credenciais válidas.

**Critério de Aceite**:
- Campo `Servidor_Smtp` deve estar preenchido
- Campo `Porta_Smtp` deve estar entre 1-65535
- Senha SMTP deve ser criptografada antes de salvar
- Opcionalmente, testar conexão SMTP antes de salvar (timeout 10s)

---

### RN-SYS-001-12 — Limites de Uso por Conglomerado

**Descrição**: Cada tipo de limite (`Tipo_Limite`) deve ser único por conglomerado.

**Critério de Aceite**:
- Constraint UNIQUE em (`Id_Conglomerado`, `Tipo_Limite`)
- Atualizar `Uso_Atual` quando operações afetadas ocorrerem (criar usuário, ativo, upload, API call)
- Enviar alerta quando `Uso_Atual / Limite * 100 >= Percentual_Alerta`
- Bloquear operação quando `Uso_Atual >= Limite` (exceto Super Admin)

---

### RN-SYS-001-13 — Alertas de Limite de Uso

**Descrição**: Alertas devem ser enviados quando uso atingir percentual de alerta definido.

**Critério de Aceite**:
- Job Hangfire verifica limites a cada 1 hora
- Se `Uso_Atual / Limite * 100 >= Percentual_Alerta` E `Fl_Alerta_Enviado = 0` → enviar e-mail para administradores
- Marcar `Fl_Alerta_Enviado = 1` após envio (não duplicar alertas)
- Resetar flag quando `Uso_Atual / Limite * 100 < Percentual_Alerta - 10%` (hysteresis para evitar oscilações)

---

### RN-SYS-001-14 — Isolamento Multi-tenancy

**Descrição**: Todos os parâmetros e configurações devem ser isolados por conglomerado. Usuário só pode acessar dados do seu próprio conglomerado.

**Critério de Aceite**:
- Filtrar sempre por `Id_Conglomerado` do usuário autenticado em queries
- Validar que `Id_Conglomerado` no payload coincide com conglomerado do usuário autenticado
- Tentativa de acesso cross-tenant → rejeição HTTP 403 (Forbidden)
- Super Administrador pode acessar todos os conglomerados (bypassar filtro)

---

### RN-SYS-001-15 — Validação de JSON

**Descrição**: Parâmetros do tipo JSON devem ter JSON válido.

**Critério de Aceite**:
- Tentar deserializar valor com `JsonDocument.Parse()` ou equivalente
- JSON inválido → rejeição HTTP 400 com mensagem de erro de parsing
- Aceitar apenas objetos `{}` ou arrays `[]` JSON (não valores primitivos)

---

## 6. ESTADOS DA ENTIDADE

### Estados de Parâmetro

| Estado | Descrição |
|------|-----------|
| `pending` | Criado, aguardando aprovação (se workflow habilitado) |
| `active` | Ativo e em uso |
| `inactive` | Inativo (não é consultado pelo sistema) |
| `cancelled` | Cancelado (não pode voltar a ativo) |

### Transições permitidas

| De | Para |
|---|---|
| `pending` | `active` |
| `active` | `inactive` |
| `inactive` | `active` |
| `active` | `cancelled` |

**Transições proibidas**:
- `cancelled` → qualquer estado (estado terminal)
- Qualquer estado → `pending` (estado inicial)

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre |
|------|--------------|
| `parametro.criado` | Após criação bem-sucedida de parâmetro |
| `parametro.atualizado` | Após atualização de valor ou metadados |
| `parametro.excluido` | Após exclusão lógica de parâmetro |
| `parametro_sensivel.acessado` | Ao visualizar valor de parâmetro sensível |
| `featureflag.ativada` | Ao ativar feature flag |
| `featureflag.desativada` | Ao desativar feature flag |
| `limite_uso.alerta_enviado` | Ao enviar alerta de limite próximo de ser atingido |
| `limite_uso.atingido` | Ao atingir 100% do limite de uso |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento multi-tenant
- Nenhuma regra de negócio pode ser ignorada (todas são obrigatórias)
- Erros devem ser previsíveis, rastreáveis e com mensagens claras (sem expor stack traces)
- Auditoria deve registrar quem, quando, de onde (IP) e o que mudou (diff JSON)
- Dados sensíveis NUNCA aparecem em logs ou respostas sem máscara
- Validações devem ser aplicadas ANTES de persistir (fail-fast)
- Configuração dinâmica deve invalidar cache automaticamente ao salvar parâmetro
- Interface deve seguir princípio de proteção: parâmetros de sistema não editáveis, valores sensíveis mascarados
- Testes devem cobrir todos os tipos de dados, validações, transições de estado e cross-tenant access

---

## 9. SEGURANÇA

- **Validação de Entrada**: Todos os payloads devem ser validados (FluentValidation)
- **Proteção contra Injeção**: Usar parameterized queries (EF Core), evitar SQL dinâmico
- **Controle de Permissões**: Matriz RBAC com permissões específicas por operação
- **Isolamento Multi-tenant**: Row-Level Security baseado em `Id_Conglomerado`
- **Criptografia**: AES-256 para dados sensíveis em repouso; TLS 1.2+ para dados em trânsito
- **Rate Limiting**: Limitar chamadas API por usuário/conglomerado
- **Auditoria de Acesso**: Registrar visualização de parâmetros sensíveis

**Permissões Requeridas**:
- `SYS.PARAMETROS.CREATE` - Criar novos parâmetros
- `SYS.PARAMETROS.UPDATE` - Editar parâmetros existentes
- `SYS.PARAMETROS.DELETE` - Excluir parâmetros
- `SYS.PARAMETROS.VIEW` - Visualizar parâmetros
- `SYS.PARAMETROS.VIEW_ANY` - Listar parâmetros
- `SYS.PARAMETROS.VIEW_SENSITIVE` - Visualizar valores sensíveis descriptografados
- `SYS.PARAMETROS.EXPORT` - Exportar lista de parâmetros
- `SYS.FEATUREFLAGS.UPDATE` - Modificar feature flags
- `SYS.CONFIGURACOES_EMAIL.UPDATE` - Editar configurações de e-mail
- `SYS.LIMITES_USO.UPDATE` - Modificar limites de uso

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF001.md** (Casos de Uso): Detalhamento de fluxos de criação, atualização, listagem, exclusão de parâmetros, feature flags, configurações de e-mail e limites de uso
- **MD-RF001.yaml** (Modelo de Dados): DDL completo das tabelas `Sistema_Parametro`, `Sistema_Feature_Flag`, `Sistema_Configuracao_Email`, `Sistema_Limite_Uso` e suas respectivas tabelas de histórico
- **MT-RF001.yaml** (Massas de Teste): Dados de teste cobrindo todos os tipos de parâmetros, validações, feature flags e limites de uso
- **TC-RF001.yaml** (Casos de Teste): Testes automatizados de validação, criptografia, multi-tenancy, auditoria e feature flags

---

## 11. RASTREABILIDADE

| Artefato | Gerado | Status |
|--------|-------|--------|
| Casos de Uso (UC-RF001.md) | Obrigatório | ✅ Criado |
| Modelo de Dados (MD-RF001.yaml) | Obrigatório | ⏳ Pendente |
| Massas de Teste (MT-RF001.yaml) | Obrigatório | ⏳ Pendente |
| Casos de Teste (TC-RF001.yaml) | Obrigatório | ⏳ Pendente |

**Registro na Central de Funcionalidades**:
- Código: `FNC-SYS-001`
- Nome: Gestão de Parâmetros e Configurações do Sistema
- Categoria: Configurações
- Tipo: Tela + API

**Chaves de Internacionalização (i18n)**:
- Prefixo: `PARAMETROS.`, `FEATURE_FLAGS.`, `CONFIGURACOES_EMAIL.`, `LIMITES_USO.`
- Idiomas: pt-BR (principal), en-US, es-ES
- Arquivo: `src/assets/i18n/pt-BR.json`

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|------|------|----------|------|
| 2.0 | 2025-12-29 | Migração manual para nova governança (separação RF/RL, conformidade 100% com template oficial) | Agência ALC - alc.dev.br |
| 1.0 | 2025-11-03 | Versão inicial estrutura simplificada (5 seções) | Agência ALC - alc.dev.br |
