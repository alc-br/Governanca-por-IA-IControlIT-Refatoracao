# Casos de Uso - RF001

**VersÃ£o:** 1.0
**Data:** 2025-12-17
**RF Relacionado:** [RF001 - Parametros-e-Configuracoes-do-Sistema](./RF001.md)

---

## Ãndice de Casos de Uso

| UC | Nome | DescriÃ§Ã£o |
|----|------|-----------|
| UC00 | Listar ParÃ¢metros do Sistema | Este caso de uso permite que administradores do sistema visualizem, pesquisem e filtrem todos os par |
| UC01 | Criar/Atualizar ParÃ¢metro do Sistema | Este caso de uso permite que administradores do sistema criem novos parÃ¢metros de configuraÃ§Ã£o ou at |
| UC02 | Visualizar Detalhes de ParÃ¢metro | Este caso de uso permite que usuÃ¡rios autorizados visualizem todos os detalhes de um parÃ¢metro espec |
| UC03 | UC03 - Gerenciar Feature Flags | Caso de uso |
| UC04 | Configurar Limites de Uso | Este caso de uso permite que Super Administradores configurem limites de uso por conglomerado para c |
| UC08 | UC08 - Ocultar Feature do Sistema | Caso de uso |

---

# UC00: Listar ParÃ¢metros do Sistema


---

## ğŸ“‹ InformaÃ§Ãµes Gerais

### DescriÃ§Ã£o
Este caso de uso permite que administradores do sistema visualizem, pesquisem e filtrem todos os parÃ¢metros configurÃ¡veis do sistema IControlIT. A listagem suporta paginaÃ§Ã£o, ordenaÃ§Ã£o e filtros avanÃ§ados por categoria, tipo de dado e conglomerado.

### Atores
- **Administrador do Sistema**: UsuÃ¡rio com permissÃ£o para visualizar e gerenciar parÃ¢metros
- **Administrador do Conglomerado**: UsuÃ¡rio com permissÃ£o para visualizar apenas parÃ¢metros de seu conglomerado

### PrÃ©-condiÃ§Ãµes
1. UsuÃ¡rio deve estar autenticado no sistema
2. **UsuÃ¡rio deve ter permissÃ£o `SYS.PARAMETROS.READ`** (verificaÃ§Ã£o via Central de Funcionalidades)
3. UsuÃ¡rio deve ter perfil ativo
4. SessÃ£o vÃ¡lida e nÃ£o expirada
5. Sistema deve ter ao menos uma categoria de parÃ¢metros cadastrada

### PÃ³s-condiÃ§Ãµes
**Sucesso**:
- Lista de parÃ¢metros Ã© exibida conforme filtros aplicados
- UsuÃ¡rio pode visualizar detalhes de cada parÃ¢metro
- ParÃ¢metros sensÃ­veis tÃªm valores mascarados (******)

**Falha**:
- Mensagem de erro Ã© exibida explicando o motivo
- Sistema permanece na tela de listagem

---

## ğŸ¯ Fluxo Principal

### FP-01: Listar Todos os ParÃ¢metros

1. **UsuÃ¡rio** acessa menu "Sistema â†’ ConfiguraÃ§Ãµes â†’ ParÃ¢metros"
2. **Sistema** carrega categorias de parÃ¢metros do cache/banco de dados
3. **Sistema** aplica filtro automÃ¡tico por conglomerado do usuÃ¡rio (se nÃ£o for admin master)
4. **Sistema** consulta parÃ¢metros na tabela `Sistema_Parametro` com:
   - Filtro: `Fl_Ativo = 1`
   - OrdenaÃ§Ã£o padrÃ£o: `Nm_Categoria ASC, Nm_Parametro ASC`
   - PaginaÃ§Ã£o: 50 itens por pÃ¡gina
5. **Sistema** exibe grid com colunas:
   - Categoria
   - CÃ³digo do ParÃ¢metro
   - Nome do ParÃ¢metro
   - Tipo de Dado
   - Valor Atual (mascarado se `Fl_Sensivel = 1`)
   - Status (Sistema/EditÃ¡vel)
   - AÃ§Ãµes (Visualizar, Editar, HistÃ³rico)
6. **Sistema** exibe total de parÃ¢metros encontrados
7. **Caso de uso** encerra

**Regras de NegÃ³cio Aplicadas**:
- **RN-CFG-001-14**: Isolamento multi-tenancy (filtrar por conglomerado)
- **RN-CFG-001-03**: ParÃ¢metros de sistema (`Fl_Sistema = 1`) nÃ£o mostram botÃ£o "Editar"
- **RN-CFG-001-04**: ParÃ¢metros sensÃ­veis (`Fl_Sensivel = 1`) mostram "******"

---

## ğŸ”€ Fluxos Alternativos

### FA-01: Filtrar por Categoria

1. No passo 3 do FP-01, **usuÃ¡rio** seleciona uma categoria no dropdown
2. **Sistema** aplica filtro `Id_Categoria = {categoria_selecionada}`
3. **Sistema** atualiza grid com parÃ¢metros da categoria
4. Retorna ao passo 6 do FP-01

### FA-02: Pesquisar por CÃ³digo ou Nome

1. No passo 3 do FP-01, **usuÃ¡rio** digita texto no campo de pesquisa
2. **Sistema** aguarda 500ms (debounce) apÃ³s usuÃ¡rio parar de digitar
3. **Sistema** aplica filtro:
   ```sql
   WHERE (Cd_Parametro LIKE '%{texto}%' OR Nm_Parametro LIKE '%{texto}%')
   ```
4. **Sistema** atualiza grid com resultados
5. Retorna ao passo 6 do FP-01

### FA-03: Filtrar por Tipo de Dado

1. No passo 3 do FP-01, **usuÃ¡rio** seleciona tipo de dado (String, Integer, Boolean, etc.)
2. **Sistema** aplica filtro `Tipo_Dado = {tipo_selecionado}`
3. **Sistema** atualiza grid
4. Retorna ao passo 6 do FP-01

### FA-04: Ordenar Colunas

1. Em qualquer momento, **usuÃ¡rio** clica em cabeÃ§alho de coluna
2. **Sistema** alterna ordenaÃ§Ã£o (ASC â†” DESC)
3. **Sistema** recarrega grid com nova ordenaÃ§Ã£o
4. Continua no passo 6 do FP-01

### FA-05: Navegar entre PÃ¡ginas

1. Em qualquer momento, **usuÃ¡rio** clica em botÃ£o de paginaÃ§Ã£o (Anterior, PrÃ³xima, ou nÃºmero de pÃ¡gina)
2. **Sistema** carrega pÃ¡gina solicitada mantendo filtros ativos
3. **Sistema** atualiza grid
4. Continua no passo 6 do FP-01

### FA-06: Alterar Tamanho de PÃ¡gina

1. Em qualquer momento, **usuÃ¡rio** seleciona quantidade de itens por pÃ¡gina (25, 50, 100)
2. **Sistema** recarrega primeira pÃ¡gina com novo tamanho
3. **Sistema** atualiza paginador
4. Continua no passo 6 do FP-01

### FA-07: Visualizar Detalhes do ParÃ¢metro

1. Em qualquer momento, **usuÃ¡rio** clica em Ã­cone "Visualizar" (olho)
2. **Sistema** abre modal/drawer com detalhes completos:
   - CÃ³digo
   - Nome
   - DescriÃ§Ã£o
   - Categoria
   - Tipo de Dado
   - Valor Atual (descriptografado se usuÃ¡rio tiver permissÃ£o)
   - ValidaÃ§Ãµes (regex, min/max, opÃ§Ãµes vÃ¡lidas)
   - Valor PadrÃ£o
   - Flags (SensÃ­vel, ObrigatÃ³rio, Sistema)
   - Data de CriaÃ§Ã£o
   - Data de Ãšltima AlteraÃ§Ã£o
3. **UsuÃ¡rio** fecha modal
4. Retorna ao passo 6 do FP-01

### FA-08: Editar ParÃ¢metro

1. Em qualquer momento, **usuÃ¡rio** clica em Ã­cone "Editar" (lÃ¡pis)
2. **Sistema** valida se parÃ¢metro nÃ£o Ã© de sistema (`Fl_Sistema = 0`)
3. **Sistema** redireciona para [UC01: Criar/Atualizar ParÃ¢metro](./UC01-criar-atualizar-parametro.md)
4. Caso de uso UC01 Ã© executado

### FA-09: Visualizar HistÃ³rico

1. Em qualquer momento, **usuÃ¡rio** clica em Ã­cone "HistÃ³rico" (relÃ³gio)
2. **Sistema** abre modal com histÃ³rico de alteraÃ§Ãµes da tabela `Sistema_Parametro_Historico`
3. **Sistema** exibe lista ordenada por `Dt_Alteracao DESC`:
   - Data/Hora
   - UsuÃ¡rio que alterou
   - Valor Anterior
   - Valor Novo
   - Motivo da AlteraÃ§Ã£o
   - IP do UsuÃ¡rio
4. **UsuÃ¡rio** pode exportar histÃ³rico para CSV
5. **UsuÃ¡rio** fecha modal
6. Retorna ao passo 6 do FP-01

### FA-10: Exportar Lista para Excel

1. Em qualquer momento, **usuÃ¡rio** clica em botÃ£o "Exportar"
2. **Sistema** gera arquivo Excel (.xlsx) com parÃ¢metros visÃ­veis (respeitando filtros)
3. **Sistema** mascara valores sensÃ­veis na exportaÃ§Ã£o
4. **Sistema** inicia download do arquivo
5. Continua no passo 6 do FP-01

---

## âš ï¸ Fluxos de ExceÃ§Ã£o

### FE-01: Nenhum ParÃ¢metro Encontrado

1. No passo 4 do FP-01, **sistema** nÃ£o encontra nenhum parÃ¢metro que atenda aos filtros
2. **Sistema** exibe mensagem: "Nenhum parÃ¢metro encontrado com os filtros aplicados"
3. **Sistema** sugere aÃ§Ãµes:
   - Limpar filtros
   - Criar novo parÃ¢metro (se tiver permissÃ£o)
4. **Caso de uso** encerra

### FE-02: Erro ao Carregar ParÃ¢metros

1. No passo 4 do FP-01, **sistema** falha ao consultar banco de dados
2. **Sistema** loga erro no sistema de logs
3. **Sistema** exibe mensagem: "Erro ao carregar parÃ¢metros. Tente novamente em instantes."
4. **Sistema** exibe botÃ£o "Tentar Novamente"
5. **UsuÃ¡rio** pode clicar para tentar novamente ou sair da tela
6. **Caso de uso** encerra

### FE-03: UsuÃ¡rio Sem PermissÃ£o

1. No passo 2 do FP-01, **sistema** verifica que usuÃ¡rio nÃ£o possui permissÃ£o necessÃ¡ria
2. **Sistema** exibe mensagem: "VocÃª nÃ£o possui permissÃ£o para visualizar parÃ¢metros do sistema"
3. **Sistema** redireciona para dashboard principal
4. **Caso de uso** encerra com erro

### FE-04: Tentativa de Editar ParÃ¢metro de Sistema

1. No FA-08, **usuÃ¡rio** tenta editar parÃ¢metro com `Fl_Sistema = 1`
2. **Sistema** exibe mensagem: "ParÃ¢metros de sistema nÃ£o podem ser editados pela interface. Contacte o administrador."
3. Retorna ao passo 6 do FP-01

### FE-05: Cache InvÃ¡lido

1. No passo 2 do FP-01, **sistema** detecta que cache Redis estÃ¡ indisponÃ­vel
2. **Sistema** consulta diretamente o banco de dados
3. **Sistema** loga warning sobre cache indisponÃ­vel
4. Continua no passo 4 do FP-01
5. **Sistema** tenta reconectar ao Redis em background

---

## ğŸ“Š CritÃ©rios de AceitaÃ§Ã£o

### CA-01: Listagem BÃ¡sica
- âœ… Grid carrega em menos de 2 segundos para atÃ© 1000 parÃ¢metros
- âœ… PaginaÃ§Ã£o funciona corretamente
- âœ… Valores sensÃ­veis sÃ£o mascarados (******)
- âœ… ParÃ¢metros de sistema nÃ£o mostram botÃ£o "Editar"

### CA-02: Filtros
- âœ… Filtro por categoria funciona corretamente
- âœ… Pesquisa por cÃ³digo/nome tem debounce de 500ms
- âœ… Filtro por tipo de dado funciona
- âœ… MÃºltiplos filtros podem ser combinados

### CA-03: OrdenaÃ§Ã£o
- âœ… Todas as colunas sÃ£o ordenÃ¡veis
- âœ… Indicador visual mostra coluna ordenada (seta â†‘â†“)
- âœ… AlternÃ¢ncia ASC/DESC funciona corretamente

### CA-04: Performance
- âœ… Grid suporta atÃ© 10.000 parÃ¢metros com paginaÃ§Ã£o
- âœ… Filtros aplicam em menos de 500ms
- âœ… Cache Redis Ã© utilizado quando disponÃ­vel
- âœ… Consulta ao banco usa Ã­ndices otimizados

### CA-05: SeguranÃ§a
- âœ… UsuÃ¡rio sÃ³ vÃª parÃ¢metros de seu conglomerado (exceto admin master)
- âœ… Valores sensÃ­veis nunca sÃ£o expostos na API REST response
- âœ… Acesso Ã© logado para auditoria
- âœ… PermissÃµes sÃ£o validadas no backend

### CA-06: Responsividade
- âœ… Interface adapta para mobile (table â†’ cards)
- âœ… Filtros colapsam em dropdown em telas pequenas
- âœ… PaginaÃ§Ã£o adapta para mobile

---

## ğŸ”’ Regras de NegÃ³cio

### RN-UC00-01: Isolamento Multi-Tenant
**DescriÃ§Ã£o**: Administradores de conglomerado sÃ³ veem parÃ¢metros de seu conglomerado.

**ImplementaÃ§Ã£o**:
```sql
WHERE (Id_Conglomerado = @Id_Conglomerado_Usuario OR @Fl_Admin_Master = 1)
```

### RN-UC00-02: PriorizaÃ§Ã£o de Cache
**DescriÃ§Ã£o**: ParÃ¢metros sÃ£o cacheados por 1 hora no Redis.

**ImplementaÃ§Ã£o**:
- Key: `parametros:conglomerado:{id}:lista`
- TTL: 3600 segundos
- InvalidaÃ§Ã£o: Ao criar/atualizar/deletar parÃ¢metro

### RN-UC00-03: MÃ¡scara de Valores SensÃ­veis
**DescriÃ§Ã£o**: Valores com `Fl_Sensivel = 1` sÃ£o sempre mascarados na listagem.

**ImplementaÃ§Ã£o**:
```csharp
if (parametro.Fl_Sensivel == 1)
{
    parametro.ValorExibicao = "*".Repeat(8);
}
```

### RN-UC00-04: Limite de PaginaÃ§Ã£o
**DescriÃ§Ã£o**: MÃ¡ximo de 100 itens por pÃ¡gina para evitar sobrecarga.

**ValidaÃ§Ã£o**:
```csharp
if (pageSize > 100) throw new BusinessException("MÃ¡ximo de 100 itens por pÃ¡gina");
```

### RN-UC00-05: VerificaÃ§Ã£o de PermissÃ£o de Acesso
**DescriÃ§Ã£o**: O sistema deve verificar se o usuÃ¡rio possui permissÃ£o `SYS.PARAMETROS.READ` atravÃ©s da Central de Funcionalidades.

**Regra**:
1. Antes de executar qualquer aÃ§Ã£o, verificar se usuÃ¡rio tem permissÃ£o
2. Consultar tabelas `Usuario_Perfil` e `Perfil_Funcionalidade`
3. Validar que funcionalidade `FNC-SYS-001` estÃ¡ associada ao perfil com `Fl_Ler = 1`
4. Retornar HTTP 403 Forbidden se usuÃ¡rio nÃ£o tiver acesso
5. Registrar tentativa de acesso nÃ£o autorizado em auditoria

**ExceÃ§Ã£o**:
- Se usuÃ¡rio nÃ£o tiver permissÃ£o, executar fluxo FE-03 (UsuÃ¡rio Sem PermissÃ£o)

### RN-UC00-06: Auditoria de Acesso
**DescriÃ§Ã£o**: Toda visualizaÃ§Ã£o de parÃ¢metros deve ser registrada em auditoria.

**ImplementaÃ§Ã£o**:
- Registrar em `Sistema_Parametro_Historico`:
  - `Tipo_Operacao = 'READ'`
  - `Id_Usuario` = usuÃ¡rio que acessou
  - `Dt_Operacao` = timestamp da operaÃ§Ã£o
  - `Ip_Usuario` = IP da requisiÃ§Ã£o
  - `User_Agent` = navegador/aplicaÃ§Ã£o do usuÃ¡rio
- VisualizaÃ§Ã£o de parÃ¢metros sensÃ­veis deve ter log adicional de tipo `ACCESS`

---

## ğŸ”— IntegraÃ§Ãµes ObrigatÃ³rias

### Central de Funcionalidades

**Funcionalidade**: `FNC-SYS-001` - GestÃ£o de ParÃ¢metros do Sistema

**PermissÃ£o Requerida**: `SYS.PARAMETROS.READ`

**ValidaÃ§Ã£o no Backend**:
```csharp
[Authorize]
[RequiresPermission("SYS.PARAMETROS.READ")]
public async Task<IActionResult> ListarParametros([FromQuery] ParametroFiltroDto filtro)
{
    // LÃ³gica da listagem
}
```

**ValidaÃ§Ã£o no Frontend**:
```typescript
// Guard na rota
{
  path: 'parametros',
  component: ParametrosComponent,
  canActivate: [AuthGuard, PermissionGuard],
  data: { permission: 'SYS.PARAMETROS.READ' }
}

// Diretiva no menu
<a *hasPermission="'SYS.PARAMETROS.READ'" routerLink="/parametros">
  ParÃ¢metros
</a>
```

### InternacionalizaÃ§Ã£o

**Chaves de TraduÃ§Ã£o NecessÃ¡rias**:

| Chave | Contexto | Texto PT-BR |
|-------|----------|-------------|
| `PARAMETROS.TITLE` | TÃ­tulo da tela | "ParÃ¢metros do Sistema" |
| `PARAMETROS.SUBTITLE` | SubtÃ­tulo | "Gerenciar configuraÃ§Ãµes do sistema" |
| `PARAMETROS.FIELDS.CODE` | Label coluna | "CÃ³digo" |
| `PARAMETROS.FIELDS.NAME` | Label coluna | "Nome" |
| `PARAMETROS.FIELDS.CATEGORY` | Label coluna | "Categoria" |
| `PARAMETROS.FIELDS.DATA_TYPE` | Label coluna | "Tipo de Dado" |
| `PARAMETROS.FIELDS.VALUE` | Label coluna | "Valor" |
| `PARAMETROS.MESSAGES.LOAD_ERROR` | Erro ao carregar | "Erro ao carregar parÃ¢metros" |
| `PARAMETROS.MESSAGES.SENSITIVE_VALUE_MASKED` | Info valor mascarado | "Valor sensÃ­vel (oculto por seguranÃ§a)" |
| `COMMON.BUTTONS.NEW` | BotÃ£o novo | "Novo" |
| `COMMON.BUTTONS.EXPORT` | BotÃ£o exportar | "Exportar" |
| `COMMON.BUTTONS.REFRESH` | BotÃ£o atualizar | "Atualizar" |
| `COMMON.LABELS.SEARCH` | Campo busca | "Pesquisar..." |
| `COMMON.LABELS.CATEGORY` | Label filtro | "Categoria" |
| `COMMON.LABELS.ALL` | OpÃ§Ã£o todos | "Todos" |
| `COMMON.PAGINATION.TOTAL` | Total registros | "Total: {count} parÃ¢metros" |
| `COMMON.PAGINATION.PAGE` | PÃ¡gina | "PÃ¡gina" |

**Arquivo**: `src/assets/i18n/pt-BR.json`
**SeÃ§Ã£o**: `PARAMETROS`

**Uso no CÃ³digo**:
```typescript
export class ParametrosListComponent {
  constructor(private translate: TranslateService) {}

  ngOnInit() {
    this.title = this.translate.instant('PARAMETROS.TITLE');
    this.loadParametros();
  }

  onError() {
    this.toastr.error(
      this.translate.instant('PARAMETROS.MESSAGES.LOAD_ERROR')
    );
  }
}
```

```html
<h1>{{ 'PARAMETROS.TITLE' | translate }}</h1>
<p class="subtitle">{{ 'PARAMETROS.SUBTITLE' | translate }}</p>

<table>
  <thead>
    <tr>
      <th>{{ 'PARAMETROS.FIELDS.CATEGORY' | translate }}</th>
      <th>{{ 'PARAMETROS.FIELDS.CODE' | translate }}</th>
      <th>{{ 'PARAMETROS.FIELDS.NAME' | translate }}</th>
      <th>{{ 'PARAMETROS.FIELDS.DATA_TYPE' | translate }}</th>
      <th>{{ 'PARAMETROS.FIELDS.VALUE' | translate }}</th>
      <th>{{ 'COMMON.LABELS.ACTIONS' | translate }}</th>
    </tr>
  </thead>
</table>

<button class="btn-primary">
  {{ 'COMMON.BUTTONS.NEW' | translate }}
</button>
```

### Auditoria

**OperaÃ§Ãµes Auditadas**:

| OperaÃ§Ã£o | Tipo | Dados Registrados |
|----------|------|-------------------|
| Listar ParÃ¢metros | READ | Filtros aplicados, quantidade de registros retornados |
| Visualizar ParÃ¢metro SensÃ­vel | ACCESS | ID do parÃ¢metro, cÃ³digo do parÃ¢metro |
| Exportar ParÃ¢metros | EXPORT | Filtros utilizados, quantidade de registros exportados |

**Tabela de Auditoria**: `Sistema_Parametro_Historico`

**ImplementaÃ§Ã£o Backend**:
```csharp
public async Task<ActionResult<PagedResult<ParametroDto>>> ListarParametros(
    [FromQuery] ParametroFiltroDto filtro)
{
    var userId = User.GetUserId();
    var ipAddress = HttpContext.Connection.RemoteIpAddress?.ToString();
    var userAgent = HttpContext.Request.Headers["User-Agent"].ToString();

    // Buscar parÃ¢metros
    var resultado = await _parametroService.Listar(filtro);

    // Registrar auditoria
    await _auditoriaService.Registrar(new AuditoriaDto
    {
        TipoOperacao = "READ",
        Entidade = "Sistema_Parametro",
        Descricao = $"Listou {resultado.TotalItems} parÃ¢metros",
        DadosAdicionais = JsonSerializer.Serialize(filtro),
        IdUsuario = userId,
        IpUsuario = ipAddress,
        UserAgent = userAgent
    });

    return Ok(resultado);
}
```

**ImplementaÃ§Ã£o Frontend (Interceptor)**:
```typescript
@Injectable()
export class AuditInterceptor implements HttpInterceptor {
  intercept(req: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {
    const auditReq = req.clone({
      headers: req.headers
        .set('X-Audit-Action', 'READ')
        .set('X-Audit-Timestamp', new Date().toISOString())
    });
    return next.handle(auditReq);
  }
}
```

### Controle de Acesso

**Perfis com Acesso a este Caso de Uso**:

| Perfil | Pode Acessar? | RestriÃ§Ãµes |
|--------|---------------|------------|
| Super Administrador | âœ… Sim | Visualiza todos os parÃ¢metros de todos os conglomerados |
| Administrador de Sistema | âœ… Sim | Visualiza apenas parÃ¢metros do seu conglomerado |
| Administrador de TI | âœ… Sim | Visualiza apenas parÃ¢metros do seu conglomerado |
| Gerente de OperaÃ§Ãµes | âœ… Sim (somente leitura) | Visualiza parÃ¢metros nÃ£o sensÃ­veis do seu conglomerado |
| Auditor | âœ… Sim (somente leitura) | Visualiza parÃ¢metros nÃ£o sensÃ­veis do seu conglomerado |
| Operador | âŒ NÃ£o | Sem acesso |
| UsuÃ¡rio Final | âŒ NÃ£o | Sem acesso |

**ValidaÃ§Ã£o de Isolamento Multi-Tenant**:
```csharp
public async Task<List<ParametroDto>> Listar(ParametroFiltroDto filtro, Guid userId)
{
    var usuario = await _usuarioRepository.ObterPorId(userId);

    var query = _context.SistemaParametro
        .Where(p => p.FlExcluido == false);

    // Filtrar por conglomerado (exceto super admin)
    if (!usuario.FlSuperAdmin)
    {
        query = query.Where(p => p.IdConglomerado == usuario.IdConglomerado);
    }

    // Ocultar parÃ¢metros sensÃ­veis para nÃ£o-admins
    if (!usuario.FlAdministrador)
    {
        query = query.Where(p => p.FlSensivel == false);
    }

    return await query.ToListAsync();
}
```

---

## ğŸ–¥ï¸ Interface de UsuÃ¡rio (Mockup)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ  Dashboard > Sistema > ConfiguraÃ§Ãµes > ParÃ¢metros                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  ğŸ“‹ ParÃ¢metros do Sistema                                     [+ Novo]    â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ” Pesquisar...                                                 â”‚   â”‚
â”‚  â”‚ ğŸ“‚ Categoria: [Todas â–¼]  ğŸ“Š Tipo: [Todos â–¼]  ğŸ”„ Atualizar      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Categoria    CÃ³digo           Nome             Tipo      Valor   â”‚âš™ï¸  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ ğŸ” SeguranÃ§a SMTP_HOST       Servidor SMTP    String    smtp...  â”‚ğŸ‘ï¸ğŸ“â”‚
â”‚  â”‚ ğŸ” SeguranÃ§a SMTP_PASSWORD   Senha SMTP       String    ******** â”‚ğŸ‘ï¸ğŸš«â”‚
â”‚  â”‚ âš™ï¸ Sistema   MAX_LOGIN_TRIES Tentativas Login Integer   5        â”‚ğŸ‘ï¸ğŸš«â”‚
â”‚  â”‚ ğŸ“§ Email     EMAIL_TIMEOUT   Timeout Email    Integer   30       â”‚ğŸ‘ï¸ğŸ“â”‚
â”‚  â”‚ ...                                                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â”‚  ğŸ“Š Total: 142 parÃ¢metros  |  PÃ¡gina: [â—€] 1 2 3 ... 15 [â–¶]  [50 â–¼]     â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Legenda:
ğŸ‘ï¸ = Visualizar Detalhes
ğŸ“ = Editar
ğŸš« = NÃ£o EditÃ¡vel (Sistema)
â±ï¸ = HistÃ³rico de AlteraÃ§Ãµes
```

---

## ğŸ”— APIs REST

### GET /api/parametros

**AutenticaÃ§Ã£o**: Bearer Token JWT
**PermissÃ£o**: `SYS.PARAMETROS.READ`
**Atributo de AutorizaÃ§Ã£o**: `[RequiresPermission("SYS.PARAMETROS.READ")]`

**Query Parameters**:
```
?page=1
&pageSize=50
&categoria={id_categoria}
&tipoDado={String|Integer|Boolean|Decimal|Date|JSON}
&pesquisa={texto}
&ordenacao={campo}
&direcao={ASC|DESC}
```

**Response 200 OK**:
```json
{
  "data": [
    {
      "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
      "codigo": "SMTP_HOST",
      "nome": "Servidor SMTP",
      "descricao": "EndereÃ§o do servidor SMTP para envio de emails",
      "categoria": {
        "id": "...",
        "codigo": "SEGURANCA",
        "nome": "SeguranÃ§a"
      },
      "tipoDado": "String",
      "valorExibicao": "smtp.gmail.com",
      "flSensivel": false,
      "flSistema": false,
      "flAtivo": 1,
      "dtCriacao": "2025-01-15T10:30:00Z",
      "dtAlteracao": "2025-02-20T14:22:00Z"
    },
    {
      "id": "...",
      "codigo": "SMTP_PASSWORD",
      "nome": "Senha SMTP",
      "descricao": "Senha do servidor SMTP",
      "categoria": {...},
      "tipoDado": "String",
      "valorExibicao": "********",
      "flSensivel": true,
      "flSistema": false,
      "flAtivo": 1,
      "dtCriacao": "2025-01-15T10:30:00Z",
      "dtAlteracao": null
    }
  ],
  "pagination": {
    "page": 1,
    "pageSize": 50,
    "totalItems": 142,
    "totalPages": 3
  }
}
```

**Response 403 Forbidden**:
```json
{
  "error": "Forbidden",
  "message": "VocÃª nÃ£o possui permissÃ£o para visualizar parÃ¢metros do sistema"
}
```

---

## ğŸ§ª CenÃ¡rios de Teste

Este caso de uso possui os seguintes documentos de teste:

- **Backend**: [CN-UC00-listar-parametros.md](../Testes/Backend/CN-UC00-listar-parametros.md)
- **Sistema**: [CN-UC00-listar-parametros.md](../Testes/Sistema/CN-UC00-listar-parametros.md)

---

## ğŸ“š ReferÃªncias

- [RF-001: ParÃ¢metros e ConfiguraÃ§Ãµes do Sistema](../RF-001-Parametros-e-Configuracoes-do-Sistema.md)
- [MD-001: Modelo de Dados](../MD-001-Parametros-e-Configuracoes-do-Sistema.md)
- [UC01: Criar/Atualizar ParÃ¢metro](./UC01-criar-atualizar-parametro.md)

---

**Ãšltima AtualizaÃ§Ã£o**: 2025-11-04
**Status**: âœ… Pronto para ImplementaÃ§Ã£o

---

# UC01: Criar/Atualizar ParÃ¢metro do Sistema


---

## ğŸ“‹ InformaÃ§Ãµes Gerais

### DescriÃ§Ã£o
Este caso de uso permite que administradores do sistema criem novos parÃ¢metros de configuraÃ§Ã£o ou atualizem parÃ¢metros existentes. O formulÃ¡rio suporta validaÃ§Ã£o em tempo real, seleÃ§Ã£o de tipo de dado, configuraÃ§Ã£o de validaÃ§Ãµes (regex, min/max) e marcaÃ§Ã£o de parÃ¢metros sensÃ­veis que serÃ£o criptografados automaticamente.

### Atores
- **Administrador do Sistema**: UsuÃ¡rio com permissÃ£o para criar e editar todos os parÃ¢metros
- **Administrador do Conglomerado**: UsuÃ¡rio com permissÃ£o para criar/editar parÃ¢metros de seu conglomerado

### PrÃ©-condiÃ§Ãµes
1. UsuÃ¡rio deve estar autenticado no sistema
2. **UsuÃ¡rio deve ter permissÃ£o `SYS.PARAMETROS.CREATE` (para criar) ou `SYS.PARAMETROS.UPDATE` (para editar)** (verificaÃ§Ã£o via Central de Funcionalidades)
3. UsuÃ¡rio deve ter perfil ativo
4. SessÃ£o vÃ¡lida e nÃ£o expirada
5. Sistema deve ter ao menos uma categoria de parÃ¢metros cadastrada
6. Para ediÃ§Ã£o: ParÃ¢metro nÃ£o pode ser de sistema (`Fl_Sistema = 0`)

### PÃ³s-condiÃ§Ãµes
**Sucesso**:
- ParÃ¢metro Ã© criado/atualizado no banco de dados
- Cache Redis Ã© invalidado para forÃ§ar recarga
- Registro de auditoria Ã© criado em `Sistema_Parametro_Historico`
- UsuÃ¡rio Ã© redirecionado para listagem com mensagem de sucesso
- Valores sensÃ­veis sÃ£o criptografados automaticamente

**Falha**:
- Mensagem de erro Ã© exibida explicando o motivo
- Dados do formulÃ¡rio sÃ£o preservados
- Sistema permanece na tela de ediÃ§Ã£o

---

## ğŸ¯ Fluxo Principal

### FP-01: Criar Novo ParÃ¢metro

1. **UsuÃ¡rio** acessa tela de listagem e clica em botÃ£o "Novo ParÃ¢metro"
2. **Sistema** verifica permissÃ£o `SYS.PARAMETROS.CREATE`
3. **Sistema** exibe formulÃ¡rio em branco com campos:
   - Conglomerado (dropdown - prÃ©-selecionado com conglomerado do usuÃ¡rio)
   - Categoria (dropdown obrigatÃ³rio)
   - CÃ³digo do ParÃ¢metro (text input obrigatÃ³rio)
   - Nome do ParÃ¢metro (text input obrigatÃ³rio)
   - DescriÃ§Ã£o (textarea opcional)
   - Tipo de Dado (dropdown obrigatÃ³rio: String, Integer, Decimal, Boolean, Date, JSON)
   - Valor (input dinÃ¢mico baseado no tipo)
   - Valor PadrÃ£o (input dinÃ¢mico)
   - ValidaÃ§Ã£o Regex (text input opcional)
   - Valor MÃ­nimo (number input condicional)
   - Valor MÃ¡ximo (number input condicional)
   - OpÃ§Ãµes VÃ¡lidas (textarea JSON condicional)
   - ObrigatÃ³rio (checkbox)
   - SensÃ­vel (checkbox)
   - Somente Leitura (checkbox)
4. **UsuÃ¡rio** preenche campos obrigatÃ³rios
5. **Sistema** valida em tempo real:
   - CÃ³digo nÃ£o pode conter espaÃ§os
   - CÃ³digo deve ter formato: `[A-Z_]+`
   - Valor deve ser compatÃ­vel com tipo de dado
   - Regex deve ser vÃ¡lido (se preenchido)
   - OpÃ§Ãµes vÃ¡lidas devem ser JSON array (se preenchido)
6. **UsuÃ¡rio** clica em botÃ£o "Salvar"
7. **Sistema** valida todos os campos no backend
8. **Sistema** verifica unicidade do cÃ³digo por conglomerado
9. **Sistema** criptografa valor se `Fl_Sensivel = 1`
10. **Sistema** insere registro em `Sistema_Parametro`
11. **Sistema** registra auditoria em `Sistema_Parametro_Historico`:
    - Tipo_Operacao = 'CREATE'
    - Dados_Novos = JSON completo do parÃ¢metro
    - IP e User-Agent do usuÃ¡rio
12. **Sistema** invalida cache Redis (key: `parametros:conglomerado:{id}:*`)
13. **Sistema** exibe mensagem de sucesso
14. **Sistema** redireciona para listagem
15. **Caso de uso** encerra

**Regras de NegÃ³cio Aplicadas**:
- **RN-CFG-001-01**: CÃ³digo Ãšnico de ParÃ¢metro
- **RN-CFG-001-02**: ValidaÃ§Ã£o por Tipo de Dado
- **RN-CFG-001-04**: Criptografia de Dados SensÃ­veis
- **RN-CFG-001-14**: Isolamento Multi-tenancy

---

### FP-02: Atualizar ParÃ¢metro Existente

1. **UsuÃ¡rio** acessa tela de listagem e clica em Ã­cone "Editar" de um parÃ¢metro
2. **Sistema** verifica permissÃ£o `SYS.PARAMETROS.UPDATE`
3. **Sistema** verifica se `Fl_Sistema = 0` (nÃ£o Ã© parÃ¢metro de sistema)
4. **Sistema** carrega dados do parÃ¢metro do banco
5. **Sistema** descriptografa valor se `Fl_Sensivel = 1` (somente para exibiÃ§Ã£o)
6. **Sistema** exibe formulÃ¡rio preenchido com dados atuais
7. **Sistema** desabilita campo "CÃ³digo" (nÃ£o pode ser alterado)
8. **Sistema** desabilita campo "Tipo de Dado" (nÃ£o pode ser alterado)
9. **UsuÃ¡rio** modifica campos permitidos
10. **Sistema** valida mudanÃ§as em tempo real
11. **UsuÃ¡rio** clica em botÃ£o "Salvar"
12. **Sistema** valida todos os campos no backend
13. **Sistema** compara valores antigos vs novos para gerar diff
14. **Sistema** criptografa novo valor se `Fl_Sensivel = 1`
15. **Sistema** atualiza registro em `Sistema_Parametro`:
    - Atualiza campos modificados
    - Define `Id_Usuario_Alteracao` e `Dt_Alteracao`
16. **Sistema** registra auditoria em `Sistema_Parametro_Historico`:
    - Tipo_Operacao = 'UPDATE'
    - Dados_Anteriores = JSON com valores antigos
    - Dados_Novos = JSON com valores novos
    - IP e User-Agent do usuÃ¡rio
17. **Sistema** invalida cache Redis
18. **Sistema** exibe mensagem de sucesso
19. **Sistema** redireciona para listagem
20. **Caso de uso** encerra

**Regras de NegÃ³cio Aplicadas**:
- **RN-CFG-001-02**: ValidaÃ§Ã£o por Tipo de Dado
- **RN-CFG-001-03**: ParÃ¢metros de Sistema NÃ£o EditÃ¡veis
- **RN-CFG-001-04**: Criptografia de Dados SensÃ­veis
- **RN-CFG-001-06**: HistÃ³rico de AlteraÃ§Ãµes

---

## ğŸ”€ Fluxos Alternativos

### FA-01: MudanÃ§a de Tipo de Dado

1. No passo 4 do FP-01, **usuÃ¡rio** seleciona tipo de dado
2. **Sistema** ajusta campo "Valor" dinamicamente:
   - **String**: Text input com validaÃ§Ã£o de regex (se definido)
   - **Integer**: Number input sem decimais, com min/max
   - **Decimal**: Number input com 4 decimais, com min/max
   - **Boolean**: Checkbox ou toggle
   - **Date**: Date picker
   - **JSON**: Code editor com syntax highlighting
3. **Sistema** mostra/oculta campos condicionais:
   - Regex: VisÃ­vel apenas para String
   - Min/Max: VisÃ­vel para Integer, Decimal, Date
   - OpÃ§Ãµes VÃ¡lidas: VisÃ­vel para String, Integer
4. Retorna ao passo 5 do FP-01

### FA-02: Validar Regex em Tempo Real

1. No passo 5 do FP-01, **usuÃ¡rio** digita regex no campo "ValidaÃ§Ã£o Regex"
2. **Sistema** aguarda 500ms (debounce)
3. **Sistema** tenta compilar regex
4. **Sistema** testa regex contra valor atual do campo "Valor"
5. **Sistema** exibe indicador visual:
   - âœ… Verde: Regex vÃ¡lido e valor corresponde
   - âš ï¸ Amarelo: Regex vÃ¡lido mas valor nÃ£o corresponde
   - âŒ Vermelho: Regex invÃ¡lido
6. Continua no passo 5 do FP-01

### FA-03: Testar Valor Contra ValidaÃ§Ãµes

1. A qualquer momento, **usuÃ¡rio** clica em botÃ£o "Testar ValidaÃ§Ã£o"
2. **Sistema** aplica todas as validaÃ§Ãµes configuradas:
   - Regex (se definido)
   - Min/Max (se definido)
   - OpÃ§Ãµes VÃ¡lidas (se definido)
   - Tipo de dado
3. **Sistema** exibe modal com resultados:
   - Lista de validaÃ§Ãµes executadas
   - Status de cada validaÃ§Ã£o (âœ… Passou / âŒ Falhou)
   - Mensagem explicativa para falhas
4. **UsuÃ¡rio** fecha modal
5. Retorna ao formulÃ¡rio

### FA-04: Cancelar EdiÃ§Ã£o

1. A qualquer momento, **usuÃ¡rio** clica em botÃ£o "Cancelar"
2. **Sistema** verifica se hÃ¡ alteraÃ§Ãµes nÃ£o salvas
3. **Sistema** exibe confirmaÃ§Ã£o: "Descartar alteraÃ§Ãµes?"
4. **UsuÃ¡rio** confirma
5. **Sistema** redireciona para listagem sem salvar
6. **Caso de uso** encerra

### FA-05: Duplicar ParÃ¢metro

1. Em FP-02, **usuÃ¡rio** clica em botÃ£o "Duplicar" (Ã­cone de cÃ³pia)
2. **Sistema** carrega dados do parÃ¢metro atual
3. **Sistema** cria novo formulÃ¡rio com dados copiados
4. **Sistema** limpa campo "CÃ³digo" e adiciona sufixo "_COPIA"
5. **Sistema** habilita campo "CÃ³digo" para ediÃ§Ã£o
6. **Sistema** marca formulÃ¡rio como "CriaÃ§Ã£o" (nÃ£o atualizaÃ§Ã£o)
7. Continua no passo 4 do FP-01

### FA-06: Visualizar HistÃ³rico Durante EdiÃ§Ã£o

1. Em FP-02, **usuÃ¡rio** clica em tab "HistÃ³rico"
2. **Sistema** exibe timeline de alteraÃ§Ãµes ordenado por `Dt_Alteracao DESC`
3. Para cada entrada:
   - Data/Hora da alteraÃ§Ã£o
   - UsuÃ¡rio que alterou
   - Campos modificados (diff visual)
   - Valor anterior â†’ Valor novo
4. **UsuÃ¡rio** pode clicar em "Restaurar" para reverter para versÃ£o anterior
5. **Sistema** preenche formulÃ¡rio com valores da versÃ£o selecionada
6. **UsuÃ¡rio** retorna Ã  tab "Dados"
7. Continua em FP-02

---

## âš ï¸ Fluxos de ExceÃ§Ã£o

### FE-01: CÃ³digo Duplicado

1. No passo 8 do FP-01, **sistema** detecta que cÃ³digo jÃ¡ existe para o conglomerado
2. **Sistema** exibe erro no campo "CÃ³digo": "JÃ¡ existe um parÃ¢metro com este cÃ³digo"
3. **Sistema** sugere cÃ³digos alternativos baseados no digitado
4. **UsuÃ¡rio** altera cÃ³digo
5. Retorna ao passo 6 do FP-01

### FE-02: Valor InvÃ¡lido para Tipo de Dado

1. No passo 7 do FP-01, **sistema** detecta incompatibilidade de tipo
2. **Sistema** exibe erro no campo "Valor":
   - Integer: "Valor deve ser um nÃºmero inteiro"
   - Decimal: "Valor deve ser um nÃºmero decimal vÃ¡lido"
   - Date: "Valor deve ser uma data vÃ¡lida"
   - JSON: "Valor deve ser um JSON vÃ¡lido"
3. **Sistema** mantÃ©m foco no campo com erro
4. **UsuÃ¡rio** corrige valor
5. Retorna ao passo 7 do FP-01

### FE-03: Regex InvÃ¡lido

1. No passo 7 do FP-01, **sistema** detecta regex invÃ¡lido
2. **Sistema** exibe erro no campo "ValidaÃ§Ã£o Regex": "ExpressÃ£o regular invÃ¡lida: {erro}"
3. **Sistema** sugere exemplos de regex comuns (email, telefone, CPF)
4. **UsuÃ¡rio** corrige regex ou limpa campo
5. Retorna ao passo 7 do FP-01

### FE-04: Valor Fora do Intervalo Min/Max

1. No passo 7 do FP-01, **sistema** detecta valor fora do intervalo
2. **Sistema** exibe erro: "Valor deve estar entre {min} e {max}"
3. **Sistema** destaca campos "Valor", "Valor MÃ­nimo" e "Valor MÃ¡ximo"
4. **UsuÃ¡rio** ajusta valor ou limites
5. Retorna ao passo 7 do FP-01

### FE-05: JSON InvÃ¡lido em OpÃ§Ãµes VÃ¡lidas

1. No passo 7 do FP-01, **sistema** detecta JSON malformado
2. **Sistema** exibe erro no campo "OpÃ§Ãµes VÃ¡lidas": "JSON invÃ¡lido: {erro}"
3. **Sistema** mostra linha e coluna do erro
4. **Sistema** oferece botÃ£o "Formatar JSON" para corrigir automaticamente
5. **UsuÃ¡rio** corrige JSON manualmente ou clica em "Formatar"
6. Retorna ao passo 7 do FP-01

### FE-06: Tentativa de Editar ParÃ¢metro de Sistema

1. No passo 3 do FP-02, **sistema** detecta `Fl_Sistema = 1`
2. **Sistema** exibe modal de erro:
   - TÃ­tulo: "ParÃ¢metro de Sistema"
   - Mensagem: "Este parÃ¢metro Ã© crÃ­tico para o funcionamento do sistema e nÃ£o pode ser editado pela interface. Contacte o administrador."
   - BotÃ£o: "Entendi"
3. **UsuÃ¡rio** fecha modal
4. **Sistema** retorna para listagem
5. **Caso de uso** encerra com erro

### FE-07: UsuÃ¡rio Sem PermissÃ£o para Criar

1. No passo 2 do FP-01, **sistema** verifica que usuÃ¡rio nÃ£o possui permissÃ£o `SYS.PARAMETROS.CREATE`
2. **Sistema** registra tentativa de acesso nÃ£o autorizado em auditoria
3. **Sistema** exibe mensagem: "VocÃª nÃ£o possui permissÃ£o para criar parÃ¢metros"
4. **Sistema** redireciona para listagem
5. **Caso de uso** encerra com erro

### FE-08: UsuÃ¡rio Sem PermissÃ£o para Editar

1. No passo 2 do FP-02, **sistema** verifica que usuÃ¡rio nÃ£o possui permissÃ£o `SYS.PARAMETROS.UPDATE`
2. **Sistema** registra tentativa de acesso nÃ£o autorizado em auditoria
3. **Sistema** exibe mensagem: "VocÃª nÃ£o possui permissÃ£o para editar parÃ¢metros"
4. **Sistema** redireciona para listagem
5. **Caso de uso** encerra com erro

### FE-09: Erro ao Salvar no Banco de Dados

1. No passo 10 do FP-01 ou passo 15 do FP-02, **sistema** falha ao salvar
2. **Sistema** captura exceÃ§Ã£o e loga erro detalhado
3. **Sistema** faz rollback da transaÃ§Ã£o
4. **Sistema** exibe mensagem: "Erro ao salvar parÃ¢metro. Tente novamente."
5. **Sistema** preserva dados do formulÃ¡rio
6. **UsuÃ¡rio** pode tentar novamente ou cancelar
7. Retorna ao formulÃ¡rio

### FE-10: Cache Redis IndisponÃ­vel

1. No passo 12 do FP-01, **sistema** tenta invalidar cache mas Redis estÃ¡ offline
2. **Sistema** loga warning sobre cache indisponÃ­vel
3. **Sistema** continua operaÃ§Ã£o normalmente (banco de dados Ã© source of truth)
4. **Sistema** agenda job para invalidar cache quando Redis voltar
5. Continua no passo 13 do FP-01

---

## ğŸ“Š CritÃ©rios de AceitaÃ§Ã£o

### CA-01: FormulÃ¡rio DinÃ¢mico
- âœ… Campos de validaÃ§Ã£o aparecem/desaparecem conforme tipo de dado
- âœ… Campo "Valor" muda tipo de input conforme tipo de dado selecionado
- âœ… ValidaÃ§Ã£o em tempo real funciona com debounce de 500ms
- âœ… Indicadores visuais claros para validaÃ§Ãµes (âœ… âš ï¸ âŒ)

### CA-02: ValidaÃ§Ãµes
- âœ… CÃ³digo nÃ£o permite espaÃ§os ou caracteres especiais
- âœ… CÃ³digo Ã© Ãºnico por conglomerado
- âœ… Valor Ã© compatÃ­vel com tipo de dado
- âœ… Regex Ã© vÃ¡lido quando preenchido
- âœ… Min/Max sÃ£o respeitados
- âœ… JSON Ã© vÃ¡lido quando tipo Ã© JSON ou em OpÃ§Ãµes VÃ¡lidas

### CA-03: CriaÃ§Ã£o
- âœ… Novo parÃ¢metro Ã© criado em menos de 1 segundo
- âœ… Valores sensÃ­veis sÃ£o criptografados automaticamente
- âœ… Auditoria registra operaÃ§Ã£o com todos os dados
- âœ… Cache Ã© invalidado corretamente
- âœ… Mensagem de sucesso Ã© exibida

### CA-04: AtualizaÃ§Ã£o
- âœ… Campos "CÃ³digo" e "Tipo de Dado" sÃ£o desabilitados
- âœ… Diff Ã© calculado corretamente (anterior vs novo)
- âœ… HistÃ³rico mostra todas as alteraÃ§Ãµes
- âœ… ParÃ¢metros de sistema nÃ£o podem ser editados
- âœ… Auditoria registra valores antigos e novos

### CA-05: SeguranÃ§a
- âœ… PermissÃµes sÃ£o validadas no backend
- âœ… Valores sensÃ­veis nunca sÃ£o expostos descriptografados na API
- âœ… Tentativas de acesso nÃ£o autorizado sÃ£o auditadas
- âœ… Isolamento multi-tenant Ã© respeitado
- âœ… SQL Injection Ã© prevenido (queries parametrizadas)

### CA-06: Performance
- âœ… FormulÃ¡rio carrega em menos de 500ms
- âœ… ValidaÃ§Ãµes em tempo real nÃ£o travam interface
- âœ… Salvamento completo em menos de 2 segundos
- âœ… Cache Ã© invalidado de forma assÃ­ncrona

### CA-07: Usabilidade
- âœ… Mensagens de erro sÃ£o claras e acionÃ¡veis
- âœ… SugestÃµes de correÃ§Ã£o sÃ£o oferecidas quando possÃ­vel
- âœ… FormulÃ¡rio preserva dados em caso de erro
- âœ… Interface adapta para mobile
- âœ… Atalhos de teclado funcionam (Ctrl+S para salvar, Esc para cancelar)

---

## ğŸ”’ Regras de NegÃ³cio

### RN-UC01-01: CÃ³digo ImutÃ¡vel ApÃ³s CriaÃ§Ã£o
**DescriÃ§Ã£o**: O cÃ³digo do parÃ¢metro nÃ£o pode ser alterado apÃ³s criaÃ§Ã£o.

**ImplementaÃ§Ã£o**:
```typescript
// Frontend
if (this.isEditMode) {
  this.form.get('codigo').disable();
}
```

```csharp
// Backend
if (parametroExistente != null && dto.Codigo != parametroExistente.Codigo)
{
    throw new BusinessException("CÃ³digo do parÃ¢metro nÃ£o pode ser alterado");
}
```

### RN-UC01-02: Tipo de Dado ImutÃ¡vel
**DescriÃ§Ã£o**: O tipo de dado nÃ£o pode ser alterado apÃ³s criaÃ§Ã£o (evita inconsistÃªncias).

**Justificativa**: Mudar tipo de dado pode quebrar validaÃ§Ãµes, integraÃ§Ãµes e cÃ³digo que consome o parÃ¢metro.

**Alternativa**: Criar novo parÃ¢metro com tipo correto e deprecar o antigo.

### RN-UC01-03: ValidaÃ§Ã£o de Regex
**DescriÃ§Ã£o**: Se regex for informado, o valor atual deve corresponder ao padrÃ£o.

**ImplementaÃ§Ã£o**:
```csharp
if (!string.IsNullOrEmpty(dto.ValidationRegex))
{
    var regex = new Regex(dto.ValidationRegex);
    if (!regex.IsMatch(dto.Valor))
    {
        throw new BusinessException(
            $"Valor nÃ£o corresponde ao padrÃ£o esperado: {dto.ValidationRegex}"
        );
    }
}
```

### RN-UC01-04: ValidaÃ§Ã£o de Min/Max
**DescriÃ§Ã£o**: Para tipos numÃ©ricos e datas, valor deve estar entre min e max.

**ImplementaÃ§Ã£o**:
```csharp
if (dto.TipoDado == TipoDado.Integer)
{
    var valor = int.Parse(dto.Valor);
    if (dto.ValorMinimo.HasValue && valor < dto.ValorMinimo.Value)
        throw new BusinessException($"Valor deve ser maior ou igual a {dto.ValorMinimo}");
    if (dto.ValorMaximo.HasValue && valor > dto.ValorMaximo.Value)
        throw new BusinessException($"Valor deve ser menor ou igual a {dto.ValorMaximo}");
}
```

### RN-UC01-05: Criptografia AutomÃ¡tica
**DescriÃ§Ã£o**: Valores marcados como sensÃ­veis sÃ£o criptografados automaticamente antes de salvar.

**ImplementaÃ§Ã£o**:
```csharp
if (dto.FlSensivel)
{
    parametro.Valor = _encryptionService.Encrypt(dto.Valor, _configuration["Encryption:Key"]);
}
```

### RN-UC01-06: Auditoria de CriaÃ§Ã£o
**DescriÃ§Ã£o**: CriaÃ§Ã£o de parÃ¢metro registra todos os dados em histÃ³rico.

**ImplementaÃ§Ã£o**:
```csharp
await _historico.Adicionar(new SistemaParametroHistorico
{
    IdParametro = parametro.IdParametro,
    TipoOperacao = "CREATE",
    DadosNovos = JsonSerializer.Serialize(parametro),
    IdUsuario = userId,
    DtOperacao = DateTime.UtcNow,
    IpUsuario = ipAddress,
    UserAgent = userAgent
});
```

### RN-UC01-07: Auditoria de AtualizaÃ§Ã£o com Diff
**DescriÃ§Ã£o**: AtualizaÃ§Ã£o registra valores anteriores e novos para comparaÃ§Ã£o.

**ImplementaÃ§Ã£o**:
```csharp
var parametroAntigo = await _repository.ObterPorId(id);
var diff = CalcularDiff(parametroAntigo, parametroNovo);

await _historico.Adicionar(new SistemaParametroHistorico
{
    IdParametro = id,
    TipoOperacao = "UPDATE",
    DadosAnteriores = JsonSerializer.Serialize(parametroAntigo),
    DadosNovos = JsonSerializer.Serialize(parametroNovo),
    CamposAlterados = JsonSerializer.Serialize(diff),
    IdUsuario = userId,
    DtOperacao = DateTime.UtcNow,
    IpUsuario = ipAddress,
    UserAgent = userAgent
});
```

### RN-UC01-08: InvalidaÃ§Ã£o de Cache
**DescriÃ§Ã£o**: Cache Redis deve ser invalidado apÃ³s criar/atualizar parÃ¢metro.

**ImplementaÃ§Ã£o**:
```csharp
// Invalidar cache especÃ­fico do conglomerado
await _cache.RemoveAsync($"parametros:conglomerado:{parametro.IdConglomerado}:*");

// Invalidar cache especÃ­fico do parÃ¢metro
await _cache.RemoveAsync($"parametros:codigo:{parametro.CdParametro}");
```

### RN-UC01-09: VerificaÃ§Ã£o de PermissÃ£o de Acesso
**DescriÃ§Ã£o**: Sistema deve verificar permissÃ£o apropriada (CREATE ou UPDATE).

**Regra**:
1. Para criaÃ§Ã£o: verificar `SYS.PARAMETROS.CREATE`
2. Para ediÃ§Ã£o: verificar `SYS.PARAMETROS.UPDATE`
3. Consultar `Usuario_Perfil` e `Perfil_Funcionalidade`
4. Retornar HTTP 403 se usuÃ¡rio nÃ£o tiver acesso
5. Registrar tentativa nÃ£o autorizada em auditoria

---

## ğŸ”— IntegraÃ§Ãµes ObrigatÃ³rias

### Central de Funcionalidades

**Funcionalidade**: `FNC-SYS-001` - GestÃ£o de ParÃ¢metros do Sistema

**PermissÃµes Requeridas**:
- `SYS.PARAMETROS.CREATE` - Para criar novos parÃ¢metros
- `SYS.PARAMETROS.UPDATE` - Para editar parÃ¢metros existentes

**ValidaÃ§Ã£o no Backend**:
```csharp
// CriaÃ§Ã£o
[HttpPost]
[Authorize]
[RequiresPermission("SYS.PARAMETROS.CREATE")]
public async Task<IActionResult> Criar([FromBody] CriarParametroDto dto)
{
    var parametro = await _parametroService.Criar(dto, User.GetUserId());
    return CreatedAtAction(nameof(ObterPorId), new { id = parametro.Id }, parametro);
}

// AtualizaÃ§Ã£o
[HttpPut("{id}")]
[Authorize]
[RequiresPermission("SYS.PARAMETROS.UPDATE")]
public async Task<IActionResult> Atualizar(Guid id, [FromBody] AtualizarParametroDto dto)
{
    var parametro = await _parametroService.Atualizar(id, dto, User.GetUserId());
    return Ok(parametro);
}
```

**ValidaÃ§Ã£o no Frontend**:
```typescript
// Guard na rota de criaÃ§Ã£o
{
  path: 'parametros/novo',
  component: ParametroFormComponent,
  canActivate: [AuthGuard, PermissionGuard],
  data: { permission: 'SYS.PARAMETROS.CREATE' }
}

// Guard na rota de ediÃ§Ã£o
{
  path: 'parametros/:id/editar',
  component: ParametroFormComponent,
  canActivate: [AuthGuard, PermissionGuard],
  data: { permission: 'SYS.PARAMETROS.UPDATE' }
}

// Controle de exibiÃ§Ã£o de botÃµes
<button
  *hasPermission="'SYS.PARAMETROS.CREATE'"
  (click)="novoParametro()">
  {{ 'COMMON.BUTTONS.NEW' | translate }}
</button>

<button
  *hasPermission="'SYS.PARAMETROS.UPDATE'"
  (click)="editarParametro(parametro.id)">
  {{ 'COMMON.BUTTONS.EDIT' | translate }}
</button>
```

### InternacionalizaÃ§Ã£o

**Chaves de TraduÃ§Ã£o NecessÃ¡rias**:

| Chave | Contexto | Texto PT-BR |
|-------|----------|-------------|
| `PARAMETROS.FORM.TITLE_CREATE` | TÃ­tulo criaÃ§Ã£o | "Novo ParÃ¢metro" |
| `PARAMETROS.FORM.TITLE_EDIT` | TÃ­tulo ediÃ§Ã£o | "Editar ParÃ¢metro" |
| `PARAMETROS.FORM.TAB_DATA` | Tab dados | "Dados" |
| `PARAMETROS.FORM.TAB_HISTORY` | Tab histÃ³rico | "HistÃ³rico" |
| `PARAMETROS.FIELDS.CONGLOMERATE` | Label campo | "Conglomerado" |
| `PARAMETROS.FIELDS.CATEGORY` | Label campo | "Categoria" |
| `PARAMETROS.FIELDS.CODE` | Label campo | "CÃ³digo" |
| `PARAMETROS.FIELDS.NAME` | Label campo | "Nome" |
| `PARAMETROS.FIELDS.DESCRIPTION` | Label campo | "DescriÃ§Ã£o" |
| `PARAMETROS.FIELDS.DATA_TYPE` | Label campo | "Tipo de Dado" |
| `PARAMETROS.FIELDS.VALUE` | Label campo | "Valor" |
| `PARAMETROS.FIELDS.DEFAULT_VALUE` | Label campo | "Valor PadrÃ£o" |
| `PARAMETROS.FIELDS.VALIDATION_REGEX` | Label campo | "ValidaÃ§Ã£o (Regex)" |
| `PARAMETROS.FIELDS.MIN_VALUE` | Label campo | "Valor MÃ­nimo" |
| `PARAMETROS.FIELDS.MAX_VALUE` | Label campo | "Valor MÃ¡ximo" |
| `PARAMETROS.FIELDS.VALID_OPTIONS` | Label campo | "OpÃ§Ãµes VÃ¡lidas (JSON)" |
| `PARAMETROS.FIELDS.IS_REQUIRED` | Label checkbox | "ObrigatÃ³rio" |
| `PARAMETROS.FIELDS.IS_SENSITIVE` | Label checkbox | "SensÃ­vel (serÃ¡ criptografado)" |
| `PARAMETROS.FIELDS.IS_READONLY` | Label checkbox | "Somente Leitura" |
| `PARAMETROS.FORM.CODE_HINT` | Dica | "Use MAIÃšSCULAS e underscores (ex: MAX_LOGIN_TRIES)" |
| `PARAMETROS.FORM.REGEX_HINT` | Dica | "ExpressÃ£o regular para validar valor" |
| `PARAMETROS.FORM.OPTIONS_HINT` | Dica | "Array JSON de valores vÃ¡lidos (ex: [\"opcao1\", \"opcao2\"])" |
| `PARAMETROS.MESSAGES.CREATE_SUCCESS` | Sucesso | "ParÃ¢metro criado com sucesso" |
| `PARAMETROS.MESSAGES.UPDATE_SUCCESS` | Sucesso | "ParÃ¢metro atualizado com sucesso" |
| `PARAMETROS.MESSAGES.CREATE_ERROR` | Erro | "Erro ao criar parÃ¢metro" |
| `PARAMETROS.MESSAGES.UPDATE_ERROR` | Erro | "Erro ao atualizar parÃ¢metro" |
| `PARAMETROS.VALIDATION.CODE_REQUIRED` | ValidaÃ§Ã£o | "CÃ³digo Ã© obrigatÃ³rio" |
| `PARAMETROS.VALIDATION.CODE_FORMAT` | ValidaÃ§Ã£o | "CÃ³digo deve conter apenas letras maiÃºsculas, nÃºmeros e underscore" |
| `PARAMETROS.VALIDATION.CODE_DUPLICATE` | ValidaÃ§Ã£o | "JÃ¡ existe um parÃ¢metro com este cÃ³digo" |
| `PARAMETROS.VALIDATION.NAME_REQUIRED` | ValidaÃ§Ã£o | "Nome Ã© obrigatÃ³rio" |
| `PARAMETROS.VALIDATION.CATEGORY_REQUIRED` | ValidaÃ§Ã£o | "Categoria Ã© obrigatÃ³ria" |
| `PARAMETROS.VALIDATION.VALUE_REQUIRED` | ValidaÃ§Ã£o | "Valor Ã© obrigatÃ³rio" |
| `PARAMETROS.VALIDATION.REGEX_INVALID` | ValidaÃ§Ã£o | "ExpressÃ£o regular invÃ¡lida" |
| `PARAMETROS.VALIDATION.REGEX_NOMATCH` | ValidaÃ§Ã£o | "Valor nÃ£o corresponde ao padrÃ£o esperado" |
| `PARAMETROS.VALIDATION.JSON_INVALID` | ValidaÃ§Ã£o | "JSON invÃ¡lido" |
| `PARAMETROS.VALIDATION.VALUE_OUT_OF_RANGE` | ValidaÃ§Ã£o | "Valor deve estar entre {min} e {max}" |
| `PARAMETROS.FORM.SYSTEM_PARAMETER_ERROR` | Erro | "ParÃ¢metros de sistema nÃ£o podem ser editados" |
| `PARAMETROS.FORM.DISCARD_CHANGES` | ConfirmaÃ§Ã£o | "Descartar alteraÃ§Ãµes?" |
| `PARAMETROS.FORM.TEST_VALIDATION` | BotÃ£o | "Testar ValidaÃ§Ã£o" |
| `PARAMETROS.FORM.FORMAT_JSON` | BotÃ£o | "Formatar JSON" |
| `PARAMETROS.FORM.DUPLICATE` | BotÃ£o | "Duplicar" |
| `COMMON.BUTTONS.SAVE` | BotÃ£o | "Salvar" |
| `COMMON.BUTTONS.CANCEL` | BotÃ£o | "Cancelar" |

**Arquivo**: `src/assets/i18n/pt-BR.json`
**SeÃ§Ã£o**: `PARAMETROS`

**Uso no CÃ³digo**:
```typescript
export class ParametroFormComponent implements OnInit {
  constructor(
    private translate: TranslateService,
    private parametroService: ParametroService,
    private toastr: ToastrService,
    private route: ActivatedRoute,
    private router: Router
  ) {}

  ngOnInit() {
    this.isEditMode = !!this.route.snapshot.params['id'];
    this.title = this.isEditMode
      ? this.translate.instant('PARAMETROS.FORM.TITLE_EDIT')
      : this.translate.instant('PARAMETROS.FORM.TITLE_CREATE');

    if (this.isEditMode) {
      this.loadParametro();
    }
  }

  onSubmit() {
    if (this.form.invalid) {
      this.toastr.error(
        this.translate.instant('COMMON.VALIDATION.FORM_INVALID')
      );
      return;
    }

    const action = this.isEditMode
      ? this.parametroService.atualizar(this.parametroId, this.form.value)
      : this.parametroService.criar(this.form.value);

    action.subscribe({
      next: () => {
        const message = this.isEditMode
          ? 'PARAMETROS.MESSAGES.UPDATE_SUCCESS'
          : 'PARAMETROS.MESSAGES.CREATE_SUCCESS';
        this.toastr.success(this.translate.instant(message));
        this.router.navigate(['/parametros']);
      },
      error: (err) => {
        const message = this.isEditMode
          ? 'PARAMETROS.MESSAGES.UPDATE_ERROR'
          : 'PARAMETROS.MESSAGES.CREATE_ERROR';
        this.toastr.error(this.translate.instant(message));
      }
    });
  }
}
```

```html
<h1>{{ title }}</h1>

<form [formGroup]="form" (ngSubmit)="onSubmit()">
  <div class="form-group">
    <label>{{ 'PARAMETROS.FIELDS.CODE' | translate }}*</label>
    <input formControlName="codigo" [readonly]="isEditMode" />
    <small class="hint">{{ 'PARAMETROS.FORM.CODE_HINT' | translate }}</small>
    <div *ngIf="form.get('codigo').errors?.required" class="error">
      {{ 'PARAMETROS.VALIDATION.CODE_REQUIRED' | translate }}
    </div>
    <div *ngIf="form.get('codigo').errors?.pattern" class="error">
      {{ 'PARAMETROS.VALIDATION.CODE_FORMAT' | translate }}
    </div>
  </div>

  <div class="form-group">
    <label>{{ 'PARAMETROS.FIELDS.NAME' | translate }}*</label>
    <input formControlName="nome" />
  </div>

  <div class="form-actions">
    <button type="submit" class="btn-primary">
      {{ 'COMMON.BUTTONS.SAVE' | translate }}
    </button>
    <button type="button" (click)="onCancel()" class="btn-secondary">
      {{ 'COMMON.BUTTONS.CANCEL' | translate }}
    </button>
  </div>
</form>
```

### Auditoria

**OperaÃ§Ãµes Auditadas**:

| OperaÃ§Ã£o | Tipo | Dados Registrados |
|----------|------|-------------------|
| Criar ParÃ¢metro | CREATE | Todos os campos do novo parÃ¢metro (valor sensÃ­vel mascarado no log) |
| Editar ParÃ¢metro | UPDATE | Diff completo (campos alterados com valor anterior vs novo) |
| Tentar Editar ParÃ¢metro de Sistema | ACCESS_DENIED | ID do parÃ¢metro, usuÃ¡rio, timestamp |

**Tabela de Auditoria**: `Sistema_Parametro_Historico`

**ImplementaÃ§Ã£o Backend**:
```csharp
// Service de ParÃ¢metro com Auditoria
public class ParametroService : IParametroService
{
    private readonly IControlITDbContext _context;
    private readonly IAuditoriaService _auditoriaService;
    private readonly IEncryptionService _encryptionService;
    private readonly IHttpContextAccessor _httpContext;

    public async Task<ParametroDto> Criar(CriarParametroDto dto, Guid userId)
    {
        // ValidaÃ§Ãµes
        await ValidarCodigoUnico(dto.Codigo, dto.IdConglomerado);
        ValidarTipoDado(dto.TipoDado, dto.Valor);
        ValidarRegex(dto.ValidationRegex, dto.Valor);

        // Criar entidade
        var parametro = new SistemaParametro
        {
            IdParametro = Guid.NewGuid(),
            IdConglomerado = dto.IdConglomerado,
            IdCategoria = dto.IdCategoria,
            CdParametro = dto.Codigo,
            NmParametro = dto.Nome,
            DsParametro = dto.Descricao,
            TipoDado = dto.TipoDado,
            Valor = dto.FlSensivel
                ? _encryptionService.Encrypt(dto.Valor)
                : dto.Valor,
            FlSensivel = dto.FlSensivel,
            FlObrigatorio = dto.FlObrigatorio,
            ValidationRegex = dto.ValidationRegex,
            ValorMinimo = dto.ValorMinimo,
            ValorMaximo = dto.ValorMaximo,
            IdUsuarioCriacao = userId,
            DtCriacao = DateTime.UtcNow
        };

        _context.SistemaParametro.Add(parametro);
        await _context.SaveChangesAsync();

        // Auditoria
        await _auditoriaService.Registrar(new AuditoriaDto
        {
            TipoOperacao = "CREATE",
            Entidade = "Sistema_Parametro",
            IdEntidade = parametro.IdParametro,
            DadosNovos = JsonSerializer.Serialize(new
            {
                parametro.IdParametro,
                parametro.CdParametro,
                parametro.NmParametro,
                Valor = parametro.FlSensivel ? "****" : parametro.Valor
            }),
            IdUsuario = userId,
            IpUsuario = _httpContext.HttpContext?.Connection.RemoteIpAddress?.ToString(),
            UserAgent = _httpContext.HttpContext?.Request.Headers["User-Agent"].ToString()
        });

        // Invalidar cache
        await InvalidarCache(parametro.IdConglomerado, parametro.CdParametro);

        return MapToDto(parametro);
    }

    public async Task<ParametroDto> Atualizar(Guid id, AtualizarParametroDto dto, Guid userId)
    {
        var parametro = await _context.SistemaParametro
            .FirstOrDefaultAsync(p => p.IdParametro == id && !p.FlExcluido);

        if (parametro == null)
            throw new NotFoundException("ParÃ¢metro nÃ£o encontrado");

        if (parametro.FlSistema)
            throw new BusinessException("ParÃ¢metros de sistema nÃ£o podem ser editados");

        // Guardar valores anteriores para diff
        var valoresAnteriores = new
        {
            parametro.NmParametro,
            parametro.DsParametro,
            Valor = parametro.FlSensivel ? "****" : parametro.Valor,
            parametro.FlObrigatorio,
            parametro.FlSensivel,
            parametro.ValidationRegex,
            parametro.ValorMinimo,
            parametro.ValorMaximo
        };

        // ValidaÃ§Ãµes
        ValidarTipoDado(parametro.TipoDado, dto.Valor);
        ValidarRegex(dto.ValidationRegex, dto.Valor);

        // Atualizar campos
        parametro.NmParametro = dto.Nome;
        parametro.DsParametro = dto.Descricao;
        parametro.Valor = dto.FlSensivel
            ? _encryptionService.Encrypt(dto.Valor)
            : dto.Valor;
        parametro.FlObrigatorio = dto.FlObrigatorio;
        parametro.FlSensivel = dto.FlSensivel;
        parametro.ValidationRegex = dto.ValidationRegex;
        parametro.ValorMinimo = dto.ValorMinimo;
        parametro.ValorMaximo = dto.ValorMaximo;
        parametro.IdUsuarioAlteracao = userId;
        parametro.DtAlteracao = DateTime.UtcNow;

        await _context.SaveChangesAsync();

        // Auditoria com diff
        var valoresNovos = new
        {
            parametro.NmParametro,
            parametro.DsParametro,
            Valor = parametro.FlSensivel ? "****" : parametro.Valor,
            parametro.FlObrigatorio,
            parametro.FlSensivel,
            parametro.ValidationRegex,
            parametro.ValorMinimo,
            parametro.ValorMaximo
        };

        await _auditoriaService.Registrar(new AuditoriaDto
        {
            TipoOperacao = "UPDATE",
            Entidade = "Sistema_Parametro",
            IdEntidade = parametro.IdParametro,
            DadosAnteriores = JsonSerializer.Serialize(valoresAnteriores),
            DadosNovos = JsonSerializer.Serialize(valoresNovos),
            IdUsuario = userId,
            IpUsuario = _httpContext.HttpContext?.Connection.RemoteIpAddress?.ToString(),
            UserAgent = _httpContext.HttpContext?.Request.Headers["User-Agent"].ToString()
        });

        // Invalidar cache
        await InvalidarCache(parametro.IdConglomerado, parametro.CdParametro);

        return MapToDto(parametro);
    }

    private async Task InvalidarCache(Guid? idConglomerado, string codigo)
    {
        try
        {
            await _cache.RemoveAsync($"parametros:conglomerado:{idConglomerado}:*");
            await _cache.RemoveAsync($"parametros:codigo:{codigo}");
        }
        catch (Exception ex)
        {
            _logger.LogWarning(ex, "Falha ao invalidar cache Redis");
        }
    }
}
```

### Controle de Acesso

**Perfis com Acesso a este Caso de Uso**:

| Perfil | Pode Criar? | Pode Editar? | RestriÃ§Ãµes |
|--------|-------------|--------------|------------|
| Super Administrador | âœ… Sim | âœ… Sim | Sem restriÃ§Ãµes (inclusive parÃ¢metros globais) |
| Administrador de Sistema | âœ… Sim | âœ… Sim | Apenas parÃ¢metros do seu conglomerado |
| Administrador de TI | âœ… Sim | âœ… Sim | Apenas parÃ¢metros do seu conglomerado |
| Gerente de OperaÃ§Ãµes | âŒ NÃ£o | âŒ NÃ£o | Somente leitura |
| Auditor | âŒ NÃ£o | âŒ NÃ£o | Somente leitura |
| Operador | âŒ NÃ£o | âŒ NÃ£o | Sem acesso |
| UsuÃ¡rio Final | âŒ NÃ£o | âŒ NÃ£o | Sem acesso |

**ValidaÃ§Ã£o de Isolamento Multi-Tenant**:
```csharp
public async Task<ParametroDto> Criar(CriarParametroDto dto, Guid userId)
{
    var usuario = await _usuarioRepository.ObterPorId(userId);

    // Validar isolamento: usuÃ¡rio sÃ³ pode criar parÃ¢metros do seu conglomerado
    if (!usuario.FlSuperAdmin && dto.IdConglomerado != usuario.IdConglomerado)
    {
        await _auditoriaService.RegistrarAcessoNegado(
            userId,
            "SYS.PARAMETROS.CREATE",
            "Tentativa de criar parÃ¢metro em conglomerado diferente"
        );
        throw new ForbiddenException("VocÃª nÃ£o pode criar parÃ¢metros para outro conglomerado");
    }

    // LÃ³gica de criaÃ§Ã£o...
}

public async Task<ParametroDto> Atualizar(Guid id, AtualizarParametroDto dto, Guid userId)
{
    var usuario = await _usuarioRepository.ObterPorId(userId);
    var parametro = await _repository.ObterPorId(id);

    // Validar isolamento: usuÃ¡rio sÃ³ pode editar parÃ¢metros do seu conglomerado
    if (!usuario.FlSuperAdmin && parametro.IdConglomerado != usuario.IdConglomerado)
    {
        await _auditoriaService.RegistrarAcessoNegado(
            userId,
            "SYS.PARAMETROS.UPDATE",
            "Tentativa de editar parÃ¢metro de outro conglomerado"
        );
        throw new ForbiddenException("VocÃª nÃ£o pode editar parÃ¢metros de outro conglomerado");
    }

    // Validar se Ã© parÃ¢metro de sistema
    if (parametro.FlSistema)
    {
        await _auditoriaService.RegistrarAcessoNegado(
            userId,
            "SYS.PARAMETROS.UPDATE",
            "Tentativa de editar parÃ¢metro de sistema"
        );
        throw new BusinessException("ParÃ¢metros de sistema nÃ£o podem ser editados");
    }

    // LÃ³gica de atualizaÃ§Ã£o...
}
```

---

## ğŸ–¥ï¸ Interface de UsuÃ¡rio (Mockup)

### Tela de CriaÃ§Ã£o

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ  Dashboard > Sistema > ConfiguraÃ§Ãµes > ParÃ¢metros > Novo               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  âœ¨ Novo ParÃ¢metro                                                        â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“‚ Conglomerado *                                                 â”‚   â”‚
â”‚  â”‚ [Conglomerado XYZ â–¼]                                              â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚ ğŸ·ï¸ Categoria *                                                    â”‚   â”‚
â”‚  â”‚ [Sistema â–¼]                                                       â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚ ğŸ”‘ CÃ³digo *                                                       â”‚   â”‚
â”‚  â”‚ [MAX_LOGIN_TRIES________________]                                 â”‚   â”‚
â”‚  â”‚ â„¹ï¸ Use MAIÃšSCULAS e underscores (ex: MAX_LOGIN_TRIES)            â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚ ğŸ“ Nome *                                                         â”‚   â”‚
â”‚  â”‚ [MÃ¡ximo de Tentativas de Login___________]                       â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚ ğŸ“„ DescriÃ§Ã£o                                                      â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚ â”‚ NÃºmero mÃ¡ximo de tentativas de login antes de bloquear     â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ a conta temporariamente                                     â”‚  â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚ ğŸ”¢ Tipo de Dado *                                                 â”‚   â”‚
â”‚  â”‚ [Integer â–¼]                                                       â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚ ğŸ’¾ Valor *                                                        â”‚   â”‚
â”‚  â”‚ [5____] (nÃºmero inteiro)                                          â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚ ğŸ“Œ Valor PadrÃ£o                                                   â”‚   â”‚
â”‚  â”‚ [3____]                                                           â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚ â¬‡ï¸ Valor MÃ­nimo     â¬†ï¸ Valor MÃ¡ximo                               â”‚   â”‚
â”‚  â”‚ [1____]            [10___]                                        â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚ â˜‘ï¸ ObrigatÃ³rio     ğŸ”’ SensÃ­vel     ğŸ‘ï¸ Somente Leitura             â”‚   â”‚
â”‚  â”‚ â˜                 â˜                â˜                              â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â”‚  [ğŸ’¾ Salvar]  [âŒ Cancelar]                                               â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Tela de EdiÃ§Ã£o com HistÃ³rico

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ  Dashboard > Sistema > ConfiguraÃ§Ãµes > ParÃ¢metros > Editar             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  âœï¸ Editar ParÃ¢metro: MAX_LOGIN_TRIES                                    â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ [ğŸ“ Dados]  [ğŸ“œ HistÃ³rico]                                       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ”‘ CÃ³digo (nÃ£o editÃ¡vel)                                          â”‚   â”‚
â”‚  â”‚ [MAX_LOGIN_TRIES________________] ğŸ”’                              â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚ ğŸ”¢ Tipo de Dado (nÃ£o editÃ¡vel)                                    â”‚   â”‚
â”‚  â”‚ [Integer] ğŸ”’                                                      â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚ ğŸ“ Nome *                                                         â”‚   â”‚
â”‚  â”‚ [MÃ¡ximo de Tentativas de Login___________]                       â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚ ğŸ’¾ Valor *                                                        â”‚   â”‚
â”‚  â”‚ [5____] âœ…                                                        â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚ â¬‡ï¸ Valor MÃ­nimo     â¬†ï¸ Valor MÃ¡ximo                               â”‚   â”‚
â”‚  â”‚ [1____]            [10___]                                        â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚ â˜‘ï¸ ObrigatÃ³rio     ğŸ”’ SensÃ­vel     ğŸ‘ï¸ Somente Leitura             â”‚   â”‚
â”‚  â”‚ â˜‘                 â˜                â˜                              â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â”‚  [ğŸ’¾ Salvar]  [ğŸ“‹ Duplicar]  [âŒ Cancelar]                                â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

HistÃ³rico (quando tab HistÃ³rico for clicada):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“œ HistÃ³rico de AlteraÃ§Ãµes                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚ â”Œâ”€ 2025-11-03 14:32:15 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ğŸ‘¤ Admin Sistema (admin@example.com)                               â”‚   â”‚
â”‚ â”‚ ğŸŒ IP: 192.168.1.100                                                â”‚   â”‚
â”‚ â”‚                                                                      â”‚   â”‚
â”‚ â”‚ Valor: 3 â†’ 5                                                        â”‚   â”‚
â”‚ â”‚ Motivo: Aumentar seguranÃ§a apÃ³s tentativas de invasÃ£o              â”‚   â”‚
â”‚ â”‚                                                                      â”‚   â”‚
â”‚ â”‚ [â†©ï¸ Restaurar esta versÃ£o]                                          â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â”‚ â”Œâ”€ 2025-11-01 10:15:42 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ğŸ‘¤ JoÃ£o Silva (joao.silva@example.com)                             â”‚   â”‚
â”‚ â”‚ ğŸŒ IP: 192.168.1.50                                                 â”‚   â”‚
â”‚ â”‚                                                                      â”‚   â”‚
â”‚ â”‚ Valor: 5 â†’ 3                                                        â”‚   â”‚
â”‚ â”‚ Valor MÃ­nimo: 3 â†’ 1                                                 â”‚   â”‚
â”‚ â”‚                                                                      â”‚   â”‚
â”‚ â”‚ [â†©ï¸ Restaurar esta versÃ£o]                                          â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â”‚ â”Œâ”€ 2025-10-28 09:00:00 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ğŸ‘¤ Sistema (system@icontrolit.com)                                  â”‚   â”‚
â”‚ â”‚ ğŸŒ IP: 127.0.0.1                                                    â”‚   â”‚
â”‚ â”‚                                                                      â”‚   â”‚
â”‚ â”‚ âœ¨ ParÃ¢metro criado                                                 â”‚   â”‚
â”‚ â”‚ Valor inicial: 5                                                    â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”— APIs REST

### POST /api/parametros

**AutenticaÃ§Ã£o**: Bearer Token JWT
**PermissÃ£o**: `SYS.PARAMETROS.CREATE`
**Atributo de AutorizaÃ§Ã£o**: `[RequiresPermission("SYS.PARAMETROS.CREATE")]`

**Request Body**:
```json
{
  "idConglomerado": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "idCategoria": "7ca85f64-5717-4562-b3fc-2c963f66afa6",
  "codigo": "MAX_LOGIN_TRIES",
  "nome": "MÃ¡ximo de Tentativas de Login",
  "descricao": "NÃºmero mÃ¡ximo de tentativas antes de bloquear conta",
  "tipoDado": "Integer",
  "valor": "5",
  "valorPadrao": "3",
  "validationRegex": null,
  "valorMinimo": 1,
  "valorMaximo": 10,
  "opcoesValidas": null,
  "flObrigatorio": true,
  "flSensivel": false,
  "flSomenteLeitura": false
}
```

**Response 201 Created**:
```json
{
  "id": "9fa85f64-5717-4562-b3fc-2c963f66afa6",
  "codigo": "MAX_LOGIN_TRIES",
  "nome": "MÃ¡ximo de Tentativas de Login",
  "categoria": {
    "id": "7ca85f64-5717-4562-b3fc-2c963f66afa6",
    "nome": "Sistema"
  },
  "tipoDado": "Integer",
  "valorExibicao": "5",
  "flSensivel": false,
  "flSistema": false,
  "flObrigatorio": true,
  "dtCriacao": "2025-11-04T10:30:00Z"
}
```

**Response 400 Bad Request** (CÃ³digo duplicado):
```json
{
  "error": "ValidationError",
  "message": "JÃ¡ existe um parÃ¢metro com este cÃ³digo",
  "field": "codigo",
  "suggestedAlternatives": [
    "MAX_LOGIN_TRIES_V2",
    "MAX_LOGIN_ATTEMPTS"
  ]
}
```

**Response 403 Forbidden** (Sem permissÃ£o):
```json
{
  "error": "Acesso negado",
  "message": "VocÃª nÃ£o possui permissÃ£o para criar parÃ¢metros",
  "requiredPermission": "SYS.PARAMETROS.CREATE",
  "code": "INSUFFICIENT_PERMISSIONS"
}
```

---

### PUT /api/parametros/{id}

**AutenticaÃ§Ã£o**: Bearer Token JWT
**PermissÃ£o**: `SYS.PARAMETROS.UPDATE`
**Atributo de AutorizaÃ§Ã£o**: `[RequiresPermission("SYS.PARAMETROS.UPDATE")]`

**Path Parameters**:
- `id` (GUID): ID do parÃ¢metro

**Request Body**:
```json
{
  "nome": "MÃ¡ximo de Tentativas de Login",
  "descricao": "NÃºmero mÃ¡ximo de tentativas antes de bloquear conta temporariamente",
  "valor": "3",
  "valorPadrao": "3",
  "validationRegex": null,
  "valorMinimo": 1,
  "valorMaximo": 10,
  "flObrigatorio": true,
  "flSensivel": false,
  "flSomenteLeitura": false,
  "motivoAlteracao": "Reduzir para aumentar seguranÃ§a"
}
```

**Response 200 OK**:
```json
{
  "id": "9fa85f64-5717-4562-b3fc-2c963f66afa6",
  "codigo": "MAX_LOGIN_TRIES",
  "nome": "MÃ¡ximo de Tentativas de Login",
  "categoria": {
    "id": "7ca85f64-5717-4562-b3fc-2c963f66afa6",
    "nome": "Sistema"
  },
  "tipoDado": "Integer",
  "valorExibicao": "3",
  "flSensivel": false,
  "flSistema": false,
  "flObrigatorio": true,
  "dtCriacao": "2025-11-03T10:30:00Z",
  "dtAlteracao": "2025-11-04T14:22:00Z",
  "usuarioAlteracao": {
    "id": "1fa85f64-5717-4562-b3fc-2c963f66afa6",
    "nome": "Admin Sistema"
  }
}
```

**Response 400 Bad Request** (Valor invÃ¡lido):
```json
{
  "error": "ValidationError",
  "message": "Valor deve estar entre 1 e 10",
  "field": "valor",
  "currentValue": "15",
  "constraints": {
    "min": 1,
    "max": 10
  }
}
```

**Response 403 Forbidden** (ParÃ¢metro de sistema):
```json
{
  "error": "BusinessError",
  "message": "ParÃ¢metros de sistema nÃ£o podem ser editados pela interface",
  "code": "SYSTEM_PARAMETER_NOT_EDITABLE"
}
```

**Response 404 Not Found**:
```json
{
  "error": "NotFound",
  "message": "ParÃ¢metro nÃ£o encontrado",
  "id": "9fa85f64-5717-4562-b3fc-2c963f66afa6"
}
```

---

### GET /api/parametros/{id}/historico

**AutenticaÃ§Ã£o**: Bearer Token JWT
**PermissÃ£o**: `SYS.PARAMETROS.READ`

**Path Parameters**:
- `id` (GUID): ID do parÃ¢metro

**Query Parameters**:
```
?page=1
&pageSize=10
```

**Response 200 OK**:
```json
{
  "data": [
    {
      "id": "1aa85f64-5717-4562-b3fc-2c963f66afa6",
      "tipoOperacao": "UPDATE",
      "dtOperacao": "2025-11-04T14:22:00Z",
      "usuario": {
        "id": "1fa85f64-5717-4562-b3fc-2c963f66afa6",
        "nome": "Admin Sistema",
        "email": "admin@example.com"
      },
      "ipUsuario": "192.168.1.100",
      "camposAlterados": [
        {
          "campo": "Valor",
          "valorAnterior": "5",
          "valorNovo": "3"
        }
      ],
      "motivoAlteracao": "Reduzir para aumentar seguranÃ§a"
    },
    {
      "id": "2aa85f64-5717-4562-b3fc-2c963f66afa6",
      "tipoOperacao": "CREATE",
      "dtOperacao": "2025-11-03T10:30:00Z",
      "usuario": {
        "id": "2fa85f64-5717-4562-b3fc-2c963f66afa6",
        "nome": "Sistema",
        "email": "system@icontrolit.com"
      },
      "ipUsuario": "127.0.0.1",
      "valorInicial": "5"
    }
  ],
  "pagination": {
    "page": 1,
    "pageSize": 10,
    "totalItems": 2,
    "totalPages": 1
  }
}
```

---

## ğŸ“š CenÃ¡rios de Teste Relacionados

- [CN-UC01 - CenÃ¡rios de Teste Backend](../Testes/Backend/CN-UC01-criar-atualizar-parametro.md)
- [CN-UC01 - CenÃ¡rios de Teste Sistema](../Testes/Sistema/CN-UC01-criar-atualizar-parametro.md)

## ğŸ“ Casos de Teste Relacionados

- [TC-UC01 - Casos de Teste Backend](../Testes/Backend/TC-UC01-criar-atualizar-parametro.md)
- [TC-UC01 - Casos de Teste Sistema](../Testes/Sistema/TC-UC01-criar-atualizar-parametro.md)

---

**Ãšltima AtualizaÃ§Ã£o**: 2025-11-04
**Autor**: Sistema de DocumentaÃ§Ã£o IControlIT
**Revisores**: Equipe de Arquitetura, Equipe de Desenvolvimento

---

# UC02: Visualizar Detalhes de ParÃ¢metro


---

## ğŸ“‹ InformaÃ§Ãµes Gerais

### DescriÃ§Ã£o
Este caso de uso permite que usuÃ¡rios autorizados visualizem todos os detalhes de um parÃ¢metro especÃ­fico do sistema, incluindo suas configuraÃ§Ãµes de validaÃ§Ã£o, histÃ³rico de alteraÃ§Ãµes, valores criptografados (se tiver permissÃ£o) e metadados de auditoria.

### Atores
- **Super Administrador**: Visualiza todos os detalhes, incluindo valores sensÃ­veis descriptografados
- **Administrador do Sistema**: Visualiza detalhes de parÃ¢metros do seu conglomerado
- **Administrador de TI**: Visualiza detalhes de parÃ¢metros do seu conglomerado
- **Auditor**: Visualiza detalhes exceto valores sensÃ­veis
- **Gerente de OperaÃ§Ãµes**: Visualiza detalhes exceto valores sensÃ­veis

### PrÃ©-condiÃ§Ãµes
1. UsuÃ¡rio deve estar autenticado no sistema
2. **UsuÃ¡rio deve ter permissÃ£o `SYS.PARAMETROS.READ`** (verificaÃ§Ã£o via Central de Funcionalidades)
3. UsuÃ¡rio deve ter perfil ativo
4. SessÃ£o vÃ¡lida e nÃ£o expirada
5. ParÃ¢metro deve existir e nÃ£o estar excluÃ­do (`Fl_Excluido = 0`)

### PÃ³s-condiÃ§Ãµes
**Sucesso**:
- UsuÃ¡rio visualiza todos os detalhes do parÃ¢metro
- Valores sensÃ­veis sÃ£o mascarados ou descriptografados conforme permissÃ£o
- Acesso Ã© registrado em auditoria (especialmente para parÃ¢metros sensÃ­veis)
- HistÃ³rico de alteraÃ§Ãµes Ã© exibido cronologicamente

**Falha**:
- Mensagem de erro Ã© exibida explicando o motivo
- UsuÃ¡rio Ã© redirecionado para listagem

---

## ğŸ¯ Fluxo Principal

### FP-01: Visualizar Detalhes Completos

1. **UsuÃ¡rio** acessa tela de listagem e clica em Ã­cone "Visualizar" (olho) de um parÃ¢metro
2. **Sistema** verifica permissÃ£o `SYS.PARAMETROS.READ`
3. **Sistema** carrega dados completos do parÃ¢metro do banco de dados
4. **Sistema** verifica nÃ­vel de acesso do usuÃ¡rio:
   - Super Admin: Pode ver valores sensÃ­veis descriptografados
   - Outros: Valores sensÃ­veis aparecem mascarados (******)
5. **Sistema** registra acesso em auditoria (especialmente se `Fl_Sensivel = 1`)
6. **Sistema** exibe modal/pÃ¡gina com abas:
   - **Tab "InformaÃ§Ãµes Gerais"**: Dados bÃ¡sicos do parÃ¢metro
   - **Tab "ValidaÃ§Ãµes"**: Regras de validaÃ§Ã£o configuradas
   - **Tab "HistÃ³rico"**: Timeline de todas as alteraÃ§Ãµes
   - **Tab "Metadados"**: InformaÃ§Ãµes de auditoria e sistema
7. **Sistema** carrega tab "InformaÃ§Ãµes Gerais" por padrÃ£o
8. **Sistema** exibe dados:
   - CÃ³digo do ParÃ¢metro
   - Nome
   - DescriÃ§Ã£o
   - Categoria
   - Tipo de Dado
   - Valor Atual (mascarado se sensÃ­vel e usuÃ¡rio sem permissÃ£o)
   - Valor PadrÃ£o
   - Status (Ativo/Inativo)
   - Flags (Sistema, ObrigatÃ³rio, SensÃ­vel, Somente Leitura)
9. **UsuÃ¡rio** navega entre abas para visualizar mais detalhes
10. **UsuÃ¡rio** pode exportar informaÃ§Ãµes para PDF
11. **UsuÃ¡rio** fecha modal
12. **Caso de uso** encerra

**Regras de NegÃ³cio Aplicadas**:
- **RN-CFG-001-04**: Valores sensÃ­veis mascarados para usuÃ¡rios sem permissÃ£o
- **RN-CFG-001-14**: Isolamento multi-tenancy
- **RN-UC02-01**: Auditoria de acesso a valores sensÃ­veis

---

## ğŸ”€ Fluxos Alternativos

### FA-01: Visualizar Tab "ValidaÃ§Ãµes"

1. No passo 9 do FP-01, **usuÃ¡rio** clica na tab "ValidaÃ§Ãµes"
2. **Sistema** exibe configuraÃ§Ãµes de validaÃ§Ã£o:
   - **ValidaÃ§Ã£o Regex**: ExpressÃ£o regular (se configurada)
   - **Valor MÃ­nimo**: Limite inferior (para nÃºmeros/datas)
   - **Valor MÃ¡ximo**: Limite superior (para nÃºmeros/datas)
   - **OpÃ§Ãµes VÃ¡lidas**: Array de valores permitidos (se configurado)
   - **Obrigatoriedade**: Se campo Ã© obrigatÃ³rio
3. **Sistema** exibe exemplos de valores vÃ¡lidos e invÃ¡lidos
4. **Sistema** oferece botÃ£o "Testar ValidaÃ§Ã£o"
5. Se **usuÃ¡rio** clicar em "Testar ValidaÃ§Ã£o":
   - **Sistema** exibe campo de entrada
   - **UsuÃ¡rio** digita valor de teste
   - **Sistema** aplica todas as validaÃ§Ãµes
   - **Sistema** exibe resultado: âœ… VÃ¡lido ou âŒ InvÃ¡lido com motivo
6. Continua no passo 9 do FP-01

### FA-02: Visualizar Tab "HistÃ³rico"

1. No passo 9 do FP-01, **usuÃ¡rio** clica na tab "HistÃ³rico"
2. **Sistema** carrega registros de `Sistema_Parametro_Historico`
3. **Sistema** exibe timeline ordenada por `Dt_Operacao DESC`
4. Para cada registro exibe:
   - Data e hora da operaÃ§Ã£o
   - Tipo de operaÃ§Ã£o (CREATE, UPDATE, DELETE, ACCESS)
   - UsuÃ¡rio que executou (nome, email, foto)
   - IP do usuÃ¡rio
   - User-Agent (navegador/dispositivo)
   - Campos alterados (para UPDATE):
     - Nome do campo
     - Valor anterior â†’ Valor novo
     - Diff visual (cores: vermelho para removido, verde para adicionado)
   - Motivo da alteraÃ§Ã£o (se informado)
5. **Sistema** destaca em amarelo acessos a valores sensÃ­veis (tipo ACCESS)
6. **Sistema** permite filtrar histÃ³rico:
   - Por tipo de operaÃ§Ã£o
   - Por perÃ­odo de data
   - Por usuÃ¡rio
7. **Sistema** oferece botÃ£o "Exportar HistÃ³rico" (CSV/PDF)
8. Continua no passo 9 do FP-01

### FA-03: Visualizar Tab "Metadados"

1. No passo 9 do FP-01, **usuÃ¡rio** clica na tab "Metadados"
2. **Sistema** exibe informaÃ§Ãµes tÃ©cnicas:
   - **ID**: GUID Ãºnico do parÃ¢metro
   - **Conglomerado**: Nome do conglomerado (ou "Global")
   - **Criado em**: Data/hora de criaÃ§Ã£o
   - **Criado por**: UsuÃ¡rio que criou
   - **Ãšltima alteraÃ§Ã£o**: Data/hora da Ãºltima modificaÃ§Ã£o
   - **Alterado por**: UsuÃ¡rio que fez Ãºltima modificaÃ§Ã£o
   -    - **Cache**: Status do cache (cached/not-cached)
   - **Cache Key**: Chave Redis utilizada
   - **Cache TTL**: Tempo restante atÃ© expiraÃ§Ã£o
   - **ReferÃªncias**: Onde o parÃ¢metro Ã© utilizado no sistema
3. **Sistema** exibe badges de status:
   - ğŸ”’ Sistema (se `Fl_Sistema = 1`)
   - ğŸ” SensÃ­vel (se `Fl_Sensivel = 1`)
   - âš ï¸ ObrigatÃ³rio (se `Fl_Obrigatorio = 1`)
   - ğŸ‘ï¸ Somente Leitura (se `Fl_SomenteLeitura = 1`)
4. Continua no passo 9 do FP-01

### FA-04: Descriptografar Valor SensÃ­vel (Super Admin)

1. No passo 8 do FP-01, **sistema** detecta que usuÃ¡rio Ã© Super Admin e parÃ¢metro Ã© sensÃ­vel
2. **Sistema** exibe valor mascarado (******) por padrÃ£o
3. **Sistema** exibe botÃ£o "ğŸ‘ï¸ Mostrar Valor" ao lado do valor
4. **UsuÃ¡rio** clica em "Mostrar Valor"
5. **Sistema** exibe modal de confirmaÃ§Ã£o:
   - "VocÃª estÃ¡ prestes a visualizar um valor sensÃ­vel. Esta aÃ§Ã£o serÃ¡ registrada em auditoria."
   - "Motivo do acesso (opcional): [__________]"
   - BotÃµes: [Confirmar] [Cancelar]
6. **UsuÃ¡rio** confirma (opcionalmente informa motivo)
7. **Sistema** descriptografa valor
8. **Sistema** exibe valor real por 30 segundos
9. **Sistema** registra acesso em auditoria:
   - Tipo_Operacao = 'ACCESS'
   - Id_Parametro
   - Motivo informado
   - IP e User-Agent
10. ApÃ³s 30 segundos, **sistema** oculta valor novamente automaticamente
11. Continua no passo 9 do FP-01

### FA-05: Comparar VersÃµes

1. No FA-02 (Tab HistÃ³rico), **usuÃ¡rio** seleciona duas versÃµes diferentes usando checkboxes
2. **Sistema** habilita botÃ£o "ğŸ”„ Comparar VersÃµes"
3. **UsuÃ¡rio** clica em "Comparar VersÃµes"
4. **Sistema** exibe modal com comparaÃ§Ã£o lado a lado:
   - Coluna esquerda: VersÃ£o mais antiga
   - Coluna direita: VersÃ£o mais recente
   - DiferenÃ§as destacadas em cores
5. **UsuÃ¡rio** fecha modal de comparaÃ§Ã£o
6. Retorna ao histÃ³rico (FA-02)

### FA-06: Exportar Detalhes para PDF

1. A qualquer momento, **usuÃ¡rio** clica em botÃ£o "ğŸ“„ Exportar PDF"
2. **Sistema** gera documento PDF com:
   - Logo do IControlIT
   - TÃ­tulo: "Detalhes do ParÃ¢metro: {CÃ³digo}"
   - Data/hora de geraÃ§Ã£o
   - Todas as abas (InformaÃ§Ãµes, ValidaÃ§Ãµes, HistÃ³rico, Metadados)
   - Valores sensÃ­veis aparecem mascarados no PDF
   - RodapÃ© com marca d'Ã¡gua de confidencialidade
3. **Sistema** registra exportaÃ§Ã£o em auditoria
4. **Sistema** inicia download do PDF
5. Continua no passo 9 do FP-01

### FA-07: Copiar CÃ³digo do ParÃ¢metro

1. A qualquer momento, **usuÃ¡rio** clica em Ã­cone de "copiar" ao lado do cÃ³digo
2. **Sistema** copia cÃ³digo para clipboard
3. **Sistema** exibe tooltip: "âœ… CÃ³digo copiado!"
4. Continua no passo 9 do FP-01

### FA-08: Ver Onde Ã© Usado

1. No FA-03 (Tab Metadados), **usuÃ¡rio** clica em "ğŸ“ Ver Onde Ã© Usado"
2. **Sistema** busca referÃªncias ao parÃ¢metro no cÃ³digo (anÃ¡lise estÃ¡tica)
3. **Sistema** exibe modal com lista de locais:
   - Arquivo de cÃ³digo
   - Linha
   - Trecho de cÃ³digo que usa o parÃ¢metro
4. **Sistema** mostra tambÃ©m integraÃ§Ãµes que consomem o parÃ¢metro via API
5. **UsuÃ¡rio** fecha modal
6. Retorna ao FA-03

---

## âš ï¸ Fluxos de ExceÃ§Ã£o

### FE-01: ParÃ¢metro NÃ£o Encontrado

1. No passo 3 do FP-01, **sistema** nÃ£o encontra parÃ¢metro com ID informado
2. **Sistema** exibe mensagem: "ParÃ¢metro nÃ£o encontrado. Pode ter sido excluÃ­do."
3. **Sistema** fecha modal automaticamente
4. **Sistema** retorna para listagem
5. **Caso de uso** encerra com erro

### FE-02: UsuÃ¡rio Sem PermissÃ£o

1. No passo 2 do FP-01, **sistema** detecta que usuÃ¡rio nÃ£o possui permissÃ£o `SYS.PARAMETROS.READ`
2. **Sistema** registra tentativa de acesso nÃ£o autorizado em auditoria
3. **Sistema** exibe mensagem: "VocÃª nÃ£o possui permissÃ£o para visualizar este parÃ¢metro"
4. **Sistema** redireciona para dashboard
5. **Caso de uso** encerra com erro

### FE-03: Acesso Cross-Tenant Negado

1. No passo 4 do FP-01, **sistema** detecta que parÃ¢metro pertence a outro conglomerado
2. **Sistema** verifica se usuÃ¡rio Ã© Super Admin:
   - Se sim: continua normalmente
   - Se nÃ£o: executa passos abaixo
3. **Sistema** registra tentativa de acesso cross-tenant em auditoria
4. **Sistema** exibe mensagem: "VocÃª nÃ£o tem acesso a parÃ¢metros de outro conglomerado"
5. **Sistema** retorna para listagem
6. **Caso de uso** encerra com erro

### FE-04: Erro ao Carregar Dados

1. No passo 3 do FP-01, **sistema** falha ao consultar banco de dados
2. **Sistema** loga erro detalhado
3. **Sistema** exibe mensagem: "Erro ao carregar detalhes do parÃ¢metro. Tente novamente."
4. **Sistema** oferece botÃ£o "ğŸ”„ Tentar Novamente"
5. **UsuÃ¡rio** pode tentar novamente ou fechar modal
6. **Caso de uso** encerra

### FE-05: Cache Redis IndisponÃ­vel

1. No FA-03, **sistema** tenta verificar status do cache mas Redis estÃ¡ offline
2. **Sistema** exibe em "Cache": "âŒ IndisponÃ­vel"
3. **Sistema** continua exibindo demais informaÃ§Ãµes normalmente
4. **Sistema** loga warning sobre cache offline
5. Continua no FA-03

### FE-06: HistÃ³rico Vazio

1. No FA-02, **sistema** nÃ£o encontra registros em `Sistema_Parametro_Historico`
2. **Sistema** exibe mensagem informativa: "Nenhum histÃ³rico disponÃ­vel para este parÃ¢metro"
3. **Sistema** sugere: "Este parÃ¢metro pode ter sido criado antes da implementaÃ§Ã£o do histÃ³rico"
4. Continua no passo 9 do FP-01

---

## ğŸ“Š CritÃ©rios de AceitaÃ§Ã£o

### CA-01: VisualizaÃ§Ã£o BÃ¡sica
- âœ… Modal/pÃ¡gina carrega em menos de 500ms
- âœ… Todas as informaÃ§Ãµes sÃ£o exibidas corretamente
- âœ… Valores sensÃ­veis sÃ£o mascarados por padrÃ£o
- âœ… Layout Ã© responsivo e adapta para mobile

### CA-02: Tabs
- âœ… NavegaÃ§Ã£o entre abas Ã© instantÃ¢nea (sem reload)
- âœ… Cada tab carrega seus dados sob demanda
- âœ… Estado da tab ativa persiste ao reabrir modal
- âœ… HistÃ³rico Ã© carregado com paginaÃ§Ã£o (10 por pÃ¡gina)

### CA-03: SeguranÃ§a
- âœ… Valores sensÃ­veis nunca sÃ£o expostos descriptografados sem permissÃ£o
- âœ… Acesso a valores sensÃ­veis Ã© auditado
- âœ… Isolamento multi-tenant Ã© respeitado rigorosamente
- âœ… Descriptografia requer confirmaÃ§Ã£o explÃ­cita (Super Admin)
- âœ… Valor descriptografado oculta automaticamente apÃ³s 30s

### CA-04: Auditoria
- âœ… Todo acesso a parÃ¢metros sensÃ­veis Ã© registrado
- âœ… HistÃ³rico mostra diff visual claro entre versÃµes
- âœ… ExportaÃ§Ãµes de dados sÃ£o auditadas
- âœ… Tentativas de acesso nÃ£o autorizado sÃ£o registradas

### CA-05: Usabilidade
- âœ… Interface Ã© intuitiva e clara
- âœ… Badges de status (Sistema, SensÃ­vel, etc.) sÃ£o visualmente distintos
- âœ… BotÃ£o "Copiar CÃ³digo" funciona em todos os navegadores
- âœ… ExportaÃ§Ã£o para PDF tem formataÃ§Ã£o profissional
- âœ… Tooltips explicativos em campos tÃ©cnicos

### CA-06: Performance
- âœ… Carregamento inicial em menos de 500ms
- âœ… Troca de abas em menos de 100ms
- âœ… HistÃ³rico com 1000+ entradas carrega sem travamento
- âœ… GeraÃ§Ã£o de PDF completa em menos de 3 segundos

---

## ğŸ”’ Regras de NegÃ³cio

### RN-UC02-01: Auditoria de Acesso a Valores SensÃ­veis
**DescriÃ§Ã£o**: Todo acesso a valores sensÃ­veis deve ser registrado em auditoria.

**ImplementaÃ§Ã£o**:
```csharp
if (parametro.FlSensivel)
{
    await _auditoriaService.Registrar(new AuditoriaDto
    {
        TipoOperacao = "ACCESS",
        Entidade = "Sistema_Parametro",
        IdEntidade = parametro.IdParametro,
        Descricao = $"Visualizou parÃ¢metro sensÃ­vel: {parametro.CdParametro}",
        Motivo = motivoAcesso, // Informado pelo usuÃ¡rio
        IdUsuario = userId,
        IpUsuario = ipAddress,
        UserAgent = userAgent
    });
}
```

### RN-UC02-02: Mascaramento de Valores SensÃ­veis
**DescriÃ§Ã£o**: Valores sensÃ­veis aparecem mascarados exceto para Super Admins que explicitamente descriptografarem.

**ImplementaÃ§Ã£o**:
```csharp
public ParametroDetalheDto ObterDetalhes(Guid id, Guid userId)
{
    var usuario = await _usuarioRepository.ObterPorId(userId);
    var parametro = await _repository.ObterPorId(id);

    var dto = MapToDto(parametro);

    if (parametro.FlSensivel && !usuario.FlSuperAdmin)
    {
        dto.ValorExibicao = "********";
        dto.ValorDescriptografado = null;
        dto.PodeDescriptografar = false;
    }
    else if (parametro.FlSensivel && usuario.FlSuperAdmin)
    {
        dto.ValorExibicao = "********";
        dto.ValorDescriptografado = null; // SÃ³ retorna apÃ³s confirmaÃ§Ã£o
        dto.PodeDescriptografar = true;
    }
    else
    {
        dto.ValorExibicao = parametro.Valor;
        dto.PodeDescriptografar = false;
    }

    return dto;
}
```

### RN-UC02-03: Descriptografia TemporÃ¡ria
**DescriÃ§Ã£o**: Valores descriptografados sÃ£o ocultados automaticamente apÃ³s 30 segundos.

**ImplementaÃ§Ã£o Frontend**:
```typescript
mostrarValorSensivel() {
  this.valorDescriptografado = this.parametroService
    .descriptografar(this.parametroId, this.motivoAcesso)
    .subscribe(valor => {
      this.valorExibido = valor;
      this.mostrandoValor = true;

      // Ocultar apÃ³s 30 segundos
      setTimeout(() => {
        this.valorExibido = '********';
        this.mostrandoValor = false;
      }, 30000);
    });
}
```

### RN-UC02-04: Isolamento Multi-Tenant
**DescriÃ§Ã£o**: UsuÃ¡rio sÃ³ pode visualizar parÃ¢metros do seu conglomerado (exceto Super Admin).

**ImplementaÃ§Ã£o**:
```csharp
public async Task<ParametroDetalheDto> ObterDetalhes(Guid id, Guid userId)
{
    var usuario = await _usuarioRepository.ObterPorId(userId);
    var parametro = await _repository.ObterPorId(id);

    if (parametro == null)
        throw new NotFoundException("ParÃ¢metro nÃ£o encontrado");

    // Validar isolamento multi-tenant
    if (!usuario.FlSuperAdmin && parametro.IdConglomerado != usuario.IdConglomerado)
    {
        await _auditoriaService.RegistrarAcessoNegado(
            userId,
            "SYS.PARAMETROS.READ",
            $"Tentativa de acessar parÃ¢metro de outro conglomerado: {id}"
        );
        throw new ForbiddenException("Acesso negado a parÃ¢metro de outro conglomerado");
    }

    return MapToDetalheDto(parametro);
}
```

### RN-UC02-05: VerificaÃ§Ã£o de PermissÃ£o
**DescriÃ§Ã£o**: Sistema deve verificar permissÃ£o `SYS.PARAMETROS.READ` antes de exibir detalhes.

**Regra**:
1. Verificar se usuÃ¡rio estÃ¡ autenticado
2. Consultar `Usuario_Perfil` e `Perfil_Funcionalidade`
3. Validar que funcionalidade `FNC-SYS-001` possui `Fl_Ler = 1`
4. Retornar HTTP 403 se usuÃ¡rio nÃ£o tiver acesso
5. Registrar tentativa nÃ£o autorizada em auditoria

---

## ğŸ”— IntegraÃ§Ãµes ObrigatÃ³rias

### Central de Funcionalidades

**Funcionalidade**: `FNC-SYS-001` - GestÃ£o de ParÃ¢metros do Sistema

**PermissÃ£o Requerida**: `SYS.PARAMETROS.READ`

**ValidaÃ§Ã£o no Backend**:
```csharp
[HttpGet("{id}")]
[Authorize]
[RequiresPermission("SYS.PARAMETROS.READ")]
public async Task<IActionResult> ObterDetalhes(Guid id)
{
    var detalhes = await _parametroService.ObterDetalhes(id, User.GetUserId());
    return Ok(detalhes);
}

[HttpPost("{id}/descriptografar")]
[Authorize]
[RequiresPermission("SYS.PARAMETROS.READ")]
public async Task<IActionResult> Descriptografar(
    Guid id,
    [FromBody] DescriptografarDto dto)
{
    // Validar que usuÃ¡rio Ã© Super Admin
    if (!User.IsSuperAdmin())
        return Forbid();

    var valor = await _parametroService.Descriptografar(
        id,
        User.GetUserId(),
        dto.Motivo
    );

    return Ok(new { valor });
}
```

**ValidaÃ§Ã£o no Frontend**:
```typescript
// Guard na rota de detalhes
{
  path: 'parametros/:id',
  component: ParametroDetalheComponent,
  canActivate: [AuthGuard, PermissionGuard],
  data: { permission: 'SYS.PARAMETROS.READ' }
}

// Controle de exibiÃ§Ã£o de botÃ£o
<button
  *hasPermission="'SYS.PARAMETROS.READ'"
  (click)="visualizarDetalhes(parametro.id)">
  <i class="icon-eye"></i> {{ 'COMMON.BUTTONS.VIEW' | translate }}
</button>
```

### InternacionalizaÃ§Ã£o

**Chaves de TraduÃ§Ã£o NecessÃ¡rias**:

| Chave | Contexto | Texto PT-BR |
|-------|----------|-------------|
| `PARAMETROS.DETAILS.TITLE` | TÃ­tulo | "Detalhes do ParÃ¢metro" |
| `PARAMETROS.DETAILS.TAB_INFO` | Tab | "InformaÃ§Ãµes Gerais" |
| `PARAMETROS.DETAILS.TAB_VALIDATIONS` | Tab | "ValidaÃ§Ãµes" |
| `PARAMETROS.DETAILS.TAB_HISTORY` | Tab | "HistÃ³rico" |
| `PARAMETROS.DETAILS.TAB_METADATA` | Tab | "Metadados" |
| `PARAMETROS.DETAILS.GENERAL_INFO` | SeÃ§Ã£o | "InformaÃ§Ãµes Gerais" |
| `PARAMETROS.DETAILS.VALIDATION_RULES` | SeÃ§Ã£o | "Regras de ValidaÃ§Ã£o" |
| `PARAMETROS.DETAILS.SYSTEM_INFO` | SeÃ§Ã£o | "InformaÃ§Ãµes do Sistema" |
| `PARAMETROS.DETAILS.SHOW_VALUE` | BotÃ£o | "Mostrar Valor" |
| `PARAMETROS.DETAILS.HIDE_VALUE` | BotÃ£o | "Ocultar Valor" |
| `PARAMETROS.DETAILS.SENSITIVE_WARNING` | Aviso | "Este valor Ã© sensÃ­vel e estÃ¡ criptografado" |
| `PARAMETROS.DETAILS.DECRYPT_CONFIRM` | ConfirmaÃ§Ã£o | "VocÃª estÃ¡ prestes a visualizar um valor sensÃ­vel. Esta aÃ§Ã£o serÃ¡ registrada em auditoria." |
| `PARAMETROS.DETAILS.ACCESS_REASON` | Label | "Motivo do acesso (opcional)" |
| `PARAMETROS.DETAILS.VALUE_HIDDEN` | Info | "Valor oculto por seguranÃ§a" |
| `PARAMETROS.DETAILS.AUTO_HIDE` | Info | "SerÃ¡ ocultado automaticamente em {seconds}s" |
| `PARAMETROS.DETAILS.CREATED_BY` | Label | "Criado por" |
| `PARAMETROS.DETAILS.CREATED_AT` | Label | "Criado em" |
| `PARAMETROS.DETAILS.UPDATED_BY` | Label | "Atualizado por" |
| `PARAMETROS.DETAILS.UPDATED_AT` | Label | "Atualizado em" |
| `PARAMETROS.DETAILS.VERSION` | Label | "VersÃ£o" |
| `PARAMETROS.DETAILS.CACHE_STATUS` | Label | "Status do Cache" |
| `PARAMETROS.DETAILS.CACHED` | Status | "Em cache" |
| `PARAMETROS.DETAILS.NOT_CACHED` | Status | "NÃ£o cacheado" |
| `PARAMETROS.DETAILS.REFERENCES` | BotÃ£o | "Ver Onde Ã© Usado" |
| `PARAMETROS.DETAILS.EXPORT_PDF` | BotÃ£o | "Exportar PDF" |
| `PARAMETROS.DETAILS.COPY_CODE` | Tooltip | "Copiar CÃ³digo" |
| `PARAMETROS.DETAILS.CODE_COPIED` | Feedback | "CÃ³digo copiado!" |
| `PARAMETROS.DETAILS.COMPARE_VERSIONS` | BotÃ£o | "Comparar VersÃµes" |
| `PARAMETROS.DETAILS.EXPORT_HISTORY` | BotÃ£o | "Exportar HistÃ³rico" |
| `PARAMETROS.DETAILS.NO_HISTORY` | Mensagem | "Nenhum histÃ³rico disponÃ­vel" |
| `PARAMETROS.DETAILS.OPERATION_CREATE` | OperaÃ§Ã£o | "CriaÃ§Ã£o" |
| `PARAMETROS.DETAILS.OPERATION_UPDATE` | OperaÃ§Ã£o | "AtualizaÃ§Ã£o" |
| `PARAMETROS.DETAILS.OPERATION_DELETE` | OperaÃ§Ã£o | "ExclusÃ£o" |
| `PARAMETROS.DETAILS.OPERATION_ACCESS` | OperaÃ§Ã£o | "Acesso" |
| `PARAMETROS.DETAILS.FIELD_CHANGED` | Label | "Campo alterado" |
| `PARAMETROS.DETAILS.OLD_VALUE` | Label | "Valor anterior" |
| `PARAMETROS.DETAILS.NEW_VALUE` | Label | "Valor novo" |
| `PARAMETROS.DETAILS.CHANGE_REASON` | Label | "Motivo da alteraÃ§Ã£o" |
| `PARAMETROS.DETAILS.TEST_VALIDATION` | BotÃ£o | "Testar ValidaÃ§Ã£o" |
| `PARAMETROS.DETAILS.TEST_VALUE` | Label | "Valor de teste" |
| `PARAMETROS.DETAILS.VALIDATION_PASSED` | Resultado | "ValidaÃ§Ã£o passou" |
| `PARAMETROS.DETAILS.VALIDATION_FAILED` | Resultado | "ValidaÃ§Ã£o falhou" |
| `PARAMETROS.MESSAGES.NOT_FOUND` | Erro | "ParÃ¢metro nÃ£o encontrado" |
| `PARAMETROS.MESSAGES.ACCESS_DENIED` | Erro | "VocÃª nÃ£o tem acesso a este parÃ¢metro" |
| `PARAMETROS.MESSAGES.LOAD_ERROR` | Erro | "Erro ao carregar detalhes" |
| `COMMON.BUTTONS.CLOSE` | BotÃ£o | "Fechar" |
| `COMMON.BUTTONS.CONFIRM` | BotÃ£o | "Confirmar" |
| `COMMON.BUTTONS.CANCEL` | BotÃ£o | "Cancelar" |

**Arquivo**: `src/assets/i18n/pt-BR.json`
**SeÃ§Ã£o**: `PARAMETROS`

**Uso no CÃ³digo**:
```typescript
export class ParametroDetalheComponent implements OnInit {
  constructor(
    private translate: TranslateService,
    private parametroService: ParametroService,
    private route: ActivatedRoute,
    private toastr: ToastrService
  ) {}

  ngOnInit() {
    const id = this.route.snapshot.params['id'];
    this.loadDetalhes(id);
  }

  loadDetalhes(id: string) {
    this.parametroService.obterDetalhes(id).subscribe({
      next: (detalhes) => {
        this.parametro = detalhes;
        this.title = `${this.translate.instant('PARAMETROS.DETAILS.TITLE')}: ${detalhes.codigo}`;
      },
      error: () => {
        this.toastr.error(
          this.translate.instant('PARAMETROS.MESSAGES.LOAD_ERROR')
        );
      }
    });
  }

  descriptografarValor() {
    const motivo = prompt(
      this.translate.instant('PARAMETROS.DETAILS.ACCESS_REASON')
    );

    this.parametroService.descriptografar(this.parametro.id, motivo).subscribe({
      next: (response) => {
        this.valorDescriptografado = response.valor;
        this.mostrandoValor = true;
        this.iniciarContadorOcultacao();
      }
    });
  }

  iniciarContadorOcultacao() {
    let segundos = 30;
    this.segundosRestantes = segundos;

    const interval = setInterval(() => {
      this.segundosRestantes--;
      if (this.segundosRestantes <= 0) {
        clearInterval(interval);
        this.ocultarValor();
      }
    }, 1000);
  }

  ocultarValor() {
    this.valorDescriptografado = null;
    this.mostrandoValor = false;
  }
}
```

```html
<div class="parametro-detalhes">
  <h1>{{ title }}</h1>

  <mat-tab-group>
    <!-- Tab InformaÃ§Ãµes Gerais -->
    <mat-tab [label]="'PARAMETROS.DETAILS.TAB_INFO' | translate">
      <div class="info-section">
        <h3>{{ 'PARAMETROS.DETAILS.GENERAL_INFO' | translate }}</h3>

        <div class="field">
          <label>{{ 'PARAMETROS.FIELDS.CODE' | translate }}</label>
          <div class="value-with-copy">
            <span>{{ parametro.codigo }}</span>
            <button
              (click)="copiarCodigo()"
              [title]="'PARAMETROS.DETAILS.COPY_CODE' | translate">
              <i class="icon-copy"></i>
            </button>
          </div>
        </div>

        <div class="field">
          <label>{{ 'PARAMETROS.FIELDS.VALUE' | translate }}</label>
          <div class="value-sensitive" *ngIf="parametro.flSensivel">
            <span *ngIf="!mostrandoValor">********</span>
            <span *ngIf="mostrandoValor">{{ valorDescriptografado }}</span>

            <button
              *ngIf="parametro.podeDescriptografar && !mostrandoValor"
              (click)="descriptografarValor()">
              {{ 'PARAMETROS.DETAILS.SHOW_VALUE' | translate }}
            </button>

            <span *ngIf="mostrandoValor" class="auto-hide-timer">
              {{ 'PARAMETROS.DETAILS.AUTO_HIDE' | translate: { seconds: segundosRestantes } }}
            </span>
          </div>
          <div *ngIf="!parametro.flSensivel">
            <span>{{ parametro.valor }}</span>
          </div>
        </div>
      </div>
    </mat-tab>

    <!-- Tab ValidaÃ§Ãµes -->
    <mat-tab [label]="'PARAMETROS.DETAILS.TAB_VALIDATIONS' | translate">
      <!-- ConteÃºdo de validaÃ§Ãµes -->
    </mat-tab>

    <!-- Tab HistÃ³rico -->
    <mat-tab [label]="'PARAMETROS.DETAILS.TAB_HISTORY' | translate">
      <!-- ConteÃºdo de histÃ³rico -->
    </mat-tab>

    <!-- Tab Metadados -->
    <mat-tab [label]="'PARAMETROS.DETAILS.TAB_METADATA' | translate">
      <!-- ConteÃºdo de metadados -->
    </mat-tab>
  </mat-tab-group>

  <div class="actions">
    <button (click)="exportarPDF()">
      {{ 'PARAMETROS.DETAILS.EXPORT_PDF' | translate }}
    </button>
    <button (click)="fechar()">
      {{ 'COMMON.BUTTONS.CLOSE' | translate }}
    </button>
  </div>
</div>
```

### Auditoria

**OperaÃ§Ãµes Auditadas**:

| OperaÃ§Ã£o | Tipo | Dados Registrados |
|----------|------|-------------------|
| Visualizar ParÃ¢metro | READ | ID do parÃ¢metro, cÃ³digo |
| Visualizar ParÃ¢metro SensÃ­vel | ACCESS | ID, cÃ³digo, motivo de acesso (se informado) |
| Descriptografar Valor | ACCESS | ID, cÃ³digo, motivo, timestamp |
| Exportar Detalhes PDF | EXPORT | ID, cÃ³digo, formato (PDF) |
| Exportar HistÃ³rico | EXPORT | ID, cÃ³digo, formato (CSV/PDF), quantidade de registros |

**Tabela de Auditoria**: `Sistema_Parametro_Historico`

**ImplementaÃ§Ã£o Backend**:
```csharp
public async Task<ParametroDetalheDto> ObterDetalhes(Guid id, Guid userId)
{
    var parametro = await _repository.ObterPorId(id);
    var usuario = await _usuarioRepository.ObterPorId(userId);

    // Auditoria bÃ¡sica de visualizaÃ§Ã£o
    await _auditoriaService.Registrar(new AuditoriaDto
    {
        TipoOperacao = "READ",
        Entidade = "Sistema_Parametro",
        IdEntidade = id,
        Descricao = $"Visualizou detalhes do parÃ¢metro: {parametro.CdParametro}",
        IdUsuario = userId,
        IpUsuario = _httpContext.HttpContext?.Connection.RemoteIpAddress?.ToString(),
        UserAgent = _httpContext.HttpContext?.Request.Headers["User-Agent"].ToString()
    });

    // Auditoria adicional se for sensÃ­vel
    if (parametro.FlSensivel)
    {
        await _auditoriaService.Registrar(new AuditoriaDto
        {
            TipoOperacao = "ACCESS",
            Entidade = "Sistema_Parametro",
            IdEntidade = id,
            Descricao = $"Acessou parÃ¢metro SENSÃVEL: {parametro.CdParametro}",
            Severidade = "HIGH",
            IdUsuario = userId,
            IpUsuario = _httpContext.HttpContext?.Connection.RemoteIpAddress?.ToString(),
            UserAgent = _httpContext.HttpContext?.Request.Headers["User-Agent"].ToString()
        });
    }

    return MapToDetalheDto(parametro, usuario);
}

public async Task<string> Descriptografar(Guid id, Guid userId, string motivo)
{
    var parametro = await _repository.ObterPorId(id);
    var usuario = await _usuarioRepository.ObterPorId(userId);

    // Validar que Ã© Super Admin
    if (!usuario.FlSuperAdmin)
        throw new ForbiddenException("Apenas Super Administradores podem descriptografar valores");

    // Descriptografar
    var valorDescriptografado = _encryptionService.Decrypt(parametro.Valor);

    // Auditoria CRÃTICA
    await _auditoriaService.Registrar(new AuditoriaDto
    {
        TipoOperacao = "DECRYPT",
        Entidade = "Sistema_Parametro",
        IdEntidade = id,
        Descricao = $"DESCRIPTOGRAFOU valor sensÃ­vel do parÃ¢metro: {parametro.CdParametro}",
        Motivo = motivo ?? "NÃ£o informado",
        Severidade = "CRITICAL",
        IdUsuario = userId,
        IpUsuario = _httpContext.HttpContext?.Connection.RemoteIpAddress?.ToString(),
        UserAgent = _httpContext.HttpContext?.Request.Headers["User-Agent"].ToString(),
        DadosAdicionais = JsonSerializer.Serialize(new
        {
            ParametroCodigo = parametro.CdParametro,
            ParametroNome = parametro.NmParametro,
            Timestamp = DateTime.UtcNow
        })
    });

    return valorDescriptografado;
}
```

### Controle de Acesso

**Perfis com Acesso a este Caso de Uso**:

| Perfil | Pode Visualizar? | Pode Ver Valores SensÃ­veis? | Pode Descriptografar? |
|--------|------------------|-----------------------------|-----------------------|
| Super Administrador | âœ… Sim (todos) | âœ… Sim (mascarado) | âœ… Sim (explÃ­cito) |
| Administrador de Sistema | âœ… Sim (seu conglomerado) | âŒ NÃ£o (sempre mascarado) | âŒ NÃ£o |
| Administrador de TI | âœ… Sim (seu conglomerado) | âŒ NÃ£o (sempre mascarado) | âŒ NÃ£o |
| Gerente de OperaÃ§Ãµes | âœ… Sim (nÃ£o sensÃ­veis) | âŒ NÃ£o | âŒ NÃ£o |
| Auditor | âœ… Sim (todos, somente leitura) | âŒ NÃ£o | âŒ NÃ£o |
| Operador | âŒ NÃ£o | âŒ NÃ£o | âŒ NÃ£o |
| UsuÃ¡rio Final | âŒ NÃ£o | âŒ NÃ£o | âŒ NÃ£o |

**ValidaÃ§Ã£o de Acesso por NÃ­vel**:
```csharp
public async Task<ParametroDetalheDto> ObterDetalhes(Guid id, Guid userId)
{
    var usuario = await _usuarioRepository.ObterPorId(userId);
    var parametro = await _repository.ObterPorId(id);

    // 1. Validar isolamento multi-tenant
    if (!usuario.FlSuperAdmin && parametro.IdConglomerado != usuario.IdConglomerado)
    {
        throw new ForbiddenException("Acesso negado a parÃ¢metro de outro conglomerado");
    }

    // 2. Validar acesso a parÃ¢metros sensÃ­veis (para nÃ£o-admins)
    if (parametro.FlSensivel && !usuario.FlAdministrador && !usuario.FlSuperAdmin)
    {
        // Gerentes e Auditores nÃ£o podem ver nem existÃªncia de parÃ¢metros sensÃ­veis
        throw new NotFoundException("ParÃ¢metro nÃ£o encontrado");
    }

    var dto = MapToDetalheDto(parametro);

    // 3. Configurar permissÃµes de visualizaÃ§Ã£o
    dto.PodeDescriptografar = usuario.FlSuperAdmin && parametro.FlSensivel;
    dto.PodeEditar = (usuario.FlAdministrador || usuario.FlSuperAdmin) && !parametro.FlSistema;
    dto.PodeExcluir = usuario.FlSuperAdmin && !parametro.FlSistema;
    dto.PodeExportar = true; // Todos com permissÃ£o READ podem exportar

    // 4. Mascarar valor se sensÃ­vel
    if (parametro.FlSensivel)
    {
        dto.ValorExibicao = "********";
        dto.ValorReal = null; // Nunca retornar no GET bÃ¡sico
    }

    return dto;
}
```

---

## ğŸ–¥ï¸ Interface de UsuÃ¡rio (Mockup)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ  Dashboard > Sistema > ConfiguraÃ§Ãµes > ParÃ¢metros > Detalhes           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  ğŸ“‹ Detalhes do ParÃ¢metro: SMTP_PASSWORD                                  â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ [ğŸ“ InformaÃ§Ãµes]  [âœ“ ValidaÃ§Ãµes]  [ğŸ“œ HistÃ³rico]  [âš™ï¸ Metadados] â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ“Œ InformaÃ§Ãµes Gerais                                             â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚ ğŸ”‘ CÃ³digo                                                         â”‚   â”‚
â”‚  â”‚ SMTP_PASSWORD  ğŸ“‹                                                 â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚ ğŸ“ Nome                                                           â”‚   â”‚
â”‚  â”‚ Senha do Servidor SMTP                                            â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚ ğŸ“„ DescriÃ§Ã£o                                                      â”‚   â”‚
â”‚  â”‚ Senha de autenticaÃ§Ã£o para envio de e-mails via SMTP             â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚ ğŸ·ï¸ Categoria                                                      â”‚   â”‚
â”‚  â”‚ ğŸ” SeguranÃ§a                                                      â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚ ğŸ”¢ Tipo de Dado                                                   â”‚   â”‚
â”‚  â”‚ String                                                            â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚ ğŸ’¾ Valor Atual                                                    â”‚   â”‚
â”‚  â”‚ ******** ğŸ”’ [ğŸ‘ï¸ Mostrar Valor] (Super Admin)                      â”‚   â”‚
â”‚  â”‚ âš ï¸ Este valor Ã© sensÃ­vel e estÃ¡ criptografado                     â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â”‚ ğŸ·ï¸ Badges                                                         â”‚   â”‚
â”‚  â”‚ [ğŸ” SensÃ­vel]  [âš ï¸ ObrigatÃ³rio]                                   â”‚   â”‚
â”‚  â”‚                                                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â”‚  [ğŸ“„ Exportar PDF]  [âœï¸ Editar]  [âŒ Fechar]                              â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Tab HistÃ³rico:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“œ HistÃ³rico de AlteraÃ§Ãµes                                                â”‚
â”‚                                                                            â”‚
â”‚ ğŸ” Filtros: [Tipo â–¼]  [PerÃ­odo â–¼]  [UsuÃ¡rio â–¼]     [ğŸ“¥ Exportar]        â”‚
â”‚                                                                            â”‚
â”‚ â”Œâ”€ 2025-11-04 14:30:22 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ ğŸ” ACESSO SENSÃVEL                                                 â”‚    â”‚
â”‚ â”‚ ğŸ‘¤ Super Admin (admin@example.com)                                 â”‚    â”‚
â”‚ â”‚ ğŸŒ IP: 192.168.1.100 | ğŸ’» Chrome 120 / Windows 11                  â”‚    â”‚
â”‚ â”‚                                                                     â”‚    â”‚
â”‚ â”‚ âš ï¸ Descriptografou valor sensÃ­vel                                  â”‚    â”‚
â”‚ â”‚ Motivo: Validar configuraÃ§Ã£o apÃ³s mudanÃ§a de provedor SMTP        â”‚    â”‚
â”‚ â”‚                                                                     â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                            â”‚
â”‚ â”Œâ”€ 2025-11-03 10:15:00 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ âœï¸ ATUALIZAÃ‡ÃƒO                                                     â”‚    â”‚
â”‚ â”‚ ğŸ‘¤ JoÃ£o Silva (joao.silva@example.com)                             â”‚    â”‚
â”‚ â”‚ ğŸŒ IP: 192.168.1.50 | ğŸ’» Firefox 119 / Linux                       â”‚    â”‚
â”‚ â”‚                                                                     â”‚    â”‚
â”‚ â”‚ Campos alterados:                                                  â”‚    â”‚
â”‚ â”‚ â€¢ Valor: ******** â†’ ******** (sensÃ­vel)                           â”‚    â”‚
â”‚ â”‚                                                                     â”‚    â”‚
â”‚ â”‚ Motivo: RotaÃ§Ã£o de senha conforme polÃ­tica de seguranÃ§a           â”‚    â”‚
â”‚ â”‚                                                                     â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                            â”‚
â”‚ â”Œâ”€ 2025-10-01 09:00:00 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ âœ¨ CRIAÃ‡ÃƒO                                                         â”‚    â”‚
â”‚ â”‚ ğŸ‘¤ Sistema (system@icontrolit.com)                                 â”‚    â”‚
â”‚ â”‚ ğŸŒ IP: 127.0.0.1 | ğŸ’» System Process                               â”‚    â”‚
â”‚ â”‚                                                                     â”‚    â”‚
â”‚ â”‚ ParÃ¢metro criado com valor inicial (criptografado)                â”‚    â”‚
â”‚ â”‚                                                                     â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                            â”‚
â”‚  PÃ¡gina: [â—€] 1 [â–¶]  Total: 3 registros                                   â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Modal de ConfirmaÃ§Ã£o de Descriptografia:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš ï¸ AtenÃ§Ã£o - Valor SensÃ­vel                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚ VocÃª estÃ¡ prestes a visualizar um valor     â”‚
â”‚ sensÃ­vel. Esta aÃ§Ã£o serÃ¡ registrada em      â”‚
â”‚ auditoria.                                   â”‚
â”‚                                              â”‚
â”‚ Motivo do acesso (opcional):                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Validar configuraÃ§Ã£o SMTP            â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                              â”‚
â”‚ â±ï¸ O valor serÃ¡ ocultado automaticamente    â”‚
â”‚    apÃ³s 30 segundos.                        â”‚
â”‚                                              â”‚
â”‚         [âœ… Confirmar]  [âŒ Cancelar]        â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”— APIs REST

### GET /api/parametros/{id}

**AutenticaÃ§Ã£o**: Bearer Token JWT
**PermissÃ£o**: `SYS.PARAMETROS.READ`
**Atributo de AutorizaÃ§Ã£o**: `[RequiresPermission("SYS.PARAMETROS.READ")]`

**Path Parameters**:
- `id` (GUID): ID do parÃ¢metro

**Response 200 OK**:
```json
{
  "id": "9fa85f64-5717-4562-b3fc-2c963f66afa6",
  "codigo": "SMTP_PASSWORD",
  "nome": "Senha do Servidor SMTP",
  "descricao": "Senha de autenticaÃ§Ã£o para envio de e-mails via SMTP",
  "categoria": {
    "id": "7ca85f64-5717-4562-b3fc-2c963f66afa6",
    "nome": "SeguranÃ§a",
    "icone": "ğŸ”"
  },
  "tipoDado": "String",
  "valorExibicao": "********",
  "valorPadrao": null,
  "validacoes": {
    "regex": null,
    "valorMinimo": null,
    "valorMaximo": null,
    "opcoesValidas": null,
    "flObrigatorio": true
  },
  "flags": {
    "flSensivel": true,
    "flSistema": false,
    "flObrigatorio": true,
    "flSomenteLeitura": false
  },
  "permissoes": {
    "podeDescriptografar": true,
    "podeEditar": true,
    "podeExcluir": false,
    "podeExportar": true
  },
  "auditoria": {
    "dtCriacao": "2025-10-01T09:00:00Z",
    "usuarioCriacao": {
      "id": "1fa85f64-5717-4562-b3fc-2c963f66afa6",
      "nome": "Sistema"
    },
    "dtAlteracao": "2025-11-03T10:15:00Z",
    "usuarioAlteracao": {
      "id": "2fa85f64-5717-4562-b3fc-2c963f66afa6",
      "nome": "JoÃ£o Silva"
    },
    "versao": 3
  },
  "cache": {
    "status": "cached",
    "key": "parametros:codigo:SMTP_PASSWORD",
    "ttl": 2847
  }
}
```

**Response 404 Not Found**:
```json
{
  "error": "NotFound",
  "message": "ParÃ¢metro nÃ£o encontrado",
  "id": "9fa85f64-5717-4562-b3fc-2c963f66afa6"
}
```

**Response 403 Forbidden**:
```json
{
  "error": "Acesso negado",
  "message": "VocÃª nÃ£o tem acesso a parÃ¢metros de outro conglomerado",
  "code": "CROSS_TENANT_ACCESS_DENIED"
}
```

---

### POST /api/parametros/{id}/descriptografar

**AutenticaÃ§Ã£o**: Bearer Token JWT
**PermissÃ£o**: `SYS.PARAMETROS.READ` + Super Admin
**Atributo de AutorizaÃ§Ã£o**: `[RequiresPermission("SYS.PARAMETROS.READ")]` + `[RequiresSuperAdmin]`

**Path Parameters**:
- `id` (GUID): ID do parÃ¢metro

**Request Body**:
```json
{
  "motivo": "Validar configuraÃ§Ã£o apÃ³s mudanÃ§a de provedor SMTP"
}
```

**Response 200 OK**:
```json
{
  "valor": "Senh@Secreta123!",
  "expiresIn": 30
}
```

**Response 403 Forbidden** (NÃ£o Ã© Super Admin):
```json
{
  "error": "Acesso negado",
  "message": "Apenas Super Administradores podem descriptografar valores sensÃ­veis",
  "code": "INSUFFICIENT_PRIVILEGES"
}
```

---

### GET /api/parametros/{id}/historico

**AutenticaÃ§Ã£o**: Bearer Token JWT
**PermissÃ£o**: `SYS.PARAMETROS.READ`

**Path Parameters**:
- `id` (GUID): ID do parÃ¢metro

**Query Parameters**:
```
?page=1
&pageSize=10
&tipoOperacao=UPDATE
&dataInicio=2025-11-01
&dataFim=2025-11-04
&usuarioId={guid}
```

**Response 200 OK**:
```json
{
  "data": [
    {
      "id": "1aa85f64-5717-4562-b3fc-2c963f66afa6",
      "tipoOperacao": "DECRYPT",
      "dtOperacao": "2025-11-04T14:30:22Z",
      "usuario": {
        "id": "1fa85f64-5717-4562-b3fc-2c963f66afa6",
        "nome": "Super Admin",
        "email": "admin@example.com",
        "foto": "https://..."
      },
      "ipUsuario": "192.168.1.100",
      "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0",
      "motivoAlteracao": "Validar configuraÃ§Ã£o apÃ³s mudanÃ§a de provedor SMTP",
      "severidade": "CRITICAL"
    }
  ],
  "pagination": {
    "page": 1,
    "pageSize": 10,
    "totalItems": 1,
    "totalPages": 1
  }
}
```

---

### POST /api/parametros/{id}/exportar-pdf

**AutenticaÃ§Ã£o**: Bearer Token JWT
**PermissÃ£o**: `SYS.PARAMETROS.READ`

**Path Parameters**:
- `id` (GUID): ID do parÃ¢metro

**Response 200 OK**:
```
Content-Type: application/pdf
Content-Disposition: attachment; filename="parametro-SMTP_PASSWORD-20251104.pdf"

[Binary PDF Data]
```

---

## ğŸ“š CenÃ¡rios de Teste Relacionados

- [CN-UC02 - CenÃ¡rios de Teste Backend](../Testes/Backend/CN-UC02-visualizar-parametro.md)
- [CN-UC02 - CenÃ¡rios de Teste Sistema](../Testes/Sistema/CN-UC02-visualizar-parametro.md)

## ğŸ“ Casos de Teste Relacionados

- [TC-UC02 - Casos de Teste Backend](../Testes/Backend/TC-UC02-visualizar-parametro.md)
- [TC-UC02 - Casos de Teste Sistema](../Testes/Sistema/TC-UC02-visualizar-parametro.md)

---

**Ãšltima AtualizaÃ§Ã£o**: 2025-11-04
**Autor**: Sistema de DocumentaÃ§Ã£o IControlIT
**Revisores**: Equipe de Arquitetura, Equipe de SeguranÃ§a

---

# UC03 - Gerenciar Feature Flags

**Requisito Funcional:** RF-001
**Tipo:** Funcional | CRUD
**Complexidade:** Alta
**Prioridade:** Alta

---

## 1. DescriÃ§Ã£o

Este caso de uso permite que administradores do sistema gerenciem feature flags, controlando a ativaÃ§Ã£o e desativaÃ§Ã£o de funcionalidades em tempo real, com suporte a:
- **Feature flags globais** (para todo o sistema)
- **Feature flags por empresa** (controle granular por cliente)
- **Feature flags por conglomerado** (grupo de empresas)
- **Rollout gradual** com mÃºltiplas estratÃ©gias
- **DependÃªncias entre features** (obrigatÃ³rias e recomendadas)
- **Auditoria completa** de todas as operaÃ§Ãµes

---

## 2. Atores

- **Ator Principal**: Administrador do Sistema, Super Admin
- **Atores SecundÃ¡rios**: Admin Sistema (por conglomerado), Gestor (visualizaÃ§Ã£o apenas)

---

## 3. PrÃ©-condiÃ§Ãµes

- UsuÃ¡rio autenticado com permissÃ£o `SYS.FEATUREFLAGS.MANAGE`
- Para features por empresa: permissÃ£o `SYS.FEATUREFLAGS.ATIVAR_EMPRESA`
- Para rollout gradual: permissÃ£o `SYS.FEATUREFLAGS.ROLLOUT_EMPRESA`
- Banco de dados acessÃ­vel
- Cache Redis configurado e disponÃ­vel

---

## 4. PÃ³s-condiÃ§Ãµes

### Sucesso
- Feature flag criada/atualizada/excluÃ­da no banco de dados
- Registro de auditoria criado em `Sistema_Feature_Flag_Historico`
- Cache Redis invalidado para todas as chaves afetadas:
  - `feature:{codigo}:global`
  - `feature:{codigo}:empresa:{guid}`
  - `features:empresa:{guid}:all`
  - `dashboard:features:*`
- Empresas afetadas recebem notificaÃ§Ã£o (se configurado)
- DependÃªncias validadas e ativadas automaticamente (se obrigatÃ³rias)

### Falha
- Dados nÃ£o sÃ£o alterados
- Mensagem de erro Ã© exibida
- Log de erro Ã© registrado
- TransaÃ§Ã£o Ã© revertida (rollback)

---

## 5. Fluxo Principal

### 5.1. Criar Feature Flag Global

1. Administrador acessa tela "ConfiguraÃ§Ãµes" â†’ "Feature Flags"
2. Clica no botÃ£o "+ Nova Feature Flag"
3. Sistema exibe formulÃ¡rio com campos:
   - **CÃ³digo** (obrigatÃ³rio, Ãºnico, formato: `[A-Z_]+`)
   - **Nome** (obrigatÃ³rio)
   - **DescriÃ§Ã£o** (obrigatÃ³rio)
   - **Tipo** (dropdown: Global / Por Empresa / Por Conglomerado)
   - **Categoria** (dropdown: UI, API, PROCESSAMENTO, INTEGRACAO, etc.)
   - **Status Inicial** (toggle: Ativa / Inativa)
   - **Data de ExpiraÃ§Ã£o** (opcional, datepicker)
   - **DependÃªncias** (multiselect de outras features)
4. UsuÃ¡rio preenche os campos
5. Sistema valida:
   - CÃ³digo nÃ£o existe
   - Nome nÃ£o estÃ¡ vazio
   - DependÃªncias nÃ£o criam ciclos
6. UsuÃ¡rio clica "Salvar"
7. Sistema:
   - Insere registro em `Sistema_Feature_Flag`
   - Registra histÃ³rico com `Tipo_Operacao = "CRIACAO"`
   - Invalida cache `features:all`
   - Exibe mensagem: "Feature flag criada com sucesso!"
8. Sistema retorna Ã  lista de feature flags

### 5.2. Criar Feature Flag por Empresa

1. Administrador acessa tela "Empresas" â†’ Seleciona empresa â†’ Aba "Features"
2. Clica no botÃ£o "+ Ativar Feature para esta Empresa"
3. Sistema exibe modal com:
   - **Selecionar Feature** (dropdown de features globais existentes)
   - **Motivo da AtivaÃ§Ã£o** (textarea, obrigatÃ³rio)
   - **Data de InÃ­cio** (datepicker, opcional - padrÃ£o: imediato)
   - **Data de ExpiraÃ§Ã£o** (datepicker, opcional)
   - **Notificar UsuÃ¡rios** (checkbox)
4. UsuÃ¡rio seleciona feature "BI_AVANCADO"
5. Sistema verifica dependÃªncias:
   - Se BI_AVANCADO depende de BI_BASICO (OBRIGATORIA)
   - Exibe alerta: "Esta feature depende de: BI_BASICO. SerÃ¡ ativada automaticamente."
6. UsuÃ¡rio preenche motivo: "Cliente contratou mÃ³dulo Premium"
7. UsuÃ¡rio clica "Ativar"
8. Sistema:
   - Adiciona `empresaId` ao campo `EmpresasAlvos` (JSON array)
   - Ativa dependÃªncias obrigatÃ³rias automaticamente
   - Registra histÃ³rico: `Tipo_Operacao = "ADICIONAR_EMPRESA"`
   - Invalida cache: `feature:BI_AVANCADO:empresa:{guid}`
   - Conta usuÃ¡rios afetados (ex: 47 usuÃ¡rios)
   - Exibe mensagem: "Feature ativada para ABC Tecnologia. 47 usuÃ¡rios afetados."

### 5.3. Configurar Rollout Gradual

1. Administrador acessa "Feature Flags" â†’ Seleciona feature â†’ BotÃ£o "Configurar Rollout"
2. Sistema exibe modal "Configurar Rollout Gradual" com estratÃ©gias:
   - **Empresas Piloto** (seleÃ§Ã£o manual de empresas)
   - **Percentual Progressivo** (0% â†’ 25% â†’ 50% â†’ 75% â†’ 100%)
   - **Por Segmento** (Tecnologia, Varejo, ServiÃ§os, etc.)
   - **Por Porte** (Pequeno, MÃ©dio, Grande)
   - **Por RegiÃ£o** (Sudeste, Sul, Nordeste, Centro-Oeste, Norte)
3. UsuÃ¡rio seleciona "Percentual Progressivo"
4. Sistema exibe configuraÃ§Ã£o:
   - **Fase 1**: 25% - DuraÃ§Ã£o: 7 dias
   - **Fase 2**: 50% - DuraÃ§Ã£o: 7 dias
   - **Fase 3**: 75% - DuraÃ§Ã£o: 7 dias
   - **Fase 4**: 100% - DuraÃ§Ã£o: indefinido
   - **CritÃ©rio de Rollback**: Taxa de erro > 5%
5. UsuÃ¡rio clica "Iniciar Rollout"
6. Sistema:
   - Calcula hash consistente (MurmurHash3) para cada empresa
   - Seleciona 25% das empresas (ex: 38 de 151)
   - Atualiza `EstrategiaRollout = "PERCENTUAL_EMPRESAS"`
   - Agenda job Hangfire para Fase 2 (7 dias)
   - Registra histÃ³rico: `Tipo_Operacao = "INICIAR_ROLLOUT"`
   - Exibe: "Rollout iniciado! Fase 1: 38 empresas (25%)"

### 5.4. Listar Feature Flags

1. Administrador acessa "ConfiguraÃ§Ãµes" â†’ "Feature Flags"
2. Sistema exibe grid com colunas:
   - **CÃ³digo** (ex: BI_AVANCADO)
   - **Nome** (ex: Business Intelligence AvanÃ§ado)
   - **Tipo** (badge: Global / Empresa / Conglomerado)
   - **Status** (badge verde "Ativa" / cinza "Inativa")
   - **Empresas Ativas** (ex: 85/151)
   - **Rollout** (progress bar: Fase 2/4 - 50%)
   - **Ãšltima AlteraÃ§Ã£o** (data/hora + usuÃ¡rio)
   - **AÃ§Ãµes** (Ã­cones: âœï¸ Editar | ğŸ—‘ï¸ Excluir | ğŸ“Š HistÃ³rico | âš™ï¸ Rollout)
3. Sistema oferece filtros:
   - **Status**: Todas / Ativas / Inativas
   - **Tipo**: Todos / Global / Empresa / Conglomerado
   - **Categoria**: Todas / UI / API / Processamento / IntegraÃ§Ã£o
   - **Busca textual**: por cÃ³digo ou nome
4. UsuÃ¡rio clica filtro "Ativas" â†’ Grid atualiza mostrando apenas features ativas
5. Sistema aplica filtro em tempo real (< 500ms)

### 5.5. Editar Feature Flag

1. Administrador acessa lista â†’ Clica Ã­cone âœï¸ "Editar" em feature existente
2. Sistema exibe formulÃ¡rio preenchido com dados atuais
3. UsuÃ¡rio altera campo "DescriÃ§Ã£o"
4. Sistema detecta mudanÃ§a e habilita botÃ£o "Salvar AlteraÃ§Ãµes"
5. UsuÃ¡rio clica "Salvar AlteraÃ§Ãµes"
6. Sistema:
   - Gera diff JSON (valor anterior vs novo)
   - Atualiza registro em `Sistema_Feature_Flag`
   - Registra histÃ³rico: `Tipo_Operacao = "ALTERACAO"` com diff completo
   - Invalida cache da feature
   - Exibe: "Feature atualizada com sucesso!"

### 5.6. Desativar Feature Flag (Global)

1. Administrador acessa lista â†’ Clica toggle "Status" de feature ativa
2. Sistema exibe modal de confirmaÃ§Ã£o:
   - "Desativar feature BI_AVANCADO?"
   - "Esta feature estÃ¡ ativa para 85 empresas (2.340 usuÃ¡rios)"
   - Campo "Motivo da desativaÃ§Ã£o" (obrigatÃ³rio)
   - Checkbox "Notificar empresas afetadas"
3. UsuÃ¡rio preenche motivo: "Bug crÃ­tico identificado - CVE-2025-1234"
4. UsuÃ¡rio marca checkbox "Notificar empresas"
5. UsuÃ¡rio clica "Confirmar DesativaÃ§Ã£o"
6. Sistema:
   - Atualiza `Fl_Ativo = 0`
   - Registra histÃ³rico: `Tipo_Operacao = "DESATIVAR_GLOBAL"`
   - Invalida TODOS os caches relacionados (global + empresas)
   - Envia notificaÃ§Ã£o para 85 empresas afetadas
   - Exibe: "Feature desativada. 85 empresas e 2.340 usuÃ¡rios afetados. NotificaÃ§Ãµes enviadas."

### 5.7. Remover Empresa de Feature Flag

1. Administrador acessa "Empresas" â†’ ABC Tecnologia â†’ Aba "Features"
2. Grid mostra features ativas para esta empresa (ex: 18 features)
3. UsuÃ¡rio clica Ã­cone ğŸ—‘ï¸ "Remover" na feature "CUSTOM_DASHBOARD"
4. Sistema exibe modal:
   - "Remover feature CUSTOM_DASHBOARD da empresa ABC Tecnologia?"
   - "47 usuÃ¡rios desta empresa perderÃ£o acesso"
   - Campo "Motivo" (obrigatÃ³rio)
5. UsuÃ¡rio preenche: "Fim do perÃ­odo de trial"
6. UsuÃ¡rio clica "Confirmar RemoÃ§Ã£o"
7. Sistema:
   - Remove `empresaId` do array `EmpresasAlvos`
   - Registra histÃ³rico: `Tipo_Operacao = "REMOVER_EMPRESA"`
   - Invalida cache: `feature:CUSTOM_DASHBOARD:empresa:{guid-abc}`
   - Exibe: "Feature removida. 47 usuÃ¡rios afetados."

### 5.8. Validar DependÃªncias ao Desativar

1. Administrador tenta desativar feature "BI_BASICO"
2. Sistema detecta que "BI_AVANCADO" depende de "BI_BASICO" (OBRIGATORIA)
3. Sistema exibe modal de alerta:
   - "âš ï¸ NÃ£o Ã© possÃ­vel desativar esta feature"
   - "As seguintes features dependem de BI_BASICO:"
   - Lista: "â€¢ BI_AVANCADO (85 empresas) - OBRIGATÃ“RIA"
   - SugestÃ£o: "Desative primeiro as features dependentes ou remova a dependÃªncia."
   - BotÃµes: "Cancelar" | "Ver Features Dependentes"
4. UsuÃ¡rio clica "Ver Features Dependentes"
5. Sistema redireciona para grid filtrado mostrando apenas "BI_AVANCADO"
6. OperaÃ§Ã£o de desativaÃ§Ã£o Ã© cancelada

### 5.9. Excluir Feature Flag (Soft Delete)

1. Administrador acessa lista â†’ Clica Ã­cone ğŸ—‘ï¸ "Excluir"
2. Sistema valida:
   - Feature nÃ£o estÃ¡ ativa para nenhuma empresa
   - Nenhuma outra feature depende dela
3. Sistema exibe modal de confirmaÃ§Ã£o:
   - "Excluir definitivamente a feature TEST_BETA?"
   - "Esta aÃ§Ã£o nÃ£o pode ser desfeita."
   - Campo "Motivo da exclusÃ£o"
   - âš ï¸ "Nota: A feature serÃ¡ marcada como excluÃ­da (soft delete)"
4. UsuÃ¡rio preenche motivo: "Feature experimental descontinuada"
5. UsuÃ¡rio clica "Confirmar ExclusÃ£o"
6. Sistema:
   - Atualiza `Fl_Ativo = 0` e `Dt_Exclusao = NOW()`
   - Registra histÃ³rico: `Tipo_Operacao = "EXCLUSAO"`
   - Invalida cache
   - Exibe: "Feature excluÃ­da com sucesso"
7. Feature nÃ£o aparece mais na listagem padrÃ£o (filtro: `Dt_Exclusao IS NULL`)

### 5.10. Visualizar HistÃ³rico de Feature Flag

1. Administrador acessa lista â†’ Clica Ã­cone ğŸ“Š "HistÃ³rico" em feature
2. Sistema abre modal "HistÃ³rico - BI_AVANCADO" com timeline:
   - **07/11/2025 14:35** - Maria Silva
     - ğŸŸ¢ ADICIONAR_EMPRESA - ABC Tecnologia
     - Motivo: "Cliente contratou mÃ³dulo Premium"
   - **05/11/2025 09:20** - Sistema (Hangfire)
     - ğŸ”µ ROLLOUT_FASE_2 - 50% empresas (76 empresas)
   - **03/11/2025 10:15** - JoÃ£o Admin
     - ğŸŸ¡ ALTERAR_CONFIGURACAO
     - Diff: `PercentualRollout: 25% â†’ 50%`
   - **01/11/2025 08:00** - Sistema
     - ğŸŸ¢ INICIAR_ROLLOUT - Fase 1 (25%)
3. UsuÃ¡rio pode filtrar por:
   - Tipo de operaÃ§Ã£o (dropdown)
   - PerÃ­odo (date range picker)
   - UsuÃ¡rio (autocomplete)
4. UsuÃ¡rio pode exportar histÃ³rico (Excel/PDF)

---

## 6. Fluxos Alternativos

### 6A. CÃ³digo de Feature Duplicado

1. No passo 5.1.5, sistema detecta cÃ³digo duplicado
2. Sistema exibe erro: "âŒ CÃ³digo BI_AVANCADO jÃ¡ existe. Use outro cÃ³digo."
3. Campo "CÃ³digo" Ã© destacado em vermelho
4. UsuÃ¡rio corrige e tenta novamente
5. Retorna ao passo 5.1.6

### 6B. DependÃªncia Circular Detectada

1. No passo 5.1.5, sistema detecta ciclo:
   - FEATURE_A depende de FEATURE_B
   - FEATURE_B depende de FEATURE_C
   - FEATURE_C depende de FEATURE_A (ciclo!)
2. Sistema exibe erro: "âŒ DependÃªncia circular detectada: A â†’ B â†’ C â†’ A"
3. Campo "DependÃªncias" Ã© destacado
4. UsuÃ¡rio remove dependÃªncia que causa ciclo
5. Retorna ao passo 5.1.6

### 6C. Rollout Pausado por Alta Taxa de Erros

1. Durante rollout automÃ¡tico (passo 5.3), sistema monitora mÃ©tricas
2. Sistema detecta taxa de erro > 5% (threshold configurado)
3. Sistema automaticamente:
   - Pausa rollout (cancela jobs Hangfire futuros)
   - Registra histÃ³rico: `Tipo_Operacao = "PAUSAR_ROLLOUT"`
   - Envia alerta para admins: "âš ï¸ Rollout de BI_AVANCADO pausado - Taxa de erro: 7.2%"
   - MantÃ©m empresas da fase atual ativas (nÃ£o faz rollback automÃ¡tico)
4. Administrador investiga problema
5. Administrador decide:
   - **Retomar rollout**: Clica "Retomar" â†’ Volta ao passo 5.3
   - **Fazer rollback**: Clica "Reverter" â†’ Remove feature de todas empresas da fase atual

### 6D. Feature com Data de ExpiraÃ§Ã£o

1. Sistema executa job diÃ¡rio Hangfire: `VerificarFeaturesExpiradas`
2. Job detecta feature com `DtExpiracao < NOW()`
3. Sistema automaticamente:
   - Desativa feature globalmente (`Fl_Ativo = 0`)
   - Remove de todas empresas
   - Registra histÃ³rico: `Tipo_Operacao = "EXPIRACAO_AUTOMATICA"`
   - Envia notificaÃ§Ã£o para admins e empresas afetadas
4. Feature aparece com badge vermelho "Expirada" na listagem

### 6E. PermissÃ£o Insuficiente (Admin Sistema por Conglomerado)

1. Admin Sistema (Conglomerado X) tenta ativar feature para Empresa Y (Conglomerado Z)
2. Sistema valida permissÃµes e detecta empresa fora do conglomerado do usuÃ¡rio
3. Sistema exibe erro: "âŒ Acesso Negado - VocÃª sÃ³ pode gerenciar features de empresas do Conglomerado X"
4. OperaÃ§Ã£o Ã© cancelada
5. Log de seguranÃ§a Ã© registrado com tentativa de acesso nÃ£o autorizado

---

## 7. Fluxos de ExceÃ§Ã£o

### 7A. Erro de ConexÃ£o com Redis (Cache)

1. Durante qualquer operaÃ§Ã£o, sistema tenta invalidar cache Redis
2. Redis estÃ¡ indisponÃ­vel (timeout/erro de conexÃ£o)
3. Sistema:
   - **NÃƒO falha** a operaÃ§Ã£o (cache Ã© secundÃ¡rio)
   - Registra log de warning: "Cache Redis indisponÃ­vel - operaÃ§Ã£o continuou sem invalidaÃ§Ã£o"
   - Completa operaÃ§Ã£o normalmente no banco de dados
   - Exibe aviso ao usuÃ¡rio: "âš ï¸ OperaÃ§Ã£o concluÃ­da, mas cache pode estar desatualizado (aguarde 5 min)"
4. Sistema tenta reconectar Redis em background

### 7B. Erro ao Ativar DependÃªncia ObrigatÃ³ria

1. No passo 5.2.5, sistema tenta ativar dependÃªncia obrigatÃ³ria "BI_BASICO"
2. DependÃªncia estÃ¡ com erro/corrompida no banco
3. Sistema:
   - Faz rollback da transaÃ§Ã£o inteira
   - Exibe erro: "âŒ NÃ£o foi possÃ­vel ativar dependÃªncia obrigatÃ³ria: BI_BASICO. Verifique a integridade da feature."
   - Registra erro detalhado em logs
   - Envia alerta para time tÃ©cnico
4. Feature principal NÃƒO Ã© ativada (transaÃ§Ã£o atÃ´mica)

### 7C. Job Hangfire de Rollout Falha

1. Durante execuÃ§Ã£o automÃ¡tica de Fase 2 do rollout (passo 5.3)
2. Job Hangfire falha por exception nÃ£o tratada
3. Sistema:
   - Hangfire tenta reexecutar job automaticamente (retry policy: 3x)
   - Se todas tentativas falharem:
     - Marca rollout como "PAUSADO"
     - Registra histÃ³rico: `Tipo_Operacao = "ERRO_ROLLOUT"`
     - Envia alerta crÃ­tico para admins com stack trace
     - Empresas da fase atual permanecem com feature ativa (nÃ£o reverte)
4. Administrador pode retomar manualmente apÃ³s correÃ§Ã£o

### 7D. Tentativa de Excluir Feature Ativa

1. Administrador tenta excluir feature que ainda tem empresas ativas
2. Sistema valida e detecta 15 empresas com feature ativa
3. Sistema exibe erro:
   - "âŒ NÃ£o Ã© possÃ­vel excluir esta feature"
   - "15 empresas ainda utilizam esta feature:"
   - Lista empresas (scroll se > 5)
   - BotÃ£o "Remover de Todas Empresas e Excluir"
4. Se usuÃ¡rio clicar botÃ£o:
   - Sistema pede confirmaÃ§Ã£o adicional com senha do admin
   - Remove feature de todas empresas
   - Registra histÃ³rico: `Tipo_Operacao = "REMOCAO_EM_MASSA"`
   - Exclui feature (soft delete)

---

## 8. Requisitos NÃ£o Funcionais

### Desempenho
- Listagem de features: < 2 segundos (atÃ© 1000 features)
- CriaÃ§Ã£o/ediÃ§Ã£o: < 1 segundo
- InvalidaÃ§Ã£o de cache: < 500ms
- CÃ¡lculo de hash para rollout: < 3 segundos (para 1000 empresas)

### SeguranÃ§a
- Auditoria completa: 100% das operaÃ§Ãµes registradas
- Campos sensÃ­veis criptografados em `Diff_Json`
- Rate limiting: 100 requisiÃ§Ãµes/minuto por usuÃ¡rio
- ValidaÃ§Ã£o de CSRF token em todas operaÃ§Ãµes

### Disponibilidade
- Cache Redis com fallback graceful (continua sem cache)
- Rollback automÃ¡tico em transaÃ§Ãµes
- Jobs Hangfire com retry policy (3 tentativas)

### Usabilidade
- Feedback visual imediato (< 200ms)
- Mensagens de erro claras e acionÃ¡veis
- ConfirmaÃ§Ã£o obrigatÃ³ria para operaÃ§Ãµes destrutivas
- HistÃ³rico completo acessÃ­vel em 1 clique

---

## 9. Regras de NegÃ³cio

### RN-UC03-01: PrecedÃªncia HierÃ¡rquica de Feature Flags
- **Prioridade**: Empresa > Conglomerado > Global
- Se feature estÃ¡ ativa para empresa especÃ­fica â†’ retorna TRUE (ignora global/conglomerado)
- Se nÃ£o estÃ¡ em empresa, verifica conglomerado â†’ se ativa, retorna TRUE
- Se nÃ£o estÃ¡ em conglomerado, verifica global â†’ se ativa, retorna TRUE
- Caso contrÃ¡rio, retorna FALSE

### RN-UC03-02: ValidaÃ§Ã£o de DependÃªncias
- Feature nÃ£o pode ser ativada se suas dependÃªncias OBRIGATÃ“RIAS nÃ£o estiverem ativas
- Sistema ativa dependÃªncias OBRIGATÃ“RIAS automaticamente
- Sistema exibe alerta para dependÃªncias RECOMENDADAS (mas permite continuar)
- DependÃªncias circulares (Aâ†’Bâ†’Câ†’A) devem ser bloqueadas

### RN-UC03-03: InvalidaÃ§Ã£o de Cache
- Ao alterar feature global: invalidar `feature:{codigo}:global`
- Ao adicionar/remover empresa: invalidar `feature:{codigo}:empresa:{guid}` + `features:empresa:{guid}:all`
- Ao alterar qualquer feature: invalidar `dashboard:features:*` (todos dashboards)
- TTL padrÃ£o do cache: 5 minutos

### RN-UC03-04: Consistent Hashing para Rollout Percentual
- Usar **MurmurHash3** para gerar hash da combinaÃ§Ã£o `{empresaId}:{codigoFeature}`
- Hash deve ser determinÃ­stico (mesma empresa sempre cai no mesmo percentual)
- DistribuiÃ§Ã£o deve ser uniforme (evitar clustering)
- CÃ¡lculo: `hash(empresaId:feature) <= (UINT32_MAX * percentual / 100)`

### RN-UC03-05: Auditoria ObrigatÃ³ria
- **TODAS** as operaÃ§Ãµes devem registrar histÃ³rico
- Campos obrigatÃ³rios: `Id_Usuario_Alteracao`, `Dt_Alteracao`, `Tipo_Operacao`
- Campos opcionais mas recomendados: `Motivo`, `IP_Alteracao`, `UserAgent`
- Diff JSON deve conter: `valorAnterior` e `valorNovo` para campos alterados

### RN-UC03-06: Soft Delete
- Features NUNCA sÃ£o excluÃ­das fisicamente do banco
- ExclusÃ£o seta `Fl_Ativo = 0` e `Dt_Exclusao = NOW()`
- Listagem padrÃ£o filtra: `WHERE Dt_Exclusao IS NULL`
- HistÃ³rico permanece acessÃ­vel mesmo apÃ³s exclusÃ£o

### RN-UC03-07: Rollback AutomÃ¡tico por Taxa de Erros
- Durante rollout, monitorar taxa de erros HTTP 5xx
- Se taxa > 5% em janela de 15 minutos â†’ pausar rollout automaticamente
- Enviar alerta imediato para admins
- NÃƒO fazer rollback automÃ¡tico (manter empresas atuais ativas, apenas pausar expansÃ£o)

### RN-UC03-08: NotificaÃ§Ãµes
- Ao ativar feature: notificar admins da empresa afetada
- Ao desativar: notificar TODOS os usuÃ¡rios afetados
- Ao expirar: notificar admins 7 dias antes + no dia
- NotificaÃ§Ãµes via: E-mail + Sino (in-app) + Push (se habilitado)

### RN-UC03-09: ValidaÃ§Ã£o de CÃ³digo
- CÃ³digo deve ser ÃšNICO em todo o sistema
- Formato: apenas letras maiÃºsculas, nÃºmeros e underscore `[A-Z0-9_]+`
- Tamanho: 3-50 caracteres
- Exemplos vÃ¡lidos: `BI_AVANCADO`, `MULTI_IDIOMA`, `API_V2`
- Exemplos invÃ¡lidos: `bi-avancado`, `Feature 1`, `teste@123`

### RN-UC03-10: ExpiraÃ§Ã£o AutomÃ¡tica
- Job diÃ¡rio `VerificarFeaturesExpiradas` executa Ã s 03:00 AM
- Features com `DtExpiracao < NOW()` sÃ£o desativadas automaticamente
- Empresas sÃ£o notificadas 7 dias antes da expiraÃ§Ã£o
- ApÃ³s expiraÃ§Ã£o, feature pode ser reativada alterando data ou removendo expiraÃ§Ã£o

---

## 10. Interface do UsuÃ¡rio

### Tela Principal: Lista de Feature Flags

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Feature Flags                                            [+ Nova Feature]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ” Buscar...  â”‚ Status: [Todas â–¼] â”‚ Tipo: [Todos â–¼] â”‚ Categoria: [Todas â–¼] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CÃ³digo       â”‚ Nome             â”‚ Tipo   â”‚ Status   â”‚ Empresas â”‚ AÃ§Ãµes      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ BI_AVANCADO  â”‚ BI AvanÃ§ado      â”‚ [EMP]  â”‚ ğŸŸ¢ Ativa â”‚  85/151  â”‚ âœï¸ ğŸ—‘ï¸ ğŸ“Š âš™ï¸ â”‚
â”‚              â”‚                  â”‚        â”‚          â”‚ â–“â–“â–“â–“â–‘ 56%â”‚            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MULTI_IDIOMA â”‚ Multi Idioma     â”‚ [GLB]  â”‚ ğŸ”µ Roll  â”‚ 151/151  â”‚ âœï¸ ğŸ—‘ï¸ ğŸ“Š âš™ï¸ â”‚
â”‚              â”‚                  â”‚        â”‚ Fase 2/4 â”‚ â–“â–“â–“â–‘â–‘ 50%â”‚            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TEST_BETA    â”‚ Teste Beta       â”‚ [EMP]  â”‚ âšª Inati â”‚   0/151  â”‚ âœï¸ ğŸ—‘ï¸ ğŸ“Š âš™ï¸ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    PÃ¡gina 1 de 5 [â† 1 2 3 4 5 â†’]
```

### Modal: Nova Feature Flag

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Nova Feature Flag                                          [X]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ CÃ³digo *                                                        â”‚
â”‚ [BI_PREMIUM________________________]  (A-Z, 0-9, _ apenas)     â”‚
â”‚                                                                 â”‚
â”‚ Nome *                                                          â”‚
â”‚ [Business Intelligence Premium_____]                           â”‚
â”‚                                                                 â”‚
â”‚ DescriÃ§Ã£o *                                                     â”‚
â”‚ [Funcionalidades avanÃ§adas de BI   ]                           â”‚
â”‚ [com dashboards personalizÃ¡veis    ]                           â”‚
â”‚                                                                 â”‚
â”‚ Tipo *                            Categoria *                  â”‚
â”‚ [Global â–¼]                        [UI â–¼]                       â”‚
â”‚                                                                 â”‚
â”‚ Status Inicial                    Data ExpiraÃ§Ã£o               â”‚
â”‚ âšª Inativa  ğŸŸ¢ Ativa              [ğŸ“… 01/12/2025]  (Opcional)  â”‚
â”‚                                                                 â”‚
â”‚ DependÃªncias                                                    â”‚
â”‚ [ğŸ” Buscar features...]                                        â”‚
â”‚ âœ“ BI_BASICO (OBRIGATÃ“RIA)         [X]                         â”‚
â”‚ âœ“ CUSTOM_DASHBOARD (RECOMENDADA)  [X]                         â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        [Cancelar]  [Salvar]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Modal: Configurar Rollout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Configurar Rollout - BI_AVANCADO                           [X] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ EstratÃ©gia de Rollout:                                         â”‚
â”‚ âšª Empresas Piloto (seleÃ§Ã£o manual)                            â”‚
â”‚ ğŸ”µ Percentual Progressivo (0â†’25%â†’50%â†’75%â†’100%)                â”‚
â”‚ âšª Por Segmento (Tecnologia, Varejo, etc)                      â”‚
â”‚ âšª Por Porte (Pequeno, MÃ©dio, Grande)                          â”‚
â”‚ âšª Por RegiÃ£o (Sudeste, Sul, Nordeste, etc)                    â”‚
â”‚                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ ConfiguraÃ§Ã£o: Percentual Progressivo                      â”‚  â”‚
â”‚ â”‚                                                            â”‚  â”‚
â”‚ â”‚ Fase 1: 25%  â”‚ DuraÃ§Ã£o: [7] dias  â”‚ Empresas: ~38        â”‚  â”‚
â”‚ â”‚ Fase 2: 50%  â”‚ DuraÃ§Ã£o: [7] dias  â”‚ Empresas: ~76        â”‚  â”‚
â”‚ â”‚ Fase 3: 75%  â”‚ DuraÃ§Ã£o: [7] dias  â”‚ Empresas: ~113       â”‚  â”‚
â”‚ â”‚ Fase 4: 100% â”‚ Indefinido          â”‚ Empresas: 151        â”‚  â”‚
â”‚ â”‚                                                            â”‚  â”‚
â”‚ â”‚ âš™ï¸ ConfiguraÃ§Ãµes AvanÃ§adas                                 â”‚  â”‚
â”‚ â”‚ â˜‘ Rollback automÃ¡tico se taxa erro > [5]%                 â”‚  â”‚
â”‚ â”‚ â˜‘ Notificar empresas ao ativar                            â”‚  â”‚
â”‚ â”‚ â˜‘ Enviar relatÃ³rio de progresso semanal                   â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                              [Cancelar]  [Iniciar Rollout]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 11. Mensagens do Sistema

### Sucesso
- âœ… "Feature flag criada com sucesso!"
- âœ… "Feature ativada para ABC Tecnologia. 47 usuÃ¡rios afetados."
- âœ… "Rollout iniciado! Fase 1: 38 empresas (25%)"
- âœ… "Feature desativada. 85 empresas e 2.340 usuÃ¡rios afetados."

### Erro
- âŒ "CÃ³digo BI_AVANCADO jÃ¡ existe. Use outro cÃ³digo."
- âŒ "DependÃªncia circular detectada: A â†’ B â†’ C â†’ A"
- âŒ "NÃ£o Ã© possÃ­vel desativar esta feature. 3 features dependem dela."
- âŒ "Acesso Negado - VocÃª nÃ£o tem permissÃ£o SYS.FEATUREFLAGS.MANAGE"

### Aviso
- âš ï¸ "Esta feature depende de: BI_BASICO. SerÃ¡ ativada automaticamente."
- âš ï¸ "Rollout pausado - Taxa de erro: 7.2%"
- âš ï¸ "Feature expira em 7 dias (08/12/2025)"
- âš ï¸ "OperaÃ§Ã£o concluÃ­da, mas cache pode estar desatualizado"

### ConfirmaÃ§Ã£o
- â“ "Desativar feature BI_AVANCADO? 85 empresas (2.340 usuÃ¡rios) serÃ£o afetadas."
- â“ "Excluir definitivamente a feature TEST_BETA? Esta aÃ§Ã£o nÃ£o pode ser desfeita."
- â“ "Remover feature de 15 empresas e excluir?"

---

## 12. Pontos de ExtensÃ£o

- IntegraÃ§Ã£o com sistema de notificaÃ§Ãµes (RF-021)
- Webhook para eventos de feature flag (ativaÃ§Ã£o/desativaÃ§Ã£o)
- API REST pÃºblica para consulta de features
- Export/import de configuraÃ§Ãµes em JSON
- Teste A/B com rollout parcial por usuÃ¡rio (nÃ£o apenas empresa)
- Machine Learning para recomendar estratÃ©gia de rollout ideal

---

## 13. CritÃ©rios de Aceite

- [ ] Admin pode criar feature flag global com todos os campos obrigatÃ³rios
- [ ] Admin pode ativar feature para empresa especÃ­fica
- [ ] Admin pode configurar rollout gradual com 5 estratÃ©gias diferentes
- [ ] Sistema valida e bloqueia dependÃªncias circulares
- [ ] Sistema ativa dependÃªncias obrigatÃ³rias automaticamente
- [ ] Sistema registra 100% das operaÃ§Ãµes em histÃ³rico de auditoria
- [ ] Cache Redis Ã© invalidado corretamente apÃ³s cada operaÃ§Ã£o
- [ ] Sistema faz rollback automÃ¡tico em caso de erro
- [ ] Admin pode visualizar histÃ³rico completo com diff JSON
- [ ] Sistema usa soft delete (nunca exclui fisicamente)
- [ ] Rollout percentual usa consistent hashing (MurmurHash3)
- [ ] Sistema pausa rollout se taxa de erro > 5%
- [ ] Features com data expiraÃ§Ã£o sÃ£o desativadas automaticamente
- [ ] Admin Sistema vÃª apenas empresas do seu conglomerado
- [ ] Gestor vÃª apenas features da sua empresa (sem ediÃ§Ã£o)

---

**Ãšltima AtualizaÃ§Ã£o:** 2025-11-07
**Autor:** Equipe de Arquitetura
**Aprovado por:** [Pendente]

---

# UC04: Configurar Limites de Uso


---

## ğŸ“‹ InformaÃ§Ãµes Gerais

### DescriÃ§Ã£o
Este caso de uso permite que Super Administradores configurem limites de uso por conglomerado para controlar capacidade e custos. Suporta limites de usuÃ¡rios, ativos, armazenamento e chamadas de API, com alertas automÃ¡ticos ao atingir percentual configurado.

### Atores
- **Super Administrador**: Ãšnico perfil com permissÃ£o para gerenciar limites

### PrÃ©-condiÃ§Ãµes
1. UsuÃ¡rio deve estar autenticado no sistema
2. **UsuÃ¡rio deve ter permissÃ£o `SYS.LIMITES_USO.READ` e `SYS.LIMITES_USO.UPDATE`**
3. UsuÃ¡rio deve ser Super Administrador
4. Conglomerado deve existir e estar ativo

### PÃ³s-condiÃ§Ãµes
**Sucesso**:
- Limites sÃ£o atualizados no banco de dados
- Job de monitoramento Ã© notificado da mudanÃ§a
- Alertas sÃ£o enviados se uso atual exceder novo limite
- Auditoria registra alteraÃ§Ã£o

**Falha**:
- Mensagem de erro Ã© exibida
- Limites anteriores permanecem ativos

---

## ğŸ¯ Fluxo Principal

### FP-01: Visualizar Limites de Conglomerado

1. **UsuÃ¡rio** acessa "Sistema â†’ ConfiguraÃ§Ãµes â†’ Limites de Uso"
2. **Sistema** verifica permissÃ£o `SYS.LIMITES_USO.READ` e `FlSuperAdmin = 1`
3. **Sistema** exibe dropdown de conglomerados
4. **UsuÃ¡rio** seleciona conglomerado
5. **Sistema** carrega limites da tabela `Sistema_Limite_Uso`
6. **Sistema** calcula uso atual de cada limite
7. **Sistema** exibe cards com:
   - Tipo de Limite (Ã­cone + nome)
   - Limite Configurado
   - Uso Atual
   - Percentual Utilizado (barra de progresso)
   - Percentual de Alerta
   - Status do Alerta (Enviado/NÃ£o Enviado)
   - BotÃ£o "Editar"
8. **Sistema** destaca em vermelho limites que atingiram percentual de alerta
9. **Caso de uso** encerra

### FP-02: Atualizar Limite

1. No FP-01, **usuÃ¡rio** clica em "Editar" de um limite
2. **Sistema** verifica permissÃ£o `SYS.LIMITES_USO.UPDATE`
3. **Sistema** exibe modal com:
   - Tipo de Limite (readonly)
   - Conglomerado (readonly)
   - Limite Atual (nÃºmero, editÃ¡vel)
   - Uso Atual (nÃºmero, readonly, info)
   - Percentual de Alerta (slider 0-100%, default 80%)
   - Alerta por Email (checkbox)
   - Emails para Alerta (textarea, mÃºltiplos emails)
4. **UsuÃ¡rio** altera valores
5. **Sistema** valida:
   - Limite deve ser >= Uso Atual (nÃ£o pode diminuir abaixo do jÃ¡ usado)
   - Percentual de Alerta deve estar entre 50-100%
   - Emails devem ser vÃ¡lidos
6. **UsuÃ¡rio** salva
7. **Sistema** atualiza registro em `Sistema_Limite_Uso`
8. **Sistema** reseta `Fl_Alerta_Enviado = 0` se novo limite > uso atual
9. **Sistema** verifica se novo uso excede percentual de alerta:
   - Se sim: envia alerta imediatamente
10. **Sistema** registra auditoria
11. **Sistema** fecha modal e atualiza card
12. **Caso de uso** encerra

---

## ğŸ”€ Fluxos Alternativos

### FA-01: Exportar RelatÃ³rio de Uso

1. No FP-01, **usuÃ¡rio** clica em "Exportar RelatÃ³rio"
2. **Sistema** gera Excel com:
   - Aba por tipo de limite
   - HistÃ³rico de uso (30 dias)
   - GrÃ¡ficos de tendÃªncia
3. **Sistema** registra exportaÃ§Ã£o em auditoria
4. **Sistema** inicia download
5. Retorna ao FP-01

### FA-02: Ver HistÃ³rico de AlteraÃ§Ãµes de Limite

1. No FP-01, **usuÃ¡rio** clica em "HistÃ³rico" de um limite
2. **Sistema** carrega `Sistema_Limite_Uso_Historico`
3. **Sistema** exibe timeline:
   - Data/Hora da alteraÃ§Ã£o
   - UsuÃ¡rio responsÃ¡vel
   - Limite anterior â†’ Limite novo
   - Motivo (se informado)
4. **UsuÃ¡rio** fecha histÃ³rico
5. Retorna ao FP-01

### FA-03: Reenviar Alerta Manualmente

1. No FP-01, **usuÃ¡rio** clica em "Reenviar Alerta"
2. **Sistema** exibe confirmaÃ§Ã£o
3. **UsuÃ¡rio** confirma
4. **Sistema** envia emails de alerta
5. **Sistema** marca `Fl_Alerta_Enviado = 1`
6. **Sistema** atualiza card
7. Retorna ao FP-01

---

## âš ï¸ Fluxos de ExceÃ§Ã£o

### FE-01: Limite Menor que Uso Atual

1. No passo 5 do FP-02, **sistema** detecta limite < uso atual
2. **Sistema** exibe erro: "Limite nÃ£o pode ser menor que uso atual ({uso_atual})"
3. **Sistema** sugere limite mÃ­nimo = uso atual + 10%
4. Retorna ao passo 4 do FP-02

### FE-02: Uso Excede Limite ApÃ³s AtualizaÃ§Ã£o

1. No passo 9 do FP-02, **sistema** detecta uso >= (limite * percentual_alerta)
2. **Sistema** envia alerta automÃ¡tico:
   - Email para administradores do conglomerado
   - Email para emails configurados
   - NotificaÃ§Ã£o no sistema
3. **Sistema** marca `Fl_Alerta_Enviado = 1`
4. Continua no passo 10 do FP-02

### FE-03: UsuÃ¡rio NÃ£o Ã© Super Admin

1. No passo 2 do FP-01 ou FP-02, **sistema** detecta que usuÃ¡rio nÃ£o Ã© Super Admin
2. **Sistema** registra tentativa nÃ£o autorizada
3. **Sistema** exibe mensagem: "Apenas Super Administradores podem gerenciar limites"
4. **Sistema** redireciona para dashboard
5. **Caso de uso** encerra

### FE-04: Erro ao Calcular Uso Atual

1. No passo 6 do FP-01, **sistema** falha ao calcular uso
2. **Sistema** loga erro
3. **Sistema** exibe uso como "Erro ao calcular"
4. **Sistema** oferece botÃ£o "Recalcular"
5. Continua no FP-01 com dados disponÃ­veis

---

## ğŸ”— IntegraÃ§Ãµes ObrigatÃ³rias

### Central de Funcionalidades
**PermissÃµes**: `SYS.LIMITES_USO.READ`, `SYS.LIMITES_USO.UPDATE` (Super Admin only)

### InternacionalizaÃ§Ã£o
**Chaves Principais**:
- `LIMITES_USO.TITLE`: "Limites de Uso"
- `LIMITES_USO.LIMIT_TYPES.MAX_USUARIOS`: "MÃ¡ximo de UsuÃ¡rios"
- `LIMITES_USO.LIMIT_TYPES.MAX_ATIVOS`: "MÃ¡ximo de Ativos"
- `LIMITES_USO.LIMIT_TYPES.MAX_STORAGE_MB`: "Armazenamento (MB)"
- `LIMITES_USO.LIMIT_TYPES.MAX_API_CALLS_DIA`: "Chamadas API/Dia"
- `LIMITES_USO.CURRENT_USAGE`: "Uso Atual"
- `LIMITES_USO.LIMIT`: "Limite"
- `LIMITES_USO.ALERT_PERCENTAGE`: "Alerta em"
- `LIMITES_USO.ALERT_SENT`: "Alerta Enviado"
- `LIMITES_USO.ALERT_NOT_SENT`: "Alerta NÃ£o Enviado"

### Auditoria
**OperaÃ§Ãµes Auditadas**:
- Alterar limite
- Alterar percentual de alerta
- Reenviar alerta manualmente
- Exportar relatÃ³rio

### Controle de Acesso
**Perfis**: Apenas Super Administrador

---

## ğŸ”’ Regras de NegÃ³cio

### RN-UC04-01: ValidaÃ§Ã£o de Limite MÃ­nimo
```csharp
var usoAtual = await CalcularUsoAtual(idConglomerado, tipoLimite);
if (novoLimite < usoAtual)
{
    throw new BusinessException(
        $"Limite nÃ£o pode ser menor que uso atual ({usoAtual}). MÃ­nimo sugerido: {usoAtual * 1.1}"
    );
}
```

### RN-UC04-02: Envio AutomÃ¡tico de Alerta
```csharp
public async Task VerificarLimites(Guid idConglomerado)
{
    var limites = await _repository.ObterPorConglomerado(idConglomerado);

    foreach (var limite in limites)
    {
        var usoAtual = await CalcularUsoAtual(idConglomerado, limite.TipoLimite);
        var percentualUsado = (decimal)usoAtual / limite.Limite * 100;

        if (percentualUsado >= limite.PercentualAlerta && !limite.FlAlertaEnviado)
        {
            await EnviarAlerta(limite, usoAtual);
            limite.FlAlertaEnviado = true;
            await _repository.Atualizar(limite);
        }
        else if (percentualUsado < limite.PercentualAlerta && limite.FlAlertaEnviado)
        {
            // Reset flag quando uso voltar abaixo do alerta
            limite.FlAlertaEnviado = false;
            await _repository.Atualizar(limite);
        }
    }
}
```

### RN-UC04-03: CÃ¡lculo de Uso Atual
```csharp
public async Task<int> CalcularUsoAtual(Guid idConglomerado, string tipoLimite)
{
    return tipoLimite switch
    {
        "MAX_USUARIOS" => await _context.Usuario
            .CountAsync(u => u.IdConglomerado == idConglomerado && !u.FlExcluido),

        "MAX_ATIVOS" => await _context.Ativo
            .CountAsync(a => a.IdConglomerado == idConglomerado && !a.FlExcluido),

        "MAX_STORAGE_MB" => await _context.Documento
            .Where(d => d.IdConglomerado == idConglomerado)
            .SumAsync(d => d.TamanhoBytes) / 1024 / 1024,

        "MAX_API_CALLS_DIA" => await _context.ApiLog
            .Where(l => l.IdConglomerado == idConglomerado && l.DtChamada >= DateTime.Today)
            .CountAsync(),

        _ => 0
    };
}
```

### RN-UC04-04: Job de Monitoramento
```csharp
// Executar a cada 1 hora via Hangfire
public async Task MonitorarLimites()
{
    var conglomerados = await _conglomeradoRepository.ObterAtivos();

    foreach (var conglomerado in conglomerados)
    {
        await VerificarLimites(conglomerado.Id);
    }
}
```

---

## ğŸ–¥ï¸ Interface (Mockup Resumido)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“Š Limites de Uso                                   â”‚
â”‚                                                       â”‚
â”‚ Conglomerado: [Acme Corp â–¼]                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                       â”‚
â”‚ â”Œâ”€ ğŸ‘¥ MÃ¡ximo de UsuÃ¡rios â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Limite: 100 | Uso: 87 | 87% usado             â”‚   â”‚
â”‚ â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘  âš ï¸ Alerta em 80%        â”‚   â”‚
â”‚ â”‚ [âœï¸ Editar] [ğŸ“œ HistÃ³rico]                     â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                       â”‚
â”‚ â”Œâ”€ ğŸ“¦ MÃ¡ximo de Ativos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Limite: 5000 | Uso: 3240 | 65% usado           â”‚   â”‚
â”‚ â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘                            â”‚   â”‚
â”‚ â”‚ [âœï¸ Editar] [ğŸ“œ HistÃ³rico]                     â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                       â”‚
â”‚ â”Œâ”€ ğŸ’¾ Armazenamento (MB) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Limite: 10240 MB | Uso: 8956 MB | 87% usado     â”‚   â”‚
â”‚ â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘  âš ï¸ Alerta em 80%        â”‚   â”‚
â”‚ â”‚ ğŸš¨ Alerta enviado em 04/11/2025 14:30          â”‚   â”‚
â”‚ â”‚ [âœï¸ Editar] [ğŸ“§ Reenviar Alerta]               â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                       â”‚
â”‚ â”Œâ”€ ğŸ”Œ Chamadas API/Dia â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Limite: 100000 | Uso: 45230 | 45% usado         â”‚   â”‚
â”‚ â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘                            â”‚   â”‚
â”‚ â”‚ [âœï¸ Editar] [ğŸ“œ HistÃ³rico]                     â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                       â”‚
â”‚ [ğŸ“¥ Exportar RelatÃ³rio]                              â”‚
â”‚                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”— APIs REST

### GET /api/limites-uso/{idConglomerado}
**PermissÃ£o**: `SYS.LIMITES_USO.READ` + Super Admin
**Response**:
```json
{
  "conglomerado": {
    "id": "guid",
    "nome": "Acme Corp"
  },
  "limites": [
    {
      "tipoLimite": "MAX_USUARIOS",
      "limite": 100,
      "usoAtual": 87,
      "percentualUsado": 87,
      "percentualAlerta": 80,
      "flAlertaEnviado": true,
      "dtUltimoAlerta": "2025-11-04T14:30:00Z"
    }
  ]
}
```

### PUT /api/limites-uso/{id}
**PermissÃ£o**: `SYS.LIMITES_USO.UPDATE` + Super Admin
**Request**:
```json
{
  "limite": 150,
  "percentualAlerta": 85,
  "flAlertaEmail": true,
  "emailsAlerta": ["admin@acme.com", "ti@acme.com"]
}
```

### POST /api/limites-uso/{id}/reenviar-alerta
**PermissÃ£o**: `SYS.LIMITES_USO.UPDATE` + Super Admin

### GET /api/limites-uso/{id}/historico
**PermissÃ£o**: `SYS.LIMITES_USO.READ` + Super Admin

---

**Ãšltima AtualizaÃ§Ã£o**: 2025-11-04

---

# UC08 - Ocultar Feature do Sistema

**Requisito Funcional:** RF-001
**Tipo:** Funcional | Sistema
**Complexidade:** MÃ©dia
**Prioridade:** Alta

---

## 1. DescriÃ§Ã£o

Este caso de uso permite que usuÃ¡rios com perfil **Developer** (nÃ­vel hierÃ¡rquico -1) possam ocultar features do sistema que estÃ£o em desenvolvimento, garantindo que:
- Features ocultas **nÃ£o aparecem** em menus, listagens ou qualquer interface para usuÃ¡rios nÃ£o-Developer
- Features ocultas permanecem **visÃ­veis apenas para Developer**, permitindo testes e desenvolvimento contÃ­nuo
- O estado de visibilidade Ã© controlado pelo campo `FlOcultaParaSistema` na entidade `SistemaFeatureFlagAvancado`
- Todas as operaÃ§Ãµes de ocultaÃ§Ã£o/exibiÃ§Ã£o sÃ£o **auditadas** com motivo obrigatÃ³rio
- Cache Ã© **invalidado automaticamente** para garantir consistÃªncia

**Contexto de Uso:**
- Desenvolvimento de features experimentais sem exposiÃ§Ã£o prematura a usuÃ¡rios finais
- Testes internos de funcionalidades antes do release oficial
- Gradual disclosure de funcionalidades (primeiro Developer, depois todos)

---

## 2. Atores

- **Ator Principal**: Developer (hierarquia -1)
- **Atores SecundÃ¡rios**: Sistema (cache invalidation, auditoria)

---

## 3. PrÃ©-condiÃ§Ãµes

- UsuÃ¡rio autenticado com perfil **Developer** (hierarquia -1)
- PermissÃ£o `SYS.FEATUREFLAGS.HIDE_SYSTEM` associada ao perfil Developer
- Feature flag existe na tabela `Sistema_Feature_Flag_Avancado`
- Banco de dados acessÃ­vel
- Cache Redis configurado (opcional, sistema continua sem cache)

---

## 4. PÃ³s-condiÃ§Ãµes

### Sucesso (Ocultar)
- Campo `FlOcultaParaSistema` atualizado para `TRUE` no banco de dados
- Feature **desaparece** de todas listagens e menus para usuÃ¡rios nÃ£o-Developer
- Cache invalidado para chaves:
  - `feature:{codigo}:global`
  - `feature:{codigo}:*`
  - `features:*:all`
  - `dashboard:features:*`
- Registro de auditoria criado com:
  - `Id_Usuario_Alteracao`: ID do Developer
  - `Motivo`: Justificativa fornecida
  - `Tipo_Operacao`: "OCULTAR_SISTEMA"
- Mensagem de sucesso exibida ao usuÃ¡rio

### Sucesso (Exibir)
- Campo `FlOcultaParaSistema` atualizado para `FALSE` no banco de dados
- Feature **reaparece** para todos os usuÃ¡rios do sistema
- Cache invalidado (mesmas chaves)
- Registro de auditoria criado com `Tipo_Operacao = "EXIBIR_SISTEMA"`

### Falha
- Dados nÃ£o sÃ£o alterados
- Mensagem de erro Ã© exibida
- Log de erro Ã© registrado
- TransaÃ§Ã£o Ã© revertida (rollback)

---

## 5. Fluxo Principal

### 5.1. Ocultar Feature do Sistema

1. Developer acessa tela "ConfiguraÃ§Ãµes" â†’ "Feature Flags"
2. Sistema exibe grid com **todas** as features (incluindo ocultas)
3. Developer identifica feature em desenvolvimento (ex: `NOVO_RELATORIO_BETA`)
4. Developer clica no botÃ£o "ğŸ”’ Ocultar do Sistema" (Ã­cone de cadeado)
5. Sistema exibe modal de confirmaÃ§Ã£o:
   ```
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Ocultar Feature do Sistema                         [X] â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                                                         â”‚
   â”‚ Feature: NOVO_RELATORIO_BETA                           â”‚
   â”‚ Nome: Novo RelatÃ³rio de Ativos (Beta)                  â”‚
   â”‚                                                         â”‚
   â”‚ âš ï¸ Esta feature serÃ¡ ocultada de TODOS os usuÃ¡rios     â”‚
   â”‚    exceto perfis Developer.                            â”‚
   â”‚                                                         â”‚
   â”‚ Motivo da OcultaÃ§Ã£o: *                                 â”‚
   â”‚ [Feature ainda em desenvolvimento - testes internos]   â”‚
   â”‚                                                         â”‚
   â”‚                            [Cancelar]  [Confirmar]     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ```
6. Developer preenche motivo: "Feature ainda em desenvolvimento - testes internos"
7. Developer clica "Confirmar"
8. Sistema executa:
   - Valida permissÃ£o `SYS.FEATUREFLAGS.HIDE_SYSTEM`
   - Valida que usuÃ¡rio Ã© Developer (hierarquia = -1)
   - Atualiza `FlOcultaParaSistema = TRUE`
   - Registra auditoria:
     ```csharp
     {
       "Id_Usuario_Alteracao": "guid-developer",
       "Dt_Alteracao": "2025-11-07 14:30:00",
       "Tipo_Operacao": "OCULTAR_SISTEMA",
       "Motivo": "Feature ainda em desenvolvimento - testes internos",
       "Codigo_Feature": "NOVO_RELATORIO_BETA",
       "IP_Alteracao": "192.168.1.100",
       "UserAgent": "Mozilla/5.0..."
     }
     ```
   - Invalida cache em 4 padrÃµes de chaves
   - Salva alteraÃ§Ãµes no banco
9. Sistema exibe mensagem: "âœ… Feature ocultada com sucesso! Apenas Developers podem visualizÃ¡-la agora."
10. Grid atualiza mostrando badge "ğŸ”’ OCULTA" na feature

### 5.2. Exibir Feature no Sistema (Tornar VisÃ­vel)

1. Developer acessa tela "ConfiguraÃ§Ãµes" â†’ "Feature Flags"
2. Sistema exibe grid com features ocultas marcadas com badge "ğŸ”’ OCULTA"
3. Developer identifica feature pronta para release (ex: `NOVO_RELATORIO_BETA`)
4. Developer clica no botÃ£o "ğŸ”“ Exibir no Sistema" (Ã­cone de cadeado aberto)
5. Sistema exibe modal de confirmaÃ§Ã£o:
   ```
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Exibir Feature no Sistema                          [X] â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                                                         â”‚
   â”‚ Feature: NOVO_RELATORIO_BETA                           â”‚
   â”‚ Nome: Novo RelatÃ³rio de Ativos (Beta)                  â”‚
   â”‚                                                         â”‚
   â”‚ âœ… Esta feature serÃ¡ visÃ­vel para TODOS os usuÃ¡rios    â”‚
   â”‚    do sistema.                                         â”‚
   â”‚                                                         â”‚
   â”‚ Motivo da ExibiÃ§Ã£o: *                                  â”‚
   â”‚ [Testes concluÃ­dos - feature pronta para produÃ§Ã£o]    â”‚
   â”‚                                                         â”‚
   â”‚                            [Cancelar]  [Confirmar]     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ```
6. Developer preenche motivo: "Testes concluÃ­dos - feature pronta para produÃ§Ã£o"
7. Developer clica "Confirmar"
8. Sistema executa processo inverso:
   - Valida permissÃµes
   - Atualiza `FlOcultaParaSistema = FALSE`
   - Registra auditoria com `Tipo_Operacao = "EXIBIR_SISTEMA"`
   - Invalida cache
   - Salva alteraÃ§Ãµes
9. Sistema exibe mensagem: "âœ… Feature exibida com sucesso! Agora estÃ¡ visÃ­vel para todos os usuÃ¡rios."
10. Badge "ğŸ”’ OCULTA" Ã© removido do grid

### 5.3. Listar Features Filtradas (API Backend)

1. Frontend faz requisiÃ§Ã£o GET: `/api/featureflags/visiveis?incluirOcultas=false`
2. Sistema identifica perfil do usuÃ¡rio atual:
   - Se **Developer**: Query NÃƒO filtra por `FlOcultaParaSistema` (retorna todas)
   - Se **NÃ£o-Developer**: Query filtra `WHERE FlOcultaParaSistema = FALSE`
3. Sistema executa query com filtros adicionais (se fornecidos):
   - `Filtro`: Busca textual em `Codigo` ou `Nome`
   - `ApenasAtivas`: Filtra `WHERE FlEnabled = TRUE`
4. Sistema projeta para DTO:
   ```csharp
   {
     "Id": "guid",
     "Codigo": "NOVO_RELATORIO_BETA",
     "Nome": "Novo RelatÃ³rio de Ativos (Beta)",
     "FlEnabled": true,
     "FlOcultaParaSistema": true,  // SÃ³ aparece para Developer
     "EstrategiaRollout": "GLOBAL",
     "PercentualAtivacao": 100
   }
   ```
5. Sistema retorna lista ordenada por `Nome`

### 5.4. Verificar Feature Ativa (com Visibilidade)

1. Sistema recebe requisiÃ§Ã£o para verificar feature: `POST /api/featureflags/verificar`
2. Sistema busca feature pelo cÃ³digo
3. **NOVA LÃ“GICA DE VISIBILIDADE:**
   ```csharp
   if (feature.FlOcultaParaSistema)
   {
       var isDeveloper = await _currentUserService.IsDeveloperAsync();

       if (!isDeveloper)
       {
           return new FeatureAtivaDto
           {
               Codigo = request.Codigo,
               Ativa = false,
               Motivo = "Feature oculta do sistema (visÃ­vel apenas para Developer)"
           };
       }
   }
   ```
4. Se usuÃ¡rio NÃƒO Ã© Developer e feature estÃ¡ oculta â†’ retorna `Ativa = FALSE`
5. Se usuÃ¡rio Ã© Developer OU feature NÃƒO estÃ¡ oculta â†’ continua verificaÃ§Ã£o normal (`FlEnabled`, empresa, etc.)

---

## 6. Fluxos Alternativos

### 6A. Feature JÃ¡ EstÃ¡ Oculta

1. No passo 5.1.8, sistema detecta `FlOcultaParaSistema = TRUE`
2. Sistema retorna aviso:
   - "âš ï¸ Feature NOVO_RELATORIO_BETA jÃ¡ estÃ¡ oculta do sistema."
   - OperaÃ§Ã£o retorna `FALSE` (sem alteraÃ§Ã£o)
3. Log de warning Ã© registrado:
   - "Developer tentou ocultar feature jÃ¡ oculta: {Codigo}"
4. Nenhuma auditoria Ã© criada (sem mudanÃ§a de estado)

### 6B. Feature JÃ¡ EstÃ¡ VisÃ­vel

1. No passo 5.2.8, sistema detecta `FlOcultaParaSistema = FALSE`
2. Sistema retorna aviso:
   - "âš ï¸ Feature NOVO_RELATORIO_BETA jÃ¡ estÃ¡ visÃ­vel no sistema."
   - OperaÃ§Ã£o retorna `FALSE` (sem alteraÃ§Ã£o)
3. Log de warning Ã© registrado
4. Nenhuma auditoria Ã© criada

### 6C. Developer com PermissÃ£o mas Hierarquia Incorreta (Edge Case)

1. Sistema verifica `IsDeveloperAsync()` que valida hierarquia = -1
2. Se hierarquia do usuÃ¡rio nÃ£o Ã© -1 (ex: Super Admin = 0):
   - Retorna `FALSE` mesmo com permissÃ£o
   - Exibe erro: "âŒ Apenas perfil Developer pode ocultar features do sistema"
3. Log de seguranÃ§a Ã© registrado:
   - "Tentativa de ocultar feature sem perfil Developer: User={userId}, Hierarchy={level}"

---

## 7. Fluxos de ExceÃ§Ã£o

### 7A. Feature NÃ£o Encontrada

1. No passo 5.1.8, sistema busca feature por ID
2. Feature nÃ£o existe no banco de dados
3. Sistema lanÃ§a `NotFoundException`:
   - Mensagem: "Feature com ID {guid} nÃ£o encontrada."
4. TransaÃ§Ã£o Ã© revertida
5. Frontend exibe erro: "âŒ Feature nÃ£o encontrada. Pode ter sido excluÃ­da."

### 7B. PermissÃ£o Insuficiente

1. UsuÃ¡rio nÃ£o-Developer tenta acessar endpoint `POST /api/featureflags/{id}/ocultar-sistema`
2. Middleware de autorizaÃ§Ã£o valida polÃ­tica `SYS.FEATUREFLAGS.HIDE_SYSTEM`
3. PermissÃ£o nÃ£o existe para perfil do usuÃ¡rio
4. Sistema retorna HTTP 403 Forbidden:
   ```json
   {
     "error": "Acesso Negado",
     "message": "VocÃª nÃ£o tem permissÃ£o SYS.FEATUREFLAGS.HIDE_SYSTEM",
     "requiredRole": "Developer"
   }
   ```
5. Log de seguranÃ§a Ã© registrado com tentativa de acesso nÃ£o autorizado

### 7C. Erro ao Invalidar Cache

1. No passo 5.1.8, sistema tenta invalidar cache Redis
2. Redis estÃ¡ indisponÃ­vel (timeout/conexÃ£o recusada)
3. Sistema:
   - **NÃƒO falha** a operaÃ§Ã£o (cache Ã© opcional)
   - Registra log de warning:
     ```
     "Cache Redis indisponÃ­vel durante ocultaÃ§Ã£o de feature {Codigo}.
      OperaÃ§Ã£o concluÃ­da no banco, mas cache pode estar desatualizado."
     ```
   - Completa operaÃ§Ã£o normalmente
   - Exibe aviso ao usuÃ¡rio:
     - "âœ… Feature ocultada, mas cache pode levar atÃ© 5 minutos para atualizar"
4. Sistema tenta reconectar Redis em background

### 7D. Erro de Banco de Dados

1. Durante execuÃ§Ã£o de `SaveChangesAsync`, ocorre exception (deadlock, timeout, etc.)
2. Entity Framework lanÃ§a `DbUpdateException`
3. Sistema:
   - Faz rollback automÃ¡tico da transaÃ§Ã£o
   - Registra log de erro com stack trace completo
   - Retorna HTTP 500 Internal Server Error
   - Exibe mensagem genÃ©rica: "âŒ Erro ao salvar alteraÃ§Ãµes. Tente novamente."
4. Developer pode consultar logs para detalhes tÃ©cnicos

---

## 8. Requisitos NÃ£o Funcionais

### Desempenho
- OperaÃ§Ã£o de ocultar/exibir: < 1 segundo
- InvalidaÃ§Ã£o de cache: < 500ms
- Query filtrada por visibilidade: < 300ms (atÃ© 1000 features)
- MÃ©todo `IsDeveloperAsync()`: < 100ms (usa cache de claims quando disponÃ­vel)

### SeguranÃ§a
- **PermissÃ£o restrita**: Apenas Developer (hierarquia -1)
- **Auditoria completa**: 100% das operaÃ§Ãµes registradas com motivo obrigatÃ³rio
- **ValidaÃ§Ã£o dupla**: PermissÃ£o + Hierarquia
- **Log de seguranÃ§a**: Tentativas nÃ£o autorizadas registradas
- **Cache-safe**: InvalidaÃ§Ã£o garante que nÃ£o-Developers nÃ£o vejam features ocultas via cache

### Disponibilidade
- **Graceful degradation**: Sistema continua funcionando se Redis falhar
- **TransaÃ§Ãµes atÃ´micas**: Rollback automÃ¡tico em caso de erro
- **IdempotÃªncia**: Ocultar feature jÃ¡ oculta nÃ£o causa erro fatal

### Usabilidade
- **Feedback visual**: Badge "ğŸ”’ OCULTA" em features ocultas
- **Mensagens claras**: IndicaÃ§Ã£o explÃ­cita de quem pode ver a feature
- **Reversibilidade**: OperaÃ§Ã£o de exibir reverte ocultaÃ§Ã£o completamente
- **Motivo obrigatÃ³rio**: Garante rastreabilidade e documentaÃ§Ã£o

---

## 9. Regras de NegÃ³cio

### RN-UC08-01: Visibilidade Baseada em Hierarquia
- **Developer (hierarquia -1)**: VÃª TODAS as features (ocultas e visÃ­veis)
- **Outros perfis (hierarquia >= 0)**: Veem APENAS features com `FlOcultaParaSistema = FALSE`
- Hierarquia Ã© verificada via `ICurrentUserService.IsDeveloperAsync()`
- VerificaÃ§Ã£o usa claims JWT quando disponÃ­vel (performance)
- Fallback para banco de dados se claims nÃ£o disponÃ­veis

### RN-UC08-02: PrecedÃªncia de OcultaÃ§Ã£o
- Se `FlOcultaParaSistema = TRUE` â†’ Feature NÃƒO aparece para nÃ£o-Developers
- **Independente** de `FlEnabled` (pode estar ativa mas oculta)
- **Independente** de empresas alvos (pode estar configurada mas oculta)
- **OcultaÃ§Ã£o tem prioridade** sobre todas as outras validaÃ§Ãµes para nÃ£o-Developers

### RN-UC08-03: Auditoria ObrigatÃ³ria
- **Motivo Ã© OBRIGATÃ“RIO** para ocultar e exibir
- Motivo deve ter mÃ­nimo 10 caracteres, mÃ¡ximo 500
- Auditoria registra:
  - `Id_Usuario_Alteracao`, `Dt_Alteracao`, `Tipo_Operacao`
  - `Motivo`, `Codigo_Feature`
  - Opcionais: `IP_Alteracao`, `UserAgent`
- HistÃ³rico permanece acessÃ­vel mesmo se feature for excluÃ­da

### RN-UC08-04: InvalidaÃ§Ã£o de Cache
- Ao ocultar/exibir, invalidar padrÃµes de chaves:
  1. `feature:{codigo}:global` - Cache global da feature
  2. `feature:{codigo}:*` - Todos os caches da feature (wildcard)
  3. `features:*:all` - Listas de features de todas empresas
  4. `dashboard:features:*` - Dashboards de feature flags
- InvalidaÃ§Ã£o Ã© **best-effort** (nÃ£o bloqueia se Redis falhar)
- TTL padrÃ£o: 5 minutos

### RN-UC08-05: PermissÃ£o Exclusiva Developer
- PermissÃ£o `SYS.FEATUREFLAGS.HIDE_SYSTEM` sÃ³ existe em perfil Developer
- **NÃƒO pode** ser concedida a outros perfis (seguranÃ§a)
- ValidaÃ§Ã£o adicional: `IsDeveloperAsync()` garante hierarquia -1
- Super Admin (hierarquia 0) **NÃƒO tem** acesso a esta funcionalidade

### RN-UC08-06: Comportamento em Queries
- `ListarFeaturesFiltradasQuery`:
  - Developer: Retorna todas (incluindo ocultas se `IncluirOcultas = true`)
  - NÃ£o-Developer: **SEMPRE** filtra ocultas (ignora parÃ¢metro `IncluirOcultas`)
- `VerificarFeatureAtivaQuery`:
  - Se oculta + nÃ£o-Developer â†’ retorna `Ativa = FALSE` com motivo especÃ­fico
  - Se oculta + Developer â†’ continua verificaÃ§Ã£o normal
- Endpoints de listagem em APIs pÃºblicas **NUNCA** retornam features ocultas (exceto para Developer)

---

## 10. Interface do UsuÃ¡rio

### Grid de Features (VisÃ£o Developer)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Feature Flags                                            [+ Nova Feature]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ” Buscar...  â”‚ Status: [Todas â–¼] â”‚ Visibilidade: [Todas â–¼] â”‚ Tipo: [Todas] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CÃ³digo           â”‚ Nome             â”‚ Tipo   â”‚ Status   â”‚ VisÃ­velâ”‚ AÃ§Ãµes    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ BI_AVANCADO      â”‚ BI AvanÃ§ado      â”‚ [EMP]  â”‚ ğŸŸ¢ Ativa â”‚   âœ…   â”‚ âœï¸ ğŸ”’ ğŸ“Š â”‚
â”‚                  â”‚                  â”‚        â”‚          â”‚        â”‚          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ NOVO_RELATORIO   â”‚ Novo RelatÃ³rio   â”‚ [GLB]  â”‚ ğŸŸ¡ Inati â”‚ ğŸ”’ NÃƒO â”‚ âœï¸ ğŸ”“ ğŸ“Š â”‚
â”‚ _BETA            â”‚ (Beta)           â”‚        â”‚          â”‚  OCULTAâ”‚          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MULTI_IDIOMA     â”‚ Multi Idioma     â”‚ [GLB]  â”‚ ğŸŸ¢ Ativa â”‚   âœ…   â”‚ âœï¸ ğŸ”’ ğŸ“Š â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              Legenda: ğŸ”’ = Ocultar | ğŸ”“ = Exibir | âœï¸ = Editar
```

### Grid de Features (VisÃ£o NÃ£o-Developer)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Feature Flags                                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ” Buscar...  â”‚ Status: [Todas â–¼] â”‚ Tipo: [Todas â–¼]                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CÃ³digo           â”‚ Nome             â”‚ Tipo   â”‚ Status   â”‚ Empresas          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ BI_AVANCADO      â”‚ BI AvanÃ§ado      â”‚ [EMP]  â”‚ ğŸŸ¢ Ativa â”‚  85/151           â”‚
â”‚                  â”‚                  â”‚        â”‚          â”‚ â–“â–“â–“â–“â–‘ 56%         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MULTI_IDIOMA     â”‚ Multi Idioma     â”‚ [GLB]  â”‚ ğŸŸ¢ Ativa â”‚ 151/151           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        Nota: NOVO_RELATORIO_BETA nÃ£o aparece (estÃ¡ oculta)
```

### Modal de ConfirmaÃ§Ã£o - Ocultar

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ocultar Feature do Sistema                                [X]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ Feature: NOVO_RELATORIO_BETA                                   â”‚
â”‚ Nome: Novo RelatÃ³rio de Ativos (Beta)                          â”‚
â”‚                                                                 â”‚
â”‚ âš ï¸ IMPORTANTE:                                                  â”‚
â”‚ â€¢ Esta feature serÃ¡ OCULTADA de todos os usuÃ¡rios              â”‚
â”‚ â€¢ Apenas perfis Developer poderÃ£o visualizÃ¡-la                â”‚
â”‚ â€¢ Menus, listagens e interfaces nÃ£o mostrarÃ£o esta feature    â”‚
â”‚ â€¢ UsuÃ¡rios nÃ£o-Developer receberÃ£o erro ao tentar acessar     â”‚
â”‚                                                                 â”‚
â”‚ Motivo da OcultaÃ§Ã£o: *                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚Feature em desenvolvimento - testes internos             â”‚  â”‚
â”‚ â”‚                                                            â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚ (MÃ­nimo: 10 caracteres, MÃ¡ximo: 500)                          â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                  [Cancelar]  [Confirmar]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Modal de ConfirmaÃ§Ã£o - Exibir

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Exibir Feature no Sistema                                 [X]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ Feature: NOVO_RELATORIO_BETA                                   â”‚
â”‚ Nome: Novo RelatÃ³rio de Ativos (Beta)                          â”‚
â”‚                                                                 â”‚
â”‚ âœ… CONFIRMAÃ‡ÃƒO:                                                 â”‚
â”‚ â€¢ Esta feature serÃ¡ EXIBIDA para todos os usuÃ¡rios             â”‚
â”‚ â€¢ AparecerÃ¡ em menus, listagens e interfaces                  â”‚
â”‚ â€¢ Todos os perfis poderÃ£o visualizar (se tiverem permissÃ£o)   â”‚
â”‚ â€¢ Esta aÃ§Ã£o torna a feature "pÃºblica" no sistema              â”‚
â”‚                                                                 â”‚
â”‚ Motivo da ExibiÃ§Ã£o: *                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚Testes concluÃ­dos - feature pronta para produÃ§Ã£o         â”‚  â”‚
â”‚ â”‚                                                            â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚ (MÃ­nimo: 10 caracteres, MÃ¡ximo: 500)                          â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                  [Cancelar]  [Confirmar]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 11. Mensagens do Sistema

### Sucesso
- âœ… "Feature ocultada com sucesso! Apenas Developers podem visualizÃ¡-la agora."
- âœ… "Feature exibida com sucesso! Agora estÃ¡ visÃ­vel para todos os usuÃ¡rios."
- âœ… "Visibilidade da feature {Codigo} atualizada."

### Erro
- âŒ "Feature com ID {guid} nÃ£o encontrada."
- âŒ "Acesso Negado - VocÃª nÃ£o tem permissÃ£o SYS.FEATUREFLAGS.HIDE_SYSTEM"
- âŒ "Apenas perfil Developer pode ocultar features do sistema"
- âŒ "Motivo da ocultaÃ§Ã£o Ã© obrigatÃ³rio (mÃ­nimo 10 caracteres)"
- âŒ "Erro ao salvar alteraÃ§Ãµes. Tente novamente."

### Aviso
- âš ï¸ "Feature {Codigo} jÃ¡ estÃ¡ oculta do sistema."
- âš ï¸ "Feature {Codigo} jÃ¡ estÃ¡ visÃ­vel no sistema."
- âš ï¸ "Feature ocultada, mas cache pode levar atÃ© 5 minutos para atualizar"
- âš ï¸ "Cache Redis indisponÃ­vel - operaÃ§Ã£o concluÃ­da, mas pode haver atraso na atualizaÃ§Ã£o"

### Info (para nÃ£o-Developers tentando acessar feature oculta)
- â„¹ï¸ "Feature nÃ£o encontrada ou indisponÃ­vel"
- â„¹ï¸ "Esta funcionalidade nÃ£o estÃ¡ disponÃ­vel no momento"

---

## 12. Endpoints da API

### POST /api/featureflags/{id}/ocultar-sistema
**DescriÃ§Ã£o:** Oculta uma feature do sistema (apenas Developer)

**Request Body:**
```json
{
  "motivo": "Feature ainda em desenvolvimento - testes internos"
}
```

**Response 200 OK:**
```json
{
  "success": true,
  "message": "Feature ocultada com sucesso",
  "featureCodigo": "NOVO_RELATORIO_BETA"
}
```

**Response 400 Bad Request:**
```json
{
  "success": false,
  "message": "Feature jÃ¡ estÃ¡ oculta do sistema"
}
```

**Response 403 Forbidden:**
```json
{
  "error": "Acesso Negado",
  "message": "Apenas perfil Developer pode ocultar features",
  "requiredPermission": "SYS.FEATUREFLAGS.HIDE_SYSTEM"
}
```

**Response 404 Not Found:**
```json
{
  "error": "NÃ£o Encontrado",
  "message": "Feature com ID {guid} nÃ£o encontrada"
}
```

### POST /api/featureflags/{id}/exibir-sistema
**DescriÃ§Ã£o:** Exibe (torna visÃ­vel) uma feature do sistema

**Request Body:**
```json
{
  "motivo": "Testes concluÃ­dos - feature pronta para produÃ§Ã£o"
}
```

**Response:** Mesmo formato do endpoint acima

### GET /api/featureflags/visiveis
**DescriÃ§Ã£o:** Lista features visÃ­veis para o perfil do usuÃ¡rio

**Query Parameters:**
- `incluirOcultas` (bool, default: false): Incluir features ocultas (apenas Developer)
- `filtro` (string, optional): Busca textual em cÃ³digo ou nome
- `apenasAtivas` (bool, default: false): Apenas features com `FlEnabled = true`

**Response 200 OK:**
```json
{
  "features": [
    {
      "id": "guid-1",
      "codigo": "BI_AVANCADO",
      "nome": "BI AvanÃ§ado",
      "descricao": "Business Intelligence com dashboards avanÃ§ados",
      "flEnabled": true,
      "flOcultaParaSistema": false,
      "estrategiaRollout": "PERCENTUAL_EMPRESAS",
      "percentualAtivacao": 50
    }
    // NOVO_RELATORIO_BETA nÃ£o aparece aqui (oculta para nÃ£o-Developer)
  ],
  "total": 15
}
```

**Response 200 OK (Developer com incluirOcultas=true):**
```json
{
  "features": [
    {
      "id": "guid-1",
      "codigo": "BI_AVANCADO",
      "nome": "BI AvanÃ§ado",
      "flEnabled": true,
      "flOcultaParaSistema": false
    },
    {
      "id": "guid-2",
      "codigo": "NOVO_RELATORIO_BETA",
      "nome": "Novo RelatÃ³rio (Beta)",
      "flEnabled": false,
      "flOcultaParaSistema": true  // Developer vÃª esta propriedade
    }
  ],
  "total": 16
}
```

---

## 13. Pontos de ExtensÃ£o

- IntegraÃ§Ã£o com sistema de notificaÃ§Ãµes para alertar Developers quando feature Ã© exibida
- Dashboard de features ocultas com mÃ©tricas de tempo mÃ©dio atÃ© exibiÃ§Ã£o
- Agendamento automÃ¡tico de exibiÃ§Ã£o (ex: "Exibir automaticamente em 7 dias")
- HistÃ³rico de tentativas de acesso a features ocultas por nÃ£o-Developers (analytics)
- Feature preview por grupo de usuÃ¡rios (alÃ©m de apenas Developer)
- Export de relatÃ³rio de features ocultas para compliance

---

## 14. CritÃ©rios de Aceite

- [ ] Developer pode ocultar feature do sistema com motivo obrigatÃ³rio
- [ ] Developer pode exibir feature previamente oculta com motivo obrigatÃ³rio
- [ ] Feature oculta NÃƒO aparece em listagens para usuÃ¡rios nÃ£o-Developer
- [ ] Feature oculta SEMPRE aparece para Developer (mesmo sem flag `incluirOcultas`)
- [ ] Query `VerificarFeatureAtivaQuery` retorna `Ativa = FALSE` para nÃ£o-Developer se feature oculta
- [ ] Query `ListarFeaturesFiltradasQuery` filtra ocultas automaticamente para nÃ£o-Developer
- [ ] PermissÃ£o `SYS.FEATUREFLAGS.HIDE_SYSTEM` existe e estÃ¡ associada apenas a Developer
- [ ] MÃ©todo `IsDeveloperAsync()` verifica corretamente hierarquia = -1
- [ ] Cache Ã© invalidado em 4 padrÃµes de chaves apÃ³s ocultar/exibir
- [ ] Sistema continua funcionando se Redis estiver indisponÃ­vel (graceful degradation)
- [ ] Auditoria registra 100% das operaÃ§Ãµes com motivo, usuÃ¡rio e data
- [ ] Motivo tem validaÃ§Ã£o: mÃ­nimo 10 caracteres, mÃ¡ximo 500
- [ ] Tentativa de ocultar feature jÃ¡ oculta retorna aviso (sem erro fatal)
- [ ] Tentativa de exibir feature jÃ¡ visÃ­vel retorna aviso (sem erro fatal)
- [ ] UsuÃ¡rio nÃ£o-Developer recebe HTTP 403 ao tentar acessar endpoints de ocultar/exibir
- [ ] Badge "ğŸ”’ OCULTA" aparece no grid para Developer
- [ ] Grid de nÃ£o-Developer nÃ£o mostra coluna "Visibilidade" nem features ocultas
- [ ] Migration `AddFlOcultaParaSistemaToFeatureFlags` aplicada com sucesso
- [ ] Ãndices criados: individual em `FlOcultaParaSistema` e composto em `(FlEnabled, FlOcultaParaSistema, FlExcluido)`

---

## 15. ImplementaÃ§Ã£o TÃ©cnica

### Entidade Domain

**Arquivo:** `src/Domain/Entities/SistemaFeatureFlagAvancado.cs`

```csharp
/// <summary>
/// Se a feature estÃ¡ oculta do sistema para usuÃ¡rios nÃ£o-Developer
/// Quando true, a feature NÃƒO aparece em menus, listagens ou qualquer interface
/// para perfis que nÃ£o sejam Developer, independente do FlEnabled
/// Usado para desenvolvimento de features sem exposiÃ§Ã£o aos usuÃ¡rios finais
/// </summary>
public bool FlOcultaParaSistema { get; set; } = false;
```

### Configuration

**Arquivo:** `src/Infrastructure/Data/Configurations/SistemaFeatureFlagAvancadoConfiguration.cs`

```csharp
// OcultaÃ§Ã£o para desenvolvimento
builder.Property(f => f.FlOcultaParaSistema)
    .IsRequired()
    .HasDefaultValue(false);

// Index individual
builder.HasIndex(f => f.FlOcultaParaSistema)
    .HasDatabaseName("IX_SistemaFeatureFlagsAvancados_FlOcultaParaSistema");

// Index composto para queries de visibilidade
builder.HasIndex(f => new { f.FlEnabled, f.FlOcultaParaSistema, f.FlExcluido })
    .HasDatabaseName("IX_SistemaFeatureFlagsAvancados_Visibilidade");
```

### Commands

**Arquivo:** `src/Application/FeatureFlags/Commands/OcultarFeatureDoSistema/OcultarFeatureDoSistemaCommand.cs`

```csharp
[Authorize(Policy = FeatureFlagsPermissions.HideFromSystem)]
public record OcultarFeatureDoSistemaCommand : IRequest<bool>
{
    public Guid FeatureFlagId { get; init; }

    [Required(ErrorMessage = "Motivo Ã© obrigatÃ³rio")]
    [StringLength(500, MinimumLength = 10, ErrorMessage = "Motivo deve ter entre 10 e 500 caracteres")]
    public string Motivo { get; init; } = string.Empty;
}
```

### Queries

**Arquivo:** `src/Application/FeatureFlags/Queries/ListarFeaturesFiltradas/ListarFeaturesFiltradasQuery.cs`

```csharp
public async Task<List<FeatureFlagDto>> Handle(ListarFeaturesFiltradasQuery request, CancellationToken cancellationToken)
{
    // Verificar se usuÃ¡rio Ã© Developer
    var isDeveloper = await _currentUserService.IsDeveloperAsync();

    var query = _context.SistemaFeatureFlagsAvancados
        .Where(f => !f.FlExcluido);

    // Se nÃ£o Ã© Developer, filtrar features ocultas
    if (!isDeveloper)
    {
        query = query.Where(f => !f.FlOcultaParaSistema);
    }
    else if (!request.IncluirOcultas)
    {
        query = query.Where(f => !f.FlOcultaParaSistema);
    }

    return await query
        .OrderBy(f => f.Nome)
        .Select(f => new FeatureFlagDto { ... })
        .ToListAsync(cancellationToken);
}
```

### Endpoints

**Arquivo:** `src/Web/Endpoints/FeatureFlagsEmpresa.cs`

```csharp
group.MapPost("{id}/ocultar-sistema", OcultarFeatureDoSistema)
    .WithName("OcultarFeatureDoSistema")
    .WithSummary("Ocultar feature do sistema (apenas Developer)")
    .RequireAuthorization();

group.MapPost("{id}/exibir-sistema", ExibirFeatureNoSistema)
    .WithName("ExibirFeatureNoSistema")
    .WithSummary("Exibir feature no sistema (apenas Developer)")
    .RequireAuthorization();

group.MapGet("visiveis", ListarFeaturesFiltradas)
    .WithName("ListarFeaturesFiltradas")
    .WithSummary("Listar features visÃ­veis (respeitando perfil)")
    .RequireAuthorization();
```

### PermissÃ£o SQL

**Arquivo:** `src/Web/insert_rf001_feature_hide_permissions.sql`

```sql
INSERT INTO Permissions (Id, Codigo, Nome, Descricao, Modulo, Entidade, Acao, Ativo, Created, CreatedBy, LastModified, LastModifiedBy, FlCritica)
SELECT
    [GUID GENERATION],
    'SYS.FEATUREFLAGS.HIDE_SYSTEM',
    'Ocultar/Exibir Features do Sistema',
    'Permite ocultar features em desenvolvimento da interface de usuÃ¡rios nÃ£o-Developer. Features ocultas permanecem visÃ­veis apenas para o perfil Developer.',
    'Sistema',
    'FeatureFlags',
    'Hide',
    1,
    datetime('now'),
    'system',
    datetime('now'),
    'system',
    0
WHERE NOT EXISTS (
    SELECT 1 FROM Permissions WHERE Codigo = 'SYS.FEATUREFLAGS.HIDE_SYSTEM'
);

-- Associar ao perfil Developer
INSERT INTO RolePermissions (RoleId, PermissionId)
SELECT r.Id, p.Id
FROM Roles r
CROSS JOIN Permissions p
WHERE r.Nome = 'Developer'
  AND p.Codigo = 'SYS.FEATUREFLAGS.HIDE_SYSTEM'
  AND NOT EXISTS (
      SELECT 1 FROM RolePermissions rp
      WHERE rp.RoleId = r.Id AND rp.PermissionId = p.Id
  );
```

---

**Ãšltima AtualizaÃ§Ã£o:** 2025-11-07
**Autor:** Equipe de Arquitetura
**Aprovado por:** [Pendente]

---

## HistÃ³rico de AlteraÃ§Ãµes

| VersÃ£o | Data | Autor | DescriÃ§Ã£o |
|--------|------|-------|-----------|
| 1.0 | 2025-12-17 | Sistema | ConsolidaÃ§Ã£o de 6 casos de uso |
