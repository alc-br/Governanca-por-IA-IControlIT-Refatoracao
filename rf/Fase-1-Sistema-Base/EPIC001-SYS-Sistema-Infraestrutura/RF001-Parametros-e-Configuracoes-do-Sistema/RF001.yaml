# =============================================
# RF001 - Requisito Funcional (Contrato Canônico)
# Gerado manualmente via análise de IA
# Data: 2025-12-29 16:50:00
# Autor: Agência ALC - alc.dev.br
# =============================================

rf:
  id: RF001
  nome: Sistema de Parâmetros e Configurações Centralizadas
  versao: '2.0'
  data: '2025-12-29'
  fase: Fase-1-Sistema-Base
  epic: EPIC001-SYS-Sistema-Infraestrutura
  status: active

descricao:
  objetivo: |
    Implementar o Sistema de Parâmetros e Configurações Centralizadas do IControlIT, responsável por gerenciar todas as configurações do sistema de forma flexível, segura e auditável, permitindo que administradores personalizem comportamentos do sistema sem necessidade de alteração de código.
  problema_resolvido: |
    Eliminar necessidade de alteração de código para ajustar comportamentos do sistema. Permitir configuração flexível por conglomerado (multi-tenant). Armazenar dados sensíveis de forma segura (criptografia AES-256). Auditar todas as alterações em configurações.
  publico_afetado: |
    Administradores de Sistema, Administradores de TI, Gerentes de Operações, Auditores, Super Administradores.

escopo:
  incluso:
    - Criar, atualizar, listar e excluir parâmetros de sistema
    - Gerenciar feature flags com rollout gradual
    - Configurar provedores de e-mail (SMTP, SendGrid, AWS SES)
    - Definir e monitorar limites de uso por conglomerado
    - Validar valores conforme tipo de dado (String, Integer, Decimal, Boolean, Date, JSON)
    - Criptografar dados sensíveis (senhas, API keys, tokens)
    - Registrar histórico completo de alterações (auditoria)
    - Controle de acesso baseado em permissões (RBAC)
    - Isolamento multi-tenant (parâmetros por conglomerado ou globais)
    - Configuração dinâmica em runtime (cache invalidation)
    - Categorização de parâmetros (Sistema, Segurança, Integração, Notificação, Relatório)
    - Proteção de parâmetros críticos (não editáveis via UI)
  fora:
    - Interface visual específica (detalhes de layout, cores, fontes)
    - Tecnologia, framework ou linguagem de implementação
    - Estratégia de deploy ou infraestrutura de hospedagem
    - Integração com ferramentas específicas de monitoramento (Application Insights, Grafana)

entidades:
  - nome: Sistema_Parametro
    descricao: Configuração do sistema com código único, valor tipado e validações
    multi_tenant: true
    soft_delete: true
    auditoria: true
    campos:
      - nome: Cd_Parametro
        tipo: string
        obrigatorio: true
        unicidade: true
        descricao: Código único do parâmetro por conglomerado
      - nome: Nm_Parametro
        tipo: string
        obrigatorio: true
        descricao: Nome legível do parâmetro
      - nome: Ds_Parametro
        tipo: string
        obrigatorio: true
        descricao: Descrição detalhada do parâmetro
      - nome: Tipo_Dado
        tipo: enum
        valores: [String, Integer, Decimal, Boolean, Date, JSON]
        obrigatorio: true
        descricao: Tipo de dado do valor
      - nome: Categoria
        tipo: enum
        valores: [Sistema, Segurança, Integração, Notificação, Relatório]
        obrigatorio: true
        descricao: Categoria do parâmetro
      - nome: Fl_Sensivel
        tipo: boolean
        obrigatorio: true
        descricao: Indica se valor requer criptografia AES-256
      - nome: Fl_Sistema
        tipo: boolean
        obrigatorio: true
        descricao: Indica se parâmetro não pode ser editado via UI
      - nome: Fl_Obrigatorio
        tipo: boolean
        obrigatorio: true
        descricao: Indica se valor não pode ser nulo
      - nome: Regex_Validacao
        tipo: string
        obrigatorio: false
        descricao: Regex para validação de valor String
      - nome: Valor_Minimo
        tipo: decimal
        obrigatorio: false
        descricao: Valor mínimo para Integer/Decimal
      - nome: Valor_Maximo
        tipo: decimal
        obrigatorio: false
        descricao: Valor máximo para Integer/Decimal
      - nome: Opcoes_Validas
        tipo: string
        obrigatorio: false
        descricao: Lista de opções válidas separadas por vírgula
      - nome: Valor_Padrao
        tipo: string
        obrigatorio: false
        descricao: Valor padrão para parâmetros obrigatórios

  - nome: Sistema_Feature_Flag
    descricao: Interruptor para ativar/desativar funcionalidades de forma controlada
    multi_tenant: true
    soft_delete: true
    auditoria: true
    campos:
      - nome: Cd_Feature
        tipo: string
        obrigatorio: true
        unicidade: true
        descricao: Código único da feature flag
      - nome: Nm_Feature
        tipo: string
        obrigatorio: true
        descricao: Nome legível da feature
      - nome: Ds_Feature
        tipo: string
        obrigatorio: true
        descricao: Descrição detalhada da feature
      - nome: Fl_Ativa
        tipo: boolean
        obrigatorio: true
        descricao: Indica se feature está ativa
      - nome: Tipo_Rollout
        tipo: enum
        valores: [All, Percentage, UserList, DateRange]
        obrigatorio: true
        descricao: Tipo de rollout gradual
      - nome: Percentual_Rollout
        tipo: integer
        obrigatorio: false
        descricao: Percentual de usuários (0-100) quando Tipo_Rollout = Percentage
      - nome: Lista_Usuarios
        tipo: string
        obrigatorio: false
        descricao: IDs de usuários separados por vírgula quando Tipo_Rollout = UserList
      - nome: Data_Inicio
        tipo: date
        obrigatorio: false
        descricao: Data de início quando Tipo_Rollout = DateRange
      - nome: Data_Fim
        tipo: date
        obrigatorio: false
        descricao: Data de fim quando Tipo_Rollout = DateRange

  - nome: Sistema_Configuracao_Email
    descricao: Credenciais e configurações de provedor SMTP/SendGrid/AWS SES
    multi_tenant: true
    soft_delete: true
    auditoria: true
    campos:
      - nome: Provedor
        tipo: enum
        valores: [SMTP, SendGrid, AWS_SES]
        obrigatorio: true
        descricao: Provedor de e-mail
      - nome: Servidor_Smtp
        tipo: string
        obrigatorio: true_condicional
        descricao: Servidor SMTP (obrigatório se Provedor = SMTP)
      - nome: Porta_Smtp
        tipo: integer
        obrigatorio: true_condicional
        descricao: Porta SMTP (1-65535, obrigatório se Provedor = SMTP)
      - nome: Usuario
        tipo: string
        obrigatorio: true
        descricao: Usuário de autenticação
      - nome: Senha
        tipo: string
        obrigatorio: true
        descricao: Senha criptografada AES-256
      - nome: Fl_Usar_Ssl
        tipo: boolean
        obrigatorio: true
        descricao: Indica se deve usar SSL/TLS
      - nome: Email_Remetente
        tipo: string
        obrigatorio: true
        descricao: E-mail remetente
      - nome: Nome_Remetente
        tipo: string
        obrigatorio: true
        descricao: Nome remetente
      - nome: Fl_Principal
        tipo: boolean
        obrigatorio: true
        descricao: Indica se é configuração principal do conglomerado

  - nome: Sistema_Limite_Uso
    descricao: Restrição quantitativa por conglomerado (usuários, ativos, storage, API calls)
    multi_tenant: true
    soft_delete: true
    auditoria: true
    campos:
      - nome: Tipo_Limite
        tipo: enum
        valores: [MAX_USUARIOS, MAX_ATIVOS, MAX_STORAGE_MB, MAX_API_CALLS_DIA]
        obrigatorio: true
        unicidade: true
        descricao: Tipo de limite (único por conglomerado)
      - nome: Limite
        tipo: integer
        obrigatorio: true
        descricao: Valor máximo permitido
      - nome: Uso_Atual
        tipo: integer
        obrigatorio: true
        descricao: Valor atual de uso
      - nome: Percentual_Alerta
        tipo: integer
        obrigatorio: true
        descricao: "Percentual para envio de alerta (ex: 80)"
      - nome: Fl_Alerta_Enviado
        tipo: boolean
        obrigatorio: true
        descricao: Indica se alerta já foi enviado

regras_negocio:
  - id: RN-SYS-001-01
    descricao: O código do parâmetro (Cd_Parametro) deve ser único por conglomerado
    tipo: unicidade
    campos_afetados: [Cd_Parametro]
    obrigatorio: true
    criterio_aceite: Tentativa de criar parâmetro duplicado → rejeição HTTP 409 (Conflict)

  - id: RN-SYS-001-02
    descricao: Valor do parâmetro deve ser validado conforme tipo de dado declarado (String, Integer, Decimal, Boolean, Date, JSON)
    tipo: validacao
    campos_afetados: [Tipo_Dado, Vl_String, Vl_Inteiro, Vl_Decimal, Vl_Boolean, Vl_Data, Vl_Json]
    obrigatorio: true
    criterio_aceite: Valor inválido → rejeição HTTP 400 com mensagem específica por tipo

  - id: RN-SYS-001-03
    descricao: Parâmetros de sistema (Fl_Sistema = 1) não podem ser editados ou excluídos via interface
    tipo: restricao
    campos_afetados: [Fl_Sistema]
    obrigatorio: true
    criterio_aceite: Tentativa de UPDATE/DELETE parâmetro de sistema → rejeição HTTP 403 (Forbidden)

  - id: RN-SYS-001-04
    descricao: Parâmetros sensíveis (Fl_Sensivel = 1) devem ter valores criptografados em AES-256
    tipo: seguranca
    campos_afetados: [Fl_Sensivel, Vl_String]
    obrigatorio: true
    criterio_aceite: Valor sensível criptografado automaticamente ao salvar; descriptografado apenas para Super Admin com permissão SYS.PARAMETROS.VIEW_SENSITIVE

  - id: RN-SYS-001-05
    descricao: Se Opcoes_Validas preenchido, valor deve estar na lista de opções separadas por vírgula
    tipo: validacao
    campos_afetados: [Opcoes_Validas]
    obrigatorio: true
    criterio_aceite: Valor fora da lista → rejeição HTTP 400 com mensagem de opções válidas

  - id: RN-SYS-001-06
    descricao: Parâmetros obrigatórios (Fl_Obrigatorio = 1) não podem ter valor nulo
    tipo: validacao
    campos_afetados: [Fl_Obrigatorio]
    obrigatorio: true
    criterio_aceite: Valor ausente → rejeição HTTP 400; usar Valor_Padrao se especificado

  - id: RN-SYS-001-07
    descricao: Todas as operações (CREATE, UPDATE, DELETE, ACCESS) devem ser registradas em Sistema_Parametro_Historico
    tipo: auditoria
    campos_afetados: ["*"]
    obrigatorio: true
    criterio_aceite: Histórico registra usuário, data/hora, IP, User-Agent, diff JSON (UPDATE), retenção 7 anos

  - id: RN-SYS-001-08
    descricao: Feature flags podem ser globais (Id_Conglomerado = NULL) ou específicas por conglomerado; flag específica tem prioridade
    tipo: logica
    campos_afetados: [Id_Conglomerado]
    obrigatorio: true
    criterio_aceite: Verificar flag específica primeiro; se não existir, verificar flag global

  - id: RN-SYS-001-09
    descricao: Features com Tipo_Rollout = Percentage devem calcular hash determinístico do Id_Usuario para consistência
    tipo: logica
    campos_afetados: [Tipo_Rollout, Percentual_Rollout]
    obrigatorio: true
    criterio_aceite: Hash(Id_Usuario) % 100 < Percentual_Rollout → feature ativa; mesmo usuário sempre mesmo resultado

  - id: RN-SYS-001-10
    descricao: Apenas uma configuração de e-mail pode ser principal (Fl_Principal = 1) por conglomerado
    tipo: unicidade
    campos_afetados: [Fl_Principal]
    obrigatorio: true
    criterio_aceite: Ao marcar como principal, desmarcar automaticamente outras do conglomerado

  - id: RN-SYS-001-11
    descricao: Configurações SMTP devem ter servidor, porta (1-65535) e credenciais válidas
    tipo: validacao
    campos_afetados: [Provedor, Servidor_Smtp, Porta_Smtp]
    obrigatorio: true
    criterio_aceite: Campos obrigatórios preenchidos; senha criptografada; opcionalmente testar conexão SMTP

  - id: RN-SYS-001-12
    descricao: Cada Tipo_Limite deve ser único por conglomerado; atualizar Uso_Atual quando operações afetadas ocorrerem
    tipo: unicidade
    campos_afetados: [Tipo_Limite, Uso_Atual]
    obrigatorio: true
    criterio_aceite: Constraint UNIQUE (Id_Conglomerado, Tipo_Limite); bloquear operação quando Uso_Atual >= Limite

  - id: RN-SYS-001-13
    descricao: Enviar alertas quando Uso_Atual/Limite >= Percentual_Alerta; evitar duplicação com flag Fl_Alerta_Enviado
    tipo: notificacao
    campos_afetados: [Percentual_Alerta, Fl_Alerta_Enviado]
    obrigatorio: true
    criterio_aceite: Job Hangfire verifica a cada 1h; enviar e-mail para admins; resetar flag com hysteresis (Percentual_Alerta - 10%)

  - id: RN-SYS-001-14
    descricao: Isolamento multi-tenant; usuário só acessa dados do próprio conglomerado; Super Admin bypassa filtro
    tipo: seguranca
    campos_afetados: [Id_Conglomerado]
    obrigatorio: true
    criterio_aceite: Filtrar sempre por Id_Conglomerado do usuário autenticado; cross-tenant → HTTP 403

  - id: RN-SYS-001-15
    descricao: Parâmetros tipo JSON devem ter JSON válido; aceitar apenas objetos {} ou arrays []
    tipo: validacao
    campos_afetados: [Tipo_Dado, Vl_Json]
    obrigatorio: true
    criterio_aceite: JsonDocument.Parse() com sucesso; JSON inválido → HTTP 400 com erro de parsing

estados:
  - id: pending
    descricao: Criado, aguardando aprovação (se workflow habilitado)
  - id: active
    descricao: Ativo e em uso
  - id: inactive
    descricao: Inativo (não é consultado pelo sistema)
  - id: cancelled
    descricao: Cancelado (estado terminal, não pode voltar a ativo)

transicoes:
  permitidas:
    - de: pending
      para: active
    - de: active
      para: inactive
    - de: inactive
      para: active
    - de: active
      para: cancelled
  proibidas:
    - de: cancelled
      para: active
      motivo: Estado terminal
    - de: cancelled
      para: inactive
      motivo: Estado terminal
    - de: active
      para: pending
      motivo: Estado inicial

eventos:
  - nome: parametro.criado
    descricao: Após criação bem-sucedida de parâmetro
  - nome: parametro.atualizado
    descricao: Após atualização de valor ou metadados
  - nome: parametro.excluido
    descricao: Após exclusão lógica de parâmetro
  - nome: parametro_sensivel.acessado
    descricao: Ao visualizar valor de parâmetro sensível
  - nome: featureflag.ativada
    descricao: Ao ativar feature flag
  - nome: featureflag.desativada
    descricao: Ao desativar feature flag
  - nome: limite_uso.alerta_enviado
    descricao: Ao enviar alerta de limite próximo de ser atingido
  - nome: limite_uso.atingido
    descricao: Ao atingir 100% do limite de uso

permissoes:
  - codigo: SYS.PARAMETROS.CREATE
    descricao: Criar novos parâmetros
  - codigo: SYS.PARAMETROS.UPDATE
    descricao: Editar parâmetros existentes
  - codigo: SYS.PARAMETROS.DELETE
    descricao: Excluir parâmetros
  - codigo: SYS.PARAMETROS.VIEW
    descricao: Visualizar parâmetros
  - codigo: SYS.PARAMETROS.VIEW_ANY
    descricao: Listar parâmetros
  - codigo: SYS.PARAMETROS.VIEW_SENSITIVE
    descricao: Visualizar valores sensíveis descriptografados
  - codigo: SYS.PARAMETROS.EXPORT
    descricao: Exportar lista de parâmetros
  - codigo: SYS.FEATUREFLAGS.UPDATE
    descricao: Modificar feature flags
  - codigo: SYS.CONFIGURACOES_EMAIL.UPDATE
    descricao: Editar configurações de e-mail
  - codigo: SYS.LIMITES_USO.UPDATE
    descricao: Modificar limites de uso

integracoes:
  internas:
    - Autenticacao (verificar permissões RBAC)
    - Multi-Tenancy (isolamento por Id_Conglomerado)
    - Auditoria (registrar em Sistema_Parametro_Historico, Sistema_Feature_Flag_Historico, etc)
    - Cache (invalidar ao alterar parâmetro)
    - Hangfire (job para verificar limites de uso a cada 1h)
  externas:
    - Provedores de E-mail (SMTP, SendGrid API, AWS SES SDK)
    - ViaCEP (opcional, para validação de endereços em parâmetros de localização)

seguranca:
  isolamento_tenant: true
  auditoria_obrigatoria: true
  soft_delete: true
  criptografia_dados_sensiveis: true
  algoritmo_criptografia: AES-256
  rate_limiting: true
  validacao_entrada: FluentValidation

rastreabilidade:
  ucs_esperados:
    - UC00 - Listar parâmetros
    - UC01 - Criar parâmetro
    - UC02 - Visualizar parâmetro
    - UC03 - Editar parâmetro
    - UC04 - Excluir parâmetro
  artefatos_relacionados:
    - UC-RF001.md (Casos de Uso detalhados)
    - MD-RF001.yaml (DDL completo)
    - MT-RF001.yaml (Massas de teste)
    - TC-RF001.yaml (Casos de teste)

catalog:
  crud:
    - id: RF-CRUD-01
      title: Criar parâmetro
      required: true
    - id: RF-CRUD-02
      title: Listar parâmetros
      required: true
    - id: RF-CRUD-03
      title: Visualizar parâmetro
      required: true
    - id: RF-CRUD-04
      title: Atualizar parâmetro
      required: true
    - id: RF-CRUD-05
      title: Excluir parâmetro
      required: true
  validacoes:
    - id: RF-VAL-01
      title: Validar campos obrigatórios
      required: true
    - id: RF-VAL-02
      title: Validar unicidade de código
      required: true
    - id: RF-VAL-03
      title: Validar tipo de dado
      required: true
    - id: RF-VAL-04
      title: Validar regex (se especificado)
      required: true
    - id: RF-VAL-05
      title: Validar min/max (se especificado)
      required: true
    - id: RF-VAL-06
      title: Validar opções válidas (se especificado)
      required: true
  seguranca:
    - id: RF-SEC-01
      title: Isolamento de tenant
      required: true
    - id: RF-SEC-02
      title: Permissões RBAC
      required: true
    - id: RF-SEC-03
      title: Criptografia AES-256 para dados sensíveis
      required: true
    - id: RF-SEC-04
      title: Máscarar valores sensíveis na interface
      required: true
    - id: RF-SEC-05
      title: Proteção de parâmetros de sistema (não editáveis)
      required: true

exclusions:
  rf_items:
    - item: Interface visual específica
      motivo: Detalhes de layout, cores, fontes são responsabilidade de UX/UI
    - item: Tecnologia de implementação
      motivo: Backend pode ser .NET, Java, etc; Frontend pode ser Angular, React, etc
    - item: Estratégia de deploy
      motivo: Infraestrutura (Azure, AWS, On-Premise) é decisão de DevOps
    - item: Integração com Application Insights
      motivo: Ferramenta de monitoramento específica, não obrigatória

historico:
  - versao: '2.0'
    data: '2025-12-29'
    autor: Agência ALC - alc.dev.br
    descricao: Migração manual para nova governança (separação RF/RL, conformidade 100% com template oficial, extração completa de conteúdo)
  - versao: '1.0'
    data: '2025-11-03'
    autor: Agência ALC - alc.dev.br
    descricao: Versão inicial estrutura simplificada (5 seções)
