# =============================================
# Modelo de Dados (MD) — RF014
# Versão: 2.0
# Autor: Agência ALC - alc.dev.br
# =============================================

# =============================================
# 1. METADADOS DO DOCUMENTO (OBRIGATÓRIO)
# =============================================
metadata:
  versao: "2.0"
  data: "2026-01-04"
  autor: "Agência ALC - alc.dev.br"

  rf_relacionado:
    id: "RF014"
    nome: "Configurações do Usuário"

  sistema_modulo: "Sistema Base - Gestão de Usuários"
  banco_de_dados:
    engine: "logico"        # Modelo lógico (independente de engine física)
    schema: "logico"        # Abstração de schema
  padroes:
    multi_tenancy: true
    auditoria: true
    soft_delete: true

# =============================================
# 2. ENTIDADES (OBRIGATÓRIO)
# =============================================
entidades:
  - nome: "usuario"
    descricao: "Entidade central que armazena dados pessoais, credenciais e preferências do usuário"

    # -----------------------------
    # 2.1 CAMPOS (OBRIGATÓRIO)
    # -----------------------------
    campos:
      # CHAVE PRIMÁRIA (OBRIGATÓRIO)
      - nome: "id"
        tipo: "GUID"
        nulo: false
        default: "NEWID()"
        descricao: "Chave primária"
        pk: true
        mutavel: false
        origem:
          rf: "RF014"
          uc: "UC00"
          wf: null
          campo_wf: null
          observacao: "Identificador único do usuário"

      # MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "empresa_id"
        tipo: "GUID"
        nulo: false
        descricao: "FK para empresa (multi-tenancy)"
        fk:
          tabela: "empresa"
          coluna: "id"
          on_delete: "CASCADE"
        index: true
        mutavel: false
        origem:
          rf: "RF014"
          uc: "UC00"
          wf: "WF-01"
          campo_wf: "CMP-WF01-007"
          observacao: "Empresa vinculada ao usuário (somente leitura)"

      # CAMPOS DE NEGÓCIO — DADOS PESSOAIS
      - nome: "nome"
        tipo: "VARCHAR(200)"
        nulo: false
        default: null
        descricao: "Nome completo do usuário"
        index: true
        mutavel: false
        origem:
          rf: "RF014"
          uc: "UC00"
          wf: "WF-01"
          campo_wf: "CMP-WF01-002"
          observacao: "Campo somente leitura (RN-RF014-01)"

      - nome: "email"
        tipo: "VARCHAR(200)"
        nulo: false
        default: null
        descricao: "Email do usuário (login)"
        unique_por_tenant: false
        index: true
        mutavel: false
        origem:
          rf: "RF014"
          uc: "UC00"
          wf: "WF-01"
          campo_wf: "CMP-WF01-003"
          observacao: "Campo somente leitura (RN-RF014-01)"

      - nome: "cpf"
        tipo: "VARCHAR(14)"
        nulo: false
        default: null
        descricao: "CPF do usuário (formato XXX.XXX.XXX-XX)"
        unique_por_tenant: false
        index: true
        mutavel: false
        origem:
          rf: "RF014"
          uc: "UC00"
          wf: "WF-01"
          campo_wf: "CMP-WF01-004"
          observacao: "Campo somente leitura (RN-RF014-01)"

      - nome: "telefone"
        tipo: "VARCHAR(20)"
        nulo: true
        default: null
        descricao: "Telefone do usuário (formato (XX) XXXXX-XXXX ou (XX) XXXX-XXXX)"
        index: false
        mutavel: true
        origem:
          rf: "RF014"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-004"
          observacao: "Campo editável pelo usuário (UC01)"

      - nome: "data_nascimento"
        tipo: "DATE"
        nulo: true
        default: null
        descricao: "Data de nascimento do usuário (não pode ser futura)"
        index: false
        mutavel: true
        origem:
          rf: "RF014"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-005"
          observacao: "Campo editável pelo usuário (UC01)"

      # CAMPOS DE NEGÓCIO — CREDENCIAIS
      - nome: "password_hash"
        tipo: "VARCHAR(255)"
        nulo: false
        default: null
        descricao: "Hash seguro da senha (BCrypt/PBKDF2)"
        index: false
        mutavel: true
        origem:
          rf: "RF014"
          uc: "UC02"
          wf: "WF-03"
          campo_wf: "CMP-WF03-002"
          observacao: "Alterável pelo usuário com validações de segurança (UC02)"

      # CAMPOS DE NEGÓCIO — PREFERÊNCIAS DE INTERFACE
      - nome: "idioma"
        tipo: "VARCHAR(10)"
        nulo: false
        default: "pt-BR"
        descricao: "Idioma da interface (pt-BR, en-US, es-ES)"
        index: true
        mutavel: true
        check:
          definicao: "idioma IN ('pt-BR','en-US','es-ES')"
          descricao: "Idiomas suportados pelo sistema"
        origem:
          rf: "RF014"
          uc: "UC03"
          wf: "WF-04"
          campo_wf: "CMP-WF04-001"
          observacao: "Preferência de idioma (UC03, RN-RF014-10)"

      - nome: "tema"
        tipo: "VARCHAR(10)"
        nulo: false
        default: "light"
        descricao: "Tema visual da interface (light, dark, auto)"
        index: false
        mutavel: true
        check:
          definicao: "tema IN ('light','dark','auto')"
          descricao: "Temas suportados pelo sistema"
        origem:
          rf: "RF014"
          uc: "UC03"
          wf: "WF-04"
          campo_wf: "CMP-WF04-002"
          observacao: "Preferência de tema visual (UC03, RN-RF014-11)"

      - nome: "timezone"
        tipo: "VARCHAR(50)"
        nulo: false
        default: "America/Sao_Paulo"
        descricao: "Timezone IANA do usuário"
        index: false
        mutavel: true
        origem:
          rf: "RF014"
          uc: "UC03"
          wf: "WF-04"
          campo_wf: "CMP-WF04-003"
          observacao: "Preferência de timezone (UC03, RN-RF014-12)"

      # CAMPOS DE NEGÓCIO — CONTROLE DE ESTADO
      - nome: "status"
        tipo: "VARCHAR(20)"
        nulo: false
        default: "active"
        descricao: "Status do usuário (active, inactive, blocked)"
        index: true
        mutavel: true
        check:
          definicao: "status IN ('active','inactive','blocked')"
          descricao: "Estados permitidos para usuário"
        origem:
          rf: "RF014"
          uc: "UC00"
          wf: null
          campo_wf: null
          observacao: "Controle de estado (apenas usuários active podem alterar configurações)"

      - nome: "ativo"
        tipo: "BOOLEAN"
        nulo: false
        default: true
        descricao: "Flag de ativo/inativo"
        index: true
        mutavel: true
        index_parcial:
          where: "ativo = true"
          descricao: "Acelera listagens de usuários ativos"
        origem:
          rf: "RF014"
          uc: "UC00"
          wf: null
          campo_wf: null
          observacao: "Usuários inativos não podem fazer login"

      # AUDITORIA (OBRIGATÓRIO - 5 campos)
      - nome: "created_at"
        tipo: "DATETIME"
        nulo: true
        default: "GETDATE()"
        descricao: "Data de criação"
        audit: true
        mutavel: false
        origem:
          rf: "RF014"
          uc: "UC00"
          wf: "WF-01"
          campo_wf: "CMP-WF01-011"
          observacao: "Campo gerado automaticamente pelo sistema"

      - nome: "created_by"
        tipo: "GUID"
        nulo: true
        default: null
        descricao: "Usuário que criou"
        audit: true
        mutavel: false
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "SET NULL"
        origem:
          rf: "RF014"
          uc: "UC00"
          wf: null
          campo_wf: null
          observacao: "Preenchido automaticamente com ID do usuário autenticado"

      - nome: "updated_at"
        tipo: "DATETIME"
        nulo: true
        default: null
        descricao: "Data de atualização"
        audit: true
        mutavel: false
        origem:
          rf: "RF014"
          uc: "UC00"
          wf: "WF-01"
          campo_wf: "CMP-WF01-012"
          observacao: "Campo gerado automaticamente pelo sistema (UC01, UC02, UC03)"

      - nome: "updated_by"
        tipo: "GUID"
        nulo: true
        default: null
        descricao: "Usuário que atualizou"
        audit: true
        mutavel: false
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "SET NULL"
        origem:
          rf: "RF014"
          uc: "UC01"
          wf: null
          campo_wf: null
          observacao: "Preenchido automaticamente com ID do usuário autenticado (UC01, UC02, UC03)"

      # SOFT DELETE (OBRIGATÓRIO)
      - nome: "deleted_at"
        tipo: "DATETIME"
        nulo: true
        default: null
        descricao: "Soft delete"
        audit: true
        mutavel: false
        origem:
          rf: "RF014"
          uc: null
          wf: null
          campo_wf: null
          observacao: "Preenchido automaticamente ao excluir (soft delete)"

    # -----------------------------
    # 2.2 ÍNDICES (OBRIGATÓRIO)
    # -----------------------------
    indices:
      # ÍNDICE PRIMÁRIO (OBRIGATÓRIO)
      - nome: "pk_usuario"
        tipo: "PRIMARY"
        colunas: ["id"]
        descricao: "Chave primária"

      # ÍNDICE MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "idx_usuario_empresa"
        tipo: "BTREE"
        colunas: ["empresa_id"]
        descricao: "Performance multi-tenant"

      # ÍNDICES DE PERFORMANCE (conforme WF - filtros/buscas)
      - nome: "idx_usuario_email"
        tipo: "BTREE"
        colunas: ["email"]
        descricao: "Performance em login e busca por email"

      - nome: "idx_usuario_cpf"
        tipo: "BTREE"
        colunas: ["cpf"]
        descricao: "Performance em busca por CPF"

      - nome: "idx_usuario_nome"
        tipo: "BTREE"
        colunas: ["nome"]
        descricao: "Performance em busca por nome"

      - nome: "idx_usuario_status"
        tipo: "BTREE"
        colunas: ["status"]
        descricao: "Performance em filtros por status (active, inactive, blocked)"

      - nome: "idx_usuario_idioma"
        tipo: "BTREE"
        colunas: ["idioma"]
        descricao: "Performance em filtros e relatórios por idioma"

      - nome: "idx_usuario_created_at"
        tipo: "BTREE"
        colunas: ["created_at"]
        descricao: "Performance em ordenação por data de criação"

      # ÍNDICE PARCIAL (OBRIGATÓRIO)
      - nome: "idx_usuario_ativo_true"
        tipo: "BTREE"
        colunas: ["ativo"]
        where: "ativo = true"
        descricao: "Acelera consultas apenas de usuários ativos"

    # -----------------------------
    # 2.3 CONSTRAINTS (OBRIGATÓRIO)
    # -----------------------------
    constraints:
      # FK MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "fk_usuario_empresa"
        tipo: "FOREIGN KEY"
        definicao: "empresa_id REFERENCES empresa(id)"
        on_delete: "CASCADE"
        descricao: "Multi-tenancy"

      # UNIQUE (EMAIL)
      - nome: "uq_usuario_email"
        tipo: "UNIQUE"
        definicao: "(email)"
        descricao: "Email único no sistema"

      # UNIQUE (CPF)
      - nome: "uq_usuario_cpf"
        tipo: "UNIQUE"
        definicao: "(cpf)"
        descricao: "CPF único no sistema"

      # CHECK (STATUS)
      - nome: "chk_usuario_status"
        tipo: "CHECK"
        definicao: "status IN ('active','inactive','blocked')"
        descricao: "Status permitido"

      # CHECK (IDIOMA)
      - nome: "chk_usuario_idioma"
        tipo: "CHECK"
        definicao: "idioma IN ('pt-BR','en-US','es-ES')"
        descricao: "Idiomas suportados"

      # CHECK (TEMA)
      - nome: "chk_usuario_tema"
        tipo: "CHECK"
        definicao: "tema IN ('light','dark','auto')"
        descricao: "Temas suportados"

      # FKs DE AUDITORIA (OBRIGATÓRIO)
      - nome: "fk_usuario_created_by"
        tipo: "FOREIGN KEY"
        definicao: "created_by REFERENCES usuario(id)"
        on_delete: "SET NULL"
        descricao: "Auditoria - criador"

      - nome: "fk_usuario_updated_by"
        tipo: "FOREIGN KEY"
        definicao: "updated_by REFERENCES usuario(id)"
        on_delete: "SET NULL"
        descricao: "Auditoria - editor"

  # =============================================
  # TABELA DE AUDITORIA DE ALTERAÇÃO DE SENHA
  # =============================================
  - nome: "usuario_senha_auditoria"
    descricao: "Registra todas as tentativas de alteração de senha para auditoria e segurança"

    # -----------------------------
    # 2.1 CAMPOS (OBRIGATÓRIO)
    # -----------------------------
    campos:
      # CHAVE PRIMÁRIA (OBRIGATÓRIO)
      - nome: "id"
        tipo: "GUID"
        nulo: false
        default: "NEWID()"
        descricao: "Chave primária"
        pk: true
        mutavel: false
        origem:
          rf: "RF014"
          uc: "UC02"
          wf: null
          campo_wf: null
          observacao: "Identificador único do registro de auditoria"

      # MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "empresa_id"
        tipo: "GUID"
        nulo: false
        descricao: "FK para empresa (multi-tenancy)"
        fk:
          tabela: "empresa"
          coluna: "id"
          on_delete: "CASCADE"
        index: true
        mutavel: false
        origem:
          rf: "RF014"
          uc: "UC02"
          wf: null
          campo_wf: null
          observacao: "Empresa do usuário que alterou senha"

      # CAMPOS DE NEGÓCIO
      - nome: "usuario_id"
        tipo: "GUID"
        nulo: false
        descricao: "FK para usuario (usuário que alterou senha)"
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "CASCADE"
        index: true
        mutavel: false
        origem:
          rf: "RF014"
          uc: "UC02"
          wf: null
          campo_wf: null
          observacao: "Usuário que executou a alteração de senha"

      - nome: "ip_origem"
        tipo: "VARCHAR(45)"
        nulo: false
        default: null
        descricao: "Endereço IP de origem da requisição"
        index: false
        mutavel: false
        origem:
          rf: "RF014"
          uc: "UC02"
          wf: null
          campo_wf: null
          observacao: "Registra IP para auditoria de segurança (RN-RF014-SEC-03)"

      - nome: "user_agent"
        tipo: "VARCHAR(500)"
        nulo: true
        default: null
        descricao: "User agent do navegador/dispositivo"
        index: false
        mutavel: false
        origem:
          rf: "RF014"
          uc: "UC02"
          wf: null
          campo_wf: null
          observacao: "Registra dispositivo para auditoria"

      - nome: "sucesso"
        tipo: "BOOLEAN"
        nulo: false
        default: null
        descricao: "Indica se a alteração foi bem-sucedida"
        index: true
        mutavel: false
        origem:
          rf: "RF014"
          uc: "UC02"
          wf: null
          campo_wf: null
          observacao: "True = sucesso, False = falha (validação, senha incorreta, etc.)"

      - nome: "motivo_falha"
        tipo: "VARCHAR(200)"
        nulo: true
        default: null
        descricao: "Motivo da falha (se aplicável)"
        index: false
        mutavel: false
        origem:
          rf: "RF014"
          uc: "UC02"
          wf: null
          campo_wf: null
          observacao: "Ex: senha_atual_incorreta, senha_muito_comum, etc."

      # AUDITORIA (OBRIGATÓRIO - 5 campos)
      - nome: "created_at"
        tipo: "DATETIME"
        nulo: true
        default: "GETDATE()"
        descricao: "Data de criação (timestamp da tentativa)"
        audit: true
        mutavel: false
        origem:
          rf: "RF014"
          uc: "UC02"
          wf: null
          campo_wf: null
          observacao: "Timestamp da tentativa de alteração de senha"

      - nome: "created_by"
        tipo: "GUID"
        nulo: true
        default: null
        descricao: "Usuário que criou"
        audit: true
        mutavel: false
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "SET NULL"
        origem:
          rf: "RF014"
          uc: "UC02"
          wf: null
          campo_wf: null
          observacao: "Preenchido automaticamente com ID do usuário autenticado"

      - nome: "updated_at"
        tipo: "DATETIME"
        nulo: true
        default: null
        descricao: "Data de atualização (não aplicável para auditoria)"
        audit: true
        mutavel: false
        origem:
          rf: "RF014"
          uc: "UC02"
          wf: null
          campo_wf: null
          observacao: "Não aplicável (registros de auditoria não são editados)"

      - nome: "updated_by"
        tipo: "GUID"
        nulo: true
        default: null
        descricao: "Usuário que atualizou (não aplicável para auditoria)"
        audit: true
        mutavel: false
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "SET NULL"
        origem:
          rf: "RF014"
          uc: "UC02"
          wf: null
          campo_wf: null
          observacao: "Não aplicável (registros de auditoria não são editados)"

      # SOFT DELETE (OBRIGATÓRIO)
      - nome: "deleted_at"
        tipo: "DATETIME"
        nulo: true
        default: null
        descricao: "Soft delete (não aplicável para auditoria)"
        audit: true
        mutavel: false
        origem:
          rf: "RF014"
          uc: "UC02"
          wf: null
          campo_wf: null
          observacao: "Não aplicável (registros de auditoria não devem ser excluídos)"

    # -----------------------------
    # 2.2 ÍNDICES (OBRIGATÓRIO)
    # -----------------------------
    indices:
      # ÍNDICE PRIMÁRIO (OBRIGATÓRIO)
      - nome: "pk_usuario_senha_auditoria"
        tipo: "PRIMARY"
        colunas: ["id"]
        descricao: "Chave primária"

      # ÍNDICE MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "idx_usuario_senha_auditoria_empresa"
        tipo: "BTREE"
        colunas: ["empresa_id"]
        descricao: "Performance multi-tenant"

      # ÍNDICES DE PERFORMANCE
      - nome: "idx_usuario_senha_auditoria_usuario"
        tipo: "BTREE"
        colunas: ["usuario_id"]
        descricao: "Performance em consultas por usuário"

      - nome: "idx_usuario_senha_auditoria_created_at"
        tipo: "BTREE"
        colunas: ["created_at"]
        descricao: "Performance em consultas por período"

      - nome: "idx_usuario_senha_auditoria_sucesso"
        tipo: "BTREE"
        colunas: ["sucesso"]
        descricao: "Performance em filtros por sucesso/falha"

      - nome: "idx_usuario_senha_auditoria_ip"
        tipo: "BTREE"
        colunas: ["ip_origem"]
        descricao: "Performance em consultas por IP (detecção de ataques)"

    # -----------------------------
    # 2.3 CONSTRAINTS (OBRIGATÓRIO)
    # -----------------------------
    constraints:
      # FK MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "fk_usuario_senha_auditoria_empresa"
        tipo: "FOREIGN KEY"
        definicao: "empresa_id REFERENCES empresa(id)"
        on_delete: "CASCADE"
        descricao: "Multi-tenancy"

      # FK USUARIO
      - nome: "fk_usuario_senha_auditoria_usuario"
        tipo: "FOREIGN KEY"
        definicao: "usuario_id REFERENCES usuario(id)"
        on_delete: "CASCADE"
        descricao: "Usuário que alterou senha"

      # FKs DE AUDITORIA (OBRIGATÓRIO)
      - nome: "fk_usuario_senha_auditoria_created_by"
        tipo: "FOREIGN KEY"
        definicao: "created_by REFERENCES usuario(id)"
        on_delete: "SET NULL"
        descricao: "Auditoria - criador"

      - nome: "fk_usuario_senha_auditoria_updated_by"
        tipo: "FOREIGN KEY"
        definicao: "updated_by REFERENCES usuario(id)"
        on_delete: "SET NULL"
        descricao: "Auditoria - editor"

# =============================================
# 3. RELACIONAMENTOS GLOBAIS (OPCIONAL)
# =============================================
relacionamentos_globais:
  - origem: "empresa"
    cardinalidade: "1:N"
    destino: "usuario"
    descricao: "Uma empresa possui muitos usuários"

  - origem: "usuario"
    cardinalidade: "1:N"
    destino: "usuario_senha_auditoria"
    descricao: "Um usuário possui muitos registros de auditoria de alteração de senha"

# =============================================
# 4. OBSERVAÇÕES E DECISÕES (OBRIGATÓRIO)
# =============================================
observacoes:
  - categoria: "Modelagem"
    descricao: "Derivado do RF014 - Campos principais mapeados de UC00 (visualização), UC01 (edição de dados pessoais), UC02 (alteração de senha) e UC03 (preferências de interface)"

  - categoria: "Modelagem"
    descricao: "Campos somente leitura (nome, email, CPF, empresa_id) marcados como mutavel: false conforme RN-RF014-01"

  - categoria: "Modelagem"
    descricao: "Criada tabela separada usuario_senha_auditoria para registrar todas as tentativas de alteração de senha (sucesso e falha) conforme RF014-SEC-03"

  - categoria: "Performance"
    descricao: "Índices criados para queries principais do UC00 (listagem de usuários por status, empresa, idioma)"

  - categoria: "Performance"
    descricao: "Índices criados para login (email) e buscas (CPF, nome)"

  - categoria: "Performance"
    descricao: "Índice parcial em ativo = true para acelerar listagens de usuários ativos (caso de uso mais comum)"

  - categoria: "Segurança"
    descricao: "Multi-tenancy implementado via empresa_id com CASCADE em todas as tabelas"

  - categoria: "Segurança"
    descricao: "Auditoria completa implementada (created_at, created_by, updated_at, updated_by, deleted_at) em todas as tabelas"

  - categoria: "Segurança"
    descricao: "Password_hash armazena hash seguro (BCrypt/PBKDF2) conforme RF014-SEC-04"

  - categoria: "Segurança"
    descricao: "Tabela usuario_senha_auditoria registra IP, user_agent, sucesso/falha e motivo para detecção de ataques"

  - categoria: "Segurança"
    descricao: "Constraints CHECK garantem valores válidos para status, idioma e tema (defesa em profundidade)"

  - categoria: "Validação"
    descricao: "Email e CPF são únicos no sistema (não por tenant) pois são identificadores pessoais"

  - categoria: "Validação"
    descricao: "Validações de formato (telefone, data_nascimento) são aplicadas no backend (FluentValidation)"

  - categoria: "Validação"
    descricao: "Validações de senha forte (complexidade, blacklist, dados pessoais) são aplicadas no backend antes de gerar hash"

# =============================================
# 5. HISTÓRICO DE ALTERAÇÕES (OBRIGATÓRIO)
# =============================================
historico:
  - versao: "2.0"
    data: "2026-01-04"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Versão inicial derivada do RF014 com cobertura completa de UC00, UC01, UC02 e UC03. Incluída tabela usuario_senha_auditoria para auditoria obrigatória de alteração de senha."
