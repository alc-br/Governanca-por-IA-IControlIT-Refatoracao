# RF-014: Configurações do Usuário

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC001-SYS - Sistema Infraestrutura
**Fase**: Fase 1 - Sistema Base

---

## 1. OBJETIVO DO REQUISITO

Fornecer ao usuário autenticado a capacidade de gerenciar autonomamente suas informações pessoais, credenciais de segurança (senha) e preferências de interface (idioma, tema, timezone), sem necessidade de intervenção administrativa, garantindo controle pessoal, segurança e experiência personalizada no sistema IControlIT.

Este requisito define **o que o sistema deve fazer** para permitir que cada usuário configure sua conta de forma independente, aplicando validações de segurança robustas e persistindo preferências entre sessões.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Visualização de dados pessoais do usuário autenticado
- [x] Edição limitada de dados pessoais (telefone, data de nascimento)
- [x] Alteração de senha com validações de segurança
- [x] Seleção de idioma da interface (pt-BR, en-US, es-ES)
- [x] Seleção de tema visual (claro, escuro, automático)
- [x] Seleção de timezone
- [x] Auditoria de operações críticas (alteração de senha)
- [x] Controle de acesso: apenas o próprio usuário acessa suas configurações
- [x] Persistência de preferências entre sessões

### 2.2 Fora do escopo (não objetivos)

- Alteração de nome, email, CPF (requer validação administrativa)
- Gestão de permissões e roles do usuário
- Configurações globais do sistema (é responsabilidade de RF-001)
- Layout específico da interface (responsabilidade do frontend)
- Autenticação multifator (será tratado em RF futuro)
- Histórico de senhas anteriores

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-----|---------|
| Usuário Autenticado | Pessoa autenticada no sistema via JWT com claims válidos |
| Configurações Pessoais | Conjunto de dados editáveis pelo próprio usuário |
| Preferências | Configurações de idioma, tema e timezone |
| Senha Forte | Senha com mínimo 8 caracteres, incluindo maiúscula, minúscula, número e caractere especial |
| Blacklist de Senhas | Lista de senhas comuns bloqueadas pelo sistema |
| Self-service | Capacidade do usuário de gerenciar suas próprias configurações sem admin |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Visualizar Conta** - Exibir dados pessoais (nome, email, CPF, empresa)
2. **Editar Dados Pessoais** - Atualizar telefone e data de nascimento
3. **Alterar Senha** - Modificar credenciais com validações de segurança
4. **Configurar Idioma** - Selecionar idioma da interface
5. **Configurar Tema** - Escolher tema visual
6. **Configurar Timezone** - Definir fuso horário

---

## 5. REGRAS DE NEGÓCIO

### RN-RF014-01 — Campos Somente Leitura

**Descrição**: Nome, email, CPF e empresa do usuário são exibidos como somente leitura.

**Justificativa**: São dados críticos que requerem validação administrativa para alteração (prevenção de fraude, compliance).

**Critério de Aceite**:
- Campos exibidos mas não editáveis
- Tentativa de alteração via API → HTTP 400 (campo bloqueado)

---

### RN-RF014-02 — Validação de Telefone

**Descrição**: Telefone deve seguir formato brasileiro `(XX) XXXXX-XXXX` ou `(XX) XXXX-XXXX`.

**Justificativa**: Padronização para comunicação e integração com sistemas de notificação.

**Critério de Aceite**:
- Telefone com formato inválido → rejeição
- Exemplos válidos: `(11) 99999-9999`, `(11) 3333-4444`

---

### RN-RF014-03 — Senha Atual Obrigatória para Alteração

**Descrição**: Para alterar senha, usuário deve informar senha atual corretamente.

**Justificativa**: Previne alteração de senha por terceiros que tenham acesso ao dispositivo do usuário.

**Critério de Aceite**:
- Senha atual incorreta → HTTP 400 com mensagem "Senha atual incorreta"
- Hash da senha atual deve ser validado no backend

---

### RN-RF014-04 — Requisitos de Nova Senha

**Descrição**: Nova senha deve ter:
- Mínimo 8 caracteres
- Ao menos 1 letra maiúscula
- Ao menos 1 letra minúscula
- Ao menos 1 número
- Ao menos 1 caractere especial (@$!%*?&)

**Justificativa**: Segurança da aplicação conforme OWASP Top 10.

**Critério de Aceite**:
- Senha sem requisitos mínimos → rejeição
- Exemplo válido: `Senha@123`
- Exemplo inválido: `senha123` (falta maiúscula e especial)

---

### RN-RF014-05 — Nova Senha Diferente da Atual

**Descrição**: Nova senha não pode ser igual à senha atual.

**Justificativa**: Forçar renovação efetiva de credenciais.

**Critério de Aceite**:
- Nova senha == senha atual → HTTP 400 "Nova senha deve ser diferente da senha atual"

---

### RN-RF014-06 — Blacklist de Senhas Comuns

**Descrição**: Senhas comuns são bloqueadas:
- `123456`, `password`, `senha123`, `admin123`, `qwerty`, etc.

**Justificativa**: Prevenção contra ataques de dicionário.

**Critério de Aceite**:
- Senha na blacklist → HTTP 400 "Esta senha é muito comum. Escolha uma senha mais segura."

---

### RN-RF014-07 — Senha Não Pode Conter Dados Pessoais

**Descrição**: Senha não pode conter:
- Nome do usuário (ou parte dele)
- Parte do email (antes do @)

**Justificativa**: Dificulta engenharia social e adivinhação.

**Critério de Aceite**:
- Usuário "João Silva" (joao@email.com) não pode usar `joao123` como senha
- Violação → HTTP 400 "Senha não pode conter seu nome ou email"

---

### RN-RF014-08 — Confirmação de Senha

**Descrição**: Campo de confirmação deve ser idêntico ao campo de nova senha.

**Justificativa**: Prevenir erros de digitação.

**Critério de Aceite**:
- Nova senha ≠ confirmação → rejeição
- Frontend valida antes de enviar

---

### RN-RF014-09 — Persistência de Idioma

**Descrição**: Idioma selecionado é salvo no perfil do usuário e aplicado imediatamente.

**Justificativa**: Preferência deve persistir entre sessões.

**Critério de Aceite**:
- Usuário seleciona "English" → sistema muda imediatamente
- Próximo login → idioma mantido

---

### RN-RF014-10 — Idiomas Suportados

**Descrição**: Sistema suporta 3 idiomas:
- pt-BR (Português do Brasil) - padrão
- en-US (English - United States)
- es-ES (Español - España)

**Justificativa**: Atendimento a usuários de diferentes países.

**Critério de Aceite**:
- Idioma não suportado → fallback para pt-BR

---

### RN-RF014-11 — Temas Disponíveis

**Descrição**: Usuário pode escolher entre:
- `light` - Tema claro
- `dark` - Tema escuro
- `auto` - Segue preferência do sistema operacional

**Justificativa**: Acessibilidade e preferência visual.

**Critério de Aceite**:
- Tema `auto` → sistema detecta preferência do SO
- Mudança de tema → aplicada imediatamente

---

### RN-RF014-12 — Timezones Suportados

**Descrição**: Sistema oferece lista de timezones IANA comuns:
- América (São Paulo, Nova York, Los Angeles)
- Europa (Londres, Paris, Berlim)
- Ásia (Tóquio, Dubai, Singapura)

**Justificativa**: Usuários em diferentes fusos horários veem datas/horas corretas.

**Critério de Aceite**:
- Timezone selecionado → todas as datas/horas exibidas naquele fuso

---

### RN-RF014-13 — Navegação Responsiva

**Descrição**: Em telas menores (< 1024px), menu lateral de navegação vira drawer overlay.

**Justificativa**: Usabilidade em dispositivos móveis.

**Critério de Aceite**:
- Mobile → menu como drawer
- Desktop → menu fixo lateral

---

### RN-RF014-14 — Sincronização de Idioma

**Descrição**: Alteração de idioma em qualquer parte do sistema reflete na tela de configurações.

**Justificativa**: Consistência de estado entre componentes.

**Critério de Aceite**:
- Usuário muda idioma no header → dropdown de preferências atualiza automaticamente

---

### RN-RF014-15 — Usuário Logado Obrigatório

**Descrição**: Tela de configurações só é acessível por usuários autenticados.

**Justificativa**: Proteção de dados pessoais.

**Critério de Aceite**:
- Usuário não logado → redirecionado para login
- Token inválido → HTTP 401

---

### RN-RF014-16 — Isolamento de Dados

**Descrição**: Usuário só pode visualizar e editar suas próprias configurações.

**Justificativa**: Multi-tenancy e privacidade.

**Critério de Aceite**:
- Tentativa de acessar configurações de outro usuário → HTTP 403

---

## 6. ESTADOS DA ENTIDADE

Este RF não gerencia estados de entidade específicos, pois atualiza diretamente a entidade `Usuario` que possui estados gerenciados por RF-008 (Gestão de Usuários).

**Estados relevantes do Usuario**:

| Estado | Descrição |
|------|-----------|
| active | Usuário ativo (pode alterar configurações) |
| inactive | Usuário inativo (não pode fazer login) |
| blocked | Usuário bloqueado (não pode fazer login) |

**Transições permitidas** (gerenciadas por RF-008):
- Apenas usuários `active` podem alterar configurações
- Usuários `inactive` ou `blocked` → não conseguem autenticar

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre | Dados |
|------|--------------|-------|
| usuario.senha_alterada | Após alteração bem-sucedida de senha | UserId, IP, Timestamp |
| usuario.preferencias_atualizadas | Após atualização de idioma/tema/timezone | UserId, Preferências antigas, Preferências novas |
| usuario.dados_pessoais_atualizados | Após edição de telefone ou data nascimento | UserId, Campos alterados |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant (usuário só edita seus dados)
- Nenhuma regra de segurança de senha pode ser ignorada
- Alterações de senha devem ser auditadas
- Erros devem retornar mensagens claras e estruturadas (não vazamento de stack traces)
- Preferências devem ser persistidas no banco de dados
- Idioma deve ser aplicado imediatamente sem necessidade de logout/login

---

## 9. SEGURANÇA

- **Validação de entrada obrigatória**: Todos os campos editáveis devem ser validados (backend e frontend)
- **Proteção contra injeção**: Utilizar FluentValidation e Entity Framework (protege contra SQL Injection)
- **Hash seguro de senha**: Utilizar BCrypt ou PBKDF2 (não armazenar senha em texto plano)
- **Auditoria de senha**: Registrar IP, timestamp e userId em toda alteração de senha
- **Rate limiting** (recomendado): Limitar tentativas de alteração de senha (5 tentativas/hora)
- **Validação de token JWT**: Garantir que apenas usuário autenticado acesse sua própria conta

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF014.md** - Casos de Uso (UC00-UC04)
- **MD-RF014.md** - Modelo de Dados (tabela Usuario com campos de preferências)
- **MT-RF014.yaml** - Massas de Teste
- **TC-RF014.yaml** - Casos de Teste

---

## 11. RASTREABILIDADE

| Artefato | Status | Localização |
|--------|-------|-------------|
| Casos de Uso (UC-RF014.md) | Criado | docs/rf/Fase-1-Sistema-Base/EPIC001-SYS-Sistema-Infraestrutura/RF014-Configuracoes-do-Usuario/ |
| Modelo de Dados (MD-RF014.md) | Criado | docs/rf/Fase-1-Sistema-Base/EPIC001-SYS-Sistema-Infraestrutura/RF014-Configuracoes-do-Usuario/ |
| Casos de Teste | Pendente | - |
| Massas de Teste | Pendente | - |

**Dependências de outros RFs**:

| RF | Dependência | Descrição |
|----|-------------|-----------|
| RF-008 | Gestão de Usuários | Utiliza entidade Usuario |
| RF-005 | i18n | Sistema de tradução Transloco |
| RF-004 | Auditoria | Registro de alterações críticas |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|------|------|----------|------|
| 2.0 | 2025-12-30 | Migração para formato v2.0 com 11 seções canônicas, separação estrita RF/RL, eliminação de referências ao legado | Agência ALC - alc.dev.br |
| 1.1 | 2025-12-27 | Atualização conforme CONTRATO DE DOCUMENTAÇÃO ESSENCIAL - Inclusão de campos de auditoria completos, Fl_Ativo BIT, documentação detalhada de funcionalidades | Equipe IControlIT |
| 1.0 | 2025-11-19 | Criação inicial da documentação reversa baseada na implementação existente | Equipe IControlIT |
