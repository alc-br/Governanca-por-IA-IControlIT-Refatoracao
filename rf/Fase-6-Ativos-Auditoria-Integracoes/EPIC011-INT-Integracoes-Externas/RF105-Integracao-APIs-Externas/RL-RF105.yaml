# RL-RF105.yaml - Rastreabilidade do Legado (Integração Operadoras → APIs Externas)
# Versão: 2.0
# Data: 2025-12-31

rf_id: RF105
titulo: "Integração com APIs Externas e WebServices"

legado:
  sistema: "VB.NET + ASP.NET Web Forms"
  versao: "IControlIT v1 (2010-2024)"
  arquitetura: "Monolítica WebForms + ASMX"
  banco_dados: "SQL Server 2008 R2"
  multi_tenant: true  # ClienteId presente
  auditoria: "partial"  # Apenas logs em arquivo de texto

# SEÇÃO CRÍTICA: Referencias ao Legado com Destino Obrigatório
referencias:
  - id: "LEG-RF105-001"
    tipo: "tela"
    nome: "GestaoOperadoras.aspx"
    caminho: "ic1_legado/IControlIT/Integracao/GestaoOperadoras.aspx"
    descricao: |
      CRUD de configuração de operadoras de telecomunicações (Vivo, Claro, TIM, Oi).
      Campos: Nome Operadora (dropdown), API Key (password), Client ID, Client Secret, URL Endpoint, Ativa (checkbox).
      Ações: btnSalvar_Click() salva credenciais criptografadas AES-256, btnTestarConexao_Click() valida conectividade, btnExcluir_Click() soft delete.
    destino: "substituido"
    justificativa: |
      Interface legada substituída por componente Angular 19 moderno com validação reativa, integração direta com Azure Key Vault para rotação de chaves,
      e UI responsiva. Tela ASPX não suporta SPA, validação client-side limitada, e  dependência de ViewState (pesado).
    rf_item_relacionado: "RN-RF105-001"
    uc_relacionado: "UC01"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF105-002"
    tipo: "tela"
    nome: "ConsultaConsumo.aspx"
    caminho: "ic1_legado/IControlIT/Integracao/ConsultaConsumo.aspx"
    descricao: |
      Consulta consumo de voz, dados e SMS de linhas telefônicas. Campos: Operadora (dropdown), MSISDN (text), Período (daterange).
      GridView exibe: MSISDN, Voz (minutos), Dados (MB), SMS (unidades), Última Atualização.
      PROBLEMA CRÍTICO: SEM cache - cada consulta = chamada direta à API (latência 5-30s, custo alto).
    destino: "substituido"
    justificativa: |
      Performance crítica. Tela legada consulta operadora a cada request (lento, caro). Sistema moderno implementa cache Redis com TTL 15min,
      reduzindo latência de 5-30s para <50ms e economizando custos de API. Interface Angular com lazy loading e virtual scrolling para grandes volumes.
    rf_item_relacionado: "RN-RF105-006"
    uc_relacionado: "UC02"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF105-003"
    tipo: "tela"
    nome: "GestaoFaturas.aspx"
    caminho: "ic1_legado/IControlIT/Integracao/GestaoFaturas.aspx"
    descricao: |
      Listar faturas importadas e importar manualmente via FileUpload control (aceita .xml).
      Validação de schema XML NF-e. Armazenamento em pasta local: \\servidor\faturas\operadora\ano\mes\
      PROBLEMA CRÍTICO: Armazenamento local sem backup, vulnerável a falhas de disco, sem versionamento.
    destino: "substituido"
    justificativa: |
      Armazenamento local substituído por Azure Blob Storage (durabilidade 99.999999999%, backup automático, compliance LGPD).
      Interface modernizada com drag-and-drop upload, validação client-side de schema, e preview de XML antes de importar.
    rf_item_relacionado: "RN-RF105-005"
    uc_relacionado: "UC03"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF105-004"
    tipo: "webservice"
    nome: "WSOperadora.ConsultarConsumo"
    caminho: "ic1_legado/WebService/WSOperadora.asmx.vb"
    descricao: |
      WebMethod SOAP que consulta consumo de linha (voz, dados, SMS) via API da operadora.
      Implementação: HttpClient síncrono (GetAsync().Result), sem retry, sem timeout configurável, sem cache.
      PROBLEMAS: Bloqueante (trava thread), sem resiliência, sem tratamento de falhas transientes.
    destino: "substituido"
    justificativa: |
      SOAP substituído por REST API com async/await nativo (.NET 10). Polly implementa retry com backoff exponencial (3 tentativas: 1s, 2s, 4s),
      circuit breaker (5 falhas → bloqueio 5min), e timeout configurável (5-300s). Cache Redis reduz carga em operadoras.
    rf_item_relacionado: "RN-RF105-003"
    uc_relacionado: "UC02"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF105-005"
    tipo: "webservice"
    nome: "WSOperadora.ImportarFatura"
    caminho: "ic1_legado/WebService/WSOperadora.asmx.vb"
    descricao: |
      WebMethod SOAP que importa XML de fatura eletrônica.
      Implementação: File.WriteAllText() salva XML em \\servidor\faturas\, sem validação de duplicidade, sem armazenamento distribuído.
      PROBLEMAS: Armazenamento local inseguro, sem versionamento, sem backup automático.
    destino: "substituido"
    justificativa: |
      SOAP substituído por Azure Function + Blob Storage Trigger. XMLs armazenados em Blob Storage com AES-256, validação automática de schema,
      detecção de duplicidade via hash SHA-256, e processamento assíncrono escalável.
    rf_item_relacionado: "RN-RF105-005"
    uc_relacionado: "UC03"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF105-006"
    tipo: "webservice"
    nome: "WSOperadora.ListarInventario"
    caminho: "ic1_legado/WebService/WSOperadora.asmx.vb"
    descricao: |
      WebMethod SOAP que lista inventário de linhas telefônicas ativas na operadora.
      Implementação: HttpClient.GetAsync().Result, retorna lista vazia em erro (silencioso), sem auditoria.
      PROBLEMAS: Falhas silenciosas (retorna [] sem logar erro), sem rastreabilidade.
    destino: "substituido"
    justificativa: |
      SOAP substituído por REST API com tratamento de erros estruturado (Problem Details RFC 7807), logging completo em AuditLog,
      e métricas em tempo real (latência P95, taxa de erro, disponibilidade).
    rf_item_relacionado: "RN-RF105-009"
    uc_relacionado: "UC04"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF105-007"
    tipo: "stored_procedure"
    nome: "pa_ConsultarConsumoLinha"
    caminho: "Database/dbo.pa_ConsultarConsumoLinha"
    descricao: |
      Stored Procedure que consulta último consumo registrado de linha (voz, dados, SMS).
      Query: SELECT TOP 1 FROM ConsumoLinhas WHERE ID_Cliente = @ClienteId AND MSISDN = @MSISDN ORDER BY DataConsulta DESC
    destino: "substituido"
    justificativa: |
      Stored Procedure substituída por query EF Core + LINQ no ConsumoService. ORM oferece type safety, testabilidade,
      e manutenção facilitada. Dados de consumo movidos para cache Redis (não precisam persistência permanente).
    rf_item_relacionado: "RN-RF105-006"
    uc_relacionado: "UC02"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF105-008"
    tipo: "stored_procedure"
    nome: "pa_ImportarFatura"
    caminho: "Database/dbo.pa_ImportarFatura"
    descricao: |
      Stored Procedure que insere registro de fatura no banco com XML completo.
      INSERT INTO FaturasOperadora (ID_Cliente, ID_Operadora, NumeroNota, XMLFatura, ...)
      PROBLEMA: Armazena XML completo (MBs) no campo [text], causando lentidão em queries e backup pesado.
    destino: "substituido"
    justificativa: |
      Stored Procedure substituída por FaturaService.ImportarFaturaAsync(). XMLs movidos para Azure Blob Storage,
      banco armazena apenas metadados (NFeId, Valor, BlobStoragePath, XMLHash). Separação de concerns: DB para indexação, Blob para conteúdo.
    rf_item_relacionado: "RN-RF105-005"
    uc_relacionado: "UC03"
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: 2

  - id: "LEG-RF105-009"
    tipo: "stored_procedure"
    nome: "pa_SincronizarInventario"
    caminho: "Database/dbo.pa_SincronizarInventario"
    descricao: |
      Stored Procedure que marca linhas como desatualizadas, insere novas (manual), e marca deletadas como inativas.
      PROBLEMA: Sincronização manual, dependente de job VB.NET externo via Task Scheduler (sem monitoramento).
    destino: "substituido"
    justificativa: |
      Stored Procedure substituída por SincronizacaoOperadoraJob (Hangfire RecurringJob executado às 3h AM).
      Automação robusta com retry automático, monitoramento em dashboard, histórico de execuções, e auditoria completa.
    rf_item_relacionado: "RN-RF105-007"
    uc_relacionado: "UC04"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF105-010"
    tipo: "componente"
    nome: "CriptografiaHelper.vb"
    caminho: "ic1_legado/Helpers/CriptografiaHelper.vb"
    descricao: |
      Helper de criptografia AES-256 para credenciais de operadoras.
      PROBLEMAS CRÍTICOS: Chave mestra hardcoded ("ChaveSecretaIControlIT2024"), IV fixo ("IVFixo123456").
      VULNERABILIDADES: Chave não rotacionável, IV fixo permite ataques de análise de padrões.
    destino: "substituido"
    justificativa: |
      Helper legado substituído por Azure Key Vault + CredentialEncryptionService. Chaves armazenadas em Key Vault (rotacionáveis, auditadas),
      IV aleatório gerado por request, conformidade com ISO 27001 e NIST. Chave hardcoded é vulnerabilidade crítica de segurança.
    rf_item_relacionado: "RN-RF105-001"
    uc_relacionado: "UC01"
    complexidade: "media"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF105-011"
    tipo: "componente"
    nome: "OperadoraDAO.vb"
    caminho: "ic1_legado/Helpers/OperadoraDAO.vb"
    descricao: |
      Data Access Layer legado usando ADO.NET raw (SqlCommand, SqlDataReader).
      Implementação: queries SQL hardcoded, sem type safety, sem migrations automáticas.
    destino: "substituido"
    justificativa: |
      ADO.NET raw substituído por OperadoraRepository com EF Core + Repository Pattern. Benefícios: type safety, LINQ,
      testabilidade (mock de IRepository), migrations automáticas (dotnet ef), e change tracking.
    rf_item_relacionado: "RN-RF105-008"
    uc_relacionado: "UC00"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF105-012"
    tipo: "componente"
    nome: "SincronizacaoJob.vb"
    caminho: "ic1_legado/Jobs/SincronizacaoJob.vb"
    descricao: |
      Job de sincronização diária (3h AM) executado via Windows Task Scheduler.
      PROBLEMAS: Sem monitoramento (falhas silenciosas), sem retry automático, sem auditoria de execução.
      Se job falhar, não há alerta. Histórico de execuções não rastreável.
    destino: "substituido"
    justificativa: |
      Task Scheduler substituído por Hangfire RecurringJob. Hangfire oferece: dashboard em tempo real, retry automático em falhas,
      histórico de execuções com timestamps e status, auditoria completa, e alertas configuráveis (email/webhook em falha).
    rf_item_relacionado: "RN-RF105-007"
    uc_relacionado: "UC04"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF105-013"
    tipo: "tabela"
    nome: "ConfiguracaoOperadora"
    caminho: "Database/dbo.ConfiguracaoOperadora"
    descricao: |
      Tabela de credenciais de operadoras (ApiKey, ClientId, ClientSecret criptografados AES-256).
      Schema compatível com multi-tenancy (ID_Cliente presente).
    destino: "assumido"
    justificativa: |
      Schema base compatível e assumido no sistema moderno. Evolução: adição de campos retry_maximo, timeout_segundos, cache_ttl_segundos
      para suportar retry automático e cache configurável. Tabela renomeada para IntegracaoApiExterna (nome mais genérico).
    rf_item_relacionado: "RN-RF105-001"
    uc_relacionado: "UC01"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF105-014"
    tipo: "tabela"
    nome: "FaturasOperadora.XMLFatura"
    caminho: "Database/dbo.FaturasOperadora"
    descricao: |
      Coluna [XMLFatura] [text] armazena XML completo de NF-e (pode ter MBs por fatura).
      PROBLEMA CRÍTICO: Lentidão em queries (SELECT *), backup pesado, sem versionamento.
    destino: "descartado"
    justificativa: |
      Coluna XMLFatura descartada. XMLs movidos para Azure Blob Storage. Banco moderno armazena apenas metadados:
      BlobStoragePath (URL do blob), XMLHash (SHA-256 para integridade). Separação de concerns: DB para indexação rápida, Blob para conteúdo volumoso.
      Metadados mantidos: ID_Cliente, ID_Operadora, NumeroNota, DataEmissao, Valor (assumidos).
    rf_item_relacionado: "RN-RF105-005"
    uc_relacionado: "UC03"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF105-015"
    tipo: "tabela"
    nome: "LinhasTelefonicas"
    caminho: "Database/dbo.LinhasTelefonicas"
    descricao: |
      Tabela de linhas telefônicas ativas (MSISDN, IMSI, Estado, Plano).
      Schema compatível com multi-tenancy (ID_Cliente, ID_Operadora presentes).
    destino: "assumido"
    justificativa: |
      Schema base compatível e assumido. Evolução: adição de campos DataSincronizacao (timestamp da última sincronização com operadora)
      e UltimaConsultaConsumo (cache de quando consumo foi consultado). Tabela renomeada para LinhasTelefonia (padronização de nomenclatura).
    rf_item_relacionado: "RN-RF105-007"
    uc_relacionado: "UC04"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF105-016"
    tipo: "tabela"
    nome: "ConsumoLinhas"
    caminho: "Database/dbo.ConsumoLinhas"
    descricao: |
      Tabela que armazena consumo de linhas (Voz, Dados, SMS, DataConsulta).
      Dados históricos de consumo consultados da operadora.
    destino: "descartado"
    justificativa: |
      Tabela descartada. Dados de consumo em tempo real não precisam persistência permanente. Sistema moderno usa Redis Cache
      com TTL 15 minutos (volátil). Cache key: consumo:{clienteId}:{operadoraId}:{msisdn}. Se necessário histórico para relatórios,
      usar Azure Application Insights Metrics (agregados, não raw data).
    rf_item_relacionado: "RN-RF105-006"
    uc_relacionado: "UC02"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF105-017"
    tipo: "regra_negocio"
    nome: "Timeout Sícrono 30s (hardcoded)"
    caminho: "ic1_legado/WebService/WSOperadora.asmx.vb"
    descricao: |
      Timeout de 30 segundos hardcoded para consultas síncronas. Não configurável por operadora.
      Operadoras lentas (ex: Oi) frequentemente excedem 30s, causando timeouts recorrentes.
    destino: "assumido"
    justificativa: |
      Regra assumida mas evoluída. Sistema moderno permite timeout configurável por API (campo timeout_segundos entre 5-300s).
      Padrão permanece 30s para compatibilidade, mas operadoras lentas podem configurar 60-120s. CancellationToken para timeout preciso.
    rf_item_relacionado: "RN-RF105-009"
    uc_relacionado: "UC02"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF105-018"
    tipo: "regra_negocio"
    nome: "Multi-tenancy com ClienteId e OperadoraId"
    caminho: "ic1_legado/Helpers/OperadoraDAO.vb"
    descricao: |
      Isolamento de dados entre clientes via ClienteId em todas as consultas.
      WHERE ID_Cliente = @ClienteId AND ID_Operadora = @OperadoraId sempre presente.
    destino: "assumido"
    justificativa: |
      Regra assumida e reforçada. Sistema moderno adiciona Global Query Filter no EF Core (validação automática em TODAS as queries).
      TenantContext injeta ClienteId do JWT, impossibilitando queries cross-tenant (proteção em nível de ORM).
    rf_item_relacionado: "RN-RF105-008"
    uc_relacionado: "UC00"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 1

  - id: "LEG-RF105-019"
    tipo: "regra_negocio"
    nome: "Sincronização Diária às 3h AM"
    caminho: "ic1_legado/Jobs/SincronizacaoJob.vb"
    descricao: |
      Job agendado diariamente às 3:00 AM (Task Scheduler) que sincroniza faturas, consumo e inventário.
      Horário escolhido por ser baixa atividade (menos impacto em performance).
    destino: "assumido"
    justificativa: |
      Regra assumida. Hangfire RecurringJob mantém horário 3h AM (cron: "0 3 * * *"). Adições: retry automático em falhas,
      monitoramento em dashboard, auditoria de execuções, e alertas configuráveis (email em falha > 3 tentativas).
    rf_item_relacionado: "RN-RF105-007"
    uc_relacionado: "UC04"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF105-020"
    tipo: "regra_negocio"
    nome: "Soft Delete (Ativa = FALSE)"
    caminho: "ic1_legado/IControlIT/Integracao/GestaoOperadoras.aspx.vb"
    descricao: |
      Inativação lógica de operadoras via campo Ativa = FALSE (nunca DELETE físico).
      Preserva histórico de auditoria e permite reativação.
    destino: "assumido"
    justificativa: |
      Regra assumida e expandida. Sistema moderno usa Fl_Excluido = TRUE (padrão de nomenclatura do projeto).
      Adiciona DataExclusao e UsuarioExclusaoId para rastreabilidade. Global Query Filter EF Core oculta registros excluídos automaticamente.
    rf_item_relacionado: "RN-RF105-008"
    uc_relacionado: "UC04"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

# Gap Analysis (Legado x Moderno)
gap_analysis:
  - item: "Cache de Respostas API"
    existe_legado: false
    existe_moderno: true
    notas: "Redis cache com TTL 15min reduz latência de 5-30s para <50ms (RN-RF105-006)"

  - item: "Retry Automático com Backoff Exponencial"
    existe_legado: false
    existe_moderno: true
    notas: "Polly retry policy (3 tentativas: 1s, 2s, 4s) melhora resiliência (RN-RF105-003)"

  - item: "Circuit Breaker"
    existe_legado: false
    existe_moderno: true
    notas: "Polly circuit breaker (5 falhas → bloqueio 5min) protege contra cascata (RN-RF105-010)"

  - item: "Validação HMAC de Webhooks"
    existe_legado: false
    existe_moderno: true
    notas: "HMAC-SHA256 obrigatório em webhooks protege contra ataques (RN-RF105-004)"

  - item: "Armazenamento Blob (Azure)"
    existe_legado: false
    existe_moderno: true
    notas: "Azure Blob Storage com AES-256 substitui pasta local insegura (RN-RF105-005)"

  - item: "Timeout Configurável por API"
    existe_legado: false
    existe_moderno: true
    notas: "Campo timeout_segundos (5-300s) permite ajuste fino por operadora (RN-RF105-009)"

  - item: "Hangfire Dashboard"
    existe_legado: false
    existe_moderno: true
    notas: "Monitoramento em tempo real de jobs, retry automático, histórico (RN-RF105-007)"

  - item: "Azure Key Vault"
    existe_legado: false
    existe_moderno: true
    notas: "Chaves rotacionáveis, auditadas, conformes ISO 27001 (RN-RF105-001)"

# Riscos de Migração
riscos_migracao:
  - risco: "Quebra de compatibilidade com operadoras que dependem de endpoints SOAP legados"
    impacto: "medio"
    probabilidade: "baixa"
    mitigacao: |
      Manter proxy SOAP→REST temporário por 90 dias. Notificar operadoras com 60 dias de antecedência sobre descontinuação de SOAP.
      Fornecer documentação de migração para REST API.

  - risco: "Perda de XMLs durante migração de \\servidor\faturas\ para Azure Blob"
    impacto: "alto"
    probabilidade: "baixa"
    mitigacao: |
      Script de migração com validação de hash SHA-256 (comparar XMLs locais vs. blobs). Manter pasta local por 180 dias após migração.
      Backup completo antes de iniciar. Migração em lotes de 1000 faturas com checkpoint.

  - risco: "Chave mestra hardcoded do legado comprometida (ChaveSecretaIControlIT2024)"
    impacto: "critico"
    probabilidade: "media"
    mitigacao: |
      Re-criptografar TODAS as credenciais existentes com chave do Azure Key Vault imediatamente após migração.
      Script de rotação automática: descriptografa com chave legado, re-criptografa com Key Vault. Audit log completo.

  - risco: "Job Hangfire não executado em horário esperado (3h AM) por mudança de fuso horário"
    impacto: "medio"
    probabilidade: "baixa"
    mitigacao: |
      Cron configurado com TimeZoneInfo.FindSystemTimeZoneById("E. South America Standard Time"). Alerta configurado se job não executar por 24h.
      Teste em ambiente staging com fusos horários diferentes (UTC, America/Sao_Paulo, America/New_York).

# Changelog
changelog:
  - versao: "2.0"
    data: "2025-12-31"
    descricao: "Rastreabilidade completa com 20 itens legado documentados, destinos obrigatórios, gap analysis, riscos de migração"
    autor: "IControlIT Architect Agent"
