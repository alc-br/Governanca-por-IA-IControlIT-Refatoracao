# RF035 - Gestão de Resumos de Auditoria

**Versão:** 2.0
**Data:** 2025-12-30
**Autor:** Architect Agent
**EPIC:** EPIC010-AUD-Auditoria-Avancada
**Fase:** Fase 6 - Ativos, Auditoria e Integrações

---

## 1. VISÃO GERAL

### 1.1 Objetivo do Requisito

O **RF035 - Gestão de Resumos de Auditoria** implementa o módulo de consolidação, análise e relatório gerencial de auditorias de faturas de telecomunicações. Este sistema é responsável por agregar dados detalhados de itens de auditoria (RF034) em resumos consolidados por período, operadora, tipo de serviço e lote, fornecendo visões executivas, indicadores de desempenho e alertas automáticos de desvios.

Este documento define **o que o sistema deve fazer**, servindo como **contrato oficial** entre negócio, desenvolvimento, testes e agentes de IA.

### 1.2 Importância Estratégica

O módulo de Resumos de Auditoria é crítico para:

- **Visibilidade Executiva:** Dashboards gerenciais consolidados com KPIs em tempo real para tomada de decisão estratégica sobre continuidade de programas de auditoria
- **Inteligência Financeira:** Calcula ROI de auditoria (economia realizada vs. investimento), justificando continuidade e expansão de programas
- **Análise Comparativa:** Compara períodos (mês/mês, trimestre/trimestre, ano/ano) e operadoras para identificação de padrões de glosa e tendências
- **Conformidade Contratual:** Documenta não-conformidades recorrentes de operadoras como base para renegociações de contratos e SLAs
- **Performance Management:** Avalia efetividade de equipes de auditoria através de métricas de produtividade e ROI individual
- **Alertas Operacionais:** Detecta desvios de padrão (glosas acima da média histórica) para investigação proativa e gestão de risco
- **Exportação Gerencial:** Gera relatórios consolidados para diretoria, conselhos, stakeholders e acionistas em PDF e Excel

### 1.3 Conceitos Fundamentais

**Resumo de Auditoria:** Agregação consolidada de itens auditados (RF034) em um período específico, agrupado por dimensões (operadora, tipo serviço, centro custo, lote). Inclui totalizadores financeiros e indicadores de desempenho.

- Período de consolidação (dia, mês, trimestre, ano)
- Dimensões de agrupamento (operadora, tipo serviço, centro custo, lote)
- Totalizadores financeiros (valor faturado, valor glosado, economia, %)

**Glosa de Auditoria:** Diferença entre valor cobrado pela operadora e valor contratualmente correto, representando sobrecobranças a serem recuperadas. Calculada como: Valor Cobrado - Valor Correto.

- Expressão em R$ (valor absoluto) e % de divergência para benchmarking
- Essencial para quantificar impacto financeiro e justificar contestações

**Drill-Down de Navegação:** Funcionalidade que permite exploração entre níveis hierárquicos de agregação, navegando de resumo consolidado para itens específicos para bilhetes originais.

- Resumo (consolidado) → Itens (filtrados) → Bilhete (detalhe)
- Preservação automática de contexto (filtros, período, operadora)

**Indicador de Performance:** Métrica calculada derivada de dados de auditoria que quantifica efetividade, qualidade ou retorno do programa.

- % glosa média por operadora (benchmark)
- Taxa de economia realizada vs. investimento em auditoria (ROI)
- Tempo médio de processamento de item por auditor (eficiência)
- Ticket médio glosado (valor econômico médio por item)

### 1.4 Escopo

#### O que está dentro do escopo

- [x] Consolidação automática diária de itens em resumos agrupados
- [x] Cálculo de totalizadores financeiros (faturado, glosado, economia, %)
- [x] Análise comparativa entre períodos (mês/mês, trimestre, ano)
- [x] Indicadores de performance (ROI, % glosa, ticket médio, eficiência)
- [x] Dashboard executivo com gráficos em tempo real (Chart.js + SignalR)
- [x] Drill-down navegável com preservação de contexto
- [x] Alertas automáticos de desvios (glosa > limite, variação > 20%)
- [x] Exportação de relatórios gerenciais (PDF com iText, Excel com EPPlus)
- [x] Histórico de períodos com arquivamento (3 anos online, 7 anos backup)
- [x] Integração bidirecional com lotes (RF054)
- [x] Row-Level Security automática por ClienteId
- [x] Integração com SLA Audit (RF028, RF029)

#### Fora do escopo

- Interface visual específica (definida em WF-RF035)
- Tecnologia de implementação (definida em padrões de codificação)
- Layout, UX ou identidade visual (responsabilidade do frontend)
- Estratégia de deploy ou infraestrutura (definida em contratos de deploy)
- Análise manual de glosas (sistema é automático)
- Geração de contestações formais para operadoras (RF futuro)

---

## 2. FUNCIONALIDADES

### 2.1 Funcionalidades Principais

1. **Consolidação Automática Diária** - Job Hangfire executado diariamente (02h) consolidando itens auditados do dia anterior em resumos agrupados por período, operadora, tipo serviço e lote (**CRÍTICA**)

2. **Totalizadores Financeiros Automáticos** - Cálculo de somas: valor total faturado, valor total glosado, valor econômico realizado, percentual de glosa, percentual de economia com precisão de 8 casas decimais (**CRÍTICA**)

3. **Análise Comparativa Multi-Período** - Comparação mês atual vs. mês anterior, trimestre atual vs. anterior, ano atual vs. anterior com variações em valor absoluto e percentual (**ALTA**)

4. **Indicadores de Performance Calculados** - KPIs: taxa de economia em %, ROI de auditoria, % glosa por operadora, ticket médio glosado, itens processados por auditor/dia, eficiência operacional (**ALTA**)

5. **Dashboard Executivo em Tempo Real** - Visualização de principais indicadores com gráficos (Chart.js: linhas/barras/pizza), totalizadores, Top 10 (maiores glosas, operadoras divergentes) com atualização SignalR (**ALTA**)

6. **Drill-Down Navegável com Contexto** - Capacidade de descer de resumo consolidado para itens específicos para bilhetes originais preservando filtros aplicados, período, operadora, lote (**ALTA**)

7. **Alertas de Desvios Automáticos** - Detecção quando: glosa operadora > limite histórico, glosa mês atual > mês anterior em +20%, economia < 80% meta, padrões novos de glosa detectados (**CRÍTICA**)

8. **Exportação de Relatórios Gerenciais** - Geração de PDF (iText) e Excel (EPPlus) com gráficos, tabelas consolidadas, análises comparativas, 16 pontos i18n, assinatura digital (**ALTA**)

9. **Histórico de Períodos com Arquivamento** - Manutenção de arquivo histórico de resumos anteriores (3 anos online, 7 anos em backup conforme LGPD) para análise de tendências multi-ano (**MÉDIA**)

10. **Integração Bidirecional com Lotes** - Vinculação com RF054 (Gestão de Lotes), permitindo navegação: resumo → lote origem e lote → resumos consolidados (**ALTA**)

11. **Segurança Row-Level Automática** - Isolamento por conglomerado (ClienteId obrigatório) com validação em TODAS operações CRUD, RLS SQL Server, CONTEXT_INFO (**CRÍTICA**)

12. **Integração com SLA Audit** - Links para configurações de SLA (RF028, RF029) permitindo contexto sobre tolerância de divergências por tipo serviço (**MÉDIA**)

---

## 3. REGRAS DE NEGÓCIO

### RN-RF035-001: Consolidação Automática Diária com Agrupamento Multi-Dimensional

**Descrição:** O sistema DEVE executar automaticamente um job Hangfire a cada dia às 02h00 (horário servidor UTC) que consolida todos os itens de auditoria criados no dia anterior, agrupando por ClienteId, Operadora, TipoServico, LoteAuditoriaId e DataPeriodo, criando um resumo por combinação única.

**Justificativa:** Garante dados sempre atualizados sem ações manuais. Executa fora horário comercial minimizando impacto performance. Agrupamento multi-dimensional permite análises em múltiplos níveis.

**Critério de Aceite:**
- Job DEVE executar diariamente às 02h00 UTC sem intervenção manual
- DEVE agrupar itens por (ClienteId, Operadora, TipoServico, LoteId, DataPeriodo)
- DEVE criar resumo único por combinação
- Falha no job DEVE gerar alerta crítico
- Job DEVE ter proteção contra execução concorrente

**Prioridade:** CRÍTICA

---

### RN-RF035-002: Cálculo Automático e Validado de Totalizadores

**Descrição:** Sistema DEVE calcular automaticamente: TotalFaturado (Σ ValorCobrado), TotalGlosado (Σ ValorCobradoAMais), TotalEconomia (= TotalGlosado), PercentualGlosa (Glosado / Faturado * 100), PercentualEconomia (Economia / Faturado * 100) com precisão de 8 casas decimais conforme padrão telecomunicações.

**Justificativa:** Elimina erros de cálculo manual. Garante consistência em todas visualizações. Cálculo determinístico permite auditoria e verificação.

**Critério de Aceite:**
- DEVE calcular TotalFaturado = Σ ValorCobrado de todos os itens do grupo
- DEVE calcular TotalGlosado = Σ ValorCobradoAMais de todos os itens do grupo
- DEVE calcular PercentualGlosa = (TotalGlosado / TotalFaturado) * 100
- DEVE validar que TotalGlosado ≤ TotalFaturado
- DEVE validar que valores não sejam negativos
- DEVE usar precisão de 8 casas decimais em cálculos intermediários
- DEVE arredondar resultados finais para 2 casas decimais (moeda)
- SE TotalFaturado = 0 ENTÃO PercentualGlosa = 0

**Prioridade:** CRÍTICA

**Exemplos:**
- Válido: 10 itens, Faturado=R$1.000,00, Glosado=R$150,00, % Glosa=15,00%
- Inválido: Glosado=R$1.500 (> Faturado) → DomainException lançada

---

### RN-RF035-003: Análise Comparativa Automática Entre Períodos

**Descrição:** Sistema DEVE calcular automaticamente variações entre período atual e período anterior (mês, trimestre, ano) em valores absolutos (R$) e percentuais (%). Variações superiores a 20% DEVEM gerar alertas automáticos.

**Justificativa:** Permite identificação rápida de tendências e desvios sem processamento manual. Essencial para análises executivas proativas.

**Critério de Aceite:**
- DEVE comparar mês atual vs. mês anterior
- DEVE comparar trimestre atual vs. trimestre anterior
- DEVE comparar ano atual vs. ano anterior
- DEVE calcular variação absoluta = ValorAtual - ValorAnterior
- DEVE calcular variação percentual = ((ValorAtual - ValorAnterior) / ValorAnterior) * 100
- SE variação > +20% ENTÃO gerar alerta de aumento
- SE variação < -20% ENTÃO gerar alerta de redução
- DEVE exibir variações no dashboard com indicador visual (↑ verde, ↓ vermelho)

**Prioridade:** ALTA

---

### RN-RF035-004: Cálculo de Indicadores de Performance

**Descrição:** Sistema DEVE calcular automaticamente os seguintes indicadores: % Glosa Média por Operadora, ROI Auditoria (Economia / Investimento * 100), Taxa Economia vs Meta, Ticket Médio Glosado, Eficiência por Auditor (itens/dia) com atualização em tempo real.

**Justificativa:** Indicadores consolidados permitem análise gerencial rápida e identificação de operadoras problema.

**Critério de Aceite:**
- DEVE calcular % Glosa Média por Operadora = média de PercentualGlosa agrupado por Operadora
- DEVE calcular ROI = (TotalEconomia / InvestimentoAuditoria) * 100
- DEVE calcular Ticket Médio = TotalGlosado / QuantidadeItens
- DEVE calcular Eficiência Auditor = QuantidadeItens / DiasUteis
- Indicadores DEVEM ser recalculados após cada consolidação
- DEVE armazenar histórico de indicadores para análise de tendências
- DEVE permitir exportação de indicadores em Excel

**Prioridade:** ALTA

---

### RN-RF035-005: Alertas de Desvios Automáticos

**Descrição:** Sistema DEVE gerar alertas automáticos quando: glosa operadora > limite histórico definido, variação mês atual vs. anterior > 20%, economia < 80% da meta, padrões novos de glosa detectados (>2 desvios padrão da média histórica).

**Justificativa:** Identificação proativa de anomalias sem monitoramento manual. Severidade diferenciada (CRITICO, ALERTA, AVISO) direciona atenção correta.

**Critério de Aceite:**
- DEVE gerar alerta SE % Glosa Operadora > limite configurado
- DEVE gerar alerta SE variação período > +20% ou < -20%
- DEVE gerar alerta SE Economia < 80% da meta definida
- DEVE gerar alerta SE valor > média + 2σ (dois desvios padrão)
- Alertas DEVEM ter severidade (CRITICO, ALERTA, AVISO)
- DEVE notificar usuários em tempo real via SignalR
- DEVE registrar alertas em tabela de auditoria
- DEVE permitir reconhecimento manual de alertas

**Prioridade:** CRÍTICA

---

### RN-RF035-006: Drill-Down com Preservação de Contexto

**Descrição:** Sistema DEVE permitir navegação entre níveis hierárquicos: Resumo → Itens → Bilhete preservando TODOS os filtros aplicados (período, operadora, lote) e mantendo breadcrumb de navegação.

**Justificativa:** Análise exploratória essencial para investigação de divergências. Contexto preservado melhora usabilidade e eficiência de análise.

**Critério de Aceite:**
- DEVE navegar de Resumo para Itens preservando filtros (operadora, período, lote)
- DEVE navegar de Item para Bilhete original preservando contexto
- DEVE exibir breadcrumb com caminho de navegação
- DEVE permitir retorno ao nível anterior restaurando contexto
- Filtros DEVEM ser passados via querystring ou state management
- DEVE validar que usuário tem permissão para acessar todos os níveis

**Prioridade:** ALTA

---

### RN-RF035-007: Integração Bidirecional com Lotes (RF054)

**Descrição:** Resumos DEVEM ser vinculados ao lote de origem. Sistema DEVE permitir navegação bidirecional: a partir de resumo, acessar lote; a partir de lote, visualizar resumos que contêm seus itens.

**Justificativa:** Rastreabilidade completa entre lotes e resumos. Integração entre módulos obrigatória para consistência de dados.

**Critério de Aceite:**
- Resumo DEVE ter FK LoteAuditoriaId (nullable)
- A partir de resumo, DEVE permitir navegação para tela de lote
- A partir de lote, DEVE exibir lista de resumos relacionados
- DEVE validar que lote existe antes de criar resumo
- DEVE permitir filtrar resumos por lote

**Prioridade:** ALTA

---

### RN-RF035-008: Exportação em Múltiplos Formatos

**Descrição:** Sistema DEVE permitir exportação de resumos e dashboards em PDF (iText 8+) com gráficos renderizados e Excel (EPPlus 6+) com múltiplas abas (Consolidado, Detalhes, Gráficos).

**Justificativa:** Compartilhamento com stakeholders sem acesso ao sistema. Formatos estruturados facilitam análise offline e auditoria externa.

**Critério de Aceite:**
- DEVE exportar PDF com: cabeçalho, rodapé, gráficos, tabelas, 16 pontos i18n
- DEVE exportar Excel com: aba Consolidado (resumos), aba Detalhes (itens), aba Gráficos
- PDF DEVE ter assinatura digital (opcional)
- Excel DEVE ter formatação (cores, bordas, títulos)
- Exportação DEVE ser assíncrona (job Hangfire)
- DEVE validar permissão auditoria:resumo:export
- DEVE registrar exportação em auditoria

**Prioridade:** ALTA

---

### RN-RF035-009: Row-Level Security por ClienteId

**Descrição:** Sistema DEVE aplicar isolamento automático por ClienteId em TODAS as operações CRUD. Usuários DEVEM acessar APENAS resumos do seu próprio conglomerado.

**Justificativa:** Multi-tenancy obrigatório. Sem RLS, dados vazam entre clientes. Conformidade LGPD exige isolamento rigoroso.

**Critério de Aceite:**
- TODAS queries DEVEM incluir WHERE ClienteId = @ClienteIdUsuario
- DEVE usar SQL Server RLS (Row-Level Security)
- DEVE definir CONTEXT_INFO com ClienteId no início da conexão
- Tentativa de acesso cruzado DEVE retornar 403 Forbidden
- DEVE validar ClienteId em Commands antes de persistir
- DEVE auditar tentativas de violação

**Prioridade:** CRÍTICA

---

### RN-RF035-010: Auditoria Completa de Alterações

**Descrição:** Sistema DEVE registrar TODAS as operações de criação, atualização, exclusão e exportação com: usuário, timestamp, IP, campos alterados (antes/depois), motivo (se aplicável) com retenção de 7 anos (LGPD).

**Justificativa:** Conformidade LGPD, rastreabilidade total, suporte a auditorias externas e análise de comportamento suspeito.

**Critério de Aceite:**
- DEVE registrar: UserId, Timestamp, IP, Ação (CREATE/UPDATE/DELETE/EXPORT)
- DEVE registrar estado anterior e novo (JSON)
- DEVE ter retenção de 7 anos
- DEVE permitir consulta de histórico por período/usuário/ação
- DEVE exportar logs de auditoria em Excel

**Prioridade:** CRÍTICA

---

### RN-RF035-011: Validação de Integridade Referencial

**Descrição:** Sistema DEVE validar que: lote (FK) existe no banco, TODOS os itens pertencem ao mesmo conglomerado do resumo, período do resumo coincide com período dos itens agrupados.

**Justificativa:** Previne dados órfãos, inconsistências e violações de integridade referencial que comprometem confiabilidade dos dados.

**Critério de Aceite:**
- SE LoteId informado ENTÃO validar que lote existe
- DEVE validar que TODOS itens têm ClienteId = ClienteIdResumo
- DEVE validar que DataPeriodo dos itens ≈ DataPeriodo do resumo
- Falha de validação DEVE lançar DomainException
- DEVE registrar falhas de validação em log

**Prioridade:** CRÍTICA

---

## 4. INTEGRAÇÕES OBRIGATÓRIAS

### 4.1 Central de Funcionalidades

```json
{
    "featureKey": "AUDITORIA_RESUMOS",
    "nome": "Gestão de Resumos de Auditoria",
    "descricao": "Consolidação e análise gerencial de auditorias",
    "modulo": "Auditoria",
    "habilitado": true,
    "permissoesRequeridas": [
        "auditoria:resumo:read",
        "auditoria:resumo:create",
        "auditoria:resumo:update",
        "auditoria:resumo:delete",
        "auditoria:resumo:export",
        "auditoria:indicador:read",
        "auditoria:alerta:read"
    ]
}
```

### 4.2 Internacionalização (i18n - 16 Pontos Obrigatórios)

```json
{
    "auditoria": {
        "resumos": {
            "titulo": "Resumos de Auditoria",
            "dashboard": "Dashboard Executivo",
            "periodo": "Período",
            "operadora": "Operadora",
            "totalFaturado": "Total Faturado",
            "totalGlosado": "Total Glosado",
            "economia": "Economia",
            "percentualGlosa": "% Glosa",
            "acoes": "Ações",
            "exportar": "Exportar",
            "analisar": "Analisar",
            "filtrar": "Filtrar",
            "comparar": "Comparar",
            "alertas": "Alertas",
            "indicadores": "Indicadores",
            "drillDown": "Detalhar"
        }
    }
}
```

### 4.3 Auditoria

Operações auditadas: CREATE, UPDATE, DELETE, EXPORT com retenção de 7 anos (LGPD).

Campos obrigatórios no log:
- UserId (Guid) - Quem executou
- Timestamp (DateTime) - Quando executou
- Action (string) - O que executou (CREATE/UPDATE/DELETE/EXPORT)
- EntityId (Guid) - ID do resumo afetado
- OldValues (JSON) - Estado anterior (UPDATE/DELETE)
- NewValues (JSON) - Estado novo (CREATE/UPDATE)
- IpAddress (string) - IP de origem
- UserAgent (string) - Navegador/aplicação

### 4.4 Controle de Acesso (RBAC)

| Permissão | Código | Perfis Autorizados |
|-----------|--------|-------------------|
| Listar resumos | `auditoria:resumo:read` | Gerente, Auditor, Diretor, Admin |
| Criar resumo | `auditoria:resumo:create` | Admin (job automático) |
| Atualizar resumo | `auditoria:resumo:update` | Admin |
| Excluir resumo | `auditoria:resumo:delete` | Admin |
| Exportar relatório | `auditoria:resumo:export` | Gerente, Auditor, Diretor, Admin |
| Visualizar indicadores | `auditoria:indicador:read` | Gerente, Diretor, Admin |
| Visualizar alertas | `auditoria:alerta:read` | Gerente, Diretor, Admin |
| Drill-down itens | `auditoria:itens:read` | Gerente, Auditor, Diretor, Admin |

---

## 5. PERMISSÕES RBAC

| Funcionalidade | Permission Code | Roles Autorizadas | Endpoint |
|---------------|----------------|------------------|----------|
| Listar resumos | `AUD.RESUMOS.READ` | Gerente, Auditor, Diretor, Admin | `GET /api/auditoria/resumos` |
| Obter resumo específico | `AUD.RESUMOS.READ` | Gerente, Auditor, Diretor, Admin | `GET /api/auditoria/resumos/{id}` |
| Criar resumo (job) | `AUD.RESUMOS.CREATE` | System (Hangfire Job) | `POST /api/auditoria/resumos` |
| Atualizar resumo | `AUD.RESUMOS.UPDATE` | Admin | `PUT /api/auditoria/resumos/{id}` |
| Excluir resumo | `AUD.RESUMOS.DELETE` | Admin | `DELETE /api/auditoria/resumos/{id}` |
| Exportar PDF | `AUD.RESUMOS.EXPORT` | Gerente, Diretor, Admin | `GET /api/auditoria/resumos/{id}/pdf` |
| Exportar Excel | `AUD.RESUMOS.EXPORT` | Gerente, Diretor, Admin | `GET /api/auditoria/resumos/{id}/excel` |
| Visualizar dashboard | `AUD.INDICADORES.READ` | Gerente, Diretor, Admin | `GET /api/auditoria/dashboard` |
| Visualizar alertas | `AUD.ALERTAS.READ` | Gerente, Diretor, Admin | `GET /api/auditoria/alertas` |
| Reconhecer alerta | `AUD.ALERTAS.ACKNOWLEDGE` | Gerente, Diretor, Admin | `POST /api/auditoria/alertas/{id}/reconhecer` |
| Drill-down itens | `AUD.ITENS.READ` | Gerente, Auditor, Diretor, Admin | `GET /api/auditoria/resumos/{id}/itens` |

---

## 6. API ENDPOINTS

### 6.1 CRUD Principal

| Método | Endpoint | Descrição | Request DTO | Response DTO | Autorização |
|--------|----------|-----------|------------|--------------|-------------|
| GET | `/api/auditoria/resumos` | Listar com filtros e paginação | Query params (página, tamanho, filtros) | `PaginatedListDto<AuditoriaResumoDto>` | `AUD.RESUMOS.READ` |
| GET | `/api/auditoria/resumos/{id}` | Obter resumo específico | - | `AuditoriaResumoDto` | `AUD.RESUMOS.READ` |
| POST | `/api/auditoria/resumos` | Criar resumo (job automático) | `CreateAuditoriaResumoCommand` | `Guid` (ID do resumo criado) | `AUD.RESUMOS.CREATE` |
| PUT | `/api/auditoria/resumos/{id}` | Atualizar resumo | `UpdateAuditoriaResumoCommand` | `void` | `AUD.RESUMOS.UPDATE` |
| DELETE | `/api/auditoria/resumos/{id}` | Excluir resumo (soft delete) | - | `void` | `AUD.RESUMOS.DELETE` |

### 6.2 Operações Especiais

| Método | Endpoint | Descrição | Response DTO | Autorização |
|--------|----------|-----------|--------------|-------------|
| POST | `/api/auditoria/resumos/{id}/calcular-indicadores` | Recalcula KPIs manualmente | `IndicadoresDto` | `AUD.INDICADORES.READ` |
| GET | `/api/auditoria/resumos/{id}/itens` | Drill-down para itens (navegação) | `PaginatedListDto<AuditoriaItemDto>` | `AUD.ITENS.READ` |
| POST | `/api/auditoria/resumos/{id}/comparar-periodos` | Análise comparativa (atual vs. anterior) | `ComparacaoPeríodosDto` | `AUD.RESUMOS.READ` |
| GET | `/api/auditoria/resumos/{id}/exportar/pdf` | Exporta resumo em PDF | `FileStreamResult` (PDF) | `AUD.RESUMOS.EXPORT` |
| GET | `/api/auditoria/resumos/{id}/exportar/excel` | Exporta resumo em Excel | `FileStreamResult` (XLSX) | `AUD.RESUMOS.EXPORT` |
| GET | `/api/auditoria/resumos/{id}/lote` | Navega para lote de origem | `LoteAuditoriaDto` | `AUD.RESUMOS.READ` |
| POST | `/api/auditoria/resumos/consolidar/agora` | Executa job consolidação manual | `void` | `AUD.RESUMOS.CREATE` |
| GET | `/api/auditoria/alertas` | Lista alertas de desvios | `PaginatedListDto<AlertaAuditoriaDto>` | `AUD.ALERTAS.READ` |
| POST | `/api/auditoria/alertas/{id}/reconhecer` | Marca alerta como reconhecido | `void` | `AUD.ALERTAS.ACKNOWLEDGE` |
| GET | `/api/auditoria/dashboard` | Dashboard com KPIs consolidados | `DashboardDto` | `AUD.INDICADORES.READ` |
| GET | `/api/auditoria/resumos/top10/divergencias` | Top 10 maiores glosas | `List<AuditoriaResumoDto>` | `AUD.RESUMOS.READ` |
| GET | `/api/auditoria/evolucao/ultimos-12-meses` | Tendência de glosas 12 meses | `EvolucaoDto` | `AUD.RESUMOS.READ` |
| GET | `/api/auditoria/indicadores/roi` | ROI da auditoria | `RoiDto` | `AUD.INDICADORES.READ` |

---

## 7. MODELO DE DADOS

Ver detalhamento completo em [MD-RF035.md](./MD-RF035.md).

Principais entidades envolvidas:
- **AuditoriaResumo** (aggregate root) - Resumo consolidado de auditorias
- **AuditoriaItem** (referência de RF034) - Itens que compõem o resumo
- **LoteAuditoria** (referência de RF054) - Lote de origem dos itens
- **AlertaAuditoria** - Alertas de desvios gerados automaticamente

Relacionamentos críticos:
- AuditoriaResumo → LoteAuditoria (N:1, FK nullable)
- AuditoriaResumo → Cliente (N:1, multi-tenancy obrigatório)
- AuditoriaResumo ← AlertaAuditoria (1:N, alertas associados ao resumo)

---

## 8. DEPENDÊNCIAS

### 8.1 RFs Dependentes (Upstream)

| RF | Descrição | Tipo de Dependência |
|----|-----------|-------------------|
| RF034 | Gestão de Itens de Auditoria | **Bloqueante** - RF035 consolida itens de RF034 |
| RF054 | Gestão de Lotes de Auditoria | **Bloqueante** - Resumos vinculados a lotes |
| RF028 | SLA de Auditoria | Opcional - Links para configurações SLA |
| RF029 | Configurações de Auditoria | Opcional - Parâmetros de alertas |

### 8.2 RFs que Dependem deste (Downstream)

| RF | Descrição | Tipo de Dependência |
|----|-----------|-------------------|
| RF036 | Contestações de Auditoria | Consome resumos para geração de contestações |
| RF037 | Relatórios Gerenciais Consolidados | Agrega múltiplos resumos |

### 8.3 Dependências de Bibliotecas Externas

| Biblioteca | Versão | Finalidade |
|-----------|--------|-----------|
| Hangfire | 1.8+ | Jobs de consolidação automática |
| iTextSharp / iText 8+ | 8.0+ | Geração de PDF |
| EPPlus | 6.0+ | Geração de Excel |
| SignalR | ASP.NET Core | Notificações em tempo real |
| Chart.js | 4.0+ (frontend) | Gráficos no dashboard |

---

## 9. KPIs E MÉTRICAS

### 9.1 Indicadores de Performance

| KPI | Meta | Fórmula de Cálculo | Log Obrigatório |
|-----|------|-------------------|-----------------|
| **Glosa Média** | < 10% | (TotalGlosado / TotalFaturado) * 100 | Sim |
| **ROI Auditoria** | > 300% | (TotalEconomia / InvestimentoAuditoria) * 100 | Sim |
| **Taxa de Economia** | > 80% | (TotalEconomia / MetaEconomia) * 100 | Sim |
| **Ticket Médio Glosado** | > R$ 100 | TotalGlosado / QuantidadeItens | Sim |
| **Eficiência Auditor** | > 50 itens/dia | QuantidadeItens / DiasUteis | Sim |
| **Tempo Resposta API** | < 5s | Medido por APM (Application Performance Monitoring) | Sim |
| **Disponibilidade** | > 99.5% | Uptime / Total Time | Sim |
| **Taxa de Conformidade** | > 95% | ItensConformes / QuantidadeItens | Sim |

### 9.2 Logs Obrigatórios

Todos os KPIs DEVEM ser logados em tabela específica (`AuditoriaIndicadores`) com:
- Timestamp de cálculo
- Tipo de indicador (enum)
- Valor calculado
- Período de referência
- Metadados (ClienteId, Operadora se aplicável)

---

## 10. ALERTAS CRÍTICOS

### 10.1 Definição de Alertas

| Alerta | Condição de Disparo | Threshold | Severidade | Canal de Notificação |
|--------|-------------------|-----------|-----------|---------------------|
| **Glosa Alta** | % Glosa Operadora > limite configurado | Configurável (padrão: 15%) | ALTA | Email, Slack, SignalR |
| **Aumento Anormal** | Variação mês atual vs. anterior > +20% | +20% | CRÍTICA | Email, Slack, SignalR, SMS |
| **Meta Não Atingida** | Economia < 80% da meta | < 80% da meta | MÉDIA | Email, SignalR |
| **Lentidão de API** | Tempo de resposta > 10s | 10 segundos | ALTA | Email, Slack |
| **Falha no Job** | Job consolidação com erro | Qualquer erro | CRÍTICA | Email, Slack, SMS |
| **Inconsistência de Dados** | Validação de integridade falha | Qualquer falha | CRÍTICA | Email, Slack, DBA Alert |

### 10.2 Ações Automáticas

- Alerta de **Glosa Alta** → Notificar supervisor imediato
- Alerta de **Aumento Anormal** → Acionar revisão manual do lote
- Alerta de **Falha Job** → Reexecutar job automaticamente (máximo 3 tentativas)
- Alerta de **Inconsistência** → Bloquear novas consolidações até correção

---

## 11. CENTRAL DE FUNCIONALIDADES

```yaml
feature:
  codigo: "AUDITORIA_RESUMOS"
  modulo: "Admin / Auditoria"
  nome_i18n_key: "auditoria.resumos.titulo"
  descricao_i18n_key: "auditoria.resumos.descricao"
  icone: "analytics"
  rota_frontend: "/admin/auditoria/resumos"
  ordem_menu: 35
  habilitado: true
  permissao_requerida: "AUD.RESUMOS.READ"
  tipo: "feature"
  tags: ["auditoria", "resumo", "dashboard", "kpi"]
```

---

## ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF035.md** (Casos de Uso) - 5 casos de uso obrigatórios
- **MD-RF035.md** (Modelo de Dados) - DDL, índices, particionamento
- **WF-RF035.md** (Workflows) - Mockups Angular, fluxos de tela
- **user-stories.yaml** - Quebra em User Stories implementáveis
- **TC-RF035-BACKEND.md** (Casos de Teste Backend)
- **TC-RF035-FRONTEND.md** (Casos de Teste Frontend)
- **TC-RF035-E2E.md** (Casos de Teste E2E)

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0: Separação RF/RL, 11 seções canônicas | Architect Agent |
| 1.0 | 2025-01-14 | Versão inicial com 11 regras, 13 endpoints, 3 fluxos | Architect Agent |

---

**Última Atualização:** 2025-12-30
**Status:** Pronto para criação de RL-RF035 (Referência ao Legado)
**Próximo Passo:** Criar RL-RF035.md com memória técnica do legado
