rf:
  id: RF096
  nome: Auditoria de Mudanças de Dados
  versao: '2.0'
  data: '2025-12-31'
  fase: Fase 6 - Ativos, Auditoria e Integrações
  epic: EPIC010-AUD-Auditoria-Avancada
  modulo: Auditoria
  status: em_desenvolvimento
descricao:
  objetivo: Garantir rastreabilidade total de todas as operações de criação, alteração
    e exclusão de dados em entidades críticas do sistema, com contexto completo de
    execução e conformidade LGPD/SOX 404.
  problema_resolvido: Falta de rastreabilidade histórica de alterações, dificuldade
    em auditorias regulatórias, impossibilidade de reconstruir estados anteriores
    de dados críticos, e não conformidade com LGPD Art. 5º e SOX 404.
  publico_afetado: Auditores internos/externos, DPO (Data Protection Officer), Security
    Team, administradores do sistema, usuários finais (timeline própria).
escopo:
  incluso:
  - Rastreamento automático de operações CRUD (Create, Read, Update, Delete)
  - Captura de valores antes/depois em nível de campo
  - Contexto completo de execução (usuário, IP, timestamp, user-agent, ClienteId)
  - Detecção automática de operações em lote com CorrelationId
  - Visualização de linha do tempo com filtros avançados
  - Rollback controlado com validação de integridade referencial
  - Relatórios parametrizados com agregações
  - Dashboard com alertas de anomalias
  - Integração com Azure Sentinel (SIEM)
  - Exportação forense (CSV, Excel, JSON, PDF)
  - Retenção de dados conforme LGPD/SOX
  - Soft delete com rastreamento
  - Imutabilidade de registros de auditoria
  fora:
  - Auditoria de consultas (SELECT) sem alteração de dados
  - Auditoria de sessões de usuário (login/logout) - coberto por RF097
  - Auditoria de permissões e acessos - coberto por RF098
  - Auditoria de jobs e processamentos batch - coberto por RF099
entidades:
- nome: AuditLog
  descricao: Registro de auditoria de mudanças em entidades
  multi_tenant: true
  soft_delete: false
  auditoria: false
- nome: AuditFieldChange
  descricao: Registro de mudança em campo específico
  multi_tenant: false
  soft_delete: false
  auditoria: false
- nome: AuditRetentionPolicy
  descricao: Política de retenção de dados de auditoria por tipo de entidade
  multi_tenant: true
  soft_delete: false
  auditoria: true
regras_negocio:
- id: RN-RF096-001
  descricao: Toda entidade decorada com atributo de auditoria deve ter rastreamento
    automático de Create, Update e Delete sem necessidade de código adicional no handler.
  tipo: regra_negocio
  campos_afetados:
  - todas as entidades com [Audited]
  obrigatorio: true
- id: RN-RF096-002
  descricao: Para toda alteração (Update), o sistema deve capturar valores anteriores
    e posteriores em nível de campo, junto com contexto completo de execução.
  tipo: regra_negocio
  campos_afetados:
  - OldValue
  - NewValue
  - FieldName
  - Timestamp
  - UserId
  - IP
  - UserAgent
  obrigatorio: true
- id: RN-RF096-003
  descricao: Registros de auditoria são append-only e não podem ser alterados ou excluídos
    após inserção, garantindo integridade da trilha de auditoria.
  tipo: seguranca
  campos_afetados:
  - AuditLog
  obrigatorio: true
- id: RN-RF096-004
  descricao: Exclusões lógicas (soft delete) devem ser rastreadas como operações auditadas,
    registrando quem excluiu, quando e contexto completo.
  tipo: regra_negocio
  campos_afetados:
  - DeletedAt
  - DeletedBy
  obrigatorio: true
- id: RN-RF096-005
  descricao: Quando múltiplas entidades são alteradas em uma única transação, o sistema
    deve detectar automaticamente e agrupar com CorrelationId único.
  tipo: regra_negocio
  campos_afetados:
  - CorrelationId
  obrigatorio: true
- id: RN-RF096-006
  descricao: Adições e remoções de entidades relacionadas (collections) devem ser
    rastreadas como operações específicas de relacionamento.
  tipo: regra_negocio
  campos_afetados:
  - OperationType
  - EntityType
  - EntityId
  obrigatorio: true
- id: RN-RF096-007
  descricao: Registros de auditoria devem ser retidos conforme prazos legais (5 anos
    LGPD para dados pessoais, 7 anos SOX 404 para dados financeiros) e automaticamente
    arquivados/purgados.
  tipo: regra_negocio
  campos_afetados:
  - RetentionYears
  - AutoArchive
  obrigatorio: true
- id: RN-RF096-008
  descricao: Alterações em campos de dados sensíveis (CPF, e-mail, telefone, endereço)
    devem gerar alertas automáticos para o DPO (Data Protection Officer).
  tipo: seguranca
  campos_afetados:
  - campos marcados como sensíveis LGPD
  obrigatorio: true
- id: RN-RF096-009
  descricao: Usuários com permissão devem poder visualizar timeline completa de alterações
    em uma entidade, com filtros por período, usuário, campo alterado e tipo de operação.
  tipo: regra_negocio
  campos_afetados:
  - filtros de timeline
  obrigatorio: true
- id: RN-RF096-010
  descricao: Usuários com permissão específica (Admin + Developer) devem poder restaurar
    versões anteriores de entidades, com validação de integridade referencial antes
    de aplicar.
  tipo: seguranca
  campos_afetados:
  - OperationType = Rollback
  obrigatorio: true
- id: RN-RF096-011
  descricao: Sistema deve gerar relatórios parametrizados de auditoria com agregações,
    totalizações e exportação em múltiplos formatos.
  tipo: regra_negocio
  campos_afetados:
  - filtros de relatórios
  obrigatorio: true
- id: RN-RF096-012
  descricao: Dashboard em tempo real deve exibir métricas de auditoria e alertas automáticos
    de padrões anômalos de alteração.
  tipo: regra_negocio
  campos_afetados:
  - métricas de dashboard
  obrigatorio: true
- id: RN-RF096-013
  descricao: Eventos de auditoria críticos devem ser enviados automaticamente para
    Azure Sentinel em tempo real, no formato CEF (Common Event Format).
  tipo: seguranca
  campos_afetados:
  - eventos de SIEM
  obrigatorio: true
- id: RN-RF096-014
  descricao: Exportações forenses de trilhas de auditoria devem incluir hash SHA-256
    de cada registro e assinatura digital do arquivo, garantindo integridade para
    uso em processos judiciais.
  tipo: seguranca
  campos_afetados:
  - exportações forenses
  obrigatorio: true
- id: RN-RF096-015
  descricao: Todos os registros de auditoria devem ser isolados por ClienteId, garantindo
    que clientes não visualizem auditoria de outros clientes.
  tipo: seguranca
  campos_afetados:
  - ClienteId
  obrigatorio: true
- id: RN-RF096-016
  descricao: Consultas de auditoria com filtros complexos não podem exceder 2 segundos
    de latência, mesmo com milhões de registros.
  tipo: regra_negocio
  campos_afetados:
  - índices otimizados
  obrigatorio: true
- id: RN-RF096-017
  descricao: Tentativas de alteração ou exclusão de registros de auditoria devem ser
    detectadas e registradas automaticamente como violações de segurança.
  tipo: seguranca
  campos_afetados:
  - tentativas de violação
  obrigatorio: true
- id: RN-RF096-018
  descricao: Campos calculados ou derivados (computed properties) não devem gerar
    registros de auditoria, evitando poluição de trilha.
  tipo: validacao
  campos_afetados:
  - campos com [NotMapped]
  obrigatorio: true
- id: RN-RF096-019
  descricao: Todos os timestamps de auditoria devem usar UTC e ser armazenados com
    precisão de milissegundos.
  tipo: validacao
  campos_afetados:
  - Timestamp
  obrigatorio: true
- id: RN-RF096-020
  descricao: Importações em massa (bulk insert) devem gerar registros de auditoria
    agrupados com CorrelationId específico de batch.
  tipo: regra_negocio
  campos_afetados:
  - CorrelationId
  - metadados de batch
  obrigatorio: true
estados:
- id: Created
  descricao: Entidade foi criada
- id: Updated
  descricao: Entidade foi atualizada
- id: Deleted
  descricao: Entidade foi excluída (soft delete)
- id: Rollback
  descricao: Entidade foi restaurada a versão anterior
- id: RelationshipAdded
  descricao: Relacionamento foi adicionado
- id: RelationshipRemoved
  descricao: Relacionamento foi removido
transicoes:
  permitidas:
  - de: Created
    para: Updated
  - de: Updated
    para: Updated
  - de: Updated
    para: Deleted
  - de: Deleted
    para: Updated
  - de: qualquer
    para: Rollback
  proibidas:
  - de: Deleted
    para: Deleted
permissoes:
- codigo: CAD.AUDITORIA.TIMELINE_PROPRIA
  descricao: Visualizar timeline de próprias alterações
  roles_padrao:
  - User
  - Admin
  - Auditor
  - Developer
  - DPO
- codigo: CAD.AUDITORIA.TIMELINE_OUTROS
  descricao: Visualizar timeline de alterações de outros usuários
  roles_padrao:
  - Admin
  - Auditor
  - DPO
- codigo: CAD.AUDITORIA.ROLLBACK
  descricao: Executar rollback de entidades
  roles_padrao:
  - Admin
  - Developer
- codigo: CAD.AUDITORIA.RELATORIOS
  descricao: Gerar relatórios de auditoria
  roles_padrao:
  - Admin
  - Auditor
  - DPO
- codigo: CAD.AUDITORIA.DASHBOARD
  descricao: Visualizar dashboard de auditoria
  roles_padrao:
  - Admin
  - Auditor
  - DPO
- codigo: CAD.AUDITORIA.EXPORTACAO_FORENSE
  descricao: Exportar trilhas com hash forense
  roles_padrao:
  - Admin
  - Auditor
- codigo: CAD.AUDITORIA.CONFIGURACAO
  descricao: Configurar políticas de retenção e arquivamento
  roles_padrao:
  - Admin
- codigo: CAD.AUDITORIA.ALERTAS_SENSIVEIS
  descricao: Visualizar alertas de dados sensíveis (LGPD)
  roles_padrao:
  - Admin
  - DPO
- codigo: CAD.AUDITORIA.VISUALIZAR_VIOLACOES
  descricao: Visualizar tentativas de violação de auditoria
  roles_padrao:
  - Admin
  - Security
integracoes:
  internas:
  - Autenticacao
  - Multi-Tenancy (ClienteId)
  - Auditoria (self-referential controlada)
  - Internacionalizacao (i18n)
  - Permissões RBAC
  - Central de Funcionalidades
  externas:
  - sistema: Azure Sentinel (SIEM)
    tipo: API REST (CEF Format)
    obrigatoria: true
  - sistema: Azure Blob Storage
    tipo: Blob Storage
    obrigatoria: true
seguranca:
  isolamento_tenant: true
  auditoria_obrigatoria: false
  soft_delete: false
  imutabilidade: true
rastreabilidade:
  ucs_esperados:
  - UC00-listar-auditoria
  - UC01-visualizar-auditoria
  - UC02-executar-rollback
  - UC03-gerar-relatorio
  - UC04-dashboard-auditoria
  - UC05-exportar-forense
  - UC06-configurar-retencao
  - UC07-alertas-sensiveis
catalog:
  crud:
  - id: RF096-CRUD-01
    title: Listar timeline de entidade
    required: true
  - id: RF096-CRUD-02
    title: Visualizar detalhes de alteração
    required: true
  - id: RF096-CRUD-03
    title: Executar rollback (Admin/Developer)
    required: true
  - id: RF096-CRUD-04
    title: Gerar relatório de auditoria
    required: true
  - id: RF096-CRUD-05
    title: Dashboard de auditoria
    required: true
  - id: RF096-CRUD-06
    title: Exportação forense
    required: true
  - id: RF096-CRUD-07
    title: Configurar política de retenção
    required: true
  validacoes:
  - id: RF096-VAL-01
    title: Validar imutabilidade de AuditLog (bloqueio UPDATE/DELETE)
    required: true
  - id: RF096-VAL-02
    title: Validar isolamento multi-tenant por ClienteId
    required: true
  - id: RF096-VAL-03
    title: Validar integridade referencial antes de rollback
    required: true
  - id: RF096-VAL-04
    title: Validar latência de captura (< 50ms)
    required: true
  - id: RF096-VAL-05
    title: Validar latência de consulta (< 2s)
    required: true
  seguranca:
  - id: RF096-SEC-01
    title: Isolamento de tenant (ClienteId)
    required: true
  - id: RF096-SEC-02
    title: Permissões RBAC por funcionalidade
    required: true
  - id: RF096-SEC-03
    title: Imutabilidade de registros de auditoria
    required: true
  - id: RF096-SEC-04
    title: Alertas de violação de auditoria
    required: true
  - id: RF096-SEC-05
    title: Hash forense SHA-256 em exportações
    required: true
  - id: RF096-SEC-06
    title: Integração SIEM (Azure Sentinel)
    required: true
  compliance:
  - id: RF096-COMP-01
    title: Conformidade LGPD Art. 5º (rastreabilidade)
    required: true
  - id: RF096-COMP-02
    title: Conformidade LGPD Art. 48 (comunicação de incidentes)
    required: true
  - id: RF096-COMP-03
    title: Conformidade SOX 404 (retenção 7 anos para dados financeiros)
    required: true
  - id: RF096-COMP-04
    title: Retenção mínima 5 anos para dados pessoais (LGPD)
    required: true
  - id: RF096-COMP-05
    title: Alertas automáticos ao DPO para dados sensíveis
    required: true
exclusions:
  rf_items:
  - Auditoria de consultas (SELECT) sem alteração de dados
  - Auditoria de sessões de usuário (login/logout) - RF097
  - Auditoria de permissões e acessos - RF098
  - Auditoria de jobs e processamentos batch - RF099
api_endpoints:
- metodo: GET
  rota: /api/auditoria/timeline/{entityType}/{entityId}
  permissao: CAD.AUDITORIA.TIMELINE_PROPRIA ou CAD.AUDITORIA.TIMELINE_OUTROS
  descricao: Obter timeline de alterações de uma entidade
- metodo: POST
  rota: /api/auditoria/rollback/{auditLogId}
  permissao: CAD.AUDITORIA.ROLLBACK
  descricao: Executar rollback de entidade para versão anterior
- metodo: POST
  rota: /api/auditoria/relatorios
  permissao: CAD.AUDITORIA.RELATORIOS
  descricao: Gerar relatório de auditoria parametrizado
- metodo: GET
  rota: /api/auditoria/dashboard
  permissao: CAD.AUDITORIA.DASHBOARD
  descricao: Obter métricas de auditoria para dashboard
- metodo: POST
  rota: /api/auditoria/exportacao-forense
  permissao: CAD.AUDITORIA.EXPORTACAO_FORENSE
  descricao: Exportar trilha de auditoria com hash forense
- metodo: PUT
  rota: /api/auditoria/configuracao/retencao
  permissao: CAD.AUDITORIA.CONFIGURACAO
  descricao: Configurar política de retenção por tipo de entidade
- metodo: GET
  rota: /api/auditoria/alertas-sensiveis
  permissao: CAD.AUDITORIA.ALERTAS_SENSIVEIS
  descricao: Listar alertas de alterações em dados sensíveis (LGPD)
kpis:
  performance:
  - nome: Latência de captura de auditoria
    meta: < 50ms por operação
    medicao: Média de tempo do AuditInterceptor
  - nome: Latência de consulta de timeline
    meta: < 2s
    medicao: Tempo de resposta do endpoint GET /timeline
  - nome: Taxa de sucesso de envio para SIEM
    meta: '> 99%'
    medicao: '% de eventos enviados com sucesso para Azure Sentinel'
  - nome: Taxa de disponibilidade do módulo
    meta: '> 99.5%'
    medicao: Uptime mensal
  compliance:
  - nome: Cobertura de auditoria
    meta: 100% de entidades críticas
    medicao: '% de entidades com [Audited]'
  - nome: Taxa de auditoria de dados sensíveis
    meta: 100%
    medicao: '% de alterações em CPF/e-mail/telefone auditadas'
  - nome: Conformidade LGPD
    meta: 100%
    medicao: '% de registros com retenção configurada'
  - nome: Conformidade SOX 404
    meta: 100%
    medicao: '% de dados financeiros com retenção de 7 anos'
  seguranca:
  - nome: Tentativas de violação de auditoria
    meta: '0'
    medicao: Total de tentativas de UPDATE/DELETE em AuditLog
  - nome: Alertas de anomalias detectadas
    meta: Monitorar
    medicao: Total de alertas de spikes/horários atípicos
  - nome: Taxa de detecção de fraudes
    meta: Monitorar
    medicao: '% de fraudes detectadas via auditoria'
historico:
- versao: '1.0'
  data: '2025-12-28'
  autor: Agência ALC - alc.dev.br
  descricao: Versão inicial com código C# e referências ao legado misturadas
- versao: '2.0'
  data: '2025-12-31'
  autor: Agência ALC - alc.dev.br
  descricao: Migração para governança v2.0 - Separação RF/RL - Remoção de código C#
    - Conversão de regras para linguagem natural - Conformidade CONTRATO-RF-PARA-RL.md
