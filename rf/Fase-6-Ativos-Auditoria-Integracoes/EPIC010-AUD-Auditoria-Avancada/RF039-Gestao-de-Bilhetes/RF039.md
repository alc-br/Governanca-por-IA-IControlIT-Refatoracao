# RF-039: Gestão de Bilhetes

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC010-AUD-Auditoria-Avancada
**Fase**: Fase 6 - Ativos, Auditoria e Integrações

**RFs Relacionados**: RF022 (Gestão de Fornecedores), RF024 (Gestão de Centros de Custo), RF090 (Medição e Faturamento), SYS-002 (Sistema de Notificações)

---

## 1. OBJETIVO DO REQUISITO

Especificar o módulo de Gestão de Bilhetes Telefônicos do sistema IControlIT, responsável pela administração completa de registros de chamadas telefônicas (call tickets), incluindo importação automatizada de faturas de operadoras, análise de custos, detecção de anomalias, rateio por centro de custo, alertas de uso excessivo, otimização de planos e relatórios gerenciais.

O módulo centraliza o controle de gastos com telefonia fixa, móvel, DDN, DDI, SMS, dados e roaming, identificando oportunidades de redução de custos, fraudes e uso indevido de recursos corporativos.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Importação automatizada de faturas via FTP/API de operadoras
- [x] Upload manual de arquivos (CSV, XLS, PDF)
- [x] Parser inteligente multi-formato (TIM, Vivo, Claro, Oi)
- [x] OCR para extração de dados de PDFs escaneados
- [x] Normalização de números para formato E.164
- [x] Análise de custos e consumo por categoria
- [x] Detecção de anomalias e padrões suspeitos (Machine Learning)
- [x] Alertas automáticos (números premium, roaming, uso excessivo)
- [x] Rateio automático por centro de custo
- [x] Comparação uso real vs plano contratado
- [x] Simulador de planos alternativos
- [x] Relatórios gerenciais (Top 10 consumidores, evolução de custos)
- [x] Dashboard de horário de pico e análise de troncos
- [x] Integração com ERP (SAP, TOTVS, Protheus)
- [x] Política de uso aceitável e compliance
- [x] Multi-tenancy rigoroso (isolamento por ClienteId)
- [x] Auditoria imutável de todas as operações
- [x] Notificações em tempo real (SignalR)

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (responsabilidade do frontend)
- Tecnologia, framework ou linguagem de implementação
- Layout, UX ou identidade visual
- Estratégia de deploy ou infraestrutura
- Integração com PABX/centrais telefônicas (fora do escopo inicial)
- Controle de dispositivos físicos (telefones, headsets)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Bilhete Telefônico** | Registro individual de uma chamada telefônica (call detail record - CDR) contendo data/hora, origem, destino, duração, tipo de chamada e custo. |
| **Parser de Fatura** | Componente que identifica o formato do arquivo de fatura (operadora) e extrai dados estruturados, normalizando campos para o padrão interno. |
| **Formato E.164** | Padrão internacional de numeração telefônica (+5511987654321). Sistema normaliza todos os números para este formato para garantir consistência. |
| **OCR (Optical Character Recognition)** | Tecnologia de reconhecimento de texto em imagens/PDFs escaneados. Usado quando operadora envia fatura sem dados estruturados. |
| **Anomalia** | Padrão de uso anormal detectado por algoritmo de machine learning: ligações excessivas, horários atípicos, loops de chamada, números premium. |
| **Número Premium** | Números telefônicos com tarifa elevada (0900, 0300) geralmente proibidos em uso corporativo. Sistema detecta e alerta automaticamente. |
| **Roaming Internacional** | Uso de telefone móvel fora do país de origem, com tarifas elevadas. Sistema detecta por código do país diferente de +55. |
| **Rateio de Custos** | Distribuição proporcional de gastos de telefonia entre centros de custo/departamentos conforme uso real ou critérios configuráveis. |
| **Franquia de Plano** | Quantidade de minutos/SMS/dados incluídos no plano contratado. Sistema compara uso real vs franquia para identificar desperdício ou excesso. |
| **Horário de Pico** | Período do dia/semana com maior volume de ligações simultâneas. Usado para dimensionamento de troncos e análise de capacidade. |
| **Multi-tenancy** | Cada bilhete é isolado por ClienteId (empresa contratante). Nenhum dado de clientes diferentes pode ser visível. Segregação em database row-level. |
| **Soft Delete** | Bilhetes nunca são deletados fisicamente do banco. Ao excluir, a coluna IsDeleted é marcada como true, preservando auditoria e rastreabilidade. |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Importação Automatizada de Faturas** - Job diário conecta FTP de operadoras e processa arquivos
2. **Upload Manual de Arquivos** - Interface para upload de CSV/XLS/PDF quando FTP indisponível
3. **Detecção de Formato Automática** - Parser identifica operadora e aplica regras de extração
4. **Processamento OCR de PDFs** - Extrai texto de PDFs escaneados com validação de confiança
5. **Normalização de Números** - Converte números para formato E.164 padrão
6. **Análise de Custos por Categoria** - Dashboard de custos (fixo, móvel, DDN, DDI, SMS, dados)
7. **Detecção de Anomalias** - Machine learning identifica padrões suspeitos
8. **Alertas de Números Premium** - Notificação imediata ao detectar 0900/0300
9. **Alertas de Roaming Internacional** - SMS e e-mail ao usuário em roaming
10. **Rateio Automático** - Distribui custos por centro de custo e integra com ERP
11. **Comparação Uso vs Plano** - Identifica sub-uso ou excesso de franquia
12. **Simulador de Planos** - Compara custos com planos alternativos
13. **Relatório Top 10 Consumidores** - Ranking de números com maior custo
14. **Dashboard de Evolução** - Gráfico de tendência de custos (6/12/24 meses)
15. **Análise de Horário de Pico** - Heatmap de ligações simultâneas
16. **Política de Uso Aceitável** - Score de conformidade e auditoria de violações
17. **Exportação para ERP** - Lançamentos contábeis automáticos via API

---

## 5. REGRAS DE NEGÓCIO

### RN-BIL-039-01 — Importação Automatizada via FTP

**Descrição**: O sistema conecta automaticamente aos servidores FTP das operadoras de telecomunicações através de job agendado diário (03:00 UTC), realiza download de faturas mensais e processa os dados de forma assíncrona. Credenciais FTP são armazenadas criptografadas no banco e arquivos originais são preservados em blob storage por 7 anos.

**Justificativa**: Eliminar trabalho manual de download e upload de arquivos, garantir pontualidade e completude dos dados de billing, e reduzir erros humanos no processo de importação.

**Critério de Aceite**:
- Job Hangfire executa diariamente às 03:00 UTC sem falhas
- Credenciais FTP armazenadas com criptografia AES-256
- Arquivo baixado validado com checksum MD5 antes do processamento
- Processamento falho gera alerta para equipe de TI via SignalR e e-mail
- Backup do arquivo original em blob storage com retenção de 7 anos
- Registro de auditoria completo (timestamp, operadora, arquivo, quantidade de registros)
- Suporte simultâneo a múltiplas operadoras (TIM, Vivo, Claro, Oi)

**Exemplos**:
- ✅ Job executa às 03:00, conecta ftp.tim.com.br, baixa fatura_janeiro_2025.csv (5.2 MB), valida MD5, processa 12.458 chamadas
- ❌ Job falha: FTP timeout após 30s → Alerta enviado, retry em 1 hora

---

### RN-BIL-039-02 — Parser Inteligente Multi-Formato

**Descrição**: O sistema analisa automaticamente as primeiras 10 linhas do arquivo de fatura, identifica padrões de cabeçalho característicos de cada operadora (TIM, Vivo, Claro, Oi) e aplica o parser específico com regras de normalização. Se formato não reconhecido, tenta parser genérico baseado em heurísticas.

**Justificativa**: Cada operadora possui formato de fatura diferente (estrutura de colunas, separadores, codificações). Parser inteligente elimina necessidade de configuração manual e adapta-se a pequenas mudanças de layout.

**Critério de Aceite**:
- Sistema identifica operadora com 95% de precisão em arquivos padronizados
- Suporte a formatos: CSV (delimitadores: vírgula, ponto-e-vírgula, TAB), XLS/XLSX
- Mapeamento de colunas (data, hora, origem, destino, duração, custo) realizado automaticamente
- Formato não reconhecido → Tentar parser genérico → Se falhar, registrar erro e solicitar intervenção manual
- Registro de formato detectado e mapeamento aplicado em auditoria

**Exemplos**:
- ✅ Arquivo Vivo: Detecta cabeçalho "VIVO EMPRESAS - FATURA DETALHADA", aplica VivoEmpresasCSVParser
- ✅ Arquivo TIM: Detecta "TIM BRASIL S.A. - DETALHAMENTO DE CHAMADAS", aplica TimBrasilCSVParser
- ❌ Formato desconhecido: Tenta parser genérico → Falha → Alerta para configuração manual

---

### RN-BIL-039-03 — Normalização de Números para E.164

**Descrição**: Todos os números telefônicos (origem e destino) são normalizados para o formato internacional E.164 (+55 11 98765-4321) removendo caracteres especiais, identificando código do país (assume +55 se omitido), validando DDD conforme tabela ANATEL e formatando com padrão unificado.

**Justificativa**: Garantir consistência para comparações, relatórios, integração com PABX/troncos e evitar duplicidade por diferenças de formatação.

**Critério de Aceite**:
- Remove caracteres especiais (parênteses, hífens, espaços)
- Identifica código do país (se ausente, assume +55 Brasil)
- Valida DDD conforme lista ANATEL (11-99)
- Valida quantidade de dígitos: móvel = 9, fixo = 8, 0800 = 7
- Formato final: +55XXYYYYYYYY (Ex: +5511987654321)
- Números inválidos → Registro marcado como "Erro de Normalização" e não incluído em relatórios

**Exemplos**:
- ✅ "(11) 98765-4321" → +5511987654321
- ✅ "11 98765-4321" → +5511987654321
- ✅ "5511987654321" → +5511987654321
- ✅ "0800 123 4567" → +558001234567
- ❌ "98765" (número incompleto) → Erro de normalização

---

### RN-BIL-039-04 — Detecção de Ligações para Números Premium

**Descrição**: Ao importar bilhete, o sistema verifica se número destino inicia com 0900 ou 0300 (números premium). Se detectado, marca registro como "Premium", cria alerta de compliance, envia notificação para supervisor do usuário e gestor de TI via SignalR e e-mail, e registra na auditoria para análise posterior. Justificativa obrigatória em 48h.

**Justificativa**: Números premium têm custo elevado (R$ 5-10/min) e geralmente não são permitidos em uso corporativo. Detecção automática permite controle proativo e conformidade com política de uso aceitável.

**Critério de Aceite**:
- Número destino inicia com 0900 ou 0300 → Flag Premium = true
- Custo por minuto > R$ 5,00 → Alerta de custo elevado
- Notificação SignalR em tempo real no dashboard do gestor
- E-mail enviado para supervisor do usuário e gestor de TI
- Registro em auditoria com código BIL_NUMERO_PREMIUM_DETECTADO
- Justificativa obrigatória pelo usuário em até 48h (workflow)
- Relatório mensal consolidado de uso de números premium

**Exemplos**:
- ✅ Detectado: +55113001234567 (0300 Premium), Custo: R$ 87,50 (12 min), Alerta gerado e enviado
- ✅ Justificativa fornecida em 24h → Aprovada → Alerta fechado
- ❌ Sem justificativa após 48h → Escalado para Compliance

---

### RN-BIL-039-05 — Alerta de Roaming Internacional

**Descrição**: O sistema detecta roaming internacional quando código do país do número origem é diferente de +55 (Brasil). Ao detectar, envia SMS imediato para o número em roaming alertando sobre custos elevados, envia e-mail para gestor com detalhes (país, custo estimado/dia) e monitora custo acumulado. Se custo > R$ 500, envia alerta crítico. Se custo > R$ 2.000, pode bloquear linha (configurável).

**Justificativa**: Roaming internacional tem custo elevado (R$ 10-20/min voz, R$ 0,50-2/MB dados). Alerta preventivo em tempo real evita surpresas na fatura e permite controle proativo.

**Critério de Aceite**:
- Código do país diferente de +55 → Roaming detectado
- SMS enviado imediatamente para o número em roaming (via gateway SMS)
- E-mail enviado para gestor com país, custo estimado/dia, recomendações
- Monitoramento de custo acumulado em tempo real
- Alerta crítico se custo acumulado > R$ 500
- Bloqueio automático (configurável) se custo > R$ 2.000
- Registro de auditoria com código BIL_ROAMING_INTERNACIONAL_DETECTADO

**Exemplos**:
- ✅ Detectado: +5511987654321 em roaming nos EUA (+1), SMS enviado: "ALERTA ROAMING: R$ 15/min voz..."
- ✅ Custo acumulado R$ 550 → Alerta crítico enviado ao gestor
- ❌ Custo R$ 2.100 → Linha bloqueada automaticamente (se configurado)

---

### RN-BIL-039-06 — Rateio Automático por Centro de Custo

**Descrição**: Custos de telefonia são rateados automaticamente entre centros de custo com base no vínculo do usuário/ramal configurado no cadastro. Ao importar bilhete, sistema identifica centro de custo do número origem, totaliza custos por CC, gera lançamento contábil automático (integração ERP) e rateia custos compartilhados (trunk, assinatura mensal) proporcionalmente ao uso.

**Justificativa**: Permitir visibilidade precisa de custos por departamento, facilitar análise gerencial, garantir rastreabilidade contábil e automatizar processo de rateio que era manual.

**Critério de Aceite**:
- Cada número/ramal vinculado obrigatoriamente a um centro de custo
- Ao importar bilhete, sistema identifica CC do número origem via FK
- Totalização de custos por CC (variável + proporcional de custos fixos)
- Custos compartilhados (trunk, assinatura) rateados proporcionalmente ao uso (minutos)
- Soma dos rateios = 100% do total da fatura (validação matemática)
- Geração de lançamento contábil automático via API do ERP
- Registro de auditoria com código BIL_RATEIO_GERADO

**Exemplos**:
- ✅ Fatura R$ 15.000: CC-001 (Vendas) = R$ 5.000 (33%), CC-002 (Marketing) = R$ 3.500 (23%), Total = 100%
- ❌ Número sem CC vinculado → Erro de validação, importação bloqueada

---

### RN-BIL-039-07 — Comparação Uso Real vs Plano Contratado

**Descrição**: O sistema compara mensalmente o uso real de cada linha (minutos, SMS, dados) com a franquia do plano contratado, classifica uso (sub-uso < 50%, adequado 50-90%, excesso > 100%), calcula custos extras e recomenda upgrade/downgrade de plano quando economia potencial > R$ 50/mês.

**Justificativa**: Evitar desperdício com planos superdimensionados (sub-uso) ou custos extras elevados por subdimensionamento (excesso). Otimização baseada em dados reais.

**Critério de Aceite**:
- Cadastro de planos contratados (franquia de minutos, SMS, dados)
- Comparação mensal: uso real vs franquia (percentual de consumo)
- Classificação: Sub-uso (<50%), Adequado (50-90%), Excesso (>100%)
- Cálculo de custo total (plano + extras)
- Recomendação de mudança se economia > R$ 50/mês
- Simulação de economia anual projetada
- Notificação ao gestor com recomendações

**Exemplos**:
- ✅ Uso 2.450 min, Franquia 2.000 min → Excesso 22%, Custo extra R$ 360, Recomendação: Upgrade para plano 3.000 min (Economia R$ 300/mês)
- ✅ Uso 800 min, Franquia 2.000 min → Sub-uso 40%, Recomendação: Downgrade para plano 1.000 min (Economia R$ 150/mês)

---

### RN-BIL-039-08 — Detecção de Padrão de Uso Suspeito

**Descrição**: Algoritmo de machine learning analisa histórico de 90 dias de cada número, identifica anomalias (muitas ligações curtas < 10s, horários atípicos 00:00-06:00, aumento súbito > 300% da média, destinos incomuns), calcula score de risco (0-100) e gera alerta de comportamento suspeito se score > 70. Bloqueio automático se score > 90.

**Justificativa**: Detectar fraudes, uso indevido, problemas técnicos (loops de chamada, falhas de PABX) e proteger empresa de custos indevidos.

**Critério de Aceite**:
- Histórico mínimo de 30 dias para baseline
- Anomalias detectadas: ligações curtas, horários atípicos, volume anormal, destinos incomuns
- Score de risco calculado por algoritmo treinado (0-100)
- Alerta gerado se score > 70 (ALTO) ou > 90 (CRÍTICO)
- Bloqueio automático de linha se score > 90 (preventivo)
- Notificação SignalR + e-mail para gestor de TI e usuário
- Diagnóstico automático do tipo de anomalia (loop, fraude, uso indevido)
- Registro de auditoria com código BIL_ANOMALIA_DETECTADA

**Exemplos**:
- ✅ Detectado: 250 ligações em 2h (1.666% acima da média), duração 8s cada, mesmo destino → Score 95 → Linha bloqueada automaticamente
- ✅ Diagnóstico: "Possível loop de chamada - PABX com falha"

---

### RN-BIL-039-09 — Relatório Top 10 Maiores Consumidores

**Descrição**: Relatório mensal identifica os 10 números que mais geram custo (não apenas minutos), exibe usuário/departamento, total de ligações/minutos, custo total, principais destinos, comparação com mês anterior (% variação) e permite drill-down para detalhamento completo.

**Justificativa**: Focar atenção gerencial nos maiores geradores de custo para otimização direcionada e identificação de desperdícios ou uso indevido.

**Critério de Aceite**:
- Ordenação decrescente por custo total mensal (não por minutos)
- Top 10 exibidos com: usuário/departamento, ligações, minutos, custo, principais destinos
- Comparação com mês anterior (% variação de custo)
- Drill-down disponível para todos os top 10 (detalhamento de chamadas)
- Exportação para Excel/PDF
- Notificação automática ao gestor quando variação > 50%

**Exemplos**:
- ✅ #1: João Silva (Vendas) - R$ 1.850 (12% do total), Variação: +15% vs mês anterior
- ✅ #10: Carlos Lima (TI) - R$ 680 (5% do total), Variação: +120% → Alerta de investigação

---

### RN-BIL-039-10 — Simulador de Planos Alternativos

**Descrição**: Ferramenta que simula custos com planos alternativos de todas as operadoras (cadastradas no sistema) com base no uso real dos últimos 3 meses, calcula custo projetado com cada plano, ranqueia os 5 planos mais econômicos e projeta economia anual. Recomendação só é feita se economia > R$ 50/mês.

**Justificativa**: Permitir tomada de decisão embasada sobre troca de planos ou operadoras com base em análise quantitativa de uso real.

**Critério de Aceite**:
- Cadastro de planos disponíveis (todas as operadoras)
- Uso médio calculado dos últimos 3 meses (minutos, SMS, dados)
- Simulação de custo com cada plano alternativo (base + extras)
- Ranking dos 5 planos mais econômicos (custo projetado crescente)
- Cálculo de economia anual projetada
- Recomendação só se economia > R$ 50/mês
- Exportação de simulação para PDF/Excel

**Exemplos**:
- ✅ Uso médio: 2.200 min, 50 SMS, 4 GB → Plano atual: R$ 400/mês → Melhor opção: TIM Black 3000 (R$ 180/mês) → Economia: R$ 2.640/ano
- ❌ Melhor opção economiza R$ 30/mês → Não recomenda (economia < R$ 50)

---

### RN-BIL-039-11 — Exportação para ERP

**Descrição**: Sistema exporta automaticamente lançamentos de custo de telefonia para integração com ERP corporativo (SAP, TOTVS, Protheus) via API REST. Geração de arquivo de integração (TXT, XML, JSON), mapeamento de centros de custo para contas contábeis, validação de lançamento no ERP, retry automático em caso de falha (3 tentativas) e notificação de erro para equipe contábil.

**Justificativa**: Automatizar processo contábil, eliminar digitação manual de lançamentos, reduzir erros e garantir rastreabilidade financeira.

**Critério de Aceite**:
- Integração via API REST (SAP, TOTVS, Protheus)
- Mapeamento de centros de custo para contas contábeis (configurável)
- Lançamento gerado com: centro de custo, conta contábil, valor, histórico, documento
- Validação de sucesso no ERP (status code 200)
- Retry automático em caso de falha (3 tentativas com backoff exponencial)
- Notificação de erro para equipe contábil via e-mail
- Registro de auditoria com código BIL_EXPORTACAO_ERP

**Exemplos**:
- ✅ CC-001 (Vendas) → Conta 5.1.2.001, Valor R$ 5.000, Histórico "Despesas telefonia Jan/2025" → Enviado ao SAP → Confirmado
- ❌ Falha de conexão → Retry em 1 min → Retry em 5 min → Retry em 15 min → Erro enviado ao contábil

---

### RN-BIL-039-12 — Análise de Horário de Pico

**Descrição**: Sistema agrupa ligações por dia da semana e hora, gera heatmap visual de volume de ligações simultâneas, identifica top 5 horários de pico, compara capacidade atual de troncos vs necessária e recomenda ajuste se taxa de congestionamento > 10%.

**Justificativa**: Otimizar quantidade de troncos contratados para evitar congestionamento em horários de pico e garantir qualidade de serviço.

**Critério de Aceite**:
- Agrupamento de ligações por dia da semana (Seg-Sex) e hora (08h-18h)
- Cálculo de ligações simultâneas com precisão de 1 minuto
- Geração de heatmap visual (dashboard)
- Identificação de top 5 horários de pico
- Comparação capacidade atual vs pico máximo registrado
- Taxa de congestionamento = (pico - capacidade) / capacidade
- Recomendação de ajuste se congestionamento > 10%
- Análise requer mínimo 30 dias de dados históricos

**Exemplos**:
- ✅ Pico: Quinta 15h = 38 ligações simultâneas, Capacidade: 30 troncos → Congestionamento 27% → Recomenda aumentar para 40 troncos
- ✅ Pico: 25 ligações, Capacidade: 30 → Congestionamento 0% → Mantém capacidade atual

---

### RN-BIL-039-13 — Processamento OCR de PDFs

**Descrição**: Sistema processa faturas em formato PDF escaneado usando OCR (Azure Cognitive Services ou Tesseract), extrai texto página por página, aplica regex para identificar padrões (data, hora, número, valor), valida dados extraídos (consistência, completude) e solicita revisão manual se confiança < 90%.

**Justificativa**: Algumas operadoras ainda enviam faturas em PDF sem dados estruturados. OCR elimina digitação manual e permite automação mesmo com documentos escaneados.

**Critério de Aceite**:
- Suporte a PDFs escaneados (imagens) e nativos (texto)
- Motor OCR: Azure Cognitive Services ou Tesseract
- Extração de campos: data, hora, número origem/destino, duração, valor
- Validação de confiança mínima: 90% por campo
- Registros com confiança 70-90% → Revisão manual via interface web
- Registros com confiança < 70% → Descartados
- Confiança média mínima de 85% para aprovar lote
- Registro de auditoria com código BIL_OCR_PROCESSADO

**Exemplos**:
- ✅ PDF 10 páginas → 1.234 registros extraídos → 1.180 confiança >90% (aprovados), 54 confiança 70-90% (revisão)
- ❌ Confiança média 78% → Lote rejeitado, solicita arquivo em formato estruturado

---

### RN-BIL-039-14 — Dashboard de Evolução de Custos

**Descrição**: Dashboard gráfico exibe evolução dos custos de telefonia ao longo do tempo (6, 12 ou 24 meses) com análise de tendências, segmentação por categoria (fixo, móvel, DDN, DDI, dados), linha de tendência (regressão linear), projeção de custo para próximos 3 meses e comparação com orçamento aprovado.

**Justificativa**: Identificar padrões sazonais, tendências de crescimento/redução de custos e subsidiar planejamento orçamentário.

**Critério de Aceite**:
- Gráfico de linha com custos mensais (6, 12 ou 24 meses)
- Segmentação por categoria: Fixo, Móvel, DDN, DDI, SMS, Dados
- Linha de tendência calculada por regressão linear
- Projeção de custo para próximos 3 meses (limitada a 6 meses)
- Comparação com orçamento aprovado (% variação)
- Identificação de drivers de crescimento (categorias com maior aumento)
- Exportação de gráfico para PDF/PNG

**Exemplos**:
- ✅ Tendência: Crescimento de R$ 1.000/mês (8%/mês), Driver principal: Móvel (+100% em 12 meses), DDI (+500%)
- ✅ Projeção Fev/2025: R$ 26.000, Orçamento: R$ 20.000 → Variação: +30% acima do orçado

---

### RN-BIL-039-15 — Política de Uso Aceitável e Compliance

**Descrição**: Sistema audita uso de telefonia corporativa versus política de uso aceitável configurável (proibições, restrições, permissões), identifica violações (números premium, roaming não autorizado, uso pessoal excessivo), calcula score de conformidade (0-100) por usuário e gera relatório de violações para RH/gestores.

**Justificativa**: Garantir que recursos corporativos sejam usados adequadamente, identificar uso pessoal excessivo e aplicar políticas de compliance.

**Critério de Aceite**:
- Cadastro de política de uso aceitável (proibições, restrições, permissões)
- Monitoramento automático de compliance
- Classificação de violações: CRÍTICA, MÉDIA, BAIXA
- Score de conformidade (0-100) calculado mensalmente
- Violações críticas requerem justificativa em 72h
- Relatório mensal de violações para RH/gestores
- Registro de auditoria com código BIL_COMPLIANCE_VIOLACAO

**Exemplos de Política**:
- ❌ PROIBIDO: Números premium (0900/0300), roaming sem autorização, uso excessivo após 20h (>1h/dia)
- ⚠️ RESTRITO: Ligações pessoais (máx 30 min/mês), SMS pessoais (máx 20/mês)
- ✅ PERMITIDO: Uso corporativo sem restrições

**Exemplos de Violação**:
- ✅ Detectado: 1 ligação 0300 (CRÍTICA) + uso pessoal 45 min (MÉDIA) → Score: 65/100 → Notificação ao usuário e gestor

---

## 6. ESTADOS DA ENTIDADE

### Estados de Bilhete

| Estado | Descrição |
|--------|-----------|
| **Importado** | Bilhete importado e validado com sucesso |
| **Erro_Normalizacao** | Número de telefone inválido (não normalizável para E.164) |
| **Anomalia_Detectada** | Padrão de uso suspeito identificado (score > 70) |
| **Premium_Detectado** | Ligação para número premium (0900/0300) |
| **Roaming_Detectado** | Roaming internacional ativo |
| **Auditado** | Bilhete incluído em relatório de compliance |
| **Rateado** | Custo rateado e exportado para ERP |
| **Deleted** | Soft delete (IsDeleted = true) |

### Transições Permitidas

| De | Para | Ação |
|----|------|------|
| Importado | Anomalia_Detectada | Sistema detecta padrão suspeito |
| Importado | Premium_Detectado | Sistema detecta número 0900/0300 |
| Importado | Roaming_Detectado | Sistema detecta código país ≠ +55 |
| Importado | Rateado | Job de rateio mensal executado |
| Qualquer | Deleted | Administrador solicita exclusão |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre | Ações Automáticas |
|--------|---------------|-------------------|
| `BilheteImportado` | Após importação bem-sucedida | Normalização, validações, auditoria |
| `AnomaliaDetectada` | Score de risco > 70 | Alerta SignalR + e-mail, auditoria |
| `PremiumDetectado` | Número destino 0900/0300 | Alerta gestor, auditoria compliance |
| `RoamingDetectado` | Código país ≠ +55 | SMS usuário + e-mail gestor |
| `RateioGerado` | Job mensal executado | Exportação ERP, auditoria contábil |
| `PlanoOtimizado` | Uso vs plano analisado | Recomendação de mudança, notificação gestor |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant (ClienteId)
- Nenhuma regra de negócio pode ser ignorada
- Bilhetes nunca são deletados fisicamente (soft delete obrigatório)
- Importações falhas não podem bloquear sistema (resiliência)
- Alertas devem ser enviados em tempo real (latência < 30s)
- Rateios devem somar 100% do total da fatura (validação matemática)
- OCR com confiança < 85% requer revisão manual
- Auditoria completa de todas as operações (7 anos de retenção)

---

## 9. SEGURANÇA

### Validações de Entrada

- Arquivos de fatura limitados a 100 MB
- Formatos permitidos: CSV, XLS, XLSX, PDF
- Validação de checksums (MD5) para integridade
- Sanitização de nomes de arquivo (prevenção path traversal)
- Validação de encoding (UTF-8, ISO-8859-1)

### Proteções Implementadas

- Proteção contra injeção SQL (EF Core parametrizado)
- Proteção contra XSS em relatórios (sanitização HTML)
- Rate limiting em APIs de importação (max 10 requisições/min por tenant)
- Isolamento multi-tenant (ClienteId em todas as queries)
- Credenciais FTP criptografadas (AES-256)

### Controle de Permissões

- Apenas roles autorizadas podem importar faturas
- Apenas gestor pode bloquear linhas por uso indevido
- Apenas financeiro pode gerar rateios e exportar para ERP
- Logs de acesso completos (quem acessou qual bilhete quando)

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF039.md** - Casos de Uso (importação, análise, alertas, relatórios)
- **MD-RF039.md** - Modelo de Dados (tabelas: Bilhete, FaturaImportacao, Anomalia, Rateio)
- **WF-RF039.md** - Workflows (importação FTP, detecção de anomalias, rateio mensal)
- **TC-RF039.yaml** - Casos de Teste (validação de parsers, alertas, rateios)
- **MT-RF039.yaml** - Massas de Teste (bilhetes simulados de múltiplas operadoras)

---

## 11. RASTREABILIDADE

| Artefato | Status |
|----------|--------|
| Casos de Uso | ✅ Criados (UC-RF039.md) |
| Modelo de Dados | ✅ Criado (MD-RF039.md) |
| Workflows | ✅ Criado (WF-RF039.md) |
| Casos de Teste | ⏳ Pendente |
| Massas de Teste | ⏳ Pendente |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0 (separação RF/RL completa) | Agência ALC - alc.dev.br |
| 1.0 | 2025-01-14 | Versão inicial com conteúdo legado misturado | Architect Agent |
