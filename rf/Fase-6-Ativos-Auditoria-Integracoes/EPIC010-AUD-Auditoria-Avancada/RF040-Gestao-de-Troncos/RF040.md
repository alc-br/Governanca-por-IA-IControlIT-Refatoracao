# RF040 - Gestão de Troncos Telefônicos

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC010-AUD - Auditoria Avançada
**Fase**: Fase 6 - Ativos, Auditoria e Integrações

---

## 1. OBJETIVO DO REQUISITO

Implementar sistema completo de gerenciamento de troncos telefônicos (SIP, E1/R2, analógicos), incluindo monitoramento de disponibilidade em tempo real, análise de capacidade versus utilização, detecção automática de falhas, balanceamento de carga, custeio detalhado por tronco, integração com PABX/gateways e relatórios de QoS (Quality of Service).

O sistema deve otimizar recursos de telefonia, garantir alta disponibilidade (99,9% uptime SLA), reduzir custos operacionais e melhorar a experiência do usuário final por meio de monitoramento proativo e automação de failover.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Cadastro e configuração de troncos telefônicos (SIP, E1/R2, analógicos)
- [x] Monitoramento contínuo de status em tempo real (polling 30 segundos)
- [x] Coleta e cálculo de métricas de QoS (jitter, latência, packet loss, MOS score)
- [x] Detecção automática de falhas e degradação de qualidade
- [x] Failover automático para troncos backup (<5 segundos)
- [x] Balanceamento de carga com algoritmo Least Call Count
- [x] Análise de capacidade versus utilização mensal
- [x] Custeio detalhado por tronco com rateio por centro de custo
- [x] Integração com PABX via API REST e SNMP
- [x] Dashboard de QoS em tempo real com gráficos históricos
- [x] Relatórios de disponibilidade (% uptime) e métricas MTBF/MTTR
- [x] Simulador de economia para migração SIP versus E1
- [x] Detecção de loops e chamadas anômalas
- [x] Análise comparativa de TCO por tecnologia (E1, SIP, analógico)
- [x] Integração com gestão de bilhetes telefônicos (RF039)
- [x] Sistema de alertas escalonados (SMS, e-mail, push, chamada)
- [x] Controle de acesso granular e isolamento multi-tenant
- [x] Auditoria completa de falhas, failovers e alterações de configuração

### 2.2 Fora do escopo (não objetivos)

- Interface de configuração de PABX (gerenciado externamente)
- Gravação de chamadas (escopo de RF039)
- Tarifação de chamadas (escopo de RF039)
- Interface visual específica (definida por WF-RF040)
- Tecnologia, framework ou linguagem (decisão de implementação)
- Layout, UX ou identidade visual (definido em WF-RF040)
- Estratégia de deploy ou infraestrutura

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Tronco** | Linha telefônica física ou virtual que conecta o PABX à rede pública ou operadora |
| **SIP** | Protocol de Iniciação de Sessões - protocolo de sinalização VoIP |
| **E1/R2** | Padrão de sinalização digital de telefonia com 30 canais |
| **MOS Score** | Mean Opinion Score - métrica de qualidade de voz (1.0-5.0) |
| **Jitter** | Variação de latência em ms (<30ms ideal, <50ms aceitável) |
| **Latência** | Tempo de resposta round-trip em ms (<150ms ideal, <300ms aceitável) |
| **Packet Loss** | Percentual de pacotes perdidos (<1% ideal, <3% aceitável) |
| **Failover** | Processo de transferência automática para tronco backup em caso de falha |
| **MTBF** | Mean Time Between Failures - tempo médio entre falhas consecutivas |
| **MTTR** | Mean Time To Repair - tempo médio para restauração após falha |
| **TCO** | Total Cost of Ownership - custo total ao longo de 3 anos |
| **QoS** | Quality of Service - métricas de qualidade do serviço de telefonia |
| **Tenant** | Unidade lógica de isolamento de dados (empresa/Fornecedor) |

---

## 4. FUNCIONALIDADES COBERTAS

1. Cadastro e configuração de troncos telefônicos
2. Monitoramento contínuo de status e disponibilidade
3. Coleta e análise de métricas de QoS
4. Detecção automática de falhas
5. Failover automático para troncos backup
6. Balanceamento de carga entre troncos
7. Análise de capacidade versus utilização
8. Custeio detalhado por tronco e centro de custo
9. Integração com PABX (API REST, SNMP)
10. Dashboard de QoS em tempo real
11. Relatórios gerenciais (disponibilidade, MTBF/MTTR)
12. Simulador de economia (migração SIP vs E1)
13. Detecção de loops e chamadas anômalas
14. Análise comparativa de TCO por tecnologia
15. Integração com gestão de bilhetes telefônicos

---

## 5. REGRAS DE NEGÓCIO

### RN-RF040-01 — Monitoramento Contínuo com Polling a Cada 30 Segundos

**Descrição**: O sistema verifica o status de cada tronco a cada 30 segundos usando protocolos apropriados (SIP OPTIONS para troncos SIP, SNMP GET para troncos E1, API REST para gateways VoIP).

**Justificativa**: Detectar falhas rapidamente com SLA de detecção inferior a 1 minuto e tomar ações corretivas antes que usuários sejam impactados.

**Critério de Aceite**:
- Polling executado a cada 30 segundos para cada tronco ativo
- Timeout máximo de 5 segundos por tentativa de verificação
- 3 falhas consecutivas resultam em marcação do tronco como "down"
- Alerta dispara imediatamente ao marcar tronco como "down"
- Status atualizado no banco de dados após cada verificação

---

### RN-RF040-02 — Cálculo Automático de MOS Score (E-Model ITU-T G.107)

**Descrição**: Sistema calcula automaticamente o MOS score de cada tronco com base em jitter, latência e packet loss usando algoritmo E-Model (ITU-T G.107).

**Justificativa**: MOS é a métrica padrão da indústria para qualidade de voz, permitindo comparação objetiva entre troncos e identificação de degradação.

**Critério de Aceite**:
- MOS calculado apenas se todas as 3 métricas (jitter, latência, packet loss) estiverem disponíveis
- Classificação de qualidade: 4.0-5.0 Excelente, 3.0-4.0 Bom, 2.0-3.0 Regular (gera alerta), 1.0-2.0 Ruim (failover automático)
- Se MOS <2.0 por 3 medições consecutivas, aciona failover automático
- Histórico de MOS armazenado para análise de tendências (90 dias)

---

### RN-RF040-03 — Failover Automático em Menos de 5 Segundos

**Descrição**: Quando um tronco falha (3 tentativas consecutivas sem resposta), o sistema redireciona automaticamente as chamadas para tronco backup em menos de 5 segundos.

**Justificativa**: Garantir alta disponibilidade e minimizar impacto ao usuário final com SLA de failover inferior a 10 segundos.

**Critério de Aceite**:
- Failover só ocorre após 3 falhas consecutivas (90 segundos)
- Tronco backup deve estar disponível (status "up")
- Tempo total de failover inferior a 5 segundos
- Notificações enviadas simultaneamente (SMS, e-mail, push, chamada)
- Roteamento atualizado no PABX via API
- Retorno gradual ao tronco primário após recuperação (10% a cada minuto durante 10 minutos)
- Aguardar 5 minutos de estabilidade antes de iniciar retorno gradual

---

### RN-RF040-04 — Balanceamento de Carga com Algoritmo Least Call Count

**Descrição**: Novas chamadas são distribuídas para o tronco com menor número de chamadas ativas no momento, evitando sobrecarga.

**Justificativa**: Maximizar utilização uniforme de recursos e evitar congestionamento em troncos individuais.

**Critério de Aceite**:
- Apenas troncos com status "up" são considerados
- Ordenação por quantidade de chamadas ativas (crescente)
- Seleção do tronco com menor carga
- Em caso de empate, preferência por tronco com melhor MOS score
- Se todos os troncos estiverem em 100% utilização, chamada vai para fila de espera

---

### RN-RF040-05 — Alerta de Congestionamento (Utilização >80% por >5 Minutos)

**Descrição**: Sistema detecta congestionamento quando um tronco opera acima de 80% de utilização por mais de 5 minutos consecutivos.

**Justificativa**: Permitir ação proativa antes que chamadas comecem a ser rejeitadas (100% utilização).

**Critério de Aceite**:
- Alerta dispara somente se utilização >80% por >5 minutos CONSECUTIVOS
- Se utilização voltar a <80%, contador é zerado
- Máximo 1 alerta por hora por tronco (evitar spam)
- Notificações enviadas para equipe TI
- Sugestões automáticas de ações corretivas (redistribuir carga, ativar tronco de contingência, contratar burst)
- Redistribuição automática de 50% das novas chamadas para tronco disponível

---

### RN-RF040-06 — Análise de Capacidade Versus Utilização Mensal

**Descrição**: Relatório mensal compara capacidade contratada versus utilização real e identifica oportunidades de otimização.

**Justificativa**: Evitar desperdício com troncos ociosos (subutilização <30%) ou custos extras por congestionamento frequente (utilização >80%).

**Critério de Aceite**:
- Análise requer mínimo 30 dias completos de dados
- Classificação: Ocioso (<30%), Adequado (30-80%), Congestionado (>80%)
- Recomendação de ajuste só se economia projetada >R$ 200/mês
- Considerar sazonalidade (dezembro tem mais chamadas que janeiro)
- Exportação de relatório em PDF e Excel

---

### RN-RF040-07 — Custeio Detalhado por Tronco com Rateio por Centro de Custo

**Descrição**: Sistema calcula custo total de cada tronco (fixo + variável) e rateia entre centros de custo com base no uso real (minutos).

**Justificativa**: Permitir visibilidade precisa de custos de telefonia e facilitar análise gerencial e contábil.

**Critério de Aceite**:
- Custo fixo: Assinatura mensal do tronco
- Custo variável: Custo por minuto de chamada
- Soma dos rateios deve ser 100% do total
- Custos fixos rateados proporcionalmente ao uso
- Integração com ERP validada (confirmação de lançamento contábil)
- Exportação para sistemas financeiros (SAP, TOTVS)

---

### RN-RF040-08 — Métricas MTBF e MTTR para Análise de Confiabilidade

**Descrição**: Sistema calcula MTBF (Mean Time Between Failures) e MTTR (Mean Time To Repair) de cada tronco para análise de confiabilidade.

**Justificativa**: Identificar troncos problemáticos e avaliar qualidade do serviço de operadoras com base em dados objetivos.

**Critério de Aceite**:
- MTBF calculado apenas se houver 2+ falhas no período de 12 meses
- Falhas com duração <5 minutos não são contabilizadas (consideradas "blips")
- Disponibilidade mínima aceitável: 99,5% (SLA padrão ANATEL)
- Benchmark: MTBF ideal >720 horas (30 dias), MTTR ideal <1 hora
- Classificação de confiabilidade (A: excelente, B: bom, C: regular, D: ruim, F: crítico)

---

### RN-RF040-09 — Relatório de Disponibilidade Mensal com Comparação SLA

**Descrição**: Relatório mensal exibe o percentual de disponibilidade de cada tronco e compara com SLA contratado (tipicamente 99,9%).

**Justificativa**: Monitorar compliance com SLA e identificar operadoras com desempenho abaixo do esperado para renegociação ou penalização.

**Critério de Aceite**:
- Cálculo: Uptime % = (Total de Minutos - Minutos Indisponíveis) / Total de Minutos × 100
- SLA típico: 99,9% (permite 43 minutos de downtime por mês)
- Downtime programado (manutenção) pode ser excluído do cálculo se notificação prévia >48h
- Crédito aplicado automaticamente se downtime exceder SLA (10-25% da mensalidade conforme gravidade)
- Relatório enviado automaticamente no dia 5 de cada mês

---

### RN-RF040-10 — Integração com PABX via API REST e SNMP

**Descrição**: Sistema integra com PABX (Asterisk, FreePBX, Elastix, 3CX) via API REST e SNMP para controle de roteamento e coleta de métricas.

**Justificativa**: Permitir controle centralizado de troncos e automação de failover/balanceamento sem intervenção manual.

**Critério de Aceite**:
- API deve responder em <500ms
- Mudanças de roteamento aplicadas em <5 segundos
- SNMP timeout: 3 segundos
- Suporte a múltiplos modelos de PABX (Asterisk/FreePBX AMI, 3CX Management API, Elastix REST API)
- Autenticação: API Key + IP Whitelist

---

### RN-RF040-11 — Dashboard de QoS em Tempo Real com Atualização Automática

**Descrição**: Dashboard visual exibe métricas de QoS (jitter, latência, packet loss, MOS) em tempo real e gráficos históricos (6h, 24h, 7d, 30d).

**Justificativa**: Permitir monitoramento proativo da qualidade de voz e identificação rápida de degradações.

**Critério de Aceite**:
- Dashboard atualizado a cada 30 segundos via SignalR
- Histórico armazenado por 90 dias
- Gráficos otimizados (agregação de dados para períodos >7 dias)
- Indicadores visuais de qualidade (verde: excelente, amarelo: aceitável, vermelho: ruim)
- Drill-down para detalhes de cada tronco
- Exportação de gráficos (PNG, PDF)
- Alertas visuais quando métricas excedem limites

---

### RN-RF040-12 — Simulador de Economia para Migração SIP Versus E1

**Descrição**: Ferramenta que calcula ROI de migração de troncos E1 para SIP com base no uso real dos últimos 6 meses.

**Justificativa**: Troncos SIP geralmente têm custo menor e maior flexibilidade. Simular economia ajuda na tomada de decisão estratégica.

**Critério de Aceite**:
- Simulação requer mínimo 6 meses de histórico de uso
- Custos de operadoras devem estar atualizados (<90 dias)
- Cálculo de break-even point (meses para ROI positivo)
- Recomendação só se ROI <12 meses
- Projeção de economia em 12, 24, 36 meses
- Considerar custos: fixos (assinatura), variáveis (minutos), investimento inicial (gateway, instalação)

---

### RN-RF040-13 — Detecção de Loops e Chamadas Anômalas

**Descrição**: Sistema detecta padrões de chamadas anômalas que indicam problemas de configuração ou tentativas de fraude.

**Justificativa**: Evitar custos elevados com loops de chamada, chamadas de teste mal configuradas ou fraudes telefônicas.

**Critério de Aceite**:
- Loop detectado se >10 chamadas para mesmo número em <5 minutos
- Fraude detectada: Chamadas DDI para países de alto risco (Cuba, Somália, etc.)
- Teste detectado: Chamadas com duração <3 segundos em sequência
- Bloqueio automático apenas se score de anomalia >85
- Alerta + registro de auditoria + criação de ticket de suporte
- Desbloqueio requer aprovação manual após investigação

---

### RN-RF040-14 — Análise Comparativa de TCO por Tecnologia (E1, SIP, Analógico)

**Descrição**: Relatório compara custos totais (TCO - Total Cost of Ownership) de troncos E1, SIP e analógicos ao longo de 3 anos.

**Justificativa**: Auxiliar na decisão estratégica de qual tecnologia priorizar em novos investimentos.

**Critério de Aceite**:
- TCO calculado para períodos de 1, 3 e 5 anos
- Custos atualizados trimestralmente
- Considerar inflação (IPCA) na projeção
- Incluir: custo de aquisição (hardware, instalação), custo operacional (mensalidade, manutenção), custo variável (minutos), custo de suporte
- Comparação side-by-side de 3 tecnologias
- Recomendação estratégica baseada em menor TCO

---

### RN-RF040-15 — Integração com Sistema de Bilhetes Telefônicos (RF039)

**Descrição**: Sistema de gestão de troncos integra automaticamente com a gestão de bilhetes telefônicos para análise cruzada de dados.

**Justificativa**: Correlacionar qualidade de troncos com custos de bilhetes para análise completa de telefonia (custo + qualidade).

**Critério de Aceite**:
- Ao processar bilhete, identifica qual tronco foi utilizado (CDR matching)
- Associa custo do bilhete ao tronco correspondente
- Análise cruzada executada diariamente
- Dados sincronizados entre RF040 e RF039
- Permite análise: custo total por tronco (fixo + variável + bilhetes), correlação QoS vs reclamações de qualidade, ROI de cada tronco

---

## 6. ESTADOS DA ENTIDADE

| Estado | Descrição |
|--------|-----------|
| **disponivel** | Tronco operacional e pronto para receber chamadas |
| **ocupado** | Tronco com chamadas ativas (não atingiu capacidade máxima) |
| **indisponivel** | Tronco com falha, não responde a verificações |
| **congestionado** | Tronco com utilização >80% por >5 minutos |
| **manutencao** | Tronco temporariamente desativado para manutenção programada |
| **inativo** | Tronco desativado administrativamente (exclusão lógica) |

### Transições permitidas

| De | Para | Condição |
|----|------|----------|
| disponivel | ocupado | Chamada ativa iniciada |
| ocupado | disponivel | Todas as chamadas finalizadas |
| disponivel | indisponivel | 3 falhas consecutivas de monitoramento |
| indisponivel | disponivel | 2 verificações consecutivas OK + 5 min estabilidade |
| disponivel | congestionado | Utilização >80% por >5 min |
| congestionado | disponivel | Utilização <80% |
| disponivel | manutencao | Ação administrativa |
| manutencao | disponivel | Manutenção concluída |
| disponivel | inativo | Exclusão lógica |
| inativo | disponivel | Reativação administrativa |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre | Ações Automáticas |
|--------|---------------|-------------------|
| tronco.criado | Após criação de novo tronco | Registrar auditoria, iniciar monitoramento |
| tronco.atualizado | Após atualização de configuração | Registrar auditoria, aplicar mudanças no PABX |
| tronco.falha_detectada | Após 3 falhas consecutivas | Alerta, failover automático, registro auditoria |
| tronco.failover_executado | Após failover para backup | Notificações (SMS/e-mail/push), atualização roteamento |
| tronco.congestionado | Utilização >80% por >5 min | Alerta, redistribuição de carga, registro auditoria |
| tronco.qos_degradado | MOS <2.0 por 3 medições | Alerta, considerar failover, registro auditoria |
| tronco.recuperado | Após recuperação de falha | Iniciar retorno gradual, notificações, registro auditoria |
| tronco.inativado | Exclusão lógica | Remover de monitoramento, registrar auditoria |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant (Id_Fornecedor)
- Nenhuma regra de negócio pode ser ignorada
- Todas as operações devem ter permissões RBAC verificadas
- Erros devem ser previsíveis, rastreáveis e retornar códigos HTTP apropriados
- Auditoria deve registrar quem, quando, o que mudou e estado anterior/posterior
- Métricas de QoS devem ser coletadas a cada 30 segundos
- Failover deve ocorrer em menos de 5 segundos
- Dashboard deve atualizar em tempo real via SignalR
- Integração com PABX deve ser confiável (retry em caso de falha)
- Histórico de métricas mantido por 90 dias

---

## 9. SEGURANÇA

- Validação de entrada obrigatória (prevenir SQL Injection, XSS)
- Proteção contra injeção em comandos PABX
- Controle de permissões granular (visualizar, configurar, monitorar, dashboard, relatórios, failover manual)
- Isolamento multi-tenant rigoroso (Id_Fornecedor em todas as queries)
- API Key + IP Whitelist para integração com PABX
- Criptografia de credenciais de troncos (senha de SIP, API keys)
- Rate limiting em endpoints de monitoramento (prevenir DDoS)
- Auditoria de todas as ações administrativas

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF040.md** - Casos de Uso (listar, criar, monitorar, failover, relatórios, simular economia)
- **MD-RF040.yaml** - Modelo de Dados (tabelas Tronco, MetricasQoS, EventoFailover, HistoricoDisponibilidade)
- **WF-RF040.md** - Wireframes (dashboard QoS, listagem troncos, formulário configuração, simulador economia)
- **TC-RF040.yaml** - Casos de Teste (backend, frontend, segurança, integração PABX)
- **MT-RF040.yaml** - Massas de Teste (troncos SIP/E1/analógico, métricas QoS, eventos de falha)

---

## 11. RASTREABILIDADE

| Artefato | Status | Obrigatório |
|----------|--------|-------------|
| UC-RF040.md | Pendente | Sim |
| MD-RF040.yaml | Pendente | Sim |
| WF-RF040.md | Pendente | Sim |
| TC-RF040.yaml | Pendente | Sim |
| MT-RF040.yaml | Pendente | Sim |

**Integrações Rastreadas:**
- RF039 - Gestão de Bilhetes Telefônicos (integração de custos e análise cruzada)
- Central de Funcionalidades (registro da feature "GES.TRONCOS")
- Sistema de Auditoria (eventos de falha, failover, alterações)
- Sistema de Permissões RBAC (matriz de permissões)
- Sistema de Internacionalização i18n (chaves de tradução)

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-30 | Migração para Governança v2.0 - Separação estrita RF/RL, remoção de referências ao legado, contrato funcional moderno com 11 seções e 15 regras de negócio | Agência ALC - alc.dev.br |
| 1.0 | 2025-01-14 | Versão inicial com 5 seções obrigatórias e 15 regras de negócio | Architect Agent |
