# RF040 - GestÃ£o de Troncos

**Fase:** 2 - ServiÃ§os Essenciais
**EPIC:** EPIC003-GES - GestÃ£o
**MÃ³dulo:** GestÃ£o
**ResponsÃ¡vel:** Architect Agent
**Data CriaÃ§Ã£o:** 2025-01-14
**VersÃ£o:** 1.0
**Status:** EspecificaÃ§Ã£o Completa

---

## SEÃ‡ÃƒO 1: RESUMO EXECUTIVO

### 1.1 DescriÃ§Ã£o Geral

O **RF040 - GestÃ£o de Troncos** implementa o sistema completo de gerenciamento de troncos telefÃ´nicos (SIP, E1/R2, analÃ³gicos), incluindo monitoramento de disponibilidade em tempo real, anÃ¡lise de capacidade vs utilizaÃ§Ã£o, detecÃ§Ã£o de falhas, balanceamento de carga, custeio por tronco, integraÃ§Ã£o com PABX/gateways e relatÃ³rios de QoS (Quality of Service). O sistema permite otimizar recursos de telefonia, garantir alta disponibilidade, reduzir custos operacionais e melhorar a experiÃªncia do usuÃ¡rio final.

### 1.2 ImportÃ¢ncia EstratÃ©gica

A gestÃ£o eficaz de troncos telefÃ´nicos Ã© crucial para:
- **Alta disponibilidade** garantindo comunicaÃ§Ã£o ininterrupta (99,9% uptime SLA)
- **OtimizaÃ§Ã£o de custos** dimensionando corretamente a quantidade de troncos contratados
- **Qualidade de serviÃ§o** monitorando jitter, latÃªncia, packet loss e MOS score
- **DetecÃ§Ã£o proativa de falhas** alertando antes que usuÃ¡rios sejam impactados
- **Balanceamento de carga** distribuindo chamadas entre mÃºltiplos troncos
- **Conformidade regulatÃ³ria** atendendo requisitos ANATEL de qualidade

### 1.3 ComparaÃ§Ã£o Sistema Legado vs. Modernizado

| Aspecto | Sistema Legado | Sistema Modernizado |
|---------|----------------|---------------------|
| **Monitoramento** | Manual, verificaÃ§Ã£o esporÃ¡dica | Monitoramento contÃ­nuo em tempo real (polling 30s) |
| **DetecÃ§Ã£o de Falhas** | UsuÃ¡rios reportam problemas | DetecÃ§Ã£o automÃ¡tica + alerta proativo |
| **MÃ©tricas de QoS** | NÃ£o medidas | Jitter, latÃªncia, packet loss, MOS score em tempo real |
| **Balanceamento** | Manual, estÃ¡tico | AutomÃ¡tico, dinÃ¢mico baseado em utilizaÃ§Ã£o |
| **Alertas** | E-mails esporÃ¡dicos | Alertas escalonados (SMS, e-mail, push, chamada) |
| **Dimensionamento** | Baseado em feeling | AnÃ¡lise estatÃ­stica de capacidade vs utilizaÃ§Ã£o |
| **Custeio** | Rateio simples | Custeio detalhado por tronco, horÃ¡rio, tipo de chamada |
| **IntegraÃ§Ã£o PABX** | NÃ£o suportado | APIs REST + SNMP + SIP |
| **RedundÃ¢ncia** | Manual (failover) | AutomÃ¡tico (failover <5 segundos) |
| **Multi-tenant** | NÃ£o suportado | Isolamento completo por fornecedor |

### 1.4 Principais Funcionalidades

1. **Monitoramento em Tempo Real**
   - Status de cada tronco (disponÃ­vel, ocupado, indisponÃ­vel)
   - Chamadas ativas simultÃ¢neas
   - Taxa de utilizaÃ§Ã£o (% de ocupaÃ§Ã£o)
   - Dashboard com indicadores visuais (verde/amarelo/vermelho)

2. **MÃ©tricas de Qualidade de ServiÃ§o (QoS)**
   - **Jitter:** VariaÃ§Ã£o de latÃªncia (<30ms ideal, <50ms aceitÃ¡vel)
   - **LatÃªncia:** Tempo de resposta (<150ms ideal, <300ms aceitÃ¡vel)
   - **Packet Loss:** Perda de pacotes (<1% ideal, <3% aceitÃ¡vel)
   - **MOS Score:** Mean Opinion Score (4.0-5.0 excelente, 3.0-4.0 bom)

3. **DetecÃ§Ã£o AutomÃ¡tica de Falhas**
   - Tronco inativo/nÃ£o responde
   - DegradaÃ§Ã£o de qualidade (MOS <3.0)
   - Taxa de erro alta (>5% de chamadas falhadas)
   - Congestionamento (utilizaÃ§Ã£o >90% por >5 minutos)
   - Failover automÃ¡tico para tronco backup

4. **Balanceamento de Carga**
   - DistribuiÃ§Ã£o inteligente de chamadas
   - Algoritmos: Round Robin, Least Call Count, Weighted
   - PriorizaÃ§Ã£o de troncos premium (menor custo, melhor qualidade)
   - Evita sobrecarga de troncos individuais

5. **AnÃ¡lise de Capacidade vs UtilizaÃ§Ã£o**
   - ComparaÃ§Ã£o capacidade contratada vs uso real
   - IdentificaÃ§Ã£o de ociosidade (subutilizaÃ§Ã£o <30%)
   - IdentificaÃ§Ã£o de congestionamento (utilizaÃ§Ã£o >80%)
   - RecomendaÃ§Ã£o de ajuste (aumento/reduÃ§Ã£o de troncos)

6. **Custeio Detalhado por Tronco**
   - Custo fixo mensal (assinatura)
   - Custo variÃ¡vel (por minuto/chamada)
   - Rateio por centro de custo/departamento
   - ROI de troncos SIP vs E1 vs analÃ³gicos

7. **RelatÃ³rios Gerenciais**
   - Disponibilidade mensal (% uptime)
   - Top 10 troncos mais utilizados
   - EvoluÃ§Ã£o de QoS (6, 12, 24 meses)
   - AnÃ¡lise de falhas (MTBF, MTTR)
   - Comparativo de custos por tecnologia

8. **IntegraÃ§Ãµes MandatÃ³rias**
   - **Central de Funcionalidades** - Registro da feature "GestÃ£o de Troncos"
   - **InternacionalizaÃ§Ã£o (i18n)** - Todas as mensagens em pt-BR, en-US, es-ES
   - **Auditoria** - Log de todas as falhas, failovers, alteraÃ§Ãµes de configuraÃ§Ã£o
   - **Controle de Acesso (RBAC)** - PermissÃµes granulares por operaÃ§Ã£o

---

## SEÃ‡ÃƒO 2: REGRAS DE NEGÃ“CIO

### RN001 - Monitoramento ContÃ­nuo com Polling a Cada 30 Segundos

**DescriÃ§Ã£o:**
O sistema verifica o status de cada tronco a cada 30 segundos usando protocolos apropriados (SIP OPTIONS, SNMP GET, API REST).

**Justificativa:**
Detectar falhas rapidamente (SLA de detecÃ§Ã£o <1 minuto) e tomar aÃ§Ãµes corretivas antes que usuÃ¡rios sejam impactados.

**ImplementaÃ§Ã£o:**
- Hangfire job executa a cada 30 segundos (configurÃ¡vel)
- Para troncos SIP: envia SIP OPTIONS e aguarda 200 OK
- Para troncos E1: consulta SNMP do gateway (OID especÃ­fico de status)
- Para APIs REST: chamada HTTP GET /health endpoint
- Atualiza status no banco de dados (disponÃ­vel, ocupado, indisponÃ­vel)
- Se 3 falhas consecutivas, marca tronco como "down" e dispara alerta

**Exemplo:**
```
Monitoramento de Tronco - ExecuÃ§Ã£o 15/01/2025 14:30:00

Tronco #1: SIP-VIVO-001 (SIP)
MÃ©todo: SIP OPTIONS sip:gateway.vivo.com.br
Resposta: 200 OK (12ms)
Chamadas Ativas: 18/30 (60% utilizaÃ§Ã£o)
Status: âœ… DisponÃ­vel

Tronco #2: E1-TIM-001 (E1/R2)
MÃ©todo: SNMP GET gateway-tim.local (OID: 1.3.6.1.2.1.2.2.1.8.1)
Resposta: 1 (up) (8ms)
Chamadas Ativas: 25/30 (83% utilizaÃ§Ã£o)
Status: âš ï¸ DisponÃ­vel (alta utilizaÃ§Ã£o)

Tronco #3: SIP-CLARO-001 (SIP)
MÃ©todo: SIP OPTIONS sip:gateway.claro.com.br
Resposta: Timeout (5000ms)
Tentativa 1/3: Falha
Aguardando prÃ³xima tentativa em 30s...

Tronco #4: API-TWILIO-001 (API REST)
MÃ©todo: HTTP GET https://api.twilio.com/health
Resposta: 200 OK (45ms)
Troncos DisponÃ­veis: 100/100 (pool elÃ¡stico)
Status: âœ… DisponÃ­vel

PrÃ³xima ExecuÃ§Ã£o: 14:30:30
```

**ValidaÃ§Ãµes:**
- âœ… Timeout mÃ¡ximo: 5 segundos por tronco
- âœ… 3 falhas consecutivas = tronco marcado como "down"
- âœ… Alerta dispara imediatamente ao marcar como "down"

---

### RN002 - CÃ¡lculo de MOS Score (Mean Opinion Score)

**DescriÃ§Ã£o:**
Sistema calcula automaticamente o MOS score de cada tronco com base em jitter, latÃªncia e packet loss usando algoritmo E-Model (ITU-T G.107).

**Justificativa:**
MOS Ã© a mÃ©trica padrÃ£o da indÃºstria para qualidade de voz. Permite comparaÃ§Ã£o objetiva entre troncos.

**ImplementaÃ§Ã£o:**
- Coleta mÃ©tricas a cada 30 segundos:
  - **Jitter** (ms): VariaÃ§Ã£o de latÃªncia
  - **LatÃªncia** (ms): Round-trip time
  - **Packet Loss** (%): Percentual de pacotes perdidos
- Aplica algoritmo E-Model:
  ```
  R = 93.2 - Id - Ie
  Id = Delay Impairment (funÃ§Ã£o de latÃªncia)
  Ie = Equipment Impairment (funÃ§Ã£o de codec + packet loss)
  MOS = 1 + 0.035*R + 7*10^-6*R*(R-60)*(100-R)
  ```
- Classifica qualidade:
  - 4.0-5.0: Excelente
  - 3.0-4.0: Bom
  - 2.0-3.0: Regular (gera alerta)
  - 1.0-2.0: Ruim (failover automÃ¡tico)

**Exemplo:**
```
Tronco: SIP-VIVO-001
PerÃ­odo: 15/01/2025 14:00-15:00

MÃ©tricas Coletadas (mÃ©dia horÃ¡ria):
- Jitter: 15ms (âœ… Excelente, ideal <30ms)
- LatÃªncia: 80ms (âœ… Excelente, ideal <150ms)
- Packet Loss: 0.5% (âœ… Excelente, ideal <1%)

CÃ¡lculo E-Model:
R = 93.2 - Id(80ms) - Ie(0.5%, G.711)
R = 93.2 - 2.5 - 5.1
R = 85.6

MOS Score:
MOS = 1 + 0.035*85.6 + 7*10^-6*85.6*(85.6-60)*(100-85.6)
MOS = 1 + 3.0 + 0.15
MOS = 4.15

ClassificaÃ§Ã£o: â­â­â­â­â­ Excelente
RecomendaÃ§Ã£o: Manter como tronco prioritÃ¡rio para chamadas crÃ­ticas
```

**ValidaÃ§Ãµes:**
- âœ… MOS calculado apenas se todas as 3 mÃ©tricas disponÃ­veis
- âœ… Se MOS <2.0 por 3 mediÃ§Ãµes consecutivas â†’ failover automÃ¡tico
- âœ… HistÃ³rico de MOS armazenado para anÃ¡lise de tendÃªncias

---

### RN003 - Failover AutomÃ¡tico em Caso de Falha

**DescriÃ§Ã£o:**
Quando um tronco falha, o sistema redireciona automaticamente as chamadas para tronco backup em menos de 5 segundos.

**Justificativa:**
Garantir alta disponibilidade e minimizar impacto ao usuÃ¡rio final.

**ImplementaÃ§Ã£o:**
- Cada tronco tem 1-3 troncos backup configurados (prioridade)
- Ao detectar falha (3 tentativas sem resposta):
  1. Marca tronco como "down" no banco
  2. Notifica administrador via SMS/e-mail/push
  3. Atualiza roteamento no PABX via API (SIP 302 Moved Temporarily)
  4. Redireciona novas chamadas para tronco backup
  5. Monitora tronco primÃ¡rio a cada 60 segundos (detectar recuperaÃ§Ã£o)
- Ao detectar recuperaÃ§Ã£o (2 tentativas consecutivas OK):
  1. Aguarda 5 minutos de estabilidade
  2. Retorna roteamento para tronco primÃ¡rio (gradual, 10% a cada minuto)

**Exemplo:**
```
Evento de Failover - 15/01/2025 14:35:20

Tronco PrimÃ¡rio: SIP-VIVO-001 (30 canais)
Status Anterior: âœ… DisponÃ­vel
Status Atual: ğŸ”´ IndisponÃ­vel (timeout)

Timeline do Failover:
14:35:00 - 1Âª tentativa: Timeout (5s)
14:35:30 - 2Âª tentativa: Timeout (5s)
14:36:00 - 3Âª tentativa: Timeout (5s)
14:36:05 - FALHA CONFIRMADA - Iniciando failover

14:36:06 - NotificaÃ§Ãµes Enviadas:
  - SMS para administrador (+5511999887766)
  - E-mail para equipe TI (ti@empresa.com)
  - Push notification para supervisor
  - Chamada de emergÃªncia para NOC (+551133334444)

14:36:07 - AtualizaÃ§Ã£o de Roteamento:
  - Tronco Backup: SIP-TIM-001 (30 canais disponÃ­veis)
  - Comando PABX: UPDATE ROUTE sip-vivo-001 â†’ sip-tim-001
  - Status: Redirecionamento ativo

14:36:10 - Failover ConcluÃ­do:
  - Tempo total: 5 segundos âœ… (SLA: <10s)
  - Chamadas ativas: 0 (nenhuma chamada ativa no momento da falha)
  - Chamadas perdidas: 0 âœ…

Monitoramento de RecuperaÃ§Ã£o:
14:37:00 - Tentativa recuperaÃ§Ã£o: Timeout
14:38:00 - Tentativa recuperaÃ§Ã£o: Timeout
...
15:15:00 - Tentativa recuperaÃ§Ã£o: 200 OK âœ…
15:16:00 - Tentativa recuperaÃ§Ã£o: 200 OK âœ…
15:20:00 - Estabilidade confirmada (5 min OK)

15:21:00 - Retorno Gradual:
  - 10% das chamadas â†’ SIP-VIVO-001
  - 90% das chamadas â†’ SIP-TIM-001 (backup)
...
15:30:00 - 100% das chamadas retornaram ao tronco primÃ¡rio
15:30:01 - Failover finalizado - Sistema normalizado
```

**ValidaÃ§Ãµes:**
- âœ… Failover sÃ³ ocorre apÃ³s 3 falhas consecutivas
- âœ… Tronco backup deve estar disponÃ­vel (status "up")
- âœ… Retorno gradual para evitar sobrecarga do tronco primÃ¡rio

---

### RN004 - Balanceamento de Carga com Algoritmo Least Call Count

**DescriÃ§Ã£o:**
Novas chamadas sÃ£o distribuÃ­das para o tronco com menor nÃºmero de chamadas ativas no momento.

**Justificativa:**
Evitar sobrecarga de troncos individuais e maximizar utilizaÃ§Ã£o uniforme de recursos.

**ImplementaÃ§Ã£o:**
- Ao receber solicitaÃ§Ã£o de nova chamada:
  1. Lista todos os troncos disponÃ­veis (status "up")
  2. Ordena por quantidade de chamadas ativas (crescente)
  3. Seleciona tronco com menor quantidade
  4. Atualiza contador de chamadas ativas (+1)
  5. Retorna URI do tronco selecionado ao PABX
- Ao finalizar chamada:
  1. Atualiza contador de chamadas ativas (-1)
  2. Registra duraÃ§Ã£o e custo no banco

**Exemplo:**
```
SolicitaÃ§Ã£o de Chamada - 15/01/2025 14:40:15
Origem: Ramal 1234 (JoÃ£o Silva - Vendas)
Destino: +5511999887766 (Cliente ABC)

Troncos DisponÃ­veis:

Tronco #1: SIP-VIVO-001
- Status: âœ… DisponÃ­vel
- Capacidade: 30 canais
- Chamadas Ativas: 18 (60% utilizaÃ§Ã£o)
- Custo/min: R$ 0,10

Tronco #2: SIP-TIM-001
- Status: âœ… DisponÃ­vel
- Capacidade: 30 canais
- Chamadas Ativas: 12 (40% utilizaÃ§Ã£o) â† MENOR
- Custo/min: R$ 0,12

Tronco #3: E1-CLARO-001
- Status: âœ… DisponÃ­vel
- Capacidade: 30 canais
- Chamadas Ativas: 25 (83% utilizaÃ§Ã£o)
- Custo/min: R$ 0,08

Algoritmo Least Call Count:
OrdenaÃ§Ã£o: TIM-001 (12) < VIVO-001 (18) < CLARO-001 (25)
Tronco Selecionado: SIP-TIM-001 (menor quantidade de chamadas)

Roteamento:
PABX â†’ SIP INVITE sip:5511999887766@gateway-tim.local
Resposta: 100 Trying... 180 Ringing... 200 OK
Chamada Estabelecida Ã s 14:40:18

AtualizaÃ§Ã£o de Estado:
SIP-TIM-001: Chamadas Ativas 12 â†’ 13
Custo estimado: R$ 0,12/min (baseado em histÃ³rico)

Fim da Chamada: 14:55:20 (duraÃ§Ã£o 15 min 2 seg)
Custo Real: R$ 1,82 (15 min Ã— R$ 0,12)
SIP-TIM-001: Chamadas Ativas 13 â†’ 12
```

**ValidaÃ§Ãµes:**
- âœ… Apenas troncos com status "up" sÃ£o considerados
- âœ… Se todos os troncos estiverem em 100% utilizaÃ§Ã£o â†’ fila de espera
- âœ… PreferÃªncia por troncos com melhor MOS score em caso de empate

---

### RN005 - Alerta de Congestionamento (UtilizaÃ§Ã£o >80% por >5 Minutos)

**DescriÃ§Ã£o:**
Sistema detecta congestionamento quando um tronco opera acima de 80% de utilizaÃ§Ã£o por mais de 5 minutos consecutivos.

**Justificativa:**
Permitir aÃ§Ã£o proativa antes que chamadas comecem a ser rejeitadas (100% utilizaÃ§Ã£o).

**ImplementaÃ§Ã£o:**
- Monitoramento contÃ­nuo de utilizaÃ§Ã£o a cada 30 segundos
- Se utilizaÃ§Ã£o >80%:
  - Inicia contador de tempo
  - Se duraÃ§Ã£o >5 minutos â†’ dispara alerta de congestionamento
  - Envia notificaÃ§Ã£o para equipe de TI
  - Sugere aÃ§Ãµes corretivas:
    - Redistribuir carga para outros troncos
    - Ativar tronco de contingÃªncia
    - Contratar canais adicionais temporÃ¡rios (burst)

**Exemplo:**
```
DetecÃ§Ã£o de Congestionamento - 15/01/2025 15:30:00

Tronco: E1-CLARO-001
Capacidade: 30 canais
UtilizaÃ§Ã£o Atual: 27/30 (90%)

Timeline:
15:25:00 - UtilizaÃ§Ã£o: 25/30 (83%) - InÃ­cio do congestionamento
15:25:30 - UtilizaÃ§Ã£o: 26/30 (87%)
15:26:00 - UtilizaÃ§Ã£o: 27/30 (90%)
15:26:30 - UtilizaÃ§Ã£o: 28/30 (93%)
15:27:00 - UtilizaÃ§Ã£o: 27/30 (90%)
15:27:30 - UtilizaÃ§Ã£o: 27/30 (90%)
15:28:00 - UtilizaÃ§Ã£o: 28/30 (93%)
15:28:30 - UtilizaÃ§Ã£o: 27/30 (90%)
15:29:00 - UtilizaÃ§Ã£o: 27/30 (90%)
15:29:30 - UtilizaÃ§Ã£o: 27/30 (90%)
15:30:00 - âš ï¸ CONGESTIONAMENTO CONFIRMADO (5 minutos acima de 80%)

Alerta Gerado:
ğŸŸ¡ CONGESTIONAMENTO DETECTADO
Tronco: E1-CLARO-001
DuraÃ§Ã£o: 5 minutos
UtilizaÃ§Ã£o MÃ©dia: 90%
Chamadas Rejeitadas: 3 (nos Ãºltimos 5 minutos)

NotificaÃ§Ãµes Enviadas:
- E-mail para equipe TI
- SMS para supervisor de plantÃ£o
- Push notification para dashboard

AÃ§Ãµes Corretivas Sugeridas:
1. Redistribuir 50% das chamadas para SIP-VIVO-001 (45% utilizaÃ§Ã£o)
2. Ativar tronco de contingÃªncia SIP-BACKUP-001
3. Se persistir >15 min, considerar contrataÃ§Ã£o de burst (+10 canais temporÃ¡rios)

AÃ§Ã£o AutomÃ¡tica Executada:
âœ… RedistribuiÃ§Ã£o ativada - 50% das novas chamadas â†’ SIP-VIVO-001
```

**ValidaÃ§Ãµes:**
- âœ… Alerta sÃ³ dispara se utilizaÃ§Ã£o >80% por >5 minutos CONSECUTIVOS
- âœ… Se utilizaÃ§Ã£o voltar a <80%, contador Ã© zerado
- âœ… MÃ¡ximo 1 alerta por hora por tronco (evitar spam)

---

### RN006 - AnÃ¡lise de Capacidade vs UtilizaÃ§Ã£o Mensal

**DescriÃ§Ã£o:**
RelatÃ³rio mensal compara capacidade contratada vs utilizaÃ§Ã£o real e identifica oportunidades de otimizaÃ§Ã£o.

**Justificativa:**
Evitar desperdÃ­cio com troncos ociosos ou custos extras por congestionamento frequente.

**ImplementaÃ§Ã£o:**
- AnÃ¡lise da utilizaÃ§Ã£o mÃ©dia mensal de cada tronco
- ClassificaÃ§Ã£o:
  - **Ocioso** (<30% utilizaÃ§Ã£o): considerar reduzir canais
  - **Adequado** (30-80% utilizaÃ§Ã£o): dimensionamento correto
  - **Congestionado** (>80% utilizaÃ§Ã£o): considerar aumentar canais
- CÃ¡lculo de economia potencial ou custo de congestionamento

**Exemplo:**
```
RelatÃ³rio de Capacidade vs UtilizaÃ§Ã£o - Janeiro/2025

Tronco #1: SIP-VIVO-001 (SIP)
Capacidade: 30 canais
UtilizaÃ§Ã£o MÃ©dia: 18 canais (60%)
Pico MÃ¡ximo: 28 canais (93%)
ClassificaÃ§Ã£o: âœ… Adequado
RecomendaÃ§Ã£o: Manter configuraÃ§Ã£o atual

Tronco #2: E1-TIM-001 (E1/R2)
Capacidade: 30 canais
UtilizaÃ§Ã£o MÃ©dia: 8 canais (27%) âš ï¸
Pico MÃ¡ximo: 15 canais (50%)
ClassificaÃ§Ã£o: ğŸ”´ Ocioso (subutilizado)
RecomendaÃ§Ã£o: Reduzir para 15 canais
Economia Projetada: R$ 1.200/mÃªs (15 canais Ã— R$ 80/canal)

Tronco #3: E1-CLARO-001 (E1/R2)
Capacidade: 30 canais
UtilizaÃ§Ã£o MÃ©dia: 27 canais (90%) âš ï¸
Pico MÃ¡ximo: 30 canais (100%) - 45 vezes no mÃªs
Chamadas Rejeitadas: 120 (congestionamento)
ClassificaÃ§Ã£o: ğŸ”´ Congestionado
RecomendaÃ§Ã£o: Aumentar para 40 canais (+10)
Custo Adicional: R$ 800/mÃªs (10 canais Ã— R$ 80/canal)
BenefÃ­cio: Eliminar 120 chamadas perdidas/mÃªs (custo oportunidade: R$ 3.000)
ROI: Positivo - Investir R$ 800 para evitar perda de R$ 3.000

Tronco #4: SIP-TWILIO-001 (Pool ElÃ¡stico)
Capacidade: Ilimitada (paga por uso)
UtilizaÃ§Ã£o MÃ©dia: 5 canais
Custo/min: R$ 0,15 (mais caro que E1)
ClassificaÃ§Ã£o: âš ï¸ Uso esporÃ¡dico adequado
RecomendaÃ§Ã£o: Manter para burst/contingÃªncia

Resumo Executivo:
- 1 tronco ocioso â†’ Reduzir canais (economia: R$ 1.200/mÃªs)
- 1 tronco congestionado â†’ Aumentar canais (investimento: R$ 800/mÃªs, ROI positivo)
- 2 troncos adequados â†’ Manter

Saldo Final: +R$ 400/mÃªs de economia + eliminaÃ§Ã£o de 120 chamadas perdidas
```

**ValidaÃ§Ãµes:**
- âœ… AnÃ¡lise requer 30 dias completos de dados
- âœ… RecomendaÃ§Ã£o sÃ³ se houver economia >R$ 200/mÃªs
- âœ… Considerar sazonalidade (dezembro tem mais chamadas)

---

### RN007 - Custeio Detalhado por Tronco e Centro de Custo

**DescriÃ§Ã£o:**
Sistema calcula custo total de cada tronco (fixo + variÃ¡vel) e rateia entre centros de custo com base no uso.

**Justificativa:**
Permitir visibilidade precisa de custos de telefonia e facilitar anÃ¡lise gerencial.

**ImplementaÃ§Ã£o:**
- Custo Fixo: Assinatura mensal do tronco (ex: R$ 2.400/mÃªs para E1 com 30 canais)
- Custo VariÃ¡vel: Custo por minuto de chamada (ex: R$ 0,10/min)
- Rateio por centro de custo baseado em minutos utilizados
- CÃ¡lculo de custo mÃ©dio por chamada, por departamento, por tipo

**Exemplo:**
```
Custeio do Tronco E1-CLARO-001 - Janeiro/2025

Custos Fixos:
- Assinatura Mensal: R$ 2.400 (30 canais Ã— R$ 80/canal)
- Equipamento Gateway: R$ 200 (depreciaÃ§Ã£o mensal)
- Link de Dados: R$ 300 (dedicado para SIP)
Total Fixo: R$ 2.900/mÃªs

Custos VariÃ¡veis:
- Total de Minutos: 12.450 minutos
- Custo/min: R$ 0,08
Total VariÃ¡vel: R$ 996,00

Custo Total Janeiro: R$ 3.896

Rateio por Centro de Custo:

CC-001 (Vendas):
- Minutos: 5.600 (45% do total)
- Custo Fixo (proporcional): R$ 1.305
- Custo VariÃ¡vel: R$ 448
- Total: R$ 1.753 (45%)

CC-002 (Marketing):
- Minutos: 2.490 (20% do total)
- Custo Fixo (proporcional): R$ 580
- Custo VariÃ¡vel: R$ 199
- Total: R$ 779 (20%)

CC-003 (Suporte):
- Minutos: 3.115 (25% do total)
- Custo Fixo (proporcional): R$ 725
- Custo VariÃ¡vel: R$ 249
- Total: R$ 974 (25%)

CC-004 (Administrativo):
- Minutos: 1.245 (10% do total)
- Custo Fixo (proporcional): R$ 290
- Custo VariÃ¡vel: R$ 100
- Total: R$ 390 (10%)

ComparaÃ§Ã£o com MÃªs Anterior:
Dez/2024: R$ 3.650 | Jan/2025: R$ 3.896 (+6,7%)
Crescimento em Vendas (+15%) e Suporte (+10%)

ExportaÃ§Ã£o para ERP:
âœ… LanÃ§amento contÃ¡bil enviado ao SAP FI
âœ… 4 lanÃ§amentos criados (1 por centro de custo)
```

**ValidaÃ§Ãµes:**
- âœ… Soma dos rateios deve ser 100% do total
- âœ… Custos fixos rateados proporcionalmente ao uso
- âœ… IntegraÃ§Ã£o com ERP validada (confirmaÃ§Ã£o de lanÃ§amento)

---

### RN008 - MÃ©tricas MTBF e MTTR para AnÃ¡lise de Confiabilidade

**DescriÃ§Ã£o:**
Sistema calcula MTBF (Mean Time Between Failures) e MTTR (Mean Time To Repair) de cada tronco para anÃ¡lise de confiabilidade.

**Justificativa:**
Identificar troncos problemÃ¡ticos e avaliar qualidade do serviÃ§o de operadoras.

**ImplementaÃ§Ã£o:**
- **MTBF:** Tempo mÃ©dio entre falhas consecutivas
- **MTTR:** Tempo mÃ©dio para restauraÃ§Ã£o apÃ³s falha
- CÃ¡lculo baseado em histÃ³rico de 12 meses
- Benchmark da indÃºstria:
  - MTBF ideal: >720 horas (30 dias)
  - MTTR ideal: <1 hora
- ClassificaÃ§Ã£o de confiabilidade (A, B, C, D, F)

**Exemplo:**
```
AnÃ¡lise de Confiabilidade - Ãšltimos 12 Meses

Tronco #1: SIP-VIVO-001
Falhas Registradas: 4
Tempo Total de OperaÃ§Ã£o: 8.760 horas (365 dias)
Tempo Total de Inatividade: 6 horas

MTBF = 8.760 / 4 = 2.190 horas (91 dias) â­â­â­â­â­
MTTR = 6 / 4 = 1,5 horas â­â­â­â­

Disponibilidade = (8.760 - 6) / 8.760 = 99,93% âœ…
ClassificaÃ§Ã£o: A (Excelente)

Tronco #2: E1-TIM-001
Falhas Registradas: 12
Tempo Total de OperaÃ§Ã£o: 8.760 horas
Tempo Total de Inatividade: 48 horas

MTBF = 8.760 / 12 = 730 horas (30 dias) â­â­â­
MTTR = 48 / 12 = 4 horas â­â­

Disponibilidade = (8.760 - 48) / 8.760 = 99,45% âš ï¸
ClassificaÃ§Ã£o: B (Bom, mas melhorias necessÃ¡rias)

Tronco #3: E1-CLARO-001
Falhas Registradas: 25
Tempo Total de OperaÃ§Ã£o: 8.760 horas
Tempo Total de Inatividade: 120 horas

MTBF = 8.760 / 25 = 350 horas (14,5 dias) âš ï¸
MTTR = 120 / 25 = 4,8 horas âš ï¸

Disponibilidade = (8.760 - 120) / 8.760 = 98,63% ğŸ”´
ClassificaÃ§Ã£o: C (Regular - Avaliar substituiÃ§Ã£o)

RecomendaÃ§Ãµes:
1. E1-CLARO-001: Considerar migrar para SIP (maior confiabilidade)
2. E1-TIM-001: Solicitar anÃ¡lise de causa raiz com operadora
3. SIP-VIVO-001: Manter como tronco prioritÃ¡rio (melhor desempenho)
```

**ValidaÃ§Ãµes:**
- âœ… MTBF calculado apenas se houver 2+ falhas no perÃ­odo
- âœ… Falhas <5 minutos nÃ£o sÃ£o contabilizadas (consideradas "blips")
- âœ… Disponibilidade mÃ­nima aceitÃ¡vel: 99,5% (SLA padrÃ£o ANATEL)

---

### RN009 - RelatÃ³rio de Disponibilidade Mensal (% Uptime)

**DescriÃ§Ã£o:**
RelatÃ³rio mensal exibe o percentual de disponibilidade de cada tronco e compara com SLA contratado.

**Justificativa:**
Monitorar compliance com SLA e identificar operadoras com desempenho abaixo do esperado.

**ImplementaÃ§Ã£o:**
- CÃ¡lculo: Uptime % = (Total de Minutos - Minutos IndisponÃ­veis) / Total de Minutos Ã— 100
- SLA TÃ­pico: 99,9% (permite 43 minutos de downtime por mÃªs)
- Se uptime <SLA contratado â†’ gera crÃ©dito/desconto na fatura
- ComparaÃ§Ã£o com mÃªs anterior e mÃ©dia do ano

**Exemplo:**
```
RelatÃ³rio de Disponibilidade - Janeiro/2025 (31 dias = 44.640 minutos)

Tronco #1: SIP-VIVO-001
Minutos DisponÃ­veis: 44.635
Minutos IndisponÃ­veis: 5
Uptime: 99,99% â­â­â­â­â­
SLA Contratado: 99,9%
Status: âœ… ACIMA DO SLA (+0,09%)
CrÃ©dito: N/A (acima do esperado)

Tronco #2: E1-TIM-001
Minutos DisponÃ­veis: 44.520
Minutos IndisponÃ­veis: 120 (2 horas)
Uptime: 99,73% âš ï¸
SLA Contratado: 99,9%
Status: ğŸ”´ ABAIXO DO SLA (-0,17%)
CrÃ©dito Devido: R$ 240 (10% da mensalidade)
Falhas:
- 05/01 03:00-04:30 (90 min) - ManutenÃ§Ã£o programada da operadora
- 18/01 14:00-14:30 (30 min) - Falha nÃ£o programada

Tronco #3: E1-CLARO-001
Minutos DisponÃ­veis: 44.280
Minutos IndisponÃ­veis: 360 (6 horas)
Uptime: 99,19% ğŸ”´
SLA Contratado: 99,9%
Status: ğŸ”´ğŸ”´ CRÃTICO - ABAIXO DO SLA (-0,71%)
CrÃ©dito Devido: R$ 600 (25% da mensalidade)
AÃ§Ã£o Requerida: ReuniÃ£o com operadora + plano de aÃ§Ã£o
Falhas:
- 08/01 10:00-13:00 (180 min) - Problema de roteamento BGP
- 22/01 08:00-11:00 (180 min) - Falha de hardware no gateway

Resumo do MÃªs:
- 3 troncos monitorados
- 1 acima do SLA âœ…
- 1 abaixo do SLA âš ï¸
- 1 crÃ­tico (>0,5% abaixo) ğŸ”´
- Total de crÃ©ditos devidos: R$ 840

ComparaÃ§Ã£o com Dezembro/2024:
- SIP-VIVO-001: 99,99% (manteve)
- E1-TIM-001: 99,95% â†’ 99,73% (piora)
- E1-CLARO-001: 99,80% â†’ 99,19% (piora significativa)

MÃ©dia do Ano (Jan-Dez 2024):
- SIP-VIVO-001: 99,97% (consistente)
- E1-TIM-001: 99,88% (aceitÃ¡vel)
- E1-CLARO-001: 99,45% (tendÃªncia de piora)

RecomendaÃ§Ã£o EstratÃ©gica:
âš ï¸ Considerar substituir E1-CLARO-001 por tronco SIP alternativo
```

**ValidaÃ§Ãµes:**
- âœ… Downtime programado (manutenÃ§Ã£o) pode ser excluÃ­do do cÃ¡lculo (com notificaÃ§Ã£o prÃ©via >48h)
- âœ… CrÃ©dito sÃ³ aplicado se downtime >43 min (SLA 99,9%)
- âœ… RelatÃ³rio enviado automaticamente no dia 5 de cada mÃªs

---

### RN010 - IntegraÃ§Ã£o com PABX via API REST e SNMP

**DescriÃ§Ã£o:**
Sistema integra com PABX (Asterisk, FreePBX, Elastix, 3CX) via API REST e SNMP para controle de roteamento e coleta de mÃ©tricas.

**Justificativa:**
Permitir controle centralizado de troncos e automaÃ§Ã£o de failover/balanceamento.

**ImplementaÃ§Ã£o:**
- **API REST:** Controle de roteamento (add/remove/update routes)
- **SNMP:** Coleta de mÃ©tricas (chamadas ativas, status de troncos, QoS)
- Suporte a mÃºltiplos modelos de PABX:
  - Asterisk/FreePBX: AMI (Asterisk Manager Interface)
  - 3CX: Management API
  - Elastix: REST API
- AutenticaÃ§Ã£o: API Key + IP Whitelist

**Exemplo:**
```
IntegraÃ§Ã£o PABX - Asterisk/FreePBX

ConfiguraÃ§Ã£o:
- Endpoint: https://pabx.empresa.local:8443/api/v1
- AutenticaÃ§Ã£o: API Key (Bearer token)
- Whitelist: 192.168.1.100 (servidor IControlIT)

OperaÃ§Ã£o 1: Adicionar Tronco
Request:
POST /trunks
{
  "name": "SIP-VIVO-001",
  "type": "SIP",
  "host": "gateway.vivo.com.br",
  "username": "user@vivo",
  "password": "encrypted_password",
  "codec": "G.711a,G.729",
  "maxchannels": 30
}

Response: 201 Created
{
  "id": 123,
  "status": "active",
  "registered": true
}

OperaÃ§Ã£o 2: Atualizar Roteamento (Failover)
Request:
PUT /routes/outbound
{
  "pattern": "55119*",
  "trunk_priority": ["SIP-TIM-001", "SIP-VIVO-001"]
}

Response: 200 OK
{
  "updated": true,
  "active_calls_rerouted": 3
}

OperaÃ§Ã£o 3: Coletar MÃ©tricas via SNMP
OID: 1.3.6.1.4.1.12356.2.1.2 (Asterisk MIB)
GET: Chamadas Ativas = 45
GET: Canais DisponÃ­veis = 90
GET: Taxa de Erros = 0.5%
```

**ValidaÃ§Ãµes:**
- âœ… API deve responder em <500ms
- âœ… MudanÃ§as de roteamento devem ser aplicadas em <5 segundos
- âœ… SNMP timeout: 3 segundos

---

### RN011 - Dashboard de QoS em Tempo Real com GrÃ¡ficos HistÃ³ricos

**DescriÃ§Ã£o:**
Dashboard visual exibe mÃ©tricas de QoS (jitter, latÃªncia, packet loss, MOS) em tempo real e grÃ¡ficos histÃ³ricos (6h, 24h, 7d, 30d).

**Justificativa:**
Permitir monitoramento proativo da qualidade de voz e identificaÃ§Ã£o rÃ¡pida de degradaÃ§Ãµes.

**ImplementaÃ§Ã£o:**
- GrÃ¡ficos de linha (time series) com atualizaÃ§Ã£o automÃ¡tica (30s)
- Indicadores visuais de qualidade (verde/amarelo/vermelho)
- Drill-down para detalhes de cada tronco
- ExportaÃ§Ã£o de grÃ¡ficos (PNG, PDF)
- Alertas visuais quando mÃ©tricas excedem limites

**Exemplo:**
```
Dashboard de QoS - 15/01/2025 15:45

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VISÃƒO GERAL DE TODOS OS TRONCOS (Ãšltima Hora)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚ MOS Score (MÃ©dia):                                      â”‚
â”‚ 15:00 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 4.2 (Excelente)               â”‚
â”‚ 15:15 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 4.1 (Excelente)               â”‚
â”‚ 15:30 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 3.8 (Bom)                      â”‚
â”‚ 15:45 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 4.0 (Excelente)               â”‚
â”‚                                                         â”‚
â”‚ LatÃªncia (ms):                                          â”‚
â”‚ 15:00 â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 85ms  âœ…                       â”‚
â”‚ 15:15 â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 90ms  âœ…                       â”‚
â”‚ 15:30 â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘ 120ms âš ï¸                       â”‚
â”‚ 15:45 â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 95ms  âœ…                       â”‚
â”‚                                                         â”‚
â”‚ Packet Loss (%):                                        â”‚
â”‚ 15:00 â–‘â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 0.3%  âœ…                       â”‚
â”‚ 15:15 â–‘â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 0.5%  âœ…                       â”‚
â”‚ 15:30 â–‘â–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 2.1%  âš ï¸                       â”‚
â”‚ 15:45 â–‘â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 0.8%  âœ…                       â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Alerta Identificado Ã s 15:30:
âš ï¸ DegradaÃ§Ã£o temporÃ¡ria de qualidade
Causa: Pico de latÃªncia (120ms) e packet loss (2.1%)
Tronco Afetado: SIP-VIVO-001
DuraÃ§Ã£o: 3 minutos
AÃ§Ã£o: Monitoramento intensificado (polling 10s)
Status Atual: Normalizado
```

**ValidaÃ§Ãµes:**
- âœ… Dashboard atualizado a cada 30 segundos (SignalR)
- âœ… HistÃ³rico armazenado por 90 dias
- âœ… GrÃ¡ficos otimizados (agregaÃ§Ã£o de dados para perÃ­odos >7 dias)

---

### RN012 - Simulador de Economia com MigraÃ§Ã£o SIP vs E1

**DescriÃ§Ã£o:**
Ferramenta que calcula ROI de migraÃ§Ã£o de troncos E1 para SIP com base no uso real dos Ãºltimos 6 meses.

**Justificativa:**
Troncos SIP geralmente tÃªm custo menor e maior flexibilidade. Simular economia ajuda na tomada de decisÃ£o.

**ImplementaÃ§Ã£o:**
- AnÃ¡lise de uso dos Ãºltimos 6 meses
- ComparaÃ§Ã£o de custos:
  - E1: Custo fixo alto (R$ 80/canal), custo variÃ¡vel baixo (R$ 0,08/min)
  - SIP: Custo fixo baixo (R$ 30/canal), custo variÃ¡vel mÃ©dio (R$ 0,12/min)
- CÃ¡lculo de break-even point
- ProjeÃ§Ã£o de economia em 12, 24, 36 meses

**Exemplo:**
```
Simulador de MigraÃ§Ã£o E1 â†’ SIP - E1-TIM-001

Uso Atual (MÃ©dia 6 Meses):
- Capacidade: 30 canais E1
- UtilizaÃ§Ã£o MÃ©dia: 20 canais (67%)
- Minutos/mÃªs: 12.000 minutos

Custos Atuais (E1):
- Custo Fixo: R$ 2.400/mÃªs (30 canais Ã— R$ 80)
- Custo VariÃ¡vel: R$ 960/mÃªs (12.000 min Ã— R$ 0,08)
- Total Mensal: R$ 3.360

Custos Projetados (SIP):
- Capacidade Recomendada: 25 canais (20 uso + 5 margem)
- Custo Fixo: R$ 750/mÃªs (25 canais Ã— R$ 30)
- Custo VariÃ¡vel: R$ 1.440/mÃªs (12.000 min Ã— R$ 0,12)
- Total Mensal: R$ 2.190

Economia Mensal: R$ 1.170 (35% de reduÃ§Ã£o) âœ…
Economia Anual: R$ 14.040

Investimento Inicial:
- Gateway SIP: R$ 3.500 (one-time)
- MigraÃ§Ã£o/InstalaÃ§Ã£o: R$ 1.500 (one-time)
- Total Investimento: R$ 5.000

Break-Even Point:
Meses para ROI: 5.000 / 1.170 = 4,3 meses âœ…

ProjeÃ§Ã£o de Economia:
- 12 meses: R$ 14.040 - R$ 5.000 = R$ 9.040 lucro
- 24 meses: R$ 28.080 - R$ 5.000 = R$ 23.080 lucro
- 36 meses: R$ 42.120 - R$ 5.000 = R$ 37.120 lucro

RecomendaÃ§Ã£o Final:
ğŸ“Š MIGRAR PARA SIP
- ROI positivo em 4,3 meses
- Economia de 35% ao ano
- Maior flexibilidade (escalar canais sob demanda)
- Melhor QoS (SIP tem MOS mÃ©dio 0,3 pontos maior)

Riscos Considerados:
âš ï¸ Depende de internet estÃ¡vel (contratar link redundante)
âš ï¸ MigraÃ§Ã£o requer 2h de janela de manutenÃ§Ã£o
```

**ValidaÃ§Ãµes:**
- âœ… SimulaÃ§Ã£o requer mÃ­nimo 6 meses de histÃ³rico
- âœ… Custos de operadoras devem estar atualizados (<90 dias)
- âœ… RecomendaÃ§Ã£o sÃ³ se ROI <12 meses

---

### RN013 - DetecÃ§Ã£o de Loops e Chamadas AnÃ´malas

**DescriÃ§Ã£o:**
Sistema detecta padrÃµes de chamadas anÃ´malas que indicam problemas de configuraÃ§Ã£o ou tentativas de fraude.

**Justificativa:**
Evitar custos elevados com loops de chamada, chamadas de teste mal configuradas ou fraudes.

**ImplementaÃ§Ã£o:**
- DetecÃ§Ã£o de loops: >10 chamadas para mesmo nÃºmero em <5 minutos
- DetecÃ§Ã£o de fraude: Chamadas DDI para paÃ­ses de alto risco (Cuba, SomÃ¡lia, etc.)
- DetecÃ§Ã£o de teste: Chamadas com duraÃ§Ã£o <3 segundos em sequÃªncia
- Bloqueio automÃ¡tico + alerta + registro de auditoria

**Exemplo:**
```
DetecÃ§Ã£o de Anomalia - 15/01/2025 16:00

PadrÃ£o Detectado: LOOP DE CHAMADAS
Tronco: SIP-VIVO-001
Ramal Origem: 5678 (Sala de ReuniÃ£o - Andar 3)
NÃºmero Destino: +5511555500001 (0800 Suporte TÃ©cnico)

Timeline:
16:00:05 - Chamada #1 (duraÃ§Ã£o: 2s, desconectada)
16:00:15 - Chamada #2 (duraÃ§Ã£o: 2s, desconectada)
16:00:25 - Chamada #3 (duraÃ§Ã£o: 2s, desconectada)
...
16:04:55 - Chamada #30 (duraÃ§Ã£o: 2s, desconectada)

AnÃ¡lise:
- 30 chamadas em 5 minutos (mÃ©dia 1 a cada 10s) ğŸ”´
- Todas com duraÃ§Ã£o <3s (indicativo de falha) ğŸ”´
- Mesmo par origem-destino (indicativo de loop) ğŸ”´
- Custo estimado: R$ 0 (0800 gratuito, mas consome recursos)

DiagnÃ³stico AutomÃ¡tico:
âš ï¸ LOOP DE CHAMADA DETECTADO
Causa ProvÃ¡vel: ConfiguraÃ§Ã£o incorreta de URA
HipÃ³tese: URA estÃ¡ redirecionando para si mesma

AÃ§Ã£o AutomÃ¡tica:
1. Bloquear ramal 5678 temporariamente âœ…
2. Notificar equipe de TI (SMS + E-mail) âœ…
3. Criar ticket de suporte automÃ¡tico #45678 âœ…
4. Registrar na auditoria âœ…

E-mail Enviado:
Assunto: ALERTA: Loop de Chamadas Detectado - Ramal 5678
Prioridade: Alta
Ramal bloqueado preventivamente. Investigar configuraÃ§Ã£o da URA.
Custo evitado com bloqueio: R$ 0 (0800), mas economizou recursos do tronco.
```

**ValidaÃ§Ãµes:**
- âœ… Loop detectado se >10 chamadas iguais em <5 minutos
- âœ… Bloqueio automÃ¡tico apenas se score de anomalia >85
- âœ… Desbloqueio automÃ¡tico apÃ³s investigaÃ§Ã£o (requer aprovaÃ§Ã£o)

---

### RN014 - AnÃ¡lise Comparativa de Custos por Tecnologia

**DescriÃ§Ã£o:**
RelatÃ³rio compara custos totais (TCO - Total Cost of Ownership) de troncos E1, SIP e analÃ³gicos ao longo de 3 anos.

**Justificativa:**
Auxiliar na decisÃ£o estratÃ©gica de qual tecnologia priorizar em novos investimentos.

**ImplementaÃ§Ã£o:**
- CÃ¡lculo de TCO incluindo:
  - Custo de aquisiÃ§Ã£o (hardware, instalaÃ§Ã£o)
  - Custo operacional (mensalidade, manutenÃ§Ã£o)
  - Custo variÃ¡vel (minutos de chamada)
  - Custo de suporte (tÃ©cnico, treinamento)
- ComparaÃ§Ã£o side-by-side de 3 tecnologias
- RecomendaÃ§Ã£o estratÃ©gica

**Exemplo:**
```
AnÃ¡lise Comparativa de TCO - 30 Canais (3 Anos)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TECNOLOGIA 1: E1/R2                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Custo Inicial:                                           â”‚
â”‚ - Gateway E1: R$ 8.000                                   â”‚
â”‚ - InstalaÃ§Ã£o: R$ 2.000                                   â”‚
â”‚ Total Inicial: R$ 10.000                                 â”‚
â”‚                                                          â”‚
â”‚ Custo Mensal:                                            â”‚
â”‚ - Assinatura: R$ 2.400 (30 canais Ã— R$ 80)              â”‚
â”‚ - Minutos: R$ 960 (12.000 min Ã— R$ 0,08)                â”‚
â”‚ - ManutenÃ§Ã£o: R$ 200                                     â”‚
â”‚ Total Mensal: R$ 3.560                                   â”‚
â”‚                                                          â”‚
â”‚ TCO 3 Anos:                                              â”‚
â”‚ - Inicial: R$ 10.000                                     â”‚
â”‚ - 36 meses: R$ 128.160 (36 Ã— R$ 3.560)                  â”‚
â”‚ - Total: R$ 138.160                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TECNOLOGIA 2: SIP                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Custo Inicial:                                           â”‚
â”‚ - Gateway SIP: R$ 3.500                                  â”‚
â”‚ - InstalaÃ§Ã£o: R$ 1.500                                   â”‚
â”‚ Total Inicial: R$ 5.000                                  â”‚
â”‚                                                          â”‚
â”‚ Custo Mensal:                                            â”‚
â”‚ - Assinatura: R$ 750 (25 canais Ã— R$ 30)                â”‚
â”‚ - Minutos: R$ 1.440 (12.000 min Ã— R$ 0,12)              â”‚
â”‚ - Link Redundante: R$ 300                                â”‚
â”‚ - ManutenÃ§Ã£o: R$ 100                                     â”‚
â”‚ Total Mensal: R$ 2.590                                   â”‚
â”‚                                                          â”‚
â”‚ TCO 3 Anos:                                              â”‚
â”‚ - Inicial: R$ 5.000                                      â”‚
â”‚ - 36 meses: R$ 93.240 (36 Ã— R$ 2.590)                   â”‚
â”‚ - Total: R$ 98.240 â­ MENOR CUSTO                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TECNOLOGIA 3: ANALÃ“GICO                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Custo Inicial:                                           â”‚
â”‚ - 30 Linhas AnalÃ³gicas: R$ 0 (fornecido por operadora)  â”‚
â”‚ - InstalaÃ§Ã£o: R$ 3.000 (cabeamento)                     â”‚
â”‚ Total Inicial: R$ 3.000                                  â”‚
â”‚                                                          â”‚
â”‚ Custo Mensal:                                            â”‚
â”‚ - Assinatura: R$ 1.800 (30 linhas Ã— R$ 60)              â”‚
â”‚ - Minutos: R$ 2.400 (12.000 min Ã— R$ 0,20)              â”‚
â”‚ - ManutenÃ§Ã£o: R$ 400 (maior por ser sistema antigo)     â”‚
â”‚ Total Mensal: R$ 4.600                                   â”‚
â”‚                                                          â”‚
â”‚ TCO 3 Anos:                                              â”‚
â”‚ - Inicial: R$ 3.000                                      â”‚
â”‚ - 36 meses: R$ 165.600 (36 Ã— R$ 4.600)                  â”‚
â”‚ - Total: R$ 168.600 âš ï¸ MAIOR CUSTO                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Resumo Comparativo (3 Anos):
1. SIP: R$ 98.240 (100% baseline) â­ RECOMENDADO
2. E1/R2: R$ 138.160 (+41% vs SIP)
3. AnalÃ³gico: R$ 168.600 (+72% vs SIP)

Economia ao escolher SIP vs E1: R$ 39.920 em 3 anos
Economia ao escolher SIP vs AnalÃ³gico: R$ 70.360 em 3 anos

RecomendaÃ§Ã£o Final:
ğŸ“Š INVESTIR EM SIP
- Menor TCO (41% mais econÃ´mico que E1)
- Flexibilidade (escalar sob demanda)
- Qualidade superior (MOS mÃ©dio 4.2 vs 3.8 do E1)
- Tecnologia moderna (suporte de longo prazo)

Ressalvas:
- E1 ainda Ã© vÃ¡lido para locais sem internet estÃ¡vel
- AnalÃ³gico apenas para sistemas legados (descontinuar gradualmente)
```

**ValidaÃ§Ãµes:**
- âœ… TCO calculado para perÃ­odos de 1, 3 e 5 anos
- âœ… Custos atualizados trimestralmente
- âœ… Considerar inflaÃ§Ã£o (IPCA) na projeÃ§Ã£o

---

### RN015 - IntegraÃ§Ã£o com Sistema de Bilhetes (RF039)

**DescriÃ§Ã£o:**
Sistema de gestÃ£o de troncos integra automaticamente com a gestÃ£o de bilhetes telefÃ´nicos para anÃ¡lise cruzada de dados.

**Justificativa:**
Correlacionar qualidade de troncos com custos de bilhetes para anÃ¡lise completa de telefonia.

**ImplementaÃ§Ã£o:**
- Ao processar bilhete, identifica qual tronco foi utilizado
- Associa custo do bilhete ao tronco correspondente
- Permite anÃ¡lise:
  - Custo total por tronco (fixo + variÃ¡vel + bilhetes)
  - CorrelaÃ§Ã£o QoS do tronco vs reclamaÃ§Ãµes de qualidade nos bilhetes
  - ROI de cada tronco (custo vs uso)

**Exemplo:**
```
AnÃ¡lise Integrada Troncos + Bilhetes - Janeiro/2025

Tronco: SIP-VIVO-001
QoS MÃ©dio (MOS): 4.2 (Excelente)
Disponibilidade: 99,99%
Custo Fixo: R$ 900/mÃªs (30 canais Ã— R$ 30)

Bilhetes Associados: 3.456 chamadas
Minutos Totais: 12.450 min
Custo VariÃ¡vel (bilhetes): R$ 1.245 (12.450 min Ã— R$ 0,10)

Custo Total: R$ 2.145 (fixo + variÃ¡vel)
Custo/Minuto: R$ 0,172
Custo/Chamada: R$ 0,62

AnÃ¡lise de Valor:
â­â­â­â­â­ Excelente custo-benefÃ­cio
- QoS top tier (MOS 4.2)
- Custo competitivo (R$ 0,172/min)
- Alta disponibilidade (99,99%)

ComparaÃ§Ã£o com Outros Troncos:
1. SIP-VIVO-001: R$ 0,172/min | MOS 4.2 â­ MELHOR
2. E1-TIM-001: R$ 0,215/min | MOS 3.9
3. E1-CLARO-001: R$ 0,198/min | MOS 3.7

RecomendaÃ§Ã£o:
ğŸ“ˆ Aumentar capacidade do SIP-VIVO-001 (melhor ROI)
ğŸ“‰ Reduzir E1-TIM-001 (custo maior, qualidade menor)
```

**ValidaÃ§Ãµes:**
- âœ… AssociaÃ§Ã£o tronco-bilhete deve ser precisa (CDR matching)
- âœ… AnÃ¡lise cruzada executada diariamente
- âœ… Dados sincronizados entre RF040 e RF039

---

## SEÃ‡ÃƒO 3: REFERÃŠNCIAS AO LEGADO

### 3.1 PÃ¡ginas e Componentes do Sistema Legado

**NÃ£o identificado sistema legado especÃ­fico de gestÃ£o de troncos.**

O sistema legado IControlIT nÃ£o possui mÃ³dulo dedicado de gestÃ£o de troncos telefÃ´nicos. O controle era feito atravÃ©s de:
- ConfiguraÃ§Ã£o manual no PABX (Asterisk CLI)
- Planilhas Excel para controle de custos
- Monitoramento manual de disponibilidade (verificaÃ§Ã£o periÃ³dica)
- Sem mÃ©tricas de QoS automatizadas

### 3.2 Funcionalidades Identificadas no Legado

NÃ£o aplicÃ¡vel - funcionalidade inexistente no sistema legado.

### 3.3 Pontos de Melhoria Identificados

1. **Monitoramento manual** â†’ AutomaÃ§Ã£o com polling 30s
2. **Sem mÃ©tricas de QoS** â†’ Jitter, latÃªncia, packet loss, MOS em tempo real
3. **Failover manual** â†’ Failover automÃ¡tico <5 segundos
4. **Sem balanceamento** â†’ Algoritmo Least Call Count
5. **Custeio simplificado** â†’ TCO completo com rateio detalhado
6. **Sem alertas** â†’ Alertas escalonados proativos
7. **Sem anÃ¡lise comparativa** â†’ Simulador de economia SIP vs E1

---

## SEÃ‡ÃƒO 4: BANCO DE DADOS LEGADO

### 4.1 Estrutura Original

**NÃ£o aplicÃ¡vel** - funcionalidade inexistente no sistema legado.

---

## SEÃ‡ÃƒO 5: INTEGRAÃ‡Ã•ES OBRIGATÃ“RIAS

### 5.1 Central de Funcionalidades

**Registro da Feature:**
```json
{
  "codigoFuncionalidade": "GES.TRONCOS",
  "nome": "GestÃ£o de Troncos TelefÃ´nicos",
  "descricao": "Gerenciamento completo de troncos com monitoramento de QoS e failover automÃ¡tico",
  "modulo": "GestÃ£o",
  "categoria": "Telecom e Infraestrutura",
  "status": "Ativo",
  "permissoesRequeridas": [
    "GES.TRONCOS.VISUALIZAR",
    "GES.TRONCOS.CONFIGURAR",
    "GES.TRONCOS.MONITORAR",
    "GES.TRONCOS.DASHBOARD",
    "GES.TRONCOS.RELATORIOS"
  ]
}
```

---

### 5.2 InternacionalizaÃ§Ã£o (i18n)

**Chaves de TraduÃ§Ã£o ObrigatÃ³rias:**

```json
{
  "troncos.title": "GestÃ£o de Troncos",
  "troncos.dashboard.title": "Dashboard de Monitoramento",
  "troncos.qos.title": "MÃ©tricas de Qualidade (QoS)",

  "troncos.fields.nome": "Nome do Tronco",
  "troncos.fields.tipo": "Tipo",
  "troncos.fields.capacidade": "Capacidade (Canais)",
  "troncos.fields.status": "Status",
  "troncos.fields.utilizacao": "UtilizaÃ§Ã£o",
  "troncos.fields.mos": "MOS Score",
  "troncos.fields.latencia": "LatÃªncia (ms)",
  "troncos.fields.jitter": "Jitter (ms)",
  "troncos.fields.packetLoss": "Packet Loss (%)",

  "troncos.tipo.sip": "SIP",
  "troncos.tipo.e1": "E1/R2",
  "troncos.tipo.analogico": "AnalÃ³gico",

  "troncos.status.disponivel": "DisponÃ­vel",
  "troncos.status.ocupado": "Ocupado",
  "troncos.status.indisponivel": "IndisponÃ­vel",
  "troncos.status.congestionado": "Congestionado",

  "troncos.alert.falha": "Falha Detectada no Tronco",
  "troncos.alert.failover": "Failover AutomÃ¡tico Executado",
  "troncos.alert.congestionamento": "Congestionamento Detectado",
  "troncos.alert.qosDegradado": "Qualidade de ServiÃ§o Degradada",

  "troncos.success.failover": "Failover executado com sucesso para tronco {backupName}",
  "troncos.success.roteamentoAtualizado": "Roteamento atualizado no PABX com sucesso"
}
```

---

### 5.3 Auditoria

**OperaÃ§Ãµes Auditadas:**

1. **ConfiguraÃ§Ã£o de Troncos** (criar, editar, inativar)
2. **Eventos de Failover** (timestamp, tronco origem, tronco destino, duraÃ§Ã£o)
3. **AlteraÃ§Ãµes de Roteamento** (regra anterior, regra nova, responsÃ¡vel)
4. **DetecÃ§Ã£o de Falhas** (tipo de falha, duraÃ§Ã£o, impacto)
5. **Bloqueios de Tronco** (motivo, duraÃ§Ã£o, responsÃ¡vel)

**RetenÃ§Ã£o:** 5 anos

---

### 5.4 Controle de Acesso (RBAC)

**Matriz de PermissÃµes:**

| PermissÃ£o | DescriÃ§Ã£o | Roles PadrÃ£o |
|-----------|-----------|--------------|
| `GES.TRONCOS.VISUALIZAR` | Visualizar status de troncos | Analista TI, Gerente TI |
| `GES.TRONCOS.CONFIGURAR` | Configurar troncos e roteamento | Gerente TI, Administrador |
| `GES.TRONCOS.MONITORAR` | Acessar dashboard de monitoramento | Analista TI, NOC |
| `GES.TRONCOS.DASHBOARD` | Acessar dashboard de QoS | Gerente TI, Diretor TI |
| `GES.TRONCOS.RELATORIOS` | Gerar relatÃ³rios gerenciais | Gerente TI, Financeiro |
| `GES.TRONCOS.FAILOVER_MANUAL` | Executar failover manual | NOC, Administrador |

---

## SEÃ‡ÃƒO 6: ANEXOS E REFERÃŠNCIAS

### 6.1 Casos de Uso Relacionados

1. **UC-RF040-00** - Listar Troncos
2. **UC-RF040-01** - Criar ConfiguraÃ§Ã£o de Tronco
3. **UC-RF040-02** - Visualizar Dashboard de Monitoramento
4. **UC-RF040-03** - Executar Failover Manual
5. **UC-RF040-04** - Gerar RelatÃ³rio de Disponibilidade
6. **UC-RF040-05** - Configurar Alertas de QoS
7. **UC-RF040-06** - Simular MigraÃ§Ã£o SIP vs E1
8. **UC-RF040-07** - Analisar TCO por Tecnologia
9. **UC-RF040-08** - Visualizar MÃ©tricas de QoS HistÃ³ricas

---

**Fim do RF040 - GestÃ£o de Troncos**

**Total de linhas:** ~750
**Total de regras de negÃ³cio:** 15
**SeÃ§Ãµes obrigatÃ³rias:** 5/5 âœ…
**IntegraÃ§Ãµes obrigatÃ³rias:** 4/4 âœ…

**PrÃ³ximos Passos:**
1. Commit consolidado do Lote 3 (RF036-RF040)
2. Gerar relatÃ³rio final do Lote 3
