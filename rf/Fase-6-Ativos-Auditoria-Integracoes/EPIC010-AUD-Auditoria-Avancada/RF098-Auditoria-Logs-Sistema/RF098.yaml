# RF098.yaml - Auditoria e Logs do Sistema
# Versão: 2.0
# Data: 2025-12-31
# Autor: Agência ALC - alc.dev.br

rf_id: RF098
titulo: "Auditoria e Logs do Sistema"
versao: "2.0"
data: "2025-12-31"
autor: "Agência ALC - alc.dev.br"

epic: "EPIC010-AUD-Auditoria-Avancada"
fase: "Fase 6 - Ativos, Auditoria e Integrações"
status: "Documentação v2.0 Completa"

# SEÇÃO 1: VISÃO GERAL
visao_geral:
  resumo_executivo: |
    O RF-098 – Auditoria e Logs do Sistema estabelece o framework completo de logging,
    monitoramento e auditoria operacional do IControlIT v2. Este requisito define como todos
    os eventos, erros, acessos e operações críticas devem ser registrados, consultados,
    exportados e analisados para garantir rastreabilidade, conformidade regulatória (LGPD,
    ISO 27001) e suporte técnico eficaz.

  objetivo_principal: |
    Prover um sistema robusto de auditoria e logging que permita:
    - Rastreabilidade completa de todas as operações (quem, quando, o quê, onde)
    - Detecção proativa de erros e anomalias através de alertas automáticos
    - Investigação eficaz de incidentes com busca avançada e correlação de eventos
    - Conformidade com regulamentações de privacidade e segurança
    - Análise de performance e comportamento do sistema
    - Exportação de evidências para auditorias externas

  escopo:
    incluido:
      - Logging estruturado de todos os eventos da aplicação
      - Auditoria automática de operações CRUD
      - Rastreamento de acessos e autenticações
      - Registro de erros e exceções com stack trace
      - Monitoramento de performance (tempo de resposta, throughput)
      - Interface de busca avançada com filtros dinâmicos
      - Exportação de logs (CSV, JSON, Excel)
      - Alertas automáticos para eventos críticos
      - Integração com Application Insights
      - Dashboard de monitoramento em tempo real
      - Retenção de logs configurável por severidade
      - Correlação de eventos por CorrelationId

    nao_incluido:
      - Auditoria de mudanças de dados de negócio (coberta por AuditInterceptor - RF-002)
      - Logs de aplicações externas fora do IControlIT
      - SIEM (Security Information and Event Management) - integração futura
      - Análise de logs com Machine Learning - funcionalidade futura

# SEÇÃO 2: FUNCIONALIDADES
funcionalidades:
  - id: "F-001"
    nome: "Logging Estruturado Automático"
    prioridade: "CRÍTICA"
    descricao: "Todos os componentes da aplicação (Controllers, Services, Middlewares, Handlers) devem registrar logs estruturados com contexto completo (usuário, empresa, IP, timestamp, CorrelationId)."

  - id: "F-002"
    nome: "Busca Avançada de Logs"
    prioridade: "ALTA"
    descricao: "Interface de busca com filtros dinâmicos: período, severidade, módulo, usuário, empresa, IP, CorrelationId, texto livre. Suporte a operadores lógicos (AND, OR, NOT)."

  - id: "F-003"
    nome: "Exportação de Logs"
    prioridade: "ALTA"
    descricao: "Exportar logs filtrados em múltiplos formatos (CSV, JSON, Excel) para auditorias externas, análises offline ou compartilhamento com equipes de suporte."

  - id: "F-004"
    nome: "Dashboard de Monitoramento"
    prioridade: "ALTA"
    descricao: "Dashboard em tempo real exibindo: total de eventos por severidade (últimas 24h), top 10 erros, gráfico de eventos ao longo do tempo, status de integração com Application Insights."

  - id: "F-005"
    nome: "Alertas Automáticos"
    prioridade: "CRÍTICA"
    descricao: "Sistema de alertas configuráveis para eventos críticos: taxa de erro > 5%, latência > SLO, falhas de autenticação consecutivas, exceptions não tratadas."

  - id: "F-006"
    nome: "Rastreamento de Performance"
    prioridade: "MÉDIA"
    descricao: "Registrar tempo de execução de operações críticas (queries, APIs externas, processamentos em lote) e alertar quando ultrapassar limites configurados."

  - id: "F-007"
    nome: "Correlação de Eventos"
    prioridade: "ALTA"
    descricao: "Permitir rastrear uma requisição completa (frontend → backend → database → APIs externas) através de um CorrelationId único, facilitando investigação de problemas."

  - id: "F-008"
    nome: "Retenção Configurável de Logs"
    prioridade: "MÉDIA"
    descricao: "Definir períodos de retenção diferentes por severidade: Critical (365 dias), Error (180 dias), Warning (90 dias), Information (30 dias), Debug/Trace (7 dias)."

# SEÇÃO 3: REGRAS DE NEGÓCIO
regras_negocio:
  - id: "RN-RF098-001"
    titulo: "Níveis de Severidade Obrigatórios"
    descricao: "O sistema DEVE suportar 6 níveis de severidade de logs conforme padrão Serilog/Application Insights: Trace, Debug, Information, Warning, Error, Critical."
    criticidade: "CRÍTICA"
    tipo: "funcional"
    campos_afetados: ["Severidade", "LogGeral.Severidade", "LogSeguranca.Severidade"]
    obrigatorio: true
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "enum"
      mensagem_erro: "Severidade inválida"
      http_code: 400
      detalhes:
        - "Backend: Configurar Serilog com todos os 6 níveis"
        - "API: Endpoints devem validar severidade em filtros"
        - "Database: Enum LogSeverity com todos os níveis"
        - "UI: Dropdown de filtro deve exibir todos os níveis"

  - id: "RN-RF098-002"
    titulo: "Contexto Obrigatório em Todos os Logs"
    descricao: "TODO log DEVE conter contexto mínimo: Timestamp (ISO 8601), Severidade, Mensagem, CorrelationId, Módulo/Namespace, EmpresaId (quando aplicável), UsuarioId (quando aplicável), IP do cliente."
    criticidade: "CRÍTICA"
    tipo: "funcional"
    campos_afetados: ["Timestamp", "Severidade", "Mensagem", "CorrelationId", "Modulo", "EmpresaId", "UsuarioId", "IpAddress"]
    obrigatorio: true
    implementacao:
      backend: true
      frontend: false
      validacao_api: true
      validacao_ui: false
    validacao:
      tipo: "estrutura"
      mensagem_erro: "Contexto de log incompleto"
      http_code: 500
      detalhes:
        - "Backend: Middleware deve enriquecer contexto automaticamente"
        - "API: Logs sem contexto mínimo devem gerar alerta"
        - "Auditoria: Verificar presença de campos obrigatórios em 100% dos logs"

  - id: "RN-RF098-003"
    titulo: "CorrelationId Único Por Requisição"
    descricao: "Cada requisição HTTP DEVE ter um CorrelationId único (GUID) gerado no entry point e propagado para todas as camadas (frontend, backend, APIs externas, banco de dados)."
    criticidade: "ALTA"
    tipo: "funcional"
    campos_afetados: ["CorrelationId"]
    obrigatorio: true
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: false
    validacao:
      tipo: "guid"
      mensagem_erro: "CorrelationId inválido"
      http_code: 400
      detalhes:
        - "Backend: Middleware de correlação deve injetar CorrelationId no HttpContext"
        - "API: Header X-Correlation-Id deve ser retornado em todas as respostas"
        - "Logs: Todos os logs de uma requisição devem compartilhar o mesmo CorrelationId"
        - "Frontend: Incluir CorrelationId em todas as chamadas HTTP"

  - id: "RN-RF098-004"
    titulo: "Retenção Diferenciada Por Severidade"
    descricao: "Logs devem ter retenção diferenciada conforme severidade para otimizar armazenamento e atender regulamentações: Critical (365 dias), Error (180 dias), Warning (90 dias), Information (30 dias), Debug (7 dias), Trace (7 dias)."
    criticidade: "MÉDIA"
    tipo: "configuracao"
    campos_afetados: ["Timestamp", "Severidade"]
    obrigatorio: true
    implementacao:
      backend: true
      frontend: false
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "periodo"
      mensagem_erro: null
      http_code: null
      detalhes:
        - "Backend: Job diário de limpeza de logs expirados"
        - "Database: Index em (Timestamp, Severidade) para otimizar limpeza"
        - "Configuração: Períodos de retenção configuráveis via SistemaConfiguracaoGeral"

  - id: "RN-RF098-005"
    titulo: "Sanitização de Dados Sensíveis"
    descricao: "Logs NUNCA devem conter dados sensíveis em texto claro: senhas, tokens, CPF completo, dados de cartão de crédito, credenciais de APIs externas."
    criticidade: "CRÍTICA"
    tipo: "seguranca"
    campos_afetados: ["Mensagem", "Contexto", "Exception"]
    obrigatorio: true
    implementacao:
      backend: true
      frontend: false
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "sanitizacao"
      mensagem_erro: null
      http_code: null
      detalhes:
        - "Backend: Sanitizer automático deve mascarar campos sensíveis antes de logar"
        - "Auditoria: Scan periódico de logs para detectar vazamento de dados sensíveis"
        - "Code Review: Regra de linter para detectar logs de campos sensíveis"
        - "Exemplos: CPF 123.456.789-00 → ***.***. 789-**, Senha senha123 → [REDACTED]"

  - id: "RN-RF098-006"
    titulo: "Stack Trace Completo Para Exceções"
    descricao: "Logs de severidade Error ou Critical que registrem exceções DEVEM incluir stack trace completo, inner exceptions (até 3 níveis), e contexto da operação que falhou."
    criticidade: "ALTA"
    tipo: "funcional"
    campos_afetados: ["Exception", "StackTrace", "InnerException"]
    obrigatorio: true
    implementacao:
      backend: true
      frontend: false
      validacao_api: false
      validacao_ui: true
    validacao:
      tipo: "estrutura"
      mensagem_erro: null
      http_code: null
      detalhes:
        - "Backend: Método de logging deve capturar exception.ToString() completo"
        - "API: Endpoint de detalhes de log deve exibir stack trace formatado"
        - "UI: Exibir stack trace em modal colapsável (não inline)"

  - id: "RN-RF098-007"
    titulo: "Integração Obrigatória com Application Insights"
    descricao: "TODOS os logs DEVEM ser enviados para Application Insights (além do armazenamento local) para monitoramento em tempo real, alertas inteligentes e análise histórica."
    criticidade: "ALTA"
    tipo: "integracao"
    campos_afetados: []
    obrigatorio: true
    implementacao:
      backend: true
      frontend: false
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "integracao"
      mensagem_erro: "Falha ao enviar log para Application Insights"
      http_code: null
      detalhes:
        - "Backend: Serilog Sink configurado para Application Insights"
        - "Configuração: Instrumentation Key em appsettings.json"
        - "Monitoramento: Verificar latência de envio < 5 segundos"
        - "Fallback: Se Application Insights estiver indisponível, logar localmente sem bloquear operação"

  - id: "RN-RF098-008"
    titulo: "Busca Performática em Grandes Volumes"
    descricao: "Busca de logs DEVE retornar resultados em menos de 2 segundos mesmo com mais de 1 milhão de registros. Usar paginação (máximo 100 registros por página) e índices otimizados."
    criticidade: "ALTA"
    tipo: "performance"
    campos_afetados: []
    obrigatorio: true
    implementacao:
      backend: true
      frontend: false
      validacao_api: true
      validacao_ui: false
    validacao:
      tipo: "performance"
      mensagem_erro: "Busca de logs excedeu tempo limite"
      http_code: 504
      detalhes:
        - "Database: Índices em (Timestamp DESC, Severidade, EmpresaId, UsuarioId)"
        - "API: Query deve incluir LIMIT e OFFSET obrigatoriamente"
        - "Performance: Teste de carga com 1M+ registros deve retornar < 2s"
        - "Cache: Queries idênticas em menos de 5 minutos devem retornar cache"

  - id: "RN-RF098-009"
    titulo: "Alertas Configuráveis Por Regra"
    descricao: "Sistema DEVE permitir configurar alertas personalizados com condições dinâmicas: Se taxa de erro > 5% em 10 minutos, enviar email para equipe de suporte."
    criticidade: "MÉDIA"
    tipo: "funcional"
    campos_afetados: ["AlertaConfiguracao"]
    obrigatorio: true
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "regra"
      mensagem_erro: "Regra de alerta inválida"
      http_code: 400
      detalhes:
        - "Backend: Engine de regras de alertas deve avaliar condições a cada 1 minuto"
        - "Database: Tabela AlertaConfiguracao com campos: Condicao, Destinatarios, Cooldown"
        - "Notificação: Suportar múltiplos canais (email, webhook, notificação in-app)"
        - "Cooldown: Evitar spam de alertas (mínimo 5 minutos entre alertas da mesma regra)"

  - id: "RN-RF098-010"
    titulo: "Exportação com Limite de Volume"
    descricao: "Exportação de logs DEVE ter limite de 10.000 registros por operação para evitar sobrecarga de memória e timeout. Para volumes maiores, sugerir filtros mais restritivos ou exportação em lote."
    criticidade: "MÉDIA"
    tipo: "funcional"
    campos_afetados: []
    obrigatorio: true
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "limite"
      mensagem_erro: "Limite de 10.000 registros excedido. Refine os filtros."
      http_code: 400
      detalhes:
        - "API: Endpoint de exportação deve validar quantidade ANTES de processar"
        - "UI: Exibir warning se filtro retornar > 10.000 registros"
        - "Backend: Se exceder limite, retornar HTTP 400 com mensagem clara"
        - "Alternativa: Oferecer agendamento de exportação assíncrona (Hangfire)"

  - id: "RN-RF098-011"
    titulo: "Auditoria de Acessos a Logs"
    descricao: "Toda consulta de logs DEVE ser auditada (quem consultou, quando, quais filtros utilizou) para rastreabilidade de investigações e conformidade LGPD."
    criticidade: "ALTA"
    tipo: "auditoria"
    campos_afetados: ["LogAcessoAuditoria"]
    obrigatorio: true
    implementacao:
      backend: true
      frontend: false
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "auditoria"
      mensagem_erro: null
      http_code: null
      detalhes:
        - "Backend: Criar registro de auditoria ANTES de retornar logs"
        - "Database: Tabela LogAcessoAuditoria com campos: UsuarioId, Timestamp, Filtros, TotalRegistrosRetornados"
        - "RBAC: Apenas usuários com permissão AUD.LOGS.AUDITORIA_ACESSO podem consultar auditoria de acessos"

  - id: "RN-RF098-012"
    titulo: "Multi-Tenancy Estrito"
    descricao: "Usuários DEVEM visualizar apenas logs da(s) empresa(s) às quais têm acesso. Super Admin pode visualizar logs de todas as empresas. Developer pode visualizar logs técnicos sem EmpresaId (logs de sistema)."
    criticidade: "CRÍTICA"
    tipo: "multi_tenancy"
    campos_afetados: ["EmpresaId"]
    obrigatorio: true
    implementacao:
      backend: true
      frontend: false
      validacao_api: true
      validacao_ui: false
    validacao:
      tipo: "acesso"
      mensagem_erro: "Acesso negado: logs de outra empresa"
      http_code: 403
      detalhes:
        - "Backend: Query de logs deve SEMPRE incluir filtro WHERE EmpresaId IN (empresasDoUsuario)"
        - "API: Validar permissão de acesso à empresa ANTES de retornar logs"
        - "Exception: Logs com EmpresaId = NULL (logs de sistema) só acessíveis por Developer/Super Admin"

  - id: "RN-RF098-013"
    titulo: "Logs de Performance com Thresholds"
    descricao: "Operações críticas DEVEM registrar tempo de execução. Se ultrapassar threshold configurado (ex: query > 1s), logar com severidade Warning. Se ultrapassar threshold crítico (query > 5s), logar com severidade Error."
    criticidade: "MÉDIA"
    tipo: "performance"
    campos_afetados: ["DurationMs", "Severidade"]
    obrigatorio: true
    implementacao:
      backend: true
      frontend: false
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "threshold"
      mensagem_erro: null
      http_code: null
      detalhes:
        - "Backend: Decorator/Middleware de performance deve medir tempo automaticamente"
        - "Configuração: Thresholds configuráveis por tipo de operação (Query, API, Job)"
        - "Dashboard: Exibir top 10 operações mais lentas"

  - id: "RN-RF098-014"
    titulo: "Versionamento de Estrutura de Logs"
    descricao: "Logs DEVEM incluir campo SchemaVersion para permitir evolução da estrutura sem quebrar ferramentas de análise. Versão atual: 2.0."
    criticidade: "BAIXA"
    tipo: "funcional"
    campos_afetados: ["SchemaVersion"]
    obrigatorio: true
    implementacao:
      backend: true
      frontend: false
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "versao"
      mensagem_erro: null
      http_code: null
      detalhes:
        - "Backend: Incluir campo SchemaVersion: 2.0 em todos os logs"
        - "Retrocompatibilidade: Parsers devem suportar SchemaVersion 1.0 e 2.0"
        - "Migração: Documentar breaking changes entre versões"

  - id: "RN-RF098-015"
    titulo: "Logs de Segurança Isolados"
    descricao: "Logs de eventos de segurança (tentativas de login, falhas de autenticação, acessos negados, mudanças de permissão) DEVEM ser armazenados em tabela separada (LogSeguranca) com retenção mínima de 365 dias e acesso restrito apenas a Security Admin."
    criticidade: "ALTA"
    tipo: "seguranca"
    campos_afetados: ["LogSeguranca"]
    obrigatorio: true
    implementacao:
      backend: true
      frontend: false
      validacao_api: true
      validacao_ui: false
    validacao:
      tipo: "separacao"
      mensagem_erro: "Acesso negado: logs de segurança restritos"
      http_code: 403
      detalhes:
        - "Database: Tabela LogSeguranca separada de LogGeral"
        - "RBAC: Permissão AUD.LOGS.SEGURANCA_VIEW obrigatória"
        - "Auditoria: Acessos a logs de segurança devem gerar alerta para Security Admin"

# SEÇÃO 4: INTEGRAÇÕES OBRIGATÓRIAS
integracoes_obrigatorias:
  i18n:
    framework: "Transloco"
    idiomas_suportados: ["pt-BR", "en", "es"]
    idioma_padrao: "pt-BR"
    fallback: "pt-BR → en → es"
    chaves_obrigatorias:
      - "logs.titulo"
      - "logs.buscar"
      - "logs.filtros.periodo"
      - "logs.filtros.severidade"
      - "logs.filtros.modulo"
      - "logs.filtros.usuario"
      - "logs.filtros.empresa"
      - "logs.filtros.correlationId"
      - "logs.filtros.texto"
      - "logs.exportar"
      - "logs.detalhes"
      - "logs.stackTrace"
      - "logs.contexto"
      - "logs.alertas.titulo"
      - "logs.alertas.criar"
      - "logs.dashboard.titulo"
      - "logs.dashboard.totalEventos"
      - "logs.dashboard.topErros"
      - "logs.retenção.titulo"
      - "logs.retenção.dias"
      - "logs.mensagens.exportacaoSucesso"
      - "logs.mensagens.limiteExcedido"
      - "logs.severidade.trace"
      - "logs.severidade.debug"
      - "logs.severidade.information"
      - "logs.severidade.warning"
      - "logs.severidade.error"
      - "logs.severidade.critical"
    arquivo: "frontend/icontrolit-app/src/assets/i18n/pt-BR/logs.json"
    validacao_comando: "npm run i18n:validate"

  auditoria:
    mecanismo: "AuditInterceptor (EF Core)"
    campos_obrigatorios:
      - "Created"
      - "CreatedBy"
      - "LastModified"
      - "LastModifiedBy"
    entidades_auditadas:
      - "LogGeral"
      - "LogSeguranca"
      - "AlertaConfiguracao"
      - "LogExportacao"
    acoes_auditadas:
      - "Criação de alertas configurados"
      - "Modificação de regras de retenção"
      - "Acesso a logs de outras empresas (apenas Super Admin)"
      - "Exportação de logs (quem, quando, quantos registros)"

  rbac:
    descricao: "Controle de acesso baseado em roles e permissões"
    aplicavel: true

  central_funcionalidades:
    registros:
      - codigo: "AUD.LOGS"
        nome: "Auditoria de Logs"
        descricao: "Busca, visualização e exportação de logs do sistema"
        modulo: "Auditoria"
        icone: "heroicons_outline:document-text"
        rota: "/auditoria/logs"
        ordem: 1
        ativo: true
        permissao_requerida: "AUD.LOGS.VIEW"

      - codigo: "AUD.LOGS.SEGURANCA"
        nome: "Logs de Segurança"
        descricao: "Visualização de eventos de segurança (autenticação, acessos negados)"
        modulo: "Auditoria"
        icone: "heroicons_outline:shield-check"
        rota: "/auditoria/logs/seguranca"
        ordem: 2
        ativo: true
        permissao_requerida: "AUD.LOGS.SEGURANCA_VIEW"

      - codigo: "AUD.ALERTAS"
        nome: "Alertas e Monitoramento"
        descricao: "Configuração de alertas automáticos para eventos críticos"
        modulo: "Auditoria"
        icone: "heroicons_outline:bell"
        rota: "/auditoria/alertas"
        ordem: 3
        ativo: true
        permissao_requerida: "AUD.ALERTAS.VIEW"

      - codigo: "AUD.DASHBOARD"
        nome: "Dashboard de Monitoramento"
        descricao: "Visualização em tempo real de eventos, erros e performance"
        modulo: "Auditoria"
        icone: "heroicons_outline:chart-bar"
        rota: "/auditoria/dashboard"
        ordem: 4
        ativo: true
        permissao_requerida: "AUD.LOGS.VIEW"

# SEÇÃO 5: PERMISSÕES RBAC
permissoes_rbac:
  - codigo: "AUD.LOGS.VIEW"
    descricao: "Visualizar logs da própria empresa"
    roles_autorizados: ["User", "Manager", "Admin", "Super Admin", "Developer", "Auditor"]
    endpoints:
      - metodo: "GET"
        rota: "/api/logs/{id}"

  - codigo: "AUD.LOGS.SEARCH"
    descricao: "Buscar logs com filtros avançados"
    roles_autorizados: ["Manager", "Admin", "Super Admin", "Developer", "Auditor"]
    endpoints:
      - metodo: "GET"
        rota: "/api/logs"

  - codigo: "AUD.LOGS.EXPORT"
    descricao: "Exportar logs"
    roles_autorizados: ["Admin", "Super Admin", "Auditor"]
    endpoints:
      - metodo: "POST"
        rota: "/api/logs/export"

  - codigo: "AUD.LOGS.SEGURANCA_VIEW"
    descricao: "Visualizar logs de segurança"
    roles_autorizados: ["Security Admin", "Super Admin", "Auditor"]
    endpoints:
      - metodo: "GET"
        rota: "/api/logs/seguranca"

  - codigo: "AUD.LOGS.ALL_EMPRESAS"
    descricao: "Visualizar logs de todas as empresas"
    roles_autorizados: ["Super Admin", "Auditor"]
    endpoints: []

  - codigo: "AUD.ALERTAS.VIEW"
    descricao: "Visualizar alertas configurados"
    roles_autorizados: ["Manager", "Admin", "Super Admin", "Developer"]
    endpoints:
      - metodo: "GET"
        rota: "/api/alertas"

  - codigo: "AUD.ALERTAS.CREATE"
    descricao: "Criar novos alertas"
    roles_autorizados: ["Admin", "Super Admin", "Developer"]
    endpoints:
      - metodo: "POST"
        rota: "/api/alertas"

  - codigo: "AUD.ALERTAS.EDIT"
    descricao: "Editar alertas existentes"
    roles_autorizados: ["Admin", "Super Admin", "Developer"]
    endpoints:
      - metodo: "PUT"
        rota: "/api/alertas/{id}"

  - codigo: "AUD.ALERTAS.DELETE"
    descricao: "Excluir alertas"
    roles_autorizados: ["Super Admin"]
    endpoints:
      - metodo: "DELETE"
        rota: "/api/alertas/{id}"

  - codigo: "AUD.LOGS.RETENCAO_CONFIG"
    descricao: "Configurar períodos de retenção"
    roles_autorizados: ["Super Admin"]
    endpoints:
      - metodo: "PUT"
        rota: "/api/logs/retencao"

# SEÇÃO 6: API ENDPOINTS
endpoints:
  - id: "EP-RF098-001"
    metodo: "GET"
    rota: "/api/logs"
    descricao: "Buscar logs com filtros dinâmicos"
    autenticacao: true
    permissao: "AUD.LOGS.SEARCH"
    query_parameters:
      - nome: "dataInicio"
        tipo: "DateTime"
        obrigatorio: true
        descricao: "Data inicial do período"
      - nome: "dataFim"
        tipo: "DateTime"
        obrigatorio: true
        descricao: "Data final do período"
      - nome: "severidade"
        tipo: "string[]"
        obrigatorio: false
        descricao: "Filtro por severidade (ex: Error, Critical)"
      - nome: "modulo"
        tipo: "string"
        obrigatorio: false
        descricao: "Namespace/módulo"
      - nome: "usuarioId"
        tipo: "Guid"
        obrigatorio: false
        descricao: "Filtro por usuário"
      - nome: "empresaId"
        tipo: "Guid"
        obrigatorio: false
        descricao: "Filtro por empresa (obrigatório se não for Super Admin)"
      - nome: "correlationId"
        tipo: "string"
        obrigatorio: false
        descricao: "Filtro por CorrelationId"
      - nome: "textoLivre"
        tipo: "string"
        obrigatorio: false
        descricao: "Busca em mensagem e exception"
      - nome: "pageNumber"
        tipo: "int"
        obrigatorio: false
        descricao: "Número da página (default: 1)"
      - nome: "pageSize"
        tipo: "int"
        obrigatorio: false
        descricao: "Registros por página (default: 50, max: 100)"
    response_200:
      tipo: "PaginatedList<LogDto>"
      campos:
        - "items"
        - "totalCount"
        - "pageNumber"
        - "pageSize"
        - "totalPages"

  - id: "EP-RF098-002"
    metodo: "GET"
    rota: "/api/logs/{id}"
    descricao: "Obter detalhes completos de um log específico"
    autenticacao: true
    permissao: "AUD.LOGS.VIEW"
    path_parameters:
      - nome: "id"
        tipo: "Guid"
        obrigatorio: true
        descricao: "ID do log"
    response_200:
      tipo: "LogDetalhadoDto"
      campos:
        - "id"
        - "timestamp"
        - "severidade"
        - "mensagem"
        - "modulo"
        - "correlationId"
        - "usuarioId"
        - "usuarioNome"
        - "empresaId"
        - "empresaNome"
        - "ipAddress"
        - "userAgent"
        - "exception"
        - "stackTrace"
        - "innerException"
        - "contexto"
        - "schemaVersion"

  - id: "EP-RF098-003"
    metodo: "POST"
    rota: "/api/logs/export"
    descricao: "Exportar logs filtrados (máximo 10.000 registros)"
    autenticacao: true
    permissao: "AUD.LOGS.EXPORT"
    request_body:
      tipo: "ExportarLogsCommand"
      campos:
        - "dataInicio"
        - "dataFim"
        - "severidade"
        - "modulo"
        - "empresaId"
        - "formato"
    response_200:
      tipo: "ExportacaoResultDto"
      campos:
        - "fileUrl"
        - "fileName"
        - "totalRegistros"
        - "tamanhoBytes"
        - "expiresAt"
    response_400:
      tipo: "ErrorDto"
      descricao: "Limite de 10.000 registros excedido"

  - id: "EP-RF098-004"
    metodo: "GET"
    rota: "/api/logs/seguranca"
    descricao: "Buscar logs de segurança (tentativas de login, acessos negados)"
    autenticacao: true
    permissao: "AUD.LOGS.SEGURANCA_VIEW"
    query_parameters: "(mesmos de GET /api/logs)"
    response_200:
      tipo: "PaginatedList<LogSegurancaDto>"
      campos:
        - "items"
        - "totalCount"
        - "pageNumber"
        - "pageSize"
        - "totalPages"

  - id: "EP-RF098-005"
    metodo: "GET"
    rota: "/api/logs/dashboard"
    descricao: "Obter dados do dashboard de monitoramento em tempo real"
    autenticacao: true
    permissao: "AUD.LOGS.VIEW"
    response_200:
      tipo: "DashboardLogsDto"
      campos:
        - "periodo"
        - "totalEventos"
        - "eventosPorSeveridade"
        - "topErros"
        - "graficoPorHora"
        - "statusApplicationInsights"

  - id: "EP-RF098-006"
    metodo: "GET"
    rota: "/api/alertas"
    descricao: "Listar alertas configurados"
    autenticacao: true
    permissao: "AUD.ALERTAS.VIEW"
    response_200:
      tipo: "List<AlertaConfiguracaoDto>"
      campos:
        - "items"
        - "totalCount"

  - id: "EP-RF098-007"
    metodo: "POST"
    rota: "/api/alertas"
    descricao: "Criar novo alerta"
    autenticacao: true
    permissao: "AUD.ALERTAS.CREATE"
    request_body:
      tipo: "CreateAlertaCommand"
      campos:
        - "nome"
        - "descricao"
        - "condicao"
        - "destinatarios"
        - "canaisNotificacao"
        - "cooldownMinutos"
        - "ativo"
    response_201:
      tipo: "AlertaCriadoDto"
      campos:
        - "id"
        - "nome"
        - "created"

  - id: "EP-RF098-008"
    metodo: "PUT"
    rota: "/api/alertas/{id}"
    descricao: "Editar alerta existente"
    autenticacao: true
    permissao: "AUD.ALERTAS.EDIT"
    path_parameters:
      - nome: "id"
        tipo: "Guid"
        obrigatorio: true
    request_body:
      tipo: "UpdateAlertaCommand"
      campos: "(mesmo de POST)"
    response_200:
      tipo: "AlertaDto"

  - id: "EP-RF098-009"
    metodo: "DELETE"
    rota: "/api/alertas/{id}"
    descricao: "Excluir alerta"
    autenticacao: true
    permissao: "AUD.ALERTAS.DELETE"
    path_parameters:
      - nome: "id"
        tipo: "Guid"
        obrigatorio: true
    response_204:
      descricao: "No Content"

  - id: "EP-RF098-010"
    metodo: "PUT"
    rota: "/api/logs/retencao"
    descricao: "Configurar períodos de retenção por severidade"
    autenticacao: true
    permissao: "AUD.LOGS.RETENCAO_CONFIG"
    request_body:
      tipo: "ConfigurarRetencaoCommand"
      campos:
        - "critical"
        - "error"
        - "warning"
        - "information"
        - "debug"
        - "trace"
    response_200:
      tipo: "RetencaoConfiguradaDto"
      campos:
        - "message"
        - "aplicadoEm"

# SEÇÃO 7: MODELO DE DADOS
modelo_dados:
  arquivo_referencia: "MD-RF098-Auditoria-Logs-Sistema.md"
  principais_entidades:
    - "LogGeral"
    - "LogSeguranca"
    - "AlertaConfiguracao"
    - "LogExportacao"
  multi_tenancy:
    campo: "EmpresaId"
    tipo: "Guid"
    nullable: true
    descricao: "NULL para logs de sistema"
  auditoria:
    campos_obrigatorios:
      - "Created"
      - "CreatedBy"
      - "LastModified"
      - "LastModifiedBy"
  indices_criticos:
    - "IX_LogGeral_Timestamp_Severidade_EmpresaId"
    - "IX_LogGeral_CorrelationId"
    - "IX_LogSeguranca_TipoEvento_Timestamp"

# SEÇÃO 8: DEPENDÊNCIAS
dependencias:
  upstream:
    - rf_id: "RF-002"
      titulo: "Auditoria de Dados"
      motivo: "Usa AuditInterceptor para auditoria de configurações de logs/alertas"
    - rf_id: "RF-005"
      titulo: "i18n Multi-idioma"
      motivo: "Todas as mensagens e labels devem suportar pt-BR, en, es"
    - rf_id: "RF-006"
      titulo: "Gestão de Usuários"
      motivo: "Logs devem referenciar UsuarioId e exibir UsuarioNome"
    - rf_id: "RF-007"
      titulo: "Gestão de Perfis"
      motivo: "RBAC de logs depende de matriz Permission → Role → User"
    - rf_id: "RF-008"
      titulo: "Gestão de Empresas"
      motivo: "Multi-tenancy com EmpresaId obrigatório"

  downstream:
    - rf_id: "RF-087"
      titulo: "Integrações e APIs Externas"
      motivo: "Logs de execução de integrações dependem deste RF"
    - rf_id: "RF-099"
      titulo: "Auditoria de Acessos"
      motivo: "Logs de acessos a recursos críticos dependem deste RF"
    - rf_id: "TODOS"
      titulo: "Todos os RFs"
      motivo: "Todos os RFs loggam eventos usando este framework"

  bibliotecas_externas:
    backend:
      - nome: "Serilog"
        versao: ">= 3.1.0"
        descricao: "Framework de logging estruturado"
      - nome: "Serilog.Sinks.ApplicationInsights"
        versao: ">= 4.0.0"
        descricao: "Sink para Application Insights"
      - nome: "Serilog.Enrichers.Environment"
        versao: null
        descricao: "Enriquecimento de contexto (machine name, etc)"
      - nome: "Serilog.Enrichers.Thread"
        versao: null
        descricao: "Enriquecimento com thread ID"
      - nome: "Microsoft.ApplicationInsights.AspNetCore"
        versao: ">= 2.22.0"
        descricao: "SDK Application Insights"
    frontend:
      - nome: "@jsverse/transloco"
        versao: null
        descricao: "Internacionalização"
      - nome: "apexcharts"
        versao: null
        descricao: "Gráficos do dashboard"
      - nome: "date-fns"
        versao: null
        descricao: "Manipulação de datas para filtros de período"
    infraestrutura:
      - nome: "Application Insights"
        tipo: "Azure Service"
        descricao: "Serviço Azure para monitoramento em tempo real"
      - nome: "Azure Blob Storage"
        tipo: "Azure Service"
        descricao: "Armazenamento temporário de arquivos de exportação"
      - nome: "Hangfire"
        tipo: "Library"
        descricao: "Jobs de limpeza de logs expirados"

# SEÇÃO 9: KPIs E MÉTRICAS
kpis:
  performance:
    - nome: "Latência de Busca"
      descricao: "Tempo de resposta de query de logs"
      meta: "< 2 segundos (p95)"
      medicao: "Application Insights - Request Duration"
      calculo: "percentile(duration, 95) WHERE name == GET /api/logs"

    - nome: "Throughput de Logging"
      descricao: "Quantidade de logs processados por segundo"
      meta: "> 1000 logs/s sem degradação"
      medicao: "Serilog metrics + Application Insights"
      calculo: "avg(LogsPerSecond) by bin(timestamp, 1m)"

    - nome: "Taxa de Falha de Envio"
      descricao: "Percentual de logs que falharam ao enviar para Application Insights"
      meta: "< 0.1%"
      medicao: "(Falhas / Total) * 100"
      calculo: "(Total SendToAppInsightsFailed = true / Total logs criados) * 100"

    - nome: "Disponibilidade do Dashboard"
      descricao: "Uptime do endpoint /api/logs/dashboard"
      meta: "> 99.9%"
      medicao: "Application Insights - Availability Tests"
      calculo: "Availability Test Success Rate"

  negocio:
    - nome: "Tempo Médio de Investigação"
      descricao: "Tempo para encontrar causa raiz de um incidente usando logs"
      meta: "< 10 minutos"
      medicao: "Survey com equipe de suporte"
      calculo: "Manual"

    - nome: "Taxa de Exportação"
      descricao: "Percentual de buscas que resultam em exportação"
      meta: "< 5% (exportação é exceção)"
      medicao: "(Exportações / Buscas) * 100"
      calculo: "(Total exports / Total searches) * 100"

    - nome: "Alertas com Ação"
      descricao: "Percentual de alertas disparados que resultaram em ação corretiva"
      meta: "> 80%"
      medicao: "Auditoria manual de alertas"
      calculo: "Manual"

    - nome: "Conformidade LGPD"
      descricao: "Percentual de logs sem dados sensíveis em texto claro"
      meta: "100%"
      medicao: "Scan automatizado semanal"
      calculo: "Automated scanner results"

# SEÇÃO 10: ALERTAS CRÍTICOS
alertas:
  - nome: "Taxa de Erro Crítica"
    condicao: "ErrorRate > 5% em janela de 10 minutos"
    severidade: "CRÍTICO"
    acao: "Email para Dev Team + Webhook para PagerDuty"
    cooldown_minutos: 5

  - nome: "Latência Acima do SLO"
    condicao: "p95 latency > 3s em janela de 5 minutos"
    severidade: "ALTO"
    acao: "Email para Dev Team"
    cooldown_minutos: 5

  - nome: "Application Insights Offline"
    condicao: "Falha no envio de logs por mais de 5 minutos"
    severidade: "ALTO"
    acao: "Email para Ops Team"
    cooldown_minutos: 10

  - nome: "Tentativas de Login Suspeitas"
    condicao: "Mais de 10 falhas de login do mesmo IP em 5 minutos"
    severidade: "MÉDIO"
    acao: "Email para Security Team"
    cooldown_minutos: 15

  - nome: "Exportação de Grande Volume"
    condicao: "Exportação > 5.000 registros"
    severidade: "BAIXO"
    acao: "Notificação in-app para Auditor"
    cooldown_minutos: 30

  - nome: "Logs de Sistema Críticos"
    condicao: "Qualquer log com severidade Critical"
    severidade: "CRÍTICO"
    acao: "Email para Dev Team + Notificação in-app"
    cooldown_minutos: 5

# SEÇÃO 11: CENTRAL DE FUNCIONALIDADES
central_funcionalidades:
  codigo_funcionalidade: "AUD.LOGS"
  nome_funcionalidade: "Auditoria de Logs"
  descricao_funcionalidade: "Sistema completo de logging, busca avançada, exportação e monitoramento de eventos da aplicação"
  modulo: "Auditoria"
  icone: "heroicons_outline:document-text"
  rota: "/auditoria/logs"
  ordem: 1
  ativo: true
  permissao_requerida: "AUD.LOGS.VIEW"

  sub_funcionalidades:
    - nome: "Busca de Logs"
      codigo: "AUD.LOGS.SEARCH"
      descricao: "Filtros dinâmicos (período, severidade, módulo, usuário, empresa). Paginação e ordenação. Busca livre em mensagem/exception."

    - nome: "Detalhes de Log"
      codigo: "AUD.LOGS.VIEW"
      descricao: "Visualização completa de log individual. Stack trace formatado. Contexto estruturado (JSON)."

    - nome: "Exportação de Logs"
      codigo: "AUD.LOGS.EXPORT"
      descricao: "Formatos: CSV, JSON, Excel. Limite de 10.000 registros. Download temporário (expira em 1 hora)."

    - nome: "Logs de Segurança"
      codigo: "AUD.LOGS.SEGURANCA_VIEW"
      descricao: "Eventos de autenticação. Tentativas de acesso negado. Mudanças de permissão. Retenção mínima de 365 dias."

    - nome: "Dashboard de Monitoramento"
      codigo: "AUD.DASHBOARD"
      descricao: "Total de eventos por severidade (24h). Top 10 erros. Gráfico de eventos ao longo do tempo. Status de integração com Application Insights."

    - nome: "Alertas Configuráveis"
      codigo: "AUD.ALERTAS"
      descricao: "Criação de regras de alerta. Configuração de destinatários. Cooldown para evitar spam. Múltiplos canais (email, webhook, in-app)."

    - nome: "Configuração de Retenção"
      codigo: "AUD.LOGS.RETENCAO_CONFIG"
      descricao: "Períodos diferenciados por severidade. Job automático de limpeza. Otimização de armazenamento."

# CHANGELOG
changelog:
  - versao: "2.0"
    data: "2025-12-31"
    descricao: "Migração para Governança v2.0 - Separação RF/RL, 11 seções, 15 RNs, 10 endpoints, 10 permissões RBAC"
    autor: "Agência ALC - alc.dev.br"

  - versao: "1.0"
    data: "2025-11-15"
    descricao: "Versão inicial com documentação técnica detalhada"
    autor: "Agência ALC - alc.dev.br"
