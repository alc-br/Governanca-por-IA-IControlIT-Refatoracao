# RF-098 — Auditoria e Logs do Sistema

**RF ID:** RF098
**Versão:** 2.0
**Data:** 2025-12-31
**Autor:** Agência ALC - alc.dev.br

**Epic:** EPIC010-AUD-Auditoria-Avancada
**Fase:** Fase 6 - Ativos, Auditoria e Integrações
**Status:** Documentação v2.0 Completa

---

## 1. VISÃO GERAL

### 1.1 Resumo Executivo

O **RF-098 – Auditoria e Logs do Sistema** estabelece o framework completo de logging, monitoramento e auditoria operacional do IControlIT v2. Este requisito define como todos os eventos, erros, acessos e operações críticas devem ser registrados, consultados, exportados e analisados para garantir rastreabilidade, conformidade regulatória (LGPD, ISO 27001) e suporte técnico eficaz.

O sistema implementa logging estruturado com múltiplos níveis de severidade (Trace, Debug, Information, Warning, Error, Critical), integração com Application Insights para monitoramento em tempo real, queries avançadas com filtros dinâmicos, alertas automáticos para eventos críticos e exportação de logs para auditoria externa.

### 1.2 Objetivo Principal

Prover um sistema robusto de auditoria e logging que permita:
- Rastreabilidade completa de todas as operações (quem, quando, o quê, onde)
- Detecção proativa de erros e anomalias através de alertas automáticos
- Investigação eficaz de incidentes com busca avançada e correlação de eventos
- Conformidade com regulamentações de privacidade e segurança
- Análise de performance e comportamento do sistema
- Exportação de evidências para auditorias externas

### 1.3 Escopo

**Incluído:**
- Logging estruturado de todos os eventos da aplicação
- Auditoria automática de operações CRUD (Create, Read, Update, Delete)
- Rastreamento de acessos e autenticações
- Registro de erros e exceções com stack trace
- Monitoramento de performance (tempo de resposta, throughput)
- Interface de busca avançada com filtros dinâmicos
- Exportação de logs (CSV, JSON, Excel)
- Alertas automáticos para eventos críticos
- Integração com Application Insights
- Dashboard de monitoramento em tempo real
- Retenção de logs configurável por severidade
- Correlação de eventos por CorrelationId

**Não Incluído:**
- Auditoria de mudanças de dados de negócio (coberta por AuditInterceptor - RF-002)
- Logs de aplicações externas fora do IControlIT
- SIEM (Security Information and Event Management) - integração futura
- Análise de logs com Machine Learning - funcionalidade futura

---

## 2. FUNCIONALIDADES

### F-001: Logging Estruturado Automático
**Prioridade:** CRÍTICA
**Descrição:** Todos os componentes da aplicação (Controllers, Services, Middlewares, Handlers) devem registrar logs estruturados com contexto completo (usuário, empresa, IP, timestamp, CorrelationId).

### F-002: Busca Avançada de Logs
**Prioridade:** ALTA
**Descrição:** Interface de busca com filtros dinâmicos: período, severidade, módulo, usuário, empresa, IP, CorrelationId, texto livre. Suporte a operadores lógicos (AND, OR, NOT).

### F-003: Exportação de Logs
**Prioridade:** ALTA
**Descrição:** Exportar logs filtrados em múltiplos formatos (CSV, JSON, Excel) para auditorias externas, análises offline ou compartilhamento com equipes de suporte.

### F-004: Dashboard de Monitoramento
**Prioridade:** ALTA
**Descrição:** Dashboard em tempo real exibindo: total de eventos por severidade (últimas 24h), top 10 erros, gráfico de eventos ao longo do tempo, status de integração com Application Insights.

### F-005: Alertas Automáticos
**Prioridade:** CRÍTICA
**Descrição:** Sistema de alertas configuráveis para eventos críticos: taxa de erro > 5%, latência > SLO, falhas de autenticação consecutivas, exceptions não tratadas.

### F-006: Rastreamento de Performance
**Prioridade:** MÉDIA
**Descrição:** Registrar tempo de execução de operações críticas (queries, APIs externas, processamentos em lote) e alertar quando ultrapassar limites configurados.

### F-007: Correlação de Eventos
**Prioridade:** ALTA
**Descrição:** Permitir rastrear uma requisição completa (frontend → backend → database → APIs externas) através de um CorrelationId único, facilitando investigação de problemas.

### F-008: Retenção Configurável de Logs
**Prioridade:** MÉDIA
**Descrição:** Definir períodos de retenção diferentes por severidade: Critical (365 dias), Error (180 dias), Warning (90 dias), Information (30 dias), Debug/Trace (7 dias).

---

## 3. REGRAS DE NEGÓCIO

### RN-RF098-001: Níveis de Severidade Obrigatórios
**Descrição:** O sistema DEVE suportar 6 níveis de severidade de logs conforme padrão Serilog/Application Insights: Trace, Debug, Information, Warning, Error, Critical.

**Criticidade:** CRÍTICA

**Validação:**
- Backend: Configurar Serilog com todos os 6 níveis
- API: Endpoints devem validar severidade em filtros
- Database: Enum LogSeverity com todos os níveis
- UI: Dropdown de filtro deve exibir todos os níveis

---

### RN-RF098-002: Contexto Obrigatório em Todos os Logs
**Descrição:** TODO log DEVE conter contexto mínimo: Timestamp (ISO 8601), Severidade, Mensagem, CorrelationId, Módulo/Namespace, EmpresaId (quando aplicável), UsuarioId (quando aplicável), IP do cliente.

**Criticidade:** CRÍTICA

**Validação:**
- Backend: Middleware deve enriquecer contexto automaticamente
- API: Logs sem contexto mínimo devem gerar alerta
- Auditoria: Verificar presença de campos obrigatórios em 100% dos logs

---

### RN-RF098-003: CorrelationId Único Por Requisição
**Descrição:** Cada requisição HTTP DEVE ter um CorrelationId único (GUID) gerado no entry point e propagado para todas as camadas (frontend, backend, APIs externas, banco de dados).

**Criticidade:** ALTA

**Validação:**
- Backend: Middleware de correlação deve injetar CorrelationId no HttpContext
- API: Header `X-Correlation-Id` deve ser retornado em todas as respostas
- Logs: Todos os logs de uma requisição devem compartilhar o mesmo CorrelationId
- Frontend: Incluir CorrelationId em todas as chamadas HTTP

---

### RN-RF098-004: Retenção Diferenciada Por Severidade
**Descrição:** Logs devem ter retenção diferenciada conforme severidade para otimizar armazenamento e atender regulamentações: Critical (365 dias), Error (180 dias), Warning (90 dias), Information (30 dias), Debug (7 dias), Trace (7 dias).

**Criticidade:** MÉDIA

**Validação:**
- Backend: Job diário de limpeza de logs expirados
- Database: Index em (Timestamp, Severidade) para otimizar limpeza
- Configuração: Períodos de retenção configuráveis via SistemaConfiguracaoGeral

---

### RN-RF098-005: Sanitização de Dados Sensíveis
**Descrição:** Logs NUNCA devem conter dados sensíveis em texto claro: senhas, tokens, CPF completo, dados de cartão de crédito, credenciais de APIs externas.

**Criticidade:** CRÍTICA

**Validação:**
- Backend: Sanitizer automático deve mascarar campos sensíveis antes de logar
- Auditoria: Scan periódico de logs para detectar vazamento de dados sensíveis
- Code Review: Regra de linter para detectar logs de campos sensíveis
- Exemplos de sanitização:
  - CPF: `123.456.789-00` → `***.***.789-**`
  - Senha: `senha123` → `[REDACTED]`
  - Token: `Bearer eyJhbGc...` → `Bearer [REDACTED]`

---

### RN-RF098-006: Stack Trace Completo Para Exceções
**Descrição:** Logs de severidade Error ou Critical que registrem exceções DEVEM incluir stack trace completo, inner exceptions (até 3 níveis), e contexto da operação que falhou.

**Criticidade:** ALTA

**Validação:**
- Backend: Método de logging deve capturar exception.ToString() completo
- API: Endpoint de detalhes de log deve exibir stack trace formatado
- UI: Exibir stack trace em modal colapsável (não inline)

---

### RN-RF098-007: Integração Obrigatória com Application Insights
**Descrição:** TODOS os logs DEVEM ser enviados para Application Insights (além do armazenamento local) para monitoramento em tempo real, alertas inteligentes e análise histórica.

**Criticidade:** ALTA

**Validação:**
- Backend: Serilog Sink configurado para Application Insights
- Configuração: Instrumentation Key em appsettings.json
- Monitoramento: Verificar latência de envio < 5 segundos
- Fallback: Se Application Insights estiver indisponível, logar localmente sem bloquear operação

---

### RN-RF098-008: Busca Performática em Grandes Volumes
**Descrição:** Busca de logs DEVE retornar resultados em menos de 2 segundos mesmo com mais de 1 milhão de registros. Usar paginação (máximo 100 registros por página) e índices otimizados.

**Criticidade:** ALTA

**Validação:**
- Database: Índices em (Timestamp DESC, Severidade, EmpresaId, UsuarioId)
- API: Query deve incluir `LIMIT` e `OFFSET` obrigatoriamente
- Performance: Teste de carga com 1M+ registros deve retornar < 2s
- Cache: Queries idênticas em menos de 5 minutos devem retornar cache

---

### RN-RF098-009: Alertas Configuráveis Por Regra
**Descrição:** Sistema DEVE permitir configurar alertas personalizados com condições dinâmicas: "Se taxa de erro > 5% em 10 minutos, enviar email para equipe de suporte".

**Criticidade:** MÉDIA

**Validação:**
- Backend: Engine de regras de alertas deve avaliar condições a cada 1 minuto
- Database: Tabela AlertaConfiguracao com campos: Condicao, Destinatarios, Cooldown
- Notificação: Suportar múltiplos canais (email, webhook, notificação in-app)
- Cooldown: Evitar spam de alertas (mínimo 5 minutos entre alertas da mesma regra)

---

### RN-RF098-010: Exportação com Limite de Volume
**Descrição:** Exportação de logs DEVE ter limite de 10.000 registros por operação para evitar sobrecarga de memória e timeout. Para volumes maiores, sugerir filtros mais restritivos ou exportação em lote.

**Criticidade:** MÉDIA

**Validação:**
- API: Endpoint de exportação deve validar quantidade ANTES de processar
- UI: Exibir warning se filtro retornar > 10.000 registros
- Backend: Se exceder limite, retornar HTTP 400 com mensagem clara
- Alternativa: Oferecer agendamento de exportação assíncrona (Hangfire)

---

### RN-RF098-011: Auditoria de Acessos a Logs
**Descrição:** Toda consulta de logs DEVE ser auditada (quem consultou, quando, quais filtros utilizou) para rastreabilidade de investigações e conformidade LGPD.

**Criticidade:** ALTA

**Validação:**
- Backend: Criar registro de auditoria ANTES de retornar logs
- Database: Tabela LogAcessoAuditoria com campos: UsuarioId, Timestamp, Filtros, TotalRegistrosRetornados
- RBAC: Apenas usuários com permissão `AUD.LOGS.AUDITORIA_ACESSO` podem consultar auditoria de acessos

---

### RN-RF098-012: Multi-Tenancy Estrito
**Descrição:** Usuários DEVEM visualizar apenas logs da(s) empresa(s) às quais têm acesso. Super Admin pode visualizar logs de todas as empresas. Developer pode visualizar logs técnicos sem EmpresaId (logs de sistema).

**Criticidade:** CRÍTICA

**Validação:**
- Backend: Query de logs deve SEMPRE incluir filtro `WHERE EmpresaId IN (empresasDoUsuario)`
- API: Validar permissão de acesso à empresa ANTES de retornar logs
- Exception: Logs com EmpresaId = NULL (logs de sistema) só acessíveis por Developer/Super Admin

---

### RN-RF098-013: Logs de Performance com Thresholds
**Descrição:** Operações críticas DEVEM registrar tempo de execução. Se ultrapassar threshold configurado (ex: query > 1s), logar com severidade Warning. Se ultrapassar threshold crítico (query > 5s), logar com severidade Error.

**Criticidade:** MÉDIA

**Validação:**
- Backend: Decorator/Middleware de performance deve medir tempo automaticamente
- Configuração: Thresholds configuráveis por tipo de operação (Query, API, Job)
- Dashboard: Exibir top 10 operações mais lentas

---

### RN-RF098-014: Versionamento de Estrutura de Logs
**Descrição:** Logs DEVEM incluir campo `SchemaVersion` para permitir evolução da estrutura sem quebrar ferramentas de análise. Versão atual: `2.0`.

**Criticidade:** BAIXA

**Validação:**
- Backend: Incluir campo `SchemaVersion: "2.0"` em todos os logs
- Retrocompatibilidade: Parsers devem suportar SchemaVersion 1.0 e 2.0
- Migração: Documentar breaking changes entre versões

---

### RN-RF098-015: Logs de Segurança Isolados
**Descrição:** Logs de eventos de segurança (tentativas de login, falhas de autenticação, acessos negados, mudanças de permissão) DEVEM ser armazenados em tabela separada (LogSeguranca) com retenção mínima de 365 dias e acesso restrito apenas a Security Admin.

**Criticidade:** ALTA

**Validação:**
- Database: Tabela LogSeguranca separada de LogGeral
- RBAC: Permissão `AUD.LOGS.SEGURANCA_VIEW` obrigatória
- Auditoria: Acessos a logs de segurança devem gerar alerta para Security Admin

---

## 4. INTEGRAÇÕES OBRIGATÓRIAS

### 4.1 Internacionalização (i18n)

**Framework:** Transloco
**Idiomas Suportados:** pt-BR (padrão), en, es
**Fallback:** pt-BR → en → es

**Chaves Obrigatórias:**

```
logs.titulo: "Auditoria de Logs"
logs.buscar: "Buscar Logs"
logs.filtros.periodo: "Período"
logs.filtros.severidade: "Severidade"
logs.filtros.modulo: "Módulo"
logs.filtros.usuario: "Usuário"
logs.filtros.empresa: "Empresa"
logs.filtros.correlationId: "Correlation ID"
logs.filtros.texto: "Busca Livre"
logs.exportar: "Exportar"
logs.detalhes: "Detalhes do Log"
logs.stackTrace: "Stack Trace"
logs.contexto: "Contexto"
logs.alertas.titulo: "Alertas Configurados"
logs.alertas.criar: "Criar Alerta"
logs.dashboard.titulo: "Dashboard de Monitoramento"
logs.dashboard.totalEventos: "Total de Eventos (24h)"
logs.dashboard.topErros: "Top 10 Erros"
logs.retenção.titulo: "Configuração de Retenção"
logs.retenção.dias: "Dias de Retenção"
logs.mensagens.exportacaoSucesso: "Logs exportados com sucesso"
logs.mensagens.limiteExcedido: "Limite de 10.000 registros excedido. Refine os filtros."
logs.severidade.trace: "Trace"
logs.severidade.debug: "Debug"
logs.severidade.information: "Information"
logs.severidade.warning: "Warning"
logs.severidade.error: "Error"
logs.severidade.critical: "Critical"
```

**Validação:**
- Arquivo: `D:\IC2\frontend\icontrolit-app/src/assets/i18n/pt-BR/logs.json`
- Comando: `npm run i18n:validate` DEVE passar 100%

---

### 4.2 Auditoria

**Mecanismo:** AuditInterceptor (EF Core)

**Campos Obrigatórios em LogGeral, LogSeguranca, AlertaConfiguracao:**
- `Created` (DateTime)
- `CreatedBy` (string - nome do usuário)
- `LastModified` (DateTime?)
- `LastModifiedBy` (string?)

**Ações Auditadas:**
- Criação de alertas configurados
- Modificação de regras de retenção
- Acesso a logs de outras empresas (apenas Super Admin)
- Exportação de logs (quem, quando, quantos registros)

**Validação:**
- Tabela `AuditLog` deve conter registros de todas as operações de configuração de logs/alertas

---

### 4.3 RBAC (Controle de Acesso)

**Permissões Requeridas:**

| Código Permissão | Descrição | Roles Autorizados |
|------------------|-----------|-------------------|
| `AUD.LOGS.VIEW` | Visualizar logs da própria empresa | User, Manager, Admin, Super Admin, Developer, Auditor |
| `AUD.LOGS.SEARCH` | Buscar logs com filtros avançados | Manager, Admin, Super Admin, Developer, Auditor |
| `AUD.LOGS.EXPORT` | Exportar logs | Admin, Super Admin, Auditor |
| `AUD.LOGS.SEGURANCA_VIEW` | Visualizar logs de segurança | Security Admin, Super Admin, Auditor |
| `AUD.LOGS.ALL_EMPRESAS` | Visualizar logs de todas as empresas | Super Admin, Auditor |
| `AUD.ALERTAS.VIEW` | Visualizar alertas configurados | Manager, Admin, Super Admin, Developer |
| `AUD.ALERTAS.CREATE` | Criar novos alertas | Admin, Super Admin, Developer |
| `AUD.ALERTAS.EDIT` | Editar alertas existentes | Admin, Super Admin, Developer |
| `AUD.ALERTAS.DELETE` | Excluir alertas | Super Admin |
| `AUD.LOGS.RETENCAO_CONFIG` | Configurar períodos de retenção | Super Admin |

**Matriz de Permissões:**

| Funcionalidade | User | Manager | Admin | Super Admin | Developer | Auditor | Security Admin |
|----------------|------|---------|-------|-------------|-----------|---------|----------------|
| Visualizar logs própria empresa | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| Buscar logs com filtros | - | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| Exportar logs | - | - | ✓ | ✓ | - | ✓ | - |
| Visualizar logs segurança | - | - | - | ✓ | - | ✓ | ✓ |
| Visualizar logs todas empresas | - | - | - | ✓ | - | ✓ | - |
| Criar alertas | - | - | ✓ | ✓ | ✓ | - | - |
| Editar alertas | - | - | ✓ | ✓ | ✓ | - | - |
| Excluir alertas | - | - | - | ✓ | - | - | - |
| Configurar retenção | - | - | - | ✓ | - | - | - |

---

### 4.4 Central de Funcionalidades

**Registro Obrigatório:**

```csharp
new SistemaFuncionalidade
{
    Codigo = "AUD.LOGS",
    Nome = "Auditoria de Logs",
    Descricao = "Busca, visualização e exportação de logs do sistema",
    Modulo = "Auditoria",
    Icone = "heroicons_outline:document-text",
    Rota = "/auditoria/logs",
    Ordem = 1,
    Ativo = true,
    PermissaoRequerida = "AUD.LOGS.VIEW"
}

new SistemaFuncionalidade
{
    Codigo = "AUD.LOGS.SEGURANCA",
    Nome = "Logs de Segurança",
    Descricao = "Visualização de eventos de segurança (autenticação, acessos negados)",
    Modulo = "Auditoria",
    Icone = "heroicons_outline:shield-check",
    Rota = "/auditoria/logs/seguranca",
    Ordem = 2,
    Ativo = true,
    PermissaoRequerida = "AUD.LOGS.SEGURANCA_VIEW"
}

new SistemaFuncionalidade
{
    Codigo = "AUD.ALERTAS",
    Nome = "Alertas e Monitoramento",
    Descricao = "Configuração de alertas automáticos para eventos críticos",
    Modulo = "Auditoria",
    Icone = "heroicons_outline:bell",
    Rota = "/auditoria/alertas",
    Ordem = 3,
    Ativo = true,
    PermissaoRequerida = "AUD.ALERTAS.VIEW"
}

new SistemaFuncionalidade
{
    Codigo = "AUD.DASHBOARD",
    Nome = "Dashboard de Monitoramento",
    Descricao = "Visualização em tempo real de eventos, erros e performance",
    Modulo = "Auditoria",
    Icone = "heroicons_outline:chart-bar",
    Rota = "/auditoria/dashboard",
    Ordem = 4,
    Ativo = true,
    PermissaoRequerida = "AUD.LOGS.VIEW"
}
```

**Validação:**
- Seeds devem incluir esses 4 registros
- Menu lateral deve exibir "Auditoria" com 4 sub-itens

---

## 5. PERMISSÕES RBAC

### Matriz de Permissões x Endpoints

| Endpoint | Método | Permissão Requerida | Roles |
|----------|--------|---------------------|-------|
| `/api/logs` | GET | `AUD.LOGS.SEARCH` | Manager, Admin, Super Admin, Developer, Auditor |
| `/api/logs/{id}` | GET | `AUD.LOGS.VIEW` | User, Manager, Admin, Super Admin, Developer, Auditor |
| `/api/logs/export` | POST | `AUD.LOGS.EXPORT` | Admin, Super Admin, Auditor |
| `/api/logs/seguranca` | GET | `AUD.LOGS.SEGURANCA_VIEW` | Security Admin, Super Admin, Auditor |
| `/api/logs/dashboard` | GET | `AUD.LOGS.VIEW` | User, Manager, Admin, Super Admin, Developer, Auditor |
| `/api/alertas` | GET | `AUD.ALERTAS.VIEW` | Manager, Admin, Super Admin, Developer |
| `/api/alertas` | POST | `AUD.ALERTAS.CREATE` | Admin, Super Admin, Developer |
| `/api/alertas/{id}` | PUT | `AUD.ALERTAS.EDIT` | Admin, Super Admin, Developer |
| `/api/alertas/{id}` | DELETE | `AUD.ALERTAS.DELETE` | Super Admin |
| `/api/logs/retencao` | PUT | `AUD.LOGS.RETENCAO_CONFIG` | Super Admin |

---

## 6. API ENDPOINTS

### 6.1 GET /api/logs
**Descrição:** Buscar logs com filtros dinâmicos
**Autenticação:** Requerida
**Permissão:** `AUD.LOGS.SEARCH`

**Query Parameters:**
- `dataInicio` (DateTime, obrigatório): Data inicial do período
- `dataFim` (DateTime, obrigatório): Data final do período
- `severidade` (string[], opcional): Filtro por severidade (ex: ["Error", "Critical"])
- `modulo` (string, opcional): Namespace/módulo (ex: "IControlIT.Application.Integracoes")
- `usuarioId` (Guid, opcional): Filtro por usuário
- `empresaId` (Guid, opcional): Filtro por empresa (obrigatório se não for Super Admin)
- `correlationId` (string, opcional): Filtro por CorrelationId
- `textoLivre` (string, opcional): Busca em mensagem e exception
- `pageNumber` (int, default: 1): Número da página
- `pageSize` (int, default: 50, max: 100): Registros por página

**Response 200 OK:**
```json
{
  "items": [
    {
      "id": "guid",
      "timestamp": "2025-12-31T14:30:00Z",
      "severidade": "Error",
      "mensagem": "Falha ao processar integração",
      "modulo": "IControlIT.Application.Integracoes",
      "correlationId": "guid",
      "usuarioId": "guid",
      "usuarioNome": "João Silva",
      "empresaId": "guid",
      "empresaNome": "Empresa XYZ",
      "ipAddress": "192.168.1.100",
      "exception": "System.InvalidOperationException: ...",
      "contexto": {
        "IntegracaoId": "guid",
        "TipoIntegracao": "REST_API"
      }
    }
  ],
  "totalCount": 1234,
  "pageNumber": 1,
  "pageSize": 50,
  "totalPages": 25
}
```

---

### 6.2 GET /api/logs/{id}
**Descrição:** Obter detalhes completos de um log específico
**Autenticação:** Requerida
**Permissão:** `AUD.LOGS.VIEW`

**Response 200 OK:**
```json
{
  "id": "guid",
  "timestamp": "2025-12-31T14:30:00Z",
  "severidade": "Error",
  "mensagem": "Falha ao processar integração",
  "modulo": "IControlIT.Application.Integracoes.Commands.ExecutarIntegracaoCommandHandler",
  "correlationId": "guid",
  "usuarioId": "guid",
  "usuarioNome": "João Silva",
  "empresaId": "guid",
  "empresaNome": "Empresa XYZ",
  "ipAddress": "192.168.1.100",
  "userAgent": "Mozilla/5.0...",
  "exception": "System.InvalidOperationException: ...",
  "stackTrace": "at IControlIT.Application.Integracoes...",
  "innerException": "System.Net.Http.HttpRequestException: ...",
  "contexto": {
    "IntegracaoId": "guid",
    "TipoIntegracao": "REST_API",
    "Endpoint": "https://api.externa.com/v1/data",
    "HttpMethod": "POST",
    "StatusCode": 500,
    "DurationMs": 5234
  },
  "schemaVersion": "2.0"
}
```

---

### 6.3 POST /api/logs/export
**Descrição:** Exportar logs filtrados (máximo 10.000 registros)
**Autenticação:** Requerida
**Permissão:** `AUD.LOGS.EXPORT`

**Request Body:**
```json
{
  "dataInicio": "2025-12-01T00:00:00Z",
  "dataFim": "2025-12-31T23:59:59Z",
  "severidade": ["Error", "Critical"],
  "modulo": "IControlIT.Application",
  "empresaId": "guid",
  "formato": "CSV"
}
```

**Response 200 OK:**
```json
{
  "fileUrl": "https://storage.blob.core.windows.net/exports/logs_20251231_143000.csv",
  "fileName": "logs_20251231_143000.csv",
  "totalRegistros": 8945,
  "tamanhoBytes": 2457600,
  "expiresAt": "2025-12-31T15:30:00Z"
}
```

**Response 400 Bad Request (limite excedido):**
```json
{
  "error": "EXPORT_LIMIT_EXCEEDED",
  "message": "A consulta retornou 15.432 registros. O limite é 10.000. Refine os filtros.",
  "totalRegistros": 15432,
  "limitePermitido": 10000
}
```

---

### 6.4 GET /api/logs/seguranca
**Descrição:** Buscar logs de segurança (tentativas de login, acessos negados)
**Autenticação:** Requerida
**Permissão:** `AUD.LOGS.SEGURANCA_VIEW`

**Query Parameters:** (mesmos de GET /api/logs)

**Response 200 OK:**
```json
{
  "items": [
    {
      "id": "guid",
      "timestamp": "2025-12-31T14:25:00Z",
      "tipoEvento": "LOGIN_FALHA",
      "severidade": "Warning",
      "mensagem": "Tentativa de login falhou - senha incorreta",
      "usuarioTentativa": "joao.silva@empresa.com",
      "ipAddress": "192.168.1.100",
      "userAgent": "Mozilla/5.0...",
      "empresaId": "guid",
      "tentativasConsecutivas": 3,
      "bloqueado": false
    }
  ],
  "totalCount": 45,
  "pageNumber": 1,
  "pageSize": 50,
  "totalPages": 1
}
```

---

### 6.5 GET /api/logs/dashboard
**Descrição:** Obter dados do dashboard de monitoramento em tempo real
**Autenticação:** Requerida
**Permissão:** `AUD.LOGS.VIEW`

**Response 200 OK:**
```json
{
  "periodo": "24h",
  "totalEventos": 45678,
  "eventosPorSeveridade": {
    "trace": 1234,
    "debug": 5678,
    "information": 35000,
    "warning": 2500,
    "error": 1200,
    "critical": 66
  },
  "topErros": [
    {
      "mensagem": "Timeout ao chamar API externa",
      "ocorrencias": 234,
      "primeiraOcorrencia": "2025-12-31T08:15:00Z",
      "ultimaOcorrencia": "2025-12-31T14:30:00Z"
    }
  ],
  "graficoPorHora": [
    {
      "hora": "2025-12-31T00:00:00Z",
      "total": 1500,
      "erros": 45,
      "warnings": 120
    }
  ],
  "statusApplicationInsights": {
    "conectado": true,
    "ultimoEnvio": "2025-12-31T14:29:55Z",
    "latenciaMs": 234
  }
}
```

---

### 6.6 GET /api/alertas
**Descrição:** Listar alertas configurados
**Autenticação:** Requerida
**Permissão:** `AUD.ALERTAS.VIEW`

**Response 200 OK:**
```json
{
  "items": [
    {
      "id": "guid",
      "nome": "Alta Taxa de Erro",
      "descricao": "Alertar se taxa de erro > 5% em 10 minutos",
      "condicao": "ErrorRate > 5 AND TimeWindow = 10",
      "destinatarios": ["suporte@empresa.com", "dev@empresa.com"],
      "canaisNotificacao": ["email", "webhook"],
      "cooldownMinutos": 15,
      "ativo": true,
      "ultimoDisparo": "2025-12-30T18:45:00Z"
    }
  ],
  "totalCount": 8
}
```

---

### 6.7 POST /api/alertas
**Descrição:** Criar novo alerta
**Autenticação:** Requerida
**Permissão:** `AUD.ALERTAS.CREATE`

**Request Body:**
```json
{
  "nome": "Latência Crítica",
  "descricao": "Alertar se latência média > 2s em 5 minutos",
  "condicao": "AvgLatencyMs > 2000 AND TimeWindow = 5",
  "destinatarios": ["dev@empresa.com"],
  "canaisNotificacao": ["email"],
  "cooldownMinutos": 10,
  "ativo": true
}
```

**Response 201 Created:**
```json
{
  "id": "guid",
  "nome": "Latência Crítica",
  "created": "2025-12-31T14:30:00Z"
}
```

---

### 6.8 PUT /api/alertas/{id}
**Descrição:** Editar alerta existente
**Autenticação:** Requerida
**Permissão:** `AUD.ALERTAS.EDIT`

**Request Body:** (mesmo de POST)

**Response 200 OK:** (alerta atualizado)

---

### 6.9 DELETE /api/alertas/{id}
**Descrição:** Excluir alerta
**Autenticação:** Requerida
**Permissão:** `AUD.ALERTAS.DELETE`

**Response 204 No Content**

---

### 6.10 PUT /api/logs/retencao
**Descrição:** Configurar períodos de retenção por severidade
**Autenticação:** Requerida
**Permissão:** `AUD.LOGS.RETENCAO_CONFIG`

**Request Body:**
```json
{
  "critical": 365,
  "error": 180,
  "warning": 90,
  "information": 30,
  "debug": 7,
  "trace": 7
}
```

**Response 200 OK:**
```json
{
  "message": "Configuração de retenção atualizada com sucesso",
  "aplicadoEm": "2025-12-31T14:30:00Z"
}
```

---

## 7. MODELO DE DADOS

### 7.1 Referência ao Modelo de Dados

O modelo de dados detalhado está documentado em:

**Arquivo:** [MD-RF098-Auditoria-Logs-Sistema.md](./MD-RF098-Auditoria-Logs-Sistema.md)

**Principais Entidades:**
- `LogGeral` - Logs gerais da aplicação
- `LogSeguranca` - Logs de eventos de segurança (autenticação, acessos)
- `AlertaConfiguracao` - Configuração de alertas automáticos
- `LogExportacao` - Auditoria de exportações de logs

**Campos Obrigatórios Multi-Tenancy:**
- `EmpresaId` (Guid) - Isolamento por empresa (NULL para logs de sistema)

**Campos Obrigatórios Auditoria:**
- `Created`, `CreatedBy`, `LastModified`, `LastModifiedBy`

**Índices Críticos:**
- `IX_LogGeral_Timestamp_Severidade_EmpresaId` - Performance de busca
- `IX_LogGeral_CorrelationId` - Rastreamento de requisições
- `IX_LogSeguranca_TipoEvento_Timestamp` - Análise de segurança

---

## 8. DEPENDÊNCIAS

### 8.1 RFs Upstream (Dependências)

| RF | Título | Motivo |
|----|--------|--------|
| RF-002 | Auditoria de Dados | Usa AuditInterceptor para auditoria de configurações de logs/alertas |
| RF-005 | i18n Multi-idioma | Todas as mensagens e labels devem suportar pt-BR, en, es |
| RF-006 | Gestão de Usuários | Logs devem referenciar UsuarioId e exibir UsuarioNome |
| RF-007 | Gestão de Perfis | RBAC de logs depende de matriz Permission → Role → User |
| RF-008 | Gestão de Empresas | Multi-tenancy com EmpresaId obrigatório |

### 8.2 RFs Downstream (Dependentes deste RF)

| RF | Título | Motivo |
|----|--------|--------|
| RF-087 | Integrações e APIs Externas | Logs de execução de integrações dependem deste RF |
| RF-099 | Auditoria de Acessos | Logs de acessos a recursos críticos dependem deste RF |
| TODOS | - | Todos os RFs loggam eventos usando este framework |

### 8.3 Bibliotecas e Dependências Externas

**Backend:**
- `Serilog` (>= 3.1.0) - Framework de logging estruturado
- `Serilog.Sinks.ApplicationInsights` (>= 4.0.0) - Sink para Application Insights
- `Serilog.Enrichers.Environment` - Enriquecimento de contexto (machine name, etc)
- `Serilog.Enrichers.Thread` - Enriquecimento com thread ID
- `Microsoft.ApplicationInsights.AspNetCore` (>= 2.22.0) - SDK Application Insights

**Frontend:**
- `@jsverse/transloco` - Internacionalização
- `apexcharts` - Gráficos do dashboard
- `date-fns` - Manipulação de datas para filtros de período

**Infraestrutura:**
- **Application Insights** - Serviço Azure para monitoramento em tempo real
- **Azure Blob Storage** - Armazenamento temporário de arquivos de exportação
- **Hangfire** - Jobs de limpeza de logs expirados

---

## 9. KPIs E MÉTRICAS

### 9.1 KPIs de Performance

| KPI | Descrição | Meta | Medição |
|-----|-----------|------|---------|
| **Latência de Busca** | Tempo de resposta de query de logs | < 2 segundos (p95) | Application Insights - Request Duration |
| **Throughput de Logging** | Quantidade de logs processados por segundo | > 1000 logs/s sem degradação | Serilog metrics + Application Insights |
| **Taxa de Falha de Envio** | Percentual de logs que falharam ao enviar para Application Insights | < 0.1% | (Falhas / Total) * 100 |
| **Disponibilidade do Dashboard** | Uptime do endpoint `/api/logs/dashboard` | > 99.9% | Application Insights - Availability Tests |

### 9.2 KPIs de Negócio

| KPI | Descrição | Meta | Medição |
|-----|-----------|------|---------|
| **Tempo Médio de Investigação** | Tempo para encontrar causa raiz de um incidente usando logs | < 10 minutos | Survey com equipe de suporte |
| **Taxa de Exportação** | Percentual de buscas que resultam em exportação | < 5% (exportação é exceção) | (Exportações / Buscas) * 100 |
| **Alertas com Ação** | Percentual de alertas disparados que resultaram em ação corretiva | > 80% | Auditoria manual de alertas |
| **Conformidade LGPD** | Percentual de logs sem dados sensíveis em texto claro | 100% | Scan automatizado semanal |

### 9.3 Cálculo de KPIs

**Latência de Busca (p95):**
```
Query: requests
| where name == "GET /api/logs"
| summarize percentile(duration, 95) by bin(timestamp, 1h)
```

**Taxa de Falha de Envio:**
```
(Total de logs com campo SendToAppInsightsFailed = true / Total de logs criados) * 100
```

**Throughput de Logging:**
```
Query: customMetrics
| where name == "LogsPerSecond"
| summarize avg(value) by bin(timestamp, 1m)
```

---

## 10. ALERTAS CRÍTICOS

### 10.1 Regras de Alerta Obrigatórias

| Alerta | Condição | Severidade | Ação |
|--------|----------|------------|------|
| **Taxa de Erro Crítica** | ErrorRate > 5% em janela de 10 minutos | CRÍTICO | Email para Dev Team + Webhook para PagerDuty |
| **Latência Acima do SLO** | p95 latency > 3s em janela de 5 minutos | ALTO | Email para Dev Team |
| **Application Insights Offline** | Falha no envio de logs por mais de 5 minutos | ALTO | Email para Ops Team |
| **Tentativas de Login Suspeitas** | Mais de 10 falhas de login do mesmo IP em 5 minutos | MÉDIO | Email para Security Team |
| **Exportação de Grande Volume** | Exportação > 5.000 registros | BAIXO | Notificação in-app para Auditor |
| **Logs de Sistema Críticos** | Qualquer log com severidade Critical | CRÍTICO | Email para Dev Team + Notificação in-app |

### 10.2 Configuração de Alertas

**Cooldown Mínimo:** 5 minutos (evitar spam de alertas)

**Canais de Notificação:**
- Email (SMTP configurado)
- Webhook (integração com PagerDuty, Slack, Teams)
- Notificação in-app (SignalR push notification)

**Formato de Notificação:**
```
Assunto: [ALERTA CRÍTICO] Taxa de Erro Crítica - IControlIT

Alerta: Taxa de Erro Crítica
Severidade: CRÍTICO
Condição Disparada: ErrorRate = 7.8% (threshold: 5%)
Janela de Tempo: Últimos 10 minutos
Timestamp: 2025-12-31 14:30:00 UTC

Detalhes:
- Total de Requisições: 12.345
- Total de Erros: 963
- Top 3 Erros:
  1. Timeout ao chamar API externa (345 ocorrências)
  2. Database connection timeout (234 ocorrências)
  3. Null reference exception (123 ocorrências)

Ação Recomendada: Investigar logs em /auditoria/logs?severidade=Error,Critical&dataInicio=2025-12-31T14:20:00Z

Correlation IDs Afetados: [guid1, guid2, guid3...]
```

---

## 11. CENTRAL DE FUNCIONALIDADES

### 11.1 Registro de Funcionalidade

**Código:** `AUD.LOGS`
**Nome:** Auditoria de Logs
**Descrição:** Sistema completo de logging, busca avançada, exportação e monitoramento de eventos da aplicação
**Módulo:** Auditoria
**Ícone:** `heroicons_outline:document-text`
**Rota:** `/auditoria/logs`
**Ordem:** 1
**Ativo:** true
**Permissão Requerida:** `AUD.LOGS.VIEW`

### 11.2 Sub-Funcionalidades

1. **Busca de Logs** (`AUD.LOGS.SEARCH`)
   - Filtros dinâmicos (período, severidade, módulo, usuário, empresa)
   - Paginação e ordenação
   - Busca livre em mensagem/exception

2. **Detalhes de Log** (`AUD.LOGS.VIEW`)
   - Visualização completa de log individual
   - Stack trace formatado
   - Contexto estruturado (JSON)

3. **Exportação de Logs** (`AUD.LOGS.EXPORT`)
   - Formatos: CSV, JSON, Excel
   - Limite de 10.000 registros
   - Download temporário (expira em 1 hora)

4. **Logs de Segurança** (`AUD.LOGS.SEGURANCA_VIEW`)
   - Eventos de autenticação
   - Tentativas de acesso negado
   - Mudanças de permissão
   - Retenção mínima de 365 dias

5. **Dashboard de Monitoramento** (`AUD.DASHBOARD`)
   - Total de eventos por severidade (24h)
   - Top 10 erros
   - Gráfico de eventos ao longo do tempo
   - Status de integração com Application Insights

6. **Alertas Configuráveis** (`AUD.ALERTAS`)
   - Criação de regras de alerta
   - Configuração de destinatários
   - Cooldown para evitar spam
   - Múltiplos canais (email, webhook, in-app)

7. **Configuração de Retenção** (`AUD.LOGS.RETENCAO_CONFIG`)
   - Períodos diferenciados por severidade
   - Job automático de limpeza
   - Otimização de armazenamento

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-31 | Migração para Governança v2.0 - Separação RF/RL, 11 seções, 15 RNs, 10 endpoints, 10 permissões RBAC | Agência ALC - alc.dev.br |
| 1.0 | 2025-11-15 | Versão inicial com documentação técnica detalhada | Agência ALC - alc.dev.br |

---

**FIM DO DOCUMENTO**
