# RF098: Auditoria de Logs do Sistema

**Vers√£o**: 1.0 | **Data**: 2025-12-28
**RF Relacionado**: RF004, RF095, RF096 | **EPIC**: EPIC010-AUD-Auditoria-Avan√ßada
**Fase**: Fase 6 - Ativos, Auditoria e Integra√ß√µes

---

## 1. RESUMO EXECUTIVO

### 1.1 Descri√ß√£o Geral

Este requisito especifica o m√≥dulo **Auditoria de Logs do Sistema** do IControlIT, respons√°vel por centralizar, estruturar, armazenar e disponibilizar logs de toda a infraestrutura da aplica√ß√£o de forma controlada, rastre√°vel e conform√°vel com regulamenta√ß√µes.

O sistema registra eventos operacionais em tempo real (erros, avisos, informa√ß√µes, depura√ß√£o) com contexto completo (usu√°rio, IP, timestamp UTC, correla√ß√£o de requisi√ß√£o), centraliza em reposit√≥rio √∫nico (Azure Application Insights), fornece ferramentas avan√ßadas de busca e correla√ß√£o, implementa alertas autom√°ticos para eventos cr√≠ticos, gera m√©tricas de observabilidade (RED: Rate, Errors, Duration), suporta integra√ß√£o SIEM para investiga√ß√£o de seguran√ßa e cumpre reten√ß√£o de dados conforme legisla√ß√£o.

O m√≥dulo √© fundamental para detec√ß√£o e resposta a incidentes, diagn√≥stico de problemas de performance, conformidade regulat√≥ria (LGPD, SOX), investiga√ß√£o forense e compreens√£o do comportamento da plataforma em produ√ß√£o.

### 1.2 Import√¢ncia Estrat√©gica

O m√≥dulo de Auditoria de Logs √© cr√≠tico para:

- **Detec√ß√£o de Incidentes**: Identifica√ß√£o r√°pida de anomalias, ataques, falhas e comportamentos inusitados atrav√©s de an√°lise centralizada de eventos
- **Diagn√≥stico de Problemas**: Rastreamento completo de requisi√ß√µes (trace ID) permitindo investiga√ß√£o profunda de falhas intermitentes e degrada√ß√£o de performance
- **Compliance Regulat√≥rio**: Manuten√ß√£o de registros estruturados de todas as opera√ß√µes para cumprimento LGPD (direito ao esquecimento), SOX (segrega√ß√£o de fun√ß√µes, n√£o-rep√∫dio) e auditorias externas
- **Conformidade de Seguran√ßa**: Registro de tentativas de acesso n√£o autorizado, mudan√ßas cr√≠ticas de configura√ß√£o e viola√ß√µes de pol√≠tica para investiga√ß√£o forense
- **An√°lise de Performance**: Coleta de m√©tricas de observabilidade (lat√™ncia de requisi√ß√£o, taxa de erro, taxa de sucesso) para otimiza√ß√£o cont√≠nua
- **Rastreabilidade de Auditoria**: Registro imut√°vel de quem fez o qu√™, quando e com que resultado para conformidade e presta√ß√£o de contas
- **Investiga√ß√£o Forense**: Armazenamento de logs hist√≥ricos estruturados permitindo an√°lise posterior de incidentes, ataques e viola√ß√µes
- **Governan√ßa de TI**: Visibilidade em tempo real do estado da plataforma para tomada de decis√£o informada e planejamento de capacidade
- **Integra√ß√£o SIEM**: Exporta√ß√£o de eventos estruturados para plataformas de gerenciamento de seguran√ßa (Azure Sentinel) para an√°lises complexas
- **Alertas Inteligentes**: Notifica√ß√£o autom√°tica de eventos cr√≠ticos, tend√™ncias an√¥malas e viola√ß√µes de SLO para resposta r√°pida

### 1.3 Conceitos Fundamentais

**Log**: Registro estruturado de um evento ocorrido no sistema com metadados completos.

- Estrutura: `{timestamp, n√≠vel, mensagem, contexto, user, ip, correlationId, stackTrace}`
- N√≠vel: Trace (verbose, desenvolvimento), Debug (diagn√≥stico), Info (informacional), Warning (aviso), Error (erro), Critical (falha cr√≠tica)
- Imut√°vel ap√≥s registro
- Indexado para busca r√°pida

**N√≠vel de Log**: Classifica√ß√£o de severidade do evento.

- **Trace**: Mensagens muito verbosas (entrada/sa√≠da de fun√ß√£o), apenas em desenvolvimento
- **Debug**: Informa√ß√µes de diagn√≥stico (valores de vari√°veis, decis√µes), √∫til para troubleshooting
- **Info**: Eventos normais (login bem-sucedido, opera√ß√£o conclu√≠da), rastreamento de fluxo
- **Warning**: Condi√ß√µes anormais mas n√£o cr√≠ticas (quota pr√≥xima do limite, valida√ß√£o falhou), poss√≠vel indicador de problema
- **Error**: Falhas em opera√ß√µes espec√≠ficas (falha ao salvar, timeout), n√£o impede funcionamento do sistema
- **Critical**: Falhas que degradam ou impedem funcionamento da plataforma, requer a√ß√£o imediata

**Correla√ß√£o de Requisi√ß√£o**: Mecanismo que conecta m√∫ltiplos eventos relacionados.

- TraceId/CorrelationId √© gerado no ponto de entrada (API, UI)
- Propagado atrav√©s de toda a cadeia de processamento (backend, servi√ßos externos, filas)
- Permite rastreamento completo de uma requisi√ß√£o do usu√°rio at√© conclus√£o
- Essencial para diagn√≥stico de problemas distribu√≠dos

**Contexto de Log**: Metadados associados ao evento.

- `UserId`: Identifica√ß√£o do usu√°rio que causou o evento (n√£o logging de senha)
- `ClientId`: Identifica√ß√£o do cliente (multi-tenancy)
- `IP`: Endere√ßo IP da requisi√ß√£o (importante para detec√ß√£o de fraude)
- `UserAgent`: Navegador/cliente usado
- `SessionId`: Identifica√ß√£o da sess√£o do usu√°rio
- `RequestPath`: Rota da API ou p√°gina acessada
- `Method`: Verbo HTTP (GET, POST, etc.)
- `StatusCode`: C√≥digo HTTP retornado
- `ResponseTime`: Lat√™ncia da opera√ß√£o em ms
- `Exce√ß√£o**: Stack trace completo em caso de erro
- `Environment`: Identifica√ß√£o do ambiente (DEV, HOM, PRD)

**Observabilidade**: Capacidade de entender estado interno do sistema atrav√©s de dados.

- **Metrics**: Valores agregados (taxa de erro por hora, lat√™ncia p99, throughput)
- **Traces**: Rastreamento completo de requisi√ß√£o distribu√≠da
- **Logs**: Registros estruturados de eventos
- **Alertas**: Notifica√ß√µes autom√°ticas de condi√ß√µes anormais

**Reten√ß√£o de Dados**: Pol√≠tica de armazenamento e descarte de logs.

- **Online**: 30 dias em Application Insights com acesso r√°pido
- **Arquivo**: 7 anos em Azure Blob Storage com acesso sob demanda
- **Exclus√£o**: Ap√≥s 7 anos (cumprimento LGPD e padr√µes de compliance)
- **Direito ao Esquecimento**: Exclus√£o autom√°tica de logs relacionados a usu√°rios que solicitam LGPD

### 1.4 Legado vs Modernizado

| Aspecto | Legado (VB.NET + ASPX) | Modernizado (.NET 10 + Angular 19) |
|---------|------------------------|-------------------------------------|
| **Framework de Logging** | Logging simples em arquivo (EventViewer) ou banco | Serilog + Application Insights com estrutura√ß√£o completa |
| **Centraliza√ß√£o** | Logs espalhados em m√∫ltiplos servidores | Centralizado em Application Insights (nuvem) |
| **Correla√ß√£o** | Sem correla√ß√£o entre eventos | TraceId/CorrelationId autom√°tico em toda requisi√ß√£o |
| **Indexa√ß√£o** | Busca manual em arquivos de log | Indexed no Application Insights com KQL (Kusto) |
| **N√≠veis** | Prim√°rio: Error/Info | Seis n√≠veis: Trace, Debug, Info, Warning, Error, Critical |
| **Contexto** | M√≠nimo (apenas mensagem) | Completo (usu√°rio, IP, ses√£o, path, timing) |
| **Alertas** | Sem alertas autom√°ticos | Alert Rules no Application Insights com webhooks |
| **Integra√ß√£o SIEM** | N√£o integrado | Azure Sentinel com conectores nativos |
| **Reten√ß√£o** | Ad hoc, sem pol√≠tica clara | Governada (30 dias online, 7 anos backup) |
| **Conformidade** | Sem suporte a LGPD/SOX | Autom√°tico (direito ao esquecimento, segrega√ß√£o de fun√ß√µes) |
| **Observabilidade** | Ausente | RED metrics (Rate, Errors, Duration) com Grafana |
| **Performance** | Impacto vari√°vel em aplica√ß√£o | M√≠nimo (async, batching, sampling) |
| **An√°lise** | Manual via logs | Kusto Query Language (KQL) para an√°lises complexas |

### 1.5 Funcionalidades Principais

1. **Registro Estruturado de Logs** - Captura autom√°tica de eventos com estrutura padr√£o (timestamp UTC, n√≠vel, mensagem, contexto, user, IP)

2. **Suporte a Seis N√≠veis de Log** - Classifica√ß√£o completa de eventos (Trace, Debug, Info, Warning, Error, Critical) com respectivos alertas

3. **Correla√ß√£o Autom√°tica de Requisi√ß√µes** - Gera√ß√£o e propaga√ß√£o de TraceId/CorrelationId atrav√©s de toda requisi√ß√£o para rastreamento E2E

4. **Contextualiza√ß√£o Completa** - Captura autom√°tica de UserId, ClientId, IP, UserAgent, SessionId, RequestPath, StatusCode, ResponseTime

5. **Centraliza√ß√£o em Application Insights** - Armazenamento √∫nico e estruturado de todos os logs com acesso via Azure Portal e KQL

6. **Busca Avan√ßada com KQL** - Queries em linguagem Kusto permitindo an√°lises complexas (filtros, agrega√ß√µes, s√©ries temporais, gr√°ficos)

7. **Alertas Autom√°ticos** - Notifica√ß√µes imediatas para eventos cr√≠ticos, taxas de erro elevadas, lat√™ncia acima de SLO

8. **Dashboard de Sa√∫de do Sistema** - Visualiza√ß√£o em tempo real de KPIs (erros por hora, uptime, lat√™ncia p50/p95/p99, throughput)

9. **Detec√ß√£o de Padr√µes de Erro** - Identifica√ß√£o autom√°tica de erros recorrentes, cascatas de falha, correla√ß√£o entre eventos

10. **Rastreamento de Performance** - Captura de m√©tricas de observabilidade (RED: Rate de requisi√ß√µes, Error rate, Duration/lat√™ncia)

11. **Exporta√ß√£o de Dados** - Download de logs em JSON, CSV ou integra√ß√£o com Power BI para an√°lises complexas

12. **Integra√ß√£o SIEM** - Exporta√ß√£o de eventos para Azure Sentinel para an√°lises de seguran√ßa e investiga√ß√£o de incidentes

13. **An√°lise de Tend√™ncias** - Gr√°ficos de evolu√ß√£o temporal de erros, lat√™ncia e taxa de sucesso para identifica√ß√£o de degrada√ß√£o

14. **Compliance LGPD** - Suporte a direito ao esquecimento, reten√ß√£o governada, criptografia de dados sens√≠veis

15. **M√©tricas de SLO** - Tracking autom√°tico de objetivos de disponibilidade, lat√™ncia e taxa de erro para SLAs

16. **Notifica√ß√µes Multi-canal** - Alertas via email, SMS, Teams, PagerDuty para escala√ß√£o apropriada

---

## 2. REGRAS DE NEG√ìCIO

### RN-LOG-098-01: Registro Obrigat√≥rio de Todas as Opera√ß√µes

**Descri√ß√£o**: Todo evento relevante no sistema (requisi√ß√£o HTTP, mudan√ßa de dados, erro, acesso negado) deve ser registrado automaticamente no log com contexto completo.

**Justificativa**: Garantir rastreabilidade completa para auditoria, conformidade regulat√≥ria e diagn√≥stico de problemas. Evita falhas silenciosas e facilita investiga√ß√£o forense.

**Implementa√ß√£o**:
```csharp
public class LoggingMiddleware
{
    public async Task InvokeAsync(HttpContext context, ILogger<LoggingMiddleware> logger)
    {
        var correlationId = context.Request.Headers.GetOrAddTraceId();
        var startTime = DateTime.UtcNow;

        try
        {
            await _next(context);

            var duration = DateTime.UtcNow - startTime;
            var logLevel = context.Response.StatusCode >= 400 ? LogLevel.Warning : LogLevel.Information;

            logger.Log(logLevel,
                "HTTP {Method} {Path} completed with status {StatusCode} in {Duration}ms",
                context.Request.Method,
                context.Request.Path,
                context.Response.StatusCode,
                duration.TotalMilliseconds);
        }
        catch (Exception ex)
        {
            logger.LogError(ex,
                "Unhandled exception in HTTP {Method} {Path}",
                context.Request.Method,
                context.Request.Path);
            throw;
        }
    }
}
```

**Exemplos**:
- ‚úÖ Requisi√ß√£o GET /api/logs registrada com correlationId, usu√°rio, IP, lat√™ncia
- ‚ùå Opera√ß√£o executada sem log ‚Üí Viola√ß√£o de compliance, impossibilita auditoria

---

### RN-LOG-098-02: Contexto Completo Obrigat√≥rio

**Descri√ß√£o**: Todo log deve incluir obrigatoriamente: timestamp UTC, n√≠vel, mensagem, UserId, ClientId, IP, TraceId, RequestPath, StatusCode, ResponseTime.

**Justificativa**: Contexto completo √© essencial para diagn√≥stico eficiente e correla√ß√£o de eventos em ambiente distribu√≠do. Sem contexto, log torna-se in√∫til.

**Implementa√ß√£o**:
```csharp
public static class LogExtensions
{
    public static void LogWithContext(this ILogger logger, LogLevel level,
        Exception ex, string messageTemplate, params object[] args)
    {
        using (LogContext.PushProperty("UserId", GetCurrentUserId()))
        using (LogContext.PushProperty("ClientId", GetCurrentClientId()))
        using (LogContext.PushProperty("IP", GetClientIP()))
        using (LogContext.PushProperty("SessionId", GetSessionId()))
        {
            logger.Log(level, ex, messageTemplate, args);
        }
    }
}

// Configura√ß√£o Serilog
Log.Logger = new LoggerConfiguration()
    .MinimumLevel.Is(LogEventLevel.Information)
    .Enrich.FromLogContext()
    .Enrich.WithMachineName()
    .Enrich.WithEnvironmentUserName()
    .Enrich.WithProperty("Environment", environment)
    .WriteTo.Console()
    .WriteTo.ApplicationInsights(
        telemetryClient,
        TelemetryConverter.Traces,
        LogEventLevel.Information)
    .CreateLogger();
```

**Exemplos**:
- ‚úÖ Log: `{"timestamp":"2025-12-28T10:30:45Z","level":"Error","userId":"USR-001","clientId":"CLI-001","ip":"192.168.1.100","traceId":"abc123","message":"Falha ao salvar usu√°rio"}`
- ‚ùå Log: `"Erro no sistema"` ‚Üí Falta contexto, impossibilita correla√ß√£o

---

### RN-LOG-098-03: N√≠veis de Log Conforme Severidade

**Descri√ß√£o**: Eventos devem usar n√≠vel apropriado: Trace (muito verboso), Debug (diagn√≥stico), Info (normal), Warning (anormal mas n√£o cr√≠tico), Error (falha), Critical (degrada√ß√£o da plataforma).

**Justificativa**: Permite filtra√ß√£o eficiente, alertas apropriados e diferencia√ß√£o entre eventos normais e problemas reais. Reduz ru√≠do.

**Implementa√ß√£o**:
```csharp
public class LogLevelStrategy
{
    public void LogEvent(string eventType, object data, Exception ex = null)
    {
        switch (eventType)
        {
            case "UserLogin":
                _logger.LogInformation("Usu√°rio {UserId} realizou login com sucesso", data);
                break;

            case "ValidationFailed":
                _logger.LogWarning("Valida√ß√£o falhou para {Entity}: {Reason}", data.Type, data.Reason);
                break;

            case "DatabaseError":
                _logger.LogError(ex, "Erro na base de dados ao executar {Query}", data);
                break;

            case "ServiceCrash":
                _logger.LogCritical(ex, "Servi√ßo {Service} parou inesperadamente", data);
                break;

            case "VariableValue":
                _logger.LogDebug("Vari√°vel {Name} = {Value}", data.Name, data.Value);
                break;

            case "FunctionEntry":
                _logger.LogTrace("Entrando em {Method} com par√¢metros: {Params}", data.Method, data.Params);
                break;
        }
    }
}
```

**Exemplos**:
- ‚úÖ Error: Falha ao conectar em banco de dados
- ‚úÖ Warning: Tentativa de acesso negado (sem erro no sistema)
- ‚úÖ Info: Opera√ß√£o CRUD completada com sucesso
- ‚ùå Critical: Falha na autentica√ß√£o (deve ser Warning ou Error, n√£o Critical)

---

### RN-LOG-098-04: TraceId Obrigat√≥rio para Rastreamento E2E

**Descri√ß√£o**: Todo contexto de execu√ß√£o (requisi√ß√£o HTTP, job background, integra√ß√£o) deve ter TraceId √∫nico que √© propagado atrav√©s de todas as camadas.

**Justificativa**: Permite correla√ß√£o completa de eventos distribu√≠dos, essencial para diagn√≥stico em microservi√ßos e processamento ass√≠ncrono.

**Implementa√ß√£o**:
```csharp
public class TraceIdMiddleware
{
    public async Task InvokeAsync(HttpContext context)
    {
        var traceId = context.Request.Headers.GetValueOrDefault("X-Trace-Id")
                      ?? Activity.Current?.Id
                      ?? context.TraceIdentifier;

        using var activity = new Activity("HttpRequest").Start();
        activity.Id = traceId;

        using (LogContext.PushProperty("TraceId", traceId))
        using (LogContext.PushProperty("CorrelationId", traceId))
        {
            context.Items["TraceId"] = traceId;
            await _next(context);
        }
    }
}

// Propaga√ß√£o em chamadas ass√≠ncronas
public async Task ProcessAsync(string data)
{
    var traceId = GetCurrentTraceId(); // Do LogContext

    await _backgroundJobClient.EnqueueAsync(() =>
        ProcessBackgroundJob(data, traceId));
}

public void ProcessBackgroundJob(string data, string traceId)
{
    using (LogContext.PushProperty("TraceId", traceId))
    {
        _logger.LogInformation("Processando job com traceId {TraceId}", traceId);
    }
}
```

**Exemplos**:
- ‚úÖ Requisi√ß√£o: trace=abc123 ‚Üí Backend: trace=abc123 ‚Üí Banco: trace=abc123 ‚Üí Log rastre√°vel
- ‚ùå Sem TraceId ‚Üí Imposs√≠vel correlacionar eventos de uma requisi√ß√£o

---

### RN-LOG-098-05: Conformidade LGPD - N√£o Registrar Dados Sens√≠veis

**Descri√ß√£o**: Logs devem NUNCA registrar dados sens√≠veis como senhas, tokens, n√∫meros de cart√£o, CPF/CNPJ sem mascaramento.

**Justificativa**: Compliance com LGPD (Lei Geral de Prote√ß√£o de Dados) e seguran√ßa da plataforma. Exposi√ß√£o de dados sens√≠veis em logs √© vulnerabilidade cr√≠tica.

**Implementa√ß√£o**:
```csharp
public static class SensitiveDataMasking
{
    private static readonly string[] SensitivePatterns = new[]
    {
        "password", "token", "secret", "apikey",
        "creditcard", "cpf", "cnpj", "ssn"
    };

    public static string MaskSensitiveData(string input)
    {
        if (string.IsNullOrEmpty(input))
            return input;

        var maskedInput = SensitivePatterns.Aggregate(input, (current, pattern) =>
            Regex.Replace(current,
                $@"{pattern}\s*[:=]\s*([^\s,\}]+)",
                $"{pattern}=***MASKED***",
                RegexOptions.IgnoreCase));

        return maskedInput;
    }
}

// Enricher Serilog customizado
public class SensitiveDataEnricher : ILogEventEnricher
{
    public void Enrich(LogEvent logEvent, ILogEventPropertyFactory propertyFactory)
    {
        if (logEvent.MessageTemplate.Text.Contains("password", StringComparison.OrdinalIgnoreCase))
        {
            logEvent.MessageTemplate = new TextMessageTemplate("***FILTERED***");
        }
    }
}
```

**Exemplos**:
- ‚úÖ Log: `"Tentativa de login do usu√°rio USR-001 falhou"`
- ‚ùå Log: `"Login falhou para usuario@example.com com senha abc123XYZ"` ‚Üí Viola√ß√£o LGPD

---

### RN-LOG-098-06: Reten√ß√£o Governada (30 dias online, 7 anos backup)

**Descri√ß√£o**: Logs online em Application Insights s√£o retidos por 30 dias. Logs hist√≥ricos s√£o arquivados em Blob Storage por 7 anos. Exclus√£o autom√°tica ap√≥s 7 anos.

**Justificativa**: Balance entre disponibilidade (acesso r√°pido) e conformidade (reten√ß√£o legal). LGPD permite exclus√£o ap√≥s 7 anos de armazenamento.

**Implementa√ß√£o**:
```csharp
public class LogRetentionPolicy
{
    public async Task ArchiveOldLogsAsync()
    {
        var thirtyDaysAgo = DateTime.UtcNow.AddDays(-30);

        // Exportar logs com mais de 30 dias para Blob Storage
        var exportQuery = $@"
            traces
            | where timestamp < {thirtyDaysAgo:O}
            | project
                timestamp,
                severityLevel,
                message,
                customDimensions,
                tostring(operation_Id)
        ";

        var logs = await _appInsights.QueryAsync(exportQuery);

        foreach (var batch in logs.Batch(1000))
        {
            var json = JsonConvert.SerializeObject(batch);
            var fileName = $"logs-{thirtyDaysAgo:yyyy-MM-dd}-{Guid.NewGuid()}.jsonl";

            await _blobClient.UploadAsync(
                Path.Combine("logs-archive", fileName),
                BinaryData.FromString(json));
        }

        // Deletar logs com mais de 7 anos
        var sevenYearsAgo = DateTime.UtcNow.AddYears(-7);
        var deleteBlobs = _blobClient.GetBlobsAsync(
            prefix: "logs-archive/",
            states: BlobStates.All)
            .Where(b => ExtractDateFromBlob(b.Name) < sevenYearsAgo);

        foreach (var blob in deleteBlobs)
        {
            await _blobClient.DeleteBlobAsync(blob.Name);
        }
    }
}
```

**Exemplos**:
- ‚úÖ Logs de 2025-12: Acess√≠veis em tempo real no Application Insights
- ‚úÖ Logs de 2024-01: Arquivados em Blob Storage, acess√≠veis sob demanda
- ‚úÖ Logs de 2017: Deletados automaticamente (cumprimento LGPD)

---

### RN-LOG-098-07: Alertas Autom√°ticos para Erros Cr√≠ticos

**Descri√ß√£o**: Sistema deve gerar alertas autom√°ticos quando: taxa de erro > 5% por 5 minutos, lat√™ncia p95 > SLO, evento cr√≠tico registrado.

**Justificativa**: Notifica√ß√£o r√°pida permite resposta imediata a incidentes, reduzindo impacto. Sem alertas, problemas podem passar despercebidos.

**Implementa√ß√£o**:
```csharp
public class AlertRuleConfiguration
{
    public static void ConfigureAlerts(IApplicationInsightsClient client)
    {
        // Alerta 1: Taxa de erro > 5%
        var errorRateRule = new AlertRuleResource
        {
            Name = "HighErrorRate",
            Condition = new ThresholdRuleCondition
            {
                Operator = "GreaterThan",
                Threshold = 5.0,
                TimeAggregation = TimeAggregationOperator.Average,
                WindowSize = TimeSpan.FromMinutes(5)
            },
            Source = new RuleMetricDataSource
            {
                MetricName = "FailedRequests",
                MetricNamespace = "Microsoft.Insights/components"
            }
        };

        // Alerta 2: Lat√™ncia P95 > SLO
        var latencyRule = new AlertRuleResource
        {
            Name = "HighLatency",
            Condition = new ThresholdRuleCondition
            {
                Operator = "GreaterThan",
                Threshold = 2000.0, // 2 segundos
                TimeAggregation = TimeAggregationOperator.Maximum,
                WindowSize = TimeSpan.FromMinutes(5)
            },
            Source = new RuleMetricDataSource
            {
                MetricName = "AjaxCallDuration",
                MetricNamespace = "Microsoft.Insights/components"
            }
        };

        // Alerta 3: Evento cr√≠tico
        var criticalEventRule = new AlertRuleResource
        {
            Name = "CriticalEvent",
            Source = new RuleLogicDataSource
            {
                Query = @"
                    traces
                    | where severityLevel == 4 or severityLevel == 5
                    | summarize count() by bin(timestamp, 1m)
                    | where count_ > 0
                "
            }
        };
    }
}

// Webhook para integra√ß√£o com Teams
public class AlertWebhookHandler
{
    public async Task HandleAlertAsync(AlertPayload alert)
    {
        var teamsMessage = new AdaptiveCard
        {
            Body = new List<IAdaptiveElement>
            {
                new TextBlock
                {
                    Text = $"Alerta: {alert.RuleName}",
                    Weight = AdaptiveTextWeight.Bolder,
                    Size = AdaptiveTextSize.Large
                },
                new TextBlock { Text = $"Condi√ß√£o: {alert.Condition}" },
                new TextBlock { Text = $"Valor: {alert.Value}" },
                new TextBlock { Text = $"Timestamp: {alert.Timestamp:O}" }
            }
        };

        await _teamsWebhook.SendAsync(teamsMessage);
    }
}
```

**Exemplos**:
- ‚úÖ Taxa de erro 10% por 5 minutos ‚Üí Alerta enviado ao time via Teams + email
- ‚úÖ Evento Critical registrado ‚Üí Notifica√ß√£o imediata via PagerDuty
- ‚ùå Sistema com 50% de erro sem alerta ‚Üí Problema n√£o detectado, clientes impactados

---

### RN-LOG-098-08: Rastreamento Autom√°tico de Mudan√ßas Cr√≠ticas

**Descri√ß√£o**: Mudan√ßas cr√≠ticas (permiss√µes, configura√ß√µes de seguran√ßa, dados sens√≠veis) devem ser registradas com "antes" e "depois" para auditoria.

**Justificativa**: Facilita investiga√ß√£o de incidentes de seguran√ßa, compliance e demonstra quem fez o qu√™ e quando.

**Implementa√ß√£o**:
```csharp
public class CriticalChangeInterceptor : IInterceptor
{
    private readonly ILogger<CriticalChangeInterceptor> _logger;
    private readonly string[] _criticalTables = new[]
    {
        "Usuarios", "Perfis", "Permissoes", "Configuracoes", "ClienteConfigs"
    };

    public override void SaveChanges(SaveChangesInterceptorEventData eventData)
    {
        var context = eventData.Context;

        foreach (var entry in context.ChangeTracker.Entries())
        {
            if (_criticalTables.Contains(entry.Entity.GetType().Name)
                && entry.State != EntityState.Unchanged)
            {
                LogCriticalChange(entry);
            }
        }

        base.SaveChanges(eventData);
    }

    private void LogCriticalChange(EntityEntry entry)
    {
        var entityName = entry.Entity.GetType().Name;
        var keyValues = entry.Metadata.FindPrimaryKey()
            .Properties.Select(p => entry.Property(p.Name).CurrentValue);

        var changes = new Dictionary<string, object>();

        foreach (var property in entry.OriginalValues.Properties)
        {
            var original = entry.OriginalValues[property];
            var current = entry.CurrentValues[property];

            if (!Equals(original, current))
            {
                changes[property.Name] = new { Before = original, After = current };
            }
        }

        _logger.LogWarning(
            "Mudan√ßa cr√≠tica em {Entity} ({Keys}): {@Changes}",
            entityName,
            keyValues,
            changes);
    }
}
```

**Exemplos**:
- ‚úÖ Log: `Permiss√£o alterada: USR-001 antes=[read,write] depois=[admin], feito por ADM-005`
- ‚ùå Sem rastreamento de antes/depois ‚Üí Imposs√≠vel auditar mudan√ßa de permiss√µes

---

### RN-LOG-098-09: Correla√ß√£o Autom√°tica de Eventos Relacionados

**Descri√ß√£o**: O sistema deve automaticamente agrupar logs relacionados usando operationId, fazendo poss√≠vel rastrear uma requisi√ß√£o atrav√©s de toda a plataforma.

**Justificativa**: Em ambiente distribu√≠do, uma requisi√ß√£o passa por m√∫ltiplos servi√ßos. Correla√ß√£o permite diagn√≥stico eficiente de falhas.

**Implementa√ß√£o**:
```csharp
public class OperationIdPropagation
{
    public async Task<T> ExecuteWithCorrelationAsync<T>(
        Func<Task<T>> operation,
        string operationId = null)
    {
        operationId ??= Guid.NewGuid().ToString();

        using (LogContext.PushProperty("OperationId", operationId))
        using (new ActivityScope(operationId))
        {
            return await operation();
        }
    }
}

public class HttpClientLoggingHandler : DelegatingHandler
{
    protected override async Task<HttpResponseMessage> SendAsync(
        HttpRequestMessage request,
        CancellationToken cancellationToken)
    {
        var operationId = GetCurrentOperationId();
        request.Headers.Add("X-Operation-Id", operationId);
        request.Headers.Add("X-Correlation-Id", operationId);

        return await base.SendAsync(request, cancellationToken);
    }
}

// Query para correlacionar eventos
public string GetCorrelatedLogsQuery(string operationId)
{
    return $@"
        union
            (traces | where operation_Id == ""{operationId}""),
            (customEvents | where operation_Id == ""{operationId}""),
            (dependencies | where operation_Id == ""{operationId}""),
            (requests | where operation_Id == ""{operationId}"")
        | order by timestamp asc
    ";
}
```

**Exemplos**:
- ‚úÖ OperationId=op123: Requisi√ß√£o ‚Üí Backend ‚Üí Banco ‚Üí Cache ‚Üí Resposta (rastre√°vel)
- ‚ùå Sem correla√ß√£o: N√£o h√° forma de conectar 5 logs disparados pela mesma requisi√ß√£o

---

### RN-LOG-098-10: M√©tricas RED (Rate, Errors, Duration)

**Descri√ß√£o**: Sistema coleta automaticamente m√©tricas de observabilidade: Taxa de requisi√ß√µes por segundo, Taxa de erro %, Lat√™ncia (p50, p95, p99).

**Justificativa**: M√©tricas agregadas permitem detec√ß√£o de tend√™ncias e degrada√ß√£o de performance antes que afetem SLA.

**Implementa√ß√£o**:
```csharp
public class RedMetricsCollector
{
    public void ConfigureMetrics(IServiceCollection services)
    {
        var meter = new Meter("IControlIT.Observability");

        // Rate: requisi√ß√µes por segundo
        var requestCounter = meter.CreateCounter<long>(
            "http.requests.total",
            description: "Total HTTP requests");

        // Errors: taxa de erro
        var errorCounter = meter.CreateCounter<long>(
            "http.errors.total",
            description: "Total HTTP errors");

        // Duration: lat√™ncia em ms
        var durationHistogram = meter.CreateHistogram<double>(
            "http.request.duration_ms",
            description: "HTTP request duration in milliseconds");

        services.AddMetrics(builder =>
        {
            builder.AddMeter("IControlIT.Observability");
        });
    }

    public void LogRequestMetrics(string method, string path, int statusCode, double durationMs)
    {
        _requestCounter.Add(1, new KeyValuePair<string, object>("method", method));

        if (statusCode >= 400)
        {
            _errorCounter.Add(1, new KeyValuePair<string, object>("status", statusCode));
        }

        _durationHistogram.Record(durationMs);
    }
}

// Dashboard Grafana: percentis de lat√™ncia
public string GetLatencyPercentilesQuery()
{
    return @"
        requests
        | summarize
            p50 = percentile(duration, 50),
            p95 = percentile(duration, 95),
            p99 = percentile(duration, 99),
            avg = avg(duration)
            by bin(timestamp, 5m), name
        | render timechart
    ";
}
```

**Exemplos**:
- ‚úÖ Taxa: 100 req/s, Erro: 0.5%, Lat√™ncia p95: 250ms ‚Üí Sistema saud√°vel
- ‚úÖ Taxa: 50 req/s (queda), Erro: 15% (alta) ‚Üí Alerta de degrada√ß√£o

---

## 3. REFER√äNCIAS AO LEGADO

### 3.1 Banco de Dados Legado

**Banco**: `ic1_legado`

**Tabelas de Logging Existentes**:

```sql
CREATE TABLE [dbo].[LogRegistro](
    [IdLogRegistro] [int] IDENTITY(1,1) NOT NULL,
    [DataLog] [datetime] NOT NULL,
    [TipoLog] [varchar](50) NOT NULL,  -- ERROR, WARNING, INFO
    [Mensagem] [varchar](1000) NOT NULL,
    [Usuario] [varchar](50) NULL,
    [Computador] [varchar](50) NULL,
    [Excecao] [varchar](max) NULL,
    CONSTRAINT [PK_LogRegistro] PRIMARY KEY CLUSTERED ([IdLogRegistro] ASC)
);

CREATE TABLE [dbo].[LogAuditoria](
    [IdLogAuditoria] [int] IDENTITY(1,1) NOT NULL,
    [DataOperacao] [datetime] NOT NULL,
    [Usuario] [varchar](50) NOT NULL,
    [Tabela] [varchar](100) NOT NULL,
    [Operacao] [varchar](20) NOT NULL,  -- INSERT, UPDATE, DELETE
    [ValoresAntigos] [varchar](max) NULL,
    [ValoresNovos] [varchar](max) NULL,
    [RegistroId] [int] NOT NULL,
    CONSTRAINT [PK_LogAuditoria] PRIMARY KEY CLUSTERED ([IdLogAuditoria] ASC)
);

CREATE TABLE [dbo].[LogErro](
    [IdErro] [int] IDENTITY(1,1) NOT NULL,
    [DataErro] [datetime] NOT NULL,
    [Excepcao] [varchar](max) NOT NULL,
    [StackTrace] [varchar](max) NOT NULL,
    [Pagina] [varchar](500) NOT NULL,
    [Usuario] [varchar](50) NULL,
    [Parametros] [varchar](max) NULL,
    CONSTRAINT [PK_LogErro] PRIMARY KEY CLUSTERED ([IdErro] ASC)
);
```

**Campos Importantes**:

| Campo Legado | Descri√ß√£o | Uso no Modernizado |
|--------------|-----------|-------------------|
| `DataLog` | Timestamp do evento | Mapeado para `timestamp` em UTC |
| `TipoLog` | N√≠vel (ERROR, WARNING, INFO) | Expandido para 6 n√≠veis (Trace, Debug, Info, Warning, Error, Critical) |
| `Mensagem` | Descri√ß√£o do evento | Mantido, enriquecido com contexto estruturado |
| `Usuario` | Identifica√ß√£o de usu√°rio | Estruturado como `UserId` + `UserName` |
| `Excepcao` | Stack trace | Preservado, inclu√≠do em `Exception` |
| `Tabela` + `Operacao` | O que foi alterado | Mapeado para `AuditCode` (AUD_ENTIDADE_ACAO) |

### 3.2 Stored Procedures Legado

| Procedure | Descri√ß√£o | Migra√ß√£o |
|-----------|-----------|----------|
| `pa_LogRegistrar` | Insere registro de log simples | Substitu√≠do por Serilog com Application Insights |
| `pa_LogAuditar` | Registra mudan√ßa de dados | Substitu√≠do por EF Core Interceptors + Domain Events |
| `pa_LogLimpar` | Remove logs antigos | Substitu√≠do por Azure Blob archival + reten√ß√£o autom√°tica |
| `pa_LogBuscar` | Busca logs por crit√©rio | Substitu√≠do por Application Insights KQL queries |

### 3.3 Telas ASPX

| P√°gina | Descri√ß√£o | Tela Moderna |
|--------|-----------|--------------|
| `VisualizarLogs.aspx` | Visualiza√ß√£o simples de logs | `/admin/logs` (Angular + Material) |
| `RelatorioErros.aspx` | Relat√≥rio de erros por per√≠odo | `/admin/logs/errors/report` |
| `AuditoriaOperacoes.aspx` | Auditoria de mudan√ßas | `/admin/audit-log` |

### 3.4 WebServices Legado (VB.NET)

**Arquivo**: `D:\IC2\ic1_legado\WebService\WSAuditoria.asmx.vb`

| M√©todo | Descri√ß√£o | Endpoint Moderno |
|--------|-----------|-----------------|
| `ObterLogs()` | Retorna √∫ltimos 100 logs | `GET /api/logs?limit=100` |
| `BuscarErros(dataInicio, dataFim)` | Busca erros em per√≠odo | `GET /api/logs/errors?startDate=X&endDate=Y` |
| `ExportarAuditoria(tabela)` | Exporta auditoria em CSV | `GET /api/audit-log/export?table=X` |

---

## 4. INTEGRA√á√ïES OBRIGAT√ìRIAS

### 4.1 Central de Funcionalidades (Feature Flags)

**FeatureKey**: `LOG_SISTEMA_AUDITORIA`

**Configura√ß√£o**:
```json
{
    "featureKey": "LOG_SISTEMA_AUDITORIA",
    "nome": "Auditoria de Logs do Sistema",
    "descricao": "Registro centralizado e estruturado de logs com Application Insights",
    "habilitado": true,
    "isSystemFeature": true,
    "enabledFor": {
        "clients": ["*"]
    },
    "relatedFlags": [
        "LOG_ALERTAS_CRITICOS",
        "LOG_EXPORTACAO_LOGS",
        "LOG_INTEGRACAO_SIEM"
    ]
}
```

**Nota**: Feature Flags permitem ativar/desativar componentes de logging por cliente (multi-tenancy):
- LOG_ALERTAS_CRITICOS: Alertas autom√°ticos
- LOG_EXPORTACAO_LOGS: Download de logs em CSV/JSON
- LOG_INTEGRACAO_SIEM: Envio para Azure Sentinel

---

### 4.2 Internacionaliza√ß√£o (i18n)

**Chaves de Tradu√ß√£o**:

```json
{
    "audit": {
        "logs": {
            "title": "Auditoria de Logs",
            "subtitle": "Visualize e analise logs do sistema",
            "filters": {
                "level": "N√≠vel",
                "startDate": "Data Inicial",
                "endDate": "Data Final",
                "user": "Usu√°rio",
                "message": "Mensagem",
                "correlationId": "ID de Correla√ß√£o",
                "statusCode": "C√≥digo HTTP"
            },
            "levels": {
                "trace": "Rastreamento",
                "debug": "Depura√ß√£o",
                "info": "Informa√ß√£o",
                "warning": "Aviso",
                "error": "Erro",
                "critical": "Cr√≠tico"
            },
            "messages": {
                "noLogs": "Nenhum log encontrado",
                "loadingLogs": "Carregando logs...",
                "exportSuccess": "Logs exportados com sucesso",
                "exportError": "Erro ao exportar logs"
            },
            "dashboard": {
                "errorRate": "Taxa de Erro",
                "avgLatency": "Lat√™ncia M√©dia",
                "uptime": "Disponibilidade",
                "throughput": "Taxa de Requisi√ß√µes"
            },
            "alerts": {
                "highErrorRate": "Taxa de erro alta",
                "highLatency": "Lat√™ncia acima do SLO",
                "criticalEvent": "Evento cr√≠tico detectado"
            }
        }
    }
}
```

---

### 4.3 Auditoria

**Opera√ß√µes Auditadas**:

| Opera√ß√£o | C√≥digo | Dados Registrados |
|----------|--------|-------------------|
| Visualizar logs | `AUD_LOG_READ` | Filtros usados, per√≠odo, quantidade de registros retornados |
| Exportar logs | `AUD_LOG_EXPORT` | Formato (JSON/CSV), per√≠odo, quantidade de registros |
| Configurar alertas | `AUD_ALERT_UPDATE` | Regra anterior, regra nova, threshold modificado |
| Arquivar logs | `AUD_LOG_ARCHIVE` | Data de corte, quantidade de registros arquivados |
| Buscar por tra√ßo | `AUD_TRACE_SEARCH` | TraceId procurado, eventos encontrados |

**Reten√ß√£o**: 7 anos (conforme LGPD e padr√£o de compliance)

---

### 4.4 Controle de Acesso (RBAC)

**Permiss√µes**:

| Permiss√£o | Descri√ß√£o | Perfis |
|-----------|-----------|--------|
| `log:view` | Visualizar logs | Administrador, Gerente de TI, Analista de Seguran√ßa |
| `log:search` | Buscar logs com filtros avan√ßados | Gerente de TI, Analista de Seguran√ßa |
| `log:export` | Exportar logs em CSV/JSON | Gerente de TI, Analista de Compliance |
| `log:configure-alerts` | Configurar regras de alerta | Administrador, Gerente de TI |
| `log:archive` | Arquivar/restaurar logs antigos | Administrador, DBA |
| `audit:read` | Visualizar logs de auditoria | Auditor Externo, Compliance Officer |

**Nota**: Gerentes de TI podem visualizar apenas logs relacionados a seus servi√ßos. Auditores externos t√™m acesso read-only a logs de conformidade.

---

## 5. ENDPOINTS DA API

### 5.1 CRUD Principal

| M√©todo | Endpoint | Descri√ß√£o | Permiss√£o |
|--------|----------|-----------|-----------|
| GET | `/api/logs` | Listar logs com filtros (paginado) | `log:view` |
| GET | `/api/logs/{id}` | Obter detalhes de um log espec√≠fico | `log:view` |
| POST | `/api/logs/search` | Busca avan√ßada com KQL | `log:search` |
| PUT | `/api/logs/{id}` | Atualizar anota√ß√µes de log | `log:update` |
| DELETE | `/api/logs/{id}` | Excluir log (exceto cr√≠ticos/auditoria) | `log:delete` |

### 5.2 Opera√ß√µes Especiais

| M√©todo | Endpoint | Descri√ß√£o | Permiss√£o |
|--------|----------|-----------|-----------|
| GET | `/api/logs/export` | Exportar logs em CSV/JSON | `log:export` |
| GET | `/api/logs/dashboard` | M√©tricas agregadas (taxa erro, lat√™ncia) | `log:view` |
| POST | `/api/logs/alerts/configure` | Criar/atualizar regra de alerta | `log:configure-alerts` |
| GET | `/api/logs/alerts/active` | Listar alertas ativos | `log:view` |
| GET | `/api/logs/correlation/{traceId}` | Obter todos logs relacionados a um tra√ßo | `log:search` |
| GET | `/api/logs/metrics/red` | M√©tricas RED (Rate, Errors, Duration) | `log:view` |
| POST | `/api/logs/archive` | Arquivar logs com mais de 30 dias | `log:archive` |
| GET | `/api/audit-log` | Visualizar logs de auditoria de sistema | `audit:read` |
| GET | `/api/logs/performance` | An√°lise de performance por endpoint | `log:view` |
| POST | `/api/logs/incidents/create` | Criar incidente baseado em logs | `log:create-incident` |
| GET | `/api/logs/trends` | An√°lise de tend√™ncias (s√©rie temporal) | `log:view` |
| GET | `/api/logs/siem/export` | Exportar para Azure Sentinel | `log:export` |
| POST | `/api/logs/retention/configure` | Configurar pol√≠tica de reten√ß√£o | `log:configure` |

---

## 6. FLUXOS PRINCIPAIS

### 6.1 Fluxo de Registro Autom√°tico de Log

```
Requisi√ß√£o HTTP entra
    |
    v
Middleware captura TraceId/CorrelationId
    |
    v
Middleware registra: timestamp, method, path, user, client
    |
    v
Requisi√ß√£o √© processada
    |
    +---> Sucesso (200-299)
    |     |
    |     v
    |     Logger.LogInformation
    |     N√≠vel: Info
    |     Contexto: status, lat√™ncia, registros retornados
    |
    +---> Erro de cliente (400-499)
    |     |
    |     v
    |     Logger.LogWarning
    |     N√≠vel: Warning
    |     Contexto: status, erro de valida√ß√£o, par√¢metros
    |
    +---> Erro de servidor (500-599)
          |
          v
          Logger.LogError (com Exception)
          N√≠vel: Error
          Contexto: status, stacktrace, usu√°rio, tentativas
          |
          v
          Se severidade cr√≠tica:
            +---> Dispara Alerta via Teams/Email
                  |
                  v
                  Notifica time de opera√ß√µes

Log estruturado enviado para Application Insights
    |
    v
Indexado em tempo real (< 1 segundo)
    |
    v
Dispon√≠vel para busca via KQL
    |
    v
Ap√≥s 30 dias: Arquivado em Blob Storage
    |
    v
Ap√≥s 7 anos: Deletado automaticamente (LGPD)
```

### 6.2 Fluxo de Investiga√ß√£o de Incidente via Rastreamento

```
Usu√°rio relata "Sua requisi√ß√£o falhou"
    |
    v
Usu√°rio fornece timestamp (~10:30)
    |
    v
Admin busca em /api/logs/dashboard
    |
    v
Filtra por per√≠odo (10:25-10:35)
    |
    v
Identifica 50 erros de timeout naquele per√≠odo
    |
    v
Procura por padr√£o:
    "Duration > 5000 AND StatusCode = 504"
    |
    v
Encontra correla√ß√£o: API X chamou servi√ßo Y
    |
    v
Busca logs do servi√ßo Y naquele per√≠odo:
    GET /api/logs/correlation/{service-Y-traceId}
    |
    v
Visualiza sequ√™ncia:
    10:30:01 -> Requisi√ß√£o chegou
    10:30:02 -> Conectou ao banco
    10:30:07 -> Timeout na query
    |
    v
Root cause: √çndice da tabela estava sendo reconstru√≠do
    |
    v
Cria ticket de corre√ß√£o com evid√™ncia (logs exportados)
```

### 6.3 Fluxo de Alerta Autom√°tico

```
Logger registra evento Critical
    |
    v
Serilog enriquece com contexto (user, ip, trace)
    |
    v
Envia para Application Insights
    |
    v
Alert Rule detecta severityLevel = Critical
    |
    v
Dispara webhook para Teams
    |
    v
Teams envia mensagem formatada:
    [üö®] ALERTA CR√çTICO
    Evento: ServiceCrash
    Severidade: Critical
    Timestamp: 2025-12-28T10:30:45Z
    Usu√°rio: ADM-001
    Descri√ß√£o: Servi√ßo X parou inesperadamente
    TraceId: abc123
    |
    v
Se escala√ß√£o autom√°tica est√° ativa:
    |
    +---> Cria PagerDuty incident
    |
    +---> SMS para Gerente de TI
    |
    v
DevOps acessa /api/logs/correlation/{traceId}
    |
    v
V√™ hist√≥rico completo do erro
    |
    v
Reinicia servi√ßo + documenta em wiki
```

---

## 7. SEGURAN√áA

### 7.1 Prote√ß√µes Implementadas

| Prote√ß√£o | Descri√ß√£o |
|----------|-----------|
| **Mascaramento de Dados Sens√≠veis** | Passwords, tokens, cart√µes, CPF nunca aparecem em logs (regex + enricher customizado) |
| **Isolamento Multi-tenant** | Logs de Cliente A n√£o s√£o acess√≠veis por Cliente B (Row-Level Security via ClienteId) |
| **Criptografia em Tr√¢nsito** | HTTPS/TLS 1.2+ obrigat√≥rio, Application Insights usa HTTPS |
| **Criptografia em Repouso** | Logs em Blob Storage criptografados com Azure Storage Encryption |
| **Acesso Baseado em Fun√ß√£o** | RBAC obriga permiss√£o `log:view` para ver qualquer log |
| **Auditoria de Acesso** | Toda busca de logs √© registrada com usu√°rio, per√≠odo, filtros (audit trail) |
| **Reten√ß√£o Limitada** | Logs deletados automaticamente ap√≥s 7 anos (LGPD) |
| **Direito ao Esquecimento** | Job autom√°tico identifica e deleta logs de usu√°rio que solicitou LGPD |
| **Rate Limiting** | M√°ximo 100 buscas por minuto por usu√°rio (evita DoS via logs) |
| **Integridade de Log** | Logs n√£o podem ser editados (apenas anota√ß√µes em campo separado) |

### 7.2 Testes de Seguran√ßa Obrigat√≥rios

- [ ] Tentativa de acessar log de outro cliente ‚Üí Retorna 403 Forbidden
- [ ] Tentativa de buscar "password" em logs ‚Üí Retorna resultados mascarados (***MASKED***)
- [ ] Tentativa de deletar log cr√≠tico ‚Üí Retorna 403 Forbidden
- [ ] Tentativa sem permiss√£o `log:view` ‚Üí Retorna 403 Forbidden
- [ ] Injection de KQL em busca (`'; drop table logs`) ‚Üí Sanitizado, seguro
- [ ] Rate limit (101¬™ busca no minuto) ‚Üí Retorna 429 Too Many Requests
- [ ] Busca de 1 milh√£o de registros ‚Üí Paginado automaticamente (max 1000 por p√°gina)
- [ ] XSS em filtro de mensagem ‚Üí Sanitizado em HTML antes de render
- [ ] CSRF em POST /logs/alerts/configure ‚Üí Token CSRF validado
- [ ] Tentativa de acessar API sem autentica√ß√£o ‚Üí Retorna 401 Unauthorized

---

## 8. M√âTRICAS E INDICADORES

### 8.1 KPIs

| KPI | Meta | Medi√ß√£o |
|-----|------|---------|
| **Tempo de Busca de Log** | < 2 segundos | Query em KQL contra Application Insights (p95) |
| **Lat√™ncia M√©dia de Requisi√ß√£o** | < 500ms | percentile(duration, 50) em /api/logs |
| **Taxa de Disponibilidade** | > 99.9% | uptime de Application Insights |
| **Cobertura de Logs** | 100% | Todas as opera√ß√µes registradas (auditoria manual) |
| **Taxa de Falso Positivo em Alertas** | < 5% | Alertas que dispararam mas n√£o era problema real |
| **Tempo de Resposta a Alerta Cr√≠tico** | < 5 minutos | Tempo m√©dio do disparo at√© primeiro log de a√ß√£o |
| **Reten√ß√£o de Dados** | 30 dias online, 7 anos backup | Dias de reten√ß√£o em Application Insights |
| **Taxa de Corrup√ß√£o de Log** | 0% | Logs corrompidos ou perdidos (deve ser zero) |
| **Conformidade LGPD** | 100% | Dados sens√≠veis mascarados, direito ao esquecimento implementado |

### 8.2 Alertas

| Alerta | Condi√ß√£o | A√ß√£o |
|--------|----------|------|
| **Taxa de Erro Alta** | Taxa de erro > 5% por 5 minutos | Notificar Teams + email, criar PagerDuty |
| **Lat√™ncia Acima de SLO** | p95 > 2000ms por 10 minutos | Notificar Gerente de TI, escalar se persiste |
| **Evento Cr√≠tico** | severityLevel == Critical | Alerta imediato via SMS + Teams + PagerDuty |
| **Falha de Indexa√ß√£o** | Logs n√£o aparecem no Insights em 30s | Alertar DBA, verificar pipeline |
| **Espa√ßo em Disco Baixo** | Storage < 10% | Aumentar capacidade, revis√£o de reten√ß√£o |
| **Taxa de Alerta An√¥mala** | Quantidade de alertas > 3x m√©dia hist√≥rica | Poss√≠vel ataque ou problema subjacente |
| **Servi√ßo N√£o Registrando Logs** | Servi√ßo X sem logs por 5 minutos | Verificar conectividade, status do servi√ßo |
| **Viola√ß√£o de Acesso** | Tentativa de acessar log de outro cliente | Alerta de seguran√ßa, investiga√ß√£o forense |

---

## 9. PR√ìXIMOS PASSOS

1. **Modelo de Dados**: Criar [MD-RF098](/docs/rf/Fase-6-Ativos-Auditoria-Integracoes/EPIC010-AUD-Auditoria-Avancada/RF098-Auditoria-Logs-Sistema/MD-RF098.md)

2. **Casos de Uso**: Criar [UC-RF098](/docs/rf/Fase-6-Ativos-Auditoria-Integracoes/EPIC010-AUD-Auditoria-Avancada/RF098-Auditoria-Logs-Sistema/UC-RF098.md)

3. **Fluxos de Tela**: Criar [WF-RF098](/docs/rf/Fase-6-Ativos-Auditoria-Integracoes/EPIC010-AUD-Auditoria-Avancada/RF098-Auditoria-Logs-Sistema/WF-RF098.md)

4. **User Stories**: Criar [user-stories.yaml](/docs/rf/Fase-6-Ativos-Auditoria-Integracoes/EPIC010-AUD-Auditoria-Avancada/RF098-Auditoria-Logs-Sistema/user-stories.yaml)

5. **Implementa√ß√£o Backend**: Serilog, Application Insights, Alert Rules, RBAC filters

6. **Implementa√ß√£o Frontend**: Angular dashboard, filtros, exporta√ß√£o, gr√°ficos

7. **Testes**: Cen√°rios de logging, correla√ß√£o, alertas, conformidade LGPD

---

## CHANGELOG

| Vers√£o | Data | Descri√ß√£o | Autor |
|--------|------|-----------|-------|
| 1.0 | 2025-12-28 | Vers√£o inicial baseada em RF.md | Claude Code |

---

**√öltima Atualiza√ß√£o**: 2025-12-28
**Autor**: Claude Code
**Revis√£o**: Pendente de aprova√ß√£o
