# =============================================
# UC - Casos de Uso (Contrato Comportamental)
# RF034 - Gestão de Itens de Auditoria
# Versão: 2.0
# Autor padrão: Agência ALC - alc.dev.br
# =============================================

uc:
  rf: "RF034"
  versao: "2.0"
  data: "2025-12-31"

casos_de_uso:

  - id: "UC00"
    nome: "Listar Itens de Auditoria"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      rf_items:
        - "F01"  # CRUD Completo
        - "F10"  # Dashboard de Glosas
        - "F14"  # Multi-tenancy
      uc_items:
        - id: "FP-UC00-001"
          title: "Usuário acessa Auditoria → Itens de Auditoria"
          required: true
        - id: "FP-UC00-002"
          title: "Sistema valida permissão AUD.ITENS.VIEW"
          required: true
        - id: "FP-UC00-003"
          title: "Sistema carrega itens do tenant (Global Query Filter por ConglomeradoId)"
          required: true
        - id: "FP-UC00-004"
          title: "Sistema aplica paginação (20 itens/página) e ordenação padrão (data DESC)"
          required: true
        - id: "FP-UC00-005"
          title: "Sistema exibe grid com colunas: Lote, Bilhete, Ativo, Operadora, ValorCobrado, ValorCorreto, Glosa, Divergência%, Status"
          required: true
        - id: "FP-UC00-006"
          title: "Sistema exibe totalizadores no rodapé: Total Glosa, Total Itens"
          required: true
        - id: "FA-UC00-001"
          title: "Filtrar por Lote (AAAAMM)"
          required: false
        - id: "FA-UC00-002"
          title: "Filtrar por Operadora"
          required: false
        - id: "FA-UC00-003"
          title: "Filtrar por Criticidade (Crítica >10%, Alta 5-10%, Média 1-5%, Baixa <1%)"
          required: false
        - id: "FA-UC00-004"
          title: "Ordenar por coluna (Glosa, Divergência, Data)"
          required: false
        - id: "FA-UC00-005"
          title: "Exportar lista filtrada para Excel/CSV"
          required: false
        - id: "FE-UC00-001"
          title: "Usuário sem permissão → HTTP 403 Acesso negado"
          required: true
        - id: "FE-UC00-002"
          title: "Nenhum registro encontrado → estado vazio"
          required: true
        - id: "FE-UC00-003"
          title: "Filtro de lote inválido → HTTP 400"
          required: true

    precondicoes:
      - permissao: "AUD.ITENS.VIEW"

    gatilho: "Usuario acessa funcionalidade pelo menu Auditoria"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessa_menu_auditoria"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "aplicar_filtro_tenant"
      - passo: 4
        ator: "sistema"
        acao: "aplicar_paginacao"
      - passo: 5
        ator: "sistema"
        acao: "exibir_grid_itens"
      - passo: 6
        ator: "sistema"
        acao: "exibir_totalizadores"

    fluxos_alternativos:
      - id: "FA-UC00-01"
        condicao: "usuario_aplica_filtro"
        resultado: "lista_filtrada_exibida"

    fluxos_excecao:
      - id: "FE-UC00-01"
        condicao: "sem_permissao"
        resultado: "acesso_negado_403"
      - id: "FE-UC00-02"
        condicao: "nenhum_registro"
        resultado: "estado_vazio"

    regras_aplicadas:
      - "RN-RF034-013"  # Multi-tenancy
      - "RN-RF034-014"  # Índices para performance

    resultado_final:
      estado: "lista_exibida_com_totalizadores"

  - id: "UC01"
    nome: "Criar Item de Auditoria"
    ator_principal: "usuario_autenticado"
    tipo: "crud"
    impacta_dados: true

    covers:
      rf_items:
        - "F01"   # CRUD Completo
        - "F02"   # Detecção Automática de Divergências
        - "F03"   # Classificação de Divergências
        - "F05"   # Vinculação Inteligente
        - "F06"   # Sincronização com Resumos
        - "F11"   # Auditoria Completa
        - "F12"   # Notificações de Divergências Críticas
      uc_items:
        - id: "FP-UC01-001"
          title: "Usuário solicita criação clicando em Novo Item"
          required: true
        - id: "FP-UC01-002"
          title: "Sistema valida permissão AUD.ITENS.CREATE"
          required: true
        - id: "FP-UC01-003"
          title: "Sistema exibe formulário com campos obrigatórios"
          required: true
        - id: "FP-UC01-004"
          title: "Usuário preenche campos obrigatórios"
          required: true
        - id: "FP-UC01-005"
          title: "Sistema valida dados conforme RNs"
          required: true
        - id: "FP-UC01-006"
          title: "Sistema calcula automaticamente ValorCobradoAMais e PercentualDivergencia"
          required: true
        - id: "FP-UC01-007"
          title: "Sistema classifica criticidade (Crítica/Alta/Média/Baixa)"
          required: true
        - id: "FP-UC01-008"
          title: "Sistema cria registro com ConglomeradoId = usuário logado"
          required: true
        - id: "FP-UC01-009"
          title: "Sistema dispara Domain Event: AuditoriaItemCreated"
          required: true
        - id: "FP-UC01-010"
          title: "Handler sincroniza Resumo: incrementa TotalGlosa, QtdItens"
          required: true
        - id: "FP-UC01-011"
          title: "Sistema registra auditoria (UsuarioCriacao, DataCriacao)"
          required: true
        - id: "FP-UC01-012"
          title: "Sistema retorna HTTP 201 com ID do item criado"
          required: true
        - id: "FP-UC01-013"
          title: "Sistema exibe mensagem de sucesso com valor da glosa"
          required: true
        - id: "FA-UC01-001"
          title: "Salvar e criar outro"
          required: false
        - id: "FA-UC01-002"
          title: "Cancelar criação"
          required: false
        - id: "FE-UC01-001"
          title: "Campo obrigatório ausente → HTTP 400"
          required: true
        - id: "FE-UC01-002"
          title: "Resumo inexistente → HTTP 400"
          required: true
        - id: "FE-UC01-003"
          title: "Bilhete inexistente → HTTP 400"
          required: true
        - id: "FE-UC01-004"
          title: "Lote inválido → HTTP 400"
          required: true
        - id: "FE-UC01-005"
          title: "QuantidadeConsumo <= 0 → HTTP 400"
          required: true
        - id: "FE-UC01-006"
          title: "Valor com mais de 8 decimais → HTTP 400"
          required: true
        - id: "FE-UC01-007"
          title: "UnidadeConsumo incompatível com Tipo → HTTP 400"
          required: true
        - id: "FE-UC01-008"
          title: "Valor negativo → HTTP 400"
          required: true
        - id: "FE-UC01-009"
          title: "Erro inesperado → HTTP 500"
          required: true

    precondicoes:
      - permissao: "AUD.ITENS.CREATE"
      - estado: "resumo_auditoria_existente"
      - estado: "bilhete_existente"

    gatilho: "Usuario clica em Novo Item"

    fluxo_principal:
      - passo: 1
        ator: "sistema"
        acao: "exibir_formulario"
      - passo: 2
        ator: "usuario"
        acao: "preencher_campos"
      - passo: 3
        ator: "usuario"
        acao: "salvar"
      - passo: 4
        ator: "sistema"
        acao: "validar_dados"
      - passo: 5
        ator: "sistema"
        acao: "calcular_glosa_divergencia"
      - passo: 6
        ator: "sistema"
        acao: "classificar_criticidade"
      - passo: 7
        ator: "sistema"
        acao: "persistir_registro"
      - passo: 8
        ator: "sistema"
        acao: "disparar_domain_event"
      - passo: 9
        ator: "sistema"
        acao: "sincronizar_resumo"
      - passo: 10
        ator: "sistema"
        acao: "registrar_auditoria"

    fluxos_excecao:
      - id: "FE-UC01-01"
        condicao: "validacao_falhou"
        resultado: "exibir_erros_validacao"
      - id: "FE-UC01-02"
        condicao: "resumo_nao_encontrado"
        resultado: "http_400_resumo_nao_encontrado"
      - id: "FE-UC01-03"
        condicao: "bilhete_nao_encontrado"
        resultado: "http_400_bilhete_nao_encontrado"

    regras_aplicadas:
      - "RN-RF034-001"  # Vinculação Obrigatória
      - "RN-RF034-002"  # Cálculo Automático de Glosa
      - "RN-RF034-003"  # Precisão Numérica
      - "RN-RF034-004"  # Quantidade Positiva
      - "RN-RF034-005"  # Validação de Relacionamentos
      - "RN-RF034-006"  # Sincronização com Resumo
      - "RN-RF034-009"  # Auditoria Completa
      - "RN-RF034-011"  # Validação Unidade vs Tipo
      - "RN-RF034-013"  # Multi-tenancy

    resultado_final:
      estado: "registro_criado_glosa_calculada_resumo_sincronizado"

  - id: "UC02"
    nome: "Visualizar Item de Auditoria"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      rf_items:
        - "F01"   # CRUD Completo
        - "F11"   # Auditoria Completa
        - "F14"   # Multi-tenancy
      uc_items:
        - id: "FP-UC02-001"
          title: "Usuário seleciona item na lista"
          required: true
        - id: "FP-UC02-002"
          title: "Sistema valida permissão AUD.ITENS.VIEW"
          required: true
        - id: "FP-UC02-003"
          title: "Sistema valida tenant (item.ConglomeradoId == usuário logado)"
          required: true
        - id: "FP-UC02-004"
          title: "Sistema carrega item com todos os relacionamentos"
          required: true
        - id: "FP-UC02-005"
          title: "Sistema exibe seções: Cabeçalho, Identificação, Valores, Consumo, Relacionamentos, Observações, Auditoria"
          required: true
        - id: "FP-UC02-006"
          title: "Sistema destaca visualmente glosa positiva/negativa e divergência crítica"
          required: true
        - id: "FA-UC02-001"
          title: "Visualizar histórico de alterações"
          required: false
        - id: "FA-UC02-002"
          title: "Exportar detalhes em PDF"
          required: false
        - id: "FE-UC02-001"
          title: "Registro inexistente → HTTP 404"
          required: true
        - id: "FE-UC02-002"
          title: "Registro de outro tenant → HTTP 404"
          required: true
        - id: "FE-UC02-003"
          title: "Resumo vinculado excluído → Exibe (Resumo excluído)"
          required: true

    precondicoes:
      - permissao: "AUD.ITENS.VIEW"

    gatilho: "Usuario clica em item na listagem"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "selecionar_item"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "validar_tenant"
      - passo: 4
        ator: "sistema"
        acao: "carregar_com_relacionamentos"
      - passo: 5
        ator: "sistema"
        acao: "exibir_detalhes"

    fluxos_excecao:
      - id: "FE-UC02-01"
        condicao: "registro_nao_encontrado"
        resultado: "http_404"
      - id: "FE-UC02-02"
        condicao: "tenant_diferente"
        resultado: "http_404"

    regras_aplicadas:
      - "RN-RF034-009"  # Auditoria Completa
      - "RN-RF034-013"  # Multi-tenancy

    resultado_final:
      estado: "detalhes_exibidos"

  - id: "UC03"
    nome: "Editar Item de Auditoria"
    ator_principal: "usuario_autenticado"
    tipo: "crud"
    impacta_dados: true

    covers:
      rf_items:
        - "F01"   # CRUD Completo
        - "F02"   # Detecção Automática de Divergências
        - "F03"   # Classificação de Divergências
        - "F06"   # Sincronização com Resumos
        - "F11"   # Auditoria Completa
      uc_items:
        - id: "FP-UC03-001"
          title: "Usuário solicita edição clicando em Editar"
          required: true
        - id: "FP-UC03-002"
          title: "Sistema valida permissão AUD.ITENS.UPDATE"
          required: true
        - id: "FP-UC03-003"
          title: "Sistema valida que item não está em status Recuperado"
          required: true
        - id: "FP-UC03-004"
          title: "Sistema carrega dados atuais em formulário"
          required: true
        - id: "FP-UC03-005"
          title: "Usuário altera campos permitidos"
          required: true
        - id: "FP-UC03-006"
          title: "Sistema valida alterações (mesmas regras de UC01)"
          required: true
        - id: "FP-UC03-007"
          title: "Sistema recalcula ValorCobradoAMais e PercentualDivergencia"
          required: true
        - id: "FP-UC03-008"
          title: "Sistema reclassifica criticidade"
          required: true
        - id: "FP-UC03-009"
          title: "Sistema persiste alterações"
          required: true
        - id: "FP-UC03-010"
          title: "Sistema dispara Domain Event: AuditoriaItemUpdated com valores antes/depois"
          required: true
        - id: "FP-UC03-011"
          title: "Handler recalcula totalizadores do Resumo"
          required: true
        - id: "FP-UC03-012"
          title: "Sistema registra auditoria (UsuarioAlteracao, DataAlteracao, ValoresAntes, ValoresDepois)"
          required: true
        - id: "FP-UC03-013"
          title: "Sistema retorna HTTP 200"
          required: true
        - id: "FP-UC03-014"
          title: "Sistema exibe mensagem de sucesso com nova glosa"
          required: true
        - id: "FA-UC03-001"
          title: "Cancelar edição"
          required: false
        - id: "FE-UC03-001"
          title: "Erro de validação (mesmas de UC01)"
          required: true
        - id: "FE-UC03-002"
          title: "Item em status Recuperado → HTTP 400"
          required: true
        - id: "FE-UC03-003"
          title: "Conflito de edição concorrente → HTTP 409"
          required: true
        - id: "FE-UC03-004"
          title: "Registro de outro tenant → HTTP 404"
          required: true

    precondicoes:
      - permissao: "AUD.ITENS.UPDATE"
      - estado: "item_nao_recuperado"

    gatilho: "Usuario clica em Editar"

    fluxo_principal:
      - passo: 1
        ator: "sistema"
        acao: "exibir_formulario_preenchido"
      - passo: 2
        ator: "usuario"
        acao: "alterar_campos"
      - passo: 3
        ator: "usuario"
        acao: "salvar"
      - passo: 4
        ator: "sistema"
        acao: "validar_alteracoes"
      - passo: 5
        ator: "sistema"
        acao: "recalcular_glosa_divergencia"
      - passo: 6
        ator: "sistema"
        acao: "reclassificar_criticidade"
      - passo: 7
        ator: "sistema"
        acao: "persistir_alteracoes"
      - passo: 8
        ator: "sistema"
        acao: "disparar_domain_event"
      - passo: 9
        ator: "sistema"
        acao: "recalcular_resumo"
      - passo: 10
        ator: "sistema"
        acao: "registrar_auditoria"

    fluxos_excecao:
      - id: "FE-UC03-01"
        condicao: "validacao_falhou"
        resultado: "exibir_erros"
      - id: "FE-UC03-02"
        condicao: "status_recuperado"
        resultado: "http_400_nao_editavel"
      - id: "FE-UC03-03"
        condicao: "conflito_concorrencia"
        resultado: "http_409_conflito"

    regras_aplicadas:
      - "RN-RF034-002"  # Cálculo Automático de Glosa
      - "RN-RF034-006"  # Sincronização com Resumo
      - "RN-RF034-009"  # Auditoria Completa
      - "RN-RF034-011"  # Validação Unidade vs Tipo
      - "RN-RF034-013"  # Multi-tenancy

    resultado_final:
      estado: "registro_atualizado_resumo_sincronizado"

  - id: "UC04"
    nome: "Excluir Item de Auditoria"
    ator_principal: "usuario_autenticado"
    tipo: "crud"
    impacta_dados: true

    covers:
      rf_items:
        - "F01"   # CRUD Completo
        - "F06"   # Sincronização com Resumos
        - "F11"   # Auditoria Completa
      uc_items:
        - id: "FP-UC04-001"
          title: "Usuário solicita exclusão clicando em Excluir"
          required: true
        - id: "FP-UC04-002"
          title: "Sistema exibe confirmação"
          required: true
        - id: "FP-UC04-003"
          title: "Usuário confirma"
          required: true
        - id: "FP-UC04-004"
          title: "Sistema valida permissão AUD.ITENS.DELETE"
          required: true
        - id: "FP-UC04-005"
          title: "Sistema valida que não há dependências bloqueantes"
          required: true
        - id: "FP-UC04-006"
          title: "Sistema executa soft delete: FlExcluido = true"
          required: true
        - id: "FP-UC04-007"
          title: "Sistema registra: DataExclusao, UsuarioExclusao"
          required: true
        - id: "FP-UC04-008"
          title: "Sistema dispara Domain Event: AuditoriaItemDeleted"
          required: true
        - id: "FP-UC04-009"
          title: "Handler recalcula totalizadores do Resumo (reduz TotalGlosa, QtdItens)"
          required: true
        - id: "FP-UC04-010"
          title: "Sistema registra auditoria"
          required: true
        - id: "FP-UC04-011"
          title: "Sistema retorna HTTP 204"
          required: true
        - id: "FP-UC04-012"
          title: "Sistema exibe mensagem de sucesso"
          required: true
        - id: "FA-UC04-001"
          title: "Cancelar exclusão"
          required: false
        - id: "FE-UC04-001"
          title: "Registro já excluído → HTTP 404"
          required: true
        - id: "FE-UC04-002"
          title: "Registro de outro tenant → HTTP 404"
          required: true
        - id: "FE-UC04-003"
          title: "Erro ao sincronizar resumo → HTTP 500"
          required: true

    precondicoes:
      - permissao: "AUD.ITENS.DELETE"

    gatilho: "Usuario clica em Excluir"

    fluxo_principal:
      - passo: 1
        ator: "sistema"
        acao: "exibir_confirmacao"
      - passo: 2
        ator: "usuario"
        acao: "confirmar"
      - passo: 3
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 4
        ator: "sistema"
        acao: "executar_soft_delete"
      - passo: 5
        ator: "sistema"
        acao: "disparar_domain_event"
      - passo: 6
        ator: "sistema"
        acao: "recalcular_resumo"
      - passo: 7
        ator: "sistema"
        acao: "registrar_auditoria"

    fluxos_excecao:
      - id: "FE-UC04-01"
        condicao: "ja_excluido"
        resultado: "http_404"
      - id: "FE-UC04-02"
        condicao: "erro_sincronizacao"
        resultado: "http_500"

    regras_aplicadas:
      - "RN-RF034-006"  # Sincronização com Resumo
      - "RN-RF034-009"  # Auditoria Completa
      - "RN-RF034-012"  # Soft Delete com Recálculo
      - "RN-RF034-013"  # Multi-tenancy

    resultado_final:
      estado: "registro_excluido_resumo_atualizado"

  - id: "UC05"
    nome: "Aprovar/Contestar Item"
    ator_principal: "usuario_autenticado"
    tipo: "acao"
    impacta_dados: true

    covers:
      rf_items:
        - "F07"   # Workflow de Aprovação
        - "F11"   # Auditoria Completa
      uc_items:
        - id: "FP-UC05-001"
          title: "Usuário visualiza item (UC02)"
          required: true
        - id: "FP-UC05-002"
          title: "Sistema exibe botões conforme status atual"
          required: true
        - id: "FP-UC05-003"
          title: "Usuário clica em botão de ação"
          required: true
        - id: "FP-UC05-004"
          title: "Sistema valida permissão"
          required: true
        - id: "FP-UC05-005"
          title: "Sistema valida transição permitida"
          required: true
        - id: "FP-UC05-006"
          title: "Sistema solicita justificativa (obrigatória)"
          required: true
        - id: "FP-UC05-007"
          title: "Usuário informa justificativa"
          required: true
        - id: "FP-UC05-008"
          title: "Sistema atualiza: Status, Data, Usuário, Justificativa"
          required: true
        - id: "FP-UC05-009"
          title: "Sistema registra auditoria"
          required: true
        - id: "FP-UC05-010"
          title: "Sistema retorna HTTP 200"
          required: true
        - id: "FP-UC05-011"
          title: "Sistema exibe mensagem de sucesso"
          required: true
        - id: "FA-UC05-001"
          title: "Rejeitar item"
          required: false
        - id: "FA-UC05-002"
          title: "Cancelar ação"
          required: false
        - id: "FE-UC05-001"
          title: "Transição inválida → HTTP 400"
          required: true
        - id: "FE-UC05-002"
          title: "Justificativa ausente → HTTP 400"
          required: true
        - id: "FE-UC05-003"
          title: "Item em status final (Recuperado) → HTTP 400"
          required: true

    precondicoes:
      - permissao: "AUD.ITENS.UPDATE"

    gatilho: "Usuario clica em Aprovar/Contestar/Recuperar"

    fluxo_principal:
      - passo: 1
        ator: "sistema"
        acao: "exibir_botoes_status"
      - passo: 2
        ator: "usuario"
        acao: "clicar_acao"
      - passo: 3
        ator: "sistema"
        acao: "validar_transicao"
      - passo: 4
        ator: "sistema"
        acao: "solicitar_justificativa"
      - passo: 5
        ator: "usuario"
        acao: "informar_justificativa"
      - passo: 6
        ator: "sistema"
        acao: "atualizar_status"
      - passo: 7
        ator: "sistema"
        acao: "registrar_auditoria"

    fluxos_excecao:
      - id: "FE-UC05-01"
        condicao: "transicao_invalida"
        resultado: "http_400"
      - id: "FE-UC05-02"
        condicao: "justificativa_ausente"
        resultado: "http_400"

    regras_aplicadas:
      - "RN-RF034-009"  # Auditoria Completa

    resultado_final:
      estado: "status_atualizado_workflow_avancado"

  - id: "UC06"
    nome: "Exportar para Contestação"
    ator_principal: "usuario_autenticado"
    tipo: "acao"
    impacta_dados: false

    covers:
      rf_items:
        - "F08"   # Exportação para Contestação
        - "F11"   # Auditoria Completa
      uc_items:
        - id: "FP-UC06-001"
          title: "Usuário acessa Exportar para Contestação"
          required: true
        - id: "FP-UC06-002"
          title: "Sistema valida permissão AUD.ITENS.EXPORT"
          required: true
        - id: "FP-UC06-003"
          title: "Sistema exibe filtros: Lote, Operadora, Status, Formato"
          required: true
        - id: "FP-UC06-004"
          title: "Usuário define filtros e formato"
          required: true
        - id: "FP-UC06-005"
          title: "Sistema busca itens conforme filtros"
          required: true
        - id: "FP-UC06-006"
          title: "Sistema agrupa por operadora"
          required: true
        - id: "FP-UC06-007"
          title: "Sistema calcula subtotais por operadora"
          required: true
        - id: "FP-UC06-008"
          title: "Sistema gera documento estruturado"
          required: true
        - id: "FP-UC06-009"
          title: "Sistema registra auditoria (operação EXPORT)"
          required: true
        - id: "FP-UC06-010"
          title: "Sistema retorna arquivo para download"
          required: true
        - id: "FP-UC06-011"
          title: "Sistema exibe mensagem de sucesso"
          required: true
        - id: "FA-UC06-001"
          title: "Exportação grande (>10.000 registros) via job background"
          required: false
        - id: "FA-UC06-002"
          title: "Personalizar template"
          required: false
        - id: "FE-UC06-001"
          title: "Nenhum item encontrado → HTTP 400"
          required: true
        - id: "FE-UC06-002"
          title: "Erro ao gerar arquivo → HTTP 500"
          required: true
        - id: "FE-UC06-003"
          title: "Timeout (>30s) → enfileira job background"
          required: true

    precondicoes:
      - permissao: "AUD.ITENS.EXPORT"

    gatilho: "Usuario clica em Exportar para Contestacao"

    fluxo_principal:
      - passo: 1
        ator: "sistema"
        acao: "exibir_filtros"
      - passo: 2
        ator: "usuario"
        acao: "definir_filtros"
      - passo: 3
        ator: "sistema"
        acao: "buscar_itens"
      - passo: 4
        ator: "sistema"
        acao: "agrupar_por_operadora"
      - passo: 5
        ator: "sistema"
        acao: "calcular_subtotais"
      - passo: 6
        ator: "sistema"
        acao: "gerar_documento"
      - passo: 7
        ator: "sistema"
        acao: "registrar_auditoria"
      - passo: 8
        ator: "sistema"
        acao: "retornar_arquivo"

    fluxos_excecao:
      - id: "FE-UC06-01"
        condicao: "nenhum_item"
        resultado: "http_400"
      - id: "FE-UC06-02"
        condicao: "erro_geracao"
        resultado: "http_500"

    regras_aplicadas:
      - "RN-RF034-008"  # Exportação Estruturada
      - "RN-RF034-015"  # Exportação Excel Detalhada

    resultado_final:
      estado: "arquivo_gerado_auditoria_registrada"

  - id: "UC07"
    nome: "Buscar e Filtrar Avançado"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      rf_items:
        - "F10"   # Dashboard de Glosas
        - "F11"   # Auditoria Completa
      uc_items:
        - id: "FP-UC07-001"
          title: "Usuário acessa Buscar Avançada"
          required: true
        - id: "FP-UC07-002"
          title: "Sistema exibe campos de filtro múltiplos"
          required: true
        - id: "FP-UC07-003"
          title: "Usuário define critérios"
          required: true
        - id: "FP-UC07-004"
          title: "Sistema valida filtros"
          required: true
        - id: "FP-UC07-005"
          title: "Sistema aplica filtros cumulativos (AND)"
          required: true
        - id: "FP-UC07-006"
          title: "Sistema retorna resultados paginados"
          required: true
        - id: "FP-UC07-007"
          title: "Sistema atualiza URL com query string"
          required: true
        - id: "FA-UC07-001"
          title: "Limpar filtros"
          required: false
        - id: "FA-UC07-002"
          title: "Salvar filtro como favorito"
          required: false
        - id: "FE-UC07-001"
          title: "Filtro inválido → HTTP 400"
          required: true
        - id: "FE-UC07-002"
          title: "Nenhum resultado → estado vazio"
          required: true

    precondicoes:
      - permissao: "AUD.ITENS.VIEW"

    gatilho: "Usuario clica em Buscar Avancada"

    fluxo_principal:
      - passo: 1
        ator: "sistema"
        acao: "exibir_filtros_avancados"
      - passo: 2
        ator: "usuario"
        acao: "definir_criterios"
      - passo: 3
        ator: "sistema"
        acao: "validar_filtros"
      - passo: 4
        ator: "sistema"
        acao: "aplicar_filtros_cumulativos"
      - passo: 5
        ator: "sistema"
        acao: "retornar_resultados"
      - passo: 6
        ator: "sistema"
        acao: "atualizar_url"

    fluxos_excecao:
      - id: "FE-UC07-01"
        condicao: "filtro_invalido"
        resultado: "http_400"

    regras_aplicadas:
      - "RN-RF034-010"  # Filtros Avançados
      - "RN-RF034-014"  # Índices para Performance

    resultado_final:
      estado: "resultados_filtrados_exibidos"

  - id: "UC08"
    nome: "Gerar Relatórios Gerenciais"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      rf_items:
        - "F04"   # Cálculo de Economia Gerada
        - "F09"   # Relatórios Gerenciais
        - "F11"   # Auditoria Completa
      uc_items:
        - id: "FP-UC08-001"
          title: "Usuário acessa Relatórios"
          required: true
        - id: "FP-UC08-002"
          title: "Sistema exibe opções de relatório"
          required: true
        - id: "FP-UC08-003"
          title: "Usuário seleciona tipo de relatório"
          required: true
        - id: "FP-UC08-004"
          title: "Sistema solicita parâmetros (período, filtros)"
          required: true
        - id: "FP-UC08-005"
          title: "Sistema gera relatório consolidado"
          required: true
        - id: "FP-UC08-006"
          title: "Sistema exibe gráficos e tabelas"
          required: true
        - id: "FP-UC08-007"
          title: "Sistema permite exportar em PDF/Excel"
          required: true
        - id: "FA-UC08-001"
          title: "Agendar relatório recorrente"
          required: false
        - id: "FE-UC08-001"
          title: "Dados insuficientes → HTTP 400"
          required: true

    precondicoes:
      - permissao: "AUD.ITENS.VIEW"

    gatilho: "Usuario clica em Relatorios"

    fluxo_principal:
      - passo: 1
        ator: "sistema"
        acao: "exibir_opcoes_relatorio"
      - passo: 2
        ator: "usuario"
        acao: "selecionar_tipo"
      - passo: 3
        ator: "sistema"
        acao: "solicitar_parametros"
      - passo: 4
        ator: "usuario"
        acao: "informar_parametros"
      - passo: 5
        ator: "sistema"
        acao: "gerar_relatorio"
      - passo: 6
        ator: "sistema"
        acao: "exibir_graficos_tabelas"

    fluxos_excecao:
      - id: "FE-UC08-01"
        condicao: "dados_insuficientes"
        resultado: "http_400"

    regras_aplicadas:
      - "RN-RF034-014"  # Índices para Performance

    resultado_final:
      estado: "relatorio_gerado_exibido"

  - id: "UC09"
    nome: "Visualizar Dashboard de Glosas"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      rf_items:
        - "F04"   # Cálculo de Economia Gerada
        - "F10"   # Dashboard de Glosas
        - "F11"   # Auditoria Completa
      uc_items:
        - id: "FP-UC09-001"
          title: "Usuário acessa Dashboard de Glosas"
          required: true
        - id: "FP-UC09-002"
          title: "Sistema carrega KPIs: Total Glosa Pendente/Aprovada/Contestada/Recuperada, Taxa Recuperação, Economia Gerada"
          required: true
        - id: "FP-UC09-003"
          title: "Sistema exibe gráficos: Evolução Glosas, Distribuição Operadora, Top 10 Divergências"
          required: true
        - id: "FP-UC09-004"
          title: "Sistema atualiza automaticamente via SignalR"
          required: true
        - id: "FA-UC09-001"
          title: "Filtrar por período"
          required: false
        - id: "FE-UC09-001"
          title: "Erro ao carregar dados → exibe cache anterior"
          required: true

    precondicoes:
      - permissao: "AUD.ITENS.VIEW"

    gatilho: "Usuario clica em Dashboard de Glosas"

    fluxo_principal:
      - passo: 1
        ator: "sistema"
        acao: "carregar_kpis"
      - passo: 2
        ator: "sistema"
        acao: "exibir_graficos"
      - passo: 3
        ator: "sistema"
        acao: "iniciar_atualizacao_signalr"

    fluxos_excecao:
      - id: "FE-UC09-01"
        condicao: "erro_carregamento"
        resultado: "exibir_cache"

    regras_aplicadas:
      - "RN-RF034-014"  # Índices para Performance

    resultado_final:
      estado: "dashboard_exibido_atualizacao_real_time"

exclusions:
  uc_items: []

historico:
  - versao: "2.0"
    data: "2025-12-31"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Recriação completa alinhada ao RF034 (Auditoria de Telecom) - 10 UCs cobrindo 14 funcionalidades"
  - versao: "1.0"
    data: "2025-12-18"
    autor: "Architect Agent"
    descricao: "Versão inicial (INCORRETA - documentava RF003 em vez de RF034)"
