# RF034: Gestão de Itens de Auditoria

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC010-AUD-Auditoria-Avançada
**Fase**: Fase 6 - Ativos, Auditoria e Integrações

---

## 1. VISÃO GERAL

### 1.1 Resumo Executivo

Este requisito especifica o módulo **Gestão de Itens de Auditoria** do sistema IControlIT, responsável pelo controle detalhado e análise linha-a-linha de divergências identificadas na auditoria de faturas de telecomunicações.

O sistema registra cada bilhete (item de consumo) auditado, compara valores cobrados versus valores contratuais, identifica cobranças a maior (glosas) e gera base documental estruturada para contestações formais junto às operadoras telecom.

### 1.2 Objetivo Principal

Fornecer ferramenta completa para:
- Identificação e documentação de divergências entre valores cobrados e contratuais
- Cálculo automático de glosas (valores a recuperar)
- Geração de evidências para contestação formal
- Análise de qualidade de faturamento por operadora
- Rastreabilidade total de auditoria para conformidade LGPD e SOX

### 1.3 Escopo

**Dentro do escopo:**
- CRUD completo de itens de auditoria
- Cálculo automático de glosas e percentuais de divergência
- Vinculação com resumos de auditoria (RF035)
- Vinculação com bilhetes e faturas (RF032)
- Classificação automática de criticidade
- Sincronização com totalizadores de resumo
- Workflow de aprovação (pendente → análise → aprovado → contestado → recuperado)
- Exportação para contestação (PDF, Excel, CSV)
- Relatórios gerenciais por operadora, tipo de serviço e período
- Dashboard de glosas em tempo real
- Auditoria completa de operações
- Notificações de divergências críticas
- Multi-tenancy com Row-Level Security

**Fora do escopo:**
- Interface visual específica (definida em WF-RF034)
- Tecnologia ou framework (definida em arquitetura)
- Integração com sistemas externos de operadoras
- Negociação ou recuperação automática de glosas

### 1.4 Conceitos Fundamentais

**Auditoria de Fatura**: Processo sistemático de validação linha-a-linha de bilhetes de consumo de telecomunicação, comparando valores, quantidades e tarifas cobradas contra valores contratuais negociados.

**Bilhete**: Registro individual de consumo (ligação telefônica, tráfego de dados, SMS, roaming) com informações de origem, destino, quantidade e tarifa cobrada.

**Glosa**: Valor cobrado indevidamente pela operadora, calculado como diferença entre valor cobrado e valor contratual correto (Glosa = ValorCobrado - ValorCorreto).

**Divergência**: Diferença percentual entre valor cobrado e valor correto, usada para classificar criticidade (crítica >10%, alta 5-10%, média 1-5%, baixa <1%).

**Resumo de Auditoria**: Agregação de itens auditados em um período (RF035), com totalizadores de valores, quantidades e análises consolidadas.

---

## 2. FUNCIONALIDADES

### F01 — CRUD Completo de Itens de Auditoria

Criar, visualizar, editar e excluir itens auditados com validações automáticas de integridade referencial e cálculos de divergências.

**Prioridade**: CRÍTICA

### F02 — Detecção Automática de Divergências

Comparação automática de valores cobrados versus contratuais, gerando glosas com precisão de até 8 casas decimais conforme padrão telecomunicações (NUMERIC(13,8)).

**Prioridade**: CRÍTICA

### F03 — Classificação de Divergências

Categorização automática conforme criticidade (crítica >10%, alta 5-10%, média 1-5%, baixa <1%) para priorização de análise.

**Prioridade**: ALTA

### F04 — Cálculo de Economia Gerada

Agregação automática de glosas aprovadas por período, operadora e tipo de serviço para demonstração de ROI da auditoria.

**Prioridade**: ALTA

### F05 — Vinculação Inteligente

Relacionamento automático com bilhetes, ativos, contratos, operadoras e faturas com validação de períodos e status.

**Prioridade**: CRÍTICA

### F06 — Sincronização com Resumos

Atualização automática de totalizadores do resumo de auditoria (RF035) ao criar/editar/excluir itens via Domain Events.

**Prioridade**: CRÍTICA

### F07 — Workflow de Aprovação

Suporte a transições de estado (pendente → análise → aprovado → contestado → recuperado) com registro de aprovadores e datas.

**Prioridade**: ALTA

### F08 — Exportação para Contestação

Geração de documentos estruturados (PDF, Excel, CSV) com itens agrupados por operadora e justificativas para contestação formal.

**Prioridade**: ALTA

### F09 — Relatórios Gerenciais

Análises por operadora, tipo de serviço, período, divergência, status e usuário responsável.

**Prioridade**: MÉDIA

### F10 — Dashboard de Glosas

Visualização em tempo real de valores pendentes, aprovados, contestados e recuperados com gráficos de evolução.

**Prioridade**: MÉDIA

### F11 — Auditoria Completa

Rastreamento de todas as operações (criar, editar, excluir, aprovar) com identificação de usuário, timestamp e valores antes/depois.

**Prioridade**: CRÍTICA

### F12 — Notificações de Divergências Críticas

Alertas automáticos via SignalR para divergências acima de limite configurado (>10%) para escalação rápida.

**Prioridade**: ALTA

### F13 — Integração LGPD+SOX

Conformidade automática com retenção de 7 anos, direito ao esquecimento, criptografia de dados sensíveis.

**Prioridade**: CRÍTICA

### F14 — Multi-tenancy com Row-Level Security

Isolamento automático de dados por ClienteId com feature flags por cliente para habilitação/desabilitação.

**Prioridade**: CRÍTICA

---

## 3. REGRAS DE NEGÓCIO

### RN-RF034-001: Vinculação Obrigatória a Resumo e Bilhete

**Descrição**: Todo item de auditoria deve estar obrigatoriamente vinculado a um resumo de auditoria válido e a um bilhete específico válido.

**Justificativa**: Garante rastreabilidade completa e relacionamento bidirecional correto. Evita órfãos de dados e facilita análises consolidadas.

**Critério de Aceite**:
- Item criado sem resumo → HTTP 400 "Resumo de auditoria é obrigatório"
- Item criado sem bilhete → HTTP 400 "Bilhete é obrigatório"
- Resumo inexistente ou excluído → HTTP 400 "Resumo não encontrado ou inativo"
- Bilhete inexistente ou excluído → HTTP 400 "Bilhete não encontrado ou inativo"

---

### RN-RF034-002: Cálculo Automático de Glosa

**Descrição**: O sistema calcula automaticamente ValorCobradoAMais = ValorCobrado - ValorCorreto sem necessidade de entrada manual do usuário.

**Justificativa**: Elimina inconsistências de cálculo, garante precisão matemática e facilita auditoria.

**Critério de Aceite**:
- Campo ValorCobradoAMais é somente leitura
- Tentativa de editar diretamente → ignorado ou rejeitado
- Cálculo atualizado automaticamente ao modificar ValorCobrado ou ValorCorreto

---

### RN-RF034-003: Precisão Numérica Conforme Padrão Telecomunicações

**Descrição**: Todos os valores monetários devem ter precisão numérica de até 8 casas decimais (NUMERIC(13,8)) conforme padrão de faturamento telecomunicações brasileiro.

**Justificativa**: Compatibilidade com padrão ABNT de telecomunicações e com legado. Evita erros de arredondamento em cálculos financeiros críticos.

**Critério de Aceite**:
- Valor com 8 decimais → aceito
- Valor com 9 decimais → HTTP 400 "Máximo 8 casas decimais"
- Valor negativo → HTTP 400 "Valor não pode ser negativo"

---

### RN-RF034-004: Quantidade de Consumo Positiva

**Descrição**: A quantidade de consumo (minutos, MB, SMS, etc.) deve ser obrigatoriamente maior que zero.

**Justificativa**: Lógica de negócio: não há consumo de zero ou negativo. Detecta dados corrompidos ou entrada manual errada.

**Critério de Aceite**:
- QuantidadeConsumo = 0 → HTTP 400 "Quantidade deve ser maior que zero"
- QuantidadeConsumo negativo → HTTP 400 "Quantidade deve ser maior que zero"
- QuantidadeConsumo válido (>0) → aceito

---

### RN-RF034-005: Validação de Relacionamentos Obrigatórios

**Descrição**: Todos os relacionamentos (ativo, contrato, operadora, tipo de bilhete) devem referenciar registros válidos e ativos. Soft delete (FlExcluido = true) torna o relacionamento inválido.

**Justificativa**: Garante integridade referencial forte. Evita análises sobre dados órfãos ou desatualizados.

**Critério de Aceite**:
- Ativo inexistente → HTTP 400 "Ativo não encontrado"
- Ativo excluído (FlExcluido=true) → HTTP 400 "Ativo não encontrado ou excluído"
- Contrato inexistente → HTTP 400 "Contrato não encontrado"
- Tipo de bilhete inexistente → HTTP 400 "Tipo de bilhete não encontrado"

---

### RN-RF034-006: Sincronização Automática com Resumo de Auditoria

**Descrição**: Ao criar, editar ou excluir um item de auditoria, os totalizadores do resumo associado (RF035) devem ser recalculados automaticamente via Domain Events.

**Justificativa**: Mantém consistência de dados agregados em tempo real. Elimina necessidade de jobs de sincronização batch.

**Critério de Aceite**:
- Item criado → Resumo.TotalGlosa incrementado automaticamente
- Item editado → Resumo.TotalGlosa recalculado automaticamente
- Item excluído → Resumo.TotalGlosa reduzido automaticamente
- Resumo sempre reflete soma de itens ativos (FlExcluido=false)

---

### RN-RF034-007: Validação de Lote (Formato AAAAMM)

**Descrição**: O campo Lote deve estar no formato AAAAMM (6 dígitos) representando um período válido de faturamento.

**Justificativa**: Garante consistência de período. Facilita agrupamento por mês/ano nas análises.

**Critério de Aceite**:
- Lote = "202512" (dezembro/2025) → aceito
- Lote = "2025-12" → HTTP 400 "Formato inválido (esperado AAAAMM)"
- Lote = "202513" (mês 13) → HTTP 400 "Mês inválido (deve ser 01-12)"
- Lote = "12345" (5 dígitos) → HTTP 400 "Lote deve ter exatamente 6 caracteres"

---

### RN-RF034-008: Exportação Estruturada para Contestação

**Descrição**: Itens de auditoria devem ser exportáveis em formato estruturado (PDF, Excel, CSV) agrupados por operadora, com cálculo de subtotais, justificativas técnicas e referência de bilhete.

**Justificativa**: Prepara documentação formal para contestação junto à operadora. Deve ser auto-explicativo e completo.

**Critério de Aceite**:
- Exportação agrupa itens por operadora
- Cada grupo exibe subtotal de glosas
- Documento inclui data de geração e total geral
- Justificativas técnicas são geradas automaticamente conforme criticidade

---

### RN-RF034-009: Auditoria Completa de Operações

**Descrição**: Todas as operações (criar, editar, excluir, aprovar, contestar) devem ser auditadas com registro de usuário, timestamp, valores antes/depois via Shadow Properties do EF Core.

**Justificativa**: Conformidade LGPD (retenção 7 anos). Rastreabilidade de mudanças para investigação e compliance.

**Critério de Aceite**:
- Criar → registra UsuarioCriacao e DataCriacao
- Editar → registra UsuarioAlteracao, DataAlteracao, ValoresAntes, ValoresDepois
- Excluir → registra UsuarioExclusao, DataExclusao, FlExcluido=true
- Logs retidos por 7 anos

---

### RN-RF034-010: Filtros Avançados por Unidade de Consumo

**Descrição**: Os itens devem ser filtráveis por unidade de consumo (minutos, MB, SMS, franquia) para análises segmentadas por tipo de serviço.

**Justificativa**: Diferentes tipos de erro ocorrem em diferentes serviços. Filtragem facilita análise de padrão.

**Critério de Aceite**:
- Filtro Unidade=Minutos → retorna apenas VOZ
- Filtro Unidade=MegaBytes → retorna apenas DADOS
- Filtro Unidade=SMS → retorna apenas mensagens
- Filtro DivergenciaMinima=50.00 → retorna apenas glosas >=R$ 50

---

### RN-RF034-011: Validação de Valores Conforme Tipo de Bilhete

**Descrição**: Validações de unidade de consumo e tipo de serviço devem respeitar relacionamento com tipo de bilhete (VOZ usa minutos, DADOS usa MB, etc.).

**Justificativa**: Detecta erros de entrada. Garante consistência de dados.

**Critério de Aceite**:
- Tipo=VOZ + Unidade=Minutos → aceito
- Tipo=VOZ + Unidade=MegaBytes → HTTP 400 "Unidade incompatível com tipo de bilhete"
- Tipo=DADOS + Unidade=MegaBytes → aceito
- Tipo=DADOS + Unidade=Minutos → HTTP 400 "Unidade incompatível"

---

### RN-RF034-012: Soft Delete com Recálculo de Agregados

**Descrição**: Exclusão lógica (soft delete) deve definir FlExcluido=true e disparar evento para recálculo automático de totalizadores do resumo.

**Justificativa**: Preserva auditoria (registro não é perdido). Mantém consistência de agregados.

**Critério de Aceite**:
- DELETE /api/itens/{id} → FlExcluido=true
- Resumo.TotalGlosa reduzido automaticamente
- Item não aparece em listagens (Global Query Filter)
- Item preservado em auditoria/histórico

---

### RN-RF034-013: Multi-Tenancy Obrigatório com Row-Level Security

**Descrição**: Todos os itens de auditoria devem estar obrigatoriamente isolados por ConglomeradoId (ClienteId). Global Query Filters garantem isolamento automático em todas as queries.

**Justificativa**: Conformidade multi-tenancy. Evita vazamento de dados entre clientes.

**Critério de Aceite**:
- Cliente A não pode listar itens de Cliente B
- Tentativa de acesso cruzado → retorna vazio (não HTTP 403)
- Global Query Filter aplica WHERE ConglomeradoId = CurrentClientId automaticamente
- Nenhuma query deve permitir acesso cross-tenant

---

### RN-RF034-014: Índices para Performance em Consultas Analíticas

**Descrição**: Criar índices não-clusterizados otimizados para consultas de auditoria, relatórios e exportações.

**Justificativa**: Relatórios sobre milhares de itens requerem performance. Índices reduzem tempo de execução de O(n) para O(log n).

**Critério de Aceite**:
- Query de lista (GET /api/itens) < 500ms para 10.000 registros
- Query de relatório por operadora < 1s para 50.000 registros
- Índices criados em AuditoriaResumoId, BilheteId, Lote, ConglomeradoId
- Índice com INCLUDE para colunas usadas em projeções

---

### RN-RF034-015: Exportação para Excel com Detalhamento Completo

**Descrição**: Exportação para Excel deve incluir todas as colunas relevantes em formatação legível, com subtotais por operadora e divergência.

**Justificativa**: Facilita análise offline e compartilhamento com stakeholders.

**Critério de Aceite**:
- Excel contém todas as colunas (bilhete, ativo, operadora, valores, glosa, divergência)
- Headers com formatação bold + fundo cinza
- Colunas ajustadas automaticamente ao conteúdo
- Subtotais por operadora em linhas destacadas
- Total geral no final do documento

---

## 4. INTEGRAÇÕES OBRIGATÓRIAS

### 4.1 Internacionalização (i18n)

**Framework**: Transloco
**Idiomas**: pt-BR (principal), en, es

**Chaves obrigatórias** (mínimo 16 pontos):

```json
{
  "auditoria.itens.titulo": "Itens de Auditoria",
  "auditoria.itens.labels.bilhete": "Bilhete",
  "auditoria.itens.labels.valorCobrado": "Valor Cobrado (R$)",
  "auditoria.itens.labels.valorCorreto": "Valor Correto (R$)",
  "auditoria.itens.labels.glosa": "Glosa (R$)",
  "auditoria.itens.labels.divergencia": "Divergência (%)",
  "auditoria.itens.mensagens.sucesso.criar": "Item criado com sucesso",
  "auditoria.itens.mensagens.erro.criar": "Erro ao criar item",
  "auditoria.itens.validacao.campoObrigatorio": "Campo obrigatório",
  "auditoria.itens.validacao.valorInvalido": "Valor inválido",
  "auditoria.itens.validacao.loteInvalido": "Lote deve estar no formato AAAAMM"
}
```

### 4.2 Auditoria de Operações

**Tabela centralizada**: `dbo.AuditoriaLogs` (conforme RF003)

**Operações auditadas**:
- `AUD_ITEM_CREATE` - Criar item
- `AUD_ITEM_UPDATE` - Editar item
- `AUD_ITEM_DELETE` - Excluir item
- `AUD_ITEM_EXPORT` - Exportar itens
- `AUD_ITEM_CONTESTACAO` - Gerar contestação

**Retenção**: 7 anos (conformidade LGPD)

### 4.3 Controle de Acesso (RBAC)

**Permissões definidas**:

| Permissão | Descrição | Super Admin | Auditor | Gestor Fin. | Analista |
|-----------|-----------|-------------|---------|-------------|----------|
| `aud:itens:view` | Visualizar itens | ✅ | ✅ | ✅ | ✅ |
| `aud:itens:create` | Criar itens | ✅ | ✅ | ❌ | ❌ |
| `aud:itens:edit` | Editar itens | ✅ | ✅ | ❌ | ❌ |
| `aud:itens:delete` | Excluir itens | ✅ | ❌ | ❌ | ❌ |
| `aud:itens:export` | Exportar | ✅ | ✅ | ✅ | ✅ |
| `aud:itens:contestacao` | Gerar contestação | ✅ | ✅ | ✅ | ❌ |

### 4.4 Central de Funcionalidades (Feature Flags)

**FeatureKey**: `AUD_AUDITORIA_ITENS`

**Configuração**:
```json
{
  "featureKey": "AUD_AUDITORIA_ITENS",
  "nome": "Gestão de Itens de Auditoria",
  "modulo": "Auditoria",
  "habilitado": true,
  "permissaoMinima": "aud:itens:view"
}
```

---

## 5. PERMISSÕES RBAC

| Permission Code | Descrição | Roles Autorizadas |
|----------------|-----------|-------------------|
| `AUD.ITENS.VIEW` | Visualizar itens | Super Admin, Auditor, Gestor Fin., Analista |
| `AUD.ITENS.CREATE` | Criar novo item | Super Admin, Auditor |
| `AUD.ITENS.UPDATE` | Editar item | Super Admin, Auditor |
| `AUD.ITENS.DELETE` | Excluir item | Super Admin |
| `AUD.ITENS.EXPORT` | Exportar dados | Super Admin, Auditor, Gestor Fin., Analista |
| `AUD.ITENS.CONTESTACAO` | Gerar contestação | Super Admin, Auditor, Gestor Fin. |

---

## 6. API ENDPOINTS

### 6.1 CRUD Principal

| Método | Endpoint | Descrição | Permissão | Status Code |
|--------|----------|-----------|-----------|-------------|
| GET | `/api/v1/auditoria-itens` | Listar com paginação/filtros | `aud:itens:view` | 200, 400, 403 |
| GET | `/api/v1/auditoria-itens/{id}` | Obter por ID | `aud:itens:view` | 200, 404, 403 |
| POST | `/api/v1/auditoria-itens` | Criar novo | `aud:itens:create` | 201, 400, 403, 409 |
| PUT | `/api/v1/auditoria-itens/{id}` | Atualizar | `aud:itens:edit` | 200, 400, 404, 403 |
| DELETE | `/api/v1/auditoria-itens/{id}` | Excluir (soft delete) | `aud:itens:delete` | 204, 404, 403 |

### 6.2 Operações Especiais

| Método | Endpoint | Descrição | Permissão |
|--------|----------|-----------|-----------|
| GET | `/api/v1/auditoria-itens/export/excel` | Exportar Excel | `aud:itens:export` |
| POST | `/api/v1/auditoria-itens/export/pdf` | Exportar PDF | `aud:itens:export` |
| POST | `/api/v1/auditoria-itens/gerar-contestacao` | Gerar contestação | `aud:itens:contestacao` |
| GET | `/api/v1/auditoria-itens/relatorios/por-operadora` | Relatório operadora | `aud:itens:view` |
| GET | `/api/v1/auditoria-itens/relatorios/por-tipo` | Relatório tipo serviço | `aud:itens:view` |
| GET | `/api/v1/auditoria-itens/dashboard` | Dashboard KPIs | `aud:itens:view` |

---

## 7. MODELO DE DADOS

Ver documento completo em: [MD-RF034.md](./MD-RF034.md)

**Principais entidades**:
- `AuditoriaItem` - Entidade principal
- `AuditoriaResumo` - Agregação (RF035)
- `Bilhete` - Item de consumo
- `BilheteTipo` - Tipo de serviço (VOZ, DADOS, SMS, FRANQUIA)
- `Ativo` - Telefone ou circuito
- `Contrato` - Contrato com operadora
- `Operadora` - Prestadora de serviço

**Relacionamentos críticos**:
- AuditoriaItem N:1 AuditoriaResumo (obrigatório)
- AuditoriaItem N:1 Bilhete (obrigatório)
- AuditoriaItem N:1 Ativo (obrigatório)
- AuditoriaItem N:1 Contrato (obrigatório)
- AuditoriaItem N:1 Operadora (obrigatório)
- AuditoriaItem N:1 BilheteTipo (obrigatório)

---

## 8. DEPENDÊNCIAS

### 8.1 RFs Dependentes (Upstream)

| RF | Descrição | Motivo |
|----|-----------|--------|
| RF035 | Gestão de Resumos de Auditoria | Item vinculado a resumo |
| RF032 | Gestão de Faturas | Bilhetes vêm de faturas |

### 8.2 RFs Downstream

Nenhum RF depende diretamente de RF034.

### 8.3 Bibliotecas Externas

- EPPlus (exportação Excel)
- iTextSharp ou QuestPDF (exportação PDF)
- FluentValidation (validações)
- MediatR (CQRS)
- Entity Framework Core (persistência)
- SignalR (notificações real-time)

---

## 9. KPIs E MÉTRICAS

| KPI | Meta | Medição | Frequência |
|-----|------|---------|-----------|
| Glosa Recuperada (R$) | 50% da glosa auditada | SUM(ValorCobradoAMais) recuperado / total | Mensal |
| Tempo Médio de Análise | < 2 dias | DataAprovacao - DataCriacao | Mensal |
| Taxa Divergência Crítica | < 5% | COUNT(Divergencia >10%) / COUNT(total) | Mensal |
| Performance Query Lista | < 500ms | Tempo resposta GET /api/itens | Contínuo |
| Taxa Sucesso Exportação | > 99% | Exports sucesso / exports totais | Mensal |
| Cobertura de Auditoria | > 95% | Itens auditados / bilhetes carregados | Mensal |
| Acurácia de Glosa | > 98% | Glosas confirmadas / glosas propostas | Mensal |

---

## 10. ALERTAS CRÍTICOS

| Alerta | Condição | Ação | Destinatário |
|--------|----------|------|-------------|
| Divergência Crítica | Glosa >10% contratual | SignalR + Email | Gestores Auditoria |
| Query Performance | Query >2s | Log aviso, análise índice | DBA |
| Falha Exportação | Erro após 3 tentativas | Log erro + notificação | Admin |
| Falta Sincronização | Resumo não atualizado em 5min | Retrigger handler | Operações |
| Retenção Auditoria | Logs >7 anos | Archive para blob, delete | Admin (automático) |

---

## 11. CENTRAL DE FUNCIONALIDADES

**Código da Funcionalidade**: `AUD_AUDITORIA_ITENS`

**Módulo**: Auditoria

**i18n keys para menu**:
- `menu.auditoria.itens`: "Itens de Auditoria"
- `menu.auditoria.itens.descricao`: "Gestão detalhada de divergências"

**Rota Frontend**: `/gestao/auditoria-itens`

**Feature Flag**: Permite desabilitar funcionalidade sem deploy

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0 (separação RF/RL completa) | Agência ALC - alc.dev.br |
| 1.0 | 2025-12-28 | Versão inicial | Claude Code |
