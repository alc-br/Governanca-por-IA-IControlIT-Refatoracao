rf_id: RF109
versao_governanca: "2.0"
data_migracao: "2025-12-31"
rf_moderno: "RF109.md"
rl_moderno: "RL-RF109.md"

# ==============================================================================
# INVENTÁRIO DE ITENS LEGADO
# ==============================================================================

referencias:
  - id: "LEG-RF109-001"
    tipo: "infraestrutura"
    nome: "Armazenamento Local C:\\Documentos"
    caminho: "C:\\Documentos\\{ClienteId}\\{AnoMes}\\{DocumentoId}"
    descricao: "Armazenamento físico de documentos em disco local do servidor com limite de 2GB por cliente"
    destino: "substituido"
    justificativa: "Armazenamento local obsoleto, sem escalabilidade, sem replicação geográfica, sem disaster recovery. Substituído por Azure Blob Storage com tiers hot/cool/archive."
    rastreabilidade:
      rf_secao: "Seção 4 - Funcionalidades - Storage Hierarquizado"
      componente_backend: "AzureBlobStorageService"
      regra_negocio: "RN-RF109-009"

  - id: "LEG-RF109-002"
    tipo: "tela"
    nome: "DocumentoUpload.aspx"
    caminho: "ic1_legado/IControlIT/Documentos/DocumentoUpload.aspx"
    descricao: "Tela de upload de documentos via WebForm com limite 30 MB e seleção manual de tipo"
    tecnologia: "ASP.NET Web Forms + VB.NET"
    destino: "substituido"
    justificativa: "WebForm substituído por componente Angular com upload drag-and-drop, validação client-side, progress bar, e upload chunked para arquivos grandes."
    rastreabilidade:
      rf_secao: "Seção 10 - API Endpoints - POST /api/documentos/upload"
      componente_frontend: "documento-upload.component.ts"
      componente_backend: "UploadDocumentoCommand + UploadDocumentoCommandHandler"

  - id: "LEG-RF109-003"
    tipo: "stored_procedure"
    nome: "sp_InsertDocumento"
    caminho: "SQL Server 2008 - dbo.sp_InsertDocumento"
    descricao: "Stored procedure para inserir metadados de documento na tabela Documento"
    tecnologia: "T-SQL"
    destino: "substituido"
    justificativa: "Stored procedures substituídas por Entity Framework Core com Commands/Queries (CQRS). Migration automática cria tabela com campos de auditoria."
    rastreabilidade:
      rf_secao: "Seção 12 - Modelo de Dados"
      componente_backend: "Documento.cs (Entity) + UploadDocumentoCommandHandler.cs"
      migration: "AddDocumentoTable"

  - id: "LEG-RF109-004"
    tipo: "tabela"
    nome: "Tabela Documento"
    caminho: "SQL Server 2008 - dbo.Documento"
    descricao: "Tabela de metadados de documentos com 9 campos básicos"
    campos_principais: "DocumentoId, ClienteId, TipoDocumentoId, Titulo, Descricao, CaminhoArquivo, TamanhoBytes, UsuarioUploadId, DataUpload, Status"
    destino: "assumido"
    observacao: "Estrutura básica assumida com EXTENSÕES obrigatórias"
    justificativa: "Estrutura básica assumida, mas estendida com novos campos para suportar OCR, assinatura digital, versionamento, retenção e auditoria completa."
    rastreabilidade:
      rf_secao: "Seção 12 - Modelo de Dados"
      componente_backend: "Documento.cs (Entity)"
      migration: "AddDocumentoTable"
    campos_novos:
      - "BlobStoragePath (Azure Blob URL)"
      - "OcrStatus, OcrExtractedText, OcrConfidence"
      - "AssinaturaDigitalUrl, CertificadoIcpBrasilId"
      - "Versao, VersaoAnteriorId"
      - "DataRetencao, PolicyRetencaoId"
      - "DataCriacao, UsuarioCriacaoId, DataModificacao, UsuarioModificacaoId"

  - id: "LEG-RF109-005"
    tipo: "webservice"
    nome: "DocumentoWebService.asmx"
    caminho: "ic1_legado/IControlIT/WebServices/DocumentoWebService.asmx"
    descricao: "API SOAP para integração com sistemas externos (upload/download de documentos)"
    tecnologia: "SOAP WebService + VB.NET"
    metodos_expostos:
      - "UploadDocumento(byte[], string, int)"
      - "DownloadDocumento(int) → byte[]"
      - "ListarDocumentos(int, int) → DataSet"
    destino: "substituido"
    justificativa: "SOAP WebService substituído por REST API (.NET 10 Minimal APIs) com autenticação JWT, validação de payload, rate limiting, e Swagger/OpenAPI."
    rastreabilidade:
      rf_secao: "Seção 10 - API Endpoints"
      endpoints_rest:
        - "POST /api/documentos/upload (substitui UploadDocumento)"
        - "GET /api/documentos/{id}/download (substitui DownloadDocumento)"
        - "GET /api/documentos (substitui ListarDocumentos)"

  - id: "LEG-RF109-006"
    tipo: "regra_implicita"
    nome: "Busca de Documentos por Título (LIKE %)"
    caminho: "DocumentoSearch.aspx.vb"
    descricao: "Busca simples por LIKE % no título do documento sem indexação full-text"
    query_exemplo: "SELECT * FROM Documento WHERE Titulo LIKE '%' + @TextoBusca + '%'"
    limitacoes:
      - "Busca apenas no título (não no conteúdo)"
      - "Performance ruim com LIKE %"
      - "Sem relevância ou ranking"
      - "Sem suporte a sinônimos ou erros ortográficos"
    destino: "substituido"
    justificativa: "Busca SQL simples substituída por ElasticSearch full-text indexing com OCR, relevância, faceted search, e suporte a queries complexas."
    rastreabilidade:
      rf_secao: "Seção 4 - Funcionalidades - Busca Full-Text"
      componente_backend: "PesquisarDocumentosQueryHandler + ElasticSearchService"
      componente_frontend: "documento-search.component.ts"
      regra_negocio: "RN-RF109-007"
      endpoint: "GET /api/documentos/pesquisar"

  - id: "LEG-RF109-007"
    tipo: "regra_implicita"
    nome: "Download sem Marca D'Água"
    caminho: "DocumentoDownload.aspx.vb"
    descricao: "Download direto do arquivo sem aplicação de marca d'água identificando usuário"
    limitacoes:
      - "Sem marca d'água aplicada"
      - "Sem identificação de quem baixou, quando, de qual IP"
      - "Risco de vazamento de documentos sem rastreabilidade"
    destino: "substituido"
    justificativa: "Download agora aplica marca d'água obrigatória em PDFs/imagens identificando usuário (nome, CPF), data/hora e IP. Auditoria completa registrada."
    rastreabilidade:
      rf_secao: "Seção 4 - Funcionalidades - Download com Marca D'Água"
      componente_backend: "DownloadDocumentoQueryHandler + WatermarkService"
      regra_negocio: "RN-RF109-010"
      endpoint: "GET /api/documentos/{id}/download"

  - id: "LEG-RF109-008"
    tipo: "regra_implicita"
    nome: "Sem Verificação de Malware"
    caminho: "Upload flow completo (aspx + stored procedure)"
    descricao: "Nenhuma verificação de antivírus era realizada antes de armazenar o arquivo"
    risco: "Arquivos maliciosos podiam ser uploadados e compartilhados com outros usuários"
    destino: "substituido"
    justificativa: "Todos os uploads agora passam por verificação obrigatória com ClamAV antes de armazenamento. Arquivos infectados são rejeitados com HTTP 400 e deletados imediatamente."
    rastreabilidade:
      rf_secao: "Seção 4 - Funcionalidades"
      componente_backend: "UploadDocumentoCommandHandler + ClamAvService"
      regra_negocio: "RN-RF109-004"

  - id: "LEG-RF109-009"
    tipo: "regra_implicita"
    nome: "Sem Políticas de Retenção Automáticas"
    caminho: "Sem implementação no legado"
    descricao: "Documentos ficavam armazenados indefinidamente sem descarte automático"
    problema: "Violação potencial de LGPD (retenção excessiva de dados pessoais)"
    destino: "substituido"
    justificativa: "Sistema moderno implementa políticas de retenção automáticas por tipo de documento (7 anos para fiscais/contratuais conforme LGPD Art. 16). Job Hangfire executa descarte programado."
    rastreabilidade:
      rf_secao: "Seção 4 - Funcionalidades - Retenção e Descarte"
      componente_backend: "DescarteAutomaticoJob (Hangfire)"
      regra_negocio: "RN-RF109-006"

  - id: "LEG-RF109-010"
    tipo: "regra_implicita"
    nome: "Sem OCR Automático"
    caminho: "Processamento manual externo ao sistema"
    descricao: "PDFs scaneados ou imagens não passavam por OCR automaticamente. Usuários tinham que extrair texto manualmente em ferramenta externa (ABBYY FineReader) e copiar para campo Descrição."
    limitacoes:
      - "Processo manual demorado"
      - "Texto não indexado para busca"
      - "Dependência de software externo (licença cara)"
      - "Inconsistência (alguns docs processados, outros não)"
    destino: "substituido"
    justificativa: "OCR agora é automático e assíncrono via Hangfire. Sistema detecta automaticamente PDFs scaneados e agenda OCR com Azure Cognitive Services ou Tesseract. Resultado indexado no ElasticSearch."
    rastreabilidade:
      rf_secao: "Seção 4 - Funcionalidades - Processamento de OCR"
      componente_backend: "ProcessarOcrJob (Hangfire) + AzureCognitiveServicesClient"
      regra_negocio: "RN-RF109-003"

  - id: "LEG-RF109-011"
    tipo: "regra_implicita"
    nome: "Limite de Upload 30 MB"
    caminho: "web.config - httpRuntime maxRequestLength='30720'"
    descricao: "Uploads limitados a 30 MB configurado no web.config"
    limitacao: "Bloqueio de documentos grandes (contratos escaneados, plantas, desenhos técnicos)"
    destino: "substituido"
    justificativa: "Limite aumentado para 50 MB com suporte a upload chunked para arquivos grandes. Configuração via appsettings.json."
    rastreabilidade:
      rf_secao: "Seção 4 - Funcionalidades"
      regra_negocio: "RN-RF109-001"

  - id: "LEG-RF109-012"
    tipo: "regra_implicita"
    nome: "Sem Versionamento Automático"
    caminho: "Upload flow (sobrescrita manual)"
    descricao: "Ao reenviar documento com mesmo nome, arquivo anterior era sobrescrito sem manter histórico"
    limitacao: "Perda de versões anteriores, sem rollback, sem auditoria de mudanças"
    destino: "substituido"
    justificativa: "Sistema moderno implementa versionamento automático. Cada upload de documento existente cria nova versão com rastreamento de mudanças e possibilidade de rollback."
    rastreabilidade:
      rf_secao: "Seção 4 - Funcionalidades - Controle de Versão"
      componente_backend: "DocumentoVersao.cs (Entity)"
      endpoint: "GET /api/documentos/{id}/versions"

  - id: "LEG-RF109-013"
    tipo: "regra_implicita"
    nome: "Sem Assinatura Digital"
    caminho: "Sem implementação no legado"
    descricao: "Não havia suporte a assinatura digital com certificados ICP-Brasil"
    limitacao: "Falta de validade jurídica eletrônica conforme Lei 14.063/2020"
    destino: "substituido"
    justificativa: "Sistema moderno integra com DocuSign/Adobe Sign para assinatura criptográfica com certificados ICP-Brasil A3. Suporta workflow de múltiplos signatários."
    rastreabilidade:
      rf_secao: "Seção 4 - Funcionalidades - Assinatura Digital"
      componente_backend: "AssinarDocumentoCommandHandler + DocuSignService"
      regra_negocio: "RN-RF109-005"
      endpoint: "POST /api/documentos/{id}/assinar"

  - id: "LEG-RF109-014"
    tipo: "regra_implicita"
    nome: "Classificação Manual de Documentos"
    caminho: "DocumentoUpload.aspx - ddlTipoDocumento (dropdown)"
    descricao: "Usuário tinha que selecionar manualmente o tipo de documento em dropdown (NF-e, Contrato, RG, etc.)"
    limitacao: "Processo lento, inconsistente, sujeito a erro humano"
    destino: "substituido"
    justificativa: "Sistema moderno implementa classificação automática via Machine Learning (Azure Form Recognizer). Usuário pode sobrescrever manualmente se necessário."
    rastreabilidade:
      rf_secao: "Seção 4 - Funcionalidades - Classificação Automática"
      componente_backend: "ClassificarDocumentosJob (Hangfire) + AzureFormRecognizerService"
      endpoint: "POST /api/documentos/{id}/classify"

  - id: "LEG-RF109-015"
    tipo: "regra_implicita"
    nome: "Auditoria Limitada (Apenas Criação/Modificação)"
    caminho: "Tabela Documento - DataUpload, UsuarioUploadId"
    descricao: "Apenas criação e modificação eram registradas. Não havia log de acesso, download, visualização ou exclusão."
    limitacao: "Falta de rastreabilidade completa, dificulta investigação de vazamento de informações"
    destino: "substituido"
    justificativa: "Sistema moderno implementa auditoria completa com registro de todas as operações: acesso, download, visualização, aprovação, rejeição, assinatura, exclusão, modificação de metadados."
    rastreabilidade:
      rf_secao: "Seção 4 - Funcionalidades - Auditoria Completa"
      componente_backend: "DocumentoAuditoria.cs (Entity)"
      regra_negocio: "RN-RF109-010"
      endpoint: "GET /api/documentos/{id}/auditoria"

# ==============================================================================
# MAPEAMENTO DE CAMPOS (LEGADO → MODERNO)
# ==============================================================================

mapeamento_campos:
  - campo_legado: "DocumentoId"
    tipo_legado: "INT IDENTITY"
    campo_moderno: "Id"
    tipo_moderno: "Guid"
    observacao: "Conversão INT → Guid durante migração"

  - campo_legado: "ClienteId"
    tipo_legado: "INT"
    campo_moderno: "ClienteId"
    tipo_moderno: "Guid"
    observacao: "Conversão INT → Guid"

  - campo_legado: "TipoDocumentoId"
    tipo_legado: "INT"
    campo_moderno: "ClassificacaoDocumentoId"
    tipo_moderno: "Guid"
    observacao: "Renomeado para clareza + conversão Guid"

  - campo_legado: "Titulo"
    tipo_legado: "NVARCHAR(200)"
    campo_moderno: "Titulo"
    tipo_moderno: "string (200)"
    observacao: "Assumido sem mudanças"

  - campo_legado: "Descricao"
    tipo_legado: "NVARCHAR(MAX)"
    campo_moderno: "Descricao"
    tipo_moderno: "string"
    observacao: "Assumido sem mudanças"

  - campo_legado: "CaminhoArquivo"
    tipo_legado: "NVARCHAR(500)"
    campo_moderno: "BlobStoragePath"
    tipo_moderno: "string (URL Azure)"
    observacao: "Migração física de C:\\ para Azure Blob"

  - campo_legado: "TamanhoBytes"
    tipo_legado: "BIGINT"
    campo_moderno: "TamanhoBytes"
    tipo_moderno: "long"
    observacao: "Assumido sem mudanças"

  - campo_legado: "UsuarioUploadId"
    tipo_legado: "INT"
    campo_moderno: "UsuarioCriacaoId"
    tipo_moderno: "Guid"
    observacao: "Renomeado para padrão auditoria + Guid"

  - campo_legado: "DataUpload"
    tipo_legado: "DATETIME"
    campo_moderno: "DataCriacao"
    tipo_moderno: "DateTime (UTC)"
    observacao: "Renomeado para padrão auditoria"

  - campo_legado: "Status"
    tipo_legado: "NVARCHAR(20)"
    campo_moderno: "StatusDocumento"
    tipo_moderno: "Enum"
    observacao: "Conversão string → Enum (Rascunho, EmProcessamento, Aprovado, etc.)"

  - campo_legado: "(inexistente)"
    tipo_legado: null
    campo_moderno: "OcrStatus, OcrExtractedText, OcrConfidence"
    tipo_moderno: "Enum, string, decimal"
    observacao: "Novo campo para OCR automático"

  - campo_legado: "(inexistente)"
    tipo_legado: null
    campo_moderno: "Versao, VersaoAnteriorId"
    tipo_moderno: "int, Guid"
    observacao: "Novo campo para versionamento"

  - campo_legado: "(inexistente)"
    tipo_legado: null
    campo_moderno: "DataRetencao, PolicyRetencaoId"
    tipo_moderno: "DateTime, Guid"
    observacao: "Novo campo para políticas de retenção LGPD"

  - campo_legado: "(inexistente)"
    tipo_legado: null
    campo_moderno: "AssinaturaDigitalUrl, CertificadoIcpBrasilId"
    tipo_moderno: "string, Guid"
    observacao: "Novo campo para assinatura digital ICP-Brasil"

# ==============================================================================
# DECISÕES DE MIGRAÇÃO
# ==============================================================================

decisoes_migracao:
  - decisao: "Migração Big Bang (sem período de convivência)"
    justificativa: "Armazenamento legado (C:\\Documentos) incompatível com Azure Blob Storage. Não há API comum entre SOAP WebService e REST API. Estrutura de dados completamente redesenhada."
    acao: "Script de migração MigrarDocumentosLegadoParaAzure.ps1 copia arquivos de C:\\ para Azure e insere registros em tabela moderna."

  - decisao: "Conversão de IDs INT → Guid"
    justificativa: "Padrão moderno usa Guid para evitar colisões em ambientes distribuídos e facilitar merge de bancos."
    acao: "Script de conversão mantém mapeamento INT → Guid em tabela temporária para integração com sistemas legados."

  - decisao: "OCR retroativo opcional"
    justificativa: "Executar OCR em 100k+ documentos legados seria custoso e demorado."
    acao: "OCR executado on-demand (lazy loading) quando usuário acessa documento pela primeira vez. Job em background pode processar lote aos finais de semana."

# ==============================================================================
# SISTEMAS AFETADOS
# ==============================================================================

sistemas_afetados:
  - sistema: "ERP Financeiro"
    dependencia_legado: "SOAP WebService DocumentoWebService.asmx"
    acao_migracao: "Migrar para REST API /api/documentos com autenticação JWT"
    impacto: "ALTO - Requer mudança no código do ERP"

  - sistema: "Portal do Cliente"
    dependencia_legado: "Link direto para C:\\Documentos (quebra após migração)"
    acao_migracao: "Substituir por endpoint /api/documentos/{id}/download"
    impacto: "MÉDIO - Requer atualização de links"

  - sistema: "Módulo de Contratos (RF050)"
    dependencia_legado: "Referência DocumentoId (INT)"
    acao_migracao: "Atualizar para Guid + script conversão de FKs"
    impacto: "MÉDIO - Migration de FK INT → Guid"

# ==============================================================================
# METADADOS
# ==============================================================================

metadados:
  total_itens_legado: 15
  itens_substituidos: 14
  itens_assumidos: 1
  itens_descartados: 0
  itens_a_revisar: 0
  cobertura_destinos: "100%"

  linhas_documentacao:
    rl_md: 485
    rl_yaml: 510
    total: 995
