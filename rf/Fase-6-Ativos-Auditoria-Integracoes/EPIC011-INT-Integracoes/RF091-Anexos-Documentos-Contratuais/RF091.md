# RF091: Gestão de Anexos e Documentos Contratuais

**Versão**: 2.0
**Data**: 2025-12-31
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC011-INT-Integracoes
**Fase**: Fase 6 - Ativos, Auditoria e Integrações

---

## 1. OBJETIVO DO REQUISITO

Descrever de forma clara, objetiva e verificável o comportamento esperado do sistema IControlIT no gerenciamento completo do ciclo de vida de documentos e anexos associados a contratos, operações e entidades do sistema.

Este requisito serve como **contrato oficial** entre negócio, desenvolvimento, testes e agentes de IA, garantindo que o módulo de Gestão de Anexos e Documentos Contratuais atenda requisitos de conformidade legal (LGPD, ISO 27001), segurança da informação, rastreabilidade operacional e integração com serviços de nuvem.

O sistema deve permitir upload seguro, armazenamento criptografado, versionamento completo, controle de acesso granular, auditoria não-repudiável e integração com serviços externos (Azure Blob Storage, ClamAV, OCR, DocuSign).

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- Upload de arquivos com validação de tipo, tamanho e integridade
- Armazenamento seguro em Azure Blob Storage com criptografia AES-256
- Scan automático de antivírus (ClamAV) em todos os arquivos
- Versionamento imutável com histórico completo
- Controle de acesso granular por RBAC e políticas temporárias
- Download seguro com SAS tokens temporários (15 minutos)
- Watermark visual em documentos PDF
- OCR e indexação full-text (Elasticsearch)
- Integração com DocuSign para assinatura digital
- Auditoria completa de todas operações (upload, download, visualização, exclusão, compartilhamento, assinatura)
- Validação de documentação obrigatória por tipo de contrato
- Compartilhamento de documentos com delegação temporal
- Busca full-text por conteúdo extraído (OCR)
- Integração com RF023 (Gestão de Contratos)
- Integração com Central de Funcionalidades (Feature Flags)
- Internacionalização completa (pt-BR, en-US, es-ES, fr-FR)

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (definida em WF-RF091)
- Tecnologia de implementação (definida em arquitetura)
- Layout, UX ou identidade visual (responsabilidade do design)
- Estratégia de deploy ou infraestrutura (responsabilidade DevOps)
- Armazenamento local em file system (apenas Azure Blob)
- Processamento de vídeo ou áudio (apenas documentos: PDF, Office, imagens)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-----|---------|
| **Anexo (Attachment)** | Arquivo digital associado a uma entidade do sistema (Contrato, Fatura, Fornecedor) com metadados completos |
| **Documento Contratual** | Categoria de documentação necessária para contratos (ex: "Proposta Original", "Termo Assinado", "Aditivo 01") |
| **Versão** | Instância específica de um documento identificada por número sequencial, cada upload cria nova versão imutável |
| **Tenant** | Unidade lógica de isolamento de dados (ClienteId), garantindo que usuários de uma empresa não acessem dados de outra |
| **SAS Token** | Shared Access Signature do Azure, URL temporária com permissões restritas e expiração configurável |
| **Watermark** | Marca d'água visual ou invisível em documentos para rastreabilidade e proteção contra vazamentos |
| **OCR** | Optical Character Recognition, extração de texto de imagens e PDFs scaneados |
| **Hash SHA-256** | Função criptográfica que gera assinatura única de arquivo, usada para validar integridade |
| **RBAC** | Role-Based Access Control, controle de acesso baseado em papéis e permissões |
| **Policy** | Regra de acesso específica que pode ser temporária ou delegada a usuários individuais |
| **Operação** | Ação executável sobre documentos: upload, download, view, delete, sign, share |

---

## 4. FUNCIONALIDADES COBERTAS

1. Upload de documentos com validação dupla (client-side e server-side)
2. Armazenamento seguro em nuvem com criptografia e redundância geográfica
3. Scan automático de antivírus em tempo real
4. Versionamento completo com histórico imutável
5. Download seguro com tokens temporários e watermark
6. Visualização inline de PDFs e imagens no navegador
7. Controle de acesso granular por RBAC e políticas
8. Compartilhamento de documentos com delegação temporal
9. Assinatura digital integrada (DocuSign)
10. OCR e busca full-text em conteúdo de documentos
11. Auditoria não-repudiável de todas operações
12. Validação de documentação obrigatória por tipo de contrato
13. Integração com RF023 para vincular documentos a contratos
14. Gestão de permissões e revogação de acessos

---

## 5. REGRAS DE NEGÓCIO

### RN-RF091-001 — Validação de Tipo de Arquivo (Whitelist)

**Descrição**: O sistema deve aceitar apenas tipos de arquivo explicitamente aprovados. Tentativas de upload de tipos não autorizados devem ser rejeitadas imediatamente com mensagem clara.

**Justificativa**: Proteger contra execução de código malicioso e garantir que documentação armazenada seja em formatos suportados.

**Tipos Permitidos**:
- PDF (application/pdf)
- DOCX (application/vnd.openxmlformats-officedocument.wordprocessingml.document)
- XLSX (application/vnd.openxmlformats-officedocument.spreadsheetml.sheet)
- JPG/JPEG (image/jpeg)
- PNG (image/png)
- TIFF (image/tiff)

**Critério de Aceite**:
- Arquivo com extensão .pdf e MIME type application/pdf → aceito
- Arquivo com extensão .exe → rejeitado (HTTP 400)
- Arquivo com extensão dupla .pdf.exe → rejeitado
- Validação deve ocorrer tanto por extensão quanto por MIME type (dupla verificação)

---

### RN-RF091-002 — Limite de Tamanho de Arquivo

**Descrição**: Nenhum arquivo individual pode exceder 50MB. Tentativas de upload de arquivos maiores devem retornar erro HTTP 413 (Payload Too Large).

**Justificativa**: Controlar consumo de banda, tempo de upload/download e armazenamento em blob storage. 50MB é suficiente para contratos PDF de alta qualidade e planilhas complexas.

**Critério de Aceite**:
- Arquivo de 5MB → aceito
- Arquivo de 50MB → aceito (limite máximo)
- Arquivo de 51MB → rejeitado (HTTP 413)
- Mensagem de erro deve indicar tamanho máximo permitido

---

### RN-RF091-003 — Scan Obrigatório de Antivírus

**Descrição**: Todo arquivo recebido deve ser submetido a scan de antivírus (ClamAV) antes de ser armazenado. Arquivos com malware detectado devem ser colocados em quarentena e o upload rejeitado.

**Justificativa**: Prevenir distribuição de malware através do sistema e atender requisitos de ISO 27001.

**Critério de Aceite**:
- Arquivo limpo → armazenado normalmente
- Arquivo com vírus EICAR → quarentenado, upload rejeitado (HTTP 400)
- Auditoria deve registrar evento de malware detectado com nome do vírus
- Usuário deve ser notificado sobre detecção de malware

---

### RN-RF091-004 — Cálculo de Hash para Integridade

**Descrição**: O sistema deve calcular hash SHA-256 de cada arquivo após upload. Este hash deve ser registrado e usado para validar integridade em downloads posteriores.

**Justificativa**: Detectar corrupção acidental de arquivo e fornecer evidência de não-repúdio.

**Critério de Aceite**:
- Arquivo uploadado → hash SHA-256 calculado e armazenado
- Download posterior → hash recalculado e comparado
- Hashes idênticos → integridade validada
- Hashes diferentes → alerta de corrupção, bloqueio de download

---

### RN-RF091-005 — Versionamento Imutável

**Descrição**: Cada versão de um documento é imutável e identificada por número sequencial. Novo upload cria nova versão sem alterar versões anteriores. Apenas a versão mais recente é marcada como "Atual".

**Justificativa**: Preservar histórico completo para auditoria, permitir rollback e criar trilha forense de alterações.

**Critério de Aceite**:
- Primeiro upload → VersionNumber = 1, IsCurrentVersion = true
- Segundo upload → VersionNumber = 2, IsCurrentVersion = true (v1 fica com IsCurrentVersion = false)
- Versões anteriores permanecem acessíveis e imutáveis
- Rollback cria nova versão (v3) com conteúdo idêntico à versão escolhida

---

### RN-RF091-006 — Armazenamento em Azure Blob Storage

**Descrição**: Todos os arquivos devem ser armazenados em Azure Blob Storage com criptografia AES-256 em repouso e TLS 1.2+ em trânsito.

**Justificativa**: Garantir segurança da informação, redundância geográfica e conformidade com LGPD.

**Critério de Aceite**:
- Arquivo armazenado em blob storage (não em file system local)
- Criptografia AES-256 habilitada na conta de storage
- Acesso ao blob apenas via SAS tokens ou autenticação Azure AD
- Backup geográfico redundante (RA-GRS) configurado

---

### RN-RF091-007 — Controle de Acesso Granular (RBAC + Policy)

**Descrição**: Acesso a documentos deve ser controlado por papel (Role) ou política (Policy). O sistema deve suportar delegação temporária de acesso e revogação imediata de permissões.

**Justificativa**: Garantir que apenas usuários autorizados acessem documentação sensível e atender requisitos de segregação de funções.

**Permissões Obrigatórias**:
- doc:document:create
- doc:document:read
- doc:document:download
- doc:document:update
- doc:document:delete
- doc:document:sign
- doc:document:share
- doc:document:audit

**Critério de Aceite**:
- Usuário sem permissão tenta acessar documento → HTTP 403 Forbidden
- Permissão delegada com ValidUntil expirado → acesso negado
- Permissão revogada (IsRevoked = true) → acesso negado imediatamente
- Role "Gerente de Contratos" tem acesso a todos os contratos de sua unidade
- Delegação temporária funciona até data especificada

---

### RN-RF091-008 — Download Seguro com SAS Token

**Descrição**: Downloads devem ser realizados através de SAS token do Azure com validade de 15 minutos. URLs de download devem expirar automaticamente.

**Justificativa**: Impedir compartilhamento de URLs permanentes e criar auditoria de quem baixou quando.

**Critério de Aceite**:
- Solicitação de download gera SAS token válido por 15 minutos
- URL expirada → acesso negado (HTTP 403)
- Cada download é registrado em auditoria com timestamp, UserId, IP

---

### RN-RF091-009 — Watermark em PDFs

**Descrição**: Documentos PDF baixados devem incluir watermark visual com nome do usuário, data/hora e logotipo da empresa.

**Justificativa**: Prevenir vazamentos não autorizados e deixar marca visual em documentos impressos.

**Critério de Aceite**:
- PDF baixado contém watermark: "Baixado por [Nome] em [Data/Hora]"
- Watermark deve ser visível mas não obstruir conteúdo principal
- Documentos não-PDF não recebem watermark

---

### RN-RF091-010 — OCR e Indexação Full-Text

**Descrição**: Documentos PDF e imagens devem sofrer OCR (Optical Character Recognition) para extração de texto. O texto extraído deve ser indexado em Elasticsearch para busca por conteúdo.

**Justificativa**: Permitir que usuários encontrem contratos específicos pelo conteúdo sem conhecer nome exato do arquivo.

**Critério de Aceite**:
- Upload de PDF/imagem → OCR processado automaticamente (async)
- Texto extraído indexado em Elasticsearch
- Busca por "fornecedor ABC" retorna documentos com esse termo no conteúdo
- Busca funciona mesmo em documentos scaneados (não nativos digitais)

---

### RN-RF091-011 — Integração com DocuSign para Assinatura Digital

**Descrição**: O sistema deve integrar com DocuSign para captura de assinaturas eletrônicas com valor legal (Lei 14.063/2020). Deve rastrear quem assinou, quando e de qual IP.

**Justificativa**: Garantir validade legal de documentos assinados e criar evidência forense.

**Critério de Aceite**:
- Usuário inicia fluxo de assinatura → documento enviado para DocuSign
- Signatário recebe email com link de assinatura
- Assinatura captura timestamp, IP, geolocalização
- Documento assinado retorna ao sistema como nova versão
- Auditoria registra todo o fluxo de assinatura

---

### RN-RF091-012 — Validação de Documentação Obrigatória

**Descrição**: Cada tipo de contrato pode definir quais tipos de documento são obrigatórios. Um contrato não pode ser marcado como "Ativo" enquanto não tiver todos os documentos obrigatórios.

**Justificativa**: Garantir que documentação contratual está completa antes de operações iniciarem.

**Critério de Aceite**:
- Contrato com documentos obrigatórios faltando → não pode ser ativado
- Tentativa de ativar contrato incompleto → erro claro indicando documentos faltantes
- Após upload de todos os documentos obrigatórios → contrato pode ser ativado

---

### RN-RF091-013 — Auditoria Não-Repudiável

**Descrição**: Todas as operações em documentos (upload, download, visualização, exclusão, compartilhamento, assinatura) devem ser registradas em tabela de auditoria imutável.

**Justificativa**: Atender requisitos LGPD (rastreabilidade de acesso a dados pessoais), ISO 27001 e forense de segurança.

**Dados Registrados**:
- UserId, UserEmail
- Action (DOC_UPLOAD, DOC_DOWNLOAD, DOC_DELETE, DOC_SIGN, etc.)
- DocumentId, ContractId
- Timestamp (UTC)
- IpAddress, UserAgent
- Metadata (informações contextuais)

**Critério de Aceite**:
- Toda operação gera entrada em AuditLog
- Logs são imutáveis (não podem ser alterados ou excluídos)
- Retenção de 10 anos para conformidade legal
- Busca por histórico de acesso funciona corretamente

---

### RN-RF091-014 — Isolamento Multi-Tenant

**Descrição**: Um usuário só pode acessar documentos do seu próprio tenant (ClienteId). Tentativas de acesso cruzado devem ser bloqueadas.

**Justificativa**: Garantir segregação absoluta de dados entre clientes.

**Critério de Aceite**:
- Usuário do ClienteId=A tenta acessar documento do ClienteId=B → acesso negado
- Queries de listagem filtram automaticamente por ClienteId do usuário autenticado
- Auditoria registra tentativas de acesso cruzado como incidentes de segurança

---

### RN-RF091-015 — Compartilhamento com Delegação Temporal

**Descrição**: O sistema deve permitir compartilhamento de documentos com usuários/grupos específicos, definindo permissões e validade temporal.

**Justificativa**: Permitir colaboração controlada sem expor documentos permanentemente.

**Critério de Aceite**:
- Documento compartilhado com ValidUntil = 2026-01-31 → acesso válido até essa data
- Após expiração → acesso revogado automaticamente
- Permissões podem ser: read, download, sign
- Compartilhamento pode ser revogado a qualquer momento

---

## 6. ESTADOS DA ENTIDADE

### DocumentAttachment (Anexo)

| Estado | Descrição |
|------|-----------|
| uploading | Upload em progresso |
| scanning | Scan de antivírus em andamento |
| active | Disponível para uso |
| quarantined | Malware detectado, bloqueado |
| deleted | Excluído logicamente |

### SigningFlow (Fluxo de Assinatura)

| Estado | Descrição |
|------|-----------|
| pending | Aguardando assinaturas |
| partially_signed | Algumas assinaturas coletadas |
| completed | Todas assinaturas coletadas |
| rejected | Signatário rejeitou assinatura |
| expired | Prazo de assinatura expirado |

### Transições Permitidas

**DocumentAttachment**:
- uploading → scanning
- scanning → active (se limpo)
- scanning → quarantined (se malware)
- active → deleted

**SigningFlow**:
- pending → partially_signed
- partially_signed → completed
- pending → rejected
- pending → expired

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre |
|------|--------------|
| document.uploaded | Após upload bem-sucedido e scan de antivírus |
| document.malware_detected | Quando ClamAV detecta vírus |
| document.downloaded | Quando SAS token é gerado para download |
| document.shared | Quando documento é compartilhado com usuário/grupo |
| document.signed | Quando assinatura é coletada (DocuSign) |
| document.deleted | Quando documento é excluído logicamente |
| document.version_created | Quando nova versão é criada |
| document.ocr_completed | Quando OCR é finalizado e texto indexado |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant
- Nenhum arquivo pode ser armazenado sem scan de antivírus
- Nenhum download pode ocorrer sem auditoria registrada
- Nenhuma versão pode ser alterada após criação (imutabilidade)
- Erros devem ser previsíveis, estruturados e rastreáveis
- Todas as operações devem respeitar permissões RBAC
- Integração com Azure Blob Storage deve ser resiliente a falhas
- OCR deve processar documentos de forma assíncrona sem bloquear upload

---

## 9. SEGURANÇA

### Proteções Obrigatórias

- Criptografia em repouso (AES-256) e em trânsito (TLS 1.2+)
- Validação dupla de tipo de arquivo (extensão + MIME type)
- Scan de antivírus em tempo real (ClamAV)
- Hash SHA-256 para integridade
- SAS tokens com expiração curta (15 minutos)
- Watermark em documentos sensíveis
- Rate limiting (100 uploads/hora, 1000 downloads/hora por usuário)
- MFA obrigatório para assinatura de documentos críticos
- Auditoria imutável de todas operações
- Proteção contra CSRF, XSS, SQL Injection, Path Traversal

### Testes de Segurança Obrigatórios

- SQL Injection em campos de busca
- XSS em nomes de arquivo
- CSRF em endpoints POST
- Path Traversal em download
- Acesso não autorizado (usuário A tentando acessar documento de usuário B)
- Upload de arquivo executável bloqueado
- Arquivo > 50MB rejeitado
- Malware (EICAR test file) detectado
- SAS token expirado retorna 403
- Verificação de integridade (hash mismatch) detectada

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF091.md** (Casos de Uso: upload, download, assinatura, compartilhamento, auditoria)
- **MD-RF091.md** (Modelo de Dados: DocumentAttachment, DocumentAccessPolicy, DocumentCategory, AuditLog)
- **WF-RF091.md** (Fluxos de Tela: listagem, upload, visualização, versionamento, assinatura, auditoria)
- **TC-RF091-BACKEND.yaml** (Casos de Teste backend)
- **TC-RF091-FRONTEND.yaml** (Casos de Teste frontend)
- **TC-RF091-SEGURANCA.yaml** (Casos de Teste de segurança)
- **TC-RF091-E2E.yaml** (Casos de Teste end-to-end)

---

## 11. RASTREABILIDADE

### Integrações Obrigatórias

| Sistema | Finalidade |
|---------|-----------|
| Azure Blob Storage | Armazenamento seguro de arquivos |
| ClamAV | Scan de antivírus |
| Azure Cognitive Services | OCR para extração de texto |
| Elasticsearch | Indexação e busca full-text |
| DocuSign | Assinatura digital |
| RF023 (Gestão de Contratos) | Vincular documentos a contratos |
| Central de Funcionalidades | Feature flags para OCR, antivírus, assinatura |
| Sistema de Auditoria | Registro de todas operações |

### Dependências

- RF023: Gestão de Contratos (vinculação de documentos)
- RF020: Documentos e Anexos (base conceitual)
- Central de Funcionalidades (controle de features)

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|------|------|----------|------|
| 2.0 | 2025-12-31 | Versão modernizada - Separação RF/RL, contrato funcional limpo | Agência ALC - alc.dev.br |
| 1.0 | 2025-12-28 | Versão inicial do requisito funcional | Claude Code |
