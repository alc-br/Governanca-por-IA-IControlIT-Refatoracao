# RF076: Manutenção Preventiva e Corretiva

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC011-INT-Integracoes
**Fase**: Fase 6 - Ativos, Auditoria e Integrações

---

## 1. OBJETIVO DO REQUISITO

Prover capacidade de gerenciamento completo do ciclo de vida das manutenções de ativos (preventivas e corretivas), permitindo agendamento automático, execução de ordens de serviço, controle de peças/materiais, workflow de aprovação e cálculo de indicadores de confiabilidade (MTBF) e eficiência (MTTR).

Este documento define **o que o sistema deve fazer**, servindo como **contrato oficial** entre negócio, desenvolvimento e testes, sem especificar tecnologia ou implementação.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- Criação e gestão de planos de manutenção preventiva com periodicidade configurável
- Agendamento automático de ordens de manutenção preventiva
- Criação de ordens de serviço corretivas (emergenciais)
- Workflow de aprovação de ordens com transições de estado controladas
- Registro de peças e materiais utilizados em cada manutenção
- Controle de custos (materiais + mão de obra)
- Cálculo automático de MTBF (Mean Time Between Failures)
- Cálculo automático de MTTR (Mean Time To Repair)
- Alertas de manutenções vencidas ou próximas do vencimento
- Integração com RF028 (Gestão de Ativos) para atualização de status
- Relatórios de custos e histórico de manutenções
- Controle de acesso baseado em permissões (RBAC)
- Auditoria de todas as operações
- Isolamento multi-tenant

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica ou layout de telas
- Tecnologia, framework ou linguagem de implementação
- Estratégia de deploy ou infraestrutura
- Gestão de contratos com fornecedores externos (coberto por RF023)
- Gestão de inventário de peças (integra com sistema existente)
- Agendamento de equipes técnicas (apenas atribuição de responsável)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| Manutenção Preventiva | Intervenção planejada em ativo antes de falha, baseada em calendário ou contadores (horas, km) |
| Manutenção Corretiva | Intervenção não planejada para restaurar ativo à operação após falha |
| Ordem de Serviço (OS) | Documento que autoriza e documenta uma intervenção de manutenção com escopo, recursos e cronograma definidos |
| Plano de Manutenção | Conjunto de manutenções preventivas agendadas para um ativo ou classe de ativos |
| MTBF | Mean Time Between Failures - Tempo médio entre falhas consecutivas (indicador de confiabilidade) |
| MTTR | Mean Time To Repair - Tempo médio para reparar (indicador de eficiência de manutenção) |
| Checklist | Lista de atividades a serem executadas durante uma manutenção |
| Periodicidade | Intervalo de tempo ou contador que define quando manutenção deve ocorrer |
| Tenant | Unidade lógica de isolamento de dados (ClienteId ou EmpresaId) |

---

## 4. FUNCIONALIDADES COBERTAS

1. Criar plano de manutenção preventiva
2. Atualizar plano de manutenção preventiva
3. Consultar plano por ID
4. Listar planos de manutenção
5. Ativar/desativar plano de manutenção
6. Criar ordem de serviço (preventiva ou corretiva)
7. Aprovar ordem de serviço
8. Iniciar execução de ordem
9. Registrar peças/materiais utilizados
10. Concluir ordem de serviço
11. Fechar ordem de serviço
12. Consultar ordem por ID
13. Listar ordens com filtros
14. Calcular MTBF de um ativo
15. Calcular MTTR de um ativo
16. Gerar alertas de manutenções vencidas
17. Gerar relatório de custos de manutenção
18. Gerar histórico de manutenções por ativo

---

## 5. REGRAS DE NEGÓCIO

### RN-RF076-01 — Criação de Plano de Manutenção Preventiva

**Descrição**: Um plano de manutenção preventiva deve especificar periodicidade (calendário ou contador) e checklist de atividades. Pelo menos um tipo de intervalo deve ser definido (dias, horas ou quilometragem).

**Justificativa**: Padronizar intervalos de manutenção conforme recomendações do fabricante, normas técnicas (ISO 55000) e boas práticas de engenharia de manutenção.

**Critério de Aceite**:
- Nome do plano obrigatório
- Ativo associado obrigatório
- Pelo menos um intervalo configurado (dias > 0 OU horas > 0 OU km > 0)
- Checklist com mínimo 1 atividade
- Tentativa de criar plano sem intervalo → rejeição

---

### RN-RF076-02 — Agendamento Automático de Manutenção Preventiva

**Descrição**: Ao ativar um plano de manutenção, o sistema deve gerar automaticamente ordens de manutenção preventiva de forma recorrente. A primeira ordem é criada imediatamente; as subsequentes seguem a periodicidade definida.

**Justificativa**: Automação reduz carga administrativa e garante que manutenções preventivas nunca sejam esquecidas.

**Critério de Aceite**:
- Plano ativado → primeira ordem criada imediatamente com status "Agendada"
- Agendamento recorrente configurado conforme periodicidade
- Plano desativado → agendamento recorrente removido, novas ordens não são criadas
- Ordens já criadas permanecem mesmo se plano for desativado

---

### RN-RF076-03 — Status de Ordem de Serviço e Transições

**Descrição**: Uma ordem de serviço passa por estados bem definidos. Transições inválidas devem ser rejeitadas.

**Justificativa**: Controle de workflow garante que ordens sejam executadas conforme processo aprovado e permita auditoria de cada transição.

**Critério de Aceite**:
- Estados válidos: Agendada, Aprovada, Rejeitada, EmExecucao, Concluida, Fechada
- Transições permitidas:
  - Agendada → Aprovada (por usuário com permissão `man:ordem:approve`)
  - Agendada → Rejeitada (por usuário com permissão `man:ordem:approve`)
  - Aprovada → EmExecucao (por usuário com permissão `man:ordem:execute`)
  - EmExecucao → Concluida (por usuário com permissão `man:ordem:execute`)
  - Concluida → Fechada (por usuário com permissão `man:ordem:close`)
- Tentativa de transição não permitida → rejeição
- Ordem rejeitada não pode mudar para nenhum outro estado

---

### RN-RF076-04 — Peças e Materiais Utilizados

**Descrição**: Toda peça ou material utilizado em uma manutenção deve ser registrado na ordem de serviço com quantidade, custo unitário e descrição. Quantidade deve ser positiva e custo não pode ser negativo.

**Justificativa**: Rastreabilidade de custos, controle de inventário e documentação para auditoria e análise de despesas.

**Critério de Aceite**:
- Quantidade obrigatória e > 0
- Custo unitário obrigatório e >= 0
- Descrição obrigatória
- Tentativa de registrar quantidade <= 0 → rejeição
- Tentativa de registrar custo negativo → rejeição
- Saída de inventário é automática ao fechar a ordem

---

### RN-RF076-05 — Cálculo Automático de MTBF

**Descrição**: MTBF (Mean Time Between Failures) é calculado como tempo médio entre falhas consecutivas de um ativo. Fórmula: (Total Horas de Operação) / (Número de Falhas). Deve ser atualizado sempre que uma ordem corretiva é fechada.

**Justificativa**: MTBF é indicador crítico de confiabilidade. Maior MTBF indica ativo mais confiável e menor necessidade de manutenção emergencial.

**Critério de Aceite**:
- MTBF calculado apenas para ativos com 2 ou mais falhas corretivas
- Ativo com 0 ou 1 falha → MTBF = 0 (insuficiente dados)
- Apenas ordens corretivas fechadas são consideradas
- MTBF atualizado automaticamente ao fechar ordem corretiva

---

### RN-RF076-06 — Cálculo Automático de MTTR

**Descrição**: MTTR (Mean Time To Repair) é o tempo médio para reparar uma falha. Fórmula: (Total Horas de Reparo) / (Número de Falhas). Horas de reparo são contadas do estado "EmExecucao" até "Concluida".

**Justificativa**: MTTR indica eficiência da equipe de manutenção. Menor MTTR significa reparos mais rápidos e menor downtime.

**Critério de Aceite**:
- MTTR calculado apenas para ativos com ordens corretivas fechadas
- Apenas ordens com DataInicio e DataConclusao preenchidas são consideradas
- Ativo sem reparos concluídos → MTTR = 0
- MTTR atualizado automaticamente ao fechar ordem corretiva

---

### RN-RF076-07 — Alertas de Manutenção Vencida

**Descrição**: O sistema deve monitorar ordens de manutenção preventiva agendadas. Se não forem executadas até 7 dias após a data prevista, deve gerar alerta automático e notificar responsável.

**Justificativa**: Conformidade com cronograma de manutenção preventiva, evitando atrasos que comprometam a confiabilidade do ativo.

**Critério de Aceite**:
- Verificação automática diária
- Ordem preventiva com status "Agendada" e DataPrevista < (Hoje - 7 dias) → gera alerta
- Alerta com severidade "Alta"
- Notificação enviada para responsável pela ordem
- Ordem já aprovada, em execução, concluída ou fechada → não gera alerta

---

### RN-RF076-08 — Integração com RF028 - Status de Ativo

**Descrição**: Quando uma ordem de manutenção passa para "EmExecucao", o status do ativo associado deve mudar para "EmManutencao". Quando concluída, volta para "Operacional" ou conforme configurado.

**Justificativa**: Mantém consistência entre módulos e reflete estado real do ativo no sistema.

**Critério de Aceite**:
- Ordem inicia execução → Ativo muda para "EmManutencao"
- Ordem concluída → Ativo volta para "Operacional" (padrão) ou status especificado
- Mudança de status auditada
- Evento publicado para integração com RF028

---

### RN-RF076-09 — Permissões e Autorização por Tipo de Operação

**Descrição**: Diferentes operações requerem permissões específicas. Usuários sem permissão devem ter operação rejeitada com HTTP 403.

**Justificativa**: Controle de acesso baseado em função (RBAC) garante segregação de deveres e conformidade com políticas de autorização.

**Critério de Aceite**:

| Operação | Permissão Requerida | Perfis Comuns |
|----------|---------------------|---------------|
| Criar ordem | `man:ordem:create` | Gerente, Técnico, Admin |
| Visualizar ordem | `man:ordem:read` | Todos os usuários |
| Atualizar ordem | `man:ordem:update` | Gerente, Admin |
| Aprovar ordem | `man:ordem:approve` | Aprovador, Gerente, Admin |
| Executar ordem | `man:ordem:execute` | Técnico, Admin |
| Fechar ordem | `man:ordem:close` | Gerente, Admin |
| Criar plano | `man:plano:create` | Gerente, Admin |
| Visualizar plano | `man:plano:read` | Todos os usuários |
| Atualizar plano | `man:plano:update` | Gerente, Admin |
| Ativar plano | `man:plano:activate` | Gerente, Admin |
| Visualizar relatórios | `man:relatorio:read` | Gerente, Admin |

- Tentativa de operação sem permissão → HTTP 403 Forbidden

---

### RN-RF076-10 — Isolamento por Tenant

**Descrição**: Um usuário só pode acessar ordens, planos e relatórios do seu próprio tenant (ClienteId ou EmpresaId).

**Justificativa**: Segurança e conformidade multi-tenant.

**Critério de Aceite**:
- Todas as queries filtradas automaticamente por tenant do usuário autenticado
- Tentativa de acesso cruzado → não permitido (registro não encontrado ou HTTP 403)
- Isolamento aplicado em todas as operações (CRUD, relatórios, cálculos)

---

## 6. ESTADOS DA ENTIDADE

### Ordem de Serviço

| Estado | Descrição |
|--------|-----------|
| Agendada | Ordem criada, aguardando aprovação ou execução |
| Aprovada | Ordem aprovada por aprovador, aguarda execução |
| Rejeitada | Ordem negada por aprovador (estado final) |
| EmExecucao | Ordem sendo executada por técnico |
| Concluida | Ordem executada, aguarda fechamento |
| Fechada | Ordem finalizada e auditada (estado final) |

### Transições permitidas

| De | Para | Permissão Requerida |
|----|------|---------------------|
| Agendada | Aprovada | `man:ordem:approve` |
| Agendada | Rejeitada | `man:ordem:approve` |
| Aprovada | EmExecucao | `man:ordem:execute` |
| EmExecucao | Concluida | `man:ordem:execute` |
| Concluida | Fechada | `man:ordem:close` |

### Plano de Manutenção

| Estado | Descrição |
|--------|-----------|
| Ativo | Plano gerando ordens automaticamente |
| Inativo | Plano não gera novas ordens |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre | Payload |
|--------|---------------|---------|
| ordem.criada | Após criação de ordem | { Id, IdAtivo, Tipo, Status } |
| ordem.aprovada | Após aprovação | { Id, IdAprovador, DataAprovacao } |
| ordem.rejeitada | Após rejeição | { Id, IdAprovador, MotivoRejeicao } |
| ordem.iniciada | Ao iniciar execução | { Id, IdTecnico, DataInicio } |
| ordem.concluida | Ao concluir execução | { Id, DataConclusao } |
| ordem.fechada | Ao fechar ordem | { Id, CustoTotal, HorasExecutadas } |
| plano.ativado | Ao ativar plano | { Id, IdAtivo, Periodicidade } |
| plano.desativado | Ao desativar plano | { Id } |
| mtbf.atualizado | Após fechar ordem corretiva | { IdAtivo, NovoMTBF } |
| mttr.atualizado | Após fechar ordem corretiva | { IdAtivo, NovoMTTR } |
| ativo.status.alterado | Ao mudar status de ativo | { IdAtivo, StatusAnterior, NovoStatus } |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant
- Nenhuma regra de negócio pode ser ignorada
- Transições de estado inválidas devem ser rejeitadas
- Erros devem ser previsíveis e rastreáveis
- Auditoria deve registrar quem, quando e o que mudou
- Permissões RBAC devem ser validadas em todas as operações
- Cálculos de MTBF/MTTR devem ser precisos e atualizados automaticamente
- Agendamentos automáticos devem funcionar mesmo com sistema reiniciado

---

## 9. SEGURANÇA

- Validação de entrada obrigatória (campos, tipos, ranges)
- Proteção contra SQL Injection (queries parametrizadas)
- Proteção contra XSS (sanitização de saída)
- CSRF Token validado em operações CUD
- Controle de permissões RBAC em todos os endpoints
- Isolamento multi-tenant em todas as queries
- Soft delete (Fl_Excluido) em vez de exclusão física
- Auditoria completa de todas as operações
- Rate limiting (100 req/min por usuário)
- Logging de tentativas de acesso não autorizado

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF076.md** - Casos de Uso (UC00-UC04 + específicos)
- **MD-RF076.yaml** - Modelo de Dados (tabelas, relacionamentos, DDL)
- **WF-RF076.md** - Fluxos de Trabalho (wireframes, componentes)
- **TC-RF076.yaml** - Casos de Teste (3 camadas: Backend, Sistema, E2E)
- **MT-RF076.yaml** - Massas de Teste (dados válidos e inválidos)
- **user-stories.yaml** - User Stories derivadas deste RF

---

## 11. RASTREABILIDADE

| Artefato | Status | Localização |
|----------|--------|-------------|
| Casos de Uso | Obrigatório | UC-RF076.md |
| Modelo de Dados | Obrigatório | MD-RF076.yaml |
| Fluxos de Trabalho | Obrigatório | WF-RF076.md |
| Casos de Teste | Obrigatório | TC-RF076.yaml |
| Massas de Teste | Obrigatório | MT-RF076.yaml |
| User Stories | Obrigatório | user-stories.yaml |
| Referência ao Legado | Obrigatório | RL-RF076.md / RL-RF076.yaml |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0: Separação RF/RL completa, 0% conteúdo legado, 11 seções obrigatórias, 10 RNs em linguagem natural | Agência ALC - alc.dev.br |
| 1.0 | 2025-12-28 | Versão inicial com 10 regras, 13 endpoints, 4 integrações obrigatórias | Claude Architect |

---

**Última Atualização**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**Status Completude**: 100% - RF076 v2.0 conforme template canônico
