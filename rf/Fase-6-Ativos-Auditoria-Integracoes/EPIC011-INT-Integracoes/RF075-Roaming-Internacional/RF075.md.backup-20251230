# RF-075: Roaming Internacional

**Versao**: 1.0 | **Data**: 2025-12-28
**RF Relacionado**: RF-014 (Configuracoes do Usuario), RF-004 (Auditoria), RF-005 (i18n)
**EPIC**: EPIC011-INT-Integracoes
**Fase**: Fase 6 - Ativos, Auditoria e Integrações

---

## 1. RESUMO EXECUTIVO

### 1.1 Descricao Geral

Este requisito especifica o **módulo de Roaming Internacional** do sistema IControlIT, responsável por gerenciar solicitações de ativação de serviços de roaming internacional para dispositivos móveis corporativos. O módulo permite que colaboradores solicitem roaming em países específicos, que gestores aprovem essas solicitações, e que o sistema coordene a ativação junto aos operadores de telecomunicações (Vivo, Claro, TIM, Oi).

O módulo inclui funcionalidades de:
- Gestão completa do ciclo de vida de solicitações de roaming
- Workflow de aprovação com múltiplas etapas
- Integração com APIs dos operadores de telecomunicações
- Controle de limites de consumo (dados, voz, SMS) por país/região
- Alertas automáticos de consumo excessivo
- Bloqueio automático ao atingir limite
- Auditoria completa de solicitações e consumos
- Relatórios de custos e conformidade

### 1.2 Importancia Estrategica

O módulo de Roaming Internacional é crítico para:
- **Conformidade**: Controle de gastos internacionais evita surpresas orçamentárias e garante compliance com políticas de custos corporativos
- **Produtividade**: Permite que colaboradores em viagens internacionais mantenham conectividade, essencial para operações distribuídas
- **Governança de TI**: Auditoria completa de quem, quando e onde ativou roaming, cumprindo requisitos LGPD e de conformidade regulatória
- **Eficiência Operacional**: Automação de aprovação reduz tempo de ativação de dias para minutos
- **Controle de Custos**: Limites por país/region e alertas de consumo reduzem custos inesperados

### 1.3 Conceitos Fundamentais

**Roaming Internacional**: Capacidade de usar serviços de telefonia móvel (dados, voz, SMS) em países diferentes do país de origem, utilizando redes de operadores parceiros.

**Solicitação de Roaming**: Pedido formal de um colaborador ou gestor para ativar roaming em um país/região específica, com período determinado.

**Aprovação em Cascata**: Workflow onde solicitação passa por: Validação Automática → Aprovação de Gestor → Ativação com Operadora.

**Limite de Consumo**: Quantidade máxima de dados (GB), minutos de voz ou SMS permitida por período em uma região específica.

**Alerta de Consumo**: Notificação automática enviada quando consumo atinge 50%, 75%, 90% ou 100% do limite establecido.

**Bloqueio Automático**: Desativação automática de roaming quando consumo atinge 100% do limite ou data de término da solicitação é atingida.

### 1.4 Legado vs Modernizado

| Aspecto | Legado (VB.NET) | Modernizado (.NET 10 + Angular) |
|---------|-----------------|--------------------------------|
| **Interface de Solicitação** | Formulário ASPX simples com campos básicos | Tela Angular responsiva com validação real-time e integração com catálogo de países |
| **Workflow de Aprovação** | Aprovações sequenciais por email, sem rastreamento digital | Engine de workflow com estados visuais, notificações em tempo real, auditoria completa |
| **Integração com Operadoras** | WebService SOAP com polling manual, sem automação | APIs REST assíncronas com webhooks, sincronização de status em tempo real |
| **Controle de Limites** | Limites globais por usuário, sem segmentação por país | Limites granulares por país/região com alertas escalonados (50%, 75%, 90%, 100%) |
| **Monitoramento de Consumo** | Relatórios manuais gerados 1x/dia | Dashboard em tempo real com alertas automáticos e bloqueio imediato ao atingir limite |
| **Auditoria** | Logs básicos em tabela sem estrutura padronizada | Auditoria completa com rastreamento de alterações, usuário/timestamp/ação/dados antes/depois |
| **Conformidade Regulatória** | Sem suporte explícito a LGPD ou retenção de dados | Retenção de 7 anos conforme LGPD, direito ao esquecimento, relatórios de acesso |

### 1.5 Funcionalidades Principais

1. **Solicitação de Roaming** - Colaborador solicita ativação de roaming com país, período e tipo de serviço (dados/voz/SMS)
2. **Aprovação de Gestor** - Gestor direto aprova ou rejeita solicitação com justificativa
3. **Validação de Limites** - Sistema valida se solicitação não ultrapassa limites por país/perfil de gasto
4. **Ativação com Operadora** - Sistema faz chamada à API da operadora para ativar roaming no SIM
5. **Monitoramento de Consumo** - Sincronização periódica com operadora para monitorar consumo em tempo real
6. **Alertas Escalonados** - Notificações automáticas ao atingir 50%, 75%, 90% e 100% do limite
7. **Bloqueio Automático** - Desativação automática ao atingir limite ou data de término
8. **Gestão de Limites** - Admin configura limites por país, região, tipo de serviço e perfil de gasto
9. **Relatórios de Consumo** - Relatórios detalhados de consumo internacional por usuário, período, país, custo
10. **Auditoria Completa** - Registro de todas as ações (solicitação, aprovação, ativação, bloqueio, consumo)

---

## 2. REGRAS DE NEGOCIO

### RN-ROM-075-01: Solicitação Requer Aprovação de Gestor

**Descricao**: Toda solicitação de roaming deve ser explicitamente aprovada pelo gestor direto do solicitante antes de ser ativada com a operadora.

**Justificativa**: Conformidade com política de controle de custos. Garante que decisões de gastos internacionais são tomadas com ciência do gestor responsável pelo orçamento.

**Implementacao**:
```csharp
public class SolicitacaoRoamingCommand
{
    public int SolicitacaoId { get; set; }
    public int SolicitanteId { get; set; }
    public int GestorId { get; set; } // Obrigatorio
    public DateTime DataInicio { get; set; }
    public DateTime DataFim { get; set; }

    public void Validar()
    {
        // Validacao 1: Gestor nao pode ser o mesmo do solicitante
        if (SolicitanteId == GestorId)
            throw new InvalidOperationException("Solicitante nao pode ser gestor de si mesmo");

        // Validacao 2: Data fim deve ser >= data inicio
        if (DataFim < DataInicio)
            throw new InvalidOperationException("Data fim deve ser posterior a data inicio");

        // Validacao 3: Solicitacao nao pode ser para data passada
        if (DataInicio < DateTime.Today.AddHours(-1))
            throw new InvalidOperationException("Data inicio nao pode ser retroativa");
    }
}
```

**Exemplos**:
- ✓ Colaborador João solicita roaming em Paris de 01/03 a 05/03. Seu gestor Maria aprova. Solicitação passa para ativação.
- ✗ Colaborador João tenta solicitar roaming sem informar gestor. Sistema rejeita com mensagem: "Gestor obrigatório".

---

### RN-ROM-075-02: Limite de Consumo por País é Inviolável

**Descricao**: Nenhum dispositivo pode consumir mais dados, minutos ou SMS do que o limite estabelecido para aquele país. Se limite é atingido, roaming é desativado imediatamente.

**Justificativa**: Proteção contra custos inesperados. Operadores cobram altíssimas taxas por dados/voz internacional. Sem limite automático, empresa fica exposta a faturas de tens de milhares.

**Implementacao**:
```csharp
public class MonitorConsumoService
{
    public async Task VerificaLimitesAsync(int solicitacaoId)
    {
        var solicitacao = await _context.SolicitacoesRoaming
            .Include(x => x.Pais)
            .Include(x => x.Consumo)
            .FirstOrDefaultAsync(x => x.Id == solicitacaoId);

        var limite = solicitacao.Pais.LimiteDadosGB;
        var consumido = solicitacao.Consumo.Sum(x => x.DadosGB);

        if (consumido >= limite)
        {
            // Desativa roaming imediatamente
            await DesativaRoamingAsync(solicitacaoId, "Limite atingido");
            // Notifica usuario
            await _notificationService.NotificaAsync(solicitacao.SolicitanteId,
                "Roaming desativado: limite de dados atingido");
        }
    }
}
```

**Exemplos**:
- ✓ Limite configurado: 5 GB em França. Usuario consome 4,8 GB, recebe alerta "90% limite". Quando atinge 5 GB, roaming é desativado automaticamente.
- ✗ Limite configurado: 5 GB em França. Sistema deixa usuario consumir 6 GB. VIOLAÇÃO: Sistema deve ter desativado ao atingir 5 GB.

---

### RN-ROM-075-03: Alertas de Consumo em Cascata (50%, 75%, 90%, 100%)

**Descricao**: Sistema envia alertas automáticos ao usuario quando consumo atinge 50%, 75%, 90% e 100% do limite.

**Justificativa**: Aderência com boas práticas. Usuario precisa ser notificado ANTES de atingir limite total, para que possa tomar ações (reduzir uso, solicitar extensão de limite).

**Implementacao**:
```csharp
public class AlertaConsumoService
{
    private readonly decimal[] LIMIARES = { 0.50m, 0.75m, 0.90m, 1.00m };

    public async Task VerificaAlertas(Consumo consumo, Limite limite)
    {
        var percentual = (decimal)consumo.DadosGB / limite.LimiteDadosGB;

        foreach (var limiar in LIMIARES)
        {
            // Se ja foi alertado neste limiar, nao alertar novamente
            if (consumo.UltimoLimiarAlertado >= limiar)
                continue;

            if (percentual >= limiar)
            {
                var mensagem = limiar == 1.00m
                    ? $"CRITICO: Roaming sera desativado em 1 hora"
                    : $"Atencao: {(int)(limiar * 100)}% do limite consumido";

                await _notificationService.NotificaAsync(
                    consumo.SolicitacaoId,
                    mensagem,
                    NotificationType.Urgente);

                consumo.UltimoLimiarAlertado = limiar;
                await _context.SaveChangesAsync();
            }
        }
    }
}
```

**Exemplos**:
- ✓ Limite 5 GB. Em 2,5 GB: Alerta "50% limite". Em 3,75 GB: Alerta "75%". Em 4,5 GB: Alerta "90%". Em 5 GB: Alerta "100%, desativando em 1h".
- ✗ Limite 5 GB. Usuario consome 4,9 GB mas nao recebe nenhum alerta. VIOLAÇÃO: Sistema deve ter alertado em 50%, 75%, 90%.

---

### RN-ROM-075-04: Roaming Desativa Automaticamente na Data de Término

**Descricao**: Roaming é desativado automaticamente no dia/hora de término especificada na solicitação, independente de quantos dados foram consumidos.

**Justificativa**: Controle de tempo. Roaming é aprovado para periodo especifico. Nao é permitido extensão automática. Se usuario precisa mais tempo, deve solicitar nova aprovação.

**Implementacao**:
```csharp
public class JobDesativacaoAutomaticaRoaming : IHostedService
{
    public async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        // Job executado a cada hora
        var agora = DateTime.UtcNow;
        var ativas = await _context.SolicitacoesRoaming
            .Where(x => x.DataFim <= agora && x.Status == StatusRoaming.Ativa)
            .ToListAsync();

        foreach (var solicitacao in ativas)
        {
            await DesativaRoamingAsync(solicitacao.Id, "Data de término atingida");
        }
    }
}
```

**Exemplos**:
- ✓ Roaming aprovado de 01/03 a 05/03. Em 05/03 às 23:59:59, sistema desativa automaticamente.
- ✗ Roaming aprovado até 05/03. Usuario continua com dados em 06/03. VIOLAÇÃO: Sistema nao desativou.

---

### RN-ROM-075-05: Rejeiçao de Solicitação Invalida Gesto Duplo

**Descricao**: Se um gestor rejeita uma solicitação, o solicitante pode corrigir os dados e reenviar. Solicitação rejeitada gera ciclo de revisão de NO MÁXIMO 3 tentativas. Na 4ª rejeição, solicitação é cancelada e requer nova solicitação.

**Justificativa**: Permite correção de erros, mas evita ciclos infinitos. Após 3 rejeições, assume-se que a solicitação nao pode ser aprovada (gestor identificou problema estrutural).

**Implementacao**:
```csharp
public class SolicitacaoRoaming
{
    public int TentativasRejeitadas { get; set; } = 0;

    public async Task RejeitaAsync(string motivo)
    {
        TentativasRejeitadas++;

        if (TentativasRejeitadas >= 3)
        {
            Status = StatusRoaming.Cancelada;
            await _notificationService.NotificaAsync(
                SolicitanteId,
                "Solicitacao cancelada apos 3 rejeicoes. Solicite novamente.");
        }
        else
        {
            Status = StatusRoaming.RejeitadaParaRevisao;
            await _notificationService.NotificaAsync(
                SolicitanteId,
                $"Solicitacao rejeitada ({TentativasRejeitadas}/3). Revise e reenvie.");
        }
    }
}
```

**Exemplos**:
- ✓ Solicitação rejeitada 1x. Solicitante corrige. Solicitação rejeitada 2x. Solicitante corrige novamente. 3ª tentativa é aprovada.
- ✗ Solicitação rejeitada 3x. Solicitante tenta reenviar. Sistema deve rejeitar e exigir nova solicitação.

---

### RN-ROM-075-06: Integração com Operadora Requer Dados Válidos

**Descricao**: Antes de chamar API da operadora para ativar roaming, sistema valida que dispositivo existe, tem plano ativo, e operadora tem integração configurada.

**Justificativa**: Falhas na integração com operadora causam incidentes críticos. Validação prévia reduz falhas.

**Implementacao**:
```csharp
public class AtivacaoRoamingService
{
    public async Task AtivaRoamingAsync(int solicitacaoId)
    {
        var solicitacao = await _context.SolicitacoesRoaming
            .Include(x => x.Dispositivo)
            .Include(x => x.Operadora)
            .FirstAsync(x => x.Id == solicitacaoId);

        // Validacao 1: Dispositivo existe e esta ativo
        if (solicitacao.Dispositivo == null || !solicitacao.Dispositivo.Ativo)
            throw new InvalidOperationException("Dispositivo nao ativo");

        // Validacao 2: Plano ativo
        if (solicitacao.Dispositivo.DataVencimento < DateTime.Today)
            throw new InvalidOperationException("Plano vencido");

        // Validacao 3: Operadora tem integracao
        if (string.IsNullOrEmpty(solicitacao.Operadora.ApiKey))
            throw new InvalidOperationException("Operadora sem integracao configurada");

        // Agora sim, chama API
        await _operadoraApiService.AtivaRoamingAsync(
            solicitacao.Dispositivo.Msisdn,
            solicitacao.Pais.CodigoIso,
            solicitacao.DataFim);
    }
}
```

**Exemplos**:
- ✓ Sistema valida todos os dados antes de chamar operadora. Ativacao bem-sucedida.
- ✗ Sistema chama operadora sem validar se plano esta ativo. Operadora rejeita. Incidente causado.

---

### RN-ROM-075-07: Auditoria de Todas as Ações

**Descricao**: Cada ação no ciclo de vida da solicitação (solicitacao, aprovacao, rejeicao, ativacao, desativacao, consumo) é registrada em tabela de auditoria com usuario, timestamp, acao, dados antes/depois.

**Justificativa**: Conformidade LGPD e rastreabilidade. Auditoria é usado para investigacao de incidentes, prova de conformidade, e direito ao esquecimento.

**Implementacao**:
```csharp
public class AuditoriaService
{
    public async Task RegistraAsync(
        int solicitacaoId,
        string acao, // "SOLICITAR", "APROVAR", "DESATIVAR", etc
        object dadosAntes,
        object dadosDepois,
        int usuarioId)
    {
        var registro = new RegistroAuditoria
        {
            SolicitacaoId = solicitacaoId,
            Acao = acao,
            DadosAntes = JsonConvert.SerializeObject(dadosAntes),
            DadosDepois = JsonConvert.SerializeObject(dadosDepois),
            UsuarioId = usuarioId,
            DataUTC = DateTime.UtcNow
        };

        _context.AuditoriaRoaming.Add(registro);
        await _context.SaveChangesAsync();
    }
}
```

**Exemplos**:
- ✓ Solicitacao criada: Auditoria registra {UsuarioId: 123, Acao: SOLICITAR, DataUTC: 2025-12-28T10:30:00Z, Pais: Brasil}
- ✓ Aprovacao: Auditoria registra {UsuarioId: 456, Acao: APROVAR, DadosAntes: {Status: Pendente}, DadosDepois: {Status: Aprovada}}

---

### RN-ROM-075-08: Notificacoes em Tempo Real para Gestor e Solicitante

**Descricao**: Sistema envia notificacoes automáticas via email e dashboard quando: solicitacao criada, aprovada, rejeitada, ativada, desativada, limite atingido.

**Justificativa**: Transparência e rapidez. Usuarios precisam saber o status da solicitacao imediatamente.

**Implementacao**:
```csharp
public enum EventoRoaming
{
    Solicitada,
    Aprovada,
    Rejeitada,
    Ativada,
    Desativada,
    LimiteProximo,
    LimiteAtingido
}

public async Task NotificaAsync(int solicitacaoId, EventoRoaming evento)
{
    var solicitacao = await _context.SolicitacoesRoaming.FindAsync(solicitacaoId);

    var mensagem = evento switch
    {
        EventoRoaming.Solicitada => "Solicitacao criada. Aguardando aprovacao do gestor.",
        EventoRoaming.Aprovada => "Solicitacao aprovada. Ativando com operadora...",
        EventoRoaming.Ativada => "Roaming ativo ate " + solicitacao.DataFim.ToString("dd/MM/yyyy"),
        EventoRoaming.Desativada => "Roaming desativado.",
        EventoRoaming.LimiteProximo => "Aviso: 90% do limite consumido",
        _ => "Evento desconhecido"
    };

    // Email
    await _emailService.EnviaAsync(solicitacao.SolicitanteId, mensagem);

    // Dashboard (WebSocket)
    await _notificationHub.EnviaAsync(solicitacao.SolicitanteId, mensagem);
}
```

**Exemplos**:
- ✓ Usuario solicita roaming → Email: "Solicitacao criada". Gestor aprova → Email ao usuario: "Aprovada, ativando".
- ✗ Usuario solicita roaming → Nenhuma notificacao. Usuario nao sabe o status.

---

### RN-ROM-075-09: Limite de Roaming Ativo por Usuario (Máximo 5 Simultaneos)

**Descricao**: Usuario nao pode ter mais de 5 roamings ativos simultaneamente. Isso evita uso abusivo (ex: usuario leva multiplos dispositivos de forma nao autorizada).

**Justificativa**: Controle de uso corporativo. Roaming é para dispositivo do usuario, nao para multiplos dispositivos.

**Implementacao**:
```csharp
public class ValidadorRoamingService
{
    public async Task ValidaLimiteSimultaneos(int usuarioId)
    {
        var agora = DateTime.UtcNow;
        var ativas = await _context.SolicitacoesRoaming
            .Where(x => x.SolicitanteId == usuarioId
                && x.Status == StatusRoaming.Ativa
                && x.DataInicio <= agora
                && x.DataFim >= agora)
            .CountAsync();

        if (ativas >= 5)
            throw new InvalidOperationException(
                "Usuario ja tem 5 roamings ativos. Desative um antes de solicitar novo.");
    }
}
```

**Exemplos**:
- ✓ Usuario tem 3 roamings ativos. Solicita um 4o. Sistema aprova.
- ✗ Usuario tem 5 roamings ativos. Solicita um 6o. Sistema rejeita com mensagem clara.

---

### RN-ROM-075-10: Retenção de Dados Conforme LGPD (7 Anos)

**Descricao**: Todos os dados de roaming (solicitacoes, consumo, auditoria) sao retidos por 7 anos. Apos 7 anos, usuario pode solicitar direito ao esquecimento e dados sao anonimizados.

**Justificativa**: Conformidade LGPD artigos 16-18. Empresa precisa manter dados para investigacao e compliance. Apos 7 anos, dados sao anonimizados.

**Implementacao**:
```csharp
public class LgpdRetencaoService
{
    public async Task AnonimizaDadosApos7AnosAsync()
    {
        var limiteData = DateTime.Today.AddYears(-7);
        var registrosAntigos = await _context.SolicitacoesRoaming
            .Where(x => x.DataCriacao < limiteData && !x.Anonimizado)
            .ToListAsync();

        foreach (var solicitacao in registrosAntigos)
        {
            solicitacao.SolicitanteNome = "[ANONIMIZADO]";
            solicitacao.SolicitanteEmail = "[ANONIMIZADO]@anonimizado.local";
            solicitacao.SolicitanteId = null;
            solicitacao.Anonimizado = true;
        }

        await _context.SaveChangesAsync();
    }
}
```

**Exemplos**:
- ✓ Solicitacao de roaming de 2018. Sistema anonimiza dados ao chegar 2025.
- ✓ Usuario solicita "direito ao esquecimento". Sistema marca dados como anonimizados se ja passaram 7 anos.

---

## 3. REFERENCIAS AO LEGADO

### 3.1 Banco de Dados Legado

**Banco**: `IC1_LEGADO`

**Tabela Principal**: `dbo.RoamingInternacional`
```sql
CREATE TABLE [dbo].[RoamingInternacional](
    [Id_Roaming] [int] IDENTITY(1,1) NOT NULL,
    [Id_Usuario] [int] NOT NULL,
    [Id_Pais] [int] NOT NULL,
    [Dt_Inicio] [datetime] NOT NULL,
    [Dt_Fim] [datetime] NOT NULL,
    [Tx_Justificativa] [varchar](500) NULL,
    [Tx_Status] [varchar](20) NOT NULL,
    [Id_Usuario_Criacao] [int] NOT NULL,
    [Dt_Criacao] [datetime] NOT NULL,
    [Id_Usuario_Alteracao] [int] NULL,
    [Dt_Alteracao] [datetime] NULL,
    CONSTRAINT [PK_RoamingInternacional] PRIMARY KEY CLUSTERED ([Id_Roaming] ASC),
    CONSTRAINT [FK_RoamingInternacional_Usuario] FOREIGN KEY ([Id_Usuario]) REFERENCES [dbo].[Usuario]([Id_Usuario]),
    CONSTRAINT [FK_RoamingInternacional_Pais] FOREIGN KEY ([Id_Pais]) REFERENCES [dbo].[Pais]([Id_Pais])
)
```

**Tabela de Consumo**: `dbo.ConsumoRoaming`
```sql
CREATE TABLE [dbo].[ConsumoRoaming](
    [Id_Consumo] [int] IDENTITY(1,1) NOT NULL,
    [Id_Roaming] [int] NOT NULL,
    [Dt_Consumo] [datetime] NOT NULL,
    [Qn_DadosGB] [decimal](10,2) NOT NULL,
    [Qn_MinutosVoz] [int] NOT NULL,
    [Qn_SMS] [int] NOT NULL,
    [Vr_CustoUSD] [decimal](10,2) NOT NULL,
    CONSTRAINT [PK_ConsumoRoaming] PRIMARY KEY CLUSTERED ([Id_Consumo] ASC),
    CONSTRAINT [FK_ConsumoRoaming_Roaming] FOREIGN KEY ([Id_Roaming]) REFERENCES [dbo].[RoamingInternacional]([Id_Roaming])
)
```

**Campos Importantes**:

| Campo Legado | Descricao | Mapeamento Modernizado |
|--------------|-----------|----------------------|
| `Id_Roaming` | Identificador unico da solicitacao | `Id` (PK) |
| `Id_Usuario` | Usuario que solicitou roaming | `UsuarioSolicitanteId` (FK) |
| `Id_Pais` | Pais de destino | `PaisId` (FK) + `CodigoISO3` |
| `Dt_Inicio` / `Dt_Fim` | Periodo de roaming | `DataInicio` / `DataFim` (DateTime UTC) |
| `Tx_Status` | Status (Pendente, Ativa, Desativa) | `Status` (enum: Solicitada, Aprovada, Ativada, Desativada, etc) |
| `Dt_Criacao` | Quando foi solicitado | `DataCriacao` + `AuditoriaId` |

### 3.2 Stored Procedures Legado

| Procedure | Descricao | Migracao |
|-----------|-----------|----------|
| `sp_AprovaRoaming` | Aprova solicitacao de roaming | Migrado para Commands/Handlers MediatR |
| `sp_DesativaRoaming` | Desativa roaming | Migrado para Background Job .NET 10 |
| `sp_RelatorioConsumoRoaming` | Relatorio de consumo por usuario | Migrado para Query Handler + SSRS/Power BI |
| `sp_SincronizaOperadora` | Busca consumo na operadora | Migrado para Hosted Service com integração assíncrona |

### 3.3 Telas ASPX Legado

| Pagina | Descricao | Tela Moderna (Angular) |
|--------|-----------|----------------------|
| `SolicitarRoaming.aspx` | Formulario de solicitacao | `/mobile/roaming/request` |
| `AprovarRoaming.aspx` | Tela de aprovacao para gestor | `/mobile/roaming/approve` |
| `ConsultarRoaming.aspx` | Consulta de solicitacoes ativas | `/mobile/roaming/list` |
| `RelatorioConsumo.aspx` | Relatorio de consumo internacional | `/reports/international-usage` |

### 3.4 WebServices Legado (VB.NET)

**Arquivo**: `D:\IC2\ic1_legado\WebService\WSRoamingInternacional.asmx.vb`

| Metodo | Descricao | Endpoint Moderno |
|--------|-----------|-----------------|
| `CriaSolicitacao()` | Cria nova solicitacao | `POST /api/roaming-requests` |
| `AprovaRoaming()` | Aprova solicitacao | `PUT /api/roaming-requests/{id}/approve` |
| `RejeitaRoaming()` | Rejeita solicitacao | `PUT /api/roaming-requests/{id}/reject` |
| `ListaSolicitacoes()` | Lista solicitacoes do usuario | `GET /api/roaming-requests` |
| `SincronizaConsumo()` | Busca consumo na operadora (polling) | Substituido por webhook assíncrono |

---

## 4. INTEGRACOES OBRIGATORIAS

### 4.1 Central de Funcionalidades (Feature Flags)

**FeatureKey**: `ROAMING_INTERNACIONAL`

**Configuracao**:
```json
{
    "featureKey": "ROAMING_INTERNACIONAL",
    "nome": "Solicitacao e Aprovacao de Roaming Internacional",
    "descricao": "Permite que usuarios solicitem e gerentes aprovem roaming em paises internacionais com controle de limites",
    "habilitado": true,
    "isSystemFeature": false,
    "modulo": "Mobile"
}
```

**Sub-Features**:
```json
{
    "featureKey": "ROAMING_ALERTAS_CONSUMO",
    "nome": "Alertas de Consumo de Roaming",
    "descricao": "Ativa notificacoes quando usuario atinge 50%, 75%, 90%, 100% do limite",
    "habilitado": true
}
```

**Nota**: Feature flags permitem desabilitar roaming rapidamente em caso de incidente (ex: falha na integracao com operadora).

---

### 4.2 Internacionalizacao (i18n)

**Chaves de Traducao**:

```json
{
    "roaming": {
        "request": {
            "title": "Solicitar Roaming Internacional",
            "form": {
                "pais": "Pais de Destino",
                "dataInicio": "Data de Inicio",
                "dataFim": "Data de Fim",
                "tipoServico": "Tipo de Servico (Dados/Voz/SMS)",
                "justificativa": "Justificativa (opcional)"
            },
            "messages": {
                "success": "Solicitacao enviada com sucesso. Aguarde aprovacao do seu gestor.",
                "error": "Erro ao criar solicitacao. Tente novamente.",
                "limitExceeded": "Voce ja tem {count} roamings ativos. Desative um antes de solicitar novo."
            },
            "validation": {
                "required": "Campo obrigatorio",
                "invalidDate": "Data invalida",
                "dateRange": "Data fim deve ser posterior a data inicio"
            }
        },
        "approval": {
            "title": "Aprovar Solicitacao de Roaming",
            "buttons": {
                "approve": "Aprovar",
                "reject": "Rejeitar"
            },
            "messages": {
                "approveSuccess": "Solicitacao aprovada. Ativando com operadora...",
                "rejectSuccess": "Solicitacao rejeitada."
            }
        },
        "alerts": {
            "limit50": "Atencao: 50% do limite consumido",
            "limit75": "Aviso: 75% do limite consumido",
            "limit90": "Critico: 90% do limite consumido",
            "limit100": "Limite atingido. Roaming sera desativado em 1 hora."
        }
    }
}
```

---

### 4.3 Auditoria

**Operacoes Auditadas**:

| Operacao | Codigo | Dados Registrados |
|----------|--------|-------------------|
| Solicitacao Criada | `ROAMING_REQUEST_CREATE` | UsuarioId, PaisId, DataInicio, DataFim, Justificativa |
| Aprovacao | `ROAMING_REQUEST_APPROVE` | UsuarioId, Status=Aprovada, DataAprovacao, GestorId |
| Rejeicao | `ROAMING_REQUEST_REJECT` | UsuarioId, Status=Rejeitada, Motivo |
| Ativacao | `ROAMING_REQUEST_ACTIVATE` | Status=Ativa, DataAtivacao, ReferenciasOperadora |
| Desativacao | `ROAMING_REQUEST_DEACTIVATE` | Status=Desativada, DataDesativacao, Motivo |
| Consumo Registrado | `ROAMING_CONSUMPTION_LOG` | DadosGB, MinutosVoz, SMS, Custo, DataConsumo |
| Alerta Enviado | `ROAMING_ALERT_SENT` | TipoAlerta (50%, 75%, 90%, 100%), UsuarioId |

**Retencao**: 7 anos (conforme LGPD artigos 7-18). Apos 7 anos, dados sao anonimizados automaticamente.

---

### 4.4 Controle de Acesso (RBAC)

**Permissoes**:

| Permissao | Descricao | Perfis |
|-----------|-----------|--------|
| `roaming:request:create` | Criar solicitacao de roaming | Colaborador, Gerente, Admin |
| `roaming:request:read` | Visualizar solicitacoes proprias | Colaborador, Gerente, Admin |
| `roaming:request:read:all` | Visualizar todas as solicitacoes | Gerente, Admin |
| `roaming:request:approve` | Aprovar solicitacoes | Gerente (gestor direto), Admin |
| `roaming:request:reject` | Rejeitar solicitacoes | Gerente (gestor direto), Admin |
| `roaming:limit:manage` | Configurar limites por pais | Admin |
| `roaming:report:view` | Visualizar relatorios de consumo | Gerente, Admin |
| `roaming:operadora:config` | Configurar integracao com operadora | Admin |

**Nota**: Gestor so pode aprovar/rejeitar solicitacoes de usuarios que lhe reportam. Admin pode aprovar qualquer solicitacao.

---

## 5. ENDPOINTS DA API

### 5.1 CRUD Principal

| Metodo | Endpoint | Descricao | Permissao |
|--------|----------|-----------|-----------|
| GET | `/api/roaming-requests` | Listar solicitacoes do usuario | `roaming:request:read` |
| GET | `/api/roaming-requests?status=active` | Listar solicitacoes ativas | `roaming:request:read` |
| GET | `/api/roaming-requests?manager=true` | Listar solicitacoes a aprovar (gestor) | `roaming:request:approve` |
| GET | `/api/roaming-requests/{id}` | Obter detalhes da solicitacao | `roaming:request:read` |
| POST | `/api/roaming-requests` | Criar nova solicitacao | `roaming:request:create` |
| PUT | `/api/roaming-requests/{id}` | Editar solicitacao (apenas se pendente) | `roaming:request:create` |
| DELETE | `/api/roaming-requests/{id}` | Cancelar solicitacao | `roaming:request:create` |

### 5.2 Operacoes de Aprovacao

| Metodo | Endpoint | Descricao | Permissao |
|--------|----------|-----------|-----------|
| PUT | `/api/roaming-requests/{id}/approve` | Aprovar solicitacao | `roaming:request:approve` |
| PUT | `/api/roaming-requests/{id}/reject` | Rejeitar solicitacao | `roaming:request:approve` |
| GET | `/api/roaming-requests/{id}/audit` | Historico de alteracoes | `roaming:request:read` |

### 5.3 Operacoes de Consumo

| Metodo | Endpoint | Descricao | Permissao |
|--------|----------|-----------|-----------|
| GET | `/api/roaming-requests/{id}/consumption` | Obter consumo atual | `roaming:request:read` |
| GET | `/api/roaming-requests/{id}/consumption/history` | Historico de consumo | `roaming:request:read` |
| POST | `/api/roaming-requests/{id}/sync-operadora` | Sincronizar consumo com operadora | `roaming:request:create` |

### 5.4 Configuracoes e Limites

| Metodo | Endpoint | Descricao | Permissao |
|--------|----------|-----------|-----------|
| GET | `/api/roaming-limits` | Listar limites por pais | `roaming:limit:manage` |
| POST | `/api/roaming-limits` | Criar novo limite | `roaming:limit:manage` |
| PUT | `/api/roaming-limits/{id}` | Atualizar limite | `roaming:limit:manage` |
| DELETE | `/api/roaming-limits/{id}` | Remover limite | `roaming:limit:manage` |

### 5.5 Relatorios

| Metodo | Endpoint | Descricao | Permissao |
|--------|----------|-----------|-----------|
| GET | `/api/roaming-requests/report/consumption` | Relatorio de consumo por usuario | `roaming:report:view` |
| GET | `/api/roaming-requests/report/costs` | Relatorio de custos por pais | `roaming:report:view` |
| GET | `/api/roaming-requests/report/compliance` | Relatorio de conformidade (aprovacoes) | `roaming:report:view` |
| GET | `/api/roaming-requests/export/csv` | Exportar dados em CSV | `roaming:request:read` |

---

## 6. FLUXOS PRINCIPAIS

### 6.1 Fluxo de Solicitacao e Aprovacao

```
Usuario acessa /mobile/roaming/request
    |
    v
Preenche formulario (pais, datas, servico)
    |
    v
Valida limites simultaneos (max 5) ?
    |
    +--- NAO ---> Erro: "5 roamings ativos"
    |
    v (SIM)
Cria solicitacao com Status=Solicitada
    |
    v
Notifica Gestor por Email/Dashboard
    |
    v
Gestor acessa /mobile/roaming/approve
    |
    +--- Aprova ---> Status=Aprovada
    |                  |
    |                  v
    |               Sistema chama API Operadora
    |                  |
    |                  v
    |               Status=Ativada ou Erro_ativacao
    |
    +--- Rejeita ---> Status=RejeitadaParaRevisao
                       |
                       v
                    Usuario recebe notificacao
                       |
                       v (Pode reenviar <= 3x)
                    Corrige e resubmete
```

### 6.2 Fluxo de Monitoramento de Consumo

```
Background Job (a cada 30 min)
    |
    v
Busca roamings ATIVOS na tabela
    |
    v
Para cada roaming:
    |
    +-> Chama API Operadora: GET consumo do MSISDN
    |       |
    |       v
    |    Registra consumo em ConsumoRoaming
    |       |
    |       v
    |    Calcula percentual: consumido / limite
    |       |
    |       +--- > 100% ---> Chama Desativa Roaming
    |       |                    |
    |       |                    v
    |       |                Status=Desativada
    |       |
    |       +--- >= 50% ---> Envia Alerta correspondente
    |       |                (50%, 75%, 90%, 100%)
    |       |
    |       v
    |    Continua proxima iteracao
    |
    v
Job finaliza
```

### 6.3 Fluxo de Desativacao Automatica

```
Background Job (a cada 1 hora)
    |
    v
Busca roamings com DataFim <= Agora
    |
    v
Para cada roaming:
    |
    +-> Chama API Operadora: Desativa Roaming
    |       |
    |       v
    |    Atualiza Status=Desativada
    |       |
    |       v
    |    Envia notificacao ao usuario
    |
    v
Registra auditoria (DataFim atingida)
    |
    v
Job finaliza
```

---

## 7. SEGURANCA

### 7.1 Protecoes Implementadas

| Protecao | Descricao |
|----------|-----------|
| **Validacao de Entrada** | Todas as datas sao validadas (formato, range). Paises sao validados contra lista branca. |
| **SQL Injection** | Queries parametrizadas com Entity Framework Core. Nao ha concatenacao de strings em SQL. |
| **XSS (Cross-Site Scripting)** | Angular sanitiza automaticamente HTML em templates. APIs retornam JSON estruturado. |
| **CSRF Protection** | ASP.NET Core inclui proteccao CSRF automatica com token no header. |
| **Autenticacao** | JWT Bearer token. Sem token, acesso negado com HTTP 401. |
| **Autorizacao** | RBAC com permissoes por acao. Gestor so pode aprovar solicitacoes de subordinados. |
| **Rate Limiting** | Limite de 100 requisicoes/min por usuario para evitar abuso de API. |
| **Encriptacao de Dados Sensveis** | ApiKey da operadora e MSISDN sao encriptados em repouso (AES-256). |
| **Auditoria Imutavel** | Registros de auditoria nao podem ser alterados/deletados. Apenas insert-only. |
| **Direito ao Esquecimento (LGPD)** | Apos 7 anos, dados sao anonimizados. Usuario pode solicitar anonimizacao imediata. |

### 7.2 Testes de Seguranca Obrigatorios

- [ ] SQL Injection: Tentar injetar `'; DROP TABLE RoamingInternacional; --` em campo de pais
- [ ] XSS: Tentar inserir `<script>alert('xss')</script>` em campo de justificativa
- [ ] CSRF: Tentar aprovar solicitacao sem token CSRF valido
- [ ] Autorizacao: Usuário A tenta aprovar solicitacao de Usuário B (nao seu gestor)
- [ ] Rate Limiting: Enviar 200 requisicoes rapidamente, verificar se 401 apos limite
- [ ] Gestor Invalido: Solicitante tenta colocar outra pessoa como seu gestor
- [ ] Data Retroativa: Tenta criar solicitacao com data inicio no passado
- [ ] Limite Negativo: Tenta configurar limite de dados como -5 GB
- [ ] Dispositivo Inativo: Tenta ativar roaming em dispositivo que foi deletado
- [ ] LGPD Direito Esquecimento: Usuario solicita anonimizacao, verifica se dados sao mascarados

---

## 8. METRICAS E INDICADORES

### 8.1 KPIs

| KPI | Meta | Medicao |
|-----|------|---------|
| Tempo Medio Aprovacao | <= 4 horas | (DataAprovacao - DataSolicitacao) / total solicitacoes |
| Taxa Aprovacao | >= 85% | (Aprovadas / Total) * 100 |
| Tempo Ativacao com Operadora | <= 5 minutos | (DataAtivacao - DataAprovacao) |
| Disponibilidade da API | >= 99.5% | Uptime / Total tempo |
| Sincronizacao Consumo | < 1 hora de delay | (DataConsumoReal - DataRegistroSistema) |
| Precisao Alertas | 100% | Alertas enviados / Alertas que deveriam ser enviados |
| Taxa de Bloqueio por Limite | 100% | Roamings desativados ao atingir limite / Total roamings ativos |

### 8.2 Alertas

| Alerta | Condicao | Acao |
|--------|----------|------|
| **Aprovacao Lenta** | Solicitacao pendente > 24 horas | Notificar gestor e escalacionar para seu gestor |
| **Erro Ativacao Operadora** | API retorna erro HTTP 5xx | Retry automático 3x. Se falha, marcar como Erro_Ativacao e notificar admin |
| **Sincronizacao Falha** | Job de sincronismo nao executa por > 2 horas | Enviar alerta para squad de TI |
| **Consumo Excepcional** | Usuario consome 10x media histórica | Notificar gestor + admin + bloquear temporariamente (ate confirmacao) |
| **Limite Ultrapassado** | Consumo >= 100% limite | Desativar imediatamente + notificar usuario |
| **Operadora Indisponivel** | API operadora retorna 503 por > 30 min | Usar dados em cache + alertar admin |
| **Falha Auditoria** | Registro de auditoria falha | Parar operacao + alertar admin (auditoria é crítico) |

---

## 9. PROXIMOS PASSOS

1. **Modelo de Dados**: Criar [MD-RF075](./MD-RF075-Roaming-Internacional.md)
2. **Casos de Uso**: Criar [UC-RF075](./UC-RF075-Roaming-Internacional.md) com 5 UCs (Solicitar, Aprovar, Listar, Consumo, Bloqueio)
3. **Workflow**: Criar [WF-RF075](./WF-RF075-Roaming-Internacional.md) com telas Angular
4. **User Stories**: Criar [user-stories.yaml](./user-stories.yaml) com stories implementáveis
5. **Integração Operadoras**: Documentar contratos SOAP/REST com Vivo, Claro, TIM, Oi
6. **Implementacao Backend**: Commands/Queries/Handlers MediatR para cada UC
7. **Implementacao Frontend**: Componentes Angular para solicitacao, aprovacao, listagem, consumo
8. **Testes Automatizados**: TC-RF075-BACKEND.md, TC-RF075-FRONTEND.md, TC-RF075-E2E.md

---

## CHANGELOG

| Versao | Data | Descricao | Autor |
|--------|------|-----------|-------|
| 1.0 | 2025-12-28 | Versao inicial com 10 regras de negocio, 13 endpoints, 3 fluxos principais | Claude Architect |

---

**Ultima Atualizacao**: 2025-12-28
**Autor**: IControlIT Architect Agent
**Revisao**: Pendente de Aprovacao
