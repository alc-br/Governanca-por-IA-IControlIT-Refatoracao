# RF-075: Roaming Internacional

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC011-INT-Integracoes
**Fase**: Fase 6 - Ativos, Auditoria e Integrações

---

## 1. OBJETIVO DO REQUISITO

Especificar o módulo de gestão de roaming internacional para dispositivos móveis corporativos, permitindo que colaboradores solicitem ativação de roaming em países específicos, gestores aprovem solicitações, e o sistema coordene a ativação junto aos operadores de telecomunicações com controle automatizado de limites de consumo.

Este documento define **o que o sistema deve fazer**, não **como implementar**. Serve como contrato entre negócio, desenvolvimento e testes.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- Solicitação de ativação de roaming internacional por colaboradores
- Workflow de aprovação com gestores (máximo 3 tentativas de rejeição)
- Validação de limites de consumo por país/região
- Integração com APIs de operadoras de telecomunicações (ativação/desativação)
- Monitoramento em tempo real de consumo de dados, voz e SMS
- Sistema de alertas escalonados (50%, 75%, 90%, 100% do limite)
- Bloqueio automático ao atingir limite de consumo ou data de término
- Gestão de limites configuráveis por país, região e perfil de gasto
- Relatórios de consumo e custos internacionais
- Auditoria completa de todas as operações (conformidade LGPD)
- Notificações em tempo real (email + dashboard)
- Retenção de dados por 7 anos com anonimização automática

### 2.2 Fora do escopo (não objetivos)

- Design visual específico das telas (interface definida no WF-RF075)
- Tecnologia de implementação (backend/frontend)
- Estratégia de deploy ou infraestrutura
- Negociação de contratos com operadoras
- Gestão de planos de telefonia móvel (RF separado)
- Gestão de inventário de dispositivos móveis (RF separado)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| Roaming Internacional | Capacidade de usar serviços de telefonia móvel (dados, voz, SMS) em países diferentes do país de origem |
| Solicitação de Roaming | Pedido formal para ativar roaming em país/região específica, com período determinado |
| Aprovação em Cascata | Workflow onde solicitação passa por: Validação Automática → Aprovação de Gestor → Ativação com Operadora |
| Limite de Consumo | Quantidade máxima de dados (GB), minutos de voz ou SMS permitida por período em uma região |
| Alerta de Consumo | Notificação automática enviada ao atingir 50%, 75%, 90% ou 100% do limite |
| Bloqueio Automático | Desativação automática de roaming ao atingir 100% do limite ou data de término |
| MSISDN | Mobile Station International Subscriber Directory Number (número do SIM card) |
| Operadora | Empresa de telecomunicações que fornece o serviço de roaming (Vivo, Claro, TIM, Oi) |

---

## 4. FUNCIONALIDADES COBERTAS

1. Solicitação de roaming internacional com país, período e tipo de serviço
2. Aprovação/rejeição de solicitações por gestores
3. Validação de limites de roaming simultâneos por usuário (máximo 5)
4. Integração com APIs de operadoras para ativação/desativação
5. Monitoramento contínuo de consumo (dados, voz, SMS)
6. Envio de alertas escalonados de consumo
7. Bloqueio automático por limite ou data de término
8. Configuração de limites por país, região e perfil
9. Geração de relatórios de consumo e custos
10. Auditoria de todas as operações
11. Notificações em tempo real

---

## 5. REGRAS DE NEGÓCIO

### RN-RF075-01 — Solicitação Requer Aprovação de Gestor

**Descrição**: Toda solicitação de roaming deve ser explicitamente aprovada pelo gestor direto do solicitante antes de ser ativada com a operadora.

**Justificativa**: Conformidade com política de controle de custos. Garante que decisões de gastos internacionais são tomadas com ciência do gestor responsável pelo orçamento.

**Critério de Aceite**:
- Solicitante não pode ser gestor de si mesmo → rejeição
- Data fim deve ser >= data início → rejeição
- Data início não pode ser retroativa → rejeição
- Solicitação sem gestor informado → rejeição

---

### RN-RF075-02 — Limite de Consumo por País é Inviolável

**Descrição**: Nenhum dispositivo pode consumir mais dados, minutos ou SMS do que o limite estabelecido para aquele país. Se limite é atingido, roaming é desativado imediatamente.

**Justificativa**: Proteção contra custos inesperados. Operadores cobram altas taxas por dados/voz internacional. Sem limite automático, empresa fica exposta a faturas elevadas.

**Critério de Aceite**:
- Consumo >= 100% do limite → desativação automática imediata
- Usuário é notificado da desativação
- Auditoria registra motivo: "Limite atingido"

---

### RN-RF075-03 — Alertas de Consumo em Cascata (50%, 75%, 90%, 100%)

**Descrição**: Sistema envia alertas automáticos ao usuário quando consumo atinge 50%, 75%, 90% e 100% do limite.

**Justificativa**: Transparência e prevenção. Usuário precisa ser notificado ANTES de atingir limite total, para que possa tomar ações (reduzir uso, solicitar extensão).

**Critério de Aceite**:
- Alerta não pode ser enviado mais de uma vez para o mesmo limiar
- Alertas são enviados via email + dashboard
- Alerta de 100% indica "Roaming será desativado"

---

### RN-RF075-04 — Roaming Desativa Automaticamente na Data de Término

**Descrição**: Roaming é desativado automaticamente no dia/hora de término especificada na solicitação, independente de quantos dados foram consumidos.

**Justificativa**: Controle de tempo. Roaming é aprovado para período específico. Não é permitido extensão automática. Se usuário precisa mais tempo, deve solicitar nova aprovação.

**Critério de Aceite**:
- Data de término atingida → desativação automática (job executa a cada hora)
- Usuário é notificado da desativação
- Status muda para "Desativada"

---

### RN-RF075-05 — Rejeição com Limite de 3 Tentativas

**Descrição**: Se gestor rejeita solicitação, solicitante pode corrigir e reenviar. Após 3 rejeições, solicitação é cancelada e requer nova solicitação.

**Justificativa**: Permite correção de erros, mas evita ciclos infinitos. Após 3 rejeições, assume-se que a solicitação não pode ser aprovada.

**Critério de Aceite**:
- Rejeição 1x ou 2x → Status = "RejeitadaParaRevisao"
- Rejeição 3x → Status = "Cancelada", requer nova solicitação
- Usuário é notificado da quantidade de tentativas restantes

---

### RN-RF075-06 — Integração com Operadora Requer Dados Válidos

**Descrição**: Antes de chamar API da operadora, sistema valida que dispositivo existe, tem plano ativo, e operadora tem integração configurada.

**Justificativa**: Falhas na integração causam incidentes críticos. Validação prévia reduz falhas.

**Critério de Aceite**:
- Dispositivo não ativo → rejeição
- Plano vencido → rejeição
- Operadora sem integração configurada → rejeição
- Validação passa → chamada à API da operadora

---

### RN-RF075-07 — Auditoria de Todas as Ações

**Descrição**: Cada ação no ciclo de vida da solicitação (solicitação, aprovação, rejeição, ativação, desativação, consumo) é registrada em tabela de auditoria com usuário, timestamp, ação, dados antes/depois.

**Justificativa**: Conformidade LGPD e rastreabilidade. Auditoria é usada para investigação de incidentes, prova de conformidade, e direito ao esquecimento.

**Critério de Aceite**:
- Todas as operações geram registro de auditoria
- Auditoria é imutável (insert-only)
- Dados antes/depois são serializados em JSON

---

### RN-RF075-08 — Notificações em Tempo Real

**Descrição**: Sistema envia notificações automáticas via email e dashboard quando: solicitação criada, aprovada, rejeitada, ativada, desativada, limite atingido.

**Justificativa**: Transparência e rapidez. Usuários precisam saber o status da solicitação imediatamente.

**Critério de Aceite**:
- Notificação por email enviada
- Notificação no dashboard (WebSocket)
- Mensagem clara sobre o evento

---

### RN-RF075-09 — Limite de Roaming Ativo por Usuário (Máximo 5)

**Descrição**: Usuário não pode ter mais de 5 roamings ativos simultaneamente.

**Justificativa**: Controle de uso corporativo. Roaming é para dispositivo do usuário, não para múltiplos dispositivos.

**Critério de Aceite**:
- Usuário com 5 roamings ativos → rejeição de nova solicitação
- Mensagem clara: "Você já tem 5 roamings ativos. Desative um antes de solicitar novo."

---

### RN-RF075-10 — Retenção de Dados Conforme LGPD (7 Anos)

**Descrição**: Todos os dados de roaming (solicitações, consumo, auditoria) são retidos por 7 anos. Após 7 anos, usuário pode solicitar direito ao esquecimento e dados são anonimizados.

**Justificativa**: Conformidade LGPD artigos 16-18. Empresa precisa manter dados para investigação e compliance. Após 7 anos, dados são anonimizados.

**Critério de Aceite**:
- Dados com mais de 7 anos → anonimização automática
- Usuário pode solicitar anonimização imediata (após 7 anos)
- Dados anonimizados: nome, email, ID substituídos por "[ANONIMIZADO]"

---

### RN-RF075-11 — Multi-Tenancy: Isolamento por Conglomerado

**Descrição**: Todas as solicitações, limites e consumos são isolados por conglomerado (tenant). Usuário só pode acessar dados do seu conglomerado.

**Justificativa**: Segurança e isolamento de dados. Conformidade com arquitetura multi-tenant do IControlIT.

**Critério de Aceite**:
- Todas as queries filtram por Id_Conglomerado
- Tentativa de acesso cruzado → HTTP 403
- Auditoria registra tentativas de violação

---

### RN-RF075-12 — Validação de País na Lista Branca

**Descrição**: Roaming só pode ser solicitado para países configurados na lista branca (tabela Pais com Fl_PermiteRoaming = true).

**Justificativa**: Controle de destinos permitidos. Alguns países podem ter restrições políticas ou custos proibitivos.

**Critério de Aceite**:
- País não configurado → rejeição
- Mensagem: "Roaming não permitido para este país. Contate administrador."

---

### RN-RF075-13 — Sincronização de Consumo a Cada 30 Minutos

**Descrição**: Background job sincroniza consumo com API da operadora a cada 30 minutos para roamings ativos.

**Justificativa**: Monitoramento em tempo quase real. Permite detecção rápida de consumo excessivo.

**Critério de Aceite**:
- Job executa a cada 30 minutos
- Apenas roamings com Status = "Ativa" são sincronizados
- Falha na sincronização → retry 3x, depois alerta admin

---

### RN-RF075-14 — Permissões RBAC por Operação

**Descrição**: Cada operação requer permissão específica. Gestor só pode aprovar solicitações de subordinados diretos.

**Justificativa**: Controle de acesso. Apenas pessoas autorizadas podem executar operações críticas.

**Critério de Aceite**:
- Operação sem permissão → HTTP 403
- Gestor não autorizado (não é gestor direto) → HTTP 403
- Admin pode aprovar qualquer solicitação

---

### RN-RF075-15 — Criptografia de Dados Sensíveis

**Descrição**: ApiKey da operadora e MSISDN são criptografados em repouso (AES-256).

**Justificativa**: Segurança de dados sensíveis. ApiKey pode dar acesso a operações críticas na operadora.

**Critério de Aceite**:
- Dados armazenados criptografados no banco
- Decriptografia apenas no momento de uso
- Chave de criptografia em Key Vault (não no código)

---

## 6. ESTADOS DA ENTIDADE

| Estado | Descrição |
|--------|-----------|
| Solicitada | Criada, aguardando aprovação do gestor |
| Aprovada | Aprovada pelo gestor, aguardando ativação |
| Ativada | Roaming ativo, consumo sendo monitorado |
| RejeitadaParaRevisao | Rejeitada, pode ser corrigida e reenviada |
| Cancelada | Cancelada após 3 rejeições ou por usuário |
| Desativada | Desativada (limite atingido ou data término) |
| ErroAtivacao | Erro ao ativar com operadora |

### Transições Permitidas

| De | Para |
|----|------|
| Solicitada | Aprovada, RejeitadaParaRevisao, Cancelada |
| Aprovada | Ativada, ErroAtivacao |
| Ativada | Desativada |
| RejeitadaParaRevisao | Aprovada, Cancelada (após 3x) |
| ErroAtivacao | Aprovada (retry manual) |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando Ocorre |
|--------|---------------|
| RoamingSolicitado | Após criação da solicitação |
| RoamingAprovado | Após aprovação pelo gestor |
| RoamingRejeitado | Após rejeição pelo gestor |
| RoamingAtivado | Após ativação bem-sucedida com operadora |
| RoamingDesativado | Após desativação (limite ou data) |
| ConsumoRegistrado | Após sincronização de consumo |
| AlertaEnviado | Ao atingir limiar de alerta |
| LimiteAtingido | Ao atingir 100% do limite |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento multi-tenant
- Nenhuma regra de negócio pode ser ignorada
- Todas as operações devem ser auditadas
- Erros devem ser estruturados e rastreáveis
- Notificações devem ser enviadas em tempo real
- Limites de consumo são invioláveis
- Dados sensíveis devem ser criptografados
- Retenção LGPD de 7 anos deve ser respeitada

---

## 9. SEGURANÇA

- Validação de entrada obrigatória (país, datas, limites)
- Proteção contra SQL Injection (queries parametrizadas)
- Proteção contra XSS (sanitização automática Angular)
- Proteção contra CSRF (token no header)
- Autenticação JWT Bearer obrigatória
- Autorização RBAC por operação
- Rate Limiting: 100 requisições/min por usuário
- Criptografia de dados sensíveis (AES-256)
- Auditoria imutável (insert-only)
- Direito ao esquecimento (LGPD)

---

## 10. INTEGRAÇÕES OBRIGATÓRIAS

### 10.1 Central de Funcionalidades

**Feature Key**: `ROAMING_INTERNACIONAL`

Permite desabilitar roaming rapidamente em caso de incidente (ex: falha na integração com operadora).

**Sub-Features**:
- `ROAMING_ALERTAS_CONSUMO`: Ativa notificações quando usuário atinge 50%, 75%, 90%, 100% do limite

### 10.2 Internacionalização (i18n)

Todas as mensagens de interface devem ter chaves de tradução para pt-BR, en-US, es-ES:
- `roaming.request.title`: "Solicitar Roaming Internacional"
- `roaming.approval.title`: "Aprovar Solicitação de Roaming"
- `roaming.alerts.limit50`: "Atenção: 50% do limite consumido"
- `roaming.messages.success`: "Solicitação enviada com sucesso"
- `roaming.validation.required`: "Campo obrigatório"

### 10.3 Auditoria

Todas as operações devem ser auditadas:
- `ROAMING_REQUEST_CREATE`: Solicitação criada
- `ROAMING_REQUEST_APPROVE`: Aprovação
- `ROAMING_REQUEST_REJECT`: Rejeição
- `ROAMING_REQUEST_ACTIVATE`: Ativação
- `ROAMING_REQUEST_DEACTIVATE`: Desativação
- `ROAMING_CONSUMPTION_LOG`: Consumo registrado
- `ROAMING_ALERT_SENT`: Alerta enviado

### 10.4 Controle de Acesso (RBAC)

Permissões obrigatórias:
- `roaming:request:create`: Criar solicitação
- `roaming:request:read`: Visualizar solicitações próprias
- `roaming:request:read:all`: Visualizar todas as solicitações
- `roaming:request:approve`: Aprovar solicitações
- `roaming:request:reject`: Rejeitar solicitações
- `roaming:limit:manage`: Configurar limites por país
- `roaming:report:view`: Visualizar relatórios de consumo
- `roaming:operadora:config`: Configurar integração com operadora

---

## 11. ARTEFATOS DERIVADOS

Este RF é base para:

- UC-RF075.md (Casos de Uso)
- MD-RF075.yaml (Modelo de Dados)
- WF-RF075.md (Wireframes e Fluxos)
- TC-RF075.yaml (Casos de Teste)
- MT-RF075.yaml (Massas de Teste)

---

## 12. RASTREABILIDADE

| Artefato | Status |
|----------|--------|
| RF-075.md | Completo |
| RF-075.yaml | Obrigatório |
| RL-RF075.md | Obrigatório |
| RL-RF075.yaml | Obrigatório |
| UC-RF075.md | Pendente |
| MD-RF075.yaml | Pendente |
| WF-RF075.md | Pendente |
| TC-RF075.yaml | Pendente |
| MT-RF075.yaml | Pendente |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0: separação RF/RL, 15 RNs, 11 seções canônicas | Agência ALC - alc.dev.br |
| 1.0 | 2025-12-28 | Versão inicial com 10 regras de negócio, 13 endpoints, 3 fluxos principais | Claude Architect |

---

**Última Atualização**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**Revisão**: Aprovado
