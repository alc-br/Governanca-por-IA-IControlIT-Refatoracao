# =============================================
# RF-075 - Roaming Internacional (Contrato Canônico)
# Versão: 2.0
# Data: 2025-12-30
# Autor: Agência ALC - alc.dev.br
# =============================================

rf:
  id: "RF075"
  nome: "Roaming Internacional"
  versao: "2.0"
  data: "2025-12-30"
  fase: "Fase 6 - Ativos, Auditoria e Integrações"
  epic: "EPIC011-INT-Integracoes"
  status: "aprovado"  # draft | aprovado | em_desenvolvimento | concluido

descricao:
  objetivo: |
    Especificar o módulo de gestão de roaming internacional para dispositivos móveis corporativos,
    permitindo que colaboradores solicitem ativação de roaming em países específicos, gestores aprovem
    solicitações, e o sistema coordene a ativação junto aos operadores de telecomunicações com controle
    automatizado de limites de consumo.

  problema_resolvido: |
    Controlar gastos com roaming internacional, garantir aprovação gerencial de solicitações,
    monitorar consumo em tempo real, evitar custos inesperados com bloqueio automático,
    e manter conformidade LGPD com auditoria completa.

  publico_afetado: |
    Colaboradores que viajam internacionalmente, gestores que aprovam solicitações,
    administradores que configuram limites, operadoras de telecomunicações integradas.

escopo:
  incluso:
    - "Solicitação de ativação de roaming internacional"
    - "Workflow de aprovação com gestores (máximo 3 tentativas)"
    - "Validação de limites de consumo por país/região"
    - "Integração com APIs de operadoras (ativação/desativação)"
    - "Monitoramento em tempo real de consumo (dados, voz, SMS)"
    - "Sistema de alertas escalonados (50%, 75%, 90%, 100%)"
    - "Bloqueio automático por limite ou data de término"
    - "Configuração de limites por país, região e perfil"
    - "Relatórios de consumo e custos internacionais"
    - "Auditoria completa (conformidade LGPD)"
    - "Notificações em tempo real (email + dashboard)"
    - "Retenção de dados por 7 anos com anonimização"

  fora:
    - "Design visual específico das telas"
    - "Tecnologia de implementação (backend/frontend)"
    - "Estratégia de deploy ou infraestrutura"
    - "Negociação de contratos com operadoras"
    - "Gestão de planos de telefonia móvel"
    - "Gestão de inventário de dispositivos móveis"

entidades:
  - nome: "SolicitacaoRoaming"
    descricao: "Solicitação de ativação de roaming internacional"
    multi_tenant: true
    soft_delete: true
    auditoria: true
    campos_principais:
      - "Id_Fornecedor"
      - "Id_Usuario_Solicitante"
      - "Id_Gestor"
      - "Id_Pais"
      - "Data_Inicio"
      - "Data_Fim"
      - "Status"
      - "Tentativas_Rejeitadas"

  - nome: "ConsumoRoaming"
    descricao: "Registro de consumo de dados, voz e SMS"
    multi_tenant: true
    soft_delete: false
    auditoria: true
    campos_principais:
      - "Id_Solicitacao_Roaming"
      - "Data_Consumo"
      - "Dados_GB"
      - "Minutos_Voz"
      - "Quantidade_SMS"
      - "Custo_USD"

  - nome: "LimiteRoaming"
    descricao: "Limites de consumo por país/região"
    multi_tenant: true
    soft_delete: true
    auditoria: true
    campos_principais:
      - "Id_Pais"
      - "Limite_Dados_GB"
      - "Limite_Minutos_Voz"
      - "Limite_SMS"
      - "Perfil_Gasto"

regras_negocio:
  - id: "RN-RF075-01"
    descricao: "Solicitação Requer Aprovação de Gestor"
    tipo: "validacao"
    campos_afetados: ["Id_Gestor", "Id_Usuario_Solicitante", "Data_Inicio", "Data_Fim"]
    obrigatorio: true
    criterio_aceite:
      - "Solicitante não pode ser gestor de si mesmo → rejeição"
      - "Data fim >= data início → rejeição se violado"
      - "Data início não pode ser retroativa → rejeição"
      - "Gestor obrigatório → rejeição se ausente"

  - id: "RN-RF075-02"
    descricao: "Limite de Consumo por País é Inviolável"
    tipo: "regra_negocio"
    campos_afetados: ["Dados_GB", "Limite_Dados_GB"]
    obrigatorio: true
    criterio_aceite:
      - "Consumo >= 100% do limite → desativação automática imediata"
      - "Usuário é notificado da desativação"
      - "Auditoria registra motivo: 'Limite atingido'"

  - id: "RN-RF075-03"
    descricao: "Alertas de Consumo em Cascata (50%, 75%, 90%, 100%)"
    tipo: "regra_negocio"
    campos_afetados: ["Dados_GB", "Ultimo_Limiar_Alertado"]
    obrigatorio: true
    criterio_aceite:
      - "Alerta não pode ser enviado mais de uma vez para o mesmo limiar"
      - "Alertas via email + dashboard"
      - "Alerta de 100% indica 'Roaming será desativado'"

  - id: "RN-RF075-04"
    descricao: "Roaming Desativa Automaticamente na Data de Término"
    tipo: "regra_negocio"
    campos_afetados: ["Data_Fim", "Status"]
    obrigatorio: true
    criterio_aceite:
      - "Data término atingida → desativação automática (job a cada hora)"
      - "Usuário notificado da desativação"
      - "Status muda para 'Desativada'"

  - id: "RN-RF075-05"
    descricao: "Rejeição com Limite de 3 Tentativas"
    tipo: "regra_negocio"
    campos_afetados: ["Tentativas_Rejeitadas", "Status"]
    obrigatorio: true
    criterio_aceite:
      - "Rejeição 1x ou 2x → Status = 'RejeitadaParaRevisao'"
      - "Rejeição 3x → Status = 'Cancelada'"
      - "Usuário notificado das tentativas restantes"

  - id: "RN-RF075-06"
    descricao: "Integração com Operadora Requer Dados Válidos"
    tipo: "validacao"
    campos_afetados: ["Id_Dispositivo", "Id_Operadora"]
    obrigatorio: true
    criterio_aceite:
      - "Dispositivo não ativo → rejeição"
      - "Plano vencido → rejeição"
      - "Operadora sem integração → rejeição"

  - id: "RN-RF075-07"
    descricao: "Auditoria de Todas as Ações"
    tipo: "seguranca"
    campos_afetados: ["todas_operacoes"]
    obrigatorio: true
    criterio_aceite:
      - "Todas as operações geram registro de auditoria"
      - "Auditoria imutável (insert-only)"
      - "Dados antes/depois em JSON"

  - id: "RN-RF075-08"
    descricao: "Notificações em Tempo Real"
    tipo: "regra_negocio"
    campos_afetados: ["Status"]
    obrigatorio: true
    criterio_aceite:
      - "Notificação por email enviada"
      - "Notificação no dashboard (WebSocket)"
      - "Mensagem clara sobre o evento"

  - id: "RN-RF075-09"
    descricao: "Limite de Roaming Ativo por Usuário (Máximo 5)"
    tipo: "validacao"
    campos_afetados: ["Id_Usuario_Solicitante", "Status"]
    obrigatorio: true
    criterio_aceite:
      - "Usuário com 5 roamings ativos → rejeição de nova solicitação"
      - "Mensagem clara informando o limite"

  - id: "RN-RF075-10"
    descricao: "Retenção de Dados Conforme LGPD (7 Anos)"
    tipo: "seguranca"
    campos_afetados: ["Data_Criacao", "Fl_Anonimizado"]
    obrigatorio: true
    criterio_aceite:
      - "Dados > 7 anos → anonimização automática"
      - "Usuário pode solicitar anonimização imediata"
      - "Dados anonimizados: nome, email, ID → '[ANONIMIZADO]'"

  - id: "RN-RF075-11"
    descricao: "Multi-Tenancy: Isolamento por Fornecedor"
    tipo: "seguranca"
    campos_afetados: ["Id_Fornecedor"]
    obrigatorio: true
    criterio_aceite:
      - "Todas as queries filtram por Id_Fornecedor"
      - "Acesso cruzado → HTTP 403"
      - "Auditoria registra violações"

  - id: "RN-RF075-12"
    descricao: "Validação de País na Lista Branca"
    tipo: "validacao"
    campos_afetados: ["Id_Pais"]
    obrigatorio: true
    criterio_aceite:
      - "País não configurado → rejeição"
      - "Mensagem: 'Roaming não permitido para este país'"

  - id: "RN-RF075-13"
    descricao: "Sincronização de Consumo a Cada 30 Minutos"
    tipo: "regra_negocio"
    campos_afetados: ["Data_Ultima_Sincronizacao"]
    obrigatorio: true
    criterio_aceite:
      - "Job executa a cada 30 minutos"
      - "Apenas roamings com Status = 'Ativa'"
      - "Falha → retry 3x, depois alerta admin"

  - id: "RN-RF075-14"
    descricao: "Permissões RBAC por Operação"
    tipo: "seguranca"
    campos_afetados: ["permissoes"]
    obrigatorio: true
    criterio_aceite:
      - "Operação sem permissão → HTTP 403"
      - "Gestor não autorizado → HTTP 403"
      - "Admin pode aprovar qualquer solicitação"

  - id: "RN-RF075-15"
    descricao: "Criptografia de Dados Sensíveis"
    tipo: "seguranca"
    campos_afetados: ["Api_Key_Operadora", "MSISDN"]
    obrigatorio: true
    criterio_aceite:
      - "Dados armazenados criptografados (AES-256)"
      - "Decriptografia apenas no uso"
      - "Chave em Key Vault (não no código)"

estados:
  - id: "Solicitada"
    descricao: "Criada, aguardando aprovação do gestor"
  - id: "Aprovada"
    descricao: "Aprovada pelo gestor, aguardando ativação"
  - id: "Ativada"
    descricao: "Roaming ativo, consumo sendo monitorado"
  - id: "RejeitadaParaRevisao"
    descricao: "Rejeitada, pode ser corrigida e reenviada"
  - id: "Cancelada"
    descricao: "Cancelada após 3 rejeições ou por usuário"
  - id: "Desativada"
    descricao: "Desativada (limite atingido ou data término)"
  - id: "ErroAtivacao"
    descricao: "Erro ao ativar com operadora"

transicoes:
  permitidas:
    - de: "Solicitada"
      para: "Aprovada"
    - de: "Solicitada"
      para: "RejeitadaParaRevisao"
    - de: "Solicitada"
      para: "Cancelada"
    - de: "Aprovada"
      para: "Ativada"
    - de: "Aprovada"
      para: "ErroAtivacao"
    - de: "Ativada"
      para: "Desativada"
    - de: "RejeitadaParaRevisao"
      para: "Aprovada"
    - de: "RejeitadaParaRevisao"
      para: "Cancelada"
    - de: "ErroAtivacao"
      para: "Aprovada"

  proibidas:
    - de: "Cancelada"
      para: "qualquer_estado"
    - de: "Desativada"
      para: "Ativada"

eventos_dominio:
  - evento: "RoamingSolicitado"
    quando: "Após criação da solicitação"
  - evento: "RoamingAprovado"
    quando: "Após aprovação pelo gestor"
  - evento: "RoamingRejeitado"
    quando: "Após rejeição pelo gestor"
  - evento: "RoamingAtivado"
    quando: "Após ativação bem-sucedida com operadora"
  - evento: "RoamingDesativado"
    quando: "Após desativação (limite ou data)"
  - evento: "ConsumoRegistrado"
    quando: "Após sincronização de consumo"
  - evento: "AlertaEnviado"
    quando: "Ao atingir limiar de alerta"
  - evento: "LimiteAtingido"
    quando: "Ao atingir 100% do limite"

permissoes:
  - codigo: "roaming:request:create"
    descricao: "Criar solicitação de roaming"
  - codigo: "roaming:request:read"
    descricao: "Visualizar solicitações próprias"
  - codigo: "roaming:request:read:all"
    descricao: "Visualizar todas as solicitações"
  - codigo: "roaming:request:approve"
    descricao: "Aprovar solicitações (gestor direto)"
  - codigo: "roaming:request:reject"
    descricao: "Rejeitar solicitações"
  - codigo: "roaming:limit:manage"
    descricao: "Configurar limites por país"
  - codigo: "roaming:report:view"
    descricao: "Visualizar relatórios de consumo"
  - codigo: "roaming:operadora:config"
    descricao: "Configurar integração com operadora"

integracoes:
  internas:
    - "Central de Funcionalidades (Feature Flags)"
    - "Multi-Tenancy (Isolamento por Fornecedor)"
    - "Auditoria (7 anos LGPD)"
    - "Internacionalização (i18n)"
    - "Notificações (Email + WebSocket)"

  externas:
    - sistema: "Vivo API"
      tipo: "REST"
      obrigatoria: false
      descricao: "Ativação/desativação de roaming"
    - sistema: "Claro API"
      tipo: "REST"
      obrigatoria: false
      descricao: "Ativação/desativação de roaming"
    - sistema: "TIM API"
      tipo: "REST"
      obrigatoria: false
      descricao: "Ativação/desativação de roaming"
    - sistema: "Oi API"
      tipo: "REST"
      obrigatoria: false
      descricao: "Ativação/desativação de roaming"

seguranca:
  isolamento_tenant: true
  auditoria_obrigatoria: true
  soft_delete: true
  criptografia_dados_sensiveis: true
  protecoes:
    - "SQL Injection: queries parametrizadas"
    - "XSS: sanitização automática Angular"
    - "CSRF: token no header"
    - "Autenticação JWT Bearer obrigatória"
    - "Rate Limiting: 100 req/min por usuário"
    - "Auditoria imutável (insert-only)"
    - "Direito ao esquecimento (LGPD)"

rastreabilidade:
  ucs_esperados:
    - "UC00-listar-solicitacoes-roaming"
    - "UC01-criar-solicitacao-roaming"
    - "UC02-visualizar-solicitacao-roaming"
    - "UC03-aprovar-rejeitar-solicitacao"
    - "UC04-monitorar-consumo-roaming"

  artefatos_derivados:
    - "UC-RF075.md (Casos de Uso)"
    - "MD-RF075.yaml (Modelo de Dados)"
    - "WF-RF075.md (Wireframes e Fluxos)"
    - "TC-RF075.yaml (Casos de Teste)"
    - "MT-RF075.yaml (Massas de Teste)"

catalog:
  crud:
    - id: "RF-CRUD-01"
      title: "Criar solicitação de roaming"
      required: true
    - id: "RF-CRUD-02"
      title: "Listar solicitações de roaming"
      required: true
    - id: "RF-CRUD-03"
      title: "Visualizar solicitação de roaming"
      required: true
    - id: "RF-CRUD-04"
      title: "Atualizar solicitação de roaming (apenas se pendente)"
      required: true
    - id: "RF-CRUD-05"
      title: "Cancelar solicitação de roaming"
      required: true

  validacoes:
    - id: "RF-VAL-01"
      title: "Validar campos obrigatórios (gestor, país, datas)"
      required: true
    - id: "RF-VAL-02"
      title: "Validar limite de 5 roamings ativos por usuário"
      required: true
    - id: "RF-VAL-03"
      title: "Validar país na lista branca"
      required: true
    - id: "RF-VAL-04"
      title: "Validar dispositivo ativo e plano válido"
      required: true

  seguranca:
    - id: "RF-SEC-01"
      title: "Isolamento de tenant (Id_Fornecedor)"
      required: true
    - id: "RF-SEC-02"
      title: "Permissões RBAC por operação"
      required: true
    - id: "RF-SEC-03"
      title: "Auditoria de todas as operações"
      required: true
    - id: "RF-SEC-04"
      title: "Criptografia de dados sensíveis (AES-256)"
      required: true

  workflows:
    - id: "RF-WF-01"
      title: "Workflow de aprovação (gestor direto)"
      required: true
    - id: "RF-WF-02"
      title: "Workflow de ativação com operadora"
      required: true
    - id: "RF-WF-03"
      title: "Workflow de monitoramento de consumo (job 30 min)"
      required: true
    - id: "RF-WF-04"
      title: "Workflow de desativação automática (limite ou data)"
      required: true
    - id: "RF-WF-05"
      title: "Workflow de alertas escalonados (50%, 75%, 90%, 100%)"
      required: true

exclusions:
  rf_items: []

historico:
  - versao: "2.0"
    data: "2025-12-30"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Migração v1.0 → v2.0: separação RF/RL, 15 RNs, 11 seções canônicas, estrutura YAML sincronizada"

  - versao: "1.0"
    data: "2025-12-28"
    autor: "Claude Architect"
    descricao: "Versão inicial com 10 regras de negócio, 13 endpoints, 3 fluxos principais"
