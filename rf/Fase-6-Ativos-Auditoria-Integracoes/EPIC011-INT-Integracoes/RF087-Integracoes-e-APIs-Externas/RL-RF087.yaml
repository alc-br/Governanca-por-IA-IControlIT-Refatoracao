# RL-RF087 - Referência ao Legado (Gestão de Integrações)
# Versão: 2.0
# Data: 2025-12-31
# Autor: Agência ALC - alc.dev.br

rf_id: RF087
titulo: "Gestão de Integrações e APIs Externas"
versao_governanca: "2.0"
data_migracao: "2025-12-31"

legado:
  sistema: "IControlIT v1 (ASP.NET Web Forms + VB.NET)"
  versao: "1.0"
  arquitetura: "Monolítica WebForms"
  banco_dados: "SQL Server (múltiplas instâncias por cliente)"
  multi_tenant: false  # Bancos separados por cliente
  auditoria: "partial"  # Auditoria parcial sem padrão consistente

# ==============================================================================
# REFERÊNCIAS AO LEGADO COM DESTINO OBRIGATÓRIO
# ==============================================================================

referencias:
  # ----------------------------------------------------------------------------
  # INTEGRAÇÕES HARDCODED (VB.NET)
  # ----------------------------------------------------------------------------
  - id: "LEG-RF087-001"
    tipo: "componente"
    nome: "IntegracaoERP.vb"
    caminho: "ic1_legado/IControlIT/Classes/IntegracaoERP.vb"
    descricao: |
      Classe VB.NET para integração hardcoded com ERP externo via XML.
      Timeout fixo de 30 segundos.
      Retry manual de 3 tentativas com delay de 1 segundo.
      Credenciais hardcoded ou em Web.config (texto plano).
      Sem Circuit Breaker ou Rate Limiting.
    destino: "substituido"
    justificativa: |
      Será substituído por configuração dinâmica no módulo de Gestão de Integrações.
      Permite configurar sem deploy de código.
      Adiciona resiliência (Circuit Breaker, Retry inteligente).
    rf_item_relacionado: "RN-RF087-001, RN-RF087-005, RN-RF087-008"
    uc_relacionado: "UC01-criar-integracao"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF087-002"
    tipo: "componente"
    nome: "EmailService.vb"
    caminho: "ic1_legado/IControlIT/Classes/EmailService.vb"
    descricao: |
      Serviço de envio de emails via SMTP (Gmail/Outlook).
      Configurações hardcoded (servidor, porta, credenciais).
      Sem suporte a múltiplos provedores.
    destino: "substituido"
    justificativa: |
      Será substituído por integração configurável do tipo SMTP no RF-087.
      Permitirá trocar provedor sem alterar código.
    rf_item_relacionado: "RN-RF087-002, RN-RF087-003"
    uc_relacionado: "UC01-criar-integracao"
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: 2

  - id: "LEG-RF087-003"
    tipo: "webservice"
    nome: "ImportacaoUsuarios.asmx"
    caminho: "ic1_legado/IControlIT/WebServices/ImportacaoUsuarios.asmx"
    descricao: |
      WebService para importação manual de usuários do Active Directory via LDAP.
      Conexão LDAP hardcoded.
      Sem interface administrativa para configurar.
    destino: "substituido"
    justificativa: |
      Será substituído por integração do tipo LDAP configurável.
      Permite conectar a múltiplos Active Directories sem código.
    rf_item_relacionado: "RN-RF087-002, RN-RF087-011"
    uc_relacionado: "UC01-criar-integracao"
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: 2

  # ----------------------------------------------------------------------------
  # CONFIGURAÇÕES E CREDENCIAIS
  # ----------------------------------------------------------------------------
  - id: "LEG-RF087-004"
    tipo: "componente"
    nome: "Web.config (Credenciais de APIs)"
    caminho: "ic1_legado/IControlIT/Web.config"
    descricao: |
      Credenciais de APIs externas armazenadas em texto plano no Web.config.
      Seções: <appSettings> e <connectionStrings>.
      Vulnerabilidade crítica de segurança.
    destino: "substituido"
    justificativa: |
      Será substituído por campo CredenciaisJson criptografado na tabela Integracao.
      Criptografia AES-256 antes de salvar no banco.
      Nunca expor em logs ou respostas de API.
    rf_item_relacionado: "RN-RF087-004"
    uc_relacionado: "UC01-criar-integracao, UC03-editar-integracao"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF087-005"
    tipo: "stored_procedure"
    nome: "AppSettings (Configurações Genéricas)"
    caminho: "[dbo].[AppSettings]"
    descricao: |
      Tabela chave-valor genérica para configurações.
      Não específica para integrações.
      Sem versionamento ou auditoria de alterações.
      Sem criptografia de valores sensíveis.
    destino: "substituido"
    justificativa: |
      Será substituído por tabelas especializadas (Integracao, IntegracaoEndpoint).
      Multi-tenancy (EmpresaId).
      Auditoria automática (Created, CreatedBy, LastModified, LastModifiedBy).
    rf_item_relacionado: "Seção 7 do RF (Modelo de Dados)"
    uc_relacionado: "UC00-listar-integracoes"
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: 2

  # ----------------------------------------------------------------------------
  # REGRAS DE NEGÓCIO IMPLÍCITAS
  # ----------------------------------------------------------------------------
  - id: "LEG-RF087-006"
    tipo: "regra_negocio"
    nome: "Timeout Fixo de 30 Segundos"
    caminho: "ic1_legado/IControlIT/Classes/IntegracaoERP.vb:45"
    descricao: |
      Timeout hardcoded de 30 segundos em requisições HTTP.
      Não configurável.
      HttpWebRequest.Timeout = 30000
    destino: "assumido"
    justificativa: |
      Valor padrão de 30 segundos será mantido, mas agora configurável (1 a 300 segundos).
      Usuários podem ajustar conforme necessidade de cada integração.
    rf_item_relacionado: "RN-RF087-005"
    uc_relacionado: "UC01-criar-integracao, UC03-editar-integracao"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF087-007"
    tipo: "regra_negocio"
    nome: "Retry Manual de 3 Tentativas"
    caminho: "ic1_legado/IControlIT/Classes/IntegracaoERP.vb:78"
    descricao: |
      Lógica manual de retry com 3 tentativas.
      Delay fixo de 1 segundo entre tentativas.
      Sem backoff exponencial.
    destino: "substituido"
    justificativa: |
      Será substituído por Polly com retry inteligente.
      Backoff exponencial (1s, 2s, 4s).
      Configurável por integração.
    rf_item_relacionado: "RN-RF087-008"
    uc_relacionado: "UC01-criar-integracao"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF087-008"
    tipo: "regra_negocio"
    nome: "Logs em Arquivo TXT"
    caminho: "ic1_legado/IControlIT/Logs/"
    descricao: |
      Logs de integrações salvos em arquivos .txt.
      Sem estrutura padronizada (apenas texto livre).
      Difícil análise e monitoramento.
      Rotação manual de arquivos.
    destino: "substituido"
    justificativa: |
      Será substituído por tabela IntegracaoExecucao com JSON estruturado.
      Campos: Request, Response, Duração, Status, Erros.
      Permite queries SQL e dashboard de estatísticas.
    rf_item_relacionado: "RN-RF087-015"
    uc_relacionado: "UC06-visualizar-execucoes"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 3

  # ----------------------------------------------------------------------------
  # FUNCIONALIDADES AUSENTES NO LEGADO (NOVAS)
  # ----------------------------------------------------------------------------
  - id: "LEG-RF087-009"
    tipo: "regra_negocio"
    nome: "Circuit Breaker"
    caminho: "N/A - Funcionalidade Nova"
    descricao: |
      Não havia Circuit Breaker no legado.
      Falhas em APIs externas causavam falhas em cascata.
      Sistema tentava indefinidamente mesmo com serviço fora do ar.
    destino: "a_revisar"
    justificativa: |
      Funcionalidade totalmente nova, sem equivalente no legado.
      Implementar com biblioteca Polly.
      Estados: CLOSED, OPEN, HALF_OPEN.
    rf_item_relacionado: "RN-RF087-006"
    uc_relacionado: "UC02-visualizar-integracao (status do circuito)"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 2

  - id: "LEG-RF087-010"
    tipo: "regra_negocio"
    nome: "Rate Limiting"
    caminho: "N/A - Funcionalidade Nova"
    descricao: |
      Não havia controle de quantidade de requisições por período.
      Risco de sobrecarga de APIs externas.
      Risco de bloqueio por excesso de chamadas.
    destino: "a_revisar"
    justificativa: |
      Funcionalidade totalmente nova.
      Implementar sliding window counter.
      Configurável por integração (N requisições em X segundos).
    rf_item_relacionado: "RN-RF087-007"
    uc_relacionado: "UC01-criar-integracao"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF087-011"
    tipo: "regra_negocio"
    nome: "Webhooks"
    caminho: "N/A - Funcionalidade Nova"
    descricao: |
      Não havia suporte a webhooks no legado.
      Integrações eram sempre iniciadas pelo IControlIT (pull).
      Não aceitava notificações de sistemas externos (push).
    destino: "descartado"
    justificativa: |
      Funcionalidade descartada NESTE RF por não existir no legado.
      Será implementada como funcionalidade nova em fase futura.
      Requer infraestrutura adicional (endpoint público, validação HMAC).
    rf_item_relacionado: "RN-RF087-013"
    uc_relacionado: null
    complexidade: "alta"
    risco_migracao: "baixo"
    prioridade: 5

# ==============================================================================
# TELAS LEGADAS (DETALHAMENTO)
# ==============================================================================

telas:
  - id: "LEG-RF087-001"
    nome: "Nenhuma tela de gestão de integrações"
    caminho: "N/A"
    responsabilidade: "Não aplicável - funcionalidade nova"
    campos: []
    comportamentos_implicitos: []
    notas: "O legado não possui interface administrativa para gestão de integrações."

# ==============================================================================
# WEBSERVICES LEGADOS
# ==============================================================================

servicos:
  - id: "LEG-RF087-003"
    nome: "ImportacaoUsuarios.asmx"
    localizacao: "ic1_legado/IControlIT/WebServices/ImportacaoUsuarios.asmx"
    responsabilidade: "Importação manual de usuários do Active Directory"
    notas: "Será substituído por integração LDAP configurável"

# ==============================================================================
# TABELAS LEGADAS COM PROBLEMAS
# ==============================================================================

tabelas:
  - nome: "AppSettings"
    finalidade: "Armazenar configurações genéricas do sistema"
    problemas:
      - "Não específica para integrações"
      - "Sem versionamento de alterações"
      - "Sem auditoria (quem/quando alterou)"
      - "Sem criptografia de valores sensíveis"
      - "Sem multi-tenancy (global para todos os clientes)"

# ==============================================================================
# REGRAS IMPLÍCITAS (NÃO DOCUMENTADAS NO LEGADO)
# ==============================================================================

regras_implicitas:
  - id: "RL-RN-001"
    descricao: |
      Timeout fixo de 30 segundos em requisições HTTP.
      Não configurável, causava problemas em APIs lentas.
    fonte: "ic1_legado/IControlIT/Classes/IntegracaoERP.vb:45"

  - id: "RL-RN-002"
    descricao: |
      Retry manual de 3 tentativas com delay fixo de 1 segundo.
      Sem backoff exponencial, ineficiente para falhas transitórias.
    fonte: "ic1_legado/IControlIT/Classes/IntegracaoERP.vb:78"

  - id: "RL-RN-003"
    descricao: |
      Credenciais de APIs armazenadas em Web.config em texto plano.
      Vulnerabilidade crítica de segurança.
    fonte: "ic1_legado/IControlIT/Web.config"

  - id: "RL-RN-004"
    descricao: |
      Logs de integrações salvos em arquivos .txt sem estrutura.
      Dificulta análise e monitoramento de problemas.
    fonte: "ic1_legado/IControlIT/Logs/"

  - id: "RL-RN-005"
    descricao: |
      Ausência de Circuit Breaker.
      Falhas em APIs externas causavam falhas em cascata no sistema.
    fonte: "Todo o código legado"

  - id: "RL-RN-006"
    descricao: |
      Ausência de Rate Limiting.
      Risco de sobrecarga de APIs externas e bloqueio por excesso de requisições.
    fonte: "Todo o código legado"

# ==============================================================================
# GAP ANALYSIS (LEGADO × MODERNO)
# ==============================================================================

gap_analysis:
  - item: "Gestão Centralizada de Integrações"
    existe_legado: false
    existe_moderno: true
    notas: "Funcionalidade NOVA. Interface administrativa completa."

  - item: "Criptografia de Credenciais"
    existe_legado: false
    existe_moderno: true
    notas: "Funcionalidade NOVA. AES-256 no banco de dados."

  - item: "Circuit Breaker"
    existe_legado: false
    existe_moderno: true
    notas: "Funcionalidade NOVA. Biblioteca Polly com padrão Circuit Breaker."

  - item: "Rate Limiting"
    existe_legado: false
    existe_moderno: true
    notas: "Funcionalidade NOVA. Sliding window counter implementado."

  - item: "Retry com Backoff Exponencial"
    existe_legado: false
    existe_moderno: true
    notas: "Substituição. Legado tinha retry manual com delay fixo."

  - item: "Webhooks"
    existe_legado: false
    existe_moderno: true
    notas: "Funcionalidade NOVA. Suporte a webhooks IN/OUT com HMAC."

  - item: "Filas de Processamento"
    existe_legado: false
    existe_moderno: true
    notas: "Funcionalidade NOVA. Hangfire para processamento assíncrono."

  - item: "Dashboard de Estatísticas"
    existe_legado: false
    existe_moderno: true
    notas: "Funcionalidade NOVA. Métricas de sucesso, erro, tempo médio."

  - item: "Multi-tenancy"
    existe_legado: false
    existe_moderno: true
    notas: "Legado tinha bancos separados. Moderno tem Row-Level Security."

  - item: "Auditoria de Operações"
    existe_legado: false
    existe_moderno: true
    notas: "Funcionalidade NOVA. AuditInterceptor automático."

# ==============================================================================
# DECISÕES DE MODERNIZAÇÃO
# ==============================================================================

decisoes_modernizacao:
  - decisao: "Criar módulo de Gestão de Integrações do zero"
    motivo: |
      O legado não possui funcionalidade equivalente.
      Integrações eram hardcoded, dificultando manutenção.
    impacto: "alto"
    data: "2025-12-31"

  - decisao: "Usar biblioteca Polly para resiliência"
    motivo: |
      Implementar Circuit Breaker, Retry e Timeout de forma padronizada.
      Polly é padrão da indústria .NET.
    impacto: "medio"
    data: "2025-12-31"

  - decisao: "Usar Hangfire para processamento assíncrono"
    motivo: |
      Executar integrações longas em background sem bloquear HTTP.
      Melhora performance e experiência do usuário.
    impacto: "medio"
    data: "2025-12-31"

  - decisao: "Criptografar credenciais no banco de dados"
    motivo: |
      Credenciais em texto plano é vulnerabilidade crítica.
      Atende padrões de segurança (LGPD, ISO 27001).
    impacto: "alto"
    data: "2025-12-31"

  - decisao: "Suportar múltiplos tipos de integração"
    motivo: |
      Legado só tinha HTTP.
      Modernizar exige suporte a SOAP, GraphQL, FTP, LDAP, etc.
    impacto: "alto"
    data: "2025-12-31"

# ==============================================================================
# RISCOS DE MIGRAÇÃO
# ==============================================================================

riscos_migracao:
  - risco: "Dependência de integrações hardcoded existentes"
    impacto: "alto"
    probabilidade: "alta"
    mitigacao: |
      Mapear todas as integrações hardcoded existentes no legado.
      Configurá-las no novo módulo antes de desativar código legado.
      Testes paralelos (legado + moderno) antes de cutover.

  - risco: "Credenciais perdidas durante migração"
    impacto: "alto"
    probabilidade: "media"
    mitigacao: |
      Documentar todas as credenciais do Web.config.
      Migrá-las de forma criptografada para o novo banco.
      Backup de Web.config antes de migração.

  - risco: "Falta de histórico de execuções"
    impacto: "medio"
    probabilidade: "alta"
    mitigacao: |
      Aceitar que logs antigos (arquivos .txt) não serão migrados.
      Novo sistema começa histórico do zero.
      Manter logs legados por 90 dias para consulta.

  - risco: "Mudança de comportamento (Retry/Timeout)"
    impacto: "baixo"
    probabilidade: "media"
    mitigacao: |
      Configurar novos valores de retry e timeout compatíveis com o legado.
      Padrão: 3 tentativas, 30 segundos (igual ao legado).
      Testes de integração antes de produção.

  - risco: "Falta de testes de integrações externas"
    impacto: "alto"
    probabilidade: "alta"
    mitigacao: |
      Criar ambiente de staging com APIs mock.
      Testar integrações sem impactar sistemas externos reais.
      Validação com time de integrações antes de cutover.

# ==============================================================================
# RASTREABILIDADE (LEGADO → MODERNO)
# ==============================================================================

rastreabilidade:
  - elemento_legado: "IntegracaoERP.vb"
    referencia_rf: "RN-RF087-001, RN-RF087-005, RN-RF087-008"
    referencia_uc: "UC01-criar-integracao"
    status: "migrado"

  - elemento_legado: "EmailService.vb"
    referencia_rf: "RN-RF087-002, RN-RF087-003"
    referencia_uc: "UC01-criar-integracao"
    status: "migrado"

  - elemento_legado: "ImportacaoUsuarios.asmx"
    referencia_rf: "RN-RF087-002, RN-RF087-011"
    referencia_uc: "UC01-criar-integracao"
    status: "migrado"

  - elemento_legado: "Web.config (Credenciais)"
    referencia_rf: "RN-RF087-004"
    referencia_uc: "UC01-criar-integracao, UC03-editar-integracao"
    status: "migrado"

  - elemento_legado: "AppSettings (Tabela)"
    referencia_rf: "Seção 7 (Modelo de Dados)"
    referencia_uc: "UC00-listar-integracoes"
    status: "migrado"

  - elemento_legado: "Timeout 30s hardcoded"
    referencia_rf: "RN-RF087-005"
    referencia_uc: "UC01-criar-integracao"
    status: "migrado"

  - elemento_legado: "Retry manual"
    referencia_rf: "RN-RF087-008"
    referencia_uc: "UC01-criar-integracao"
    status: "migrado"

  - elemento_legado: "Logs em TXT"
    referencia_rf: "RN-RF087-015"
    referencia_uc: "UC06-visualizar-execucoes"
    status: "migrado"

  - elemento_legado: "Circuit Breaker (ausente)"
    referencia_rf: "RN-RF087-006"
    referencia_uc: "UC02-visualizar-integracao"
    status: "em_analise"

  - elemento_legado: "Rate Limiting (ausente)"
    referencia_rf: "RN-RF087-007"
    referencia_uc: "UC01-criar-integracao"
    status: "em_analise"

  - elemento_legado: "Webhooks (ausente)"
    referencia_rf: "RN-RF087-013"
    referencia_uc: null
    status: "descartado"

# ==============================================================================
# METADADOS DE MIGRAÇÃO
# ==============================================================================

metadados:
  total_itens_legado: 11
  itens_assumidos: 1
  itens_substituidos: 7
  itens_descartados: 1
  itens_a_revisar: 2
  cobertura_destinos: "100%"

# ==============================================================================
# PROBLEMAS LEGADO IDENTIFICADOS
# ==============================================================================

problemas_legado:
  - id: "PROB-RF087-001"
    titulo: "Credenciais em Texto Plano"
    severidade: "CRÍTICA"
    descricao: |
      Credenciais de APIs externas armazenadas em Web.config sem criptografia.
      Vulnerabilidade de segurança grave.
    impacto: "Exposição de credenciais em caso de vazamento de código ou acesso ao servidor."
    solucao_moderna: "Campo CredenciaisJson criptografado com AES-256 no banco de dados."

  - id: "PROB-RF087-002"
    titulo: "Ausência de Resiliência"
    severidade: "ALTA"
    descricao: |
      Sem Circuit Breaker, Rate Limiting ou Retry inteligente.
      Falhas em APIs externas causavam falhas em cascata.
    impacto: "Indisponibilidade do sistema quando APIs externas falhavam."
    solucao_moderna: "Biblioteca Polly com Circuit Breaker, Retry e Rate Limiting."

  - id: "PROB-RF087-003"
    titulo: "Integrações Hardcoded"
    severidade: "ALTA"
    descricao: |
      Cada nova integração exigia alterar código VB.NET e fazer deploy.
    impacto: "Alto custo de manutenção, risco de bugs, tempo de entrega longo."
    solucao_moderna: "Interface administrativa para configurar integrações dinamicamente."

  - id: "PROB-RF087-004"
    titulo: "Logs Não Estruturados"
    severidade: "MÉDIA"
    descricao: |
      Logs de integrações salvos em arquivos .txt sem estrutura.
    impacto: "Dificulta debugging e análise de problemas. Sem métricas de performance."
    solucao_moderna: "Tabela IntegracaoExecucao com JSON estruturado + Dashboard."

  - id: "PROB-RF087-005"
    titulo: "Ausência de Auditoria"
    severidade: "MÉDIA"
    descricao: |
      Não havia registro de quem/quando alterou configurações.
    impacto: "Falta de rastreabilidade em caso de problemas ou auditorias."
    solucao_moderna: "AuditInterceptor automático em todas as operações."

  - id: "PROB-RF087-006"
    titulo: "Multi-Tenancy Parcial"
    severidade: "MÉDIA"
    descricao: |
      Bancos de dados separados por cliente dificultava gestão centralizada.
    impacto: "Cada cliente precisava ter configuração replicada manualmente."
    solucao_moderna: "Multi-tenancy com Row-Level Security (campo EmpresaId)."

# ==============================================================================
# CHANGELOG
# ==============================================================================

changelog:
  - versao: "1.0"
    data: "2025-12-31"
    descricao: "Documentação inicial de referência ao legado (funcionalidade nova)"
    autor: "Agência ALC - alc.dev.br"
