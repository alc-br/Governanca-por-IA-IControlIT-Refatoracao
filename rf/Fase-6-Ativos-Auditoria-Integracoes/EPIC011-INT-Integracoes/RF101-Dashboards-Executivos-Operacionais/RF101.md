# RF-101: Dashboards Executivos Operacionais

**Versão**: 2.0 | **Data**: 2025-12-31
**RF Relacionado**: RF099, RF093, RF094, RF079 | **EPIC**: EPIC011-INT-Integracoes
**Fase**: Fase 6 - Ativos, Auditoria e Integrações

---

## 1. VISÃO GERAL

### 1.1 Objetivo

Fornecer dashboards executivos pré-definidos para públicos estratégicos (C-Level, Diretoria, Gerência Sênior), consolidando dados operacionais e financeiros em visualizações de alto impacto para tomada de decisão rápida baseada em dados consolidados.

### 1.2 Problema Resolvido

Executivos precisam de visões consolidadas de múltiplas fontes (telecom, TI, facilities) sem necessidade de acesso a sistemas transacionais. Falta de visibilidade estratégica em KPIs financeiros, compliance e SLA dificulta governança corporativa e tomada de decisão informada.

### 1.3 Público Afetado

- **Primário**: CEO, CFO, CIO, Diretoria Executiva, Gerência Sênior
- **Secundário**: Analistas Executivos, Auditores Internos, Controladores Financeiros
- **Sistemas Integrados**: RF099 (Dashboards genéricos), RF093 (KPIs), RF094 (Auditoria Custos), RF079 (Políticas)

### 1.4 Conceitos Fundamentais

**Dashboard Executivo**: Painel visual consolidado com indicadores pré-selecionados para público específico, dados agregados em batch, acesso restrito por RBAC.

**Consolidação Batch**: Agregação diária de dados transacionais em fact tables dimensionais via Hangfire (6h AM), reduzindo carga OLAP em produção.

**Forecast ML**: Previsão de custos futuros usando Azure ML SDK ou ML.NET (ARIMA/Regressão Linear) com R² mínimo 0.85 para validade estatística.

**Heatmap de Consumo**: Matriz bidimensional filiais × centros de custo com escala de cores (verde < 80%, amarelo 80-100%, vermelho > 100% meta).

**Balanced Scorecard**: Framework estratégico com 4 perspectivas (Financeira, Clientes, Processos, Aprendizado) sincronizado com RF093.

**Budget vs Real**: Comparativo orçamento previsto vs despesa realizada com alertas automáticos quando variação > 10%.

**SLA Executive View**: Consolidação de SLAs contratuais (RF023) com performance realizada (RF028/RF029), alertas para SLAs em risco.

---

## 2. ESCOPO

### 2.1 Incluído

- Dashboard C-Level com 4 KPIs estratégicos (Receita, Custos, Compliance, SLA)
- Dashboard de Custos consolidados por contrato/filial/centro de custo com trending
- Dashboard de Compliance com status de políticas (RF079) e cobertura LGPD
- Dashboard de Performance com indicadores operacionais (RF093) e heatmap de eficiência
- Indicadores de SLA com % atendimento vs meta contratual (RF028, RF029, RF023)
- Heatmap de Consumo (matriz filial × centro de custo com escala visual)
- Trending de Custos (granularidades: diária 30d, semanal 13s, mensal 12m) com regressão linear
- Forecast com Machine Learning para previsão 3/6/12 meses com intervalo de confiança 95%
- Budget vs Real com alertas automáticos (variação > 10% amarelo, > 20% vermelho)
- Balanced Scorecard com 4 perspectivas e indicadores balanceados
- Export Executivo em PowerPoint (.pptx) e PDF com gráficos embutidos como PNG
- Drill-down detalhado navegando de KPI agregado para dados granulares
- Sincronização com Azure DevOps via RF079 para indicadores de projeto

### 2.2 Fora do Escopo

- Dashboards configuráveis customizados por usuário (coberto por RF099)
- Criação de novos KPIs ou métricas custom (deve usar RF093)
- Relatórios transacionais detalhados (usar módulos específicos de origem)
- Exportação em Excel dinâmico (apenas PowerPoint e PDF executivos)
- Agendamento de envio de relatórios por email (roadmap futuro)
- Integração com Power BI Desktop (apenas Power BI Embedded)

---

## 3. ENTIDADES

### 3.1 Dashboard

**Descrição**: Representa um dashboard executivo pré-definido.

**Atributos**:
- **Id** (Guid): Identificador único
- **ClienteId** (Guid): Isolamento multi-tenant
- **Tipo** (enum): CLevelDashboard, CustosDashboard, ComplianceDashboard, PerformanceDashboard
- **Titulo** (string): Nome do dashboard
- **Descricao** (string): Descrição breve
- **Ativo** (bool): Dashboard habilitado para acesso
- **PermissaoRequerida** (string): Código de permissão RBAC necessária
- **DataCriacao** (DateTime): Timestamp de criação
- **DataUltimaAtualizacao** (DateTime): Última atualização dos dados consolidados

**Multi-tenancy**: Sim (ClienteId)
**Soft Delete**: Sim (campo Fl_Excluido)
**Auditoria**: Sim (todos os acessos auditados em RF004)

### 3.2 FatoDashboard_Custos

**Descrição**: Tabela de fatos dimensional com custos consolidados para performance.

**Atributos**:
- **Id** (bigint): Chave primária identidade
- **ClienteId** (Guid): Isolamento multi-tenant
- **ContratoId** (Guid): FK para Contrato (RF023)
- **FilialId** (Guid): FK para Filial (RF008)
- **CentroCustoId** (Guid): FK para Centro de Custo (RF009)
- **DataConsolidacao** (Date): Data da consolidação (referência)
- **Mes** (int): Mês (1-12)
- **Ano** (int): Ano (YYYY)
- **ValorTotal** (decimal 18,2): Valor consolidado
- **ValorUnitario** (decimal 18,2): Valor médio unitário (opcional)
- **Quantidade** (int): Quantidade de itens agregados

**Multi-tenancy**: Sim (ClienteId)
**Soft Delete**: Não (fact table agregada, dados históricos mantidos)
**Auditoria**: Não (auditado via Dashboard_Consolidacao)

### 3.3 FatoDashboard_SLA

**Descrição**: Consolidação de performance SLA para consultas rápidas.

**Atributos**:
- **Id** (bigint): Chave primária identidade
- **ClienteId** (Guid): Isolamento multi-tenant
- **ContratoId** (Guid): FK para Contrato
- **DataReferencia** (Date): Período de referência
- **MetaPercentual** (decimal 5,2): Meta contratual (ex: 95.00)
- **PercentualAtendimento** (decimal 5,2): % real atingido
- **Atendido** (int): Quantidade atendida dentro do SLA
- **Esperado** (int): Quantidade total esperada
- **Status** (enum): Atendido, Aviso, NaoAtendido

**Multi-tenancy**: Sim (ClienteId)
**Soft Delete**: Não
**Auditoria**: Não

### 3.4 Dashboard_Consolidacao

**Descrição**: Registro de execução de jobs de consolidação diária.

**Atributos**:
- **Id** (Guid): Identificador único
- **ClienteId** (Guid): Cliente processado
- **DataConsolidacao** (Date): Data dos dados consolidados
- **TipoDado** (enum): Custos, SLA, Compliance, Performance
- **Periodo** (string): Período no formato YYYY-MM
- **DataExecucao** (DateTime): Timestamp da execução
- **Sucesso** (bool): Job concluído com sucesso
- **RegistrosProcessados** (int): Quantidade de registros carregados
- **MensagemErro** (string): Mensagem de erro se houver falha

**Multi-tenancy**: Sim (ClienteId)
**Soft Delete**: Não
**Auditoria**: Sim (logs estruturados)

### 3.5 ForecastResult

**Descrição**: Resultado de previsão de Machine Learning.

**Atributos**:
- **Id** (Guid): Identificador único
- **ClienteId** (Guid): Isolamento multi-tenant
- **ContratoId** (Guid): Contrato analisado
- **DataGeracao** (DateTime): Quando foi gerado
- **ProximaAtualizacao** (DateTime): Validade do forecast (30 dias)
- **IsValido** (bool): Modelo atende R² >= 0.85
- **RSquared** (decimal 5,4): Coeficiente de determinação (0-1)
- **ConfiancaPercentual** (int): Confiança em % (85-100)
- **MotivoInvalido** (string): Motivo se inválido (ex: "Histórico < 12 meses")
- **PrevisoesMensais** (JSON): Array de previsões com intervalo confiança

**Multi-tenancy**: Sim (ClienteId)
**Soft Delete**: Não (sobrescrito mensalmente)
**Auditoria**: Sim (geração de forecast auditada)

---

## 4. REGRAS DE NEGÓCIO

### RN-DSH-101-01: Controle de Acesso Restrito a Executivos

**Descrição**: Apenas usuários com perfis C-Level, Diretoria, Gerência Sênior e Analista Executivo podem acessar dashboards executivos. Tentativas não autorizadas retornam HTTP 403 e são auditadas.

**Tipo**: Segurança
**Campos Afetados**: Todos os endpoints de dashboard
**Obrigatório**: Sim

**Validação**:
- Verificar claims do JWT: Roles contém "CEO" OU "CFO" OU "CIO" OU "Diretoria" OU "Gerencia" OU "AnalistaExecutivo"
- Verificar permissão específica: `dashboard:executivo:view`
- Auditar TODAS as tentativas (sucesso e falha)

**Mensagem de Erro**: "Acesso negado. Usuário não possui permissão para visualizar dashboards executivos."

### RN-DSH-101-02: Consolidação Diária de Dados via Hangfire

**Descrição**: Dados agregados devem ser consolidados automaticamente via Hangfire job executado diariamente às 6:00 AM UTC. Job deve ser idempotente e registrar sucesso/falha.

**Tipo**: Regra de Negócio
**Campos Afetados**: FatoDashboard_Custos, FatoDashboard_SLA, Dashboard_Consolidacao
**Obrigatório**: Sim

**Comportamento**:
- Executar às 06:00 AM UTC via RecurringJob (Cron.Daily(6, 0))
- Consolidar dados do dia anterior (D-1)
- Idempotente: múltiplas execuções no mesmo dia não duplicam dados (UPSERT)
- Registrar em Dashboard_Consolidacao: DataExecucao, Sucesso, RegistrosProcessados, MensagemErro
- Em caso de falha: Log estruturado, alerta ops, retry automático após 1 hora (máximo 3 tentativas)

**Métricas**: Duração média < 10 minutos para volume esperado (1M registros/dia)

### RN-DSH-101-03: Forecast com Série Histórica 12+ Meses

**Descrição**: Previsões de custos futuros exigem mínimo 12 meses de histórico. Modelo estatístico (ARIMA/Regressão Linear) deve atingir R² mínimo 0.85 para ser considerado válido.

**Tipo**: Regra de Negócio
**Campos Afetados**: ForecastResult.IsValido, ForecastResult.RSquared, ForecastResult.MotivoInvalido
**Obrigatório**: Sim

**Validação**:
- Contar meses com dados consolidados em FatoDashboard_Custos para (ClienteId + ContratoId)
- SE contagem < 12 ENTÃO IsValido = false, MotivoInvalido = "Histórico insuficiente (< 12 meses)", ConfiancaPercentual = 0
- SE contagem >= 12 ENTÃO treinar modelo ML.NET (ForecastBySsa) ou Azure ML
- Calcular R² comparando previsão vs dados reais em janela de teste (últimos 20%)
- SE R² < 0.85 ENTÃO IsValido = false, MotivoInvalido = "Modelo estatístico com baixa acurácia (R² < 0.85)"
- SE R² >= 0.85 ENTÃO IsValido = true, ConfiancaPercentual = (int)(R² * 100)

**Exemplos**:
- Contrato com 14 meses: Forecast válido, R² = 0.92 → ConfiancaPercentual = 92
- Contrato com 8 meses: Forecast inválido → Exibir aviso na UI, gráfico não exibido
- Modelo com R² = 0.78: Forecast inválido → "Modelo estatístico insuficiente"

### RN-DSH-101-04: Budget vs Real com Alertas por Variação

**Descrição**: Comparativo Budget vs Real calcula variação percentual ((Real - Budget) / Budget). Alertas visuais: > 10% amarelo, > 20% vermelho.

**Tipo**: Regra de Negócio
**Campos Afetados**: BudgetVsRealDto.VariacaoPercentual, BudgetVsRealDto.AlertNivel, BudgetVsRealDto.CorAlerta
**Obrigatório**: Sim

**Cálculo**:
```
Variacao = ((Real - Budget) / Budget) * 100
```

**Classificação**:
- |Variacao| <= 10%: AlertNivel = Normal, Cor = Verde (#4CAF50)
- 10% < |Variacao| <= 20%: AlertNivel = Aviso, Cor = Amarelo (#FFC107)
- |Variacao| > 20%: AlertNivel = Critico, Cor = Vermelho (#F44336)

**Casos Especiais**:
- Budget = 0 e Real > 0: Variacao = 100%, AlertNivel = Critico
- Budget = 0 e Real = 0: Variacao = 0%, AlertNivel = Normal

**Mensagens**:
- Normal: "Conforme orçado"
- Aviso: "Desvio de {abs(variacao):F1}% - Revisar próximo mês"
- Crítico: "CRÍTICO: Desvio de {abs(variacao):F1}% - Ação necessária"

### RN-DSH-101-05: Heatmap com Escala de Cores por Meta

**Descrição**: Heatmap de consumo usa escala de cores: verde (< 80% meta), amarelo (80-100% meta), vermelho (> 100% meta). Cores acessíveis WCAG AA.

**Tipo**: Regra de Negócio
**Campos Afetados**: HeatmapCell.Status, HeatmapCell.CorHex, HeatmapCell.PercentualMeta
**Obrigatório**: Sim

**Cálculo**:
```
PercentualMeta = (ConsumoReal / MetaMensal) * 100
```

**Classificação**:
- PercentualMeta < 80%: Status = Otimo, Cor = #4CAF50 (verde WCAG AA)
- 80% <= PercentualMeta <= 100%: Status = Aceitavel, Cor = #FFC107 (amarelo WCAG AA)
- PercentualMeta > 100%: Status = Critico, Cor = #F44336 (vermelho WCAG AA)
- MetaMensal = 0: Status = Indefinido, Cor = #999999 (cinza)

**Metadados**:
- Incluir em HeatmapCell: ConsumoReal, MetaMensal, PercentualMeta, TrendingMeses (últimos 6 meses)
- TextoAlternativo para acessibilidade: "{FilialNome}/{CCustoNome}: {PercentualMeta:F1}% ({ConsumoReal:C})"

### RN-DSH-101-06: Trending Multi-Granularidade

**Descrição**: Gráfico trending permite granularidades: diária (30 dias), semanal (13 semanas), mensal (12 meses). Linha de tendência via regressão linear.

**Tipo**: Regra de Negócio
**Campos Afetados**: TrendingData.Granularidade, TrendingData.Pontos, TrendingData.Regressao
**Obrigatório**: Sim

**Granularidades**:
- **Diária**: Últimos 30 dias, agregação por data (YYYY-MM-DD)
- **Semanal**: Últimas 13 semanas, agregação por semana ISO 8601 (YYYY-Www)
- **Mensal**: Últimos 12 meses, agregação por mês (YYYY-MM)

**Regressão Linear**:
- Calcular slope (inclinação) e intercept (intersecção) via método dos mínimos quadrados
- Direcao = slope > 0 ? "Subindo" : "Descendo"
- Angulo = atan(slope) * (180 / π)

**Variação Período-a-Período**:
- Para cada ponto N: VariacaoPercentual = ((ValorN - ValorN-1) / ValorN-1) * 100

**Resumo Estatístico**:
- ValorInicio, ValorFim, VariacaoTotal, ValorMedio, ValorMaximo, ValorMinimo

### RN-DSH-101-07: SLA com % Atendimento vs Meta Contratual

**Descrição**: Indicador SLA mostra % atendimento comparado com meta contratual (RF023). Cálculo: (Atendido / Esperado) * 100. Verde >= meta, amarelo 95-99% meta, vermelho < 95%.

**Tipo**: Regra de Negócio
**Campos Afetados**: SLAIndicadorDto.PercentualAtendimento, SLAIndicadorDto.Status
**Obrigatório**: Sim

**Cálculo**:
```
PercentualAtendimento = (Atendido / Esperado) * 100
```

**Classificação** (assumindo MetaContratual = 95%):
- PercentualAtendimento >= MetaContratual: Status = Atendido, Cor = Verde
- MetaContratual * 0.95 <= PercentualAtendimento < MetaContratual: Status = Aviso, Cor = Amarelo
- PercentualAtendimento < MetaContratual * 0.95: Status = NaoAtendido, Cor = Vermelho

**Fontes de Dados**:
- Meta contratual: RF023 (Contratos).SLAs.MetaPercentual
- Atendido: COUNT em RF028 (Operações) ou RF029 (Serviços) WHERE Status = Concluido AND DentroSLA = true
- Esperado: SUM de expectativa/demanda planejada

### RN-DSH-101-08: Integração com Compliance (RF079)

**Descrição**: Dashboard Compliance integra status de políticas (RF079). Exibir: título, última atualização, status conformidade, % cobertura filiais, drill-down detalhado.

**Tipo**: Regra de Negócio
**Campos Afetados**: ComplianceDashboardDto.Indicadores, ComplianceIndicador.PercentualCobertura
**Obrigatório**: Sim

**Dados Exibidos por Política**:
- PoliticaId, TituloPolitica, DataUltimaAtualizacao (de RF079.Politica)
- StatusGeral: Conforme (nenhuma filial não conforme), ParcialmenteConforme (cobertura >= 80%), NaoConforme (< 80%)
- PercentualCobertura: (FiliaisConformes / TotalFiliais) * 100
- TotalFiliais, FiliaisConformes, FiliaisNaoConformes, FiliaisPendentes

**Consolidação Geral**:
- PercentualConformidadeGeral: Média de PercentualCobertura de todas as políticas
- TotalPoliticas, PoliticasConformes, PoliticasNaoConformes

**Drill-down**: Clicar em política abre detalhe por filial

### RN-DSH-101-09: Export Executivo em PowerPoint

**Descrição**: Endpoint POST /api/dashboards/executivo/export/pptx gera arquivo PowerPoint com 6 slides: Capa, Sumário, C-Level, Custos, SLA/Compliance, Recomendações. Gráficos embutidos como PNG.

**Tipo**: Regra de Negócio
**Campos Afetados**: ExportResponse.UrlDownload, ExportResponse.NomeArquivo
**Obrigatório**: Sim

**Estrutura do Arquivo**:
1. **Slide 1 - Capa**: Título, data geração, usuário, empresa
2. **Slide 2 - Sumário Executivo**: 4 KPIs principais em cards
3. **Slide 3 - Dashboard C-Level**: Gráficos de linha/barra renderizados como PNG
4. **Slide 4 - Dashboard Custos**: Trending, heatmap, budget vs real
5. **Slide 5 - SLA e Compliance**: Indicadores, status, alertas
6. **Slide 6 - Recomendações**: Análise e ações sugeridas

**Renderização Gráficos**:
- Converter D3.js/Highcharts em PNG via Puppeteer (headless Chrome)
- Resolução: 1920x1080 por gráfico
- Embed no PowerPoint via Open XML SDK

**Armazenamento**:
- Upload em Azure Blob Storage (container: relatorios-executivos)
- Expiração: 7 dias (SAS token com TTL)
- Nome arquivo: `relatorio_executivo_{ClienteId}_{YYYYMMDD_HHmmss}.pptx`

**Auditoria**: Log com UserId, ClienteId, DataGeracao, NomeArquivo

### RN-DSH-101-10: Auditoria Obrigatória de Acesso

**Descrição**: Toda tentativa de acesso a dashboard executivo deve ser auditada em AuditLog (RF004) com: UserId, ClienteId, DashboardTipo, DataAcesso, IpOrigem, UserAgent. Retenção 5 anos (LGPD).

**Tipo**: Segurança
**Campos Afetados**: AuditEntry (RF004)
**Obrigatório**: Sim

**Dados Auditados**:
- **Sucesso**: UserId, ClienteId, Acao = "DSH_DASHBOARD_ACESSO", Recurso = "Dashboard_{tipo}", IpOrigem, UserAgent, DataAcesso
- **Falha**: Idem + Sucesso = false, Descricao = "Acesso não autorizado"

**Operações Auditadas**:
- DSH_DASHBOARD_ACESSO (visualização)
- DSH_EXPORT_POWERPOINT (export)
- DSH_EXPORT_PDF (export)
- DSH_DRILL_DOWN (navegação detalhada)
- DSH_ACESSO_NEGADO (tentativa sem permissão)

**Retenção**: DataRetencao = DateTime.UtcNow.AddYears(5) conforme LGPD

**Criptografia**: IPs sensíveis criptografados com AES-256

---

## 5. ESTADOS E TRANSIÇÕES

### 5.1 Estados de Dashboard

| Estado | Descrição |
|--------|-----------|
| **Ativo** | Dashboard habilitado para visualização |
| **Inativo** | Dashboard desabilitado temporariamente (manutenção) |
| **Obsoleto** | Dashboard descontinuado, substituído por nova versão |

### 5.2 Transições Permitidas

- Ativo → Inativo (desabilitar temporariamente)
- Inativo → Ativo (reabilitar)
- Ativo → Obsoleto (descontinuar)

### 5.3 Transições Proibidas

- Obsoleto → Ativo (uma vez descontinuado, não pode ser reativado)
- Inativo → Obsoleto (deve passar por Ativo antes)

---

## 6. PERMISSÕES RBAC

| Código | Descrição | Perfis Autorizados |
|--------|-----------|-------------------|
| `dashboard.executivo.view_any` | Listar dashboards disponíveis | CEO, CFO, CIO, Diretoria, Gerencia, AnalistaExecutivo |
| `dashboard.executivo.view` | Visualizar dashboard específico | CEO, CFO, CIO, Diretoria, Gerencia, AnalistaExecutivo |
| `dashboard.executivo.clevel` | Acessar Dashboard C-Level | CEO, CFO, CIO, Diretoria |
| `dashboard.executivo.custos` | Acessar Dashboard Custos | CEO, CFO, Diretoria, Gerencia |
| `dashboard.executivo.compliance` | Acessar Dashboard Compliance | CEO, CFO, CIO, DiretorCompliance |
| `dashboard.executivo.performance` | Acessar Dashboard Performance | CEO, CIO, DiretorOperacoes, Gerencia |
| `dashboard.executivo.export` | Exportar PowerPoint/PDF | CEO, CFO, CIO, Diretoria, AnalistaExecutivo |
| `dashboard.executivo.drill_down` | Acessar análise detalhada | CEO, CFO, CIO, Diretoria, Gerencia, Analista |
| `dashboard.executivo.audit` | Visualizar logs auditoria | CEO, CIO, GerenciaTI |

**Nota**: Perfis CEO/CFO/CIO têm acesso a TODOS os dashboards. Gerentes têm acesso restrito à sua filial/área. Analistas têm acesso read-only.

---

## 7. INTEGRAÇÕES

### 7.1 Integrações Internas

| Sistema | Tipo | Obrigatória | Descrição |
|---------|------|-------------|-----------|
| **RF099 - Dashboards Genéricos** | Componente compartilhado | Sim | Widgets e componentes visuais reutilizáveis |
| **RF093 - Indicadores de Performance** | API REST | Sim | Fonte de KPIs operacionais |
| **RF094 - Auditoria de Custos** | API REST | Sim | Dados de custos consolidados |
| **RF079 - Políticas e Compliance** | API REST | Sim | Status de conformidade de políticas |
| **RF023 - Contratos** | API REST | Sim | Metas de SLA contratuais |
| **RF028 - SLA Operações** | API REST | Sim | Performance realizada (operações) |
| **RF029 - SLA Serviços** | API REST | Sim | Performance realizada (serviços) |
| **RF008 - Empresas e Filiais** | Entidade compartilhada | Sim | Hierarquia organizacional |
| **RF009 - Centros de Custo** | Entidade compartilhada | Sim | Estrutura de custos |
| **RF004 - Auditoria** | Sistema transversal | Sim | Log de todos os acessos |
| **RF001 - Central de Funcionalidades** | Feature flags | Sim | Controle de features habilitadas |
| **Autenticação/Autorização** | Sistema transversal | Sim | JWT + RBAC |
| **Multi-Tenancy** | Sistema transversal | Sim | Isolamento por ClienteId |

### 7.2 Integrações Externas

| Sistema | Tipo | Obrigatória | Descrição |
|---------|------|-------------|-----------|
| **Azure ML** | API REST | Não | Forecast com Machine Learning (alternativa: ML.NET local) |
| **Power BI Embedded** | JavaScript SDK | Não | Visualizações avançadas (opcional) |
| **Azure Blob Storage** | SDK .NET | Sim | Armazenamento de arquivos exportados |
| **Azure DevOps** | API REST | Não | Sincronização de indicadores de projeto (via RF079) |

---

## 8. SEGURANÇA

### 8.1 Controles de Segurança

| Controle | Implementação |
|----------|---------------|
| **RBAC** | Controle por perfil (CEO, CFO, CIO, Diretoria, Gerência, Analista) |
| **Autenticação** | JWT Bearer Token com claims ClienteId, UserId, Roles, TTL 30 min |
| **Isolamento Multi-Tenant** | Filtro ClienteId obrigatório em todas as queries |
| **Auditoria Completa** | Log de acessos, exports, drill-downs, retenção 5 anos |
| **HTTPS Obrigatório** | TLS 1.3, certificados válidos |
| **Criptografia em Repouso** | Azure SQL Transparent Data Encryption (TDE) |
| **CORS Restritivo** | Apenas domínios confiáveis |
| **Rate Limiting** | 100 requisições/minuto por usuário |
| **SQL Injection Prevention** | Entity Framework parametrizado |
| **XSS Prevention** | Angular sanitização automática + CSP headers |
| **CSRF Protection** | Token CSRF em POST + SameSite cookies |

### 8.2 Testes de Segurança Obrigatórios

- SQL Injection em filtros (período, contrato, filial)
- XSS em campos de entrada
- CSRF Protection em POST /export/pptx
- Validação de permissões em cada endpoint
- Isolamento ClienteId entre tenants
- Rate Limiting contra força bruta
- Auditoria de acessos não autorizados
- Validação Token JWT (expiração, assinatura)
- Proteção timing attacks
- Validação entrada (tipos, ranges, enums)

---

## 9. RASTREABILIDADE

### 9.1 Casos de Uso Esperados

- **UC00-listar-dashboards-executivos**: Listar dashboards disponíveis para o perfil do usuário
- **UC01-visualizar-dashboard-clevel**: Acessar Dashboard C-Level com 4 KPIs principais
- **UC02-visualizar-dashboard-custos**: Acessar Dashboard de Custos com trending e forecast
- **UC03-visualizar-dashboard-compliance**: Acessar status de políticas e conformidade
- **UC04-visualizar-dashboard-performance**: Acessar indicadores operacionais e heatmap
- **UC05-exportar-powerpoint**: Gerar arquivo PowerPoint executivo
- **UC06-drill-down-kpi**: Navegar de KPI agregado para dados detalhados

### 9.2 Dependências

**Depende de**:
- RF001 (Central de Funcionalidades) - Feature flags
- RF004 (Auditoria) - Logs de acesso
- RF008 (Empresas e Filiais) - Hierarquia organizacional
- RF009 (Centros de Custo) - Estrutura de custos
- RF023 (Contratos) - Metas SLA
- RF028 (SLA Operações) - Performance realizada
- RF029 (SLA Serviços) - Performance realizada
- RF079 (Políticas) - Status compliance
- RF093 (Indicadores de Performance) - KPIs operacionais
- RF094 (Auditoria de Custos) - Custos consolidados
- RF099 (Dashboards Genéricos) - Componentes visuais

**Bloqueia**:
- Nenhum RF depende diretamente deste

---

## 10. MÉTRICAS E INDICADORES

### 10.1 KPIs de Sucesso

| KPI | Meta | Medição |
|-----|------|---------|
| **Tempo de Carregamento** | < 2 segundos | Latência P95 (90% < 2s) |
| **Disponibilidade** | 99,9% | Uptime via Application Insights |
| **Acurácia Forecast** | R² >= 0.85 | % forecasts válidos / total |
| **Conformidade SLA** | >= 95% | % SLAs atendidos |
| **Cobertura Consolidação** | 100% | % dados consolidados / esperado |
| **Taxa Sucesso Export** | >= 99% | % exports concluídos / solicitados |
| **Retenção Auditoria** | 100% | % logs retidos 5 anos / gerados |
| **Usuários Ativos Mensais** | >= 50 | Usuários únicos que acessaram |

### 10.2 Alertas Operacionais

| Alerta | Condição | Ação |
|--------|----------|------|
| Dashboard lento | Latência P95 > 5s por 10 min | Escalar, revisar queries |
| Consolidação falhou | Job Status=Falha | Email ops, retry 3x |
| Forecast inválido | R² < 0.60 múltiplos contratos | Desabilitar, notificar BI |
| SLA crítico | % atendimento < 90% | Alerta vermelho, email gerente |
| Budget crítico | Desvio > 20% | Alerta crítico, email CFO |
| Acesso não autorizado | 5+ tentativas/10min mesmo IP | Bloquear IP, alerta segurança |
| Auditoria perdida | Falha > 1 hora | Investigar, escalar |
| Espaço blob reduzido | < 10% disponível | Alertar ops, arquivar antigos |

---

## 11. PRÓXIMOS PASSOS

1. **Modelo de Dados**: Criar MD-RF101-Dashboards-Executivos.md com DDL completo
2. **Casos de Uso**: Criar UC-RF101-*.md para cada funcionalidade (UC00-UC06)
3. **Workflows UI**: Criar WF-RF101-Dashboards-Executivos.md com wireframes
4. **User Stories**: Criar user-stories.yaml com stories implementáveis
5. **Testes Técnicos**: TC-RF101-BACKEND.md, TC-RF101-FRONTEND.md, TC-RF101-E2E.md
6. **Implementação Backend**: Commands/Queries/Handlers, Hangfire jobs, ML.NET
7. **Implementação Frontend**: Componentes Angular, D3.js/Highcharts, PowerPoint export
8. **Integração ML**: Azure ML SDK ou ML.NET para forecast
9. **Deploy HOM**: Validação em homologação
10. **Sincronização DevOps**: Atualizar Azure DevOps

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-31 | Migração v1.0 → v2.0: Separação RF/RL completa, contrato funcional moderno sem referências ao legado, 11 seções, 10 regras de negócio em linguagem natural | Claude Code |
| 1.0 | 2025-12-28 | Documento inicial com regras, endpoints, integrações | Claude Code |

---

**Última Atualização**: 2025-12-31
**Autor**: Claude Code (Agente Architect)
**Status**: Aprovado para implementação
**Revisão**: Pendente validação com stakeholders

---

**FIM DO DOCUMENTO RF-101 v2.0**
