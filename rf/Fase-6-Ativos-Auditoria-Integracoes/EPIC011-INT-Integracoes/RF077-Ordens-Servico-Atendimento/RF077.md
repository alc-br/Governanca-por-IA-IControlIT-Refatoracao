# RF077: Ordens de Serviço e Atendimento

**Versão**: 2.0
**Data**: 2025-01-14
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC011-INT-Integracoes
**Fase**: Fase 6 - Ativos, Auditoria e Integrações

---

## 1. OBJETIVO DO REQUISITO

Especificar de forma clara e verificável o módulo de **Ordens de Serviço (OS) e Atendimento**, responsável pela criação, agendamento, execução, rastreamento de tempo, consumo de materiais, coleta de evidências digitais (fotos/assinatura) e finalização de ordens de serviço para atividades de manutenção, instalação, configuração e suporte técnico em ativos.

Este documento define **o que o sistema deve fazer** em termos de gestão completa do ciclo de vida de ordens de serviço, servindo como contrato oficial entre negócio, desenvolvimento, testes e agentes de IA.

**Nota**: Este RF **NÃO define implementação**, apenas comportamento esperado, validações obrigatórias e garantias de conformidade com ISO 20000 e ISO 27001.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] CRUD completo de Ordens de Serviço (criar, listar, visualizar, editar, cancelar)
- [x] Gestão de Tipos de OS parametrizados (instalação, configuração, movimentação, reparo, retirada)
- [x] Agendamento de OS com seleção de data/hora/técnico e verificação automática de disponibilidade
- [x] Checklist dinâmico baseado em tipo de OS com validação de completude obrigatória
- [x] Registro de tempo automatizado (início, pausa, retomada, conclusão) com auditoria completa
- [x] Consumo de materiais com redução automática de estoque após conclusão
- [x] Upload de fotos/evidências com validação de metadados EXIF (data, GPS opcional)
- [x] Assinatura digital obrigatória para conclusão com timestamp e hash de verificação
- [x] Validação de conformidade com SLA de atendimento (integração com RF028)
- [x] Relatórios de produtividade por técnico (diário, semanal, mensal)
- [x] Controle de transições de estado com validações de fluxo
- [x] Auditoria completa de todas as operações (retenção 7 anos - LGPD)
- [x] Multi-tenancy (isolamento por ClienteId)
- [x] RBAC (permissões baseadas em roles)
- [x] i18n (pt-BR, en, es)
- [x] Central de Funcionalidades (feature flags)

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (Angular 19 é implementação, não requisito)
- Tecnologia de assinatura digital (Signpad, canvas, outro)
- Formato de exportação de relatórios (PDF, Excel são opcionais)
- Integração com GPS/localização mobile (funcionalidade opcional futura)
- Estratégia de deploy ou infraestrutura

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Ordem de Serviço (OS)** | Documento formal que autoriza e documenta a execução de uma atividade de manutenção, instalação ou suporte em um ativo. Contém descrição, técnico responsável, data/hora agendada, materiais e checklist. |
| **Tipo de OS** | Categoria parametrizada que define natureza da atividade (Instalação, Configuração, Movimentação, Reparo, Retirada) e checklist associado. |
| **Agendamento** | Definição de data, hora e técnico responsável pela execução, com validação automática de disponibilidade do técnico. |
| **Checklist** | Roteiro padronizado de atividades específico por tipo de OS. Cada item deve ser verificado (sim/não) ou preenchido com observações. |
| **Registro de Tempo** | Rastreamento automático de início, pausas (almoço, deslocamento) e conclusão, gerando relatório de tempo total efetivo. |
| **Assinatura Digital** | Comprovante de conclusão assinado pelo solicitante/cliente, incluindo timestamp, identificação do signatário e hash SHA-256 de verificação. |
| **Material Consumido** | Peças/componentes utilizados durante execução, com registro de quantidade e redução automática de estoque após conclusão. |
| **Foto/Evidência** | Imagem anexada à OS com validação obrigatória de metadados EXIF (data/hora captura, GPS opcional), armazenada em blob storage criptografado. |
| **SLA de Atendimento** | Acordo de nível de serviço que define prazo máximo de resposta e conclusão, com monitoramento automático de violação. |
| **Tenant** | Unidade lógica de isolamento de dados (ClienteId). Cada cliente só visualiza/manipula suas próprias ordens de serviço. |

---

## 4. FUNCIONALIDADES COBERTAS

1. **CRUD de Ordens de Serviço** - Criar, listar, visualizar, editar e cancelar OS com validações de estado
2. **Gestão de Tipos de OS** - CRUD de tipos parametrizados com checklists associados
3. **Agendamento de Atendimentos** - Seleção de data/hora/técnico com verificação automática de conflitos
4. **Checklist Dinâmico** - Roteiros específicos por tipo de OS com validação de completude
5. **Registro de Tempo** - Timer automático com pausa/retomada e cálculo de tempo efetivo
6. **Gestão de Materiais** - Vinculação de peças consumidas com validação contra estoque
7. **Upload de Fotos/Evidências** - Múltiplas imagens com validação EXIF e redimensionamento automático
8. **Assinatura Digital** - Captura de assinatura com timestamp e hash para conclusão obrigatória
9. **Relatórios de Produtividade** - Estatísticas por técnico, período, tipo de OS (tempo médio, custos, conformidade SLA)
10. **Validação de SLA** - Monitoramento automático de prazos com alertas de violação

---

## 5. REGRAS DE NEGÓCIO

### RN-RF077-001: Validação de Transição de Estados

**Descrição**: Uma OS só pode transicionar para determinados estados conforme seu estado atual. Estados permitidos: Rascunho → Pendente Aprovação → Aprovada → Agendada → Em Execução → Concluída | Cancelada. Transições para estados anteriores (regressão) são proibidas. Estados "Concluída" e "Cancelada" são terminais (nenhuma transição permitida).

**Justificativa**: Garante integridade do processo de gestão de ordens, impede voltar para estados anteriores inadequados e documenta ações irreversíveis (ex: não pode aprovar uma OS concluída).

**Critério de Aceite**:
- Tentativa de transição Rascunho → Concluída deve ser rejeitada (falta aprovação intermediária)
- Tentativa de transição Concluída → Em Execução deve ser rejeitada (estado terminal)
- Tentativa de transição Cancelada → Aprovada deve ser rejeitada (estado terminal)
- Transições válidas devem ser permitidas sem erro

**Prioridade**: CRÍTICA

---

### RN-RF077-002: Obrigatoriedade de Checklist Completo Antes de Conclusão

**Descrição**: Uma OS não pode transicionar para estado "Concluída" sem que TODOS os itens do checklist associado sejam preenchidos (marcados sim/não com observações obrigatórias se aplicável). Se checklist estiver vazio, a conclusão deve ser bloqueada com erro explícito.

**Justificativa**: Garante que todas as atividades definidas no roteiro foram executadas e documentadas. Conformidade com ISO 20000 que exige comprovação de completude de atividades.

**Critério de Aceite**:
- OS com checklist de 5 itens todos preenchidos → Conclusão permitida
- OS com checklist de 5 itens e 2 em branco → Erro: "Complete todos os itens do checklist"
- OS sem checklist (vazio) → Erro: "Checklist vazio; impossível concluir OS"

**Prioridade**: CRÍTICA

---

### RN-RF077-003: Assinatura Digital Obrigatória em Conclusão

**Descrição**: A conclusão de uma OS (transição para "Concluída") requer captura de assinatura digital do solicitante ou cliente. A assinatura deve incluir timestamp UTC, identificação textual do signatário (nome completo) e hash SHA-256 de verificação da imagem.

**Justificativa**: Comprovação legal de entrega do serviço, rastreabilidade para auditoria e conformidade com ISO 27001 (não repúdio).

**Critério de Aceite**:
- Tentativa de conclusão sem assinatura → Erro modal: "Assinatura digital é requerida"
- Assinatura capturada → Timestamp registrado, hash SHA-256 calculado, OS marcada como Concluída
- Registro de auditoria deve incluir nome do signatário, timestamp e hash

**Prioridade**: CRÍTICA

---

### RN-RF077-004: Agendamento Requer Disponibilidade de Técnico

**Descrição**: Uma OS só pode ser agendada para data/hora se o técnico designado não tiver conflito com outra OS no mesmo período. Um técnico não pode ter 2 ordens simultâneas. Sistema deve verificar automaticamente conflitos considerando intervalos de tempo (DataHoraInicio até DataHoraFim).

**Justificativa**: Evita dupla alocação de técnicos, garante qualidade do atendimento e serve como base para otimização de roteiros.

**Critério de Aceite**:
- Técnico sem OS agendada em 10/01 09:00 → Agendamento permitido
- Técnico com OS agendada 10/01 09:00-11:00 → Tentativa de agendar 10/01 10:30 deve retornar erro: "Técnico indisponível no período selecionado"
- Erro deve incluir lista de conflitos detectados

**Prioridade**: ALTA

---

### RN-RF077-005: Duração Estimada vs Real com Margem de Tolerância

**Descrição**: A duração real da OS não pode exceder a duração estimada em mais de 20% sem justificativa textual obrigatória. Caso ultrapasse, sistema registra como "ultrapassagem com justificativa" e exige preenchimento de campo de observação antes de permitir conclusão.

**Justificativa**: Controle de custos operacionais, detecção de estimativas ruins para ajustes futuros e decisões sobre reúso de checklists.

**Critério de Aceite**:
- Duração estimada 60 min, duração real 70 min (16% acima) → Conclusão sem justificativa
- Duração estimada 60 min, duração real 80 min (33% acima) → Erro: "Duração excedida em >20%; justificativa obrigatória"
- Campo de justificativa preenchido → Conclusão permitida, flag IndicadorUltrapassagem = true

**Prioridade**: MÉDIA

---

### RN-RF077-006: Consumo de Materiais Reduz Estoque Automaticamente

**Descrição**: Quando um material/peça é associado a uma OS com quantidade específica, o saldo em estoque é decrementado automaticamente APENAS após a conclusão da OS. Se antes da conclusão houver falta de estoque, sistema registra como "falta documentada" e bloqueia conclusão até resolução (reabastecimento ou remoção do material da OS).

**Justificativa**: Rastreabilidade de consumo por OS, prevenção de overselling (venda de estoque inexistente) e base para reordenação automática de materiais.

**Critério de Aceite**:
- Material XYZ com saldo 10, OS consome 5 → Após conclusão: saldo = 5
- Material ABC com saldo 2, OS consome 5 → Erro: "Estoque insuficiente para material ABC"
- Conclusão bloqueada até saldo ser suficiente ou item removido da OS

**Prioridade**: ALTA

---

### RN-RF077-007: Conformidade com SLA de Atendimento (Integração RF028)

**Descrição**: Toda OS deve estar associada a um SLA de atendimento (definido em RF028). A transição para estado "Em Execução" verifica automaticamente se o prazo de resposta foi atendido. Atrasos geram registro de violação de SLA (IndicadorSlaViolado = true), auditoria e impactam métricas de conformidade.

**Justificativa**: Conformidade com ISO 20000, garantia de qualidade de serviço contratual e base para escalação automática de OS em risco.

**Critério de Aceite**:
- SLA com prazo de resposta 4h, OS criada às 08:00, iniciada às 10:30 → Conforme (2,5h < 4h)
- SLA com prazo de resposta 4h, OS criada às 08:00, iniciada às 13:30 → Violação (5,5h > 4h), flag IndicadorSlaViolado = true, registro de auditoria

**Prioridade**: CRÍTICA

---

### RN-RF077-008: Rastreamento de Tempo com Pausa/Retomada Auditada

**Descrição**: Durante execução de uma OS, o técnico pode pausar (ex: almoço, deslocamento) e retomar quantas vezes necessário. Cada pausa/retomada é registrada com timestamp UTC e motivo textual. O tempo total reflete apenas períodos "em execução", desconsiderando pausas. Toda ação de pausa/retomada é auditada automaticamente.

**Justificativa**: Precisão no cálculo de custos operacionais (horas efetivas), detecção de fraudes (pausas irreais) e conformidade regulatória com rastreamento completo.

**Critério de Aceite**:
- Início: 09:00, Pausa: 12:00-13:00 (almoço), Fim: 16:00 → Tempo total efetivo = 6h (não 7h)
- Cada pausa registrada com motivo obrigatório ("Almoço", "Deslocamento", etc.)
- Auditoria deve incluir todos os timestamps de pausa/retomada

**Prioridade**: ALTA

---

### RN-RF077-009: Validação de Fotos/Evidências com Metadados EXIF

**Descrição**: Fotos anexadas a uma OS devem conter metadados EXIF válidos, incluindo data/hora de captura obrigatória e GPS opcional. Fotos sem data são rejeitadas imediatamente. Fotos com data de captura >3 dias antes da criação da OS geram aviso (mas não bloqueiam). Sistema aplica redimensionamento automático para máximo 1920x1080 pixels.

**Justificativa**: Comprovação de autenticidade temporal das evidências, prevenção de reuso de fotos antigas e otimização de armazenamento.

**Critério de Aceite**:
- Foto com metadados EXIF e data dentro de 3 dias → Upload aceito
- Foto sem metadados EXIF → Erro: "Imagem sem metadados EXIF; foto rejeitada"
- Foto com data >3 dias antes da OS → Aviso: "Foto capturada há X dias" (mas upload permitido)
- Imagens >1920x1080 automaticamente redimensionadas

**Prioridade**: MÉDIA

---

### RN-RF077-010: Relatórios de Produtividade por Técnico e Período

**Descrição**: Sistema gera automaticamente relatórios consolidados por técnico (diário, semanal, mensal) contendo: total de OS, total de OS concluídas, taxa de completamento, tempo médio de atendimento, conformidade com SLA, taxa de retrabalho e custo total de materiais. Relatórios baseiam-se APENAS em dados auditados de OS com status "Concluída".

**Justificativa**: Inteligência operacional para decisões de contratação/treinamento, identificação de problemas de produtividade e conformidade regulatória (ISO 20000).

**Critério de Aceite**:
- Relatório de João (01-30 Nov): 20 OS criadas, 18 concluídas (90%), tempo médio 90 min, SLA 95% conforme
- Dados de OS em rascunho/pendente não devem ser incluídos no cálculo
- Relatório deve ser exportável (formato definido na implementação)

**Prioridade**: MÉDIA

---

## 6. ESTADOS DA ENTIDADE

| Estado | Descrição | Edição Permitida? |
|--------|-----------|-------------------|
| Rascunho | OS criada, ainda não enviada para aprovação | Sim |
| Pendente Aprovação | Aguardando aprovação de supervisor/gerente | Não (apenas aprovar/cancelar) |
| Aprovada | Aprovada, pronta para agendamento | Apenas agendamento |
| Agendada | Data/hora/técnico definidos | Apenas iniciar execução |
| Em Execução | Técnico executando atividades | Apenas pausa/retomada/conclusão |
| Concluída | Finalizada com assinatura digital | Não (terminal - apenas leitura) |
| Cancelada | Cancelada antes da conclusão | Não (terminal - apenas leitura) |

### Transições Permitidas

| De | Para |
|----|------|
| Rascunho | Pendente Aprovação, Cancelada |
| Pendente Aprovação | Aprovada, Cancelada |
| Aprovada | Agendada, Cancelada |
| Agendada | Em Execução, Cancelada |
| Em Execução | Concluída, Cancelada |
| Concluída | (nenhuma - terminal) |
| Cancelada | (nenhuma - terminal) |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre | Dados incluídos |
|--------|---------------|-----------------|
| os.criada | Após criação de nova OS | OS ID, tipo, ativo, técnico, descrição |
| os.aprovada | Após aprovação por supervisor | OS ID, aprovador, timestamp |
| os.agendada | Após definição de data/hora/técnico | OS ID, data/hora, técnico, duração estimada |
| os.execucao_iniciada | Após técnico iniciar execução | OS ID, timestamp início, técnico |
| os.pausada | Após registro de pausa | OS ID, motivo, timestamp pausa |
| os.retomada | Após retomada de execução | OS ID, timestamp retomada |
| os.concluida | Após conclusão com assinatura | OS ID, duração real, assinatura (hash), timestamp |
| os.cancelada | Após cancelamento | OS ID, motivo, usuário responsável |
| os.material_consumido | Após registro de material | OS ID, material ID, quantidade, preço |
| os.foto_anexada | Após upload de foto | OS ID, arquivo, metadados EXIF, timestamp |
| os.sla_violado | Quando prazo de SLA é excedido | OS ID, SLA ID, tempo resposta real vs esperado |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant (ClienteId)
- Nenhuma regra de negócio pode ser ignorada
- Erros devem ser previsíveis, rastreáveis e retornar HTTP codes apropriados (400 para validação, 403 para permissão, 404 para not found)
- Auditoria deve registrar quem (usuário), quando (timestamp UTC), o que mudou (campos alterados com valores anterior/novo)
- Todos os campos obrigatórios devem ser validados no backend (não confiar apenas em frontend)
- Multi-tenancy deve ser aplicado em TODAS as queries (filtro automático por ClienteId)
- Assinatura digital deve incluir hash SHA-256 para verificação de integridade
- Fotos devem ser validadas quanto a metadados EXIF antes do armazenamento

---

## 9. SEGURANÇA

- **Autenticação**: OAuth 2.0 com token JWT obrigatório em todos os endpoints
- **Autorização**: RBAC com validação de permissões por operação (osv:os:create, osv:os:read, osv:os:update, osv:os:delete, osv:os:agendar, osv:os:executar, osv:os:concluir)
- **Isolamento Multi-tenant**: Filtro automático por ClienteId em todas as queries
- **Validação de Entrada**: Sanitização de strings, validação de tipos, limites de tamanho (ex: descrição max 5000 chars)
- **Proteção contra Injeção**: Sanitização de SQL, validação de XSS em campos de texto
- **Rate Limiting**: Limite de 100 requisições/minuto por usuário
- **CORS Restritivo**: Apenas domínios autorizados podem fazer requisições
- **HTTPS Obrigatório**: TLS 1.3+ para todas as comunicações
- **Hash de Assinatura**: SHA-256 para verificação de integridade de assinaturas
- **Criptografia de Fotos**: Blob storage com chave de criptografia por cliente
- **Logging de Acesso**: Auditoria completa de todas as ações (usuário, timestamp, IP, mudanças)

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- **MD-RF077.md** - Modelo de Dados (Tabelas: OrdensSevico, ChecklistItems, RegistroPausaRetomada, MaterialConsumido, AssinaturaDigital, FotosEvidencia)
- **UC-RF077.md** - Casos de Uso (UC00-UC04: Listar, Criar, Visualizar, Editar, Agendar, Executar, Concluir)
- **WF-RF077.md** - Fluxo de Trabalho (Telas, Estados, Componentes Angular)
- **user-stories.yaml** - User Stories (US-RF077-001 a US-RF077-006)
- **TC-RF077-BACKEND.md** - Casos de Teste Backend
- **TC-RF077-FRONTEND.md** - Casos de Teste Frontend
- **TC-RF077-E2E.md** - Casos de Teste E2E
- **TC-RF077-SEGURANCA.md** - Casos de Teste de Segurança

---

## 11. RASTREABILIDADE

| Artefato | Status | Caminho |
|----------|--------|---------|
| Modelo de Dados (MD-RF077.md) | Pendente | `./MD-RF077-Ordens-Servico-Atendimento.md` |
| Casos de Uso (UC-RF077.md) | Pendente | `./UC-RF077-Ordens-Servico-Atendimento.md` |
| Fluxo de Trabalho (WF-RF077.md) | Pendente | `./WF-RF077-Ordens-Servico-Atendimento.md` |
| User Stories (user-stories.yaml) | Pendente | `./user-stories.yaml` |
| Testes Backend (TC-RF077-BACKEND.md) | Pendente | `./Testes/TC-RF077-BACKEND.md` |
| Testes Frontend (TC-RF077-FRONTEND.md) | Pendente | `./Testes/TC-RF077-FRONTEND.md` |
| Testes E2E (TC-RF077-E2E.md) | Pendente | `./Testes/TC-RF077-E2E.md` |
| Testes Segurança (TC-RF077-SEGURANCA.md) | Pendente | `./Testes/TC-RF077-SEGURANCA.md` |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-01-14 | Migração v1.0 → v2.0: Remoção completa de código C# e SQL, conversão para linguagem natural, reestruturação em 11 seções obrigatórias (Governança v2.0), separação estrita RF (contrato moderno) vs RL (legado) | Agência ALC - alc.dev.br |
| 1.0 | 2025-12-28 | Versão inicial com código C# e SQL misturados (violação Governança v2.0) | IControlIT Architect Agent |

---

**Última Atualização**: 2025-01-14
**Autor**: Agência ALC - alc.dev.br
**Revisão**: Pendente Aprovação
**Status**: RF v2.0 Limpo (SEM código) - Pronto para criação de RL-RF077.md
