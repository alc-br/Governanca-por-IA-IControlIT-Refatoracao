# RF102: Relatórios e Análises

**Versao**: 1.0 | **Data**: 2025-12-28
**RF Relacionado**: RF103, RF099, RF094 | **EPIC**: EPIC011-INT-Integracoes
**Fase**: Fase 6 - Ativos, Auditoria e Integrações

---

## 1. RESUMO EXECUTIVO

### 1.1 Descricao Geral

O módulo de **Relatórios e Análises** (RF102) do sistema IControlIT é responsável pela geração, personalização, agendamento e distribuição de relatórios analíticos e gerenciais. Este módulo permite que usuários criem relatórios dinâmicos utilizando um designer visual intuitivo, agendem execuções periódicas, exportem dados em múltiplos formatos (PDF, Excel, CSV, JSON, XML) e recebam automaticamente os resultados via e-mail.

O RF102 integra-se com diversos módulos do sistema (Ativos, Contratos, Faturas, Chamados, SLA, Auditoria) para consolidar dados operacionais e gerenciais, fornecendo insights acionáveis para a tomada de decisão. Utiliza processamento assíncrono (Hangfire) para relatórios volumosos e mantém histórico de execuções por 90 dias para rastreabilidade.

### 1.2 Importancia Estrategica

O módulo de Relatórios é crítico para:

- **Conformidade e Auditoria**: Geração de relatórios de auditoria e compliance conforme LGPD, com rastreabilidade completa de todas as execuções
- **Eficiência Operacional**: Automatização de relatórios recorrentes elimina retrabalho manual e garante consistência dos dados
- **Inteligência Empresarial**: Relatórios analíticos com drill-down permitem análise profunda de tendências, custos e performance
- **Governança**: Controle de acesso granular e justificativa de acesso a dados sensíveis garantem governança de dados
- **Escalabilidade**: Processamento assíncrono permite gerar relatórios com 100mil+ registros sem impactar performance da aplicação

### 1.3 Conceitos Fundamentais

**Relatório**: Conjunto estruturado de dados apresentados em formato tabular, gráfico ou narrativo. Pode ser predefinido (template fornecido pelo sistema) ou personalizado (criado pelo usuário).

- Exemplos: Relatório de Ativos por Departamento, Relatório de Custos por Centro, Análise de SLA por Serviço
- Diferencia-se de Dashboard por ser estático e focado em análise histórica (ex: "custos do mês passado")

**Designer Visual**: Interface para seleção de campos, filtros e formatação de relatórios sem necessidade de conhecimento técnico ou SQL.

- Permite seleção de até 20 campos por relatório
- Oferece filtros pré-configurados por módulo (data, status, departamento, etc)
- Gera preview em tempo real

**Agendamento**: Configuração de execução automática periódica (diária, semanal, mensal) com envio automático por e-mail.

- Máximo 10 relatórios agendados por usuário
- Suporta distribuição para múltiplos destinatários
- Permite configuração de horário específico

**Export**: Conversão de relatório para formato persistente (PDF, Excel, CSV, JSON, XML) para compartilhamento ou análise offline.

- PDF inclui logo do cliente e informações de geração (data/hora, usuário)
- Excel preserva formatação e permite análise com pivot tables
- CSV e JSON para integração com ferramentas externas

**Histórico**: Registro de todas as execuções anteriores de um relatório com links para download dos arquivos gerados.

- Mantido por 90 dias conforme política de retenção
- Permite rastrear quem gerou o relatório e em qual data/hora
- Suporta re-download de relatórios antigos

### 1.4 Legado vs Modernizado

| Aspecto | Legado (VB.NET) | Modernizado (.NET 10 + Angular) |
|---------|-----------------|--------------------------------|
| **Designer de Relatórios** | Crystal Reports (complexo, requer conhecimento técnico) | Visual Drag-and-Drop (intuitivo, sem código) |
| **Processamento** | Síncrono (bloqueia tela) | Assíncrono via Hangfire (background jobs) |
| **Formatos de Export** | PDF e Excel apenas | PDF, Excel, CSV, JSON, XML |
| **Agendamento** | Via SQL Agent (difícil de configurar) | UI integrada (simples) |
| **Multi-tenancy** | Banco de dados global | ClienteId em todas as queries |
| **Auditoria** | Logs manuais | Auditoria automática integrada |
| **LGPD Compliance** | Nenhuma justificativa de acesso | Obrigatória para dados sensíveis |
| **Performance** | Slow (bloqueante) | Fast (assíncrono + cache) |

### 1.5 Funcionalidades Principais

1. **Criação de Relatórios Personalizados** - Designer visual permite seleção de até 20 campos, aplicação de filtros, ordenação e formatação
2. **Relatórios Predefinidos** - Templates prontos para cada módulo (Ativos, Contratos, Faturas, Chamados, SLA)
3. **Agendamento de Execuções** - Permite agendar até 10 relatórios recorrentes (diário, semanal, mensal) por usuário
4. **Export Multi-Formato** - Exporta para PDF (com logo), Excel (com formatação), CSV, JSON e XML
5. **Envio Automático por E-mail** - Agendamentos podem distribuir relatório para múltiplos destinatários automaticamente
6. **Histórico de Execuções** - Rastreia todas as execuções anteriores, usuário, data/hora e links para download
7. **Drill-Down e Análise** - Relatórios analíticos permitem clicar em dados para análise profunda
8. **Filtros Parametrizados** - Parâmetros dinâmicos permitem reutilizar mesmo relatório com diferentes filtros
9. **Processamento em Background** - Relatórios com > 10mil registros processados assincronamente via Hangfire
10. **Compliance LGPD** - Relatórios com dados sensíveis exigem justificativa de acesso; auditoria de todas as execuções

---

## 2. REGRAS DE NEGOCIO

### RN-REL-102-01: Relatório deve ter no mínimo 1 campo selecionado

**Descricao**: Um relatório válido deve ter pelo menos um campo de dados selecionado para exibição. Campos de filtro não contam.

**Justificativa**: Um relatório sem campos de dados é inútil. Esta validação evita criação de relatórios vazios que causam confusão aos usuários.

**Implementacao**:
```csharp
public class CreateRelatórioCommand : IRequest<Result<RelatórioDto>>
{
    public int ClienteId { get; set; }
    public string Nome { get; set; }
    public List<string> CamposSelecionados { get; set; }
    public List<FiltroRelatório> Filtros { get; set; }
}

public class CreateRelatórioCommandHandler : IRequestHandler<CreateRelatórioCommand, Result<RelatórioDto>>
{
    public async Task<Result<RelatórioDto>> Handle(CreateRelatórioCommand request, CancellationToken cancellationToken)
    {
        // Validar: mínimo 1 campo selecionado
        if (request.CamposSelecionados == null || request.CamposSelecionados.Count < 1)
        {
            return Result.Failure($"Relatório deve ter no mínimo 1 campo selecionado");
        }

        var relatorio = new Relatório
        {
            ClienteId = request.ClienteId,
            Nome = request.Nome,
            CamposSelecionados = request.CamposSelecionados,
            Filtros = request.Filtros,
            DataCriacao = DateTime.UtcNow
        };

        await _repository.AddAsync(relatorio, cancellationToken);
        return Result.Success(MapToDto(relatorio));
    }
}
```

**Exemplos**:
- **Válido**: Relatório "Ativos por Departamento" com campos [Nome do Ativo, Departamento, Valor] = 3 campos
- **Inválido**: Relatório "Análise" com CamposSelecionados vazio ou null

---

### RN-REL-102-02: Relatórios sensíveis exigem justificativa (LGPD)

**Descricao**: Quando um relatório incluir dados pessoais ou sensíveis (CPF, RG, Salário, Endereço), o usuário deve fornecer uma justificativa comercial antes de gerar. A justificativa é auditada.

**Justificativa**: LGPD exige consentimento e justificativa documentada para acesso a dados sensíveis. Esta regra garante rastreabilidade e conformidade legal.

**Implementacao**:
```csharp
public class ExecutarRelatórioCommand : IRequest<Result<ArquivoRelatórioDto>>
{
    public int ClienteId { get; set; }
    public int RelatórioId { get; set; }
    public Dictionary<string, string> ParametrosFiltro { get; set; }
    public string JustificativaLGPD { get; set; }  // Obrigatória se dados sensíveis
}

public class ExecutarRelatórioCommandHandler : IRequestHandler<ExecutarRelatórioCommand, Result<ArquivoRelatórioDto>>
{
    public async Task<Result<ArquivoRelatórioDto>> Handle(ExecutarRelatórioCommand request, CancellationToken cancellationToken)
    {
        var relatorio = await _repository.GetByIdAsync(request.RelatórioId, cancellationToken);

        // Verificar se contém dados sensíveis
        bool temDadosSensiveis = relatorio.CamposSelecionados.Any(c =>
            _camposSensiveis.Contains(c) // CPF, Salário, RG, etc
        );

        if (temDadosSensiveis && string.IsNullOrWhiteSpace(request.JustificativaLGPD))
        {
            return Result.Failure("Relatório com dados sensíveis exige justificativa LGPD");
        }

        // Auditar acesso
        var auditoria = new AuditoriaRelatório
        {
            ClienteId = request.ClienteId,
            RelatórioId = request.RelatórioId,
            UsuarioId = _currentUser.Id,
            DataExecucao = DateTime.UtcNow,
            JustificativaLGPD = request.JustificativaLGPD,
            CamposSensiveisAcessados = temDadosSensiveis
        };

        await _auditoriaRepository.AddAsync(auditoria, cancellationToken);

        // Processar relatório...
        return await ProcessarRelatório(request, cancellationToken);
    }
}
```

**Exemplos**:
- **Válido**: Relatório "Folha de Pagamento" com justificativa "Análise de custos RH para 2025"
- **Inválido**: Mesmo relatório sem justificativa

---

### RN-REL-102-03: Agendamento máximo 10 relatórios por usuário

**Descricao**: Um usuário pode agendar no máximo 10 relatórios recorrentes simultaneamente. Ao tentar agendar o 11º, deve ser oferecido para cancelar um dos agendados.

**Justificativa**: Previne abuso de recursos (executar 100+ relatórios diários consumiria muito processamento). 10 é um limite razoável para uso legítimo.

**Implementacao**:
```csharp
public class AgendasRelatórioCommand : IRequest<Result<AgendamentoRelatórioDto>>
{
    public int ClienteId { get; set; }
    public int RelatórioId { get; set; }
    public FrequenciaAgendamento Frequencia { get; set; } // Diário, Semanal, Mensal
    public TimeSpan HorarioExecucao { get; set; }
    public List<string> EmailsDestinatarios { get; set; }
}

public enum FrequenciaAgendamento
{
    Diário = 1,
    Semanal = 2,
    Mensal = 3
}

public class AgendasRelatórioCommandHandler : IRequestHandler<AgendasRelatórioCommand, Result<AgendamentoRelatórioDto>>
{
    public async Task<Result<AgendamentoRelatórioDto>> Handle(AgendasRelatórioCommand request, CancellationToken cancellationToken)
    {
        var usuarioId = _currentUser.Id;

        // Contar agendamentos ativos do usuário
        var agendamentosAtivos = await _repository.CountAsync(
            a => a.ClienteId == request.ClienteId
                 && a.UsuarioId == usuarioId
                 && a.Ativo == true,
            cancellationToken
        );

        if (agendamentosAtivos >= 10)
        {
            return Result.Failure(
                "Você já possui 10 relatórios agendados (limite máximo). " +
                "Cancele um dos agendados para agendar um novo."
            );
        }

        var agendamento = new AgendamentoRelatório
        {
            ClienteId = request.ClienteId,
            RelatórioId = request.RelatórioId,
            UsuarioId = usuarioId,
            Frequencia = request.Frequencia,
            HorarioExecucao = request.HorarioExecucao,
            EmailsDestinatarios = request.EmailsDestinatarios,
            Ativo = true,
            DataCriacao = DateTime.UtcNow
        };

        await _repository.AddAsync(agendamento, cancellationToken);
        return Result.Success(MapToDto(agendamento));
    }
}
```

**Exemplos**:
- **Válido**: Usuário com 5 agendamentos ativos agenda o 6º
- **Inválido**: Usuário com 10 agendamentos tenta agendar o 11º

---

### RN-REL-102-04: Relatórios com > 10.000 registros processados em background (Hangfire)

**Descricao**: Quando um relatório retorna mais de 10.000 registros após aplicação de filtros, deve ser processado assincronamente via Hangfire em vez de síncrono. Usuário recebe notificação quando pronto.

**Justificativa**: Relatórios grandes bloqueiam a tela durante alguns minutos. Hangfire evita timeout do HTTP e oferece melhor UX. Limite de 10mil é onde o tempo aproxima 30 segundos.

**Implementacao**:
```csharp
public class ExecutarRelatórioSyncHandler
{
    public async Task<Result<ArquivoRelatórioDto>> Handle(ExecutarRelatórioCommand request, CancellationToken cancellationToken)
    {
        var relatorio = await _repository.GetByIdAsync(request.RelatórioId, cancellationToken);

        // Estimar tamanho do resultado
        int estimatedRows = await EstimarRegistros(relatorio, request.ParametrosFiltro, cancellationToken);

        if (estimatedRows > 10000)
        {
            // Agendar no Hangfire
            var jobId = BackgroundJob.Enqueue<ExecutarRelatórioBackgroundJob>(
                job => job.Execute(
                    request.ClienteId,
                    request.RelatórioId,
                    request.ParametrosFiltro,
                    request.JustificativaLGPD,
                    _currentUser.Id
                )
            );

            return Result.Success(new ArquivoRelatórioDto
            {
                Id = 0,
                JobId = jobId,
                Status = "Processando",
                Mensagem = $"Relatório em processamento. Job ID: {jobId}"
            });
        }
        else
        {
            // Processar sincronamente (< 10 segundos)
            return await ProcessarRelatórioSincrono(request, cancellationToken);
        }
    }

    private async Task<int> EstimarRegistros(Relatório relatorio, Dictionary<string, string> filtros, CancellationToken cancellationToken)
    {
        // Query simplificada para contar registros sem trazer todos
        var query = _BuildQueryComFiltros(relatorio, filtros);
        return await query.CountAsync(cancellationToken);
    }
}

public class ExecutarRelatórioBackgroundJob
{
    public async Task Execute(
        int clienteId, int relatórioId, Dictionary<string, string> parametros,
        string justificativaLgpd, int usuarioId)
    {
        try
        {
            var relatorio = await _repository.GetByIdAsync(relatórioId);
            var dados = await _repository.ExecutarRelatório(relatorio, parametros, clienteId);

            var arquivo = await ExportarPDF(dados, relatorio);

            // Salvar em storage
            await _storage.UploadAsync($"relatorios/{clienteId}/{relatórioId}/{DateTime.Now:yyyyMMdd_HHmmss}.pdf", arquivo);

            // Notificar usuário
            await _notificationService.EnviarNotificacao(usuarioId, $"Relatório {relatorio.Nome} pronto para download");
        }
        catch (Exception ex)
        {
            // Log e notificar erro
            _logger.LogError(ex, $"Erro ao processar relatório {relatórioId}");
        }
    }
}
```

**Exemplos**:
- **Síncrono**: Relatório "Top 100 Ativos" com 1.500 registros (rápido)
- **Assíncrono**: Relatório "Auditoria Completa" com 50.000 registros (usa Hangfire)

---

### RN-REL-102-05: Export PDF deve ter logo do cliente e data/hora de geração

**Descricao**: Quando um relatório é exportado para PDF, o arquivo deve incluir cabeçalho com logo do cliente (obtido de RF017 ou configuração), título do relatório, data/hora de geração e nome do usuário que gerou.

**Justificativa**: PDFs corporativos devem ter identidade visual. Data/hora garante rastreabilidade. Nome do usuário é exigido por auditoria.

**Implementacao**:
```csharp
public class ExportarRelatórioPdfCommand : IRequest<Result<byte[]>>
{
    public int ClienteId { get; set; }
    public int RelatórioId { get; set; }
    public Dictionary<string, string> ParametrosFiltro { get; set; }
}

public class ExportarRelatórioPdfCommandHandler : IRequestHandler<ExportarRelatórioPdfCommand, Result<byte[]>>
{
    public async Task<Result<byte[]>> Handle(ExportarRelatórioPdfCommand request, CancellationToken cancellationToken)
    {
        var relatorio = await _repository.GetByIdAsync(request.RelatórioId, cancellationToken);
        var dados = await _repository.ExecutarRelatório(relatorio, request.ParametrosFiltro, request.ClienteId, cancellationToken);

        // Obter logo do cliente
        var logoCliente = await _clienteService.GetLogoAsync(request.ClienteId, cancellationToken);
        var usuarioAtual = _currentUser.Nome;

        using (var ms = new MemoryStream())
        {
            var doc = new Document();
            var writer = PdfWriter.GetInstance(doc, ms);

            doc.Open();

            // Cabeçalho com logo
            if (logoCliente != null)
            {
                var img = Image.GetInstance(logoCliente);
                img.ScaleToFit(100, 50);
                img.Alignment = Element.ALIGN_LEFT;
                doc.Add(img);
            }

            // Título e metadados
            var titulo = new Paragraph(relatorio.Nome, new Font(Font.HELVETICA, 16, Font.BOLD));
            titulo.Alignment = Element.ALIGN_CENTER;
            doc.Add(titulo);

            var metadata = new Paragraph(
                $"Gerado em: {DateTime.Now:dd/MM/yyyy HH:mm:ss} | Usuário: {usuarioAtual}",
                new Font(Font.HELVETICA, 10, Font.ITALIC)
            );
            metadata.Alignment = Element.ALIGN_RIGHT;
            doc.Add(metadata);

            doc.Add(new Paragraph(" ")); // Espaço

            // Tabela de dados
            var table = new PdfPTable(relatorio.CamposSelecionados.Count);

            foreach (var campo in relatorio.CamposSelecionados)
            {
                var cell = new PdfPCell(new Phrase(campo, new Font(Font.HELVETICA, 10, Font.BOLD)));
                cell.BackgroundColor = BaseColor.LIGHT_GRAY;
                table.AddCell(cell);
            }

            foreach (var linha in dados)
            {
                foreach (var campo in relatorio.CamposSelecionados)
                {
                    table.AddCell(new Paragraph(linha[campo]?.ToString() ?? "", new Font(Font.HELVETICA, 10)));
                }
            }

            doc.Add(table);
            doc.Close();

            return Result.Success(ms.ToArray());
        }
    }
}
```

**Exemplos**:
- **Válido**: PDF exportado com logo, "Relatório de Ativos | 28/12/2025 14:30:00 | Usuário: João Silva"
- **Inválido**: PDF sem logo ou sem data/hora

---

### RN-REL-102-06: Relatórios com dados pessoais exigem permissão especial (lgpd:relatorio:dados-sensiveis)

**Descricao**: Para criar ou executar relatórios que incluam dados pessoais (CPF, RG, Endereço, Telefone, Salário), o usuário deve ter a permissão `lgpd:relatorio:dados-sensiveis`. Usuários sem permissão não veem estes campos no designer.

**Justificativa**: Restrição de acesso previne exposição acidental de dados pessoais a usuários que não precisam. LGPD exige este controle de acesso granular.

**Implementacao**:
```csharp
[ApiController]
[Route("api/relatorios")]
public class RelatóriosController : ControllerBase
{
    [HttpGet("campos-disponiveis/{modulo}")]
    [Authorize]
    public async Task<IActionResult> GetCamposDisponiveis(string modulo, CancellationToken cancellationToken)
    {
        var usuario = _currentUser;

        var camposBase = _GetCamposPorModulo(modulo);

        // Filtrar campos sensíveis se usuário não tem permissão
        if (!usuario.Permissions.Contains("lgpd:relatorio:dados-sensiveis"))
        {
            camposBase = camposBase
                .Where(c => !_camposSensiveis.Contains(c.Nome))
                .ToList();
        }

        return Ok(camposBase);
    }

    [HttpPost]
    [Authorize(Policy = "relatorio:create")]
    public async Task<IActionResult> CreateRelatório(CreateRelatórioCommand command, CancellationToken cancellationToken)
    {
        // Validar permissão para campos sensíveis
        var temCamposSensiveis = command.CamposSelecionados.Any(c => _camposSensiveis.Contains(c));

        if (temCamposSensiveis && !_currentUser.Permissions.Contains("lgpd:relatorio:dados-sensiveis"))
        {
            return Forbid($"Você não tem permissão para criar relatórios com dados sensíveis (CPF, RG, Salário, etc)");
        }

        var result = await _mediator.Send(command, cancellationToken);
        return Ok(result);
    }
}

public static class CamposSensiveis
{
    public static readonly string[] Campos = new[]
    {
        "CPF",
        "RG",
        "Salário",
        "Endereço",
        "Telefone",
        "Email",
        "DataNascimento",
        "NomeMãe",
        "Dependentes"
    };
}
```

**Exemplos**:
- **Válido**: Usuário com `lgpd:relatorio:dados-sensiveis` vê e seleciona campo "CPF"
- **Inválido**: Mesmo usuário sem a permissão não vê o campo "CPF" no designer

---

### RN-REL-102-07: Histórico de relatórios mantido por 90 dias

**Descricao**: Todas as execuções de um relatório são registradas com data, hora, usuário, filtros utilizados e link para download. Este histórico é mantido por 90 dias. Após 90 dias, registros antigos e seus arquivos são automaticamente deletados.

**Justificativa**: Conformidade com políticas de retenção de dados. Evita acúmulo indefinido de arquivos na storage. Permite rastreabilidade recente.

**Implementacao**:
```csharp
public class HistóricoRelatório
{
    public int Id { get; set; }
    public int ClienteId { get; set; }
    public int RelatórioId { get; set; }
    public int UsuarioId { get; set; }
    public DateTime DataExecucao { get; set; }
    public Dictionary<string, string> FiltrosUtilizados { get; set; }
    public string UrlDownload { get; set; }
    public long TamanoArquivo { get; set; }
    public DateTime? DataExpiracao { get; set; } = DateTime.UtcNow.AddDays(90);
}

[ApiController]
[Route("api/relatorios/{relatórioId}/historico")]
public class HistóricoRelatórioController : ControllerBase
{
    [HttpGet]
    [Authorize(Policy = "relatorio:read")]
    public async Task<IActionResult> GetHistórico(int relatórioId, CancellationToken cancellationToken)
    {
        var historico = await _repository.GetHistóricoAtivo(relatórioId, _currentUser.ClienteId, cancellationToken);
        return Ok(historico);
    }
}

public class LimparHistóricoExpiradoJob
{
    [RecurringJob("*/1 * * * *")]  // A cada 1 minuto
    public async Task Execute()
    {
        var hoje = DateTime.UtcNow;

        // Deletar registros expirados
        var registrosExpirados = await _repository.GetAsync(
            h => h.DataExpiracao.HasValue && h.DataExpiracao.Value < hoje
        );

        foreach (var registro in registrosExpirados)
        {
            // Deletar arquivo da storage
            await _storage.DeleteAsync($"relatorios/{registro.ClienteId}/{registro.RelatórioId}/{registro.Id}.pdf");

            // Deletar registro
            await _repository.DeleteAsync(registro);
        }

        _logger.LogInformation($"Limpeza de histórico: {registrosExpirados.Count} registros deletados");
    }
}
```

**Exemplos**:
- **Válido**: Relatório gerado em 01/10/2025 é deletado automaticamente em 30/12/2025
- **Inválido**: Arquivo mantido indefinidamente na storage

---

### RN-REL-102-08: Relatórios devem respeitar filtro multi-tenancy (ClienteId)

**Descricao**: Todos os relatórios devem incluir filtro automático por ClienteId. Um usuário só pode ver e gerar relatórios dos clientes aos quais tem acesso. Dados de outros clientes nunca devem aparecer.

**Justificativa**: Multi-tenancy é crítico para SaaS. ClienteId deve estar em todas as queries para garantir isolamento de dados.

**Implementacao**:
```csharp
public class ExecutarRelatórioSyncHandler : IRequestHandler<ExecutarRelatórioCommand>
{
    public async Task<Result<ArquivoRelatórioDto>> Handle(ExecutarRelatórioCommand request, CancellationToken cancellationToken)
    {
        // Validar que usuário tem acesso ao ClienteId
        var usuarioTemAcesso = await _usuarioService.TemAcessoAoCliente(
            _currentUser.Id, request.ClienteId, cancellationToken
        );

        if (!usuarioTemAcesso)
        {
            return Result.Failure($"Você não tem acesso ao cliente {request.ClienteId}");
        }

        var relatorio = await _repository.GetByIdAsync(request.RelatórioId, cancellationToken);

        // Garantir que ClienteId está nos filtros
        var filtrosComClienteId = new List<FiltroRelatório>(request.ParametrosFiltro);
        filtrosComClienteId.Add(new FiltroRelatório { Campo = "ClienteId", Valor = request.ClienteId.ToString() });

        var dados = await _BuildQuery(relatorio, filtrosComClienteId, cancellationToken);

        return Result.Success(dados);
    }
}

public class ObterRelatóriosUsuárioHandler : IRequestHandler<ObterRelatóriosUsuárioQuery, Result<List<RelatórioDto>>>
{
    public async Task<Result<List<RelatórioDto>>> Handle(ObterRelatóriosUsuárioQuery request, CancellationToken cancellationToken)
    {
        // Sempre filtrar por ClienteId do usuário
        var relatorios = await _repository.GetAsync(
            r => r.ClienteId == request.ClienteId,
            cancellationToken
        );

        return Result.Success(relatorios.Select(MapToDto).ToList());
    }
}
```

**Exemplos**:
- **Válido**: Usuário da Cliente A vê apenas relatórios de Cliente A
- **Inválido**: Query sem filtro por ClienteId, expondo dados de múltiplos clientes

---

### RN-REL-102-09: Designer visual limitado a 20 campos por relatório

**Descricao**: No designer visual, o usuário pode selecionar no máximo 20 campos para incluir no relatório. Acima disso, a operação é rejeitada com mensagem clara.

**Justificativa**: Relatórios com muitos campos ficam ilegíveis. 20 campos é um limite razoável que cabe em uma página A4 ou planilha Excel. Força usuários a pensarem em o que realmente precisam.

**Implementacao**:
```csharp
public class CreateRelatórioCommand : IRequest<Result<RelatórioDto>>
{
    public int ClienteId { get; set; }
    public string Nome { get; set; }
    public List<string> CamposSelecionados { get; set; }
    public List<FiltroRelatório> Filtros { get; set; }
}

public class CreateRelatórioCommandValidator : AbstractValidator<CreateRelatórioCommand>
{
    public CreateRelatórioCommandValidator()
    {
        RuleFor(x => x.CamposSelecionados)
            .NotEmpty().WithMessage("Selecione pelo menos 1 campo")
            .Must(c => c.Count <= 20).WithMessage("Máximo 20 campos permitidos por relatório");
    }
}

[ApiController]
[Route("api/relatorios")]
public class RelatóriosController : ControllerBase
{
    [HttpPost]
    [Authorize(Policy = "relatorio:create")]
    public async Task<IActionResult> Create(CreateRelatórioCommand command, CancellationToken cancellationToken)
    {
        var validationResult = await _validator.ValidateAsync(command, cancellationToken);

        if (!validationResult.IsValid)
        {
            return BadRequest(validationResult.Errors);
        }

        var result = await _mediator.Send(command, cancellationToken);
        return CreatedAtAction(nameof(GetById), new { id = result.Data.Id }, result.Data);
    }
}
```

**Exemplos**:
- **Válido**: Relatório com 15 campos selecionados
- **Inválido**: Tentativa de criar relatório com 25 campos (rejeitado com erro)

---

### RN-REL-102-10: Auditoria obrigatória de todos os relatórios gerados

**Descricao**: Toda execução de um relatório gera um registro de auditoria incluindo: ClienteId, RelatórioId, UsuarioId, DataHora, FiltrosUtilizados, TamanoArquivo, JustificativaLGPD (se aplicável). Este registro é imutável e não pode ser deletado pelo usuário.

**Justificativa**: Conformidade com LGPD exige rastreabilidade. Auditoria imutável prova quem acessou o que, quando e por quê. Crítico para investigações de segurança.

**Implementacao**:
```csharp
public class AuditoriaRelatório
{
    [Key]
    public int Id { get; set; }
    public int ClienteId { get; set; }
    public int RelatórioId { get; set; }
    public int UsuarioId { get; set; }
    public DateTime DataExecucao { get; set; }
    public Dictionary<string, string> FiltrosUtilizados { get; set; }
    public long TamanoArquivo { get; set; }
    public string JustificativaLGPD { get; set; }
    public string IpUsuario { get; set; }
    public string UserAgent { get; set; }
    public DateTime DataCriacao { get; set; } = DateTime.UtcNow;

    // Imutável - sem atualizações
    public override bool Equals(object obj) => false;
}

public class ExecutarRelatórioHandler : IRequestHandler<ExecutarRelatórioCommand>
{
    public async Task<Result<ArquivoRelatórioDto>> Handle(ExecutarRelatórioCommand request, CancellationToken cancellationToken)
    {
        var relatorio = await _repository.GetByIdAsync(request.RelatórioId, cancellationToken);
        var dados = await ExecutarRelatorio(relatorio, request.ParametrosFiltro, cancellationToken);
        var arquivo = await ExportarParaPdf(dados, relatorio, cancellationToken);

        // Registrar auditoria
        var auditoria = new AuditoriaRelatório
        {
            ClienteId = request.ClienteId,
            RelatórioId = request.RelatórioId,
            UsuarioId = _currentUser.Id,
            DataExecucao = DateTime.UtcNow,
            FiltrosUtilizados = request.ParametrosFiltro,
            TamanoArquivo = arquivo.Length,
            JustificativaLGPD = request.JustificativaLGPD,
            IpUsuario = _httpContextAccessor.HttpContext.Connection.RemoteIpAddress.ToString(),
            UserAgent = _httpContextAccessor.HttpContext.Request.Headers["User-Agent"]
        };

        await _auditoriaRepository.AddAsync(auditoria, cancellationToken);

        // Deletar auditoria é PROIBIDO (sem permissão delete)
        // Visibilidade restrita a usuários com audit:read

        return Result.Success(new ArquivoRelatórioDto { /* ... */ });
    }
}

[ApiController]
[Route("api/auditoria/relatorios")]
public class AuditoriaRelatórioController : ControllerBase
{
    [HttpGet]
    [Authorize(Policy = "audit:read")]
    public async Task<IActionResult> GetAuditoria(int relatórioId, CancellationToken cancellationToken)
    {
        var registros = await _repository.GetAsync(
            a => a.RelatórioId == relatórioId && a.ClienteId == _currentUser.ClienteId,
            cancellationToken
        );
        return Ok(registros);
    }

    // DELETE é NUNCA permitido - auditoria é imutável
}
```

**Exemplos**:
- **Válido**: Auditoria registra "Relatório Ativos executado por João às 14:30, 5.234 registros, IP 192.168.1.100"
- **Inválido**: Tentativa de deletar registro de auditoria (Forbid 403)

---

## 3. REFERENCIAS AO LEGADO

### 3.1 Banco de Dados Legado

**Banco**: `IC1_Producao`

**Tabelas Principais**:

```sql
-- Tabela de Relatórios Predefinidos (VB.NET)
CREATE TABLE [dbo].[tblRelatorios](
    [Id_Relatorio] [int] IDENTITY(1,1) NOT NULL,
    [Nm_Relatorio] [varchar](255) NOT NULL,
    [Ds_Relatorio] [text] NULL,
    [Cd_Modulo] [varchar](50) NOT NULL,
    [Tx_SQL] [text] NOT NULL,  -- Query original em texto
    [Dt_Criacao] [datetime] NOT NULL DEFAULT GETDATE(),
    [Bl_Ativo] [bit] NOT NULL DEFAULT 1,
    CONSTRAINT [PK_tblRelatorios] PRIMARY KEY CLUSTERED ([Id_Relatorio] ASC)
);

-- Tabela de Agendamentos (VB.NET)
CREATE TABLE [dbo].[tblAgendamentos](
    [Id_Agendamento] [int] IDENTITY(1,1) NOT NULL,
    [Id_Relatorio] [int] NOT NULL,
    [Cd_Usuario] [int] NOT NULL,
    [Cd_Frequencia] [int] NOT NULL,  -- 1=Diário, 2=Semanal, 3=Mensal
    [Hr_Execucao] [time] NOT NULL,
    [Tx_Email] [varchar](max) NULL,
    [Bl_Ativo] [bit] NOT NULL DEFAULT 1,
    [Dt_Criacao] [datetime] NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_tblAgendamentos] PRIMARY KEY CLUSTERED ([Id_Agendamento] ASC),
    CONSTRAINT [FK_tblAgendamentos_tblRelatorios] FOREIGN KEY ([Id_Relatorio])
        REFERENCES [tblRelatorios]([Id_Relatorio])
);

-- Tabela de Histórico (VB.NET)
CREATE TABLE [dbo].[tblHistoricoRelatorios](
    [Id_Historico] [int] IDENTITY(1,1) NOT NULL,
    [Id_Relatorio] [int] NOT NULL,
    [Cd_Usuario] [int] NOT NULL,
    [Dt_Execucao] [datetime] NOT NULL DEFAULT GETDATE(),
    [Tx_Filtros] [text] NULL,
    [Nm_Arquivo] [varchar](500) NULL,
    [Tm_Arquivo] [bigint] NULL,
    CONSTRAINT [PK_tblHistoricoRelatorios] PRIMARY KEY CLUSTERED ([Id_Historico] ASC)
);
```

**Campos Importantes**:

| Campo Legado | Descricao | Uso no Modernizado |
|--------------|-----------|-------------------|
| `[Nm_Relatorio]` | Nome do relatório | Migrado para `Relatório.Nome` |
| `[Cd_Modulo]` | Código do módulo (EST, CON, FAT, CHM) | Migrado para `Relatório.Módulo` (enum) |
| `[Tx_SQL]` | Query SQL inline (problema!) | Substituído por LINQ + specification pattern |
| `[Dt_Criacao]` | Data de criação | Migrado para `Relatório.DataCriacao` |
| `[Hr_Execucao]` | Hora do agendamento | Migrado para `AgendamentoRelatório.HorarioExecucao` |
| `[Tx_Email]` | Emails destinatários (string separada por ponto-e-vírgula) | Migrado para `AgendamentoRelatório.EmailsDestinatarios` (List<string>) |

### 3.2 Stored Procedures Legado

| Procedure | Descricao | Migracao |
|-----------|-----------|----------|
| `pa_GerarRelatorioAtivos` | Gera relatório de ativos com filtros | Substituído por `ExecutarRelatórioHandler` + EF Core |
| `pa_ExportarRelatorioExcel` | Exporta relatório para Excel | Substituído por EPPlus library + handler |
| `pa_LimparHistoricoRelatorios` | Deleta histórico com > 90 dias | Substituído por Hangfire recurring job |

### 3.3 Telas ASPX

| Pagina | Descricao | Tela Moderna |
|--------|-----------|--------------|
| `RelatóriosListar.aspx` | Lista relatórios disponíveis | `/relatorios` (Angular) |
| `RelatóriosDesigner.aspx` | Designer visual (Crystal Reports) | `/relatorios/novo` (Angular) |
| `RelatóriosExecutar.aspx` | Executar e visualizar relatório | `/relatorios/{id}/executar` (Angular) |
| `AgendamentosListar.aspx` | Listar agendamentos | `/relatorios/agendamentos` (Angular) |
| `HistoricoRelatorios.aspx` | Ver histórico de execuções | `/relatorios/{id}/historico` (Angular) |

### 3.4 WebServices Legado (VB.NET)

**Arquivo**: `D:\IC2\ic1_legado\WebService\WSRelatorios.asmx.vb`

| Metodo | Descricao | Endpoint Moderno |
|--------|-----------|-----------------|
| `ListarRelatorios()` | Lista todos os relatórios | `GET /api/relatorios` |
| `GetRelatorio(id)` | Obter relatório por ID | `GET /api/relatorios/{id}` |
| `ExecutarRelatorio(id, filtros)` | Executa relatório com filtros | `POST /api/relatorios/{id}/executar` |
| `ExportarPDF(id, filtros)` | Exporta para PDF | `POST /api/relatorios/{id}/export/pdf` |
| `ExportarExcel(id, filtros)` | Exporta para Excel | `POST /api/relatorios/{id}/export/excel` |
| `CriarAgendamento(relId, freq, email)` | Cria agendamento | `POST /api/relatorios/{id}/agendar` |

---

## 4. INTEGRACOES OBRIGATORIAS

### 4.1 Central de Funcionalidades (Feature Flags)

**FeatureKey**: `RELATORIO_DESIGNER_VISUAL`

**Configuracao**:
```json
{
    "featureKey": "RELATORIO_DESIGNER_VISUAL",
    "nome": "Designer Visual de Relatórios",
    "descricao": "Permite criar relatórios personalizados sem código SQL",
    "habilitado": true,
    "isSystemFeature": false
}
```

**FeatureKey**: `RELATORIO_AGENDAMENTO`

```json
{
    "featureKey": "RELATORIO_AGENDAMENTO",
    "nome": "Agendamento de Relatórios",
    "descricao": "Permite agendar execução automática de relatórios",
    "habilitado": true,
    "isSystemFeature": false
}
```

**FeatureKey**: `RELATORIO_BACKGROUND_PROCESSING`

```json
{
    "featureKey": "RELATORIO_BACKGROUND_PROCESSING",
    "nome": "Processamento em Background via Hangfire",
    "descricao": "Relatórios com > 10mil registros processados assincronamente",
    "habilitado": true,
    "isSystemFeature": false
}
```

**FeatureKey**: `RELATORIO_LGPD_COMPLIANCE`

```json
{
    "featureKey": "RELATORIO_LGPD_COMPLIANCE",
    "nome": "Conformidade LGPD em Relatórios",
    "descricao": "Exige justificativa de acesso a dados pessoais",
    "habilitado": true,
    "isSystemFeature": false
}
```

---

### 4.2 Internacionalizacao (i18n)

**Chaves de Traducao**:

```json
{
    "relatorio": {
        "titulo": "Relatórios e Análises",
        "listagem": {
            "titulo": "Meus Relatórios",
            "novo": "Novo Relatório",
            "editar": "Editar",
            "excluir": "Excluir",
            "executar": "Executar",
            "agendar": "Agendar",
            "historico": "Histórico",
            "vazio": "Nenhum relatório encontrado"
        },
        "designer": {
            "titulo": "Designer de Relatórios",
            "camposSelecionados": "Campos Selecionados",
            "camposDisponiveis": "Campos Disponíveis",
            "maxCampos": "Máximo 20 campos",
            "filtros": "Filtros",
            "adicionarFiltro": "Adicionar Filtro",
            "preview": "Preview",
            "salvar": "Salvar Relatório",
            "nomeDoCampo": "Nome do Campo",
            "nomeDoRelatorio": "Nome do Relatório"
        },
        "execucao": {
            "titulo": "Executar Relatório",
            "executando": "Processando...",
            "processandoBackground": "Relatório em processamento (background). Você receberá notificação.",
            "resultados": "Resultados",
            "registrosPorPagina": "Registros por Página",
            "exportar": "Exportar",
            "exportandoPDF": "Gerando PDF...",
            "exportandoExcel": "Gerando Excel...",
            "exportandoCSV": "Gerando CSV..."
        },
        "agendamento": {
            "titulo": "Agendar Relatório",
            "frequencia": "Frequência",
            "diario": "Diário",
            "semanal": "Semanal",
            "mensal": "Mensal",
            "horarioExecucao": "Horário de Execução",
            "emailsDestinatarios": "E-mails Destinatários",
            "adicionarEmail": "Adicionar E-mail",
            "maxAgendamentos": "Você atingiu o máximo de 10 agendamentos",
            "agendar": "Agendar"
        },
        "historico": {
            "titulo": "Histórico de Execuções",
            "data": "Data",
            "usuario": "Usuário",
            "tamanho": "Tamanho",
            "download": "Download",
            "filtrosUtilizados": "Filtros Utilizados",
            "vazio": "Nenhuma execução anterior"
        },
        "validacoes": {
            "minimo1Campo": "Selecione pelo menos 1 campo",
            "maximo20Campos": "Máximo 20 campos permitidos",
            "nomeObrigatorio": "Nome do relatório é obrigatório",
            "justificativaLGPDObrigatoria": "Justificativa LGPD é obrigatória para acessar dados pessoais",
            "selecioneModulo": "Selecione um módulo"
        },
        "mensagens": {
            "relatorioCriado": "Relatório criado com sucesso",
            "relatorioAtualizado": "Relatório atualizado com sucesso",
            "relatorioExcluido": "Relatório excluído com sucesso",
            "relatorioExportado": "Relatório exportado com sucesso",
            "agendamentoCriado": "Agendamento criado com sucesso",
            "agendamentoCancelado": "Agendamento cancelado com sucesso",
            "erro": "Erro ao processar relatório. Tente novamente.",
            "naoTemAcesso": "Você não tem permissão para acessar este relatório"
        },
        "permissoes": {
            "criarRelatorio": "Criar Relatório",
            "editarRelatorio": "Editar Relatório",
            "excluirRelatorio": "Excluir Relatório",
            "executarRelatorio": "Executar Relatório",
            "acessarDadosSensiveis": "Acessar Dados Sensíveis (LGPD)"
        }
    }
}
```

---

### 4.3 Auditoria

**Operacoes Auditadas**:

| Operacao | Codigo | Dados Registrados |
|----------|--------|-------------------|
| Criar Relatório | `REL_RELATORIO_CREATE` | ClienteId, Nome, Módulo, CamposSelecionados, Filtros, UsuarioId |
| Atualizar Relatório | `REL_RELATORIO_UPDATE` | ClienteId, RelatórioId, Campos Alterados (antes/depois), UsuarioId |
| Excluir Relatório | `REL_RELATORIO_DELETE` | ClienteId, RelatórioId, Nome, UsuarioId |
| Executar Relatório | `REL_RELATORIO_EXECUTE` | ClienteId, RelatórioId, FiltrosUtilizados, TamanoArquivo, JustificativaLGPD, UsuarioId, IpUsuario |
| Agendar Relatório | `REL_AGENDAMENTO_CREATE` | ClienteId, RelatórioId, Frequência, EmailsDestinatarios, UsuarioId |
| Cancelar Agendamento | `REL_AGENDAMENTO_CANCEL` | ClienteId, AgendamentoId, UsuarioId |
| Download Histórico | `REL_HISTORICO_DOWNLOAD` | ClienteId, RelatórioId, HistóricoId, UsuarioId, IpUsuario |

**Retencao**: 7 anos (conforme Lei de Acesso à Informação + LGPD)

---

### 4.4 Controle de Acesso (RBAC)

**Permissoes**:

| Permissao | Descricao | Perfis |
|-----------|-----------|--------|
| `relatorio:relatorio:create` | Criar novo relatório | Analista, Gerente, Administrador |
| `relatorio:relatorio:read` | Visualizar relatórios | Analista, Gerente, Administrador, Operador |
| `relatorio:relatorio:update` | Editar relatório | Gerente, Administrador (apenas próprio ou de time) |
| `relatorio:relatorio:delete` | Excluir relatório | Administrador |
| `relatorio:relatorio:execute` | Executar relatório | Analista, Gerente, Administrador, Operador |
| `relatorio:relatorio:export` | Exportar relatório | Analista, Gerente, Administrador, Operador |
| `relatorio:agendamento:create` | Agendar execução | Gerente, Administrador |
| `relatorio:agendamento:manage` | Gerenciar agendamentos | Administrador |
| `lgpd:relatorio:dados-sensiveis` | Acessar dados pessoais em relatórios | Gerente RH, Administrador (restrito) |
| `audit:relatorio:read` | Visualizar auditoria de relatórios | Administrador, Compliance Officer |

**Nota**: Usuários só veem relatórios do seu ClienteId. Administrador vê apenas relatórios do seu cliente.

---

## 5. ENDPOINTS DA API

### 5.1 CRUD Principal

| Metodo | Endpoint | Descricao | Permissao |
|--------|----------|-----------|-----------|
| GET | `/api/relatorios` | Listar relatórios do usuário | `relatorio:relatorio:read` |
| GET | `/api/relatorios/{id}` | Obter definição de relatório | `relatorio:relatorio:read` |
| POST | `/api/relatorios` | Criar novo relatório personalizado | `relatorio:relatorio:create` |
| PUT | `/api/relatorios/{id}` | Atualizar relatório | `relatorio:relatorio:update` |
| DELETE | `/api/relatorios/{id}` | Excluir relatório | `relatorio:relatorio:delete` |

**Exemplos de Request/Response**:

```http
GET /api/relatorios
Authorization: Bearer <token>
ClienteId: 1

HTTP/1.1 200 OK
Content-Type: application/json

[
    {
        "id": 101,
        "nome": "Ativos por Departamento",
        "modulo": "EST",
        "dataUltimaExecucao": "2025-12-27T14:30:00Z",
        "totalExecutacoes": 25
    },
    {
        "id": 102,
        "nome": "Custos de Contratos",
        "modulo": "CON",
        "dataUltimaExecucao": "2025-12-26T10:15:00Z",
        "totalExecutacoes": 12
    }
]
```

```http
POST /api/relatorios
Authorization: Bearer <token>
Content-Type: application/json
ClienteId: 1

{
    "nome": "Análise Mensal de SLA",
    "modulo": "CHA",
    "camposSelecionados": ["Serviço", "SLA Meta", "SLA Atingido", "Taxa Cumprimento"],
    "filtros": [
        {"campo": "DataInicio", "operador": ">=", "valor": "2025-12-01"},
        {"campo": "DataFim", "operador": "<=", "valor": "2025-12-31"}
    ]
}

HTTP/1.1 201 Created
Location: /api/relatorios/205

{
    "id": 205,
    "nome": "Análise Mensal de SLA",
    "modulo": "CHA",
    "dataCriacao": "2025-12-28T14:30:00Z"
}
```

### 5.2 Operacoes Especiais

| Metodo | Endpoint | Descricao | Permissao |
|--------|----------|-----------|-----------|
| POST | `/api/relatorios/{id}/executar` | Executar relatório e retornar dados | `relatorio:relatorio:execute` |
| POST | `/api/relatorios/{id}/export/pdf` | Exportar para PDF | `relatorio:relatorio:export` |
| POST | `/api/relatorios/{id}/export/excel` | Exportar para Excel | `relatorio:relatorio:export` |
| POST | `/api/relatorios/{id}/export/csv` | Exportar para CSV | `relatorio:relatorio:export` |
| POST | `/api/relatorios/{id}/agendar` | Agendar execução periódica | `relatorio:agendamento:create` |
| GET | `/api/relatorios/{id}/historico` | Histórico de execuções anteriores | `relatorio:relatorio:read` |
| GET | `/api/relatorios/predefinidos/{modulo}` | Listar relatórios predefinidos por módulo | `relatorio:relatorio:read` |
| GET | `/api/relatorios/{id}/preview` | Preview do relatório (primeiras 100 linhas) | `relatorio:relatorio:read` |

**Exemplos**:

```http
POST /api/relatorios/101/executar
Authorization: Bearer <token>
Content-Type: application/json
ClienteId: 1

{
    "parametrosFiltro": {
        "departamento": "TI",
        "dataInicio": "2025-12-01",
        "dataFim": "2025-12-31"
    },
    "justificativaLGPD": "Análise de custos departamental para reunião de diretoria"
}

HTTP/1.1 200 OK
Content-Type: application/json

{
    "id": 5001,
    "realtorioId": 101,
    "status": "Concluído",
    "totalRegistros": 245,
    "urlDownload": "/storage/relatorios/1/101/20251228_143000.pdf"
}
```

```http
POST /api/relatorios/101/export/excel
Authorization: Bearer <token>
ClienteId: 1

HTTP/1.1 200 OK
Content-Disposition: attachment; filename="Ativos-por-Departamento.xlsx"
Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
```

```http
POST /api/relatorios/101/agendar
Authorization: Bearer <token>
Content-Type: application/json
ClienteId: 1

{
    "frequencia": "Mensal",
    "horarioExecucao": "08:00:00",
    "emailsDestinatarios": ["gerente@empresa.com", "cfo@empresa.com"]
}

HTTP/1.1 201 Created

{
    "id": 501,
    "relatórioId": 101,
    "frequencia": "Mensal",
    "horarioExecucao": "08:00:00",
    "emailsDestinatarios": ["gerente@empresa.com", "cfo@empresa.com"],
    "proximaExecucao": "2026-01-28T08:00:00Z"
}
```

```http
GET /api/relatorios/101/historico?limit=20&offset=0
Authorization: Bearer <token>
ClienteId: 1

HTTP/1.1 200 OK

{
    "total": 45,
    "items": [
        {
            "id": 5045,
            "dataExecucao": "2025-12-27T14:30:00Z",
            "usuario": "João Silva",
            "tamanho": 524288,
            "filtrosUtilizados": {"departamento": "TI"},
            "urlDownload": "/api/relatorios/101/historico/5045/download"
        },
        {
            "id": 5044,
            "dataExecucao": "2025-12-20T10:00:00Z",
            "usuario": "Maria Santos",
            "tamanho": 512000,
            "filtrosUtilizados": {"departamento": "RH"},
            "urlDownload": "/api/relatorios/101/historico/5044/download"
        }
    ]
}
```

---

## 6. FLUXOS PRINCIPAIS

### 6.1 Fluxo de Criacao de Relatorio Personalizado

```
Usuario acessa /relatorios/novo
    |
    v
Carrega Designer Visual
    |
    v
Seleciona Módulo (EST, CON, FAT, CHM, etc)
    |
    v
Carrega lista de campos disponíveis do módulo
    |
    +--- Usuário NÃO tem lgpd:relatorio:dados-sensiveis?
    |    Sim: Filtrar campos sensíveis
    |
    v
Usuario arrastra campos para área selecionada (max 20)
    |
    v
Preview em tempo real
    |
    +--- OK?
         |
         +--- Não: Ajustar seleção ou filtros
         |
         v Sim
Usuario clica "Salvar Relatório"
    |
    v
Valida: nome não vazio, mínimo 1 campo
    |
    v
POST /api/relatorios (ClienteId no header)
    |
    v
Relatório criado com sucesso
    |
    v
Usuário redirecionado para /relatorios/[ID]
```

### 6.2 Fluxo de Execucao de Relatorio

```
Usuario seleciona relatório em /relatorios/[ID]
    |
    v
Clica "Executar"
    |
    v
Carrega formulário de filtros parametrizados
    |
    v
Usuário preenche filtros (opcional)
    |
    +--- Relatório tem dados sensíveis?
         |
         +--- Sim: Exigir justificativa LGPD
         |    Não: Pular
    |
    v
Clica "Gerar"
    |
    v
POST /api/relatorios/[ID]/executar
    |
    v
Backend estima tamanho: > 10.000 registros?
    |
    +--- SIM: Enfileirar no Hangfire
    |    |
    |    v
    |    Retornar JobId + "Processando em background"
    |    |
    |    v
    |    Usuario recebe notificação quando pronto
    |
    +--- NAO: Processar sincronamente
         |
         v
Backend aplica filtros + ClienteId
    |
    v
Exporta para PDF (com logo + data/hora)
    |
    v
Registra auditoria (REL_RELATORIO_EXECUTE)
    |
    v
Retorna arquivo PDF
    |
    v
Usuario clica "Download" ou visualiza no navegador
```

### 6.3 Fluxo de Agendamento de Relatorio

```
Usuario em /relatorios/[ID]
    |
    v
Clica "Agendar"
    |
    v
Conta agendamentos ativos: >= 10?
    |
    +--- SIM: Erro "Máximo 10 agendamentos"
    |
    v NAO
Form de agendamento carrega
    |
    v
Usuario seleciona frequência (Diário, Semanal, Mensal)
    |
    v
Seleciona horário (ex: 08:00)
    |
    v
Adiciona emails de destinatários
    |
    v
Clica "Agendar"
    |
    v
POST /api/relatorios/[ID]/agendar
    |
    v
Backend cria AgendamentoRelatório
    |
    v
Registra auditoria (REL_AGENDAMENTO_CREATE)
    |
    v
Hangfire scheduling em background
    |
    v
Confirmação: "Agendamento criado. Próxima execução: [DATA/HORA]"
    |
    v
A partir da próxima execução, Hangfire roda job periodicamente
    |
    v (diariamente às 08:00)
Job dispara ExecutarRelatório automático
    |
    v
PDF gerado e enviado para emails via SMTP
    |
    v
Histórico atualizado
```

### 6.4 Fluxo de Download de Historico

```
Usuario em /relatorios/[ID]/historico
    |
    v
Carrega lista de execuções anteriores (últimos 90 dias)
    |
    v
Tabela mostra:
   - Data/Hora
   - Usuário que gerou
   - Tamanho arquivo
   - Filtros utilizados
    |
    v
Usuario clica em um registro
    |
    v
GET /api/relatorios/[ID]/historico/[HISTORICO_ID]/download
    |
    v
Backend valida:
   - ClienteId match
   - Permissão read
   - Arquivo não expirado (< 90 dias)
    |
    +--- Inválido? Retornar 404
    |
    v Válido
Recupera arquivo de Azure Blob Storage
    |
    v
Registra auditoria (REL_HISTORICO_DOWNLOAD)
    |
    v
Retorna arquivo para download
```

---

## 7. SEGURANCA

### 7.1 Protecoes Implementadas

| Protecao | Descricao |
|----------|-----------|
| **Multi-tenancy por ClienteId** | Todas as queries filtram por ClienteId. Um usuário de um cliente nunca vê dados de outro cliente. |
| **RBAC (Role-Based Access Control)** | Permissões granulares controlam quem pode criar, executar, agendar e deletar relatórios. |
| **LGPD Justificativa Obrigatória** | Acesso a dados pessoais exige justificativa documentada e é auditado. |
| **Auditoria Imutável** | Todos os acessos são registrados em tabela sem permissão DELETE. Rastreabilidade completa. |
| **Expiração de Histórico** | Arquivos e registros expiram após 90 dias (job Hangfire automático). Previne acúmulo indefinido. |
| **SQL Injection Prevention** | Uso de EF Core + LINQ elimina SQL inline (diferente do legado). Parameterização automática. |
| **XSS Protection** | Frontend (Angular) sanitiza saídas automaticamente. Backend valida entrada. |
| **CSRF Protection** | Tokens anti-CSRF em POST/PUT/DELETE. |
| **IP Logging** | IP do usuário registrado em auditoria para análise de padrões anormais. |
| **Permissão de Delete Restrita** | Apenas Administrador pode deletar relatórios. Suavizador evita exclusão acidental. |

### 7.2 Testes de Seguranca Obrigatorios

- [ ] SQL Injection: Tentar SQL em filtros (` OR 1=1 `) - deve rejeitar
- [ ] XSS: Tentar HTML em nome de relatório (`<script>alert()</script>`) - deve sanitizar
- [ ] CSRF: POST sem token - deve retornar 400
- [ ] Validacao de permissoes: Usuário sem `relatorio:relatorio:create` tenta POST /api/relatorios - deve retornar 403
- [ ] Multi-tenancy: Usuário de Cliente A tenta executar relatório de Cliente B - deve retornar 403
- [ ] LGPD: Acesso a dados pessoais sem justificativa - deve retornar 400
- [ ] Auditoria: Tentar deletar registro de auditoria - deve retornar 403
- [ ] Expiração: Tentar download de histórico com > 90 dias - deve retornar 404
- [ ] Rate Limiting: 100+ requisições em 1 minuto - deve throttle

---

## 8. METRICAS E INDICADORES

### 8.1 KPIs

| KPI | Meta | Medicao |
|-----|------|---------|
| **Tempo Médio de Execução** | < 5 segundos para relatórios < 1.000 linhas | SELECT AVG(DATEDIFF(SECOND, DataInicio, DataFim)) FROM HistóricoRelatório |
| **Taxa de Sucesso** | > 98% | (Total Executados - Total Falhados) / Total Executados |
| **Relatórios Criados/Mês** | > 5 novos por cliente | COUNT(*) FROM Relatórios WHERE MONTH(DataCriacao) = MONTH(GETDATE()) |
| **Agendamentos Ativos** | Média 3-5 por usuário | COUNT(*) FROM AgendamentosRelatórios WHERE Ativo = 1 |
| **Tamanho Médio de Arquivo** | < 5 MB | AVG(TamanoArquivo) FROM HistóricoRelatório |
| **Taxa de Retenção Histórico** | < 90 dias | MIN(DATEDIFF(DAY, DataExecucao, GETDATE())) FROM HistóricoRelatório |

### 8.2 Alertas

| Alerta | Condicao | Acao |
|--------|----------|------|
| **Relatório Lento** | Execução > 30 segundos | Notificar usuário, verificar índices no BD |
| **Falha Hangfire** | Job falha 3x consecutivas | Email para suporte técnico com log de erro |
| **Armazenamento Cheio** | Azure Blob > 80% quota | Alertar DevOps para aumentar cota |
| **Acesso a Dados Sensíveis** | Múltiplas execuções com LGPD em 1 hora | Flag para análise de comportamento suspeito |
| **Auditoria Desabilitada** | Nenhuma auditoria em 24 horas | Crítico - parar sistema até resolver |

---

## 9. PROXIMOS PASSOS

1. **Modelo de Dados**: Criar [MD-RF102](./MD-RF102-Relatorios-e-Analises.md)
2. **Casos de Uso**: Criar [UC-RF102](./UC-RF102-Relatorios-e-Analises.md)
3. **Fluxos e Wireframes**: Criar [WF-RF102](./WF-RF102-Relatorios-e-Analises.md)
4. **User Stories**: Criar [user-stories.yaml](./user-stories.yaml)
5. **Teste Cases**: Criar [TC-RF102-BACKEND.md](./TC-RF102-BACKEND.md)
6. **Implementacao Backend**: Commands/Queries/Handlers conforme Clean Architecture
7. **Implementacao Frontend**: Telas Angular com Designer Visual
8. **Testes Automatizados**: Execução de cenários documentados

---

## CHANGELOG

| Versao | Data | Descricao | Autor |
|--------|------|-----------|-------|
| 1.0 | 2025-12-28 | Versao inicial com 10 regras de negócio, 14 endpoints e integrações obrigatórias | Claude Code |

---

**Ultima Atualizacao**: 2025-12-28
**Autor**: Claude Code
**Revisao**: Pendente de aprovação
