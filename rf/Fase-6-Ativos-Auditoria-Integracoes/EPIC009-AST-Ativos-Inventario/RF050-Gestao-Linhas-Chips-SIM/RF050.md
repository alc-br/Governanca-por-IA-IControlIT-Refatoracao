# RF-050: Gestão de Linhas Móveis e Chips SIM

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC009-AST-Ativos-Inventario
**Fase**: Fase 6 - Ativos, Auditoria e Integrações

**RFs Relacionados**: RF022 (Gestão de Fornecedores), RF023 (Gestão de Contratos), RF025 (Gestão de Ativos), RF026 (Gestão de Faturas), RF052 (Gestão de Consumidores), RF066 (Notificações e Alertas), RF067 (Central de E-mails)

---

## 1. OBJETIVO DO REQUISITO

Especificar o módulo de Gestão de Linhas Móveis e Chips SIM do sistema IControlIT, responsável pela administração completa do ciclo de vida de linhas telefônicas móveis, controle de chips SIM (ICCID, IMSI), operações de ativação, portabilidade, troca de chip, suspensão e cancelamento, controle de estoque de chips, rastreamento de associações linha-chip-aparelho-consumidor, integração com APIs de operadoras para sincronização automática de dados, e workflow de aprovação para operações financeiramente relevantes.

O módulo oferece visibilidade completa do inventário de ativos móveis, controle de custos de telefonia, identificação de linhas subutilizadas, alertas de vencimento de contrato, e relatórios gerenciais detalhados sobre utilização e despesas.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] CRUD completo de linhas móveis
- [x] CRUD completo de chips SIM
- [x] Gestão de operações (Ativação, Portabilidade, Troca de Chip, Suspensão, Cancelamento)
- [x] Controle de estoque de chips por operadora (Novo, Ativo, Defeituoso, Inativo)
- [x] Rastreamento de ICCID (19-20 dígitos), IMSI (14-15 dígitos), IMEI (15 dígitos)
- [x] Associação dinâmica linha x chip x aparelho x consumidor
- [x] Workflow de aprovação baseado em alçadas de valor
- [x] Integração com APIs de operadoras (status, consumo, saldo de franquia)
- [x] Alertas automáticos de vencimento de contrato (30/60/90 dias)
- [x] Identificação de linhas subutilizadas (otimização de custos)
- [x] Dashboard de estoque de chips e status de linhas
- [x] Importação de linhas via CSV/Excel (migração em lote)
- [x] Exportação de relatórios gerenciais
- [x] Histórico completo de operações (auditoria 7 anos)
- [x] Multi-tenancy rigoroso (isolamento por ClienteId)
- [x] Soft delete de linhas e chips
- [x] Auditoria imutável de todas as operações

### 2.2 Fora do escopo

- Interface visual específica (responsabilidade do frontend)
- Tecnologia, framework ou linguagem de implementação
- Layout, UX ou identidade visual
- Estratégia de deploy ou infraestrutura
- Gerenciamento de operadoras e fornecedores (RF022)
- Gerenciamento de contratos (RF023)
- Gerenciamento de consumidores (RF052)
- Faturamento detalhado (RF026)
- Gestão de aparelhos e dispositivos (RF025)
- Auditoria de bilhetes de chamadas (RF034, RF035)
- Integração com ERPs externos
- Análise preditiva de churn ou fraude avançada

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Linha Móvel** | Entidade lógica que representa um número telefônico (DDI+DDD+Número) associado a uma operadora, plano de serviço, consumidor e aparelho. Contém status (Ativo, Suspenso, Cancelado), data de ativação, data de vencimento de contrato e histórico de operações. |
| **Chip SIM** | Entidade física que representa um cartão SIM com identificador único ICCID (19-20 dígitos). Contém IMSI (14-15 dígitos), status (Novo, Ativo, Defeituoso, Inativo) e histórico de associações com linhas móveis. |
| **ICCID** | Integrated Circuit Card ID - Identificador único gravado no chip SIM (19-20 dígitos). Imutável e globalmente único. |
| **IMSI** | International Mobile Subscriber Identity - Identificador do assinante na rede da operadora (14-15 dígitos). Associado ao chip SIM. |
| **IMEI** | International Mobile Equipment Identity - Identificador do aparelho móvel (15 dígitos). Muda quando a linha é usada em aparelho diferente. Sistema registra histórico de IMEIs para detectar múltiplos aparelhos. |
| **Operação de Linha** | Evento que altera o ciclo de vida da linha (Ativação, Portabilidade, Troca de Chip, Suspensão, Cancelamento). Cada operação pode exigir aprovação baseada em valor ou criticidade. |
| **Portabilidade** | Operação que permite manter o número da linha ao trocar de operadora. Exige chip SIM da operadora destino, protocolo ANATEL e prazo mínimo de 7 dias úteis. |
| **Troca de Chip** | Operação que substitui o chip SIM físico mantendo o número da linha. Motivos: Defeito, Perda, Roubo, Upgrade de Tecnologia (3G→4G→5G). |
| **Estoque de Chips** | Inventário físico de chips SIM por operadora, controlado por movimentações de Entrada (compra), Saída (ativação), Devolução (defeituoso) e Baixa (descarte). |
| **Workflow de Aprovação** | Fluxo de autorização baseado em alçadas de valores ou criticidade da operação. Exemplo: Ativação de plano >R$100/mês requer aprovação de Gestor. Portabilidade requer Gestor + Financeiro. |
| **Multi-tenancy** | Isolamento rigoroso de dados por ClienteId (cliente/empresa contratante). Nenhuma linha ou chip de clientes diferentes pode ser visível entre si. |
| **Soft Delete** | Linhas e chips nunca são deletados fisicamente. Ao excluir, a coluna IsDeleted é marcada como true, preservando auditoria e rastreabilidade. |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Gestão de Linhas Móveis** - CRUD completo de linhas com validações de número, operadora e plano
2. **Gestão de Chips SIM** - CRUD completo de chips com validação de ICCID e IMSI
3. **Ativação de Linha** - Criar nova linha associando chip disponível no estoque
4. **Portabilidade de Linha** - Migrar linha para outra operadora mantendo número
5. **Troca de Chip** - Substituir chip físico mantendo número da linha
6. **Suspensão Temporária** - Suspender linha por período definido (férias, licença)
7. **Cancelamento Definitivo** - Cancelar linha calculando multa se aplicável
8. **Controle de Estoque de Chips** - Entrada, saída, devolução e inventário de chips
9. **Associação Linha-Chip-Aparelho-Consumidor** - Rastreamento dinâmico de associações
10. **Integração com Operadoras** - Sincronização automática de status, consumo e saldo
11. **Workflow de Aprovação** - Aprovação multi-nível para operações críticas
12. **Alertas de Vencimento** - Notificações automáticas 30/60/90 dias antes
13. **Identificação de Subutilização** - Análise de consumo para otimização de custos
14. **Dashboard de Estoque** - Visualização em tempo real de status e estoque
15. **Importação/Exportação** - Carga em lote via CSV/Excel e exportação de relatórios
16. **Histórico de Operações** - Rastreamento completo de todas as operações (7 anos)
17. **Relatórios Gerenciais** - Custos, utilização, vencimentos, estoque, performance

---

## 5. REGRAS DE NEGÓCIO

### RN-050-001 — Estrutura de Linha Móvel e Chip SIM

**Descrição**: Linha móvel e chip SIM são entidades distintas mas relacionadas. Uma linha representa o número telefônico lógico, enquanto o chip é o hardware físico associado.

**Justificativa**: Permite rastrear trocas de chip mantendo o histórico completo da linha e detectar anomalias como múltiplos chips ativos simultaneamente.

**Critério de Aceite**:
- Linha contém: Número (DDI+DDD+Número), Operadora (FK), Plano (FK), DataAtivacao, Status (Ativo/Suspenso/Cancelado)
- Chip contém: ICCID (19-20 dígitos, único), IMSI (14-15 dígitos), Status (Novo/Ativo/Defeituoso/Inativo)
- Uma linha pode ter histórico de múltiplos chips (rastreamento de trocas)
- Um chip ativo está associado a no máximo uma linha ativa
- Número da linha deve ser único globalmente
- ICCID do chip deve ser único globalmente
- Formato de número: +55 (DDD) 9XXXX-XXXX (celular brasileiro)

**Exemplos**:
- ✅ Linha +55 11 99999-8888 com Chip ICCID 8955010400000001234 (status Ativo)
- ✅ Linha mantém mesmo número após troca de chip (ICCID muda, número permanece)
- ❌ Dois chips ativos com mesmo ICCID (violação de unicidade)
- ❌ Duas linhas ativas com mesmo número (violação de unicidade)

---

### RN-050-002 — Operação de Ativação de Linha

**Descrição**: Ativação de nova linha móvel requer chip SIM disponível no estoque, operadora e plano selecionados, e opcionalmente um consumidor designado.

**Justificativa**: Garante que toda linha ativada tem um chip físico correspondente e rastreabilidade completa desde a origem.

**Critério de Aceite**:
- Pré-requisitos obrigatórios: Chip SIM com status "Novo" no estoque, Operadora existente, Plano válido
- Processo: Atribui número à linha, associa chip à linha, atualiza status do chip para "Ativo", registra DataAtivacao, cria registro de custo mensal
- Plano com custo >R$100/mês requer aprovação de Gestor antes de ativar
- Sistema notifica consumidor após ativação bem-sucedida
- Auditoria registra usuário, data/hora, chip utilizado e justificativa

**Exemplos**:
- ✅ Ativar linha com chip ICCID disponível, operadora Vivo, plano Controle 10GB (R$60/mês) - aprovação automática
- ✅ Ativar linha com plano Pós 50GB (R$150/mês) - aguarda aprovação do Gestor
- ❌ Ativar linha sem chip disponível no estoque (rejeição)
- ❌ Ativar linha com chip já associado a outra linha ativa (rejeição)

---

### RN-050-003 — Operação de Portabilidade

**Descrição**: Portabilidade permite manter o número da linha ao trocar de operadora, seguindo regulamentação ANATEL com protocolo e prazo mínimo de 7 dias úteis.

**Justificativa**: Permite migração entre operadoras otimizando custos ou qualidade de serviço sem perder o número histórico.

**Critério de Aceite**:
- Pré-requisitos: Linha ativa na operadora origem, Chip SIM da operadora destino disponível no estoque, Protocolo ANATEL válido
- Processo: Cria solicitação de portabilidade, informa data agendada (D+7 dias úteis), atualiza operadora na data agendada, troca chip físico, mantém número da linha
- Requer aprovação de Gestor + Financeiro (duas aprovações)
- Sistema valida formato de protocolo ANATEL (10-12 dígitos numéricos)
- Prazo mínimo 7 dias úteis, portabilidade emergencial 3 dias com justificativa de Super Admin
- Registra histórico completo: Operadora origem, operadora destino, protocolo, datas, aprovadores

**Exemplos**:
- ✅ Portabilidade de +55 11 99999-8888 de Vivo para TIM, protocolo 123456789012, agendada para D+7
- ✅ Portabilidade emergencial com justificativa "Falha crítica de cobertura" aprovada por Super Admin
- ❌ Portabilidade sem protocolo ANATEL (rejeição)
- ❌ Portabilidade agendada para D+3 sem justificativa emergencial (rejeição)

---

### RN-050-004 — Operação de Troca de Chip

**Descrição**: Troca de chip permite substituir chip defeituoso, perdido ou roubado mantendo o número da linha, ou fazer upgrade de tecnologia (3G→4G→5G).

**Justificativa**: Garante continuidade do serviço em caso de falha física do chip sem perder o número telefônico.

**Critério de Aceite**:
- Motivos válidos: Chip Defeituoso, Chip Perdido, Chip Roubado, Upgrade de Tecnologia
- Processo: Valida motivo da troca, desativa chip antigo (status "Inativo" ou "Defeituoso"), atribui novo chip da mesma operadora, mantém número da linha, registra histórico de troca
- Troca por perda ou roubo pode gerar cobrança ao consumidor (decisão configurável por cliente)
- Múltiplas trocas em período <30 dias geram alerta para investigação de fraude
- Chip antigo é movido para estoque com status "Defeituoso" ou "Inativo" conforme motivo
- Sistema valida disponibilidade de chip compatível (mesma operadora) no estoque

**Exemplos**:
- ✅ Trocar chip por defeito físico (falha de leitura) - chip antigo vira "Defeituoso", chip novo vira "Ativo"
- ✅ Trocar chip perdido - chip antigo vira "Inativo", gera cobrança de R$20 ao consumidor
- ❌ Trocar chip 3 vezes em 15 dias - alerta de fraude gerado para investigação
- ❌ Trocar chip sem chip compatível disponível no estoque (rejeição)

---

### RN-050-005 — Controle de Estoque de Chips

**Descrição**: Sistema gerencia estoque físico de chips SIM por operadora com estados (Novo, Ativo, Inativo, Defeituoso) e operações de movimentação (Entrada, Saída, Devolução, Baixa).

**Justificativa**: Garante rastreabilidade completa de chips físicos, evita ativações sem estoque, e otimiza compra de chips novos.

**Critério de Aceite**:
- Estados de chip: Novo (no estoque, nunca usado), Ativo (em uso em linha), Inativo (foi usado, agora desativado), Defeituoso (falha física)
- Operações: Entrada (compra de chips novos), Saída (ativação de linha), Devolução (chip defeituoso para operadora), Baixa (descarte de chips defeituosos)
- Alertas automáticos: Estoque baixo (<10 chips por operadora), Chips parados >6 meses (risco de expiração)
- Inventário físico mensal deve ser conciliado com saldo do sistema
- Chips de teste/homologação têm controle separado (não entram no estoque regular)
- Dashboard exibe saldo de chips por operadora e status em tempo real

**Exemplos**:
- ✅ Entrada de 50 chips Vivo novos - estoque atualizado, auditoria registrada
- ✅ Alerta "Estoque baixo TIM: 8 chips restantes" gerado automaticamente
- ❌ Tentar ativar linha sem chips disponíveis no estoque (rejeição)

---

### RN-050-006 — Rastreamento de ICCID, IMSI e IMEI

**Descrição**: Sistema rastreia identificadores únicos de linha, chip e aparelho permitindo análise de múltiplos aparelhos por linha e histórico completo de associações.

**Justificativa**: Permite detecção de anomalias (linha usada em múltiplos aparelhos simultaneamente), suporte técnico e investigações de segurança.

**Critério de Aceite**:
- ICCID (Integrated Circuit Card ID): Identifica chip SIM (19-20 dígitos), gravado no chip, imutável
- IMSI (International Mobile Subscriber Identity): Identifica assinante na rede (14-15 dígitos), associado ao chip
- IMEI (International Mobile Equipment Identity): Identifica aparelho (15 dígitos), muda se trocar aparelho
- Sistema valida formato via regex: ICCID (^[0-9]{19,20}$), IMSI (^[0-9]{14,15}$), IMEI (^[0-9]{15}$)
- Histórico registra todos os IMEIs já usados com cada linha (detector de múltiplos aparelhos)
- Chips eSIM podem ter ICCID virtual (aceita formato diferente com flag IsEsim=true)

**Exemplos**:
- ✅ Linha rastreada com ICCID 8955010400000001234, IMSI 724110123456789, IMEI 123456789012345
- ✅ Histórico mostra linha usada em 3 aparelhos diferentes (3 IMEIs registrados)
- ❌ ICCID com 18 dígitos (rejeição por formato inválido)
- ❌ IMEI com letras (rejeição por formato inválido)

---

### RN-050-007 — Workflow de Aprovação para Operações Críticas

**Descrição**: Operações financeiramente relevantes ou de alto impacto requerem aprovação multi-nível baseada em alçadas de valor ou criticidade.

**Justificativa**: Garante controle financeiro e compliance com políticas internas de governança de TI.

**Critério de Aceite**:
- Operações críticas:
  - Ativação de plano >R$100/mês → aprovação de Gestor
  - Portabilidade → aprovação de Gestor + Financeiro
  - Cancelamento antes de 12 meses → aprovação de Financeiro (pode gerar multa)
  - Troca de chip por perda/roubo → aprovação de Gestor (pode gerar cobrança)
- Workflow: Cria solicitação, notifica aprovadores via RF066/RF067, aguarda aprovações, executa operação, notifica solicitante
- Sistema bloqueia execução até aprovações completas
- Super Admin pode aprovar/executar imediatamente em emergências
- Histórico de aprovações é auditado (quem aprovou, quando, justificativa)

**Exemplos**:
- ✅ Ativação de plano Controle 10GB (R$60/mês) - aprovação automática
- ✅ Ativação de plano Pós 50GB (R$150/mês) - aguarda aprovação do Gestor
- ✅ Portabilidade - aguarda aprovação de Gestor + Financeiro (2 aprovações)
- ❌ Executar portabilidade sem aprovações completas (rejeição)

---

### RN-050-008 — Integração com APIs de Operadoras

**Descrição**: Sistema sincroniza automaticamente dados com APIs de operadoras (Vivo, Claro, TIM, Oi) para obter status em tempo real, consumo do período e saldo de franquia.

**Justificativa**: Garante dados atualizados sem necessidade de importação manual, reduz erros e agiliza controle de custos.

**Critério de Aceite**:
- Dados sincronizados: Status da linha (ativo, suspenso, cancelado), Consumo do período (dados MB/GB, voz minutos, SMS quantidade), Saldo de franquia restante, Data de vencimento de contrato
- Frequência: Consumo diário (via API ou arquivo), Status em tempo real (via webhook), Vencimento mensal
- Em caso de divergência entre sistema e operadora, dados da operadora são fonte da verdade (com alerta para investigação)
- Job noturno (Hangfire) sincroniza dados de todas as operadoras integradas
- Operadoras sem API funcionam com importação manual de arquivos CSV/Excel
- Circuit Breaker protege sistema contra falhas prolongadas de APIs externas

**Exemplos**:
- ✅ Job sincroniza status de 1.000 linhas Vivo via API em 5 minutos
- ✅ Webhook recebe notificação de linha suspensa pela operadora e atualiza sistema em tempo real
- ❌ API da operadora indisponível por 2 horas - Circuit Breaker ativa, job reagenda para 1 hora
- ❌ Divergência detectada: Sistema mostra linha ativa, operadora mostra cancelada - alerta gerado

---

### RN-050-009 — Alertas de Vencimento de Contrato

**Descrição**: Sistema envia alertas proativos sobre vencimento de contratos de linhas móveis em 30, 60 e 90 dias antes do vencimento, permitindo planejamento de renovação ou migração.

**Justificativa**: Evita renovações automáticas indesejadas, permite renegociação de valores e otimização de custos.

**Critério de Aceite**:
- Alertas enviados em: 90 dias antes (planejamento), 60 dias antes (negociação), 30 dias antes (decisão urgente), No vencimento (renovação automática ou cancelamento)
- Destinatários: Gestor responsável, Financeiro, Compras
- Ação recomendada sugerida no alerta: Renovar contrato, Renegociar valores, Migrar para operadora concorrente, Cancelar linha (se subutilizada)
- Job diário (Hangfire) verifica vencimentos e envia alertas via RF066/RF067
- Contratos sem prazo determinado (indefinidos) não geram alertas
- Histórico de alertas é auditado para compliance

**Exemplos**:
- ✅ Linha com vencimento em 15/03/2026 gera alerta em 15/12/2025 (90 dias antes)
- ✅ Gestor recebe e-mail com ação recomendada "Renegociar valores - linha subutilizada"
- ❌ Contrato indefinido - sem alertas gerados

---

### RN-050-010 — Identificação de Linhas Subutilizadas

**Descrição**: Sistema analisa consumo mensal de linhas e identifica aquelas com baixo uso para otimização de custos via downgrade de plano, suspensão ou cancelamento.

**Justificativa**: Reduz custos de telefonia eliminando gastos desnecessários com linhas pouco utilizadas.

**Critério de Aceite**:
- Critérios de subutilização:
  - Consumo de dados <10% da franquia por 3 meses consecutivos
  - Consumo de voz <5 minutos/mês por 3 meses consecutivos
  - Sem uso de SMS por 6 meses
- Ação recomendada: Downgrade de plano, Suspensão temporária, Cancelamento (se consumidor concorda)
- Relatório mensal automático: Top 20 linhas subutilizadas, Economia potencial
- Job mensal (Hangfire) analisa consumo e gera relatório
- Linhas de emergência (segurança, ambulância) não são avaliadas (flag IsEmergencyLine=true)
- Dashboard exibe indicador de economia potencial

**Exemplos**:
- ✅ Linha com plano 50GB consome média de 2GB/mês por 3 meses - marcada como subutilizada
- ✅ Relatório sugere "Downgrade de Pós 50GB para Controle 10GB - economia de R$90/mês"
- ❌ Linha de segurança com baixo uso - não é marcada como subutilizada

---

### RN-050-011 — Operação de Suspensão Temporária

**Descrição**: Permite suspender linha temporariamente sem cancelar, útil para férias, licenças médicas ou viagens internacionais, com cobrança reduzida.

**Justificativa**: Reduz custos em períodos de não uso sem perder o número telefônico.

**Critério de Aceite**:
- Motivos válidos: Férias (até 30 dias), Licença médica (até 120 dias), Viagem internacional (usa chip local), Perda temporária de aparelho
- Efeitos: Linha mantém número, não pode fazer/receber chamadas, cobrança reduzida (geralmente 50% do valor do plano), pode ser reativada a qualquer momento
- Suspensão >30 dias requer aprovação de Gestor
- Suspensão >120 dias pode ser negada pela operadora (risco de perda do número) - sistema valida com API
- Sistema valida prazo máximo de suspensão conforme contrato da operadora
- Reativação restaura plano e franquia original

**Exemplos**:
- ✅ Suspender linha por 20 dias (férias) - aprovação automática, cobrança 50%
- ✅ Suspender linha por 90 dias (licença médica) - aguarda aprovação do Gestor
- ❌ Suspender linha por 180 dias - operadora nega (risco de perda do número)

---

### RN-050-012 — Operação de Cancelamento Definitivo

**Descrição**: Cancelamento de linha libera número e chip, com cálculo automático de multa se aplicável conforme vigência do contrato.

**Justificativa**: Garante encerramento controlado de linhas com transparência financeira sobre multas rescisórias.

**Critério de Aceite**:
- Pré-requisitos: Linha ativa ou suspensa, Aprovação de Gestor (sempre), Aprovação de Financeiro (se multa >R$500)
- Cálculo de multa: Se contrato <12 meses → Multa proporcional aos meses restantes, Se contrato ≥12 meses → Sem multa
- Processo: Calcula e exibe multa, aguarda aprovações, solicita cancelamento à operadora, atualiza status linha para "Cancelado", libera chip (status "Inativo"), desassocia de consumidor/aparelho
- Sistema valida pendências financeiras (faturas em aberto) antes de cancelar
- Cancelamento por fraude/irregularidade pode ser imediato com aprovação de Super Admin
- Soft delete: linha permanece no banco com IsDeleted=true para auditoria

**Exemplos**:
- ✅ Cancelar linha com 15 meses de contrato - sem multa, aguarda aprovação do Gestor
- ✅ Cancelar linha com 8 meses de contrato - multa R$200 (4 meses restantes × R$50), aguarda Gestor + Financeiro
- ❌ Cancelar linha com fatura em aberto - rejeição, exige quitação antes

---

### RN-050-013 — Dashboard de Estoque e Status de Linhas

**Descrição**: Interface exibe visualmente em tempo real o status de linhas, estoque de chips, ativações/cancelamentos temporais e alertas de vencimento.

**Justificativa**: Oferece visibilidade gerencial instantânea sobre inventário de ativos móveis e custos associados.

**Critério de Aceite**:
- Dashboard exibe:
  - Total de linhas por operadora (cards coloridos)
  - Total de linhas por status (Ativo, Suspenso, Cancelado)
  - Estoque de chips por operadora (Novo, Ativo, Defeituoso)
  - Gráfico de ativações/cancelamentos temporal (últimos 12 meses)
  - Alertas de vencimento de contrato (próximos 90 dias)
  - Top 10 linhas de maior custo
- Atualização em tempo real via SignalR
- Dashboard carrega em ≤2 segundos
- Dados históricos (>1 ano) carregam sob demanda (lazy loading)
- Exportação de dashboard para PDF/Excel

**Exemplos**:
- ✅ Dashboard mostra: 150 linhas Vivo ativas, 20 chips TIM novos no estoque, 5 alertas de vencimento
- ✅ Gráfico mostra pico de ativações em janeiro (50 linhas) e cancelamentos em dezembro (30 linhas)
- ❌ Dashboard demora 5 segundos para carregar - falha no critério de performance

---

### RN-050-014 — Importação de Linhas via CSV/Excel

**Descrição**: Permite importação em lote de linhas para agilizar migração de sistemas legados ou atualização em massa de dados.

**Justificativa**: Reduz esforço manual e tempo de migração de grandes volumes de linhas.

**Critério de Aceite**:
- Formato: CSV/Excel com colunas obrigatórias (Número, ICCID, Operadora, Plano, Consumidor)
- Validações: Unicidade de Número e ICCID, Operadora existente no cadastro, Formato válido de números, Chip disponível no estoque
- Processo: Upload de arquivo, Preview dos dados (primeiras 10 linhas), Validação linha a linha, Importação com relatório de sucesso/erro
- Limite de 1.000 linhas por arquivo para processamento síncrono
- Importações >1.000 linhas processadas via job em background (Hangfire)
- Template Excel disponível para download
- Relatório de importação exibe: Total de linhas, Linhas importadas com sucesso, Linhas com erro (motivo detalhado)

**Exemplos**:
- ✅ Importar 500 linhas via CSV - 490 importadas com sucesso, 10 rejeitadas por ICCID duplicado
- ✅ Importar 2.000 linhas - job em background processa em 10 minutos, envia notificação ao finalizar
- ❌ Importar arquivo com coluna "Número" faltando - rejeição com erro de validação

---

### RN-050-015 — Auditoria Completa de Operações de Linhas

**Descrição**: Todas as operações sobre linhas móveis e chips SIM são auditadas automaticamente com retenção de 7 anos conforme LGPD.

**Justificativa**: Garante rastreabilidade completa para compliance, auditoria externa e investigações de segurança.

**Critério de Aceite**:
- Operações auditadas: Ativação, Portabilidade, Troca de Chip, Suspensão, Cancelamento, Atualização de dados, Importação
- Dados registrados: Usuário (quem executou), Data/Hora (quando), Operação (o que), Dados antes/depois (mudanças), IP (de onde), Justificativa (por que)
- Retenção de 7 anos conforme LGPD
- Auditoria via AuditInterceptor automático do EF Core
- Operações de leitura simples (listagem sem filtros) não geram auditoria detalhada (otimização de performance)
- Consulta de auditoria disponível para Super Admin e Auditor

**Exemplos**:
- ✅ Auditoria registra: Usuário "admin@empresa.com" cancelou linha +55 11 99999-8888 em 30/12/2025 14:30 via IP 192.168.1.100, justificativa "Colaborador desligado"
- ✅ Auditoria preservada por 7 anos para compliance LGPD
- ❌ Listagem de linhas sem filtros - não gera auditoria detalhada (otimização)

---

## 6. ESTADOS DA ENTIDADE

### 6.1 Estados de Linha Móvel

| Estado | Descrição | Transições Permitidas |
|--------|-----------|----------------------|
| **Ativo** | Linha ativa, pode fazer/receber chamadas | → Suspenso, → Cancelado |
| **Suspenso** | Linha suspensa temporariamente, não pode fazer/receber chamadas | → Ativo, → Cancelado |
| **Cancelado** | Linha cancelada definitivamente, número liberado | (Estado final) |

### 6.2 Estados de Chip SIM

| Estado | Descrição | Transições Permitidas |
|--------|-----------|----------------------|
| **Novo** | Chip no estoque, nunca usado | → Ativo |
| **Ativo** | Chip em uso em linha ativa | → Inativo, → Defeituoso |
| **Inativo** | Chip foi usado, agora desativado | (Estado final) |
| **Defeituoso** | Chip com falha física | (Estado final) |

### 6.3 Estados de Operação de Linha

| Estado | Descrição | Transições Permitidas |
|--------|-----------|----------------------|
| **Pendente** | Operação criada, aguardando aprovações | → Aprovada, → Rejeitada |
| **Aprovada** | Operação aprovada, pronta para execução | → Executada, → Cancelada |
| **Executada** | Operação concluída com sucesso | (Estado final) |
| **Rejeitada** | Operação rejeitada por aprovador | (Estado final) |
| **Cancelada** | Operação cancelada pelo solicitante | (Estado final) |

---

## 7. PERMISSÕES RBAC

| Operação | Permission Code | Roles Autorizadas | Descrição |
|----------|----------------|-------------------|-----------|
| Listar Linhas | `AST.LINHAS_MOVEIS.VIEW_ANY` | Super Admin, Admin, Gestor, Operador | Visualizar lista de linhas |
| Visualizar Linha | `AST.LINHAS_MOVEIS.VIEW` | Super Admin, Admin, Gestor, Operador | Visualizar detalhes de uma linha |
| Criar Linha | `AST.LINHAS_MOVEIS.CREATE` | Super Admin, Admin, Gestor | Criar nova linha |
| Atualizar Linha | `AST.LINHAS_MOVEIS.UPDATE` | Super Admin, Admin, Gestor | Atualizar linha existente |
| Ativar Linha | `AST.LINHAS_MOVEIS.ACTIVATE` | Super Admin, Admin, Gestor | Ativar nova linha |
| Portabilidade | `AST.LINHAS_MOVEIS.PORTABILITY` | Super Admin, Admin, Gestor | Solicitar portabilidade |
| Trocar Chip | `AST.LINHAS_MOVEIS.SWAP_CHIP` | Super Admin, Admin, Gestor, Operador | Trocar chip de linha |
| Suspender Linha | `AST.LINHAS_MOVEIS.SUSPEND` | Super Admin, Admin, Gestor | Suspender linha temporariamente |
| Cancelar Linha | `AST.LINHAS_MOVEIS.CANCEL` | Super Admin, Admin, Gestor | Cancelar linha definitivamente |
| Excluir Linha | `AST.LINHAS_MOVEIS.DELETE` | Super Admin, Admin | Soft delete de linha |
| Aprovar Operação | `AST.LINHAS_MOVEIS.APPROVE` | Super Admin, Gestor, Financeiro | Aprovar operações críticas |
| Importar Linhas | `AST.LINHAS_MOVEIS.IMPORT` | Super Admin, Admin, Gestor | Importar linhas via CSV/Excel |
| Exportar Relatórios | `AST.LINHAS_MOVEIS.EXPORT` | Super Admin, Admin, Gestor, Operador | Exportar relatórios |
| Visualizar Dashboard | `AST.LINHAS_MOVEIS.DASHBOARD` | Super Admin, Admin, Gestor, Operador | Acessar dashboard de estoque |
| Gerenciar Estoque | `AST.CHIPS_SIM.MANAGE` | Super Admin, Admin, Gestor | Gerenciar estoque de chips |
| Sincronizar Operadora | `AST.LINHAS_MOVEIS.SYNC` | Super Admin, Admin | Sincronizar dados com operadora |
| Visualizar Auditoria | `AST.LINHAS_MOVEIS.AUDIT` | Super Admin, Auditor | Consultar auditoria de operações |

---

## 8. API ENDPOINTS

| Método | Endpoint | Descrição | Permission | Request DTO | Response DTO |
|--------|----------|-----------|------------|-------------|--------------|
| GET | `/api/gestao/linhas-moveis` | Listar linhas com filtros e paginação | `AST.LINHAS_MOVEIS.VIEW_ANY` | Query params (page, pageSize, status, operadora) | `PaginatedListDto<LinhaMovelDto>` |
| GET | `/api/gestao/linhas-moveis/{id}` | Obter detalhes de uma linha | `AST.LINHAS_MOVEIS.VIEW` | Path param (id) | `LinhaMovelDto` |
| POST | `/api/gestao/linhas-moveis` | Criar nova linha | `AST.LINHAS_MOVEIS.CREATE` | `CreateLinhaMovelCommand` | `Guid` (ID da linha) |
| PUT | `/api/gestao/linhas-moveis/{id}` | Atualizar linha existente | `AST.LINHAS_MOVEIS.UPDATE` | `UpdateLinhaMovelCommand` | `bool` |
| POST | `/api/gestao/linhas-moveis/{id}/ativar` | Ativar nova linha | `AST.LINHAS_MOVEIS.ACTIVATE` | `ActivateLinhaMovelCommand` | `bool` |
| POST | `/api/gestao/linhas-moveis/{id}/portabilidade` | Solicitar portabilidade | `AST.LINHAS_MOVEIS.PORTABILITY` | `PortabilidadeLinhaCommand` | `Guid` (ID da operação) |
| POST | `/api/gestao/linhas-moveis/{id}/trocar-chip` | Trocar chip da linha | `AST.LINHAS_MOVEIS.SWAP_CHIP` | `TrocaChipCommand` | `bool` |
| POST | `/api/gestao/linhas-moveis/{id}/suspender` | Suspender linha temporariamente | `AST.LINHAS_MOVEIS.SUSPEND` | `SuspendLinhaMovelCommand` | `bool` |
| POST | `/api/gestao/linhas-moveis/{id}/cancelar` | Cancelar linha definitivamente | `AST.LINHAS_MOVEIS.CANCEL` | `CancelLinhaMovelCommand` | `bool` |
| DELETE | `/api/gestao/linhas-moveis/{id}` | Soft delete de linha | `AST.LINHAS_MOVEIS.DELETE` | Path param (id) | `bool` |
| GET | `/api/gestao/linhas-moveis/{id}/historico` | Obter histórico de operações | `AST.LINHAS_MOVEIS.VIEW` | Path param (id) | `List<OperacaoLinhaDto>` |
| GET | `/api/gestao/chips-sim` | Listar chips no estoque | `AST.CHIPS_SIM.MANAGE` | Query params (status, operadora) | `PaginatedListDto<ChipSIMDto>` |
| GET | `/api/gestao/chips-sim/dashboard` | Obter dados do dashboard de estoque | `AST.LINHAS_MOVEIS.DASHBOARD` | - | `EstoqueDashboardDto` |
| POST | `/api/gestao/linhas-moveis/importar` | Importar linhas via CSV/Excel | `AST.LINHAS_MOVEIS.IMPORT` | `IFormFile` | `ImportResultDto` |
| GET | `/api/gestao/linhas-moveis/exportar` | Exportar linhas para arquivo | `AST.LINHAS_MOVEIS.EXPORT` | Query params (formato, filtros) | `FileContentResult` |
| POST | `/api/gestao/linhas-moveis/sincronizar/{operadora}` | Sincronizar dados com operadora | `AST.LINHAS_MOVEIS.SYNC` | Path param (operadora) | `SyncResultDto` |
| POST | `/api/gestao/operacoes/{id}/aprovar` | Aprovar operação pendente | `AST.LINHAS_MOVEIS.APPROVE` | `ApproveOperacaoCommand` | `bool` |
| POST | `/api/gestao/operacoes/{id}/rejeitar` | Rejeitar operação pendente | `AST.LINHAS_MOVEIS.APPROVE` | `RejectOperacaoCommand` | `bool` |

---

## 9. INTEGRAÇÕES OBRIGATÓRIAS

### 9.1 Internacionalização (i18n)

**Transloco** para suporte a pt-BR, en-US, es-ES.

**Chaves obrigatórias:**
```typescript
{
  "gestao.linhas_moveis.titulo": "Gestão de Linhas Móveis",
  "gestao.linhas_moveis.criar": "Nova Linha",
  "gestao.linhas_moveis.numero": "Número",
  "gestao.linhas_moveis.iccid": "ICCID",
  "gestao.linhas_moveis.operadora": "Operadora",
  "gestao.linhas_moveis.status.ativo": "Ativo",
  "gestao.linhas_moveis.status.suspenso": "Suspenso",
  "gestao.linhas_moveis.status.cancelado": "Cancelado",
  "gestao.linhas_moveis.ativar": "Ativar Linha",
  "gestao.linhas_moveis.portabilidade": "Solicitar Portabilidade",
  "gestao.linhas_moveis.trocar_chip": "Trocar Chip",
  "gestao.linhas_moveis.suspender": "Suspender",
  "gestao.linhas_moveis.cancelar": "Cancelar",
  "gestao.linhas_moveis.validacoes.numero_invalido": "Número de telefone inválido",
  "gestao.linhas_moveis.validacoes.iccid_invalido": "ICCID deve ter 19-20 dígitos numéricos",
  "gestao.linhas_moveis.validacoes.chip_indisponivel": "Chip não disponível no estoque"
}
```

### 9.2 Auditoria (RF003)

**Campos obrigatórios em todas as entidades:**
- `Created` (DateTime)
- `CreatedBy` (string - email do usuário)
- `LastModified` (DateTime?)
- `LastModifiedBy` (string?)

**Auditoria via `AuditInterceptor` automático do EF Core.**

### 9.3 Permissões RBAC (RF006)

**Validação de permissões em todos os endpoints via `RequireAuthorization()`.**

**Matriz de permissões conforme seção 7.**

### 9.4 Central de Funcionalidades

**Registro obrigatório:**
```json
{
  "code": "AST.LINHAS_MOVEIS",
  "module": "Gestão de Ativos",
  "title": "Gestão de Linhas Móveis e Chips SIM",
  "route": "/gestao/linhas-moveis",
  "icon": "mat:phone_iphone",
  "permissions": [
    "AST.LINHAS_MOVEIS.VIEW_ANY",
    "AST.LINHAS_MOVEIS.CREATE",
    "AST.LINHAS_MOVEIS.UPDATE",
    "AST.LINHAS_MOVEIS.DELETE",
    "AST.LINHAS_MOVEIS.ACTIVATE",
    "AST.LINHAS_MOVEIS.PORTABILITY",
    "AST.LINHAS_MOVEIS.SWAP_CHIP",
    "AST.LINHAS_MOVEIS.SUSPEND",
    "AST.LINHAS_MOVEIS.CANCEL",
    "AST.LINHAS_MOVEIS.APPROVE",
    "AST.LINHAS_MOVEIS.IMPORT",
    "AST.LINHAS_MOVEIS.EXPORT",
    "AST.LINHAS_MOVEIS.DASHBOARD",
    "AST.CHIPS_SIM.MANAGE",
    "AST.LINHAS_MOVEIS.SYNC",
    "AST.LINHAS_MOVEIS.AUDIT"
  ]
}
```

### 9.5 Notificações e Alertas (RF066, RF067)

**Eventos que geram notificações:**
- Linha ativada com sucesso
- Portabilidade aprovada/rejeitada
- Chip trocado com sucesso
- Linha suspensa/cancelada
- Vencimento de contrato (30/60/90 dias)
- Estoque de chips baixo (<10 unidades)
- Linha subutilizada detectada
- Operação pendente de aprovação

---

## 10. SEGURANÇA

### 10.1 Validação de Entrada

- Validação de formato de números telefônicos (regex)
- Validação de ICCID (19-20 dígitos numéricos)
- Validação de IMSI (14-15 dígitos numéricos)
- Validação de IMEI (15 dígitos numéricos)
- Validação de protocolo ANATEL (10-12 dígitos numéricos)
- Sanitização de inputs para prevenção de SQL Injection
- Validação de tamanho de arquivos de importação (max 10MB)

### 10.2 Isolamento Multi-tenant

- Filtro automático por `ClienteId` em todas as queries
- Row-Level Security no banco de dados
- Validação de acesso cruzado entre clientes (HTTP 403)

### 10.3 Rate Limiting

- Máximo 100 requests/minuto por usuário
- Máximo 10 importações/hora por cliente

### 10.4 Proteção de APIs Externas

- Circuit Breaker para APIs de operadoras
- Retry com backoff exponencial
- Timeout de 30 segundos por request

---

## 11. MÉTRICAS E INDICADORES

### 11.1 KPIs de Negócio

| KPI | Meta | Frequência |
|-----|------|------------|
| Taxa de Ativação | Medir quantidade de ativações/mês | Mensal |
| Taxa de Portabilidade | Medir quantidade de portabilidades/mês | Mensal |
| Taxa de Cancelamento | <5% das linhas ativas/mês | Mensal |
| Economia por Otimização | Medir R$ economizados com downgrade/cancelamento | Mensal |
| Estoque de Chips | Manter >10 chips por operadora | Diário |
| Tempo Médio de Aprovação | <24 horas para operações pendentes | Diário |
| Linhas Subutilizadas | Medir % de linhas com consumo <10% | Mensal |

### 11.2 KPIs Técnicos

| KPI | Meta | Frequência |
|-----|------|------------|
| Tempo de Resposta API | P95 <300ms | Tempo real |
| Taxa de Sucesso Sincronização | >95% | Diário |
| Taxa de Erro Importação | <5% de linhas com erro | Por importação |
| Disponibilidade do Sistema | >99.9% | Mensal |
| Tempo de Carregamento Dashboard | <2 segundos | Tempo real |

---

## 12. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF050.md** - Casos de Uso detalhados
- **MD-RF050.md** - Modelo de Dados (DDL, ER Diagram)
- **WF-RF050.md** - Wireframes e Fluxos de Tela
- **TC-RF050-BACKEND.md** - Casos de Teste Backend
- **TC-RF050-FRONTEND.md** - Casos de Teste Frontend
- **TC-RF050-SEGURANCA.md** - Casos de Teste Segurança
- **TC-RF050-E2E.md** - Casos de Teste E2E
- **MT-RF050.yaml** - Massas de Teste

---

## 13. RASTREABILIDADE

| Artefato | Status | Responsável |
|----------|--------|-------------|
| RF050.md | ✅ Criado | Architect Agent |
| RF050.yaml | ⏳ Pendente | Architect Agent |
| RL-RF050.md | ⏳ Pendente | Architect Agent |
| RL-RF050.yaml | ⏳ Pendente | Architect Agent |
| UC-RF050.md | ✅ Criado | Architect Agent |
| MD-RF050.md | ✅ Criado | Architect Agent |
| WF-RF050.md | ✅ Criado | Architect Agent |
| TC-RF050-BACKEND.md | ✅ Criado | Tester Agent |
| Implementação Backend | ✅ Concluído | Developer Agent |
| Implementação Frontend | ✅ Concluído | Developer Agent |
| Testes Unitários | ⏳ Pendente | Developer Agent |
| Testes E2E | ⏳ Pendente | Tester Agent |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 1.0 | 2025-12-18 | Versão inicial com 15 regras de negócio | IControlIT Architect Agent |
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0 - Separação RF/RL, contrato moderno com 11 seções obrigatórias | Agência ALC - alc.dev.br |
