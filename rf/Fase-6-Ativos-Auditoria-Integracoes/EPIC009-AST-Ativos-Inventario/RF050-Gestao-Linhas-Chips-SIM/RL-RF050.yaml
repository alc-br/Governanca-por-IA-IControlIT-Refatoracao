rf_id: RF050
rf_title: "Gestão de Linhas Móveis e Chips SIM"
versao_governanca: "2.0"
data_migracao: "2025-12-30"

# ==============================================================================
# ITENS LEGADO RASTREADOS
# ==============================================================================

itens_legado:
  # ------------------------------------------------------------------------------
  # TELAS ASPX
  # ------------------------------------------------------------------------------
  - id: "LEG-RF050-001"
    tipo: "tela"
    titulo: "Listagem de Linhas Móveis (Default.aspx)"
    caminho_legado: "ic1_legado/IControlIT/Telecom/LinhasMoveis/Default.aspx"
    descricao: |
      Tela de listagem de linhas móveis com filtros básicos (operadora, status, consumidor).
      Paginação hard-coded em 50 linhas. Ordenação por data de ativação DESC.
      Soft delete não existia (delete físico). Sem controle de permissões.
    regras_implicitas:
      - "Filtro de operadora carregava apenas operadoras com linhas ativas"
      - "Paginação fixa em 50 linhas sem possibilidade de configuração"
      - "Delete físico ao excluir linha (perda de auditoria)"
    destino: "SUBSTITUÍDO"
    justificativa: "Substituído por tela moderna Angular 19 com filtros dinâmicos, paginação configurável, soft delete e RBAC"
    rastreabilidade:
      rf_moderno: "RF050 - Seção 4 (Funcionalidades Cobertas) - Item 1"
      uc_moderno: "UC-RF050 - Listar Linhas Móveis"
    migracao_moderna:
      componente_angular: "linhas-moveis-list.component.ts"
      rota_frontend: "/gestao/linhas-moveis"

  - id: "LEG-RF050-002"
    tipo: "tela"
    titulo: "Cadastro/Edição de Linha (Editar.aspx)"
    caminho_legado: "ic1_legado/IControlIT/Telecom/LinhasMoveis/Editar.aspx"
    descricao: |
      Tela de criação e edição de linhas móveis com validações básicas.
      Validações apenas em JavaScript (podia bypassar). Unicidade de Número/ICCID validada apenas no banco.
      Sem workflow de aprovação. Sem auditoria. Histórico de trocas não registrado.
    regras_implicitas:
      - "Unicidade de Número e ICCID validada apenas por constraint no banco (erro genérico)"
      - "Histórico de trocas de chip não era registrado (ICCID sobrescrito)"
      - "Sem workflow de aprovação para planos caros (ativação imediata)"
      - "Campos de auditoria inexistentes"
    destino: "SUBSTITUÍDO"
    justificativa: "Substituído por formulário moderno com validações FluentValidation backend + validações reativas Angular"
    rastreabilidade:
      rf_moderno: "RF050 - Seção 5 - RN-050-001, RN-050-002"
      uc_moderno: "UC-RF050 - Criar/Editar Linha"
    migracao_moderna:
      componente_angular: "linhas-moveis-form.component.ts"
      command_cqrs: "CreateLinhaMovelCommand, UpdateLinhaMovelCommand"
      validador: "CreateLinhaMovelCommandValidator"

  - id: "LEG-RF050-003"
    tipo: "tela"
    titulo: "Operações sobre Linha (Operacoes.aspx)"
    caminho_legado: "ic1_legado/IControlIT/Telecom/LinhasMoveis/Operacoes.aspx"
    descricao: |
      Tela para executar operações críticas (portabilidade, troca chip, suspensão, cancelamento).
      Sem validação de protocolo ANATEL. Prazo de 7 dias não validado. Sem workflow de aprovação.
      Execução imediata por qualquer usuário. Sem notificações ao consumidor.
    regras_implicitas:
      - "Portabilidade sem validação de protocolo ANATEL (aceitava qualquer texto)"
      - "Prazo mínimo de 7 dias não validado (erro manual comum)"
      - "Troca de chip não registrava histórico (ICCID sobrescrito)"
      - "Suspensão sem prazo máximo (linhas ficavam suspensas indefinidamente)"
      - "Cancelamento sem cálculo de multa (feito manualmente no financeiro)"
    destino: "SUBSTITUÍDO"
    justificativa: "Substituído por wizard moderno com validações rigorosas, workflow multi-nível e notificações automáticas"
    rastreabilidade:
      rf_moderno: "RF050 - Seção 5 - RN-050-003, RN-050-004, RN-050-007, RN-050-011, RN-050-012"
      uc_moderno: "UC-RF050 - Portabilidade, Troca Chip, Suspensão, Cancelamento"
    migracao_moderna:
      componente_angular: "operacoes-linha-wizard.component.ts"
      command_cqrs: "PortabilidadeLinhaCommand, TrocaChipCommand, SuspendLinhaMovelCommand, CancelLinhaMovelCommand"
      workflow: "ApprovalWorkflowService (RF066/RF067)"

  - id: "LEG-RF050-004"
    tipo: "tela"
    titulo: "Estoque de Chips (Estoque.aspx)"
    caminho_legado: "ic1_legado/IControlIT/Telecom/Chips/Estoque.aspx"
    descricao: |
      Tela de controle de entrada e saída de chips SIM no estoque.
      Entrada manual (um por um ou lote). Sem rastreamento de lote/fornecedor.
      Sem alertas de estoque baixo. Chips defeituosos misturados com estoque normal.
    regras_implicitas:
      - "Entrada de chips manual (geração sequencial de ICCID em lote)"
      - "Sem controle de lote/fornecedor (não rastreava origem)"
      - "Sem alertas de estoque baixo (verificação manual)"
      - "Chips defeituosos não separados (risco de uso acidental)"
      - "Chips parados >6 meses não identificados"
    destino: "ASSUMIDO"
    justificativa: "Funcionalidade mantida com melhorias: alertas automáticos, rastreamento de lote, conciliação de inventário"
    rastreabilidade:
      rf_moderno: "RF050 - Seção 5 - RN-050-005"
      uc_moderno: "UC-RF050 - Gestão de Estoque de Chips"
    migracao_moderna:
      componente_angular: "chips-estoque.component.ts, estoque-chips-dashboard.component.ts"
      service: "EstoqueChipsService"
      job_hangfire: "EstoqueBaixoAlertJob (diário)"

  # ------------------------------------------------------------------------------
  # WEBSERVICES
  # ------------------------------------------------------------------------------
  - id: "LEG-RF050-005"
    tipo: "webservice"
    titulo: "LinhasMovelsService.asmx"
    caminho_legado: "ic1_legado/IControlIT/Telecom/WebService/LinhasMovelsService.asmx"
    metodos:
      - nome: "GetLinhasByOperadora"
        parametros: "int operadoraId"
        retorno: "List<LinhaMovel>"
      - nome: "CreateLinha"
        parametros: "string numero, string iccid, int operadoraId, int planoId"
        retorno: "int linhaId"
      - nome: "UpdateLinha"
        parametros: "int linhaId, string numero, string iccid"
        retorno: "bool success"
      - nome: "DeleteLinha"
        parametros: "int linhaId"
        retorno: "bool success"
      - nome: "ActivateLinha"
        parametros: "int linhaId, string chipIccid"
        retorno: "bool success"
      - nome: "CancelLinha"
        parametros: "int linhaId, string motivo"
        retorno: "bool success"
    descricao: |
      WebService SOAP para CRUD básico de linhas móveis. Autenticação Basic Auth (inseguro).
      Sem rate limiting. Sem versionamento. Erros genéricos. Sem logging.
    destino: "SUBSTITUÍDO"
    justificativa: "Substituído por REST API moderna com JWT, rate limiting, versionamento e erros estruturados"
    rastreabilidade:
      rf_moderno: "RF050 - Seção 8 (API Endpoints)"
      endpoint_moderno: "GET/POST/PUT/DELETE /api/gestao/linhas-moveis"
    migracao_moderna:
      rest_api: "/api/gestao/linhas-moveis (17 endpoints RESTful)"
      autenticacao: "JWT Bearer Token"
      rate_limiting: "100 requests/minuto"

  # ------------------------------------------------------------------------------
  # STORED PROCEDURES
  # ------------------------------------------------------------------------------
  - id: "LEG-RF050-006"
    tipo: "stored_procedure"
    titulo: "usp_LinhaMovel_Insert"
    caminho_legado: "ic1_legado/Database/Procedures/usp_LinhaMovel_Insert.sql"
    parametros_entrada:
      - "@Numero VARCHAR(20)"
      - "@ICCID VARCHAR(20)"
      - "@IMSI VARCHAR(15)"
      - "@IMEI VARCHAR(15)"
      - "@OperadoraId INT"
      - "@PlanoId INT"
      - "@ConsumidorId INT = NULL"
      - "@DataAtivacao DATETIME"
      - "@ValorMensal DECIMAL(10,2)"
    parametros_saida:
      - "@LinhaId INT OUTPUT"
    descricao: |
      Stored procedure para inserir nova linha móvel. Valida unicidade de Número e ICCID.
      Atualiza status do chip para Ativo. Sem auditoria. Sem notificação ao consumidor.
    destino: "SUBSTITUÍDO"
    justificativa: "Lógica movida para CQRS Handler com validações FluentValidation e auditoria automática"
    rastreabilidade:
      rf_moderno: "RF050 - Seção 5 - RN-050-001, RN-050-002"
      regra_moderna: "RN-050-002"
    migracao_moderna:
      handler: "CreateLinhaMovelCommandHandler"
      validador: "CreateLinhaMovelCommandValidator"
      auditoria: "AuditInterceptor (automático EF Core)"

  - id: "LEG-RF050-007"
    tipo: "stored_procedure"
    titulo: "usp_LinhaMovel_Portabilidade"
    caminho_legado: "ic1_legado/Database/Procedures/usp_LinhaMovel_Portabilidade.sql"
    parametros_entrada:
      - "@LinhaId INT"
      - "@NovaOperadoraId INT"
      - "@NovoChipIccid VARCHAR(20)"
      - "@ProtocoloANATEL VARCHAR(12)"
      - "@DataAgendamento DATETIME"
    descricao: |
      Stored procedure para executar portabilidade. Atualiza operadora e ICCID da linha.
      Sem validação de protocolo ANATEL. Sem validação de prazo mínimo 7 dias.
      Sem histórico de trocas. Sem notificação ao consumidor.
    destino: "SUBSTITUÍDO"
    justificativa: "Lógica movida para CQRS Handler com validações rigorosas (protocolo, prazo) e workflow de aprovação"
    rastreabilidade:
      rf_moderno: "RF050 - Seção 5 - RN-050-003, RN-050-007"
      regra_moderna: "RN-050-003"
    migracao_moderna:
      handler: "PortabilidadeLinhaCommandHandler"
      validador: "PortabilidadeLinhaCommandValidator (valida protocolo + prazo)"
      workflow: "ApprovalWorkflowService (Gestor + Financeiro)"

  - id: "LEG-RF050-008"
    tipo: "stored_procedure"
    titulo: "usp_Chip_EstoqueReport"
    caminho_legado: "ic1_legado/Database/Procedures/usp_Chip_EstoqueReport.sql"
    parametros_entrada:
      - "@OperadoraId INT = NULL"
    parametros_saida:
      - "Tabela: Operadora, TotalNovo, TotalAtivo, TotalDefeituoso"
    descricao: |
      Stored procedure para gerar relatório de estoque de chips por operadora e status.
      Sem detecção de chips parados >6 meses. Sem alertas de estoque baixo.
    destino: "ASSUMIDO"
    justificativa: "Query mantida com melhorias: detecção de chips parados e alertas automáticos via job Hangfire"
    rastreabilidade:
      rf_moderno: "RF050 - Seção 5 - RN-050-005"
      regra_moderna: "RN-050-005"
    migracao_moderna:
      query: "GetEstoqueChipsQuery"
      job: "EstoqueBaixoAlertJob (Hangfire diário)"

  # ------------------------------------------------------------------------------
  # TABELAS LEGADAS
  # ------------------------------------------------------------------------------
  - id: "LEG-RF050-009"
    tipo: "tabela"
    titulo: "LinhasMoveis"
    schema_legado: "[dbo].[LinhasMoveis]"
    problemas_identificados:
      - "Sem FK para ChipId (relacionamento apenas por ICCID string - ineficiente)"
      - "Sem campos de auditoria (Created, CreatedBy, LastModified, LastModifiedBy)"
      - "Sem soft delete (IsDeleted) - delete físico irreversível"
      - "Sem multi-tenancy (ClienteId) - tabela por banco físico"
      - "Campos IMSI e IMEI na mesma tabela (deveriam estar em histórico separado)"
      - "Sem índice em Número (consultas lentas)"
      - "Sem índice composto (Operadora + Status)"
    destino: "SUBSTITUÍDO"
    justificativa: "Tabela redesenhada com FKs, auditoria, soft delete, multi-tenancy e índices otimizados"
    rastreabilidade:
      rf_moderno: "RF050 - Seção 12 (Artefatos Derivados)"
      md_moderno: "MD-RF050.md - Tabela LinhaMovel"
    migracao_moderna:
      tabela_moderna: "LinhaMovel (Entity Framework)"
      migration_ef_core: "20251230_CreateLinhaMovelTable.cs"
      indices: "IX_LinhaMovel_Numero, IX_LinhaMovel_Operadora_Status, IX_LinhaMovel_ClienteId"

  - id: "LEG-RF050-010"
    tipo: "tabela"
    titulo: "Chips"
    schema_legado: "[dbo].[Chips]"
    problemas_identificados:
      - "Sem FK para OperadoraId (relacionamento apenas por nome string)"
      - "Sem rastreamento de lote/fornecedor"
      - "Sem data de entrada/saída (apenas status atual)"
      - "Sem auditoria de movimentações"
      - "Sem separação de chips de teste/homologação"
      - "Sem alerta automático de estoque baixo"
    destino: "SUBSTITUÍDO"
    justificativa: "Tabela redesenhada com FKs, rastreamento de lote, movimentações auditadas e alertas"
    rastreabilidade:
      rf_moderno: "RF050 - Seção 12 (Artefatos Derivados)"
      md_moderno: "MD-RF050.md - Tabelas ChipSIM, EstoqueChip, HistoricoLinhaChip"
    migracao_moderna:
      tabela_moderna: "ChipSIM"
      tabela_relacionada_1: "EstoqueChip (movimentações)"
      tabela_relacionada_2: "HistoricoLinhaChip (trocas)"

  - id: "LEG-RF050-011"
    tipo: "tabela"
    titulo: "OperacoesLinhas (NÃO EXISTIA no legado)"
    schema_legado: "N/A - Tabela inexistente"
    problemas_identificados:
      - "Operações não eram registradas em tabela dedicada"
      - "Histórico inferido por datas de atualização (impreciso)"
      - "Sem rastreamento de aprovadores"
      - "Sem rastreamento de justificativas"
    destino: "A_REVISAR"
    justificativa: "Tabela criada no sistema moderno para rastrear operações com workflow de aprovação"
    rastreabilidade:
      rf_moderno: "RF050 - Seção 6.3 (Estados de Operação de Linha)"
      md_moderno: "MD-RF050.md - Tabela OperacaoLinha"
    migracao_moderna:
      tabela_moderna: "OperacaoLinha"
      estados: "Pendente, Aprovada, Executada, Rejeitada, Cancelada"

  # ------------------------------------------------------------------------------
  # REGRAS IMPLÍCITAS
  # ------------------------------------------------------------------------------
  - id: "LEG-RF050-012"
    tipo: "regra_negocio"
    titulo: "Validação de Número de Telefone Móvel Brasileiro"
    localizacao_codigo: "ic1_legado/IControlIT/Telecom/LinhasMoveis/Editar.aspx - JavaScript validation"
    descricao: |
      Número de telefone móvel brasileiro deve ter 11 dígitos: 2 (DDD) + 1 (9 obrigatório) + 8 (número único).
      Regex: ^\d{2}9\d{8}$
      Exemplo válido: 11987654321
    destino: "ASSUMIDO"
    justificativa: "Regra documentada e mantida com validação FluentValidation"
    rastreabilidade:
      rf_moderno: "RF050 - Seção 5 - RN-050-001"
      regra_moderna: "RN-050-001"
    migracao_moderna:
      validador: "CreateLinhaMovelCommandValidator"
      regex: "^[0-9]{2}9[0-9]{8}$"

  - id: "LEG-RF050-013"
    tipo: "regra_negocio"
    titulo: "ICCID Deve Ser Único Globalmente"
    localizacao_codigo: "ic1_legado/Database/Constraints/UK_Chips_ICCID.sql"
    descricao: |
      ICCID é identificador único mundial de chip SIM. Sistema rejeita duplicatas com HTTP 400.
      Constraint UNIQUE em coluna ICCID.
    destino: "ASSUMIDO"
    justificativa: "Constraint mantida no banco moderno + validação adicional em FluentValidation"
    rastreabilidade:
      rf_moderno: "RF050 - Seção 5 - RN-050-006"
      regra_moderna: "RN-050-006"
    migracao_moderna:
      constraint: "UNIQUE INDEX IX_ChipSIM_ICCID ON ChipSIM (ICCID)"
      validador: "CreateChipSIMCommandValidator"

  - id: "LEG-RF050-014"
    tipo: "regra_negocio"
    titulo: "Troca de Chip Por Perda Gera Cobrança R$20,00"
    localizacao_codigo: "ic1_legado/IControlIT/Telecom/LinhasMoveis/Operacoes.aspx.vb - linha ~350"
    descricao: |
      Troca de chip por perda ou roubo gera cobrança automática de R$20,00 ao consumidor.
      Valor inserido em cobranças avulsas. Se linha sem consumidor, apenas log de aviso.
    destino: "ASSUMIDO"
    justificativa: "Regra mantida, mas valor torna-se configurável por cliente (não hard-coded)"
    rastreabilidade:
      rf_moderno: "RF050 - Seção 5 - RN-050-004"
      regra_moderna: "RN-050-004"
    migracao_moderna:
      handler: "TrocaChipCommandHandler"
      configuracao: "AppSettings:TrocaChipPerdaCusto (configurável por cliente)"
      integracao: "RF026 (Gestão de Faturas)"

  - id: "LEG-RF050-015"
    tipo: "regra_negocio"
    titulo: "Portabilidade Requer Prazo Mínimo 7 Dias Úteis"
    localizacao_codigo: "ic1_legado/IControlIT/Telecom/LinhasMoveis/Operacoes.aspx.vb - BUG: regra NÃO implementada"
    descricao: |
      Portabilidade deve ser agendada para mínimo 7 dias úteis (regulamentação ANATEL).
      Sistema calcula data mínima considerando apenas dias úteis (segunda-sexta, exceto feriados).
    destino: "ASSUMIDO"
    justificativa: "Regra que estava faltando no legado foi implementada no sistema moderno"
    rastreabilidade:
      rf_moderno: "RF050 - Seção 5 - RN-050-003"
      regra_moderna: "RN-050-003"
    migracao_moderna:
      validador: "PortabilidadeLinhaCommandValidator"
      validacao: "DataAgendamento >= DateTime.Now.AddBusinessDays(7)"
      helper: "BusinessDaysHelper (calcula dias úteis)"

  - id: "LEG-RF050-016"
    tipo: "regra_negocio"
    titulo: "Linha Suspensa Tem Cobrança Reduzida 50%"
    localizacao_codigo: "ic1_legado/Database/Procedures/usp_Fatura_Calcular.sql"
    descricao: |
      Linha suspensa não pode fazer/receber chamadas, mas número é mantido.
      Operadora cobra 50% do valor do plano durante suspensão.
      Percentual pode variar conforme contrato (configurável).
    destino: "ASSUMIDO"
    justificativa: "Regra mantida, mas percentual de desconto torna-se configurável"
    rastreabilidade:
      rf_moderno: "RF050 - Seção 5 - RN-050-011"
      regra_moderna: "RN-050-011"
    migracao_moderna:
      handler: "SuspendLinhaMovelCommandHandler"
      configuracao: "AppSettings:SuspensaoDescontoPercentual (padrão: 50%)"
      integracao: "RF026 (Gestão de Faturas)"

# ==============================================================================
# BANCOS LEGADOS MAPEADOS
# ==============================================================================

bancos_legados:
  - nome: "IControlIT_Cliente01"
    servidor: "SQL-LEGADO-01"
    tabelas_relacionadas:
      - "LinhasMoveis"
      - "Chips"
      - "Operadoras"
      - "Planos"
      - "Consumidores"
    destino: "CONSOLIDADO"
    justificativa: "Migrado para banco único com multi-tenancy (Row-Level Security via ClienteId)"
    banco_moderno: "IControlIT.db (SQLite dev) / SQL Server moderno (prod) com ClienteId"

  - nome: "IControlIT_Cliente02"
    servidor: "SQL-LEGADO-01"
    tabelas_relacionadas:
      - "LinhasMoveis"
      - "Chips"
      - "Operadoras"
      - "Planos"
    destino: "CONSOLIDADO"
    justificativa: "Consolidado no banco único multi-tenant"
    banco_moderno: "IControlIT.db / SQL Server com ClienteId=2"

  - nome: "IControlIT_Cliente03"
    servidor: "SQL-LEGADO-02"
    tabelas_relacionadas:
      - "LinhasMoveis"
      - "Chips"
    destino: "CONSOLIDADO"
    justificativa: "Consolidado no banco único multi-tenant"
    banco_moderno: "IControlIT.db / SQL Server com ClienteId=3"

# ==============================================================================
# PROBLEMAS LEGADO IDENTIFICADOS
# ==============================================================================

problemas_legado:
  - id: "PROB-RF050-001"
    titulo: "Multi-Database Dificulta Manutenção e Consultas Agregadas"
    severidade: "ALTA"
    descricao: |
      Cada cliente tinha banco SQL Server separado, dificultando backup,
      manutenção e consultas cross-cliente para administradores.
    impacto: "Alto custo de infraestrutura, backup complexo, impossibilidade de consultas agregadas"
    solucao_moderna: "Banco único SQLite (dev) / SQL Server (prod) com isolamento lógico via ClienteId (Row-Level Security)"

  - id: "PROB-RF050-002"
    titulo: "Falta de Workflow de Aprovação para Operações Críticas"
    severidade: "CRÍTICA"
    descricao: |
      Operações como portabilidade, ativação de planos caros e cancelamentos
      eram executadas imediatamente sem aprovação formal, gerando risco financeiro.
    impacto: "Falta de governança, risco financeiro, dificuldade de auditoria"
    solucao_moderna: "Workflow de aprovação multi-nível com SLA de 24 horas e notificações automáticas via RF066/RF067"

  - id: "PROB-RF050-003"
    titulo: "Validações Fragmentadas (JavaScript + VB.NET + SQL)"
    severidade: "ALTA"
    descricao: |
      Validações duplicadas em frontend (JavaScript), code-behind (VB.NET)
      e stored procedures, gerando inconsistências e bugs.
    impacto: "Inconsistências, bugs, dificuldade de manutenção, validações podiam ser bypassadas"
    solucao_moderna: "Validações centralizadas no backend com FluentValidation, garantindo consistência e segurança"

  - id: "PROB-RF050-004"
    titulo: "Histórico de Trocas de Chip Não Registrado"
    severidade: "MÉDIA"
    descricao: |
      Histórico de trocas de chip não era registrado (ICCID era sobrescrito),
      impossibilitando rastreamento e detecção de anomalias.
    impacto: "Perda de rastreabilidade, dificuldade em detectar múltiplas trocas suspeitas, suporte técnico limitado"
    solucao_moderna: "Tabela HistoricoLinhaChip com registro completo de todas as trocas (7 anos de retenção LGPD)"

  - id: "PROB-RF050-005"
    titulo: "Autenticação Insegura em WebServices ASMX (Basic Auth)"
    severidade: "CRÍTICA"
    descricao: |
      WebServices ASMX usavam autenticação Basic Auth (usuário/senha em cada request)
      sem HTTPS obrigatório, vulnerável a interceptação.
    impacto: "Risco de segurança, credenciais expostas, sem rate limiting (DoS)"
    solucao_moderna: "REST API com autenticação JWT Bearer Token, HTTPS obrigatório, rate limiting 100 req/min"

  - id: "PROB-RF050-006"
    titulo: "Falta de Auditoria Completa de Operações"
    severidade: "ALTA"
    descricao: |
      Auditoria parcial ou inexistente em operações de linhas.
      Campos Created, CreatedBy, LastModified, LastModifiedBy não existiam.
    impacto: "Falta de compliance LGPD, dificuldade em auditorias externas, rastreabilidade limitada"
    solucao_moderna: "Auditoria automática via AuditInterceptor do EF Core com retenção 7 anos conforme LGPD"

# ==============================================================================
# METADADOS
# ==============================================================================

metadados:
  total_itens_legado: 16
  itens_assumidos: 5
  itens_substituidos: 10
  itens_descartados: 0
  itens_a_revisar: 1
  cobertura_destinos: "100%"
