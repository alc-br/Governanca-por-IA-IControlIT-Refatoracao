# RF-068: Inventário Cíclico e Auditoria de Estoque

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC009-AST-Ativos-Inventario
**Fase**: Fase 6 - Ativos, Auditoria e Integrações

---

## 1. OBJETIVO DO REQUISITO

Descrever de forma clara, objetiva e verificável o comportamento esperado do módulo de **Inventário Cíclico e Auditoria de Estoque** do sistema IControlIT, responsável pela contagem física periódica de ativos, conciliação entre quantidades registradas no sistema e quantidades reais, identificação e tratamento de divergências (perdas, sobras), e geração de relatórios de compliance com rastreabilidade total.

Este documento **não define implementação**, apenas **o que o sistema deve fazer**, sob quais condições e quais garantias devem ser preservadas.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Criação de inventários (geral, cíclico ABC, parcial)
- [x] Gerenciamento de classificação ABC (A: alta rotatividade, B: média, C: baixa)
- [x] Contagem física via app mobile com leitura de barcode/QR code
- [x] Registro de contagens duplas cegas para itens críticos
- [x] Identificação automática de divergências (Qtd_Sistema vs Qtd_Contada)
- [x] Workflow de aprovação de ajustes (supervisor obrigatório)
- [x] Recontagem obrigatória para divergências > 5%
- [x] Bloqueio de movimentações de estoque durante inventário
- [x] Conciliação automática e manual
- [x] Dashboard de acompanhamento em tempo real (SignalR)
- [x] Geração de relatórios de auditoria ISO 9001
- [x] Histórico imutável de contagens e ajustes
- [x] Notificações push para divergências
- [x] Exportação de resultados (Excel, PDF)
- [x] Integração com ERP para ajustes contábeis
- [x] Validações funcionais e regras de negócio
- [x] Controle de acesso e isolamento por tenant
- [x] Auditoria de operações (compliance LGPD)

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica
- Tecnologia, framework ou linguagem
- Layout, UX ou identidade visual
- Estratégia de deploy ou infraestrutura
- RFID automático (será RF separado - melhoria futura)
- Drones para inventário (será RF separado - melhoria futura)
- IA para predição de divergências (será RF separado - melhoria futura)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-----|---------|
| **Inventário** | Processo de contagem física de ativos em um ou mais almoxarifados para validar consistência com registros do sistema. |
| **Inventário Geral** | Contagem completa de todos os itens de todos os almoxarifados. Realizado anualmente ou sob demanda. |
| **Inventário Cíclico** | Contagem periódica baseada em classificação ABC. Itens A contados mensalmente, B trimestralmente, C anualmente. |
| **Inventário Parcial** | Contagem de um subconjunto de itens (filtro por categoria, localização, valor, etc.). |
| **Classificação ABC** | Categorização de itens por valor acumulado: A (80% do valor, 20% dos itens), B (15% do valor, 30% dos itens), C (5% do valor, 50% dos itens). |
| **Divergência** | Diferença entre quantidade registrada no sistema (Qtd_Sistema) e quantidade contada fisicamente (Qtd_Contada). Pode ser positiva (sobra) ou negativa (perda). |
| **Contagem Dupla Cega** | Para itens críticos (classificação A), exigir contagem independente por 2 usuários sem que um veja resultado do outro. |
| **Ajuste de Estoque** | Correção da quantidade no sistema baseada na contagem física. Requer justificativa e aprovação de supervisor. |
| **Conciliação** | Processo de validar contagem e decidir se divergência será ajustada ou será solicitada recontagem. |
| **Almoxarifado** | Localização física onde ativos são armazenados. Um inventário ocorre em um ou mais almoxarifados. |
| **Tenant** | Unidade lógica de isolamento de dados (ClienteId). |
| **Usuário** | Agente autenticado que executa ações. |
| **Operação** | Ação executável sobre a entidade Inventário. |

---

## 4. FUNCIONALIDADES COBERTAS

1. Criar inventário (definir tipo, almoxarifado, data início)
2. Gerar lista de itens a contar (filtros por classificação ABC, categoria, localização)
3. Atribuir responsáveis pela contagem (usuários com permissão)
4. Contar item via app mobile (barcode/QR scan)
5. Registrar contagem dupla cega (itens críticos)
6. Identificar divergências automaticamente
7. Solicitar recontagem (divergência > 5%)
8. Aprovar ou rejeitar ajuste de estoque
9. Conciliar inventário (validar todas as contagens)
10. Finalizar inventário (bloquear alterações, gerar relatório)
11. Visualizar dashboard de progresso em tempo real
12. Listar inventários com filtros (status, tipo, período)
13. Exportar resultados (Excel, PDF)
14. Integrar ajustes com ERP (lançamento contábil)
15. Consultar histórico de inventários passados

---

## 5. REGRAS DE NEGÓCIO

### RN-RF068-001 — Classificação ABC Obrigatória para Inventário Cíclico

**Descrição**: Todo item de estoque deve ter classificação ABC (A, B ou C) para ser incluído em inventário cíclico. Classificação calculada por valor acumulado (Quantidade × Custo Unitário).

**Justificativa**: Otimiza recursos de contagem priorizando itens de maior impacto financeiro (Princípio de Pareto).

**Critério de Aceite**:
- Item sem classificação ABC → não incluído em inventário cíclico
- Criar inventário cíclico sem itens classificados → rejeição HTTP 400
- Reclassificação ABC automática a cada 3 meses (job Hangfire)

**Exemplos**:
- ✅ Válido: Notebook Dell (valor R$ 500k, 100 unidades × R$ 5k) → Classificação A → Contagem mensal
- ✅ Válido: Teclado USB (valor R$ 2k, 200 unidades × R$ 10) → Classificação C → Contagem anual
- ❌ Inválido: Item novo sem classificação → não aparece em inventário cíclico até classificação ser calculada

---

### RN-RF068-002 — Contagem Dupla Cega para Itens Classificação A

**Descrição**: Itens classificação A devem ser contados por 2 usuários diferentes de forma independente (cega). O sistema só aceita contagem se ambas concordarem ou se houver aprovação de supervisor para a divergência.

**Justificativa**: Reduz erro humano em itens de alto valor (80% do valor total do estoque).

**Critério de Aceite**:
- Item A contado por apenas 1 usuário → status "Pendente 2ª Contagem"
- Contagens discordantes → diferença > 2% → solicitar recontagem
- Contagens concordantes → aceitar automaticamente
- Supervisor pode aceitar contagem única em situação excepcional (registrar justificativa)

**Exemplos**:
- ✅ Válido: Usuário A conta 50 notebooks, Usuário B conta 50 → aceito automaticamente
- ⚠️ Atenção: Usuário A conta 50 notebooks, Usuário B conta 48 (diff 4%) → recontagem obrigatória
- ❌ Inválido: Item A sem 2ª contagem → inventário não pode ser finalizado

---

### RN-RF068-003 — Divergência > 5% Exige Recontagem

**Descrição**: Quando divergência entre Qtd_Sistema e Qtd_Contada for superior a 5%, o sistema deve exigir recontagem obrigatória antes de permitir ajuste.

**Justificativa**: Divergências grandes podem indicar erro de contagem, não perda/sobra real.

**Critério de Aceite**:
- Divergência ≤ 5% → ajuste permitido após aprovação
- Divergência > 5% → status "Recontagem Obrigatória"
- Após recontagem, nova divergência > 5% → aprovação de gerente obrigatória
- Cálculo divergência: `|(Qtd_Contada - Qtd_Sistema) / Qtd_Sistema| * 100`

**Exemplos**:
- ✅ Válido: Sistema 100 unidades, Contado 97 (diff 3%) → ajuste permitido
- ⚠️ Atenção: Sistema 100 unidades, Contado 90 (diff 10%) → recontagem obrigatória
- ⚠️ Crítico: Sistema 10 unidades, Contado 0 (diff 100%) → recontagem + aprovação gerente

---

### RN-RF068-004 — Ajuste de Estoque Exige Aprovação de Supervisor

**Descrição**: Qualquer ajuste de quantidade (positivo ou negativo) identificado em inventário deve ser aprovado por usuário com perfil Supervisor ou superior.

**Justificativa**: Ajustes de estoque têm impacto contábil e fiscal (perda = despesa, sobra = receita). Requer controle rigoroso.

**Critério de Aceite**:
- Ajuste sem aprovação → não aplicado ao estoque
- Ajuste aprovado → atualiza quantidade + registra na auditoria + notifica ERP
- Ajuste rejeitado → solicita nova contagem ou justificativa
- Aprovador não pode ser o mesmo usuário que contou

**Exemplos**:
- ✅ Válido: Contador João registra divergência -5 unidades → Supervisor Maria aprova → estoque ajustado
- ❌ Inválido: Contador João tenta aprovar próprio ajuste → rejeição HTTP 403
- ❌ Inválido: Ajuste aplicado sem aprovação → violação de auditoria

---

### RN-RF068-005 — Bloqueio de Movimentação Durante Inventário

**Descrição**: Enquanto inventário estiver com status "Em Andamento", almoxarifado inventariado não pode ter movimentações de entrada (recebimento) ou saída (requisição, transferência).

**Justificativa**: Evita inconsistência entre contagem física e registros do sistema durante o processo.

**Critério de Aceite**:
- Iniciar inventário → bloquear almoxarifado automaticamente
- Tentativa de movimentação → rejeição HTTP 409 ("Almoxarifado bloqueado por inventário")
- Finalizar inventário → desbloquear almoxarifado
- Cancelar inventário → desbloquear almoxarifado

**Exemplos**:
- ✅ Válido: Inventário iniciado → usuário tenta requisitar item → sistema bloqueia com mensagem
- ❌ Inválido: Permitir requisição durante inventário → contagem física fica desatualizada

---

### RN-RF068-006 — Almoxarifado Deve Estar Ativo

**Descrição**: Inventário só pode ser criado para almoxarifados com status "Ativo". Almoxarifados inativos não podem ter inventário.

**Justificativa**: Almoxarifados inativos não têm movimentação e não precisam de contagem.

**Critério de Aceite**:
- Almoxarifado inativo → rejeição HTTP 400
- Almoxarifado de outro tenant → rejeição HTTP 403
- Almoxarifado inexistente → rejeição HTTP 404

**Exemplos**:
- ✅ Válido: Criar inventário para "Almoxarifado Central" (ativo)
- ❌ Inválido: Tentar inventário em "Depósito Antigo" (inativo)

---

### RN-RF068-007 — Periodicidade Inventário Cíclico

**Descrição**: Inventário cíclico deve respeitar periodicidade baseada em classificação ABC: A (mensal), B (trimestral), C (anual). Sistema gera alertas automáticos quando período vencer.

**Justificativa**: Garante compliance com ISO 9001 e otimiza recursos de contagem.

**Critério de Aceite**:
- Job Hangfire executa diariamente para verificar periodicidade
- Item A sem contagem há > 30 dias → alerta
- Item B sem contagem há > 90 dias → alerta
- Item C sem contagem há > 365 dias → alerta
- Alerta enviado para responsável por inventário

**Exemplos**:
- ✅ Válido: Item A contado em 01/01 → próximo inventário devido em 01/02 (30 dias)
- ⚠️ Atenção: Item A contado em 01/01, hoje 15/02 → alerta "Inventário atrasado 15 dias"

---

### RN-RF068-008 — Histórico Imutável de Contagens

**Descrição**: Todas as contagens (primeira, segunda, recontagem) devem ser preservadas no histórico de forma imutável. Não é permitido alterar ou deletar contagens registradas.

**Justificativa**: Rastreabilidade e compliance auditoria (ISO 9001, SOX).

**Critério de Aceite**:
- Contagem registrada → não pode ser editada ou deletada
- Tentativa de edição → rejeição HTTP 403
- Nova contagem → cria novo registro vinculado ao item
- Histórico completo visível em auditoria

**Exemplos**:
- ✅ Válido: Contador registra 50 unidades → depois recontar e registrar 48 → ambas no histórico
- ❌ Inválido: Tentar alterar contagem de 50 para 48 → bloqueado

---

### RN-RF068-009 — Dashboard Tempo Real via SignalR

**Descrição**: Dashboard de acompanhamento de inventário deve atualizar em tempo real via SignalR conforme contagens são registradas. Exibir progresso (itens contados / total), divergências identificadas, usuários ativos.

**Justificativa**: Facilita gestão de equipes de contagem e permite intervenção rápida em problemas.

**Critério de Aceite**:
- Contagem registrada → dashboard atualiza em < 2 segundos
- Exibir: progresso %, divergências, contadores ativos, tempo estimado de conclusão
- Atualização automática sem refresh da página

**Exemplos**:
- ✅ Válido: Contador registra item → dashboard atualiza "324/500 itens (65%)"

---

### RN-RF068-010 — Integração com ERP para Ajustes Contábeis

**Descrição**: Ajustes de estoque aprovados devem ser enviados automaticamente para ERP para lançamento contábil (perda = despesa, sobra = receita).

**Justificativa**: Mantém consistência entre estoque físico, sistêmico e contábil.

**Critério de Aceite**:
- Ajuste aprovado → gerar evento `EstoqueAjustadoEvent`
- Evento consumido por integração ERP
- Em caso de falha → retry 3x com backoff exponencial (5min, 15min, 30min)
- Se 3 retries falharem → alerta para admin

**Exemplos**:
- ✅ Válido: Perda de 10 notebooks (R$ 50k) → lançamento contábil no ERP
- ⚠️ Atenção: Integração ERP offline → retry automático após 5 minutos

---

### RN-RF068-011 — Relatório de Auditoria ISO 9001

**Descrição**: Ao finalizar inventário, gerar relatório com estrutura compatível com ISO 9001 contendo: data, responsáveis, itens contados, divergências, ajustes, aprovações.

**Justificativa**: Compliance com certificações de qualidade.

**Critério de Aceite**:
- Relatório em formato PDF assinado digitalmente
- Conteúdo: cabeçalho (empresa, almoxarifado, período), resumo (total itens, divergências), detalhamento (item a item), assinaturas digitais (contador, supervisor)
- Armazenamento obrigatório por 7 anos (compliance LGPD)

**Exemplos**:
- ✅ Válido: Inventário finalizado → PDF gerado automaticamente e enviado para DMS (Document Management System)

---

### RN-RF068-012 — App Mobile Offline-First

**Descrição**: App mobile de contagem deve funcionar offline (PWA) e sincronizar contagens quando conexão for restabelecida. Evita bloqueio de contagem por falha de rede.

**Justificativa**: Almoxarifados podem ter sinal de internet fraco.

**Critério de Aceite**:
- Contagem registrada localmente (IndexedDB)
- Sincronização automática quando online
- Indicador visual de status (online/offline/sincronizando)
- Conflito (mesmo item contado offline por 2 usuários) → supervisor resolve

**Exemplos**:
- ✅ Válido: Contador sem sinal registra 50 itens → ao reconectar, sincroniza automaticamente

---

## 6. ESTADOS DA ENTIDADE

### Estados do Inventário

| Estado | Descrição |
|------|-----------|
| `Planejado` | Inventário criado, aguardando início |
| `EmAndamento` | Contagem iniciada, almoxarifado bloqueado |
| `AguardandoConciliacao` | Todas contagens registradas, aguardando validação de divergências |
| `Concluido` | Inventário finalizado, ajustes aplicados, relatório gerado |
| `Cancelado` | Inventário cancelado antes de conclusão |

### Transições Permitidas

| De | Para | Ação Gatilho |
|---|---|---|
| `Planejado` | `EmAndamento` | Iniciar inventário (bloquear almoxarifado) |
| `EmAndamento` | `AguardandoConciliacao` | Última contagem registrada |
| `AguardandoConciliacao` | `Concluido` | Todas divergências tratadas + aprovações |
| `EmAndamento` | `Cancelado` | Cancelar inventário (desbloquear almoxarifado) |
| `AguardandoConciliacao` | `EmAndamento` | Reabrir para recontagens |

---

### Estados do Item de Inventário

| Estado | Descrição |
|------|-----------|
| `Pendente` | Item aguardando contagem |
| `Contado` | Item contado, sem divergência |
| `Divergente` | Divergência identificada, aguardando tratamento |
| `RecontagemSolicitada` | Divergência > 5%, recontagem obrigatória |
| `AguardandoAprovacao` | Ajuste aguardando aprovação de supervisor |
| `Ajustado` | Ajuste aprovado e aplicado ao estoque |
| `Rejeitado` | Ajuste rejeitado, item retorna para recontagem |

---

## 7. PERMISSÕES RBAC

### Matriz de Permissões

| Operação | Permission Code | Roles Autorizadas |
|-------|---------|---------|
| Criar inventário | `INVENTARIO.CREATE` | Gerente de Almoxarifado, Coordenador de Inventário |
| Visualizar inventários | `INVENTARIO.VIEW` | Gerente, Coordenador, Contador, Auditor |
| Contar item | `INVENTARIO.COUNT` | Contador de Inventário |
| Aprovar ajuste | `INVENTARIO.APPROVE_ADJUSTMENT` | Supervisor, Gerente de Almoxarifado |
| Finalizar inventário | `INVENTARIO.FINALIZE` | Coordenador de Inventário, Gerente |
| Cancelar inventário | `INVENTARIO.CANCEL` | Gerente de Almoxarifado |
| Exportar relatório | `INVENTARIO.EXPORT` | Gerente, Auditor, Coordenador |
| Visualizar dashboard | `INVENTARIO.DASHBOARD` | Gerente, Coordenador |

---

## 8. API ENDPOINTS

### Inventários

| Método | Rota | Descrição | Autorização |
|------|------|-----------|-------------|
| GET | `/api/inventarios` | Listar inventários com filtros | `INVENTARIO.VIEW` |
| GET | `/api/inventarios/{id}` | Obter detalhes de inventário | `INVENTARIO.VIEW` |
| POST | `/api/inventarios` | Criar novo inventário | `INVENTARIO.CREATE` |
| PUT | `/api/inventarios/{id}/iniciar` | Iniciar inventário (bloquear almoxarifado) | `INVENTARIO.CREATE` |
| PUT | `/api/inventarios/{id}/finalizar` | Finalizar inventário | `INVENTARIO.FINALIZE` |
| PUT | `/api/inventarios/{id}/cancelar` | Cancelar inventário | `INVENTARIO.CANCEL` |
| GET | `/api/inventarios/{id}/dashboard` | Dashboard tempo real (SignalR) | `INVENTARIO.DASHBOARD` |
| GET | `/api/inventarios/{id}/relatorio` | Gerar relatório PDF | `INVENTARIO.EXPORT` |

### Contagens

| Método | Rota | Descrição | Autorização |
|------|------|-----------|-------------|
| GET | `/api/inventarios/{id}/itens` | Listar itens a contar | `INVENTARIO.VIEW` |
| POST | `/api/inventarios/{id}/itens/{itemId}/contar` | Registrar contagem | `INVENTARIO.COUNT` |
| GET | `/api/inventarios/{id}/divergencias` | Listar divergências | `INVENTARIO.VIEW` |
| POST | `/api/inventarios/{id}/itens/{itemId}/recontar` | Solicitar recontagem | `INVENTARIO.COUNT` |

### Ajustes

| Método | Rota | Descrição | Autorização |
|------|------|-----------|-------------|
| GET | `/api/inventarios/{id}/ajustes` | Listar ajustes pendentes | `INVENTARIO.APPROVE_ADJUSTMENT` |
| POST | `/api/inventarios/{id}/ajustes/{ajusteId}/aprovar` | Aprovar ajuste | `INVENTARIO.APPROVE_ADJUSTMENT` |
| POST | `/api/inventarios/{id}/ajustes/{ajusteId}/rejeitar` | Rejeitar ajuste | `INVENTARIO.APPROVE_ADJUSTMENT` |

---

## 9. INTEGRAÇÕES OBRIGATÓRIAS

### 9.1 i18n (Internacionalização)

**Transloco** com suporte a pt-BR (padrão), en-US, es-ES.

**Chaves obrigatórias:**
- `inventario.titulo` (Inventário de Estoque)
- `inventario.criar` (Criar Inventário)
- `inventario.tipo.geral` (Inventário Geral)
- `inventario.tipo.ciclico` (Inventário Cíclico)
- `inventario.status.emAndamento` (Em Andamento)
- `inventario.divergencia.titulo` (Divergências Identificadas)
- `inventario.ajuste.aprovar` (Aprovar Ajuste)

### 9.2 Auditoria

**Campos obrigatórios** em todas as tabelas:
- `Created` (DateTime2 NOT NULL DEFAULT GETDATE())
- `CreatedBy` (UNIQUEIDENTIFIER NOT NULL FK → Usuario)
- `LastModified` (DateTime2 NULL)
- `LastModifiedBy` (UNIQUEIDENTIFIER NULL FK → Usuario)

**Operações auditadas:**
- Criação de inventário
- Iniciar/finalizar/cancelar inventário
- Registrar contagem
- Aprovar/rejeitar ajuste

**Retenção:** 7 anos (compliance LGPD).

### 9.3 RBAC (Controle de Acesso)

**Integração com tabela `SistemaPermissao`**.

**Validação:** Toda operação valida permissão antes de executar.

### 9.4 Central de Funcionalidades

**Código:** `INVENTARIO`
**Módulo:** Estoque
**i18n Key Título:** `inventario.titulo`
**i18n Key Menu:** `menu.estoque.inventario`
**Rota:** `/estoque/inventario`

---

## 10. SEGURANÇA

- **Validação de entrada obrigatória** (FluentValidation)
- **Proteção contra injeção SQL** (EF Core parametrizado)
- **Controle de permissões** (authorization policies)
- **Isolamento multi-tenant** (ClienteId em todas as queries)
- **Assinatura digital** em relatórios de auditoria
- **Criptografia** de dados sensíveis em repouso (AES-256)

---

## 11. MÉTRICAS E INDICADORES

### KPIs

| KPI | Descrição | Meta |
|-----|-----------|------|
| **Acurácia de Inventário** | % de itens sem divergência | ≥ 95% |
| **Tempo Médio de Inventário** | Tempo médio para finalizar inventário | ≤ 48h para inventário parcial, ≤ 7 dias para geral |
| **Taxa de Recontagem** | % de itens que exigiram recontagem | ≤ 5% |
| **Taxa de Aprovação de Ajustes** | % de ajustes aprovados vs rejeitados | ≥ 90% aprovados |
| **Tempo Médio de Aprovação** | Tempo médio entre solicitação e aprovação de ajuste | ≤ 24h |

### Logs Obrigatórios

- Início/fim de inventário
- Contagens registradas
- Divergências identificadas
- Ajustes aprovados/rejeitados
- Falhas de integração ERP
- Tempo de resposta de endpoints críticos

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|------|------|----------|------|
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0 - Separação RF/RL, 11 seções obrigatórias, 12 regras de negócio detalhadas | Agência ALC - alc.dev.br |
| 1.0 | 2025-10-26 | Versão inicial resumida (78 linhas) | Sistema |
