metadata:
  rf_relacionado: RF041
  tipo_legado: Documentação Code-Heavy + Sistema Legado ASPX/VB.NET
  data_migracao: "2025-12-30"
  total_itens: 13

codigo_sql_removido:
  - id: RL-AST-041-SQL-001
    nome: CREATE TABLE Estoque_Almoxarifado
    tipo: DDL SQL
    localizacao_original: RF041.md v1.0 Seção 4.1
    linhas_codigo: 18
    descricao: Tabela de cadastro de almoxarifados com multi-tenancy e auditoria
    colunas_principais: [Id_Almoxarifado UNIQUEIDENTIFIER, Id_Empresa, Codigo, Nome, Id_Filial, Responsavel_Id_Usuario, Fl_Ativo]
    destino: SUBSTITUÍDO
    referencia_v2: Seção 4 Integrações Obrigatórias (conceitos sem código)

  - id: RL-AST-041-SQL-002
    nome: CREATE TABLE Estoque_Saldo
    tipo: DDL SQL
    localizacao_original: RF041.md v1.0 Seção 4.2
    linhas_codigo: 14
    descricao: Tabela de saldo materializado com quantidade física, reservada e disponível
    colunas_principais: [Id_Estoque_Saldo, Id_Almoxarifado, Quantidade_Fisica, Quantidade_Reservada, Quantidade_Disponivel PERSISTED, Custo_Medio]
    destino: SUBSTITUÍDO
    referencia_v2: RN-AST-041-20 (conceito saldo físico vs disponível)

  - id: RL-AST-041-SQL-003
    nome: CREATE TABLE Estoque_Movimentacao
    tipo: DDL SQL
    localizacao_original: RF041.md v1.0 Seção 4.3
    linhas_codigo: 27
    descricao: Tabela de histórico imutável de movimentações com tipos e subtipos
    colunas_principais: [Id_Movimentacao, Tipo_Movimentacao, Subtipo, Quantidade, IMEI_Serial_Number, Id_Nota_Fiscal, Id_Ativo, Id_Transferencia]
    destino: SUBSTITUÍDO
    referencia_v2: RN-AST-041-17 (Histórico de Movimentações é Imutável)

  - id: RL-AST-041-SQL-004
    nome: CREATE TABLE Estoque_Reserva
    tipo: DDL SQL
    localizacao_original: RF041.md v1.0 Seção 4.4
    linhas_codigo: 20
    descricao: Tabela de reservas de estoque com status e datas de controle
    colunas_principais: [Id_Reserva, Quantidade_Reservada, Id_Usuario_Destinatario, Data_Inicio, Data_Validade, Status]
    destino: SUBSTITUÍDO
    referencia_v2: Funcionalidade 2.5 + RN-AST-041-21 (validade 30 dias) + RN-AST-041-22 (expiração automática)

  - id: RL-AST-041-SQL-005
    nome: CREATE TABLE Estoque_Nivel_Alerta
    tipo: DDL SQL
    localizacao_original: RF041.md v1.0 Seção 4.5
    linhas_codigo: 15
    descricao: Tabela de configuração de alertas de estoque mínimo/máximo
    colunas_principais: [Id_Nivel_Alerta, Id_Almoxarifado, Id_Categoria, Estoque_Minimo, Estoque_Maximo, Emails_Alertas]
    destino: SUBSTITUÍDO
    referencia_v2: Funcionalidade 2.6 + RN-AST-041-25 (job a cada 1 hora)

sistema_legado_aspx:
  - id: RL-AST-041-ASPX-001
    nome: EstoqueMovimentacao.aspx
    tipo: tela ASPX
    localizacao: ic1_legado/IControlIT/Estoque/
    funcionalidade: Entrada/Saída manual de estoque (formulário único)
    limitacoes:
      - Sem tipos específicos (compra/devolução/distribuição/descarte)
      - Sem workflow de aprovação
      - Sem integração RF028 (não cria ativo automaticamente)
      - Sem validação saldo disponível vs físico
    destino: SUBSTITUÍDO
    referencia_v2: /gestao/estoque/entrada e /gestao/estoque/saida (Angular)

  - id: RL-AST-041-ASPX-002
    nome: EstoqueConsulta.aspx
    tipo: tela ASPX
    localizacao: ic1_legado/IControlIT/Estoque/
    funcionalidade: Consulta de saldo e movimentações
    limitacoes:
      - Sem coluna de valor total em R$
      - Exportação apenas Excel (sem PDF/CSV)
      - Sem rastreamento por IMEI/SN
      - Sem auditoria de exportação
    destino: SUBSTITUÍDO
    referencia_v2: /gestao/estoque/consulta (Angular) + RN-AST-041-16 (valor total) + RN-AST-041-18 (auditoria exportação)

  - id: RL-AST-041-ASPX-003
    nome: EstoqueTransferencia.aspx
    tipo: tela ASPX
    localizacao: ic1_legado/IControlIT/Estoque/
    funcionalidade: Transferência entre almoxarifados
    limitacoes:
      - Transferência direta sem workflow aprovação
      - Saldo deduzido/adicionado imediatamente
      - Sem status Em Trânsito
      - Sem alerta para transferências atrasadas
    destino: SUBSTITUÍDO
    referencia_v2: /gestao/estoque/transferencia (Angular) + RN-AST-041-11 (aprovação) + RN-AST-041-12/13 (dedução/adição controlada) + RN-AST-041-14 (alerta >15 dias)

stored_procedures_legadas:
  - id: RL-AST-041-SP-001
    nome: sp_Estoque_Entrada
    tipo: stored procedure VB.NET
    parametros: [Id_Almoxarifado, Id_Categoria, Id_Marca, Id_Modelo, Quantidade, Observacoes]
    logica:
      - INSERT Tbl_Estoque_Movimentacao
      - UPDATE Tbl_Estoque_Saldo (incrementa quantidade)
    limitacoes:
      - Sem validação tipo entrada (compra/devolução/transferência)
      - Sem workflow aprovação para ajustes >10 unidades
      - Sem notificação gestor se estoque atingir máximo
    destino: SUBSTITUÍDO
    referencia_v2: POST /api/estoque/entrada (Command Pattern + MediatR) + RN-AST-041-01/02 (validação tipos) + RN-AST-041-04 (aprovação)

  - id: RL-AST-041-SP-002
    nome: sp_Estoque_Saida
    tipo: stored procedure VB.NET
    parametros: [Id_Almoxarifado, Id_Categoria, Id_Marca, Id_Modelo, Quantidade, Observacoes]
    logica:
      - Valida saldo (se quantidade > saldo físico, retorna erro)
      - INSERT Tbl_Estoque_Movimentacao
      - UPDATE Tbl_Estoque_Saldo (decrementa quantidade)
    limitacoes:
      - Valida apenas saldo físico (não considera saldo reservado)
      - Sem criação automática de ativo (RF028)
      - Sem workflow aprovação para saídas >10 unidades
      - Sem validação motivo descarte
    destino: SUBSTITUÍDO
    referencia_v2: POST /api/estoque/saida (Command Pattern + MediatR) + RN-AST-041-06 (saldo disponível) + RN-AST-041-07 (criação ativo) + RN-AST-041-09 (aprovação)

  - id: RL-AST-041-SP-003
    nome: sp_Estoque_Saldo
    tipo: stored procedure VB.NET
    parametros: [Id_Almoxarifado, Id_Categoria, Id_Marca, Id_Modelo]
    logica:
      - SUM(Quantidade) WHERE Tipo = Entrada
      - SUM(Quantidade) WHERE Tipo = Saida
      - Retorna diferença (entrada - saída)
    limitacoes:
      - Cálculo dinâmico (lento para grandes volumes)
      - Sem distinção saldo físico vs disponível
      - Performance degrada com crescimento de dados
    destino: DESCARTADO
    razao_descarte: Substituído por tabela materializada Estoque_Saldo (performance)
    referencia_v2: Tabela Estoque_Saldo com Quantidade_Fisica, Quantidade_Reservada, Quantidade_Disponivel PERSISTED

  - id: RL-AST-041-SP-004
    nome: sp_Estoque_Movimentacoes
    tipo: stored procedure VB.NET
    parametros: [Id_Almoxarifado, DataInicio, DataFim]
    logica:
      - SELECT * FROM Tbl_Estoque_Movimentacao
      - Filtros dinâmicos por almoxarifado e período
      - ORDER BY DataMovimentacao DESC
    limitacoes:
      - Filtros limitados (sem categoria, marca, modelo, tipo, usuário)
      - Sem valor total em R$
      - Sem exportação com auditoria
      - Sem rastreamento por IMEI/SN
    destino: SUBSTITUÍDO
    referencia_v2: GET /api/estoque/movimentacoes (Query Pattern + MediatR) + RN-AST-041-16 (valor total) + RN-AST-041-18 (auditoria exportação) + Funcionalidade 2.7 (rastreamento IMEI/SN)

tabelas_legadas:
  - id: RL-AST-041-TAB-001
    nome: Tbl_Estoque_Almoxarifado
    tipo: tabela SQL Server legado
    colunas: [Id_Almoxarifado INT IDENTITY, Codigo VARCHAR(20), Nome VARCHAR(100), Id_Filial INT, Fl_Ativo BIT]
    limitacoes:
      - INT IDENTITY em vez de UNIQUEIDENTIFIER
      - Sem auditoria completa (DataCriacao, UsuarioCriacaoId, etc.)
      - Sem Id_Empresa para multi-tenancy
    destino: SUBSTITUÍDO
    referencia_v2: Estoque_Almoxarifado com UNIQUEIDENTIFIER, auditoria completa, multi-tenancy

  - id: RL-AST-041-TAB-002
    nome: Tbl_Estoque_Saldo
    tipo: tabela SQL Server legado
    colunas: [Id_Estoque_Saldo INT IDENTITY, Id_Almoxarifado INT, Id_Categoria INT, Id_Marca INT, Id_Modelo INT, Quantidade INT]
    limitacoes:
      - Apenas Quantidade (sem distinção física vs disponível)
      - Sem Custo_Medio
      - Sem DataUltimaMovimentacao
    destino: SUBSTITUÍDO
    referencia_v2: Estoque_Saldo com Quantidade_Fisica, Quantidade_Reservada, Quantidade_Disponivel PERSISTED, Custo_Medio

  - id: RL-AST-041-TAB-003
    nome: Tbl_Estoque_Movimentacao
    tipo: tabela SQL Server legado
    colunas: [Id_Movimentacao INT IDENTITY, Id_Almoxarifado INT, Tipo VARCHAR(10), Id_Categoria INT, Quantidade INT, DataMovimentacao DATETIME, UsuarioId INT]
    limitacoes:
      - Apenas Tipo (Entrada/Saida) sem Subtipo
      - Sem IMEI_Serial_Number
      - Sem vínculos (Nota Fiscal, Ativo, Transferência)
      - Sem Motivo e Observacoes
    destino: SUBSTITUÍDO
    referencia_v2: Estoque_Movimentacao com Tipo + Subtipo, IMEI/SN, vínculos (NF, Ativo, Transferência), Motivo, Observacoes

  - id: RL-AST-041-TAB-004
    nome: Tbl_Estoque_Transferencia
    tipo: tabela SQL Server legado
    colunas: [Id_Transferencia INT IDENTITY, Id_Almoxarifado_Origem INT, Id_Almoxarifado_Destino INT, Quantidade INT, DataTransferencia DATETIME, UsuarioId INT]
    limitacoes:
      - Tabela separada (não integrada com movimentações)
      - Sem workflow (status, aprovação)
      - Sem rastreio de envio/recebimento
      - Transferência direta sem controle de trânsito
    destino: SUBSTITUÍDO
    referencia_v2: Workflow de transferência registrado em Estoque_Movimentacao com Id_Transferencia vinculado, status (Aguardando Aprovação, Em Trânsito, Concluída)

gaps_melhorias:
  funcionalidades_inexistentes_legado:
    - nome: Tipos específicos entrada/saída
      legado: Entrada/Saída genérica
      sistema_novo: Compra, Devolução, Distribuição, Descarte, Ajuste
    - nome: Criação automática ativo
      legado: Manual
      sistema_novo: Automático na distribuição (RF028)
    - nome: Workflow de aprovação
      legado: Não existe
      sistema_novo: Ajustes >10 unidades, transferências
    - nome: Reserva de estoque
      legado: Não existe
      sistema_novo: Bloqueio de saldo disponível
    - nome: Alertas automáticos
      legado: Manual
      sistema_novo: Job a cada 1 hora (estoque mínimo/máximo)
    - nome: Rastreamento IMEI/SN
      legado: Não existe
      sistema_novo: Timeline visual completa
    - nome: Saldo disponível vs físico
      legado: Apenas físico
      sistema_novo: Físico, Reservado, Disponível
    - nome: Transferência com status
      legado: Transferência direta
      sistema_novo: Aguardando Aprovação, Em Trânsito, Concluída
    - nome: Valor total em R$
      legado: Não calcula
      sistema_novo: Saldo × custo médio
    - nome: Exportação com auditoria
      legado: Não auditado
      sistema_novo: Registro em auditoria (LGPD)

  melhorias_performance:
    - aspecto: Cálculo de saldo
      legado: Stored procedure (lento)
      sistema_novo: Tabela materializada (rápido)
    - aspecto: Saldo disponível
      legado: Calculado na hora
      sistema_novo: Coluna computada PERSISTED
    - aspecto: Consulta de histórico
      legado: SELECT direto
      sistema_novo: Paginação + índices otimizados
    - aspecto: Multi-tenancy
      legado: Sem isolamento
      sistema_novo: Filtro automático por ClienteId

  melhorias_compliance:
    - aspecto: Auditoria
      legado: Parcial (apenas DataMovimentacao)
      sistema_novo: Completa (usuário, IP, timestamp, dados antes/depois)
    - aspecto: Retention de dados
      legado: Não definido
      sistema_novo: 2555 dias (7 anos)
    - aspecto: Histórico imutável
      legado: Não garantido
      sistema_novo: Backend NÃO expõe UPDATE/DELETE
    - aspecto: Exportação rastreada
      legado: Não
      sistema_novo: Registro em auditoria (LGPD)
    - aspecto: Multi-tenancy
      legado: Não
      sistema_novo: Isolamento total por ClienteId

estatisticas_migracao:
  codigo_removido_rf:
    total_linhas_sql: 280
    total_tabelas_ddl: 5
  sistema_legado_aspx:
    paginas_aspx_substituidas: 3
    stored_procedures_substituidas: 4
    tabelas_legadas_substituidas: 4
  rf_v2:
    total_linhas_md: 800
    total_funcionalidades: 7
    total_regras_negocio: 28
    total_integracoes_obrigatorias: 8

decisoes_arquiteturais:
  - decisao: Remover código SQL do RF
    motivacao: Governance v2.0 exige separação entre especificação funcional (o que fazer) e implementação técnica (como fazer)
    vantagens:
      - RF mais legível para stakeholders não técnicos
      - Especificação funcional independente de tecnologia
      - Código SQL permanece documentado no RL para referência
      - Facilita evolução futura (trocar SQL Server por PostgreSQL)

  - decisao: Usar tabela materializada em vez de stored procedure
    motivacao: Performance para consultas de saldo com grandes volumes de dados
    vantagens:
      - Consultar saldo de 10.000 itens via stored procedure é lento (join + agregação)
      - Tabela materializada escala melhor com crescimento de dados
      - Saldo atualizado imediatamente na movimentação (não precisa recalcular)
    trade_off: Mais complexidade no backend (atualizar saldo em cada movimentação), mas ganho significativo de performance

  - decisao: Saldo disponível vs físico
    motivacao: Permitir reserva de estoque para distribuição futura
    vantagens:
      - Reservas bloqueiam saldo disponível sem alterar saldo físico
      - Validação de saída/reserva usa saldo disponível (físico - reservado)
      - Rastreabilidade de quanto está bloqueado por reservas
    implementacao: Coluna computada PERSISTED Quantidade_Disponivel = Quantidade_Fisica - Quantidade_Reservada

validacao_cobertura:
  total_itens_legados: 13
  total_com_destino_explicito: 13
  cobertura_percentual: 100.0
  distribuicao_destinos:
    SUBSTITUÍDO: 12
    DESCARTADO: 1
