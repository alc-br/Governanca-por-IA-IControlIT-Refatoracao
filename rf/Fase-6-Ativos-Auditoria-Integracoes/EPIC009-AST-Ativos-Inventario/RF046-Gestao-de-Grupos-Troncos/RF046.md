# RF046 - Gestão de Grupos de Troncos

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC009-AST-Ativos-Inventario
**Fase**: Fase-6-Ativos-Auditoria-Integracoes

---

## 1. OBJETIVO DO REQUISITO

Implementar sistema completo de agrupamento lógico, roteamento inteligente e monitoramento de troncos telefônicos (SIP, E1, móvel) com failover automático, balanceamento de carga e otimização de custos (LCR - Least Cost Routing).

O sistema deve garantir:
- Alta disponibilidade de conectividade telefônica (uptime ≥ 99.9%)
- Otimização automática de custos através de roteamento inteligente
- Failover transparente em caso de falha de tronco (< 5 segundos)
- Monitoramento em tempo real de saúde, capacidade e qualidade de serviço
- Rastreabilidade completa de uso, falhas e performance

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- Criação e gerenciamento de grupos hierárquicos de troncos
- Configuração de algoritmos de balanceamento (Round-Robin, Least-Used, Weighted, Priority, LCR)
- Health checks automáticos a cada 30 segundos
- Failover automático com detecção de falha em 3 tentativas consecutivas
- Monitoramento de métricas QoS (Jitter, Latência, Packet Loss, MOS Score)
- Dashboard de status em tempo real via SignalR
- Alertas proativos de capacidade e disponibilidade
- Integração com PABX/SIP trunk providers via APIs e webhooks
- Histórico de 7 anos de logs de failover e uso
- Isolamento multi-tenant por fornecedor

### 2.2 Fora do escopo (não objetivos)

- Configuração de hardware PABX (apenas integração via API)
- Gerenciamento de ramais individuais (responsabilidade de outro RF)
- Tarifação detalhada de chamadas (outro módulo)
- Gravação de chamadas (outro módulo)
- Interface visual específica (definida no WF)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Grupo de Troncos** | Agrupamento lógico de troncos com algoritmo de roteamento e failover configuráveis |
| **Tronco** | Canal de comunicação telefônica (SIP trunk, linha E1, chip móvel 4G) |
| **Failover** | Processo automático de redirecionar chamadas de tronco falho para tronco backup |
| **LCR (Least Cost Routing)** | Algoritmo que roteia chamadas pelo tronco mais barato disponível |
| **Health Check** | Verificação periódica (30s) de disponibilidade e qualidade de tronco |
| **MOS (Mean Opinion Score)** | Métrica de qualidade de voz (1-5, ideal ≥ 4.0) |
| **Concurrent Calls** | Número de chamadas simultâneas ativas em um tronco |
| **Balanceamento de Carga** | Distribuição inteligente de chamadas entre múltiplos troncos |
| **Prioridade** | Ordem de preferência para uso de troncos (1 = maior prioridade) |
| **Peso** | Percentual de tráfego distribuído para tronco (algoritmo Weighted) |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Gerenciamento de Grupos de Troncos**
   - Criar grupo com nome, tipo (GEOGRAFICO, OPERADORA, TECNOLOGIA, CUSTO, QUALIDADE)
   - Configurar algoritmo de balanceamento (ROUND_ROBIN, LEAST_USED, WEIGHTED, PRIORITY, LCR)
   - Definir limites de capacidade (concurrent calls, bandwidth)
   - Ativar/desativar failover automático
   - Configurar intervalo de health check (mínimo 10s, default 30s)

2. **Gerenciamento de Troncos**
   - Adicionar tronco ao grupo (SIP, E1, MOVEL_4G, ISDN, ANALOGICO)
   - Definir prioridade única dentro do grupo
   - Configurar peso para balanceamento (se algoritmo WEIGHTED)
   - Informar custo por minuto (obrigatório se algoritmo LCR)
   - Configurar capacidade máxima (concurrent calls)
   - Informar endpoint de conexão (SIP URI, número E1, etc.)

3. **Roteamento Inteligente**
   - Round-Robin: distribuição igualitária sequencial
   - Least-Used: seleciona tronco com menor uso atual
   - Weighted: distribuição ponderada por peso configurado
   - Priority: usa sempre maior prioridade disponível
   - LCR: seleciona rota mais barata com qualidade mínima (MOS ≥ 3.0)

4. **Health Checks Automáticos**
   - Verificação a cada 30s via SIP OPTIONS (SIP), SNMP GET (E1), Ping (móvel)
   - Registro de latência, packet loss, jitter
   - Cálculo de MOS Score (E-Model)
   - Detecção de falha após 3 health checks consecutivos com falha
   - Restauração automática após 3 health checks consecutivos bem-sucedidos

5. **Failover Automático**
   - Detecção de falha em menos de 90 segundos (3 × 30s)
   - Roteamento imediato para tronco backup (< 5s)
   - Notificação instantânea por e-mail + SMS para administradores
   - Registro completo em auditoria (timestamp, tronco origem/destino, motivo)
   - Tentativa automática de restauração quando tronco recuperar

6. **Monitoramento e Métricas**
   - Dashboard em tempo real via SignalR
   - Status atual: ATIVO, INATIVO, FALHA, MANUTENÇÃO
   - Concurrent calls atual vs capacidade
   - Bandwidth consumido (Mbps)
   - Latência média, packet loss, jitter
   - MOS Score por tronco
   - Taxa de chamadas completadas vs abandonadas
   - Alerta quando uso > 80% da capacidade

7. **Relatórios e Estatísticas**
   - Evolução de uso (calls/hora, calls/dia, calls/mês)
   - Distribuição de tráfego por tronco
   - Histórico de failovers (frequência, duração, motivo)
   - Economia com LCR vs roteamento fixo
   - Uptime por tronco (SLA)
   - Relatório mensal automático

8. **Integração com PABX/SIP Providers**
   - Webhook para receber eventos de chamadas (start, end, fail)
   - API REST para atualizar configuração de roteamento
   - Comandos para reload de config em PABX (Asterisk, FreeSWITCH)
   - Consulta de chamadas ativas por tronco
   - Provisionamento automático de novos troncos

---

## 5. REGRAS DE NEGÓCIO

### RN-RF046-001: Grupo Deve Ter Pelo Menos 1 Tronco Ativo

**Descrição**: Não é permitido ativar um grupo de troncos sem pelo menos 1 tronco ativo. Não é permitido desativar o último tronco ativo de um grupo.

**Justificativa**: Garante que sempre haverá rota disponível para chamadas. Evita blackout de telefonia.

**Critério de Aceite**:
- Tentativa de criar grupo sem troncos → HTTP 400
- Tentativa de desativar último tronco ativo → HTTP 409 Conflict
- Mensagem: "Grupo deve ter pelo menos 1 tronco ativo"

---

### RN-RF046-002: Prioridade Única por Tronco no Grupo

**Descrição**: Dentro de um grupo, cada tronco deve ter prioridade única. Não pode haver dois troncos com prioridade 1, por exemplo.

**Justificativa**: Elimina ambiguidade no roteamento por prioridade. Sistema precisa saber exatamente qual tronco usar.

**Critério de Aceite**:
- Constraint única: `IX_Tronco_GrupoId_Prioridade`
- Tentativa de criar tronco com prioridade duplicada → HTTP 400
- Mensagem: "Prioridade {valor} já existe no grupo"

---

### RN-RF046-003: Soma de Pesos Deve Ser 100% (Weighted Balancing)

**Descrição**: Se algoritmo de balanceamento é WEIGHTED, a soma dos pesos de todos os troncos ativos deve ser exatamente 100%.

**Justificativa**: Garante distribuição correta de carga. Evita troncos sem tráfego ou sobrecarga.

**Critério de Aceite**:
- Validação executada ao alterar algoritmo para WEIGHTED
- Soma de pesos ≠ 100% → HTTP 400
- Mensagem: "Soma dos pesos deve ser 100%. Atual: {valor}%"
- Auto-ajuste proporcional se usuário não fornecer pesos

---

### RN-RF046-004: Health Check Mínimo de 10 Segundos

**Descrição**: Intervalo de health check deve ser no mínimo 10 segundos. Não permitir valores menores para evitar sobrecarga de rede.

**Justificativa**: Health checks frequentes demais geram tráfego desnecessário e podem causar falsos positivos por congestionamento.

**Critério de Aceite**:
- Valor < 10s → HTTP 400
- Mensagem: "Intervalo mínimo: 10 segundos"
- Default: 30 segundos

---

### RN-RF046-005: Failover Apenas se Grupo Tiver 2+ Troncos

**Descrição**: Opção `failoverAutomatico` só pode ser ativada se grupo tiver pelo menos 2 troncos ativos.

**Justificativa**: Failover sem redundância não faz sentido. Precisa de tronco backup disponível.

**Critério de Aceite**:
- Grupo com 1 tronco + tentativa de ativar failover → HTTP 400
- Mensagem: "Failover requer pelo menos 2 troncos ativos"
- Desabilita automaticamente se último tronco backup for removido

---

### RN-RF046-006: LCR Requer Campo "Custo Por Minuto" Preenchido

**Descrição**: Se algoritmo de roteamento é LCR, todos os troncos devem ter campo `custoPorMinuto` > 0.

**Justificativa**: LCR precisa saber custo de cada tronco para escolher mais barato.

**Critério de Aceite**:
- Algoritmo LCR + tronco sem custo → HTTP 400
- Mensagem: "LCR requer custo por minuto em todos os troncos"
- Bloqueio ao alterar algoritmo para LCR se algum tronco não tiver custo

---

### RN-RF046-007: Notificação Imediata em Failover

**Descrição**: Sempre que ocorrer failover automático, sistema deve notificar administradores imediatamente via e-mail + SMS.

**Justificativa**: Failover indica problema crítico que exige atenção imediata, mesmo que backup esteja funcionando.

**Critério de Aceite**:
- Trigger em `TroncoFailoverService.TriggerFailover()`
- Notificação para perfis "Administrador" e "Gestor de Telecom"
- Conteúdo: tronco origem, tronco destino, motivo, timestamp, ação recomendada
- Severidade: ALTA

---

### RN-RF046-008: Restauração Automática Após 3 Health Checks OK

**Descrição**: Tronco em status FALHA só retorna para ATIVO após 3 health checks consecutivos bem-sucedidos.

**Justificativa**: Evita flapping (oscilação entre ativo/falha) que degrada experiência e gera alertas desnecessários.

**Critério de Aceite**:
- Contador reinicia em 0 se qualquer health check falhar
- Apenas após 3 consecutivos OK → status ATIVO
- Registro em log de auditoria

---

### RN-RF046-009: Alerta em 80% da Capacidade de Concurrent Calls

**Descrição**: Sistema deve alertar quando uso de concurrent calls atingir 80% da capacidade configurada do grupo.

**Justificativa**: Permite ação proativa (adicionar troncos, redistribuir carga) antes de atingir limite e derrubar chamadas.

**Critério de Aceite**:
- Verificação em tempo real em webhook `CallStatus`
- Alerta enviado apenas 1x por dia (evita spam)
- Mensagem: "Grupo {nome} próximo da capacidade ({percentual}%)"
- Recomendação: "Considere adicionar troncos ou redistribuir carga"

---

### RN-RF046-010: Rotação de Logs de Health Check (30 Dias)

**Descrição**: Logs de health check devem ser mantidos por 30 dias. Após isso, consolidar em métricas agregadas (disponibilidade %, latência média) e deletar.

**Justificativa**: Health checks a cada 30s geram ~3.000 registros/dia/tronco. Armazenamento ilimitado é inviável.

**Critério de Aceite**:
- Hangfire job diário `TroncoHealthCheckCleanupJob`
- Agrega para métricas diárias antes de deletar
- Preserva agregados por 7 anos (conformidade)

---

### RN-RF046-011: Prioridade Sempre Crescente (Sem Saltos)

**Descrição**: Prioridades devem ser sequenciais sem saltos. Se há troncos com prioridade 1 e 3, deve haver um com prioridade 2.

**Justificativa**: Evita confusão e garante failover funciona como esperado (sem "buracos" na cadeia).

**Critério de Aceite**:
- Validação em `CreateTroncoCommandValidator`
- Tentativa de criar prioridade 3 quando só existe 1 → auto-ajuste para 2
- Mensagem informativa: "Prioridade ajustada de 3 para 2 (sem saltos)"

---

### RN-RF046-012: MOS Mínimo de 3.0 para Tronco Ser Elegível

**Descrição**: Tronco com MOS (Mean Opinion Score) < 3.0 não deve ser usado em roteamento automático, apenas como último recurso (failover extremo).

**Justificativa**: MOS < 3.0 indica qualidade ruim de voz (má experiência de usuário). Preferir troncos com qualidade aceitável.

**Critério de Aceite**:
- Filtro em `TroncoRoutingService.SelectTronco()`
- Troncos com MOS < 3.0 ignorados em roteamento normal
- Exceção: se TODOS os troncos tiverem MOS < 3.0, usa o melhor disponível
- Alerta: "Qualidade de voz degradada (MOS < 3.0)"

---

### RN-RF046-013: Bloqueio de Alteração de Grupo com Chamadas Ativas

**Descrição**: Não permitir alterar algoritmo de balanceamento ou remover troncos de grupo que tenha chamadas ativas no momento.

**Justificativa**: Evita derrubar chamadas em andamento. Mudanças de roteamento devem ser feitas em janela de manutenção.

**Critério de Aceite**:
- Verificação em `UpdateGrupoTroncoCommand`
- Se `concurrentCalls > 0` → HTTP 409 Conflict
- Mensagem: "Grupo possui {count} chamadas ativas. Aguarde finalização ou force atualização."
- Permite override com parâmetro `forceUpdate=true` (registra em auditoria)

---

### RN-RF046-014: Histórico de 7 Anos para Auditoria

**Descrição**: Logs de failover, uso de troncos e alterações de configuração devem ser mantidos por 7 anos (conformidade LGPD).

**Justificativa**: Permite auditoria de incidentes históricos e análise de longo prazo de confiabilidade.

**Critério de Aceite**:
- Particionamento anual de tabela `TroncoFailoverLog`
- Arquivamento em cold storage (Azure Blob) após 2 anos
- Deleção automática após 7 anos
- Consultas via stored procedures com filtros de data

---

### RN-RF046-015: Isolamento Multi-Tenancy por Fornecedor

**Descrição**: Grupos de troncos e rotas de um fornecedor não podem ser visualizados ou usados por outro fornecedor.

**Justificativa**: Segurança e isolamento de recursos. Evita que fornecedor A use troncos caros de fornecedor B.

**Critério de Aceite**:
- Coluna `FornecedorId` em `GrupoTronco` e `Tronco`
- Filtro automático em todas as queries por `FornecedorId` do usuário logado
- Tentativa de acesso cruzado → HTTP 403 Forbidden
- Row-Level Security no banco de dados

---

## 6. ESTADOS DA ENTIDADE

### 6.1 Estados do Grupo de Troncos

| Estado | Descrição |
|--------|-----------|
| ATIVO | Grupo configurado e operacional |
| INATIVO | Grupo desabilitado (não aceita chamadas) |
| MANUTENCAO | Grupo em manutenção programada |

### 6.2 Estados do Tronco

| Estado | Descrição |
|--------|-----------|
| ATIVO | Tronco operacional e disponível |
| INATIVO | Tronco desabilitado manualmente |
| FALHA | Tronco com falha detectada por health check |
| MANUTENCAO | Tronco em manutenção programada |

### 6.3 Transições Permitidas (Grupo)

| De | Para | Condição |
|----|------|----------|
| ATIVO | INATIVO | Manual |
| ATIVO | MANUTENCAO | Manual |
| INATIVO | ATIVO | Deve ter ≥1 tronco ativo |
| MANUTENCAO | ATIVO | Após conclusão de manutenção |

### 6.4 Transições Permitidas (Tronco)

| De | Para | Condição |
|----|------|----------|
| ATIVO | FALHA | 3 health checks consecutivos falharam |
| FALHA | ATIVO | 3 health checks consecutivos OK |
| ATIVO | INATIVO | Manual (se não for último ativo) |
| INATIVO | ATIVO | Manual |
| * | MANUTENCAO | Manual |
| MANUTENCAO | ATIVO | Manual |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre | Payload |
|--------|---------------|---------|
| `GrupoTronco.Criado` | Após criação de grupo | GrupoId, Nome, Algoritmo |
| `GrupoTronco.Atualizado` | Após alteração de configuração | GrupoId, Alterações |
| `Tronco.Adicionado` | Após adição de tronco ao grupo | TroncoId, GrupoId, Prioridade |
| `Tronco.StatusAlterado` | Mudança de status (ATIVO↔FALHA) | TroncoId, StatusAntigo, StatusNovo |
| `Failover.Executado` | Após failover automático | TroncoOrigemId, TroncoDestinoId, Motivo |
| `Tronco.CapacidadeAtingida` | Uso > 80% capacidade | TroncoId, UsoAtual, Capacidade |
| `HealthCheck.Falhou` | Health check com falha | TroncoId, Latencia, PacketLoss |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhum grupo pode ficar sem tronco ativo (RN-RF046-001)
- Failover automático deve ocorrer em menos de 5 segundos após detecção de falha
- Health checks não podem consumir mais que 1% da banda de cada tronco
- Monitoramento em tempo real deve atualizar dashboard a cada 5 segundos (SignalR)
- Logs de failover devem incluir timestamp preciso (milissegundos)
- Algoritmo LCR deve considerar qualidade mínima (MOS ≥ 3.0) além de custo
- Isolamento multi-tenant deve ser garantido em todas as queries (Row-Level Security)
- Notificações de failover devem ser enviadas em menos de 30 segundos
- Relatórios mensais devem ser gerados automaticamente no 1º dia do mês
- Auditoria deve registrar todas as alterações de configuração e failovers

---

## 9. SEGURANÇA

### 9.1 Controle de Acesso

- Autenticação obrigatória em todos os endpoints
- Permissões RBAC para cada operação (ver seção 11)
- Isolamento multi-tenant por `FornecedorId`
- Row-Level Security no banco de dados

### 9.2 Validações de Entrada

- Sanitização de campos de texto (nome, descrição, endpoint)
- Validação de ranges para valores numéricos (prioridade 1-99, peso 0-100%)
- Validação de formato de endpoint (SIP URI, IP:porta, número E1)
- Proteção contra SQL Injection em consultas dinâmicas

### 9.3 Proteção de Dados Sensíveis

- Endpoint de tronco pode conter credenciais SIP → criptografado em repouso
- Logs não devem incluir credenciais completas (mascarar)
- Histórico de 7 anos → arquivamento seguro em cold storage

### 9.4 Auditoria de Segurança

- Registro de todas as tentativas de acesso negado (HTTP 403)
- Alerta de múltiplas tentativas de acesso a dados de outro fornecedor
- Log de alterações de configuração crítica (algoritmo, prioridades)

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF046.md**: Casos de Uso (UC00-listar, UC01-criar, UC02-visualizar, UC03-editar, UC04-inativar, UC05-configurar-roteamento, UC06-monitorar-saude, UC07-executar-failover)
- **MD-RF046.md**: Modelo de Dados (GrupoTronco, Tronco, TroncoHealthCheck, TroncoFailoverLog, TroncoUso)
- **WF-RF046.md**: Wireframes (dashboard, formulário de grupo, configuração de roteamento, monitoramento)
- **TC-RF046-BACKEND.yaml**: Casos de Teste Backend (validações, health checks, failover, LCR)
- **TC-RF046-FRONTEND.yaml**: Casos de Teste Frontend (CRUD, dashboard, alertas)
- **TC-RF046-SEGURANCA.yaml**: Casos de Teste Segurança (isolamento multi-tenant, permissões)
- **TC-RF046-E2E.yaml**: Casos de Teste E2E (fluxo completo de criação grupo + failover)

---

## 11. PERMISSÕES RBAC

| Operação | Permission Code | Descrição | Roles Autorizadas |
|----------|----------------|-----------|-------------------|
| Listar grupos | `AST.GRUPOS_TRONCOS.LIST` | Visualizar lista de grupos | Admin, Gestor Telecom, Operador |
| Criar grupo | `AST.GRUPOS_TRONCOS.CREATE` | Criar novo grupo | Admin, Gestor Telecom |
| Editar grupo | `AST.GRUPOS_TRONCOS.UPDATE` | Alterar configuração de grupo | Admin, Gestor Telecom |
| Excluir grupo | `AST.GRUPOS_TRONCOS.DELETE` | Inativar grupo | Admin |
| Adicionar tronco | `AST.TRONCOS.CREATE` | Adicionar tronco ao grupo | Admin, Gestor Telecom |
| Configurar roteamento | `AST.GRUPOS_TRONCOS.CONFIGURE_ROUTING` | Alterar algoritmo/prioridades | Admin, Gestor Telecom |
| Executar failover manual | `AST.GRUPOS_TRONCOS.FAILOVER` | Forçar failover manualmente | Admin, Gestor Telecom |
| Monitorar saúde | `AST.GRUPOS_TRONCOS.MONITOR` | Visualizar dashboard de saúde | Admin, Gestor Telecom, Operador |
| Visualizar relatórios | `AST.GRUPOS_TRONCOS.REPORTS` | Acessar relatórios de uso | Admin, Gestor Telecom |

---

## 12. API ENDPOINTS

| Método | Rota | Descrição | Permission |
|--------|------|-----------|------------|
| GET | `/api/v1/grupos-troncos` | Listar grupos com paginação | `AST.GRUPOS_TRONCOS.LIST` |
| GET | `/api/v1/grupos-troncos/{id}` | Obter grupo por ID | `AST.GRUPOS_TRONCOS.LIST` |
| POST | `/api/v1/grupos-troncos` | Criar novo grupo | `AST.GRUPOS_TRONCOS.CREATE` |
| PUT | `/api/v1/grupos-troncos/{id}` | Atualizar grupo | `AST.GRUPOS_TRONCOS.UPDATE` |
| DELETE | `/api/v1/grupos-troncos/{id}` | Inativar grupo | `AST.GRUPOS_TRONCOS.DELETE` |
| POST | `/api/v1/grupos-troncos/{id}/troncos` | Adicionar tronco ao grupo | `AST.TRONCOS.CREATE` |
| PUT | `/api/v1/grupos-troncos/{id}/roteamento` | Configurar algoritmo/prioridades | `AST.GRUPOS_TRONCOS.CONFIGURE_ROUTING` |
| GET | `/api/v1/grupos-troncos/{id}/saude` | Obter status de saúde em tempo real | `AST.GRUPOS_TRONCOS.MONITOR` |
| POST | `/api/v1/grupos-troncos/{id}/failover` | Executar failover manual | `AST.GRUPOS_TRONCOS.FAILOVER` |
| GET | `/api/v1/grupos-troncos/{id}/relatorios` | Obter relatórios de uso | `AST.GRUPOS_TRONCOS.REPORTS` |
| POST | `/api/v1/webhooks/call-status` | Receber eventos de chamadas do PABX | (autenticação via API key) |

---

## 13. INTEGRAÇÕES OBRIGATÓRIAS

### 13.1 Internacionalização (i18n)

**Chaves de tradução obrigatórias:**

```json
{
  "gruposTroncos": {
    "title": "Gestão de Grupos de Troncos",
    "list": {
      "title": "Grupos de Troncos",
      "empty": "Nenhum grupo cadastrado"
    },
    "form": {
      "nome": "Nome do Grupo",
      "tipo": "Tipo de Agrupamento",
      "algoritmo": "Algoritmo de Balanceamento",
      "failoverAutomatico": "Failover Automático",
      "tempoHealthCheck": "Intervalo de Health Check (segundos)"
    },
    "tipos": {
      "GEOGRAFICO": "Geográfico",
      "OPERADORA": "Por Operadora",
      "TECNOLOGIA": "Por Tecnologia",
      "CUSTO": "Por Custo",
      "QUALIDADE": "Por Qualidade"
    },
    "algoritmos": {
      "ROUND_ROBIN": "Round-Robin (Distribuição Igualitária)",
      "LEAST_USED": "Menor Uso Atual",
      "WEIGHTED": "Ponderado por Peso",
      "PRIORITY": "Prioridade Estrita",
      "LCR": "Menor Custo (LCR)"
    },
    "messages": {
      "grupoCreated": "Grupo {nome} criado com sucesso",
      "grupoUpdated": "Grupo {nome} atualizado",
      "failoverExecutado": "Failover executado: {origem} → {destino}",
      "troncoRestaurado": "Tronco {nome} restaurado",
      "capacidadeAlerta": "Grupo {nome} próximo da capacidade ({percentual}%)"
    },
    "errors": {
      "semTroncoAtivo": "Grupo deve ter pelo menos 1 tronco ativo",
      "prioridadeDuplicada": "Prioridade {valor} já existe no grupo",
      "pesosInvalidos": "Soma dos pesos deve ser 100%. Atual: {valor}%",
      "lcrSemCusto": "LCR requer custo por minuto em todos os troncos",
      "chamadasAtivas": "Grupo possui {count} chamadas ativas. Aguarde finalização."
    }
  }
}
```

**Idiomas suportados**: pt-BR (padrão), en-US, es-ES

### 13.2 Auditoria

**Operações auditadas:**

| Operação | Tipo | Dados Capturados |
|----------|------|------------------|
| `GRUPO_TRONCO_CREATED` | CREATE | Todos os campos do grupo |
| `GRUPO_TRONCO_UPDATED` | UPDATE | Campos alterados (antes/depois) |
| `TRONCO_ADDED` | CREATE | GrupoId, TroncoId, Prioridade, Peso |
| `ROTEAMENTO_CHANGED` | UPDATE | AlgoritmoAntigo, AlgoritmoNovo |
| `FAILOVER_EXECUTED` | ACTION | TroncoOrigem, TroncoDestino, Motivo, Timestamp |
| `TRONCO_STATUS_CHANGED` | UPDATE | TroncoId, StatusAntigo, StatusNovo |
| `HEALTH_CHECK_FAILED` | ERROR | TroncoId, Latencia, PacketLoss, Jitter |
| `CAPACIDADE_ATINGIDA` | WARNING | GrupoId, UsoAtual, Capacidade |

**Campos obrigatórios de auditoria:**
- `CreatedAt`, `CreatedBy` (criação)
- `LastModifiedAt`, `LastModifiedBy` (última modificação)
- `IP`, `UserAgent` (contexto da requisição)

**Retenção**: 7 anos conforme LGPD

### 13.3 Permissões e Controle de Acesso (RBAC)

**Integração com módulo de autenticação:**
- Validação de token JWT em todos os endpoints
- Extração de `FornecedorId` do token para isolamento multi-tenant
- Verificação de permissões antes de executar comando/query

**Matriz de permissões** (ver seção 11)

### 13.4 Central de Funcionalidades

**Registro na Central:**

```json
{
  "modulo": "ATIVOS",
  "codigo": "AST.GRUPOS_TRONCOS",
  "nome": "Gestão de Grupos de Troncos",
  "descricao": "Agrupamento, roteamento e monitoramento de troncos telefônicos",
  "icone": "phone_in_talk",
  "rota": "/ativos/grupos-troncos",
  "ordem": 50,
  "ativo": true,
  "permissao_minima": "AST.GRUPOS_TRONCOS.LIST"
}
```

---

## 14. RASTREABILIDADE

| Artefato | Status | Observações |
|----------|--------|-------------|
| UC-RF046.md | Obrigatório | 7 casos de uso mínimo |
| MD-RF046.md | Obrigatório | 5 tabelas principais |
| WF-RF046.md | Obrigatório | Dashboard + formulários |
| TC-RF046-BACKEND.yaml | Obrigatório | 50+ casos de teste |
| TC-RF046-FRONTEND.yaml | Obrigatório | 30+ casos de teste |
| TC-RF046-SEGURANCA.yaml | Obrigatório | 20+ casos de teste |
| TC-RF046-E2E.yaml | Obrigatório | 10+ cenários E2E |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0 (separação RF/RL completa). Removidas referências ao legado (ASPX, VB.NET, SQL). Adicionadas 15 regras de negócio em linguagem natural. Estrutura de 11 seções conforme template v2.0. | Agência ALC - alc.dev.br |
| 1.0 | 2025-01-14 | Versão inicial com conteúdo legado misturado | - |

---

**FIM DO RF046 v2.0**

**Estatísticas:**
- **Seções:** 14/11 completas (11 obrigatórias + 3 adicionais)
- **Regras de Negócio:** 15 regras (RN-RF046-001 até RN-RF046-015)
- **Integrações Obrigatórias:** 4/4 (i18n, auditoria, RBAC, Central)
- **Permissões RBAC:** 9 permissões definidas
- **API Endpoints:** 11 endpoints REST
- **Complexidade:** ALTA
- **Qualidade:** 100% (SEM referências ao legado)
