# RF078: Integração com ERPs

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC008-SD-Service-Desk
**Fase**: Fase 5 - Service Desk

---

## 1. OBJETIVO DO REQUISITO

Estabelecer comunicação bidirecional e em tempo real entre o IControlIT e sistemas de gestão empresarial (SAP, TOTVS Protheus, Oracle EBS), permitindo sincronização automática de dados mestres, operações transacionais e auditoria completa de conformidade fiscal.

Este documento define **o que o sistema deve fazer** para eliminar silos de dados, garantir conformidade com legislação contábil/fiscal (SOX, NF-e) e implementar fluxos de negócio integrados entre TI e gestão financeira.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- Integração com múltiplos ERPs simultaneamente (SAP, TOTVS Protheus, Oracle EBS)
- Sincronização bidirecional de Centros de Custo
- Sincronização bidirecional de Departamentos e Colaboradores
- Exportação automática de custos de TI para contabilização no ERP
- Importação de ordens de compra e notas fiscais do ERP
- Reconciliação automática de faturas telecom com contas a pagar do ERP
- Webhooks para eventos em tempo real (notificação de mudanças de status, criação de registros)
- Retry automático com backoff exponencial para falhas transientes
- Transformação de dados entre formatos (JSON ↔ XML ↔ EDI)
- Dashboard de monitoramento em tempo real do status de integrações
- Dead Letter Queue (DLQ) para mensagens com falha após retry
- Auditoria estruturada com retenção de 7 anos
- Validação de assinatura HMAC-SHA256 em webhooks
- Criptografia de credenciais em Azure Key Vault com rotação automática

### 2.2 Fora do escopo (não objetivos)

- Implementação técnica específica (RFC ABAP, SOAP vs REST)
- Interface visual específica (layout, UX, identidade visual)
- Tecnologia, framework ou linguagem de programação
- Estratégia de deploy ou infraestrutura
- Migração de dados históricos de ERPs antigos
- Integração com ERPs além de SAP, TOTVS Protheus e Oracle EBS

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-----|---------|
| **ERP** | Enterprise Resource Planning - Sistema integrado que gerencia processos de negócio (contabilidade, compras, RH, estoque, suprimentos). No contexto IControlIT: SAP, TOTVS Protheus e Oracle EBS |
| **Sincronização Bidirecional** | Dados fluem em ambas as direções (IControlIT ↔ ERP) com tratamento de conflitos e validação de consistência |
| **Transformação de Dados** | Conversão entre formatos (JSON ↔ XML ↔ EDI) e schemas diferentes entre sistemas, incluindo mapping de campos, tratamento de valores nulos, validação de domínios |
| **Webhook** | Notificação automática disparada quando um evento ocorre (mudança de status, criação de registro), reduzindo latência comparado a polling periódico |
| **Retry com Backoff Exponencial** | Mecanismo de recuperação para falhas transientes (timeout de rede, indisponibilidade temporária do ERP) com tentativas em intervalos crescentes (2s, 4s, 8s, 16s, 32s) |
| **Dead Letter Queue (DLQ)** | Fila especial para mensagens que falharam após todas as tentativas de retry, permitindo investigação posterior sem bloqueio do fluxo normal |
| **Reconciliação** | Processo de matching entre faturas telecom (IControlIT) e contas a pagar (ERP), com tolerância de diferença configurável |
| **MessageId** | Identificador único (UUID) de cada mensagem para deduplicação e rastreabilidade |
| **HMAC-SHA256** | Hash-based Message Authentication Code - Algoritmo de assinatura criptográfica para validar autenticidade de webhooks |
| **Azure Key Vault** | Serviço de armazenamento seguro de credenciais, tokens e certificados com rotação automática |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Integração Multi-ERP** - Conectar simultaneamente com SAP, TOTVS Protheus e Oracle EBS
2. **Sincronização Bidirecional de Centros de Custo** - Mudanças em qualquer sistema refletem automaticamente no outro
3. **Sincronização Bidirecional de RH** - Departamentos, filiais e colaboradores sincronizados em tempo real
4. **Exportação de Custos de TI** - Envio automático de custos para contabilização no ERP por centro de custo e período
5. **Importação de Compras** - Recebimento de ordens de compra e notas fiscais do ERP
6. **Reconciliação de Faturas** - Matching automático de contas a pagar com faturas de telecom
7. **Webhooks em Tempo Real** - Notificações instantâneas de eventos do ERP
8. **Retry Automático** - Recuperação de falhas transientes com backoff exponencial
9. **Transformação de Dados** - Conversão entre JSON, XML e EDI com validação de schema
10. **Dashboard de Integrações** - Visualização do status, logs e métricas em tempo real
11. **Dead Letter Queue** - Gestão de mensagens com falha para análise posterior
12. **Gestão de Credenciais** - Armazenamento seguro em Key Vault com rotação automática

---

## 5. REGRAS DE NEGÓCIO

### RN-RF078-001: Sincronização de Centros de Custo deve ser bidirecional

**Descrição**: Centros de custo podem ser criados ou alterados tanto no IControlIT quanto no ERP. As mudanças devem ser sincronizadas automaticamente em ambas as direções.

**Justificativa**: Estrutura organizacional é frequentemente definida no ERP (SAP), mas pode sofrer ajustes locais em IControlIT. Sem sincronização bidirecional, divergências comprometem auditoria e conformidade fiscal.

**Critério de Aceite**:
- Centro de Custo criado no SAP → importado automaticamente para IControlIT
- Centro de Custo desativado em IControlIT → marcado como inativo no ERP
- Conflitos de atualização → resolvidos com timestamp (última atualização prevalece)
- Auditoria registra origem da mudança (IControlIT ou ERP)

---

### RN-RF078-002: Credenciais de ERP devem ser armazenadas em Azure Key Vault com rotação automática

**Descrição**: Senhas, tokens de API e certificados RFC devem ser armazenados criptografados em Azure Key Vault, nunca em código ou arquivo de configuração. Rotação automática deve ocorrer a cada 90 dias.

**Justificativa**: Conformidade com SOX, LGPD e boas práticas de segurança. Credenciais hardcoded em repositório ou config files são vulnerabilidades críticas.

**Critério de Aceite**:
- Credenciais nunca aparecem em código-fonte ou appsettings.json
- Busca em Key Vault sempre que necessário usar credencial
- Rotação automática 7 dias antes do vencimento
- Alerta disparado se rotação falhar
- Auditoria registra todas as leituras de credenciais

---

### RN-RF078-003: Integrações com falha devem registrar na DLQ e notificar administrador

**Descrição**: Quando uma integração falha após 5 tentativas com backoff exponencial, a mensagem é movida para Dead Letter Queue (DLQ) e um alerta é disparado para o administrador de integrações.

**Justificativa**: Garantir que nenhuma integração seja silenciosamente perdida. DLQ permite investigação posterior sem bloquear o fluxo normal de operação.

**Critério de Aceite**:
- Tentativas: 2s, 4s, 8s, 16s, 32s (máximo 5 tentativas)
- Após 5 falhas → mover para DLQ
- Notificação enviada para ADMIN_INTEGRACAO via email e Slack
- Auditoria registra todas as tentativas com timestamps
- Dashboard exibe quantidade de mensagens em DLQ

---

### RN-RF078-004: Exportação de custos de TI deve respeitar centro de custo e período contábil

**Descrição**: Custos são exportados apenas para centros de custo válidos no ERP e apenas para períodos contábeis abertos ou atuais.

**Justificativa**: Evitar contabilização de custos em centros inexistentes ou períodos fechados, que causariam erro no ERP e inconsistência fiscal.

**Critério de Aceite**:
- Validar período está aberto no ERP antes de exportar
- Validar CodigoERP preenchido para cada centro de custo
- Validar código existe no ERP (consulta prévia)
- Centros sem mapeamento → skip com registro em log
- Período fechado → erro 400 com mensagem clara

---

### RN-RF078-005: Cada mensagem integrada deve ter identificador único (UUID) para deduplicação

**Descrição**: Todas as mensagens enviadas ou recebidas em integrações possuem UUID único (MessageId). Se a mesma mensagem for reprocessada, ela é identificada como duplicata e ignorada.

**Justificativa**: Evitar processamento duplicado em caso de retry. Sem deduplicação, nota fiscal poderia ser importada 2x, gerando divergência contábil.

**Critério de Aceite**:
- Gerar UUID antes de processar mensagem
- Verificar se MessageId já existe em IntegrationAudit
- Duplicata detectada → registrar em log, ignorar processamento
- Mensagem nova → processar, marcar MessageId como processada
- UUID deve seguir padrão RFC 4122

---

### RN-RF078-006: Transformação de dados deve validar schema e tipo de campo antes de processar

**Descrição**: Todo dado recebido do ERP (JSON, XML, EDI) é validado contra um schema JSON Schema v7 ou XSD antes de ser processado.

**Justificativa**: Dados malformados ou com tipos incorretos causam erros silenciosos ou crashes. Validação preventiva garante qualidade dos dados e rastreabilidade de erros.

**Critério de Aceite**:
- Carregar schema apropriado (JSON Schema v7 ou XSD)
- Validar estrutura do payload recebido
- Validação falhou → erro 400 com lista de campos inválidos
- Validação OK → aplicar transformação e processar
- Auditoria registra resultado da validação

---

### RN-RF078-007: Logs de integração devem registrar entrada, saída e erro em tabela estruturada com retenção de 7 anos

**Descrição**: Todas as operações de integração (sync, import, export) registram dados estruturados em tabela IntegrationAudit com retenção de 7 anos por conformidade LGPD.

**Justificativa**: Conformidade regulatória, forensics, troubleshooting, compliance reporting. Logs em arquivo de texto não são auditáveis nem consultáveis.

**Critério de Aceite**:
- Registrar MessageId, TipoIntegracao, DirecaoFluxo (INBOUND/OUTBOUND)
- Registrar StatusExecucao (SUCESSO/ERRO/DLQ)
- Registrar payload de entrada e saída em JSON
- Registrar mensagem de erro se aplicável
- Registrar usuário, data/hora, tempo de execução
- Retenção automática de 7 anos (2555 dias)

---

### RN-RF078-008: Webhooks de ERP devem validar assinatura HMAC-SHA256 antes de processar

**Descrição**: Mensagens webhook recebidas do ERP devem incluir assinatura HMAC-SHA256 no header `X-Hub-Signature` que é validada contra chave secreta armazenada em Key Vault.

**Justificativa**: Prevenir spoofing de webhook. Sem validação, qualquer pessoa poderia disparar integrações falsas causando dados corrompidos ou ataques DoS.

**Critério de Aceite**:
- Header `X-Hub-Signature` obrigatório
- Computar HMAC-SHA256 do body com chave do Key Vault
- Comparar assinatura recebida com computada
- Assinatura inválida → rejeitar com 403 Forbidden
- Assinatura válida → processar webhook
- Auditoria registra tentativas de webhook inválido

---

### RN-RF078-009: Dados sensíveis (salários, valores de contrato) devem ser criptografados em campo específico na auditoria

**Descrição**: Valores financeiros, salários, valores de contrato são armazenados criptografados em campos específicos da auditoria e nunca em logs de texto plano.

**Justificativa**: Conformidade LGPD e proteção de dados sensíveis. Mesmo em auditoria, não devemos expor valores financeiros em texto plano.

**Critério de Aceite**:
- Valores sensíveis criptografados com AES-256
- Chave de criptografia armazenada em Key Vault
- IV (Initialization Vector) gerado único por registro
- Descriptografia apenas com permissão ADMIN_AUDITORIA
- Dados sensíveis nunca aparecem em logs de texto

---

### RN-RF078-010: Reconciliação de faturas telecom com contas a pagar do ERP deve considerar tolerância de diferença de 0,5%

**Descrição**: Ao fazer matching entre faturas telecom (IControlIT) e contas a pagar (ERP), tolera-se diferença de até 0,5% no valor total para absorver variações cambiais e juros.

**Justificativa**: Faturas telecom podem ter variações de moeda ou juros não previstos. Reconciliação muito rígida gera divergências que precisam ajuste manual desnecessariamente.

**Critério de Aceite**:
- Calcular diferença percentual: `|Fatura - ContaPagar| / Fatura * 100`
- Diferença ≤ 0,5% → reconciliar automaticamente
- Diferença > 0,5% → marcar como REQUER_MANUAL
- Notificar financeiro para faturas que requerem reconciliação manual
- Auditoria registra percentual de diferença encontrado

---

## 6. ESTADOS DA ENTIDADE

### 6.1 Estados de Integração

| Estado | Descrição |
|------|-----------|
| `PENDENTE` | Mensagem criada, aguardando processamento |
| `EM_PROCESSAMENTO` | Processamento em andamento |
| `SUCESSO` | Processada com sucesso |
| `ERRO_TEMPORARIO` | Falha temporária, aguardando retry |
| `ERRO_PERMANENTE` | Falha permanente após 5 tentativas |
| `NA_DLQ` | Movida para Dead Letter Queue |
| `DUPLICATA` | Detectada como duplicata, ignorada |

### 6.2 Estados de Reconciliação

| Estado | Descrição |
|------|-----------|
| `PENDENTE_RECONCILIACAO` | Fatura importada, aguardando matching |
| `RECONCILIADO` | Matching automático realizado com sucesso |
| `REQUER_MANUAL` | Diferença > 0,5%, requer intervenção |
| `RECONCILIADO_MANUAL` | Reconciliado manualmente pelo financeiro |
| `NAO_RECONCILIAVEL` | Sem correspondência no ERP |

### Transições permitidas

| De | Para | Evento |
|---|---|---|
| `PENDENTE` | `EM_PROCESSAMENTO` | Mensagem retirada da fila |
| `EM_PROCESSAMENTO` | `SUCESSO` | Processamento concluído sem erros |
| `EM_PROCESSAMENTO` | `ERRO_TEMPORARIO` | Falha temporária (timeout, indisponibilidade) |
| `ERRO_TEMPORARIO` | `EM_PROCESSAMENTO` | Retry automático |
| `ERRO_TEMPORARIO` | `ERRO_PERMANENTE` | 5 tentativas esgotadas |
| `ERRO_PERMANENTE` | `NA_DLQ` | Movida para DLQ |
| `EM_PROCESSAMENTO` | `DUPLICATA` | MessageId já processado |
| `PENDENTE_RECONCILIACAO` | `RECONCILIADO` | Matching automático (diferença ≤ 0,5%) |
| `PENDENTE_RECONCILIACAO` | `REQUER_MANUAL` | Diferença > 0,5% |
| `REQUER_MANUAL` | `RECONCILIADO_MANUAL` | Usuário reconciliou manualmente |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre |
|------|--------------|
| `CentroCustoSincronizado` | Após sincronização bem-sucedida de centro de custo |
| `CustoExportado` | Após exportação de custos para ERP |
| `NotaFiscalImportada` | Após importação de nota fiscal do ERP |
| `FaturaReconciliada` | Após reconciliação automática ou manual |
| `IntegracaoFalhou` | Após falha permanente (movida para DLQ) |
| `CredencialRotacionada` | Após rotação automática de credencial no Key Vault |
| `WebhookRecebido` | Após recebimento e validação de webhook |
| `DuplicataDetectada` | Quando MessageId duplicado é detectado |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant (dados de um cliente nunca vazam para outro)
- Nenhuma regra de negócio pode ser ignorada silenciosamente
- Erros devem ser previsíveis, rastreáveis e auditáveis
- Auditoria deve registrar quem, quando, o quê mudou e de onde veio (IControlIT ou ERP)
- Credenciais nunca aparecem em logs ou código-fonte
- Webhooks sem assinatura válida devem ser rejeitados
- Mensagens duplicadas devem ser detectadas e ignoradas
- Dados sensíveis devem ser criptografados em repouso
- Conformidade com LGPD, SOX e NF-e deve ser garantida

---

## 9. SEGURANÇA

### 9.1 Controles de Segurança

- Validação de entrada obrigatória (JSON Schema, XSD)
- Proteção contra injeção (SQL, XML, JSON)
- Controle de permissões RBAC para todas as operações
- Isolamento multi-tenant estrito (cada cliente vê apenas suas integrações)
- Validação de assinatura HMAC-SHA256 em webhooks
- Criptografia de credenciais em Azure Key Vault
- Criptografia de dados sensíveis em auditoria (AES-256)
- Rate limiting de 100 req/min por client
- Logs estruturados em JSON sem exposição de dados sensíveis
- Rotação automática de credenciais a cada 90 dias

### 9.2 Testes de Segurança Obrigatórios

- SQL Injection em payloads de integração (XML, JSON, EDI)
- XSS em mensagens de erro exibidas no dashboard
- CSRF Protection em endpoints POST de configuração
- Validação de permissões RBAC em todos os endpoints
- Validação de assinatura HMAC (webhook falso deve ser rejeitado)
- Teste de rejeição de credenciais expiradas no Key Vault
- Teste de conformidade: dados sensíveis não aparecem em logs
- Teste de rate limiting: >100 req/min deve retornar 429 Too Many Requests
- Teste de expiração de token OAuth e renovação automática
- Teste de isolamento multi-tenancy: cliente A não acessa dados do cliente B

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF078.md** - 5 casos de uso (UC00 a UC04: listar, sincronizar, exportar, reconciliar, webhook)
- **MD-RF078.yaml** - Modelo de dados (IntegrationAudit, ERPCredential, ReconciliationMatch)
- **TC-RF078.yaml** - Casos de teste (validação de schema, retry, deduplicação, HMAC)
- **MT-RF078.yaml** - Massas de teste (payloads válidos e inválidos, webhooks, credenciais)

---

## 11. RASTREABILIDADE

| Artefato | Status | Responsável |
|--------|-------|------|
| **UC-RF078.md** | Pendente | Architect Agent |
| **MD-RF078.yaml** | Pendente | Architect Agent |
| **TC-RF078-BACKEND.md** | Pendente | Tester Agent |
| **TC-RF078-FRONTEND.md** | Pendente | Tester Agent |
| **TC-RF078-SEGURANCA.md** | Pendente | Tester Agent |
| **TC-RF078-E2E.md** | Pendente | Tester Agent |
| **MT-RF078-BACKEND.csv** | Pendente | Tester Agent |
| **Backend Implementation** | Pendente | Developer Agent |
| **Frontend Implementation** | Pendente | Developer Agent |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|------|------|----------|------|
| 2.0 | 2025-12-30 | Migração para Governança v2.0 - Separação completa RF/RL, 10 regras de negócio em linguagem natural, remoção de código e referências ao legado | Agência ALC - alc.dev.br |
| 1.0 | 2025-12-28 | Versão inicial com 10 regras de negócio, 13 endpoints, 3 fluxos | Claude Code |

---

**Última Atualização**: 2025-12-30
**Versão Governança**: 2.0
**Autor**: Agência ALC - alc.dev.br
**Revisão**: Pendente de aprovação técnica
