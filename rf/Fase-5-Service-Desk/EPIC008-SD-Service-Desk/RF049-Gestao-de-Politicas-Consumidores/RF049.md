# RF-049: Gestão de Políticas de Consumidores

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC008-SD-Service-Desk
**Fase**: Fase 5 - Service Desk

---

## 1. OBJETIVO DO REQUISITO

Implementar sistema completo de gestão de políticas de consumidores que permita definir, aplicar e monitorar regras de uso e restrições para consumidores de telecomunicações (colaboradores, departamentos, dispositivos). O sistema oferece motor de políticas configurável que controla limites de consumo, restrições de uso, franquias de dados/voz/SMS, bloqueios automáticos, alertas proativos e aplicação baseada em perfis/departamentos/status.

O sistema deve permitir controlar custos de telecomunicações através de limites e franquias, prevenir uso indevido de recursos corporativos, garantir conformidade com políticas corporativas e regulatórias, automatizar bloqueios e notificações quando limites são atingidos, e oferecer visibilidade gerencial sobre consumo e violações de políticas.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] CRUD completo de políticas de consumo
- [x] Motor de políticas configurável com múltiplos tipos de regras
- [x] Aplicação automática de políticas por perfil/status/departamento
- [x] Processamento em lote de aplicação/remoção de políticas
- [x] Avaliação de políticas em tempo real (API de verificação)
- [x] Alertas proativos em múltiplos limiares (50%, 80%, 100%)
- [x] Bloqueios automáticos por violação de políticas
- [x] Histórico de aplicações de políticas (retenção 7 anos LGPD)
- [x] Histórico de violações de políticas
- [x] Dashboard de conformidade com indicadores visuais
- [x] Simulador de impacto de políticas
- [x] Relatórios de violações e consumo
- [x] API REST completa com permissões RBAC
- [x] Interface Angular 19 com wizard de criação
- [x] Auditoria completa de todas as operações
- [x] Suporte multi-tenant com isolamento de dados
- [x] Templates de políticas pré-configuradas
- [x] Importação/Exportação de políticas (JSON)

### 2.2 Fora do escopo (não objetivos)

- Gerenciamento de usuários/perfis (RF006)
- Gerenciamento de consumidores (RF052)
- Gerenciamento de status (RF048)
- Faturamento detalhado (RF026)
- Auditoria de bilhetes (RF034, RF035)
- Gestão de contratos (RF023)
- Inventário de ativos (RF025)
- Análise preditiva de consumo (roadmap futuro)
- Interface visual específica (layout é responsabilidade do frontend)
- Tecnologia de implementação (definido em arquitetura)
- Estratégia de deploy ou infraestrutura

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| Política de Consumidor | Conjunto de regras e restrições aplicadas a um ou mais consumidores para controlar uso de serviços de telecomunicações |
| Motor de Políticas | Componente que avalia em tempo real se uma operação viola políticas aplicadas |
| Violação de Política | Evento onde consumidor ultrapassa ou viola uma regra definida em política aplicada |
| Aplicação de Política | Ato de vincular uma política a um consumidor específico, com data de início e fim |
| Template de Política | Política pré-configurada que pode ser reutilizada e customizada |
| Limiar de Alerta | Percentual do limite (50%, 80%, 100%) que dispara notificação automática |
| Bloqueio Automático | Restrição aplicada automaticamente quando consumidor atinge 100% do limite |
| Conformidade | Estado que indica se consumidor está respeitando políticas aplicadas |
| Simulador de Impacto | Ferramenta que analisa impacto de política antes da aplicação em produção |
| Processamento em Lote | Aplicação/remoção de política para múltiplos consumidores simultaneamente |

---

## 4. FUNCIONALIDADES COBERTAS

1. Criar política de consumidor
2. Atualizar política existente
3. Consultar política por ID
4. Listar políticas com filtros (tipo, status, perfil)
5. Excluir política (lógica)
6. Aplicar política a consumidores (individual ou lote)
7. Remover política de consumidores
8. Avaliar se operação viola política (tempo real)
9. Simular impacto de política antes de aplicar
10. Gerar alertas proativos em limiares configurados
11. Executar bloqueios automáticos por violação
12. Registrar histórico de aplicações (7 anos)
13. Registrar histórico de violações
14. Exibir dashboard de conformidade
15. Importar políticas de arquivo JSON
16. Exportar políticas para arquivo JSON
17. Gerenciar templates de políticas

---

## 5. REGRAS DE NEGÓCIO

### RN-RF049-01 — Tipos de Políticas Suportadas

**Descrição**: Sistema deve suportar múltiplos tipos de políticas de restrição configuráveis.

**Justificativa**: Permitir flexibilidade no controle de diferentes aspectos de consumo de telecomunicações.

**Critério de Aceite**:
- Tipos suportados: Limite Monetário (R$), Franquia de Dados (MB/GB), Franquia de Voz (minutos), Franquia de SMS (quantidade), Restrição de Horário, Restrição de Destinos, Limite de Roaming, Limite por Tipo de Serviço
- Cada política pode combinar múltiplos tipos de restrições
- Sistema valida tipo de política ao criar
- Políticas customizadas podem ser criadas por Super Admins com validação manual

---

### RN-RF049-02 — Aplicação Automática de Políticas por Perfil

**Descrição**: Políticas devem ser aplicadas automaticamente conforme perfil do consumidor.

**Justificativa**: Automatizar governança de uso conforme hierarquia organizacional.

**Critério de Aceite**:
- Perfis pré-definidos: Executivo, Gerente, Colaborador, Estagiário, Externo
- Cada perfil tem conjunto padrão de políticas
- Ao criar consumidor com perfil X, políticas do perfil são aplicadas automaticamente via Domain Event
- Mudança de perfil aplica novas políticas e remove antigas (com histórico)
- Consumidores podem ter políticas customizadas que sobrescrevem políticas de perfil

---

### RN-RF049-03 — Aplicação Automática de Políticas por Status

**Descrição**: Mudança de status do consumidor deve aplicar políticas específicas automaticamente.

**Justificativa**: Garantir que mudanças de status reflitam em restrições adequadas.

**Critério de Aceite**:
- Status Ativo: Políticas normais do perfil
- Status Suspenso: Bloqueio de novas operações, mantém consulta
- Status Bloqueado: Bloqueio total
- Status Inativo: Sem políticas aplicadas
- Status Pendente: Políticas restritivas (ex: apenas ligações locais)
- Integração com RF048 (Status) via Domain Events
- Políticas de status sobrescrevem políticas de perfil em caso de conflito

---

### RN-RF049-04 — Alertas Proativos em Múltiplos Limiares

**Descrição**: Sistema deve alertar ANTES de atingir limite para permitir ação preventiva.

**Justificativa**: Prevenir violações através de notificações antecipadas.

**Critério de Aceite**:
- Alertas em: 50% do limite (aviso informativo), 80% do limite (aviso crítico), 100% do limite (bloqueio iminente)
- Canais: E-mail, SMS (crítico), Notificação in-app
- Destinatários: Consumidor, Gestor responsável, Financeiro
- Alertas não devem duplicar (apenas 1 alerta por limiar por período)
- Sistema monitora consumo em tempo real e dispara alertas via RF066/RF067
- Alertas podem ser desabilitados por política (ex: para testes)

---

### RN-RF049-05 — Bloqueio Automático por Violação de Política

**Descrição**: Consumidores que violam políticas devem ser bloqueados automaticamente.

**Justificativa**: Garantir conformidade e evitar custos excessivos.

**Critério de Aceite**:
- Ao atingir 100% do limite: Bloqueia novas operações do tipo restrito, Notifica stakeholders, Registra violação no histórico, Cria solicitação de análise para Gestor
- Bloqueio pode ser: Total (todos os serviços) ou Parcial (apenas serviço que violou)
- Motor de políticas avalia violação e dispara bloqueio via RF048
- Políticas com flag "AlertOnly" apenas alertam sem bloquear
- Mantém outros serviços funcionando (bloqueio seletivo)

---

### RN-RF049-06 — Processamento em Lote de Aplicação de Políticas

**Descrição**: Permitir aplicar/remover políticas de múltiplos consumidores simultaneamente.

**Justificativa**: Facilitar gestão em larga escala de políticas corporativas.

**Critério de Aceite**:
- Operação em lote deve: Validar se política é aplicável a cada consumidor, Processar de forma assíncrona (job em background), Gerar relatório consolidado de sucesso/falha, Permitir rollback em caso de falha crítica
- Respeitar limite máximo de 1000 consumidores por lote
- Sistema processa via Hangfire, gerando relatório ao final
- Lotes com mais de 1000 registros devem ser divididos em múltiplos jobs

---

### RN-RF049-07 — Histórico Completo de Aplicações de Políticas (LGPD)

**Descrição**: Todas as aplicações/remoções de políticas devem ser registradas de forma imutável.

**Justificativa**: Conformidade com LGPD e rastreabilidade de decisões.

**Critério de Aceite**:
- Sistema registra: Data/Hora, Usuário Responsável, Consumidor Afetado, Política Aplicada/Removida, Motivo, Vigência (Data Início/Fim)
- Retenção de 7 anos conforme LGPD
- Dados não podem ser alterados, apenas visualizados
- Cada aplicação/remoção gera registro imutável na tabela PoliticaConsumidorHistorico
- Histórico é obrigatório para conformidade (sem exceções)

---

### RN-RF049-08 — Histórico de Violações de Políticas

**Descrição**: Todas as violações de políticas devem ser registradas para auditoria e análise.

**Justificativa**: Permitir análise de tendências e identificação de violadores recorrentes.

**Critério de Aceite**:
- Violação registra: Data/Hora, Consumidor, Política Violada, Valor Limite, Valor Consumido, Ação Tomada (bloqueio/alerta), Responsável pela Liberação (se aplicável)
- Dashboard exibe: Top 10 violadores, Políticas mais violadas, Tendência temporal de violações
- Sistema cria registro automático ao detectar violação
- Violações em ambiente de teste não geram histórico

---

### RN-RF049-09 — Avaliação de Políticas em Tempo Real (API)

**Descrição**: Sistema deve fornecer API para verificar se ação viola política ANTES de executar.

**Justificativa**: Prevenir violações antes que ocorram.

**Critério de Aceite**:
- Endpoint `POST /api/gestao/politicas-consumidores/avaliar` recebe: Consumidor, Tipo de Operação, Valor/Destino
- Retorna: Permitido (true/false), Políticas Aplicáveis, Limite Atual, Consumo Atual, Percentual Usado
- Tempo de resposta ≤ 100ms (P95) para não impactar operações
- Motor de políticas avalia regras em memória (cache) para performance
- Em caso de falha do serviço, política padrão é "permitir" (fail-open para disponibilidade)

---

### RN-RF049-10 — Simulador de Impacto de Políticas

**Descrição**: Permitir simular impacto de política antes de aplicar em produção.

**Justificativa**: Reduzir risco de aplicação de políticas inadequadas.

**Critério de Aceite**:
- Simulador recebe política a ser testada
- Analisa consumo histórico dos consumidores afetados
- Retorna: Quantos seriam bloqueados, Quando seriam bloqueados, Estimativa de economia
- Interface exibe relatório visual com gráficos
- Simulador usa dados históricos reais mas não aplica mudanças
- Simulador não funciona para consumidores novos sem histórico

---

### RN-RF049-11 — Templates de Políticas Pré-Configuradas

**Descrição**: Sistema deve oferecer templates de políticas comuns para agilizar configuração.

**Justificativa**: Facilitar criação de políticas padronizadas.

**Critério de Aceite**:
- Templates disponíveis: "Executivo" (sem limites), "Gerente" (limite R$ 500), "Colaborador" (limite R$ 200), "Estagiário" (limite R$ 50, apenas local)
- Cada template pode ser customizado ao aplicar
- Templates podem ser criados por administradores
- Sistema lista templates disponíveis e permite clonagem/customização
- Templates não podem ser deletados se estiverem em uso

---

### RN-RF049-12 — Importação/Exportação de Políticas

**Descrição**: Permitir importar/exportar políticas para replicação entre ambientes ou backup.

**Justificativa**: Facilitar migração entre ambientes e backup de configurações.

**Critério de Aceite**:
- Exportação: Gera JSON com todas as políticas e configurações
- Importação: Valida estrutura do arquivo, Verifica conflitos com políticas existentes, Permite preview antes de confirmar, Cria histórico de importação
- Formato JSON deve seguir schema validado
- Sistema valida schema JSON e integridade de dados
- Importação de políticas inválidas é rejeitada com mensagem de erro detalhada

---

### RN-RF049-13 — Dashboard de Conformidade com Indicadores Visuais

**Descrição**: Interface deve exibir visualmente conformidade de consumidores com políticas.

**Justificativa**: Facilitar gestão visual e identificação rápida de problemas.

**Critério de Aceite**:
- Dashboard exibe: Total de consumidores por status de conformidade (Conforme, Aviso, Crítico, Violação), Gráfico de evolução de violações temporal, Lista de consumidores em situação crítica (>80%), Top 10 violadores do período
- Cores: Verde (Conforme), Amarelo (Aviso), Laranja (Crítico), Vermelho (Violação)
- Dashboard atualiza em tempo real via SignalR
- Dados históricos (>3 meses) carregam sob demanda

---

### RN-RF049-14 — Integração com Faturamento para Cálculo de Economia

**Descrição**: Sistema deve calcular economia gerada por políticas aplicadas.

**Justificativa**: Demonstrar ROI de políticas de contenção de custos.

**Critério de Aceite**:
- Cálculo: Consumo Real com Política - Consumo Estimado sem Política = Economia
- Base de comparação: Média de consumo dos 3 meses anteriores à aplicação da política
- Relatório mensal de economia enviado automaticamente para Gestores
- Economia exibida no dashboard
- Integração com RF026 (Faturamento) para obter dados de consumo
- Consumidores novos (<3 meses) não têm cálculo de economia

---

### RN-RF049-15 — Validação de Permissões RBAC

**Descrição**: Operações sobre políticas devem respeitar permissões por perfil.

**Justificativa**: Garantir segregação de duties e segurança.

**Critério de Aceite**:
- Permissões definidas: GESTAO.POLITICAS.VIEW, GESTAO.POLITICAS.CREATE, GESTAO.POLITICAS.UPDATE, GESTAO.POLITICAS.DELETE, GESTAO.POLITICAS.APPLY, GESTAO.POLITICAS.ADMIN
- Endpoints validam permissões via RequireAuthorization
- Commands validam via Authorize(Roles)
- Permissões são obrigatórias para segurança (sem exceções)

---

## 6. ESTADOS DA ENTIDADE

| Estado | Descrição | Transições Permitidas |
|--------|-----------|----------------------|
| Rascunho | Política criada mas não publicada | → Ativa, → Cancelada |
| Ativa | Política em vigor e aplicável | → Suspensa, → Inativa |
| Suspensa | Política temporariamente desabilitada | → Ativa, → Inativa |
| Inativa | Política desabilitada permanentemente | (final) |
| Cancelada | Política cancelada sem ter sido ativada | (final) |

**Transições Proibidas**:
- De Inativa ou Cancelada para qualquer outro estado
- De Rascunho diretamente para Suspensa ou Inativa

---

## 7. ENDPOINTS DA API

| Método | Endpoint | Descrição | Permissão |
|--------|----------|-----------|-----------|
| GET | /api/gestao/politicas-consumidores | Listar políticas com filtros | GESTAO.POLITICAS.VIEW |
| GET | /api/gestao/politicas-consumidores/{id} | Obter detalhes de uma política | GESTAO.POLITICAS.VIEW |
| POST | /api/gestao/politicas-consumidores | Criar nova política | GESTAO.POLITICAS.CREATE |
| PUT | /api/gestao/politicas-consumidores/{id} | Atualizar política existente | GESTAO.POLITICAS.UPDATE |
| DELETE | /api/gestao/politicas-consumidores/{id} | Excluir política (lógica) | GESTAO.POLITICAS.DELETE |
| POST | /api/gestao/politicas-consumidores/{id}/apply | Aplicar política a consumidores | GESTAO.POLITICAS.APPLY |
| POST | /api/gestao/politicas-consumidores/{id}/remove | Remover política de consumidores | GESTAO.POLITICAS.APPLY |
| POST | /api/gestao/politicas-consumidores/batch-apply | Aplicação em lote | GESTAO.POLITICAS.APPLY |
| POST | /api/gestao/politicas-consumidores/avaliar | Avaliar se ação viola política | GESTAO.POLITICAS.VIEW |
| POST | /api/gestao/politicas-consumidores/{id}/simular | Simular impacto de política | GESTAO.POLITICAS.VIEW |
| GET | /api/gestao/politicas-consumidores/{id}/historico | Obter histórico de aplicações | GESTAO.POLITICAS.VIEW |
| GET | /api/gestao/politicas-consumidores/violacoes | Listar violações de políticas | GESTAO.POLITICAS.VIEW |
| GET | /api/gestao/politicas-consumidores/dashboard | Obter dados do dashboard | GESTAO.POLITICAS.VIEW |
| GET | /api/gestao/politicas-consumidores/templates | Listar templates de políticas | GESTAO.POLITICAS.VIEW |
| POST | /api/gestao/politicas-consumidores/importar | Importar políticas de arquivo | GESTAO.POLITICAS.ADMIN |
| GET | /api/gestao/politicas-consumidores/exportar | Exportar políticas para arquivo | GESTAO.POLITICAS.ADMIN |

---

## 8. INTEGRAÇÕES

### 8.1 Integrações Internas Obrigatórias

- **Autenticação (RF006)**: Validação de JWT token em todos os endpoints
- **Multi-Tenancy**: Isolamento de dados por Id_Fornecedor via Query Filter
- **Auditoria (RF003)**: Registro de todas as operações (CREATE, READ, UPDATE, DELETE, APPLY, REMOVE)
- **Internacionalização (i18n)**: Todas as mensagens, labels e validações devem ter chaves de tradução

### 8.2 Integrações com Outros RFs

| RF | Nome | Tipo | Descrição |
|----|------|------|-----------|
| RF003 | Logs, Monitoramento e Observabilidade | Obrigatória | Auditoria de todas as operações |
| RF006 | Gestão de Usuários | Obrigatória | Validação de permissões RBAC |
| RF026 | Gestão de Faturas | Obrigatória | Cálculo de consumo e economia |
| RF048 | Gestão de Status de Consumidores | Obrigatória | Bloqueios automáticos e aplicação por status |
| RF052 | Gestão de Consumidores | Obrigatória | Entidade principal e aplicação de políticas |
| RF066 | Notificações e Alertas | Obrigatória | Alertas proativos via notificações in-app |
| RF067 | Central de E-mails | Obrigatória | Envio de alertas e relatórios via e-mail |
| RF030 | Gestão de Parâmetros de Faturamento | Opcional | Configurações de limites padrão |
| RF034 | Gestão de Itens de Auditoria | Opcional | Auditoria avançada de violações |
| RF035 | Gestão de Resumos de Auditoria | Opcional | Relatórios consolidados de auditoria |

### 8.3 Serviços Externos

- **Hangfire**: Processamento assíncrono de lotes e monitoramento
- **SignalR**: Atualizações em tempo real do dashboard

---

## 9. MODELO DE DADOS

### 9.1 Entidades Principais

**PoliticaConsumidor**
- Campos obrigatórios: Id_Fornecedor (multi-tenant), Nome, Tipo, Status
- Campos de auditoria: Id_Usuario_Criacao, Dt_Criacao, Id_Usuario_Alteracao, Dt_Alteracao
- Soft delete: Fl_Excluido
- Índices: Id_Fornecedor, Status, Tipo

**PoliticaConsumidorAplicacao**
- Campos obrigatórios: Id_Politica, Id_Consumidor, Dt_Inicio
- Campos opcionais: Dt_Fim, Motivo
- Relacionamentos: PoliticaConsumidor (N:1), Consumidor (N:1)

**PoliticaConsumidorHistorico**
- Campos obrigatórios: Id_Politica, Id_Consumidor, Dt_Operacao, Tipo_Operacao, Id_Usuario
- Imutável: Sem updates, apenas inserts
- Retenção: 7 anos

**ViolacaoPolitica**
- Campos obrigatórios: Id_Politica, Id_Consumidor, Dt_Violacao, Valor_Limite, Valor_Consumido, Acao_Tomada
- Campos opcionais: Id_Usuario_Liberacao, Dt_Liberacao

**TemplatePolitica**
- Campos obrigatórios: Nome, Descricao, Configuracao (JSON)
- Campos de auditoria: Id_Usuario_Criacao, Dt_Criacao

### 9.2 Restrições de Integridade

- PoliticaConsumidorAplicacao: Dt_Fim >= Dt_Inicio (se preenchida)
- ViolacaoPolitica: Valor_Consumido > Valor_Limite
- PoliticaConsumidor: Nome único por Id_Fornecedor

---

## 10. SEGURANÇA

### 10.1 Autenticação e Autorização

- **Autenticação**: JWT Bearer Token obrigatório em todos os endpoints
- **Autorização**: RBAC com permissões granulares (VIEW, CREATE, UPDATE, DELETE, APPLY, ADMIN)
- **Multi-tenancy**: Isolamento por Id_Fornecedor via Query Filter
- **Segregação de duties**: Quem cria política não pode aplicar diretamente (permissões separadas)

### 10.2 Proteção de Dados

- **Criptografia em repouso**: AES-256 para dados sensíveis
- **Criptografia em trânsito**: TLS 1.3
- **Auditoria**: Registro de todas as operações com usuário, IP, timestamp
- **Rate Limiting**: Máximo 100 requests/minuto por usuário
- **Input Validation**: Validação de entrada em todos os endpoints

---

## 11. REQUISITOS NÃO-FUNCIONAIS

### 11.1 Performance

- **Tempo de resposta**: Avaliar política em tempo real ≤ 100ms (P95)
- **Throughput**: Suportar até 50.000 avaliações de políticas/dia
- **Processamento em lote**: Aplicar política a 1.000 consumidores em ≤ 5 minutos
- **Dashboard**: Carregar dashboard completo em ≤ 2 segundos
- **Simulador**: Simular impacto de política em ≤ 5 segundos
- **Caching**: Cache de políticas ativas em memória por 5 minutos

### 11.2 Disponibilidade

- **Uptime**: 99.9% (tempo de inatividade máximo: 8h45min/ano)
- **Backup**: Backup diário com retenção de 30 dias
- **Retenção de dados**: 7 anos para histórico e violações (LGPD)
- **Disaster Recovery**: RPO ≤ 1 hora, RTO ≤ 4 horas
- **Fail-open**: Em caso de falha do motor de políticas, permitir operação (com log de alerta)

### 11.3 Escalabilidade

- **Horizontal**: Suportar múltiplas instâncias do motor de políticas
- **Cache distribuído**: Redis para cache de políticas ativas
- **Jobs assíncronos**: Hangfire para processamento em background

---

## 12. CRITÉRIOS DE ACEITAÇÃO

- [ ] CRUD completo de políticas de consumidores funcionando via API REST
- [ ] Motor de políticas avaliando regras em tempo real (≤100ms P95)
- [ ] Aplicação automática de políticas por perfil/status implementada
- [ ] Processamento em lote de aplicação/remoção de políticas funcionando
- [ ] Alertas proativos em múltiplos limiares (50%, 80%, 100%) enviados
- [ ] Bloqueios automáticos por violação de políticas funcionando
- [ ] Histórico de aplicações e violações armazenado (7 anos)
- [ ] Dashboard de conformidade atualizando em tempo real via SignalR
- [ ] Simulador de impacto de políticas funcionando corretamente
- [ ] Templates de políticas pré-configuradas disponíveis
- [ ] Importação/Exportação de políticas via JSON funcionando
- [ ] Integração com faturamento calculando economia gerada
- [ ] Interface Angular 19 com wizard de criação de políticas
- [ ] Auditoria completa de todas as operações funcionando
- [ ] Permissões RBAC validadas em todos os endpoints
- [ ] Multi-tenancy com isolamento de dados por fornecedor
- [ ] Cobertura de testes ≥ 80%
- [ ] Performance atendendo requisitos (≤100ms P95 para avaliação)
- [ ] Documentação técnica completa (Swagger + README)
- [ ] Logs estruturados e monitoramento configurados

---

## Histórico de Alterações

| Versão | Data | Autor | Descrição |
|--------|------|-------|-----------|
| 2.0 | 2025-12-30 | Agência ALC - alc.dev.br | Migração v1.0 → v2.0: Separação RF/RL, reestruturação para 11 seções padrão, remoção de referências ao legado |
| 1.0 | 2025-12-18 | IControlIT Architect Agent | Versão inicial - Especificação completa de Gestão de Políticas de Consumidores |
