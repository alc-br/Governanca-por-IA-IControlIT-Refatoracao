# RF044: Gest√£o de KPIs (Key Performance Indicators)

**Vers√£o**: 2.0
**Data**: 2025-12-30
**Autor**: Ag√™ncia ALC - alc.dev.br
**EPIC**: EPIC008-SD-Service-Desk
**Fase**: Fase-5-Service-Desk

---

## 1. OBJETIVO DO REQUISITO

Implementar um motor completo de indicadores-chave de desempenho (Key Performance Indicators) para monitoramento estrat√©gico e operacional do sistema IControlIT, permitindo:

- Cria√ß√£o, configura√ß√£o, monitoramento e an√°lise de indicadores personalizados
- Sistema de metas hier√°rquicas com alertas autom√°ticos
- Dashboards executivos com gr√°ficos interativos
- An√°lise preditiva de tend√™ncias com machine learning
- Exporta√ß√£o para ferramentas de BI externas

Este RF serve como **contrato oficial** entre neg√≥cio, desenvolvimento e testes, definindo **o que o sistema deve fazer**, sob quais condi√ß√µes e quais garantias devem ser preservadas.

---

## 2. ESCOPO

### 2.1 O que est√° dentro do escopo

- [x] Cria√ß√£o de KPIs customiz√°veis com f√≥rmulas complexas
- [x] Configura√ß√£o de metas hier√°rquicas (operacional ‚Üí t√°tico ‚Üí estrat√©gico)
- [x] Sistema de alertas autom√°ticos por threshold
- [x] Dashboards visuais com gr√°ficos interativos (ApexCharts)
- [x] An√°lise de tend√™ncias com machine learning (Azure ML)
- [x] Compara√ß√µes hist√≥ricas e benchmarking
- [x] Exporta√ß√£o para BI tools (Power BI, Tableau, Excel, PDF)
- [x] Drill-down para an√°lise detalhada
- [x] Recalculo autom√°tico por periodicidade (Hangfire)
- [x] Versionamento de f√≥rmulas de c√°lculo
- [x] Controle de acesso por categoria de KPI (RBAC)
- [x] Auditoria de opera√ß√µes
- [x] Isolamento multi-tenant

### 2.2 Fora do escopo (n√£o objetivos)

- Interface visual espec√≠fica (responsabilidade do frontend)
- Tecnologia, framework ou linguagem de implementa√ß√£o
- Layout, UX ou identidade visual
- Estrat√©gia de deploy ou infraestrutura
- Algoritmos espec√≠ficos de machine learning (responsabilidade Azure ML)

---

## 3. CONCEITOS E DEFINI√á√ïES

| Termo | Defini√ß√£o |
|-----|---------|
| KPI | Key Performance Indicator - Indicador-chave de desempenho mensur√°vel |
| Meta | Objetivo num√©rico a ser alcan√ßado por um KPI |
| Dashboard | Painel visual que agrega m√∫ltiplos KPIs |
| Alerta | Notifica√ß√£o autom√°tica quando KPI viola condi√ß√£o |
| Threshold | Limite (inferior ou superior) que dispara alerta |
| Drill-down | Navega√ß√£o de valor agregado at√© transa√ß√£o individual |
| Forecasting | Previs√£o de valores futuros baseada em hist√≥rico |
| Anomalia | Desvio estat√≠stico significativo do padr√£o hist√≥rico |
| Tenant | Unidade l√≥gica de isolamento de dados (empresa/conglomerado) |
| Sem√°foro | Indicador visual de status (vermelho, amarelo, verde, azul, roxo) |

---

## 4. FUNCIONALIDADES COBERTAS

1. Criar KPI com f√≥rmula de c√°lculo customiz√°vel
2. Atualizar configura√ß√£o de KPI existente
3. Consultar KPI por ID
4. Listar KPIs com filtros (categoria, status, respons√°vel)
5. Excluir KPI (soft delete)
6. Definir metas hier√°rquicas (m√≠nima, ideal, desafiadora)
7. Configurar alertas autom√°ticos (threshold, tend√™ncia, anomalia)
8. Recalcular KPIs manualmente ou automaticamente
9. Visualizar dashboards executivos
10. Exportar dados de KPIs (Power BI, Excel, PDF, JSON, CSV)
11. Consultar hist√≥rico de valores
12. Compartilhar dashboard via link p√∫blico tempor√°rio
13. Realizar drill-down at√© transa√ß√£o individual

---

## 5. REGRAS DE NEG√ìCIO

### RN-RF044-01 ‚Äî Unicidade de C√≥digo de KPI

**Descri√ß√£o**: Cada KPI deve ter um c√≥digo √∫nico no formato `KPI-{CATEGORIA}-{SEQUENCIAL}` (ex: `KPI-FIN-001`). O c√≥digo n√£o pode ser alterado ap√≥s cria√ß√£o.

**Justificativa**: Garante rastreabilidade e evita duplica√ß√£o de indicadores. O c√≥digo √© usado em f√≥rmulas de KPIs compostos.

**Crit√©rio de Aceite**:
- Campo `codigo` ausente ou vazio ‚Üí rejei√ß√£o HTTP 400
- C√≥digo duplicado ‚Üí rejei√ß√£o HTTP 409 com mensagem "C√≥digo {codigo} j√° existe para outro KPI"
- Formato inv√°lido ‚Üí rejei√ß√£o HTTP 400 com mensagem "C√≥digo deve seguir formato KPI-XXX-999"
- Tentativa de alterar c√≥digo em UPDATE ‚Üí rejei√ß√£o HTTP 400

**Implementa√ß√£o**:
```csharp
// CreateKPICommandValidator
RuleFor(x => x.Codigo)
    .NotEmpty().WithMessage("C√≥digo √© obrigat√≥rio")
    .Matches(@"^KPI-[A-Z]{3}-\d{3}$").WithMessage("C√≥digo deve seguir formato KPI-XXX-999");

// Unique constraint no banco
builder.HasIndex(k => k.Codigo).IsUnique();
```

---

### RN-RF044-02 ‚Äî Valida√ß√£o de F√≥rmula de C√°lculo

**Descri√ß√£o**: F√≥rmulas de KPIs devem ser validadas sintaticamente antes de salvar. SQL queries devem retornar exatamente uma linha com um valor num√©rico.

**Justificativa**: Evita erros em runtime que quebram c√°lculos de KPIs. Garante que o motor de c√°lculo sempre retorne valores v√°lidos.

**Crit√©rio de Aceite**:
- F√≥rmula SQL que retorna m√∫ltiplas linhas ‚Üí rejei√ß√£o HTTP 400
- F√≥rmula SQL que retorna valor n√£o num√©rico ‚Üí rejei√ß√£o HTTP 400
- F√≥rmula SQL com timeout > 30s ‚Üí rejei√ß√£o HTTP 408
- F√≥rmula com sintaxe inv√°lida ‚Üí rejei√ß√£o HTTP 400

**Implementa√ß√£o**:
```csharp
// KPICalculationService.ValidateFormula()
public async Task<ValidationResult> ValidateFormula(string formula)
{
    // Testa execu√ß√£o em sandbox isolado
    // Verifica tipo de retorno (decimal, int, float)
    // Timeout de 30s para queries complexas
}
```

---

### RN-RF044-03 ‚Äî Periodicidade M√≠nima por Fonte de Dados

**Descri√ß√£o**: KPIs baseados em API externa s√≥ podem ter periodicidade m√≠nima de 1 hora. KPIs de banco podem ser real-time (5min).

**Justificativa**: Evita sobrecarga de chamadas a APIs externas que t√™m rate limiting. Protege contra custos excessivos de API.

**Crit√©rio de Aceite**:
- KPI com `fonteDados = 'API_EXTERNA'` e `periodicidade < 60min` ‚Üí rejei√ß√£o HTTP 400
- KPI com `fonteDados = 'DATABASE'` permite qualquer periodicidade

**Implementa√ß√£o**:
```csharp
// CreateKPICommandValidator
RuleFor(x => x)
    .Must(kpi => kpi.FonteDados != "API_EXTERNA" || kpi.PeriodicidadeMinutos >= 60)
    .WithMessage("Periodicidade m√≠nima para API externa √© 1 hora");
```

---

### RN-RF044-04 ‚Äî Hierarquia de Metas Obrigat√≥ria

**Descri√ß√£o**: Metas de n√≠veis inferiores (departamento, equipe) devem somar no m√°ximo 100% da meta do n√≠vel superior (corporativa, divis√£o).

**Justificativa**: Garante alinhamento estrat√©gico e evita metas irrealistas. A soma das partes n√£o pode exceder o todo.

**Crit√©rio de Aceite**:
- Soma das metas filhas > 100% da meta pai ‚Üí rejei√ß√£o HTTP 400
- Alerta se soma ultrapassar 95% (warning, n√£o bloqueia)

**Implementa√ß√£o**:
```csharp
// CreateKPIMetaCommandValidator
public override async Task<ValidationResult> ValidateAsync(ValidationContext<CreateKPIMetaCommand> context)
{
    var metaPai = await _context.KPIMetas.FindAsync(command.MetaPaiId);
    var metasFilhas = await _context.KPIMetas.Where(m => m.MetaPaiId == command.MetaPaiId).ToListAsync();
    var somaFilhas = metasFilhas.Sum(m => m.Valor) + command.Valor;

    if (somaFilhas > metaPai.Valor)
        return ValidationResult.Failed("Soma das metas inferiores excede meta superior");
}
```

---

### RN-RF044-05 ‚Äî Sem√°foro Autom√°tico por Percentual

**Descri√ß√£o**: Cor do sem√°foro √© calculada automaticamente baseada no percentual de atingimento da meta m√≠nima:
- üî¥ Vermelho: < 80%
- üü° Amarelo: 80%-99%
- üü¢ Verde: 100%-104%
- üîµ Azul: 105%-119% (meta ideal)
- üü£ Roxo: ‚â• 120% (meta desafiadora)

**Justificativa**: Padroniza visualiza√ß√£o de performance em todos os dashboards. Facilita identifica√ß√£o r√°pida de problemas.

**Crit√©rio de Aceite**:
- C√°lculo autom√°tico a cada rec√°lculo do KPI
- Valor armazenado em `KPIHistorico.Semaforo`
- Personaliza√ß√£o de thresholds por KPI (campo `ThresholdsCustomizados`)

---

### RN-RF044-06 ‚Äî Alerta de Tend√™ncia com 3 Dias de Anteced√™ncia

**Descri√ß√£o**: Alertas de tend√™ncia devem disparar quando a previs√£o indica que a meta n√£o ser√° atingida nos pr√≥ximos 3 dias √∫teis.

**Justificativa**: Permite a√ß√£o corretiva antes do fim do per√≠odo. 3 dias √© tempo suficiente para mobilizar recursos.

**Crit√©rio de Aceite**:
- Azure ML calcula previs√£o diariamente
- Compara previs√£o D+3 com meta do per√≠odo
- Dispara alerta se previs√£o < 90% da meta

---

### RN-RF044-07 ‚Äî Anomalia Estat√≠stica (3 Desvios-Padr√£o)

**Descri√ß√£o**: Alertas de anomalia disparam quando o valor atual est√° a mais de 3 desvios-padr√£o da m√©dia dos √∫ltimos 30 dias.

**Justificativa**: Detecta comportamentos at√≠picos que podem indicar problemas (fraude, erro de sistema, incidente).

**Crit√©rio de Aceite**:
- C√°lculo usa hist√≥rico de 30 dias para baseline
- Verifica anomalias positivas (valor muito alto) e negativas (valor muito baixo)
- Dispara alerta apenas se |z-score| > 3

---

### RN-RF044-08 ‚Äî Drill-Down At√© Transa√ß√£o Individual

**Descri√ß√£o**: Todos os KPIs devem permitir drill-down at√© a transa√ß√£o ou registro individual que comp√µe o valor.

**Justificativa**: Permite investiga√ß√£o detalhada de desvios. Usu√°rio pode validar a origem dos n√∫meros.

**Crit√©rio de Aceite**:
- Endpoint `/api/kpis/{id}/detalhamento?data={data}` retorna lista de registros
- Lista inclui todos os filtros aplicados na f√≥rmula original
- Pagina√ß√£o obrigat√≥ria (max 100 registros por p√°gina)

---

### RN-RF044-09 ‚Äî Recalculo Autom√°tico por Periodicidade

**Descri√ß√£o**: KPIs devem ser recalculados automaticamente conforme periodicidade configurada via Hangfire jobs.

**Justificativa**: Garante dados sempre atualizados sem interven√ß√£o manual. Distribui√ß√£o de carga computacional.

**Periodicidades**:
- REALTIME ‚Üí a cada 5min
- HORARIO ‚Üí a cada 1h
- DIARIO ‚Üí 00:05 AM
- SEMANAL ‚Üí segunda 00:05 AM
- MENSAL ‚Üí dia 1 00:05 AM
- TRIMESTRAL ‚Üí primeiro dia do trimestre 00:05 AM

---

### RN-RF044-10 ‚Äî Cooldown de Alertas (1 Hora)

**Descri√ß√£o**: Mesmo alerta n√£o pode ser enviado mais de uma vez por hora para os mesmos destinat√°rios.

**Justificativa**: Evita spam de notifica√ß√µes quando KPI oscila pr√≥ximo ao threshold. Reduz fadiga de alertas.

**Crit√©rio de Aceite**:
- Tabela `KPIAlertaHistorico` com timestamp √∫ltimo envio
- Cooldown configur√°vel por alerta (padr√£o 60min)

---

### RN-RF044-11 ‚Äî Versionamento de F√≥rmulas

**Descri√ß√£o**: Altera√ß√µes em f√≥rmulas de KPIs devem criar nova vers√£o. Valores hist√≥ricos s√£o recalculados apenas se solicitado explicitamente.

**Justificativa**: Preserva consist√™ncia de dados hist√≥ricos. Permite auditoria de mudan√ßas em metodologia de c√°lculo.

**Crit√©rio de Aceite**:
- Tabela `KPIFormulaVersao` armazena hist√≥rico
- Flag `RecalcularHistorico` (default: false)
- Job ass√≠ncrono para rec√°lculo (pode levar horas)

---

### RN-RF044-12 ‚Äî Permiss√µes por Categoria de KPI

**Descri√ß√£o**: Usu√°rios s√≥ podem visualizar KPIs das categorias permitidas em seu perfil RBAC.

**Justificativa**: Seguran√ßa de informa√ß√µes estrat√©gicas. CFO v√™ financeiro, COO v√™ operacional, etc.

**Crit√©rio de Aceite**:
- Filtro autom√°tico em `GetKPIsQuery` baseado em permiss√µes
- Permission: `KPI.VIEW.{CATEGORIA}` (ex: `KPI.VIEW.FINANCEIRO`)

---

### RN-RF044-13 ‚Äî Dashboard P√∫blico com Token Tempor√°rio

**Descri√ß√£o**: Dashboards podem ser compartilhados via link p√∫blico com token JWT de 7 dias (renov√°vel).

**Justificativa**: Permite compartilhar resultados com stakeholders externos sem criar contas no sistema.

**Crit√©rio de Aceite**:
- Endpoint `POST /api/kpis/dashboards/{id}/share` gera token
- Token expira em 1-30 dias (configur√°vel)
- Acesso an√¥nimo apenas leitura (sem drill-down)

---

### RN-RF044-14 ‚Äî Agrega√ß√£o Inteligente por N√≠vel

**Descri√ß√£o**: KPIs de n√≠veis inferiores devem agregar automaticamente para n√≠veis superiores usando opera√ß√£o apropriada (SUM, AVG, MAX, MIN).

**Justificativa**: Evita inconsist√™ncias entre vis√µes micro e macro. Garante que "o todo = soma das partes".

**Crit√©rio de Aceite**:
- Campo `TipoAgregacao` define como agregar (SUM, AVG, MAX, MIN)
- C√°lculo autom√°tico em `KPIAggregationService`
- Valida√ß√£o: agregado = opera√ß√£o(componentes)

---

### RN-RF044-15 ‚Äî Reten√ß√£o de Dados Hist√≥ricos (7 Anos)

**Descri√ß√£o**: Valores hist√≥ricos de KPIs devem ser mantidos por 7 anos conforme LGPD/GDPR para auditoria.

**Justificativa**: Conformidade legal. Permite an√°lises de longo prazo e compara√ß√µes hist√≥ricas.

**Crit√©rio de Aceite**:
- Particionamento de tabela `KPIHistorico` por ano
- Job de arquivamento ap√≥s 7 anos (mover para cold storage)

---

## 6. ESTADOS DA ENTIDADE

### KPI

| Estado | Descri√ß√£o |
|------|-----------|
| DRAFT | Criado, ainda n√£o validado |
| ACTIVE | Ativo, c√°lculo autom√°tico habilitado |
| INACTIVE | Inativo, sem c√°lculo autom√°tico |
| DELETED | Exclu√≠do logicamente (soft delete) |

### Transi√ß√µes permitidas

| De | Para | Condi√ß√£o |
|---|---|---|
| DRAFT | ACTIVE | F√≥rmula validada com sucesso |
| ACTIVE | INACTIVE | Desativa√ß√£o manual |
| INACTIVE | ACTIVE | Reativa√ß√£o manual |
| ACTIVE | DELETED | Exclus√£o (soft delete) |
| INACTIVE | DELETED | Exclus√£o (soft delete) |

### Transi√ß√µes proibidas

| De | Para | Motivo |
|---|---|---|
| DELETED | qualquer | Exclus√£o l√≥gica √© irrevers√≠vel |
| DRAFT | DELETED | Deve passar por ACTIVE ou INACTIVE |

---

## 7. EVENTOS DE DOM√çNIO

| Evento | Quando ocorre | Dados do evento |
|------|--------------|-----------------|
| KPI.Criado | Ap√≥s cria√ß√£o bem-sucedida | KPIId, Codigo, Nome, Categoria |
| KPI.Atualizado | Ap√≥s atualiza√ß√£o | KPIId, CamposAlterados |
| KPI.Excluido | Ap√≥s exclus√£o l√≥gica | KPIId, Codigo, Nome |
| KPI.Calculado | Ap√≥s cada c√°lculo | KPIId, Valor, DataCalculo, FonteDados |
| KPI.MetaDefinida | Ap√≥s defini√ß√£o de meta | KPIId, TipoMeta, Valor |
| KPI.AlertaDisparado | Quando alerta √© enviado | KPIId, TipoAlerta, Destinatarios |
| KPI.FormulaAlterada | Quando f√≥rmula muda | KPIId, FormulaAntiga, FormulaNova, Versao |
| KPI.DashboardAcessado | Quando dashboard √© visualizado | DashboardId, UsuarioId |
| KPI.Exportado | Quando dados s√£o exportados | KPIId, Formato, Filtros |
| KPI.DashboardCompartilhado | Quando link p√∫blico √© gerado | DashboardId, Token, Expiracao |

---

## 8. CRIT√âRIOS GLOBAIS DE ACEITE

- ‚úÖ Nenhuma opera√ß√£o pode violar isolamento de tenant (EmpresaId/ConglomeradoId)
- ‚úÖ Nenhuma regra de neg√≥cio pode ser ignorada
- ‚úÖ Erros devem ser previs√≠veis, estruturados e rastre√°veis
- ‚úÖ Auditoria deve registrar quem, quando e o que mudou
- ‚úÖ F√≥rmulas inv√°lidas nunca podem ser salvas
- ‚úÖ Alertas respeitam cooldown configurado
- ‚úÖ Hist√≥rico preservado por 7 anos
- ‚úÖ Permiss√µes RBAC validadas em todas as opera√ß√µes
- ‚úÖ Rec√°lculo autom√°tico funciona conforme periodicidade
- ‚úÖ Drill-down sempre retorna dados consistentes com f√≥rmula original

---

## 9. INTEGRA√á√ïES OBRIGAT√ìRIAS

### 9.1 Central de Funcionalidades

**Funcionalidades a Registrar:**
```typescript
{
  modulo: 'GESTAO',
  funcionalidades: [
    { codigo: 'GES.KPI.LISTAR', nome: 'Listar KPIs', tipo: 'CONSULTA' },
    { codigo: 'GES.KPI.CRIAR', nome: 'Criar KPI', tipo: 'ESCRITA' },
    { codigo: 'GES.KPI.EDITAR', nome: 'Editar KPI', tipo: 'ESCRITA' },
    { codigo: 'GES.KPI.EXCLUIR', nome: 'Excluir KPI', tipo: 'EXCLUSAO' },
    { codigo: 'GES.KPI.CALCULAR', nome: 'Recalcular KPIs', tipo: 'ACAO' },
    { codigo: 'GES.KPI.DASHBOARD', nome: 'Visualizar Dashboards', tipo: 'CONSULTA' },
    { codigo: 'GES.KPI.META.DEFINIR', nome: 'Definir Metas', tipo: 'ESCRITA' },
    { codigo: 'GES.KPI.ALERTA.CONFIGURAR', nome: 'Configurar Alertas', tipo: 'ESCRITA' },
    { codigo: 'GES.KPI.HISTORICO', nome: 'Visualizar Hist√≥rico', tipo: 'CONSULTA' },
    { codigo: 'GES.KPI.EXPORTAR', nome: 'Exportar KPIs', tipo: 'EXPORTACAO' }
  ]
}
```

### 9.2 Internacionaliza√ß√£o (i18n)

**Idiomas Suportados**: pt-BR (padr√£o), en-US, es-ES

**Chaves Principais**:
- `kpis.title` - "Gest√£o de KPIs"
- `kpis.form.codigo` - "C√≥digo"
- `kpis.form.nome` - "Nome"
- `kpis.categorias.FINANCEIRO` - "Financeiro"
- `kpis.messages.createSuccess` - "KPI criado com sucesso"
- `kpis.validations.codigoRequired` - "C√≥digo √© obrigat√≥rio"

### 9.3 Auditoria

**Opera√ß√µes Auditadas:**
- `KPI_CREATED` - Captura todos os campos
- `KPI_UPDATED` - Captura before/after de campos alterados
- `KPI_DELETED` - Captura Id, Codigo, Nome
- `KPI_CALCULATED` - Captura KPIId, Valor, FonteDados
- `KPI_META_DEFINED` - Captura KPIId, TipoMeta, Valor
- `KPI_ALERT_SENT` - Captura KPIId, Destinatarios, Canal
- `KPI_FORMULA_CHANGED` - Captura FormulaAntiga, FormulaNova
- `KPI_DASHBOARD_ACCESSED` - Captura DashboardId, Usuario
- `KPI_EXPORTED` - Captura Formato, Filtros
- `KPI_SHARED` - Captura DashboardId, Token, Expiracao

**Reten√ß√£o**: 7 anos (conformidade LGPD)

### 9.4 Controle de Acesso (RBAC)

**Matriz de Permiss√µes:**

| Perfil | Listar | Criar | Editar | Excluir | Calcular | Dashboard | Metas | Alertas | Hist√≥rico | Exportar |
|--------|--------|-------|--------|---------|----------|-----------|-------|---------|-----------|----------|
| **Super Admin** | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| **Administrador** | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| **Gestor** | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| **Analista** | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ |
| **Operador** | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| **Consulta** | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |

**Permission Codes:**
```typescript
GES.KPI.LISTAR
GES.KPI.CRIAR
GES.KPI.EDITAR
GES.KPI.EXCLUIR
GES.KPI.CALCULAR
GES.KPI.DASHBOARD
GES.KPI.META.DEFINIR
GES.KPI.ALERTA.CONFIGURAR
GES.KPI.HISTORICO
GES.KPI.EXPORTAR

// Permiss√µes por categoria
GES.KPI.VIEW.FINANCEIRO
GES.KPI.VIEW.OPERACIONAL
GES.KPI.VIEW.QUALIDADE
GES.KPI.VIEW.COMERCIAL
GES.KPI.VIEW.SERVICO
```

---

## 10. ENDPOINTS DA API

| M√©todo | Endpoint | Descri√ß√£o |
|--------|----------|-----------|
| GET | `/api/kpis` | Listar KPIs |
| GET | `/api/kpis/{id}` | Obter KPI por ID |
| POST | `/api/kpis` | Criar KPI |
| PUT | `/api/kpis/{id}` | Atualizar KPI |
| DELETE | `/api/kpis/{id}` | Excluir KPI (soft delete) |
| POST | `/api/kpis/calcular` | Recalcular todos os KPIs |
| GET | `/api/kpis/{id}/valor-atual` | Valor atual do KPI |
| GET | `/api/kpis/{id}/historico` | Hist√≥rico de valores |
| GET | `/api/kpis/{id}/detalhamento` | Drill-down para transa√ß√µes |
| POST | `/api/kpis/{id}/metas` | Definir meta |
| POST | `/api/kpis/{id}/alertas` | Configurar alerta |
| GET | `/api/kpis/dashboards/{id}` | Obter dashboard |
| POST | `/api/kpis/dashboards/{id}/share` | Compartilhar dashboard |
| GET | `/api/kpis/export` | Exportar KPIs |

---

## 11. MODELO DE DADOS (REFER√äNCIA)

**Entidades Principais:**
- `KPI` - Configura√ß√£o do indicador
- `KPIMeta` - Metas (m√≠nima, ideal, desafiadora)
- `KPIHistorico` - Valores hist√≥ricos
- `KPIDashboard` - Pain√©is customizados
- `KPIAlerta` - Configura√ß√£o de alertas
- `KPIFormulaVersao` - Versionamento de f√≥rmulas

**Detalhamento**: Ver `MD-RF044.md`

---

## 12. SEGURAN√áA

- ‚úÖ Valida√ß√£o de entrada obrigat√≥ria (FluentValidation)
- ‚úÖ Prote√ß√£o contra SQL injection (parametriza√ß√£o)
- ‚úÖ Controle de permiss√µes RBAC
- ‚úÖ Isolamento multi-tenant (EmpresaId/ConglomeradoId)
- ‚úÖ Token JWT para dashboards p√∫blicos
- ‚úÖ Rate limiting em APIs externas
- ‚úÖ Timeout em queries complexas (30s)

---

## 13. M√âTRICAS E INDICADORES

| M√©trica | Meta | Medi√ß√£o |
|---------|------|---------|
| Tempo de c√°lculo de KPI | < 5s | 95th percentile |
| Uptime do motor de c√°lculo | > 99.9% | Mensal |
| Precis√£o de forecasting | > 80% | MAPE (Mean Absolute Percentage Error) |
| Lat√™ncia de alertas | < 1min | M√©dia |
| Taxa de falsos positivos em alertas | < 5% | Mensal |

---

## 14. ARTEFATOS DERIVADOS

Este RF √© base para:

- **UC-RF044.md** - Casos de Uso (UC00-UC04 obrigat√≥rios)
- **MD-RF044.md** - Modelo de Dados (DDL completo)
- **TC-RF044.yaml** - Casos de Teste (Backend, Frontend, Sistema)
- **MT-RF044.yaml** - Massas de Teste

---

## 15. RASTREABILIDADE

| Artefato | Status | Localiza√ß√£o |
|--------|-------|-------------|
| Casos de Uso | ‚è≥ Pendente | `Casos de Uso/` |
| Modelo de Dados | ‚è≥ Pendente | `MD-RF044.md` |
| Casos de Teste | ‚è≥ Pendente | `Testes/` |
| Massas de Teste | ‚è≥ Pendente | `Testes/Massa/` |

---

## CHANGELOG

| Vers√£o | Data | Descri√ß√£o | Autor |
|------|------|----------|------|
| 2.0 | 2025-12-30 | Migra√ß√£o v1.0 ‚Üí v2.0 (separa√ß√£o RF/RL completa) | Ag√™ncia ALC - alc.dev.br |
| 1.0 | 2025-01-14 | Vers√£o inicial com conte√∫do legado misturado | Equipe IControlIT |
