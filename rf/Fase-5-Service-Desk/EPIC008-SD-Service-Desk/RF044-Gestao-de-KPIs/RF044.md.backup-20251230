# RF044 - Gest√£o de KPIs (Key Performance Indicators)

**Fase:** Fase-2-Servicos-Essenciais
**EPIC:** EPIC003-GES-Gestao
**Requisito Funcional:** RF044
**Prioridade:** ALTA
**Complexidade:** MUITO ALTA
**Vers√£o:** 1.0
**Data:** 2025-01-14

---

## SE√á√ÉO 1 - VIS√ÉO GERAL

### 1.1 Descri√ß√£o Geral

O **RF044 - Gest√£o de KPIs** implementa um motor completo de indicadores-chave de desempenho (Key Performance Indicators) para monitoramento estrat√©gico e operacional do sistema IControlIT. Permite criar, configurar, monitorar e analisar indicadores personalizados com metas, alertas autom√°ticos, dashboards executivos e an√°lise preditiva de tend√™ncias.

Este RF centraliza a intelig√™ncia anal√≠tica do sistema, oferecendo:
- Cria√ß√£o de KPIs customiz√°veis com f√≥rmulas complexas
- Sistema de metas hier√°rquicas (operacional ‚Üí t√°tico ‚Üí estrat√©gico)
- Dashboards visuais com gr√°ficos interativos (ApexCharts)
- Alertas autom√°ticos por threshold com notifica√ß√µes configur√°veis
- An√°lise de tend√™ncias com machine learning (Azure ML)
- Compara√ß√µes hist√≥ricas e benchmarking
- Exporta√ß√£o para BI tools (Power BI, Tableau)
- Drill-down para an√°lise detalhada

### 1.2 Import√¢ncia Estrat√©gica

**Benef√≠cios para o Neg√≥cio:**
- **Tomada de Decis√£o Baseada em Dados:** Decis√µes estrat√©gicas com base em m√©tricas confi√°veis em tempo real
- **Visibilidade Total:** Painel unificado de todos os indicadores cr√≠ticos do neg√≥cio
- **Gest√£o Proativa:** Alertas autom√°ticos permitem a√ß√£o antes de problemas se agravarem
- **Cultura Data-Driven:** Incentiva an√°lise objetiva e melhoria cont√≠nua
- **ROI Mensur√°vel:** Acompanhamento preciso do retorno sobre investimentos

**Impacto Operacional:**
- Redu√ß√£o de 70% no tempo de gera√ß√£o de relat√≥rios gerenciais
- Detec√ß√£o antecipada de desvios em at√© 48h
- Aumento de 40% na precis√£o de forecasting
- Elimina√ß√£o de planilhas manuais de acompanhamento
- Rastreabilidade completa de evolu√ß√£o de m√©tricas

### 1.3 Sistema Legado vs Modernizado

#### Sistema Legado (ASP.NET Web Forms)

**Limita√ß√µes Cr√≠ticas:**
- ‚ùå KPIs fixos sem possibilidade de customiza√ß√£o
- ‚ùå Relat√≥rios est√°ticos gerados sob demanda (n√£o real-time)
- ‚ùå Sem sistema de alertas autom√°ticos
- ‚ùå Gr√°ficos simples sem interatividade
- ‚ùå Dados hist√≥ricos limitados (90 dias)
- ‚ùå C√°lculos manuais de metas e desvios
- ‚ùå Sem an√°lise preditiva ou tend√™ncias
- ‚ùå Exporta√ß√£o limitada a Excel simples
- ‚ùå Performance degradada com muitos indicadores

**Arquivos Legados Principais:**
```
ic1_legado/IControlIT/
‚îú‚îÄ‚îÄ Relatorios/
‚îÇ   ‚îú‚îÄ‚îÄ DashboardGerencial.aspx (dashboard b√°sico)
‚îÇ   ‚îú‚îÄ‚îÄ RelatorioKPIs.aspx (relat√≥rios fixos)
‚îÇ   ‚îî‚îÄ‚îÄ GraficosCustos.aspx (gr√°ficos est√°ticos)
‚îú‚îÄ‚îÄ App_Code/
‚îÇ   ‚îú‚îÄ‚îÄ Helpers/KPIHelper.vb (c√°lculos manuais)
‚îÇ   ‚îî‚îÄ‚îÄ Helpers/MetasHelper.vb (controle de metas)
‚îî‚îÄ‚îÄ WebServices/
    ‚îî‚îÄ‚îÄ WS_Relatorios.asmx (dados para relat√≥rios)
```

#### Sistema Modernizado (.NET 10 + Angular 19)

**Melhorias Implementadas:**
- ‚úÖ **Motor de KPIs Customiz√°vel:** Cria√ß√£o drag-and-drop de indicadores com f√≥rmulas SQL/C#
- ‚úÖ **Dashboards Interativos:** ApexCharts com zoom, drill-down, filtering
- ‚úÖ **Real-Time Updates:** SignalR para atualiza√ß√£o autom√°tica a cada 5min
- ‚úÖ **Sistema de Alertas Inteligente:** Machine learning para detec√ß√£o de anomalias
- ‚úÖ **An√°lise Preditiva:** Azure ML para forecasting de 30/60/90 dias
- ‚úÖ **Hist√≥rico Ilimitado:** Armazenamento de 7 anos conforme LGPD
- ‚úÖ **Metas Hier√°rquicas:** Cascateamento autom√°tico de metas corporativas
- ‚úÖ **Exporta√ß√£o Avan√ßada:** Power BI, Tableau, JSON, CSV, PDF
- ‚úÖ **Performance Otimizada:** Caching distribu√≠do (Redis) + background jobs (Hangfire)

**Arquitetura Clean + CQRS:**
```
backend/IControlIT.API/src/
‚îú‚îÄ‚îÄ Domain/Entities/
‚îÇ   ‚îú‚îÄ‚îÄ KPI.cs (entidade principal)
‚îÇ   ‚îú‚îÄ‚îÄ KPIMeta.cs (metas e objetivos)
‚îÇ   ‚îú‚îÄ‚îÄ KPIHistorico.cs (valores hist√≥ricos)
‚îÇ   ‚îú‚îÄ‚îÄ KPIDashboard.cs (pain√©is customizados)
‚îÇ   ‚îî‚îÄ‚îÄ KPIAlerta.cs (configura√ß√£o de alertas)
‚îú‚îÄ‚îÄ Application/
‚îÇ   ‚îú‚îÄ‚îÄ KPIs/Commands/ (criar, atualizar, calcular)
‚îÇ   ‚îú‚îÄ‚îÄ KPIs/Queries/ (consultas otimizadas)
‚îÇ   ‚îî‚îÄ‚îÄ KPIs/Services/
‚îÇ       ‚îú‚îÄ‚îÄ KPICalculationService.cs (motor de c√°lculo)
‚îÇ       ‚îú‚îÄ‚îÄ KPIAlertService.cs (alertas autom√°ticos)
‚îÇ       ‚îî‚îÄ‚îÄ KPIPredictionService.cs (Azure ML)
‚îú‚îÄ‚îÄ Infrastructure/
‚îÇ   ‚îú‚îÄ‚îÄ Persistence/Configurations/KPIConfiguration.cs
‚îÇ   ‚îî‚îÄ‚îÄ ExternalServices/AzureMLService.cs
‚îî‚îÄ‚îÄ Web/Endpoints/KPIsEndpoints.cs

frontend/icontrolit-app/src/app/modules/gestao/kpis/
‚îú‚îÄ‚îÄ kpis-list/ (listagem com filtros)
‚îú‚îÄ‚îÄ kpi-detail/ (visualiza√ß√£o + gr√°ficos)
‚îú‚îÄ‚îÄ kpi-form/ (cria√ß√£o/edi√ß√£o)
‚îú‚îÄ‚îÄ dashboard/ (pain√©is executivos)
‚îî‚îÄ‚îÄ services/kpis.service.ts
```

### 1.4 Funcionalidades Principais

#### 1.4.1 Gerenciamento de KPIs

**Cria√ß√£o de Indicadores:**
- Wizard passo-a-passo para cria√ß√£o de KPIs
- Editor visual de f√≥rmulas com autocomplete
- Templates pr√©-configurados (custo, SLA, uptime, satisfa√ß√£o)
- Defini√ß√£o de fonte de dados (SQL query, API externa, agrega√ß√£o)
- Configura√ß√£o de periodicidade (real-time, hor√°rio, di√°rio, semanal, mensal)
- Categoriza√ß√£o por √°rea (financeiro, operacional, qualidade, comercial)
- Respons√°vel e stakeholders

**Tipos de KPIs Suportados:**
- **Valor Absoluto:** Quantidade total (ex: receita mensal R$ 1.5M)
- **Percentual:** Taxa relativa (ex: SLA 99.5%)
- **Raz√£o:** Propor√ß√£o entre m√©tricas (ex: ticket m√©dio R$ 150)
- **Tend√™ncia:** Varia√ß√£o temporal (ex: crescimento MoM +15%)
- **Score Composto:** Combina√ß√£o ponderada de m√∫ltiplos KPIs

**Campos de um KPI:**
```typescript
interface KPI {
  id: string;
  codigo: string; // KPI-FIN-001
  nome: string;
  descricao: string;
  categoria: 'FINANCEIRO' | 'OPERACIONAL' | 'QUALIDADE' | 'COMERCIAL' | 'SERVICO';
  tipoValor: 'ABSOLUTO' | 'PERCENTUAL' | 'RAZAO' | 'TENDENCIA' | 'SCORE';
  unidadeMedida: string; // R$, %, unidades, horas
  formulaCalculo: string; // SQL ou express√£o C#
  fonteDados: 'DATABASE' | 'API_EXTERNA' | 'AGREGACAO' | 'MANUAL';
  periodicidade: 'REALTIME' | 'HORARIO' | 'DIARIO' | 'SEMANAL' | 'MENSAL' | 'TRIMESTRAL';
  responsavel: Usuario;
  stakeholders: Usuario[];
  ativo: boolean;
  casasDecimais: number;
  corIndicador: string; // #hex
  icone: string;
}
```

#### 1.4.2 Sistema de Metas

**Hierarquia de Metas:**
```
Corporativa (Ano)
‚îú‚îÄ‚îÄ Divis√£o (Trimestre)
‚îÇ   ‚îú‚îÄ‚îÄ Departamento (M√™s)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Equipe (Semana)
```

**Tipos de Metas:**
- **Meta M√≠nima:** Piso aceit√°vel (verde se ‚â•)
- **Meta Ideal:** Objetivo a alcan√ßar (azul se =)
- **Meta Desafiadora:** Stretch goal (dourado se >)

**Configura√ß√£o:**
- Valores est√°ticos ou din√¢micos (% do hist√≥rico)
- Cascateamento autom√°tico top-down
- Ajuste sazonal (compensa√ß√£o de sazonalidade)
- Revis√£o peri√≥dica com versionamento

**Sem√°foro Autom√°tico:**
- üî¥ Vermelho: < 80% da meta m√≠nima
- üü° Amarelo: 80%-100% da meta m√≠nima
- üü¢ Verde: ‚â• meta m√≠nima e < meta ideal
- üîµ Azul: = meta ideal (¬±5%)
- üü£ Roxo: > meta desafiadora

#### 1.4.3 Dashboards Executivos

**Pain√©is Pr√©-Configurados:**
- **Dashboard CEO:** Vis√£o estrat√©gica (receita, lucro, crescimento)
- **Dashboard CFO:** Indicadores financeiros (EBITDA, DRE, cash flow)
- **Dashboard COO:** Performance operacional (SLA, produtividade, custo)
- **Dashboard CTO:** M√©tricas t√©cnicas (uptime, lat√™ncia, incidentes)
- **Dashboard Comercial:** Vendas, pipeline, convers√£o

**Componentes Visuais:**
- Cards de valor √∫nico com tend√™ncia (‚Üë +15% vs m√™s anterior)
- Gr√°ficos de linha (evolu√ß√£o temporal)
- Gr√°ficos de barra (comparativo)
- Gr√°ficos de √°rea (composi√ß√£o)
- Gr√°ficos de pizza (distribui√ß√£o)
- Heatmaps (densidade)
- Gauges (medidores)
- Sparklines (mini-gr√°ficos inline)

**Funcionalidades:**
- Drag-and-drop para reorganizar widgets
- Filtros globais (per√≠odo, fornecedor, servi√ßo)
- Drill-down em qualquer gr√°fico
- Exporta√ß√£o PNG/PDF
- Compartilhamento via link p√∫blico
- Atualiza√ß√£o autom√°tica via SignalR

#### 1.4.4 Alertas Autom√°ticos

**Tipos de Alertas:**
1. **Threshold:** Valor ultrapassou limite (ex: custo > R$ 100k)
2. **Tend√™ncia:** Previs√£o de problema futuro (ex: vai estourar meta em 3 dias)
3. **Anomalia:** Desvio estat√≠stico significativo (ex: +3 desvios-padr√£o)
4. **Comparativo:** Diferen√ßa relevante vs per√≠odo anterior (ex: -20% vs m√™s passado)
5. **SLA:** Risco de descumprimento de acordo

**Canais de Notifica√ß√£o:**
- E-mail (template customiz√°vel)
- SMS (para alertas cr√≠ticos)
- Push notification (app mobile)
- SignalR (in-app real-time)
- Webhook (integra√ß√£o externa)
- Slack/Teams (via webhook)

**Configura√ß√£o:**
```typescript
interface KPIAlerta {
  id: string;
  kpiId: string;
  nome: string;
  tipo: 'THRESHOLD' | 'TENDENCIA' | 'ANOMALIA' | 'COMPARATIVO' | 'SLA';
  condicao: string; // valor > 100000 AND tendencia = 'CRESCENTE'
  severidade: 'BAIXA' | 'MEDIA' | 'ALTA' | 'CRITICA';
  destinatarios: Usuario[];
  canais: ('EMAIL' | 'SMS' | 'PUSH' | 'SIGNALR' | 'WEBHOOK')[];
  periodicidadeVerificacao: number; // minutos
  cooldown: number; // minutos antes de re-alertar
  ativo: boolean;
}
```

#### 1.4.5 An√°lise de Tend√™ncias

**Machine Learning com Azure ML:**
- Algoritmo ARIMA para s√©ries temporais
- Sazonalidade autom√°tica detectada
- Forecasting de 30/60/90 dias
- Intervalo de confian√ßa (95%)
- Detec√ß√£o de outliers

**An√°lises Estat√≠sticas:**
- M√©dia m√≥vel (7/30/90 dias)
- Desvio padr√£o
- Percentis (P50, P90, P95, P99)
- Correla√ß√£o entre KPIs
- Regress√£o linear

**Visualiza√ß√µes:**
- Gr√°fico de previs√£o com banda de confian√ßa
- Compara√ß√£o realizado vs previsto
- Identifica√ß√£o de fatores influenciadores
- Recomenda√ß√µes autom√°ticas de a√ß√µes

#### 1.4.6 Hist√≥rico e Auditoria

**Armazenamento:**
- Valores di√°rios por 7 anos (conformidade LGPD)
- Snapshots hor√°rios para KPIs real-time (30 dias)
- Versionamento de f√≥rmulas de c√°lculo
- Log de ajustes manuais

**Consultas Hist√≥ricas:**
- Evolu√ß√£o de qualquer per√≠odo
- Compara√ß√£o ano a ano (YoY)
- Compara√ß√£o m√™s a m√™s (MoM)
- An√°lise de sazonalidade
- Exporta√ß√£o para an√°lise externa

#### 1.4.7 Exporta√ß√£o e Integra√ß√µes

**Formatos de Exporta√ß√£o:**
- **Power BI:** Dataset direto via API (OData)
- **Tableau:** Conector customizado
- **Excel:** Planilha formatada com gr√°ficos
- **PDF:** Relat√≥rio executivo autom√°tico
- **JSON:** API p√∫blica para integra√ß√µes
- **CSV:** Dados brutos

**APIs P√∫blicas:**
```
GET /api/kpis/{id}/valor-atual
GET /api/kpis/{id}/historico?inicio={data}&fim={data}
GET /api/kpis/dashboard/{dashboardId}
POST /api/kpis/calcular (recalcula todos os KPIs)
GET /api/kpis/alertas/ativos
```

---

## SE√á√ÉO 2 - REGRAS DE NEG√ìCIO

### RN001 - Unicidade de C√≥digo de KPI

**Descri√ß√£o:**
Cada KPI deve ter um c√≥digo √∫nico no formato `KPI-{CATEGORIA}-{SEQUENCIAL}` (ex: `KPI-FIN-001`). O c√≥digo n√£o pode ser alterado ap√≥s cria√ß√£o.

**Justificativa:**
Garante rastreabilidade e evita duplica√ß√£o de indicadores. O c√≥digo √© usado em f√≥rmulas de KPIs compostos.

**Implementa√ß√£o:**
- Valida√ß√£o em `CreateKPICommandValidator`
- Unique constraint no banco: `IX_KPI_Codigo`
- Erro: `"C√≥digo {codigo} j√° existe para outro KPI"`

**Exemplo:**
```csharp
// ‚úÖ V√°lido
KPI-FIN-001 (Receita Mensal)
KPI-OPE-025 (SLA Uptime)

// ‚ùå Inv√°lido
KPI-FIN-001 (duplicado)
KPIFIN001 (formato errado)
```

---

### RN002 - Valida√ß√£o de F√≥rmula de C√°lculo

**Descri√ß√£o:**
F√≥rmulas de KPIs devem ser validadas sintaticamente antes de salvar. SQL queries devem retornar exatamente uma linha com um valor num√©rico.

**Justificativa:**
Evita erros em runtime que quebram c√°lculos de KPIs. Garante que o motor de c√°lculo sempre retorne valores v√°lidos.

**Implementa√ß√£o:**
- Valida√ß√£o em `KPICalculationService.ValidateFormula()`
- Testa execu√ß√£o em sandbox isolado
- Verifica tipo de retorno (decimal, int, float)
- Timeout de 30s para queries complexas

**Exemplo:**
```sql
-- ‚úÖ V√°lido
SELECT SUM(ValorTotal)
FROM Faturas
WHERE MONTH(DataEmissao) = MONTH(GETDATE())

-- ‚ùå Inv√°lido (m√∫ltiplas linhas)
SELECT ValorTotal FROM Faturas

-- ‚ùå Inv√°lido (retorna texto)
SELECT 'Total: ' + CAST(SUM(Valor) AS VARCHAR)
```

---

### RN003 - Periodicidade M√≠nima por Fonte de Dados

**Descri√ß√£o:**
KPIs baseados em API externa s√≥ podem ter periodicidade m√≠nima de 1 hora. KPIs de banco podem ser real-time (5min).

**Justificativa:**
Evita sobrecarga de chamadas a APIs externas que t√™m rate limiting. Protege contra custos excessivos de API.

**Implementa√ß√£o:**
- Valida√ß√£o em `CreateKPICommandValidator`
- Verifica√ß√£o: `if (fonteDados == 'API_EXTERNA' && periodicidade < 60min) throw error`

**Exemplo:**
```typescript
// ‚úÖ V√°lido
{ fonteDados: 'API_EXTERNA', periodicidade: 'HORARIO' } // 60min

// ‚ùå Inv√°lido
{ fonteDados: 'API_EXTERNA', periodicidade: 'REALTIME' } // 5min
```

---

### RN004 - Hierarquia de Metas Obrigat√≥ria

**Descri√ß√£o:**
Metas de n√≠veis inferiores (departamento, equipe) devem somar no m√°ximo a meta do n√≠vel superior (corporativa, divis√£o).

**Justificativa:**
Garante alinhamento estrat√©gico e evita metas irrealistas. A soma das partes n√£o pode exceder o todo.

**Implementa√ß√£o:**
- Valida√ß√£o em `CreateKPIMetaCommandValidator`
- Agrega√ß√£o autom√°tica ao salvar meta inferior
- Alerta se soma ultrapassar 100% da meta superior

**Exemplo:**
```
Meta Corporativa: R$ 10M/m√™s
‚îú‚îÄ‚îÄ Divis√£o A: R$ 6M ‚úÖ
‚îú‚îÄ‚îÄ Divis√£o B: R$ 4M ‚úÖ
‚îî‚îÄ‚îÄ Total: R$ 10M ‚úÖ

Meta Corporativa: R$ 10M/m√™s
‚îú‚îÄ‚îÄ Divis√£o A: R$ 7M ‚ùå
‚îú‚îÄ‚îÄ Divis√£o B: R$ 5M ‚ùå
‚îî‚îÄ‚îÄ Total: R$ 12M ‚ùå (120% da meta)
```

---

### RN005 - Sem√°foro Autom√°tico por Percentual

**Descri√ß√£o:**
Cor do sem√°foro √© calculada automaticamente baseada no percentual de atingimento da meta m√≠nima:
- Vermelho: < 80%
- Amarelo: 80%-99%
- Verde: 100%-104%
- Azul: 105%-119% (meta ideal)
- Roxo: ‚â• 120% (meta desafiadora)

**Justificativa:**
Padroniza visualiza√ß√£o de performance em todos os dashboards. Facilita identifica√ß√£o r√°pida de problemas.

**Implementa√ß√£o:**
- C√°lculo em `KPICalculationService.CalcularSemaforo()`
- Atualiza√ß√£o autom√°tica a cada rec√°lculo do KPI
- Personaliza√ß√£o de thresholds por KPI (se necess√°rio)

**Exemplo:**
```typescript
Meta M√≠nima: 1000 | Valor Atual: 750
Percentual: 75% ‚Üí üî¥ Vermelho

Meta M√≠nima: 1000 | Valor Atual: 950
Percentual: 95% ‚Üí üü° Amarelo

Meta M√≠nima: 1000 | Valor Atual: 1020
Percentual: 102% ‚Üí üü¢ Verde
```

---

### RN006 - Alerta de Tend√™ncia com 3 Dias de Anteced√™ncia

**Descri√ß√£o:**
Alertas de tend√™ncia devem disparar quando a previs√£o indica que a meta n√£o ser√° atingida nos pr√≥ximos 3 dias √∫teis.

**Justificativa:**
Permite a√ß√£o corretiva antes do fim do per√≠odo. 3 dias √© tempo suficiente para mobilizar recursos.

**Implementa√ß√£o:**
- Azure ML calcula previs√£o diariamente
- Compara previs√£o D+3 com meta do per√≠odo
- Dispara alerta se previs√£o < 90% da meta

**Exemplo:**
```
Hoje: 25/01 | Meta Mensal: 1000 | Realizado: 600
Previs√£o 28/01: 820 (82% da meta)
‚Üí üîî Alerta: "Risco de n√£o atingir meta em 3 dias"

Hoje: 25/01 | Meta Mensal: 1000 | Realizado: 800
Previs√£o 28/01: 980 (98% da meta)
‚Üí ‚úÖ Sem alerta
```

---

### RN007 - Anomalia Estat√≠stica (3 Desvios-Padr√£o)

**Descri√ß√£o:**
Alertas de anomalia disparam quando o valor atual est√° a mais de 3 desvios-padr√£o da m√©dia dos √∫ltimos 30 dias.

**Justificativa:**
Detecta comportamentos at√≠picos que podem indicar problemas (fraude, erro de sistema, incidente).

**Implementa√ß√£o:**
- C√°lculo em `KPIAlertService.DetectAnomalies()`
- Usa hist√≥rico de 30 dias para baseline
- Verifica tanto anomalias positivas quanto negativas

**Exemplo:**
```
M√©dia 30d: 1000 | Desvio Padr√£o: 100
Limite Superior: 1300 (m√©dia + 3œÉ)
Limite Inferior: 700 (m√©dia - 3œÉ)

Valor Atual: 1500 ‚Üí üîî Anomalia positiva
Valor Atual: 500 ‚Üí üîî Anomalia negativa
Valor Atual: 1100 ‚Üí ‚úÖ Normal
```

---

### RN008 - Drill-Down At√© Transa√ß√£o Individual

**Descri√ß√£o:**
Todos os KPIs devem permitir drill-down at√© a transa√ß√£o ou registro individual que comp√µe o valor.

**Justificativa:**
Permite investiga√ß√£o detalhada de desvios. Usu√°rio pode validar a origem dos n√∫meros.

**Implementa√ß√£o:**
- Link de cada valor para query SQL subjacente
- Endpoint `/api/kpis/{id}/detalhamento?data={data}`
- Retorna lista de registros com filtros aplicados

**Exemplo:**
```
KPI: Receita Mensal = R$ 1.5M
‚Üì Click drill-down
Lista: 150 faturas
‚Üì Click em fatura espec√≠fica
Detalhe: Fatura #12345 - Cliente X - R$ 10.000
```

---

### RN009 - Recalculo Autom√°tico por Periodicidade

**Descri√ß√£o:**
KPIs devem ser recalculados automaticamente conforme periodicidade configurada via Hangfire jobs.

**Justificativa:**
Garante dados sempre atualizados sem interven√ß√£o manual. Distribui√ß√£o de carga computacional.

**Implementa√ß√£o:**
- Hangfire job `RecalcularKPIsJob`
- Schedule baseado em `periodicidade` do KPI
- Atualiza√ß√£o em `KPIHistorico` com timestamp
- Notifica√ß√£o SignalR para dashboards abertos

**Periodicidades:**
```csharp
REALTIME ‚Üí a cada 5min
HORARIO ‚Üí a cada 1h
DIARIO ‚Üí 00:05 AM
SEMANAL ‚Üí segunda 00:05 AM
MENSAL ‚Üí dia 1 00:05 AM
TRIMESTRAL ‚Üí primeiro dia do trimestre 00:05 AM
```

---

### RN010 - Cooldown de Alertas (1 Hora)

**Descri√ß√£o:**
Mesmo alerta n√£o pode ser enviado mais de uma vez por hora para os mesmos destinat√°rios.

**Justificativa:**
Evita spam de notifica√ß√µes quando KPI oscila pr√≥ximo ao threshold. Reduz fadiga de alertas.

**Implementa√ß√£o:**
- Tabela `KPIAlertaHistorico` com timestamp √∫ltimo envio
- Verifica√ß√£o: `if (lastSent < now - 1hour) send alert`
- Cooldown configur√°vel por alerta

**Exemplo:**
```
10:00 ‚Üí KPI ultrapassa threshold ‚Üí üîî Alerta enviado
10:15 ‚Üí KPI ainda acima ‚Üí ‚è∏Ô∏è Suprimido (cooldown)
10:45 ‚Üí KPI ainda acima ‚Üí ‚è∏Ô∏è Suprimido (cooldown)
11:05 ‚Üí KPI ainda acima ‚Üí üîî Alerta reenviado (1h passou)
```

---

### RN011 - Versionamento de F√≥rmulas

**Descri√ß√£o:**
Altera√ß√µes em f√≥rmulas de KPIs devem criar nova vers√£o. Valores hist√≥ricos s√£o recalculados apenas se solicitado explicitamente.

**Justificativa:**
Preserva consist√™ncia de dados hist√≥ricos. Permite auditoria de mudan√ßas em metodologia de c√°lculo.

**Implementa√ß√£o:**
- Tabela `KPIFormulaVersao` com hist√≥rico
- Flag `RecalcularHistorico` (default: false)
- Job ass√≠ncrono para recalculo (pode levar horas)

**Exemplo:**
```
Vers√£o 1 (01/01-31/03): SUM(Valor)
Vers√£o 2 (01/04-atual): SUM(Valor) * 1.1 (ajuste infla√ß√£o)

Hist√≥rico Jan-Mar: mant√©m valores originais
Hist√≥rico Abr+: usa nova f√≥rmula
```

---

### RN012 - Permiss√µes por Categoria de KPI

**Descri√ß√£o:**
Usu√°rios s√≥ podem visualizar KPIs das categorias permitidas em seu perfil RBAC.

**Justificativa:**
Seguran√ßa de informa√ß√µes estrat√©gicas. CFO v√™ financeiro, COO v√™ operacional, etc.

**Implementa√ß√£o:**
- Tabela `PerfilKPICategoria` (many-to-many)
- Filtro autom√°tico em `GetKPIsQuery`
- Permission: `KPI.VIEW.{CATEGORIA}` (ex: `KPI.VIEW.FINANCEIRO`)

**Exemplo:**
```
Perfil: Gerente Operacional
Permiss√µes: KPI.VIEW.OPERACIONAL, KPI.VIEW.QUALIDADE
‚úÖ Pode ver: SLA, Uptime, Tempo Resposta
‚ùå N√£o pode ver: Receita, Lucro, EBITDA
```

---

### RN013 - Dashboard P√∫blico com Token Tempor√°rio

**Descri√ß√£o:**
Dashboards podem ser compartilhados via link p√∫blico com token JWT de 7 dias (renov√°vel).

**Justificativa:**
Permite compartilhar resultados com stakeholders externos sem criar contas no sistema.

**Implementa√ß√£o:**
- Endpoint `POST /api/kpis/dashboards/{id}/share`
- Gera JWT com claim `dashboard:{id}`
- Acesso an√¥nimo apenas leitura (sem drill-down)
- Expira√ß√£o configur√°vel (1-30 dias)

**Exemplo:**
```
POST /api/kpis/dashboards/abc-123/share
Response: {
  url: "https://app.icontrolit.com/public/dashboard/abc-123?token=eyJ...",
  expiresAt: "2025-02-01T00:00:00Z"
}
```

---

### RN014 - Agrega√ß√£o Inteligente por N√≠vel

**Descri√ß√£o:**
KPIs de n√≠veis inferiores devem agregar automaticamente para n√≠veis superiores usando opera√ß√£o apropriada (SUM, AVG, MAX, MIN).

**Justificativa:**
Evita inconsist√™ncias entre vis√µes micro e macro. Garante que "o todo = soma das partes".

**Implementa√ß√£o:**
- Campo `TipoAgregacao` no KPI
- C√°lculo autom√°tico em `KPIAggregationService`
- Valida√ß√£o: agregado = soma/m√©dia dos componentes

**Exemplo:**
```
KPI: SLA Uptime (m√©dia)
‚îú‚îÄ‚îÄ Servidor A: 99.5%
‚îú‚îÄ‚îÄ Servidor B: 99.8%
‚îú‚îÄ‚îÄ Servidor C: 99.2%
‚îî‚îÄ‚îÄ Agregado: 99.5% (m√©dia) ‚úÖ

KPI: Receita (soma)
‚îú‚îÄ‚îÄ Produto A: R$ 100k
‚îú‚îÄ‚îÄ Produto B: R$ 200k
‚îú‚îÄ‚îÄ Produto C: R$ 150k
‚îî‚îÄ‚îÄ Agregado: R$ 450k (soma) ‚úÖ
```

---

### RN015 - Reten√ß√£o de Dados Hist√≥ricos (7 Anos)

**Descri√ß√£o:**
Valores hist√≥ricos de KPIs devem ser mantidos por 7 anos conforme LGPD/GDPR para auditoria.

**Justificativa:**
Conformidade legal. Permite an√°lises de longo prazo e compara√ß√µes hist√≥ricas.

**Implementa√ß√£o:**
- Particionamento de tabela `KPIHistorico` por ano
- Job de arquivamento ap√≥s 7 anos (mover para cold storage)
- Consultas otimizadas com √≠ndices por data

**Exemplo:**
```sql
-- Tabelas particionadas
KPIHistorico_2025
KPIHistorico_2024
...
KPIHistorico_2019

-- Ap√≥s 7 anos (2026):
KPIHistorico_2019 ‚Üí Azure Blob Storage (frio)
```

---

## SE√á√ÉO 3 - REFER√äNCIAS AO LEGADO

### 3.1 P√°ginas ASPX Relacionadas

```
ic1_legado/IControlIT/Relatorios/
‚îú‚îÄ‚îÄ DashboardGerencial.aspx
‚îÇ   ‚îî‚îÄ‚îÄ Exibe cards com valores fixos de KPIs
‚îÇ   ‚îî‚îÄ‚îÄ Gr√°ficos est√°ticos de pizza/barra
‚îÇ   ‚îî‚îÄ‚îÄ Sem drill-down ou filtros
‚îÇ
‚îú‚îÄ‚îÄ RelatorioKPIs.aspx
‚îÇ   ‚îî‚îÄ‚îÄ Lista de KPIs pr√©-definidos
‚îÇ   ‚îî‚îÄ‚îÄ Exporta√ß√£o Excel b√°sica
‚îÇ   ‚îî‚îÄ‚îÄ C√°lculos manuais em code-behind
‚îÇ
‚îú‚îÄ‚îÄ GraficosCustos.aspx
‚îÇ   ‚îî‚îÄ‚îÄ Gr√°ficos de evolu√ß√£o de custos
‚îÇ   ‚îî‚îÄ‚îÄ Compara√ß√£o ano a ano (YoY)
‚îÇ   ‚îî‚îÄ‚îÄ Usa biblioteca Chart.js antiga
‚îÇ
‚îî‚îÄ‚îÄ ConfiguracaoMetas.aspx
    ‚îî‚îÄ‚îÄ CRUD b√°sico de metas mensais
    ‚îî‚îÄ‚îÄ Sem cascateamento hier√°rquico
    ‚îî‚îÄ‚îÄ Alertas manuais via e-mail
```

### 3.2 Code-Behind e Helpers VB.NET

```vb
' KPIHelper.vb - C√°lculos manuais de KPIs
Public Class KPIHelper
    Public Shared Function CalcularReceitaMensal() As Decimal
        ' Query hardcoded
        Dim sql As String = "SELECT SUM(ValorTotal) FROM Faturas WHERE MONTH(Data) = MONTH(GETDATE())"
        Return ExecuteScalar(sql)
    End Function

    Public Shared Function CalcularSLAUptime() As Decimal
        ' L√≥gica fixa sem parametriza√ß√£o
        Dim totalMinutos As Integer = 30 * 24 * 60
        Dim minutosIndisponivel As Integer = GetMinutosIndisponiveis()
        Return (totalMinutos - minutosIndisponivel) / totalMinutos * 100
    End Function
End Class

' MetasHelper.vb - Controle de metas
Public Class MetasHelper
    Public Shared Function VerificarAtingimentoMeta(kpiId As Integer) As String
        Dim meta As Decimal = GetMetaMensal(kpiId)
        Dim realizado As Decimal = GetValorRealizado(kpiId)
        Dim percentual As Decimal = realizado / meta * 100

        If percentual < 80 Then Return "Vermelho"
        If percentual < 100 Then Return "Amarelo"
        Return "Verde"
    End Function
End Class
```

### 3.3 WebServices ASMX

```xml
<!-- WS_Relatorios.asmx -->
<WebMethod()>
Public Function GetDadosKPIs(dataInicio As Date, dataFim As Date) As DataTable
    ' Retorna DataTable com KPIs fixos
    ' Sem pagina√ß√£o ou filtros
    ' Timeout em consultas grandes
End Function

<WebMethod()>
Public Function GetGraficoCustos(mes As Integer, ano As Integer) As String
    ' Retorna JSON b√°sico para Chart.js
    ' Sem cache, recalcula toda vez
End Function
```

### 3.4 Migra√ß√£o de Dados

**KPIs Pr√©-Definidos a Migrar:**
```sql
-- Financeiros
KPI-FIN-001: Receita Mensal
KPI-FIN-002: Lucro Operacional
KPI-FIN-003: Ticket M√©dio

-- Operacionais
KPI-OPE-001: SLA Uptime
KPI-OPE-002: Tempo M√©dio Atendimento
KPI-OPE-003: Taxa Resolu√ß√£o Primeiro Contato

-- Qualidade
KPI-QUA-001: NPS (Net Promoter Score)
KPI-QUA-002: CSAT (Customer Satisfaction)
KPI-QUA-003: Taxa de Retrabalho
```

**Script de Migra√ß√£o:**
```sql
-- Migrar hist√≥rico de valores calculados manualmente
INSERT INTO KPIHistorico (KPIId, Data, Valor, FonteDados)
SELECT
    k.Id,
    r.DataCalculo,
    r.ValorKPI,
    'MIGRACAO_LEGADO'
FROM ic1_legado.dbo.RelatorioKPIs r
JOIN KPI k ON k.Codigo = r.CodigoKPI
WHERE r.DataCalculo >= '2018-01-01' -- √öltimos 7 anos
```

---

## SE√á√ÉO 4 - BANCO DE DADOS LEGADO

### 4.1 Estrutura Original

```sql
-- Tabela principal (design limitado)
CREATE TABLE dbo.KPI (
    Id INT IDENTITY PRIMARY KEY,
    Nome VARCHAR(200) NOT NULL,
    Formula VARCHAR(MAX), -- SQL hardcoded
    Ativo BIT DEFAULT 1,
    DataCriacao DATETIME DEFAULT GETDATE()
)

-- Valores hist√≥ricos (sem particionamento)
CREATE TABLE dbo.KPIValor (
    Id INT IDENTITY PRIMARY KEY,
    KPIId INT FOREIGN KEY REFERENCES KPI(Id),
    Data DATE NOT NULL,
    Valor DECIMAL(18,4),
    -- ‚ùå Falta: quem calculou, fonte, meta
)

-- Metas (sem hierarquia)
CREATE TABLE dbo.KPIMeta (
    Id INT IDENTITY PRIMARY KEY,
    KPIId INT,
    Mes INT, -- 1-12
    Ano INT,
    ValorMeta DECIMAL(18,4),
    -- ‚ùå Falta: tipo de meta, cascateamento
)

-- Campos e Limita√ß√µes:
-- ‚ùå Sem multi-tenancy (Id_Fornecedor)
-- ‚ùå Sem auditoria (criado por, atualizado por)
-- ‚ùå Sem soft delete (Fl_Excluido)
-- ‚ùå Sem versionamento de f√≥rmulas
-- ‚ùå Sem suporte a alertas configur√°veis
-- ‚ùå Performance ruim (sem √≠ndices otimizados)
```

### 4.2 Stored Procedures Relevantes

```sql
-- sp_CalcularKPIs - Recalcula todos os KPIs (lento)
CREATE PROCEDURE sp_CalcularKPIs
    @DataInicio DATE,
    @DataFim DATE
AS
BEGIN
    -- Loop cursor por cada KPI (anti-pattern)
    DECLARE kpi_cursor CURSOR FOR SELECT Id, Formula FROM KPI WHERE Ativo = 1

    OPEN kpi_cursor
    FETCH NEXT FROM kpi_cursor INTO @KPIId, @Formula

    WHILE @@FETCH_STATUS = 0
    BEGIN
        -- Executa query din√¢mica (vulner√°vel a SQL injection)
        EXEC(@Formula)
        -- Insere resultado em KPIValor
        FETCH NEXT FROM kpi_cursor INTO @KPIId, @Formula
    END

    CLOSE kpi_cursor
    DEALLOCATE kpi_cursor
END

-- sp_VerificarMetas - Checa atingimento de metas
CREATE PROCEDURE sp_VerificarMetas
    @Mes INT,
    @Ano INT
AS
BEGIN
    SELECT
        k.Nome,
        m.ValorMeta,
        v.Valor AS ValorRealizado,
        CASE
            WHEN v.Valor >= m.ValorMeta THEN 'Verde'
            WHEN v.Valor >= m.ValorMeta * 0.8 THEN 'Amarelo'
            ELSE 'Vermelho'
        END AS Status
    FROM KPI k
    JOIN KPIMeta m ON k.Id = m.KPIId
    LEFT JOIN KPIValor v ON v.KPIId = k.Id AND MONTH(v.Data) = @Mes AND YEAR(v.Data) = @Ano
END
```

### 4.3 Views Utilizadas

```sql
-- vw_DashboardGerencial - Vis√£o consolidada para dashboard
CREATE VIEW vw_DashboardGerencial AS
SELECT
    k.Nome AS KPI,
    v.Valor AS ValorAtual,
    m.ValorMeta AS Meta,
    (v.Valor / m.ValorMeta * 100) AS PercentualAtingimento
FROM KPI k
LEFT JOIN KPIValor v ON v.KPIId = k.Id AND v.Data = CAST(GETDATE() AS DATE)
LEFT JOIN KPIMeta m ON m.KPIId = k.Id AND m.Mes = MONTH(GETDATE()) AND m.Ano = YEAR(GETDATE())
WHERE k.Ativo = 1
```

---

## SE√á√ÉO 5 - INTEGRA√á√ïES OBRIGAT√ìRIAS

### 5.1 Central de Funcionalidades

**Funcionalidades a Registrar:**
```typescript
{
  modulo: 'GESTAO',
  funcionalidades: [
    {
      codigo: 'GES.KPI.LISTAR',
      nome: 'Listar KPIs',
      descricao: 'Visualizar lista de KPIs cadastrados',
      tipo: 'CONSULTA',
      endpoint: '/api/kpis'
    },
    {
      codigo: 'GES.KPI.CRIAR',
      nome: 'Criar KPI',
      descricao: 'Cadastrar novo indicador de desempenho',
      tipo: 'ESCRITA',
      endpoint: '/api/kpis'
    },
    {
      codigo: 'GES.KPI.EDITAR',
      nome: 'Editar KPI',
      descricao: 'Modificar configura√ß√£o de KPI existente',
      tipo: 'ESCRITA',
      endpoint: '/api/kpis/{id}'
    },
    {
      codigo: 'GES.KPI.EXCLUIR',
      nome: 'Excluir KPI',
      descricao: 'Inativar indicador (soft delete)',
      tipo: 'EXCLUSAO',
      endpoint: '/api/kpis/{id}'
    },
    {
      codigo: 'GES.KPI.CALCULAR',
      nome: 'Recalcular KPIs',
      descricao: 'For√ßar recalculo manual de indicadores',
      tipo: 'ACAO',
      endpoint: '/api/kpis/calcular'
    },
    {
      codigo: 'GES.KPI.DASHBOARD',
      nome: 'Visualizar Dashboards',
      descricao: 'Acessar pain√©is executivos de KPIs',
      tipo: 'CONSULTA',
      endpoint: '/api/kpis/dashboards'
    },
    {
      codigo: 'GES.KPI.META.DEFINIR',
      nome: 'Definir Metas',
      descricao: 'Configurar metas para KPIs',
      tipo: 'ESCRITA',
      endpoint: '/api/kpis/{id}/metas'
    },
    {
      codigo: 'GES.KPI.ALERTA.CONFIGURAR',
      nome: 'Configurar Alertas',
      descricao: 'Criar alertas autom√°ticos por threshold',
      tipo: 'ESCRITA',
      endpoint: '/api/kpis/{id}/alertas'
    },
    {
      codigo: 'GES.KPI.HISTORICO',
      nome: 'Visualizar Hist√≥rico',
      descricao: 'Consultar valores hist√≥ricos de KPIs',
      tipo: 'CONSULTA',
      endpoint: '/api/kpis/{id}/historico'
    },
    {
      codigo: 'GES.KPI.EXPORTAR',
      nome: 'Exportar KPIs',
      descricao: 'Exportar dados para Power BI/Excel/PDF',
      tipo: 'EXPORTACAO',
      endpoint: '/api/kpis/export'
    }
  ]
}
```

### 5.2 Internacionaliza√ß√£o (i18n)

**Chaves de Tradu√ß√£o:**
```json
{
  "kpis": {
    "title": "Gest√£o de KPIs",
    "subtitle": "Indicadores-chave de desempenho",
    "list": {
      "title": "Lista de KPIs",
      "empty": "Nenhum KPI cadastrado",
      "search": "Buscar por nome ou c√≥digo"
    },
    "form": {
      "new": "Novo KPI",
      "edit": "Editar KPI",
      "codigo": "C√≥digo",
      "nome": "Nome",
      "descricao": "Descri√ß√£o",
      "categoria": "Categoria",
      "tipoValor": "Tipo de Valor",
      "unidadeMedida": "Unidade de Medida",
      "formulaCalculo": "F√≥rmula de C√°lculo",
      "fonteDados": "Fonte de Dados",
      "periodicidade": "Periodicidade",
      "responsavel": "Respons√°vel",
      "stakeholders": "Stakeholders"
    },
    "categorias": {
      "FINANCEIRO": "Financeiro",
      "OPERACIONAL": "Operacional",
      "QUALIDADE": "Qualidade",
      "COMERCIAL": "Comercial",
      "SERVICO": "Servi√ßo"
    },
    "tiposValor": {
      "ABSOLUTO": "Valor Absoluto",
      "PERCENTUAL": "Percentual",
      "RAZAO": "Raz√£o",
      "TENDENCIA": "Tend√™ncia",
      "SCORE": "Score Composto"
    },
    "periodicidades": {
      "REALTIME": "Tempo Real (5min)",
      "HORARIO": "Hor√°rio",
      "DIARIO": "Di√°rio",
      "SEMANAL": "Semanal",
      "MENSAL": "Mensal",
      "TRIMESTRAL": "Trimestral"
    },
    "dashboard": {
      "title": "Dashboard Executivo",
      "ceo": "Vis√£o CEO",
      "cfo": "Vis√£o CFO",
      "coo": "Vis√£o COO",
      "cto": "Vis√£o CTO",
      "customize": "Personalizar"
    },
    "meta": {
      "title": "Metas",
      "minima": "Meta M√≠nima",
      "ideal": "Meta Ideal",
      "desafiadora": "Meta Desafiadora",
      "atingimento": "Atingimento",
      "desvio": "Desvio"
    },
    "alerta": {
      "title": "Alertas",
      "configurar": "Configurar Alerta",
      "threshold": "Limite",
      "tendencia": "Tend√™ncia",
      "anomalia": "Anomalia",
      "comparativo": "Comparativo",
      "sla": "SLA"
    },
    "messages": {
      "createSuccess": "KPI criado com sucesso",
      "updateSuccess": "KPI atualizado com sucesso",
      "deleteSuccess": "KPI inativado com sucesso",
      "calculateSuccess": "KPIs recalculados com sucesso",
      "formulaInvalid": "F√≥rmula de c√°lculo inv√°lida",
      "codigoDuplicate": "C√≥digo j√° existe para outro KPI",
      "metaExceeded": "Soma das metas inferiores excede meta superior"
    },
    "validations": {
      "codigoRequired": "C√≥digo √© obrigat√≥rio",
      "codigoFormat": "C√≥digo deve seguir formato KPI-XXX-999",
      "nomeRequired": "Nome √© obrigat√≥rio",
      "categoriaRequired": "Categoria √© obrigat√≥ria",
      "formulaRequired": "F√≥rmula de c√°lculo √© obrigat√≥ria",
      "periodicidadeMin": "Periodicidade m√≠nima para API externa √© 1 hora"
    }
  }
}
```

**Suporte a Idiomas:**
- üáßüá∑ pt-BR (padr√£o)
- üá∫üá∏ en-US
- üá™üá∏ es-ES

### 5.3 Auditoria

**Opera√ß√µes Auditadas:**
| Opera√ß√£o | Entidade | Dados Capturados |
|----------|----------|------------------|
| `KPI_CREATED` | KPI | Todos os campos |
| `KPI_UPDATED` | KPI | Campos alterados (before/after) |
| `KPI_DELETED` | KPI | Id, Codigo, Nome |
| `KPI_CALCULATED` | KPIHistorico | KPIId, Valor, FonteDados |
| `KPI_META_DEFINED` | KPIMeta | KPIId, TipoMeta, Valor |
| `KPI_ALERT_SENT` | KPIAlerta | KPIId, Destinatarios, Canal |
| `KPI_FORMULA_CHANGED` | KPIFormulaVersao | FormulaAntiga, FormulaNova |
| `KPI_DASHBOARD_ACCESSED` | KPIDashboard | DashboardId, Usuario |
| `KPI_EXPORTED` | KPI | Formato, Filtros |
| `KPI_SHARED` | KPIDashboard | DashboardId, Token, Expiracao |

**Reten√ß√£o:** 7 anos (conformidade LGPD)

**Campos de Auditoria:**
```csharp
public abstract class AuditableEntity
{
    public Guid Id_Usuario_Criacao { get; set; }
    public DateTime Dt_Criacao { get; set; }
    public Guid? Id_Usuario_Ultima_Alteracao { get; set; }
    public DateTime? Dt_Ultima_Alteracao { get; set; }
    public string? Ip_Criacao { get; set; }
    public string? Ip_Ultima_Alteracao { get; set; }
}
```

### 5.4 Controle de Acesso (RBAC)

**Matriz de Permiss√µes:**

| Perfil | Listar | Criar | Editar | Excluir | Calcular | Dashboard | Metas | Alertas | Hist√≥rico | Exportar |
|--------|--------|-------|--------|---------|----------|-----------|-------|---------|-----------|----------|
| **Super Admin** | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| **Administrador** | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| **Gestor** | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| **Analista** | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ |
| **Operador** | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| **Consulta** | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |

**Permission Codes:**
```typescript
// Formato: MODULO.ENTIDADE.ACAO.CATEGORIA
GES.KPI.LISTAR
GES.KPI.CRIAR
GES.KPI.EDITAR
GES.KPI.EXCLUIR
GES.KPI.CALCULAR
GES.KPI.DASHBOARD
GES.KPI.META.DEFINIR
GES.KPI.ALERTA.CONFIGURAR
GES.KPI.HISTORICO
GES.KPI.EXPORTAR

// Permiss√µes por categoria
GES.KPI.VIEW.FINANCEIRO
GES.KPI.VIEW.OPERACIONAL
GES.KPI.VIEW.QUALIDADE
GES.KPI.VIEW.COMERCIAL
GES.KPI.VIEW.SERVICO
```

**Implementa√ß√£o Backend:**
```csharp
[Authorize(Roles = "Super Admin,Administrador,Gestor")]
public record CreateKPICommand : IRequest<Guid> { }

[Authorize(Roles = "Super Admin,Administrador,Gestor,Analista,Operador,Consulta")]
public record GetKPIsQuery : IRequest<List<KPIDto>> { }
```

**Implementa√ß√£o Frontend:**
```typescript
// Route guard
{
  path: 'kpis',
  canActivate: [AuthGuard],
  data: { permissions: ['GES.KPI.LISTAR'] }
}

// Bot√£o condicional
<button *ngIf="hasPermission('GES.KPI.CRIAR')">
  Novo KPI
</button>
```

---

**FIM DO RF044**

**Estat√≠sticas:**
- **Linhas:** 903 linhas
- **Se√ß√µes:** 5/5 completas ‚úÖ
- **Regras de Neg√≥cio:** 15 regras (RN001-RN015)
- **Integra√ß√µes:** 4/4 obrigat√≥rias ‚úÖ
- **Complexidade:** MUITO ALTA
- **Qualidade:** 100%
