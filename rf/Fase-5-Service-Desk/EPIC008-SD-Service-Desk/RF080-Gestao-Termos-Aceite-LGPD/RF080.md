# RF-080: Gestão de Termos de Aceite e LGPD

**Versão**: 2.0
**Data**: 2025-12-31
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC008-SD-Service-Desk
**Fase**: Fase 5 - Service Desk e Governança

---

## 1. OBJETIVO DO REQUISITO

Implementar módulo completo de **Gestão de Termos de Aceite e LGPD** que permita ao sistema IControlIT atender integralmente às exigências da Lei Geral de Proteção de Dados (LGPD - Lei 13.709/2018), GDPR e ISO 27701 através de:

- Versionamento automático de termos de uso e políticas de privacidade
- Aceite obrigatório no primeiro acesso com bloqueio até consentimento
- Gestão granular de consentimentos por tipo de processamento
- Direitos do titular: revogação, portabilidade e anonimização de dados
- Auditoria completa de todas as ações de consentimento
- Dashboard de conformidade em tempo real

Este documento define **o que o sistema deve fazer**, servindo como **contrato oficial** entre negócio, desenvolvimento e testes.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [ ] Criação de termos de uso, políticas de privacidade, cookies e compartilhamento
- [ ] Versionamento automático com histórico completo e comparação visual (diff)
- [ ] Aceite obrigatório no primeiro acesso com bloqueio até consentimento
- [ ] Re-aceite automático quando termo é atualizado
- [ ] Consentimentos granulares: Marketing, Analytics, Cookies, Compartilhamento
- [ ] Revogação de consentimento a qualquer momento (LGPD Art. 18, IX)
- [ ] Portabilidade de dados em formato estruturado (JSON/CSV/XML)
- [ ] Anonimização irreversível de dados pessoais (LGPD Art. 16)
- [ ] Auditoria completa com IP, User-Agent, geolocalização e timestamp
- [ ] Dashboard de conformidade com métricas em tempo real
- [ ] Notificações multi-canal: e-mail, SMS e in-app (SignalR)
- [ ] Integração com RF079 (Políticas Corporativas)
- [ ] Assinatura digital opcional com certificado A1/A3
- [ ] Multi-idioma: português, inglês e espanhol

### 2.2 Fora do escopo

- Interface específica de usuário (definida em WF-080)
- Tecnologia, framework ou linguagem (implementação livre)
- Layout, cores ou identidade visual
- Estratégia de deploy ou infraestrutura
- Módulo de gestão de incidentes LGPD (será RF separado)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-----|---------|
| **Termo de Uso** | Documento que define regras de utilização do sistema, responsabilidades do usuário e limitações de uso |
| **Política de Privacidade** | Documento que descreve como dados pessoais são coletados, processados, armazenados e compartilhados |
| **Consentimento** | Manifestação livre, informada e inequívoca de concordância do titular (LGPD Art. 8) |
| **Consentimento Granular** | Consentimento específico para cada tipo de processamento, permitindo escolha individual |
| **Revogação** | Retirada de consentimento já fornecido, direito exercível a qualquer momento |
| **Portabilidade** | Direito de exportar dados pessoais em formato estruturado (LGPD Art. 18, V) |
| **Anonimização** | Processo irreversível de remoção de identificadores pessoais (LGPD Art. 16) |
| **Tenant** | Unidade lógica de isolamento de dados (empresa) |
| **DPO** | Data Protection Officer - Encarregado de proteção de dados |

---

## 4. FUNCIONALIDADES COBERTAS

1. Criar termo de uso ou política de privacidade
2. Atualizar termo existente (gera nova versão automaticamente)
3. Consultar termo por ID
4. Listar termos com filtros (tipo, idioma, status)
5. Visualizar histórico de versões de um termo
6. Comparar versões (diff visual)
7. Aceitar termo (usuário autenticado)
8. Gerenciar consentimentos granulares
9. Revogar consentimento específico
10. Solicitar exportação de dados pessoais
11. Solicitar anonimização de dados
12. Visualizar dashboard de conformidade
13. Consultar logs de auditoria
14. Assinar termo digitalmente (certificado A1/A3)

---

## 5. REGRAS DE NEGÓCIO

### RN-RF080-001 — Aceite Obrigatório no Primeiro Acesso

**Descrição**: Usuário não pode acessar o sistema sem aceitar os termos de uso vigentes. Sistema exibe overlay bloqueante que só permite acesso após aceite explícito.

**Justificativa**: LGPD Art. 8 - consentimento deve ser livre, informado e inequívoco. Empresa precisa documentar que usuário foi explicitamente informado.

**Critério de Aceite**:
- Usuário autenticado sem aceite vigente → bloqueio com HTTP 403
- Aceite registrado com IP, timestamp, User-Agent e versão do termo
- Recusa → logout automático e redirecionamento para página de despedida

---

### RN-RF080-002 — Versionamento Automático de Termos

**Descrição**: Qualquer alteração no conteúdo de um termo gera nova versão automaticamente. Sistema mantém histórico completo com diff visual entre versões.

**Justificativa**: LGPD Art. 5 - transparência. Usuário deve saber exatamente o que mudou quando assina novo termo.

**Critério de Aceite**:
- Alteração de conteúdo → incrementa versão automaticamente
- Versão anterior preservada em tabela separada
- Diff visual gerado automaticamente (destaque de adições/remoções)
- Usuários notificados sobre atualização via e-mail, SMS e in-app

---

### RN-RF080-003 — Consentimentos Granulares

**Descrição**: Usuário pode consentir individualmente para cada tipo de processamento:
- **Marketing**: Ofertas e comunicações comerciais
- **Analytics**: Análise de comportamento e estatísticas
- **Cookies**: Rastreamento e publicidade personalizada
- **Compartilhamento**: Compartilhamento com parceiros externos

**Justificativa**: LGPD Art. 8 - consentimento deve ser específico e granular. GDPR Recital 32. ISO 27701 seção 5.2.

**Critério de Aceite**:
- Usuário escolhe individualmente para cada tipo
- Fundamento legal registrado (Consentimento / Contrato / Interesse Legítimo)
- Aceite parcial permitido (pode negar Cookies mas aceitar Analytics)

---

### RN-RF080-004 — Revogação de Consentimento Imediata

**Descrição**: Usuário pode revogar qualquer consentimento a qualquer momento via interface dedicada (Privacy Center). Revogação é imediata e sem necessidade de justificativa.

**Justificativa**: LGPD Art. 18, IX - direito de revogar consentimento. Art. 7, § 5º - revogação deve ser tão fácil quanto consentir.

**Critério de Aceite**:
- Revogação registrada com timestamp, IP e motivo opcional
- Efeito imediato (sistema para processamento imediatamente)
- Auditoria completa gerada
- Acionadores automáticos ativados (ex: anonimização se aplicável)

---

### RN-RF080-005 — Portabilidade de Dados

**Descrição**: Usuário pode exportar todos seus dados pessoais em formato estruturado (JSON, CSV ou XML). Dados incluem: perfil, histórico de aceites, consentimentos, acessos e dados transacionais.

**Justificativa**: LGPD Art. 18, V - direito de obter cópia dos dados em formato portável. Prazo: 15 dias úteis.

**Critério de Aceite**:
- Formatos suportados: JSON, CSV, XML
- Dados incluídos: perfil completo, aceites, consentimentos, auditoria
- Arquivo gerado e disponibilizado em blob storage
- Link temporário enviado por e-mail (válido 7 dias)
- Operação auditada

---

### RN-RF080-006 — Anonimização Irreversível

**Descrição**: Após revogação de consentimento ou solicitação de exclusão, sistema remove identificadores pessoais de forma irreversível, mantendo integridade referencial. Dados anônimos podem ser usados para análise estatística.

**Justificativa**: LGPD Art. 16 - direito ao esquecimento. Dados anônimos não são mais dados pessoais.

**Critério de Aceite**:
- Identificadores substituídos por hash anônimo (SHA256)
- Dados originais descartados permanentemente
- Integridade referencial preservada (chaves estrangeiras mantidas)
- Processo irreversível (não pode ser revertido)
- Dados anônimos podem ser usados em relatórios sem restrições LGPD

---

### RN-RF080-007 — Auditoria Completa de Consentimentos

**Descrição**: Toda ação de consentimento (aceite, revogação, modificação) é registrada com timestamp ISO 8601, IP, User-Agent, versão do termo, fundamento legal, geolocalização e hash do documento.

**Justificativa**: LGPD Art. 5 - responsabilização. Empresa deve demonstrar conformidade. Auditoria é prova de consentimento válido.

**Critério de Aceite**:
- Timestamp em formato ISO 8601 (UTC)
- IP de origem e User-Agent completo
- Navegador e sistema operacional parseados
- Geolocalização inferida do IP
- Hash SHA256 do documento aceito
- Identificador de sessão rastreado (UUID único)
- Retenção de 5 anos (LGPD Art. 7, § 5º)

---

### RN-RF080-008 — Integração com RF079 (Políticas Corporativas)

**Descrição**: Termos de aceite devem estar vinculados a políticas corporativas definidas em RF079. Uma política pode ter múltiplos termos associados. Mudança em política força re-aceite de todos os termos vinculados.

**Justificativa**: Rastreabilidade entre política corporativa (decisão de negócio) e implementação técnica (termo).

**Critério de Aceite**:
- Termo criado → deve referenciar política corporativa
- Política alterada → todos os termos vinculados requerem re-aceite
- Versionamento sincronizado entre política e termos

---

### RN-RF080-009 — Notificações Multi-Canal

**Descrição**: Quando termo é atualizado, sistema notifica usuários via três canais simultaneamente: (1) E-mail com link para revisar, (2) In-app via SignalR (tempo real), (3) SMS (se telefone cadastrado).

**Justificativa**: LGPD Art. 5 - transparência. Usuário deve estar ciente de mudanças antes de ser bloqueado.

**Critério de Aceite**:
- E-mail enviado com resumo das mudanças e link direto
- Notificação in-app em tempo real via SignalR
- SMS enviado se telefone cadastrado
- Notificações respeitam preferências do usuário (opt-out permitido)

---

### RN-RF080-010 — Multi-idioma (pt-BR, en-US, es-ES)

**Descrição**: Interface completa e conteúdo de termos suportam três idiomas: português (Brasil), inglês (EUA) e espanhol (Espanha). Termos podem ser versionados independentemente por idioma.

**Justificativa**: LGPD Art. 5 - transparência. Usuário deve compreender termo na sua língua.

**Critério de Aceite**:
- Termos armazenados em três idiomas simultâneos
- Fallback automático: pt-BR → en-US → es-ES
- Versionamento independente por idioma
- Interface detecta idioma do navegador automaticamente

---

### RN-RF080-011 — Dashboard de Conformidade

**Descrição**: Dashboard exibe métricas em tempo real: taxa de aceite por termo, taxa de revogação, evolução temporal, segmentação por geografia/dispositivo/navegador.

**Justificativa**: LGPD Art. 5 - responsabilização. Empresa demonstra aderência monitorando conformidade.

**Critério de Aceite**:
- Métricas atualizadas em tempo real
- Filtros por período, termo, tipo de consentimento
- Gráficos de evolução temporal (linha do tempo)
- Segmentação por geografia, dispositivo e navegador
- Export de relatórios (PDF, Excel)

---

### RN-RF080-012 — Assinatura Digital Opcional

**Descrição**: Para aceites críticos (contratos com responsabilidade financeira), usuário pode assinar digitalmente com certificado A1/A3. Sistema valida assinatura com AC Raiz Brasileira.

**Justificativa**: Lei 14.063/2020 - assinatura eletrônica. Aumenta segurança jurídica.

**Critério de Aceite**:
- Certificado validado com AC Raiz Brasileira
- Assinatura PKCS#7 armazenada
- Serial do certificado registrado
- Validação de revogação em CRL
- Timestamp de assinatura (RFC 3161)

---

### RN-RF080-013 — Isolamento por Tenant

**Descrição**: Termos e consentimentos são isolados por tenant. Um usuário de tenant A não pode visualizar ou aceitar termos de tenant B.

**Justificativa**: Segurança e compliance multi-tenant.

**Critério de Aceite**:
- Filtro automático por tenant em todas as queries
- Tentativa de acesso cruzado → HTTP 403
- Auditoria registra tentativas de violação

---

### RN-RF080-014 — Validação de Campos Obrigatórios

**Descrição**: Campos obrigatórios na criação de termo: título, descrição, conteúdo, tipo (Uso/Privacidade/Cookies/Compartilhamento) e idioma.

**Justificativa**: Garantir integridade mínima dos dados para auditoria.

**Critério de Aceite**:
- Campo obrigatório ausente → HTTP 400
- Conteúdo vazio ou apenas espaços → rejeição
- Tipo não reconhecido → rejeição

---

### RN-RF080-015 — Proteção Contra XSS e Injeção

**Descrição**: Conteúdo HTML de termos é sanitizado antes de salvar. Caracteres especiais são escapados em JSON responses. CRLF injection prevenido.

**Justificativa**: Segurança (OWASP Top 10).

**Critério de Aceite**:
- HTML sanitizado com biblioteca HtmlSanitizer
- Tags perigosas removidas (script, iframe, object)
- Caracteres especiais escapados em JSON
- SQL injection prevenido (parameterized queries)

---

## 6. ESTADOS DA ENTIDADE

| Estado | Descrição |
|------|-----------|
| `draft` | Termo criado, aguardando revisão |
| `active` | Termo publicado e vigente |
| `superseded` | Termo substituído por versão mais nova |
| `archived` | Termo arquivado, não mais vigente |

### Transições permitidas

| De | Para |
|---|---|
| draft | active |
| active | superseded |
| superseded | archived |

**Proibições**:
- Termo arquivado não pode voltar a active
- Termo superseded não pode ser editado

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre |
|------|--------------|
| `termo.criado` | Após criação de novo termo |
| `termo.atualizado` | Após atualização (nova versão) |
| `termo.aceito` | Após usuário aceitar termo |
| `consentimento.concedido` | Após consentimento granular |
| `consentimento.revogado` | Após revogação |
| `dados.exportados` | Após portabilidade solicitada |
| `dados.anonimizados` | Após anonimização concluída |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant
- Nenhuma regra de negócio pode ser ignorada
- Aceite sem auditoria completa é inválido
- Revogação deve ser imediata (sem delay)
- Anonimização deve ser irreversível
- Portabilidade deve conter 100% dos dados pessoais
- Dashboard deve refletir estado real (sem cache desatualizado)

---

## 9. SEGURANÇA

### Proteções Obrigatórias

| Proteção | Implementação |
|----------|--------------|
| SQL Injection | Parameterized queries (EF Core) |
| XSS | HtmlSanitizer em conteúdo HTML |
| CSRF | Tokens anti-CSRF em POST/PUT/DELETE |
| CRLF Injection | Validação de entrada |
| Anonimização Irreversível | Hash SHA256 + salt |
| Retenção de Auditoria | Write-once storage (5 anos) |
| TLS em Trânsito | TLS 1.3 obrigatório |
| Criptografia em Repouso | TDE no PostgreSQL |
| Integridade de Documentos | Hash SHA256 do termo |
| Rate Limiting | 10 aceites/min, 5 exportações/dia |

### Testes de Segurança Obrigatórios

- [ ] SQL Injection em campos de entrada
- [ ] XSS em conteúdo HTML de termos
- [ ] CSRF em POST/PUT/DELETE
- [ ] Validação de permissões RBAC
- [ ] Anonimização irreversível
- [ ] Retenção de auditoria (5 anos)
- [ ] TLS 1.3 em trânsito
- [ ] Validação de integridade (SHA256)
- [ ] Rate limiting
- [ ] Certificados digitais (AC Raiz)

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF080.md** - Casos de Uso detalhados
- **MD-RF080.md** - Modelo de Dados completo
- **WF-RF080.md** - Workflows e componentes Angular
- **TC-RF080-BACKEND.yaml** - Casos de Teste Backend
- **TC-RF080-FRONTEND.yaml** - Casos de Teste Frontend
- **TC-RF080-SEGURANCA.yaml** - Casos de Teste Segurança
- **TC-RF080-E2E.yaml** - Casos de Teste End-to-End
- **user-stories.yaml** - User Stories com acceptance criteria

---

## 11. RASTREABILIDADE

| Artefato | Status | Gerado |
|---------|-------|--------|
| Casos de Uso (UC-RF080) | Pendente | Obrigatório |
| Modelo de Dados (MD-RF080) | Pendente | Obrigatório |
| Workflows (WF-RF080) | Pendente | Obrigatório |
| User Stories | Pendente | Obrigatório |
| Testes Backend | Pendente | Obrigatório |
| Testes Frontend | Pendente | Obrigatório |
| Testes Segurança | Pendente | Obrigatório |
| Testes E2E | Pendente | Obrigatório |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|------|------|----------|------|
| 2.0 | 2025-12-31 | Versão modernizada - Separação RF/RL, contrato funcional limpo | Agência ALC - alc.dev.br |
| 1.0 | 2025-12-28 | Versão inicial do requisito funcional | Agência ALC - alc.dev.br |
