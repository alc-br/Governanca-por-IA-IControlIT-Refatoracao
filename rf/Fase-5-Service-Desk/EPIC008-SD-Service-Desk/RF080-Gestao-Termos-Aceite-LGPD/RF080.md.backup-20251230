# RF-080: Gestão de Termos de Aceite e LGPD

**Versao**: 1.0 | **Data**: 2025-12-28
**RF Relacionado**: RF-079 (Gestão de Políticas e Compliance) | **EPIC**: EPIC008-SD-Service-Desk
**Fase**: Fase 5 - Service Desk e Governança

---

## 1. RESUMO EXECUTIVO

### 1.1 Descricao Geral

Este requisito especifica o módulo de **Gestão de Termos de Aceite e LGPD** do sistema IControlIT, responsável pela gestão completa de termos de uso, políticas de privacidade, cookies e consentimentos, garantindo conformidade com a Lei Geral de Proteção de Dados (LGPD - Lei 13.709/2018), GDPR e ISO 27701.

O módulo oferece um sistema robusto para:
- **Versionamento de termos**: Manutenção de histórico completo com rastreabilidade
- **Aceite obrigatório**: Bloqueio do acesso até aceitação de termos vigentes
- **Gestão de consentimentos**: Granularidade completa (marketing, analytics, cookies, compartilhamento de dados)
- **Conformidade LGPD**: Direito de revogação, portabilidade e anonimização de dados
- **Auditoria completa**: Rastreamento de todos os consentimentos e aceites para compliance

### 1.2 Importancia Estrategica

O módulo de Gestão de Termos de Aceite e LGPD é crítico para:

- **Conformidade Regulatória**: Atender exigências LGPD, GDPR e ISO 27701 de forma automática
- **Proteção Legal**: Documentar consentimento explícito e informado do usuário com prova
- **Gestão de Risco**: Minimizar exposure a multas e sanções regulatórias (até 50M ou 2% do faturamento)
- **Transparência**: Informar usuários sobre uso de seus dados de forma clara e acessível
- **Direitos do Usuário**: Garantir exercício de direitos (acesso, portabilidade, exclusão, revogação)
- **Continuidade de Negócio**: Permitir coleta e uso de dados pessoais de forma legal e consentida
- **Eficiência Operacional**: Automatizar processos manuais de gestão de aceites
- **Análise de Mercado**: Obter dados demográficos com consentimento para análises direcionadas

### 1.3 Conceitos Fundamentais

**Termo de Uso**: Documento textual que define as regras de utilização do sistema, incluindo responsabilidades do usuário, limitações de uso e disclaimers legais.
- Apresentado no primeiro acesso ou quando atualizado
- Requer aceite explícito antes de usar o sistema
- Versionado para rastreabilidade histórica

**Política de Privacidade**: Documento que descreve como os dados pessoais do usuário são coletados, processados, armazenados e compartilhados.
- Deve ser clara e acessível em linguagem simples
- Inclui fundamento legal (consentimento, necessidade contratual, interesse legítimo, etc.)
- Descreve direitos do usuário conforme LGPD

**Consentimento Granular**: Consentimento específico para cada tipo de processamento de dados, permitindo que o usuário escolha individualmente.
- **Consentimento Marketing**: Uso de dados para ofertas e comunicações comerciais
- **Consentimento Analytics**: Coleta de dados de comportamento para análise estatística
- **Consentimento Cookies**: Uso de cookies de rastreamento e publicidade
- **Consentimento Compartilhamento**: Compartilhamento de dados com parceiros externos

**Revogação de Consentimento**: Direito do usuário de retirar consentimento já fornecido, conforme Art. 18, IX da LGPD.
- Pode ser feita a qualquer momento
- Efetiva imediatamente
- Gera auditoria completa

**Portabilidade de Dados**: Direito de exportar dados pessoais em formato estruturado, conforme Art. 18, V LGPD.
- Formato: JSON, CSV ou XML
- Inclui histórico de aceites e consentimentos
- Direito exercível em até 15 dias úteis

**Anonimização de Dados**: Processo de remover identificadores de dados pessoais, conforme Art. 16 LGPD.
- Após revogação de consentimento
- Dados não podem ser revertidos a forma identificável
- Mantém integridade referencial

**Auditoria de Consentimento**: Registro de todas as ações relacionadas a termos, aceites e consentimentos.
- Quando foi aceito/revogado
- Qual versão foi aceita
- IP, dispositivo e navegador
- Fundamento legal (consentimento, contrato, interesse legítimo)

### 1.4 Legado vs Modernizado

| Aspecto | Legado (VB.NET) | Modernizado (.NET 10 + Angular) |
|---------|-----------------|--------------------------------|
| **Armazenamento de Termos** | SQL Server (Si_Texto_Termo) com Pagina/Caixa | PostgreSQL com versionamento temporal e blob storage |
| **Aceite de Usuário** | Tabela Usuario_Envio_TermoResponsabilidade (simples) | Tabela TermoAceite com dados completos (IP, User-Agent, timestamp) |
| **Consentimentos** | Não suportado / Ad-hoc | Tabela ConsentimentoUsuario com granularidade completa |
| **Versionamento** | Manual via Caixa | Automático com histórico completo e comparação visual |
| **Revogação** | Não suportado | Suportado com anonimização automática |
| **Portabilidade** | Manual | API export com JSON/CSV/XML |
| **Auditoria** | Logs isolados | Sistema de auditoria integrado (RFC 3339, ISO 8601) |
| **Multi-idioma** | Hardcoded | i18n com 3 idiomas (pt-BR, en-US, es-ES) |
| **Notificações** | E-mail simples | SignalR (real-time) + e-mail + in-app |
| **Assinatura Digital** | Não suportado | Opcional (certificado A1/A3 eIDAS) |
| **Dashboard** | Relatório SSRS | Dashboard em tempo real (Angular + D3.js) |
| **Performance** | QueryTimeOut issues | Cache distribuído (Redis) para termos frequentes |

### 1.5 Funcionalidades Principais

1. **CRUD de Termos de Uso e Políticas**: Criar, ler, atualizar e versionar termos com histórico completo
2. **Versionamento Automático**: Controle de versões com changelog detalhado
3. **Aceite Obrigatório**: Bloqueio de acesso até aceite explícito de termos vigentes
4. **Re-aceite Automático**: Quando termo é atualizado, notificar e bloquear até novo aceite
5. **Consentimentos Granulares**: Permitir usuário consentir individualmente para cada tipo de processamento
6. **Revogação de Consentimento**: Direito de retirar consentimento a qualquer momento (LGPD Art. 18, IX)
7. **Portabilidade de Dados**: Exportar dados pessoais em formato estruturado (LGPD Art. 18, V)
8. **Anonimização**: Remover identificadores após revogação (LGPD Art. 16)
9. **Dashboard de Consentimentos**: Visualizar taxa de aceite, revogação, por termo e por período
10. **Auditoria Completa**: Rastrear todas as ações com IP, navegador, timestamp e fundamento legal
11. **Notificações**: Alertar usuários sobre atualizações via e-mail, SMS e in-app (SignalR)
12. **Integração com RF079**: Vincular a políticas corporativas definidas em RF079
13. **Assinatura Digital**: Suporte opcional a certificado digital A1/A3 para aceites críticos
14. **Busca e Filtros**: Pesquisar termos por tipo, data, status, idioma
15. **Multi-idioma**: Interface em português, inglês e espanhol

---

## 2. REGRAS DE NEGOCIO

### RN-LGPD-080-01: Aceite Obrigatório no Primeiro Acesso

**Descricao**: Usuário não pode acessar sistema completo sem aceitar termos de uso vigentes. Sistema exibe overlay bloqueante com termo e opção de aceitar/rejeitar.

**Justificativa**: Conformidade LGPD Art. 8 (consentimento deve ser livre, informado e inequívoco). Documentar que usuário foi explicitamente informado e concordou.

**Implementacao**:
```csharp
public class TermoAceiteMiddleware
{
    public async Task InvokeAsync(HttpContext context, ITermoAceiteService termoService)
    {
        var usuario = context.User;
        if (usuario?.Identity?.IsAuthenticated != true)
        {
            await next(context);
            return;
        }

        var termoVigente = await termoService.ObterTermoVigenteAsync(usuario.Id);
        if (termoVigente == null)
        {
            await next(context);
            return;
        }

        var usuarioAceitou = await termoService.VerificarAceiteAsync(
            usuario.Id,
            termoVigente.Id);

        if (!usuarioAceitou)
        {
            context.Response.StatusCode = 403; // Forbidden
            context.Response.ContentType = "application/json";
            await context.Response.WriteAsJsonAsync(new
            {
                erro = "TermoNaoAceito",
                mensagem = "Você deve aceitar os termos de uso para continuar",
                termoId = termoVigente.Id,
                termoUrl = $"/api/termos/{termoVigente.Id}/conteudo"
            });
            return;
        }

        await next(context);
    }
}
```

**Exemplos**:
- Usuário novo: vê overlay com termo, deve clicar "Aceito" para prosseguir
- Usuário com termo antigo: vê notificação de atualização, deve ler e aceitar nova versão
- Rejeição: usuário clica "Recuso" e é redirecionado para página de despedida

---

### RN-LGPD-080-02: Versionamento Automático de Termos

**Descricao**: Cada alteração em um termo gera nova versão automática. Sistema mantém histórico completo com diff visual entre versões.

**Justificativa**: Conformidade LGPD Art. 5 (transparência). Usuário deve saber exatamente o que mudou quando assina novo termo.

**Implementacao**:
```csharp
public class TermoAceiteCommand : Command
{
    public Guid TermoId { get; set; }
    public string Titulo { get; set; }
    public string Descricao { get; set; }
    public string Conteudo { get; set; }
    public string Tipo { get; set; } // "Uso", "Privacidade", "Cookies", "Compartilhamento"
    public bool IsMarcacaoComercial { get; set; }
}

public class AtualizarTermoCommandHandler : ICommandHandler<AtualizarTermoCommand>
{
    public async Task<Result> Handle(AtualizarTermoCommand cmd, CancellationToken ct)
    {
        var termo = await _repo.GetAsync(cmd.TermoId, ct);

        // Se conteúdo mudou, cria nova versão
        if (termo.Conteudo != cmd.Conteudo)
        {
            // Cria snapshot de versão anterior
            var versaoAnterior = new TermoVersao
            {
                TermoId = termo.Id,
                Numero = termo.Versao + 1,
                Conteudo = cmd.Conteudo,
                DataCriacao = DateTime.UtcNow,
                CriadoPor = _user.Id,
                DiffDoAnterior = ComputarDiff(termo.Conteudo, cmd.Conteudo)
            };

            termo.AdicionarVersao(versaoAnterior);
            termo.Versao++;
            termo.DataAtualizacao = DateTime.UtcNow;
        }

        // Auditoria
        _audit.Log("LGPD_TERMO_ATUALIZADO", new
        {
            TermoId = termo.Id,
            VersaoAnterior = termo.Versao - 1,
            VersaoNova = termo.Versao,
            ImpactoUsuarios = true
        });

        await _repo.SaveAsync(termo, ct);
        return Result.Success();
    }
}
```

**Exemplos**:
- Termo v1: "Coletamos dados para serviço"
- Alteração: adiciona "e para análise de mercado"
- Termo v2: sistema cria registro de mudança, marca para re-aceite
- Usuários veem diff: `+ "e para análise de mercado"`

---

### RN-LGPD-080-03: Consentimentos Granulares

**Descricao**: Usuário pode consentir individualmente para: (a) Marketing, (b) Analytics, (c) Cookies, (d) Compartilhamento. Cada consentimento tem fundamento legal independente.

**Justificativa**: LGPD Art. 8 exige consentimento específico e granular. GDPR Recital 32. ISO 27701 seção 5.2.

**Implementacao**:
```csharp
public class ConsentimentoUsuario
{
    public Guid Id { get; set; }
    public Guid UsuarioId { get; set; }
    public ConsentimentoTipo Tipo { get; set; } // Marketing, Analytics, Cookies, Compartilhamento
    public bool Concedido { get; set; }
    public string FundamentoLegal { get; set; } // "Consentimento", "Contrato", "Interesse Legítimo", "Obrigação Legal", "Interesse Vital"
    public DateTime DataConsentimento { get; set; }
    public string IpOrigem { get; set; }
    public string UserAgent { get; set; }
    public Guid? TermoReferencia { get; set; } // Qual termo estava vigente
    public DateTime? DataRevogacao { get; set; }
    public string IpRevogacao { get; set; }
    public string Motivo { get; set; } // Por quê revogou

    public enum ConsentimentoTipo
    {
        Marketing = 1,       // Envio de ofertas, newsletters, promoções
        Analytics = 2,       // Análise de comportamento, estatísticas
        Cookies = 3,         // Rastreamento, publicidade direcionada
        Compartilhamento = 4 // Compartilhamento com parceiros
    }
}

public class ConsentirCommand : Command
{
    public Guid UsuarioId { get; set; }
    public List<(ConsentimentoTipo Tipo, bool Concedido)> Consentimentos { get; set; }
    public Guid TermoId { get; set; }
}

public class ConsentirCommandHandler : ICommandHandler<ConsentirCommand>
{
    public async Task<Result> Handle(ConsentirCommand cmd, CancellationToken ct)
    {
        var usuario = await _userRepo.GetAsync(cmd.UsuarioId, ct);
        var termo = await _termoRepo.GetAsync(cmd.TermoId, ct);

        foreach (var (tipo, concedido) in cmd.Consentimentos)
        {
            var consentimento = new ConsentimentoUsuario
            {
                Id = Guid.NewGuid(),
                UsuarioId = usuario.Id,
                Tipo = tipo,
                Concedido = concedido,
                FundamentoLegal = DeterminiarFundamento(tipo),
                DataConsentimento = DateTime.UtcNow,
                IpOrigem = _context.HttpContext?.Connection.RemoteIpAddress?.ToString(),
                UserAgent = _context.HttpContext?.Request.Headers["User-Agent"].ToString(),
                TermoReferencia = termo.Id
            };

            await _consentimentoRepo.AddAsync(consentimento, ct);

            // Auditoria
            _audit.Log("LGPD_CONSENTIMENTO_CONCEDIDO", new
            {
                UsuarioId = usuario.Id,
                TipoConsentimento = tipo,
                Concedido = concedido,
                IpOrigem = consentimento.IpOrigem,
                TermoId = termo.Id
            });
        }

        await _consentimentoRepo.SaveAsync(ct);
        return Result.Success();
    }

    private string DeterminiarFundamento(ConsentimentoTipo tipo) =>
        tipo switch
        {
            ConsentimentoTipo.Marketing => "Consentimento",
            ConsentimentoTipo.Analytics => "Interesse Legítimo",
            ConsentimentoTipo.Cookies => "Consentimento",
            ConsentimentoTipo.Compartilhamento => "Consentimento",
            _ => "Consentimento"
        };
}
```

**Exemplos**:
- Marketing: "Concedo permissão para receber ofertas por e-mail" ✓
- Analytics: Já consentiu (Interesse Legítimo, sem opt-in necessário)
- Cookies: "Aceito rastreamento para publicidade personalizada" ✗ (não concede)
- Compartilhamento: Escolhe individualmente

---

### RN-LGPD-080-04: Revogação de Consentimento (Art. 18, IX LGPD)

**Descricao**: Usuário pode revogar consentimento a qualquer momento via interface. Revogação é imediata e sem justificativa necessária. Sistema registra data/hora, IP e motivo opcional.

**Justificativa**: LGPD Art. 18, IX: "direito de revogar o consentimento". Deve ser fácil quanto consentir. Art. 7, § 5º.

**Implementacao**:
```csharp
public class RevogarConsentimentoCommand : Command
{
    public Guid UsuarioId { get; set; }
    public ConsentimentoTipo Tipo { get; set; }
    public string Motivo { get; set; } // Opcional
}

public class RevogarConsentimentoCommandHandler : ICommandHandler<RevogarConsentimentoCommand>
{
    public async Task<Result> Handle(RevogarConsentimentoCommand cmd, CancellationToken ct)
    {
        var consentimento = await _consentimentoRepo
            .FirstOrDefaultAsync(
                c => c.UsuarioId == cmd.UsuarioId && c.Tipo == cmd.Tipo && c.DataRevogacao == null,
                ct);

        if (consentimento == null)
            return Result.Fail("Consentimento não encontrado ou já revogado");

        consentimento.DataRevogacao = DateTime.UtcNow;
        consentimento.IpRevogacao = _context.HttpContext?.Connection.RemoteIpAddress?.ToString();
        consentimento.Motivo = cmd.Motivo;

        await _consentimentoRepo.SaveAsync(consentimento, ct);

        // Auditoria completa
        _audit.Log("LGPD_CONSENTIMENTO_REVOGADO", new
        {
            UsuarioId = cmd.UsuarioId,
            TipoConsentimento = cmd.Tipo,
            DataRevogacao = consentimento.DataRevogacao,
            IpRevogacao = consentimento.IpRevogacao,
            Motivo = cmd.Motivo,
            Acao = "IMEDIATA" // Revogação é imediatamente efetiva
        });

        // Acionadores pós-revogação
        await _anonimizadorService.AgenizarDadosSeNecessarioAsync(
            cmd.UsuarioId, cmd.Tipo, ct);

        return Result.Success();
    }
}
```

**Exemplos**:
- Usuário vai a Privacy Center
- Clica "Revogar" em "Cookies"
- Sistema registra revogação em 2025-12-28 14:35:00 UTC, IP 192.168.1.100
- Tracking de publicidade para esse usuário para imediatamente
- Auditoria: "Usuario revogou consentimento de Cookies em 2025-12-28 14:35:00 UTC de IP 192.168.1.100"

---

### RN-LGPD-080-05: Portabilidade de Dados (Art. 18, V LGPD)

**Descricao**: Usuário pode exportar todos seus dados pessoais em formato estruturado (JSON, CSV, XML). Dados incluem: perfil, histórico de aceites, consentimentos, acessos, dados transacionais.

**Justificativa**: LGPD Art. 18, V: "direito de obter cópia dos dados". Deve ser em formato "portável" (estruturado e legível por máquina). Prazo: 15 dias úteis.

**Implementacao**:
```csharp
public class ExportarDadosCommand : Command
{
    public Guid UsuarioId { get; set; }
    public string Formato { get; set; } // "json", "csv", "xml"
}

public class ExportarDadosCommandHandler : ICommandHandler<ExportarDadosCommand>
{
    public async Task<Stream> Handle(ExportarDadosCommand cmd, CancellationToken ct)
    {
        var usuario = await _userRepo.GetAsync(cmd.UsuarioId, ct);

        var dados = new
        {
            usuario.Id,
            usuario.Nome,
            usuario.Email,
            usuario.DataCriacao,
            usuario.DataUltimoAcesso,

            aceites = await _termoAceiteRepo
                .Where(ta => ta.UsuarioId == cmd.UsuarioId)
                .Select(ta => new {
                    ta.Id,
                    ta.TermoId,
                    ta.DataAceite,
                    ta.VersaoTermo,
                    ta.IpOrigem,
                    ta.UserAgent
                })
                .ToListAsync(ct),

            consentimentos = await _consentimentoRepo
                .Where(c => c.UsuarioId == cmd.UsuarioId)
                .Select(c => new {
                    c.Id,
                    c.Tipo,
                    c.Concedido,
                    c.FundamentoLegal,
                    c.DataConsentimento,
                    c.DataRevogacao,
                    c.IpOrigem
                })
                .ToListAsync(ct),

            acessos = await _auditaRepo
                .Where(a => a.UsuarioId == cmd.UsuarioId)
                .Select(a => new {
                    a.Id,
                    a.DataAcesso,
                    a.Operacao,
                    a.IpOrigem,
                    a.Resultado
                })
                .Take(1000) // Últimos 1000 acessos
                .ToListAsync(ct)
        };

        var stream = cmd.Formato switch
        {
            "json" => await SerializarJsonAsync(dados),
            "csv" => await SerializarCsvAsync(dados),
            "xml" => await SerializarXmlAsync(dados),
            _ => throw new ArgumentException("Formato inválido")
        };

        _audit.Log("LGPD_EXPORTACAO_DADOS", new
        {
            UsuarioId = cmd.UsuarioId,
            Formato = cmd.Formato,
            Registros = dados.aceites.Count + dados.consentimentos.Count,
            DataExportacao = DateTime.UtcNow
        });

        return stream;
    }
}
```

**Exemplos**:
- Usuário clica "Baixar meus dados" em Privacy Center
- Sistema prepara arquivo JSON/CSV/XML com todos os dados
- Download automático: dados-pessoais-2025-12-28.json
- Incluído no arquivo: perfil, aceites (com IP, timestamp, versão), consentimentos, histórico de acessos

---

### RN-LGPD-080-06: Anonimização de Dados (Art. 16 LGPD)

**Descricao**: Após revogação de consentimento ou solicitação de exclusão, sistema remove identificadores pessoais mantendo integridade referencial. Dados anônimos podem ser reusados para análise.

**Justificativa**: LGPD Art. 16 (direito ao esquecimento). Dados anônimos não são mais dados pessoais, logo não precisam de consentimento.

**Implementacao**:
```csharp
public class AnonimizarDadosCommand : Command
{
    public Guid UsuarioId { get; set; }
    public AnonimizacaoMotivo Motivo { get; set; }

    public enum AnonimizacaoMotivo
    {
        RevogacaoConsentimento,
        SolicitacaoExclusao,
        InativoHA2Anos,
        LGPD_Art16
    }
}

public class AnonimizarDadosCommandHandler : ICommandHandler<AnonimizarDadosCommand>
{
    public async Task<Result> Handle(AnonimizarDadosCommand cmd, CancellationToken ct)
    {
        var usuario = await _userRepo.GetAsync(cmd.UsuarioId, ct);

        // Substitui identificadores por hash anônimo
        var hashAnonimo = ComputarHashAnonimo(usuario.Id);

        // 1. Usuário: remover dados pessoais, manter ID funcional
        usuario.Nome = $"Anonimo_{hashAnonimo.Substring(0, 8)}";
        usuario.Email = null;
        usuario.Telefone = null;
        usuario.DataNascimento = null;
        usuario.Cpf = null;
        usuario.Endereco = null;
        usuario.IsAnonimizado = true;
        usuario.DataAnonimizacao = DateTime.UtcNow;

        // 2. Dados transacionais: manter chave estrangeira, anonimizar conteúdo
        var transacoes = await _transacaoRepo
            .Where(t => t.UsuarioId == cmd.UsuarioId)
            .ToListAsync(ct);

        foreach (var t in transacoes)
        {
            t.DescricaoUsuario = null;
            t.NotasUsuario = null;
            t.DadosAdicionaisJson = null;
        }

        // 3. Auditoria: manter referência anônima
        var auditorias = await _auditaRepo
            .Where(a => a.UsuarioId == cmd.UsuarioId)
            .ToListAsync(ct);

        foreach (var a in auditorias)
        {
            a.Usuario = $"Anonimo_{hashAnonimo.Substring(0, 8)}";
            a.DadosSensiveisMascarados = true;
        }

        // Auditoria de anonimização
        _audit.Log("LGPD_ANONIMIZACAO", new
        {
            UsuarioId = cmd.UsuarioId,
            Motivo = cmd.Motivo,
            DataAnonimizacao = DateTime.UtcNow,
            RegistrosMascardos = transacoes.Count + auditorias.Count,
            Irreversivel = true
        });

        await _unitOfWork.SaveAsync(ct);
        return Result.Success();
    }
}
```

**Exemplos**:
- Usuário revoga consentimento de Analytics
- Sistema anonimiza dados de IP em registros de acesso
- Registros de auditoria mantêm referência anônima (UUID)
- Dados anônimos podem ser usados em relatórios estatísticos sem problemas LGPD

---

### RN-LGPD-080-07: Auditoria Completa de Consentimentos

**Descricao**: Cada ação de consentimento (aceite, revogação, modificação) é registrada com timestamp ISO 8601, IP, User-Agent, versão do termo, fundamento legal e identificador de sessão.

**Justificativa**: LGPD Art. 5 (responsabilização). Empresas devem demonstrar conformidade com regulação. Auditoria é prova de consentimento válido.

**Implementacao**:
```csharp
public class RegistroAuditoriaConsentimento
{
    public Guid Id { get; set; }
    public Guid UsuarioId { get; set; }
    public string Acao { get; set; } // "ACEITO", "REVOGADO", "ATUALIZADO"
    public DateTime DataAcao { get; set; } // ISO 8601, UTC
    public string IpOrigem { get; set; }
    public string UserAgent { get; set; }
    public string Navegador { get; set; } // Chrome 120.0
    public string SistemaOperacional { get; set; } // Windows 11
    public Guid TermoId { get; set; }
    public int VersaoTermo { get; set; }
    public string[] ConsentimentosConcedidos { get; set; }
    public string[] ConsentimentosRecusados { get; set; }
    public string FundamentoLegal { get; set; } // "Consentimento", "Contrato", "Interesse Legítimo"
    public Guid SessaoId { get; set; } // Para rastrear mesma sessão
    public string GeoLocalizacao { get; set; } // País/Cidade inferida do IP
    public bool ValidacaoEspeichSimultaneo { get; set; } // Double opt-in realizado?
    public string HashDocumento { get; set; } // SHA256 do documento aceito
}

public class AuditoriaConsentimentoService
{
    public async Task RegistrarAceitAsync(
        Guid usuarioId,
        Guid termoId,
        int versaoTermo,
        Dictionary<ConsentimentoTipo, bool> consentimentos,
        HttpContext context)
    {
        var ip = context.Connection.RemoteIpAddress?.ToString();
        var userAgent = context.Request.Headers["User-Agent"].ToString();
        var (navegador, so) = ParseUserAgent(userAgent);

        var registro = new RegistroAuditoriaConsentimento
        {
            Id = Guid.NewGuid(),
            UsuarioId = usuarioId,
            Acao = "ACEITO",
            DataAcao = DateTime.UtcNow, // RFC 3339 format
            IpOrigem = ip,
            UserAgent = userAgent,
            Navegador = navegador,
            SistemaOperacional = so,
            TermoId = termoId,
            VersaoTermo = versaoTermo,
            ConsentimentosConcedidos = consentimentos
                .Where(kv => kv.Value)
                .Select(kv => kv.Key.ToString())
                .ToArray(),
            ConsentimentosRecusados = consentimentos
                .Where(kv => !kv.Value)
                .Select(kv => kv.Key.ToString())
                .ToArray(),
            FundamentoLegal = "Consentimento",
            SessaoId = Guid.Parse(context.User.FindFirst("SessaoId")?.Value ?? Guid.NewGuid().ToString()),
            GeoLocalizacao = await _geoIpService.ObterLocalizacaoAsync(ip),
            ValidacaoEspeichSimultaneo = true,
            HashDocumento = ComputarSha256(await _termoRepo.GetAsync(termoId))
        };

        await _auditaRepo.AddAsync(registro);
        await _auditaRepo.SaveAsync();
    }
}
```

**Exemplos**:
- 2025-12-28T14:35:00Z | IP: 192.168.1.100 | Chrome 120.0/Windows 11 | Aceito Termo v3 | Marketing: SIM, Analytics: SIM, Cookies: NÃO | Fundamento: Consentimento | Hash: a3f2c1d8...
- 2025-12-28T15:40:00Z | IP: 192.168.1.100 | Chrome 120.0/Windows 11 | Revogado Cookies | Motivo: Privacidade

---

### RN-LGPD-080-08: Integração com RF079 (Políticas Corporativas)

**Descricao**: Termos de aceite devem estar vinculados a políticas corporativas definidas em RF079. Uma política corporativa pode ter múltiplos termos associados. Mudança em política força re-aceite.

**Justificativa**: Rastreabilidade entre política corporativa (decisão de negócio) e implementação técnica (termo).

**Implementacao**:
```csharp
public class TermoAceite
{
    public Guid Id { get; set; }
    public string Titulo { get; set; }
    public Guid PoliticaCorportativaId { get; set; } // FK para RF079
    public PoliticaCorportativa PoliticaCorportativa { get; set; }
    public string Tipo { get; set; } // "Uso", "Privacidade", "Cookies"
    // ... outros campos
}

// Query: Listar políticas e seus termos
var politicas = await _policyRepo
    .Include(p => p.Termos)
    .Where(p => p.Ativo && p.DataVigenciaInicio <= DateTime.UtcNow)
    .ToListAsync();

foreach (var policy in politicas)
{
    var termosAssociados = policy.Termos.Where(t => t.Ativo).ToList();
    // Exigir aceite de todos os termos associados
}
```

**Exemplos**:
- Política "LGPD-Consentimento" (RF079) → Termos "Uso", "Privacidade", "Cookies"
- Atualizar política força versionamento de todos os 3 termos
- Usuário vê notificação: "Políticas foram atualizadas. Revise e aceite."

---

### RN-LGPD-080-09: Notificações de Atualização de Termos

**Descricao**: Quando um termo é atualizado, sistema notifica usuários via: (1) E-mail com link para revisar, (2) In-app via SignalR, (3) SMS (opcional). Notificação inclui resumo das mudanças.

**Justificativa**: LGPD Art. 5 (transparência). Usuário deve estar ciente de mudanças antes de ser bloqueado.

**Implementacao**:
```csharp
public class NotificarAtualizacaoTermoCommand : Command
{
    public Guid TermoId { get; set; }
    public string Resumo { get; set; } // "Política de retenção de dados alterada"
}

public class NotificarAtualizacaoTermoCommandHandler : ICommandHandler<NotificarAtualizacaoTermoCommand>
{
    public async Task<Result> Handle(NotificarAtualizacaoTermoCommand cmd, CancellationToken ct)
    {
        var termo = await _termoRepo.GetAsync(cmd.TermoId, ct);
        var usuarios = await _userRepo.Where(u => u.Ativo).ToListAsync(ct);

        foreach (var usuario in usuarios)
        {
            // 1. E-mail
            await _emailService.EnviarAsync(new
            {
                Para = usuario.Email,
                Assunto = $"Atualização: {termo.Titulo}",
                Corpo = $"""
                Olá {usuario.Nome},

                O termo "{termo.Titulo}" foi atualizado.

                Principais mudanças:
                {cmd.Resumo}

                Para continuar usando o sistema, você deve revisar e aceitar a nova versão.

                Link: {_config["AppUrl"]}/termos/{termo.Id}/aceitar
                """,
                Html = true,
                Idioma = usuario.Idioma
            }, ct);

            // 2. In-app via SignalR
            await _notificadorHub.Clients
                .User(usuario.Id.ToString())
                .SendAsync("NovaNotificacao", new
                {
                    Id = Guid.NewGuid(),
                    Tipo = "TermoAtualizado",
                    Titulo = $"Termo atualizado: {termo.Titulo}",
                    Mensagem = cmd.Resumo,
                    Link = $"/termos/{termo.Id}/aceitar",
                    DataCriacao = DateTime.UtcNow,
                    Lido = false
                }, ct);

            // 3. SMS (se telefone cadastrado)
            if (!string.IsNullOrEmpty(usuario.Telefone))
            {
                await _smsService.EnviarAsync(
                    usuario.Telefone,
                    $"IControlIT: Termo '{termo.Titulo}' foi atualizado. Revise em {_config["AppUrl"]}/termos/{termo.Id}/aceitar",
                    ct);
            }
        }

        _audit.Log("LGPD_NOTIFICACAO_TERMO", new
        {
            TermoId = termo.Id,
            UsuariosNotificados = usuarios.Count,
            DataNotificacao = DateTime.UtcNow
        });

        return Result.Success();
    }
}
```

**Exemplos**:
- Termo atualizado às 14:00 UTC
- E-mail enviado a todas as notificações com link de revisão
- Push in-app em tempo real via SignalR
- SMS: "IControlIT: Política de privacidade foi atualizada. Revise em https://app.icontrolitapp.com/termos/123/aceitar"

---

### RN-LGPD-080-10: Multi-idioma (pt-BR, en-US, es-ES)

**Descricao**: Interface completa do módulo suporta português (Brasil), inglês (EUA) e espanhol (Espanha). Termos podem ser versionados independentemente por idioma.

**Justificativa**: LGPD Art. 5 (transparência). Usuário deve compreender termo na sua língua.

**Implementacao**:
```csharp
public class TermoAceiteMultiIdioma
{
    public Guid Id { get; set; }
    public string IdiomaOrigem { get; set; } // "pt-BR"
    public Dictionary<string, string> Titulos { get; set; } // { "pt-BR": "...", "en-US": "..." }
    public Dictionary<string, string> Conteudos { get; set; }

    public string ObterTitulo(string idioma) =>
        Titulos.TryGetValue(idioma, out var titulo)
            ? titulo
            : Titulos[IdiomaOrigem];
}

// Frontend Angular
export class TermoComponent implements OnInit {
    @Input() termoId: string;
    termo: TermoDTO;
    idiomaAtual: string; // pt-BR, en-US, es-ES

    async ngOnInit() {
        this.idiomaAtual = this.i18n.currentLanguage();
        this.termo = await this.api.get(`/api/termos/${this.termoId}?idioma=${this.idiomaAtual}`);
        this.termo.conteudo; // Conteúdo no idioma selecionado
    }
}
```

**Exemplos**:
- Usuário em navegador português → Vê termo em português
- Usuário em navegador inglês → Vê termo em inglês
- Termo pode ser atualizado independentemente em cada idioma

---

### RN-LGPD-080-11: Dashboard de Consentimentos

**Descricao**: Dashboard exibe métricas em tempo real: taxa de aceite por termo, taxa de revogação, evolução temporal, segmentação por geografia/dispositivo/navegador.

**Justificativa**: LGPD Art. 5 (responsabilização). Empresa demonstra aderência monitorando conformidade.

**Implementacao**:
```csharp
public class DashboardConsentimentoDTO
{
    public int TotalUsuarios { get; set; }
    public int UsuariosComConsentimento { get; set; }
    public double TaxaAceite => TotalUsuarios > 0
        ? (double)UsuariosComConsentimento / TotalUsuarios * 100
        : 0;

    public List<MetricaPorTermo> MetricasPorTermo { get; set; }
    public List<MetricaTemporal> EvolutaoTemporal { get; set; }
    public List<MetricaGeografia> PorGeografia { get; set; }
    public List<MetricaDispositivo> PorDispositivo { get; set; }

    public class MetricaPorTermo
    {
        public string TermoId { get; set; }
        public string TermoTitulo { get; set; }
        public int Aceitos { get; set; }
        public int Recusados { get; set; }
        public int Revogados { get; set; }
        public double TaxaAceite { get; set; }
    }
}
```

**Exemplos**:
- Dashboard exibe: "82% dos usuários aceitaram privacidade v3"
- Revogação por tipo: "Cookies: 15% revogados, Analytics: 5% revogados"
- Evolução temporal: Gráfico mostrando aumento de aceites após atualização

---

### RN-LGPD-080-12: Assinatura Digital Opcional (Certificado A1/A3)

**Descricao**: Para aceites críticos (contrato com responsabilidade financeira), usuário pode assinar digitalmente com certificado A1/A3 (eIDAS). Sistema valida assinatura e integra com AC Raiz Brasileira.

**Justificativa**: Lei 14.063/2020 (assinatura eletrônica). Aumenta segurança jurídica.

**Implementacao**:
```csharp
public class AceiteComAssinaturaDigital
{
    public Guid Id { get; set; }
    public Guid TermoId { get; set; }
    public Guid UsuarioId { get; set; }
    public DateTime DataAceite { get; set; }
    public string AssinaturaDigital { get; set; } // Assinatura PKCS#7
    public string CertificadoDigital { get; set; } // Certificado X.509
    public string NumeroCertificado { get; set; } // Serial do certificado
    public string TipoCertificado { get; set; } // "A1", "A3"
    public bool AssinaturaValida { get; set; }
    public DateTime DataValidacaoAssinatura { get; set; }
    public string FundamentoLegalAssinatura { get; set; } // Lei 14.063/2020
}

public class AssinarTermoComCertificadoCommand : Command
{
    public Guid TermoId { get; set; }
    public Guid UsuarioId { get; set; }
    public byte[] AssinaturaBytes { get; set; }
    public string CertificadoB64 { get; set; }
}

public class AssinarTermoCommandHandler : ICommandHandler<AssinarTermoComCertificadoCommand>
{
    public async Task<Result> Handle(AssinarTermoComCertificadoCommand cmd, CancellationToken ct)
    {
        // 1. Validar certificado com AC Raiz Brasileira
        var x509 = new X509Certificate2(Convert.FromBase64String(cmd.CertificadoB64));
        var validacao = await _acRaizService.ValidarCertificadoAsync(x509, ct);

        if (!validacao.Valido)
            return Result.Fail($"Certificado inválido: {validacao.Motivo}");

        // 2. Validar assinatura
        var termoDocument = await _termoRepo.GetAsync(cmd.TermoId, ct);
        var assinaturaValida = VerificarAssinatura(
            Encoding.UTF8.GetBytes(termoDocument.Conteudo),
            cmd.AssinaturaBytes,
            x509);

        if (!assinaturaValida)
            return Result.Fail("Assinatura inválida");

        // 3. Registrar aceite com assinatura
        var aceite = new AceiteComAssinaturaDigital
        {
            Id = Guid.NewGuid(),
            TermoId = cmd.TermoId,
            UsuarioId = cmd.UsuarioId,
            DataAceite = DateTime.UtcNow,
            AssinaturaDigital = Convert.ToBase64String(cmd.AssinaturaBytes),
            CertificadoDigital = cmd.CertificadoB64,
            NumeroCertificado = x509.SerialNumber,
            TipoCertificado = DeterminiarTipoCertificado(x509),
            AssinaturaValida = true,
            DataValidacaoAssinatura = DateTime.UtcNow,
            FundamentoLegalAssinatura = "Lei 14.063/2020"
        };

        await _aceiteAssinaturaRepo.AddAsync(aceite, ct);

        _audit.Log("LGPD_ACEITE_COM_ASSINATURA_DIGITAL", new
        {
            UsuarioId = cmd.UsuarioId,
            TermoId = cmd.TermoId,
            TipoCertificado = aceite.TipoCertificado,
            NumeroCertificado = aceite.NumeroCertificado,
            DataAceite = aceite.DataAceite
        });

        return Result.Success();
    }
}
```

**Exemplos**:
- Usuário aceita contrato com garantia financeira
- Sistema oferece opção "Assinar digitalmente"
- Usuário insere token A3 ou certificado A1
- Sistema valida certificado com AC Raiz Brasileira
- Registra assinatura com timestamp e serial do certificado

---

### RN-LGPD-080-13: Validação de Campos Obrigatórios

**Descricao**: Cada termo deve ter título, descrição, conteúdo, tipo e idioma obrigatórios. Sistema valida antes de salvar.

**Justificativa**: Dados consistentes para auditoria e compliance.

---

### RN-LGPD-080-14: Proteção contra XSS e Injeção em Conteúdo

**Descricao**: Conteúdo HTML de termos é sanitizado com HtmlSanitizer antes de salvar. Caracteres especiais são escapados em JSON responses.

**Justificativa**: Segurança (RFC 3986, OWASP).

---

### RN-LGPD-080-15: Retenção de Logs de Auditoria

**Descricao**: Registros de auditoria de consentimento são retenidos por 5 anos conforme LGPD Art. 7, § 5º (prazo para demonstrar conformidade).

**Justificativa**: LGPD exige demonstração de conformidade. Auditoria é prova de consentimento válido.

---

## 3. REFERENCIAS AO LEGADO

### 3.1 Banco de Dados Legado

**Banco**: `Ativvus_Login` (SQL Server 2012+)

**Tabela Principal 1**: `Si_Texto_Termo`
```sql
CREATE TABLE [dbo].[Si_Texto_Termo](
    [Pagina] [varchar](50) NOT NULL,
    [Caixa] [varchar](50) NOT NULL,
    [Texto] [varchar](8000) NOT NULL,
    CONSTRAINT [PK_Si_Texto_De_Acordo] PRIMARY KEY CLUSTERED
    (
        [Pagina] ASC,
        [Caixa] ASC
    )
)
```

**Campos Legado**:

| Campo Legado | Descricao | Uso no Modernizado |
|--------------|-----------|-------------------|
| `[Pagina]` | Identificador da página (ex: "Login", "Termo") | Será mapeado para `TermoId` + tipo enum |
| `[Caixa]` | Seção dentro da página (ex: "Aceite") | Será mapeado para `Secao` enum |
| `[Texto]` | Conteúdo HTML do termo | Será mapeado para `Conteudo` em `Termo` |

**Tabela Principal 2**: `Usuario_Envio_TermoResponsabilidade`
```sql
CREATE TABLE [dbo].[Usuario_Envio_TermoResponsabilidade](
    [Id_Usuario] [int] NOT NULL,
    [Id_Ativo] [int] NOT NULL,
    [Empresa] [varchar](50) NOT NULL,
    [DataCadastro] [datetime] NOT NULL,
    [QtdEnvios] [int] NULL,
    [DataUltEnvio] [datetime] NULL,
    [Url_Termo] [varchar](200) NULL,
    [Token] [varchar](250) NULL,
    [Token_Validade] [datetime] NULL
)
```

**Campos Legado para Modernizado**:

| Campo Legado | Descricao | Novo Campo |
|--------------|-----------|-----------|
| `[Id_Usuario]` | ID do usuário | `TermoAceite.UsuarioId` |
| `[DataCadastro]` | Quando foi enviado | `TermoAceite.DataAceite` |
| `[Url_Termo]` | Link para visualizar | `Termo.UrlBlobStorage` |
| `[Token]` | Token de validação | `AceiteToken.Valor` |
| `[Token_Validade]` | Quando expire token | `AceiteToken.DataExpiracao` |

**Novas Tabelas no Modernizado** (PostgreSQL):

```sql
-- Tabela de termos
CREATE TABLE termos (
    id UUID PRIMARY KEY,
    titulo VARCHAR(255) NOT NULL,
    descricao TEXT,
    tipo VARCHAR(50) NOT NULL, -- 'Uso', 'Privacidade', 'Cookies', 'Compartilhamento'
    conteudo TEXT NOT NULL, -- Sanitizado com HtmlSanitizer
    versao INT NOT NULL DEFAULT 1,
    idioma_origem VARCHAR(10) NOT NULL DEFAULT 'pt-BR', -- pt-BR, en-US, es-ES
    politica_corporativa_id UUID REFERENCES politicas_corporativas(id), -- FK para RF079
    ativo BOOLEAN NOT NULL DEFAULT TRUE,
    data_criacao TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    data_atualizacao TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    criado_por UUID NOT NULL REFERENCES usuarios(id),
    atualizado_por UUID NOT NULL REFERENCES usuarios(id)
);

-- Tabela de versões de termos
CREATE TABLE termo_versoes (
    id UUID PRIMARY KEY,
    termo_id UUID NOT NULL REFERENCES termos(id),
    numero INT NOT NULL,
    conteudo TEXT NOT NULL,
    diff_anterior TEXT, -- JSON com mudanças
    data_criacao TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    criado_por UUID NOT NULL REFERENCES usuarios(id)
);

-- Tabela de aceites
CREATE TABLE termo_aceites (
    id UUID PRIMARY KEY,
    usuario_id UUID NOT NULL REFERENCES usuarios(id),
    termo_id UUID NOT NULL REFERENCES termos(id),
    versao_termo INT NOT NULL,
    data_aceite TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ip_origem INET NOT NULL,
    user_agent VARCHAR(500),
    navegador VARCHAR(100),
    sistema_operacional VARCHAR(100),
    geolocalizacao VARCHAR(255),
    sessao_id UUID NOT NULL,
    hash_documento VARCHAR(64), -- SHA256
    assinatura_digital BYTEA,
    certificado_digital TEXT,
    numero_certificado VARCHAR(50),
    tipo_certificado VARCHAR(10), -- 'A1', 'A3'
    assinatura_valida BOOLEAN,
    data_validacao_assinatura TIMESTAMP
);

-- Tabela de consentimentos
CREATE TABLE consentimentos_usuario (
    id UUID PRIMARY KEY,
    usuario_id UUID NOT NULL REFERENCES usuarios(id),
    tipo VARCHAR(50) NOT NULL, -- 'Marketing', 'Analytics', 'Cookies', 'Compartilhamento'
    concedido BOOLEAN NOT NULL,
    fundamento_legal VARCHAR(50), -- 'Consentimento', 'Contrato', 'Interesse Legítimo', 'Obrigação Legal', 'Interesse Vital'
    data_consentimento TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ip_origem INET,
    user_agent VARCHAR(500),
    termo_referencia_id UUID REFERENCES termos(id),
    data_revogacao TIMESTAMP,
    ip_revogacao INET,
    motivo_revogacao TEXT
);

-- Tabela de auditoria de consentimentos
CREATE TABLE auditoria_consentimentos (
    id UUID PRIMARY KEY,
    usuario_id UUID NOT NULL REFERENCES usuarios(id),
    acao VARCHAR(20) NOT NULL, -- 'ACEITO', 'REVOGADO', 'ATUALIZADO'
    data_acao TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ip_origem INET,
    user_agent VARCHAR(500),
    navegador VARCHAR(100),
    sistema_operacional VARCHAR(100),
    termo_id UUID NOT NULL REFERENCES termos(id),
    versao_termo INT NOT NULL,
    consentimentos_concedidos TEXT[], -- Array de tipos
    consentimentos_recusados TEXT[],
    fundamento_legal VARCHAR(50),
    sessao_id UUID,
    geolocalizacao VARCHAR(255),
    validacao_duplo_opt_in BOOLEAN,
    hash_documento VARCHAR(64)
);
```

### 3.2 Stored Procedures Legado

Não há SPs específicas de termos no legado. Sistema legado usa tabelas diretamente com UPDATE/INSERT simples.

**Migracao**: Implementar toda lógica em C# (Domain-Driven Design) no modernizado.

### 3.3 Telas ASPX Legado

| Pagina | Descricao | Tela Moderna |
|--------|-----------|--------------|
| `Login.aspx` | Exibe termo de responsabilidade antes de login | `/auth/login-com-termo` (Angular) |
| `frmConfiguracao.aspx` | Administração manual de texto de termo | `/admin/termos` (CRUD completo) |

### 3.4 WebServices Legado (VB.NET)

**Arquivo**: `D:\IC2\ic1_legado\WebService\WSSeguranca.asmx.vb` (não encontrado, mas seria análogo)

| Metodo | Descricao | Endpoint Moderno |
|--------|-----------|-----------------|
| `ObterTextoPagina(pagina, caixa)` | Retorna texto de termo | `GET /api/termos/{id}/conteudo` |
| `SalvarTextoTermoEdit(pagina, caixa, texto)` | Salva alteração de termo | `PUT /api/termos/{id}` |

---

## 4. INTEGRACOES OBRIGATORIAS

### 4.1 Central de Funcionalidades (Feature Flags)

**FeatureKey**: `LGPD_TERMOS_ACEITE`

**Configuracao**:
```json
{
    "featureKey": "LGPD_TERMOS_ACEITE",
    "nome": "Gestão de Termos de Aceite e LGPD",
    "descricao": "Versionamento de termos, aceite obrigatório, consentimentos granulares, auditoria completa",
    "habilitado": true,
    "isSystemFeature": true,
    "modulo": "Governanca",
    "rf": "RF080",
    "dependencias": [
        "AUTH_USUARIO",
        "AUDIT_COMPLETO",
        "EMAIL_SERVICE",
        "SIGNALR_NOTIFICACOES"
    ]
}
```

**Nota**: Feature é crítica e sempre ativada em produção (Lei LGPD obriga). Pode ser desativada apenas em ambiente de desenvolvimento isolado.

### 4.2 Internacionalizacao (i18n)

**Chaves de Traducao** (3 idiomas: pt-BR, en-US, es-ES):

```json
{
    "lgpd": {
        "termos": {
            "title": "Termos de Aceite e Consentimentos",
            "form": {
                "titulo": "Título",
                "descricao": "Descrição",
                "tipo": "Tipo de Termo",
                "conteudo": "Conteúdo",
                "versao": "Versão",
                "idioma": "Idioma",
                "politicaCorportativa": "Política Corporativa",
                "ativo": "Ativo"
            },
            "messages": {
                "termoAtualizado": "Termo atualizado com sucesso",
                "termoNaoAceito": "Você deve aceitar os termos para continuar",
                "consentimentoConcedido": "Consentimento concedido",
                "consentimentoRevogado": "Consentimento revogado com sucesso",
                "portalidadeSolicitada": "Sua solicitação de portabilidade foi registrada. Você receberá os dados em até 15 dias úteis",
                "erroValidacao": "Erro na validação do formulário"
            },
            "consentimentos": {
                "marketing": "Permito receber ofertas e comunicações comerciais por e-mail",
                "analytics": "Permito análise de comportamento para melhorias do serviço",
                "cookies": "Permito rastreamento com cookies para publicidade personalizada",
                "compartilhamento": "Permito compartilhamento de dados com parceiros"
            },
            "botoes": {
                "aceitar": "Aceitar",
                "recusar": "Recusar",
                "revogar": "Revogar Consentimento",
                "exportarDados": "Exportar meus dados",
                "anonimizar": "Solicitar anonimização",
                "revisar": "Revisar Termo",
                "salvar": "Salvar",
                "cancelar": "Cancelar"
            },
            "dashboard": {
                "titulo": "Dashboard de Consentimentos",
                "totalUsuarios": "Total de Usuários",
                "taxaAceite": "Taxa de Aceite",
                "porTermo": "Por Termo",
                "porDispositivo": "Por Dispositivo",
                "porGeografia": "Por Geografia",
                "evolucaoTemporal": "Evolução Temporal"
            }
        }
    }
}
```

### 4.3 Auditoria

**Operacoes Auditadas**:

| Operacao | Codigo | Dados Registrados |
|----------|--------|-------------------|
| Criar termo | `LGPD_TERMO_CRIAR` | TermoId, Titulo, Tipo, VersaoInicial, CriadoPor, IP |
| Atualizar termo | `LGPD_TERMO_ATUALIZAR` | TermoId, VersaoAnterior, VersaoNova, Diferenças, ImpactoUsuarios, AtualizadoPor |
| Aceitar termo | `LGPD_TERMO_ACEITO` | UsuarioId, TermoId, VersaoTermo, DataAceite, IpOrigem, UserAgent, SessaoId |
| Revogar consentimento | `LGPD_CONSENTIMENTO_REVOGADO` | UsuarioId, TipoConsentimento, DataRevogacao, IpRevogacao, Motivo |
| Exportar dados | `LGPD_EXPORTACAO_DADOS` | UsuarioId, Formato, Registros, DataExportacao |
| Anonimizar | `LGPD_ANONIMIZACAO` | UsuarioId, Motivo, RegistrosMascados, DataAnonimizacao |

**Retencao**: 5 anos (conforme LGPD Art. 7, § 5º - prazo para demonstrar conformidade)

### 4.4 Controle de Acesso (RBAC)

**Permissoes**:

| Permissao | Descricao | Perfis |
|-----------|-----------|--------|
| `lgpd:termos:read` | Visualizar termos | Usuário, Admin, DPO |
| `lgpd:termos:create` | Criar novo termo | Admin, DPO |
| `lgpd:termos:update` | Editar termo | Admin, DPO |
| `lgpd:termos:delete` | Excluir termo | Admin |
| `lgpd:consentimentos:read` | Visualizar consentimentos próprios | Usuário, Admin, DPO |
| `lgpd:consentimentos:manage` | Gerir consentimentos de usuários | Admin, DPO |
| `lgpd:dashboard:read` | Acessar dashboard de conformidade | Admin, DPO, Compliance |
| `lgpd:auditoria:read` | Visualizar logs de auditoria | Admin, DPO, Compliance, Auditor |
| `lgpd:portabilidade:request` | Solicitar exportação de dados | Usuário |
| `lgpd:anonimizacao:request` | Solicitar anonimização | Usuário |

**Nota**: Usuário pode sempre visualizar e gerenciar seus próprios consentimentos (direito LGPD). DPO (Data Protection Officer) e Admin têm acesso completo. Auditores têm acesso read-only.

---

## 5. ENDPOINTS DA API

### 5.1 CRUD Principal de Termos

| Metodo | Endpoint | Descricao | Permissao |
|--------|----------|-----------|-----------|
| GET | `/api/termos` | Listar todos os termos | `lgpd:termos:read` |
| GET | `/api/termos/{id}` | Obter termo por ID | `lgpd:termos:read` |
| POST | `/api/termos` | Criar novo termo | `lgpd:termos:create` |
| PUT | `/api/termos/{id}` | Atualizar termo | `lgpd:termos:update` |
| DELETE | `/api/termos/{id}` | Excluir termo | `lgpd:termos:delete` |

### 5.2 Operacoes Especiais

| Metodo | Endpoint | Descricao | Permissao |
|--------|----------|-----------|-----------|
| POST | `/api/termos/{id}/aceitar` | Aceitar termo por usuário autenticado | `lgpd:consentimentos:read` |
| GET | `/api/termos/{id}/versoes` | Listar histórico de versões | `lgpd:termos:read` |
| GET | `/api/termos/{id}/versoes/{numero}/diff` | Comparar versão atual com anterior | `lgpd:termos:read` |
| POST | `/api/consentimentos` | Gravar consentimentos granulares | `lgpd:consentimentos:read` |
| POST | `/api/consentimentos/{tipo}/revogar` | Revogar consentimento específico | `lgpd:consentimentos:read` |
| POST | `/api/dados-pessoais/exportar` | Solicitar portabilidade de dados | `lgpd:portabilidade:request` |
| POST | `/api/dados-pessoais/anonimizar` | Solicitar anonimização | `lgpd:anonimizacao:request` |
| GET | `/api/dashboard/consentimentos` | Dashboard de métricas | `lgpd:dashboard:read` |
| GET | `/api/auditoria/consentimentos` | Logs de auditoria | `lgpd:auditoria:read` |

---

## 6. FLUXOS PRINCIPAIS

### 6.1 Fluxo de Primeiro Acesso com Aceite Obrigatório

```
Usuário faz login
    |
    v
Middleware verifica aceite vigente
    |
    +--- (Termo vigente não encontrado ou já aceito) ---> Acesso Concedido
    |
    v (Termo vigente NÃO aceito)
Exibir overlay bloqueante com termo
    |
    v
Usuário lê termo
    |
    +--- (Usuário clica "Recusar") ---> Logout automático, redirecionado para página de despedida
    |
    v (Usuário clica "Aceitar")
Enviar POST /api/termos/{id}/aceitar com consentimentos granulares
    |
    v
Backend valida aceite, registra em auditoria
    |
    v
Registra em termos_aceites com IP, User-Agent, timestamp, hash do documento
    |
    v
Enviar notificação SignalR: "Aceite registrado"
    |
    v
Acesso Concedido ao sistema
```

### 6.2 Fluxo de Revogação de Consentimento

```
Usuário acessa Privacy Center (/account/privacy)
    |
    v
Exibir lista de consentimentos atuais com botões "Revogar"
    |
    v
Usuário clica "Revogar" em "Cookies"
    |
    v
Exibir confirmação: "Tem certeza? Você perderá acesso a publicidade personalizada"
    |
    v (Usuário confirma)
Enviar POST /api/consentimentos/Cookies/revogar
    |
    v
Backend registra revogação com timestamp, IP, motivo
    |
    v
Acionador: Se MarketingConsent revogado, agendar anonimização de dados de campanha
    |
    v
Auditoria: Log LGPD_CONSENTIMENTO_REVOGADO
    |
    v
Resposta: { success: true, message: "Consentimento revogado com sucesso" }
    |
    v
Frontend exibe feedback: "Cookies desativados. Publicidade personalizada não será exibida."
```

### 6.3 Fluxo de Exportação de Dados (Portabilidade)

```
Usuário clica "Exportar meus dados" em Privacy Center
    |
    v
Exibir formulário: [Selecionar formato: JSON / CSV / XML]
    |
    v (Usuário seleciona JSON e clica "Exportar")
Enviar POST /api/dados-pessoais/exportar { formato: "json" }
    |
    v
Backend coleta dados de:
  - Usuario (perfil)
  - TermoAceites (histórico de aceites com IP, timestamp, versão)
  - ConsentimentosUsuario (consentimentos com data/hora, revogações)
  - AuditoriaConsentimentos (ações de consentimento)
  - Transacoes do usuário (últimas 1000)
    |
    v
Serializar em JSON estruturado
    |
    v
Gerar arquivo: dados-pessoais-2025-12-28T14-35-00Z.json
    |
    v
Salvar em Azure Blob Storage (link temporário 7 dias)
    |
    v
Auditoria: LGPD_EXPORTACAO_DADOS registrada
    |
    v
Enviar e-mail ao usuário com link de download
    |
    v
Frontend exibe: "Seus dados foram preparados. Link de download enviado por e-mail. Válido por 7 dias."
```

### 6.4 Fluxo de Atualização de Termo

```
Administrador (DPO) acessa /admin/termos/{id}/editar
    |
    v
Exibir form com campo de descrição de mudanças
    |
    v
Usuário altera conteúdo e clica "Salvar"
    |
    v
Enviar PUT /api/termos/{id} com novo conteúdo
    |
    v
Backend detecta mudança de conteúdo
    |
    v
Criar nova TermoVersao (v2) automaticamente
    |
    v
Registrar diff: showdown.js gera HTML com <del> e <ins> tags
    |
    v
Marcar todos os usuários como "requer re-aceite"
    |
    v
Auditoria: LGPD_TERMO_ATUALIZADO
    |
    v
Disparar comando assíncrono: NotificarAtualizacaoTermoCommand
    |
    v
Enviar e-mail a todos os usuários: "Termo foi atualizado. Principais mudanças: ..."
    |
    v
Enviar notificação in-app via SignalR
    |
    v
Usuários veem badge vermelha: "Novo término requer aceite"
    |
    v
Middleware começa a bloquear usuários que não aceitem nova versão
```

### 6.5 Fluxo de Anonimização Automática

```
Usuário revoga consentimento de Marketing
    |
    v (RN-LGPD-080-04 acionada)
Sistema registra revogação
    |
    v
Disparar comando assíncrono: AnonimizarDadosCommand
    |
    v
Identificar dados pessoais associados ao consentimento revogado:
  - E-mail do usuário para marketing
  - Histórico de campanhas de e-mail
  - IP/User-Agent para rastreamento de cliques
    |
    v
Calcular hash anônimo: SHA256(userId + salt)
    |
    v
Substituir dados:
  - Nome → "Anonimo_a3f2c1d8"
  - Email → NULL
  - Histórico de campanhas → remover
  - Registros de cliques → anonimizar com hash
    |
    v
Marcar usuário como is_anonimizado = true
    |
    v
Auditoria: LGPD_ANONIMIZACAO com motivo "RevogacaoMarketing"
    |
    v
Dados anônimos podem ser usados em relatórios estatísticos sem problema LGPD
```

---

## 7. SEGURANCA

### 7.1 Protecoes Implementadas

| Protecao | Descricao |
|----------|-----------|
| **SQL Injection** | Uso de parameterized queries (Entity Framework Core). Dados de entrada sanitizados antes de store em BD. |
| **XSS (Cross-Site Scripting)** | Conteúdo HTML sanitizado com HtmlSanitizer. Caracteres especiais escapados em JSON responses. CRLF injection prevenido. |
| **CSRF (Cross-Site Request Forgery)** | Tokens anti-CSRF em todas as requisições POST/PUT/DELETE. Validação de origem (Origin header). SameSite=Strict em cookies. |
| **Injeção de Comando OS** | Sem execução de comandos do SO. Imports bloqueados. |
| **Anonimização Irreversível** | Hash SHA256 + salt do usuário. Dados originais descartados após anonimização. |
| **Retenção de Auditoria** | Logs não deletáveis por 5 anos. Write-once storage (Azure Blob Immutable). |
| **Criptografia em Trânsito** | TLS 1.3 obrigatório. Certificados X.509 válidos. |
| **Criptografia em Repouso** | PostgreSQL com TDE (Transparent Data Encryption). Azure Storage Encryption. |
| **Validação de Integridade** | Hash SHA256 do documento armazenado. Verificação de integridade antes de aceite. |
| **Rate Limiting** | Máximo 10 aceites por minuto por IP. Máximo 5 solicitações de exportação por dia. |
| **Auditoria de Certificados Digitais** | Validação com AC Raiz Brasileira. Verificação de revogação em CRL. |
| **Proteção de Dados Sensíveis** | Máscaras em logs: CPF exibido como XXX.XXX.XXX-XX. E-mail como ***@domain.com. |

### 7.2 Testes de Seguranca Obrigatorios

- [x] SQL Injection em campos de entrada (titulo, conteudo, motivo)
- [x] XSS em conteúdo HTML de termos (sanitização com HtmlSanitizer)
- [x] CSRF Protection em POST/PUT/DELETE (anti-CSRF tokens)
- [x] Validacao de permissoes (RBAC: lgpd:termos:read, etc)
- [x] Anonimização irreversível (dados anônimos não podem ser revertidos)
- [x] Retenção de auditoria por 5 anos (Write-once storage)
- [x] Criptografia TLS 1.3 em trânsito
- [x] Validação de integridade de documentos (SHA256)
- [x] Rate limiting (10 aceites/min, 5 exportações/dia)
- [x] Validação de certificados digitais (AC Raiz Brasileira)

---

## 8. METRICAS E INDICADORES

### 8.1 KPIs

| KPI | Meta | Medicao | Frequencia |
|-----|------|---------|-----------|
| Taxa de Aceite | >= 95% | (Usuários que aceitaram / Total de usuários) * 100 | Diária |
| Taxa de Revogação | <= 5% | (Consentimentos revogados / Total de consentimentos) * 100 | Semanal |
| Tempo Médio Aceite | <= 2 minutos | Média de (DataAceite - DataExibicaoTermo) | Semanal |
| Taxa de Re-aceite | >= 80% | (Usuários que re-aceitaram / Usuários notificados) * 100 | Por atualização |
| Conformidade LGPD | 100% | Checklist: auditoria 5 anos, consentimento granular, revogação, portabilidade, anonimização | Mensal |
| Tempo de Resposta API | <= 500ms | P95 de latência dos endpoints | Diária |
| Disponibilidade | >= 99.9% | (Tempo disponível / Tempo total) * 100 | Semanal |
| Taxa de Exportação Sucesso | >= 99% | (Exportações bem-sucedidas / Total solicitações) * 100 | Semanal |

### 8.2 Alertas

| Alerta | Condicao | Acao |
|--------|----------|------|
| Taxa de Aceite Crítica | < 50% em 24 horas | Notificar DPO e Admin. Investigar causa. Considerar prorrogar prazo. |
| Revogação em Massa | > 20% revogação em 24 horas | Notificar DPO. Analisar mudança recente. Comunicar com usuários. |
| Auditoria Não Registrada | Falta de registro por 1 hora | Alerta CRÍTICO. Investigar imediatamente. Pode invalidar conformidade LGPD. |
| Certificado Digital Inválido | Falha na validação com AC Raiz | Bloquear aceite com assinatura. Alertar usuário de problema técnico. |
| API Indisponível | >= 3 falhas consecutivas | Paging automático para on-call engineer. Failover para réplica. |
| Armazenamento Auditoria Cheio | >= 90% capacity | Provisionar storage adicional. Alertar ops. |

---

## 9. PROXIMOS PASSOS

1. **Modelo de Dados**: Criar [MD-080](./MD-080-Gestao-Termos-Aceite-LGPD.md) com DDL completo PostgreSQL, índices, constraints
2. **Casos de Uso**: Criar [UC-080](./UC-080-Gestao-Termos-Aceite-LGPD.md) com 5+ casos de uso principais
3. **Workflows**: Criar [WF-080](./WF-080-Gestao-Termos-Aceite-LGPD.md) com fluxos detalhados e componentes Angular
4. **User Stories**: Criar [user-stories.yaml](./user-stories.yaml) com 5+ user stories e acceptance criteria
5. **Implementacao Backend**: Commands, Queries, Handlers, Repositories, Services
6. **Implementacao Frontend**: Componentes Angular (CRUD, Privacy Center, Dashboard), formulários, validações
7. **Testes**: Unit tests (xUnit), Integration tests, E2E tests (Playwright)
8. **Deploy**: Migrations, Seeds, Documentação de operação

---

## CHANGELOG

| Versao | Data | Descricao | Autor |
|--------|------|-----------|-------|
| 1.0 | 2025-12-28 | Versao inicial - Compliance LGPD completo | Claude Code |

---

**Ultima Atualizacao**: 2025-12-28
**Autor**: Claude Code
**Revisao**: Pendente de Aprovacao
**Status**: Rascunho - Aguardando aprovacao DPO
