# RF-081: Termos de Responsabilidade por Ativos e Equipamentos

**Versão**: 1.0 | **Data**: 2025-12-28
**RF Relacionado**: RF-027 (Gestão de Aditivos Contratos), RF-024 (Gestão de Ativos), RF-080 (LGPD) | **EPIC**: EPIC008-SD-Service-Desk
**Fase**: Fase 5 - Service Desk e Governança

---

## 1. RESUMO EXECUTIVO

### 1.1 Descrição Geral

Este requisito especifica o módulo de **Gestão de Termos de Responsabilidade por Ativos e Equipamentos** do sistema IControlIT, responsável por:

- Criação e versionamento de termos de responsabilidade customizados por tipo de ativo (notebooks, telefones, badges, ferramentas, etc.)
- Captura de aceite obrigatório no momento da entrega do equipamento ao usuário
- Registro imutável de aceite com assinatura digital (touch/mouse/stylus), data, hora, IP, localização GPS e foto de comprovante
- Versionamento de termos com rastreabilidade histórica (compatível com LGPD e auditorias SOX)
- Notificações inteligentes de vencimento, devolvução, penalidades
- Revogação de termo (quando equipamento é devolvido ou perdido)
- Dashboard de aceites pendentes, vencidos, ativos por usuário/departamento/empresa
- Exportação de comprovante de aceite em PDF com QRCode para rastreabilidade
- Integração com workflows de movimentação de ativos (RF-027)
- Suporte multi-idioma (pt-BR, en-US, es-ES) e multi-tenancy (ClienteId obrigatório)

**Objetivo Estratégico**: Garantir que 100% dos ativos entregues sejam formalmente aceitos por seus responsáveis, criando prova legal de custódia para proteção patrimonial, conformidade com LGPD (rastreamento de quem assinou o quê e quando) e eficiência operacional na gestão de devoluções e penalidades.

---

### 1.2 Importância Estratégica

O módulo de Gestão de Termos de Responsabilidade é crítico para:

- **Proteção Patrimonial**: Documentar formalmente a transferência de custódia de ativos, criando prova legal de quem é responsável por cada equipamento
- **Conformidade LGPD**: Rastrear quem aceitou quais termos, quando, com qual dados pessoais, em qual contexto (auditoria completa)
- **Conformidade SOX**: Documentar controles internos sobre ativos corporativos com rastreabilidade total para auditorias
- **Eficiência Operacional**: Automatizar fluxo manual de entrega de ativos (hoje: impressão + assinatura em papel + arquivo = lentidão + perda de documentos)
- **Gestão de Riscos**: Identificar equipamentos sem aceite (não saído do almoxarifado) vs. equipamentos com aceite (já em poder do usuário)
- **Recuperação de Ativos**: Rastrear quem tem qual equipamento para facilitar recuperação, transferência ou suporte
- **Análise de Custo**: Calcular custo de reposição para equipamentos perdidos/danificados (seguro, indenização, etc.)
- **Dashboard Executivo**: Visibilidade em tempo real de aceites pendentes, taxa de devolução, dias em atraso

**Impacto de Negócio**:
- Redução de 85% no tempo de entrega de ativos (de 2-3 horas para 20 minutos)
- Recuperação de 15-20% de ativos "perdidos" via rastreamento (valor médio R$500k/ano em empresas médias)
- Zero multas LGPD relacionadas a rastreamento inadequado de dados pessoais (potencial economia: R$50M em multas)
- Documentação completa para auditorias SOX/ISO (economia: 40h/ano em busca de documentação manual)

---

### 1.3 Conceitos Fundamentais

**Termo de Responsabilidade (TR)**: Documento formal que transfere custódia de um ativo (equipamento) de uma entidade jurídica para uma pessoa natural, especificando:
- Identificação do ativo (modelo, série, código patrimonial)
- Responsabilidades do portador (cuidados, manutenção, devolução, penalidades)
- Período de vigência (data início/fim esperado)
- Condições especiais por tipo de ativo

**Aceite de Termo (ou Assinatura de Termo)**: Ato formal onde o usuário concorda em ser responsável pelo ativo, capturando:
- Identificação do usuário (CPF, matrícula, email)
- Timestamp (data/hora exato no servidor em UTC)
- Geolocalização (IP, localização GPS se permitido)
- Dispositivo (User-Agent, tipo de assinatura: touch/mouse/stylus)
- Biométrica opcional (captura de rosto/foto para comprovação)
- Versão do termo aceito (versionamento imutável)

**Vigência de Termo**: Período durante o qual o aceite permanece válido:
- Início: data/hora do aceite
- Fim: data esperada de devolução (calculada automaticamente por tipo de ativo ou definida manualmente)
- Status: Ativo, Vencido, Revogado, Pendente de Aceite

**Penalidades de Retenção**: Cálculo automático de multa por retenção de ativo além do prazo:
- Tipo 1: Multa fixa (ex: R$100 por dia de atraso)
- Tipo 2: Multa progressiva (ex: R$50 para 1-5 dias, R$100 para 6-10 dias, etc.)
- Tipo 3: Custo de reposição (preço de mercado do equipamento novo)

**Comprovante de Aceite**: Documento PDF gerado automaticamente com:
- QRCode (código de barras 2D com link para verificação de autenticidade)
- Dados do termo aceito
- Assinatura digital (imagem rasterizada)
- Hash SHA-256 para verificação de integridade
- Data/hora em ISO 8601 e RFC 3339

---

### 1.4 Legado vs Modernizado

| Aspecto | Legado (VB.NET) | Modernizado (.NET 10 + Angular) |
|---------|-----------------|--------------------------------|
| **Armazenamento de Termos** | Si_Texto_Termo (SQL Server, sem versionamento) | PostgreSQL com auditoria temporal e versionamento automático |
| **Captura de Aceite** | Formulário Web simples (sem assinatura) | SignaturePad (touch/mouse) + captura GPS + foto comprovante |
| **Identificação de Usuário** | Login simples (sem validação) | CPF/matrícula obrigatória com integração BrasilAPI |
| **Timestamp** | Gerado no servidor (fuso local) | UTC com sincronização NTP para precisão forense |
| **Geolocalização** | Não suportado | GPS (móvel) + IP geolocation (fallback) com consentimento LGPD |
| **Versionamento de Termo** | Manual (sobrescrevia anterior) | Automático com histórico completo (temporal tables) |
| **Assinatura Digital** | Não suportado | Certificado A1/A3 eIDAS (opcional para contratos críticos) |
| **Notificações** | Email simples | SignalR (real-time) + Email + SMS + Push Notification |
| **Comprovante** | PDF manual gerado em Word | PDF automático com QRCode + verificação de integridade |
| **Dashboard** | Relatório SSRS estático | Dashboard Angular em tempo real (D3.js) com filtros |
| **Multi-idioma** | Hardcoded em português | i18n com 3 idiomas (pt-BR, en-US, es-ES) |
| **Conformidade LGPD** | Não auditado | Auditoria completa com direito a portabilidade e revogação |

---

### 1.5 Funcionalidades Principais

1. **CRUD de Termos de Responsabilidade**: Criar, ler, atualizar, versionar termos específicos por tipo de ativo (notebooks, telefones, badges, ferramentas, etc.)

2. **Versionamento Automático com Auditoria**: Cada alteração gera nova versão com changelog, autor, data, diff visual entre versões

3. **Captura de Aceite com Assinatura Digital**: Integração SignaturePad para captura de assinatura (touch/mouse/stylus) com imagem rasterizada PNG

4. **Validação de Identidade Obrigatória**: Integração BrasilAPI para validação de CPF em tempo real, verificação de matrícula corporativa

5. **Geolocalização e Contexto**: Captura automática de IP + GPS (se autorizado) + User-Agent + tipo de dispositivo no momento do aceite

6. **Notificações Inteligentes**: Alertas automáticos 30/15/7 dias antes do vencimento + SMS de confirmação + email com comprovante

7. **Revogação de Termo**: Quando equipamento é devolvido/perdido, revoga termo com registro de motivo e data de encerramento

8. **Comprovante PDF com QRCode**: Geração automática de PDF com assinatura digital, QRCode único, timestamp, dados do equipamento para impressão/email

9. **Dashboard de Aceites**: Filtros por usuário/departamento/empresa/status (Pendente/Ativo/Vencido/Revogado) com métricas (taxa aceite, tempo médio, equipamentos com atraso)

10. **Integração com Movimentação de Ativos**: Webhook automático quando ativo é entregue para gerar termo pendente de aceite

11. **Cálculo de Penalidades**: Multa automática por retenção de equipamento além do prazo (configurável por tipo de ativo)

12. **Exportação de Comprovante**: Download PDF + envio automático por email + armazenamento em Azure Blob Storage

13. **Auditoria LGPD Completa**: Rastreamento de quem aceitou, quando, qual versão, com qual dados pessoais (CPF, matrícula, email)

14. **Busca e Filtros Avançados**: Pesquisa por código patrimonial, nome do usuário, status, tipo de ativo, período, departamento

15. **Suporte Multi-idioma e Multi-tenancy**: Interface em 3 idiomas, isolamento completo por ClienteId obrigatório

---

## 2. REGRAS DE NEGÓCIO

### RN-TRM-081-01: Tipos de Ativos e Termos Customizados

**Descrição**: Sistema DEVE suportar no mínimo 12 tipos de ativos diferentes, cada um com termo de responsabilidade customizado contendo campos, penalidades e vigência específica.

**Justificativa**: Diferentes tipos de equipamentos têm diferentes riscos, responsabilidades e períodos de vigência. Termo genérico não captura nuances de cada tipo.

**Implementação**:
```csharp
public class TipoAtivoEntity
{
    public Guid Id { get; set; }
    public string Nome { get; set; } // "Notebook", "Telefone", "Badge", etc.
    public string Descricao { get; set; }
    public Guid ClienteId { get; set; } // Multi-tenancy obrigatório

    public int DiasVigenciaDefault { get; set; } // Dias até devolução esperada
    public decimal PenaldidaDiariaRetenção { get; set; } // R$ por dia após vencimento
    public decimal ValorReposiçãoMédio { get; set; } // Para cálculo de multa
    public bool RequerAssinaturaDigital { get; set; } // Crítico (certificado A3)?
    public bool RequerFoto { get; set; } // Capturar foto do equipamento
    public bool RequerGPS { get; set; } // Localização no aceite

    public TermoResponsabilidadeEntity TermoAtivo { get; set; } // Versão vigente
    public ICollection<TermoResponsabilidadeEntity> HistoricoTermos { get; set; }
}

// 12 tipos suportados
var tipos = new[] {
    "Notebook", "Telefone", "Badge/Cartão", "Monitor",
    "Mouse/Teclado", "Webcam/Headset", "Estação Acoplável",
    "Projetor", "Roteador/Modem", "Tablet/iPad",
    "Unidade Armazenamento (SSD/HDD)", "Ferramentas/Equipamentos"
};
```

**Exemplos**:
- Tipo: Notebook → vigência 1095 dias (3 anos) → penalidade R$50/dia → requer foto e GPS
- Tipo: Telefone → vigência 730 dias (2 anos) → penalidade R$30/dia → requer assinatura digital (crítico)
- Tipo: Badge → vigência 365 dias (1 ano) → penalidade R$10/dia → sem foto, com GPS obrigatório

---

### RN-TRM-081-02: Validação de Identidade no Aceite - CPF/Matrícula Obrigatória

**Descrição**: Antes de capturar aceite, sistema DEVE validar identidade do usuário verificando CPF (via BrasilAPI) ou matrícula corporativa contra base de dados de RH.

**Justificativa**: Garantir que a pessoa que está assinando é realmente a responsável pelo ativo (prevenção de fraude, falsificação, error de entraga a pessoa errada).

**Implementação**:
```csharp
public interface IValidadorIdentidadeService
{
    Task<Result<UsuarioValidadoDto>> ValidarCPFAsync(string cpf);
    Task<Result<UsuarioValidadoDto>> ValidarMatriculaAsync(string matricula, Guid clienteId);
}

public class ValidadorIdentidadeService : IValidadorIdentidadeService
{
    private readonly IBrasilApiClient _brasilApi;
    private readonly IUsuarioRepository _usuarioRepo;

    public async Task<Result<UsuarioValidadoDto>> ValidarCPFAsync(string cpf)
    {
        // Sanitizar entrada (remover máscara)
        cpf = cpf.Replace(".", "").Replace("-", "");

        if (!cpf.IsValidCPF())
            return Result.Failure("CPF_INVALIDO");

        // Consultar BrasilAPI em tempo real
        var validacao = await _brasilApi.ValidarCPFAsync(cpf);
        if (!validacao.IsValid)
            return Result.Failure("CPF_NAO_ENCONTRADO");

        // Correlacionar com usuário no sistema
        var usuario = await _usuarioRepo.FindByCPFAsync(cpf);
        if (usuario == null)
            return Result.Failure("CPF_NAO_CADASTRADO_SISTEMA");

        return Result.Success(new UsuarioValidadoDto
        {
            Id = usuario.Id,
            Nome = usuario.Nome,
            CPF = cpf,
            Email = usuario.Email,
            Departamento = usuario.Departamento
        });
    }

    public async Task<Result<UsuarioValidadoDto>> ValidarMatriculaAsync(
        string matricula, Guid clienteId)
    {
        var usuario = await _usuarioRepo.FindByMatriculaAsync(matricula, clienteId);
        if (usuario == null)
            return Result.Failure("MATRICULA_NAO_ENCONTRADA");

        // Validar se matrícula está ativa no RH (chamada integrada)
        var statusRH = await _sistemaRHClient.VerificarStatusAsync(matricula);
        if (statusRH != "Ativo")
            return Result.Failure("USUARIO_INATIVO_RH");

        return Result.Success(new UsuarioValidadoDto
        {
            Id = usuario.Id,
            Nome = usuario.Nome,
            Matricula = matricula,
            Email = usuario.Email,
            Departamento = usuario.Departamento
        });
    }
}
```

**Exemplos**:
- ✅ CPF válido e cadastrado no sistema → permite prosseguir para assinatura
- ❌ CPF válido mas NÃO cadastrado → rejeita com mensagem "Cadastre-se antes de aceitar termo"
- ❌ Matrícula inativa no RH → rejeita com mensagem "Usuário inativo, contacte RH"

---

### RN-TRM-081-03: Captura de Assinatura Digital com Timestamp UTC e Geolocalização

**Descrição**: Aceite DEVE capturar assinatura rasterizada (PNG) via SignaturePad (touch/mouse/stylus), timestamp exato em UTC com sincronização NTP, geolocalização (IP + GPS se autorizado), User-Agent do navegador.

**Justificativa**: Prova forense de que a assinatura foi feita em data/hora/local específicos por pessoa específica. Timestamp UTC garante sincronização com auditorias internacionais (SOX, LGPD).

**Implementação**:
```csharp
public class AceiteTermoCommand : Command
{
    public Guid TermoResponsabilidadeId { get; set; }
    public Guid UsuarioId { get; set; }
    public Guid AtivoId { get; set; }

    // Assinatura digital
    public string AssinaturaBase64PNG { get; set; } // Imagem rasterizada (max 1MB)

    // Timestamp
    public DateTime TimestampUTC { get; set; } // Servidor (não confia no cliente)

    // Geolocalização
    public string IPAddress { get; set; } // Extraído automaticamente do HttpContext
    public double? Latitude { get; set; } // GPS (opcional, se autorizado)
    public double? Longitude { get; set; }

    // Contexto
    public string UserAgent { get; set; } // Navegador, OS, dispositivo
    public string TipoAssinatura { get; set; } // "Touch", "Mouse", "Stylus"
}

public class AceiteTermoCommandHandler : ICommandHandler<AceiteTermoCommand, Result>
{
    private readonly ITermoRepository _termoRepo;
    private readonly IAceiteRepository _aceiteRepo;
    private readonly INTPTimeProvider _ntpTime;
    private readonly IGeolocationService _geoLocation;
    private readonly ILogger<AceiteTermoCommandHandler> _logger;

    public async Task<Result> Handle(AceiteTermoCommand cmd, CancellationToken ct)
    {
        // Validação 1: Termo existe e está vigente
        var termo = await _termoRepo.GetAsync(cmd.TermoResponsabilidadeId, ct);
        if (termo?.Status != TermoStatus.Vigente)
            return Result.Failure("TERMO_NAO_VIGENTE");

        // Validação 2: Usuário ainda não aceita este termo
        var aceiteExistente = await _aceiteRepo.FindByUsuarioTermoAsync(
            cmd.UsuarioId, cmd.TermoResponsabilidadeId, ct);
        if (aceiteExistente != null)
            return Result.Failure("TERMO_JA_ACEITO");

        // Validação 3: Assinatura não está em branco
        if (string.IsNullOrWhiteSpace(cmd.AssinaturaBase64PNG) || cmd.AssinaturaBase64PNG.Length < 10000)
            return Result.Failure("ASSINATURA_INVALIDA");

        // Geolocalização (IP é capturado automaticamente)
        string? localizacaoIP = null;
        if (!string.IsNullOrEmpty(cmd.IPAddress))
        {
            var geoIP = await _geoLocation.LookupAsync(cmd.IPAddress);
            localizacaoIP = geoIP?.Cidade;
        }

        // Criar registro de aceite com timestamp UTC sincronizado
        var aceiteTermo = new AceiteTermoEntity
        {
            Id = Guid.NewGuid(),
            TermoResponsabilidadeId = cmd.TermoResponsabilidadeId,
            UsuarioId = cmd.UsuarioId,
            AtivoId = cmd.AtivoId,
            ClienteId = termo.ClienteId,

            // Assinatura
            AssinaturaPNG = Convert.FromBase64String(cmd.AssinaturaBase64PNG),
            HashSHA256Assinatura = ComputeSHA256(cmd.AssinaturaBase64PNG),

            // Timestamp (servidor, não cliente!)
            DataHoraAceiteUTC = await _ntpTime.GetUtcNowAsync(), // Sincronizado com NTP

            // Geolocalização
            IPAddress = cmd.IPAddress,
            Latitude = cmd.Latitude,
            Longitude = cmd.Longitude,
            LocalizacaoIP = localizacaoIP,
            ConsentimentoGPS = cmd.Latitude.HasValue,

            // Contexto
            UserAgent = cmd.UserAgent,
            TipoAssinatura = cmd.TipoAssinatura,
            VersaoTermoAceito = termo.Versao,

            // Status
            Status = AceiteStatus.Aceito,
            DataUltimaAtualizacao = await _ntpTime.GetUtcNowAsync(),
            UsuarioCriacaoId = cmd.UsuarioId
        };

        await _aceiteRepo.AddAsync(aceiteTermo, ct);
        await _aceiteRepo.SaveChangesAsync(ct);

        // Log de auditoria (LGPD)
        _logger.LogInformation(
            "Termo aceito: Usuario={UsuarioId}, Termo={TermoId}, IP={IP}, " +
            "Timestamp={Timestamp}, GPS={HasGPS}",
            cmd.UsuarioId, cmd.TermoResponsabilidadeId, cmd.IPAddress,
            aceiteTermo.DataHoraAceiteUTC, cmd.Latitude.HasValue);

        return Result.Success();
    }

    private string ComputeSHA256(string data)
    {
        using var sha = System.Security.Cryptography.SHA256.Create();
        var hash = sha.ComputeHash(System.Text.Encoding.UTF8.GetBytes(data));
        return Convert.ToHexString(hash);
    }
}
```

**Exemplos**:
- ✅ Timestamp: 2025-12-28T14:32:45.123Z (UTC sincronizado) → auditável e forense
- ✅ Geolocalização: IP 201.43.12.45 → São Paulo, GPS 23.5505°S, 46.6333°W → rastreável
- ❌ Assinatura em branco ou muito pequena → rejeita com mensagem "Assine novamente"

---

### RN-TRM-081-04: Versionamento Automático de Termos com Histórico Imutável

**Descrição**: Quando conteúdo de um termo é alterado, sistema cria automaticamente nova versão com histórico completo e changelog detalhado. Versões anteriores são imutáveis (append-only).

**Justificativa**: Garantir rastreabilidade histórica para LGPD (qual versão cada usuário aceitou) e auditorias (quando/por quem termo foi atualizado).

**Implementação**:
```csharp
public class TermoResponsabilidadeEntity
{
    public Guid Id { get; set; }
    public Guid TipoAtivoId { get; set; }
    public Guid ClienteId { get; set; }

    public string Titulo { get; set; }
    public string Conteudo { get; set; } // Versão atual
    public int Versao { get; set; } // 1, 2, 3, ...
    public string Status { get; set; } // "Rascunho", "Vigente", "Obsoleto"

    public DateTime DataCriacao { get; set; }
    public Guid UsuarioCriacaoId { get; set; }
    public DateTime? DataVigencia { get; set; } // Quando termo começar a valer

    public ICollection<TermoVersaoEntity> Versoes { get; set; } // Histórico
    public ICollection<AceiteTermoEntity> Aceites { get; set; } // Quem aceitou
}

public class TermoVersaoEntity
{
    public Guid Id { get; set; }
    public Guid TermoResponsabilidadeId { get; set; }
    public int Numero { get; set; }

    public string Titulo { get; set; }
    public string Conteudo { get; set; } // Snapshot imutável da versão
    public string ConteudoAnterior { get; set; } // Para comparação (opcional)

    public string Changelog { get; set; } // "Alterado prazo de 1095 para 730 dias", etc.
    public DateTime DataCriacao { get; set; }
    public Guid UsuarioCriacaoId { get; set; }
    public string MotivoBanco { get; set; } // "Alteração solicitada por Jurídico", etc.
}

public class AtualizarTermoResponsabilidadeCommandHandler : ICommandHandler<AtualizarTermoResponsabilidadeCommand>
{
    public async Task Handle(AtualizarTermoResponsabilidadeCommand cmd, CancellationToken ct)
    {
        var termo = await _repo.GetAsync(cmd.TermoId, ct);

        // Se conteúdo mudou, cria nova versão
        if (termo.Conteudo != cmd.ConteudoNovo)
        {
            // Backup da versão atual
            var versaoAnterior = new TermoVersaoEntity
            {
                Id = Guid.NewGuid(),
                TermoResponsabilidadeId = termo.Id,
                Numero = termo.Versao,
                Titulo = termo.Titulo,
                Conteudo = termo.Conteudo,
                ConteudoAnterior = termo.Versoes.LastOrDefault()?.Conteudo,
                Changelog = cmd.Changelog,
                DataCriacao = DateTime.UtcNow,
                UsuarioCriacaoId = cmd.UsuarioId,
                MotivoBanco = cmd.MotivoBanco
            };

            termo.Versoes.Add(versaoAnterior);

            // Atualiza versão atual
            termo.Versao++;
            termo.Conteudo = cmd.ConteudoNovo;
            termo.Titulo = cmd.TituloNovo;
            termo.DataUltimaAtualizacao = DateTime.UtcNow;
            termo.UsuarioUltimaAtualizacao = cmd.UsuarioId;

            // Marca termo como "Vigente" se era "Rascunho"
            if (termo.Status == TermoStatus.Rascunho)
                termo.Status = TermoStatus.Vigente;

            await _repo.UpdateAsync(termo, ct);

            // Notificar usuários que não aceitaram nova versão
            var usuariosComVersaoAnterior = await _aceiteRepo
                .FindByTermoVersionAsync(termo.Id, termo.Versao - 1, ct);

            foreach (var usuario in usuariosComVersaoAnterior)
            {
                await _notificationService.EnviarRe_aceiteRequiredAsync(
                    usuario.UsuarioId, termo.Id, termo.Versao, ct);
            }
        }
    }
}
```

**Exemplos**:
- V1 (2025-01-15): "Termo de Notebook" → prazo 1095 dias, penalidade R$50/dia
- V2 (2025-06-20): Changelog: "Reduzido prazo para 730 dias por política de renovação" → autor: Gestor de TI, data: 2025-06-20
- V3 (2025-12-01): Changelog: "Aumentada penalidade para R$75/dia por aumento de custo de reposição" → autor: CFO

---

### RN-TRM-081-05: Aceite Obrigatório - Bloqueio de Acesso sem Termo Vigente Assinado

**Descrição**: Usuário que recebeu equipamento novo ou cujo termo está vencido NÃO pode acessar certos módulos do sistema até aceitar termo vigente. Sistema exibe modal bloqueante.

**Justificativa**: Conformidade legal (documentação de custódia), proteção patrimonial (rastreamento de quem tem qual ativo).

**Implementação**:
```csharp
public class VerificarAceiteTermoMiddleware
{
    public async Task InvokeAsync(HttpContext context, IAceiteTermoService aceiteService)
    {
        var usuarioId = context.User.FindFirst("sub")?.Value;
        var clienteId = context.User.FindFirst("cliente_id")?.Value;

        if (string.IsNullOrEmpty(usuarioId) || string.IsNullOrEmpty(clienteId))
        {
            await _next(context);
            return;
        }

        // Verificar se há termos pendentes de aceite ou vencidos
        var termosComStatus = await aceiteService
            .VerificarTermosPendentesAsync(Guid.Parse(usuarioId), Guid.Parse(clienteId));

        if (termosComStatus.TemTermoPendente || termosComStatus.TemTermoVencido)
        {
            // Retornar erro 403 com dados do termo para modal no frontend
            context.Response.StatusCode = 403;
            await context.Response.WriteAsJsonAsync(new
            {
                tipo = "TERMO_REQUER_ACEITE",
                mensagem = termosComStatus.TemTermoPendente
                    ? "Você recebeu novo equipamento. Aceite o termo de responsabilidade para continuar."
                    : "Seu termo de responsabilidade expirou. Renove o aceite.",
                termosIds = termosComStatus.TermosIds, // IDs dos termos pendentes
                urlModal = "/modal/aceitar-termo", // Rota do modal
                bloqueiaAcesso = true // Impede navegação
            });
            return;
        }

        await _next(context);
    }
}
```

**Exemplos**:
- ✅ Usuário aceita novo notebook → acesso permitido
- ❌ Usuário com notebook mas sem aceitar termo → bloqueado, vê modal "Aceite o termo de responsabilidade"
- ❌ Termo vencido (equipamento deveria estar devolvido) → bloqueado, vê modal "Renove o aceite ou devolva equipamento"

---

### RN-TRM-081-06: Notificações Inteligentes - Alertas de Vencimento e Devolução

**Descrição**: Sistema DEVE gerar notificações automáticas (email, SMS, in-app via SignalR) com 30, 15 e 7 dias antes do vencimento do termo. Campos: equipamento, usuário responsável, dias restantes, penalidades acumuladas.

**Justificativa**: Lembrar usuário para devolver equipamento no prazo, evitando penalidades e atraso.

**Implementação**:
```csharp
public class GenerarNotificacoesVencimentoJob : IJob
{
    private readonly IAceiteTermoRepository _aceiteRepo;
    private readonly INotificationService _notificationService;
    private readonly ILogger<GenerarNotificacoesVencimentoJob> _logger;

    // Executar diariamente (Hangfire Job)
    [RecurringJob("*/1 * * * *")] // A cada minuto (ajustar conforme necessário)
    public async Task ExecuteAsync()
    {
        var hoje = DateTime.UtcNow.Date;

        // Encontrar aceites que vencerão em 7, 15, 30 dias
        var diasAvisos = new[] { 7, 15, 30 };

        foreach (var dias in diasAvisos)
        {
            var dataLimite = hoje.AddDays(dias);
            var aceitesVencendo = await _aceiteRepo
                .FindByDataVencimentoAsync(dataLimite, dataLimite);

            foreach (var aceite in aceitesVencendo)
            {
                var ativo = await _ativoRepo.GetAsync(aceite.AtivoId);
                var usuario = await _usuarioRepo.GetAsync(aceite.UsuarioId);

                // Calcular penalidade acumulada se não devolver no prazo
                var penalidaldeProjetada = CalcularPenalidade(ativo, dias);

                var notificacao = new NotificacaoEntity
                {
                    Id = Guid.NewGuid(),
                    UsuarioId = usuario.Id,
                    Tipo = "VENCIMENTO_TERMO",
                    Titulo = $"Equipamento {ativo.Modelo} vence em {dias} dias",
                    Corpo = $"Código: {ativo.CodigoPatrimonial}\n" +
                            $"Usuário: {usuario.Nome}\n" +
                            $"Vencimento: {aceite.DataVencimento:dd/MM/yyyy}\n" +
                            $"Penalidade se atraso: R$ {penalidaldeProjetada:F2}/dia",
                    DataCriacao = DateTime.UtcNow,
                    Link = $"/ativos/{ativo.Id}/devolucao",
                    Lida = false
                };

                await _notificationService.EnviarAsync(notificacao);

                // Enviar também por email e SMS
                await _emailService.EnviarAvisoVencimentoAsync(usuario.Email, notificacao);
                await _smsService.EnviarAvisoVencimentoAsync(usuario.Telefone, dias);
            }
        }
    }

    private decimal CalcularPenalidade(AtivoEntity ativo, int diasAtraso)
    {
        // Penalidade progressiva
        if (diasAtraso <= 5)
            return diasAtraso * ativo.TipoAtivo.PenaldidaDiariaRetenção;
        else if (diasAtraso <= 10)
            return diasAtraso * ativo.TipoAtivo.PenaldidaDiariaRetenção * 1.5m;
        else
            return diasAtraso * ativo.TipoAtivo.PenaldidaDiariaRetenção * 2.0m; // Multa dobrada
    }
}
```

**Exemplos**:
- 30 dias antes: "Notebook ThinkPad (PAT-2024-0123) vence em 30 dias. Prepare devolução."
- 7 dias antes: "URGENTE: Equipamento PAT-2024-0123 vence em 7 dias. Penalidade: R$350/dia de atraso."
- Vencido: "ATRASO: Equipamento PAT-2024-0123 venceu. Penalidade atual: R$2.450. Devolva imediatamente."

---

### RN-TRM-081-07: Cálculo de Penalidades por Retenção de Ativo Além do Prazo

**Descrição**: Quando termo vence e ativo não é devolvido, sistema calcula automaticamente multa de retenção com opções de: (A) multa fixa diária, (B) multa progressiva (aumenta a cada X dias), (C) custo de reposição integral.

**Justificativa**: Incentivar devolução no prazo, proteger empresa contra perda patrimonial.

**Implementação**:
```csharp
public class CalculadorPenuldadeService
{
    public decimal CalcularPenalidade(
        AceiteTermoEntity aceite,
        AtivoEntity ativo,
        DateTime dataAtual)
    {
        // Se ainda não venceu, penalidade é zero
        if (dataAtual <= aceite.DataVencimento)
            return 0m;

        var diasAtraso = (int)(dataAtual - aceite.DataVencimento).TotalDays;
        if (diasAtraso <= 0)
            return 0m;

        return ativo.TipoAtivo.TipoPenalidade switch
        {
            TipoPenalidade.FixaDiaria =>
                diasAtraso * ativo.TipoAtivo.PenaldidaDiariaRetenção,

            TipoPenalidade.Progressiva =>
                CalcularProgressiva(diasAtraso, ativo.TipoAtivo.PenaldidaDiariaRetenção),

            TipoPenalidade.CustoReposicao =>
                // Após 30 dias de atraso, multa se torna custo de reposição integral
                diasAtraso >= 30
                    ? ativo.TipoAtivo.ValorReposiçãoMédio
                    : diasAtraso * ativo.TipoAtivo.PenaldidaDiariaRetenção,

            _ => 0m
        };
    }

    private decimal CalcularProgressiva(int diasAtraso, decimal penaldidaDiaria)
    {
        // Escala: R$50/dia para 1-5 dias, R$75/dia para 6-10 dias, R$100/dia para 10+
        if (diasAtraso <= 5)
            return diasAtraso * penaldidaDiaria;
        else if (diasAtraso <= 10)
            return (5 * penaldidaDiaria) + ((diasAtraso - 5) * penaldidaDiaria * 1.5m);
        else
            return (5 * penaldidaDiaria) + (5 * penaldidaDiaria * 1.5m) +
                   ((diasAtraso - 10) * penaldidaDiaria * 2.0m);
    }
}

// Uso em comando de devolução
public class DevolverAtivoCommand : Command
{
    public Guid AceiteTermoId { get; set; }
    public DateTime DataDevolucaoEfetiva { get; set; }
    public string MotivoDevolucao { get; set; } // "Normal", "Danificado", "Perdido"
}

public class DevolverAtivoCommandHandler : ICommandHandler<DevolverAtivoCommand>
{
    public async Task Handle(DevolverAtivoCommand cmd, CancellationToken ct)
    {
        var aceite = await _aceiteRepo.GetAsync(cmd.AceiteTermoId, ct);
        var ativo = await _ativoRepo.GetAsync(aceite.AtivoId, ct);

        // Calcular penalidade se atraso
        var penalidade = _penuldadeService.CalcularPenalidade(
            aceite, ativo, cmd.DataDevolucaoEfetiva);

        // Revogar aceite
        aceite.Status = AceiteStatus.Revogado;
        aceite.DataRevogacao = DateTime.UtcNow;
        aceite.MotivoBanco = cmd.MotivoDevolucao;
        aceite.PenuldadeAcumulada = penalidade;

        // Marcar ativo como devolvido
        ativo.Status = AtivoStatus.Devolvido;
        ativo.DataDevolucao = cmd.DataDevolucaoEfetiva;
        ativo.EmprestimoAtivo = null; // Desvincula do empréstimo

        await _aceiteRepo.UpdateAsync(aceite, ct);
        await _ativoRepo.UpdateAsync(ativo, ct);

        // Registrar penalidade em tabela de cobranças
        if (penalidade > 0)
        {
            var cobranca = new CobrancaPenuldadeEntity
            {
                Id = Guid.NewGuid(),
                AceiteTermoId = aceite.Id,
                UsuarioId = aceite.UsuarioId,
                Valor = penalidade,
                DataGeracao = DateTime.UtcNow,
                Status = "Pendente",
                Descricao = $"Retenção de {ativo.Modelo} ({ativo.CodigoPatrimonial}): " +
                            $"{(cmd.DataDevolucaoEfetiva - aceite.DataVencimento).TotalDays:F0} dias de atraso"
            };

            await _cobrancaRepo.AddAsync(cobranca, ct);
        }

        await _aceiteRepo.SaveChangesAsync(ct);
    }
}
```

**Exemplos**:
- Notebook vencido há 5 dias: R$250 (5 dias × R$50/dia)
- Notebook vencido há 10 dias: R$537,50 (5 dias × R$50 + 5 dias × R$75)
- Notebook vencido há 45 dias: Custo de reposição (R$4.500) aplicado após 30 dias

---

### RN-TRM-081-08: Revogação de Termo - Encerramento Formal com Documentação de Motivo

**Descrição**: Quando equipamento é devolvido ou perdido, termo é revogado automaticamente com registro imutável de data, motivo, e quem revogou. Gera documento PDF de encerramento.

**Justificativa**: Conformidade LGPD (fim da custódia = fim do processamento de dados do equipamento), rastreabilidade patrimonial.

**Implementação**:
```csharp
public class RevogarTermoResponsabilidadeCommand : Command
{
    public Guid AceiteTermoId { get; set; }
    public MotivoRevogacao Motivo { get; set; } // "Devolucao", "Perda", "Roubo", "Aposentadoria", "Troca"
    public string Observacoes { get; set; } // "Equipamento danificado no canto superior esquerdo", etc.
    public Guid UsuarioRevogadorId { get; set; } // Quem está revogando (Gestor, Almoxarife, etc.)
}

public enum MotivoRevogacao
{
    Devolucao = 0,
    Perda = 1,
    Roubo = 2,
    Aposentadoria = 3,
    Troca = 4,
    Outro = 5
}

public class RevogarTermoCommandHandler : ICommandHandler<RevogarTermoResponsabilidadeCommand>
{
    public async Task Handle(RevogarTermoResponsabilidadeCommand cmd, CancellationToken ct)
    {
        var aceite = await _aceiteRepo.GetAsync(cmd.AceiteTermoId, ct);

        // Validar se aceite ainda está vigente
        if (aceite.Status != AceiteStatus.Aceito && aceite.Status != AceiteStatus.Vencido)
            return Result.Failure("ACEITE_JA_REVOGADO");

        // Registrar revogação (append-only)
        var revogacao = new RevogacaoTermoEntity
        {
            Id = Guid.NewGuid(),
            AceiteTermoId = aceite.Id,
            TermoResponsabilidadeId = aceite.TermoResponsabilidadeId,
            UsuarioResponsavelId = aceite.UsuarioId, // Quem recebeu o equipamento
            UsuarioRevogadorId = cmd.UsuarioRevogadorId, // Quem está revogando
            DataRevogacao = DateTime.UtcNow,
            Motivo = cmd.Motivo,
            Observacoes = cmd.Observacoes
        };

        // Atualizar aceite
        aceite.Status = AceiteStatus.Revogado;
        aceite.DataRevogacao = DateTime.UtcNow;
        aceite.MotivoBanco = cmd.Motivo.ToString();

        await _revogacaoRepo.AddAsync(revogacao, ct);
        await _aceiteRepo.UpdateAsync(aceite, ct);

        // Gerar PDF de encerramento
        var documentoPDF = await _documentService.GerarPDFEncerrramentoAsync(
            aceite, revogacao);

        // Armazenar em Blob Storage
        await _blobService.UploadAsync(
            $"termos/revogacao/{aceite.Id}_{DateTime.UtcNow:yyyyMMdd}.pdf",
            documentoPDF,
            ct);

        // Notificar usuário e gestor
        await _notificationService.EnviarRevogacaoAsync(aceite.UsuarioId, revogacao, ct);

        return Result.Success();
    }
}
```

**Exemplos**:
- Motivo: Devolução → PDF com data/hora/assinatura de quem recebeu
- Motivo: Perda → PDF com observação "Equipamento perdido em ônibus", data da perda, penalidade calculada
- Motivo: Troca → PDF referenciando novo equipamento/novo termo

---

### RN-TRM-081-09: Dashboard com Filtros e Métricas de Aceites

**Descrição**: Dashboard exibe métricas em tempo real: total de aceites (Pendente, Ativo, Vencido, Revogado), taxa de aceite (%), tempo médio para aceitar, equipamentos em atraso, penalidades acumuladas. Filtros por usuário, departamento, tipo de ativo, período.

**Justificativa**: Visibilidade gerencial para gestores de TI acompanharem gestão de ativos.

**Implementação**:
```csharp
public class DashboardAceitesQuery : Query<DashboardAceitesDto>
{
    public Guid ClienteId { get; set; }
    public DateTime? DataInicio { get; set; }
    public DateTime? DataFim { get; set; }
    public Guid? DepartamentoId { get; set; }
    public Guid? TipoAtivoId { get; set; }
    public Guid? UsuarioId { get; set; }
}

public class DashboardAceitesDto
{
    public MetricasGeraisDto MetricasGerais { get; set; }
    public IEnumerable<MetricasPorStatusDto> PorStatus { get; set; }
    public IEnumerable<MetricasPorDepartamentoDto> PorDepartamento { get; set; }
    public IEnumerable<MetricasPorTipoAtivoDto> PorTipoAtivo { get; set; }
    public IEnumerable<AceiteAtrasadoDto> AceitesAtrasados { get; set; }
}

public class MetricasGeraisDto
{
    public int TotalAceites { get; set; }
    public int AceitesPendentes { get; set; }
    public int AceitesAtivos { get; set; }
    public int AceitesVencidos { get; set; }
    public int AceitesRevogados { get; set; }
    public decimal TaxaAceite { get; set; } // %
    public decimal PenuldadeAcumulada { get; set; } // R$
    public int DiasAtrasoMedio { get; set; }
}

public class AceiteAtrasadoDto
{
    public Guid AceiteId { get; set; }
    public string NomeUsuario { get; set; }
    public string Departamento { get; set; }
    public string CodigoPatrimonial { get; set; }
    public string Modelo { get; set; }
    public DateTime DataVencimento { get; set; }
    public int DiasAtraso { get; set; }
    public decimal PenaldideDiaria { get; set; }
    public decimal PenuldadeAcumulada { get; set; }
}
```

**Exemplos**:
- Métrica: Total de Aceites = 1.234 (956 Ativos + 150 Vencidos + 100 Pendentes + 28 Revogados)
- Taxa Aceite: 95,2% (956 ativos / 1004 total entregues)
- Equipamentos em Atraso: 150 (vencidos) gerando penalidade total R$127.450
- Por Departamento: TI (234 aceites), RH (156), Financeiro (89), etc.

---

### RN-TRM-081-10: Exportação de Comprovante em PDF com QRCode

**Descrição**: Após aceitar termo, sistema gera automaticamente PDF com QRCode (código de barras 2D) único que permite verificar autenticidade e integridade da assinatura online. PDF inclui: dados pessoal, equipamento, assinatura rasterizada, hash SHA-256, timestamp.

**Justificativa**: Prova física para arquivo do usuário, rastreabilidade (QRCode escaneia em portal público).

**Implementação**:
```csharp
public class GerarComprovanteAceiteService
{
    private readonly IQRCodeGenerator _qrGenerator;
    private readonly IEmailService _emailService;
    private readonly IBlobStorageService _blobService;

    public async Task<byte[]> GerarPDFComprovanteAsync(
        AceiteTermoEntity aceite,
        TermoResponsabilidadeEntity termo,
        UsuarioEntity usuario,
        AtivoEntity ativo)
    {
        var documento = new Document();
        var writer = new PdfWriter(new MemoryStream());
        var pdf = new PdfDocument(writer);
        var doc = new Document(pdf);

        // Cabeçalho
        doc.Add(new Paragraph("COMPROVANTE DE ACEITE DE TERMO DE RESPONSABILIDADE")
            .SetBold()
            .SetFontSize(14)
            .SetTextAlignment(TextAlignment.CENTER));

        doc.Add(new Paragraph($"Data de Emissão: {DateTime.UtcNow:dd/MM/yyyy HH:mm:ss}")
            .SetFontSize(10));

        // Seção 1: Dados Pessoais
        var tableDados = new Table(2);
        tableDados.AddCell(new Cell().Add(new Paragraph("Nome do Responsável").SetBold()));
        tableDados.AddCell(new Cell().Add(new Paragraph(usuario.Nome)));
        tableDados.AddCell(new Cell().Add(new Paragraph("CPF").SetBold()));
        tableDados.AddCell(new Cell().Add(new Paragraph(usuario.CPF.MaskCPF())));
        tableDados.AddCell(new Cell().Add(new Paragraph("Matrícula").SetBold()));
        tableDados.AddCell(new Cell().Add(new Paragraph(usuario.Matricula)));
        tableDados.AddCell(new Cell().Add(new Paragraph("Departamento").SetBold()));
        tableDados.AddCell(new Cell().Add(new Paragraph(usuario.Departamento)));
        doc.Add(tableDados);

        // Seção 2: Dados do Equipamento
        doc.Add(new Paragraph("\nDados do Equipamento").SetBold().SetFontSize(12));
        var tableAtivo = new Table(2);
        tableAtivo.AddCell(new Cell().Add(new Paragraph("Tipo").SetBold()));
        tableAtivo.AddCell(new Cell().Add(new Paragraph(ativo.TipoAtivo.Nome)));
        tableAtivo.AddCell(new Cell().Add(new Paragraph("Código Patrimonial").SetBold()));
        tableAtivo.AddCell(new Cell().Add(new Paragraph(ativo.CodigoPatrimonial)));
        tableAtivo.AddCell(new Cell().Add(new Paragraph("Modelo/Série").SetBold()));
        tableAtivo.AddCell(new Cell().Add(new Paragraph($"{ativo.Modelo} - {ativo.NumeroSerie}")));
        tableAtivo.AddCell(new Cell().Add(new Paragraph("Data de Aceite").SetBold()));
        tableAtivo.AddCell(new Cell().Add(new Paragraph(aceite.DataHoraAceiteUTC.ToString("dd/MM/yyyy HH:mm:ss (UTC)"))));
        doc.Add(tableAtivo);

        // Seção 3: Assinatura Digital
        doc.Add(new Paragraph("\nAssinatura Digital").SetBold().SetFontSize(12));
        if (aceite.AssinaturaPNG != null && aceite.AssinaturaPNG.Length > 0)
        {
            var img = new Image(ImageDataFactory.Create(aceite.AssinaturaPNG));
            img.SetWidth(150).SetHeight(50);
            doc.Add(img);
        }

        // Seção 4: QRCode para Verificação
        doc.Add(new Paragraph("\nCódigo de Verificação (QRCode)").SetBold().SetFontSize(12));
        var qrData = $"https://ic2.empresa.com.br/verificar-aceite/{aceite.Id}";
        var qrCodeImage = _qrGenerator.GenerateQRCode(qrData);
        doc.Add(new Image(ImageDataFactory.Create(qrCodeImage))
            .SetWidth(100)
            .SetHeight(100));

        // Seção 5: Hash de Integridade
        doc.Add(new Paragraph("\nHash de Integridade (SHA-256)").SetBold().SetFontSize(10));
        doc.Add(new Paragraph(aceite.HashSHA256Assinatura)
            .SetFont(PdfFonts.COURIER)
            .SetFontSize(8));

        // Seção 6: Dados Técnicos (para auditoria)
        doc.Add(new Paragraph("\nDados Técnicos de Auditoria").SetBold().SetFontSize(10));
        var tableTecnica = new Table(2);
        tableTecnica.AddCell(new Cell().Add(new Paragraph("IP de Aceite").SetBold()));
        tableTecnica.AddCell(new Cell().Add(new Paragraph(aceite.IPAddress)));
        tableTecnica.AddCell(new Cell().Add(new Paragraph("Localização").SetBold()));
        tableTecnica.AddCell(new Cell().Add(new Paragraph(aceite.LocalizacaoIP ?? "N/A")));
        if (aceite.Latitude.HasValue && aceite.Longitude.HasValue)
        {
            tableTecnica.AddCell(new Cell().Add(new Paragraph("GPS").SetBold()));
            tableTecnica.AddCell(new Cell().Add(new Paragraph(
                $"{aceite.Latitude:F6}, {aceite.Longitude:F6}")));
        }
        tableTecnica.AddCell(new Cell().Add(new Paragraph("Dispositivo").SetBold()));
        tableTecnica.AddCell(new Cell().Add(new Paragraph(aceite.UserAgent)));
        doc.Add(tableTecnica);

        doc.Close();

        return writer.GetStream().ToArray();
    }

    public async Task<Result> EnviarComprovanteAsync(
        AceiteTermoEntity aceite,
        byte[] pdf,
        CancellationToken ct)
    {
        // Enviar por email
        var usuario = await _usuarioRepo.GetAsync(aceite.UsuarioId, ct);

        await _emailService.EnviarAsync(new EmailMessage
        {
            Para = usuario.Email,
            Assunto = $"Comprovante de Aceite - Equipamento {aceite.Ativo.Modelo}",
            Corpo = $"Prezado(a) {usuario.Nome},\n\n" +
                    $"Segue em anexo o comprovante de aceite de responsabilidade.\n\n" +
                    $"Equipamento: {aceite.Ativo.CodigoPatrimonial}\n" +
                    $"Data: {aceite.DataHoraAceiteUTC:dd/MM/yyyy HH:mm:ss}\n\n" +
                    $"Guarde este comprovante para sua proteção.",
            Anexos = new[] { pdf }
        }, ct);

        // Armazenar em Blob Storage
        await _blobService.UploadAsync(
            $"termos/comprovantes/{aceite.Id}_{DateTime.UtcNow:yyyyMMddHHmmss}.pdf",
            pdf, ct);

        return Result.Success();
    }
}
```

**Exemplo de PDF gerado**:
```
╔════════════════════════════════════════════════════════╗
║  COMPROVANTE DE ACEITE DE TERMO DE RESPONSABILIDADE   ║
║  Data: 28/12/2025 14:32:45                            ║
╚════════════════════════════════════════════════════════╝

DADOS PESSOAIS:
  Nome: João Silva
  CPF: 123.456.789-00
  Matrícula: TI-2024-001234
  Departamento: Tecnologia da Informação

DADOS DO EQUIPAMENTO:
  Tipo: Notebook
  Código Patrimonial: PAT-2024-0123
  Modelo/Série: ThinkPad X1 Carbon - SN12345
  Data Aceite: 28/12/2025 14:32:45 (UTC)

ASSINATURA DIGITAL:
  [IMAGEM DA ASSINATURA]

QRCode de Verificação:
  [QRCode escaneável]
  https://ic2.empresa.com.br/verificar-aceite/8a5c9...

Hash SHA-256: e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855

DADOS TÉCNICOS:
  IP de Aceite: 201.43.12.45
  Localização: São Paulo, SP
  GPS: 23.5505°S, 46.6333°W
  Dispositivo: Mozilla/5.0 (Windows NT 10.0)...
```

---

### RN-TRM-081-11: Integração com RF-027 (Movimentação de Ativos) - Webhook Automático

**Descrição**: Quando ativo é transferido para novo usuário via RF-027, webhook automático dispara criação de novo termo pendente de aceite. Sistema notifica novo responsável.

**Justificativa**: Fluxo seamless - não quebra continuidade de trabalho.

**Implementação**:
```csharp
[HttpPost("/webhooks/rf027/ativo-transferido")]
public async Task<IActionResult> OnAtivoTransferidoAsync(
    [FromBody] AtivoTransferidoWebhookDto evento,
    [FromServices] IAceiteTermoService aceiteService)
{
    // Evento disparado por RF-027 quando ativo é transferido
    var aceite = new AceiteTermoEntity
    {
        Id = Guid.NewGuid(),
        AtivoId = evento.AtivoId,
        UsuarioNovoId = evento.UsuarioNovoId,
        TermoResponsabilidadeId = evento.TipoAtivo.TermoResponsabilidadeIdVigente,
        Status = AceiteStatus.PendenteDePendence, // Aguardando aceite do novo usuário
        DataCriacaoPendente = DateTime.UtcNow,
        ClienteId = evento.ClienteId
    };

    await aceiteService.AddAsync(aceite);

    // Notificar novo usuário
    await aceiteService.NotificarAceitePendnteAsync(
        evento.UsuarioNovoId,
        evento.AtivoId);

    return Ok();
}
```

---

### RN-TRM-081-12: Suporte Multi-idioma e Multi-tenancy

**Descrição**: Interface e termos de responsabilidade devem ser traduzidos para português, inglês e espanhol (i18n). Isolamento completo por ClienteId (cada cliente tem seus próprios termos customizados).

**Justificativa**: Compliance com multinacionais, isolamento de dados por segurança.

**Exemplo**:
```json
{
  "termos": {
    "pt-BR": {
      "titulo": "Termo de Responsabilidade",
      "aceitar": "Aceitar",
      "rejeitar": "Recusar",
      "confirmacao": "Você aceita ser responsável por este equipamento?"
    },
    "en-US": {
      "titulo": "Equipment Responsibility Agreement",
      "aceitar": "Accept",
      "rejeitar": "Decline",
      "confirmacao": "Do you accept responsibility for this equipment?"
    },
    "es-ES": {
      "titulo": "Acuerdo de Responsabilidad del Equipo",
      "aceitar": "Aceptar",
      "rejeitar": "Rechazar",
      "confirmacao": "¿Acepta ser responsable de este equipo?"
    }
  }
}
```

---

## 3. REFERÊNCIAS AO LEGADO

### 3.1 Banco de Dados Legado

**Banco**: `[ic1_legado]` (SQL Server)

**Tabelas Principais**:

```sql
-- Termos de Responsabilidade (legado simples)
CREATE TABLE [dbo].[Si_Texto_Termo](
    [Id_Texto_Termo] [int] IDENTITY(1,1) NOT NULL,
    [Ds_Titulo] [varchar](255) NOT NULL,
    [Ds_Termo] [nvarchar](max) NOT NULL,
    [Dt_Criacao] [datetime] NOT NULL,
    [Ativo] [bit] NOT NULL DEFAULT 1,
    CONSTRAINT [PK_Si_Texto_Termo] PRIMARY KEY CLUSTERED ([Id_Texto_Termo] ASC)
);

-- Aceites de usuários (legado - mínimo de informações)
CREATE TABLE [dbo].[Usuario_Envio_TermoResponsabilidade](
    [Id_Usuario_Envio_Termo] [int] IDENTITY(1,1) NOT NULL,
    [Id_Usuario] [int] NOT NULL,
    [Id_Texto_Termo] [int] NOT NULL,
    [Dt_Envio] [datetime] NOT NULL,
    [Flg_Lido] [bit] NOT NULL DEFAULT 0,
    [Dt_Leitura] [datetime] NULL,
    [Flg_Aceito] [bit] NOT NULL DEFAULT 0,
    [Dt_Aceito] [datetime] NULL,
    CONSTRAINT [PK_Usuario_Envio_TermoResponsabilidade] PRIMARY KEY CLUSTERED ([Id_Usuario_Envio_Termo] ASC)
);
```

**Campos Importantes**:

| Campo Legado | Descrição | Uso no Modernizado |
|--------------|-----------|-------------------|
| `Si_Texto_Termo` | Armazena texto do termo (sem versionamento) | Migrar para `TermoResponsabilidade` com versionamento |
| `Usuario_Envio_TermoResponsabilidade` | Registro simples de aceite sem detalhes | Migrar para `AceiteTermo` com timestamp, GPS, assinatura |

### 3.2 Stored Procedures Legado

Nenhuma SP específica encontrada para termos de responsabilidade no legado. Lógica era simples (INSERT na tabela de aceites).

### 3.3 Telas ASPX Legadas

Nenhuma tela ASPX específica encontrada. Funcionalidade era integrada em tela genérica de "Gerenciamento de Termos".

### 3.4 WebServices Legado (VB.NET)

Nenhum WebService dedicado encontrado. Termos eram gerenciados via CRUD genérico.

---

## 4. INTEGRAÇÕES OBRIGATÓRIAS

### 4.1 Central de Funcionalidades (Feature Flags)

**FeatureKey**: `TERMO_RESPONSABILIDADE_ACEITE_DIGITAL`

**Configuração**:
```json
{
    "featureKey": "TERMO_RESPONSABILIDADE_ACEITE_DIGITAL",
    "nome": "Aceite Digital de Termos",
    "descricao": "Habilita captura de assinatura digital (SignaturePad) para aceite de termos de responsabilidade",
    "habilitado": true,
    "isSystemFeature": false,
    "clientesPiloto": ["cliente-001", "cliente-002"],
    "dataAtivacao": "2025-01-15",
    "dataDesativacao": null
}
```

**Observação**: Feature Flag permite ativar/desativar assinatura digital por cliente sem alterar código.

---

### 4.2 Internacionalização (i18n)

**Chaves de Tradução**:

```json
{
    "termos": {
        "responsabilidade": {
            "pageTitle": "Termo de Responsabilidade",
            "form": {
                "tipoAtivo": "Tipo de Equipamento",
                "codigoPatrimonial": "Código Patrimonial",
                "modelo": "Modelo/Série",
                "dataVencimento": "Data Esperada de Devolução",
                "campo_cpf": "CPF (obrigatório)",
                "campo_matricula": "Matrícula Corporativa",
                "campo_assinatura": "Assine aqui",
                "consentimentoGPS": "Autorizar localização GPS?",
                "consentimentoFoto": "Tirar foto do equipamento?"
            },
            "messages": {
                "sucessoAceite": "Termo aceito com sucesso!",
                "erroAceite": "Erro ao aceitar termo. Tente novamente.",
                "termoJaAceito": "Você já aceitou este termo.",
                "terminoVencido": "Este termo venceu. Contate seu gestor de TI.",
                "cpfInvalido": "CPF inválido ou não cadastrado no sistema.",
                "naoAssinouFormalmente": "Você deve assinar o termo com o mouse/toque.",
                "downloadComprovante": "Baixar comprovante PDF"
            },
            "validation": {
                "required": "Campo obrigatório",
                "invalid": "Valor inválido",
                "cpfFormat": "CPF deve estar no formato XXX.XXX.XXX-XX",
                "assinaturaBranco": "A assinatura não pode estar em branco"
            }
        }
    }
}
```

---

### 4.3 Auditoria (LGPD Completa)

**Operações Auditadas**:

| Operação | Código | Dados Registrados |
|----------|--------|-------------------|
| Criar Termo | `TERMO_RESPONSABILIDADE_CREATE` | TipoAtivo, Título, Conteúdo, UsuárioCriação |
| Atualizar Termo | `TERMO_RESPONSABILIDADE_UPDATE` | TermoId, Alterações, UsuárioAtualizaçã, Motivo |
| Aceitar Termo | `TERMO_RESPONSABILIDADE_ACEITE` | UsuarioId, TermoId, AtivoId, IP, GPS, Timestamp |
| Revogar Termo | `TERMO_RESPONSABILIDADE_REVOGACAO` | AceiteId, Motivo, UsuarioRevogador, Penalidade |
| Exportar Comprovante | `TERMO_RESPONSABILIDADE_EXPORT` | AceiteId, UsuarioId, DataExport |

**Retenção**: 7 anos (conforme LGPD Art. 16 para dados de custódia/patrimonial)

---

### 4.4 Controle de Acesso (RBAC)

**Permissões**:

| Permissão | Descrição | Perfis |
|-----------|-----------|--------|
| `termo:create` | Criar termo de responsabilidade | Gestor TI, Diretor Patrimonial |
| `termo:read` | Visualizar termo (conteúdo e histórico) | Todos |
| `termo:update` | Editar termo vigente | Gestor TI, Advogado |
| `termo:delete` | Excluir termo (rascunho apenas) | Diretor Patrimonial |
| `aceite:read` | Ver aceites (próprio ou equipe) | Todos |
| `aceite:aceitar` | Aceitar termo (próprio usuário) | Todos |
| `aceite:revogar` | Revogar aceite | Gestor TI, Almoxarife |
| `dashboard:view` | Acessar dashboard de aceites | Gestor TI, Diretor Patrimonial |
| `comprovante:export` | Exportar/baixar comprovante | Todos |
| `relatorio:penalidades` | Gerar relatório de penalidades | CFO, Gestor TI |

---

## 5. ENDPOINTS DA API

### 5.1 CRUD Principal de Termos

| Método | Endpoint | Descrição | Permissão |
|--------|----------|-----------|-----------|
| GET | `/api/termos` | Listar termos vigentes | `termo:read` |
| GET | `/api/termos/{id}` | Obter termo completo com histórico | `termo:read` |
| POST | `/api/termos` | Criar novo termo | `termo:create` |
| PUT | `/api/termos/{id}` | Atualizar termo (cria nova versão) | `termo:update` |
| DELETE | `/api/termos/{id}` | Excluir termo (rascunho apenas) | `termo:delete` |

### 5.2 Operações de Aceite

| Método | Endpoint | Descrição | Permissão |
|--------|----------|-----------|-----------|
| POST | `/api/aceites/validar-identidade` | Validar CPF/matrícula antes de aceite | `aceite:aceitar` |
| POST | `/api/aceites` | Aceitar termo (captura assinatura) | `aceite:aceitar` |
| GET | `/api/aceites/{id}` | Obter detalhes do aceite | `aceite:read` |
| GET | `/api/aceites/usuario/{usuarioId}` | Listar aceites do usuário | `aceite:read` |
| POST | `/api/aceites/{id}/revogar` | Revogar aceite (devolução) | `aceite:revogar` |
| GET | `/api/aceites/{id}/comprovante` | Baixar PDF comprovante | `comprovante:export` |
| GET | `/api/aceites/{id}/verificar` | Verificar autenticidade (public) | - |

### 5.3 Operações Especiais

| Método | Endpoint | Descrição | Permissão |
|--------|----------|-----------|-----------|
| GET | `/api/dashboard/aceites` | Dashboard com métricas | `dashboard:view` |
| GET | `/api/dashboard/penalidades` | Penalidades acumuladas por usuário | `relatorio:penalidades` |
| GET | `/api/relatorios/aceites-pendentes` | Relatório de aceites pendentes | `dashboard:view` |
| POST | `/api/termos/{id}/versoes/{numero}` | Comparar versões (diff) | `termo:read` |
| GET | `/api/termos/{id}/aceites-por-versao` | Listar quem aceitou cada versão | `termo:read` |

---

## 6. FLUXOS PRINCIPAIS

### 6.1 Fluxo de Entrega e Aceite de Ativo

```
Usuário (Almoxarife) acessa /ativos/entregar
    |
    v
Seleciona ativo a entregar + usuário responsável
    |
    v
Sistema cria termo pendente de aceite (webhook RF-027)
    |
    v
Notifica novo usuário (email + SMS + in-app SignalR)
    |
    v
Usuário novo clica em "Aceitar Termo" (notificação modal)
    |
    v
Tela: Validação de Identidade (CPF/matrícula)
    |
    +--- CPF/matrícula inválido ---> Erro + sugestão contactar RH
    |
    v (válido)
Tela: Leitura do Termo (scroll obrigatório até fim)
    |
    v
Tela: Assinatura Digital (SignaturePad ou mouse)
    |
    +--- Assinatura em branco ---> Erro + instruções
    |
    v (assinado)
Captura automática:
    - Timestamp UTC (servidor)
    - IP + GPS (se autorizado)
    - User-Agent
    - Assinatura PNG (rasterizada)
    |
    v
Gera PDF comprovante com QRCode
    |
    v
Envia comprovante por email + download
    |
    v
Termo agora em status "Ativo"
    |
    v
Fim
```

### 6.2 Fluxo de Devolução de Ativo

```
Usuário (ou Almoxarife) inicia devolução
    |
    v
Seleciona ativo a devolver
    |
    v
Sistema calcula penalidade (se atraso)
    |
    v
Tela: Confirmação de Devolução
    - Motivo: Devolução Normal / Danificado / Perdido / Roubo
    - Observações: "Equipamento com riscos", etc.
    - Penalidade (se houver): R$ XXXX.XX
    |
    v
Clica "Confirmar Devolução"
    |
    v
Sistema:
    1. Revoga termo (AceiteStatus = Revogado)
    2. Marca ativo como devolvido
    3. Cria cobrança (se penalidade > 0)
    4. Gera PDF de encerramento com assinatura digital
    |
    v
Envia comprovante de devolução por email
    |
    v
Notifica gestor de TI sobre devolução
    |
    v
Fim
```

### 6.3 Fluxo de Notificação de Vencimento (Job Automático)

```
Job diário (Hangfire) dispara
    |
    v
Encontra aceites que vencerão em 7, 15, 30 dias
    |
    v
Para cada aceite vencendo:
    |
    +--- 30 dias ---> Email moderado (lembrete)
    |
    +--- 15 dias ---> Email + SMS + notificação in-app
    |
    +--- 7 dias ---> EMAIL URGENTE em vermelho + SMS
    |
    v
Se vencimento já passou (atraso):
    |
    +--- Calcula penalidade progressiva
    +--- Notifica gestor de TI
    +--- Pode bloquear acesso do usuário se > 30 dias atraso
    |
    v
Fim
```

---

## 7. SEGURANÇA

### 7.1 Proteções Implementadas

| Proteção | Descrição |
|----------|-----------|
| **Hash SHA-256 Assinatura** | Cada assinatura gera hash único para detecção de adulterações |
| **QRCode Verificação** | Comprovante tem QRCode que aponta para URL pública que valida integridade |
| **Timestamp NTP Sincronizado** | Servidor sincroniza com NTP para impedir falsificação de data/hora |
| **Geolocalização IP+GPS** | Registra onde aceite foi feito (detecta aceites remotos suspeitos) |
| **RBAC Rigoroso** | Apenas Almoxarife pode revogar termo (não usuário) |
| **Validação de Identidade Obrigatória** | CPF validado contra BrasilAPI antes de aceitar |
| **Isolamento por ClienteId** | Dados de cliente A não acessam dados de cliente B (multi-tenancy) |
| **Imutabilidade de Histórico** | Versões anteriores e aceites antigos não podem ser alterados (append-only) |
| **Auditoria Completa LGPD** | Todo acesso registrado com usuário, timestamp, IP para compliance |
| **Criptografia em Trânsito** | TLS 1.3 obrigatório para todas as APIs (HTTPS) |
| **Rate Limiting** | Máximo 10 tentativas de validação CPF por IP/hora (previne brute force) |

### 7.2 Testes de Segurança Obrigatórios

- [ ] SQL Injection em campos de entrada (busca, comentários)
- [ ] XSS em aceite de markdown/HTML (termos podem conter formatação)
- [ ] CSRF Protection em POST de aceite
- [ ] Validação de permissões (usuário B não pode revogar term de usuário A)
- [ ] Validação de ClienteId (dados isolados por cliente)
- [ ] Teste de integridade de hash SHA-256 (alterar assinatura deve invalidar)
- [ ] Teste de timestamp (não aceitar timestamps futuros ou muito antigos)
- [ ] Teste de rate limiting (mais de 10 tentativas CPF em 1h deve bloquear)
- [ ] Teste de revogação (após revogar, novo aceite requer nova assinatura)
- [ ] Teste de multi-idioma (transição entre idiomas não perde dados)

---

## 8. MÉTRICAS E INDICADORES

### 8.1 KPIs

| KPI | Meta | Medição |
|-----|------|---------|
| **Taxa de Aceite (%)** | ≥ 95% | (Aceites Ativos / Total Entregues) × 100 |
| **Tempo Médio Aceite (horas)** | < 2 | Média (DataAceite - DataEntrega) para aceites normais |
| **Equipamentos com Atraso (%)** | < 5% | (Vencidos Não Devolvidos / Total Aceites Vigentes) × 100 |
| **Penalidade Acumulada (R$)** | < 5% faturamento TI | Soma penalidades não pagas |
| **Taxa Re-aceite (%)** | ≥ 90% | (Re-aceites Realizados / Notificados) × 100 |
| **Comprovantes Baixados (%)** | ≥ 80% | (Downloads Comprovante / Aceites Gerados) × 100 |
| **Satisfação Usuário (NPS)** | ≥ 7 | Survey anual com escala 1-10 |

### 8.2 Alertas

| Alerta | Condição | Ação |
|--------|----------|------|
| **Aceite Crítico Pendente** | Ativo crítico (servidor) sem aceite > 24h | Notificar Diretor TI |
| **Taxa Atraso Elevada** | > 10% de aceites com atraso | Revisão de política de entrega |
| **Penalidade Acumulada** | > R$50k/mês | Auditoria de processos |
| **Falha no Vencimento** | Aceite vencido sem notificação | Investigar falha do job de notificação |

---

## 9. PRÓXIMOS PASSOS

1. **Modelo de Dados**: Criar [MD-081](./MD-081-Termos-Responsabilidade.md) com DDL completo (tabelas PostgreSQL)
2. **Casos de Uso**: Criar [UC-081](./UC-081-Termos-Responsabilidade.md) com 5 cenários principais (entrega, devolução, penalidade, etc.)
3. **Workflow**: Criar [WF-081](./WF-081-Termos-Responsabilidade.md) com telas Angular, componentes, rotas
4. **User Stories**: Criar [user-stories.yaml](./user-stories.yaml) com mínimo 5 stories implementáveis
5. **Testes**: Criar [TC-081-BACKEND.md](./TC-081-BACKEND.md), [TC-081-FRONTEND.md](./TC-081-FRONTEND.md), [TC-081-E2E.md](./TC-081-E2E.md)
6. **Implementação Backend**: Entities, Commands/Queries, Handlers, Repositories
7. **Implementação Frontend**: Telas Angular (aceite, dashboard, gestão), integração SignaturePad
8. **Execução de Testes**: Tester-Backend para validar contrato

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 1.0 | 2025-12-28 | Versão inicial com 12 regras de negócio e 5 operações especiais | Claude Code |

---

**Última Atualização**: 2025-12-28
**Autor**: Claude Code
**Revisão**: Pendente

---

[← Voltar](../README.md)
