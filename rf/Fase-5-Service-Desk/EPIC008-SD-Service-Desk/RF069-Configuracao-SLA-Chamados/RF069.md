# RF-069: Configuração de SLA para Chamados

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC008-SD - Service Desk
**Fase**: Fase 5 - Service Desk

---

## 1. OBJETIVO DO REQUISITO

Especificar o sistema de configuração e gerenciamento de Acordos de Nível de Serviço (SLA) para chamados de Service Desk, estabelecendo regras claras para prazos de resposta, tempos de resolução, matrizes de priorização, pausas automatizadas, feriados, escalações multi-nível e cálculos de compliance.

Este documento define **o que o sistema deve fazer**, servindo como **contrato oficial** entre negócio, desenvolvimento, testes e agentes de IA.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Cadastro completo de SLAs (nome, descrição, prioridade, tempos, calendário)
- [x] Matriz de prioridades (Urgência × Impacto)
- [x] Gestão de calendários de operação (comercial, 24x7, feriados)
- [x] Regras de pausa automática de SLA por status
- [x] Escalações multi-nível (até 5 níveis com percentuais configuráveis)
- [x] Simulador de impacto de mudanças em SLA
- [x] Relatórios de compliance SLA
- [x] Versionamento completo de alterações
- [x] Aplicação automática de SLA ao criar chamado
- [x] Controle de acesso e isolamento por tenant
- [x] Auditoria de todas operações

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (wireframes em WF-RF069.md)
- Tecnologia, framework ou linguagem de implementação
- Layout, UX ou identidade visual
- Estratégia de deploy ou infraestrutura
- Gestão de chamados propriamente dita (RF-073)
- SLA de operações (RF-028) e serviços (RF-029)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **SLA** | Service Level Agreement - Acordo formal que define métricas mensuráveis de qualidade de serviço |
| **Tempo de Resposta** | Prazo máximo entre abertura do chamado e primeira interação significativa do atendente |
| **Tempo de Resolução** | Prazo máximo entre abertura do chamado e resolução final (status Resolvido/Fechado) |
| **Prioridade** | Nível de urgência/impacto do chamado que determina qual SLA será aplicado |
| **Pausa de SLA** | Período em que a contagem do tempo de SLA é suspensa devido a evento externo |
| **Calendário de Operação** | Define horários e dias úteis de atendimento para cálculo de "horas úteis" |
| **Escalação Automática** | Ação automática disparada quando chamado atinge percentual de tempo decorrido ou é violado |
| **Compliance SLA** | Percentual de chamados resolvidos dentro do prazo contratual em um período |

---

## 4. FUNCIONALIDADES COBERTAS

1. Criar SLA com parâmetros completos
2. Atualizar SLA existente (com versionamento)
3. Consultar SLA por ID
4. Listar SLAs com paginação e filtros
5. Inativar SLA (soft delete)
6. Configurar matriz de prioridades (Urgência × Impacto)
7. Cadastrar calendários de operação
8. Importar feriados nacionais via API pública
9. Definir regras de pausa automática por status
10. Configurar escalações multi-nível
11. Simular impacto de mudanças em SLA
12. Gerar relatórios de compliance
13. Visualizar histórico de alterações
14. Calcular prazos limite considerando horários úteis e feriados
15. Aplicar SLA automaticamente ao criar chamado

---

## 5. REGRAS DE NEGÓCIO

### RN-RF069-01 — Tempos Obrigatórios e Válidos

**Descrição**: Todo SLA DEVE ter tempo de resposta e tempo de resolução definidos, ambos maiores que zero, e tempo de resolução maior ou igual ao tempo de resposta.

**Justificativa**: SLA sem prazos definidos não pode ser monitorado nem gerar alertas de violação. Tempo de resolução menor que resposta é logicamente impossível.

**Critério de Aceite**:
- Tempo de resposta ausente ou ≤ 0 → rejeição (HTTP 400)
- Tempo de resolução ausente ou ≤ 0 → rejeição (HTTP 400)
- Tempo de resolução < tempo de resposta → rejeição (HTTP 400)

---

### RN-RF069-02 — Unicidade por Cliente/Tipo/Prioridade

**Descrição**: Não pode existir mais de um SLA ativo para a mesma combinação de Cliente + Tipo de Chamado + Prioridade.

**Justificativa**: Evita ambiguidade na aplicação de SLA ao criar chamado.

**Critério de Aceite**:
- Tentativa de criar SLA duplicado → rejeição (HTTP 400)
- Mensagem: "Já existe SLA ativo para esta combinação Cliente/Tipo/Prioridade"

---

### RN-RF069-03 — Calendário Obrigatório

**Descrição**: Todo SLA DEVE estar associado a um calendário de operação válido e ativo.

**Justificativa**: Sem calendário, sistema não consegue calcular "horas úteis" para SLA.

**Critério de Aceite**:
- Calendário ausente → rejeição (HTTP 400)
- Calendário inválido ou inativo → rejeição (HTTP 400)
- Referencial integrity garantida por FK no banco

---

### RN-RF069-04 — Pausas Automáticas por Status

**Descrição**: Sistema DEVE pausar automaticamente a contagem de SLA quando chamado entrar em status configurado como "Pausa SLA" e retomar quando sair.

**Justificativa**: Justiça contratual - cliente não pode ser penalizado por tempo que depende de terceiros.

**Critério de Aceite**:
- Mudança para status com Fl_Pausa_SLA=true → SLA pausa imediatamente
- Mudança para status sem pausa → SLA retoma, acumulando tempo pausado
- Auditoria registra início/fim de pausa com motivo

---

### RN-RF069-05 — Escalações em Percentuais Configuráveis

**Descrição**: Sistema DEVE disparar escalações automaticas quando chamado atingir percentuais configurados do tempo de SLA (ex: 50%, 75%, 90%, 100%).

**Justificativa**: Alertas proativos permitem ação preventiva antes de violação contratual.

**Critério de Aceite**:
- Percentual atingido → notificação disparada uma única vez
- Suporte a múltiplos canais (email, SMS, push, webhook)
- Registro de auditoria para cada disparo

---

### RN-RF069-06 — Cálculo em Horário Útil

**Descrição**: Sistema DEVE calcular tempo decorrido de SLA apenas durante horário útil definido no calendário, excluindo feriados e fins de semana.

**Justificativa**: Contratos geralmente definem SLA em "horas úteis" (business hours).

**Critério de Aceite**:
- Chamado aberto fora de horário → início da contagem no próximo horário útil
- Fins de semana e feriados não contam
- Pausas respeitadas independente de horário útil

---

### RN-RF069-07 — Feriados Customizáveis

**Descrição**: Sistema DEVE suportar cadastro de feriados nacionais, estaduais, municipais e corporativos, com suporte a feriados recorrentes e importação via API.

**Justificativa**: Calendários de atendimento variam por região e empresa.

**Critério de Aceite**:
- Cadastro manual de feriados com tipos (Nacional, Estadual, Municipal, Corporativo)
- Importação automática via API pública (BrasilAPI)
- Feriados recorrentes (Natal, Ano Novo) marcados como tal

---

### RN-RF069-08 — Versionamento Imutável

**Descrição**: Sistema DEVE registrar TODAS as alterações em configurações de SLA com data/hora, usuário, valores before/after e motivo obrigatório da mudança.

**Justificativa**: Auditoria LGPD, compliance contratual e rastreabilidade em disputas.

**Critério de Aceite**:
- Alteração sem motivo → rejeição (HTTP 400)
- Histórico acessível por ID de SLA
- Temporal Tables SQL Server (história imutável)

---

### RN-RF069-09 — Simulador "What-If"

**Descrição**: Sistema DEVE fornecer simulador que calcula impacto no compliance histórico ao alterar parâmetros de SLA.

**Justificativa**: Permite decisões baseadas em dados ao negociar SLAs com clientes.

**Critério de Aceite**:
- Simulação usa dados reais dos últimos 90 dias
- Resultado mostra compliance atual vs projetado
- Alerta se impacto > 10% de queda

---

### RN-RF069-10 — Aplicação Automática de SLA

**Descrição**: Sistema DEVE aplicar SLA automaticamente ao criar chamado baseado em regras de precedência: 1) SLA específico Cliente+Tipo+Prioridade, 2) SLA genérico Tipo+Prioridade, 3) SLA default Prioridade.

**Justificativa**: Automação total - usuário não precisa escolher SLA manualmente.

**Critério de Aceite**:
- Chamado criado → SLA aplicado automaticamente
- Se nenhum SLA encontrado → erro (HTTP 400)
- Auditoria registra regra usada

---

### RN-RF069-11 — Isolamento Multi-Tenant

**Descrição**: Um usuário só pode acessar e gerenciar SLAs do seu próprio Fornecedor (tenant).

**Critério de Aceite**:
- Tentativa de acesso cruzado → rejeição (HTTP 404)
- Filtro Id_Fornecedor aplicado em todas as queries

---

### RN-RF069-12 — Permissões Granulares

**Descrição**: Cada operação exige permissão explícita baseada em políticas RBAC.

| Operação | Permissão |
|----------|-----------|
| Listar SLAs | servicedesk:sla:read |
| Visualizar SLA | servicedesk:sla:read |
| Criar SLA | servicedesk:sla:create |
| Atualizar SLA | servicedesk:sla:update |
| Inativar SLA | servicedesk:sla:delete |
| Usar Simulador | servicedesk:sla:simulate |
| Configurar Escalações | servicedesk:sla:escalation:manage |
| Gerenciar Calendários | servicedesk:sla:calendar:manage |
| Ver Relatórios | servicedesk:sla:report:view |
| Ver Auditoria | servicedesk:sla:audit:view |

**Critério de Aceite**:
- Operação sem permissão → rejeição (HTTP 403)
- Validação no backend via Policies

---

## 6. ESTADOS DA ENTIDADE

| Estado | Descrição |
|--------|-----------|
| **Ativo** | SLA em uso, pode ser aplicado a chamados |
| **Inativo** | SLA desativado, não será aplicado a novos chamados |
| **Excluído** | Soft delete (Fl_Excluido=true) |

### Transições permitidas

| De | Para |
|----|------|
| Ativo | Inativo |
| Inativo | Ativo |
| Ativo/Inativo | Excluído |

**Regra**: SLA excluído não pode ser reativado (criação de novo SLA necessária).

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre |
|--------|---------------|
| **SLA.Criado** | Após criação bem-sucedida |
| **SLA.Atualizado** | Após alteração de parâmetros |
| **SLA.Inativado** | Após desativação |
| **SLA.Aplicado** | Quando SLA é associado a um chamado |
| **SLA.Pausado** | Quando contagem de SLA é pausada |
| **SLA.Retomado** | Quando contagem de SLA é retomada |
| **SLA.Escalado** | Quando escalação é disparada |
| **SLA.Violado** | Quando prazo é ultrapassado |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant
- Nenhuma regra de negócio pode ser ignorada
- Erros devem ser previsíveis e rastreáveis (códigos estruturados)
- Auditoria deve registrar quem, quando e o que mudou
- Performance: listagem < 300ms, cálculo de prazo < 200ms
- Disponibilidade do job de monitoramento > 99.9%
- Compliance mínimo esperado: ≥95% resposta, ≥90% resolução

---

## 9. SEGURANÇA

### 9.1 Proteções Implementadas

- **SQL Injection**: Parametrização total via Entity Framework Core
- **XSS**: Sanitização automática Angular + validação MaxLength backend
- **CSRF**: Token Anti-CSRF obrigatório em formulários
- **Autorização Granular**: Validação de permissões via Policies em todos endpoints
- **Rate Limiting**: 100 requests/min por usuário/IP
- **Auditoria Completa**: Todas operações CUD auditadas com usuário, IP, timestamp
- **Validação Dupla**: FluentValidation backend + Reactive Forms frontend
- **Criptografia**: E-mails de escalação criptografados em repouso (AES-256)
- **Versionamento Imutável**: Temporal Tables SQL Server
- **Multi-Tenancy Rigoroso**: Filtro global Id_Fornecedor

### 9.2 Testes de Segurança Obrigatórios

- SQL Injection em campos Nome SLA, Descrição, E-mails
- XSS em campos Mensagem Template de Escalação
- CSRF Protection em todos formulários
- Validação de permissões em todos endpoints
- Rate Limiting (200 requests em 1 min → HTTP 429)
- Vazamento de dados entre tenants
- Escalação de privilégios
- Auditoria de alterações (before/after)
- Validação de calendário inválido
- Simulador com dados maliciosos

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF069.md** (Casos de Uso) - Obrigatório
- **MD-RF069.md** (Modelo de Dados) - Obrigatório
- **WF-RF069.md** (Wireframes) - Obrigatório
- **MT-RF069.yaml** (Massas de Teste) - Obrigatório
- **TC-RF069.yaml** (Casos de Teste) - Obrigatório

---

## 11. RASTREABILIDADE

| Artefato | Status | Gerado |
|----------|--------|--------|
| Casos de Uso | Pendente | Próximo contrato |
| Modelo de Dados | Pendente | Próximo contrato |
| Wireframes | Pendente | Próximo contrato |
| Massas de Teste | Pendente | Após UCs |
| Casos de Teste | Pendente | Após UCs |

**RFs Relacionados:**
- **RF-073**: Gestão de Chamados (consumidor de SLA)
- **RF-028**: SLA Operações (consolidação de métricas)
- **RF-029**: SLA Serviços (consolidação de métricas)

**Integrações Obrigatórias:**
- i18n (Transloco) - pt-BR/en/es
- Auditoria (AuditInterceptor)
- RBAC (Authorization Policies)
- Central de Funcionalidades (Feature Flags)

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0 - Separação RF/RL completa. RF limpo sem referências ao legado. | Agência ALC - alc.dev.br |
| 1.0 | 2025-12-28 | Versão inicial com mapeamento legado incluído | Claude Code (IControlIT Architect Agent) |
