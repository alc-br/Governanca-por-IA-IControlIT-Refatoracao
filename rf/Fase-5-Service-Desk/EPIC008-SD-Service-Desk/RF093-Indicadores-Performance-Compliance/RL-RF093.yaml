# =============================================
# RL-RF093 - Referência ao Legado
# Indicadores de Performance e Compliance
# Data: 2025-12-30
# Autor: Equipe IControlIT
# =============================================

rf_id: RF093
titulo: Indicadores de Performance e Compliance (KPIs)

legado:
  sistema: VB.NET + ASP.NET Web Forms
  versao: N/A
  arquitetura: Monolítica WebForms
  banco_dados: SQL Server
  multi_tenant: false
  auditoria: false
  possui_kpi_sistema: false

conclusao_analise: |
  A tabela Si_KPI encontrada no legado NÃO constitui um sistema de KPIs.
  É apenas uma configuração auxiliar básica com 9 campos para armazenar
  dias de processamento batch e nomes de hierarquia corporativa.

  O RF093 implementa um SISTEMA COMPLETO E MODERNO de KPIs que
  NÃO POSSUI contrapartida no legado.

# SEÇÃO CRÍTICA: Referências ao Legado com Destino Obrigatório
referencias:
  - id: LEG-RF093-001
    tipo: componente
    nome: Si_KPI (Configuração Básica de Processamento)
    caminho: ic1_legado/BancoDados/Interno/Cliente_Modelo.sql (linhas 8204-8215)
    descricao: |
      Tabela extremamente simples com apenas 9 campos:
      - Fl_Carga_Auditada (int): Flag de carga auditada
      - Dia_Entrega_RH (int): Dia do mês para entrega de dados RH
      - Dia_Entrega_Rateio (int): Dia do mês para entrega de rateios
      - Dia_Carga (int): Dia do mês para execução de carga
      - Nm_Filial (varchar): Nome do nível hierárquico Filial
      - Nm_Centro_Custo (varchar): Nome do nível hierárquico Centro de Custo
      - Nm_Departamento (varchar): Nome do nível hierárquico Departamento
      - Nm_Setor (varchar): Nome do nível hierárquico Setor
      - Nm_Secao (varchar): Nome do nível hierárquico Seção

      PROBLEMAS IDENTIFICADOS:
      - Sem chave primária (PK)
      - Sem campos de auditoria
      - Sem suporte a multi-tenancy (ClienteId)
      - Sem relacionamentos com outras tabelas (FK)
      - Propósito pouco claro (mistura dias de entrega com nomes de hierarquia)
      - Sem versionamento ou histórico
    destino: descartado
    justificativa: |
      Esta tabela NÃO armazena KPIs propriamente ditos. Aparenta ser uma configuração
      de processamento batch legado sem relação com o sistema de KPIs do RF093.

      O novo sistema implementa entidades específicas (KpiDefinition, KpiTarget,
      KpiCalculation, KpiAlert, KpiAuditLog) com propósitos bem definidos.

      Migração causaria inconsistência semântica (forçar encaixe de dados incompatíveis).
      Os campos da tabela legada (Dia_Entrega_RH, Nm_Filial, etc.) não têm correspondência
      nas novas entidades.
    rf_item_relacionado: null
    uc_relacionado: null
    complexidade: baixa
    risco_migracao: nenhum
    prioridade: 5

  - id: LEG-RF093-002
    tipo: stored_procedure
    nome: Procedures de Cálculo de KPIs
    caminho: ic1_legado/**/*.sql
    descricao: |
      Busca executada: pa_.*KPI|pa_CalcularKPI|pa_VerificarAlertas|pa_GerarRelatorioKPI

      RESULTADO: Nenhuma stored procedure relacionada a KPIs foi encontrada.

      Procedures esperadas mas NÃO encontradas:
      - pa_CalcularKPI_SLA
      - pa_CalcularKPI_Contratos
      - pa_CalcularKPI_Custos
      - pa_VerificarAlertas
      - pa_GerarRelatorioKPI
    destino: descartado
    justificativa: |
      NÃO APLICÁVEL - Não existem stored procedures de KPI no legado.

      O novo sistema utiliza Hangfire para cálculo automático em background (.NET),
      eliminando dependência de stored procedures do SQL Server.
    rf_item_relacionado: null
    uc_relacionado: null
    complexidade: nenhuma
    risco_migracao: nenhum
    prioridade: 5

  - id: LEG-RF093-003
    tipo: tela
    nome: Telas ASPX de Gestão de KPIs
    caminho: ic1_legado/IControlIT/**/*.aspx
    descricao: |
      Busca executada: **/*Dashboard*.aspx, **/*KPI*.aspx

      RESULTADO: Nenhuma tela ASPX relacionada a KPIs foi encontrada.

      Telas esperadas mas NÃO encontradas:
      - Dashboard.aspx (Dashboard de KPIs)
      - GestaoKPI.aspx (Gestão de Indicadores)
      - MetasKPI.aspx (Configuração de Metas)
      - RelatorioKPI.aspx (Relatórios Analíticos)
    destino: descartado
    justificativa: |
      NÃO APLICÁVEL - Não existem telas de KPI no legado.

      O novo sistema implementa dashboards modernos em Angular 19 com atualização
      em tempo real via SignalR, drill-down em gráficos, exportação PDF/Excel.
    rf_item_relacionado: UC06
    uc_relacionado: UC06
    complexidade: nenhuma
    risco_migracao: nenhum
    prioridade: 5

  - id: LEG-RF093-004
    tipo: webservice
    nome: WSKPI.asmx.vb (Webservice de KPIs)
    caminho: ic1_legado/**/*.asmx*
    descricao: |
      Busca executada: **/WSKPI.asmx*

      RESULTADO: Nenhum webservice relacionado a KPIs foi encontrado.

      Webservice esperado mas NÃO encontrado:
      - WSKPI.asmx.vb com métodos GetKPIs(), CalcularKPI(), GetAlertas(), AtualizarMeta()
    destino: descartado
    justificativa: |
      NÃO APLICÁVEL - Não existe webservice de KPI no legado.

      O novo sistema implementa API REST moderna (.NET 10 + Minimal APIs) com endpoints:
      - GET /api/kpis (listar KPIs)
      - POST /api/kpis/{id}/calculate (calcular KPI específico)
      - GET /api/kpis/{id}/alerts (obter alertas)
      - PUT /api/kpis/{id}/targets (atualizar metas)
    rf_item_relacionado: null
    uc_relacionado: null
    complexidade: nenhuma
    risco_migracao: nenhum
    prioridade: 5

  - id: LEG-RF093-005
    tipo: regra_negocio
    nome: RB-LEG-093-01 - Configuração de Dias de Processamento
    caminho: Tabela Si_KPI (campos Dia_Entrega_RH, Dia_Entrega_Rateio, Dia_Carga)
    descricao: |
      Regra presumida a partir dos campos da tabela Si_KPI:

      A tabela aparentemente armazena dias específicos para processamentos batch:
      - Dia_Entrega_RH: Dia do mês em que RH entrega dados
      - Dia_Entrega_Rateio: Dia do mês em que rateios são entregues
      - Dia_Carga: Dia do mês em que carga de dados é executada

      Provável uso: Agendamento fixo de processamentos mensais.
    destino: descartado
    justificativa: |
      Esta regra NÃO tem relação com o sistema de KPIs do RF093.

      O novo sistema utiliza agendamento via Hangfire com periodicidade configurável
      (horária, diária, semanal, mensal, anual), sem dependência de "dias fixos de processamento".

      Cada KPI pode ter sua própria periodicidade configurada independentemente,
      permitindo flexibilidade total sem necessidade de carga batch em dia específico.
    rf_item_relacionado: RN-KPI-093-03
    uc_relacionado: UC03
    complexidade: baixa
    risco_migracao: nenhum
    prioridade: 4

  - id: LEG-RF093-006
    tipo: regra_negocio
    nome: RB-LEG-093-02 - Nomes de Hierarquia Corporativa
    caminho: Tabela Si_KPI (campos Nm_Filial, Nm_Centro_Custo, Nm_Departamento, Nm_Setor, Nm_Secao)
    descricao: |
      Regra presumida a partir dos campos da tabela Si_KPI:

      A tabela armazena nomes de níveis hierárquicos:
      - Nm_Filial
      - Nm_Centro_Custo
      - Nm_Departamento
      - Nm_Setor
      - Nm_Secao

      Possível uso: Padronização de nomenclatura em relatórios.
      Problema: Duplicação de dados (nomes também estão em outras tabelas).
    destino: descartado
    justificativa: |
      O novo sistema obtém hierarquia corporativa diretamente do RF009
      (Hierarquia Corporativa), eliminando duplicação de dados.

      Nomes são obtidos via foreign keys (FilialId, CentroCustoId, DepartamentoId, etc.),
      garantindo consistência e evitando dessincronia entre sistemas.

      Não há razão para manter cópias redundantes de nomes hierárquicos em tabela de KPIs.
    rf_item_relacionado: null
    uc_relacionado: null
    complexidade: baixa
    risco_migracao: nenhum
    prioridade: 5

# Mapeamento de Funcionalidades Novas (sem contrapartida legado)
funcionalidades_novas:
  - id: FN-093-01
    titulo: Sistema completo de gestão de KPIs
    descricao: |
      Cadastro de indicadores com fórmulas customizadas, validação automática de fórmulas
      (sintaxe, referências, divisão por zero), versionamento e histórico de alterações.
    modulos:
      - Gestão de KPIs
      - Gestão de Metas
      - Configuração de Fórmulas
    contrapartida_legado: false

  - id: FN-093-02
    titulo: Cálculo automático via Hangfire
    descricao: |
      Agendamento periódico (horário, diário, semanal, mensal, anual), execução em background
      sem bloquear aplicação, retry automático em caso de falha (3 tentativas).
    tecnologias:
      - Hangfire
      - BackgroundJob
      - RecurringJob
    contrapartida_legado: false

  - id: FN-093-03
    titulo: Sistema de metas e alertas
    descricao: |
      Configuração de limites verde/amarelo/vermelho, geração automática de alertas em desvios,
      notificações multicanal (email, SMS, in-app via SignalR).
    componentes:
      - KpiTarget (Entity)
      - KpiAlert (Entity)
      - AlertaService
      - SignalR Hub
    contrapartida_legado: false

  - id: FN-093-04
    titulo: Dashboards em tempo real
    descricao: |
      Atualização automática via SignalR, drill-down em gráficos, exportação para PDF/Excel.
    tecnologias:
      - SignalR
      - ApexCharts
      - Angular Material
    contrapartida_legado: false

  - id: FN-093-05
    titulo: Indicadores específicos por categoria
    descricao: |
      - SLA: Percentual cumprimento, tempo médio resposta/resolução
      - Contratos: Custos, economia em renegociações
      - Ativos: TCO, taxa de utilização, disponibilidade
      - Custos: Variação orçamentária, ROI, tendências
      - Compliance: Aderência SOX/LGPD/ISO 27001
    categorias:
      - SLA
      - Contratos
      - Ativos
      - Custos
      - Compliance
    contrapartida_legado: false

  - id: FN-093-06
    titulo: Integração com ferramentas de BI
    descricao: |
      Endpoint OData para Power BI, Web Data Connector para Tableau, templates pré-configurados (.pbix, .twb).
    integracao_externa:
      - ferramenta: Power BI
        protocolo: OData
        template: KPI-Dashboard.pbix
      - ferramenta: Tableau
        protocolo: Web Data Connector (WDC)
        template: KPI-Dashboard.twb
    contrapartida_legado: false

  - id: FN-093-07
    titulo: Auditoria completa
    descricao: |
      Registro imutável de todos os cálculos, snapshot de dados de entrada, trilha de alterações com before/after.
    entidade: KpiAuditLog
    campos_principais:
      - Operacao (CRIACAO, ALTERACAO, EXCLUSAO, CALCULO)
      - PayloadBefore (JSON)
      - PayloadAfter (JSON)
      - UsuarioId
      - DataHora
      - IpAddress
    contrapartida_legado: false

  - id: FN-093-08
    titulo: Busca full-text com ElasticSearch
    descricao: |
      Indexação automática de documentos, busca facetada com filtros combinados, fuzzy matching (tolerância a erros).
    tecnologias:
      - ElasticSearch
      - NEST (.NET Client)
    indices:
      - kpi-definitions
      - kpi-calculations
      - kpi-alerts
    contrapartida_legado: false

# Recomendações Técnicas
recomendacoes_tecnicas:
  - codigo: REC-093-01
    titulo: Não Migrar Dados da Tabela Si_KPI
    prioridade: ALTA
    recomendacao: NÃO migrar dados da tabela Si_KPI para o novo sistema.
    justificativa: |
      - A tabela legada não armazena KPIs propriamente ditos
      - Os campos (Dia_Entrega_RH, Nm_Filial, etc.) não têm correspondência nas novas entidades
      - Dados parecem ser configurações específicas de processamento batch legado
      - Migração causaria inconsistência semântica (forçar encaixe de dados incompatíveis)

  - codigo: REC-093-02
    titulo: Iniciar Sistema de KPIs com Dados Zerados
    prioridade: ALTA
    recomendacao: Implementar RF093 com banco de dados limpo (sem dados legados).
    passos_sugeridos:
      - Criar entidades modernas: KpiDefinition, KpiTarget, KpiCalculation, KpiAlert, KpiAuditLog
      - Permitir que usuários cadastrem KPIs manualmente via interface Angular
      - Sistema calculará histórico a partir da data de cadastro (não retroativo ao legado)
      - Dashboards exibirão dados a partir da data de ativação do módulo

  - codigo: REC-093-03
    titulo: Considerar Importação Manual de Indicadores Críticos
    prioridade: MÉDIA
    recomendacao: Se houver KPIs sendo acompanhados manualmente (ex. planilhas Excel), considerar importação via API.
    cenario_exemplo:
      situacao: Empresa já acompanha 'Taxa de Cumprimento de SLA' manualmente
      historico_disponivel: 12 meses
      formato: CSV
    solucao:
      - Criar endpoint de importação POST /api/kpis/import
      - Validar formato CSV (colunas: Data, Valor, Meta)
      - Criar registros em KpiCalculation com dados históricos
      - Usuário visualiza tendência imediatamente no dashboard

# Estatísticas de Mapeamento
estatisticas:
  total_itens_legados: 6
  itens_assumidos: 0
  itens_substituidos: 0
  itens_descartados: 6
  itens_a_revisar: 0
  percentual_cobertura: 100
  status_cobertura: COMPLETO

# Histórico de Revisões
historico_revisoes:
  - versao: "1.0"
    data: "2025-12-30"
    autor: "Equipe IControlIT"
    descricao: |
      Versão inicial. Análise completa do legado confirmou que sistema de KPIs
      não existe (apenas tabela Si_KPI com configurações básicas).
      100% de cobertura de destinos alcançada (6 itens DESCARTADOS/NÃO APLICÁVEL).
    mudancas:
      - Criação do documento RL-RF093.yaml
      - Mapeamento completo de 6 artefatos legados
      - Extração de 2 regras de negócio presumidas (ambas DESCARTADAS)
      - Documentação de 8 funcionalidades novas sem contrapartida legado
      - 3 recomendações técnicas para inicialização do sistema
