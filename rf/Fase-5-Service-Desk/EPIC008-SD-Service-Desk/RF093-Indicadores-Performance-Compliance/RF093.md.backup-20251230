# RF-093-Indicadores-Performance-Compliance

**Versao**: 1.0
**Ultima Atualizacao**: 2025-12-28
**Status**: Em Elaboração
**Fase**: Fase 5 - Service Desk e Operações Avançadas
**EPIC**: EPIC008-SD-Service-Desk

---

[← Voltar ao Índice](./README.md)

---

## RESUMO EXECUTIVO

### Descrição Geral

O RF-093 implementa o **Sistema de Indicadores de Performance e Compliance** do IControlIT, responsável por gerenciar, calcular e monitorar todos os KPIs (Key Performance Indicators) relevantes para operações, contratos, custos e conformidade regulatória. Este módulo é fundamental para permitir que gestores acompanhem a saúde operacional do sistema em tempo real, identifiquem desvios de metas e tomem decisões baseadas em dados.

O módulo centraliza métricas de múltiplas áreas:
- **Indicadores de SLA** (RF028, RF029): Cumprimento de Service Level Agreements
- **Indicadores de Contratos** (RF023): Performance de fornecedores e execução contratual
- **Indicadores de Ativos** (RF028): Utilização, TCO e disponibilidade
- **Indicadores de Custos** (RF094): Despesas, renegociações, economia
- **Indicadores de Compliance** (RF079): Taxa de conformidade com políticas, LGPD, regulações
- **Indicadores de Chamados** (RF073-RF074): Tempo médio de resolução, satisfação, taxa de reaberturas

### Importância Estratégica

O módulo de Indicadores é crítico para:
- **Conformidade Regulatória**: Rastreamento contínuo de métricas de compliance (SOX, LGPD, ISO27001)
- **Tomada de Decisão**: Dashboards executivos com dados consolidados e alertas em tempo real
- **Accountability**: Auditoria completa de cálculos, alterações de metas e desvios
- **Performance Operacional**: Monitoramento de SLAs, resolução de chamados, satisfação
- **Gestão Financeira**: Controle de custos, ROI de tecnologia, renegociação de contratos
- **Detecção de Problemas**: Alertas automáticos quando métricas saem dos limites configurados
- **Comparação Período a Período**: Análise de tendências para identificar melhorias ou degradação
- **Integração com BI**: Exportação para Power BI/Tableau para análises avançadas
- **Multi-Tenant**: Cada conglomerado tem seus próprios KPIs, metas e regras de cálculo
- **Escalabilidade**: Suporte a cálculos batch paralelos via Hangfire para grandes volumes

### Conceitos Fundamentais

**KPI (Key Performance Indicator)**: Métrica quantificável que mede o sucesso em atingir objetivos estratégicos. Exemplo: "Taxa de cumprimento de SLA" = (Tickets resolvidos no prazo / Total de tickets) × 100%

- Definido por: código único, descrição, fórmula de cálculo, tipo (porcentagem, valor, contagem)
- Agregação: Diário, semanal, mensal, trimestral, anual
- Alertas: Disparados quando valor sai do intervalo [Meta Mínima, Meta Máxima]

**Meta (Target)**: Valor esperado para o KPI em um período. Exemplo: "Taxa de cumprimento SLA deve ser ≥ 95%"

- Pode ter meta diferente por conglomerado, por contrato, por centro de custo
- Período: Data início e data fim (ou recorrência: diária, semanal, mensal)
- Status visual: Verde (≥ meta), Amarelo (80-99% da meta), Vermelho (< 80% da meta)

**Indicador Calculado vs Indicador Manual**:
- **Calculado**: Derivado de fórmula automática (SUM, AVG, COUNT, FORMULA customizada)
- **Manual**: Inserido manualmente (ex: % satisfação medida via pesquisa)

**Compliance**: Conformidade com regulações, políticas, padrões. Indicadores de compliance medem:
- Taxa de conformidade com políticas de segurança
- Número de exceções aprovadas vs total de operações
- Aderência a procedimentos documentados
- Taxas de violação, incidentes de segurança, acessos não autorizados

### Legado vs. Modernização

| Aspecto | Legado (VB.NET) | Modernização (.NET 10 + Angular) |
|---------|-----------------|----------------------------------|
| **Armazenamento** | Planilhas Excel, SQL Server reports | Banco de dados normalizado com histórico |
| **Cálculo** | Manual via Excel, relatórios ad-hoc | Cálculo automático via Hangfire (jobs batch) |
| **Tempo Real** | Atualização diária/semanal | Atualização em tempo real via SignalR |
| **Visualização** | Reports estatísticos limitados | Dashboards interativos com Chart.js, Highcharts |
| **Alertas** | E-mail manual | Alertas automáticos via NotificationHub |
| **Multi-Tenant** | Não suportado | Suporte completo com ClienteId |
| **Auditoria** | Nenhuma auditoria de cálculos | Histórico completo de versões de KPIs e metas |
| **Exportação** | Excel manual | Power BI, Tableau, CSV automático |
| **Validação** | Sem validação de fórmulas | Validação de sintaxe de fórmulas customizadas |
| **Comparação Período** | Manual em Excel | Automático com gráficos de tendência |
| **Integração** | Isolado de outros módulos | Integrado com SLA (RF028), Contratos (RF023), Custos (RF094) |

### Funcionalidades Principais

1. **Gestão de KPIs Configuráveis** - Criar, editar, deletar KPIs com fórmulas customizáveis
2. **Cálculo Automático de Métricas** - Execução automática via Hangfire (diário, semanal, mensal)
3. **Indicadores de SLA** - Cumprimento de prazos (RF028, RF029)
4. **Indicadores de Contratos** - Performance de fornecedores (RF023, RF090)
5. **Indicadores de Ativos** - Utilização, TCO, disponibilidade (RF028)
6. **Indicadores de Custos** - Despesas, economia, variação (RF094)
7. **Indicadores de Compliance** - Taxa conformidade, violações, exceções (RF079)
8. **Dashboard Executivo em Tempo Real** - Visualização via SignalR com atualização contínua
9. **Gráficos de Tendência** - Comparação período a período, linha, coluna, pizza
10. **Alertas Inteligentes** - Notificação automática de desvios com escalonamento
11. **Metas Configuráveis** - Verde/amarelo/vermelho com visualização em gauge
12. **Auditoria Completa** - Histórico de cálculos, alterações de metas, versões de fórmulas
13. **Exportação Power BI** - Dados estruturados em formato OData/JSON
14. **Integração com Contratos** - KPIs vinculados a RF023 com multas/bônus automáticos
15. **Comparação Entre Períodos** - Análise de variação mês anterior, mesmo mês ano anterior

---

## REGRAS DE NEGOCIO

### RN-KPI-093-01: Estrutura de KPI

**Descrição**: Um KPI é definido por um conjunto obrigatório de atributos que identificam, descrevem e definem como a métrica deve ser calculada.

**Justificativa**: Padronização garante que todos os KPIs sejam comparáveis, auditáveis e compreensíveis por todos os usuários do sistema.

**Implementação**:
```csharp
public class KpiDefinition
{
    public int Id { get; set; }
    public string Code { get; set; } // Ex: "KPI-SLA-001"
    public string Name { get; set; } // Ex: "Taxa de Cumprimento SLA"
    public string Description { get; set; }
    public string Formula { get; set; } // Ex: "(resolved_on_time / total) * 100"
    public KpiType Type { get; set; } // Percentage, Value, Count, Duration
    public string Unit { get; set; } // %, R$, dias, horas, etc
    public KpiAggregation Aggregation { get; set; } // Daily, Weekly, Monthly, etc
    public int ClienteId { get; set; } // Multi-tenancy
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
    public bool IsActive { get; set; }
    public string? Formula_Description { get; set; } // Documentação da fórmula
}

public enum KpiType
{
    Percentage = 1,
    Value = 2,
    Count = 3,
    Duration = 4,
    Custom = 5
}

public enum KpiAggregation
{
    Daily = 1,
    Weekly = 2,
    Monthly = 3,
    Quarterly = 4,
    Annually = 5,
    Custom = 6
}
```

**Exemplos**:
- ✅ KPI válido: Code="KPI-SLA-001", Type=Percentage, Unit="%", Formula="(resolved_on_time / total) * 100"
- ❌ KPI inválido: Code com caracteres especiais, Formula com sintaxe inválida

---

### RN-KPI-093-02: Validação de Fórmulas Customizadas

**Descrição**: Fórmulas customizadas devem ser validadas quanto a sintaxe, operadores suportados e referências a campos válidos antes de serem salvas.

**Justificativa**: Previne erros de cálculo que afetam a confiabilidade dos indicadores e evita falhas durante execução de cálculos batch.

**Implementação**:
```csharp
public class FormulaValidator
{
    public bool ValidateFormula(string formula)
    {
        // Verificar operadores suportados
        var allowedOperators = new[] { "+", "-", "*", "/", "(", ")", "SUM", "AVG", "COUNT", "MAX", "MIN", "IF" };
        var allowedFunctions = new[] { "DATEDIFF", "CONVERT", "CAST", "ROUND" };

        // Validar sintaxe
        var regexPattern = @"^[\w\s\(\)\+\-\*\/\.]+$";
        if (!Regex.IsMatch(formula, regexPattern))
            return false;

        // Validar parênteses balanceados
        if (!CheckBalancedParentheses(formula))
            return false;

        // Validar campos referenciados existem
        var fieldReferences = ExtractFieldReferences(formula);
        foreach (var field in fieldReferences)
        {
            if (!IsValidField(field))
                return false;
        }

        return true;
    }

    private bool CheckBalancedParentheses(string formula)
    {
        int count = 0;
        foreach (var c in formula)
        {
            if (c == '(') count++;
            if (c == ')') count--;
            if (count < 0) return false;
        }
        return count == 0;
    }
}
```

**Exemplos**:
- ✅ Fórmula válida: "(resolved_on_time / total) * 100"
- ❌ Fórmula inválida: "SUM(invalid_field)" - campo não existe
- ❌ Fórmula inválida: "(resolved_on_time / total * 100" - parênteses desbalanceados

---

### RN-KPI-093-03: Cálculo Automático via Hangfire

**Descrição**: KPIs com aggregation = Calculated devem ser calculados automaticamente em job batch agendado via Hangfire, respeitando a frequência configurada (diária, semanal, mensal).

**Justificativa**: Garante que métricas sejam atualizadas regularmente sem intervenção manual, mantendo dados sempre atualizados para decisões.

**Implementação**:
```csharp
public class KpiCalculationService
{
    private readonly IBackgroundJobClient _backgroundJobClient;
    private readonly IRepository<KpiDefinition> _kpiRepository;

    public void ScheduleKpiCalculations()
    {
        // Agendar cálculos diários às 02:00 AM
        RecurringJob.AddOrUpdate(
            "daily-kpi-calculation",
            () => CalculateKpis(KpiAggregation.Daily),
            Cron.Daily(2, 0)
        );

        // Agendar cálculos semanais (segunda-feira, 03:00 AM)
        RecurringJob.AddOrUpdate(
            "weekly-kpi-calculation",
            () => CalculateKpis(KpiAggregation.Weekly),
            Cron.Weekly(DayOfWeek.Monday, 3, 0)
        );

        // Agendar cálculos mensais (1º dia do mês, 04:00 AM)
        RecurringJob.AddOrUpdate(
            "monthly-kpi-calculation",
            () => CalculateKpis(KpiAggregation.Monthly),
            Cron.Monthly(1, 4, 0)
        );
    }

    public void CalculateKpis(KpiAggregation aggregation)
    {
        var kpis = _kpiRepository.GetAll()
            .Where(k => k.Aggregation == aggregation && k.IsActive)
            .ToList();

        foreach (var kpi in kpis)
        {
            try
            {
                var value = EvaluateFormula(kpi.Formula, kpi.ClienteId);
                var calculation = new KpiCalculation
                {
                    KpiId = kpi.Id,
                    Value = value,
                    CalculatedAt = DateTime.UtcNow,
                    Period = GetPeriod(aggregation),
                    Status = "SUCCESS"
                };
                _repository.Create(calculation);

                // Verificar alertas
                CheckAndTriggerAlerts(kpi, value);
            }
            catch (Exception ex)
            {
                _logger.LogError($"Error calculating KPI {kpi.Code}: {ex.Message}");
                // Registrar erro para auditoria
            }
        }
    }
}
```

**Exemplos**:
- ✅ KPI diário executado automaticamente todo dia às 02:00 AM
- ❌ KPI com fórmula inválida: falha no job batch com log de erro

---

### RN-KPI-093-04: Metas Configuráveis com Limites de Alerta

**Descrição**: Cada KPI pode ter uma ou mais metas associadas, definidas por período (data início/fim) e conglomerado. Metas definem limites mínimo, ideal e máximo para o indicador.

**Justificativa**: Permite que gestores definam expectativas diferentes para diferentes períodos e conglomerados, facilitando acompanhamento de progresso.

**Implementação**:
```csharp
public class KpiTarget
{
    public int Id { get; set; }
    public int KpiId { get; set; }
    public int ClienteId { get; set; }
    public decimal MinValue { get; set; } // Limite mínimo (vermelho)
    public decimal IdealValue { get; set; } // Meta desejada (verde)
    public decimal MaxValue { get; set; } // Limite máximo (amarelo se exceder)
    public DateTime StartDate { get; set; }
    public DateTime EndDate { get; set; }
    public string? Notes { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
}

public class TargetStatus
{
    public enum Status { Red, Yellow, Green }

    public static Status GetStatus(decimal value, KpiTarget target)
    {
        if (value < target.MinValue)
            return Status.Red; // Abaixo da meta

        if (value >= target.IdealValue)
            return Status.Green; // Meta atingida ou superada

        // Valor entre mínimo e ideal
        var percentage = (value - target.MinValue) / (target.IdealValue - target.MinValue) * 100;
        return percentage >= 80 ? Status.Yellow : Status.Red;
    }
}
```

**Exemplos**:
- ✅ Meta válida: MinValue=85%, IdealValue=95%, MaxValue=100% para "Taxa de Cumprimento SLA"
- ❌ Meta inválida: IdealValue (80) < MinValue (90) - valores inconsistentes

---

### RN-KPI-093-05: Indicadores de SLA (RF028, RF029)

**Descrição**: KPIs específicos para monitoramento de SLA devem ser calculados a partir dos dados de RF028 (Gestão de SLA - Operações) e RF029 (Gestão de SLA - Serviços).

**Justificativa**: Permite análise centralizada de cumprimento de SLAs em operações e serviços, identificando áreas com problemas.

**Implementação**:
```csharp
public class SlaKpiCalculator
{
    public decimal CalculateSlaCompliancePercentage(int clienteId, DateTime startDate, DateTime endDate)
    {
        var slas = _slaRepository.GetByPeriod(clienteId, startDate, endDate);
        var totalSlas = slas.Count();

        if (totalSlas == 0) return 0;

        var compliantSlas = slas.Count(s => s.IsCompliant);
        return (compliantSlas / totalSlas) * 100;
    }

    public Dictionary<string, decimal> CalculateSlaByService(int clienteId, DateTime startDate, DateTime endDate)
    {
        return _slaRepository.GetByPeriod(clienteId, startDate, endDate)
            .GroupBy(s => s.ServiceName)
            .ToDictionary(
                g => g.Key,
                g => (g.Count(s => s.IsCompliant) / g.Count()) * 100
            );
    }

    public decimal CalculateAverageResolutionTime(int clienteId, DateTime startDate, DateTime endDate)
    {
        var tickets = _ticketRepository.GetByPeriod(clienteId, startDate, endDate);
        return tickets.Average(t => (t.ResolvedAt - t.CreatedAt)?.TotalHours ?? 0);
    }
}

// KPIs de SLA pré-definidos
public static class PredefinedSlaKpis
{
    public const string SLA_COMPLIANCE = "KPI-SLA-001"; // Taxa cumprimento SLA
    public const string AVG_RESOLUTION_TIME = "KPI-SLA-002"; // Tempo médio resolução
    public const string FIRST_RESPONSE_TIME = "KPI-SLA-003"; // Tempo 1ª resposta
    public const string CRITICAL_TICKET_RESOLUTION = "KPI-SLA-004"; // Resolução tickets críticos
}
```

**Exemplos**:
- ✅ SLA Compliance: 1200 SLAs no período, 1140 cumpridos = 95% (Verde)
- ❌ SLA Compliance: 1200 SLAs no período, 960 cumpridos = 80% (Amarelo)

---

### RN-KPI-093-06: Indicadores de Contratos (RF023, RF090)

**Descrição**: KPIs vinculados a contratos (RF023) devem medir performance de fornecedores e cumprimento de obrigações contratuais, permitindo cálculo automático de multas/bônus.

**Justificativa**: Garante transparência na avaliação de fornecedores e permite aplicação automática de cláusulas de multa/incentivo baseadas em performance real.

**Implementação**:
```csharp
public class ContractKpiCalculator
{
    public ContractPerformanceMetrics CalculateSupplierPerformance(int contractId, DateTime startDate, DateTime endDate)
    {
        var contract = _contractRepository.GetById(contractId);
        var deliverables = _deliverablesRepository.GetByContract(contractId);

        var metrics = new ContractPerformanceMetrics
        {
            ContractId = contractId,
            ServiceDeliveryPercentage = CalculateDeliveryPercentage(deliverables),
            QualityScore = CalculateQualityMetrics(contractId, startDate, endDate),
            ComplianceScore = CalculateComplianceScore(contractId),
            OverallPerformanceScore = 0
        };

        // Cálculo ponderado
        metrics.OverallPerformanceScore =
            (metrics.ServiceDeliveryPercentage * 0.40) +
            (metrics.QualityScore * 0.40) +
            (metrics.ComplianceScore * 0.20);

        return metrics;
    }

    public PenaltyAndBonusCalculation CalculatePenaltiesAndBonuses(int contractId)
    {
        var contract = _contractRepository.GetById(contractId);
        var performance = CalculateSupplierPerformance(contractId, contract.StartDate, DateTime.UtcNow);

        var result = new PenaltyAndBonusCalculation();

        // Aplicar penalidades
        if (performance.OverallPerformanceScore < contract.MinimumPerformanceScore)
        {
            var penaltyPercentage = (contract.MinimumPerformanceScore - performance.OverallPerformanceScore) * 0.01m;
            result.Penalty = contract.MonthlyValue * penaltyPercentage;
        }

        // Aplicar bônus
        if (performance.OverallPerformanceScore >= contract.TargetPerformanceScore)
        {
            var bonusPercentage = (performance.OverallPerformanceScore - contract.TargetPerformanceScore) * 0.005m;
            result.Bonus = contract.MonthlyValue * bonusPercentage;
        }

        return result;
    }
}

public class ContractPerformanceMetrics
{
    public int ContractId { get; set; }
    public decimal ServiceDeliveryPercentage { get; set; }
    public decimal QualityScore { get; set; }
    public decimal ComplianceScore { get; set; }
    public decimal OverallPerformanceScore { get; set; }
}
```

**Exemplos**:
- ✅ Performance score = 98% (acima de 95% target) = Bônus de 0.15% sobre valor mensal
- ❌ Performance score = 75% (abaixo de 80% mínimo) = Multa de 0.25% sobre valor mensal

---

### RN-KPI-093-07: Indicadores de Ativos (Utilização, TCO)

**Descrição**: KPIs que medem utilização de ativos de tecnologia (RF028), incluindo disponibilidade, tempo de inatividade planejada, custo total de propriedade (TCO) por ativo.

**Justificativa**: Permite otimização de investimentos em ativos, identificação de ativos subutilizados e planejamento de substituição.

**Implementação**:
```csharp
public class AssetKpiCalculator
{
    public decimal CalculateAssetUtilization(int assetId, DateTime startDate, DateTime endDate)
    {
        var asset = _assetRepository.GetById(assetId);
        var totalDays = (endDate - startDate).TotalDays;

        // Calcular dias de indisponibilidade (manutenção, reparo)
        var unavailableDays = _maintenanceRepository.GetByAsset(assetId, startDate, endDate)
            .Sum(m => (m.EndDate - m.StartDate).TotalDays);

        var availabilityPercentage = ((totalDays - unavailableDays) / totalDays) * 100;
        return availabilityPercentage;
    }

    public decimal CalculateTotalCostOfOwnership(int assetId, int yearsToConsider = 5)
    {
        var asset = _assetRepository.GetById(assetId);
        var tco = asset.AcquisitionCost; // Custo inicial

        // Adicionar custos operacionais
        var operationalCosts = _costRepository.GetByAsset(assetId)
            .Where(c => c.Type == CostType.Operational)
            .Sum(c => c.Amount);
        tco += operationalCosts;

        // Adicionar custos de manutenção
        var maintenanceCosts = _costRepository.GetByAsset(assetId)
            .Where(c => c.Type == CostType.Maintenance)
            .Sum(c => c.Amount);
        tco += maintenanceCosts;

        // Subtrair valor residual
        tco -= asset.ResidualValue;

        return tco / yearsToConsider; // Custo anual médio
    }

    public Dictionary<int, decimal> CalculateAssetROI(int departmentId)
    {
        var assets = _assetRepository.GetByDepartment(departmentId);
        var roi = new Dictionary<int, decimal>();

        foreach (var asset in assets)
        {
            var annualBenefit = CalculateAnnualBenefit(asset.Id);
            var tco = CalculateTotalCostOfOwnership(asset.Id);
            roi[asset.Id] = ((annualBenefit - tco) / tco) * 100;
        }

        return roi;
    }
}

public class PredefinedAssetKpis
{
    public const string ASSET_AVAILABILITY = "KPI-ASSET-001"; // Disponibilidade
    public const string ASSET_TCO = "KPI-ASSET-002"; // Custo total de propriedade
    public const string ASSET_ROI = "KPI-ASSET-003"; // Retorno do investimento
    public const string ASSET_UTILIZATION = "KPI-ASSET-004"; // Taxa utilização
}
```

**Exemplos**:
- ✅ Asset availability = 99.5% (acima de 99% target)
- ❌ Asset availability = 95% (abaixo de 98% target) = Investigação necessária

---

### RN-KPI-093-08: Alertas Automáticos de Desvio

**Descrição**: Quando um KPI calculado desvia significativamente da meta (entra em status Amarelo ou Vermelho), um alerta automático deve ser disparado via NotificationHub para gestores.

**Justificativa**: Permite resposta rápida a problemas de performance, evitando degradação maior de serviços.

**Implementação**:
```csharp
public class KpiAlertService
{
    public async Task CheckAndTriggerAlerts(KpiDefinition kpi, decimal calculatedValue)
    {
        var target = _targetRepository.GetActive(kpi.Id);
        if (target == null) return;

        var status = TargetStatus.GetStatus(calculatedValue, target);
        var previousAlertStatus = _alertRepository.GetLatestStatus(kpi.Id);

        // Não reenviar alerta do mesmo status
        if (previousAlertStatus?.Status == status) return;

        var alert = new KpiAlert
        {
            KpiId = kpi.Id,
            CalculatedValue = calculatedValue,
            Status = status,
            TargetValue = target.IdealValue,
            Deviation = calculatedValue - target.IdealValue,
            CreatedAt = DateTime.UtcNow,
            AcknowledgedAt = null,
            AcknowledgedBy = null
        };

        _alertRepository.Create(alert);

        // Disparar notificação apenas se Red ou Yellow
        if (status != TargetStatus.Status.Green)
        {
            await _notificationService.SendAlert(new AlertNotification
            {
                Title = $"Alerta KPI: {kpi.Name}",
                Message = $"KPI {kpi.Name} está em status {status}. Valor: {calculatedValue} {kpi.Unit}",
                Severity = status == TargetStatus.Status.Red ? AlertSeverity.Critical : AlertSeverity.Warning,
                Recipients = GetResponsibleUsers(kpi.Id),
                ActionUrl = $"/dashboard/kpi/{kpi.Id}"
            });
        }
    }

    private List<int> GetResponsibleUsers(int kpiId)
    {
        // Recuperar gestores/analistas responsáveis por este KPI
        return _roleRepository.GetUsersWithPermission($"kpi:{kpiId}:acknowledge")
            .Select(u => u.Id)
            .ToList();
    }
}

public class KpiAlert
{
    public int Id { get; set; }
    public int KpiId { get; set; }
    public decimal CalculatedValue { get; set; }
    public TargetStatus.Status Status { get; set; }
    public decimal TargetValue { get; set; }
    public decimal Deviation { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? AcknowledgedAt { get; set; }
    public int? AcknowledgedBy { get; set; }
    public string? AcknowledgmentNotes { get; set; }
}
```

**Exemplos**:
- ✅ KPI em Red (valor < MinValue) = Alerta Critical enviado aos gestores
- ❌ KPI em Green (valor ≥ IdealValue) = Sem alerta

---

### RN-KPI-093-09: Auditoria Completa de Cálculos

**Descrição**: Todos os cálculos de KPI, alterações de metas e reconhecimento de alertas devem ser auditados com registro de quem fez, quando e por quê.

**Justificativa**: Garante rastreabilidade completa para conformidade regulatória (SOX, LGPD) e permite análise de histórico de decisões.

**Implementação**:
```csharp
public class KpiAuditService
{
    public void LogKpiCalculation(KpiDefinition kpi, decimal value, string formulaUsed)
    {
        var audit = new AuditLog
        {
            EntityType = "KPI",
            EntityId = kpi.Id,
            Action = "CALCULATE",
            OldValue = null,
            NewValue = $"Value: {value}, Formula: {formulaUsed}",
            ChangedAt = DateTime.UtcNow,
            ChangedBy = _currentUser.Id,
            IpAddress = _httpContext.Connection.RemoteIpAddress?.ToString(),
            UserAgent = _httpContext.Request.Headers["User-Agent"]
        };
        _auditRepository.Create(audit);
    }

    public void LogTargetChange(KpiTarget target, string changeDetails)
    {
        var audit = new AuditLog
        {
            EntityType = "KPI_TARGET",
            EntityId = target.Id,
            Action = "UPDATE",
            OldValue = JsonConvert.SerializeObject(target.GetOriginalValues()),
            NewValue = JsonConvert.SerializeObject(target),
            ChangedAt = DateTime.UtcNow,
            ChangedBy = _currentUser.Id,
            IpAddress = _httpContext.Connection.RemoteIpAddress?.ToString(),
            UserAgent = _httpContext.Request.Headers["User-Agent"],
            Notes = changeDetails
        };
        _auditRepository.Create(audit);
    }

    public void LogAlertAcknowledgment(KpiAlert alert, string notes)
    {
        var audit = new AuditLog
        {
            EntityType = "KPI_ALERT",
            EntityId = alert.Id,
            Action = "ACKNOWLEDGE",
            OldValue = null,
            NewValue = $"Acknowledged: {notes}",
            ChangedAt = DateTime.UtcNow,
            ChangedBy = _currentUser.Id,
            IpAddress = _httpContext.Connection.RemoteIpAddress?.ToString(),
            UserAgent = _httpContext.Request.Headers["User-Agent"]
        };
        _auditRepository.Create(audit);
    }
}

public class AuditLog
{
    public int Id { get; set; }
    public string EntityType { get; set; }
    public int EntityId { get; set; }
    public string Action { get; set; } // CREATE, UPDATE, DELETE, CALCULATE, ACKNOWLEDGE
    public string? OldValue { get; set; }
    public string? NewValue { get; set; }
    public DateTime ChangedAt { get; set; }
    public int ChangedBy { get; set; }
    public string? IpAddress { get; set; }
    public string? UserAgent { get; set; }
    public string? Notes { get; set; }
    public int ClienteId { get; set; }
}
```

**Exemplos**:
- ✅ Log: "KPI-SLA-001 calculado = 95%, fórmula = (compliant/total)*100, executado por Hangfire"
- ✅ Log: "Meta KPI-SLA-001 alterada de 90% para 95% por João Silva às 14:30"

---

### RN-KPI-093-10: Exportação para Power BI e Tableau

**Descrição**: KPIs e suas métricas históricas devem ser exportáveis em formato estruturado (OData, JSON, CSV) para integração com ferramentas de BI.

**Justificativa**: Permite análises avançadas, criação de dashboards personalizados e compartilhamento de dados com stakeholders.

**Implementação**:
```csharp
public class KpiExportService
{
    public async Task<FileStream> ExportToCSV(int clienteId, DateTime startDate, DateTime endDate)
    {
        var kpis = _kpiRepository.GetByClient(clienteId);
        var calculations = _calculationRepository.GetByPeriod(clienteId, startDate, endDate);

        var csv = new StringBuilder();
        csv.AppendLine("KPI_CODE,KPI_NAME,UNIT,CALCULATION_DATE,VALUE,TARGET,STATUS,VARIANCE");

        foreach (var calc in calculations)
        {
            var kpi = kpis.FirstOrDefault(k => k.Id == calc.KpiId);
            var target = _targetRepository.GetActive(calc.KpiId);
            var status = target != null ? TargetStatus.GetStatus(calc.Value, target) : "N/A";
            var variance = target != null ? calc.Value - target.IdealValue : 0;

            csv.AppendLine($"{kpi.Code},{kpi.Name},{kpi.Unit},{calc.CalculatedAt:yyyy-MM-dd},{calc.Value},{target?.IdealValue},{status},{variance}");
        }

        var stream = new MemoryStream(Encoding.UTF8.GetBytes(csv.ToString()));
        return stream;
    }

    public async Task<IEnumerable<KpiODataViewModel>> GetODataFeed(int clienteId)
    {
        return _kpiRepository.GetByClient(clienteId)
            .Include(k => k.Calculations)
            .Include(k => k.Targets)
            .Select(k => new KpiODataViewModel
            {
                Id = k.Id,
                Code = k.Code,
                Name = k.Name,
                Type = k.Type,
                Unit = k.Unit,
                LastCalculationDate = k.Calculations.OrderByDescending(c => c.CalculatedAt).FirstOrDefault()?.CalculatedAt,
                LastCalculationValue = k.Calculations.OrderByDescending(c => c.CalculatedAt).FirstOrDefault()?.Value,
                CurrentTarget = k.Targets.FirstOrDefault(t => DateTime.UtcNow >= t.StartDate && DateTime.UtcNow <= t.EndDate)?.IdealValue,
                Trend = CalculateTrend(k.Id)
            })
            .ToList();
    }

    public IEnumerable<KpiHistoricalData> GetHistoricalData(int kpiId, int monthsBack = 12)
    {
        var startDate = DateTime.UtcNow.AddMonths(-monthsBack);
        return _calculationRepository.GetByKpi(kpiId)
            .Where(c => c.CalculatedAt >= startDate)
            .OrderBy(c => c.CalculatedAt)
            .Select(c => new KpiHistoricalData
            {
                Date = c.CalculatedAt,
                Value = c.Value,
                TargetValue = _targetRepository.GetActive(kpiId)?.IdealValue,
                Status = TargetStatus.GetStatus(c.Value, _targetRepository.GetActive(kpiId))
            })
            .ToList();
    }
}
```

**Exemplos**:
- ✅ CSV export com 500 cálculos de KPI para análise em Power BI
- ✅ OData feed atualizado em tempo real com últimas métricas

---

## REFERENCIAS AO LEGADO

### 3.1 Banco de Dados Legado

**Banco**: `iControl1` (SQL Server)

**Tabelas Relacionadas a KPIs e Indicadores**:

```sql
-- Tabela de KPIs (se existir)
CREATE TABLE [dbo].[KPI](
    [Id_KPI] [int] IDENTITY(1,1) NOT NULL,
    [Cod_KPI] [varchar](50) NOT NULL,
    [Nom_KPI] [varchar](250) NOT NULL,
    [Des_KPI] [text] NULL,
    [Ind_Tipo] [int] NULL, -- 1=Percentage, 2=Value, 3=Count
    [Uni_KPI] [varchar](20) NULL,
    [Ind_Ativo] [bit] NOT NULL DEFAULT 1,
    [Dat_Criacao] [datetime] NOT NULL,
    [Dat_Atualizacao] [datetime] NULL,
    CONSTRAINT [PK_KPI] PRIMARY KEY CLUSTERED ([Id_KPI] ASC)
);

-- Tabela de Metas
CREATE TABLE [dbo].[KPI_Meta](
    [Id_Meta] [int] IDENTITY(1,1) NOT NULL,
    [Id_KPI] [int] NOT NULL,
    [Num_Valor_Min] [decimal](18,2) NOT NULL,
    [Num_Valor_Ideal] [decimal](18,2) NOT NULL,
    [Num_Valor_Max] [decimal](18,2) NOT NULL,
    [Dat_Inicio] [datetime] NOT NULL,
    [Dat_Fim] [datetime] NULL,
    [Des_Notas] [text] NULL,
    [Dat_Criacao] [datetime] NOT NULL,
    CONSTRAINT [PK_KPI_Meta] PRIMARY KEY CLUSTERED ([Id_Meta] ASC),
    CONSTRAINT [FK_KPI_Meta_KPI] FOREIGN KEY ([Id_KPI]) REFERENCES [dbo].[KPI]([Id_KPI])
);

-- Tabela de Cálculos/Histórico
CREATE TABLE [dbo].[KPI_Calculo](
    [Id_Calculo] [int] IDENTITY(1,1) NOT NULL,
    [Id_KPI] [int] NOT NULL,
    [Num_Valor] [decimal](18,4) NOT NULL,
    [Des_Formula_Usada] [text] NULL,
    [Dat_Calculo] [datetime] NOT NULL,
    [Des_Periodo] [varchar](50) NULL,
    [Ind_Status] [int] NULL, -- 1=Success, 2=Error
    [Des_Erro] [text] NULL,
    CONSTRAINT [PK_KPI_Calculo] PRIMARY KEY CLUSTERED ([Id_Calculo] ASC),
    CONSTRAINT [FK_KPI_Calculo_KPI] FOREIGN KEY ([Id_KPI]) REFERENCES [dbo].[KPI]([Id_KPI])
);

-- Tabela de Alertas
CREATE TABLE [dbo].[KPI_Alerta](
    [Id_Alerta] [int] IDENTITY(1,1) NOT NULL,
    [Id_KPI] [int] NOT NULL,
    [Num_Valor_Calculado] [decimal](18,4) NOT NULL,
    [Ind_Status] [int] NOT NULL, -- 1=Red, 2=Yellow, 3=Green
    [Ind_Reconhecido] [bit] NOT NULL DEFAULT 0,
    [Dat_Criacao] [datetime] NOT NULL,
    [Dat_Reconhecimento] [datetime] NULL,
    [Id_Usuario_Reconhecimento] [int] NULL,
    [Des_Notas] [text] NULL,
    CONSTRAINT [PK_KPI_Alerta] PRIMARY KEY CLUSTERED ([Id_Alerta] ASC),
    CONSTRAINT [FK_KPI_Alerta_KPI] FOREIGN KEY ([Id_KPI]) REFERENCES [dbo].[KPI]([Id_KPI])
);
```

**Campos Importantes**:

| Campo Legado | Descrição | Uso no Modernizado |
|--------------|-----------|-------------------|
| `[Cod_KPI]` | Código único do KPI | Será `Code` no modelo novo |
| `[Nom_KPI]` | Nome descritivo | Será `Name` |
| `[Ind_Tipo]` | Tipo de indicador | Mapeado para enum `KpiType` |
| `[Uni_KPI]` | Unidade (%, R$, horas) | Será `Unit` |
| `[Num_Valor]` | Valor calculado | Será `Value` em `KpiCalculation` |
| `[Dat_Calculo]` | Data do cálculo | Será `CalculatedAt` |

### 3.2 Stored Procedures Legado

| Procedure | Descrição | Migração |
|-----------|-----------|----------|
| `pa_CalcularKPI_SLA` | Calcula KPIs de SLA | Implementar via `SlaKpiCalculator` em C# |
| `pa_CalcularKPI_Contrato` | Calcula KPIs de contratos | Implementar via `ContractKpiCalculator` em C# |
| `pa_CalcularKPI_Ativo` | Calcula KPIs de ativos | Implementar via `AssetKpiCalculator` em C# |
| `pa_VerificarAlertas` | Verifica e dispara alertas | Implementar via `KpiAlertService` em C# |
| `pa_GerarRelatorioKPI` | Gera relatório de KPIs | Implementar via `KpiReportService` em C# |

### 3.3 Telas ASPX Legado

| Página | Descrição | Tela Moderna |
|--------|-----------|--------------|
| `Dashboard.aspx` | Dashboard com indicadores | `/dashboard/kpi` (Angular) |
| `GestaoKPI.aspx` | Gerenciamento de KPIs | `/admin/kpi-management` |
| `MetasKPI.aspx` | Gestão de metas de KPI | `/admin/kpi-targets` |
| `RelatorioKPI.aspx` | Relatórios de KPI | `/reports/kpi-analytics` |

### 3.4 WebServices Legado (VB.NET)

**Arquivo**: `D:\IC2\ic1_legado\WebService\WSKPI.asmx.vb`

| Metodo | Descrição | Endpoint Moderno |
|--------|-----------|-----------------|
| `GetKPIs()` | Retorna lista de KPIs | `GET /api/kpi` |
| `GetKPIById(int id)` | Retorna KPI específico | `GET /api/kpi/{id}` |
| `CalcularKPI(int kpiId)` | Calcula KPI sob demanda | `POST /api/kpi/{id}/calculate` |
| `GetAlertas(int kpiId)` | Retorna alertas do KPI | `GET /api/kpi/{id}/alerts` |
| `ReconhecerAlerta(int alertaId)` | Reconhece um alerta | `POST /api/kpi/alerts/{id}/acknowledge` |

---

## INTEGRACOES OBRIGATORIAS

### 4.1 Central de Funcionalidades (Feature Flags)

**FeatureKey**: `KPI_MANAGEMENT`

**Configuração**:
```json
{
    "featureKey": "KPI_MANAGEMENT",
    "nome": "Gestão de Indicadores de Performance e Compliance",
    "descricao": "Sistema centralizado de KPIs com cálculo automático, metas, alertas e auditoria completa",
    "habilitado": true,
    "isSystemFeature": false,
    "features": {
        "KPI_CALCULATIONS_AUTOMATIC": {
            "nome": "Cálculos Automáticos via Hangfire",
            "descricao": "Executa cálculos de KPI em job batch agendado",
            "habilitado": true
        },
        "KPI_ALERTS": {
            "nome": "Alertas Automáticos",
            "descricao": "Dispara alertas quando KPI sai dos limites",
            "habilitado": true
        },
        "KPI_REALTIME_DASHBOARD": {
            "nome": "Dashboard em Tempo Real",
            "descricao": "Atualização de dashboard via SignalR",
            "habilitado": true
        },
        "KPI_POWERBI_EXPORT": {
            "nome": "Exportação para Power BI",
            "descricao": "Exporta KPIs para análise em ferramentas BI",
            "habilitado": true
        }
    }
}
```

---

### 4.2 Internacionalização (i18n)

**Chaves de Tradução**:

```json
{
    "KPI": {
        "TITLE": "Indicadores de Performance e Compliance",
        "SUBTITLE": "Gestão centralizada de KPIs, metas e alertas",
        "TABS": {
            "DASHBOARD": "Dashboard",
            "KPIS": "KPIs",
            "TARGETS": "Metas",
            "ALERTS": "Alertas",
            "HISTORY": "Histórico",
            "REPORTS": "Relatórios"
        },
        "FIELDS": {
            "CODE": "Código",
            "NAME": "Nome",
            "DESCRIPTION": "Descrição",
            "TYPE": "Tipo",
            "UNIT": "Unidade",
            "FORMULA": "Fórmula",
            "AGGREGATION": "Agregação",
            "FORMULA_DESCRIPTION": "Descrição da Fórmula",
            "IS_ACTIVE": "Ativo",
            "MIN_VALUE": "Valor Mínimo",
            "IDEAL_VALUE": "Valor Ideal",
            "MAX_VALUE": "Valor Máximo",
            "START_DATE": "Data Início",
            "END_DATE": "Data Fim",
            "CALCULATED_VALUE": "Valor Calculado",
            "STATUS": "Status",
            "DEVIATION": "Desvio"
        },
        "TYPES": {
            "PERCENTAGE": "Percentual (%)",
            "VALUE": "Valor (R$)",
            "COUNT": "Contagem",
            "DURATION": "Duração (horas/dias)",
            "CUSTOM": "Customizado"
        },
        "AGGREGATIONS": {
            "DAILY": "Diário",
            "WEEKLY": "Semanal",
            "MONTHLY": "Mensal",
            "QUARTERLY": "Trimestral",
            "ANNUALLY": "Anual",
            "CUSTOM": "Customizado"
        },
        "STATUSES": {
            "RED": "Crítico",
            "YELLOW": "Atenção",
            "GREEN": "Normal"
        },
        "MESSAGES": {
            "SAVE_SUCCESS": "KPI salvo com sucesso",
            "UPDATE_SUCCESS": "KPI atualizado com sucesso",
            "DELETE_SUCCESS": "KPI excluído com sucesso",
            "DELETE_CONFIRM": "Deseja realmente excluir este KPI?",
            "CALCULATION_SUCCESS": "KPI calculado com sucesso",
            "CALCULATION_ERROR": "Erro ao calcular KPI",
            "FORMULA_INVALID": "Fórmula inválida",
            "TARGET_SAVED": "Meta salva com sucesso",
            "ALERT_ACKNOWLEDGED": "Alerta reconhecido com sucesso"
        },
        "VALIDATION": {
            "CODE_REQUIRED": "Código do KPI é obrigatório",
            "CODE_INVALID": "Código deve conter apenas letras, números e underscore",
            "NAME_REQUIRED": "Nome do KPI é obrigatório",
            "FORMULA_REQUIRED": "Fórmula é obrigatória",
            "FORMULA_INVALID": "Fórmula contém erros de sintaxe",
            "TYPE_REQUIRED": "Tipo é obrigatório",
            "UNIT_REQUIRED": "Unidade é obrigatória",
            "MIN_GREATER_THAN_IDEAL": "Valor mínimo não pode ser maior que ideal",
            "IDEAL_GREATER_THAN_MAX": "Valor ideal não pode ser maior que máximo"
        }
    },
    "ALERTS": {
        "TITLE": "Alertas",
        "CRITICAL": "Crítico",
        "WARNING": "Aviso",
        "INFO": "Informativo",
        "ACKNOWLEDGE": "Reconhecer",
        "ACKNOWLEDGED": "Reconhecido em {{date}} por {{user}}"
    }
}
```

---

### 4.3 Auditoria

**Operações Auditadas**:

| Operação | Código | Dados Registrados |
|----------|--------|-------------------|
| Criar KPI | `KPI_DEFINITION_CREATE` | Code, Name, Type, Formula, Unit, Aggregation |
| Alterar KPI | `KPI_DEFINITION_UPDATE` | Campos alterados (before/after) |
| Deletar KPI | `KPI_DEFINITION_DELETE` | Code, Name, motivo exclusão |
| Calcular KPI | `KPI_CALCULATION_EXECUTE` | KPI Code, Valor, Fórmula usada, Período |
| Alterar Meta | `KPI_TARGET_UPDATE` | MinValue, IdealValue, MaxValue, Período |
| Reconhecer Alerta | `KPI_ALERT_ACKNOWLEDGE` | Alert ID, Notas do reconhecimento |
| Exportar KPI | `KPI_EXPORT` | Formato (CSV/JSON), Período, Usuário |

**Retenção**: 5 anos (conforme SOX e regulações de compliance)

---

### 4.4 Controle de Acesso (RBAC)

**Permissões**:

| Permissão | Descrição | Perfis |
|-----------|-----------|--------|
| `kpi:definition:create` | Criar novos KPIs | Admin, Gerente Operacional |
| `kpi:definition:read` | Visualizar KPIs | Admin, Gerente Operacional, Analista, Gestor Financeiro |
| `kpi:definition:update` | Editar KPIs | Admin, Gerente Operacional |
| `kpi:definition:delete` | Deletar KPIs | Admin |
| `kpi:target:create` | Criar metas | Admin, Gerente Operacional |
| `kpi:target:update` | Alterar metas | Admin, Gerente Operacional |
| `kpi:target:delete` | Deletar metas | Admin |
| `kpi:calculation:trigger` | Executar cálculo sob demanda | Admin, Gerente Operacional |
| `kpi:alert:acknowledge` | Reconhecer alertas | Admin, Gerente Operacional, Gestor, Responsável |
| `kpi:alert:read` | Visualizar alertas | Admin, Gerente Operacional, Gestor, Responsável |
| `kpi:report:export` | Exportar dados para BI | Admin, Analista, Gestor Financeiro |
| `kpi:dashboard:view` | Visualizar dashboard | Todos os usuários autenticados |

---

## ENDPOINTS DA API

### 5.1 CRUD Principal

| Metodo | Endpoint | Descrição | Permissão |
|--------|----------|-----------|-----------|
| GET | `/api/kpi` | Listar KPIs | `kpi:definition:read` |
| GET | `/api/kpi/{id}` | Obter KPI por ID | `kpi:definition:read` |
| POST | `/api/kpi` | Criar novo KPI | `kpi:definition:create` |
| PUT | `/api/kpi/{id}` | Atualizar KPI | `kpi:definition:update` |
| DELETE | `/api/kpi/{id}` | Deletar KPI | `kpi:definition:delete` |

### 5.2 Operações Especiais

| Metodo | Endpoint | Descrição | Permissão |
|--------|----------|-----------|-----------|
| POST | `/api/kpi/{id}/calculate` | Calcular KPI sob demanda | `kpi:calculation:trigger` |
| GET | `/api/kpi/{id}/history` | Obter histórico de cálculos | `kpi:definition:read` |
| GET | `/api/kpi/{id}/alerts` | Listar alertas do KPI | `kpi:alert:read` |
| POST | `/api/kpi/alerts/{id}/acknowledge` | Reconhecer um alerta | `kpi:alert:acknowledge` |
| POST | `/api/kpi/{id}/export` | Exportar KPI para BI | `kpi:report:export` |
| GET | `/api/kpi/targets` | Listar metas ativas | `kpi:definition:read` |
| POST | `/api/kpi/{id}/targets` | Criar meta para KPI | `kpi:target:create` |
| PUT | `/api/kpi/targets/{id}` | Atualizar meta | `kpi:target:update` |
| DELETE | `/api/kpi/targets/{id}` | Deletar meta | `kpi:target:delete` |
| GET | `/api/kpi/dashboard/summary` | Dashboard executivo resumido | `kpi:dashboard:view` |
| GET | `/api/kpi/compliance/report` | Relatório de compliance | `kpi:report:export` |
| POST | `/api/kpi/validate-formula` | Validar sintaxe de fórmula | `kpi:definition:create` |
| GET | `/api/kpi/audit-log` | Histórico de auditoria | `kpi:audit:read` |

---

## FLUXOS PRINCIPAIS

### 6.1 Fluxo de Criação e Cálculo de KPI

```
Gerente Operacional acessa /admin/kpi-management
    |
    v
Clica em "Novo KPI"
    |
    v
Preenche formulário (Code, Name, Type, Formula, Unit, Aggregation)
    |
    v
Sistema valida fórmula (CheckBalancedParentheses + ValidateFieldReferences)
    |
    +--- Fórmula inválida ---> Exibe erro, retorna ao formulário
    |
    v (Fórmula válida)
Salva KPI no banco de dados
    |
    v
Registra ação em AuditLog (KPI_DEFINITION_CREATE)
    |
    v
Sistema agenda cálculo automático via Hangfire
    |
    v (Job Hangfire dispara em horário agendado)
Executa KpiCalculationService.CalculateKpis()
    |
    v
Recupera dados da fonte (SLA, Contratos, Ativos, etc)
    |
    v
Avalia fórmula do KPI (EvaluateFormula)
    |
    v
Salva resultado em KpiCalculation
    |
    v
Recupera meta ativa (KpiTarget)
    |
    v
Determina status (Red/Yellow/Green)
    |
    +--- Status mudou ---> Dispara alerta (SendAlert via NotificationHub)
    |
    v
Dashboard é atualizado em tempo real via SignalR
```

### 6.2 Fluxo de Reconhecimento de Alerta

```
Gestor recebe notificação de alerta (Email/Push/In-app)
    |
    v
Clica em alerta ou acessa /dashboard/kpi/alerts
    |
    v
Visualiza detalhes do KPI em status Red/Yellow
    |
    v
Clica "Reconhecer Alerta"
    |
    v
Dialogo pede notas (motivo do desvio, ações tomadas)
    |
    v
POST /api/kpi/alerts/{id}/acknowledge com notas
    |
    v
Sistema valida permissão (kpi:alert:acknowledge)
    |
    v
Atualiza KpiAlert (AcknowledgedAt = now, AcknowledgedBy = user)
    |
    v
Registra em AuditLog (KPI_ALERT_ACKNOWLEDGE)
    |
    v
Remove alerta de notificação (alerta vira histórico)
    |
    v
Dashboard atualiza via SignalR
```

### 6.3 Fluxo de Exportação para Power BI

```
Analista acessa /reports/kpi-analytics
    |
    v
Seleciona período (data início, data fim)
    |
    v
Seleciona KPIs a exportar (multi-select)
    |
    v
Clica "Exportar para Power BI"
    |
    v
POST /api/kpi/export com parâmetros
    |
    v
Sistema valida permissão (kpi:report:export)
    |
    v
KpiExportService.ExportToOData() recupera dados
    |
    v
Estrutura dados em formato OData (estruturado para BI)
    |
    v
Inclui histórico de cálculos e metas
    |
    v
Registra exportação em AuditLog (KPI_EXPORT)
    |
    v
Retorna JSON/CSV para download
    |
    v
Power BI consome dados (refresh agendado)
```

---

## SEGURANCA

### 7.1 Proteções Implementadas

| Proteção | Descrição |
|----------|-----------|
| **RBAC com Permissões Granulares** | Controle fino por operação (create, read, update, delete) |
| **Validação de Fórmulas** | Previne SQL injection via FormulaValidator |
| **Parametrização de Queries** | Uso de prepared statements para todas as queries |
| **Sanitização de Entrada** | Remoção de caracteres perigosos em Code, Name |
| **Auditoria Completa** | Log de todas operações com IP, User-Agent, timestamp |
| **Criptografia de Transmissão** | HTTPS obrigatório para todos endpoints |
| **Rate Limiting** | Proteção contra brute force em export/calculate endpoints |
| **Mascaramento de Dados Sensíveis** | Fórmulas com credenciais (API keys) não são expostas em listagens |
| **Validação de ClienteId** | Multi-tenancy enforced em cada query |
| **Isolamento de Dados** | Usuário vê apenas KPIs do seu conglomerado |
| **Timeout de Cálculo** | Fórmulas customizadas com timeout máximo (30 segundos) |
| **Assinatura de Alertas** | Alertas incluem hash para verificar integridade |

### 7.2 Testes de Segurança Obrigatórios

- [ ] SQL Injection em campos Code, Name, Formula_Description
- [ ] XSS em campos de entrada via Angular sanitization
- [ ] CSRF Protection com tokens válidos
- [ ] Validação de permissões (usuário sem `kpi:definition:read` não pode ver KPI)
- [ ] Isolamento de ClienteId (usuário de um conglomerado não vê dados de outro)
- [ ] Timeout de cálculo de fórmula (30 segundos máximo)
- [ ] Validação de sintaxe de fórmula (rejeita fórmulas malformadas)
- [ ] Rate limiting em export (máximo 10 exports por hora por usuário)
- [ ] Audit log completo e imutável (não pode ser deletado via UI)
- [ ] Teste de replay attack em reconhecimento de alerta

---

## METRICAS E INDICADORES

### 8.1 KPIs do Próprio Módulo KPI

| KPI | Meta | Medição |
|-----|------|---------|
| Acurácia de Cálculo | 99.9% | Cálculos sem erro / Total |
| Tempo Médio de Cálculo | < 5 segundos | Tempo de execução de cálculo |
| Taxa de Alertas Reconhecidos | > 90% | Alertas reconhecidos / Total alertas |
| Disponibilidade do Dashboard | 99.5% | Uptime do serviço KPI |
| Integridade de Dados | 100% | Cálculos auditáveis, sem divergências |
| Performance de Exportação | < 30 segundos | Tempo para exportar 1000 registros |

### 8.2 Alertas do Módulo KPI

| Alerta | Condição | Ação |
|--------|----------|------|
| Cálculo Falhou | Job Hangfire retorna erro | Enviar notificação para admin + log |
| Dashboard Indisponível | HTTP 5xx em endpoint KPI | Page Error, retry após 30s |
| Fórmula Customizada Lenta | Execução > 30 segundos | Cancelar cálculo, registrar warning |
| Taxa Alertas Não Reconhecidos | > 10 alertas não reconhecidos | Escalone para gerente responsável |
| Auditoria Corrupta | Inconsistência em AuditLog | Alerta crítico para compliance team |

---

## PROXIMOS PASSOS

1. **Modelo de Dados**: Criar [MD-093](./MD-093-Indicadores-Performance-Compliance.md) com DDL completo
2. **Casos de Uso**: Criar [UC-093](./UC-093-Indicadores-Performance-Compliance.md) com 5+ cenários
3. **User Stories**: Criar `user-stories.yaml` com histórias implementáveis
4. **Fluxos Visuais**: Criar [WF-093](./WF-093-Indicadores-Performance-Compliance.md) com mockups
5. **Implementação Backend**: Commands/Queries/Handlers para CRUD e cálculos
6. **Implementação Frontend**: Telas Angular (Dashboard, Gerenciamento de KPIs, Alertas)
7. **Integração SignalR**: Real-time updates no dashboard
8. **Testes E2E**: Validar cálculos, alertas, exportação
9. **Documentação de Testes**: Criar [TC-093-BACKEND.md](./TC-093-BACKEND.md), [TC-093-FRONTEND.md](./TC-093-FRONTEND.md)
10. **Deploy e Sincronização**: Atualizar STATUS.yaml, executar sync-rf.py

---

## CHANGELOG

| Versao | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 1.0 | 2025-12-28 | Versão inicial com 10 regras de negócio, endpoints e integração completa | Claude Code |

---

**Última Atualização**: 2025-12-28
**Autor**: Claude Code (IA)
**Revisão**: Pendente
**Status**: Documentação Concluída
