# RF-111: Backup, Recuperação e Disaster Recovery

**Versão**: 2.0
**Data**: 2025-12-31
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC008-SD-Service-Desk
**Fase**: Fase 5 - Service Desk

---

## 1. OBJETIVO DO REQUISITO

Especificar o comportamento esperado do módulo de Backup, Recuperação e Disaster Recovery (DR) do sistema IControlIT, garantindo continuidade de negócios através de proteção de dados, restauração confiável e planos de contingência em cenários de desastres.

Este requisito define **o que o sistema deve fazer** para proteger dados críticos de negócio, permitir recuperação em caso de falhas e assegurar disponibilidade contínua do sistema, sem especificar tecnologias ou plataformas.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [ ] Execução automática de backups completos, incrementais e diferenciais do banco de dados
- [ ] Backup automático de arquivos (uploads, documentos, configurações)
- [ ] Criptografia obrigatória de todos os backups em repouso
- [ ] Validação de integridade através de checksums antes de restauração
- [ ] Gestão automática de retenção de backups (diário, semanal, mensal)
- [ ] Restauração completa ou parcial de dados a partir de backups
- [ ] Capacidade de restaurar dados para ponto específico no tempo (Point-in-Time Recovery)
- [ ] Plano de Disaster Recovery com failover automático entre regiões
- [ ] Testes periódicos obrigatórios de DR sem impacto em produção
- [ ] Monitoramento e alertas de falhas de backup ou violação de RPO/RTO
- [ ] Auditoria completa de todas as operações de backup e restauração
- [ ] Controle de acesso granular baseado em permissões

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (layout, cores, UX)
- Plataforma de nuvem específica (Azure, AWS, GCP)
- Tecnologia de banco de dados (SQL Server, PostgreSQL, MySQL)
- Linguagem de programação ou framework
- Estratégia de infraestrutura ou containerização
- Ferramentas de backup específicas (Azure Backup, AWS Backup, Veeam)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Backup Completo (Full)** | Cópia integral de todos os dados no momento da execução. Base para backups incrementais e diferenciais. |
| **Backup Incremental** | Cópia apenas dos dados alterados desde o último backup de qualquer tipo. Reduz tempo e espaço de armazenamento. |
| **Backup Diferencial** | Cópia apenas dos dados alterados desde o último backup completo. Equilíbrio entre tamanho e tempo de restauração. |
| **Point-in-Time Recovery (PITR)** | Capacidade de restaurar dados para qualquer momento específico dentro da janela de retenção. |
| **Recovery Point Objective (RPO)** | Intervalo máximo aceitável de perda de dados em caso de falha (RF111: 6 horas). |
| **Recovery Time Objective (RTO)** | Tempo máximo aceitável para restaurar o sistema após falha (RF111: 4 horas). |
| **Disaster Recovery (DR)** | Processo de recuperação de sistemas críticos após evento catastrófico (falha regional, desastre natural, etc.). |
| **Failover** | Transferência automática de operações para ambiente secundário quando o primário fica indisponível. |
| **Retenção de Backups** | Período de tempo durante o qual backups são mantidos antes de serem removidos automaticamente. |
| **Checksum** | Valor calculado criptograficamente a partir dos dados para detectar corrupção ou alterações não autorizadas. |
| **Criptografia em Repouso** | Proteção de dados armazenados através de criptografia, garantindo que dados roubados sejam inacessíveis. |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Backup Automático de Banco de Dados** - Execução programada de backups completos, incrementais e diferenciais
2. **Backup Automático de Arquivos** - Proteção de uploads, documentos e configurações do sistema
3. **Criptografia Obrigatória** - Todos os backups devem ser criptografados antes do armazenamento
4. **Gestão de Retenção** - Remoção automática de backups antigos conforme política definida
5. **Validação de Integridade** - Verificação de checksums antes de qualquer restauração
6. **Restauração Completa** - Recuperação total do sistema a partir de backup
7. **Restauração Point-in-Time** - Recuperação de dados para momento específico no passado
8. **Plano de Disaster Recovery** - Definição de estratégias de recuperação em cenários de desastre
9. **Failover Automático** - Transferência automática para ambiente secundário após detecção de falha
10. **Testes de DR Periódicos** - Validação trimestral obrigatória do plano de DR
11. **Monitoramento e Alertas** - Notificações de falhas, violações de RPO/RTO e espaço insuficiente
12. **Auditoria de Operações** - Registro de todas as operações de backup/restore com usuário, timestamp e resultado

---

## 5. REGRAS DE NEGÓCIO

### RN-RF111-001: Backup Completo Diário em Horário de Baixa Demanda

**Descrição**: Backup completo do banco de dados deve ser executado automaticamente todos os dias em horário de baixa demanda operacional (tipicamente madrugada).

**Justificativa**: Minimiza impacto na performance do sistema durante execução do backup. Garante ponto de restauração diário garantido.

**Critério de Aceite**:
- Backup agendado para horário configurável de baixa demanda
- Execução automática sem intervenção manual
- Falha após 3 tentativas consecutivas deve gerar alerta crítico

---

### RN-RF111-002: Backup Incremental Periódico

**Descrição**: Backup incremental deve ser executado automaticamente em intervalos regulares (padrão: a cada 6 horas), capturando apenas dados alterados desde o último backup de qualquer tipo.

**Justificativa**: Estabelece RPO de 6 horas, garantindo que no máximo 6 horas de transações sejam perdidas em cenário de falha. Reduz tempo de execução e espaço de armazenamento comparado com backups completos.

**Critério de Aceite**:
- Frequência de backup incremental configurável (padrão: 6 horas)
- Apenas dados alterados desde último backup devem ser copiados
- Backup incremental depende de backup completo anterior válido

---

### RN-RF111-003: Política de Retenção Configurável

**Descrição**: Backups devem ser mantidos conforme política configurável: padrão de 7 dias para backups diários, 4 semanas para backups semanais e 12 meses para backups mensais. Backups mais antigos devem ser removidos automaticamente.

**Justificativa**: Equilibra disponibilidade de pontos de restauração com custo de armazenamento. Período de 7 dias cobre maioria dos cenários de corrupção detectados. 12 meses atende conformidade regulatória.

**Critério de Aceite**:
- Política de retenção configurável por tipo de backup (completo, incremental, diferencial)
- Remoção automática de backups expirados
- Backups críticos podem ser marcados como "permanentes" e não serem removidos

---

### RN-RF111-004: Criptografia Obrigatória com Chaves Gerenciadas

**Descrição**: Todos os backups devem ser criptografados com algoritmo forte (mínimo AES-256) antes de serem enviados para armazenamento remoto. Chaves de criptografia devem ser armazenadas em cofre de chaves seguro.

**Justificativa**: Protege contra acesso não autorizado a backups interceptados, roubados ou vazados. Atende conformidade LGPD e padrões de segurança federais.

**Critério de Aceite**:
- Criptografia obrigatória para todos os backups
- Algoritmo mínimo: AES-256
- Chaves armazenadas em cofre de chaves (não em código ou configuração)
- Backup sem criptografia deve ser rejeitado

---

### RN-RF111-005: Validação de Integridade Obrigatória

**Descrição**: Toda restauração de backup deve validar integridade do arquivo através de cálculo de checksum criptográfico (mínimo SHA-256) e comparação com checksum original armazenado. Restauração deve ser abortada se checksums não coincidirem.

**Justificativa**: Detecta corrupção de dados em trânsito ou armazenamento. Previne restauração de dados corrompidos que poderiam piorar o cenário de falha.

**Critério de Aceite**:
- Checksum calculado no momento da criação do backup
- Checksum armazenado junto com metadados do backup
- Validação automática antes de qualquer restauração
- Restauração abortada se checksums diferirem

---

### RN-RF111-006: Garantia de RPO (Recovery Point Objective)

**Descrição**: Sistema deve garantir que, em cenário de falha, no máximo 6 horas de transações sejam perdidas. Isso é estabelecido através de backup incremental a cada 6 horas.

**Justificativa**: Equilibrio entre frequência de backup (que impacta performance) e proteção de dados. Atende maioria dos casos de uso de negócio e conformidade.

**Critério de Aceite**:
- Tempo desde último backup não pode exceder 6 horas
- Violação de RPO deve gerar alerta crítico
- Backup imediato deve ser tentado se RPO for violado

---

### RN-RF111-007: Garantia de RTO (Recovery Time Objective)

**Descrição**: Sistema deve ser capaz de ser restaurado completamente a partir de backup em no máximo 4 horas. Inclui tempo de download, descriptografia, validação de integridade e restauração.

**Justificativa**: Atende SLA comercial e permite continuidade de operações com interrupção limitada. Depende de arquitetura, tamanho de dados e largura de banda disponível.

**Critério de Aceite**:
- Tempo total de restauração deve ser <= 4 horas
- Testes de restauração periódicos devem validar RTO
- Falha em atingir RTO deve gerar revisão do plano de DR

---

### RN-RF111-008: Failover Automático em Caso de Indisponibilidade

**Descrição**: Se ambiente primário fica indisponível por mais de 15 minutos consecutivos, sistema deve automaticamente iniciar processo de failover para ambiente secundário sem intervenção manual.

**Justificativa**: 15 minutos é tempo suficiente para diferenciar falha transitória de falha real, evitando falsos positivos. Failover automático reduz RTO significativamente.

**Critério de Aceite**:
- Monitoramento contínuo de saúde do ambiente primário
- Aguardar 15 minutos antes de iniciar failover (confirmar falha real)
- Failover deve ser automático, sem necessidade de intervenção
- Notificação crítica deve ser enviada aos administradores

---

### RN-RF111-009: Teste de Disaster Recovery Obrigatório

**Descrição**: Teste completo de plano de DR deve ser executado automaticamente a cada trimestre (a cada 3 meses). Teste deve validar que failover funciona, dados são consistentes no ambiente secundário e aplicação fica funcional.

**Justificativa**: Testes periódicos validam que DR não é apenas um plano teórico, mas funciona na prática. Detecta problemas antes de cenário real de desastre.

**Critério de Aceite**:
- Teste trimestral obrigatório (4 testes por ano)
- Teste deve executar em ambiente isolado (não impactar produção)
- Teste deve validar: failover, integridade de dados, funcionalidade da aplicação
- Falha no teste de DR deve gerar alerta crítico e investigação obrigatória

---

### RN-RF111-010: Auditoria Completa de Operações

**Descrição**: Cada operação de backup ou restore deve ser registrada em trilha de auditoria com dados: usuário que iniciou, timestamp, tipo de backup, tamanho, checksum, status (sucesso/falha) e detalhes de erro.

**Justificativa**: Auditoria oferece rastreabilidade, detecta atividades suspeitas, atende conformidade regulatória (LGPD, ISO 27001) e facilita investigação de problemas.

**Critério de Aceite**:
- Registro de todas as operações de backup e restore
- Dados obrigatórios: usuário, timestamp, tipo, tamanho, checksum, status, erro (se aplicável)
- Trilha de auditoria deve ser imutável (append-only)
- Retenção de auditoria: mínimo 12 meses

---

### RN-RF111-011: Isolamento por Tenant

**Descrição**: Em ambientes multi-tenant, backups devem ser isolados por tenant. Um usuário só pode acessar backups do seu próprio tenant.

**Justificativa**: Previne vazamento de dados entre clientes. Atende conformidade LGPD e requisitos de segurança multi-tenant.

**Critério de Aceite**:
- Backups devem incluir identificador do tenant
- Restauração deve validar que usuário pertence ao tenant do backup
- Tentativa de acesso cruzado deve ser rejeitada e auditada

---

### RN-RF111-012: Notificações de Falha e Sucesso

**Descrição**: Sistema deve notificar administradores sobre eventos críticos: falha de backup, violação de RPO/RTO, espaço insuficiente, falha de teste de DR e sucesso de restauração.

**Justificativa**: Permite reação rápida a problemas críticos. Mantém administradores informados sobre saúde do sistema de backup.

**Critério de Aceite**:
- Notificações para eventos críticos (falha, violação de SLA)
- Notificações para eventos informativos (sucesso de backup, sucesso de restore)
- Canais de notificação configuráveis (email, SMS, Slack, etc.)
- Alertas críticos devem ter severidade alta e exigir confirmação

---

## 6. ESTADOS DA ENTIDADE

### Backup

| Estado | Descrição |
|--------|-----------|
| `agendado` | Backup foi agendado mas ainda não iniciou execução |
| `em_progresso` | Backup está sendo executado no momento |
| `concluido` | Backup foi concluído com sucesso e está disponível para restauração |
| `falhado` | Backup falhou durante execução e não está disponível |
| `validando` | Backup está passando por validação de integridade (checksum) |
| `expirado` | Backup ultrapassou período de retenção e foi marcado para remoção |
| `removido` | Backup foi removido do armazenamento |

### Transições Permitidas

| De | Para |
|---|---|
| agendado | em_progresso |
| em_progresso | concluido |
| em_progresso | falhado |
| concluido | validando |
| validando | concluido (validação passou) |
| validando | falhado (validação falhou) |
| concluido | expirado |
| expirado | removido |

---

### Plano de Disaster Recovery

| Estado | Descrição |
|--------|-----------|
| `ativo_primaria` | Sistema operando normalmente em região primária |
| `falha_detectada` | Falha na região primária foi detectada (aguardando confirmação) |
| `failover_iniciado` | Processo de failover para região secundária foi iniciado |
| `ativo_secundaria` | Sistema operando em região secundária após failover |
| `failback_iniciado` | Processo de retorno para região primária foi iniciado |
| `teste_dr` | Teste de DR em execução em ambiente isolado |

### Transições Permitidas

| De | Para |
|---|---|
| ativo_primaria | falha_detectada |
| falha_detectada | ativo_primaria (falha transitória) |
| falha_detectada | failover_iniciado (falha confirmada após 15 min) |
| failover_iniciado | ativo_secundaria |
| ativo_secundaria | failback_iniciado |
| failback_iniciado | ativo_primaria |
| ativo_primaria | teste_dr |
| teste_dr | ativo_primaria |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre |
|--------|---------------|
| `backup.agendado` | Quando backup é agendado para execução futura |
| `backup.iniciado` | Quando execução de backup é iniciada |
| `backup.concluido` | Quando backup é concluído com sucesso |
| `backup.falhado` | Quando backup falha durante execução |
| `backup.validado` | Quando validação de integridade passa com sucesso |
| `backup.expirado` | Quando backup ultrapassa período de retenção |
| `backup.removido` | Quando backup é fisicamente removido do armazenamento |
| `restore.iniciado` | Quando processo de restauração é iniciado |
| `restore.concluido` | Quando restauração é concluída com sucesso |
| `restore.falhado` | Quando restauração falha |
| `dr.falha_detectada` | Quando falha em região primária é detectada |
| `dr.failover_iniciado` | Quando processo de failover é iniciado |
| `dr.failover_concluido` | Quando failover para região secundária é concluído |
| `dr.teste_iniciado` | Quando teste trimestral de DR é iniciado |
| `dr.teste_concluido` | Quando teste de DR é concluído (sucesso ou falha) |
| `alerta.rpo_violado` | Quando RPO de 6 horas é violado |
| `alerta.rto_violado` | Quando RTO de 4 horas é violado |
| `alerta.espaco_insuficiente` | Quando espaço de armazenamento está baixo |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhum backup pode ser criado sem criptografia obrigatória
- Nenhuma restauração pode prosseguir com falha de validação de integridade
- Violações de RPO ou RTO devem gerar alertas críticos obrigatórios
- Em ambientes multi-tenant, isolamento de backups deve ser garantido
- Todas as operações de backup e restore devem ser auditadas
- Falha de 3 backups consecutivos deve escalar para alerta crítico
- Testes trimestrais de DR são obrigatórios e não podem ser omitidos
- Backups devem ser armazenados em múltiplas localizações geográficas

---

## 9. SEGURANÇA

### 9.1 Proteções Implementadas

- **Criptografia obrigatória**: Todos os backups devem ser criptografados com AES-256 ou superior
- **Gestão de chaves**: Chaves de criptografia devem ser armazenadas em cofre de chaves seguro, não em código
- **Validação de integridade**: Checksums SHA-256 devem ser calculados e validados
- **Controle de acesso granular**: Permissões específicas para criar, visualizar, restaurar e deletar backups
- **Isolamento multi-tenant**: Backups de diferentes tenants devem ser completamente isolados
- **Auditoria completa**: Todas as operações devem ser registradas com usuário, timestamp e resultado
- **Proteção contra deleção acidental**: Confirmação obrigatória antes de deletar backups
- **Replicação geográfica**: Backups devem ser replicados em múltiplas regiões automaticamente

### 9.2 Validações Obrigatórias

- Validação de permissões em todas as operações
- Validação de integridade via checksum antes de restauração
- Validação de criptografia antes de upload para armazenamento remoto
- Validação de tenant em ambientes multi-tenant
- Validação de espaço disponível antes de criar backup
- Validação de dependências (backup incremental depende de backup completo)

---

## 10. INTEGRAÇÕES OBRIGATÓRIAS

### 10.1 Internacionalização (i18n)

Sistema deve suportar múltiplos idiomas para:
- Títulos de telas e seções
- Labels de campos
- Mensagens de erro e validação
- Mensagens de sucesso
- Notificações e alertas

**Idiomas obrigatórios**: pt-BR (padrão), en-US, es-ES

### 10.2 Auditoria

Todas as operações devem gerar registros de auditoria com:
- Usuário que executou a operação
- Timestamp (UTC)
- Tipo de operação (criar backup, restaurar, deletar, etc.)
- Dados antes e depois (quando aplicável)
- Resultado (sucesso/falha)
- Mensagem de erro (se aplicável)
- Tenant (em ambientes multi-tenant)

**Retenção de auditoria**: 12 meses (conforme LGPD)

### 10.3 Controle de Acesso (RBAC)

Permissões específicas devem ser definidas e validadas:
- `backup.create` - Criar backup manual
- `backup.view` - Visualizar backups
- `backup.view_any` - Visualizar backups de todos os tenants (admin)
- `backup.restore` - Executar restauração
- `backup.delete` - Deletar backup
- `backup.schedule` - Agendar backups automáticos
- `dr.manage` - Gerenciar plano de DR
- `dr.test` - Executar testes de DR
- `dr.failover` - Iniciar failover manual

### 10.4 Central de Funcionalidades

Funcionalidades devem ser registradas na Central para controle de habilitação:
- `BACKUP_AUTOMATED` - Backup automático de banco de dados
- `BACKUP_FILE_STORAGE` - Backup automático de arquivos
- `BACKUP_PITR` - Point-in-Time Recovery
- `DR_FAILOVER` - Failover automático para DR
- `DR_TEST` - Testes periódicos de DR

---

## 11. ARTEFATOS DERIVADOS

Este RF é base para:

| Artefato | Status | Descrição |
|----------|--------|-----------|
| UC-RF111.md | Obrigatório | Casos de Uso detalhados (UC00-UC04 padrão + casos especiais) |
| MD-RF111.md | Obrigatório | Modelo de Dados com DDL completo |
| WF-RF111.md | Obrigatório | Workflows e mockups de telas |
| MT-RF111.yaml | Obrigatório | Massas de Teste para automação |
| TC-RF111.yaml | Obrigatório | Casos de Teste para validação |
| user-stories.yaml | Obrigatório | User Stories para desenvolvimento incremental |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-31 | Migração v1.0 → v2.0: separação RF/RL, remoção de referências ao legado, foco em regras de negócio neutras de tecnologia | Agência ALC - alc.dev.br |
| 1.0 | 2025-12-28 | Versão inicial com 10 regras de negócio e 13+ endpoints | Claude Code |

---

**Última Atualização**: 2025-12-31
**Autor**: Agência ALC - alc.dev.br
**Revisão**: Pendente
**Versão de Governança**: 2.0
