rf:
  id: RF073
  nome: Gestão de Chamados e SLA
  versao: '2.0'
  data: '2025-12-30'
  fase: Fase 5 - Service Desk
  epic: EPIC008-SD-Service-Desk
  status: aprovado
descricao:
  objetivo: 'Módulo responsável pela abertura, acompanhamento, resolução e auditoria de solicitações

    de suporte técnico (chamados) em conformidade com Service Level Agreements (SLAs) contratuais.

    '
  problema_resolvido: 'Coordenação centralizada entre usuários solicitantes, equipes de suporte técnico e stakeholders

    empresariais, garantindo transparência, rastreabilidade e cumprimento de prazos contratuais.

    '
  publico_afetado: Usuários solicitantes, Técnicos de suporte, Gerentes de TI, Stakeholders empresariais
escopo:
  incluso:
  - Criação de chamados com validações obrigatórias
  - Atualização de status (Novo → Atribuído → Em Andamento → Resolvido → Fechado)
  - Listagem paginada com filtros (status, prioridade, categoria, técnico)
  - Cálculo automático de SLA (resposta e resolução)
  - Priorização automática via matriz Impacto x Urgência
  - Atribuição skill-based (roteamento por competência)
  - Categorização hierárquica em 3 níveis
  - Anexos de arquivos e comentários internos/externos
  - Registro de data de parada (downtime) que suspende SLA
  - Pesquisa de satisfação (NPS) ao encerramento
  - Notificações em tempo real (SignalR) e email
  - Integração com ServiceNow para P1/P2
  - Auditoria completa de operações
  fora:
  - Interface visual específica (layout, cores, fontes)
  - Tecnologia de implementação
  - Gestão de ativos (RF025)
  - Gestão de contratos (RF023)
  - Configuração de SLA (RF028, RF029)
entidades:
- nome: Ticket
  descricao: Chamado de suporte técnico
  multi_tenant: true
  soft_delete: true
  auditoria: true
  campos_principais:
  - Id
  - Numero (gerado automaticamente)
  - Descricao (min 20 chars)
  - CategoriaId (FK)
  - 'Prioridade (Enum: P1-P4)'
  - 'Status (Enum: Novo, Atribuído, Em Andamento, etc)'
  - SolicitanteId (FK)
  - TecnicoAtribuidoId (FK, nullable)
  - FilaAtendimentoId (FK, nullable)
  - DataCriacao
  - DataResposta
  - DataResolucao
  - DataFechamento
  - ParentTicketId (FK, nullable - para reabertura)
  - ExternalTicketId (ServiceNow ID, nullable)
  - IsDeleted (soft delete)
  - ClienteId (multi-tenancy)
- nome: TicketComment
  descricao: Comentário em chamado (interno ou externo)
  multi_tenant: true
  soft_delete: false
  auditoria: true
  campos_principais:
  - Id
  - TicketId (FK)
  - Texto
  - 'Visibilidade (Enum: Interno, Externo)'
  - AutorId (FK)
  - DataCriacao
- nome: TicketAttachment
  descricao: Anexo de arquivo em chamado
  multi_tenant: true
  soft_delete: false
  auditoria: true
  campos_principais:
  - Id
  - TicketId (FK)
  - NomeOriginal
  - NomeArmazenado (GUID)
  - TamanhoBytes
  - TipoMIME
  - BlobUrl
  - DataUpload
- nome: TicketSLA
  descricao: Controle de SLA do chamado
  multi_tenant: true
  soft_delete: false
  auditoria: true
  campos_principais:
  - Id
  - TicketId (FK)
  - DataRespostaEsperada
  - DataResolucaoEsperada
  - DataRespostaReal
  - DataResolucaoReal
  - 'Status (Enum: NoPrazo, Risco, Vencido)'
  - TempoSuspenso (TimeSpan - pausas)
- nome: TicketDowntime
  descricao: Períodos de parada de ativo que suspendem SLA
  multi_tenant: true
  soft_delete: false
  auditoria: true
  campos_principais:
  - Id
  - TicketId (FK)
  - DataInicio
  - DataFim
  - MotivoParada
- nome: QueueAtendimento
  descricao: Fila de atendimento skill-based
  multi_tenant: true
  soft_delete: true
  auditoria: true
  campos_principais:
  - Id
  - Nome
  - SkillSet
  - TecnicosIds (lista)
  - ClienteId (multi-tenancy)
regras_negocio:
- id: RN-RF073-01
  titulo: Campos obrigatórios para criação de chamado
  descricao: 'Todo novo chamado deve conter: Solicitante (autenticado), Descrição (min 20 chars),

    Categoria (nível 1-3), pelo menos 1 Ativo OU Centro de Custo.

    '
  criticidade: CRÍTICA
  implementacao:
    backend: true
    frontend: true
    validacao_api: true
    validacao_ui: true
  validacao:
    tipo: campo_obrigatorio
    mensagem_erro: Descrição obrigatória (mínimo 20 caracteres)
    http_code: 400
- id: RN-RF073-02
  titulo: Prioridade calculada automaticamente via matriz Impacto x Urgência
  descricao: 'Se não definida explicitamente: Alto Impacto + Alta Urgência = P1,

    Alto OU Alta = P2, Médio + Médio = P3, Baixo + Baixo = P4.

    '
  criticidade: ALTA
  implementacao:
    backend: true
    frontend: false
    validacao_api: false
    validacao_ui: false
  validacao:
    tipo: regra_negocio
    mensagem_erro: null
    http_code: null
- id: RN-RF073-03
  titulo: SLA de resposta e resolução baseado em prioridade
  descricao: 'P1: 1h resposta / 4h resolução, P2: 4h/8h, P3: 8h/24h, P4: 24h/72h.

    Contrato específico pode sobrescrever.

    '
  criticidade: CRÍTICA
  implementacao:
    backend: true
    frontend: true
    validacao_api: false
    validacao_ui: false
  validacao:
    tipo: regra_negocio
    mensagem_erro: null
    http_code: null
- id: RN-RF073-04
  titulo: Parada de ativo suspende cálculo de SLA
  descricao: 'Downtime registrado (DataInicio-DataFim) suspende timer de SLA.

    Tempo suspenso não conta para cálculo.

    '
  criticidade: ALTA
  implementacao:
    backend: true
    frontend: true
    validacao_api: false
    validacao_ui: false
  validacao:
    tipo: regra_negocio
    mensagem_erro: null
    http_code: null
- id: RN-RF073-05
  titulo: Atribuição automática via skill-based routing
  descricao: 'Roteamento automático para fila apropriada (Telefonia→Fila_Telecom).

    Dentro da fila, técnico com menor carga.

    '
  criticidade: ALTA
  implementacao:
    backend: true
    frontend: false
    validacao_api: false
    validacao_ui: false
  validacao:
    tipo: regra_negocio
    mensagem_erro: Nenhum técnico disponível para fila
    http_code: 503
- id: RN-RF073-06
  titulo: Status de SLA recalculado periodicamente
  descricao: 'Job a cada 5 minutos recalcula: No Prazo (>20%), Risco (5-20%), Vencido (<5% ou após prazo).

    '
  criticidade: MÉDIA
  implementacao:
    backend: true
    frontend: false
    validacao_api: false
    validacao_ui: false
  validacao:
    tipo: regra_negocio
    mensagem_erro: null
    http_code: null
- id: RN-RF073-07
  titulo: Comentários internos vs externos
  descricao: 'Comentários marcados como Interno (equipe) ou Externo (cliente visível).

    Padrão: Externo.

    '
  criticidade: MÉDIA
  implementacao:
    backend: true
    frontend: true
    validacao_api: true
    validacao_ui: true
  validacao:
    tipo: regra_negocio
    mensagem_erro: null
    http_code: null
- id: RN-RF073-08
  titulo: Reabertura de chamado fecha original e cria novo linkado
  descricao: 'Reabertura: (1) fecha original com status Reaberto, (2) cria novo ticket

    com ParentTicketId, (3) SLA zerado.

    '
  criticidade: ALTA
  implementacao:
    backend: true
    frontend: true
    validacao_api: false
    validacao_ui: false
  validacao:
    tipo: regra_negocio
    mensagem_erro: null
    http_code: null
- id: RN-RF073-09
  titulo: Auditoria de todas as mudanças de estado
  descricao: 'Toda alteração (status, prioridade, atribuição) auditada com:

    usuário, timestamp, valores anterior/novo. Retenção 7 anos.

    '
  criticidade: CRÍTICA
  implementacao:
    backend: true
    frontend: false
    validacao_api: false
    validacao_ui: false
  validacao:
    tipo: regra_negocio
    mensagem_erro: null
    http_code: null
- id: RN-RF073-10
  titulo: Integração com ServiceNow para chamados críticos
  descricao: 'P1/P2 sincronizados bidirecionalmente com ServiceNow.

    Mudanças em IControlIT ou ServiceNow refletem mutuamente.

    '
  criticidade: MÉDIA
  implementacao:
    backend: true
    frontend: false
    validacao_api: false
    validacao_ui: false
  validacao:
    tipo: integracao
    mensagem_erro: Falha ao sincronizar com ServiceNow
    http_code: 500
- id: RN-RF073-11
  titulo: Validação de anexos de arquivos
  descricao: 'Max 5MB, tipos permitidos (PDF, DOC, XLS, JPG, PNG, TXT),

    antivírus obrigatório, armazenamento com GUID.

    '
  criticidade: ALTA
  implementacao:
    backend: true
    frontend: true
    validacao_api: true
    validacao_ui: true
  validacao:
    tipo: validacao
    mensagem_erro: Arquivo não pode exceder 5 MB
    http_code: 400
- id: RN-RF073-12
  titulo: Soft delete obrigatório para chamados
  descricao: 'Nunca deletar fisicamente. Marcar IsDeleted=true.

    Soft-deleted não aparecem em listagens mas acessíveis via auditoria.

    '
  criticidade: CRÍTICA
  implementacao:
    backend: true
    frontend: false
    validacao_api: false
    validacao_ui: false
  validacao:
    tipo: regra_negocio
    mensagem_erro: null
    http_code: null
estados:
- id: novo
  descricao: Criado, aguardando atribuição
- id: atribuido
  descricao: Atribuído a técnico/fila mas não iniciado
- id: em_andamento
  descricao: Técnico está trabalhando ativamente
- id: aguardando_cliente
  descricao: Técnico solicitou informação/ação do cliente
- id: aguardando_terceiro
  descricao: Dependente de fornecedor/terceiro externo
- id: resolvido
  descricao: Solução implementada, aguardando confirmação cliente
- id: fechado
  descricao: Cliente confirmou resolução, chamado encerrado
- id: reaberto
  descricao: Chamado fechado mas cliente reportou problema continuado
- id: cancelado
  descricao: Chamado cancelado (duplicado, erro, etc)
transicoes:
  permitidas:
  - de: novo
    para: atribuido
  - de: novo
    para: cancelado
  - de: atribuido
    para: em_andamento
  - de: atribuido
    para: novo
  - de: atribuido
    para: cancelado
  - de: em_andamento
    para: aguardando_cliente
  - de: em_andamento
    para: aguardando_terceiro
  - de: em_andamento
    para: resolvido
  - de: em_andamento
    para: cancelado
  - de: aguardando_cliente
    para: em_andamento
  - de: aguardando_cliente
    para: cancelado
  - de: aguardando_terceiro
    para: em_andamento
  - de: aguardando_terceiro
    para: cancelado
  - de: resolvido
    para: fechado
  - de: resolvido
    para: reaberto
  - de: fechado
    para: reaberto
  proibidas:
  - de: fechado
    para: novo
    motivo: Deve usar Reabrir
  - de: cancelado
    para: '*'
    motivo: Cancelamento é irreversível
permissoes:
- codigo: cha.ticket.create
  descricao: Criar novo chamado
  roles_autorizadas:
  - Staff
  - Solicitante
- codigo: cha.ticket.read
  descricao: Visualizar chamado
  roles_autorizadas:
  - Staff
  - Solicitante
- codigo: cha.ticket.update
  descricao: Editar chamado (status, prioridade)
  roles_autorizadas:
  - Staff
- codigo: cha.ticket.comment
  descricao: Adicionar comentário
  roles_autorizadas:
  - Staff
  - Solicitante
- codigo: cha.ticket.assign
  descricao: Atribuir técnico
  roles_autorizadas:
  - Manager
- codigo: cha.ticket.close
  descricao: Encerrar chamado
  roles_autorizadas:
  - Staff
- codigo: cha.ticket.reopen
  descricao: Reabrir chamado
  roles_autorizadas:
  - Staff
  - Solicitante
- codigo: cha.sla.admin
  descricao: Administrar SLA
  roles_autorizadas:
  - Admin
- codigo: cha.queue.admin
  descricao: Administrar filas
  roles_autorizadas:
  - Admin
- codigo: cha.servicenow.sync
  descricao: Sincronizar ServiceNow
  roles_autorizadas:
  - Admin
integracoes:
  internas:
  - Autenticacao (JWT)
  - Multi-Tenancy (ClienteId)
  - Auditoria (7 anos retenção)
  - RBAC (Permissões)
  - Central de Funcionalidades (Feature Flags)
  - i18n (Transloco - pt-BR/en/es)
  externas:
  - sistema: ServiceNow
    tipo: REST API
    obrigatoria: false
    descricao: Sincronização bidirecional P1/P2
  - sistema: Azure Blob Storage
    tipo: Cloud Storage
    obrigatoria: true
    descricao: Armazenamento de anexos
  - sistema: SignalR
    tipo: WebSocket
    obrigatoria: true
    descricao: Notificações real-time
  - sistema: SMTP
    tipo: Email
    obrigatoria: true
    descricao: Notificações via email
seguranca:
  isolamento_tenant: true
  auditoria_obrigatoria: true
  soft_delete: true
  validacoes:
  - FluentValidation em todos Commands
  - Queries parametrizadas (EF Core)
  - RBAC baseado em claims JWT
  - XSS Protection automático (Angular)
  - CSRF Token (HttpOnly cookie)
  - Rate Limiting (anti-spam)
  - HTTPS/TLS 1.2+ obrigatório
  - Antivírus em anexos
rastreabilidade:
  ucs_esperados:
  - UC00-RF073 (Listar chamados)
  - UC01-RF073 (Criar chamado)
  - UC02-RF073 (Visualizar detalhes)
  - UC03-RF073 (Atualizar status)
  - UC04-RF073 (Fechar chamado)
  - UC05-RF073 (Reabrir chamado)
  - UC06-RF073 (Adicionar comentário)
  - UC07-RF073 (Anexar arquivo)
  - UC08-RF073 (Registrar parada)
  - UC09-RF073 (Atribuir técnico)
  - UC10-RF073 (Monitorar SLA)
catalog:
  crud:
  - id: RF073-CRUD-01
    title: Criar chamado
    required: true
  - id: RF073-CRUD-02
    title: Listar chamados
    required: true
  - id: RF073-CRUD-03
    title: Visualizar chamado
    required: true
  - id: RF073-CRUD-04
    title: Atualizar chamado
    required: true
  - id: RF073-CRUD-05
    title: Fechar chamado
    required: true
  - id: RF073-CRUD-06
    title: Reabrir chamado
    required: true
  validacoes:
  - id: RF073-VAL-01
    title: Validar campos obrigatórios
    required: true
  - id: RF073-VAL-02
    title: Validar anexos (tamanho, tipo)
    required: true
  - id: RF073-VAL-03
    title: Validar transições de estado
    required: true
  seguranca:
  - id: RF073-SEC-01
    title: Isolamento de tenant
    required: true
  - id: RF073-SEC-02
    title: Permissões RBAC
    required: true
  - id: RF073-SEC-03
    title: Soft delete obrigatório
    required: true
  - id: RF073-SEC-04
    title: Auditoria completa
    required: true
  integracao:
  - id: RF073-INT-01
    title: Cálculo automático de SLA
    required: true
  - id: RF073-INT-02
    title: Skill-based routing
    required: true
  - id: RF073-INT-03
    title: Sincronização ServiceNow
    required: false
  - id: RF073-INT-04
    title: Notificações real-time (SignalR)
    required: true
exclusions:
  rf_items:
  - id: EX-RF073-01
    justificativa: Gestão de ativos (RF025)
  - id: EX-RF073-02
    justificativa: Gestão de contratos (RF023)
  - id: EX-RF073-03
    justificativa: Configuração de SLA (RF028, RF029)
historico:
- versao: '2.0'
  data: '2025-12-30'
  autor: Agência ALC - alc.dev.br
  descricao: 'Migração v1.0 → v2.0: separação RF/RL completa, 12 RNs canônicas, ZERO referências ao legado'
- versao: '1.0'
  data: '2025-12-28'
  autor: IControlIT Architect
  descricao: Versão inicial com legado misturado (DEPRECIADA)
