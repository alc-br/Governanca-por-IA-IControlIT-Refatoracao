# RF-073: Gestão de Chamados e SLA

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC008-SD-Service-Desk
**Fase**: Fase 5 - Service Desk

---

## 1. OBJETIVO DO REQUISITO

Descrever de forma clara, objetiva e verificável o comportamento esperado do módulo de **Gestão de Chamados (Tickets) e Gerenciamento de SLA** do sistema IControlIT, servindo como **contrato oficial** entre negócio, desenvolvimento, testes e agentes de IA.

Este documento **não define implementação**, apenas **o que o sistema deve fazer**, sob quais condições e quais garantias devem ser preservadas.

O módulo é responsável pela abertura, acompanhamento, resolução e auditoria de solicitações de suporte técnico (chamados) em conformidade com Service Level Agreements (SLAs) contratuais, operando como ponto central de coordenação entre usuários solicitantes, equipes de suporte técnico e stakeholders empresariais.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Criação de chamados (tickets) com descrição, categoria, prioridade e ativos afetados
- [x] Atualização de status do chamado (Novo → Atribuído → Em Andamento → Resolvido → Fechado)
- [x] Listagem paginada de chamados com filtros (status, prioridade, categoria, técnico)
- [x] Cálculo automático de SLA (tempo de resposta e tempo de resolução)
- [x] Priorização automática via matriz Impacto x Urgência
- [x] Atribuição skill-based (roteamento automático para fila/técnico por competência)
- [x] Categorização em 3 níveis hierárquicos
- [x] Anexos de arquivos e comentários internos/externos
- [x] Registro de data de parada (downtime) que suspende SLA
- [x] Pesquisa de satisfação (NPS) ao encerramento
- [x] Notificações em tempo real (SignalR) e email
- [x] Integração com ServiceNow para chamados críticos (P1/P2)
- [x] Validações funcionais e regras de negócio
- [x] Controle de acesso e isolamento por tenant
- [x] Auditoria completa de operações

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (layout, cores, fontes)
- Tecnologia, framework ou linguagem de implementação
- Estratégia de deploy ou infraestrutura
- Gestão de ativos (RF025)
- Gestão de contratos (RF023)
- Configuração de SLA (RF028, RF029)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Chamado (Ticket)** | Solicitação de suporte técnico aberta por usuário final, contendo descrição do problema, prioridade, ativos afetados e histórico de atendimento |
| **SLA (Service Level Agreement)** | Contrato que define tempo máximo para resposta inicial e resolução do chamado |
| **Prioridade** | Classificação derivada de matriz Impacto x Urgência (P1-Crítico, P2-Alto, P3-Médio, P4-Baixo) |
| **Categoria** | Classificação funcional em 3 níveis (Nível 1: tecnologia, Nível 2: sub-grupo, Nível 3: tipo específico) |
| **Fila de Atendimento** | Conjunto de técnicos agrupados por especialidade (skill set) |
| **Data de Parada** | Período registrado onde ativo não estava em operação, suspende cálculo de SLA |
| **Tenant** | Unidade lógica de isolamento de dados (multi-tenancy) |
| **Usuário** | Agente autenticado que executa ações (solicitante ou técnico) |
| **Operação** | Ação executável sobre o chamado (criar, atualizar, comentar, fechar, reabrir) |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Criar chamado** - Abertura de novo chamado com validações de campos obrigatórios
2. **Atualizar chamado** - Alteração de status, prioridade, atribuição
3. **Consultar chamado por ID** - Visualização detalhada com histórico completo
4. **Listar chamados** - Listagem paginada com filtros e ordenação
5. **Fechar chamado** - Encerramento com solução registrada
6. **Reabrir chamado** - Reabertura cria novo ticket linkado ao original
7. **Calcular SLA automaticamente** - Job recorrente recalcula status (No prazo/Risco/Vencido)
8. **Priorizar automaticamente** - Matriz Impacto x Urgência define P1-P4
9. **Atribuir skill-based** - Roteamento automático para fila/técnico por competência
10. **Categorizar em 3 níveis** - Hierarquia Nível 1 → Nível 2 → Nível 3
11. **Adicionar comentários** - Comentários internos (equipe) ou externos (cliente)
12. **Anexar arquivos** - Upload de arquivos (max 5MB) em blob storage
13. **Registrar parada** - Período de downtime que suspende SLA
14. **Pesquisar satisfação** - Formulário NPS enviado ao encerramento
15. **Notificar em tempo real** - SignalR para mudanças de status + Email
16. **Sincronizar com ServiceNow** - Integração bidirecional para P1/P2

---

## 5. REGRAS DE NEGÓCIO

### RN-RF073-01 — Campos obrigatórios para criação de chamado

**Descrição**: Todo novo chamado deve conter minimamente: Solicitante (usuário autenticado), Descrição (mínimo 20 caracteres), Categoria (nível 1-3 definidos), pelo menos 1 Ativo Afetado OU Centro de Custo. Campos opcionais: Prioridade (padrão P3), Contrato (auto-detectado via ativo).

**Justificativa**: Evita chamados vagos ou incompletos que prejudicam análise e roteamento. Garante rastreabilidade para auditoria.

**Critério de Aceite**:
- Campo Descrição ausente → rejeição HTTP 400
- Descrição com menos de 20 caracteres → rejeição HTTP 400
- Nenhum ativo selecionado E nenhum centro de custo → rejeição HTTP 400
- Categoria não definida → rejeição HTTP 400

---

### RN-RF073-02 — Prioridade calculada automaticamente via matriz Impacto x Urgência

**Descrição**: Se Prioridade não for definida explicitamente pelo usuário, o sistema deve calcular automaticamente via matriz:
- Alto Impacto (múltiplos usuários/ativos) + Alta Urgência (usuário crítico) = **P1 (Crítico)**
- Alto Impacto OU Alta Urgência = **P2 (Alto)**
- Médio Impacto + Média Urgência = **P3 (Médio)**
- Baixo Impacto + Baixa Urgência = **P4 (Baixo)**

**Justificativa**: Padroniza classificação, evita viés humano, acelera priorização. Baseado em ITIL v4.

**Critério de Aceite**:
- Impacto=Alto (5+ ativos) + Urgência=Alta (CEO reportando) → P1
- Impacto=Alto + Urgência=Média → P2
- Impacto=Médio (1-2 usuários) + Urgência=Média → P3
- Impacto=Baixo + Urgência=Baixa → P4

---

### RN-RF073-03 — SLA de resposta e resolução baseado em prioridade

**Descrição**: Cada chamado recebe dois SLAs:
- **SLA de Resposta**: Tempo máximo até primeiro contato técnico (atribuição + comentário inicial)
- **SLA de Resolução**: Tempo máximo até fechamento

Prazos padrão (podem ser sobrescritos via contrato específico):

| Prioridade | Tempo Resposta | Tempo Resolução |
|------------|----------------|-----------------|
| P1 | 1 hora | 4 horas |
| P2 | 4 horas | 8 horas |
| P3 | 8 horas | 24 horas |
| P4 | 24 horas | 72 horas |

**Justificativa**: Garante conformidade com contratos. Prazos variam por cliente e tipo de serviço.

**Critério de Aceite**:
- P1 criado às 10:00h → Resposta esperada 11:00h, Resolução esperada 14:00h
- Contrato específico sobrescreve padrão
- SLA calculado considerando apenas horário comercial (se configurado)

---

### RN-RF073-04 — Parada de ativo suspende cálculo de SLA

**Descrição**: Quando um chamado tem Data de Parada registrada (Data Início até Data Fim), o timer de SLA é suspenso durante este período. O tempo suspenso não conta para cálculo de "Tempo em Andamento".

**Justificativa**: Reflete realidade operacional: se ativo foi desligado para manutenção programada, não deve contar como SLA vencido.

**Critério de Aceite**:
- Chamado criado 08:00h, SLA 24h → Vence 08:00h próximo dia
- Parada registrada 12:00-16:00h (4 horas) → SLA move para 12:00h próximo dia
- Múltiplas paradas são somadas e descontadas do SLA total

---

### RN-RF073-05 — Atribuição automática via skill-based routing

**Descrição**: Quando um chamado é priorizado, deve ser automaticamente roteado para a **Fila de Atendimento** (skill set) mais apropriada baseado na categoria:
- Categoria=Telefonia → Fila_Telecom
- Categoria=Dados → Fila_Rede
- Categoria=Hardware → Fila_Suporte_Hardware
- Outras categorias → Fila_Geral

Dentro da fila, escolher técnico com: (1) competência compatível, (2) menor carga atual (load balancing).

**Justificativa**: Reduz tempo de atribuição, melhora qualidade (especialista adequado), distribui carga uniformemente.

**Critério de Aceite**:
- Categoria=Telefonia, 3 técnicos disponíveis (cargas: 5, 7, 3) → Atribuir ao técnico de carga 3
- Categoria=Dados + nenhum técnico disponível → Fila Geral (aguarda disponibilidade)
- Técnico com carga > 15 chamados não recebe novos automaticamente

---

### RN-RF073-06 — Status de SLA recalculado periodicamente

**Descrição**: Cada chamado em aberto tem status de SLA atualizado a cada 5 minutos via job automatizado:
- **No Prazo**: Tempo restante > 20% do SLA total (indicador verde)
- **Risco**: Tempo restante entre 5% e 20% do SLA total (indicador amarelo)
- **Vencido**: Tempo restante < 5% OU tempo atual > data esperada (indicador vermelho)

Status calculado contra **Data de Resposta** enquanto em status "Novo", depois contra **Data de Resolução**.

**Justificativa**: Alertas proativos (status Risco) evitam vencimentos surpresa e permitem ações corretivas.

**Critério de Aceite**:
- SLA=24h, criado 10:00h, calculado 18:00h (8h decorridas) → Tempo restante 16h (66%) → Status: No Prazo
- SLA=24h, 2h antes vencimento → Tempo restante 2h (8%) → Status: Risco
- SLA=24h, após vencimento → Status: Vencido

---

### RN-RF073-07 — Comentários internos vs externos

**Descrição**: Comentários podem ser marcados como "Interno" (visível apenas à equipe técnica) ou "Externo" (visível ao solicitante). Padrão é Externo. Interface deve indicar claramente o tipo de visibilidade.

**Justificativa**: Comunicação com cliente apenas via comentários externos; internos são para coordenação da equipe técnica.

**Critério de Aceite**:
- Comentário interno exemplo: "Aguardando retorno do fabricante para peça"
- Comentário externo exemplo: "Seu chamado está em andamento. Próxima atualização até 17h."
- Solicitante visualiza apenas comentários externos
- Equipe técnica visualiza internos + externos

---

### RN-RF073-08 — Reabertura de chamado fecha original e cria novo linkado

**Descrição**: Se um chamado foi marcado como "Resolvido" mas o cliente relata problema continuado, não editar o chamado original. Em vez disso: (1) fechar o chamado original com status "Reaberto", (2) criar novo chamado linkado ao original (campo ParentTicketId), (3) recalcular SLA para novo chamado.

**Justificativa**: Mantém auditoria/histórico completo; cada chamado tem seu próprio ciclo de SLA independente.

**Critério de Aceite**:
- Original: Ticket#001 marcado resolvido dia 10
- Cliente dia 12: "Problema continua"
- Sistema: Ticket#001 → status "Reaberto", cria Ticket#001-R (linked via ParentTicketId)
- Novo ticket inicia com SLA zerado

---

### RN-RF073-09 — Auditoria de todas as mudanças de estado

**Descrição**: Toda alteração de campo em chamado (status, prioridade, atribuição, comentário) é auditada em tabela separada com: usuário executante, timestamp, campo anterior, campo novo, código de ação. Auditoria tem retenção mínima 7 anos (LGPD).

**Justificativa**: Rastreabilidade total para compliance, investigações e resolução de disputas.

**Critério de Aceite**:
- Mudança de status "Novo" → "Atribuído" registra: usuário, data/hora, valores anterior/novo
- Mudança de prioridade "P3" → "P2" registra: usuário, data/hora, motivo (se fornecido)
- Histórico de auditoria acessível via endpoint específico
- Logs de auditoria retidos por 7 anos mínimo

---

### RN-RF073-10 — Integração com ServiceNow para chamados críticos

**Descrição**: Chamados com Prioridade P1 ou P2 são automaticamente sincronizados com ServiceNow via integração bidirecional. Quando ticket muda de status em IControlIT, atualizar em ServiceNow; quando atualizado em ServiceNow, refletir em IControlIT.

**Justificativa**: Alguns clientes operam ServiceNow como sistema de record; sincronização automática evita duplicação de trabalho e garante consistência.

**Critério de Aceite**:
- P1 criado em IControlIT → Automático POST a ServiceNow (máx 2 segundos)
- Status "Resolvido" em ServiceNow → Webhook atualiza IControlIT (real-time)
- Chamados P3/P4 não são sincronizados automaticamente
- Falha de sincronização registrada em log + retry automático

---

### RN-RF073-11 — Validação de anexos de arquivos

**Descrição**: Anexos devem respeitar: (1) tamanho máximo 5MB por arquivo, (2) tipos permitidos: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG, TXT, (3) antivírus scanning obrigatório antes de armazenar, (4) armazenamento em blob storage com nome aleatorizado.

**Justificativa**: Segurança contra upload de malware e controle de uso de storage.

**Critério de Aceite**:
- Upload de arquivo 6MB → Rejeição HTTP 400
- Upload de arquivo .exe → Rejeição HTTP 415 (Unsupported Media Type)
- Arquivo aprovado em antivírus → Armazenado com GUID como nome
- Arquivo reprovado em antivírus → Rejeição + log de segurança

---

### RN-RF073-12 — Soft delete obrigatório para chamados

**Descrição**: Chamados nunca devem ser deletados fisicamente do banco de dados. Ao invés disso, marcar campo IsDeleted=true (soft delete). Chamados soft-deleted não aparecem em listagens normais mas permanecem acessíveis via auditoria.

**Justificativa**: Compliance LGPD + rastreabilidade histórica + possibilidade de recuperação.

**Critério de Aceite**:
- DELETE /api/tickets/{id} → Marca IsDeleted=true (não remove registro)
- Listagem padrão filtra IsDeleted=false automaticamente
- Endpoint de auditoria acessa chamados deletados
- Retenção de 7 anos antes de limpeza física

---

## 6. ESTADOS DA ENTIDADE

| Estado | Descrição |
|--------|-----------|
| **Novo** | Criado, aguardando atribuição |
| **Atribuído** | Atribuído a técnico/fila mas não iniciado |
| **Em Andamento** | Técnico está trabalhando ativamente |
| **Aguardando Cliente** | Técnico solicitou informação/ação do cliente |
| **Aguardando Terceiro** | Dependente de fornecedor/terceiro externo |
| **Resolvido** | Solução implementada, aguardando confirmação cliente |
| **Fechado** | Cliente confirmou resolução, chamado encerrado |
| **Reaberto** | Chamado fechado mas cliente reportou problema continuado |
| **Cancelado** | Chamado cancelado (duplicado, erro, etc) |

### Transições permitidas

| De | Para |
|----|------|
| Novo | Atribuído, Cancelado |
| Atribuído | Em Andamento, Novo, Cancelado |
| Em Andamento | Aguardando Cliente, Aguardando Terceiro, Resolvido, Cancelado |
| Aguardando Cliente | Em Andamento, Cancelado |
| Aguardando Terceiro | Em Andamento, Cancelado |
| Resolvido | Fechado, Reaberto |
| Fechado | Reaberto |

### Transições proibidas

- Fechado → Novo (deve usar Reabrir)
- Cancelado → qualquer outro estado (irreversível)
- Qualquer estado → Fechado sem passar por Resolvido

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre | Dados incluídos |
|--------|---------------|-----------------|
| `chamado.criado` | Após criação bem-sucedida | TicketId, Número, Prioridade, Solicitante |
| `chamado.atribuido` | Quando atribuído a técnico/fila | TicketId, TécnicoId, FilaId |
| `chamado.status_alterado` | Mudança de status | TicketId, StatusAnterior, NovoStatus |
| `chamado.prioridade_alterada` | Mudança de prioridade | TicketId, PrioridadeAnterior, NovaPrioridade |
| `chamado.comentario_adicionado` | Novo comentário | TicketId, Autor, Visibilidade (Interno/Externo) |
| `chamado.resolvido` | Marcado como resolvido | TicketId, Solução, TécnicoResponsável |
| `chamado.fechado` | Encerrado definitivamente | TicketId, DataFechamento |
| `chamado.reaberto` | Reabertura solicitada | TicketIdOriginal, NovoTicketId |
| `sla.risco` | SLA entrou em zona de risco | TicketId, TempoRestante, PorcentagemRestante |
| `sla.vencido` | SLA venceu | TicketId, TempoExcedido |
| `anexo.adicionado` | Arquivo anexado | TicketId, NomeArquivo, Tamanho |
| `parada.registrada` | Downtime registrado | TicketId, DataInício, DataFim |
| `servicenow.sincronizado` | Sincronização com ServiceNow | TicketId, ServiceNowIncidentId, Direção |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant (multi-tenancy)
- Nenhuma regra de negócio pode ser ignorada ou contornada
- Erros devem ser previsíveis, estruturados e rastreáveis
- Auditoria deve registrar quem, quando, o que mudou e de onde (IP)
- Performance: listagem de 1000 chamados em < 500ms
- SLA recalculado em batch de máx 5 minutos de defasagem
- Notificações entregues em < 2 segundos após evento
- Integração ServiceNow com retry automático em caso de falha

---

## 9. SEGURANÇA

- **Validação de entrada obrigatória**: FluentValidation em todos os Commands
- **Proteção contra injeção**: Queries parametrizadas (EF Core)
- **Controle de permissões**: RBAC baseado em claims JWT
- **Isolamento multi-tenant**: Filtro automático por ClienteId
- **XSS Protection**: Angular XSS guard automático
- **CSRF Token**: Cookie HttpOnly com validação automática
- **Rate Limiting**: Proteção contra spam de requisições
- **Soft Delete Obrigatório**: Nunca deletar fisicamente
- **Criptografia em trânsito**: HTTPS/TLS 1.2+ obrigatório
- **Antivírus em anexos**: Scanning automático antes de armazenar
- **Auditoria completa**: Retenção 7 anos mínimo

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF073.md** (Casos de Uso detalhados)
- **MD-RF073.md** (Modelo de Dados completo)
- **WF-RF073.md** (Wireframes e fluxos de tela)
- **TC-RF073-BACKEND.md** (Casos de Teste Backend)
- **TC-RF073-FRONTEND.md** (Casos de Teste Frontend)
- **TC-RF073-SEGURANCA.md** (Casos de Teste Segurança)
- **TC-RF073-E2E.md** (Casos de Teste End-to-End)
- **MT-RF073.yaml** (Massas de Teste)

---

## 11. RASTREABILIDADE

| Artefato | Status | Observação |
|----------|--------|------------|
| Casos de Uso | Obrigatório | UC00-UC10 mínimo |
| Modelo de Dados | Obrigatório | Tabelas: Ticket, TicketComment, TicketAttachment, TicketSLA, TicketDowntime |
| Wireframes | Obrigatório | Telas: list, create, detail, sla-dashboard |
| Casos de Teste Backend | Obrigatório | Cobertura 100% das RNs |
| Casos de Teste Frontend | Obrigatório | Cobertura fluxos completos |
| Casos de Teste Segurança | Obrigatório | Validação anti-injection, XSS, CSRF |
| Casos de Teste E2E | Obrigatório | Fluxo completo criação → resolução → fechamento |
| Massas de Teste | Obrigatório | Dados válidos + inválidos + edge cases |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0: separação RF/RL completa, 12 RNs canônicas, ZERO referências ao legado | Agência ALC - alc.dev.br |
| 1.0 | 2025-12-28 | Versão inicial com legado misturado (DEPRECIADA) | IControlIT Architect |

---

**Última Atualização**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**Revisão**: Versão canônica orientada a contrato
