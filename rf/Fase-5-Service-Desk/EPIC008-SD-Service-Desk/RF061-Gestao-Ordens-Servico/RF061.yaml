rf:
  id: RF061
  nome: Gestão de Ordens de Serviço (OS)
  versao: '2.0'
  data: '2025-12-30'
  fase: Fase-5-Service-Desk
  epic: EPIC008-SD-Service-Desk
  status: aprovado
descricao:
  objetivo: Implementar sistema completo de gestão de ordens de serviço (OS) para atendimentos técnicos presenciais (field
    service)
  problema_resolvido: Automatizar e controlar todo ciclo de vida de atendimentos técnicos em campo, desde criação até faturamento,
    com rastreabilidade completa
  publico_afetado: Gestores de Service Desk, Técnicos de campo, Clientes, Equipe de Faturamento
escopo:
  incluso:
  - Criação de OS (manual ou automática a partir de solicitações)
  - Agendamento com verificação de disponibilidade de técnicos
  - Checklist de execução por tipo de OS
  - Assinatura digital do cliente
  - Controle de peças e materiais utilizados
  - Upload de fotos de evidência (antes/depois)
  - Geolocalização de check-in/check-out
  - Cálculo de tempo de atendimento
  - Reagendamento com justificativa
  - Controle de SLA de atendimento
  - Avaliação NPS do serviço
  - Integração com estoque (baixa automática)
  - Integração com faturamento
  - Dashboard com mapa de OSs abertas
  - Notificações de agendamento (SMS/WhatsApp)
  - Histórico de performance do técnico
  - Auditoria completa de operações
  - Controle de acesso RBAC
  - Multi-tenancy
  fora:
  - Design visual específico (definido no WF)
  - App mobile nativo (interface responsiva para tablet/smartphone)
  - Tecnologia específica de implementação
  - Integração com sistemas externos de GPS
  - Sistema de pagamento online
entidades:
- nome: OrdemServico
  descricao: Entidade principal representando uma ordem de serviço técnico
  multi_tenant: true
  soft_delete: true
  auditoria: true
- nome: ChecklistOS
  descricao: Template de checklist por tipo de OS
  multi_tenant: true
  soft_delete: true
  auditoria: true
- nome: ItemChecklistOS
  descricao: Respostas do checklist preenchido pelo técnico
  multi_tenant: true
  soft_delete: false
  auditoria: true
- nome: AssinaturaOS
  descricao: Assinatura digital do cliente
  multi_tenant: true
  soft_delete: false
  auditoria: true
- nome: PecaUtilizadaOS
  descricao: Peças e materiais utilizados na execução
  multi_tenant: true
  soft_delete: false
  auditoria: true
- nome: FotoOS
  descricao: Fotos de evidência (antes/depois)
  multi_tenant: true
  soft_delete: true
  auditoria: true
- nome: CheckpointOS
  descricao: Registros de geolocalização (check-in/check-out)
  multi_tenant: true
  soft_delete: false
  auditoria: true
- nome: AvaliacaoOS
  descricao: Avaliação NPS do cliente
  multi_tenant: true
  soft_delete: false
  auditoria: true
regras_negocio:
- id: RN-RF061-001
  descricao: Criação Automática de OS a partir de Solicitação
  tipo: regra_negocio
  campos_afetados:
  - SolicitacaoOrigemId
  - Status
  - Numero
  obrigatorio: true
  criterios_aceite:
  - Solicitação aprovada com flag 'requer atendimento presencial' cria OS automaticamente
  - OS contém referência à solicitação de origem
  - 'Status inicial: AGUARDANDO_AGENDAMENTO'
  - Número gerado no formato OS-YYYY-NNNNN
- id: RN-RF061-002
  descricao: Agendamento com Verificação de Disponibilidade
  tipo: validacao
  campos_afetados:
  - TecnicoId
  - DataAgendada
  obrigatorio: true
  criterios_aceite:
  - Consultar agenda do técnico para data selecionada
  - Verificar OSs já agendadas
  - Calcular janelas livres considerando duração estimada
  - Rejeitar agendamento em horário ocupado (HTTP 400)
- id: RN-RF061-003
  descricao: Checklist Obrigatório por Tipo de OS
  tipo: validacao
  campos_afetados:
  - TipoOSId
  - ChecklistRespostas
  obrigatorio: true
  criterios_aceite:
  - Tipo de OS define lista de itens do checklist
  - Item pode ser obrigatório ou opcional
  - 'Tipos de resposta: SIM/NÃO, TEXTO, NÚMERO, FOTO'
  - Finalização com item obrigatório não preenchido é rejeitada
- id: RN-RF061-004
  descricao: Assinatura Digital Obrigatória
  tipo: validacao
  campos_afetados:
  - Assinatura
  obrigatorio: true
  criterios_aceite:
  - Assinatura capturada como imagem Base64
  - Registro de nome, CPF, data/hora, IP do dispositivo
  - Armazenamento com hash SHA-256
  - OS sem assinatura não pode ser finalizada
- id: RN-RF061-005
  descricao: Controle de Peças Utilizadas
  tipo: regra_negocio
  campos_afetados:
  - PecasUtilizadas
  obrigatorio: false
  criterios_aceite:
  - Cada peça registra ID, quantidade, valor unitário
  - Valor total calculado automaticamente
  - Finalização da OS dá baixa automática no estoque
  - Alerta se estoque insuficiente
- id: RN-RF061-006
  descricao: Fotos de Evidência (Antes/Depois)
  tipo: validacao
  campos_afetados:
  - Fotos
  obrigatorio: false
  criterios_aceite:
  - 'Tipos de foto: ANTES ou DEPOIS'
  - Descrição opcional por foto
  - Data/hora registrada automaticamente
  - Compressão automática (max 2MB)
- id: RN-RF061-007
  descricao: Geolocalização de Check-in/Check-out
  tipo: validacao
  campos_afetados:
  - Checkpoints
  obrigatorio: true
  criterios_aceite:
  - Check-in captura latitude, longitude, data/hora
  - Check-out captura latitude, longitude, data/hora
  - Precisão de 6 casas decimais
  - Requer consentimento do técnico (LGPD)
- id: RN-RF061-008
  descricao: Cálculo Automático de Tempo de Atendimento
  tipo: regra_negocio
  campos_afetados:
  - TempoAtendimento
  obrigatorio: true
  criterios_aceite:
  - Tempo = check-out - check-in
  - Exibição em formato HH:mm
  - Armazenamento em minutos
  - Disponível após check-out
- id: RN-RF061-009
  descricao: Reagendamento com Justificativa Obrigatória
  tipo: validacao
  campos_afetados:
  - DataAgendada
  - JustificativaReagendamento
  obrigatorio: true
  criterios_aceite:
  - Justificativa mínima de 20 caracteres
  - Registro de data/hora e usuário responsável
  - Notificação automática ao cliente
  - Histórico em auditoria
- id: RN-RF061-010
  descricao: Controle de SLA de Atendimento
  tipo: regra_negocio
  campos_afetados:
  - SLA
  - StatusSLA
  obrigatorio: true
  criterios_aceite:
  - SLA definido por tipo de OS (horas)
  - Cálculo considera horário comercial (8h-18h, seg-sex)
  - Alerta quando faltar 20% do prazo
  - Alerta quando SLA vencido
- id: RN-RF061-011
  descricao: Avaliação NPS do Serviço
  tipo: regra_negocio
  campos_afetados:
  - AvaliacaoNPS
  obrigatorio: false
  criterios_aceite:
  - 'Escala NPS: 0 a 10'
  - Pergunta padrão definida
  - Campo opcional para comentários (max 500 chars)
  - Vinculação à OS e ao técnico
- id: RN-RF061-012
  descricao: Integração com Faturamento
  tipo: regra_negocio
  campos_afetados:
  - Status
  - PecasUtilizadas
  obrigatorio: true
  criterios_aceite:
  - OS finalizada com peças gera pré-nota
  - Pré-nota contém valor peças + mão de obra
  - 'Status inicial: AGUARDANDO_APROVACAO'
  - Aprovação gera nota fiscal definitiva
- id: RN-RF061-013
  descricao: Histórico de Performance do Técnico
  tipo: regra_negocio
  campos_afetados:
  - TecnicoId
  obrigatorio: true
  criterios_aceite:
  - 'Métricas: OSs concluídas, tempo médio, NPS médio'
  - Atualização automática ao finalizar OS
  - Consulta por técnico e período
  - Dashboard com ranking
- id: RN-RF061-014
  descricao: Notificações de Agendamento
  tipo: regra_negocio
  campos_afetados:
  - DataAgendada
  obrigatorio: true
  criterios_aceite:
  - Notificação 24h antes via SMS/WhatsApp/Email
  - Mensagem contém data, hora, técnico, tipo de serviço
  - Link para confirmar ou reagendar
  - Confirmação atualiza status para CONFIRMADA
- id: RN-RF061-015
  descricao: Dashboard com Mapa de OSs Abertas
  tipo: regra_negocio
  campos_afetados:
  - Status
  - Checkpoints
  obrigatorio: false
  criterios_aceite:
  - Mapa exibe pins coloridos por status
  - Técnicos em campo com ícone diferenciado
  - Filtros por status, técnico, região
  - Atualização automática a cada 30 segundos
- id: RN-RF061-016
  descricao: Isolamento Multi-Tenant
  tipo: seguranca
  campos_afetados:
  - EmpresaId
  obrigatorio: true
  criterios_aceite:
  - Consultas incluem automaticamente EmpresaId
  - Acesso cross-tenant retorna HTTP 403
  - Técnicos vinculados a empresa específica
  - Clientes vinculados a empresa específica
estados:
- id: AGUARDANDO_AGENDAMENTO
  descricao: OS criada mas sem agendamento definido
- id: AGENDADA
  descricao: OS com data/hora e técnico definidos
- id: CONFIRMADA
  descricao: Cliente confirmou presença após notificação
- id: EM_ATENDIMENTO
  descricao: Técnico fez check-in e está executando
- id: AGUARDANDO_ASSINATURA
  descricao: Execução concluída, aguardando assinatura
- id: FINALIZADA
  descricao: Assinatura coletada, serviço concluído
- id: CANCELADA
  descricao: OS cancelada (com justificativa)
transicoes:
  permitidas:
  - de: AGUARDANDO_AGENDAMENTO
    para: AGENDADA
    condicao: Definir técnico e data/hora
  - de: AGENDADA
    para: CONFIRMADA
    condicao: Cliente confirmar presença
  - de: AGENDADA
    para: EM_ATENDIMENTO
    condicao: Técnico fazer check-in
  - de: CONFIRMADA
    para: EM_ATENDIMENTO
    condicao: Técnico fazer check-in
  - de: EM_ATENDIMENTO
    para: AGUARDANDO_ASSINATURA
    condicao: Técnico fazer check-out
  - de: AGUARDANDO_ASSINATURA
    para: FINALIZADA
    condicao: Coletar assinatura do cliente
  proibidas:
  - de: FINALIZADA
    para: '*'
    motivo: OS finalizada não pode mudar de status
permissoes:
- codigo: GES.OS.CREATE
  descricao: Criar OS
  roles_autorizadas:
  - Admin
  - Gestor
  - Atendente
- codigo: GES.OS.SCHEDULE
  descricao: Agendar OS
  roles_autorizadas:
  - Admin
  - Gestor
  - Atendente
- codigo: GES.OS.EXECUTE
  descricao: Executar OS (check-in/out)
  roles_autorizadas:
  - Admin
  - Técnico
- codigo: GES.OS.CLOSE
  descricao: Finalizar OS
  roles_autorizadas:
  - Admin
  - Gestor
  - Técnico
- codigo: GES.OS.CANCEL
  descricao: Cancelar OS
  roles_autorizadas:
  - Admin
  - Gestor
- codigo: GES.OS.RESCHEDULE
  descricao: Reagendar OS
  roles_autorizadas:
  - Admin
  - Gestor
  - Atendente
- codigo: GES.OS.VIEW
  descricao: Visualizar OS
  roles_autorizadas:
  - Admin
  - Gestor
  - Atendente
  - Técnico
- codigo: GES.OS.VIEW_ANY
  descricao: Listar OSs
  roles_autorizadas:
  - Admin
  - Gestor
  - Atendente
- codigo: GES.OS.ADD_PART
  descricao: Adicionar Peça
  roles_autorizadas:
  - Admin
  - Técnico
- codigo: GES.OS.DASHBOARD
  descricao: Ver Dashboard
  roles_autorizadas:
  - Admin
  - Gestor
- codigo: GES.OS.TECH_HISTORY
  descricao: Ver Histórico Técnico
  roles_autorizadas:
  - Admin
  - Gestor
endpoints:
- method: GET
  route: /api/ordens-servico
  descricao: Listar OSs com paginação e filtros
  autenticacao: true
  authorization_policy: OSRead
  request_dto: GetOrdensServicoQuery
  response_dto: PaginatedListDto<OrdemServicoDto>
- method: GET
  route: /api/ordens-servico/{id}
  descricao: Consultar OS por ID
  autenticacao: true
  authorization_policy: OSRead
  request_dto: GetOrdemServicoQuery
  response_dto: OrdemServicoDto
- method: POST
  route: /api/ordens-servico
  descricao: Criar nova OS
  autenticacao: true
  authorization_policy: OSCreate
  request_dto: CreateOrdemServicoCommand
  response_dto: Guid
- method: PUT
  route: /api/ordens-servico/{id}/agendar
  descricao: Agendar OS com técnico
  autenticacao: true
  authorization_policy: OSSchedule
  request_dto: AgendarOrdemServicoCommand
  response_dto: void
- method: PUT
  route: /api/ordens-servico/{id}/confirmar
  descricao: Cliente confirmar presença
  autenticacao: true
  authorization_policy: OSUpdate
  request_dto: ConfirmarOrdemServicoCommand
  response_dto: void
- method: PUT
  route: /api/ordens-servico/{id}/check-in
  descricao: Registrar check-in do técnico
  autenticacao: true
  authorization_policy: OSExecute
  request_dto: CheckInOrdemServicoCommand
  response_dto: void
- method: PUT
  route: /api/ordens-servico/{id}/check-out
  descricao: Registrar check-out do técnico
  autenticacao: true
  authorization_policy: OSExecute
  request_dto: CheckOutOrdemServicoCommand
  response_dto: void
- method: PUT
  route: /api/ordens-servico/{id}/assinatura
  descricao: Coletar assinatura digital
  autenticacao: true
  authorization_policy: OSExecute
  request_dto: ColetarAssinaturaCommand
  response_dto: void
- method: PUT
  route: /api/ordens-servico/{id}/avaliar
  descricao: Registrar avaliação NPS
  autenticacao: true
  authorization_policy: OSUpdate
  request_dto: AvaliarOrdemServicoCommand
  response_dto: void
- method: PUT
  route: /api/ordens-servico/{id}/reagendar
  descricao: Reagendar OS
  autenticacao: true
  authorization_policy: OSReschedule
  request_dto: ReagendarOrdemServicoCommand
  response_dto: void
- method: PUT
  route: /api/ordens-servico/{id}/cancelar
  descricao: Cancelar OS
  autenticacao: true
  authorization_policy: OSCancel
  request_dto: CancelarOrdemServicoCommand
  response_dto: void
- method: DELETE
  route: /api/ordens-servico/{id}
  descricao: Exclusão lógica
  autenticacao: true
  authorization_policy: OSDelete
  request_dto: DeleteOrdemServicoCommand
  response_dto: void
- method: POST
  route: /api/ordens-servico/{id}/pecas
  descricao: Adicionar peça utilizada
  autenticacao: true
  authorization_policy: OSAddPart
  request_dto: AddPecaUtilizadaCommand
  response_dto: Guid
- method: GET
  route: /api/ordens-servico/{id}/pecas
  descricao: Listar peças da OS
  autenticacao: true
  authorization_policy: OSRead
  request_dto: GetPecasUtilizadasQuery
  response_dto: List<PecaUtilizadaDto>
- method: DELETE
  route: /api/ordens-servico/{id}/pecas/{pecaId}
  descricao: Remover peça
  autenticacao: true
  authorization_policy: OSAddPart
  request_dto: RemovePecaUtilizadaCommand
  response_dto: void
- method: POST
  route: /api/ordens-servico/{id}/fotos
  descricao: Upload de foto
  autenticacao: true
  authorization_policy: OSExecute
  request_dto: UploadFotoOSCommand
  response_dto: Guid
- method: GET
  route: /api/ordens-servico/{id}/fotos
  descricao: Listar fotos da OS
  autenticacao: true
  authorization_policy: OSRead
  request_dto: GetFotosOSQuery
  response_dto: List<FotoOSDto>
- method: DELETE
  route: /api/ordens-servico/{id}/fotos/{fotoId}
  descricao: Excluir foto
  autenticacao: true
  authorization_policy: OSExecute
  request_dto: DeleteFotoOSCommand
  response_dto: void
- method: GET
  route: /api/ordens-servico/dashboard/mapa
  descricao: Mapa de OSs abertas
  autenticacao: true
  authorization_policy: OSDashboard
  request_dto: GetMapaOSsQuery
  response_dto: MapaOSsDto
- method: GET
  route: /api/ordens-servico/dashboard/sla
  descricao: Relatório de SLA
  autenticacao: true
  authorization_policy: OSDashboard
  request_dto: GetRelatorioSLAQuery
  response_dto: RelatorioSLADto
- method: GET
  route: /api/ordens-servico/tecnicos/{id}/historico
  descricao: Histórico do técnico
  autenticacao: true
  authorization_policy: OSTechHistory
  request_dto: GetHistoricoTecnicoQuery
  response_dto: HistoricoTecnicoDto
- method: GET
  route: /api/ordens-servico/tecnicos/{id}/disponibilidade
  descricao: Janelas disponíveis
  autenticacao: true
  authorization_policy: OSSchedule
  request_dto: GetDisponibilidadeTecnicoQuery
  response_dto: List<JanelaDisponivelDto>
integracoes:
  internas:
  - Autenticacao JWT
  - Multi-Tenancy (EmpresaId)
  - Auditoria (Created, Modified)
  - i18n (Transloco - pt-BR/en/es)
  - Central de Funcionalidades
  - RBAC (Permissões)
  externas:
  - sistema: Gestão de Estoque (RF046)
    tipo: API
    obrigatoria: true
    descricao: Baixa automática de peças utilizadas
  - sistema: Catálogo de Serviços (RF021)
    tipo: API
    obrigatoria: true
    descricao: Tipos de OS e SLAs
  - sistema: Gestão de Chamados (RF033)
    tipo: API
    obrigatoria: false
    descricao: Vinculação de OS a chamados
  - sistema: Faturamento (RF062)
    tipo: API
    obrigatoria: true
    descricao: Geração de pré-nota fiscal
seguranca:
  isolamento_tenant: true
  auditoria_obrigatoria: true
  soft_delete: true
  validacao_entrada: true
  protecao_sql_injection: true
  protecao_xss: true
  criptografia_dados_sensiveis: true
  hash_assinatura: SHA-256
  consentimento_lgpd_gps: true
central_funcionalidades:
  codigo: GES.ORDENS_SERVICO
  modulo: Gestão / Service Desk
  titulo_i18n: os.menu.title
  descricao_i18n: os.menu.description
  rota_frontend: /gestao/service-desk/ordens-servico
  icone: heroicons_outline:clipboard-list
kpis:
- nome: Taxa de Conclusão de OSs
  descricao: Percentual de OSs finalizadas vs criadas
  meta: '>= 90%'
  log_obrigatorio: true
- nome: Tempo Médio de Atendimento
  descricao: Média de duração das OSs
  meta: <= 2h
  log_obrigatorio: true
- nome: Cumprimento de SLA
  descricao: Percentual de OSs dentro do prazo
  meta: '>= 95%'
  log_obrigatorio: true
- nome: NPS Médio
  descricao: Média de avaliações dos clientes
  meta: '>= 8.0'
  log_obrigatorio: true
- nome: Taxa de Reagendamento
  descricao: Percentual de OSs reagendadas
  meta: <= 10%
  log_obrigatorio: true
- nome: Utilização de Peças
  descricao: Valor médio de peças por OS
  meta: Variável
  log_obrigatorio: true
- nome: Taxa de Check-in no Prazo
  descricao: Percentual de técnicos que fizeram check-in no horário
  meta: '>= 95%'
  log_obrigatorio: true
alertas:
- evento: SLA próximo do vencimento
  threshold: Faltam 20% do prazo
  severidade: MÉDIA
  canal_notificacao:
  - Dashboard
  - Email
- evento: SLA vencido
  threshold: Prazo expirado
  severidade: ALTA
  canal_notificacao:
  - Dashboard
  - Email
  - SMS
- evento: OS sem check-in
  threshold: 30min após horário agendado
  severidade: ALTA
  canal_notificacao:
  - Email (gestor)
- evento: Estoque insuficiente
  threshold: Peça com qtd < mínimo
  severidade: ALTA
  canal_notificacao:
  - Email
  - Dashboard
- evento: Taxa de NPS baixa
  threshold: Média < 6.0 no dia
  severidade: MÉDIA
  canal_notificacao:
  - Email (gestor)
- evento: Falha na baixa de estoque
  threshold: Erro ao processar baixa
  severidade: CRÍTICA
  canal_notificacao:
  - Email
  - Slack
dependencias:
  upstream:
  - rf_id: RF021
    descricao: Catálogo de Serviços (tipos de OS)
  - rf_id: RF033
    descricao: Gestão de Chamados (integração com chamados)
  - rf_id: RF015
    descricao: Gestão de Usuários (técnicos)
  - rf_id: RF001
    descricao: Gestão de Empresas (multi-tenancy)
  - rf_id: RF046
    descricao: Gestão de Estoque (baixa de peças)
  downstream:
  - rf_id: RF062
    descricao: Faturamento de Serviços
  - rf_id: RF063
    descricao: Análise de Performance de Técnicos
rastreabilidade:
  ucs_esperados:
  - UC00-RF061 (Listar OSs)
  - UC01-RF061 (Criar OS)
  - UC02-RF061 (Visualizar OS)
  - UC03-RF061 (Editar OS)
  - UC04-RF061 (Cancelar OS)
  artefatos:
  - nome: UC-RF061.md
    status: Criado
  - nome: MD-RF061.md
    status: Criado
  - nome: WF-RF061.md
    status: Criado
  - nome: TC-RF061.yaml
    status: Pendente
  - nome: MT-RF061.yaml
    status: Pendente
catalog:
  crud:
  - id: RF-CRUD-01
    title: Criar OS
    required: true
  - id: RF-CRUD-02
    title: Listar OSs
    required: true
  - id: RF-CRUD-03
    title: Visualizar OS
    required: true
  - id: RF-CRUD-04
    title: Atualizar OS
    required: true
  - id: RF-CRUD-05
    title: Cancelar OS
    required: true
  validacoes:
  - id: RF-VAL-01
    title: Validar campos obrigatórios
    required: true
  - id: RF-VAL-02
    title: Validar disponibilidade de técnico
    required: true
  - id: RF-VAL-03
    title: Validar checklist completo
    required: true
  - id: RF-VAL-04
    title: Validar assinatura digital
    required: true
  seguranca:
  - id: RF-SEC-01
    title: Isolamento de tenant (EmpresaId)
    required: true
  - id: RF-SEC-02
    title: Permissões RBAC
    required: true
  - id: RF-SEC-03
    title: Hash SHA-256 de assinatura
    required: true
  - id: RF-SEC-04
    title: Consentimento LGPD para GPS
    required: true
exclusions:
  rf_items:
  - id: EX-RF061-01
    justificativa: App mobile nativo (usar interface responsiva)
  - id: EX-RF061-02
    justificativa: Integração com GPS externo (usar GPS do dispositivo)
  - id: EX-RF061-03
    justificativa: Sistema de pagamento online
  - id: EX-RF061-04
    justificativa: Rastreamento em tempo real de técnicos (apenas checkpoints)
historico:
- versao: '2.0'
  data: '2025-12-30'
  autor: Agência ALC - alc.dev.br
  descricao: Migração v1.0 → v2.0 (separação RF/RL completa). Expansão para 16 RNs. Estrutura YAML completa sincronizada com
    RF.md.
- versao: '1.0'
  data: '2025-01-14'
  autor: Equipe IC2
  descricao: Versão inicial com código de exemplo
