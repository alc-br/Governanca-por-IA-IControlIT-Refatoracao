# RL-RF099.yaml - Referência ao Legado (Estruturado)
# 100% dos itens com destino definido

rf_id: RF099
versao_rl: "1.0"
data: "2025-12-31"
sistema_legado: "IControlIT VB.NET + ASP.NET WebForms + Crystal Reports"

# === ITENS LEGADO RASTREADOS ===
itens_legado:
  - id: "LEG-RF099-001"
    tipo: "tela"
    titulo: "DashboardExecutivo.aspx"
    caminho_legado: "ic1_legado/IControlIT/Relatorios/DashboardExecutivo.aspx"
    descricao: |
      Dashboard executivo com 3 KPIs fixos (SLA Geral, Custos Totais, Chamados Abertos).
      Usa Crystal Reports embarcado (CrystalReportViewer). Refresh manual (F5) ou batch 1x/hora.
      SQL Injection risk (concatenação direta de clienteId).
    destino: "SUBSTITUÍDO"
    justificativa: "Tela ASPX substituída por componente Angular 19 com SignalR real-time"
    rastreabilidade:
      rf_moderno: "RF-099 - Seção 4 (Funcionalidades - F1: Dashboard Executivo)"
      uc_moderno: "UC01-RF099 (Visualizar Dashboard Executivo)"
    migracao_moderna:
      componente_angular: "dashboard-executivo.component.ts"
      rota_frontend: "/dashboards/executivo"
      endpoint_api: "GET /api/dashboards/executivo"

  - id: "LEG-RF099-002"
    tipo: "tela"
    titulo: "RelatoriosChamados.aspx"
    caminho_legado: "ic1_legado/IControlIT/Relatorios/RelatoriosChamados.aspx"
    descricao: |
      Lista chamados com filtros básicos (Status, Prioridade, Data).
      GridView com paginação manual (ViewState pesado). Export para Excel XLS legado.
      Carrega todos os dados em memória (OutOfMemoryException com > 10k registros).
    destino: "SUBSTITUÍDO"
    justificativa: "Tela ASPX substituída por componente Angular com paginação server-side"
    rastreabilidade:
      rf_moderno: "RF-099 - Seção 4 (Funcionalidades - F4: Filtros Dinâmicos)"
      uc_moderno: "UC04-RF099 (Filtrar Dashboards Dinamicamente)"
    migracao_moderna:
      componente_angular: "dashboard-operacional.component.ts"
      rota_frontend: "/dashboards/operacional"
      endpoint_api: "GET /api/dashboards/{id}/data"

  - id: "LEG-RF099-003"
    tipo: "tela"
    titulo: "RelatoriosFaturas.aspx"
    caminho_legado: "ic1_legado/IControlIT/Relatorios/RelatoriosFaturas.aspx"
    descricao: |
      Exibe relatório de faturas por cliente com totalizadores.
      Usa Crystal Reports para PDF. Totalizadores calculados no Crystal Reports (logic duplicada).
      PDF gerado sincronamente (trava browser por 5-10 segundos).
    destino: "SUBSTITUÍDO"
    justificativa: "Tela ASPX substituída por export PDF assíncrono com Azure Blob Storage"
    rastreabilidade:
      rf_moderno: "RF-099 - Seção 4 (Funcionalidades - F10: Export Multi-Formato)"
      uc_moderno: "UC07-RF099 (Exportar Dashboard como PDF)"
    migracao_moderna:
      componente_angular: "dashboard-export.component.ts"
      rota_frontend: "/dashboards/{id}/export"
      endpoint_api: "POST /api/dashboards/{id}/export/pdf"

  - id: "LEG-RF099-004"
    tipo: "webservice"
    titulo: "WSDashboard.asmx.vb"
    caminho_legado: "ic1_legado/WebService/WSDashboard.asmx.vb"
    descricao: |
      WebService VB.NET com 3 métodos:
      - GetDashboardExecutivo(clienteId): Retorna dados do dashboard executivo
      - GetRelatoriosChamados(clienteId, status, dataInicio, dataFim): Retorna lista de chamados
      - ExportarPDF(relatorioNome, clienteId): Gera PDF do relatório
      SQL Injection risk (SQL concatenado). Sem auditoria. Execução síncrona.
    destino: "SUBSTITUÍDO"
    justificativa: "WebService VB.NET substituído por REST API .NET 10 com CQRS + MediatR"
    rastreabilidade:
      rf_moderno: "RF-099 - Seção 11 (Rastreabilidade - Endpoints API)"
      uc_moderno: "UC02-RF099 (Obter Dados de Dashboard)"
    migracao_moderna:
      endpoint_api_1: "GET /api/dashboards/executivo"
      endpoint_api_2: "GET /api/dashboards/{id}/data"
      endpoint_api_3: "POST /api/dashboards/{id}/export/pdf"

  - id: "LEG-RF099-005"
    tipo: "stored_procedure"
    titulo: "pa_DashboardExecutivo"
    caminho_legado: "SQL Server Database"
    descricao: |
      Retorna KPIs do dashboard executivo (SLA Geral, Custos, Chamados Abertos).
      SLA hardcoded para 240 minutos (4 horas). Subquery em SELECT (performance ruim).
      Sem filtro de período (calcula desde sempre).
    destino: "SUBSTITUÍDO"
    justificativa: "Stored procedure substituída por Query CQRS (CalculateKpiQuery) com fórmula configurável"
    rastreabilidade:
      rf_moderno: "RF-099 - RN-RF099-002 (KPI deve ter fórmula de cálculo definida)"
      uc_moderno: "UC02-RF099 (Obter Dados de Dashboard)"
    migracao_moderna:
      query_cqrs: "CalculateKpiQuery"
      handler: "CalculateKpiQueryHandler"

  - id: "LEG-RF099-006"
    tipo: "stored_procedure"
    titulo: "pa_RelatoriosChamados"
    caminho_legado: "SQL Server Database"
    descricao: |
      Retorna lista de chamados filtrados por status e período.
      Sem paginação (retorna todos os registros). Sem índices apropriados (lento com > 10k registros).
    destino: "SUBSTITUÍDO"
    justificativa: "Stored procedure substituída por Query CQRS com paginação server-side"
    rastreabilidade:
      rf_moderno: "RF-099 - Seção 4 (Funcionalidades - F4: Filtros Dinâmicos)"
      uc_moderno: "UC04-RF099 (Filtrar Dashboards)"
    migracao_moderna:
      query_cqrs: "GetDashboardDataQuery"
      handler: "GetDashboardDataQueryHandler"

  - id: "LEG-RF099-007"
    tipo: "stored_procedure"
    titulo: "pa_RelatorioFaturas"
    caminho_legado: "SQL Server Database"
    descricao: |
      Retorna lista de faturas filtradas por status.
      Sem paginação. SUM OVER() calcula para todos os registros (performance ruim).
    destino: "SUBSTITUÍDO"
    justificativa: "Stored procedure substituída por Query CQRS com agregações otimizadas"
    rastreabilidade:
      rf_moderno: "RF-099 - Seção 11 (KPIs de Sucesso - KPI-DSH-004: Custo por Cliente)"
      uc_moderno: "UC02-RF099 (Obter Dados de Dashboard)"
    migracao_moderna:
      query_cqrs: "CalculateKpiQuery (formula=SUM, entity=Fatura)"
      handler: "CalculateKpiQueryHandler"

  - id: "LEG-RF099-008"
    tipo: "tabela"
    titulo: "Chamados"
    caminho_legado: "SQL Server Database - Tabela [dbo].[Chamados]"
    descricao: |
      Tabela de chamados do Service Desk (fonte de dados para KPIs).
      Problemas: IdCliente sem FK, varchar livre para Prioridade/Status,
      sem campos de auditoria, sem índices em DataAbertura/Status.
    destino: "SUBSTITUÍDO"
    justificativa: "Tabela legada substituída por Entity ChamadoEntity com auditoria e multi-tenancy"
    rastreabilidade:
      rf_moderno: "RF-099 - Seção 11 (Dependências - RF-053: Solicitações e Chamados)"
      uc_moderno: "N/A (tabela de outro RF)"
    migracao_moderna:
      entity_moderna: "ChamadoEntity"
      migration: "AddChamadosTable"
      campos_auditoria: "DataCriacao, CriadoPor, DataAlteracao, AlteradoPor"
      multi_tenancy: "ClienteId (GUID) obrigatório"

  - id: "LEG-RF099-009"
    tipo: "tabela"
    titulo: "Faturas"
    caminho_legado: "SQL Server Database - Tabela [dbo].[Faturas]"
    descricao: |
      Tabela de faturas de clientes (KPI Custo por Cliente).
      Problemas: Status como varchar livre, sem campos de auditoria, sem índices.
    destino: "SUBSTITUÍDO"
    justificativa: "Tabela legada substituída por Entity FaturaEntity com auditoria"
    rastreabilidade:
      rf_moderno: "RF-099 - Seção 11 (KPIs - KPI-DSH-004: Custo por Cliente)"
      uc_moderno: "N/A (tabela de outro RF)"
    migracao_moderna:
      entity_moderna: "FaturaEntity"
      migration: "AddFaturasTable"
      campos_auditoria: "DataCriacao, CriadoPor"
      multi_tenancy: "ClienteId (GUID) obrigatório"

  - id: "LEG-RF099-010"
    tipo: "tabela"
    titulo: "Ativos"
    caminho_legado: "SQL Server Database - Tabela [dbo].[Ativos]"
    descricao: |
      Tabela de ativos de clientes (usado em dashboards de inventário).
      Problemas: Sem campos de auditoria, sem índices em DataAquisicao.
    destino: "SUBSTITUÍDO"
    justificativa: "Tabela legada substituída por Entity AtivoEntity"
    rastreabilidade:
      rf_moderno: "RF-099 - Seção 11 (Dependências - possível integração futura)"
      uc_moderno: "N/A (tabela de outro RF)"
    migracao_moderna:
      entity_moderna: "AtivoEntity"
      migration: "AddAtivosTable"
      campos_auditoria: "DataCriacao, CriadoPor"

  - id: "LEG-RF099-011"
    tipo: "regra_negocio"
    titulo: "SLA sempre 4 horas (hardcoded)"
    caminho_legado: "pa_DashboardExecutivo (linha 7: WHERE TempoResolucao <= 240)"
    descricao: |
      KPI Tempo Médio Resolução sempre usa meta de 4 horas (240 minutos)
      hardcoded em stored procedure. Não há configuração de meta por cliente ou filial.
    destino: "SUBSTITUÍDO"
    justificativa: "Meta hardcoded substituída por configuração flexível via ConfigureKpiMetaCommand"
    rastreabilidade:
      rf_moderno: "RF-099 - RN-RF099-003 (Meta de KPI deve ser configurável)"
      uc_moderno: "UC05-RF099 (Configurar Meta de KPI)"
    migracao_moderna:
      command: "ConfigureKpiMetaCommand"
      entity: "KpiMetaEntity (EffectiveFrom, ClienteId, FilialId)"

  - id: "LEG-RF099-012"
    tipo: "regra_negocio"
    titulo: "Refresh manual ou batch 1x/hora"
    caminho_legado: "DashboardExecutivo.aspx (btnAtualizar_Click) + SQL Server Agent Job"
    descricao: |
      Dashboards não atualizam automaticamente. Usuário deve clicar F5 (btnAtualizar)
      ou aguardar job SQL Server Agent executar 1x/hora.
    destino: "SUBSTITUÍDO"
    justificativa: "Refresh manual substituído por SignalR real-time (push a cada 30s)"
    rastreabilidade:
      rf_moderno: "RF-099 - RN-RF099-005 (Refresh automático a cada 30 segundos via SignalR)"
      uc_moderno: "UC02-RF099 (Obter Dados de Dashboard)"
    migracao_moderna:
      hub: "DashboardHub (SignalR)"
      background_service: "DashboardRefreshService"
      intervalo: "30 segundos"

  - id: "LEG-RF099-013"
    tipo: "regra_negocio"
    titulo: "Período 'Último Mês' = 30 dias fixos"
    caminho_legado: "DashboardExecutivo.aspx (ddlPeriodo_SelectedIndexChanged)"
    descricao: |
      Filtro de período "Último Mês" sempre calcula DATEADD(day, -30, GETDATE())
      ignorando calendário (meses com 28, 29, 31 dias).
    destino: "CORRIGIDO"
    justificativa: "Cálculo de período corrigido para usar DateTime.UtcNow.AddMonths(-1) respeitando calendário"
    rastreabilidade:
      rf_moderno: "RF-099 - Seção 4 (Funcionalidades - F4: Filtros Dinâmicos)"
      uc_moderno: "UC04-RF099 (Filtrar Dashboards)"
    migracao_moderna:
      filtro: "DateRangeFilter (preset: LastMonth)"
      calculo: "DateTime.UtcNow.AddMonths(-1)"

  - id: "LEG-RF099-014"
    tipo: "regra_negocio"
    titulo: "Sem alertas proativos"
    caminho_legado: "N/A (funcionalidade inexistente)"
    descricao: |
      Sistema não notifica quando KPI sai de meta. Usuário deve abrir dashboard
      manualmente para verificar status de KPIs.
    destino: "SUBSTITUÍDO"
    justificativa: "Sistema de alertas criado do zero (MonitorKpiAlertsBackgroundService)"
    rastreabilidade:
      rf_moderno: "RF-099 - RN-RF099-004 (Alertas disparam quando KPI < 80% ou < 60%)"
      uc_moderno: "UC06-RF099 (Receber Alertas de KPI)"
    migracao_moderna:
      background_service: "MonitorKpiAlertsBackgroundService"
      entity: "AlertEntity (AlertLevel: Green/Yellow/Red)"
      notificacao: "Email + SMS para alertas vermelhos"

  - id: "LEG-RF099-015"
    tipo: "regra_negocio"
    titulo: "Sem auditoria de acessos"
    caminho_legado: "N/A (funcionalidade inexistente)"
    descricao: |
      Sistema não registra quem acessou dashboard executivo, quais dados visualizou
      ou exportou. Sem compliance com LGPD.
    destino: "SUBSTITUÍDO"
    justificativa: "Auditoria completa criada (DashboardAccessAuditAttribute + 7 anos retenção)"
    rastreabilidade:
      rf_moderno: "RF-099 - RN-RF099-009 (Auditoria de acesso a dashboards sensíveis)"
      uc_moderno: "UC08-RF099 (Auditar Acesso a Dashboard)"
    migracao_moderna:
      attribute: "DashboardAccessAuditAttribute"
      interceptor: "DashboardAccessAuditInterceptor"
      entity: "AuditEntity (UserId, IpAddress, Timestamp)"
      retencao: "7 anos (LGPD Lei 13.709/2018)"

  - id: "LEG-RF099-016"
    tipo: "regra_negocio"
    titulo: "Multi-Database sem Row-Level Security"
    caminho_legado: "WSDashboard.GetDashboardExecutivo (linha 5: IControlIT_Cliente{clienteId})"
    descricao: |
      Multi-tenancy implementado como 1 database por cliente (IControlIT_Cliente01, IControlIT_Cliente02).
      ClienteId em queries mas sem Row-Level Security. Risco de vazamento de dados se connection string errada.
    destino: "SUBSTITUÍDO"
    justificativa: "Multi-Database substituído por Single Database + Row-Level Security (EF Core Global Query Filters)"
    rastreabilidade:
      rf_moderno: "RF-099 - RN-RF099-008 (Multi-tenancy obrigatório - ClienteId em filtros)"
      uc_moderno: "Todos os UCs (validação ClienteId obrigatória)"
    migracao_moderna:
      database_unico: "IControlIT.db (SQLite dev) / IControlIT (SQL Server prod)"
      row_level_security: "HasQueryFilter(x => x.ClienteId == CurrentClienteId)"
      middleware: "DashboardAuthorizationMiddleware"

# === PROBLEMAS ARQUITETURAIS IDENTIFICADOS ===
problemas_legado:
  - codigo: "PROB-RF099-001"
    titulo: "SQL Injection em múltiplos pontos"
    severidade: CRÍTICA
    descricao: "SQL concatenado diretamente em DashboardExecutivo.aspx, WSDashboard.GetDashboardExecutivo, etc."
    solucao: "Substituir por EF Core com queries parametrizadas (LINQ to Entities)"

  - codigo: "PROB-RF099-002"
    titulo: "Performance degradada com > 10k registros"
    severidade: ALTA
    descricao: "GridView carrega todos os dados em memória. Stored procedures sem paginação."
    solucao: "Implementar paginação server-side + Redis cache + índices apropriados"

  - codigo: "PROB-RF099-003"
    titulo: "Falha Multi-Tenant (vazamento de dados)"
    severidade: CRÍTICA
    descricao: "Multi-Database permite vazamento se connection string incorreta. Sem Row-Level Security."
    solucao: "Single Database + ClienteId obrigatório + EF Core Global Query Filters"

  - codigo: "PROB-RF099-004"
    titulo: "Sem auditoria (não compliance com LGPD)"
    severidade: ALTA
    descricao: "Sistema não audita acessos a dashboards executivos (dados financeiros sensíveis)"
    solucao: "Implementar auditoria completa com retenção de 7 anos"

  - codigo: "PROB-RF099-005"
    titulo: "UX degradada (refresh manual, sem alertas)"
    severidade: MÉDIA
    descricao: "Usuário deve clicar F5 para atualizar dados. Sem alertas proativos quando KPI sai de meta."
    solucao: "SignalR real-time (30s) + MonitorKpiAlertsBackgroundService"

  - codigo: "PROB-RF099-006"
    titulo: "Crystal Reports licenças caras e não customizável"
    severidade: MÉDIA
    descricao: "Crystal Reports binários compilados, licenças caras, não editáveis dinamicamente"
    solucao: "Substituir por Chart.js (open-source, JavaScript, customizável)"

# === METADADOS ===
metadados:
  total_itens_rastreados: 16
  cobertura_destinos: "100%"
  destinos_breakdown:
    substituido: 14
    corrigido: 1
    assumido: 0
    descartado: 0
    a_revisar: 1
  total_problemas_identificados: 6
  total_telas_aspx: 3
  total_webservices: 1
  total_stored_procedures: 3
  total_tabelas: 3
  total_regras_implícitas: 6
