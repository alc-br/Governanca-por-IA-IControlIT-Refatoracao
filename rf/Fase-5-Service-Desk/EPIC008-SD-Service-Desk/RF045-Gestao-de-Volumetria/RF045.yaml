# =============================================
# RF045 - Gestão de Volumetria
# Versão: 2.0
# Data: 2025-12-30
# Autor: Agência ALC - alc.dev.br
# =============================================

rf:
  id: "RF045"
  nome: "Gestão de Volumetria"
  versao: "2.0"
  data: "2025-12-30"
  fase: "Fase-5-Service-Desk"
  epic: "EPIC008-SD-Service-Desk"
  status: "aprovado"

descricao:
  objetivo: "Implementar sistema completo de monitoramento, análise e previsão de consumo de recursos computacionais e tráfego de dados do IControlIT"
  problema_resolvido: "No sistema anterior, não havia visibilidade sobre consumo de recursos, causando sobrecargas não planejadas, crescimento descontrolado de custos e impossibilidade de prever necessidades de expansão"
  publico_afetado: "Administradores de Sistema, Gestores de TI, Fornecedores, FinOps"

escopo:
  incluso:
    - "Coleta automática de métricas de tráfego (request/response size, latência)"
    - "Agregação inteligente de dados (minutely → hourly → daily → monthly)"
    - "Configuração de quotas e limites por fornecedor"
    - "Alertas automáticos de consumo (80%, 95%, 100% da quota)"
    - "Previsão de esgotamento com machine learning (Azure ML)"
    - "Dashboards visuais com heatmaps e gráficos temporais"
    - "Throttling progressivo ao atingir limites"
    - "Drill-down até request individual (últimos 7 dias)"
    - "Detecção de anomalias e comportamentos atípicos"
    - "Relatórios de otimização e recomendações (FinOps)"
    - "Exportação de dados de volumetria"
    - "Retenção de 7 anos para dados agregados mensais"
    - "Isolamento multi-tenant de métricas e quotas"
  fora:
    - "Interface visual específica (definida em WF-RF045)"
    - "Coleta de métricas de hardware (CPU, memória do servidor)"
    - "Integração com ferramentas externas de APM (Datadog, New Relic)"
    - "Cobrança automática baseada em consumo (billing)"
    - "Otimização automática de infraestrutura"

entidades:
  - nome: "VolumetriaConsumo"
    descricao: "Dados brutos de consumo por request (granularidade 1s, retenção 7 dias)"
    multi_tenant: true
    soft_delete: false
    auditoria: false

  - nome: "VolumetriaAgregada"
    descricao: "Dados consolidados em períodos (hourly, daily, monthly)"
    multi_tenant: true
    soft_delete: false
    auditoria: false

  - nome: "VolumetriaLimite"
    descricao: "Configuração de quotas e limites por fornecedor"
    multi_tenant: true
    soft_delete: true
    auditoria: true

  - nome: "VolumetriaAlerta"
    descricao: "Configuração de alertas de consumo e anomalias"
    multi_tenant: true
    soft_delete: true
    auditoria: true

regras_negocio:
  - id: "RN-RF045-01"
    descricao: "Dados coletados a cada request (1s) mas armazenados apenas 7 dias. Agregações horárias ficam 90 dias, diárias 2 anos, mensais 7 anos"
    tipo: "regra_negocio"
    campos_afetados: ["Timestamp", "Periodo"]
    obrigatorio: true

  - id: "RN-RF045-02"
    descricao: "Todo fornecedor deve ter quota mensal configurada (GB tráfego + número de requests). Sem quota = ilimitado apenas para Super Admin"
    tipo: "validacao"
    campos_afetados: ["FornecedorId", "LimiteBytesTotal", "LimiteRequests"]
    obrigatorio: true

  - id: "RN-RF045-03"
    descricao: "Sistema alerta automaticamente quando fornecedor atingir 80% da quota mensal ou quando previsão indicar esgotamento em 7 dias"
    tipo: "regra_negocio"
    campos_afetados: ["PercentualAlerta"]
    obrigatorio: true

  - id: "RN-RF045-04"
    descricao: "Ao atingir 95% da quota, sistema aplica rate limit de 50%. A 99%, rate limit de 80%. A 100%, bloqueia POST/PUT/DELETE (GET permitido)"
    tipo: "regra_negocio"
    campos_afetados: ["AcaoAoExceder"]
    obrigatorio: true

  - id: "RN-RF045-05"
    descricao: "Volumetria de um fornecedor não pode afetar outro. Quotas, limites e billing são completamente isolados"
    tipo: "seguranca"
    campos_afetados: ["FornecedorId"]
    obrigatorio: true

  - id: "RN-RF045-06"
    descricao: "Requests de health check (/health, /ping, /metrics) não contam para quota de volumetria"
    tipo: "regra_negocio"
    campos_afetados: ["Endpoint"]
    obrigatorio: true

  - id: "RN-RF045-07"
    descricao: "Se consumo de um dia ultrapassar 2x a média dos últimos 7 dias, dispara alerta de anomalia"
    tipo: "regra_negocio"
    campos_afetados: ["TotalBytes"]
    obrigatorio: true

  - id: "RN-RF045-08"
    descricao: "Após agregação de dados raw para hourly/daily/monthly, dados originais são deletados permanentemente"
    tipo: "regra_negocio"
    campos_afetados: ["Timestamp", "Periodo"]
    obrigatorio: true

  - id: "RN-RF045-09"
    descricao: "Se fornecedor criado no meio do mês, quota é proporcional aos dias restantes. Fórmula: quotaMensal * (diasRestantes / diasTotaisMes)"
    tipo: "regra_negocio"
    campos_afetados: ["LimiteBytesTotal", "DataCriacao"]
    obrigatorio: true

  - id: "RN-RF045-10"
    descricao: "Previsão de consumo só é gerada se fornecedor tiver pelo menos 3 meses de histórico. Caso contrário, usa média simples"
    tipo: "regra_negocio"
    campos_afetados: ["DataHora", "Periodo"]
    obrigatorio: true

  - id: "RN-RF045-11"
    descricao: "Endpoints de exportação retornam máximo 1 GB por request. Exportações maiores usam background job"
    tipo: "validacao"
    campos_afetados: ["TotalBytes"]
    obrigatorio: true

  - id: "RN-RF045-12"
    descricao: "Endpoints GET de dados estáticos devem ter cache de 15min. Header Cache-Control: public, max-age=900"
    tipo: "regra_negocio"
    campos_afetados: ["Metodo"]
    obrigatorio: true

  - id: "RN-RF045-13"
    descricao: "Dados agregados mensais devem ser mantidos por 7 anos para auditoria fiscal e conformidade com LGPD"
    tipo: "regra_negocio"
    campos_afetados: ["DataHora", "Periodo"]
    obrigatorio: true

  - id: "RN-RF045-14"
    descricao: "Usuário pode fazer drill-down de qualquer métrica agregada até o request individual, mas apenas dos últimos 7 dias"
    tipo: "regra_negocio"
    campos_afetados: ["Timestamp"]
    obrigatorio: true

  - id: "RN-RF045-15"
    descricao: "Todo domingo às 23h, sistema envia e-mail automático para administradores com resumo semanal de volumetria e anomalias"
    tipo: "regra_negocio"
    campos_afetados: ["Destinatarios"]
    obrigatorio: true

estados:
  - id: "ativo"
    descricao: "Limite ativo e sendo monitorado"
  - id: "suspenso"
    descricao: "Temporariamente desabilitado (não bloqueia)"
  - id: "excedido"
    descricao: "Quota ultrapassada (ações configuradas ativas)"

transicoes:
  permitidas:
    - de: "ativo"
      para: "suspenso"
    - de: "suspenso"
      para: "ativo"
    - de: "ativo"
      para: "excedido"
    - de: "excedido"
      para: "ativo"
  proibidas:
    - de: "suspenso"
      para: "excedido"

permissoes:
  - codigo: "volumetria.dashboard.view"
    descricao: "Visualizar dashboard de volumetria"
  - codigo: "volumetria.detalhes.view"
    descricao: "Visualizar detalhes de consumo (drill-down)"
  - codigo: "volumetria.limites.view"
    descricao: "Visualizar quotas configuradas"
  - codigo: "volumetria.limites.create"
    descricao: "Configurar quotas por fornecedor"
  - codigo: "volumetria.limites.update"
    descricao: "Alterar quotas existentes"
  - codigo: "volumetria.alertas.view"
    descricao: "Visualizar alertas configurados"
  - codigo: "volumetria.alertas.create"
    descricao: "Configurar alertas de consumo"
  - codigo: "volumetria.alertas.update"
    descricao: "Alterar alertas existentes"
  - codigo: "volumetria.export"
    descricao: "Exportar dados de volumetria"

integracoes:
  internas:
    - "Autenticacao (JWT)"
    - "Multi-Tenancy (FornecedorId)"
    - "Auditoria (alterações de quotas/limites)"
    - "Permissões RBAC"
  externas:
    - sistema: "Azure ML"
      tipo: "API"
      obrigatoria: true
      descricao: "Previsão de consumo com machine learning"
    - sistema: "Azure Blob Storage"
      tipo: "Storage"
      obrigatoria: true
      descricao: "Arquivamento de dados > 7 anos (cold storage)"

seguranca:
  isolamento_tenant: true
  auditoria_obrigatoria: true
  soft_delete: true

rastreabilidade:
  ucs_esperados:
    - "UC00"
    - "UC01"
    - "UC02"
    - "UC03"
    - "UC04"

catalog:
  crud:
    - id: "RF-CRUD-01"
      title: "Configurar quota de fornecedor"
      required: true
    - id: "RF-CRUD-02"
      title: "Listar consumo por período"
      required: true
    - id: "RF-CRUD-03"
      title: "Visualizar detalhes de consumo"
      required: true
    - id: "RF-CRUD-04"
      title: "Atualizar limites e quotas"
      required: true
    - id: "RF-CRUD-05"
      title: "Exportar dados de volumetria"
      required: true

  validacoes:
    - id: "RF-VAL-01"
      title: "Validar quota obrigatória por fornecedor"
      required: true
    - id: "RF-VAL-02"
      title: "Validar limite de exportação (1 GB)"
      required: true
    - id: "RF-VAL-03"
      title: "Validar exclusão de health checks da quota"
      required: true

  seguranca:
    - id: "RF-SEC-01"
      title: "Isolamento multi-tenant de métricas"
      required: true
    - id: "RF-SEC-02"
      title: "Permissões RBAC por operação"
      required: true
    - id: "RF-SEC-03"
      title: "Throttling progressivo ao atingir limites"
      required: true

exclusions:
  rf_items: []

historico:
  - versao: "2.0"
    data: "2025-12-30"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Migração v1.0 → v2.0: separação RF/RL, contrato funcional limpo"
  - versao: "1.0"
    data: "2025-01-14"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Versão inicial com legado misturado"
