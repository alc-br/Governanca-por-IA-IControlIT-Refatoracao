# RF045 - Gestão de Volumetria

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC008-SD-Service-Desk
**Fase**: Fase-5-Service-Desk

---

## 1. OBJETIVO DO REQUISITO

Implementar sistema completo de monitoramento, análise e previsão de consumo de recursos computacionais e tráfego de dados do IControlIT, permitindo acompanhamento em tempo real de volumetria, análise de tendências, previsão de capacidade e alertas automáticos de sobrecarga.

Este RF centraliza a inteligência de capacidade e performance, oferecendo dashboards visuais, alertas proativos e recomendações de otimização para garantir disponibilidade, performance e controle de custos.

**Problema Resolvido**: No sistema anterior, não havia visibilidade sobre consumo de recursos, causando sobrecargas não planejadas, crescimento descontrolado de custos de infraestrutura e impossibilidade de prever necessidades de expansão.

**Público Afetado**:
- Administradores de Sistema (monitoramento e capacidade)
- Gestores de TI (planejamento de infraestrutura)
- Fornecedores (acompanhamento de quotas)
- FinOps (otimização de custos)

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Coleta automática de métricas de tráfego (request/response size, latência)
- [x] Agregação inteligente de dados (minutely → hourly → daily → monthly)
- [x] Configuração de quotas e limites por fornecedor
- [x] Alertas automáticos de consumo (80%, 95%, 100% da quota)
- [x] Previsão de esgotamento com machine learning (Azure ML)
- [x] Dashboards visuais com heatmaps e gráficos temporais
- [x] Throttling progressivo ao atingir limites
- [x] Drill-down até request individual (últimos 7 dias)
- [x] Detecção de anomalias e comportamentos atípicos
- [x] Relatórios de otimização e recomendações (FinOps)
- [x] Exportação de dados de volumetria
- [x] Retenção de 7 anos para dados agregados mensais
- [x] Isolamento multi-tenant de métricas e quotas

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (definida em WF-RF045)
- Coleta de métricas de hardware (CPU, memória do servidor)
- Integração com ferramentas externas de APM (Datadog, New Relic)
- Cobrança automática baseada em consumo (billing)
- Otimização automática de infraestrutura

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| Volumetria | Medida quantitativa de dados trafegados, armazenados ou processados pelo sistema |
| Quota | Limite máximo de consumo (bytes, requests) permitido para um fornecedor em período definido |
| Agregação (Rollup) | Consolidação de dados detalhados em períodos maiores (ex: minutos → horas) |
| Throttling | Limitação progressiva de taxa de requisições ao se aproximar de limites |
| Anomalia | Consumo que excede 2x a média dos últimos 7 dias |
| Forecast | Previsão de consumo futuro baseada em histórico e machine learning |
| P95/P99 | Percentil 95/99 de latência (95% dos requests completam em X ms) |
| Raw Data | Dados brutos coletados por request (granularidade de 1 segundo) |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Coleta Automática de Métricas** - Middleware captura tamanho, latência e status de cada request
2. **Agregação e Rollups** - Jobs automáticos consolidam dados por hora, dia e mês
3. **Configuração de Quotas** - Definir limites por fornecedor (GB/mês, requests/mês)
4. **Monitoramento em Tempo Real** - Dashboard com consumo atual vs quota
5. **Alertas Automáticos** - Notificações em 80%, 95% e 100% da quota
6. **Previsão de Capacidade** - Forecast com Azure ML (30/60/90 dias)
7. **Detecção de Anomalias** - Alertas quando consumo excede 2x a média
8. **Throttling Progressivo** - Rate limit escalonado (95% → 99% → 100%)
9. **Dashboards Visuais** - Gráficos, heatmaps e top endpoints/usuários
10. **Drill-Down Detalhado** - Investigação até request individual (últimos 7 dias)
11. **Relatórios de Otimização** - Recomendações de economia e performance
12. **Exportação de Dados** - Export de métricas para análise externa

---

## 5. REGRAS DE NEGÓCIO

### RN-RF045-01 — Granularidade de Coleta e Retenção

**Descrição**: Dados são coletados a cada request (1 segundo) mas armazenados apenas 7 dias. Agregações horárias ficam 90 dias, diárias 2 anos, mensais 7 anos.

**Justificativa**: Balanceia necessidade de análise detalhada com custo de storage. 99% das análises usam dados agregados.

**Critério de Aceite**:
- Raw data < 7 dias → disponível para drill-down individual
- Raw data > 7 dias → apenas agregados disponíveis
- Agregados mensais → mantidos por 7 anos (conformidade LGPD)

---

### RN-RF045-02 — Quota Mensal Obrigatória por Fornecedor

**Descrição**: Todo fornecedor deve ter quota mensal configurada (GB tráfego + número de requests). Sem quota = ilimitado apenas para Super Admin.

**Justificativa**: Evita abuso de recursos e permite billing justo. Protege infraestrutura de sobrecargas.

**Critério de Aceite**:
- Criar fornecedor sem quota → erro de validação (exceto Super Admin)
- Default para novos fornecedores: 50GB/500K requests
- Quota proporcional se criado no meio do mês

**Exemplo**:
```
Quota mensal: 100 GB
Criado em: 15/01 (30 dias no mês)
Dias restantes: 16 dias
Quota proporcional: 100 * (16/30) = 53.3 GB
```

---

### RN-RF045-03 — Alerta Proativo em 80% da Quota

**Descrição**: Sistema alerta automaticamente quando fornecedor atingir 80% da quota mensal ou quando previsão indicar esgotamento em 7 dias.

**Justificativa**: Permite ação proativa (upgrade de plano, otimização) antes de bloquear serviço.

**Critério de Aceite**:
- Atingir 80% da quota → alerta enviado (e-mail + in-app)
- Previsão indicar 100% em 7 dias → alerta enviado
- Alerta enviado apenas 1x por threshold (não spam)

---

### RN-RF045-04 — Throttling Progressivo (95%-99%-100%)

**Descrição**: Ao atingir 95% da quota, sistema aplica rate limit de 50 req/min (normal: 100 req/min). A 99%, rate limit de 80%. A 100%, bloqueia POST/PUT/DELETE (GET permitido).

**Justificativa**: Degrada serviço gradualmente ao invés de bloqueio abrupto. Permite finalizar operações críticas.

**Critério de Aceite**:
- 95%-98%: Rate limit 50% (10 req/min)
- 99%-99.9%: Rate limit 80% (5 req/min)
- 100%+: Apenas GET permitido, POST/PUT/DELETE = 429 Too Many Requests

---

### RN-RF045-05 — Isolamento Multi-Tenant de Volumetria

**Descrição**: Volumetria de um fornecedor não pode afetar outro. Quotas, limites e billing são completamente isolados.

**Justificativa**: Fair usage e isolamento de recursos. Evita "noisy neighbor problem".

**Critério de Aceite**:
- Queries SEMPRE filtram por `FornecedorId`
- Quota de fornecedor A não impacta fornecedor B
- Alertas e relatórios separados por fornecedor

---

### RN-RF045-06 — Exclusão de Health Checks da Quota

**Descrição**: Requests de health check (`/health`, `/ping`, `/metrics`) não contam para quota de volumetria.

**Justificativa**: Health checks são infraestrutura, não uso real. Evita consumo artificial de quota.

**Critério de Aceite**:
- Endpoints matching regex `^/(health|ping|metrics)` → excluídos
- Outros endpoints → incluídos na quota

---

### RN-RF045-07 — Detecção de Anomalias (2x Média de 7 Dias)

**Descrição**: Se consumo de um dia ultrapassar 2x a média dos últimos 7 dias, dispara alerta de anomalia.

**Justificativa**: Detecta comportamento atípico que pode indicar ataque, bug ou uso indevido.

**Critério de Aceite**:
- Consumo diário > 2x média de 7 dias → alerta com severidade ALTA
- Sugestão automática de possíveis causas (exportação massiva, loop, DDoS)

---

### RN-RF045-08 — Rollup Automático Irreversível

**Descrição**: Após agregação de dados raw para hourly/daily/monthly, dados originais são deletados permanentemente.

**Justificativa**: Dados agregados são suficientes para 99% das análises. Manter raw é desperdício de 95% do storage.

**Critério de Aceite**:
- Após agregação bem-sucedida → delete de raw data
- Log de agregação para auditoria
- Delete em batch (100K registros por vez)

---

### RN-RF045-09 — Billing Proporcional por Período Parcial

**Descrição**: Se fornecedor criado no meio do mês, quota é proporcional aos dias restantes.

**Justificativa**: Cobrança justa apenas pelo período de uso efetivo.

**Critério de Aceite**:
- Fórmula: `quotaMensal * (diasRestantes / diasTotaisMes)`
- Arredondamento: 1 casa decimal

---

### RN-RF045-10 — Forecast Apenas com 3+ Meses de Histórico

**Descrição**: Previsão de consumo só é gerada se fornecedor tiver pelo menos 3 meses de histórico. Caso contrário, usa média simples.

**Justificativa**: Machine learning precisa de dados suficientes para ser confiável. Com < 3 meses, previsão seria imprecisa.

**Critério de Aceite**:
- Histórico < 3 meses → previsão por média simples
- Histórico >= 3 meses → previsão via Azure ML
- Intervalo de confiança 95% exibido

---

### RN-RF045-11 — Exportação Limitada a 1 GB por Request

**Descrição**: Endpoints de exportação (`/api/volumetria/export`) retornam máximo 1 GB por request. Exportações maiores usam background job.

**Justificativa**: Evita timeout e consumo excessivo de memória. Protege contra DoS acidental.

**Critério de Aceite**:
- Dataset <= 1 GB → retorno síncrono
- Dataset > 1 GB → HTTP 413 Payload Too Large + sugestão de job assíncrono

---

### RN-RF045-12 — Cache Agressivo para Endpoints de Leitura

**Descrição**: Endpoints `GET` de dados estáticos devem ter cache de 15min. Reduz volumetria em 60-80% sem impacto na experiência.

**Justificativa**: Maioria dos requests são leituras idênticas. Cache reduz tráfego, latência e custos.

**Critério de Aceite**:
- Header `Cache-Control: public, max-age=900` em GET de dados estáticos
- Invalidação de cache em UPDATE/DELETE da entidade

---

### RN-RF045-13 — Retenção de 7 Anos para Conformidade LGPD

**Descrição**: Dados agregados mensais devem ser mantidos por 7 anos para auditoria fiscal e conformidade com LGPD.

**Justificativa**: Legislação brasileira exige retenção de 7 anos para dados financeiros/fiscais.

**Critério de Aceite**:
- Dados < 7 anos → hot storage (Azure SQL)
- Dados > 7 anos → cold storage (Azure Blob)
- Após 7 anos → delete permanente

---

### RN-RF045-14 — Drill-Down até Request Individual (7 Dias)

**Descrição**: Usuário pode fazer drill-down de qualquer métrica agregada até o request individual, mas apenas dos últimos 7 dias.

**Justificativa**: Permite investigação detalhada de problemas recentes. Após 7 dias, apenas dados agregados disponíveis.

**Critério de Aceite**:
- Click em métrica < 7 dias → lista de requests individuais
- Click em métrica > 7 dias → mensagem "Dados detalhados não disponíveis"

---

### RN-RF045-15 — Notificação Semanal de Resumo para Administradores

**Descrição**: Todo domingo às 23h, sistema envia e-mail automático para administradores com resumo semanal de volumetria e anomalias.

**Justificativa**: Mantém equipe informada de forma proativa. Identifica tendências antes de virarem problemas.

**Critério de Aceite**:
- E-mail enviado todo domingo 23h (UTC-3)
- Destinatários: perfil "Administrador" + "Gestor"
- Conteúdo: consumo total, alertas, anomalias, previsão

---

## 6. ESTADOS DA ENTIDADE

**Entidades principais**: `VolumetriaConsumo`, `VolumetriaLimite`, `VolumetriaAlerta`

### Estados de VolumetriaLimite

| Estado | Descrição |
|--------|-----------|
| ativo | Limite ativo e sendo monitorado |
| suspenso | Temporariamente desabilitado (não bloqueia) |
| excedido | Quota ultrapassada (ações configuradas ativas) |

### Transições permitidas

| De | Para | Condição |
|----|------|----------|
| ativo | suspenso | Admin suspende manualmente |
| suspenso | ativo | Admin reativa |
| ativo | excedido | Consumo >= 100% da quota |
| excedido | ativo | Novo período inicia ou quota aumentada |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre | Ações desencadeadas |
|--------|---------------|---------------------|
| `volumetria.quota.atingida` | Consumo atinge 80%, 95% ou 100% | Envio de alerta, log de auditoria |
| `volumetria.anomalia.detectada` | Consumo > 2x média de 7 dias | Alerta crítico, investigação sugerida |
| `volumetria.limite.alterado` | Admin altera quota | Auditoria, recálculo de alertas |
| `volumetria.throttling.ativado` | Quota em 95%+ | Rate limit aplicado |
| `volumetria.forecast.gerado` | Previsão mensal calculada | Dashboard atualizado, alertas preventivos |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Coleta de métricas não pode adicionar > 5ms de latência por request
- Agregação de dados não pode impactar performance do sistema (rodar em background)
- Alertas devem ser enviados em < 5 minutos após threshold atingido
- Queries de dashboard devem responder em < 2 segundos
- Isolamento multi-tenant 100% garantido (zero vazamento entre fornecedores)
- Auditoria completa de alterações de quotas e limites

---

## 9. SEGURANÇA

- **Isolamento Multi-Tenant**: Queries SEMPRE filtram por `FornecedorId`
- **Permissões RBAC**: Cada operação exige permissão específica
- **Validação de Entrada**: Quotas não podem ser negativas ou zero
- **Rate Limiting**: Proteção contra abuso de APIs de consulta
- **Auditoria**: Todas alterações de limites logadas com usuário e timestamp
- **Exportação Controlada**: Limite de 1 GB por request

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF045.md** - Casos de Uso detalhados
- **MD-RF045.yaml** - Modelo de Dados
- **WF-RF045.md** - Wireframes e fluxos de tela
- **TC-RF045.yaml** - Casos de Teste
- **MT-RF045.yaml** - Massas de Teste

---

## 11. RASTREABILIDADE

| Artefato | Status |
|----------|--------|
| Casos de Uso (UC-RF045) | Obrigatório |
| Modelo de Dados (MD-RF045) | Obrigatório |
| Wireframes (WF-RF045) | Obrigatório |
| Casos de Teste (TC-RF045) | Obrigatório |
| Massas de Teste (MT-RF045) | Obrigatório |

**Referência ao Legado**: RL-RF045.md

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0: separação RF/RL, contrato funcional limpo | Agência ALC - alc.dev.br |
| 1.0 | 2025-01-14 | Versão inicial com legado misturado | Agência ALC - alc.dev.br |
