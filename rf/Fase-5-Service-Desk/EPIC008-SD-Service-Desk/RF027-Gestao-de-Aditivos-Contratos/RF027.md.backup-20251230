# RF-027: Gest√£o de Aditivos de Contratos de Telecom e TI

**Vers√£o**: 1.0
**√öltima Atualiza√ß√£o**: 17/12/2025
**Status**: ‚úÖ Documenta√ß√£o Completa (5 se√ß√µes)
**Fase**: Fase 2 - Servi√ßos Essenciais
**EPIC**: GES - Gest√£o
**Prioridade**: ALTA
**Complexidade**: ALTA

[‚Üê Voltar](../README.md)

---

## üìã 1. RESUMO EXECUTIVO

### Descri√ß√£o Geral

Sistema completo de gest√£o de aditivos contratuais para contratos de Telecom (telefonia, internet, links) e TI (licenciamento, suporte, cloud) com controle rigoroso de vers√µes, workflow de aprova√ß√£o multi-n√≠vel, c√°lculo autom√°tico de impacto financeiro, rastreamento de prazos e vig√™ncias, alertas de renova√ß√£o autom√°tica, integra√ß√£o com sistema jur√≠dico e dashboard executivo de pipeline de aditivos. Suporta 8 tipos de aditivos (acr√©scimo/supress√£o de linhas, altera√ß√£o tarif√°ria, prorroga√ß√£o de prazo, mudan√ßa de SLA, inclus√£o/exclus√£o de servi√ßos, reajuste inflacion√°rio, troca de garantias) com templates pr√©-definidos e builder visual para cl√°usulas customizadas.

**Objetivo Principal**: Garantir controle total sobre modifica√ß√µes contratuais que representam 40-60% dos contratos ativos em telecom (m√©dia 2,3 aditivos por contrato), eliminar diverg√™ncias entre contrato f√≠sico vs. sistema (problema recorrente em auditorias), automatizar c√°lculo de impacto financeiro que hoje leva 4-6 horas por aditivo complexo, assegurar compliance jur√≠dico com rastreabilidade de aprova√ß√µes (SOX, LGPD) e fornecer visibilidade gerencial de economia/custo incremental gerado por aditivos (ROI m√©dio 8-12% em renegocia√ß√µes).

### Contexto: Legado vs. Moderniza√ß√£o

| Aspecto | Legado (VB.NET) | Moderniza√ß√£o (.NET 10) |
|---------|----------------|----------------------|
| **Cadastro Aditivo** | Formul√°rio simples (tipo + valor) | Wizard multi-step com valida√ß√µes contextuais |
| **Versionamento** | Nenhum (sobrescrevia contrato original) | Hist√≥rico completo + diff highlighting |
| **Impacto Financeiro** | Planilha Excel manual (6h c√°lculo) | Motor autom√°tico em <5s com proje√ß√£o 12 meses |
| **Workflow Aprova√ß√£o** | Email manual (sem rastreamento) | Workflow BPM com 3 n√≠veis + DocuSign |
| **Vig√™ncia** | Campo data manual (sem valida√ß√£o) | Valida√ß√£o autom√°tica + extens√£o contrato base |
| **Documentos** | Upload PDF √∫nico (perdido facilmente) | Versionamento docs + Azure Blob Storage |
| **Alertas Vencimento** | Nenhum (descobria ap√≥s vencer) | Alertas 30/60/90 dias + renova√ß√£o autom√°tica |
| **Relat√≥rios** | Excel est√°tico | Dashboards tempo real + pipeline aditivos |
| **Templates Cl√°usulas** | Copiar/colar Word (formata√ß√£o quebra) | Library jur√≠dica com 50+ templates + builder |
| **Compara√ß√£o Vers√µes** | Manual em Word (track changes) | Diff visual autom√°tico (highlight changes) |

### 10 Funcionalidades Principais

1. **8 Tipos de Aditivos Suportados**: Acr√©scimo Linhas, Supress√£o Linhas, Altera√ß√£o Tarif√°ria, Prorroga√ß√£o Prazo, Mudan√ßa SLA, Inclus√£o Servi√ßos, Reajuste Inflacion√°rio, Troca Garantias - cada um com wizard espec√≠fico
2. **Wizard Multi-Step Inteligente**: Fluxo guiado em 5 etapas (Tipo ‚Üí Dados ‚Üí Impacto ‚Üí Documentos ‚Üí Revis√£o) com valida√ß√µes contextuais por tipo de aditivo
3. **C√°lculo Autom√°tico Impacto Financeiro**: Motor calcula valor incremental mensal/anual, proje√ß√£o 12 meses, compara√ß√£o pr√©/p√≥s-aditivo, gr√°fico waterfall de varia√ß√£o
4. **Versionamento Completo Contratos**: Cada aditivo cria nova vers√£o do contrato preservando hist√≥rico, diff visual destaca mudan√ßas, restaura√ß√£o de vers√£o anterior poss√≠vel
5. **Workflow Aprova√ß√£o Multi-N√≠vel**: 3 n√≠veis configur√°veis (Gestor ‚Üí Jur√≠dico ‚Üí Diretoria) com delega√ß√£o, prazos SLA e escala√ß√£o autom√°tica se n√£o aprovar em X dias
6. **Library Jur√≠dica de Cl√°usulas**: 50+ templates pr√©-aprovados (cl√°usulas padr√£o telecom/TI) + builder visual para compor aditivo com drag-and-drop
7. **Gest√£o Documental Integrada**: Upload PDFs/Word com OCR autom√°tico para extrair dados-chave, versionamento docs vinculados, assinatura digital via DocuSign
8. **Alertas Inteligentes Vencimento**: Machine Learning prev√™ probabilidade renova√ß√£o autom√°tica baseada em hist√≥rico + alertas escalonados 90/60/30 dias
9. **Dashboard Pipeline Aditivos**: Kanban visual (Rascunho ‚Üí Aprova√ß√£o ‚Üí Assinatura ‚Üí Vigente ‚Üí Encerrado) com m√©tricas - tempo m√©dio aprova√ß√£o, valor total em pipeline, taxa aprova√ß√£o
10. **Compara√ß√£o Vers√µes Contratos**: Diff engine visual que destaca cl√°usulas adicionadas/removidas/modificadas entre vers√µes de contrato com color coding

### Impacto de Neg√≥cio

- **Economia Direta:** Identifica√ß√£o de oportunidades renegocia√ß√£o em aditivos gera economia m√©dia 8-12% (R$120k/ano para empresa com R$1M/ano em contratos)
- **Efici√™ncia Operacional:** Redu√ß√£o de 85% no tempo an√°lise aditivo (de 6h para 1h) = R$35k/ano economia RH
- **Compliance Jur√≠dico:** Rastreabilidade total (SOX, LGPD) elimina 100% das n√£o-conformidades em auditorias contratuais
- **ROI:** Sistema paga-se em 4 meses com economia em renegocia√ß√µes + efici√™ncia
- **Visibilidade:** Dashboard pipeline permite gest√£o proativa de vencimentos e renova√ß√µes (evita surpresas de √∫ltima hora)

---

## üìê 2. REGRAS DE NEG√ìCIO

### RN-ADT-027-01: 8 Tipos de Aditivos Suportados

**Descri√ß√£o**: Sistema DEVE suportar 8 tipos distintos de aditivos contratuais, cada um com wizard e valida√ß√µes espec√≠ficas:

**1. Acr√©scimo de Linhas/Ativos**:
- Adiciona novas linhas telef√¥nicas, chips, equipamentos ao contrato existente
- Campos: Quantidade, Valor Unit√°rio, Plano/Servi√ßo, Data Ativa√ß√£o
- Valida√ß√£o: Valor total ‚â§ 25% do valor contrato base (acima requer aprova√ß√£o diretor)

**2. Supress√£o de Linhas/Ativos**:
- Remove linhas/ativos do contrato (cancelamento parcial)
- Campos: Linhas a remover, Motivo, Data Desligamento
- Valida√ß√£o: N√£o pode suprimir >50% das linhas sem criar novo contrato
- C√°lculo Multa: Se supress√£o antes de prazo m√≠nimo (fideliza√ß√£o), calcula multa automaticamente

**3. Altera√ß√£o Tarif√°ria**:
- Modifica valores de planos/servi√ßos sem alterar quantidade
- Campos: Plano Original, Plano Novo, % Desconto Negociado
- Compara√ß√£o: Gr√°fico comparativo valor mensal antes/depois

**4. Prorroga√ß√£o de Prazo**:
- Estende vig√™ncia do contrato
- Campos: Nova Data T√©rmino, Mant√©m Condi√ß√µes Originais (Sim/N√£o)
- Valida√ß√£o: Data t√©rmino ‚â• Data t√©rmino atual + 1 m√™s
- Impacto: Calcula valor total adicional no per√≠odo prorrogado

**5. Mudan√ßa de SLA**:
- Altera acordos de n√≠vel servi√ßo (tempo resposta, disponibilidade)
- Campos: SLA Atual, SLA Novo, Impacto Tarif√°rio
- Refer√™ncia Cruzada: Valida SLA contra RF-028 (Gest√£o SLA Opera√ß√µes)

**6. Inclus√£o de Novos Servi√ßos**:
- Adiciona servi√ßos n√£o previstos no contrato original
- Campos: Descri√ß√£o Servi√ßo, Valor, Forma Cobran√ßa (mensal/√∫nica)
- Valida√ß√£o: Servi√ßo n√£o pode ser duplicado de existente

**7. Reajuste Inflacion√°rio**:
- Aplica√ß√£o de √≠ndices econ√¥micos (IPCA, IGP-M, IPC)
- Campos: √çndice Aplicado, Per√≠odo Base, % Reajuste
- C√°lculo Autom√°tico: Sistema consulta API Banco Central para obter √≠ndice oficial do per√≠odo
- Compara√ß√£o: Valida se % reajuste ‚â§ √≠ndice oficial + 2% (teto cl√°usula reajuste)

**8. Troca de Garantias**:
- Substitui tipo de garantia (fian√ßa banc√°ria ‚Üí seguro garantia, etc.)
- Campos: Garantia Atual, Garantia Nova, Valor, Institui√ß√£o
- Upload Obrigat√≥rio: Documento nova garantia (PDF/scan)

**Wizard Contextual**: UI exibe campos e valida√ß√µes espec√≠ficas para o tipo selecionado.

### RN-ADT-027-02: Wizard Multi-Step com Valida√ß√µes Progressivas

**Descri√ß√£o**: Cria√ß√£o de aditivo DEVE seguir wizard guiado em 5 etapas com valida√ß√µes progressivas (n√£o permite avan√ßar se etapa incompleta).

**Etapa 1 - Identifica√ß√£o**:
- Selecionar contrato base (dropdown com autocomplete)
- Tipo de aditivo (radio buttons com 8 op√ß√µes)
- N√∫mero aditivo (auto-gerado: ADD-{Num_Contrato}-{Seq})
- Valida√ß√£o: Contrato deve estar vigente (status = Ativo)

**Etapa 2 - Dados Espec√≠ficos**:
- Campos din√¢micos baseados no tipo (vide RN-ADT-027-01)
- Datas vig√™ncia (in√≠cio/t√©rmino)
- Valida√ß√£o: Vig√™ncia aditivo ‚äÜ Vig√™ncia contrato base + prorroga√ß√£o

**Etapa 3 - Impacto Financeiro**:
- Sistema calcula automaticamente (vide RN-ADT-027-03)
- Usu√°rio pode ajustar valores manualmente com justificativa
- Gr√°ficos comparativos (antes/depois)
- Valida√ß√£o: Varia√ß√£o >20% exige justificativa obrigat√≥ria

**Etapa 4 - Documentos**:
- Upload PDF/Word aditivo assinado (obrigat√≥rio ao finalizar)
- Upload anexos opcionais (emails negocia√ß√£o, propostas comerciais)
- OCR autom√°tico extrai dados para valida√ß√£o cruzada
- Valida√ß√£o: Hash SHA-256 do doc para detectar modifica√ß√µes futuras

**Etapa 5 - Revis√£o e Envio**:
- Tela sum√°rio com todos os dados
- Compara√ß√£o lado a lado (contrato original vs. p√≥s-aditivo)
- Bot√£o "Salvar Rascunho" ou "Enviar para Aprova√ß√£o"

**Salvamento Autom√°tico**: Wizard salva progresso automaticamente a cada 30 segundos em `Aditivo` table com status "Rascunho".

### RN-ADT-027-03: C√°lculo Autom√°tico de Impacto Financeiro

**Descri√ß√£o**: Sistema DEVE calcular automaticamente o impacto financeiro de cada aditivo com 4 m√©tricas principais:

**M√©tricas Calculadas**:

1. **Valor Incremental Mensal**:
   - Diferen√ßa entre valor mensal p√≥s-aditivo vs. pr√©-aditivo
   - F√≥rmula: `Valor_Novo_Mensal - Valor_Atual_Mensal`
   - Exibi√ß√£o: R$ +XX.XXX (verde) ou R$ -XX.XXX (vermelho)

2. **Valor Incremental Anual**:
   - Proje√ß√£o 12 meses considerando vig√™ncia
   - F√≥rmula: `Valor_Incremental_Mensal √ó Meses_Vigencia_Restante`

3. **Valor Total Contrato P√≥s-Aditivo**:
   - Soma valor contrato base + todos os aditivos vigentes
   - Compara√ß√£o: % de aumento/redu√ß√£o vs. valor original

4. **Proje√ß√£o 12 Meses**:
   - Gr√°fico linha mostrando evolu√ß√£o mensal do custo
   - Considera: Reajustes autom√°ticos, sazonalidade (se hist√≥rico dispon√≠vel)

**Gr√°fico Waterfall**: Visualiza√ß√£o cascata mostrando:
- Barra base (valor contrato original)
- Barras incrementais/decrementais (aditivos anteriores)
- Barra destacada (aditivo atual)
- Barra total final

**Exporta√ß√£o**: Permite exportar c√°lculo em PDF com gr√°ficos para anexar √† proposta de aprova√ß√£o.

### RN-ADT-027-04: Versionamento Completo de Contratos

**Descri√ß√£o**: Cada aditivo aprovado DEVE criar nova vers√£o do contrato preservando hist√≥rico completo com diff visual autom√°tico.

**Estrutura Versionamento**:
- Tabela `Contrato_Versao` com campos:
  - Numero_Versao (v1.0, v1.1, v1.2...)
  - Id_Aditivo_Gerador (FK para Aditivo)
  - Snapshot_Dados (JSON completo da vers√£o)
  - Documento_PDF_URL (Azure Blob)
  - Hash_SHA256 (integridade)
  - Dt_Criacao_Versao
  - Usuario_Responsavel_Id

**Versionamento Sem√¢ntico**:
- Aditivos pequenos (tipo 3, 7): Incrementa minor version (v1.0 ‚Üí v1.1)
- Aditivos significativos (tipo 1, 2, 4): Incrementa major version (v1.2 ‚Üí v2.0)
- Crit√©rio: Impacto financeiro >15% = major version

**Diff Visual**: UI exibe compara√ß√£o lado a lado entre vers√µes:
- **Verde**: Cl√°usulas/itens adicionados
- **Vermelho**: Cl√°usulas/itens removidos
- **Amarelo**: Cl√°usulas modificadas (hover mostra antes/depois)
- **Cinza**: Cl√°usulas inalteradas (pode ocultar)

**Restaura√ß√£o**: Administrador pode restaurar vers√£o anterior (ex: se aditivo foi cancelado) com justificativa obrigat√≥ria.

**Imutabilidade**: Vers√µes anteriores N√ÉO podem ser editadas (somente consulta) para compliance.

### RN-ADT-027-05: Workflow de Aprova√ß√£o Multi-N√≠vel

**Descri√ß√£o**: Aditivo DEVE passar por workflow aprova√ß√£o configur√°vel de at√© 3 n√≠veis antes de entrar em vig√™ncia.

**N√≠veis Padr√£o**:

**N√≠vel 1 - Gestor Operacional**:
- Respons√°vel: Gerente departamento que solicitou aditivo
- Valida√ß√£o: Checklist t√©cnico (linhas corretas, planos adequados, valores ok)
- SLA: 2 dias √∫teis

**N√≠vel 2 - Jur√≠dico**:
- Respons√°vel: Advogado/Analista Jur√≠dico
- Valida√ß√£o: Conformidade cl√°usulas, riscos contratuais, multas
- SLA: 5 dias √∫teis
- Pode solicitar ajustes (retorna para solicitante)

**N√≠vel 3 - Diretoria Financeira**:
- Respons√°vel: CFO/Controller
- Gatilho: Apenas se impacto financeiro >R$50k/ano (configur√°vel)
- Valida√ß√£o: Aprova√ß√£o or√ßament√°ria, alinhamento budget
- SLA: 3 dias √∫teis

**Configurabilidade**: Administrador pode:
- Adicionar/remover n√≠veis por tipo de aditivo
- Alterar SLA por n√≠vel
- Definir gatilhos financeiros (ex: >R$100k = CEO deve aprovar)
- Configurar delega√ß√£o (se aprovador ausente, delega para substituto)

**Escala√ß√£o Autom√°tica**: Se aprovador n√£o responde em 80% do SLA, sistema:
1. Envia lembrete email + push notification
2. Aos 100% SLA, escala para gestor superior
3. Registra evento em log auditoria

**Aprova√ß√£o Mobile**: Aprovadores podem aprovar/rejeitar via app MAUI com justificativa obrigat√≥ria se rejeitar.

**Assinatura Digital**: N√≠vel final (geralmente N√≠vel 3) requer assinatura digital via DocuSign antes de marcar aditivo como "Vigente".

### RN-ADT-027-06: Library Jur√≠dica de Cl√°usulas

**Descri√ß√£o**: Sistema DEVE fornecer biblioteca de 50+ templates de cl√°usulas contratuais pr√©-aprovadas pelo jur√≠dico + builder visual para compor aditivo.

**Categorias de Templates**:

**Telecom (20 templates)**:
- Cl√°usula SLA disponibilidade rede (99,5%, 99,9%, 99,99%)
- Multa descumprimento SLA (% desconto proporcional)
- Reajuste IPCA/IGP-M anual
- Cancelamento sem multa (ap√≥s fideliza√ß√£o)
- Portabilidade de linhas (n√∫mero dias)

**TI/Cloud (15 templates)**:
- SLA uptime cloud (AWS, Azure, GCP)
- Licenciamento per-user/per-device
- Suporte 24x7 vs. hor√°rio comercial
- Backup e disaster recovery (RPO/RTO)
- LGPD data processing agreement

**Gerais (15 templates)**:
- Renova√ß√£o autom√°tica (prazo indeterminado)
- Rescis√£o antecipada (multa rescis√≥ria)
- Foro competente
- Confidencialidade (NDA)
- For√ßa maior (caso fortuito)

**Builder Visual**:
1. Drag-and-drop cl√°usulas da biblioteca para o canvas
2. Editar texto cl√°usula (personalizar vari√°veis: datas, valores, nomes)
3. Reordenar cl√°usulas
4. Preview PDF em tempo real
5. Salvar como novo template customizado

**Versionamento Templates**: Jur√≠dico pode criar novas vers√µes de templates (ex: "Cl√°usula SLA v2.0"). Aditivos hist√≥ricos mant√™m refer√™ncia para vers√£o usada.

**Aprova√ß√£o Jur√≠dica**: Templates customizados criados por usu√°rios comuns requerem aprova√ß√£o jur√≠dica antes de usar.

### RN-ADT-027-07: Gest√£o Documental Integrada

**Descri√ß√£o**: Sistema DEVE gerenciar ciclo de vida completo de documentos do aditivo (upload, OCR, versionamento, assinatura, arquivamento).

**Upload Documentos**:
- Suporta: PDF, Word (DOCX), imagens (scan)
- Tamanho m√°ximo: 25 MB por arquivo
- OCR autom√°tico: Azure Form Recognizer extrai dados-chave para valida√ß√£o cruzada
- Armazenamento: Azure Blob Storage (hot tier para docs vigentes, cool tier para hist√≥ricos)

**Tipos de Documentos**:
1. **Aditivo Assinado** (obrigat√≥rio) - Documento oficial p√≥s-assinatura
2. **Minuta Aditivo** (opcional) - Vers√£o pr√©-assinatura para revis√£o
3. **Emails Negocia√ß√£o** (opcional) - Evid√™ncias discuss√£o comercial
4. **Propostas Comerciais** (opcional) - Propostas operadora/fornecedor
5. **Aprova√ß√µes Internas** (autom√°tico) - PDFs gerados do workflow

**OCR e Valida√ß√£o Cruzada**:
- Sistema extrai: N√∫mero aditivo, datas, valores, partes contratantes
- Compara extra√≠do vs. dados cadastrados manualmente
- Alerta se diverg√™ncia >5% (ex: valor cadastrado R$10k mas PDF mostra R$12k)

**Versionamento Docs**:
- Cada upload cria nova vers√£o (v1, v2, v3...)
- Hash SHA-256 garante integridade (detecta modifica√ß√£o)
- Download sempre da vers√£o mais recente, mas pode consultar vers√µes anteriores

**Assinatura Digital DocuSign**:
- Workflow: Gera PDF minuta ‚Üí Envia para DocuSign com signat√°rios ‚Üí Recebe callback webhook ‚Üí Armazena doc assinado
- Signat√°rios: Representante empresa + Representante operadora (emails configur√°veis)
- Certificado: Inclu√≠do no PDF assinado (validade jur√≠dica)

**Reten√ß√£o**: Docs vigentes mantidos indefinidamente, docs de aditivos cancelados por 7 anos (compliance fiscal).

### RN-ADT-027-08: Alertas Inteligentes de Vencimento

**Descri√ß√£o**: Sistema DEVE monitorar vencimentos de aditivos e contratos base, gerando alertas escalonados 90/60/30 dias antes com Machine Learning prevendo renova√ß√£o autom√°tica.

**Alertas Padr√£o**:

**90 dias antes**:
- Email para gestor operacional
- Conte√∫do: Resumo aditivo, valor, pr√≥ximas a√ß√µes

**60 dias antes**:
- Email + push notification para gestor + jur√≠dico
- Conte√∫do: + Hist√≥rico varia√ß√£o pre√ßos (sugest√£o renegocia√ß√£o)

**30 dias antes**:
- Email + push + in-app notification para todos stakeholders
- Conte√∫do: + KPI compara√ß√£o mercado (benchmark)
- A√ß√£o: Bot√£o "Iniciar Renegocia√ß√£o" (workflow RFP)

**Previs√£o ML Renova√ß√£o Autom√°tica**:
- Modelo treinado com hist√≥rico: 70% dos contratos renovam automaticamente sem renegocia√ß√£o
- Features: Tipo servi√ßo, valor, fornecedor, hist√≥rico contesta√ß√µes, satisfa√ß√£o (NPS)
- Output: Probabilidade 0-100% de renova√ß√£o autom√°tica
- Alerta: Se probabilidade >80%, sugere revis√£o preventiva (evitar renova√ß√£o desfavor√°vel)

**Dashboard Vencimentos**: Kanban com 4 colunas:
- >90 dias (verde)
- 60-90 dias (amarelo)
- 30-60 dias (laranja)
- <30 dias (vermelho)

Cada card mostra: Contrato, Aditivo, Valor, Data vencimento, A√ß√£o recomendada.

### RN-ADT-027-09: Dashboard Pipeline de Aditivos

**Descri√ß√£o**: Sistema DEVE exibir dashboard executivo com pipeline visual de aditivos em andamento e KPIs principais.

**Pipeline Kanban**:
5 colunas representando status:
1. **Rascunho** (cinza) - Aditivos em elabora√ß√£o
2. **Em Aprova√ß√£o** (amarelo) - Workflow aprova√ß√£o em andamento
3. **Aguardando Assinatura** (laranja) - Aprovado mas pendente DocuSign
4. **Vigente** (verde) - Aditivo ativo
5. **Encerrado** (azul) - Aditivo conclu√≠do/expirado

**M√©tricas Pipeline**:
- Total aditivos em pipeline
- Valor total em aprova√ß√£o (R$)
- Tempo m√©dio aprova√ß√£o (dias)
- Taxa aprova√ß√£o 1¬™ rodada (% aprovados sem retorno)
- Bottleneck atual (qual n√≠vel aprova√ß√£o est√° mais lento)

**Gr√°ficos Executivos**:
1. **Distribui√ß√£o por Tipo**: Pie chart - % de cada tipo de aditivo
2. **Evolu√ß√£o Temporal**: Line chart - aditivos criados por m√™s (12 meses)
3. **Ranking Fornecedores**: Bar chart - Top 10 fornecedores com mais aditivos
4. **Impacto Financeiro**: Waterfall - economia vs. custo adicional gerado
5. **Funil Aprova√ß√£o**: Funnel chart - taxa convers√£o por n√≠vel

**Drill-Down**: Clicar em qualquer gr√°fico exibe lista detalhada de aditivos com filtros aplicados.

**Exporta√ß√£o**: Dashboard export√°vel em PDF (snapshot mensal para apresenta√ß√£o diretoria).

### RN-ADT-027-10: Compara√ß√£o Visual entre Vers√µes

**Descri√ß√£o**: Sistema DEVE permitir compara√ß√£o lado a lado entre qualquer duas vers√µes do contrato com highlight autom√°tico de diferen√ßas.

**Diff Engine**:
- Algoritmo: Myers' diff algorithm (mesmo usado pelo Git)
- Granularidade: Palavra por palavra (n√£o linha inteira)
- Color Coding:
  - üü¢ **Verde**: Texto adicionado nesta vers√£o
  - üî¥ **Vermelho**: Texto removido nesta vers√£o (strikethrough)
  - üü° **Amarelo**: Texto modificado (hover mostra vers√£o anterior)
  - ‚ö™ **Cinza**: Texto inalterado

**UI Compara√ß√£o**:
- Dropdown: Selecionar "Vers√£o A" (ex: v1.0) vs. "Vers√£o B" (ex: v1.2)
- Split View: 2 colunas lado a lado sincronizadas (scroll de uma move a outra)
- Unified View: Coluna √∫nica com color coding
- Toggle: Pode ocultar cl√°usulas inalteradas (mostra apenas diff)

**Navega√ß√£o**:
- Bot√µes "Pr√≥xima Diferen√ßa" / "Diferen√ßa Anterior"
- Jump to Section (menu lateral com navega√ß√£o r√°pida)

**Exporta√ß√£o**: Gera PDF comparativo com highlight de diferen√ßas para anexar em memorando de aprova√ß√£o.

**Performance**: Compara√ß√£o de contratos grandes (>100 p√°ginas) executa em background job Hangfire, usu√°rio recebe notifica√ß√£o quando conclu√≠da.

### RN-ADT-027-11: Valida√ß√£o de Vig√™ncia e Datas

**Descri√ß√£o**: Sistema DEVE validar automaticamente consist√™ncia de datas entre aditivo e contrato base.

**Regras de Valida√ß√£o**:

1. **In√≠cio Aditivo**:
   - `Dt_Inicio_Aditivo >= Dt_Inicio_Contrato_Base`
   - `Dt_Inicio_Aditivo <= Dt_Termino_Contrato_Base` (se n√£o for prorroga√ß√£o)

2. **T√©rmino Aditivo**:
   - `Dt_Termino_Aditivo <= Dt_Termino_Contrato_Base` (se n√£o for prorroga√ß√£o)
   - Se prorroga√ß√£o: `Dt_Termino_Aditivo > Dt_Termino_Contrato_Base` e atualiza `Dt_Termino_Contrato_Base`

3. **Sobreposi√ß√£o**:
   - N√£o permite 2 aditivos do mesmo tipo vigentes simultaneamente (ex: 2 reajustes IPCA ativos)

4. **Retroatividade**:
   - Aditivos N√ÉO podem ter `Dt_Inicio < Dt_Hoje` (n√£o permite retroativo sem justificativa obrigat√≥ria + aprova√ß√£o diretoria)

**Erro**: 400 Bad Request com mensagem clara (ex: "Data t√©rmino aditivo (31/12/2025) posterior a data t√©rmino contrato (30/06/2025). Use tipo 'Prorroga√ß√£o de Prazo' se deseja estender contrato.").

### RN-ADT-027-12: Isolamento Multi-Tenant Obrigat√≥rio

**Descri√ß√£o**: TODAS as queries e opera√ß√µes DEVEM filtrar por `ClienteId` obtido do JWT token.

**Seguran√ßa**: Usu√°rio de Cliente A N√ÉO pode ver/editar aditivos de Cliente B.

**Performance**: √çndice composto (ClienteId, Id_Contrato, Status) otimiza queries.

### RN-ADT-027-13: Soft Delete Obrigat√≥rio

**Descri√ß√£o**: Sistema NUNCA deve fazer DELETE f√≠sico de aditivos. Exclus√£o l√≥gica via `FlExcluido = TRUE`.

**Motivo**: Preservar auditoria completa (rastreabilidade SOX).

**Queries**: Filtro global `WHERE FlExcluido = 0` via EF Core Query Filter.

### RN-ADT-027-14: C√°lculo de Multas Rescis√≥rias

**Descri√ß√£o**: Para aditivos tipo "Supress√£o de Linhas" ou "Rescis√£o Parcial", sistema DEVE calcular automaticamente multa rescis√≥ria se dentro de prazo de fideliza√ß√£o.

**C√°lculo**:
- **Se** `Meses_Fidelizacao_Restante > 0` **E** `Tipo_Aditivo = Supressao`
- **Ent√£o** `Multa = Valor_Mensal_Linhas_Suprimidas √ó Meses_Fidelizacao_Restante √ó Percentual_Multa`
- **Onde** `Percentual_Multa` vem de cl√°usula contrato base (default 100%)

**Valida√ß√£o**: Sistema exibe alerta destacando valor multa antes de salvar aditivo.

**Negocia√ß√£o**: Usu√°rio pode sobrescrever multa com justificativa (ex: "Negociado isen√ß√£o de multa com operadora - email anexo").

### RN-ADT-027-15: Integra√ß√£o com Sistema Jur√≠dico Externo

**Descri√ß√£o**: Sistema DEVE sincronizar aditivos aprovados com sistema de gest√£o jur√≠dica (Projuris, Legal One, SAP ERP Legal) via API REST ou webhook.

**Dados Sincronizados**:
- Cabe√ßalho aditivo (n√∫mero, tipo, datas, partes)
- Documentos PDF assinados (upload Azure Blob ‚Üí URL compartilhada)
- Workflow aprova√ß√£o (hist√≥rico completo)
- Valores financeiros (impacto)

**Formato**: JSON payload com schema versionado (v1).

**Retry**: Polly policy 3 tentativas (backoff 2s, 4s, 8s).

**DLQ**: Eventos n√£o sincronizados v√£o para Dead Letter Queue (Azure Service Bus) para reprocessamento manual.

---

## üóÑÔ∏è 3. BANCO DE DADOS LEGADO

### Contexto do Sistema Legado

Sistema legado VB.NET tinha gest√£o primitiva de aditivos:
1. **Sobrescrevia Contrato Original**: Cada aditivo modificava contrato base - hist√≥rico perdido
2. **Sem Workflow**: Aprova√ß√£o via email sem rastreamento
3. **C√°lculo Manual Impacto**: Planilha Excel separada - desatualizada constantemente
4. **Documentos Perdidos**: PDFs salvos em rede compartilhada - sem versionamento

### Estrutura Legado Existente

**Contrato_Aditivo** (tabela √∫nica):
- Campos: Id_Aditivo, Id_Contrato, Tipo_Aditivo (texto livre), Descricao, Valor_Alteracao, Dt_Inicio, Dt_Fim, Fl_Ativo
- N√£o tinha: Vers√£o contrato, workflow, documentos vinculados, c√°lculo impacto autom√°tico, diff visual

**Problemas**:
- Tipo_Aditivo era texto livre ‚Üí inconsist√™ncia (ex: "acrescimo", "Acresc.", "add linhas")
- Valor_Alteracao sem contexto (mensal/anual? total/incremental?)
- Sem FK para documentos (PDFs perdidos)

### Migra√ß√£o para Sistema Moderno

Sistema moderno introduz 8 tabelas:

**Aditivo (Evolu√≠da)**:
Adicionados 50+ campos incluindo Status workflow (Enum 5 estados), Tipo estruturado (Enum 8 tipos), Impacto financeiro (Valor_Incremental_Mensal, _Anual, Projecao_12_Meses JSON), Workflow (Nivel_Aprovacao_Atual, Aprovadores_JSON, SLA_Deadline), Documentos (Azure_Blob_URLs JSON), ML (Probabilidade_Renovacao, Alertas_Enviados JSON).

**Contrato_Versao (Nova)**:
Versionamento completo de contratos (Numero_Versao sem√¢ntico, Id_Aditivo_Gerador, Snapshot_JSON, PDF_URL, Hash_SHA256, Dt_Criacao, Usuario_Id).

**Aditivo_Aprovacao (Nova)**:
Workflow multi-n√≠vel (Id_Aditivo, Nivel 1/2/3, Aprovador_Id, Status, Justificativa, DocuSign_Envelope_Id, Dt_Aprovacao).

**Aditivo_Documento (Nova)**:
Gest√£o documental (Tipo_Doc, Versao_Doc, Azure_Blob_URL, OCR_Dados_Extraidos JSON, Hash_SHA256, Dt_Upload).

**Aditivo_Impacto_Financeiro (Nova)**:
Snapshot c√°lculos (Dt_Calculo, Valor_Antes, Valor_Depois, Delta_Mensal, Delta_Anual, Projecao_JSON, Usuario_Responsavel).

**Clausula_Template (Nova)**:
Library jur√≠dica (Categoria, Nome_Template, Texto_Cl√°usula, Variaveis_JSON, Versao_Template, Aprovado_Juridico, Dt_Criacao).

**Aditivo_Alerta (Nova)**:
Log alertas vencimento (Id_Aditivo, Tipo_Alerta 90/60/30, Destinatarios, Dt_Envio, Status_Entrega).

**Aditivo_Auditoria_Log (Nova)**:
Auditoria completa de a√ß√µes (Acao, Usuario, IP, Device, Dt_Acao, Dados_Antes JSON, Dados_Depois JSON).

---

## üîå 4. WEBSERVICES LEGADO

### Contexto

Sistema legado VB.NET tinha apenas 3 m√©todos SOAP b√°sicos para aditivos:

**Endpoint**: `http://servidor/IControlIT/Contrato.asmx`

**1. CriarAditivo()**
- **Entrada**: IdContrato, TipoAditivo (texto livre), Descricao, Valor
- **Sa√≠da**: IdAditivo (INT)
- **Problema**: Sem valida√ß√µes (permitia datas inv√°lidas, tipos inconsistentes), sem workflow

**2. ListarAditivos()**
- **Entrada**: IdContrato
- **Sa√≠da**: Array de AditivoDto (sem pagina√ß√£o)
- **Problema**: Query lenta (>3s com 50 aditivos)

**3. AprovarAditivo()**
- **Entrada**: IdAditivo, IdUsuario
- **Sa√≠da**: Boolean
- **Problema**: Aprova√ß√£o direta (sem n√≠veis), sem rastreabilidade

### Evolu√ß√£o para REST API Moderna

Sistema moderno substitui SOAP por REST API (.NET 10) com 30+ endpoints:

**CRUD**:
- `POST /api/v1/aditivos` - Criar aditivo (wizard)
- `GET /api/v1/aditivos` - Listar com pagina√ß√£o
- `GET /api/v1/aditivos/{id}` - Buscar por ID
- `PUT /api/v1/aditivos/{id}` - Atualizar (apenas rascunho)
- `DELETE /api/v1/aditivos/{id}` - Soft delete

**Workflow**:
- `POST /api/v1/aditivos/{id}/enviar-aprovacao` - Inicia workflow
- `POST /api/v1/aditivos/{id}/aprovar` - Aprovar n√≠vel atual
- `POST /api/v1/aditivos/{id}/rejeitar` - Rejeitar com justificativa
- `POST /api/v1/aditivos/{id}/docusign` - Enviar para assinatura

**Impacto Financeiro**:
- `GET /api/v1/aditivos/{id}/impacto` - Calcular impacto
- `GET /api/v1/aditivos/{id}/projecao` - Gr√°fico proje√ß√£o 12 meses
- `POST /api/v1/aditivos/{id}/recalcular` - Recalcular com novos par√¢metros

**Versionamento**:
- `GET /api/v1/contratos/{id}/versoes` - Listar vers√µes contrato
- `GET /api/v1/contratos/{id}/versoes/comparar?v1=1.0&v2=1.2` - Diff visual
- `POST /api/v1/contratos/{id}/versoes/restaurar` - Restaurar vers√£o

**Documentos**:
- `POST /api/v1/aditivos/{id}/documentos` - Upload documento
- `GET /api/v1/aditivos/{id}/documentos` - Listar documentos
- `GET /api/v1/aditivos/{id}/documentos/{docId}/ocr` - Dados extra√≠dos OCR

**Templates Cl√°usulas**:
- `GET /api/v1/templates-clausulas` - Library completa
- `POST /api/v1/templates-clausulas` - Criar template customizado
- `PUT /api/v1/templates-clausulas/{id}/aprovar` - Aprova√ß√£o jur√≠dico

**Dashboard**:
- `GET /api/v1/aditivos/dashboard/pipeline` - Kanban pipeline
- `GET /api/v1/aditivos/dashboard/kpis` - M√©tricas principais
- `GET /api/v1/aditivos/dashboard/vencimentos` - Alertas pr√≥ximos 90 dias

**Tecnologias**:
- MediatR CQRS
- Hangfire (c√°lculos background)
- Azure Form Recognizer (OCR)
- DocuSign API
- ML.NET (previs√£o renova√ß√£o)

---

## üîó 5. REFER√äNCIAS AO LEGADO

### Mapeamento de Conceitos

| Conceito Legado | Conceito Moderno | Observa√ß√µes |
|----------------|------------------|-------------|
| Tipo texto livre | Enum 8 tipos | Consist√™ncia |
| Sobrescrevia contrato | Versionamento completo | Hist√≥rico preservado |
| Email aprova√ß√£o | Workflow BPM 3 n√≠veis | Rastre√°vel + SLA |
| Excel impacto | Motor c√°lculo autom√°tico | <5s vs. 6h |
| PDFs rede compartilhada | Azure Blob + versionamento | Nunca perdidos |
| Sem alertas | ML preditivo 90/60/30 dias | Proativo |
| Compara√ß√£o manual Word | Diff engine visual | Autom√°tico |

### Funcionalidades Legado ‚Üí Moderno

| ID | Funcionalidade Legado | Funcionalidade Moderna | Status |
|----|----------------------|------------------------|--------|
| WS01 | CriarAditivo (b√°sico) | POST /api/v1/aditivos (wizard) | üîÑ Evolu√≠do |
| WS02 | ListarAditivos (sem p√°gina) | GET /api/v1/aditivos?cursor=X | üîÑ Otimizado |
| WS03 | AprovarAditivo (direto) | POST /api/v1/aditivos/{id}/aprovar | üîÑ + Workflow |
| N/A | Wizard multi-step | 5 etapas com valida√ß√µes | ‚úÖ Nova |
| N/A | C√°lculo impacto autom√°tico | GET /api/v1/aditivos/{id}/impacto | ‚úÖ Nova |
| N/A | Versionamento contratos | GET /api/v1/contratos/{id}/versoes | ‚úÖ Nova |
| N/A | Diff visual | Comparar?v1=X&v2=Y | ‚úÖ Nova |
| N/A | Library cl√°usulas | GET /api/v1/templates-clausulas | ‚úÖ Nova |
| N/A | OCR documentos | Azure Form Recognizer | ‚úÖ Nova |
| N/A | Assinatura digital | DocuSign API | ‚úÖ Nova |
| N/A | Dashboard pipeline | Kanban visual | ‚úÖ Nova |
| N/A | ML previs√£o renova√ß√£o | Alertas inteligentes | ‚úÖ Nova |

### Telas Legado vs. Moderno

| Tela ASP.NET | Angular Moderno | Melhorias |
|--------------|-----------------|-----------|
| Contrato\Aditivo.aspx | /aditivos/wizard | 5 steps + valida√ß√µes contextuais |
| Contrato\ListaAditivos.aspx | /aditivos | Filtros + pipeline Kanban |
| N/A | /aditivos/{id}/impacto | Gr√°ficos waterfall + proje√ß√£o |
| N/A | /contratos/{id}/versoes | Timeline + diff visual |
| N/A | /templates-clausulas/builder | Drag-drop + preview PDF |
| N/A | /dashboard/aditivos | KPIs + pipeline tempo real |

---

## üìö REFER√äNCIAS T√âCNICAS

### Documenta√ß√£o Relacionada

- [ROADMAP-BASE.md](../../../../ROADMAP-BASE.md)
- [RF-026: Gest√£o de Faturas](../RF026-Gestao-de-Faturas/RF026.md)
- [RF-028: Gest√£o de SLA Opera√ß√µes](../RF028-Gestao-de-SLA-Operacoes/RF028.md)

### Tecnologias Utilizadas

- **.NET 10**: Framework backend
- **Entity Framework Core 10**: ORM
- **MediatR**: CQRS
- **Hangfire**: Background jobs
- **Azure Form Recognizer**: OCR
- **DocuSign API**: Assinatura digital
- **ML.NET**: Machine Learning
- **Myers' Diff Algorithm**: Compara√ß√£o vers√µes

---

**√öltima Revis√£o**: 17/12/2025
**Revisado Por**: Equipe IControlIT Architect
**Pr√≥xima Revis√£o**: 17/03/2026
