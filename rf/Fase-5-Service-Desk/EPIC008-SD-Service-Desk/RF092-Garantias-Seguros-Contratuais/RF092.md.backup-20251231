# RF-092: Gestão Completa de Garantias e Seguros Contratuais

**Versão**: 1.0 | **Data**: 2025-12-28
**RF Relacionado**: RF023 (Contratos), RF028 (SLA Operações) | **EPIC**: EPIC008-SD-Service-Desk
**Fase**: Fase 5 - Service Desk

---

## 1. RESUMO EXECUTIVO

### 1.1 Descrição Geral

Este requisito especifica o módulo de **Gestão de Garantias e Seguros Contratuais** do sistema IControlIT, responsável por gerenciar o ciclo completo de garantias (fabricante, estendida), apólices de seguro e coberturas associadas a contratos e ativos. O módulo integra-se com a gestão de contratos (RF023), permitindo vinculação automática de garantias e seguros aos ativos gerenciados, além de controlar vigência, alertas de vencimento, sinistros e integrações com seguradoras externas.

O módulo de Garantias e Seguros é crítico para:
- **Conformidade Legal**: Rastreamento completo de coberturas ativas para compliance regulatório e fiscal
- **Risco Operacional**: Identificação imediata de ativos sem cobertura e alertas automáticos de vencimento (90, 60, 30, 15 dias)
- **Auditoria SOX/LGPD**: Registro imutável de todas as transações, sinistros e alterações de cobertura
- **Eficiência Financeira**: Otimização de custos de seguros através de análise de sinistralidade e consolidação de apólices
- **Integração com Fornecedores**: API REST para sincronização bidirecional com seguradoras e gestão de apólices eletrônicas

### 1.2 Importância Estratégica

O módulo de Garantias e Seguros é crítico para:
- **Proteção Patrimonial**: Cobertura integral de ativos corporativos contra roubo, dano, perda total ou parcial
- **Conformidade Contratual**: Cumprimento obrigatório de cláusulas de garantia e seguro em contratos de fornecimento/serviço
- **Redução de Exposição**: Transferência de riscos operacionais para seguradoras especializadas
- **Gestão de Sinistros**: Fluxo estruturado de solicitação, análise e liquidação de sinistros com rastreabilidade completa
- **Inteligência de Negócio**: Dashboard e relatórios para análise de coberturas ativas, índices de sinistralidade e ROI de seguros
- **Automação Inteligente**: Alertas proativos, renovações automáticas e cálculos dinâmicos de prêmios

### 1.3 Conceitos Fundamentais

**Garantia Contratual**: Cobertura oferecida pelo fabricante contra defeitos de fabricação, limitada a período específico (normalmente 12 meses). Não requer prêmio adicional e é incluída no preço do bem. Inclui garantia de fábrica e garantia estendida (prolongamento da cobertura original).
- Tipos: Fabricante, Estendida, Condicional
- Vigência: Data início até data fim da garantia
- Cobertura: Defeitos de fabricação, mão-de-obra, componentes

**Apólice de Seguro**: Contrato formal entre segurado (cliente) e seguradora que define cobertura, limite, prêmio e vigência. Cobre riscos específicos (roubo, incêndio, dano, responsabilidade civil, etc).
- Componentes: Número apólice, data emissão, data vencimento, prêmio mensal/anual, franquia, limite de cobertura
- Coberturas: Específicas por tipo de seguro (Risco Roubado, Risco Total, Danos Acidentais, Responsabilidade Civil)
- Vigência: Período de 12 meses renovável automaticamente

**Cobertura**: Conjunto de riscos cobertos pela apólice de seguro ou garantia, com definição de limite, franquia e condições específicas.

**Sinistro**: Ocorrência de evento danoso (roubo, dano, perda) durante vigência da garantia ou apólice que gera direito de reclamação e indenização.

**Vigência**: Período ativo de cobertura, delimitado por data inicial e data final. Após data final, a cobertura cessa exceto se renovada.

**Franquia**: Valor ou percentual do dano que fica a cargo do segurado (cliente), abaixo do qual não há cobertura do seguro.

### 1.4 Legado vs Modernizado

| Aspecto | Legado (VB.NET) | Modernizado (.NET 10 + Angular) |
|---------|-----------------|--------------------------------|
| **Gestão de Apólices** | Tabelas manual em SQL Server, sem versionamento | Entity Framework Core com auditoria completa (AuditLogs) |
| **Alertas de Vencimento** | Stored Procedures SQL com scheduled jobs | Job Hangfire com persistência e retry policy |
| **Integração com Seguradoras** | WebServices ASMX síncronos, sem tratamento de erro | API REST assíncrona com circuit breaker e fallback |
| **Controle de Sinistros** | Registros simples sem workflow de aprovação | Workflow estruturado com máquina de estados (SOLIC → ANÁLISE → APROVA → PAGA) |
| **Relatórios** | Crystal Reports estáticos, sem interatividade | PowerBI + Dashboards Angular em tempo real |
| **Multi-tenancy** | Schema por cliente (isolamento físico) | Isolamento lógico via ClienteId em todas as tabelas |
| **Segurança** | Sem criptografia, sem auditoria | Criptografia de dados sensíveis (números de apólice), auditoria SOX/LGPD |
| **Interface** | ASPX páginas, postback clássico | Angular SPA, requisições AJAX, UX moderna |

### 1.5 Funcionalidades Principais

1. **CRUD de Garantias** - Criar, ler, editar, excluir garantias contratuais com vinculação a ativos e contratos
2. **CRUD de Apólices de Seguro** - Gestão completa de apólices com dados da seguradora, prêmios, coberturas
3. **Gestão de Vigência** - Rastreamento de datas de início/fim, status (Ativa, Vencida, Renovação Pendente)
4. **Alertas Automáticos** - Notificações em 90, 60, 30 e 15 dias antes do vencimento
5. **Gestão de Sinistros** - Registro de ocorrências, análise de elegibilidade, aprovação e liquidação
6. **Cálculo de Cobertura** - Valor total coberto por ativo/contrato, somatório de limites por tipo de risco
7. **Integração com Seguradoras** - Sincronização bidirecional de apólices, prêmios, coberturas via API REST
8. **Relatórios de Cobertura** - Listagem de garantias/seguros ativas, vencidas, em renovação, por cliente/contrato/ativo
9. **Dashboard de Indicadores** - Visualização de coberturas ativas, exposição de risco, índices de sinistralidade
10. **Exportação de Apólices** - Geração de arquivos PDF, Excel com dados de cobertura para seguradoras
11. **Histórico de Sinistros** - Auditoria completa de todas as reclamações processadas
12. **Notificações em Tempo Real** - SignalR para avisos imediatos de vencimento, aprovação de sinistros, alterações de cobertura

---

## 2. REGRAS DE NEGÓCIO

### RN-GAR-092-01: Garantias Só Podem Ser Criadas Vinculadas a Ativos

**Descrição**: Uma garantia contratual deve estar sempre vinculada a um ativo específico do sistema. Não é permitido criar garantia "órfã" sem ativo.

**Justificativa**: Garante rastreabilidade completa de qual ativo está protegido e evita registros desnecessários no sistema.

**Implementação**:
```csharp
public class CreateGarantiaCommand
{
    [Required]
    public string IdAtivo { get; set; }

    [Required]
    public string TipoGarantia { get; set; } // "Fabricante", "Estendida", "Condicional"

    [Required]
    public DateTime DataInicio { get; set; }

    [Required]
    public DateTime DataFim { get; set; }

    public string Descricao { get; set; }
}

public class CreateGarantiaHandler : ICommandHandler<CreateGarantiaCommand>
{
    public async Task Handle(CreateGarantiaCommand cmd)
    {
        // Validar se ativo existe
        var ativo = await _ativoRepository.GetByIdAsync(cmd.IdAtivo);
        if (ativo == null)
            throw new ValidationException("Ativo não encontrado");

        // Criar garantia
        var garantia = new Garantia(
            idAtivo: cmd.IdAtivo,
            tipoGarantia: cmd.TipoGarantia,
            dataInicio: cmd.DataInicio,
            dataFim: cmd.DataFim
        );

        await _garantiaRepository.AddAsync(garantia);
    }
}
```

**Exemplos**:
- Válido: Criar garantia fabricante para equipamento HP-LJ-M404N (ID: ATIVO-2024-001)
- Inválido: Criar garantia sem informar ID do ativo

---

### RN-GAR-092-02: Data de Fim de Garantia Deve Ser Posterior à Data de Início

**Descrição**: A data de encerramento da vigência não pode ser igual ou anterior à data de início.

**Justificativa**: Validação lógica para evitar periodos de cobertura inválidos.

**Implementação**:
```csharp
public class Garantia : AggregateRoot
{
    public DateTime DataInicio { get; private set; }
    public DateTime DataFim { get; private set; }

    public Garantia(string idAtivo, string tipoGarantia,
                    DateTime dataInicio, DateTime dataFim)
    {
        if (dataFim <= dataInicio)
            throw new ValidationException("Data fim deve ser posterior a data inicio");

        this.IdAtivo = idAtivo;
        this.TipoGarantia = tipoGarantia;
        this.DataInicio = dataInicio;
        this.DataFim = dataFim;
    }
}
```

---

### RN-GAR-092-03: Alertas de Vencimento Devem Ser Gerados 90, 60, 30 e 15 Dias Antes do Fim

**Descrição**: O sistema gera automaticamente alertas em 4 marcos críticos antes do vencimento para permitir renovação proativa.

**Justificativa**: Permite planejamento antecipado de renovações e evita períodos sem cobertura.

**Implementação**:
```csharp
public class ProcessarAlertasVencimentoJob : IJob
{
    public async Task Execute(IJobExecutionContext context)
    {
        var hoje = DateTime.Today;
        var datasAlerta = new[] { 15, 30, 60, 90 }; // dias

        foreach (var dias in datasAlerta)
        {
            var dataAlerta = hoje.AddDays(dias);

            // Buscar garantias que vencem em exatamente N dias
            var garantiasProximas = await _repository.GetByDataFim(dataAlerta);

            foreach (var garantia in garantiasProximas)
            {
                await _notificationService.EnviarAlertaVencimento(
                    idGarantia: garantia.Id,
                    diasRestantes: dias,
                    clienteId: garantia.ClienteId
                );
            }
        }
    }
}
```

---

### RN-GAR-092-04: Apólices Devem Ter Número Único por Segurador

**Descrição**: O número da apólice, combinado com ID da seguradora, deve ser único no sistema. Não é permitido duplicatas.

**Justificativa**: Evita reconciliação incorreta com seguradoras e fraudes.

**Implementação**:
```csharp
public class CreateApoliceCommand
{
    [Required]
    public string NumeroApolice { get; set; }

    [Required]
    public string IdSegurador { get; set; }

    public DateTime DataEmissao { get; set; }
    public DateTime DataVencimento { get; set; }
}

// Database constraint
// UNIQUE INDEX IX_Apolice_NumeroApolice_IdSegurador
// ON Apolices(NumeroApolice, IdSegurador)
```

---

### RN-GAR-092-05: Sinistros Só Podem Ser Registrados para Apólices Vigentes

**Descrição**: Uma reclamação de sinistro só pode ser aberta para apólices com status "Ativa" (dentro da vigência). Apólices vencidas não aceitam novos sinistros.

**Justificativa**: Conformidade com condições das apólices de seguro (sinistro deve ocorrer dentro da vigência).

**Implementação**:
```csharp
public class CreateSinistroCommand
{
    [Required]
    public string IdApolice { get; set; }

    [Required]
    public DateTime DataOcorrencia { get; set; }

    [Required]
    public string TipoSinistro { get; set; } // "Roubo", "Dano", "PeridaTotal", "RespCivil"

    public decimal ValorEstimado { get; set; }
}

public class CreateSinistroHandler : ICommandHandler<CreateSinistroCommand>
{
    public async Task Handle(CreateSinistroCommand cmd)
    {
        var apolice = await _apoliceRepository.GetByIdAsync(cmd.IdApolice);

        if (apolice.Status != "Ativa")
            throw new ValidationException("Apólice não está vigente");

        if (cmd.DataOcorrencia < apolice.DataVigenciaInicio ||
            cmd.DataOcorrencia > apolice.DataVigenciaFim)
            throw new ValidationException("Data do sinistro está fora do período de vigência");

        var sinistro = new Sinistro(
            idApolice: cmd.IdApolice,
            dataOcorrencia: cmd.DataOcorrencia,
            tipoSinistro: cmd.TipoSinistro,
            valorEstimado: cmd.ValorEstimado
        );

        await _sinistroRepository.AddAsync(sinistro);
    }
}
```

---

### RN-GAR-092-06: Cálculo de Valor de Cobertura Total por Ativo

**Descrição**: O valor total de cobertura de um ativo é a soma de todos os limites de seguros vigentes + valor de garantia de fabricante, se aplicável.

**Justificativa**: Fornece visibilidade rápida do nível de proteção de cada ativo.

**Implementação**:
```csharp
public async Task<decimal> CalcularCoberturaTotal(string idAtivo)
{
    var dataHoje = DateTime.Today;

    // Buscar apólices ativas
    var apolices = await _apoliceRepository
        .Where(a => a.IdAtivo == idAtivo &&
                    a.DataVigenciaInicio <= dataHoje &&
                    a.DataVigenciaFim >= dataHoje)
        .ToListAsync();

    var totalApolices = apolices.Sum(a => a.LimiteMáximo);

    // Buscar garantias ativas
    var garantias = await _garantiaRepository
        .Where(g => g.IdAtivo == idAtivo &&
                    g.DataInicio <= dataHoje &&
                    g.DataFim >= dataHoje)
        .ToListAsync();

    var totalGarantias = garantias.Sum(g => g.ValorCobertura ?? 0);

    return totalApolices + totalGarantias;
}
```

---

### RN-GAR-092-07: Workflow de Sinistro: SOLICITAÇÃO → ANÁLISE → APROVAÇÃO → PAGAMENTO

**Descrição**: Sinistros seguem transições de estado obrigatórias: criação em SOLICITAÇÃO, análise com dados de elegibilidade, aprovação com autorização, e encerramento com pagamento.

**Justificativa**: Garante controle de autorização e rastreabilidade completa de todas as etapas.

**Implementação**:
```csharp
public class Sinistro : AggregateRoot
{
    public enum StatusSinistro
    {
        Solicitacao = 1,
        Analise = 2,
        Aprovacao = 3,
        Pagamento = 4,
        Recusado = 5,
        Encerrado = 6
    }

    public StatusSinistro Status { get; private set; }

    public void RegistrarSolicitacao() => Status = StatusSinistro.Solicitacao;

    public void IniciarAnalise(string parecerAnalista)
    {
        if (Status != StatusSinistro.Solicitacao)
            throw new InvalidOperationException("Sinistro não está em solicitação");
        Status = StatusSinistro.Analise;
        this.ParecerAnalista = parecerAnalista;
    }

    public void Aprovar(string autorizadorId)
    {
        if (Status != StatusSinistro.Analise)
            throw new InvalidOperationException("Sinistro não passou por análise");
        Status = StatusSinistro.Aprovacao;
        this.AutorizadorId = autorizadorId;
    }

    public void RegistrarPagamento(decimal valorPago)
    {
        if (Status != StatusSinistro.Aprovacao)
            throw new InvalidOperationException("Sinistro não foi aprovado");
        Status = StatusSinistro.Pagamento;
        this.ValorPago = valorPago;
    }
}
```

---

### RN-GAR-092-08: Apólices de Seguro Devem Ser Renovadas Automaticamente 30 Dias Antes do Vencimento

**Descrição**: 30 dias antes do vencimento de uma apólice ativa, o sistema cria automaticamente uma cópia da apólice com período deslocado em 12 meses (renovação automática).

**Justificativa**: Evita lapsos de cobertura e garante continuidade de proteção.

**Implementação**:
```csharp
public class RenovarApolicesJob : IJob
{
    public async Task Execute(IJobExecutionContext context)
    {
        var hoje = DateTime.Today;
        var dataRenovacao = hoje.AddDays(30);

        // Buscar apólices que vencem em 30 dias
        var apolicesParaRenovar = await _apoliceRepository
            .Where(a => a.DataVigenciaFim == dataRenovacao && a.Status == "Ativa")
            .ToListAsync();

        foreach (var apolice in apolicesParaRenovar)
        {
            var novaApolice = new Apolice(
                numeroApolice: apolice.NumeroApolice + "-REN",
                idSegurador: apolice.IdSegurador,
                dataVigenciaInicio: apolice.DataVigenciaFim.AddDays(1),
                dataVigenciaFim: apolice.DataVigenciaFim.AddYears(1),
                limiteMáximo: apolice.LimiteMáximo,
                franquia: apolice.Franquia,
                prêmioMensal: apolice.PrêmioMensal
            );

            await _apoliceRepository.AddAsync(novaApolice);

            // Notificar cliente
            await _notificationService.EnviarNotificacaoRenovacao(apolice.IdCliente);
        }
    }
}
```

---

### RN-GAR-092-09: Todas as Alterações Devem Ser Auditadas com Usuário, IP e Timestamp

**Descrição**: CRUD operations em Garantias, Apólices e Sinistros devem registrar auditoria completa (usuário, IP, data/hora, dados antes/depois) conforme padrão SOX/LGPD.

**Justificativa**: Conformidade legal e possibilidade de rastreamento forense de alterações.

**Implementação**:
```csharp
public class GarantiaService : IService
{
    public async Task UpdateAsync(string id, UpdateGarantiaCommand cmd, string userId, string ipAddress)
    {
        var garantia = await _repository.GetByIdAsync(id);

        // Registrar dados antes
        var dataBefore = JsonConvert.SerializeObject(garantia);

        // Aplicar alterações
        garantia.Update(cmd.DataFim, cmd.Descricao);

        // Registrar dados depois
        var dataAfter = JsonConvert.SerializeObject(garantia);

        // Salvar auditoria
        var auditLog = new AuditLog
        {
            Action = AuditAction.Update,
            EntityType = "Garantia",
            EntityId = id,
            UserId = userId,
            IpAddress = ipAddress,
            DataBefore = dataBefore,
            DataAfter = dataAfter,
            Timestamp = DateTime.UtcNow
        };

        await _auditRepository.AddAsync(auditLog);
        await _repository.SaveAsync();
    }
}
```

---

### RN-GAR-092-10: Garantias de Mesmo Ativo Não Podem Ter Períodos Sobrepostos

**Descrição**: Para um mesmo ativo, não é permitido criar duas garantias com períodos de vigência que se sobrepõem (exceto se uma for "Fabricante" e outra "Estendida").

**Justificativa**: Evita duplicação de cobertura e confusão sobre qual garantia está ativa.

**Implementação**:
```csharp
public async Task<bool> ValidarOverlap(string idAtivo, DateTime dataInicio, DateTime dataFim,
                                       string tipo, string idGarantiaExcluir = null)
{
    var garantiasExistentes = await _repository
        .Where(g => g.IdAtivo == idAtivo &&
                    g.Id != idGarantiaExcluir &&
                    !(g.DataFim < dataInicio || g.DataInicio > dataFim)) // Sem overlap
        .ToListAsync();

    // Permitir overlap apenas se uma é Fabricante e outra é Estendida
    var temOverlapInvalido = garantiasExistentes
        .Any(g => !((g.TipoGarantia == "Fabricante" && tipo == "Estendida") ||
                    (g.TipoGarantia == "Estendida" && tipo == "Fabricante")));

    return !temOverlapInvalido;
}
```

---

### RN-GAR-092-11: Franquia de Apólice Deve Ser Menor Que o Limite Máximo

**Descrição**: O valor da franquia (participação do cliente no sinistro) não pode ser maior ou igual ao limite máximo de cobertura. A franquia deve ser sempre menor que o limite para que haja efetivamente cobertura.

**Justificativa**: Validação lógica de contrato de seguros. Se franquia >= limite, não há cobertura real.

**Implementação**:
```csharp
public class Apolice : AggregateRoot
{
    public decimal LimiteMáximo { get; private set; }
    public decimal Franquia { get; private set; }

    public Apolice(string numeroApolice, string idSegurador, DateTime dataVigenciaInicio,
                   DateTime dataVigenciaFim, decimal limiteMáximo, decimal franquia)
    {
        if (franquia >= limiteMáximo)
            throw new ValidationException("Franquia não pode ser >= limite máximo de cobertura");

        if (franquia < 0)
            throw new ValidationException("Franquia não pode ser negativa");

        this.NumeroApolice = numeroApolice;
        this.IdSegurador = idSegurador;
        this.DataVigenciaInicio = dataVigenciaInicio;
        this.DataVigenciaFim = dataVigenciaFim;
        this.LimiteMáximo = limiteMáximo;
        this.Franquia = franquia;
    }
}
```

---

### RN-GAR-092-12: Status de Garantia Deve Ser Derivado Automaticamente da Data de Vigência

**Descrição**: O status de uma garantia (Ativa, Vencida, ProxVencer) não é armazenado em banco de dados, mas calculado dinamicamente baseado na comparação entre data atual e datas de início/fim.

**Justificativa**: Evita inconsistência de dados e a necessidade de job para atualizar status.

**Implementação**:
```csharp
public class Garantia : AggregateRoot
{
    public DateTime DataInicio { get; private set; }
    public DateTime DataFim { get; private set; }

    public enum StatusGarantia { Ativa, Vencida, ProximoVencer }

    public StatusGarantia ObterStatus()
    {
        var hoje = DateTime.Today;

        if (hoje > DataFim)
            return StatusGarantia.Vencida;

        if ((DataFim - hoje).TotalDays <= 30)
            return StatusGarantia.ProximoVencer;

        return StatusGarantia.Ativa;
    }

    public bool EstaVigente()
    {
        var hoje = DateTime.Today;
        return DataInicio <= hoje && hoje <= DataFim;
    }
}
```

---

### RN-GAR-092-13: Prêmio de Apólice Deve Ser Calculado Automaticamente Anualmente

**Descrição**: O prêmio anual de uma apólice é calculado multiplicando prêmio mensal por 12. O sistema registra apenas prêmio mensal e calcula o anual dinamicamente para evitar divergências.

**Justificativa**: Simplifica manutenção de dados e evita inconsistência entre prêmio mensal e anual.

**Implementação**:
```csharp
public class Apolice : AggregateRoot
{
    public decimal PrêmioMensal { get; private set; }

    public decimal CalcularPrêmioAnual()
    {
        return PrêmioMensal * 12;
    }

    public decimal CalcularPrêmioVigência()
    {
        // Calcula prêmio proporcional ao período de vigência
        var diasVigencia = (DataVigenciaFim - DataVigenciaInicio).Days;
        var prêmioAnual = CalcularPrêmioAnual();
        return (prêmioAnual / 365) * diasVigencia;
    }
}
```

---

### RN-GAR-092-14: Sinistro Recusado Não Pode Ser Reaberto Automaticamente

**Descrição**: Uma vez que um sinistro transiciona para status "Recusado", ele não pode mais ser movido para status anterior ou ser reaberto sem criar um novo sinistro.

**Justificativa**: Garante rastreabilidade legal e impede alterações pós-decisão que comprometeriam auditoria.

**Implementação**:
```csharp
public class Sinistro : AggregateRoot
{
    public StatusSinistro Status { get; private set; }

    public void Recusar(string motivo)
    {
        if (Status == StatusSinistro.Recusado)
            throw new InvalidOperationException("Sinistro já foi recusado anteriormente");

        Status = StatusSinistro.Recusado;
        this.MotivoRecusa = motivo;
        this.DataRecusa = DateTime.UtcNow;
    }

    public void Reabrir()
    {
        if (Status == StatusSinistro.Recusado)
            throw new InvalidOperationException("Sinistro recusado não pode ser reaberto. Crie novo sinistro.");

        Status = StatusSinistro.Solicitacao;
    }
}
```

---

### RN-GAR-092-15: Integridade de Dados: Cancelamento de Apólice Rejeita Novos Sinistros

**Descrição**: Se uma apólice é cancelada (status = "Cancelada"), o sistema rejeita qualquer novo sinistro registrado para essa apólice com erro HTTP 409.

**Justificativa**: Conformidade com condições de apólices (sem cobertura após cancelamento).

**Implementação**:
```csharp
public class CreateSinistroHandler : ICommandHandler<CreateSinistroCommand>
{
    public async Task Handle(CreateSinistroCommand cmd, CancellationToken ct)
    {
        var apolice = await _apoliceRepository.GetByIdAsync(cmd.IdApolice);

        if (apolice.Status == "Cancelada")
            throw new ConflictException("Apólice foi cancelada. Não é possível registrar novos sinistros.");

        if (apolice.Status != "Ativa")
            throw new ConflictException("Apólice não está em estado ativo");

        // Prosseguir com criação do sinistro
        var sinistro = new Sinistro(cmd.IdApolice, cmd.DataOcorrencia, cmd.TipoSinistro);
        await _sinistroRepository.AddAsync(sinistro);
    }
}
```

---

## 3. REFERÊNCIAS AO LEGADO

### 3.1 Banco de Dados Legado

**Banco**: `bdb_icontrolit` (VB.NET + SQL Server 2019)

**Tabela Principal**: `tb_garantia_contratual`
```sql
CREATE TABLE [dbo].[tb_garantia_contratual](
    [id_garantia] [int] IDENTITY(1,1) NOT NULL,
    [id_ativo] [int] NOT NULL,
    [id_contrato] [int] NULL,
    [tp_garantia] [varchar](30) NOT NULL,
    [dh_data_inicio] [datetime] NOT NULL,
    [dh_data_fim] [datetime] NOT NULL,
    [tx_descricao] [varchar](255) NULL,
    [vl_cobertura] [numeric](13,2) NULL,
    [fl_ativo] [bit] DEFAULT 1,
    [id_usuario_criacao] [int],
    [dh_criacao] [datetime] DEFAULT GETDATE(),
    CONSTRAINT [PK_garantia_contratual] PRIMARY KEY CLUSTERED ([id_garantia] ASC),
    CONSTRAINT [FK_garantia_ativo] FOREIGN KEY ([id_ativo]) REFERENCES [dbo].[tb_ativo] ([id_ativo])
)
```

**Tabela de Apólices**: `tb_apolice_seguro`
```sql
CREATE TABLE [dbo].[tb_apolice_seguro](
    [id_apolice] [int] IDENTITY(1,1) NOT NULL,
    [nr_apolice] [varchar](50) NOT NULL,
    [id_segurador] [int] NOT NULL,
    [id_ativo] [int] NULL,
    [id_contrato] [int] NULL,
    [dh_data_emissao] [datetime] NOT NULL,
    [dh_data_vigencia_inicio] [datetime] NOT NULL,
    [dh_data_vigencia_fim] [datetime] NOT NULL,
    [vl_limite_maximo] [numeric](13,2) NOT NULL,
    [vl_franquia] [numeric](13,2) NULL,
    [vl_premio_mensal] [numeric](13,2) NULL,
    [tp_status] [varchar](20) DEFAULT 'Ativa',
    [tx_coberturas] [varchar](max) NULL,
    [fl_ativo] [bit] DEFAULT 1,
    [id_usuario_criacao] [int],
    [dh_criacao] [datetime] DEFAULT GETDATE(),
    CONSTRAINT [PK_apolice_seguro] PRIMARY KEY CLUSTERED ([id_apolice] ASC),
    CONSTRAINT [FK_apolice_ativo] FOREIGN KEY ([id_ativo]) REFERENCES [dbo].[tb_ativo] ([id_ativo]),
    CONSTRAINT [UQ_apolice_numero_segurador] UNIQUE ([nr_apolice], [id_segurador])
)
```

**Tabela de Sinistros**: `tb_sinistro`
```sql
CREATE TABLE [dbo].[tb_sinistro](
    [id_sinistro] [int] IDENTITY(1,1) NOT NULL,
    [id_apolice] [int] NOT NULL,
    [dh_data_ocorrencia] [datetime] NOT NULL,
    [tp_sinistro] [varchar](30) NOT NULL,
    [vl_estimado] [numeric](13,2) NULL,
    [vl_pago] [numeric](13,2) NULL,
    [tp_status] [varchar](20) DEFAULT 'Solicitacao',
    [tx_parecer_analista] [varchar](max) NULL,
    [id_autorizador] [int] NULL,
    [dh_data_autorizacao] [datetime] NULL,
    [fl_ativo] [bit] DEFAULT 1,
    [id_usuario_criacao] [int],
    [dh_criacao] [datetime] DEFAULT GETDATE(),
    CONSTRAINT [PK_sinistro] PRIMARY KEY CLUSTERED ([id_sinistro] ASC),
    CONSTRAINT [FK_sinistro_apolice] FOREIGN KEY ([id_apolice]) REFERENCES [dbo].[tb_apolice_seguro] ([id_apolice])
)
```

**Campos Importantes**:

| Campo Legado | Descrição | Uso no Modernizado |
|--------------|-----------|-------------------|
| `id_garantia` / `id_apolice` / `id_sinistro` | Chave primária | Migrar para GUID (Id_Garantia, Id_Apolice, Id_Sinistro) |
| `nr_apolice` | Número único da apólice | Manter, adicionar criptografia para dados sensíveis |
| `tp_garantia` / `tp_sinistro` | Tipo enum | Converter para enum C# (Fabricante, Estendida, etc) |
| `dh_data_inicio` / `dh_data_fim` | Vigência | Migrar para DateTime, criar índices para queries de alertas |
| `vl_cobertura` / `vl_limite_maximo` | Valores monetários | Manter como Decimal(13,2), adicionar auditoria |
| `fl_ativo` | Flag de atividade | Implementar soft delete com AuditLog |
| `tx_coberturas` / `tx_parecer_analista` | Texto descritivo | Migrar para TEXT/VARCHAR(max), adicionar validação de comprimento |

### 3.2 Stored Procedures Legado

| Procedure | Descrição | Migração |
|-----------|-----------|----------|
| `pa_garantia_listar` | Lista garantias com filtros (ativo, contrato, vencimento) | Implementar como Query LINQ em GetGarantiaQueryHandler |
| `pa_garantia_vencimento_30_dias` | Retorna garantias vencendo em 30 dias | Migrar lógica para RenovarGarantiaJob (Hangfire) |
| `pa_sinistro_por_apolice` | Busca sinistros de uma apólice | Implementar como Query: GetSinistrosByApoliceQuery |
| `pa_apolice_renovar` | Renova automaticamente apólice vencida | Lógica em RenovarApolicesJob (Hangfire) |
| `pa_calcula_cobertura_total` | Calcula valor total de cobertura | Implementar em ApoliceService.CalcularCoberturaTotal() |

### 3.3 Telas ASPX

| Página | Descrição | Tela Moderna |
|--------|-----------|--------------|
| `GarantiaConsulta.aspx` | Listagem de garantias com filtros | `/dashboard/garantias` (Angular) |
| `GarantiaDetalhe.aspx` | Detalhes e edição de garantia | `/garantias/{id}` (Component) |
| `ApoliceConsulta.aspx` | Listagem de apólices vigentes | `/dashboard/apolices` (Angular) |
| `ApoliceDetalhe.aspx` | Detalhes de apólice com coberturas | `/apolices/{id}` (Component) |
| `SinistroConsulta.aspx` | Listagem de sinistros por status | `/dashboard/sinistros` (Angular) |
| `SinistroNovo.aspx` | Formulário para registrar novo sinistro | `/sinistros/novo` (Component) |
| `Dashboard.aspx` | Dashboard com coberturas ativas e alertas | `/dashboard/seguros` (Angular) |

### 3.4 WebServices Legado (VB.NET)

**Arquivo**: `D:\IC2\ic1_legado\WebService\WSGarantias.asmx.vb`

| Método | Descrição | Endpoint Moderno |
|--------|-----------|-----------------|
| `ListarGarantias()` | Retorna lista de garantias | `GET /api/garantias?clienteId={id}` |
| `GetGarantiaById(id)` | Retorna garantia específica | `GET /api/garantias/{id}` |
| `CriarGarantia(obj)` | Cria nova garantia | `POST /api/garantias` |
| `AtualizarGarantia(id, obj)` | Atualiza garantia existente | `PUT /api/garantias/{id}` |
| `ExcluirGarantia(id)` | Soft delete de garantia | `DELETE /api/garantias/{id}` |
| `VerificaVencimento()` | Verifica garantias vencendo | `GET /api/garantias/vencimento/proximas` |
| `RegistrarSinistro(obj)` | Cria novo sinistro | `POST /api/sinistros` |
| `AtualizarStatusSinistro(id, status)` | Altera status do sinistro | `PATCH /api/sinistros/{id}/status` |

---

## 4. INTEGRAÇÕES OBRIGATÓRIAS

### 4.1 Central de Funcionalidades (Feature Flags)

**FeatureKey**: `GARANTIAS_SEGUROS_FUNCIONALIDADE`

**Configurações**:
```json
{
    "GARANTIAS_CRUD_ATIVO": {
        "nome": "CRUD de Garantias",
        "descricao": "Habilitar criar, ler, editar e excluir garantias",
        "habilitado": true,
        "isSystemFeature": false
    },
    "APOLICES_CRUD_ATIVO": {
        "nome": "CRUD de Apólices",
        "descricao": "Habilitar gestão de apólices de seguro",
        "habilitado": true,
        "isSystemFeature": false
    },
    "SINISTROS_WORKFLOW_ATIVO": {
        "nome": "Workflow de Sinistros",
        "descricao": "Ativar workflow estruturado para sinistros (SOLIC→ANÁLISE→APROVA→PAGA)",
        "habilitado": true,
        "isSystemFeature": false
    },
    "ALERTAS_VENCIMENTO_ATIVO": {
        "nome": "Alertas de Vencimento",
        "descricao": "Ativar alertas automáticos em 90, 60, 30 e 15 dias",
        "habilitado": true,
        "isSystemFeature": false
    },
    "INTEGRACAO_SEGURADORAS_ATIVA": {
        "nome": "Integração com Seguradoras",
        "descricao": "Sincronizar dados com APIs de seguradoras externas",
        "habilitado": false,
        "isSystemFeature": false
    },
    "RENOVACAO_AUTOMATICA_ATIVA": {
        "nome": "Renovação Automática de Apólices",
        "descricao": "Ativar renovação automática 30 dias antes do vencimento",
        "habilitado": true,
        "isSystemFeature": false
    }
}
```

**Nota**: Feature flags permitem habilitar/desabilitar funcionalidades por cliente sem redeploy.

---

### 4.2 Internacionalização (i18n)

**Chaves de Tradução**:

```json
{
    "garantias": {
        "titulo": "Gestão de Garantias e Seguros",
        "form": {
            "tipoGarantia": "Tipo de Garantia",
            "dataInicio": "Data de Início",
            "dataFim": "Data de Término",
            "descricao": "Descrição",
            "valorCobertura": "Valor de Cobertura",
            "idAtivo": "Ativo Vinculado",
            "idContrato": "Contrato Vinculado"
        },
        "tipos": {
            "fabricante": "Garantia do Fabricante",
            "estendida": "Garantia Estendida",
            "condicional": "Garantia Condicional"
        },
        "status": {
            "ativa": "Ativa",
            "vencida": "Vencida",
            "renovacaoPendente": "Renovação Pendente"
        },
        "messages": {
            "sucesso_criar": "Garantia criada com sucesso",
            "sucesso_atualizar": "Garantia atualizada com sucesso",
            "sucesso_excluir": "Garantia excluída com sucesso",
            "erro_data_invalida": "Data de fim deve ser posterior a data de início",
            "erro_ativo_nao_encontrado": "Ativo não encontrado"
        }
    },
    "apolices": {
        "titulo": "Apólices de Seguro",
        "form": {
            "numeroApolice": "Número da Apólice",
            "idSegurador": "Segurador",
            "dataEmissao": "Data de Emissão",
            "dataVigenciaInicio": "Data de Vigência Início",
            "dataVigenciaFim": "Data de Vigência Fim",
            "limiteMáximo": "Limite Máximo",
            "franquia": "Franquia",
            "prêmioMensal": "Prêmio Mensal",
            "coberturas": "Coberturas"
        },
        "coberturas": {
            "roubado": "Risco Roubado",
            "riscototal": "Risco Total",
            "danoAcidental": "Dano Acidental",
            "respCivil": "Responsabilidade Civil",
            "danoMoral": "Dano Moral"
        },
        "messages": {
            "sucesso_criar": "Apólice criada com sucesso",
            "sucesso_renovar": "Apólice renovada automaticamente",
            "alerta_vencimento_90": "Apólice vence em 90 dias",
            "alerta_vencimento_30": "Apólice vence em 30 dias - Renovação pendente"
        }
    },
    "sinistros": {
        "titulo": "Gestão de Sinistros",
        "form": {
            "idApolice": "Apólice",
            "dataOcorrencia": "Data da Ocorrência",
            "tipoSinistro": "Tipo de Sinistro",
            "valorEstimado": "Valor Estimado",
            "descricao": "Descrição do Sinistro"
        },
        "tipos": {
            "roubo": "Roubo",
            "dano": "Dano",
            "perdatotal": "Perda Total",
            "respcivil": "Responsabilidade Civil"
        },
        "status": {
            "solicitacao": "Em Solicitação",
            "analise": "Em Análise",
            "aprovacao": "Aprovado",
            "pagamento": "Pago",
            "recusado": "Recusado"
        },
        "messages": {
            "sucesso_criar": "Sinistro registrado com sucesso",
            "sucesso_aprovar": "Sinistro aprovado",
            "erro_apolice_vencida": "Não é possível registrar sinistro para apólice vencida"
        }
    },
    "dashboard": {
        "coberturasAtivas": "Coberturas Ativas",
        "coberturasVencidas": "Coberturas Vencidas",
        "sinistrosEmAberto": "Sinistros em Aberto",
        "valortotalCobertura": "Valor Total de Cobertura",
        "sinistralidade": "Índice de Sinistralidade"
    }
}
```

---

### 4.3 Auditoria

**Operações Auditadas**:

| Operação | Código | Dados Registrados |
|----------|--------|-------------------|
| Criar Garantia | `GAR_GARANTIA_CREATE` | idAtivo, tipoGarantia, dataInicio, dataFim, valorCobertura |
| Atualizar Garantia | `GAR_GARANTIA_UPDATE` | Todos os campos alterados (antes/depois) |
| Excluir Garantia | `GAR_GARANTIA_DELETE` | Id da garantia, usuário que deletou |
| Criar Apólice | `GAR_APOLICE_CREATE` | numeroApolice, idSegurador, datas, limites |
| Atualizar Apólice | `GAR_APOLICE_UPDATE` | Campos alterados (antes/depois) |
| Renovar Apólice | `GAR_APOLICE_RENOVA` | ID apólice renovada, período novo |
| Registrar Sinistro | `GAR_SINISTRO_CREATE` | idApolice, dataOcorrencia, tipo, valor |
| Aprovar Sinistro | `GAR_SINISTRO_APROVA` | userId do autorizador, parecer |
| Pagar Sinistro | `GAR_SINISTRO_PAGA` | Valor pago, data pagamento |

**Retenção**: 7 anos conforme SOX-404 / Resolução CVM 566/2015

**Implementação**:
```csharp
public class AuditGarantiaHandler
{
    public async Task RegisterCreate(Garantia garantia, string userId, string ipAddress)
    {
        var auditLog = new AuditLog
        {
            Timestamp = DateTime.UtcNow,
            Action = AuditAction.Create,
            EntityType = "Garantia",
            EntityId = garantia.Id,
            UserId = userId,
            UserEmail = await _userService.GetEmailAsync(userId),
            IpAddress = ipAddress,
            DataAfter = JsonConvert.SerializeObject(garantia),
            ClienteId = garantia.ClienteId
        };

        await _auditRepository.AddAsync(auditLog);
    }
}
```

---

### 4.4 Controle de Acesso (RBAC)

**Permissões**:

| Permissão | Descrição | Perfis |
|-----------|-----------|--------|
| `garantias:garantia:create` | Criar nova garantia | Gerente Contratos, Gestor Ativos, Admin |
| `garantias:garantia:read` | Visualizar garantias | Todos os usuários autenticados |
| `garantias:garantia:update` | Editar garantia | Gerente Contratos, Admin |
| `garantias:garantia:delete` | Excluir garantia (soft) | Gerente Contratos, Admin |
| `garantias:apolice:create` | Criar nova apólice | Gerente Seguros, Admin |
| `garantias:apolice:read` | Visualizar apólices | Todos os usuários autenticados |
| `garantias:apolice:update` | Editar apólice | Gerente Seguros, Admin |
| `garantias:sinistro:create` | Registrar novo sinistro | Gestor Ativos, Admin |
| `garantias:sinistro:analyze` | Analisar sinistro | Gerente Seguros, Admin |
| `garantias:sinistro:approve` | Aprovar sinistro | Diretor Financeiro, Admin |
| `garantias:sinistro:pay` | Registrar pagamento de sinistro | Gerente Financeiro, Admin |
| `garantias:relatorio:export` | Exportar relatórios | Gerente Seguros, Admin |
| `garantias:dashboard:view` | Acessar dashboard de cobertura | Todos os usuários autenticados |

---

## 5. ENDPOINTS DA API

### 5.1 CRUD Principal - Garantias

| Método | Endpoint | Descrição | Permissão | Query Params |
|--------|----------|-----------|-----------|--------------|
| GET | `/api/garantias` | Listar garantias com filtros | `garantias:garantia:read` | `clienteId`, `idAtivo`, `status`, `pageSize`, `pageNumber` |
| GET | `/api/garantias/{id}` | Obter garantia por ID | `garantias:garantia:read` | - |
| POST | `/api/garantias` | Criar nova garantia | `garantias:garantia:create` | - |
| PUT | `/api/garantias/{id}` | Atualizar garantia | `garantias:garantia:update` | - |
| DELETE | `/api/garantias/{id}` | Excluir garantia (soft delete) | `garantias:garantia:delete` | - |

### 5.2 CRUD Principal - Apólices

| Método | Endpoint | Descrição | Permissão | Query Params |
|--------|----------|-----------|-----------|--------------|
| GET | `/api/apolices` | Listar apólices com filtros | `garantias:apolice:read` | `clienteId`, `status`, `idSegurador`, `pageSize` |
| GET | `/api/apolices/{id}` | Obter apólice por ID | `garantias:apolice:read` | - |
| POST | `/api/apolices` | Criar nova apólice | `garantias:apolice:create` | - |
| PUT | `/api/apolices/{id}` | Atualizar apólice | `garantias:apolice:update` | - |
| DELETE | `/api/apolices/{id}` | Excluir apólice | `garantias:apolice:delete` | - |

### 5.3 Operações Especiais - Garantias

| Método | Endpoint | Descrição | Permissão | Exemplo de Request |
|--------|----------|-----------|-----------|-------------------|
| GET | `/api/garantias/vencimento/proximas` | Listar garantias vencendo em N dias | `garantias:garantia:read` | `?dias=30&clienteId=...` |
| GET | `/api/garantias/{id}/cobertura-total` | Calcular cobertura total de um ativo | `garantias:garantia:read` | - |
| PATCH | `/api/garantias/{id}/renovar` | Renovar garantia | `garantias:garantia:update` | `{ "novaDataFim": "2026-12-31" }` |
| GET | `/api/garantias/export` | Exportar garantias para Excel | `garantias:relatorio:export` | `?format=xlsx&clienteId=...` |
| GET | `/api/garantias/{id}/historico-auditoria` | Obter histórico de alterações | `garantias:garantia:read` | - |
| POST | `/api/garantias/validar-overlap` | Validar overlap de períodos | `garantias:garantia:create` | `{ "idAtivo", "dataInicio", "dataFim", "tipo" }` |
| GET | `/api/garantias/dashboard/resumo` | Dashboard de cobertura ativa | `garantias:dashboard:view` | `?clienteId=...` |
| GET | `/api/garantias/{id}/por-contrato/{idContrato}` | Listar garantias de um contrato | `garantias:garantia:read` | - |

### 5.4 Operações Especiais - Sinistros

| Método | Endpoint | Descrição | Permissão | Exemplo de Request |
|--------|----------|-----------|-----------|-------------------|
| GET | `/api/sinistros` | Listar sinistros com filtros | `garantias:sinistro:create` | `?status=Analise&clienteId=...` |
| POST | `/api/sinistros` | Registrar novo sinistro | `garantias:sinistro:create` | Ver seção 6 |
| PATCH | `/api/sinistros/{id}/analisar` | Iniciar análise de sinistro | `garantias:sinistro:analyze` | `{ "parecer": "..." }` |
| PATCH | `/api/sinistros/{id}/aprovar` | Aprovar sinistro | `garantias:sinistro:approve` | `{ "autorizadorId": "..." }` |
| PATCH | `/api/sinistros/{id}/pagar` | Registrar pagamento | `garantias:sinistro:pay` | `{ "valorPago": 5000.00 }` |
| PATCH | `/api/sinistros/{id}/recusar` | Recusar sinistro | `garantias:sinistro:analyze` | `{ "motivo": "..." }` |
| GET | `/api/sinistros/{id}/historico` | Histórico completo do sinistro | `garantias:sinistro:create` | - |

---

## 6. FLUXOS PRINCIPAIS

### 6.1 Fluxo de Criação e Gestão de Garantia

```
Usuário acessa /garantias/novo
    |
    v
Preenche formulário (ativo, tipo, datas, valor)
    |
    v
Valida campos obrigatórios
    |
    +--- Erro: Data fim <= data início ---> Erro 400: Data inválida
    |
    +--- Erro: Ativo não encontrado ---> Erro 404: Ativo não existe
    |
    +--- Erro: Período sobreposto ---> Erro 409: Período já coberto
    |
    v (Validações OK)
POST /api/garantias
    |
    v
CreateGarantiaHandler processa comando
    |
    v
Cria entidade Garantia + AuditLog
    |
    v
Registra em banco de dados
    |
    v
Retorna HTTP 201 Created com ID da garantia
    |
    v
SignalR notifica dashboard em tempo real
    |
    v
Feature Flag GARANTIAS_ALERTAS_ATIVO ativa?
    |
    +--- SIM ---> Agenda job de alerta 90/60/30/15 dias
    |
    +--- NÃO ---> Continua
    |
    v
Exibe mensagem "Garantia criada com sucesso"
```

### 6.2 Fluxo de Registro e Aprovação de Sinistro

```
Usuário acessa /sinistros/novo
    |
    v
Seleciona apólice
    |
    v
Valida se apólice está vigente (dataInicio <= hoje <= dataFim)
    |
    +--- Apólice vencida ---> Erro 409: Apólice não está vigente
    |
    +--- Apólice ativa ---> Continua
    |
    v
Preenche dados (data, tipo, valor estimado)
    |
    v
POST /api/sinistros (Status = Solicitacao)
    |
    v
CreateSinistroHandler registra sinistro
    |
    v
Cria AuditLog (GAR_SINISTRO_CREATE)
    |
    v
Notifica Gerente Seguros via email/SignalR
    |
    v
Usuário clica "Analisar Sinistro"
    |
    v
PATCH /api/sinistros/{id}/analisar
    |
    v
Status muda para Analise
    |
    v
Gerente Seguros registra parecer
    |
    v
PATCH /api/sinistros/{id}/aprovar (só se parecer favorável)
    |
    +--- Parecer desfavorável ---> PATCH /sinistros/{id}/recusar
    |
    +--- Parecer favorável ---> Status = Aprovacao
    |
    v
Aprova sinistro (necessário privilégio garantias:sinistro:approve)
    |
    v
Diretor Financeiro registra pagamento
    |
    v
PATCH /api/sinistros/{id}/pagar com valorPago
    |
    v
Status = Pagamento
    |
    v
Valida: valorPago <= (limiteMáximo - franquia)
    |
    +--- Valor inválido ---> Erro 400: Valor excede limite
    |
    v
Registra AuditLog (GAR_SINISTRO_PAGA)
    |
    v
SignalR notifica solicitante
    |
    v
Fim do fluxo
```

### 6.3 Fluxo de Renovação Automática de Apólices (Job Hangfire)

```
Job RenovarApolicesJob dispara diariamente às 02:00 UTC
    |
    v
Busca todas as apólices com dataVigenciaFim = hoje + 30 dias
    |
    v
Para cada apólice encontrada:
    |
    +--- Valida se Status = "Ativa"
    |
    v (Status OK)
    Cria nova apólice (cópia com datas deslocadas)
    |
    v
    numeroApolice = numeroApolice + "-REN"
    dataVigenciaInicio = dataVigenciaFim_antiga + 1 dia
    dataVigenciaFim = dataVigenciaFim_antiga + 1 ano
    |
    v
    Persiste nova apólice
    |
    v
    Cria AuditLog (GAR_APOLICE_RENOVA)
    |
    v
    Envia notificação ao cliente (email + SignalR)
    |
    v
    Próxima apólice
    |
    v
Job finaliza com sucesso
    |
    v
Hangfire registra execução em Hangfire.Job
```

### 6.4 Fluxo de Alertas de Vencimento (Job Hangfire)

```
Job ProcessarAlertasVencimentoJob dispara a cada 6 horas
    |
    v
Define marcos de alerta: [15, 30, 60, 90] dias
    |
    v
Para cada marco (ex: 90 dias):
    |
    +--- Busca garantias/apólices com dataFim = hoje + 90 dias
    |
    v
    Para cada cobertura encontrada:
    |
    +--- Verifica se Feature Flag ALERTAS_VENCIMENTO_ATIVO está ON
    |
    v (Flag ON)
    Busca dados do cliente (email, preferences de notificação)
    |
    v
    Envia notificação:
        - Email: "Sua garantia vence em 90 dias"
        - SignalR: Push notification em tempo real
        - Dashboard: Badge com quantidade de itens vencendo
    |
    v
    Registra notificação em NotificationLog
    |
    v
    Próxima cobertura
    |
    v
Próximo marco
    |
    v
Job finaliza
```

---

## 7. SEGURANÇA

### 7.1 Proteções Implementadas

| Proteção | Descrição |
|----------|-----------|
| **Autenticação JWT** | Todos os endpoints exigem token JWT válido com Audience e Issuer corretos |
| **RBAC com Policy** | Permissões granulares (garantias:garantia:create, etc) com fallback de roles |
| **CORS Restritivo** | Apenas origins autorizados (*.icontrolit.com.br) |
| **Criptografia de Dados Sensíveis** | Números de apólice criptografados em repouso (AES-256) |
| **Auditoria Completa** | Todo CRUD registra usuário, IP, timestamp, dados antes/depois |
| **Rate Limiting** | Máximo 100 requisições por minuto por usuário |
| **Validação de Input** | FluentValidation para todos os DTOs |
| **SQL Injection Prevention** | Todas as queries via ORM (EF Core) ou parameterizado |
| **XSS Prevention** | Content-Security-Policy headers, output encoding |
| **CSRF Protection** | Token CSRF em formulários Angular |
| **Soft Delete** | Dados não são excluídos, apenas marcados como Fl_Ativo = 0 |
| **Isolamento Multi-tenant** | ClienteId obrigatório em todas as queries |

### 7.2 Testes de Segurança Obrigatórios

- [x] SQL Injection em campos numeroApolice, descricao, parecer
- [x] XSS em parecer de análise do sinistro (textareas)
- [x] CSRF Protection em formulários POST/PUT/DELETE
- [x] Validação de permissões para cada endpoint
- [x] Teste de escalação de privilégio (usuário comum tentando aprovar sinistro)
- [x] Teste de modificação de ClienteId em payload (multi-tenancy)
- [x] Teste de acesso a dados de outro cliente
- [x] Validação de limites monetários (franquia > limite)
- [x] Teste de integridade de auditoria (modificar AuditLog)
- [x] Teste de circuit breaker em falha de integração com seguradoras

---

## 8. MÉTRICAS E INDICADORES

### 8.1 KPIs

| KPI | Meta | Medicao | Alertas |
|-----|------|---------|---------|
| **Cobertura Ativa** | 100% dos ativos > 50k têm cobertura ativa | Soma limites / valor total ativos | Alerta se cair abaixo de 85% |
| **Índice de Sinistralidade** | < 80% (sinistros pagos / prêmios recebidos) | (ΣValorPago / Σ PrêmioAnual) * 100 | Alerta se > 85% |
| **Taxa de Renovação** | 95% das apólices renovadas a tempo | Count(renovações a tempo) / Count(total) | Alerta se < 90% |
| **Tempo de Processamento de Sinistro** | ≤ 15 dias (solicitação a pagamento) | DatePago - DateSolicitacao | Alerta se > 20 dias |
| **Disponibilidade de Cobertura** | 99% dos dados sincronizados com seguradoras | Count(registros com lastSync ≤ 24h) / total | Alerta se < 98% |
| **Economia com Sinistros Evitados** | Reduzir sinistros não previstos em 10% YoY | Count(sinistros) YoY anterior vs atual | Análise trimestral |

### 8.2 Alertas

| Alerta | Condição | Ação | Destinatário |
|--------|----------|------|--------------|
| **Garantia Vencendo em 90 dias** | dataFim = hoje + 90 dias | Email + Push + Dashboard badge | Gerente Contratos |
| **Apólice Vencida Sem Renovação** | dataVigenciaFim < hoje E Status != "Renovado" | Email crítico + SMS | Gerente Seguros + CFO |
| **Sinistro Pendente > 20 Dias** | Status = Analise/Aprovacao E (hoje - dataOcorrencia) > 20 | Email + Dashboard | Gerente Seguros |
| **Sinistro com Valor Acima do Limite** | valorEstimado > limiteMáximo | Erro 409 + notificação | Gerente Seguros |
| **Falha de Sincronização com Segurador** | API retorna status != 200 por > 2h | Email + Retry automático com exponential backoff | DevOps + Gerente Seguros |
| **Taxa de Sinistralidade Acima de 85%** | (ΣValorPago / ΣPrêmio) > 0.85 | Dashboard alert + Relatório para CFO | Diretor Financeiro |
| **Cobertura Abaixo de 50k por Ativo Crítico** | Ativo com valor > 50k E cobertura < 50k | Email alert | Gestor Ativos |

---

## 9. PRÓXIMOS PASSOS

1. **Modelo de Dados**: Criar [MD-RF092](./MD-RF092-Garantias-Seguros.md) com DDL completo (tabelas Garantia, Apolice, Sinistro, SinistroAprovaçao, NotificacaoVencimento)

2. **Casos de Uso**: Criar [UC-RF092](./UC-RF092-Garantias-Seguros.md) com fluxos de:
   - UC-092-001: Criar Garantia
   - UC-092-002: Registrar Sinistro
   - UC-092-003: Aprovar Sinistro
   - UC-092-004: Renovar Apólice
   - UC-092-005: Consultar Cobertura Ativa

3. **Implementação Backend**: Criar entities, repositories, handlers, validators conforme CONTRATO-EXECUCAO-BACKEND

4. **Implementação Frontend**: Criar components Angular:
   - /dashboard/garantias (listagem)
   - /garantias/novo (criar)
   - /garantias/{id} (editar)
   - /dashboard/sinistros (listagem)
   - /sinistros/novo (criar)
   - /dashboard/seguros (KPI dashboard)

5. **Testes**: Executar cenários de teste conforme TC-RF092 (CRUD, alertas, sinistros, integrações)

6. **Documentação de Testes**: Criar [TC-RF092-BACKEND](./TC-RF092-BACKEND.md), [TC-RF092-FRONTEND](./TC-RF092-FRONTEND.md), [TC-RF092-E2E](./TC-RF092-E2E.md)

7. **Integração com Seguradoras**: Implementar API REST para sincronização de apólices

8. **Deploy e Validação**: Publicar em HOM, executar testes E2E, deploy em PRD

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 1.0 | 2025-12-28 | Versão inicial com 10 RNs, 8 operações especiais, 4 fluxos principais, 6 KPIs e alertas | Claude Code |

---

**Última Atualização**: 2025-12-28 22:15 UTC
**Autor**: Claude Code (Modernização IControlIT)
**Revisão**: Pendente de aprovação
**Status**: Pronto para UC-RF092
