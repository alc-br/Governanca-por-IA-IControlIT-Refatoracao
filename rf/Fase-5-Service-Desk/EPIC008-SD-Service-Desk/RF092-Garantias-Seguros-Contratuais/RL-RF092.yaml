# =============================================
# RL-RF092 - Referência ao Legado (Garantias e Seguros Contratuais)
# Versão: 2.0
# Data: 2025-12-31
# Autor: Claude Code
# =============================================

rf_id: RF092
titulo: "Gestão Completa de Garantias e Seguros Contratuais"

legado:
  sistema: "VB.NET + ASP.NET Web Forms + SQL Server 2019"
  versao: "IControlIT Legacy (Monolítico)"
  arquitetura: "Monolithic WebForms + Code-Behind"
  banco_dados: "SQL Server 2019 (bdb_icontrolit - Multi-Database - um banco por cliente)"
  multi_tenant: false
  auditoria: "parcial"

# =============================================================================
# SEÇÃO CRÍTICA: Referencias ao Legado com Destino Obrigatório
# =============================================================================

referencias:
  # TELAS LEGADAS
  - id: "LEG-RF092-001"
    tipo: "tela"
    nome: "GarantiaConsulta.aspx"
    caminho: "ic1_legado/IControlIT/Garantias/GarantiaConsulta.aspx"
    descricao: |
      Tela de consulta e listagem de garantias contratuais com grid, filtros e ações CRUD.
      Comportamento: Grid com status calculado em tempo real, paginação (20 registros),
      filtros por tipo/status/vigência, botões CRUD, exibir apenas fl_ativo = 1.
      Tecnologia: GridView, DropDownList, DatePicker, code-behind VB.NET.

    destino: "substituido"
    justificativa: |
      Substituído por componente Angular Standalone com MatTable responsivo,
      paginação server-side, filtros reativos, status calculado no backend,
      multi-tenancy automático e permissão SD.GARANTIAS.LISTAR.

    rf_item_relacionado: "RN-GAR-092-01"
    uc_relacionado: null
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF092-002"
    tipo: "tela"
    nome: "GarantiaDetalhe.aspx"
    caminho: "ic1_legado/IControlIT/Garantias/GarantiaDetalhe.aspx"
    descricao: |
      Tela de criação e edição de garantias com validações e vinculação a ativos.
      Modo CREATE/EDIT, ComboBox de ativos (WSAtivos.asmx), validação de datas
      (data_fim > data_inicio), máscara monetária em cobertura.
      Tecnologia: TextBox, DropDownList, DatePicker, CustomValidator VB.NET.

    destino: "substituido"
    justificativa: |
      Substituído por componente Angular reativo com FormBuilder, autocomplete de ativos
      com busca server-side, enum tipado, validações síncronas/assíncronas de datas,
      máscara monetária Intl.NumberFormat, permissões SD.GARANTIAS.CREATE/UPDATE.

    rf_item_relacionado: "RN-GAR-092-02"
    uc_relacionado: null
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF092-003"
    tipo: "tela"
    nome: "ApoliceConsulta.aspx"
    caminho: "ic1_legado/IControlIT/Garantias/ApoliceConsulta.aspx"
    descricao: |
      Tela de consulta de apólices de seguro com alertas visuais de vencimento.
      Grid com cálculo de prêmio anual (vl_premio_mensal * 12), linha amarela para
      apólices vencendo em 30 dias, filtros por seguradora/status/vigência.
      Tecnologia: GridView, DropDownList, código VB.NET inline.

    destino: "substituido"
    justificativa: |
      Substituído por componente Angular com MatTable, row styling condicional (expiring-soon class),
      pipe para cálculo de prêmio anual (premio-anual.pipe.ts), filtros com debounce (300ms),
      exportação PDF server-side com QuestPDF, permissão SD.APOLICES.LISTAR.

    rf_item_relacionado: "RN-GAR-092-13"
    uc_relacionado: null
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF092-004"
    tipo: "tela"
    nome: "SinistroNovo.aspx"
    caminho: "ic1_legado/IControlIT/Garantias/SinistroNovo.aspx"
    descricao: |
      Tela de registro de sinistros com validação de apólice ativa.
      ComboBox carrega apenas apólices ATIVAS (vigência válida), validação data_ocorrencia <= hoje,
      descrição obrigatória (min 50 chars), status inicial fixo em 'SOLICITAÇÃO'.
      Tecnologia: DropDownList, DatePicker, TextArea, CustomValidator VB.NET.

    destino: "substituido"
    justificativa: |
      Substituído por componente Angular com autocomplete de apólices ativas (API filtrado),
      validação de data máxima = hoje (Validators.max), validação Validators.minLength(50),
      status inicial fixo enum backend, máscara monetária BRL, permissão SD.SINISTROS.CREATE.

    rf_item_relacionado: "RN-GAR-092-05"
    uc_relacionado: null
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  # WEBSERVICES LEGADOS
  - id: "LEG-RF092-WS-001"
    tipo: "webservice"
    nome: "WSGarantias.asmx::ListarGarantias"
    caminho: "ic1_legado/IControlIT/WebServices/WSGarantias.asmx"
    descricao: |
      Método ASMX que retorna DataSet de garantias com filtros opcionais.
      JOIN com tb_ativo, filtro fl_ativo = 1 hardcoded, status calculado em SQL (CASE WHEN),
      ORDER BY data_fim DESC, sem paginação (retorna tudo).
      Assinatura: Function ListarGarantias(id_ativo, tp_garantia, status) As DataSet.

    destino: "substituido"
    justificativa: |
      Substituído por endpoint REST GET /api/garantias com paginação obrigatória (PagedRequest),
      filtros tipados (GarantiaFilters class), status calculado via propriedade computada C#,
      multi-tenancy automático (ClienteId no WHERE), permissão SD.GARANTIAS.LISTAR.

    rf_item_relacionado: "RN-GAR-092-12"
    uc_relacionado: null
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF092-WS-002"
    tipo: "webservice"
    nome: "WSGarantias.asmx::CriarGarantia"
    caminho: "ic1_legado/IControlIT/WebServices/WSGarantias.asmx"
    descricao: |
      Método ASMX que cria garantia com validação limitada.
      Valida apenas campos obrigatórios (id_ativo, datas, tipo), NÃO valida sobreposição
      de períodos, NÃO valida existência do ativo, auditoria parcial (id_usuario_criacao + dh_criacao apenas).
      Retorna id_garantia gerado.

    destino: "substituido"
    justificativa: |
      Substituído por Command CQRS POST /api/garantias com validação completa via FluentValidation,
      RN-GAR-092-10 valida sobreposição de períodos, RN-GAR-092-01 valida existência do ativo,
      RN-GAR-092-02 valida data_fim > data_inicio, auditoria completa (User, IP, Timestamp),
      multi-tenancy automático, permissão SD.GARANTIAS.CREATE.

    rf_item_relacionado: "RN-GAR-092-01, RN-GAR-092-02, RN-GAR-092-10"
    uc_relacionado: null
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF092-WS-003"
    tipo: "webservice"
    nome: "WSGarantias.asmx::VerificaVencimento"
    caminho: "ic1_legado/IControlIT/WebServices/WSGarantias.asmx"
    descricao: |
      Método ASMX executado MANUALMENTE para verificar garantias vencendo e enviar emails.
      Consulta garantias com data_fim BETWEEN GETDATE() AND GETDATE()+30, envia email hardcoded
      para 'admin@empresa.com', formato HTML manual, executado via botão na interface.
      Retorna quantidade de emails enviados.

    destino: "substituido"
    justificativa: |
      Substituído por job Hangfire automático GarantiaExpirationJob.cs (Cron diário às 8h),
      RN-GAR-092-03 alertas em 90, 60, 30, 15 dias, emails via NotificationService (template Razor),
      destinatários configuráveis (grupo de usuários), log de execução em AuditLog.

    rf_item_relacionado: "RN-GAR-092-03"
    uc_relacionado: null
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF092-WS-004"
    tipo: "webservice"
    nome: "WSGarantias.asmx::AtualizarStatusSinistro"
    caminho: "ic1_legado/IControlIT/WebServices/WSGarantias.asmx"
    descricao: |
      Método ASMX que atualiza status de sinistro SEM WORKFLOW formal.
      Permite QUALQUER transição de status (sem validação), permite reabrir sinistro recusado
      (RECUSADO → SOLICITAÇÃO), NÃO registra histórico de mudanças de status.
      Retorna True se atualizou.

    destino: "substituido"
    justificativa: |
      Substituído por State Machine PUT /api/sinistros/{id}/status com RN-GAR-092-07 workflow formal,
      RN-GAR-092-14 sinistro RECUSADO não pode ser reaberto automaticamente,
      histórico completo em tabela SinistroStatusHistorico, validação de permissões por transição
      (ex: APROVADO requer role Gestor), permissão base SD.SINISTROS.UPDATE_STATUS.

    rf_item_relacionado: "RN-GAR-092-07, RN-GAR-092-14"
    uc_relacionado: null
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  # STORED PROCEDURES LEGADAS
  - id: "LEG-RF092-SP-001"
    tipo: "stored_procedure"
    nome: "pa_garantia_listar"
    caminho: "bdb_icontrolit.dbo.pa_garantia_listar"
    descricao: |
      Procedure SQL que lista garantias com status calculado em CASE WHEN.
      SELECT g.*, CASE WHEN data_fim < GETDATE() THEN 'Vencida' WHEN ... END AS status,
      FROM tb_garantia_contratual g INNER JOIN tb_ativo a, WHERE fl_ativo = 1,
      ORDER BY data_fim DESC.

    destino: "substituido"
    justificativa: |
      Substituído por query LINQ GetGarantiasQuery.cs com status calculado em propriedade
      computada C# (GarantiaDto.Status), paginação Skip/Take, multi-tenancy automático (ClienteId),
      eager loading de navegações (Include), sem lógica SQL inline.

    rf_item_relacionado: "RN-GAR-092-12"
    uc_relacionado: null
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF092-SP-002"
    tipo: "stored_procedure"
    nome: "pa_garantia_vencimento_30_dias"
    caminho: "bdb_icontrolit.dbo.pa_garantia_vencimento_30_dias"
    descricao: |
      Procedure SQL para alertas de vencimento (apenas 30 dias).
      SELECT garantias WHERE data_fim BETWEEN GETDATE() AND DATEADD(day, 30, GETDATE()),
      ORDER BY data_fim ASC. Usado em processo manual de envio de emails.

    destino: "substituido"
    justificativa: |
      Substituído por query LINQ GetExpiringGarantiasQuery.cs + Hangfire job
      GarantiaExpirationJob.cs (executado diariamente às 8h), RN-GAR-092-03 alertas
      em 90, 60, 30, 15 dias (não apenas 30), índice em data_fim, multi-tenancy
      (processa por cliente separadamente).

    rf_item_relacionado: "RN-GAR-092-03"
    uc_relacionado: null
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF092-SP-003"
    tipo: "stored_procedure"
    nome: "pa_apolice_renovar"
    caminho: "bdb_icontrolit.dbo.pa_apolice_renovar"
    descricao: |
      Procedure SQL que copia apólice para renovação MANUAL.
      INSERT INTO tb_apolice_seguro SELECT (campos) FROM tb_apolice_seguro WHERE id_apolice = @id_apolice_original,
      com @novo_numero_apolice, @nova_data_inicio, @nova_data_fim como parâmetros.
      Executado manualmente via botão na interface.

    destino: "substituido"
    justificativa: |
      Substituído por renovação AUTOMÁTICA RN-GAR-092-08 job Hangfire ApoliceRenewalJob.cs
      (executa diariamente 30 dias antes do vencimento), cria nova apólice com data_inicio = data_fim_anterior + 1 dia,
      incrementa número de apólice (-R1, -R2), notifica responsável via email,
      renovação manual também disponível via Command.

    rf_item_relacionado: "RN-GAR-092-08"
    uc_relacionado: null
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  # TABELAS LEGADAS
  - id: "LEG-RF092-DB-001"
    tipo: "componente"
    nome: "tb_garantia_contratual"
    caminho: "bdb_icontrolit.dbo.tb_garantia_contratual"
    descricao: |
      Tabela legada de garantias contratuais.
      Problemas: Sem multi-tenancy (ausência de ClienteId/EmpresaId), auditoria incompleta
      (sem LastModified, LastModifiedBy, IP), PK INT (não GUID), tp_garantia VARCHAR (não ENUM),
      sem índice em data_fim, sem constraint data_fim > data_inicio, soft delete via fl_ativo.

    destino: "substituido"
    justificativa: |
      Substituído por entidade moderna GarantiaContratual.cs com PK Guid, multi-tenancy ClienteId,
      auditoria completa (Created, LastModified, UserIP), soft delete (IsDeleted, DeletedAt, DeletedBy),
      enum tipado TipoGarantia, índices (data_fim, ClienteId + id_ativo),
      check constraint data_fim > data_inicio, navigation properties (Ativo, Contrato).

    rf_item_relacionado: "RN-GAR-092-01, RN-GAR-092-02, RN-GAR-092-09"
    uc_relacionado: null
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF092-DB-002"
    tipo: "componente"
    nome: "tb_apolice_seguro"
    caminho: "bdb_icontrolit.dbo.tb_apolice_seguro"
    descricao: |
      Tabela legada de apólices de seguro.
      Problemas: Sem multi-tenancy (ClienteId), auditoria incompleta, PK INT,
      campo 'coberturas' como TEXT não estruturado, 'seguradora' como VARCHAR
      (deveria ser FK para tb_fornecedor), sem validação franquia < limite_cobertura,
      unique constraint apenas em numero_apolice (deveria ser por seguradora).

    destino: "substituido"
    justificativa: |
      Substituído por entidade ApoliceSeguro.cs com PK Guid, multi-tenancy ClienteId,
      auditoria completa, campo Coberturas estruturado como JSON (PostgreSQL jsonb),
      FK SeguradoraId → Fornecedores, check constraint vl_franquia < vl_limite_cobertura (RN-GAR-092-11),
      unique constraint (NumeroApolice, SeguradoraId) - RN-GAR-092-04, índices (data_fim, SeguradoraId).

    rf_item_relacionado: "RN-GAR-092-04, RN-GAR-092-11"
    uc_relacionado: null
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF092-DB-003"
    tipo: "componente"
    nome: "tb_sinistro"
    caminho: "bdb_icontrolit.dbo.tb_sinistro"
    descricao: |
      Tabela legada de sinistros.
      Problemas: Sem multi-tenancy (ClienteId), auditoria incompleta (sem histórico de mudanças de status),
      PK INT, campo 'status' VARCHAR (não ENUM + tabela de histórico), sem workflow formal
      (permite transições inválidas), campo 'descricao' TEXT (sem validação tamanho mínimo),
      sem rastreabilidade de quem aprovou/recusou.

    destino: "substituido"
    justificativa: |
      Substituído por entidade Sinistro.cs + SinistroStatusHistorico.cs com PK Guid,
      multi-tenancy ClienteId, auditoria completa, enum StatusSinistro, tabela separada
      SinistroStatusHistorico (workflow audit trail), validação Descricao.MinLength(50),
      RN-GAR-092-07 workflow com state machine, RN-GAR-092-14 recusado não reabre,
      RN-GAR-092-15 sinistro só criado se apólice ativa.

    rf_item_relacionado: "RN-GAR-092-07, RN-GAR-092-14, RN-GAR-092-15"
    uc_relacionado: null
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  # REGRAS DE NEGÓCIO IMPLÍCITAS
  - id: "LEG-RF092-RN-001"
    tipo: "regra_negocio"
    nome: "Garantias ativas apenas se fl_ativo = 1"
    caminho: "Implícito em todas as queries SQL"
    descricao: |
      Todas as consultas de garantias filtram por fl_ativo = 1 (soft delete implícito).
      WHERE fl_ativo = 1 em 100% das queries.

    destino: "assumido"
    justificativa: |
      Assumido com melhoria: IsDeleted = false (padrão EF Core), global query filter
      configurado no DbContext, auditoria de exclusão (DeletedAt, DeletedBy).

    rf_item_relacionado: "RN-GAR-092-09"
    uc_relacionado: null
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF092-RN-002"
    tipo: "regra_negocio"
    nome: "Status de garantia calculado dinamicamente"
    caminho: "Implícito em pa_garantia_listar + telas ASPX"
    descricao: |
      Status (Ativa/Vencida/Vencendo) calculado em runtime via CASE WHEN no SQL ou code-behind.
      CASE WHEN data_fim < GETDATE() THEN 'Vencida' WHEN data_fim BETWEEN ... THEN 'Vencendo' ELSE 'Ativa' END.

    destino: "assumido"
    justificativa: |
      Assumido com melhoria: propriedade computada C# (não SQL), enum StatusGarantia,
      lógica centralizada em GarantiaDto.Status getter, RN-GAR-092-12.

    rf_item_relacionado: "RN-GAR-092-12"
    uc_relacionado: null
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF092-RN-003"
    tipo: "regra_negocio"
    nome: "Renovação manual de apólices"
    caminho: "pa_apolice_renovar + botão em ApoliceConsulta.aspx"
    descricao: |
      Renovação de apólices era MANUAL, executada pelo usuário via botão.
      Usuário clica 'Renovar', preenche nova vigência, sistema copia dados da apólice antiga.

    destino: "substituido"
    justificativa: |
      Substituído por renovação AUTOMÁTICA RN-GAR-092-08 job Hangfire executa 30 dias
      antes do vencimento, notificação enviada ao responsável, renovação manual
      ainda disponível (comando separado).

    rf_item_relacionado: "RN-GAR-092-08"
    uc_relacionado: null
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF092-RN-004"
    tipo: "regra_negocio"
    nome: "Sinistro recusado pode ser reaberto"
    caminho: "WSGarantias.asmx::AtualizarStatusSinistro"
    descricao: |
      Legado permitia transição RECUSADO → SOLICITAÇÃO (reabertura livre).
      Qualquer status pode ir para qualquer status (sem workflow formal).

    destino: "substituido"
    justificativa: |
      Substituído por workflow restritivo: RN-GAR-092-14 RECUSADO não pode voltar para
      SOLICITACAO automaticamente, reabertura exige novo sinistro, state machine
      valida transições permitidas.

    rf_item_relacionado: "RN-GAR-092-14"
    uc_relacionado: null
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF092-RN-005"
    tipo: "regra_negocio"
    nome: "Prêmio anual calculado no frontend"
    caminho: "ApoliceConsulta.aspx (JavaScript) + ApoliceDetalhe.aspx (code-behind)"
    descricao: |
      Cálculo de prêmio anual (mensal * 12) feito no frontend ou code-behind, não armazenado.
      vl_premio_anual = vl_premio_mensal * 12 (calculado on-the-fly).

    destino: "assumido"
    justificativa: |
      Assumido com melhoria: propriedade computada no DTO, cálculo no backend (não frontend),
      RN-GAR-092-13 vl_premio_anual = vl_premio_mensal * 12.

    rf_item_relacionado: "RN-GAR-092-13"
    uc_relacionado: null
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF092-RN-006"
    tipo: "regra_negocio"
    nome: "Coberturas como texto livre"
    caminho: "tb_apolice_seguro.coberturas (campo TEXT)"
    descricao: |
      Coberturas da apólice armazenadas como texto livre, sem estruturação.
      Campo TEXT com descrições separadas por vírgula ou linha.

    destino: "substituido"
    justificativa: |
      Substituído por campo estruturado PostgreSQL jsonb (array de objetos),
      cada cobertura: { tipo, descricao, limite }, validação de schema no backend.

    rf_item_relacionado: null
    uc_relacionado: null
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: 2

# =============================================================================
# METADADOS DE MIGRAÇÃO
# =============================================================================

metadados:
  total_itens: 24
  itens_assumidos: 5
  itens_substituidos: 19
  itens_descartados: 0
  itens_a_revisar: 0

  decisoes_migracao:
    - codigo: "DM-001"
      decisao: "Automatizar renovação de apólices"
      justificativa: "Processo manual propenso a esquecimento, vencimentos sem cobertura"
      impacto: "Job Hangfire + notificações + RN-GAR-092-08"

    - codigo: "DM-002"
      decisao: "Workflow formal para sinistros"
      justificativa: "Legado permitia transições inválidas (RECUSADO → SOLICITAÇÃO)"
      impacto: "State machine + RN-GAR-092-07 + RN-GAR-092-14 + tabela de histórico"

    - codigo: "DM-003"
      decisao: "Estruturar coberturas como JSON"
      justificativa: "Texto livre impede validações e relatórios estruturados"
      impacto: "Campo jsonb + validação de schema + queries estruturadas"

  riscos_migracao:
    - codigo: "RM-001"
      risco: "Perda de histórico de transições de status de sinistros"
      mitigacao: "Script de migração extrai histórico implícito do AuditLog legado"

    - codigo: "RM-002"
      risco: "Quebra de integrações externas que dependem de WebServices ASMX"
      mitigacao: "Manter WSGarantias.asmx como façade para API REST durante 6 meses"

    - codigo: "RM-003"
      risco: "Coberturas em texto livre não migrarem corretamente para JSON"
      mitigacao: "Parser inteligente + validação manual de coberturas críticas"
