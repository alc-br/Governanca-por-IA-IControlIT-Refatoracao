# RF092.yaml — Gestão Completa de Garantias e Seguros Contratuais
# Versão: 2.0
# Data: 2025-12-31
# Sistema: IControlIT v2 (.NET 10 + Angular 19 + PostgreSQL)

metadados:
  rf_codigo: RF092
  rf_titulo: "Gestão Completa de Garantias e Seguros Contratuais"
  fase: "Fase-5-Service-Desk"
  epic: "EPIC008-SD-Service-Desk"
  versao: "2.0"
  data_criacao: "2025-12-31"
  status: "EM_DOCUMENTACAO"

  escopo:
    modulos:
      - "Service Desk"
      - "Gestão de Ativos"
      - "Gestão de Contratos"

    funcionalidades_principais:
      - "Gestão de garantias contratuais vinculadas a ativos"
      - "Gestão de apólices de seguro com múltiplas coberturas"
      - "Workflow de sinistros (solicitação → análise → aprovação → pagamento)"
      - "Alertas automáticos de vencimento (90, 60, 30, 15 dias)"
      - "Renovação automática de apólices (30 dias antes)"
      - "Dashboard com KPIs e métricas em tempo real"

    tecnologias:
      backend: ".NET 10 + Clean Architecture + CQRS + MediatR + EF Core"
      frontend: "Angular 19 + Standalone Components + Material Design"
      banco_dados: "PostgreSQL 16"
      jobs: "Hangfire (alertas + renovações automáticas)"
      compliance: "LGPD + SOX + Auditoria completa"

# =============================================================================
# REGRAS DE NEGÓCIO (15 regras obrigatórias)
# =============================================================================

regras_negocio:
  - codigo: RN-GAR-092-01
    titulo: "Garantia deve estar vinculada a um ativo válido"
    categoria: "Validação"
    prioridade: "CRÍTICA"

    descricao_natural: |
      Toda garantia contratual DEVE estar obrigatoriamente vinculada a um ativo existente
      no sistema. Não é permitido criar garantia órfã ou com ativo inexistente.

    criterios_aceitacao:
      - "AtivoId deve referenciar um ativo válido na tabela Ativos"
      - "Validação deve ocorrer antes da criação da garantia"
      - "Erro HTTP 400 se ativo não existir"
      - "Mensagem de erro clara: 'O ativo informado não existe ou foi excluído'"

    validacao:
      local: "CreateGarantiaCommandValidator.cs + UpdateGarantiaCommandValidator.cs"
      tipo: "FluentValidation + FK no banco"
      error_code: "GARANTIA_ATIVO_INVALIDO"

    exemplos:
      valido:
        - "AtivoId = Guid existente na tabela Ativos"
        - "Navigation property Ativo carregada corretamente"

      invalido:
        - "AtivoId = Guid.Empty"
        - "AtivoId = Guid inexistente"
        - "AtivoId = null"

  - codigo: RN-GAR-092-02
    titulo: "Data de término deve ser posterior à data de início"
    categoria: "Validação"
    prioridade: "CRÍTICA"

    descricao_natural: |
      A data de término da garantia DEVE ser obrigatoriamente posterior à data de início.
      Garantias com datas invertidas ou iguais são inválidas.

    criterios_aceitacao:
      - "DataFim > DataInicio (estritamente maior, não permite igualdade)"
      - "Validação no backend via FluentValidation"
      - "Validação no frontend via Validators.custom"
      - "Check constraint no banco de dados"
      - "Erro HTTP 400 se validação falhar"

    validacao:
      local: "CreateGarantiaCommandValidator.cs + Database CHECK constraint"
      tipo: "FluentValidation + DB Constraint"
      error_code: "GARANTIA_DATAS_INVALIDAS"

    exemplos:
      valido:
        - "DataInicio = 2025-01-01, DataFim = 2025-12-31"
        - "DataInicio = hoje, DataFim = hoje + 365 dias"

      invalido:
        - "DataInicio = 2025-12-31, DataFim = 2025-01-01"
        - "DataInicio = DataFim (mesma data)"

  - codigo: RN-GAR-092-03
    titulo: "Alertas automáticos de vencimento em 90, 60, 30 e 15 dias"
    categoria: "Automação"
    prioridade: "ALTA"

    descricao_natural: |
      O sistema DEVE enviar automaticamente alertas de vencimento de garantias e apólices
      em 4 marcos temporais: 90 dias, 60 dias, 30 dias e 15 dias antes da data de término.
      Alertas são enviados por email e registrados no sistema de notificações.

    criterios_aceitacao:
      - "Job Hangfire executado diariamente às 8h da manhã"
      - "Query identifica garantias/apólices nos marcos temporais"
      - "Email enviado para responsáveis configurados"
      - "Notificação registrada em AuditLog"
      - "Evitar duplicação: apenas 1 alerta por marco temporal"

    implementacao:
      job: "GarantiaExpirationJob.cs + ApoliceExpirationJob.cs"
      cron: "0 8 * * * (diário às 8h)"
      query: "GetExpiringGarantiasQuery.cs + GetExpiringApolicesQuery.cs"
      notification: "NotificationService.SendExpirationAlert()"

    destinatarios:
      - "Responsável pelo ativo (se definido)"
      - "Gestor do centro de custo"
      - "Grupo de Service Desk (configurável)"

    exemplos:
      - "Garantia vence em 2025-04-01. Hoje é 2025-01-02 (90 dias) → Alerta enviado"
      - "Apólice vence em 2025-05-15. Hoje é 2025-04-15 (30 dias) → Alerta enviado"

  - codigo: RN-GAR-092-04
    titulo: "Número de apólice único por seguradora"
    categoria: "Validação"
    prioridade: "CRÍTICA"

    descricao_natural: |
      Cada apólice DEVE ter um número único dentro do contexto de uma mesma seguradora.
      Não é permitido cadastrar duas apólices com o mesmo número para a mesma seguradora,
      mas é permitido o mesmo número para seguradoras diferentes.

    criterios_aceitacao:
      - "Unique constraint no banco: (NumeroApolice, SeguradoraId)"
      - "Validação assíncrona no frontend (AsyncValidator)"
      - "Validação no backend via FluentValidation + query"
      - "Erro HTTP 409 (Conflict) se duplicado"

    validacao:
      local: "CreateApoliceCommandValidator.cs + Database UNIQUE constraint"
      tipo: "FluentValidation + AsyncValidator + DB Constraint"
      error_code: "APOLICE_NUMERO_DUPLICADO"

    exemplos:
      valido:
        - "Seguradora A - Número 12345"
        - "Seguradora B - Número 12345 (seguradora diferente)"

      invalido:
        - "Seguradora A - Número 12345 (já existe)"

  - codigo: RN-GAR-092-05
    titulo: "Sinistros apenas para apólices ativas"
    categoria: "Validação"
    prioridade: "CRÍTICA"

    descricao_natural: |
      Um sinistro SOMENTE pode ser registrado contra uma apólice que esteja ATIVA no
      momento do registro. Apólices vencidas, canceladas ou inativas NÃO podem receber
      novos sinistros.

    criterios_aceitacao:
      - "Validar se DataInicio <= DataSinistro <= DataFim"
      - "Validar se IsDeleted = false"
      - "Validar se StatusApolice != Cancelada"
      - "Erro HTTP 400 se apólice inativa"

    validacao:
      local: "CreateSinistroCommandValidator.cs"
      tipo: "FluentValidation com query de verificação"
      error_code: "SINISTRO_APOLICE_INATIVA"

    exemplos:
      valido:
        - "Apólice vigente de 2025-01-01 a 2025-12-31, sinistro em 2025-06-15"

      invalido:
        - "Apólice vencida (DataFim < hoje)"
        - "Apólice cancelada (StatusApolice = Cancelada)"
        - "Apólice excluída (IsDeleted = true)"

  - codigo: RN-GAR-092-06
    titulo: "Cálculo de cobertura total por ativo"
    categoria: "Cálculo"
    prioridade: "MÉDIA"

    descricao_natural: |
      O sistema DEVE calcular e exibir a cobertura total de um ativo somando o valor de
      todas as garantias ATIVAS e VIGENTES vinculadas a ele. Garantias vencidas ou inativas
      não entram no cálculo.

    criterios_aceitacao:
      - "SUM de ValorCobertura de garantias com IsDeleted = false AND DataFim >= hoje"
      - "Exibido na tela de detalhes do ativo"
      - "Atualizado automaticamente ao criar/editar/excluir garantia"
      - "Cache de 5 minutos para otimizar performance"

    implementacao:
      query: "GetCoberturaTotalByAtivoQuery.cs"
      cache: "MemoryCache com sliding expiration de 5 minutos"
      exibicao: "ativo-detail.component.ts (card de garantias)"

    formula: "CoberturaTotal = SUM(ValorCobertura) WHERE AtivoId = X AND IsDeleted = false AND DataFim >= hoje"

    exemplos:
      - "Ativo com 3 garantias ativas: R$ 10.000 + R$ 5.000 + R$ 3.000 = R$ 18.000"
      - "Ativo sem garantias ativas: R$ 0"

  - codigo: RN-GAR-092-07
    titulo: "Workflow formal de estados de sinistro"
    categoria: "Workflow"
    prioridade: "CRÍTICA"

    descricao_natural: |
      Sinistros DEVEM seguir um workflow formal com estados e transições definidas.
      Transições inválidas são bloqueadas pelo sistema. Cada transição é auditada
      com usuário, timestamp e justificativa.

    estados_validos:
      - SOLICITACAO: "Estado inicial ao criar sinistro"
      - ANALISE: "Sinistro em análise pela seguradora"
      - APROVADO: "Sinistro aprovado para pagamento"
      - RECUSADO: "Sinistro recusado pela seguradora"
      - PAGO: "Sinistro pago ao solicitante"

    transicoes_permitidas:
      SOLICITACAO:
        - ANALISE: "Iniciar análise"
        - RECUSADO: "Recusar diretamente (casos óbvios)"

      ANALISE:
        - APROVADO: "Aprovar sinistro"
        - RECUSADO: "Recusar após análise"
        - SOLICITACAO: "Devolver para complementação"

      APROVADO:
        - PAGO: "Registrar pagamento"

      RECUSADO:
        - null: "Estado final - não pode transitar"

      PAGO:
        - null: "Estado final - não pode transitar"

    implementacao:
      state_machine: "SinistroStateMachine.cs"
      command: "UpdateSinistroStatusCommand.cs"
      historico: "SinistroStatusHistorico entity (audit trail)"
      validacao: "Valida transição antes de executar"

    auditoria_obrigatoria:
      - "StatusAnterior"
      - "StatusNovo"
      - "UsuarioId"
      - "DataTransicao"
      - "Justificativa (obrigatória em RECUSADO)"
      - "IP do usuário"

  - codigo: RN-GAR-092-08
    titulo: "Renovação automática de apólices 30 dias antes do vencimento"
    categoria: "Automação"
    prioridade: "ALTA"

    descricao_natural: |
      O sistema DEVE renovar automaticamente apólices de seguro 30 dias antes da data de
      vencimento, criando uma nova apólice com vigência subsequente e notificando o
      responsável. Renovação manual também é permitida via comando específico.

    criterios_aceitacao:
      - "Job Hangfire executado diariamente às 6h da manhã"
      - "Identifica apólices com DataFim = hoje + 30 dias"
      - "Cria nova apólice com DataInicio = DataFim_anterior + 1 dia"
      - "Copia todos os dados da apólice original (seguradora, valores, coberturas)"
      - "Incrementa número da apólice (ex: 12345 → 12345-R1)"
      - "Envia email de notificação ao responsável"
      - "Registra em AuditLog"

    implementacao:
      job: "ApoliceRenewalJob.cs"
      cron: "0 6 * * * (diário às 6h)"
      command: "RenewApoliceCommand.cs"
      notification: "NotificationService.SendRenewalNotification()"

    regras_copia:
      copiado:
        - "SeguradoraId"
        - "ValorPremioMensal"
        - "ValorLimiteCobertura"
        - "ValorFranquia"
        - "Coberturas (JSON)"

      novo:
        - "NumeroApolice (incrementado com sufixo -R1, -R2, etc.)"
        - "DataInicio (DataFim_anterior + 1 dia)"
        - "DataFim (DataInicio + 365 dias, configurável)"
        - "Created, CreatedBy (audit trail)"

    manual_override: "Permitido via botão 'Renovar Manualmente' com aprovação"

  - codigo: RN-GAR-092-09
    titulo: "Auditoria completa de todas as operações"
    categoria: "Auditoria"
    prioridade: "CRÍTICA"

    descricao_natural: |
      TODAS as operações de criação, edição e exclusão DEVEM ser auditadas automaticamente
      com usuário, IP, timestamp e dados antes/depois. Auditoria é obrigatória por compliance
      LGPD e SOX.

    criterios_aceitacao:
      - "AuditInterceptor do EF Core captura todas as mudanças"
      - "Campos obrigatórios: Created, CreatedBy, LastModified, LastModifiedBy, UserIP"
      - "Soft delete: IsDeleted, DeletedAt, DeletedBy"
      - "Registro em AuditLog com JSON before/after"
      - "Retenção de 7 anos (compliance SOX)"

    implementacao:
      interceptor: "AuditInterceptor.cs (EF Core)"
      tabela: "AuditLogs"
      campos_auditoria:
        - "Created: DateTime (NOT NULL)"
        - "CreatedBy: Guid (FK → Users)"
        - "LastModified: DateTime?"
        - "LastModifiedBy: Guid?"
        - "UserIP: string(45)"
        - "IsDeleted: bool (default false)"
        - "DeletedAt: DateTime?"
        - "DeletedBy: Guid?"

    eventos_auditados:
      - "INSERT: Criação de garantia, apólice, sinistro"
      - "UPDATE: Edição de dados, mudança de status"
      - "DELETE: Soft delete (IsDeleted = true)"
      - "WORKFLOW: Transições de estado de sinistro"

  - codigo: RN-GAR-092-10
    titulo: "Não permitir sobreposição de períodos de garantia para mesmo ativo"
    categoria: "Validação"
    prioridade: "ALTA"

    descricao_natural: |
      O sistema NÃO DEVE permitir criar ou editar garantias com períodos de vigência
      sobrepostos para o mesmo ativo. Cada ativo pode ter múltiplas garantias, mas os
      períodos devem ser disjuntos (sem overlapping).

    criterios_aceitacao:
      - "Validar antes de criar ou editar garantia"
      - "Query verifica se existe garantia com (AtivoId = X AND DataInicio <= NovaDataFim AND DataFim >= NovaDataInicio)"
      - "Erro HTTP 409 (Conflict) se sobreposição detectada"
      - "Mensagem clara indicando período conflitante"

    validacao:
      local: "CreateGarantiaCommandValidator.cs + UpdateGarantiaCommandValidator.cs"
      tipo: "FluentValidation com query customizada"
      error_code: "GARANTIA_PERIODO_SOBREPOSTO"

    formula_deteccao: |
      Sobreposição existe SE:
        NovaDataInicio <= ExistenteDataFim AND NovaDataFim >= ExistenteDataInicio

    exemplos:
      valido:
        - "Garantia 1: 2025-01-01 a 2025-06-30"
        - "Garantia 2: 2025-07-01 a 2025-12-31 (sem sobreposição)"

      invalido:
        - "Garantia 1: 2025-01-01 a 2025-06-30"
        - "Garantia 2: 2025-06-01 a 2025-12-31 (sobreposição de 30 dias)"

  - codigo: RN-GAR-092-11
    titulo: "Franquia deve ser menor que limite máximo de cobertura"
    categoria: "Validação"
    prioridade: "MÉDIA"

    descricao_natural: |
      Em apólices de seguro, o valor da franquia (valor pago pelo segurado em caso de
      sinistro) DEVE ser obrigatoriamente MENOR que o limite máximo de cobertura da apólice.
      Franquia >= Limite é inválida.

    criterios_aceitacao:
      - "ValorFranquia < ValorLimiteCobertura (estritamente menor)"
      - "Validação no backend via FluentValidation"
      - "Validação no frontend via custom validator"
      - "Check constraint no banco de dados"
      - "Erro HTTP 400 se validação falhar"

    validacao:
      local: "CreateApoliceCommandValidator.cs + Database CHECK constraint"
      tipo: "FluentValidation + DB Constraint"
      error_code: "APOLICE_FRANQUIA_INVALIDA"

    exemplos:
      valido:
        - "Franquia = R$ 5.000, Limite = R$ 100.000"
        - "Franquia = R$ 0, Limite = R$ 50.000"

      invalido:
        - "Franquia = R$ 100.000, Limite = R$ 100.000 (iguais)"
        - "Franquia = R$ 150.000, Limite = R$ 100.000 (maior)"

  - codigo: RN-GAR-092-12
    titulo: "Status de garantia derivado das datas de vigência"
    categoria: "Cálculo"
    prioridade: "BAIXA"

    descricao_natural: |
      O status de uma garantia (Ativa, Vencendo, Vencida) é CALCULADO automaticamente
      com base nas datas de início e fim em relação à data atual. Não é um campo editável,
      mas sim uma propriedade computada.

    criterios_aceitacao:
      - "Status calculado em propriedade computada no DTO (não armazenado no banco)"
      - "Regras de cálculo consistentes entre backend e frontend"
      - "Exibição com badge colorido (Material Chip)"

    regras_calculo:
      VENCIDA:
        condicao: "DataFim < hoje"
        cor: "red"
        icone: "warning"

      VENCENDO:
        condicao: "DataFim >= hoje AND DataFim <= hoje + 30 dias"
        cor: "orange"
        icone: "schedule"

      ATIVA:
        condicao: "DataFim > hoje + 30 dias AND DataInicio <= hoje"
        cor: "green"
        icone: "check_circle"

      FUTURA:
        condicao: "DataInicio > hoje"
        cor: "blue"
        icone: "schedule"

    implementacao:
      backend: "GarantiaDto.Status { get; } computed property"
      frontend: "status-badge.pipe.ts (pipe para formatação)"
      exibicao: "mat-chip com color binding"

  - codigo: RN-GAR-092-13
    titulo: "Prêmio anual calculado automaticamente como mensal * 12"
    categoria: "Cálculo"
    prioridade: "BAIXA"

    descricao_natural: |
      O prêmio anual de uma apólice de seguro é CALCULADO automaticamente multiplicando
      o prêmio mensal por 12. Não é um campo editável, mas sim uma propriedade computada.

    criterios_aceitacao:
      - "ValorPremioAnual = ValorPremioMensal * 12"
      - "Calculado no backend (DTO computed property)"
      - "Exibido em formulários e relatórios"
      - "Formatado como moeda BRL"

    implementacao:
      backend: "ApoliceDto.ValorPremioAnual { get => ValorPremioMensal * 12; }"
      frontend: "currency pipe com locale pt-BR"

    exemplos:
      - "Mensal = R$ 1.500,00 → Anual = R$ 18.000,00"
      - "Mensal = R$ 850,50 → Anual = R$ 10.206,00"

  - codigo: RN-GAR-092-14
    titulo: "Sinistro recusado não pode ser reaberto automaticamente"
    categoria: "Workflow"
    prioridade: "ALTA"

    descricao_natural: |
      Um sinistro que tenha sido RECUSADO pela seguradora NÃO PODE ser reaberto ou ter
      seu status alterado de volta para SOLICITAÇÃO automaticamente. Para contestar uma
      recusa, é necessário registrar um NOVO sinistro com justificativa detalhada.

    criterios_aceitacao:
      - "Estado RECUSADO é terminal (não permite transições de saída)"
      - "Tentativa de transição retorna erro HTTP 400"
      - "Para contestar: criar novo sinistro referenciando o recusado"
      - "Campo 'SinistroOrigemId' para rastrear contestações"

    validacao:
      local: "SinistroStateMachine.cs + UpdateSinistroStatusCommand"
      tipo: "State machine validation"
      error_code: "SINISTRO_RECUSADO_TERMINAL"

    workflow_contestacao:
      - "Usuário cria novo sinistro"
      - "Informa SinistroOrigemId = ID do sinistro recusado"
      - "Anexa documentação adicional"
      - "Novo sinistro inicia em SOLICITACAO"
      - "Histórico registra vínculo entre sinistros"

  - codigo: RN-GAR-092-15
    titulo: "Apólice cancelada rejeita novos sinistros"
    categoria: "Validação"
    prioridade: "ALTA"

    descricao_natural: |
      Uma apólice de seguro que tenha sido CANCELADA (IsDeleted = true ou status Cancelada)
      NÃO PODE receber novos sinistros. Apenas apólices ativas e vigentes podem ter
      sinistros registrados.

    criterios_aceitacao:
      - "Validar IsDeleted = false antes de criar sinistro"
      - "Validar status da apólice (se houver enum de status)"
      - "Erro HTTP 400 se apólice cancelada"
      - "Mensagem clara: 'Não é possível registrar sinistro para apólice cancelada'"

    validacao:
      local: "CreateSinistroCommandValidator.cs"
      tipo: "FluentValidation com query de verificação"
      error_code: "SINISTRO_APOLICE_CANCELADA"

    exemplos:
      valido:
        - "ApoliceId = Guid de apólice ativa (IsDeleted = false)"

      invalido:
        - "ApoliceId = Guid de apólice cancelada (IsDeleted = true)"

# =============================================================================
# API ENDPOINTS
# =============================================================================

api_endpoints:
  garantias:
    - metodo: GET
      rota: "/api/garantias"
      query: "GetGarantiasQuery"
      descricao: "Lista garantias com filtros e paginação"
      permissao: "SD.GARANTIAS.LISTAR"
      parametros:
        - "PageNumber (int, default 1)"
        - "PageSize (int, default 20, max 100)"
        - "AtivoId (Guid?, opcional)"
        - "TipoGarantia (enum?, opcional)"
        - "Status (enum?, opcional)"
      resposta: "PagedResponse<GarantiaDto>"

    - metodo: GET
      rota: "/api/garantias/{id}"
      query: "GetGarantiaByIdQuery"
      descricao: "Detalhes de uma garantia específica"
      permissao: "SD.GARANTIAS.VIEW"
      resposta: "GarantiaDto (200) ou NotFound (404)"

    - metodo: POST
      rota: "/api/garantias"
      command: "CreateGarantiaCommand"
      descricao: "Cria nova garantia contratual"
      permissao: "SD.GARANTIAS.CREATE"
      payload:
        - "AtivoId: Guid (obrigatório)"
        - "ContratoId: Guid? (opcional)"
        - "TipoGarantia: enum (obrigatório)"
        - "DataInicio: DateTime (obrigatório)"
        - "DataFim: DateTime (obrigatório)"
        - "Descricao: string(500)? (opcional)"
        - "ValorCobertura: decimal? (opcional)"
      resposta: "Guid (ID da garantia criada)"

    - metodo: PUT
      rota: "/api/garantias/{id}"
      command: "UpdateGarantiaCommand"
      descricao: "Atualiza garantia existente"
      permissao: "SD.GARANTIAS.UPDATE"
      resposta: "NoContent (204) ou NotFound (404)"

    - metodo: DELETE
      rota: "/api/garantias/{id}"
      command: "DeleteGarantiaCommand"
      descricao: "Soft delete de garantia"
      permissao: "SD.GARANTIAS.DELETE"
      resposta: "NoContent (204) ou NotFound (404)"

  apolices:
    - metodo: GET
      rota: "/api/apolices"
      query: "GetApolicesQuery"
      descricao: "Lista apólices com filtros e paginação"
      permissao: "SD.APOLICES.LISTAR"
      parametros:
        - "PageNumber (int, default 1)"
        - "PageSize (int, default 20, max 100)"
        - "SeguradoraId (Guid?, opcional)"
        - "Status (enum?, opcional)"
      resposta: "PagedResponse<ApoliceDto>"

    - metodo: POST
      rota: "/api/apolices"
      command: "CreateApoliceCommand"
      descricao: "Cria nova apólice de seguro"
      permissao: "SD.APOLICES.CREATE"
      payload:
        - "NumeroApolice: string(50) (obrigatório, único por seguradora)"
        - "SeguradoraId: Guid (obrigatório)"
        - "ValorPremioMensal: decimal (obrigatório)"
        - "ValorLimiteCobertura: decimal (obrigatório)"
        - "ValorFranquia: decimal? (opcional)"
        - "Coberturas: CoberturaDto[] (obrigatório)"
        - "DataInicio: DateTime (obrigatório)"
        - "DataFim: DateTime (obrigatório)"
      resposta: "Guid (ID da apólice criada)"

    - metodo: PUT
      rota: "/api/apolices/{id}"
      command: "UpdateApoliceCommand"
      descricao: "Atualiza apólice existente"
      permissao: "SD.APOLICES.UPDATE"
      resposta: "NoContent (204) ou NotFound (404)"

    - metodo: POST
      rota: "/api/apolices/{id}/renew"
      command: "RenewApoliceCommand"
      descricao: "Renova apólice manualmente"
      permissao: "SD.APOLICES.RENEW"
      payload:
        - "NovaDataInicio: DateTime (obrigatório)"
        - "NovaDataFim: DateTime (obrigatório)"
      resposta: "Guid (ID da nova apólice criada)"

  sinistros:
    - metodo: GET
      rota: "/api/sinistros"
      query: "GetSinistrosQuery"
      descricao: "Lista sinistros com filtros e paginação"
      permissao: "SD.SINISTROS.LISTAR"
      parametros:
        - "PageNumber (int, default 1)"
        - "PageSize (int, default 20, max 100)"
        - "ApoliceId (Guid?, opcional)"
        - "Status (enum[], opcional - multi-select)"
      resposta: "PagedResponse<SinistroDto>"

    - metodo: POST
      rota: "/api/sinistros"
      command: "CreateSinistroCommand"
      descricao: "Registra novo sinistro"
      permissao: "SD.SINISTROS.CREATE"
      payload:
        - "ApoliceId: Guid (obrigatório)"
        - "DataOcorrencia: DateTime (obrigatório, <= hoje)"
        - "Descricao: string(1000) (obrigatório, minLength 50)"
        - "ValorEstimado: decimal (obrigatório)"
        - "Observacoes: string(2000)? (opcional)"
      resposta: "Guid (ID do sinistro criado)"

    - metodo: PUT
      rota: "/api/sinistros/{id}/status"
      command: "UpdateSinistroStatusCommand"
      descricao: "Atualiza status do sinistro (workflow)"
      permissao: "SD.SINISTROS.UPDATE_STATUS"
      payload:
        - "NovoStatus: enum (obrigatório)"
        - "Justificativa: string(1000)? (obrigatório se RECUSADO)"
        - "ValorAprovado: decimal? (obrigatório se APROVADO)"
      resposta: "NoContent (204) ou BadRequest (400) se transição inválida"

  kpis:
    - metodo: GET
      rota: "/api/garantias/kpis"
      query: "GetGarantiasKpisQuery"
      descricao: "KPIs de garantias para dashboard"
      permissao: "SD.GARANTIAS.DASHBOARD"
      cache: "2 minutos (MemoryCache)"
      resposta:
        - "TotalAtivas: int"
        - "TotalVencendo30Dias: int"
        - "ValorTotalCobertura: decimal"
        - "GarantiasPorTipo: Dictionary<TipoGarantia, int>"

    - metodo: GET
      rota: "/api/sinistros/kpis"
      query: "GetSinistrosKpisQuery"
      descricao: "KPIs de sinistros para dashboard"
      permissao: "SD.SINISTROS.DASHBOARD"
      cache: "2 minutos (MemoryCache)"
      resposta:
        - "TotalPendentes: int (SOLICITACAO + ANALISE)"
        - "TotalAprovados: int"
        - "TotalRecusados: int"
        - "TotalPagos: int"
        - "ValorTotalSinistrado: decimal"
        - "SinistrosPorStatus: Dictionary<StatusSinistro, int>"

# =============================================================================
# PERMISSÕES RBAC
# =============================================================================

permissoes:
  grupo: "Service Desk - Garantias e Seguros"

  garantias:
    - codigo: "SD.GARANTIAS.LISTAR"
      descricao: "Visualizar lista de garantias"
      roles_padrao: ["ServiceDesk", "ServiceDeskManager", "Admin"]

    - codigo: "SD.GARANTIAS.VIEW"
      descricao: "Visualizar detalhes de garantia"
      roles_padrao: ["ServiceDesk", "ServiceDeskManager", "Admin"]

    - codigo: "SD.GARANTIAS.CREATE"
      descricao: "Criar nova garantia"
      roles_padrao: ["ServiceDesk", "ServiceDeskManager", "Admin"]

    - codigo: "SD.GARANTIAS.UPDATE"
      descricao: "Editar garantia existente"
      roles_padrao: ["ServiceDesk", "ServiceDeskManager", "Admin"]

    - codigo: "SD.GARANTIAS.DELETE"
      descricao: "Excluir garantia"
      roles_padrao: ["ServiceDeskManager", "Admin"]

    - codigo: "SD.GARANTIAS.DASHBOARD"
      descricao: "Visualizar dashboard de KPIs"
      roles_padrao: ["ServiceDesk", "ServiceDeskManager", "Admin"]

  apolices:
    - codigo: "SD.APOLICES.LISTAR"
      descricao: "Visualizar lista de apólices"
      roles_padrao: ["ServiceDesk", "ServiceDeskManager", "Admin"]

    - codigo: "SD.APOLICES.CREATE"
      descricao: "Criar nova apólice"
      roles_padrao: ["ServiceDeskManager", "Admin"]

    - codigo: "SD.APOLICES.UPDATE"
      descricao: "Editar apólice existente"
      roles_padrao: ["ServiceDeskManager", "Admin"]

    - codigo: "SD.APOLICES.RENEW"
      descricao: "Renovar apólice manualmente"
      roles_padrao: ["ServiceDeskManager", "Admin"]

  sinistros:
    - codigo: "SD.SINISTROS.LISTAR"
      descricao: "Visualizar lista de sinistros"
      roles_padrao: ["ServiceDesk", "ServiceDeskManager", "Admin"]

    - codigo: "SD.SINISTROS.CREATE"
      descricao: "Registrar novo sinistro"
      roles_padrao: ["ServiceDesk", "ServiceDeskManager", "Admin"]

    - codigo: "SD.SINISTROS.UPDATE_STATUS"
      descricao: "Atualizar status de sinistro (workflow)"
      roles_padrao: ["ServiceDeskManager", "Admin"]
      observacao: "APROVADO requer role Gestor ou superior"

    - codigo: "SD.SINISTROS.DASHBOARD"
      descricao: "Visualizar dashboard de sinistros"
      roles_padrao: ["ServiceDesk", "ServiceDeskManager", "Admin"]

# =============================================================================
# INTEGRACOES OBRIGATORIAS
# =============================================================================

integracoes:
  i18n:
    implementacao: "Transloco"
    chaves_principais:
      - "garantias.titulo"
      - "garantias.lista.titulo"
      - "garantias.form.criar"
      - "garantias.form.editar"
      - "garantias.status.ativa"
      - "garantias.status.vencendo"
      - "garantias.status.vencida"
      - "apolices.titulo"
      - "sinistros.titulo"
      - "sinistros.workflow.solicitacao"
      - "sinistros.workflow.analise"
      - "sinistros.workflow.aprovado"
      - "sinistros.workflow.recusado"
      - "sinistros.workflow.pago"
    idiomas_obrigatorios:
      - "pt-BR (default)"
      - "en (fallback)"
      - "es (fallback)"

  auditoria:
    implementacao: "AuditInterceptor (EF Core)"
    campos:
      - "Created, CreatedBy, LastModified, LastModifiedBy, UserIP"
      - "IsDeleted, DeletedAt, DeletedBy"
    tabela: "AuditLogs"
    retencao: "7 anos (compliance SOX)"

  permissoes:
    implementacao: "RBAC (Role-Based Access Control)"
    matriz: "Permission → Role → User"
    validacao:
      - "RequirePermission attribute em Commands"
      - "RequireAuthorization policy em Endpoints"
      - "Guard no Angular (permissionGuard)"

  central_funcionalidades:
    modulo: "Service Desk - Garantias e Seguros"
    funcionalidades:
      - codigo: "FUNC-SD-GARANTIAS"
        nome: "Gestão de Garantias Contratuais"
        rota: "/service-desk/garantias"
        icone: "verified_user"

      - codigo: "FUNC-SD-APOLICES"
        nome: "Gestão de Apólices de Seguro"
        rota: "/service-desk/apolices"
        icone: "shield"

      - codigo: "FUNC-SD-SINISTROS"
        nome: "Gestão de Sinistros"
        rota: "/service-desk/sinistros"
        icone: "report_problem"

# =============================================================================
# METRICAS E INDICADORES
# =============================================================================

kpis:
  garantias:
    - nome: "Total de Garantias Ativas"
      calculo: "COUNT WHERE IsDeleted = false AND DataFim >= hoje"
      exibicao: "Card numérico no dashboard"

    - nome: "Garantias Vencendo em 30 Dias"
      calculo: "COUNT WHERE DataFim BETWEEN hoje AND hoje+30dias"
      exibicao: "Card numérico com alerta (cor laranja)"

    - nome: "Valor Total de Cobertura"
      calculo: "SUM(ValorCobertura) WHERE IsDeleted = false AND DataFim >= hoje"
      exibicao: "Card com formatação monetária BRL"

    - nome: "Garantias por Tipo"
      calculo: "GROUP BY TipoGarantia COUNT(*)"
      exibicao: "Gráfico de pizza (ApexCharts)"

  apolices:
    - nome: "Total de Apólices Ativas"
      calculo: "COUNT WHERE IsDeleted = false AND DataFim >= hoje"
      exibicao: "Card numérico"

    - nome: "Valor Total Segurado"
      calculo: "SUM(ValorLimiteCobertura) WHERE DataFim >= hoje"
      exibicao: "Card com formatação monetária BRL"

    - nome: "Prêmio Anual Total"
      calculo: "SUM(ValorPremioMensal * 12) WHERE DataFim >= hoje"
      exibicao: "Card com formatação monetária BRL"

  sinistros:
    - nome: "Sinistros Pendentes"
      calculo: "COUNT WHERE Status IN (SOLICITACAO, ANALISE)"
      exibicao: "Card numérico com alerta (cor amarela)"

    - nome: "Sinistros Aprovados (não pagos)"
      calculo: "COUNT WHERE Status = APROVADO"
      exibicao: "Card numérico"

    - nome: "Valor Total Sinistrado"
      calculo: "SUM(ValorEstimado) WHERE Status != RECUSADO"
      exibicao: "Card com formatação monetária BRL"

    - nome: "Sinistros por Status"
      calculo: "GROUP BY Status COUNT(*)"
      exibicao: "Gráfico de barras (ApexCharts)"

    - nome: "Taxa de Aprovação"
      calculo: "(COUNT(APROVADO) / COUNT(APROVADO + RECUSADO)) * 100"
      exibicao: "Card com percentual"

# =============================================================================
# JOBS HANGFIRE
# =============================================================================

background_jobs:
  - nome: "GarantiaExpirationJob"
    descricao: "Envia alertas de vencimento de garantias (90, 60, 30, 15 dias)"
    cron: "0 8 * * * (diário às 8h)"
    query: "GetExpiringGarantiasQuery"
    acao: "NotificationService.SendExpirationAlert()"
    regra_negocio: "RN-GAR-092-03"

  - nome: "ApoliceExpirationJob"
    descricao: "Envia alertas de vencimento de apólices (90, 60, 30, 15 dias)"
    cron: "0 8 * * * (diário às 8h)"
    query: "GetExpiringApolicesQuery"
    acao: "NotificationService.SendExpirationAlert()"
    regra_negocio: "RN-GAR-092-03"

  - nome: "ApoliceRenewalJob"
    descricao: "Renova automaticamente apólices 30 dias antes do vencimento"
    cron: "0 6 * * * (diário às 6h)"
    query: "GetApolicesForRenewalQuery"
    command: "RenewApoliceCommand"
    regra_negocio: "RN-GAR-092-08"
