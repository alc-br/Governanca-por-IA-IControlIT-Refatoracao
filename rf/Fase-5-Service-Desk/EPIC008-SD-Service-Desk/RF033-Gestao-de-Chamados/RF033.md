# RF033 - Gestão de Chamados (Service Desk)

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC008-SD-Service-Desk
**Fase**: Fase 5 - Service Desk

---

## 1. OBJETIVO DO REQUISITO

Implementar um sistema completo de Service Desk para gerenciamento de chamados de suporte técnico, solicitações de serviços e incidentes relacionados a telecomunicações e TI. O sistema deve controlar SLA, distribuir chamados por filas de atendimento, registrar interações, avaliar satisfação e gerar métricas de desempenho em tempo real.

Este RF fornece o **contrato oficial** entre negócio, desenvolvimento e testes, definindo **o que o sistema deve fazer** sem especificar implementação técnica.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] CRUD completo de chamados (abertura, edição, visualização, encerramento)
- [x] Cálculo automático de SLA com base em tipo de solicitação e dias úteis
- [x] Distribuição automática e manual de chamados para filas de atendimento
- [x] Registro de interações públicas e privadas
- [x] Sistema de avaliação de satisfação (NPS)
- [x] Alertas de vencimento de SLA (visuais e notificações)
- [x] Dashboard de métricas em tempo real
- [x] Workflow configurável por tipo de chamado
- [x] Vinculação a ativos, consumidores e contratos
- [x] Base de conhecimento de soluções
- [x] Auditoria completa de operações
- [x] Controle de acesso granular (RBAC)
- [x] Multi-tenancy (isolamento por Fornecedor)
- [x] Internacionalização (pt-BR, en-US, es-ES)

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (layout, UX, identidade visual)
- Tecnologia, framework ou linguagem de implementação
- Base de conhecimento completa (será RF futuro)
- Chatbot de atendimento automático
- Integração com telefonia (CTI)
- Gestão de problemas e mudanças (ITIL completo)
- Estratégia de deploy ou infraestrutura

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Chamado** | Solicitação de serviço, suporte técnico ou registro de incidente |
| **SLA** | Service Level Agreement - prazo acordado para resolução do chamado |
| **Fila de Atendimento** | Grupo especializado responsável por atender chamados de determinada categoria |
| **Interação** | Registro de comunicação dentro do chamado (pública ou privada) |
| **Escalação** | Atribuição automática a supervisor quando SLA vence |
| **Solução** | Registro de como o problema foi resolvido |
| **Tenant** | Fornecedor - unidade lógica de isolamento de dados |
| **NPS** | Net Promoter Score - nota de satisfação de 1 a 5 |
| **Status** | Estado atual do chamado no workflow |
| **Data de Parada** | Feriado ou data de manutenção que pausa contagem de SLA |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Abertura de Chamado** - Criação de nova solicitação por usuário ou equipe
2. **Visualização de Chamado** - Consulta de detalhes completos
3. **Listagem de Chamados** - Busca e filtro por status, fila, SLA
4. **Atualização de Chamado** - Edição de informações
5. **Atribuição** - Distribuição automática ou manual para filas/técnicos
6. **Registro de Interação** - Adicionar comentários públicos ou privados
7. **Upload de Anexos** - Evidências e documentos
8. **Alteração de Status** - Transições controladas no workflow
9. **Encerramento** - Finalização com solução obrigatória
10. **Avaliação** - Registro de satisfação pelo solicitante
11. **Reabertura** - Reabrir chamado encerrado (até 7 dias)
12. **Dashboard** - Métricas e indicadores em tempo real
13. **Alertas de SLA** - Notificações automáticas de vencimento
14. **Escalação** - Atribuição automática a supervisor

---

## 5. REGRAS DE NEGÓCIO

### RN-RF033-01 — Campos Obrigatórios na Abertura

**Descrição**: Todo chamado deve ter título, data de solicitação, usuário solicitante, tipo de solicitação e tipo de ativo obrigatórios.

**Justificativa**: Garante informações mínimas para categorização e atendimento adequado.

**Critério de Aceite**:
- Campo ausente ou vazio → rejeição com HTTP 400
- Título com mais de 300 caracteres → rejeição
- Data de solicitação futura → rejeição

---

### RN-RF033-02 — Cálculo Automático de SLA

**Descrição**: O prazo de vencimento (SLA) deve ser calculado automaticamente com base no tipo de solicitação, considerando apenas dias úteis e excluindo datas de parada cadastradas.

**Justificativa**: Garante cumprimento de acordos de nível de serviço e facilita gestão de prazos.

**Critério de Aceite**:
- SLA calculado com base em `TipoSolicitacao.SLA.PrazoDias`
- Finais de semana (sábado/domingo) NÃO contam no prazo
- Datas cadastradas em `DatasParada` NÃO contam no prazo
- Cálculo deve ser determinístico (mesma entrada = mesma saída)

---

### RN-RF033-03 — Validação de Transições de Status

**Descrição**: As transições de status devem seguir workflow válido. Não é permitido pular etapas ou retroceder (exceto reabertura).

**Justificativa**: Garante rastreabilidade e integridade do workflow de atendimento.

**Critério de Aceite**:
- Transições permitidas:
  - `Aberto` → `EmAtendimento`, `Cancelado`
  - `EmAtendimento` → `AguardandoUsuario`, `AguardandoFornecedor`, `Resolvido`
  - `AguardandoUsuario` → `EmAtendimento`, `Resolvido`
  - `AguardandoFornecedor` → `EmAtendimento`, `Resolvido`
  - `Resolvido` → `Encerrado`, `EmAtendimento` (reabertura)
  - `Encerrado` → `EmAtendimento` (reabertura até 7 dias)
  - `Cancelado` → (sem transições)
- Transição inválida → rejeição com HTTP 400

---

### RN-RF033-04 — Solução Obrigatória no Encerramento

**Descrição**: Ao encerrar um chamado (status = Encerrado), é obrigatório informar a solução aplicada.

**Justificativa**: Constrói base de conhecimento e facilita resolução de problemas similares.

**Critério de Aceite**:
- Campo `SolucaoId` obrigatório quando status = `Encerrado`
- Solução deve existir e estar ativa
- Encerramento sem solução → rejeição com HTTP 400

---

### RN-RF033-05 — Alertas de SLA Vencido ou Próximo do Vencimento

**Descrição**: O sistema deve emitir alertas visuais e notificações quando o chamado estiver próximo do vencimento (80% do prazo) ou vencido.

**Justificativa**: Permite ação proativa da equipe de suporte para evitar violações de SLA.

**Critério de Aceite**:
- Chamado com 80% do prazo decorrido → alerta amarelo + notificação
- Chamado com 100% do prazo decorrido (vencido) → alerta vermelho + notificação urgente
- Notificações enviadas para: solicitante, atendente responsável, supervisor da fila
- Job recorrente verifica SLA a cada 15 minutos

---

### RN-RF033-06 — Avaliação de Satisfação Opcional

**Descrição**: A avaliação de satisfação é opcional, mas se informada, deve ter nota de 1 a 5 e comentário opcional.

**Justificativa**: Permite medir qualidade do atendimento sem obrigar usuário a avaliar.

**Critério de Aceite**:
- Nota fora do range 1-5 → rejeição com HTTP 400
- Comentário com mais de 500 caracteres → rejeição
- Avaliação só pode ser feita pelo solicitante do chamado
- Apenas 1 avaliação por chamado

---

### RN-RF033-07 — Interações Públicas e Privadas

**Descrição**: Interações (itens) do chamado podem ser públicas (visíveis ao solicitante) ou privadas (apenas equipe de suporte).

**Justificativa**: Permite comunicação interna da equipe sem expor detalhes técnicos ao usuário.

**Critério de Aceite**:
- Usuário solicitante vê apenas interações com `FlPublico = true`
- Equipe de suporte vê todas as interações
- Campo `FlPublico` obrigatório ao criar interação

---

### RN-RF033-08 — Atribuição a Fila de Atendimento

**Descrição**: Todo chamado deve ser atribuído a uma fila de atendimento no momento da criação ou distribuição.

**Justificativa**: Organiza trabalho por especialização e facilita distribuição de carga.

**Critério de Aceite**:
- Campo `FilaAtendimentoId` obrigatório
- Fila deve existir, estar ativa e pertencer ao mesmo Fornecedor
- Fila inválida ou inativa → rejeição com HTTP 400

---

### RN-RF033-09 — Vinculação a Ativo ou Consumidor

**Descrição**: O chamado pode ser vinculado a um ativo específico e/ou a uma unidade de consumidor para contextualizar o atendimento.

**Justificativa**: Facilita identificação de problemas recorrentes em ativos ou localidades específicas.

**Critério de Aceite**:
- Campos `AtivoId` e `ConsumidorUnidadeId` são opcionais
- Se informados, devem existir, estar ativos e pertencer ao mesmo Fornecedor
- Vinculação inválida → rejeição com HTTP 400

---

### RN-RF033-10 — Notificações Automáticas

**Descrição**: O sistema deve enviar notificações automáticas em eventos-chave: abertura, atribuição, alteração de status, vencimento de SLA, encerramento e avaliação.

**Justificativa**: Mantém todas as partes informadas e reduz tempo de resposta.

**Critério de Aceite**:
- Eventos que disparam notificações:
  - `ChamadoCriado` → solicitante + fila
  - `ChamadoAtribuido` → técnico responsável
  - `ChamadoStatusAlterado` → solicitante
  - `ChamadoVencendoSLA` → solicitante + técnico + supervisor
  - `ChamadoVencido` → solicitante + técnico + supervisor
  - `ChamadoEncerrado` → solicitante
  - `ChamadoAvaliado` → técnico + supervisor
- Notificações enviadas via e-mail, push e/ou SMS

---

### RN-RF033-11 — Reabertura de Chamado Encerrado

**Descrição**: Chamados encerrados podem ser reabertos pelo solicitante ou equipe de suporte em até 7 dias após o encerramento.

**Justificativa**: Permite tratar casos onde a solução não foi efetiva sem criar novo chamado.

**Critério de Aceite**:
- Reabertura permitida apenas se status = `Encerrado`
- Apenas 1 reabertura por chamado
- Reabertura após 7 dias → rejeição com HTTP 400
- Campo `Justificativa` obrigatório (máximo 500 caracteres)

---

### RN-RF033-12 — Prazo SLA Pausado em Status "Aguardando"

**Descrição**: Quando o chamado está em status "Aguardando Usuário" ou "Aguardando Fornecedor", o prazo de SLA deve ser pausado e retomado ao voltar para "Em Atendimento".

**Justificativa**: Evita penalização da equipe de suporte por atrasos causados por terceiros.

**Critério de Aceite**:
- Ao entrar em status `AguardandoUsuario` ou `AguardandoFornecedor`:
  - Registrar `DataInicioAguardando = DateTime.Now`
- Ao sair desses status:
  - Calcular tempo pausado: `TotalHorasAguardando += (Now - DataInicioAguardando)`
  - Limpar `DataInicioAguardando = null`
- Cálculo de vencimento efetivo considera tempo pausado

---

### RN-RF033-13 — Anexos e Evidências

**Descrição**: O chamado e suas interações podem ter anexos (imagens, PDFs, logs) com limite de 10 MB por arquivo e 50 MB por chamado.

**Justificativa**: Facilita comunicação e resolução com evidências visuais.

**Critério de Aceite**:
- Arquivo > 10 MB → rejeição com HTTP 400
- Total de anexos > 50 MB → rejeição com HTTP 400
- Extensões permitidas: `.jpg`, `.jpeg`, `.png`, `.pdf`, `.txt`, `.log`, `.zip`
- Extensão não permitida → rejeição com HTTP 400

---

### RN-RF033-14 — Escalação Automática por SLA

**Descrição**: Quando o SLA estiver vencido, o sistema deve escalar automaticamente o chamado para o supervisor da fila de atendimento.

**Justificativa**: Garante atenção gerencial a chamados críticos.

**Critério de Aceite**:
- Job verifica chamados vencidos a cada 15 minutos
- Chamado vencido e não escalado → marcar `FlEscalado = true` + notificar supervisor
- Criar interação privada registrando escalação automática
- Escalação ocorre apenas 1 vez por chamado

---

### RN-RF033-15 — Integração com Base de Conhecimento

**Descrição**: Soluções aplicadas em chamados encerrados devem poder ser marcadas como "Base de Conhecimento" para reutilização futura.

**Justificativa**: Constrói repositório de soluções para problemas recorrentes.

**Critério de Aceite**:
- Campo `FlBaseConhecimento` em `SolicitacaoSolucao`
- Soluções marcadas aparecem em sugestões ao criar chamado
- Busca por similaridade (título, descrição, tipo)
- Retornar top 5 soluções mais utilizadas e melhor avaliadas

---

### RN-RF033-16 — Isolamento Multi-Tenant

**Descrição**: Um usuário só pode acessar chamados do seu próprio Fornecedor.

**Justificativa**: Garantir segurança e conformidade LGPD.

**Critério de Aceite**:
- Todas as queries filtram por `FornecedorId` do usuário logado
- Tentativa de acesso cruzado → HTTP 403

---

### RN-RF033-17 — Unicidade de Avaliação

**Descrição**: Cada chamado pode ter apenas 1 avaliação.

**Justificativa**: Evitar múltiplas avaliações e garantir integridade das métricas.

**Critério de Aceite**:
- Criar avaliação quando já existe → rejeição com HTTP 400
- Apenas solicitante do chamado pode avaliar

---

## 6. ESTADOS DA ENTIDADE

| Estado | Descrição |
|--------|-----------|
| `Aberto` | Chamado criado, aguardando atendimento |
| `EmAtendimento` | Em atendimento pela equipe de suporte |
| `AguardandoUsuario` | Aguardando resposta do solicitante |
| `AguardandoFornecedor` | Aguardando resposta de fornecedor externo |
| `Resolvido` | Solução aplicada, aguardando confirmação |
| `Encerrado` | Chamado finalizado |
| `Cancelado` | Chamado cancelado sem resolução |

### Transições Permitidas

```
Aberto → EmAtendimento, Cancelado
EmAtendimento → AguardandoUsuario, AguardandoFornecedor, Resolvido
AguardandoUsuario → EmAtendimento, Resolvido
AguardandoFornecedor → EmAtendimento, Resolvido
Resolvido → Encerrado, EmAtendimento (reabertura)
Encerrado → EmAtendimento (reabertura até 7 dias)
Cancelado → (sem transições)
```

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando Ocorre |
|--------|---------------|
| `ChamadoCriado` | Após criação do chamado |
| `ChamadoAtribuido` | Após atribuição a técnico/fila |
| `ChamadoStatusAlterado` | Após mudança de status |
| `ChamadoVencendoSLA` | Quando 80% do prazo decorrido |
| `ChamadoVencido` | Quando 100% do prazo decorrido |
| `ChamadoEncerrado` | Após encerramento |
| `ChamadoAvaliado` | Após avaliação de satisfação |
| `ChamadoReaberto` | Após reabertura |
| `ChamadoEscalado` | Após escalação automática |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant (multi-tenancy)
- Nenhuma regra de negócio pode ser ignorada
- Todas as validações devem retornar mensagens i18n
- Erros devem ser previsíveis e rastreáveis
- Auditoria deve registrar quem, quando e o que mudou
- Todas as operações críticas devem emitir eventos de domínio
- Notificações devem ser enviadas de forma assíncrona
- Dashboard deve atualizar em tempo real (SignalR)

---

## 9. SEGURANÇA

- **Validação de entrada obrigatória** em todos os endpoints
- **Proteção contra injeção SQL** via ORM (Entity Framework)
- **Controle de permissões RBAC** granular
- **Isolamento multi-tenant** automático via Row-Level Security
- **Auditoria completa** de todas operações (retenção 7 anos LGPD)
- **Soft delete** (sem exclusão física de dados)

---

## 10. INTEGRAÇÕES OBRIGATÓRIAS

### 10.1 Central de Funcionalidades

**Registro da Funcionalidade:**

- **Código**: `GES.CHAMADOS`
- **Nome**: Gestão de Chamados (Service Desk)
- **Módulo**: Gestão
- **Rota**: `/gestao/chamados`
- **Ícone**: `support_agent`

**Sub-funcionalidades:**
- `GES.CHAMADOS.LISTAR` - Listar Chamados
- `GES.CHAMADOS.CRIAR` - Abrir Chamado
- `GES.CHAMADOS.VISUALIZAR` - Visualizar Chamado
- `GES.CHAMADOS.EDITAR` - Editar Chamado
- `GES.CHAMADOS.ENCERRAR` - Encerrar Chamado
- `GES.CHAMADOS.AVALIAR` - Avaliar Atendimento
- `GES.CHAMADOS.DASHBOARD` - Dashboard de SLA

### 10.2 Internacionalização (i18n)

**Chaves principais:**
- `chamados.titulo` - Título do módulo
- `chamados.campos.*` - Labels de campos
- `chamados.status.*` - Status do chamado
- `chamados.acoes.*` - Ações disponíveis
- `chamados.mensagens.*` - Mensagens de sucesso/erro
- `chamados.validacoes.*` - Validações

**Idiomas suportados:** pt-BR (padrão), en-US, es-ES

### 10.3 Auditoria

**Operações auditadas:**

| Operação | Trigger | Retenção |
|----------|---------|----------|
| `CREATE` | Abertura de chamado | 7 anos |
| `UPDATE` | Alteração de status, atribuição | 7 anos |
| `ADD_ITEM` | Nova interação | 7 anos |
| `CLOSE` | Encerramento | 7 anos |
| `REOPEN` | Reabertura | 7 anos |
| `EVALUATE` | Avaliação de satisfação | 7 anos |
| `ESCALATE` | Escalação automática | 7 anos |
| `ATTACH` | Upload de anexo | 7 anos |

### 10.4 Controle de Acesso (RBAC)

**Matriz de Permissões:**

| Perfil | VIEW | CREATE | UPDATE | CLOSE | EVALUATE | ASSIGN | REOPEN | EXPORT |
|--------|------|--------|--------|-------|----------|--------|--------|--------|
| **Super Admin** | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| **Administrador** | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| **Suporte Nível 2** | ✅ | ✅ | ✅ | ✅ | ❌ | ✅ | ✅ | ✅ |
| **Suporte Nível 1** | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| **Gestor** | ✅ | ✅ | ❌ | ❌ | ✅ | ❌ | ❌ | ✅ |
| **Usuário** | ✅* | ✅ | ❌ | ❌ | ✅** | ❌ | ✅** | ❌ |

*Apenas seus próprios chamados
**Apenas chamados que abriu

**Códigos de Permissão:**
- `GES.CHAMADOS.VIEW` - Visualizar chamados próprios
- `GES.CHAMADOS.VIEW_ALL` - Visualizar todos os chamados
- `GES.CHAMADOS.CREATE` - Criar chamados
- `GES.CHAMADOS.UPDATE` - Atualizar chamados
- `GES.CHAMADOS.CLOSE` - Encerrar chamados
- `GES.CHAMADOS.EVALUATE` - Avaliar chamados
- `GES.CHAMADOS.ASSIGN` - Atribuir chamados
- `GES.CHAMADOS.REOPEN` - Reabrir chamados
- `GES.CHAMADOS.EXPORT` - Exportar relatórios

---

## 11. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF033.md** - Casos de Uso detalhados (UC00-UC04)
- **MD-RF033.md** - Modelo de Dados completo com DDL
- **WF-RF033.md** - Wireframes e fluxos de tela
- **TC-RF033.yaml** - Casos de Teste (Backend, Frontend, E2E, Segurança)
- **MT-RF033.yaml** - Massas de Teste

---

## 12. RASTREABILIDADE

| Artefato | Status | Observação |
|----------|--------|------------|
| UC-RF033.md | ✅ Gerado | 5 casos de uso (UC00-UC04) |
| MD-RF033.md | ✅ Gerado | Modelo completo com auditoria e multi-tenancy |
| WF-RF033.md | ✅ Gerado | Wireframes de telas principais |
| TC-RF033-BACKEND.md | ✅ Gerado | Testes de backend |
| TC-RF033-FRONTEND.md | ❌ Pendente | Testes de frontend |
| TC-RF033-E2E.md | ❌ Pendente | Testes E2E |
| TC-RF033-SEGURANCA.md | ❌ Pendente | Testes de segurança |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0: Separação RF/RL completa. RF agora contém apenas contrato funcional moderno com 17 regras de negócio. Referências históricas migradas para RL-RF033.md. | Agência ALC - alc.dev.br |
| 1.0 | 2025-01-14 | Versão inicial com documentação misturada. | Architect Agent |
