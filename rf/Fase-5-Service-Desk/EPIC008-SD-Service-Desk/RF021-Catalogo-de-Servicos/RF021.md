# RF-021: Catálogo de Serviços e Portal Self-Service

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC008-SD-Service-Desk
**Fase**: Fase 5 - Service Desk

---

## 1. OBJETIVO DO REQUISITO

Implementar um **Catálogo de Serviços e Portal Self-Service** que permita aos usuários finais solicitar serviços de TI/Telecom de forma autônoma através de uma interface intuitiva estilo "carrinho de compras", com aprovação automatizada via workflow configurável, tracking visual de SLA e integração com sistemas de estoque e fornecedores.

Este requisito funcional define **O QUE** o sistema deve fazer, não **COMO** implementar. Serve como contrato oficial entre negócio, desenvolvimento, testes e agentes de IA.

### Problema Resolvido

- **Sobrecarga do Service Desk**: 70%+ das solicitações chegam via e-mail/telefone manual
- **Falta de Padronização**: Cada solicitação é descrita de forma diferente, causando inconsistência
- **Sem Visibilidade**: Usuário não sabe quais serviços estão disponíveis ou quanto tempo levará
- **Aprovação Manual**: Aprovações via e-mail sem rastreabilidade e sem SLA
- **Impossibilidade de Métricas**: Não há como medir demanda, satisfação ou tempo de atendimento

### Público Afetado

- **Usuários Finais**: Solicitam serviços (linhas móveis, equipamentos, acessos)
- **Gestores**: Aprovam solicitações de suas equipes
- **Atendentes TI/Telecom**: Executam provisionamento de serviços
- **Administradores**: Configuram catálogo, workflows e SLAs

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- Catálogo visual categorizado de serviços disponíveis
- Busca full-text inteligente no catálogo
- Carrinho de compras para múltiplos serviços
- Workflow de aprovação automatizado configurável
- Formulários dinâmicos por serviço (JSON Schema)
- SLA tracking visual com semáforo (verde/amarelo/vermelho)
- Integração com estoque (verificação de disponibilidade)
- Provisionamento automatizado via APIs de fornecedores
- Analytics de demanda (serviços mais solicitados, SLA médio)
- Avaliação de serviço (1-5 estrelas + comentários)
- Notificações multicanal (e-mail, push, in-app)
- Auto-aprovação por regras de negócio
- Cancelamento de solicitações (com restrições)
- Numeração sequencial de solicitações (SRV-YYYY-NNNNN)

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (layout, cores, fontes)
- Tecnologia, framework ou linguagem de implementação
- Estratégia de deploy ou infraestrutura
- Integração com sistemas de terceiros não especificados
- Catálogo de serviços de outros departamentos (RH, Financeiro) - será extensão futura

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Catálogo de Serviços** | Lista padronizada de serviços disponíveis com descrição, SLA, custo e formulário de solicitação |
| **Solicitação** | Pedido formal de um ou mais serviços do catálogo por um usuário |
| **Carrinho** | Lista temporária de serviços selecionados antes de finalizar solicitação |
| **Workflow de Aprovação** | Fluxo configurável de aprovadores sequenciais (gestor → TI → financeiro → diretor) |
| **SLA (Service Level Agreement)** | Prazo máximo para atendimento de uma solicitação |
| **Semáforo de SLA** | Indicador visual (verde/amarelo/vermelho) mostrando proximidade do vencimento |
| **Formulário Dinâmico** | Campos customizados por serviço definidos via JSON Schema |
| **Provisionamento** | Execução técnica do serviço (ex: ativação de linha, entrega de equipamento) |
| **Beneficiário** | Usuário que receberá o serviço (pode ser diferente do solicitante) |
| **Auto-Aprovação** | Aprovação automática baseada em regras (ex: valor baixo, usuário veterano) |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Gestão de Catálogo de Serviços** - Criar, editar, listar, inativar serviços
2. **Navegação e Busca no Catálogo** - Categorias, filtros, busca full-text
3. **Carrinho de Compras** - Adicionar múltiplos serviços, revisar antes de solicitar
4. **Criação de Solicitação** - Finalizar carrinho e criar solicitação formal
5. **Workflow de Aprovação** - Aprovação sequencial configurável por serviço
6. **Auto-Aprovação por Regras** - Aprovação automática baseada em critérios
7. **Formulários Dinâmicos** - Campos específicos por serviço via JSON Schema
8. **SLA Tracking Visual** - Semáforo em tempo real mostrando status
9. **Integração com Estoque** - Verificação de disponibilidade antes da aprovação
10. **Provisionamento Automatizado** - Chamadas a APIs de fornecedores após aprovação
11. **Notificações em Cada Etapa** - E-mail + push + in-app em mudanças de status
12. **Cancelamento de Solicitação** - Usuário ou aprovador pode cancelar (com restrições)
13. **Avaliação de Serviço** - Feedback 1-5 estrelas após conclusão
14. **Analytics de Demanda** - Dashboard com serviços mais solicitados, SLA médio, gargalos
15. **Solicitação para Terceiros** - Criar solicitação em nome de outro usuário (permissão específica)

---

## 5. REGRAS DE NEGÓCIO

### RN-RF021-001: Workflow de Aprovação Obrigatório

**Descrição**: Todo serviço marcado com `Fl_Requer_Aprovacao = 1` deve passar por workflow de aprovação configurável antes do atendimento.

**Níveis de Aprovação**:
- Nível 1: Gestor direto do solicitante
- Nível 2: TI/Telecom (validação técnica)
- Nível 3: Financeiro (aprovação de custo > R$ 1.000)
- Nível 4: Diretor (aprovação executiva para custos > R$ 10.000)

**Critério de Aceite**:
- Aprovações devem ser sequenciais (cada nível depende do anterior)
- Se uma aprovação for rejeitada, todo o fluxo é cancelado automaticamente
- Aprovador recebe notificação no momento que a solicitação chega em sua fila
- Histórico completo de aprovações deve ser auditado

---

### RN-RF021-002: Solicitação para Outro Usuário

**Descrição**: Usuários com permissão "Solicitar_Para_Terceiros" podem criar solicitações em nome de outro colaborador.

**Campos Obrigatórios**:
- `Id_Usuario_Solicitante`: Quem está criando a solicitação
- `Id_Usuario_Beneficiario`: Quem receberá o serviço

**Critério de Aceite**:
- Ambos os usuários (solicitante e beneficiário) recebem notificações
- Auditoria deve registrar explicitamente que solicitação foi feita por terceiro
- Aprovador visualiza tanto solicitante quanto beneficiário

---

### RN-RF021-003: Carrinho de Compras Temporário

**Descrição**: Usuário pode adicionar múltiplos serviços ao carrinho antes de finalizar solicitação.

**Persistência**: Itens do carrinho são salvos na tabela `Servico_Carrinho` e persistem entre sessões.

**Critério de Aceite**:
- Itens não finalizados por 30 dias são removidos automaticamente via job noturno
- Máximo de 10 serviços por carrinho
- Usuário pode editar ou remover itens do carrinho antes de finalizar
- Carrinho é limpo automaticamente após finalização da solicitação

---

### RN-RF021-004: Validação de Estoque Automática

**Descrição**: Serviços físicos (equipamentos) marcados com `Fl_Verifica_Estoque = 1` devem validar disponibilidade no estoque antes da aprovação final.

**Fluxo**:
1. Aprovador visualiza alerta se item está indisponível
2. Solicitação aguarda reposição de estoque
3. Notificação automática ao aprovador quando item ficar disponível
4. Item é **reservado** após aprovação (não pode ser alocado a outra solicitação)

**Critério de Aceite**:
- Se estoque não for reposto em 15 dias, solicitação é cancelada automaticamente
- Reserva de estoque é liberada se solicitação for cancelada ou rejeitada

---

### RN-RF021-005: SLA Tracking com Semáforo Visual

**Descrição**: Todas as solicitações devem exibir status visual de SLA em tempo real usando sistema de semáforo.

**Cálculo de SLA**:
- `SLA_Vencimento_Calculado = Data_Solicitacao + SLA_Atendimento_Horas`
- Considera apenas dias úteis (segunda a sexta, 8h às 18h)

**Semáforo**:
- Verde: >50% do tempo restante
- Amarelo: 20-50% do tempo restante
- Vermelho: <20% do tempo restante ou vencido

**Critério de Aceite**:
- Job Hangfire verifica SLAs a cada 15 minutos
- Alerta enviado ao atendente quando entrar em "vermelho"
- SLA pausado em status "Aguardando_Estoque" ou "Aguardando_Usuario"

---

### RN-RF021-006: Formulários Dinâmicos por Serviço

**Descrição**: Cada serviço pode definir campos customizados via JSON Schema armazenado em `Formulario_JSON`.

**Tipos de Campo Suportados**: text, email, number, date, select, multiselect, checkbox, radio, file upload

**Validações Suportadas**:
- Obrigatoriedade (`required`)
- Tamanho mínimo/máximo (`minLength`, `maxLength`)
- Expressões regulares (`pattern`)
- Valores mínimos/máximos numéricos (`minimum`, `maximum`)

**Critério de Aceite**:
- Validação client-side (UX) e server-side (segurança)
- Renderização dinâmica no frontend Angular usando `@angular/forms`
- Erros de validação devem ser exibidos em tempo real

---

### RN-RF021-007: Provisionamento Automatizado

**Descrição**: Serviços marcados com `Fl_Provisiona_Automatico = 1` devem chamar API do fornecedor automaticamente após aprovação final.

**Integrações Suportadas**:
- Operadoras Telecom: Vivo, Claro, TIM (ativação de linhas via API REST)
- Fornecedores de Hardware: Dell, HP, Lenovo (pedidos via EDI)
- Provedores Cloud: AWS, Azure (criação de recursos via SDK)

**Critério de Aceite**:
- Fornecedor retorna callback para atualizar status: `Em_Provisionamento` → `Aguardando_Entrega` → `Concluida`
- Se provisionamento falhar, solicitação retorna para status `Erro_Provisionamento`
- Atendente é notificado em caso de erro com detalhes técnicos

---

### RN-RF021-008: Auto-Aprovação por Regras

**Descrição**: Solicitações que atendem critérios específicos devem ser auto-aprovadas sem intervenção humana.

**Regras Configuráveis**:
- Colaborador veterano (>1 ano de empresa)
- Valor baixo (custo estimado < R$ 500)
- Serviço não-crítico (categoria não marcada como "crítica")
- Histórico positivo (usuário com >10 solicitações concluídas sem incidentes)

**Critério de Aceite**:
- Aprovação automática é registrada com `Fl_Auto_Aprovacao = 1`
- Campo `Regra_Auto_Aprovacao` armazena nome da regra aplicada
- Auditoria completa para compliance

---

### RN-RF021-009: Avaliação de Serviço Obrigatória

**Descrição**: Após conclusão da solicitação, usuário deve avaliar o serviço prestado (nota 1-5 estrelas + comentário opcional).

**Solicitação de Avaliação**:
- Push notification imediatamente após conclusão
- E-mail após 24 horas se não avaliar
- Modal no sistema após 48 horas (bloqueia navegação até avaliar)

**Critério de Aceite**:
- Campo `Avaliacao_Media` na tabela `Servico_Catalogo` atualizado automaticamente
- Serviços com avaliação média < 3.0 por 3 meses consecutivos sinalizados ao gestor
- Comentários negativos geram ticket de melhoria automático

---

### RN-RF021-010: Limite de Solicitações Simultâneas

**Descrição**: Usuário pode ter no máximo 5 solicitações com status `Pendente` ou `Em_Atendimento` simultaneamente.

**Exceção**: Usuários com perfil "Gestor" ou "Diretor" podem ter até 20 solicitações simultâneas.

**Critério de Aceite**:
- Ao atingir limite, exibir mensagem: "Você possui 5 solicitações pendentes. Aguarde conclusão ou cancele uma para criar nova."
- Validação server-side para evitar burlar via API

---

### RN-RF021-011: Cancelamento de Solicitação

**Descrição**: Solicitações podem ser canceladas pelo solicitante ou aprovador até o início do atendimento.

**Restrições**:
- Não pode cancelar após `Dt_Inicio_Atendimento` (status `Em_Atendimento`)
- Cancelamento requer justificativa obrigatória (mínimo 20 caracteres)
- Aprovador pode cancelar a qualquer momento (inclui solicitações em atendimento)

**Critério de Aceite**:
- Atualizar `Status = 'Cancelada'`
- Registrar `Dt_Cancelamento`, `Id_Usuario_Cancelamento`, `Motivo_Cancelamento`
- Liberar reserva de estoque (se aplicável)
- Notificar todos os aprovadores e atendentes envolvidos

---

### RN-RF021-012: Justificativa Obrigatória para Serviços Críticos

**Descrição**: Serviços marcados com `Fl_Requer_Justificativa = 1` exigem justificativa detalhada do solicitante.

**Validação**: Campo `Justificativa` deve ter mínimo 50 caracteres e máximo 1.000 caracteres.

**Exemplos de Serviços Críticos**:
- Linha internacional com roaming
- Equipamento high-end (notebook > R$ 8.000)
- Acesso administrativo a sistemas críticos
- Instalação de infraestrutura (cabeamento, rede)

**Critério de Aceite**:
- Aprovador visualiza justificativa em destaque antes de aprovar
- Justificativa é obrigatória no formulário de solicitação

---

### RN-RF021-013: Numeração Sequencial de Solicitações

**Descrição**: Cada solicitação deve ter número único sequencial no formato `SRV-YYYY-NNNNN`.

**Formato**:
- `SRV`: Prefixo fixo
- `YYYY`: Ano da solicitação (ex: 2025)
- `NNNNN`: Número sequencial com 5 dígitos zero-filled (ex: 00001, 00042, 01234)

**Exemplo**: `SRV-2025-00042` (42ª solicitação de 2025)

**Critério de Aceite**:
- Número gerado via sequence no SQL Server (garantia de unicidade e concorrência segura)
- Contador reinicia em 00001 a cada ano novo

---

### RN-RF021-014: Notificações em Cada Etapa do Workflow

**Descrição**: Todos os stakeholders (solicitante, aprovadores, atendentes) devem receber notificações em cada mudança de status.

**Eventos Notificados**:
- Solicitação criada
- Aguardando aprovação (notificar aprovador)
- Aprovada (notificar solicitante + atendente)
- Rejeitada (notificar solicitante com motivo)
- Em atendimento (notificar solicitante)
- Concluída (notificar solicitante + solicitar avaliação)
- SLA em risco (notificar atendente + gestor)
- Cancelada (notificar todos os envolvidos)

**Critério de Aceite**:
- Canais: E-mail + Push Notification + Notificação In-App
- Respeitar preferências do usuário (pode optar por não receber alguns tipos)

---

### RN-RF021-015: Analytics de Demanda para Gestão

**Descrição**: Sistema deve gerar métricas e analytics de demanda para tomada de decisão.

**Métricas Disponíveis**:
- Serviços mais solicitados: Top 10 por quantidade
- SLA médio por categoria: Tempo médio de atendimento (Telecom, TI, Hardware)
- Taxa de aprovação: % de solicitações aprovadas vs rejeitadas
- Tempo médio de aprovação: Da solicitação até aprovação final
- Avaliação média por serviço: Identificar serviços problemáticos
- Gargalos: Serviços com SLA vencido frequente (>20% das solicitações)

**Critério de Aceite**:
- Dashboard com visualização gráfica em tempo real
- Filtros por período, categoria, status
- Exportação para Excel/PDF para apresentações executivas

---

## 6. ESTADOS DA ENTIDADE

### 6.1 Estados de Solicitação

| Estado | Descrição |
|--------|-----------|
| **Rascunho** | Solicitação iniciada mas não finalizada (ainda no carrinho) |
| **Pendente** | Aguardando aprovação (em algum nível do workflow) |
| **Aprovada** | Aprovação completa, aguardando início do atendimento |
| **Em_Atendimento** | Atendente iniciou provisionamento do serviço |
| **Aguardando_Estoque** | Aguardando reposição de item em falta |
| **Aguardando_Usuario** | Aguardando ação do usuário (fornecer informações, confirmar entrega) |
| **Em_Provisionamento** | Integração com fornecedor em andamento |
| **Concluida** | Serviço entregue com sucesso |
| **Cancelada** | Solicitação cancelada pelo usuário ou aprovador |
| **Rejeitada** | Reprovada por algum aprovador do workflow |
| **Erro_Provisionamento** | Falha na integração com fornecedor |

### 6.2 Transições Permitidas

| De | Para |
|----|------|
| Rascunho | Pendente |
| Pendente | Aprovada, Rejeitada, Cancelada |
| Aprovada | Em_Atendimento, Aguardando_Estoque, Cancelada |
| Em_Atendimento | Em_Provisionamento, Aguardando_Usuario, Concluida, Erro_Provisionamento, Cancelada (apenas aprovador) |
| Aguardando_Estoque | Em_Atendimento, Cancelada |
| Aguardando_Usuario | Em_Atendimento, Cancelada |
| Em_Provisionamento | Concluida, Erro_Provisionamento |
| Erro_Provisionamento | Em_Atendimento |

### 6.3 Transições Proibidas

| De | Para | Motivo |
|----|------|--------|
| Concluida | Qualquer outro | Solicitação já finalizada (irreversível) |
| Rejeitada | Qualquer outro | Solicitação reprovada (usuário deve criar nova) |
| Cancelada | Qualquer outro | Cancelamento é definitivo |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando Ocorre | Quem é Notificado |
|--------|---------------|-------------------|
| `SolicitacaoCriada` | Após finalizar carrinho | Solicitante + Aprovador Nível 1 |
| `SolicitacaoAprovada` | Após aprovação final | Solicitante + Atendente |
| `SolicitacaoRejeitada` | Quando aprovador rejeita | Solicitante |
| `SolicitacaoCancelada` | Quando usuário/aprovador cancela | Todos os envolvidos |
| `SLAEmRisco` | Quando entrar em "vermelho" | Atendente + Gestor |
| `SolicitacaoConcluida` | Após atendente marcar como concluída | Solicitante (com solicitação de avaliação) |
| `AvaliacaoRecebida` | Usuário avalia serviço | Atendente + Gestor do catálogo |
| `ErroProvisionamento` | Falha na integração com fornecedor | Atendente |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant (usuários veem apenas solicitações de sua empresa)
- Nenhuma regra de negócio pode ser ignorada (todas devem ser validadas server-side)
- Erros devem ser previsíveis e rastreáveis (auditoria completa)
- Auditoria deve registrar quem, quando e o que mudou em cada solicitação
- SLA deve ser calculado corretamente considerando dias úteis e horário comercial
- Notificações devem ser enviadas em tempo real (latência máxima 30 segundos)
- Dashboard de analytics deve carregar em menos de 2 segundos (cache obrigatório)
- Formulários dinâmicos devem renderizar em menos de 1 segundo

---

## 9. SEGURANÇA

### 9.1 Validações Obrigatórias

- Validação de entrada obrigatória em todos os campos (XSS, SQL Injection)
- Proteção contra CSRF em todas as operações de escrita
- Sanitização de HTML em comentários e justificativas

### 9.2 Controle de Permissões

| Operação | Permissão Requerida |
|----------|---------------------|
| Listar catálogo | `SERVICO.CATALOGO.VIEW` |
| Criar solicitação própria | `SERVICO.SOLICITAR` |
| Criar solicitação para terceiro | `SERVICO.SOLICITAR_TERCEIROS` |
| Aprovar solicitação | `SERVICO.APROVAR` |
| Atender solicitação | `SERVICO.ATENDER` |
| Cancelar solicitação em atendimento | `SERVICO.CANCELAR_FORCADO` |
| Visualizar analytics | `SERVICO.ANALYTICS.VIEW` |
| Configurar catálogo | `SERVICO.CATALOGO.MANAGE` |

### 9.3 Isolamento Multi-Tenant

- Usuários só podem ver e solicitar serviços do catálogo de sua empresa
- Aprovadores só podem aprovar solicitações de sua empresa
- Atendentes só podem atender solicitações de empresas sob sua responsabilidade
- Analytics segmentado por empresa (tenant)

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF021.md** - Casos de Uso detalhados
- **MD-RF021.md** - Modelo de Dados (entidades, relacionamentos, DDL)
- **WF-RF021.md** - Wireframes e fluxos de tela
- **TC-RF021-BACKEND.yaml** - Casos de Teste Backend
- **TC-RF021-FRONTEND.yaml** - Casos de Teste Frontend
- **TC-RF021-E2E.yaml** - Casos de Teste End-to-End
- **TC-RF021-SEGURANCA.yaml** - Casos de Teste de Segurança

---

## 11. METADADOS E CHANGELOG

### Rastreabilidade

| Artefato | Status | Localização |
|----------|--------|-------------|
| RF-021.md | ✅ v2.0 Completo | `docs/rf/Fase-5-Service-Desk/EPIC008-SD-Service-Desk/RF021-Catalogo-de-Servicos/` |
| UC-RF021.md | ✅ Completo | `docs/rf/Fase-5-Service-Desk/EPIC008-SD-Service-Desk/RF021-Catalogo-de-Servicos/` |
| MD-RF021.md | ✅ Completo | `docs/rf/Fase-5-Service-Desk/EPIC008-SD-Service-Desk/RF021-Catalogo-de-Servicos/` |
| WF-RF021.md | ✅ Completo | `docs/rf/Fase-5-Service-Desk/EPIC008-SD-Service-Desk/RF021-Catalogo-de-Servicos/` |

### Histórico de Versões

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0 com separação estrita RF/RL (CONTRATO-RF-PARA-RL) | Agência ALC - alc.dev.br |
| 1.0 | 2025-11-03 | Versão inicial com conteúdo legado misturado | Equipe Arquitetura IControlIT |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-30 | Separação estrita RF/RL - RF agora contém APENAS contrato funcional moderno (sem referências ao legado VB.NET/ASPX) | Agência ALC - alc.dev.br |
| 1.0 | 2025-11-03 | Versão inicial com documentação completa (incluía seções de legado) | Equipe Arquitetura IControlIT v2 |

---

**Documento Validado**: ✅ Governança v2.0
**Próximos Passos**: Criar UC-RF021.md, MD-RF021.md, WF-RF021.md
**Referência ao Legado**: Consultar `RL-RF021.md` para memória técnica do sistema antigo
