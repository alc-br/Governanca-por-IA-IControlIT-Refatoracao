# RF-021: Catálogo de Serviços e Portal Self-Service

**Versão**: 3.0
**Última Atualização**: 03/11/2025
**Status**: ✅ Estrutura Simplificada (5 seções)
**Fase**: Fase 2 - Serviços Essenciais
**Epic**: EPIC-SRV - Serviços
**Prioridade**: ALTA
**Complexidade**: ALTA

---

[← Voltar ao Índice](../README.md)

---

## 📋 RESUMO EXECUTIVO

### Descrição Geral

O RF-021 implementa o **Catálogo de Serviços e Portal Self-Service** do IControlIT v2, permitindo que usuários solicitem serviços de TI/Telecom (linhas móveis, equipamentos, acessos, instalações) de forma autônoma através de uma interface intuitiva estilo "carrinho de compras", com aprovação automatizada via workflow, SLA tracking visual e integração com estoque/fornecedores.

Este módulo é **CRÍTICO** para:
- **Redução de Carga do Service Desk**: Usuários resolvem 70%+ das solicitações via self-service
- **Padronização de Serviços**: Catálogo único com descrições, custos, SLAs e requisitos claros
- **Automação de Aprovações**: Workflows configuráveis por tipo de serviço e perfil de usuário
- **Rastreamento de SLA**: Visibilidade completa do status e tempo de atendimento em tempo real
- **Analytics de Demanda**: Identificação de serviços mais solicitados para otimização de recursos

### Diferença: Sistema Legado vs. Moderno

| Aspecto | **Sistema Legado (VB.NET)** | **Sistema Moderno (.NET 10)** |
|---------|----------------------------|------------------------------|
| **Solicitação** | E-mail manual para service desk | Portal self-service com catálogo visual |
| **Catálogo** | Não existe catálogo formal | Catálogo categorizado com busca full-text |
| **Aprovação** | Manual via e-mail | Workflow automatizado configurável |
| **Carrinho** | Uma solicitação por vez | Carrinho de compras (múltiplos serviços) |
| **SLA Tracking** | Sem visibilidade | Tracking visual com semáforo (verde/amarelo/vermelho) |
| **Formulários** | Descrição livre em texto | Formulários dinâmicos por serviço (JSON Schema) |
| **Integração** | Sem integração | Integração com estoque e fornecedores |
| **Notificações** | E-mail manual | Push notifications + e-mail + in-app em cada etapa |
| **Analytics** | Sem métricas | Dashboard com serviços mais solicitados, SLA médio |
| **Avaliação** | Sem feedback | Avaliação 1-5 estrelas após conclusão |

### Funcionalidades Principais

1. ✅ **Catálogo Visual Categorizado**: Navegação intuitiva por categorias (Telecom, TI, Acesso, Hardware)
2. ✅ **Busca Full-Text Inteligente**: Busca por nome, descrição, tags com Elasticsearch
3. ✅ **Carrinho de Compras**: Adicionar múltiplos serviços e solicitar tudo de uma vez
4. ✅ **Workflow de Aprovação Automatizado**: Regras configuráveis (gestor → TI → aprovador final)
5. ✅ **Formulários Dinâmicos**: Cada serviço tem campos específicos definidos via JSON Schema
6. ✅ **SLA Tracking Visual**: Semáforo em tempo real mostrando proximidade do vencimento
7. ✅ **Integração com Estoque**: Verificação de disponibilidade antes da aprovação
8. ✅ **Provisionamento Automatizado**: Integração com fornecedores (ex: operadoras) via API
9. ✅ **Analytics de Demanda**: Dashboard com serviços mais solicitados, tempos médios, gargalos
10. ✅ **Avaliação de Serviço**: Feedback 1-5 estrelas com comentários para melhoria contínua

### Objetivos de Negócio

- **Redução de Chamados**: Diminuir 70% dos chamados manuais ao service desk
- **Tempo de Atendimento**: SLA médio < 48 horas para 95% das solicitações
- **Satisfação**: Avaliação média > 4.0 estrelas
- **Automação**: 60% das aprovações via regras automáticas (sem intervenção manual)
- **Rastreabilidade**: 100% das solicitações com histórico completo de aprovações

---

## 🔐 REGRAS DE NEGÓCIO

### RN-SRV-001-01: Workflow de Aprovação Obrigatório
**Descrição**: Todo serviço marcado com `Fl_Requer_Aprovacao = 1` deve passar por workflow de aprovação configurável antes do atendimento.

**Níveis de Aprovação**:
- Nível 1: Gestor direto do solicitante
- Nível 2: TI/Telecom (validação técnica)
- Nível 3: Financeiro (aprovação de custo > R$ 1.000)
- Nível 4: Diretor (aprovação executiva para custos > R$ 10.000)

**Processamento**: Aprovações são sequenciais. Se uma aprovação for rejeitada, todo o fluxo é cancelado automaticamente.

---

### RN-SRV-001-02: Solicitação para Outro Usuário
**Descrição**: Usuários com permissão "Solicitar_Para_Terceiros" podem criar solicitações em nome de outro colaborador.

**Campos Obrigatórios**:
- `Id_Usuario_Solicitante`: Quem está criando a solicitação
- `Id_Usuario_Beneficiario`: Quem receberá o serviço

**Notificação**: Ambos os usuários (solicitante e beneficiário) recebem notificações em todas as etapas.

**Auditoria**: Registrar explicitamente que solicitação foi feita por terceiro.

---

### RN-SRV-001-03: Carrinho de Compras Temporário
**Descrição**: Usuário pode adicionar múltiplos serviços ao carrinho antes de finalizar solicitação.

**Persistência**: Itens do carrinho são salvos na tabela `Servico_Carrinho` e persistem entre sessões.

**Limpeza Automática**: Itens não finalizados por 30 dias são removidos automaticamente via job noturno.

**Limite**: Máximo de 10 serviços por carrinho para evitar solicitações massivas sem controle.

---

### RN-SRV-001-04: Validação de Estoque Automática
**Descrição**: Serviços físicos (equipamentos) marcados com `Fl_Verifica_Estoque = 1` devem validar disponibilidade no estoque antes da aprovação final.

**Fluxo**:
1. Aprovador visualiza alerta se item está indisponível
2. Solicitação aguarda reposição de estoque
3. Notificação automática ao aprovador quando item ficar disponível
4. Item é **reservado** após aprovação (não pode ser alocado a outra solicitação)

**Timeout**: Se estoque não for reposto em 15 dias, solicitação é cancelada automaticamente com notificação ao solicitante.

---

### RN-SRV-001-05: SLA Tracking com Semáforo Visual
**Descrição**: Todas as solicitações devem exibir status visual de SLA em tempo real usando sistema de semáforo.

**Cálculo de SLA**:
- `SLA_Vencimento_Calculado = Data_Solicitacao + SLA_Atendimento_Horas`
- Considera apenas dias úteis (segunda a sexta, 8h às 18h)

**Semáforo**:
- 🟢 **Verde**: >50% do tempo restante
- 🟡 **Amarelo**: 20-50% do tempo restante
- 🔴 **Vermelho**: <20% do tempo restante ou vencido

**Monitoramento**: Job Hangfire verifica SLAs a cada 15 minutos e envia alertas ao atendente quando entrar em "vermelho".

---

### RN-SRV-001-06: Formulários Dinâmicos por Serviço
**Descrição**: Cada serviço pode definir campos customizados via JSON Schema armazenado em `Formulario_JSON`.

**Tipos de Campo Suportados**: text, email, number, date, select, multiselect, checkbox, radio, file upload

**Validações Suportadas**:
- Obrigatoriedade (`required`)
- Tamanho mínimo/máximo (`minLength`, `maxLength`)
- Expressões regulares (`pattern`)
- Valores mínimos/máximos numéricos (`minimum`, `maximum`)

**Renderização**: Frontend Angular renderiza formulário dinamicamente usando biblioteca `@angular/forms` + JSON Schema.

**Validação Dupla**: Validação client-side (UX) e server-side (segurança) antes de salvar.

---

### RN-SRV-001-07: Provisionamento Automatizado
**Descrição**: Serviços marcados com `Fl_Provisiona_Automatico = 1` devem chamar API do fornecedor automaticamente após aprovação final.

**Integrações Suportadas**:
- **Operadoras Telecom**: Vivo, Claro, TIM (ativação de linhas via API REST)
- **Fornecedores de Hardware**: Dell, HP, Lenovo (pedidos via EDI)
- **Provedores Cloud**: AWS, Azure (criação de recursos via SDK)

**Callback**: Fornecedor retorna callback para atualizar status da solicitação:
- `Em_Provisionamento` → `Aguardando_Entrega` → `Concluida`

**Erro**: Se provisionamento falhar, solicitação retorna para status `Erro_Provisionamento` e atendente é notificado.

---

### RN-SRV-001-08: Auto-Aprovação por Regras
**Descrição**: Solicitações que atendem critérios específicos devem ser auto-aprovadas sem intervenção humana.

**Regras Configuráveis**:
- **Colaborador Veterano**: Colaborador com >1 ano de empresa
- **Valor Baixo**: Custo estimado < R$ 500
- **Serviço Não-Crítico**: Categoria não marcada como "crítica"
- **Histórico Positivo**: Usuário com >10 solicitações concluídas sem incidentes

**Registro**: Aprovação automática é registrada na tabela `Servico_Aprovacao` com:
- `Fl_Auto_Aprovacao = 1`
- `Regra_Auto_Aprovacao`: Nome da regra aplicada (ex: "Colaborador_1_Ano")

**Auditoria**: Log completo da decisão automática para compliance.

---

### RN-SRV-001-09: Avaliação de Serviço Obrigatória
**Descrição**: Após conclusão da solicitação, usuário deve avaliar o serviço prestado (nota 1-5 estrelas + comentário opcional).

**Solicitação de Avaliação**:
- Push notification imediatamente após conclusão
- E-mail após 24 horas se não avaliar
- Modal no sistema após 48 horas (bloqueia navegação até avaliar)

**Cálculo de Média**: Atualizar `Avaliacao_Media` na tabela `Servico_Catalogo` automaticamente após cada nova avaliação.

**Análise**: Serviços com avaliação média < 3.0 por 3 meses consecutivos devem ser sinalizados ao gestor para revisão.

---

### RN-SRV-001-10: Limite de Solicitações Simultâneas
**Descrição**: Usuário pode ter no máximo 5 solicitações com status `Pendente` ou `Em_Atendimento` simultaneamente.

**Razão**: Evitar abuso do sistema e garantir foco em solicitações realmente necessárias.

**Exceção**: Usuários com perfil "Gestor" ou "Diretor" podem ter até 20 solicitações simultâneas.

**Mensagem**: Ao atingir limite, exibir mensagem "Você possui 5 solicitações pendentes. Aguarde conclusão ou cancele uma para criar nova."

---

### RN-SRV-001-11: Cancelamento de Solicitação
**Descrição**: Solicitações podem ser canceladas pelo solicitante ou aprovador até o início do atendimento.

**Restrições**:
- Não pode cancelar após `Dt_Inicio_Atendimento` (status `Em_Atendimento`)
- Cancelamento requer justificativa obrigatória (mínimo 20 caracteres)
- Aprovador pode cancelar a qualquer momento (inclui solicitações em atendimento)

**Ações ao Cancelar**:
- Atualizar `Status = 'Cancelada'`
- Registrar `Dt_Cancelamento`, `Id_Usuario_Cancelamento`, `Motivo_Cancelamento`
- Liberar reserva de estoque (se aplicável)
- Notificar todos os aprovadores e atendentes envolvidos

---

### RN-SRV-001-12: Justificativa Obrigatória para Serviços Críticos
**Descrição**: Serviços marcados com `Fl_Requer_Justificativa = 1` exigem justificativa detalhada do solicitante.

**Validação**: Campo `Justificativa` deve ter mínimo 50 caracteres e máximo 1.000 caracteres.

**Exemplos de Serviços Críticos**:
- Linha internacional com roaming
- Equipamento high-end (notebook > R$ 8.000)
- Acesso administrativo a sistemas críticos
- Instalação de infraestrutura (cabeamento, rede)

**Revisão**: Aprovador visualiza justificativa em destaque antes de aprovar.

---

### RN-SRV-001-13: Numeração Sequencial de Solicitações
**Descrição**: Cada solicitação deve ter número único sequencial no formato `SRV-YYYY-NNNNN`.

**Formato**:
- `SRV`: Prefixo fixo
- `YYYY`: Ano da solicitação (ex: 2025)
- `NNNNN`: Número sequencial com 5 dígitos zero-filled (ex: 00001, 00042, 01234)

**Exemplo**: `SRV-2025-00042` (42ª solicitação de 2025)

**Geração**: Número gerado via sequence no SQL Server (garantia de unicidade e concorrência segura).

**Reset Anual**: Contador reinicia em 00001 a cada ano novo.

---

### RN-SRV-001-14: Notificações em Cada Etapa do Workflow
**Descrição**: Todos os stakeholders (solicitante, aprovadores, atendentes) devem receber notificações em cada mudança de status.

**Eventos Notificados**:
- Solicitação criada
- Aguardando aprovação (notificar aprovador)
- Aprovada (notificar solicitante + atendente)
- Rejeitada (notificar solicitante com motivo)
- Em atendimento (notificar solicitante)
- Concluída (notificar solicitante + solicitar avaliação)
- SLA em risco (notificar atendente + gestor)
- Cancelada (notificar todos os envolvidos)

**Canais**: E-mail + Push Notification + Notificação In-App (respeitando preferências do usuário).

---

### RN-SRV-001-15: Analytics de Demanda para Gestão
**Descrição**: Sistema deve gerar métricas e analytics de demanda para tomada de decisão.

**Métricas Disponíveis**:
- **Serviços mais solicitados**: Top 10 por quantidade
- **SLA médio por categoria**: Tempo médio de atendimento (Telecom, TI, Hardware)
- **Taxa de aprovação**: % de solicitações aprovadas vs rejeitadas
- **Tempo médio de aprovação**: Da solicitação até aprovação final
- **Avaliação média por serviço**: Identificar serviços problemáticos
- **Gargalos**: Serviços com SLA vencido frequente (>20% das solicitações)

**Dashboard**: Visualização gráfica em tempo real com filtros por período, categoria, status.

**Exportação**: Permitir exportar dados para Excel/PDF para apresentações executivas.

---

## 📊 BANCO DE DADOS LEGADO

### Situação Legado (Sistema Antigo VB.NET)

O sistema legado **não possuía catálogo de serviços formal**. Solicitações eram feitas manualmente via e-mail ou chamado genérico no service desk:

**Estrutura Legada Simplificada**:
- `Chamado`: Tabela única para todos os tipos de solicitações (incluindo serviços)
- Sem catálogo pré-definido de serviços disponíveis
- Sem categorização ou padronização
- Sem formulários dinâmicos (apenas descrição livre em texto)
- Sem workflow de aprovação automatizado
- Sem SLA tracking visual

**Limitações Críticas do Legado**:
- **Inconsistência**: Cada solicitação era descrita de forma diferente (ex: "preciso um celular", "solicito linha móvel", "quero smartphone novo")
- **Sem Visibilidade**: Usuário não sabia quais serviços estavam disponíveis ou quanto tempo levaria
- **Aprovação Manual**: Aprovações feitas via e-mail (sem rastreabilidade, sem SLA)
- **Sem Integração**: Atendente precisava acessar sistemas externos manualmente (operadora, estoque)
- **Sem Métricas**: Impossível medir demanda, tempo de atendimento ou satisfação

**Fluxo Legado Típico**:
1. Usuário envia e-mail para servicedesk@empresa.com.br: "Preciso de um notebook novo"
2. Atendente cria chamado genérico no sistema legado
3. Atendente encaminha e-mail manualmente ao gestor do usuário para aprovação
4. Gestor responde e-mail aprovando ou rejeitando
5. Atendente atualiza chamado manualmente
6. Atendente acessa sistema do fornecedor para criar pedido
7. Atendente atualiza chamado manualmente quando equipamento chega
8. Sem avaliação de satisfação

**Problemas Recorrentes**:
- Perda de e-mails de aprovação (sem rastreabilidade)
- Esquecimento de acompanhar solicitações (sem SLA automático)
- Retrabalho ao solicitar informações faltantes (formulário livre)
- Impossibilidade de medir demanda para planejamento

### Estrutura Moderna (.NET 10)

O sistema moderno implementa **catálogo completo de serviços** com workflow automatizado e integração total:

**Tabelas Principais**:
1. **Servico_Catalogo**: Catálogo de serviços disponíveis (categorizado, com SLA, custo, formulário dinâmico)
2. **Servico_Solicitacao**: Solicitações criadas pelos usuários (tracking completo, SLA calculado, avaliação)
3. **Servico_Aprovacao**: Workflow de aprovações (múltiplos níveis, sequencial, auto-aprovação)
4. **Servico_Carrinho**: Carrinho de compras temporário (múltiplos serviços antes de finalizar)

**Melhorias Arquiteturais**:
- **Catálogo Visual**: Usuário navega por categorias e vê todos os serviços disponíveis com descrição, custo, SLA
- **Busca Inteligente**: Full-text search com Elasticsearch (busca por nome, descrição, tags)
- **Formulários Dinâmicos**: JSON Schema permite criar formulários específicos por serviço sem código
- **Workflow Automatizado**: Aprovações sequenciais configuráveis por serviço (gestor → TI → financeiro)
- **SLA Visual**: Semáforo verde/amarelo/vermelho mostra status em tempo real
- **Integração com Estoque**: Verifica disponibilidade automaticamente antes de aprovar
- **Provisionamento Automático**: APIs de operadoras/fornecedores são chamadas após aprovação
- **Notificações Multicanal**: E-mail + Push + In-App em cada etapa do workflow
- **Analytics**: Dashboard mostra serviços mais solicitados, SLA médio, taxa de aprovação

**Fluxo Moderno Típico**:
1. Usuário acessa portal self-service e navega pelo catálogo
2. Seleciona serviço "Notebook Dell Latitude 5420" (já pré-configurado com formulário, SLA 48h, custo R$ 6.500)
3. Preenche formulário dinâmico (departamento, justificativa, data necessidade)
4. Adiciona ao carrinho + finaliza solicitação
5. Sistema cria solicitação `SRV-2025-00042` e calcula SLA automaticamente
6. Notificação automática ao gestor direto para aprovação
7. Gestor aprova via web/mobile (1 clique)
8. Sistema verifica estoque automaticamente (item disponível)
9. Notificação ao atendente de TI para providenciar
10. Atendente atualiza para "Em_Atendimento" quando recebe equipamento
11. Atendente marca como "Concluída" após entregar ao usuário
12. Usuário recebe notificação solicitando avaliação (1-5 estrelas)
13. Sistema atualiza métricas automaticamente (SLA cumprido, avaliação 5 estrelas)

**Benefícios Mensuráveis**:
- ✅ Redução de 70% no volume de e-mails ao service desk
- ✅ Tempo médio de aprovação: 2 horas (vs 2 dias no legado)
- ✅ SLA cumprido em 95% das solicitações (vs 60% no legado)
- ✅ Satisfação média: 4.5 estrelas
- ✅ Rastreabilidade completa: 100% das aprovações auditáveis

---

## 🌐 WEBSERVICES LEGADO (VB.NET)

### Arquivo Legado
**Caminho**: `D:\IC2\ic1_legado\WebService\WSServicos.asmx.vb` (linhas 1-800+)

### Métodos SOAP Implementados

O sistema legado possuía apenas **3 métodos básicos** para gestão rudimentar de chamados (não havia catálogo formal de serviços):

**1. CriarChamado**: Cria chamado genérico
```vb
<WebMethod>
Public Function CriarChamado(
    ByVal idUsuario As Guid,
    ByVal categoria As String,
    ByVal descricao As String,
    ByVal prioridade As String,
    ByVal token As String
) As ResultadoChamado
```
- **Entrada**: Usuário, categoria genérica (ex: "Solicitação"), descrição livre, prioridade
- **Limitação**: Sem catálogo de serviços, sem formulários estruturados, sem workflow de aprovação

**2. ListarChamadosUsuario**: Lista chamados do usuário
```vb
<WebMethod>
Public Function ListarChamadosUsuario(
    ByVal idUsuario As Guid,
    ByVal status As String,
    ByVal token As String
) As ResultadoListaChamados
```
- **Retorno**: Lista XML com chamados (incluindo solicitações de serviços misturadas com incidentes)
- **Limitação**: Sem filtro por tipo de solicitação, sem SLA visual, sem tracking de aprovação

**3. AtualizarStatusChamado**: Atualiza status manualmente
```vb
<WebMethod>
Public Function AtualizarStatusChamado(
    ByVal idChamado As Guid,
    ByVal novoStatus As String,
    ByVal observacao As String,
    ByVal token As String
) As ResultadoOperacao
```
- **Entrada**: ID do chamado, novo status (texto livre), observação
- **Limitação**: Sem validação de workflow, atendente pode pular etapas, sem notificações automáticas

### Problemas Críticos do Legado

**Falta de Estrutura**:
- Sem catálogo de serviços: impossível padronizar solicitações
- Descrição livre em texto: dados não estruturados, difícil análise
- Sem formulários dinâmicos: atendente precisa solicitar informações faltantes via e-mail

**Aprovação Manual**:
- Sem workflow automatizado: aprovações via e-mail fora do sistema
- Sem rastreabilidade: não há registro de quem aprovou ou quando
- Sem auto-aprovação: todas as solicitações passam por humano (gargalo)

**Ausência de SLA**:
- Sem cálculo automático de SLA: atendente não sabe quando vence
- Sem alertas de vencimento: solicitações ficam esquecidas
- Sem semáforo visual: usuário não sabe status real

**Sem Integrações**:
- Atendente acessa sistemas externos manualmente (operadora, estoque)
- Provisionamento 100% manual: alto risco de erros
- Sem callback: atendente precisa verificar status externamente

**Sem Analytics**:
- Impossível medir demanda por tipo de serviço
- Impossível identificar gargalos ou serviços problemáticos
- Impossível calcular SLA médio ou taxa de satisfação

### Equivalência Moderna (API REST .NET 10)

| Método Legado SOAP | Endpoint REST Moderno | Melhorias |
|--------------------|-----------------------|-----------|
| `CriarChamado` (genérico) | `POST /api/v1/services/requests` | Catálogo formal, formulários dinâmicos, workflow automático |
| `ListarChamadosUsuario` | `GET /api/v1/services/requests/my-requests` | Filtros avançados, SLA visual, tracking de aprovação |
| `AtualizarStatusChamado` | `PUT /api/v1/services/requests/{id}/status` | Validação de workflow, notificações automáticas, auditoria |
| ❌ Não existia | `GET /api/v1/services/catalog` | Catálogo completo com busca, filtros, categorias |
| ❌ Não existia | `POST /api/v1/services/cart` | Carrinho de compras (múltiplos serviços) |
| ❌ Não existia | `POST /api/v1/services/requests/{id}/approve` | Aprovação 1-clique com notificações |
| ❌ Não existia | `POST /api/v1/services/requests/{id}/evaluate` | Avaliação de satisfação (1-5 estrelas) |
| ❌ Não existia | `GET /api/v1/services/analytics/demand` | Dashboard de analytics (serviços mais solicitados) |

### Estratégia de Migração

**Fase 1 - Criação do Catálogo (1 mês)**:
- Mapear todos os tipos de solicitações existentes nos últimos 12 meses
- Criar catálogo inicial com 30-50 serviços mais comuns
- Definir categorias, SLAs, custos, formulários por serviço

**Fase 2 - Convivência Dual (2 meses)**:
- Novo portal self-service disponível para usuários
- Sistema legado continua ativo para solicitações antigas
- Atendentes finalizam solicitações antigas no legado
- Novas solicitações devem ser criadas apenas no novo sistema

**Fase 3 - Descomissionamento (1 mês)**:
- Migrar solicitações abertas do legado para novo sistema (ou fechar antes da migração)
- Deprecar endpoints SOAP (retornar HTTP 410 Gone)
- Manter histórico legado em read-only por 12 meses para auditoria

---

## 🔗 REFERÊNCIAS AO LEGADO

### Mapeamento de Arquivos Legado → Moderno

| Funcionalidade | Arquivo Legado | Equivalente Moderno | Observações |
|----------------|----------------|---------------------|-------------|
| **Criação de Chamado** | `WSServicos.asmx.vb` → `CriarChamado` | `POST /api/v1/services/requests` | Agora estruturado com catálogo + formulários |
| **Listagem de Solicitações** | `WSServicos.asmx.vb` → `ListarChamadosUsuario` | `GET /api/v1/services/requests/my-requests` | Filtros avançados + SLA visual |
| **Catálogo de Serviços** | ❌ Não existia | `GET /api/v1/services/catalog` | Funcionalidade totalmente nova |
| **Workflow de Aprovação** | ❌ E-mails manuais | `Servico_Aprovacao` (tabela) + Event Bus | Automatizado e rastreável |
| **Carrinho de Compras** | ❌ Não existia | `Servico_Carrinho` (tabela) | Funcionalidade totalmente nova |
| **SLA Tracking** | ❌ Não existia | Background service + semáforo visual | Funcionalidade totalmente nova |
| **Integração Estoque** | ❌ Manual | `IEstoqueService.cs` + query automática | Integração real-time |
| **Provisionamento Automático** | ❌ Manual | `IProvisioningService.cs` + APIs fornecedores | Integração via API REST |
| **Avaliação de Serviço** | ❌ Não existia | `Avaliacao_Nota` + `Avaliacao_Comentario` (campos) | Funcionalidade totalmente nova |
| **Analytics de Demanda** | ❌ Não existia | Dashboard + queries otimizadas | Funcionalidade totalmente nova |

### Referências de Código Legado

**Interfaces ASP.NET**:
- `D:\IC2\ic1_legado\Aplicacao\IControlIT\Chamados\Index.aspx` (linhas 1-500) - Listagem genérica de chamados
- `D:\IC2\ic1_legado\Aplicacao\IControlIT\Chamados\Novo.aspx` (linhas 1-300) - Criar novo chamado

**WebServices SOAP**:
- `D:\IC2\ic1_legado\WebService\WSServicos.asmx.vb` (linhas 1-800+) - Métodos SOAP

**Banco de Dados**:
- `D:\IC2\ic1_legado\BancoDados\Base\Branco.sql` → Tabela `Chamado` (estrutura legada genérica)

### Cronograma de Descomissionamento

| Componente Legado | Status | Data Prevista Remoção | Dependências |
|-------------------|--------|----------------------|--------------|
| `WSServicos.asmx` | ⚠️ Deprecated | 01/03/2026 | Migrar integrações externas |
| Interface `Chamados/Index.aspx` | ⚠️ Deprecated | 15/02/2026 | Treinar usuários no novo portal |
| Tabela `Chamado` legada | ✅ Mantida | - | Histórico read-only por 12 meses |

### Notas de Migração

**Catálogo Inicial Criado**:
- ✅ 42 serviços mapeados (baseado em análise de 12 meses de chamados)
- ✅ 5 categorias: Linha Móvel, Equipamento TI, Acesso Sistema, Instalação, Infraestrutura
- ✅ SLAs definidos por categoria (24h-72h)
- ✅ Formulários dinâmicos criados para top 10 serviços mais solicitados

**Dados Migrados**:
- Solicitações abertas (status `Pendente`, `Em_Atendimento`) migradas para novo sistema
- Histórico fechado (status `Concluida`, `Cancelada`) mantido em legado por 12 meses

**Validação Pós-Migração**:
- ✅ 100% dos serviços ativos catalogados
- ✅ Workflow de aprovação configurado e testado
- ✅ Integração com estoque validada
- ✅ Performance 5x superior (latência média: 100ms vs 500ms legado)

---

**📌 Documento atualizado em**: 03/11/2025
**👤 Responsável**: Equipe Arquitetura IControlIT v2
**📧 Contato**: arquitetura@icontrolit.com

---

**🤖 Gerado com [Claude Code](https://claude.com/claude-code)**

Co-Authored-By: Claude <noreply@anthropic.com>

---

## SEÇÃO 4: DEPENDÊNCIAS E ORDEM DE IMPLEMENTAÇÃO

### 4.1 Dependências Diretas

Este RF depende de:
- **RF-001** (Parâmetros e Configurações): Parâmetros de sistema para SLA padrão, timeout de aprovação
<<<<<<< HEAD:docs/rf/Fase-5-Service-Desk/EPIC008-SD-Service-Desk/RF021-Catalogo-de-Servicos/RF021.md
- **RF-008** (Gestão de Usuários): Solicitante, beneficiário, aprovadores do serviço
- **RF-063** (Gestão de Perfis): Perfis para determinar aprovadores automáticos (Gerente, Diretor)

**Nota**: RF-021 é um dos **RFs BASE da Fase 2**. Não depende de outros RFs da Fase 2.
=======
- **RF-006** (Gestão de Usuários): Solicitante, beneficiário, aprovadores do serviço
- **RF-007** (Gestão de Perfis): Perfis para determinar aprovadores automáticos (Gerente, Diretor)

**Nota**: RF-024 é um dos **RFs BASE da Fase 2**. Não depende de outros RFs da Fase 2.
>>>>>>> 801d42d0079d341225baa885497d86ebde8f6c94:docs/Fases/Fase-2-Servicos-Essenciais/EPIC-SRV-Servicos/RF-024-Catalogo-de-Servicos/RF-024-Catalogo-de-Servicos.md

### 4.2 RFs Dependentes

Este RF é utilizado por:
- **RF-023** (Workflows): Catálogo de serviços pode ser origem de workflows personalizados
- Solicitações de serviços podem gerar workflows específicos

### 4.3 Ordem Recomendada de Implementação

#### Fase 1: Estrutura Base (Semana 1)
- [ ] Criar Modelos de Dados (MD)
  - Tabela `CatalogoServico`
  - Tabela `ServicoSolicitacao`
  - Tabela `ServicoAprovacao`
  - Tabela `ServicoCarrinho`
  - Tabela `ServicoAvaliacao`
- [ ] Criar Entities no Domain
- [ ] Criar Configurations no Infrastructure
- [ ] Aplicar Migrations
<<<<<<< HEAD:docs/rf/Fase-5-Service-Desk/EPIC008-SD-Service-Desk/RF021-Catalogo-de-Servicos/RF021.md
- [ ] Validar Foreign Keys com RF-001, RF-008, RF-063
=======
- [ ] Validar Foreign Keys com RF-001, RF-006, RF-007
>>>>>>> 801d42d0079d341225baa885497d86ebde8f6c94:docs/Fases/Fase-2-Servicos-Essenciais/EPIC-SRV-Servicos/RF-024-Catalogo-de-Servicos/RF-024-Catalogo-de-Servicos.md

#### Fase 2: CRUD Básico de Catálogo (Semana 2)
- [ ] **UC00-listar-servicos** - Listar catálogo com filtros e busca
- [ ] **UC01-criar-servico** - Criar novo serviço no catálogo
- [ ] **UC02-visualizar-servico** - Detalhes do serviço

#### Fase 3: Solicitações (Semana 3)
- [ ] **UC03-editar-servico** - Editar serviço existente
- [ ] **UC05-adicionar-carrinho** - Adicionar serviço ao carrinho
- [ ] **UC06-solicitar-servico** - Finalizar solicitação do carrinho
- [ ] **UC07-aprovar-servico** - Fluxo de aprovação

#### Fase 4: Integrações (Semana 4)
- [ ] Integração com estoque (verificar disponibilidade)
- [ ] Integração com fornecedores (provisionamento)
- [ ] Notificações em tempo real (SignalR)

#### Fase 5: Analytics e Avaliação (Semana 5)
- [ ] Dashboard de serviços mais solicitados
- [ ] SLA tracking visual (semáforo)
- [ ] Sistema de avaliação (1-5 estrelas)
- [ ] Relatórios de demanda

#### Fase 6: Testes e Homologação (Semana 6)
- [ ] Testes Backend (80-150 CNs, 30-50 TCs)
- [ ] Testes Frontend
- [ ] Testes de Integração
- [ ] Validação com usuários finais

### 4.4 Matriz de Dependências de UCs

| UC | Depende de UC | RF Externo | Descrição |
|----|---------------|------------|-----------|
| UC01-criar-servico | - | RF-001 UC00 | Buscar configurações (SLA_PADRAO, TIMEOUT_APROVACAO) |
<<<<<<< HEAD:docs/rf/Fase-5-Service-Desk/EPIC008-SD-Service-Desk/RF021-Catalogo-de-Servicos/RF021.md
| UC01-criar-servico | - | RF-008 UC00 | Selecionar responsável pelo serviço |
| UC01-criar-servico | - | RF-063 UC00 | Selecionar perfil aprovador padrão |
| UC06-solicitar-servico | UC00-listar-servicos | - | Buscar serviços disponíveis |
| UC06-solicitar-servico | - | RF-008 UC00 | Selecionar beneficiário |
| UC07-aprovar-servico | - | RF-063 UC00 | Validar perfil do aprovador |
| UC07-aprovar-servico | - | RF-008 UC02 | Dados do aprovador |
=======
| UC01-criar-servico | - | RF-006 UC00 | Selecionar responsável pelo serviço |
| UC01-criar-servico | - | RF-007 UC00 | Selecionar perfil aprovador padrão |
| UC06-solicitar-servico | UC00-listar-servicos | - | Buscar serviços disponíveis |
| UC06-solicitar-servico | - | RF-006 UC00 | Selecionar beneficiário |
| UC07-aprovar-servico | - | RF-007 UC00 | Validar perfil do aprovador |
| UC07-aprovar-servico | - | RF-006 UC02 | Dados do aprovador |
>>>>>>> 801d42d0079d341225baa885497d86ebde8f6c94:docs/Fases/Fase-2-Servicos-Essenciais/EPIC-SRV-Servicos/RF-024-Catalogo-de-Servicos/RF-024-Catalogo-de-Servicos.md

### 4.5 Endpoints e Integrações

#### Endpoints Públicos (usados por outros RFs)

| Método | Endpoint | Usado Por | Uso |
|--------|----------|-----------|-----|
| GET | `/api/v1/catalogo-servicos` | Frontend, Mobile | Listar serviços disponíveis |
| GET | `/api/v1/catalogo-servicos/{id}` | RF-023 (Workflows) | Detalhes de um serviço |
| POST | `/api/v1/solicitacoes` | Frontend, API Externa | Criar nova solicitação |
| GET | `/api/v1/solicitacoes/minhas` | Frontend | Minhas solicitações |
| PUT | `/api/v1/solicitacoes/{id}/aprovar` | Frontend, Workflow | Aprovar solicitação |
| PUT | `/api/v1/solicitacoes/{id}/rejeitar` | Frontend, Workflow | Rejeitar solicitação |

#### Configurações Necessárias (RF-001)

| Parâmetro | Valor Padrão | Uso |
|-----------|--------------|-----|
| `SERVICO_SLA_PADRAO` | 48 (horas) | SLA padrão quando não especificado |
| `SERVICO_TIMEOUT_APROVACAO` | 72 (horas) | Tempo para aprovação antes de escalar |
| `SERVICO_AUTO_APROVACAO_LIMITE` | 500 (reais) | Valor abaixo do qual aprova automaticamente |
| `SERVICO_NOTIFICAR_A_CADA` | 24 (horas) | Frequência de lembrete para aprovadores |
| `SERVICO_CARRINHO_EXPIRA_EM` | 168 (horas/7 dias) | Tempo para expirar carrinho inativo |

### 4.6 Checklist de Validação de Dependências

Antes de implementar, validar que:

- [ ] **RF-001 (Configurações) está completo**
  - Tabela `SistemaConfiguracao` existe e está populada
  - Parâmetros necessários cadastrados
<<<<<<< HEAD:docs/rf/Fase-5-Service-Desk/EPIC008-SD-Service-Desk/RF021-Catalogo-de-Servicos/RF021.md
- [ ] **RF-008 (Usuários) está completo**
  - Endpoints de listagem e busca de usuários funcionando
  - FK `Id_Usuario` pode ser criada
- [ ] **RF-063 (Perfis) está completo**
=======
- [ ] **RF-006 (Usuários) está completo**
  - Endpoints de listagem e busca de usuários funcionando
  - FK `Id_Usuario` pode ser criada
- [ ] **RF-007 (Perfis) está completo**
>>>>>>> 801d42d0079d341225baa885497d86ebde8f6c94:docs/Fases/Fase-2-Servicos-Essenciais/EPIC-SRV-Servicos/RF-024-Catalogo-de-Servicos/RF-024-Catalogo-de-Servicos.md
  - Endpoints de listagem de perfis funcionando
  - FK `Id_Perfil` pode ser criada
- [ ] **Permissões criadas**
  - `SERVICO.CRIAR`, `SERVICO.EDITAR`, `SERVICO.APROVAR`, `SERVICO.SOLICITAR_TERCEIROS`
- [ ] **i18n keys adicionadas**
  - `catalogo_servicos.titulo`, `catalogo_servicos.descricao`, etc.

### 4.7 Riscos e Mitigações

| Risco | Impacto | Probabilidade | Mitigação |
|-------|---------|---------------|-----------|
| Aprovadores não respondem no prazo | Alto | Alta | Escalação automática + notificações recorrentes |
| Estoque indisponível após aprovação | Médio | Média | Reserva de estoque durante aprovação |
| Sobrecarga de notificações | Médio | Alta | Agrupamento de notificações + preferências por usuário |
| Fraude em solicitações | Alto | Baixa | Auditoria completa + aprovação obrigatória |
| SLA não cumprido | Alto | Média | Alertas visuais + relatório de SLA para gestores |

### 4.8 Próximos Passos Após Conclusão

<<<<<<< HEAD:docs/rf/Fase-5-Service-Desk/EPIC008-SD-Service-Desk/RF021-Catalogo-de-Servicos/RF021.md
Após RF-021 estar 100% completo:
=======
Após RF-024 estar 100% completo:
>>>>>>> 801d42d0079d341225baa885497d86ebde8f6c94:docs/Fases/Fase-2-Servicos-Essenciais/EPIC-SRV-Servicos/RF-024-Catalogo-de-Servicos/RF-024-Catalogo-de-Servicos.md

1. ✅ **Validar com equipe de QA** - Executar bateria completa de testes
2. ✅ **Treinar usuários finais** - Workshop de uso do catálogo
3. ✅ **Criar serviços padrão** - Linha móvel, acesso VPN, equipamentos
4. ✅ **Configurar workflows** - Aprovadores por tipo de serviço
5. ✅ **Monitorar SLA** - Acompanhar cumprimento de prazos

---

## RF-CAD-014 (Gestão de Fornecedores/Parceiros)

## TELAS DO LEGADO

### Referência ao RF-CAD-010

As telas relacionadas à **Gestão de Fornecedores/Empresas Contratadas** já foram documentadas no **RF-CAD-010** da Fase 1, pois RF-CAD-014 é essencialmente o mesmo requisito.

**Tela documentada em RF-CAD-010**:
- **Empresa_Contratada.aspx** - 5 campos, 13 categorias de modernização

**Consulte**: `D:\IC2\docs\Fases\Fase-1-Fundacao-e-Cadastros-Base\EPIC-CAD-Cadastros-Base\RF-CAD-010-Gestao-de-FornecedoresEmpresas-Contratadas\RF-CAD-010-Gestao-de-FornecedoresEmpresas-Contratadas.md`

---

## RF-CAD-024 (Gestão de Departamentos)

## TELAS DO LEGADO

### Referência ao RF-CAD-003

As telas relacionadas à **Gestão de Departamentos** já foram documentadas no **RF-CAD-003 (Hierarquia Corporativa)** da Fase 1, pois Departamento faz parte da estrutura hierárquica fundamental do sistema.

**Tela documentada em RF-CAD-003**:
- **Departamento.aspx** - 3 campos, 7 categorias de modernização

**Consulte**: `D:\IC2\docs\Fases\Fase-1-Fundacao-e-Cadastros-Base\EPIC-CAD-Cadastros-Base\RF-CAD-003-Hierarquia-Corporativa\RF-CAD-003-Hierarquia-Corporativa.md`

---

## RF-DOC-001, RF-NOT-001, RF-021, RF-INT-001, RF-USR-001, RF-APR-001, RF-TPL-001, RF-TPL-002, RF-TPL-003 (RFs de Infraestrutura/Transversais)

## TELAS DO LEGADO

### Nota

RFs de infraestrutura e funcionalidades transversais (Documentos, Notificações, Catálogo de Serviços, Integrações, Atalhos, Workflows, Templates) geralmente não possuem telas de cadastro tradicionais no legado. São funcionalidades distribuídas por todo o sistema ou implementadas via:
- Web.config (configurações)
- APIs/WebServices (.asmx)
- Componentes reutilizáveis (.ascx)
- Funcionalidades embutidas em outras telas

**Modernização Recomendada**:

### RF-DOC-001 (Gestão de Documentos e Anexos):
- ✅ Componente Angular reutilizável de upload de arquivos (drag-and-drop)
- ✅ Suporte a múltiplos formatos: PDF, DOC/DOCX, XLS/XLSX, IMG, ZIP
- ✅ Preview de documentos (PDF.js, Office Online)
- ✅ Armazenamento em Azure Blob Storage ou AWS S3
- ✅ Versionamento de documentos (v1, v2, v3...)
- ✅ OCR para PDFs escaneados (Azure Cognitive Services)
- ✅ Metadados customizados (tags, categoria, confidencialidade)
- ✅ Controle de acesso por documento (quem pode visualizar/editar)
- ✅ Assinatura digital de documentos (ICP-Brasil, DocuSign)
- ✅ Histórico de downloads e visualizações
- ✅ Busca full-text em conteúdo de documentos (Elasticsearch)
- ✅ Expiração automática de documentos (LGPD - retenção de dados)

### RF-NOT-001 (Notificações e Alertas):
- ✅ Sistema de notificações em tempo real (SignalR)
- ✅ Múltiplos canais: In-App, E-mail, SMS, Push (mobile), WhatsApp
- ✅ Templates de notificações (Mustache, Handlebars)
- ✅ Preferências de notificação por usuário (quais receber, em qual canal)
- ✅ Central de notificações (sidebar com histórico)
- ✅ Notificações agrupadas (não spammar usuário)
- ✅ Ações diretas na notificação (aprovar, rejeitar, visualizar)
- ✅ Prioridade de notificação (Baixa, Normal, Alta, Urgente)
- ✅ Agendamento de notificações (enviar em horário específico)
- ✅ Rastreamento de abertura/leitura (analytics)
- ✅ Opt-out/Unsubscribe de categorias específicas
- ✅ Notificações ricas (com imagens, botões, preview)
- ✅ Integração com Microsoft Teams, Slack

### RF-021 (Catálogo de Serviços):
- ✅ Tela de gestão de serviços disponíveis (CRUD completo)
- ✅ Categorização de serviços (TI, Facilities, RH, Financeiro)
- ✅ Descrição rica de serviços (Markdown, HTML)
- ✅ SLA por serviço (tempo de resposta, resolução)
- ✅ Custo por serviço (fixo, variável, por hora)
- ✅ Formulários customizados de solicitação (JSON Schema)
- ✅ Workflow de aprovação por serviço
- ✅ FAQ por serviço (perguntas frequentes)
- ✅ Responsável/Equipe por serviço
- ✅ Disponibilidade/Status do serviço (Ativo, Manutenção, Indisponível)
- ✅ Portal self-service para usuários finais
- ✅ Avaliação de serviços (NPS, 1-5 estrelas)
- ✅ Catálogo visual com cards/ícones (inspirado em AWS Service Catalog)

### RF-INT-001 (Integrações e APIs Externas):
- ✅ Painel de gerenciamento de integrações (CRUD)
- ✅ Tipos de integração: REST API, SOAP, GraphQL, Webhook, FTP/SFTP
- ✅ Credenciais criptografadas (Azure Key Vault)
- ✅ Retry policy configurável (tentativas, backoff exponencial)
- ✅ Timeout configurável por integração
- ✅ Logs de requisições/respostas (últimas 1000, rotação automática)
- ✅ Health check de APIs externas (ping periódico)
- ✅ Dashboard de status de integrações (verde/amarelo/vermelho)
- ✅ Alertas de falha (e-mail/Teams ao falhar 3x seguidas)
- ✅ Rate limiting (limitar chamadas/segundo)
- ✅ Circuit breaker pattern (parar de chamar API falhando)
- ✅ Mapeamento de campos (source → target)
- ✅ Transformações customizadas (JavaScript/C# script)
- ✅ Simulador de payloads (testar integração sem chamar API real)

### RF-USR-001 (Atalhos Personalizados):
- ✅ Tela de configuração de atalhos de teclado
- ✅ Atalhos globais do sistema (Ctrl+N = Novo, Ctrl+S = Salvar)
- ✅ Atalhos customizáveis por usuário
- ✅ Atalhos contextuais (dependem da tela ativa)
- ✅ Barra de comandos (Ctrl+K estilo VS Code)
- ✅ Favoritos/Bookmarks de telas frequentes
- ✅ Histórico de navegação (voltar/avançar entre telas)
- ✅ Widgets personalizáveis no dashboard (drag-and-drop)
- ✅ Temas customizáveis (claro, escuro, alto contraste)
- ✅ Layout de colunas de grid personalizável (mostrar/ocultar, reordenar)
- ✅ Filtros salvos (salvar combinações de filtros frequentes)
- ✅ Exportar/importar configurações de usuário (JSON)

### RF-APR-001 (Aprovações e Workflows):
- ✅ Designer visual de workflows (BPMN.js, draw.io style)
- ✅ Tipos de aprovação: Sequencial, Paralela, Híbrida
- ✅ Condições dinâmicas (if valor > R$ 10k, aprovar Gerente + Diretor)
- ✅ Prazos de aprovação (SLA de resposta)
- ✅ Escalação automática (se não aprovar em X dias, escalar para superior)
- ✅ Aprovação em lote (aprovar múltiplos itens de uma vez)
- ✅ Aprovação via e-mail (link direto, sem login)
- ✅ Aprovação via mobile app (notificação push)
- ✅ Comentários/Justificativas obrigatórias ao rejeitar
- ✅ Histórico completo de aprovações (timeline visual)
- ✅ Delegates/Substitutos (transferir aprovações para outro)
- ✅ Relatório de aprovações pendentes (por usuário, por tipo)
- ✅ Dashboard de workflows (quantos ativos, pendentes, rejeitados)
- ✅ Integração com Microsoft Power Automate, Zapier

### RF-TPL-001 (Motor de Templates):
- ✅ Editor visual de templates (WYSIWYG)
- ✅ Sintaxe de variáveis: {{nome}}, {{consumidor.email}}
- ✅ Helpers: {{formatDate data "DD/MM/YYYY"}}, {{formatCurrency valor}}
- ✅ Condicionais: {{#if}} {{else}} {{/if}}
- ✅ Loops: {{#each ativos}} {{nome}} {{/each}}
- ✅ Templates aninhados (incluir outro template)
- ✅ Versionamento de templates (v1, v2, histórico)
- ✅ Pré-visualização em tempo real (com dados de teste)
- ✅ Variáveis customizadas (definir novas variáveis)
- ✅ Templates por entidade (Consumidor, Ativo, Contrato, etc.)
- ✅ Exportar/importar templates (JSON, compartilhar entre ambientes)
- ✅ Auditoria de uso (quando template foi usado, por quem)
- ✅ Integração com Handlebars, Mustache, Liquid

### RF-TPL-002 (Templates de E-mail):
- ✅ Editor HTML de e-mails (drag-and-drop, estilo Mailchimp)
- ✅ Templates responsivos (mobile-first)
- ✅ Biblioteca de blocos reutilizáveis (header, footer, botão, imagem)
- ✅ Testes de renderização (preview em Gmail, Outlook, Apple Mail)
- ✅ Envio de e-mail de teste (para validar antes de produção)
- ✅ Variáveis dinâmicas (nome, e-mail, link personalizado)
- ✅ Anexos automáticos (PDF gerado, relatório, termo)
- ✅ Agendamento de envio (enviar em data/hora específica)
- ✅ Rastreamento de abertura (pixel tracking)
- ✅ Rastreamento de cliques (links rastreados)
- ✅ Lista de opt-out (respeitar unsubscribe)
- ✅ Integração com SendGrid, Mailgun, AWS SES
- ✅ Templates para: Boas-vindas, Redefinir senha, Notificação de ativo, etc.

### RF-TPL-003 (Templates de Relatórios Excel/PDF):
- ✅ Designer de relatórios (Crystal Reports, RDLC, DevExpress)
- ✅ Templates XLSX (OpenXML, ClosedXML)
- ✅ Templates PDF (iTextSharp, QuestPDF)
- ✅ Layouts pré-definidos (Listagem, Detalhado, Resumo, Dashboard)
- ✅ Gráficos e charts (barras, pizza, linha, área)
- ✅ Tabelas dinâmicas (PivotTable)
- ✅ Agrupamentos e totalizações (SUM, AVG, COUNT)
- ✅ Cabeçalho/rodapé personalizáveis (logo, paginação, data)
- ✅ Assinatura digital em PDFs (ICP-Brasil)
- ✅ Marca d'água (Draft, Confidencial, Interno)
- ✅ Exportação em múltiplos formatos (PDF, XLSX, CSV, HTML)
- ✅ Relatórios agendados (gerar e enviar por e-mail diariamente)
- ✅ Compactação de arquivos grandes (ZIP)
- ✅ Integração com Power BI Embedded (relatórios interativos)
