# RF-072: Escalação Automática

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC008-SD - Service Desk
**Fase**: Fase 5 - Service Desk

---

## 1. OBJETIVO DO REQUISITO

Implementar engine inteligente de escalação automática de chamados (tickets) que decide quando e para quem escalar baseado em critérios configuráveis: SLA consumido, prioridade, skill-based routing, carga de trabalho e hierarquia organizacional.

O sistema reduz tempo médio de resolução (MTTR) em 57%, aumenta First Contact Resolution (FCR) de 58% para 82%, e garante 99,2% de conformidade com SLAs contratuais, evitando penalidades de até R$150mil/mês.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Engine de escalação automática por triggers configuráveis (SLA 50/75/90/100%, prioridade, skills, carga)
- [x] Matriz hierárquica de escalação configurável por cliente (Nível 1→2→3→Gestor)
- [x] Skill-based routing com algoritmo de seleção ótima de especialista
- [x] Balanceamento automático de carga (pausa por sobrecarga >8 chamados)
- [x] Notificações multi-canal (email, SMS, in-app, MS Teams)
- [x] Gestão de pausas temporárias (férias, reuniões, ausências)
- [x] Auditoria completa de escalações (7 anos de retenção)
- [x] Dashboard em tempo real com métricas de escalação
- [x] Aceite/rejeição de escalações com registro de motivo
- [x] Re-escalação automática em cascata
- [x] Integração com calendário corporativo (Active Directory)
- [x] Validação de disponibilidade antes de escalar
- [x] Multi-tenancy (matriz independente por cliente)

### 2.2 Fora do escopo (não objetivos)

- Inteligência artificial preditiva avançada (ML será adicionado em RF futuros)
- Roteamento baseado em localização geográfica (não é requisito atual)
- Integração com sistemas de telefonia (VoIP/PBX)
- Gamificação ou sistema de pontos para analistas

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Escalação (Escalation)** | Ato de rotear chamado de um analista/fila para outro ou nível superior quando detentor atual não possui skills, capacidade ou autoridade |
| **Matriz de Escalação** | Configuração hierárquica definindo regras por tipo, categoria, prioridade (Nível 1→2→3→Gestor) |
| **Trigger de Escalação** | Evento/condição que dispara escalação automática (SLA 50/75/90/100%, prioridade, skill gap, carga) |
| **Skill-Based Routing** | Algoritmo que roteia para analista com skills declaradas no tópico/categoria do chamado |
| **Balanceamento de Carga** | Distribuição inteligente evitando sobrecarga (>8 chamados = pausa automática) |
| **Escalação Horizontal** | Roteia entre analistas do mesmo nível (Helpdesk A → Helpdesk B) |
| **Escalação Vertical** | Roteia para nível superior (Nível 1 → 2 → 3) |
| **FCR (First Contact Resolution)** | Taxa de chamados resolvidos no primeiro contato sem re-escalação |
| **MTTR (Mean Time To Resolution)** | Tempo médio de resolução do chamado |
| **SLA (Service Level Agreement)** | Contrato definindo tempo máximo de resposta/resolução |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Escalação Automática por SLA Consumido** - Triggers progressivos em 50%, 75%, 90%, 100% do SLA
2. **Escalação por Prioridade** - P1 escala em 15min, P2 em 45min, P3 em 2h
3. **Skill-Based Routing** - Seleciona melhor analista com score (skills 40% + histórico 30% + disponibilidade 20% + SLA 10%)
4. **Balanceamento Automático** - Pausa por sobrecarga (>8 chamados), round-robin ponderado
5. **Matriz Hierárquica Configurável** - Editor visual com drag-and-drop, validação de ciclos
6. **Notificações Multi-Canal** - Email (detalhes) + SMS (urgentes) + In-app (badge) + MS Teams (menção)
7. **Gestão de Pausas Temporárias** - Férias, reuniões, ausências com calendário integrado
8. **Aceite/Rejeição de Escalações** - Tracking com SLA de aceite (<5min), registro de motivos
9. **Re-escalação em Cascata** - Nível 2 não resolve → auto-escala Nível 3 → Gestor
10. **Auditoria Completa** - Log estruturado com retenção 7 anos (LGPD)
11. **Dashboard Real-time** - Métricas: escalações/hora, taxa aceite, tempo médio, padrões por analista/categoria
12. **Validação de Disponibilidade** - Verifica: em pausa?, online?, tem capacity?
13. **Mecanismo de Re-tentativa** - Se 3 escalações falharem, alerta crítico para Gestor
14. **Redirecionamento Manual** - Gestor redireciona com 1 clique registrando motivo
15. **Integração com AD** - Lê calendário de férias/ausências automaticamente

---

## 5. REGRAS DE NEGÓCIO

### RN-RF072-001 — Escalação automática por SLA consumido

**Descrição**: Quando SLA de resposta atinge 50%, 75%, 90% do tempo alocado, chamado é automaticamente escalado para nível superior. Violação (100%) dispara escalação imediata para Gestor.

**Justificativa**: SLA é contrato com cliente; violação gera multa contratual até R$150mil/mês. Triggers progressivos evitam desperdício de tempo com pessoa errada.

**Critério de Aceite**:
- SLA 50% consumido → escala Nível 2
- SLA 75% consumido → escala Nível 3
- SLA 90% consumido → escala Gestor
- SLA 100% consumido → alerta crítico + escala imediata

---

### RN-RF072-002 — Escalação por prioridade automática

**Descrição**: P1 escala para Nível 2 se não atribuído em 15min, para Nível 3 se não iniciado em 30min. P2 escala em 45min, P3 em 2h.

**Justificativa**: P1 = negócio parado. Esperar resposta de trainee é operacionalmente inviável.

**Critério de Aceite**:
- P1 + 15min sem atribuição → escala Nível 2
- P1 + 30min sem início → escala Nível 3
- P2 + 45min sem resposta → escala Nível 2
- P3 + 2h sem resposta → escala Nível 2

---

### RN-RF072-003 — Skill-based routing com score ponderado

**Descrição**: Sistema seleciona analista com melhor score combinando: match de skills (40%), histórico de sucesso (30%), disponibilidade/carga (20%), SLA consumido (10%).

**Justificativa**: Escalar para pessoa errada causa retrabalho aumentando MTTR em 300%. Skill-based routing maximiza FCR.

**Critério de Aceite**:
- Analista com maior score total é selecionado
- Se score <0.3 (baixo match), escala próximo nível
- Se nenhum disponível, tenta próximo nível automaticamente

---

### RN-RF072-004 — Limite de carga e pausa automática

**Descrição**: Analista com >8 chamados ativos entra em "pausa-sistema" até carga <5. Exceção: P1 em violação força mesmo com sobrecarga.

**Justificativa**: Analista sobrecarregado comete erros, tem baixa qualidade, fica frustrado (turnover).

**Critério de Aceite**:
- 8 chamados ativos → pausa automática ativada
- <5 chamados ativos → pausa automática removida
- P1 violando SLA → exceção, força mesmo em pausa

---

### RN-RF072-005 — Matriz hierárquica multicliente independente

**Descrição**: Cada cliente define matriz com 2-5 níveis: Nível 1→2→3→4→5. Cada nível tem: analistas, skills requeridas, SLA máximo, critérios de escalação.

**Justificativa**: Cada cliente tem estrutura organizacional diferente. Matriz configurável adapta lógica sem alterar código.

**Critério de Aceite**:
- Mínimo 2 níveis, máximo 5
- Validação de ciclos (Nível 1→2→1 é inválido)
- Analista pode estar em múltiplos níveis
- Alterações refletem imediatamente

---

### RN-RF072-006 — Auditoria completa com retenção 7 anos

**Descrição**: Toda escalação registra: ID, chamado, origem, destino, timestamp, motivo, duração aceite, duração resolução, resultado. Retenção 7 anos (LGPD).

**Justificativa**: Investigações de compliance, análise de performance, rastreamento de SLA violations.

**Critério de Aceite**:
- Registro automático em toda escalação (automática ou manual)
- Dados retidos 7 anos
- Permissão `escalacao.auditoria.read` obrigatória para consulta
- Exportação para CSV/Excel disponível

---

### RN-RF072-007 — Notificação multi-canal com garantia de entrega

**Descrição**: Escalação dispara notificações em: Email (detalhes completos), SMS (para P1 urgente), In-app (badge contador), MS Teams (menção direta). SLA: <30s entrega, <5min leitura.

**Justificativa**: Analista que não vê escalação causa violação de SLA. Multi-canal garante 99% read rate.

**Critério de Aceite**:
- 4 canais: email, SMS, in-app, MS Teams
- Notificação <30s após escalação
- Tracking de leitura (confirmar visualização)
- P1 sempre envia SMS + in-app + Teams

---

### RN-RF072-008 — Pausas temporárias integradas com calendário

**Descrição**: Sistema lê calendário corporativo (Active Directory) e sincroniza pausas: férias, ausências, reuniões. Analista pausado removido de roteamento.

**Justificativa**: Analista de férias não deve receber chamado (mesmo critical). Integração com AD automatiza.

**Critério de Aceite**:
- Sincronização automática com AD 1x/hora
- Pausas manuais sobrepõem AD
- Durante pausa: sem novos chamados, chamados abertos não afetados
- Notificação 24h antes de fim de pausa

---

### RN-RF072-009 — Aceite e rejeição com registro de motivo

**Descrição**: Analista tem <5min para aceitar escalação. Pode rejeitar com motivo obrigatório. Se rejeição, sistema tenta próximo analista ou escala nível superior.

**Justificativa**: Analista pode não ter condição imediata (reunião, outro P1). Rejeição com motivo evita forçar escalação indevida.

**Critério de Aceite**:
- SLA aceite: <5min
- Rejeição obriga motivo (dropdown + texto livre)
- Após 3 rejeições no nível → escala nível superior
- Dashboard mostra taxa aceite por analista

---

### RN-RF072-010 — Dashboard real-time com alertas críticos

**Descrição**: Dashboard exibe: escalações/hora, taxa aceite, tempo médio aceite/resolução, padrões por analista/categoria, trending. Alertas: >5% violação SLA em 1h, >10 rejeições em 5min.

**Justificativa**: Gestores precisam visibilidade operacional em tempo real para intervir antes de crise.

**Critério de Aceite**:
- Atualização real-time (SignalR)
- Filtros: período, analista, categoria, prioridade
- Alertas visuais (vermelho) + notificação para gestor
- Exportação de relatórios CSV/PDF

---

## 6. ESTADOS DA ENTIDADE

| Estado | Descrição | Transições Permitidas |
|--------|-----------|---------------------|
| **Pendente** | Escalação criada, aguardando processamento | → Em Roteamento |
| **Em Roteamento** | Sistema buscando melhor analista | → Atribuída, → Falhou |
| **Atribuída** | Escalação atribuída a analista destino | → Aceita, → Rejeitada, → Expirada |
| **Aceita** | Analista aceitou escalação | → Em Atendimento |
| **Em Atendimento** | Analista trabalhando no chamado | → Resolvida, → Re-escalada |
| **Rejeitada** | Analista rejeitou (com motivo) | → Em Roteamento |
| **Resolvida** | Chamado resolvido com sucesso | *(final)* |
| **Re-escalada** | Escalada para próximo nível | → Em Roteamento |
| **Expirada** | Sem aceite em <5min | → Em Roteamento |
| **Falhou** | Sistema não encontrou analista disponível | → Alerta Crítico |

**Transições Proibidas**:
- Resolvida → qualquer outro estado (irreversível)
- Falhou → Atribuída (deve passar por Em Roteamento)

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando Ocorre | Ações Disparadas |
|--------|--------------|------------------|
| `EscalacaoCriadaEvent` | Trigger de escalação ativado | Buscar melhor analista, criar auditoria |
| `EscalacaoAtribuidaEvent` | Analista selecionado | Enviar notificações multi-canal |
| `EscalacaoAceitaEvent` | Analista aceitou em <5min | Atualizar chamado, notificar origem |
| `EscalacaoRejeitadaEvent` | Analista rejeitou | Tentar próximo analista, registrar motivo |
| `EscalacaoExpiradaEvent` | Sem aceite em 5min | Re-rotear ou escalar nível superior |
| `EscalacaoResolvidaEvent` | Chamado fechado | Atualizar métricas FCR/MTTR, fechar auditoria |
| `SobreCargaDetectadaEvent` | Analista atingiu 8 chamados | Ativar pausa automática, notificar |
| `SLATriggerEvent` | SLA 50/75/90/100% | Escalar próximo nível |
| `ViolacaoSLAEvent` | SLA 100% violado | Alerta crítico, escalar Gestor |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- [ ] 100% das escalações registradas em auditoria (sem perda de dados)
- [ ] Triggers de SLA funcionam com precisão de ±30s
- [ ] Skill-based routing seleciona analista correto em >95% dos casos
- [ ] Notificações entregues em <30s em 99% dos casos
- [ ] Pausa automática ativa/desativa sem intervenção manual
- [ ] Dashboard atualiza em <2s (SignalR real-time)
- [ ] Multi-tenancy: nenhum cliente vê dados de outro
- [ ] Performance: processar escalação em <2s mesmo com 1000 analistas
- [ ] Tolerância a falhas: se MS Teams falhar, email/SMS ainda funcionam
- [ ] Testes de carga: suportar 500 escalações simultâneas sem degradação

---

## 9. SEGURANÇA

### 9.1 Validações Obrigatórias

- **Input**: Todos os campos obrigatórios validados (FluentValidation)
- **Unicidade**: Apenas 1 escalação ativa por chamado por vez (lock otimista)
- **Range**: SLA% entre 0-100, níveis entre 1-5
- **Formato**: Emails/telefones validados antes de notificação
- **SQL Injection**: Proteção via EF Core + parametrização
- **XSS**: Sanitização de motivos de rejeição (inputs de texto livre)

### 9.2 Permissões RBAC

| Operação | Permission Code | Roles Autorizadas |
|----------|----------------|------------------|
| Visualizar escalações | `sd.escalacao.read` | Analista, Gestor, Admin |
| Criar escalação manual | `sd.escalacao.create` | Gestor, Admin |
| Aceitar escalação | `sd.escalacao.accept` | Analista atribuído |
| Rejeitar escalação | `sd.escalacao.reject` | Analista atribuído |
| Configurar matriz | `sd.escalacao.config.update` | Admin |
| Auditoria completa | `sd.escalacao.auditoria.read` | Auditor, Admin |
| Dashboard gestão | `sd.escalacao.dashboard.read` | Gestor, Admin |
| Alertas críticos | `sd.escalacao.alertas.read` | Gestor, Admin |

### 9.3 Multi-tenancy

- Campo `ClienteId` (Guid) obrigatório em todas as tabelas
- Row-Level Security via EF Core Global Query Filters
- Matriz de escalação isolada por cliente (sem compartilhamento)
- Auditoria: logs separados por tenant (não há cross-tenant query)

---

## 10. ARTEFATOS DERIVADOS

| Tipo | ID | Título | Status |
|------|-----|--------|--------|
| **UC** | UC00-RF072 | Listar escalações | A criar |
| **UC** | UC01-RF072 | Criar escalação manual | A criar |
| **UC** | UC02-RF072 | Visualizar detalhes de escalação | A criar |
| **UC** | UC03-RF072 | Aceitar/Rejeitar escalação | A criar |
| **UC** | UC04-RF072 | Configurar matriz de escalação | A criar |
| **UC** | UC05-RF072 | Gerenciar pausas temporárias | A criar |
| **MD** | MD-RF072 | Modelo de dados de escalação | A criar |
| **TC** | TC-RF072-BACKEND | Testes backend (API, validações, RBAC) | A criar |
| **TC** | TC-RF072-FRONTEND | Testes frontend (UI, componentes) | A criar |
| **TC** | TC-RF072-SEGURANCA | Testes segurança (SQL Injection, XSS, RBAC) | A criar |
| **MT** | MT-RF072 | Massa de testes (cenários válidos/inválidos) | A criar |

---

## 11. RASTREABILIDADE

### 11.1 RFs Relacionados

- **RF-073** (Gestão de Chamados) - Fonte de chamados para escalação
- **RF-074** (Gestão de Tickets) - Tickets = chamados, mesma engine
- **RF-028** (Gestão de SLA Operações) - SLAs usados como triggers
- **RF-029** (Gestão de SLA Serviços) - SLAs de atendimento

### 11.2 Integrações Obrigatórias

- **i18n**: Transloco com chaves pt-BR, en-US, es-ES (títulos, labels, notificações)
- **Auditoria**: AuditInterceptor automático + tabela EscalacaoAuditoria (7 anos)
- **RBAC**: Permissões listadas na seção 9.2
- **Central de Funcionalidades**: Feature flag `sd.escalacao.enabled`
- **Multi-tenancy**: Campo `ClienteId` + Row-Level Security
- **SignalR**: Dashboard real-time + notificações in-app
- **Hangfire**: Jobs recorrentes (verificação SLA, pausas, sincronização AD)
- **Active Directory**: Leitura de calendário de férias/ausências

### 11.3 API Endpoints

| Método | Rota | Descrição | Auth Policy |
|--------|------|-----------|-------------|
| GET | `/api/escalacoes` | Listar escalações com paginação | `EscalacaoRead` |
| GET | `/api/escalacoes/{id}` | Detalhes de escalação específica | `EscalacaoRead` |
| POST | `/api/escalacoes` | Criar escalação manual | `EscalacaoCreate` |
| POST | `/api/escalacoes/{id}/aceitar` | Aceitar escalação | `EscalacaoAccept` |
| POST | `/api/escalacoes/{id}/rejeitar` | Rejeitar com motivo | `EscalacaoReject` |
| GET | `/api/escalacoes/matriz/{clienteId}` | Obter matriz de escalação | `EscalacaoRead` |
| PUT | `/api/escalacoes/matriz/{id}` | Atualizar matriz | `EscalacaoConfigUpdate` |
| GET | `/api/escalacoes/dashboard` | Métricas real-time | `EscalacaoDashboardRead` |
| GET | `/api/escalacoes/auditoria` | Consultar auditoria completa | `EscalacaoAuditoriaRead` |
| POST | `/api/escalacoes/pausas` | Criar pausa temporária | `EscalacaoCreate` |
| DELETE | `/api/escalacoes/pausas/{id}` | Remover pausa | `EscalacaoCreate` |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-30 | Migração v1.0→v2.0: separação RF/RL, 11 seções obrigatórias, remoção de referências ao legado | Agência ALC - alc.dev.br |
| 1.0 | 2025-12-28 | Versão inicial com documentação completa | Agência ALC - alc.dev.br |
