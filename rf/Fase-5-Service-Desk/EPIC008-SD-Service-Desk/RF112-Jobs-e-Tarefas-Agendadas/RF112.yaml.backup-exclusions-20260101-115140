rf:
  id: RF112
  nome: Jobs e Tarefas Agendadas
  versao: '2.0'
  data: '2025-12-31'
  fase: Fase-5-Service-Desk
  epic: EPIC008-SD-Service-Desk
  status: draft
descricao:
  objetivo: Sistema para gerenciar, executar, monitorar e auditar tarefas de background
    (jobs agendados e sob demanda) no IControlIT.
  problema_resolvido: Automação de processos operacionais recorrentes, execução assíncrona
    de operações custosas, monitoramento de falhas e auditoria completa.
  publico_afetado: Administradores de sistema, desenvolvedores, operadores de TI e
    gestores que precisam de automação e visibilidade de processos em background.
escopo:
  incluso:
  - CRUD de jobs (criar, editar, visualizar, listar, excluir)
  - Execução imediata de jobs (forçar execução fora do agendamento)
  - Operações de controle (pausar, retomar, cancelar)
  - Aprovação em 2 etapas para jobs sensíveis
  - Histórico de execuções (últimos 90 dias)
  - Monitoramento em tempo real via SignalR
  - Notificações de falha por email e SignalR
  - Retry automático com backoff exponencial
  - Validação de cron expressions (formato POSIX)
  - Multi-tenancy com isolamento completo
  - Auditoria completa de todas as operações
  - Métricas e KPIs (taxa de sucesso, tempo médio, retries)
  - Controle via Feature Flag (JOBS_SCHEDULING)
  - i18n completo (16 chaves de tradução)
  - 11 permissões RBAC granulares
  fora:
  - Interface visual específica (layout, UX)
  - Implementação de handlers de jobs (responsabilidade de outros RFs)
  - Estratégia de deploy ou infraestrutura
  - Escolha de tecnologia (Hangfire é referência arquitetural, não requisito)
entidades:
- nome: Job
  descricao: Entidade principal que define um job agendado ou sob demanda
  multi_tenant: true
  soft_delete: true
  auditoria: true
  campos:
  - nome: Id
    tipo: Guid
    obrigatorio: true
  - nome: ClienteId
    tipo: Guid
    obrigatorio: true
  - nome: Nome
    tipo: String(100)
    obrigatorio: true
    unico_por_tenant: true
  - nome: Descricao
    tipo: String(500)
    obrigatorio: false
  - nome: CronExpression
    tipo: String(100)
    obrigatorio: true
  - nome: Timeout
    tipo: Int
    obrigatorio: true
    valor_padrao: 30
  - nome: IsSensitive
    tipo: Bool
    obrigatorio: true
    valor_padrao: false
  - nome: IsActive
    tipo: Bool
    obrigatorio: true
    valor_padrao: true
  - nome: Status
    tipo: Enum(JobStatus)
    obrigatorio: true
- nome: JobExecution
  descricao: Histórico de execuções de um job (retenção 90 dias)
  multi_tenant: true
  soft_delete: false
  auditoria: false
  campos:
  - nome: Id
    tipo: Guid
    obrigatorio: true
  - nome: JobId
    tipo: Guid
    obrigatorio: true
  - nome: ClienteId
    tipo: Guid
    obrigatorio: true
  - nome: DataInicio
    tipo: DateTime
    obrigatorio: true
  - nome: DataFim
    tipo: DateTime
    obrigatorio: false
  - nome: Duracao
    tipo: Int
    obrigatorio: false
  - nome: Status
    tipo: Enum(JobExecutionStatus)
    obrigatorio: true
  - nome: MensagemErro
    tipo: String(2000)
    obrigatorio: false
  - nome: Payload
    tipo: JSON
    obrigatorio: false
  - nome: RetryCount
    tipo: Int
    obrigatorio: true
    valor_padrao: 0
  - nome: ExecutadoPor
    tipo: Guid
    obrigatorio: false
- nome: JobApprovalRequest
  descricao: Solicitações de aprovação para jobs sensíveis (2-step execution)
  multi_tenant: true
  soft_delete: false
  auditoria: true
  campos:
  - nome: Id
    tipo: Guid
    obrigatorio: true
  - nome: JobId
    tipo: Guid
    obrigatorio: true
  - nome: ClienteId
    tipo: Guid
    obrigatorio: true
  - nome: SolicitadoPor
    tipo: Guid
    obrigatorio: true
  - nome: DataSolicitacao
    tipo: DateTime
    obrigatorio: true
  - nome: AprovadoPor
    tipo: Guid
    obrigatorio: false
  - nome: DataAprovacao
    tipo: DateTime
    obrigatorio: false
  - nome: Status
    tipo: Enum(ApprovalStatus)
    obrigatorio: true
  - nome: Justificativa
    tipo: String(1000)
    obrigatorio: false
regras_negocio:
- id: RN-JOB-112-01
  descricao: Nome Único de Job por Tenant
  tipo: unicidade
  campos_afetados:
  - Nome
  - ClienteId
  obrigatorio: true
  validacao: EXISTS(Jobs WHERE ClienteId = X AND Nome = Y AND Status != Deleted)
  criterio_aceite:
  - Tentativa de criar job com nome já existente no mesmo tenant → rejeição HTTP 400
  - Nome duplicado em tenants diferentes → permitido
  - Nome de job excluído logicamente → pode ser reutilizado
- id: RN-JOB-112-02
  descricao: Validação de Cron Expression
  tipo: validacao
  campos_afetados:
  - CronExpression
  obrigatorio: true
  validacao: Formato POSIX com mínimo 5 campos (minuto, hora, dia do mês, mês, dia
    da semana)
  criterio_aceite:
  - Cron expression ausente ou vazia → rejeição HTTP 400
  - Formato inválido → rejeição HTTP 400 com mensagem clara
  - Validação via biblioteca Cronos
- id: RN-JOB-112-03
  descricao: Retry Automático com Backoff Exponencial
  tipo: regra_negocio
  campos_afetados:
  - RetryCount
  obrigatorio: true
  politica_retry:
    tentativa_1: Imediato
    tentativa_2: 1 minuto
    tentativa_3: 2 minutos
    tentativa_4: 4 minutos
    maximo_retries: 3
  criterio_aceite:
  - Job falha → aguarda intervalo → tenta novamente
  - Após 4 tentativas → marca como FAILED e notifica administrador
  - 'Exceções: falhas de validação, permissão negada, cancelamento manual'
- id: RN-JOB-112-04
  descricao: Timeout Padrão de 30 Minutos
  tipo: regra_negocio
  campos_afetados:
  - Timeout
  obrigatorio: true
  valores:
    padrao: 30
    minimo: 5
    maximo: 240
  criterio_aceite:
  - Job excede timeout → cancelado automaticamente com status TIMEOUT
  - Log de cancelamento registrado
- id: RN-JOB-112-05
  descricao: Máximo 10 Workers Paralelos por Tenant
  tipo: regra_negocio
  campos_afetados:
  - ClienteId
  obrigatorio: true
  limite_workers: 10
  criterio_aceite:
  - 10 jobs do tenant já em execução → novos jobs entram em fila FIFO
  - Job finaliza → próximo job na fila é executado
  - Limite configurável via Feature Flag JOBS_MAX_WORKERS_PER_TENANT
- id: RN-JOB-112-06
  descricao: Histórico de Execuções Retido por 90 Dias
  tipo: regra_negocio
  campos_afetados:
  - DataInicio
  obrigatorio: true
  retencao_dias: 90
  criterio_aceite:
  - Job de limpeza automática roda diariamente às 3h da manhã
  - Registros com mais de 90 dias → excluídos fisicamente
  - Auditoria mantida indefinidamente (tabela separada)
- id: RN-JOB-112-07
  descricao: Notificação de Falha para Administrador
  tipo: regra_negocio
  campos_afetados:
  - Status
  obrigatorio: true
  criterio_aceite:
  - Job atinge status FAILED → envia email para todos os Administradores do tenant
  - Notificação via SignalR também enviada (em tempo real)
- id: RN-JOB-112-08
  descricao: Multi-tenancy com ClienteId
  tipo: seguranca
  campos_afetados:
  - ClienteId
  obrigatorio: true
  criterio_aceite:
  - Job só pode ser criado com ClienteId do usuário autenticado
  - Listagem retorna apenas jobs do tenant do usuário
  - Execução forçada só pode disparar jobs do próprio tenant
- id: RN-JOB-112-09
  descricao: Jobs Sensíveis Exigem Duas Permissões (2-Step Execution)
  tipo: seguranca
  campos_afetados:
  - IsSensitive
  obrigatorio: true
  fluxo_aprovacao:
    passo_1: Usuário A solicita execução (jobs:request_sensitive)
    passo_2: Job entra em PENDING_APPROVAL
    passo_3: Usuário B (diferente de A) com jobs:approve_sensitive aprova
    passo_4: Job executa imediatamente
  criterio_aceite:
  - Usuário não pode aprovar própria solicitação
  - Aprovação obrigatória antes de execução
- id: RN-JOB-112-10
  descricao: Auditoria Completa de Operações em Jobs
  tipo: auditoria
  campos_afetados:
  - '*'
  obrigatorio: true
  operacoes_auditadas:
  - CREATE
  - UPDATE
  - DELETE
  - EXECUTE
  - PAUSE
  - RESUME
  - APPROVE
  - REJECT
  retencao: 5 anos (conformidade legal)
  criterio_aceite:
  - Registra usuário, data/hora (UTC), IP, tenant, diff JSON
estados:
- id: ACTIVE
  descricao: Job ativo e agendado (executará conforme cron expression)
- id: PAUSED
  descricao: Job pausado (não executará até ser retomado)
- id: DELETED
  descricao: Job excluído logicamente (soft delete)
transicoes:
  permitidas:
  - de: ACTIVE
    para: PAUSED
    permissao: jobs:pause
  - de: PAUSED
    para: ACTIVE
    permissao: jobs:resume
  - de: ACTIVE
    para: DELETED
    permissao: jobs:delete
  - de: PAUSED
    para: DELETED
    permissao: jobs:delete
  proibidas:
  - de: DELETED
    para: '*'
    motivo: Jobs excluídos não podem ser reativados
permissoes:
- codigo: jobs:read
  descricao: Visualizar jobs e listar
  nivel: leitura
- codigo: jobs:create
  descricao: Criar novo job
  nivel: escrita
- codigo: jobs:update
  descricao: Editar job existente
  nivel: escrita
- codigo: jobs:delete
  descricao: Excluir job (soft delete)
  nivel: escrita
- codigo: jobs:execute
  descricao: Executar job imediatamente (forçar execução)
  nivel: execucao
- codigo: jobs:pause
  descricao: Pausar agendamento de job
  nivel: execucao
- codigo: jobs:resume
  descricao: Retomar agendamento de job
  nivel: execucao
- codigo: jobs:cancel
  descricao: Cancelar execução de job em andamento
  nivel: execucao
- codigo: jobs:request_sensitive
  descricao: Solicitar execução de job sensível (1ª etapa)
  nivel: sensivel
- codigo: jobs:approve_sensitive
  descricao: Aprovar/rejeitar execução de job sensível (2ª etapa)
  nivel: sensivel
- codigo: jobs:view_history
  descricao: Visualizar histórico de execuções e logs
  nivel: leitura
matriz_permissoes:
  Administrador:
  - jobs:read
  - jobs:create
  - jobs:update
  - jobs:delete
  - jobs:execute
  - jobs:pause
  - jobs:resume
  - jobs:cancel
  - jobs:request_sensitive
  - jobs:approve_sensitive
  - jobs:view_history
  Gerente:
  - jobs:read
  - jobs:view_history
  - jobs:approve_sensitive
  Operador:
  - jobs:read
  - jobs:execute
  - jobs:view_history
  Desenvolvedor:
  - jobs:create
  - jobs:update
  - jobs:delete
  - jobs:execute
  - jobs:pause
  - jobs:resume
  - jobs:view_history
  Usuario_Padrao:
  - jobs:read
integracoes:
  internas:
  - nome: Autenticação (RF-001)
    tipo: Hard
    descricao: Jobs exigem usuário autenticado
  - nome: Perfis (RF-007)
    tipo: Hard
    descricao: Permissões RBAC
  - nome: Auditoria (RF-010)
    tipo: Hard
    descricao: Logs de operações
  - nome: Feature Flags (RF-025)
    tipo: Hard
    descricao: Controle de ativação via JOBS_SCHEDULING
  - nome: i18n (RF-030)
    tipo: Hard
    descricao: Traduções (16 chaves obrigatórias)
  - nome: Notificações (RF-035)
    tipo: Soft
    descricao: Emails de falha
  externas:
  - sistema: Hangfire
    tipo: Orquestração
    obrigatoria: true
    descricao: Sistema distribuído de jobs
  - sistema: Redis
    tipo: Storage
    obrigatoria: true
    descricao: Storage do Hangfire
  - sistema: Application Insights
    tipo: Telemetria
    obrigatoria: false
    descricao: Monitoramento e observabilidade
  - sistema: SignalR
    tipo: Real-time
    obrigatoria: true
    descricao: Logs em tempo real
  - sistema: SMTP
    tipo: Notificação
    obrigatoria: true
    descricao: Emails de falha
feature_flags:
- key: JOBS_SCHEDULING
  default_enabled: true
  descricao: Habilita agendamento e execução de jobs
  comportamento_desabilitado:
  - Jobs existentes não executam
  - Interface de criação/edição fica bloqueada
  - API retorna HTTP 503 (Service Unavailable)
i18n:
  chaves_obrigatorias:
  - jobs.title
  - jobs.create
  - jobs.edit
  - jobs.delete
  - jobs.execute
  - jobs.pause
  - jobs.resume
  - jobs.approve
  - jobs.reject
  - jobs.status.pending
  - jobs.status.running
  - jobs.status.success
  - jobs.status.failed
  - jobs.status.timeout
  - jobs.status.cancelled
  - jobs.errors.name_duplicated
  - jobs.errors.invalid_cron
  - jobs.errors.timeout_exceeded
  - jobs.notifications.failed
endpoints:
  crud:
  - metodo: GET
    url: /api/jobs
    permissao: jobs:read
    descricao: Listar jobs do tenant
  - metodo: GET
    url: /api/jobs/{id}
    permissao: jobs:read
    descricao: Detalhes de um job
  - metodo: POST
    url: /api/jobs
    permissao: jobs:create
    descricao: Criar novo job
  - metodo: PUT
    url: /api/jobs/{id}
    permissao: jobs:update
    descricao: Editar job
  - metodo: DELETE
    url: /api/jobs/{id}
    permissao: jobs:delete
    descricao: Exclusão lógica
  execucao:
  - metodo: POST
    url: /api/jobs/{id}/executar
    permissao: jobs:execute
    descricao: Executar agora
  - metodo: POST
    url: /api/jobs/{id}/pausar
    permissao: jobs:pause
    descricao: Pausar agendamento
  - metodo: POST
    url: /api/jobs/{id}/retomar
    permissao: jobs:resume
    descricao: Retomar agendamento
  - metodo: POST
    url: /api/jobs/{id}/cancelar
    permissao: jobs:cancel
    descricao: Cancelar execução
  aprovacao:
  - metodo: POST
    url: /api/jobs/{id}/solicitar-execucao
    permissao: jobs:request_sensitive
    descricao: Solicitar aprovação (2-step)
  - metodo: POST
    url: /api/jobs/{id}/aprovar-execucao
    permissao: jobs:approve_sensitive
    descricao: Aprovar solicitação
  - metodo: POST
    url: /api/jobs/{id}/rejeitar-execucao
    permissao: jobs:approve_sensitive
    descricao: Rejeitar solicitação
  - metodo: GET
    url: /api/jobs/pendentes-aprovacao
    permissao: jobs:approve_sensitive
    descricao: Listar pendências
  monitoramento:
  - metodo: GET
    url: /api/jobs/{id}/historico
    permissao: jobs:view_history
    descricao: Histórico de execuções
  - metodo: GET
    url: /api/jobs/{id}/execucoes/{execId}
    permissao: jobs:view_history
    descricao: Detalhes de execução
  - metodo: GET
    url: /api/jobs/{id}/metricas
    permissao: jobs:read
    descricao: Métricas do job
  realtime:
  - metodo: WS
    url: /hubs/jobs
    permissao: jobs:read
    descricao: SignalR para logs em tempo real
metricas:
- nome: Taxa de Sucesso
  descricao: '% de jobs executados com sucesso'
  meta: ≥ 95%
  calculo: (Jobs com status SUCCESS / Total de Jobs Executados) * 100
- nome: Tempo Médio de Execução
  descricao: Média de duração dos jobs
  meta: Monitorar
  calculo: SUM(Duracao) / COUNT(JobExecutions) WHERE Status = SUCCESS
- nome: Taxa de Retry
  descricao: '% de jobs que precisaram de retry'
  meta: ≤ 10%
  calculo: (Jobs com RetryCount > 0 / Total de Jobs Executados) * 100
- nome: Jobs em Timeout
  descricao: '% de jobs cancelados por timeout'
  meta: ≤ 5%
- nome: Fila de Espera
  descricao: Número médio de jobs aguardando
  meta: ≤ 5
- nome: Latência de Agendamento
  descricao: Diferença entre horário agendado e execução real
  meta: ≤ 30s
- nome: Taxa de Aprovação
  descricao: '% de jobs sensíveis aprovados vs rejeitados'
  meta: Monitorar
- nome: Tempo de Aprovação
  descricao: Tempo médio entre solicitação e decisão
  meta: Monitorar
alertas:
- nome: Job Crítico Falhou
  condicao: Job sensível falha após 4 tentativas
  acao: Email para administradores + Notificação SignalR
  severidade: Critical
- nome: Timeout Recorrente
  condicao: Mesmo job excede timeout 3x em 24h
  acao: Investigação manual + Ajuste de timeout
  severidade: Warning
- nome: Fila Saturada
  condicao: Mais de 20 jobs aguardando por > 5 minutos
  acao: Revisar limite de workers
  severidade: Warning
- nome: Redis Indisponível
  condicao: Hangfire não consegue conectar ao Redis
  acao: Alerta de infraestrutura
  severidade: Critical
- nome: Cron Inválido
  condicao: Job com cron expression mal formada
  acao: Pausar job + Notificar criador
  severidade: Error
- nome: Aprovação Pendente > 24h
  condicao: Job sensível não aprovado/rejeitado em 24h
  acao: Notificar aprovadores
  severidade: Warning
seguranca:
  isolamento_tenant: true
  auditoria_obrigatoria: true
  soft_delete: true
  criptografia:
    payload: true
  rate_limiting:
    max_jobs_por_minuto_por_tenant: 100
rastreabilidade:
  ucs_esperados:
  - UC00
  - UC01
  - UC02
  - UC03
  - UC04
  - UC05
  - UC06
  - UC07
  - UC08
  - UC09
  - UC10
central_funcionalidades:
  rf_id: RF-112
  titulo: Jobs e Tarefas Agendadas
  categoria: Service Desk
  subcategoria: Automação
  feature_flag_key: JOBS_SCHEDULING
  status: ativo
  ordem_exibicao: 800
  icone: schedule
  rota_principal: /jobs
navegacao:
  menu_principal:
  - nivel_1: Service Desk
    nivel_2: Jobs e Tarefas Agendadas
    subitens:
    - Meus Jobs
    - Criar Job
    - Histórico de Execuções
    - Pendências de Aprovação
catalog:
  crud:
  - id: RF112-CRUD-01
    title: Criar Job
    required: true
  - id: RF112-CRUD-02
    title: Listar Jobs
    required: true
  - id: RF112-CRUD-03
    title: Visualizar Job
    required: true
  - id: RF112-CRUD-04
    title: Editar Job
    required: true
  - id: RF112-CRUD-05
    title: Excluir Job
    required: true
  validacoes:
  - id: RF112-VAL-01
    title: Validar campos obrigatórios (Nome, CronExpression, Timeout)
    required: true
  - id: RF112-VAL-02
    title: Validar unicidade de Nome por Tenant
    required: true
  - id: RF112-VAL-03
    title: Validar formato de Cron Expression (POSIX)
    required: true
  - id: RF112-VAL-04
    title: Validar range de Timeout (5-240 minutos)
    required: true
  seguranca:
  - id: RF112-SEC-01
    title: Isolamento de tenant (ClienteId)
    required: true
  - id: RF112-SEC-02
    title: Permissões RBAC (11 permissões)
    required: true
  - id: RF112-SEC-03
    title: 2-Step Execution para jobs sensíveis
    required: true
  - id: RF112-SEC-04
    title: Validação de aprovador diferente do solicitante
    required: true
  operacoes:
  - id: RF112-OP-01
    title: Executar job imediatamente (forçar execução)
    required: true
  - id: RF112-OP-02
    title: Pausar agendamento
    required: true
  - id: RF112-OP-03
    title: Retomar agendamento
    required: true
  - id: RF112-OP-04
    title: Cancelar execução em andamento
    required: true
  - id: RF112-OP-05
    title: Retry automático com backoff exponencial
    required: true
  - id: RF112-OP-06
    title: Timeout de execução
    required: true
  - id: RF112-OP-07
    title: Notificação de falha
    required: true
  monitoramento:
  - id: RF112-MON-01
    title: Histórico de execuções (90 dias)
    required: true
  - id: RF112-MON-02
    title: Logs em tempo real (SignalR)
    required: true
  - id: RF112-MON-03
    title: Métricas e KPIs (8 métricas)
    required: true
  - id: RF112-MON-04
    title: Alertas críticos (6 tipos de alerta)
    required: true
exclusions:
  rf_items:
  - RF112 NÃO define handlers específicos de jobs (responsabilidade de outros RFs)
  - RF112 NÃO define layout ou UX (responsabilidade do WF)
  - RF112 NÃO define tecnologia de implementação (Hangfire é referência arquitetural)
  - RF112 NÃO define estratégia de deploy ou infraestrutura
historico:
- versao: '2.0'
  data: '2025-12-31'
  autor: Agência ALC - alc.dev.br
  descricao: Migração para Governança v2.0 - Separação RF/RL completa (zero legado)
- versao: '1.0'
  data: '2025-12-28'
  autor: Agência ALC - alc.dev.br
  descricao: Versão inicial com legado misturado
