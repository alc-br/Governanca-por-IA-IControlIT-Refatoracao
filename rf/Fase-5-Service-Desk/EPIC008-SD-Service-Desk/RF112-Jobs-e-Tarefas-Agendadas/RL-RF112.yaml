# Template de Referência ao Legado (RL-RF112.yaml)
# Versão: 2.0 (Adequação para Automação e Rastreabilidade)
# Data: 2025-12-31
# Autor: Agência ALC - alc.dev.br

rf_id: RF112
titulo: "Jobs e Tarefas Agendadas"

legado:
  sistema: "VB.NET + ASP.NET Web Forms"
  versao: "IControlIT v1.x"
  arquitetura: "Monolítica WebForms + SOAP"
  banco_dados: "SQL Server"
  multi_tenant: false
  auditoria: "partial" # Apenas criação, sem dados de modificação

# SEÇÃO CRÍTICA: Referencias ao Legado com Destino Obrigatório
# TOTAL: 13 itens (3 telas + 4 webservices + 4 SPs + 2 tabelas)
referencias:
  # ===========================
  # TELAS LEGADAS (3 itens)
  # ===========================
  - id: "LEG-RF112-T01"
    tipo: "tela"
    nome: "Jobs.aspx"
    caminho: "ic1_legado/IControlIT/Jobs.aspx"
    descricao: |
      Listagem e gerenciamento básico de jobs agendados.
      - GridView exibindo todos os jobs (sem filtro por cliente)
      - Sem paginação (carregava todos os registros)
      - Sem multi-tenancy (jobs de todos os clientes misturados)
      - Sem validação de permissões (qualquer usuário autenticado via)
      - Usava UpdatePanel para refresh parcial
    destino: "substituido"
    justificativa: |
      Substituído por `/jobs` (Angular SPA).
      Nova implementação:
      - Multi-tenancy completo (ClienteId)
      - Paginação, filtros e ordenação
      - RBAC granular (permissão jobs:read)
      - Lazy loading e performance otimizada
    rf_item_relacionado: "SEÇÃO 2: FUNCIONALIDADES → 2.1 Operações CRUD"
    uc_relacionado: "UC00-listar-jobs"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF112-T02"
    tipo: "tela"
    nome: "JobDetails.aspx"
    caminho: "ic1_legado/IControlIT/JobDetails.aspx"
    descricao: |
      Criação e edição de jobs.
      - Campos: txtJobName, txtCronExpression, ddlStatus
      - NÃO validava formato de cron expression (aceitava "abc")
      - NÃO tinha campo Timeout (não era configurável)
      - NÃO tinha flag IsSensitive (2-step execution não existia)
      - Salvava direto no banco via pa_ScheduleJob
    destino: "substituido"
    justificativa: |
      Substituído por `/jobs/{id}` (Angular SPA).
      Nova implementação:
      - Validação de cron expression via Cronos (formato POSIX)
      - Campo Timeout configurável (5-240 minutos)
      - Flag IsSensitive para 2-step execution
      - Commands CQRS (CreateJobCommand, UpdateJobCommand)
      - FluentValidation para regras de negócio
    rf_item_relacionado: "SEÇÃO 3: REGRAS DE NEGÓCIO → RN-JOB-112-02"
    uc_relacionado: "UC01-criar-job, UC03-editar-job"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF112-T03"
    tipo: "tela"
    nome: "JobExecution.aspx"
    caminho: "ic1_legado/IControlIT/JobExecution.aspx"
    descricao: |
      Histórico de execuções de um job específico.
      - GridView exibindo execuções (sem limite de 90 dias)
      - Sem paginação (mostrava tudo de uma vez)
      - Sem filtro por período
      - Não exibia duração da execução (apenas status e erro)
      - Sem refresh automático (usuário precisava F5)
    destino: "substituido"
    justificativa: |
      Substituído por `/jobs/{id}/historico` (Angular SPA).
      Nova implementação:
      - Paginação e filtros por período
      - Histórico com retenção de 90 dias (limpeza automática)
      - Exibe duração em milissegundos
      - Logs em tempo real via SignalR
      - Filtros por status, período, retry count
    rf_item_relacionado: "SEÇÃO 2: FUNCIONALIDADES → 2.4 Monitoramento e Histórico"
    uc_relacionado: "UC10-visualizar-historico"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  # ===========================
  # WEBSERVICES LEGADOS (4 itens)
  # ===========================
  - id: "LEG-RF112-WS01"
    tipo: "webservice"
    nome: "WSJobs.asmx.vb → CreateScheduledJob(name, cron)"
    caminho: "ic1_legado/IControlIT/Services/WSJobs.asmx.vb"
    descricao: |
      Método SOAP para criar job agendado.
      - Parâmetros: name (String), cron (String)
      - Retorno: Integer (ID do job ou -1)
      - SEM validação de formato de cron
      - SEM validação de unicidade por tenant
      - SEM auditoria completa
      - Insere direto via pa_ScheduleJob
    destino: "substituido"
    justificativa: |
      Substituído por `POST /api/jobs` (REST API).
      Nova implementação:
      - Validação de cron expression (Cronos)
      - Validação de unicidade por tenant
      - Auditoria completa (usuário, IP, timestamp)
      - CreateJobCommand (CQRS)
      - Retorna Guid (não Integer)
      - HTTP 400 em validações falhadas (não -1)
    rf_item_relacionado: "SEÇÃO 6: API ENDPOINTS → 6.1 CRUD de Jobs"
    uc_relacionado: "UC01-criar-job"
    complexidade: "media"
    risco_migracao: "alto" # Integrações externas podem consumir SOAP
    prioridade: 1
    notas_migracao: "Manter endpoint SOAP ativo por 6 meses (deprecated) como adaptador para REST"

  - id: "LEG-RF112-WS02"
    tipo: "webservice"
    nome: "WSJobs.asmx.vb → ExecuteJobNow(jobId)"
    caminho: "ic1_legado/IControlIT/Services/WSJobs.asmx.vb"
    descricao: |
      Método SOAP para disparar execução imediata.
      - Parâmetro: jobId (Integer)
      - Retorno: Boolean
      - SEM validação de permissão
      - SEM multi-tenancy (podia executar job de outro cliente)
      - SEM validação se job está ativo
      - SEM log de execução manual
    destino: "substituido"
    justificativa: |
      Substituído por `POST /api/jobs/{id}/executar` (REST API).
      Nova implementação:
      - Validação de permissão (jobs:execute)
      - Multi-tenancy completo (valida ClienteId)
      - Validação de status (job deve estar ACTIVE)
      - Log de execução manual (ExecutadoPor = UserId)
      - ExecuteJobCommand (CQRS)
    rf_item_relacionado: "SEÇÃO 6: API ENDPOINTS → 6.2 Operações de Execução"
    uc_relacionado: "UC05-executar-job-agora"
    complexidade: "media"
    risco_migracao: "alto"
    prioridade: 1
    notas_migracao: "Validar todas as integrações externas que consomem este método"

  - id: "LEG-RF112-WS03"
    tipo: "webservice"
    nome: "WSJobs.asmx.vb → GetJobHistory(jobId)"
    caminho: "ic1_legado/IControlIT/Services/WSJobs.asmx.vb"
    descricao: |
      Método SOAP para retornar histórico de execuções.
      - Parâmetro: jobId (Integer)
      - Retorno: DataSet
      - Retorna TODAS as execuções (sem limite de 90 dias)
      - SEM paginação
      - DataSet é formato legado (dificulta consumo moderno)
    destino: "substituido"
    justificativa: |
      Substituído por `GET /api/jobs/{id}/historico` (REST API).
      Nova implementação:
      - Paginação e filtros
      - Histórico com retenção de 90 dias
      - Retorna JSON (não DataSet)
      - GetJobHistoryQuery (CQRS)
      - Filtros por período, status, retry count
    rf_item_relacionado: "SEÇÃO 6: API ENDPOINTS → 6.4 Monitoramento e Histórico"
    uc_relacionado: "UC10-visualizar-historico"
    complexidade: "baixa"
    risco_migracao: "medio"
    prioridade: 2

  - id: "LEG-RF112-WS04"
    tipo: "webservice"
    nome: "WSJobs.asmx.vb → DeleteJob(jobId)"
    caminho: "ic1_legado/IControlIT/Services/WSJobs.asmx.vb"
    descricao: |
      Método SOAP para excluir job.
      - Parâmetro: jobId (Integer)
      - Retorno: Boolean
      - EXCLUSÃO FÍSICA (DELETE permanente)
      - SEM validação de permissão
      - SEM multi-tenancy
      - Perdia histórico de execuções
    destino: "substituido"
    justificativa: |
      Substituído por `DELETE /api/jobs/{id}` (REST API).
      Nova implementação:
      - Soft delete (Status = DELETED, não DELETE físico)
      - Validação de permissão (jobs:delete)
      - Multi-tenancy completo
      - Preserva histórico de execuções (90 dias)
      - Auditoria de exclusão mantida indefinidamente
      - DeleteJobCommand (CQRS)
    rf_item_relacionado: "SEÇÃO 6: API ENDPOINTS → 6.1 CRUD de Jobs"
    uc_relacionado: "UC04-excluir-job"
    complexidade: "media"
    risco_migracao: "alto" # Perda de dados se não migrado corretamente
    prioridade: 1
    notas_migracao: "Migrar jobs excluídos fisicamente para Status=DELETED antes do cutover"

  # ===========================
  # STORED PROCEDURES LEGADAS (4 itens)
  # ===========================
  - id: "LEG-RF112-SP01"
    tipo: "stored_procedure"
    nome: "pa_ScheduleJob"
    caminho: "Database/dbo.pa_ScheduleJob"
    descricao: |
      Stored Procedure para criar job.
      - Parâmetros: @TaskName VARCHAR(255), @CronExpression VARCHAR(100)
      - Insere job sem validar unicidade de nome
      - Não valida formato de cron expression
      - Não registra usuário criador
      - Não registra tenant (sem multi-tenancy)
      - Campo IsActive sempre 1 (não permite criar job pausado)
    destino: "substituido"
    justificativa: |
      Substituído por CreateJobCommand (CQRS).
      Nova implementação:
      - Validação de unicidade de Nome por ClienteId
      - Validação de cron expression (Cronos)
      - Registra CriadoPor (UserId)
      - Registra ClienteId (multi-tenancy)
      - Permite criar job pausado (IsActive = false)
      - FluentValidation para regras de negócio
    rf_item_relacionado: "SEÇÃO 3: REGRAS DE NEGÓCIO → RN-JOB-112-01"
    uc_relacionado: "UC01-criar-job"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF112-SP02"
    tipo: "stored_procedure"
    nome: "pa_ExecuteJob"
    caminho: "Database/dbo.pa_ExecuteJob"
    descricao: |
      Stored Procedure para registrar início de execução.
      - Parâmetro: @JobId INT
      - Apenas registra início (execução real era SQL Agent)
      - Não valida se job pertence ao tenant
      - Não registra quem disparou (se manual)
      - Não valida se job está ativo
      - Não implementa retry automático
    destino: "substituido"
    justificativa: |
      Substituído por ExecuteJobCommand + Hangfire.
      Nova implementação:
      - Hangfire executa jobs (não SQL Agent)
      - Validação de multi-tenancy (ClienteId)
      - Registro de ExecutadoPor (se manual)
      - Validação de Status (job deve estar ACTIVE)
      - Retry automático com backoff exponencial (1→2→4 min)
      - JobExecutions com todos os metadados
    rf_item_relacionado: "SEÇÃO 3: REGRAS DE NEGÓCIO → RN-JOB-112-03"
    uc_relacionado: "UC05-executar-job-agora"
    complexidade: "alta"
    risco_migracao: "alto" # Mudança de SQL Agent para Hangfire
    prioridade: 1
    notas_migracao: "Migração de SQL Agent Jobs para Hangfire (requer planejamento de cutover)"

  - id: "LEG-RF112-SP03"
    tipo: "stored_procedure"
    nome: "pa_GetJobHistory"
    caminho: "Database/dbo.pa_GetJobHistory"
    descricao: |
      Stored Procedure para retornar histórico de execuções.
      - Parâmetro: @JobId INT
      - Retorna histórico completo (sem limite de 90 dias)
      - Join manual via TaskName (não FK estruturada)
      - Sem paginação
      - Sem filtros (período, status, etc.)
    destino: "substituido"
    justificativa: |
      Substituído por GetJobHistoryQuery (CQRS).
      Nova implementação:
      - Histórico com retenção de 90 dias (limpeza automática)
      - FK estruturada (JobId → Guid)
      - Paginação e filtros
      - Ordenação por DataInicio DESC
      - Filtros por período, status, retry count
    rf_item_relacionado: "SEÇÃO 3: REGRAS DE NEGÓCIO → RN-JOB-112-06"
    uc_relacionado: "UC10-visualizar-historico"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF112-SP04"
    tipo: "stored_procedure"
    nome: "pa_UpdateJobStatus"
    caminho: "Database/dbo.pa_UpdateJobStatus"
    descricao: |
      Stored Procedure para atualizar status de execução.
      - Parâmetros: @JobId INT, @Status VARCHAR(50), @ErrorMessage NVARCHAR(MAX)
      - Atualiza apenas último registro RUNNING (não usa ExecutionId)
      - Calcula duração na atualização (não no final da execução)
      - Não registra usuário que atualizou
      - Não dispara notificações de falha
    destino: "substituido"
    justificativa: |
      Substituído por UpdateJobStatusCommand (CQRS).
      Nova implementação:
      - Usa ExecutionId (Guid) para identificar execução
      - Calcula duração corretamente (DataFim - DataInicio)
      - Registra usuário (se atualização manual)
      - Dispara notificações de falha (email + SignalR)
      - Auditoria completa de atualização
    rf_item_relacionado: "SEÇÃO 3: REGRAS DE NEGÓCIO → RN-JOB-112-07"
    uc_relacionado: "UC05-executar-job-agora"
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: 2

  # ===========================
  # TABELAS LEGADAS (2 itens)
  # ===========================
  - id: "LEG-RF112-TAB01"
    tipo: "tabela"
    nome: "Job_History"
    caminho: "Database/dbo.Job_History"
    descricao: |
      Tabela de histórico de execuções de jobs.
      Problemas:
      - Sem FK (relação por JobName string, não JobId int)
      - Sem multi-tenancy (não tem ClienteId)
      - Sem auditoria (CreatedBy nunca preenchido)
      - Sem retenção (acumulava indefinidamente)
      - Sem Payload (impossível debugar execuções)
      - Sem RetryCount (não registrava tentativas)
      - Sem ExecutedBy (não registrava se manual ou agendado)
    destino: "assumido"
    justificativa: |
      Tabela migrada para JobExecutions com correções:
      - FK estruturada: JobId (Guid)
      - Multi-tenancy: ClienteId (Guid)
      - Auditoria: ExecutadoPor (Guid)
      - Retenção: 90 dias (limpeza automática diária às 3h)
      - Payload: JSON completo
      - RetryCount: 0-3
      - DataInicio, DataFim, Duracao (ms)
      - Status: Enum (SUCCESS, FAILED, TIMEOUT, CANCELLED)

      ETL necessária para migrar histórico:
      - Atribuir ClienteId baseado em contexto histórico
      - Validar 100% dos dados migrados
      - Manter tabela legado em read-only por 6 meses
    rf_item_relacionado: "SEÇÃO 7: MODELO DE DADOS → 7.2 Entidade JobExecution"
    uc_relacionado: "UC10-visualizar-historico"
    complexidade: "alta"
    risco_migracao: "alto" # Perda de histórico se ETL falhar
    prioridade: 1
    notas_migracao: |
      ETL CRÍTICA:
      1. Executar validação prévia de todos os registros
      2. Atribuir ClienteId via análise de log de aplicação
      3. Validar 100% dos dados migrados
      4. Rollback automático em caso de falha
      5. Manter Job_History em read-only por 6 meses

  - id: "LEG-RF112-TAB02"
    tipo: "tabela"
    nome: "Scheduled_Tasks"
    caminho: "Database/dbo.Scheduled_Tasks"
    descricao: |
      Tabela de jobs agendados.
      Problemas:
      - Sem validação de unicidade (permitia jobs duplicados)
      - Sem validação de cron (aceitava valores inválidos)
      - Sem multi-tenancy (não tem ClienteId)
      - Sem Timeout (não tinha configuração)
      - Sem IsSensitive (não suportava 2-step execution)
      - Sem soft delete (apenas IsActive)
      - Sem auditoria (não registrava quem criou/modificou)
    destino: "assumido"
    justificativa: |
      Tabela migrada para Jobs com correções:
      - Multi-tenancy: ClienteId (Guid)
      - Validação: Cron expression validada antes de salvar (Cronos)
      - Timeout configurável: 5-240 minutos (padrão 30)
      - IsSensitive: Suporta 2-step execution (Bool)
      - Soft delete: Status (ACTIVE, PAUSED, DELETED)
      - Auditoria: CriadoPor, AtualizadoPor, DataCriacao, DataAtualizacao
      - Unique constraint: (Nome, ClienteId, Status != DELETED)

      ETL necessária para migrar jobs:
      - Atribuir ClienteId baseado em contexto histórico
      - Validar todas as cron expressions (corrigir inválidas)
      - Atribuir Timeout padrão (30 minutos)
      - Marcar jobs problemáticos como PAUSED para revisão
    rf_item_relacionado: "SEÇÃO 7: MODELO DE DADOS → 7.1 Entidade Job"
    uc_relacionado: "UC00-listar-jobs"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1
    notas_migracao: |
      ETL:
      1. Validar todas as cron expressions (Cronos)
      2. Corrigir expressões inválidas (ou marcar PAUSED)
      3. Atribuir ClienteId via análise de log
      4. Validar 100% dos dados migrados
      5. Manter Scheduled_Tasks em read-only por 6 meses

# Telas Legadas (estrutura detalhada opcional - já documentado em referencias)
telas:
  - id: "LEG-RF112-T01"
    nome: "Jobs.aspx"
    caminho: "ic1_legado/IControlIT/Jobs.aspx"
    responsabilidade: "Listagem de jobs"
    campos:
      - nome: "GridView Jobs"
        tipo: "GridView"
        obrigatorio: false
        validacao: "Nenhuma"
    comportamentos_implicitos:
      - "Exibia jobs de todos os clientes misturados (sem multi-tenancy)"
      - "Não tinha paginação (carregava todos os registros)"

  - id: "LEG-RF112-T02"
    nome: "JobDetails.aspx"
    caminho: "ic1_legado/IControlIT/JobDetails.aspx"
    responsabilidade: "Criar/editar job"
    campos:
      - nome: "txtJobName"
        tipo: "TextBox"
        obrigatorio: true
        validacao: "RequiredFieldValidator"
      - nome: "txtCronExpression"
        tipo: "TextBox"
        obrigatorio: false
        validacao: "Nenhuma (aceitava valores inválidos)"
    comportamentos_implicitos:
      - "Não validava formato de cron expression"
      - "Não tinha campo Timeout"
      - "Não tinha flag IsSensitive"

  - id: "LEG-RF112-T03"
    nome: "JobExecution.aspx"
    caminho: "ic1_legado/IControlIT/JobExecution.aspx"
    responsabilidade: "Histórico de execuções"
    campos:
      - nome: "GridView Executions"
        tipo: "GridView"
        obrigatorio: false
        validacao: "Nenhuma"
    comportamentos_implicitos:
      - "Não paginava histórico (mostrava tudo)"
      - "Não tinha filtro por período"
      - "Sem refresh automático"

# WebServices Legados
servicos:
  - id: "LEG-RF112-WS01"
    nome: "CreateScheduledJob"
    localizacao: "WSJobs.asmx.vb"
    responsabilidade: "Criar job via SOAP"
    notas: "Sem validação de cron, sem multi-tenancy"

  - id: "LEG-RF112-WS02"
    nome: "ExecuteJobNow"
    localizacao: "WSJobs.asmx.vb"
    responsabilidade: "Executar job imediatamente via SOAP"
    notas: "Sem validação de permissão, sem multi-tenancy"

  - id: "LEG-RF112-WS03"
    nome: "GetJobHistory"
    localizacao: "WSJobs.asmx.vb"
    responsabilidade: "Retornar histórico via SOAP"
    notas: "Retorna DataSet, sem paginação"

  - id: "LEG-RF112-WS04"
    nome: "DeleteJob"
    localizacao: "WSJobs.asmx.vb"
    responsabilidade: "Excluir job via SOAP"
    notas: "Exclusão física, perdia histórico"

# Tabelas Legadas com Problemas
tabelas:
  - nome: "Job_History"
    finalidade: "Histórico de execuções"
    problemas:
      - "Sem FK estruturada (relação por nome)"
      - "Sem multi-tenancy (sem ClienteId)"
      - "Sem auditoria (CreatedBy nunca preenchido)"
      - "Sem retenção (acumulava indefinidamente)"
      - "Sem Payload (impossível debugar)"

  - nome: "Scheduled_Tasks"
    finalidade: "Jobs agendados"
    problemas:
      - "Sem validação de unicidade"
      - "Sem validação de cron"
      - "Sem multi-tenancy"
      - "Sem Timeout configurável"
      - "Sem soft delete"

# Regras de Negócio Implícitas (não documentadas no legado)
regras_implicitas:
  - id: "RL-RN-001"
    descricao: |
      Jobs executados via SQL Server Agent (não Hangfire).
      Sistema moderno migrou para Hangfire (orquestrador distribuído).
    fonte: "Análise de configuração SQL Server"

  - id: "RL-RN-002"
    descricao: |
      Jobs sem retry automático. Falhas não eram retentadas.
      Sistema moderno implementa retry com backoff exponencial (1→2→4 min).
    fonte: "Análise de pa_UpdateJobStatus"

  - id: "RL-RN-003"
    descricao: |
      Jobs sem notificação de falha. Operadores verificavam manualmente.
      Sistema moderno envia email + SignalR em falhas.
    fonte: "Ausência de código de email em pa_UpdateJobStatus"

  - id: "RL-RN-004"
    descricao: |
      Jobs executavam indefinidamente (sem timeout).
      Sistema moderno tem timeout padrão de 30 minutos (5-240 configurável).
    fonte: "Ausência de campo Timeout em Scheduled_Tasks"

  - id: "RL-RN-005"
    descricao: |
      Jobs sem validação de cron expression. Aceitava valores inválidos.
      Sistema moderno valida via Cronos antes de salvar.
    fonte: "Análise de pa_ScheduleJob e JobDetails.aspx"

  - id: "RL-RN-006"
    descricao: |
      Jobs compartilhados entre clientes (sem multi-tenancy).
      Sistema moderno isola completamente por ClienteId.
    fonte: "Ausência de ClienteId em Scheduled_Tasks e Job_History"

  - id: "RL-RN-007"
    descricao: |
      Exclusão física de jobs (DELETE permanente, perdia histórico).
      Sistema moderno usa soft delete (Status = DELETED).
    fonte: "Análise de WSJobs.asmx.vb → DeleteJob()"

# Gap Analysis (Legado x Moderno)
gap_analysis:
  - item: "Multi-tenancy"
    existe_legado: false
    existe_moderno: true
    notas: "Isolamento completo por ClienteId (crítico para segurança)"

  - item: "Retry Automático"
    existe_legado: false
    existe_moderno: true
    notas: "Backoff exponencial 1→2→4 minutos (melhora confiabilidade)"

  - item: "Timeout Configurável"
    existe_legado: false
    existe_moderno: true
    notas: "5-240 minutos (evita execuções infinitas)"

  - item: "Notificações de Falha"
    existe_legado: false
    existe_moderno: true
    notas: "Email + SignalR (reduz tempo de resposta a falhas)"

  - item: "Validação de Cron"
    existe_legado: false
    existe_moderno: true
    notas: "Biblioteca Cronos (evita agendamentos inválidos)"

  - item: "2-Step Execution"
    existe_legado: false
    existe_moderno: true
    notas: "Jobs sensíveis exigem aprovação (segurança)"

  - item: "Logs em Tempo Real"
    existe_legado: false
    existe_moderno: true
    notas: "SignalR streaming (monitoramento ativo)"

  - item: "Soft Delete"
    existe_legado: false
    existe_moderno: true
    notas: "Preserva histórico (auditoria e compliance)"

  - item: "RBAC Granular"
    existe_legado: false
    existe_moderno: true
    notas: "11 permissões (controle fino de acesso)"

  - item: "Retenção de Histórico"
    existe_legado: false
    existe_moderno: true
    notas: "90 dias (limpeza automática)"

# Decisões de Modernização
decisoes_modernizacao:
  - decisao: "Migrar de SQL Agent para Hangfire"
    motivo: |
      SQL Agent não suporta multi-tenancy, escalabilidade limitada,
      dificulta deploy em cloud (Azure SQL não tem Agent).
    impacto: "alto"
    data: "2025-12-31"

  - decisao: "Implementar Retry Automático"
    motivo: |
      Legado não retentava jobs falhados. Operadores perdiam tempo
      executando manualmente. Falhas transitórias não eram tratadas.
    impacto: "medio"
    data: "2025-12-31"

  - decisao: "Adicionar Multi-tenancy"
    motivo: |
      Legado misturava jobs de todos os clientes. Risco de segurança
      (um cliente ver jobs de outro). Não permitia limites por tenant.
    impacto: "alto"
    data: "2025-12-31"

  - decisao: "Soft Delete ao Invés de Exclusão Física"
    motivo: |
      Legado perdia histórico ao deletar job. Impossibilitava auditoria
      de jobs excluídos. Dados perdidos permanentemente.
    impacto: "medio"
    data: "2025-12-31"

# Riscos de Migração
riscos_migracao:
  - risco: "Perda de Histórico de Jobs Antigos"
    impacto: "alto"
    probabilidade: "alta"
    mitigacao: |
      ETL com atribuição manual de ClienteId baseado em contexto histórico.
      Validação 100% dos dados migrados. Manutenção de Job_History em
      read-only por 6 meses.

  - risco: "Incompatibilidade de Cron Expressions"
    impacto: "medio"
    probabilidade: "media"
    mitigacao: |
      Validação prévia de todos os cron expressions do legado. Correção
      manual de expressões inválidas antes da migração. Marcação de jobs
      problemáticos como PAUSED até revisão.

  - risco: "Quebra de Integrações SOAP"
    impacto: "alto"
    probabilidade: "baixa"
    mitigacao: |
      Manter endpoint SOAP ativo por 6 meses (deprecated). Endpoint SOAP
      apenas redireciona para REST API (adaptador). Comunicação prévia com
      sistemas consumidores. Documentação de migração SOAP → REST.

# Rastreabilidade (Legado → Moderno)
rastreabilidade:
  - elemento_legado: "Jobs.aspx"
    referencia_rf: "SEÇÃO 2: FUNCIONALIDADES → 2.1"
    referencia_uc: "UC00-listar-jobs"
    status: "migrado"

  - elemento_legado: "JobDetails.aspx"
    referencia_rf: "SEÇÃO 2: FUNCIONALIDADES → 2.1"
    referencia_uc: "UC01-criar-job, UC03-editar-job"
    status: "migrado"

  - elemento_legado: "JobExecution.aspx"
    referencia_rf: "SEÇÃO 2: FUNCIONALIDADES → 2.4"
    referencia_uc: "UC10-visualizar-historico"
    status: "migrado"

  - elemento_legado: "WSJobs.asmx.vb → CreateScheduledJob"
    referencia_rf: "SEÇÃO 6: API ENDPOINTS → 6.1"
    referencia_uc: "UC01-criar-job"
    status: "migrado"

  - elemento_legado: "WSJobs.asmx.vb → ExecuteJobNow"
    referencia_rf: "SEÇÃO 6: API ENDPOINTS → 6.2"
    referencia_uc: "UC05-executar-job-agora"
    status: "migrado"

  - elemento_legado: "WSJobs.asmx.vb → GetJobHistory"
    referencia_rf: "SEÇÃO 6: API ENDPOINTS → 6.4"
    referencia_uc: "UC10-visualizar-historico"
    status: "migrado"

  - elemento_legado: "WSJobs.asmx.vb → DeleteJob"
    referencia_rf: "SEÇÃO 6: API ENDPOINTS → 6.1"
    referencia_uc: "UC04-excluir-job"
    status: "migrado"

  - elemento_legado: "pa_ScheduleJob"
    referencia_rf: "SEÇÃO 3: REGRAS DE NEGÓCIO → RN-JOB-112-01"
    referencia_uc: "UC01-criar-job"
    status: "migrado"

  - elemento_legado: "pa_ExecuteJob"
    referencia_rf: "SEÇÃO 3: REGRAS DE NEGÓCIO → RN-JOB-112-03"
    referencia_uc: "UC05-executar-job-agora"
    status: "migrado"

  - elemento_legado: "pa_GetJobHistory"
    referencia_rf: "SEÇÃO 3: REGRAS DE NEGÓCIO → RN-JOB-112-06"
    referencia_uc: "UC10-visualizar-historico"
    status: "migrado"

  - elemento_legado: "pa_UpdateJobStatus"
    referencia_rf: "SEÇÃO 3: REGRAS DE NEGÓCIO → RN-JOB-112-07"
    referencia_uc: "UC05-executar-job-agora"
    status: "migrado"

  - elemento_legado: "Job_History"
    referencia_rf: "SEÇÃO 7: MODELO DE DADOS → 7.2"
    referencia_uc: "UC10-visualizar-historico"
    status: "migrado"

  - elemento_legado: "Scheduled_Tasks"
    referencia_rf: "SEÇÃO 7: MODELO DE DADOS → 7.1"
    referencia_uc: "UC00-listar-jobs"
    status: "migrado"

# Changelog
changelog:
  - versao: "1.0"
    data: "2025-12-31"
    descricao: "Criação inicial do RL-RF112.yaml com 13 itens legados e 100% destinos definidos"
    autor: "Agência ALC - alc.dev.br"
