# RF-112: Jobs e Tarefas Agendadas

**Versão**: 2.0
**Data**: 2025-12-31
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC008-SD-Service-Desk
**Fase**: Fase-5-Service-Desk

---

## SEÇÃO 1: VISÃO GERAL

### 1.1 Objetivo do Requisito

Definir o comportamento funcional do **sistema de jobs e tarefas agendadas** do IControlIT v2, responsável por gerenciar, executar, monitorar e auditar processamento em background (batch), jobs recorrentes (agendados) e tarefas one-time (executadas uma única vez). O módulo é crítico para operações de larga escala, processamento de importações em massa, limpeza de dados, sincronizações periódicas e integrações com sistemas externos.

O sistema deve integrar com orquestrador distribuído (Hangfire), suportar execução paralela com limite de workers, retry automático com backoff exponencial, timeout configurável e integração profunda com sistemas de auditoria e RBAC.

### 1.2 Contexto de Negócio

O módulo de Jobs é crítico para:

- **Operacional**: Processamento de faturas em lote, importações de dados, limpeza de cache, sincronizações periódicas com sistemas externos (Azure AD, ERPs, operadoras de telecom)
- **Conformidade**: Auditoria completa de cada execução, retenção de histórico por 90 dias, notificação automática de falhas para administradores
- **Segurança**: Validação de permissões 2-step execution em jobs sensíveis, criptografia de payloads em repouso, isolamento por tenant (ClienteId)
- **Performance**: Distribuição paralela com max 10 workers por tenant, paralelização de tarefas independentes, cache de resultados
- **Confiabilidade**: Retry automático com backoff exponencial (1min → 2min → 4min), timeout inteligente (padrão 30min), alertas em real-time

### 1.3 Importância Estratégica

Este requisito funcional é **CRÍTICO** para:

1. Automação de processos batch que impactam múltiplos RFs
2. Garantir SLA de processamento (importações noturnas, sincronizações recorrentes)
3. Evitar sobrecarga do sistema (controle de workers por tenant)
4. Rastreabilidade completa (auditoria + histórico de execuções)
5. Resiliência (retry automático + notificações de falha)

---

## SEÇÃO 2: FUNCIONALIDADES

### 2.1 Operações CRUD de Jobs

**Descrição**: Permitir criação, leitura, atualização e deleção de jobs agendados.

**Operações**:

1. **Criar Job**:
   - Nome único por tenant
   - Tipo de job (enum: ImportarFaturas, LimparCache, SincronizarAzureAD, etc.)
   - Cron expression validada (POSIX)
   - Prioridade (Alta, Média, Baixa)
   - Timeout configurável (5min - 4h, padrão 30min)
   - Payload (JSON, opcional)
   - Flag de 2-step execution (para jobs sensíveis)

2. **Atualizar Job**:
   - Modificar cron expression (recalcular próxima execução)
   - Alterar timeout, prioridade, payload
   - **NÃO** permite alterar tipo de job (requer novo job)

3. **Visualizar Job**:
   - Dados do job (nome, tipo, cron, status, próxima execução)
   - Histórico de execuções (últimas 100 ou últimos 90 dias)
   - Estatísticas (taxa de sucesso, tempo médio, última falha)

4. **Deletar Job**:
   - Exclusão lógica (Status = DELETED)
   - Jobs deletados NÃO são mais agendados
   - Histórico é preservado (90 dias)

### 2.2 Operações de Execução

**Descrição**: Gerenciar execução de jobs (manual, agendada, retry).

**Operações**:

1. **Executar Agora** (One-Time):
   - Disparar job imediatamente
   - Ignora cron expression
   - Requer worker disponível (ou enfileira)
   - Registra em histórico como execução manual

2. **Pausar Job**:
   - Suspender execuções recorrentes
   - Status = PAUSED
   - Histórico preservado

3. **Retomar Job**:
   - Reativar execuções recorrentes
   - Status = ACTIVE
   - Próxima execução recalculada

4. **Cancelar Execução em Andamento**:
   - Cancelar job que está rodando (via CancellationToken)
   - Status da execução = CANCELLED
   - Worker liberado

### 2.3 Operações de Aprovação (Jobs Sensíveis)

**Descrição**: Jobs marcados como "sensíveis" (ex: deletar dados em massa) requerem aprovação antes de executar.

**Fluxo**:

1. Usuário **agenda** job → Status = PENDING_APPROVAL
2. Administrador **aprova** job → Status = APPROVED
3. Usuário **executa** job → Execução normal

**Permissões**:
- Agendar: `jobs:schedule`
- Aprovar: `jobs:approve`
- Executar: `jobs:execute`

### 2.4 Monitoramento e Histórico

**Descrição**: Visualizar status, logs e métricas de jobs.

**Operações**:

1. **Dashboard em Tempo Real**:
   - Jobs ativos (executando agora)
   - Workers utilizados / máximo
   - Fila de jobs pendentes
   - Taxa de sucesso (últimas 24h)

2. **Histórico de Execuções**:
   - Timestamp início/fim
   - Status (SUCCESS, FAILED, TIMEOUT, CANCELLED)
   - Duração (em segundos)
   - Mensagem de erro (se falha)
   - Logs completos (stdout/stderr)

3. **Logs Estruturados**:
   - Application Insights integration
   - Structured logs (JSON)
   - Correlação por ExecutionId
   - Retenção 90 dias (ativo) + 5 anos (arquivo)

---

## SEÇÃO 3: REGRAS DE NEGÓCIO

### RN-JOB-112-01: Nome Único de Job por Tenant

**Descrição**: Cada job deve ter um nome único dentro do ClienteId. Nomes de jobs em diferentes tenants podem se repetir.

**Justificativa**: Evitar conflitos de agendamento e facilitar identificação de jobs no dashboard. Nome é a chave primária de negócio (além da chave técnica Id).

**Critério de Aceite**:
- ClienteId A tem job "ImportarFaturas" → OK
- ClienteId B tem job "ImportarFaturas" → OK (diferente tenant)
- ClienteId A tenta criar 2º job "ImportarFaturas" → **REJEIÇÃO** (HTTP 409 Conflict)

---

### RN-JOB-112-02: Validação de Cron Expression

**Descrição**: Toda Cron expression deve ser validada contra o padrão POSIX. Se inválida, operação é rejeitada com mensagem descritiva. Nenhum job é criado com Cron inválido.

**Justificativa**: Proteger integridade do scheduler. Cron inválido causaria falha silenciosa no agendamento ou comportamento imprevisível.

**Critério de Aceite**:
- `0 2 * * *` (daily 2am) → **VÁLIDO**
- `0 0 * * 0` (weekly Sunday) → **VÁLIDO**
- `2 0 * *` (apenas 4 campos) → **REJEIÇÃO** (HTTP 400)
- `60 * * * *` (minuto 60 inválido) → **REJEIÇÃO** (HTTP 400)
- `abc` → **REJEIÇÃO** (HTTP 400)

**Biblioteca**: Cronos (NuGet)

---

### RN-JOB-112-03: Retry Automático com Backoff Exponencial

**Descrição**: Quando um job falha, sistema reexecuta automaticamente até 3 vezes com backoff exponencial: 1ª falha aguarda 1 minuto, 2ª falha aguarda 2 minutos, 3ª falha aguarda 4 minutos. Após 3 falhas, job é marcado como Faulted e administrador é notificado.

**Justificativa**: Aumentar resiliência contra falhas transitórias (timeout de API externo, indisponibilidade temporária de banco de dados, etc.). Backoff exponencial evita overhead no sistema.

**Critério de Aceite**:
- Job falha na 1ª execução → Aguarda 1 min, reexecuta
- Job falha na 2ª execução (primeira retry) → Aguarda 2 min, reexecuta
- Job falha na 3ª execução (segunda retry) → Aguarda 4 min, reexecuta
- Job falha na 4ª execução (terceira retry) → Marcado como Faulted, administrador notificado

---

### RN-JOB-112-04: Timeout Padrão de 30 Minutos

**Descrição**: Cada job possui timeout padrão de 30 minutos. Se execução não completar neste tempo, job é cancelado automaticamente e marcado como Timeout. Timeout é configurável por job (mínimo 5 min, máximo 4 horas).

**Justificativa**: Prevenir jobs pendurados que consomem recursos indefinidamente. 30 minutos é balanço entre dar tempo suficiente para operações complexas (importações grandes) e evitar deadlocks.

**Critério de Aceite**:
- Job "ImportarFaturas": timeout = 30 min (padrão) → OK
- Job "LimparCache": timeout = 5 min (configurado) → OK
- Job "SincronizarAzureAD": timeout = 120 min (configurado) → OK
- Job excede timeout → Status = TIMEOUT, worker liberado

---

### RN-JOB-112-05: Máximo 10 Workers Paralelos por Tenant

**Descrição**: Sistema permite máximo 10 workers (instâncias paralelas de execução) simultâneos por ClienteId. Cada job ocupa 1 worker durante execução. Ultrapassado o limite, jobs adicionais entram em fila (queue).

**Justificativa**: Prevenir sobrecarga do sistema e garantir isolamento de recursos por tenant. 10 workers é balanceado para suportar picos de processamento sem comprometer performance.

**Critério de Aceite**:
- Tenant A executa 10 jobs em paralelo → **OK** (máximo)
- Tenant A tenta executar 11º job → **ENFILEIRADO** (aguarda worker livre)
- Tenant A completa 1 job → Worker liberado, 11º job começa
- Tenant B (diferente) pode executar seus próprios 10 jobs sem afetar Tenant A

---

### RN-JOB-112-06: Histórico de Execuções Retido por 90 Dias

**Descrição**: Sistema mantém histórico completo (status, logs, erros, tempo) de todas as execuções de jobs. Registros com mais de 90 dias são automaticamente arquivados (ou deletados conforme política de retenção). Dashboard mostra histórico dos últimos 90 dias.

**Justificativa**: Conformidade com regulamentações de retenção de dados. 90 dias oferece rastreabilidade suficiente para debugging de problemas recorrentes. Arquivamento libera espaço em tabelas ativas.

**Critério de Aceite**:
- Job "ImportarFaturas" executado 90 dias atrás → **ARQUIVADO**
- Job "ImportarFaturas" executado 30 dias atrás → **VISÍVEL** no dashboard
- Consultar histórico > 90 dias → Requer acesso a tabela de arquivo

---

### RN-JOB-112-07: Notificação de Falha para Administrador

**Descrição**: Quando um job falha completamente (após 3 retries), sistema envia notificação por email ao administrador do tenant informando: nome do job, horário da falha, mensagem de erro, recomendação de ação. Email é enviado apenas uma vez por falha (não repetido em retries).

**Justificativa**: Alertar rapidamente sobre problemas críticos que requerem intervenção manual. Evitar spam enviando apenas quando esgotadas todas as tentativas.

**Critério de Aceite**:
- Job "ImportarFaturas" falha 3 vezes → Email enviado ao admin UMA única vez
- Job "LimparCache" falha na retry 1 → Sem email (ainda há tentativas)
- Retry bem-sucedida após falha → Sem email (job recuperado)

---

### RN-JOB-112-08: Multi-tenancy com ClienteId

**Descrição**: Todos os jobs, execuções, e configurações são isolados por ClienteId. Jobs de um tenant nunca podem acessar dados de outro. Queries automáticas filtram por ClienteId. TenantId é obrigatório em cada operação.

**Justificativa**: Garantir isolamento de dados entre clientes. SaaS multi-tenancy é requisito de negócio (múltiplos clientes rodando no mesmo sistema).

**Critério de Aceite**:
- Tenant A (ClienteId = GUID-A) cria job "ImportarFaturas"
- Tenant B (ClienteId = GUID-B) cria job "ImportarFaturas" (mesmo nome, diferentes tenants)
- Query para Tenant A → Retorna **APENAS** job de Tenant A
- Query para Tenant B → Retorna **APENAS** job de Tenant B
- Tentativa de Tenant A acessar job de Tenant B → **HTTP 403 Forbidden**

---

### RN-JOB-112-09: Jobs Sensíveis Exigem Duas Permissões (2-Step Execution)

**Descrição**: Jobs marcados como sensíveis (ex: deletar dados em massa, sincronizar com externo) requerem 2 permissões distintas: (1) `jobs:schedule` (agendar/criar) e (2) `jobs:execute` (executar/disparar). Usuário com permissão de agendamento NÃO pode executar automaticamente; requer aprovação de usuário com permissão de execução.

**Justificativa**: Segregação de deveres em operações críticas. Reduz risco de execução acidental ou maliciosa de tarefas que impactam dados em massa.

**Critério de Aceite**:
- Job "DeletearDadosObsoletos" criado → Status = **PENDING_APPROVAL** (requer aprovação)
- Usuário A (com `jobs:execute`) clica "Aprovar" → Status = **APPROVED**, ApprovedByUserId = A
- Usuário A clica "Executar" → Job executa normalmente
- Usuário B (sem `jobs:execute`) tenta aprovar → **HTTP 403 Forbidden**

---

### RN-JOB-112-10: Auditoria Completa de Operações em Jobs

**Descrição**: Todas as operações em jobs (CREATE, UPDATE, EXECUTE, FAIL, CANCEL, PAUSE, RESUME) são registradas em log de auditoria com: ID do usuário, tipo de operação, timestamp, dados antigos/novos, ClienteId. Logs de auditoria são imutáveis e retidos por período mínimo de 5 anos.

**Justificativa**: Conformidade com regulamentações de auditoria e rastreabilidade. Permite forensics em caso de incidente de segurança ou erro operacional.

**Critério de Aceite**:
- CREATE: Usuário cria job "ImportarFaturas" → Log: `{OperationType: "CREATE", UserId: X, NewValues: {Name: "ImportarFaturas", ...}}`
- UPDATE: Usuário altera timeout → Log: `{OperationType: "UPDATE", OldValues: {Timeout: 30}, NewValues: {Timeout: 60}}`
- EXECUTE: Sistema executa job → Log: `{OperationType: "EXECUTE", Timestamp: ...}`
- FAIL: Job falha → Log: `{OperationType: "FAIL", ErrorMessage: "..."}`

---

## SEÇÃO 4: INTEGRAÇÕES OBRIGATÓRIAS

### 4.1 Central de Funcionalidades (Feature Flags)

**FeatureKey**: `JOBS_SCHEDULING`

**Configuração**:
```json
{
  "featureKey": "JOBS_SCHEDULING",
  "nome": "Sistema de Jobs e Agendamentos",
  "descricao": "Habilita agendamento, execução e monitoramento de tarefas em background",
  "habilitado": true,
  "isSystemFeature": true,
  "relatedFeatures": [
    "HANGFIRE_DASHBOARD",
    "JOB_RETRY_POLICY",
    "JOB_NOTIFICATIONS"
  ]
}
```

**Nota**: Se desabilitado, nenhum job é agendado ou executado. Jobs existentes entram em pausa.

---

### 4.2 Internacionalização (i18n)

**Chaves de Tradução** (mínimo obrigatório):

```json
{
  "jobs": {
    "list": {
      "title": "Jobs e Tarefas Agendadas",
      "emptyState": "Nenhum job configurado"
    },
    "form": {
      "name": "Nome do Job",
      "description": "Descrição",
      "jobType": "Tipo de Job",
      "cronExpression": "Expressão CRON",
      "priority": "Prioridade",
      "timeout": "Timeout (minutos)",
      "requiresTwoStep": "Requer aprovação?"
    },
    "messages": {
      "success": {
        "created": "Job criado com sucesso",
        "updated": "Job atualizado com sucesso",
        "executed": "Job executado com sucesso",
        "deleted": "Job deletado com sucesso"
      },
      "error": {
        "nameAlreadyExists": "Já existe um job com este nome",
        "invalidCron": "Expressão CRON inválida",
        "maxWorkersExceeded": "Limite máximo de workers atingido",
        "jobNotFound": "Job não encontrado"
      }
    },
    "validation": {
      "nameRequired": "Nome é obrigatório",
      "nameMinLength": "Nome deve ter pelo menos 3 caracteres",
      "cronRequired": "Expressão CRON é obrigatória",
      "timeoutRequired": "Timeout é obrigatório",
      "timeoutMinValue": "Timeout mínimo é 5 minutos",
      "timeoutMaxValue": "Timeout máximo é 240 minutos"
    },
    "status": {
      "active": "Ativo",
      "paused": "Pausado",
      "disabled": "Desabilitado",
      "faulted": "Falha",
      "pendingApproval": "Aguardando Aprovação"
    },
    "priority": {
      "high": "Alta",
      "medium": "Média",
      "low": "Baixa"
    },
    "actions": {
      "create": "Criar Job",
      "edit": "Editar",
      "delete": "Deletar",
      "execute": "Executar Agora",
      "pause": "Pausar",
      "resume": "Retomar",
      "approve": "Aprovar",
      "viewHistory": "Ver Histórico",
      "viewLogs": "Ver Logs"
    }
  }
}
```

---

### 4.3 Auditoria

**Operações Auditadas**:

| Operação | Código | Dados Registrados |
|----------|--------|-------------------|
| Criar Job | `JOBS_JOB_CREATE` | {Name, JobType, CronExpression, Priority, Timeout} |
| Atualizar Job | `JOBS_JOB_UPDATE` | {Name, CronExpression, Priority, Timeout, Status} |
| Deletar Job | `JOBS_JOB_DELETE` | {JobId, JobName} |
| Executar Job | `JOBS_JOB_EXECUTE` | {JobId, ExecutionTime, DurationMs} |
| Falha de Job | `JOBS_JOB_FAIL` | {JobId, ErrorMessage, RetryCount} |
| Pausar Job | `JOBS_JOB_PAUSE` | {JobId, PausedAt} |
| Retomar Job | `JOBS_JOB_RESUME` | {JobId, ResumedAt} |
| Aprovar Job | `JOBS_JOB_APPROVE` | {JobId, ApprovedBy, ApprovedAt} |

**Retenção**: 5 anos (conforme LGPD)

---

### 4.4 Controle de Acesso (RBAC)

**Permissões**:

| Permissão | Descrição | Perfis |
|-----------|-----------|--------|
| `jobs:read` | Visualizar jobs | Admin, Manager, Developer |
| `jobs:create` | Criar jobs | Admin, Developer |
| `jobs:update` | Editar jobs | Admin, Developer |
| `jobs:delete` | Deletar jobs | Admin |
| `jobs:execute` | Executar/disparar jobs | Admin, Developer |
| `jobs:schedule` | Agendar jobs | Admin, Developer |
| `jobs:approve` | Aprovar jobs sensíveis | Admin |
| `jobs:pause` | Pausar jobs | Admin, Developer |
| `jobs:viewHistory` | Ver histórico de execuções | Admin, Manager, Developer |
| `jobs:viewLogs` | Ver logs detalhados | Admin, Developer |
| `jobs:viewDashboard` | Ver Hangfire Dashboard | Admin, Developer |

**Nota**: Permissões de admin + developer; manager é read-only.

---

## SEÇÃO 5: PERMISSÕES RBAC

### 5.1 Matriz de Permissões

| Operação | Código da Permissão | Perfis Autorizados |
|----------|---------------------|-------------------|
| Listar jobs | `jobs:read` | Admin, Manager, Developer |
| Visualizar job específico | `jobs:read` | Admin, Manager, Developer |
| Criar job | `jobs:create` | Admin, Developer |
| Atualizar job | `jobs:update` | Admin, Developer |
| Deletar job | `jobs:delete` | Admin |
| Executar job agora | `jobs:execute` | Admin, Developer |
| Pausar job | `jobs:pause` | Admin, Developer |
| Retomar job | `jobs:pause` | Admin, Developer |
| Aprovar job sensível | `jobs:approve` | Admin |
| Ver histórico | `jobs:viewHistory` | Admin, Manager, Developer |
| Ver logs detalhados | `jobs:viewLogs` | Admin, Developer |
| Ver dashboard | `jobs:viewDashboard` | Admin, Developer |

### 5.2 Validação de Permissões

**Requisitos**:

1. Todas as operações **DEVEM** validar permissão antes de executar
2. Operações sem permissão → **HTTP 403 Forbidden**
3. Permissões são validadas via RBAC (RF-013)
4. Jobs sensíveis (2-step) exigem **2 permissões distintas**:
   - `jobs:schedule` (agendar)
   - `jobs:approve` (aprovar)
   - `jobs:execute` (executar)

---

## SEÇÃO 6: API ENDPOINTS

### 6.1 CRUD Principal

| Método | Endpoint | Descrição | Permissão |
|--------|----------|-----------|-----------|
| GET | `/api/jobs` | Listar todos os jobs | `jobs:read` |
| GET | `/api/jobs/{id}` | Obter job por ID | `jobs:read` |
| POST | `/api/jobs` | Criar novo job | `jobs:create` |
| PUT | `/api/jobs/{id}` | Atualizar job | `jobs:update` |
| DELETE | `/api/jobs/{id}` | Deletar job | `jobs:delete` |

### 6.2 Operações Especiais

| Método | Endpoint | Descrição | Permissão |
|--------|----------|-----------|-----------|
| POST | `/api/jobs/{id}/executar` | Executar job manualmente (one-time) | `jobs:execute` |
| POST | `/api/jobs/{id}/pausar` | Pausar agendamento recorrente | `jobs:pause` |
| POST | `/api/jobs/{id}/retomar` | Retomar agendamento paused | `jobs:pause` |
| GET | `/api/jobs/{id}/historico` | Obter histórico de execuções | `jobs:viewHistory` |
| GET | `/api/jobs/{id}/logs` | Obter logs detalhados de execução | `jobs:viewLogs` |
| POST | `/api/jobs/{id}/retry` | Retentar job falhado | `jobs:execute` |
| GET | `/api/jobs/dashboard` | Obter dados para dashboard em tempo real | `jobs:viewDashboard` |
| GET | `/api/jobs/workers` | Listar workers ativos e filas | `jobs:read` |
| POST | `/api/jobs/enqueue` | Enfileirar job (fila de prioridade) | `jobs:execute` |
| GET | `/api/jobs/{id}/nextExecution` | Obter próxima execução agendada | `jobs:read` |
| POST | `/api/jobs/{id}/approve` | Aprovar job sensível (2-step) | `jobs:approve` |
| POST | `/api/jobs/{id}/validate-cron` | Validar expressão CRON (sem salvar) | `jobs:read` |
| GET | `/api/jobs/audit-log` | Obter log de auditoria (admin) | `jobs:read` |

---

## SEÇÃO 7: MODELO DE DADOS

### 7.1 Entidades Principais

**Jobs** (tabela principal):

| Campo | Tipo | Obrigatório | Descrição |
|-------|------|-------------|-----------|
| Id | Guid | Sim | PK |
| ClienteId | Guid | Sim | FK para tenant (multi-tenancy) |
| Name | string(255) | Sim | Nome único por tenant |
| Description | string(1000) | Não | Descrição do job |
| JobType | string(100) | Sim | Enum: ImportarFaturas, LimparCache, etc. |
| CronExpression | string(100) | Sim | POSIX cron (validado) |
| Status | string(50) | Sim | ACTIVE, PAUSED, DISABLED, FAULTED, PENDING_APPROVAL, APPROVED |
| Priority | string(20) | Sim | HIGH, MEDIUM, LOW |
| TimeoutMinutes | int | Sim | Padrão 30 (range: 5-240) |
| RetryCount | int | Sim | Padrão 3 |
| RequiresTwoStepExecution | bool | Sim | Padrão false |
| Payload | string(MAX) | Não | JSON com dados para execução |
| NextExecution | DateTime | Não | Próxima execução calculada |
| ScheduledByUserId | Guid | Não | Quem agendou (para 2-step) |
| ApprovedByUserId | Guid | Não | Quem aprovou (para 2-step) |
| ApprovedAt | DateTime | Não | Quando foi aprovado |
| CreatedAt | DateTime | Sim | Auditoria |
| CreatedBy | Guid | Sim | Auditoria |
| UpdatedAt | DateTime | Não | Auditoria |
| UpdatedBy | Guid | Não | Auditoria |
| DeletedAt | DateTime | Não | Soft delete |
| DeletedBy | Guid | Não | Soft delete |

**JobExecutions** (histórico de execuções):

| Campo | Tipo | Obrigatório | Descrição |
|-------|------|-------------|-----------|
| Id | Guid | Sim | PK |
| JobId | Guid | Sim | FK para Jobs |
| ExecutionNumber | int | Sim | Número sequencial da execução |
| Status | string(50) | Sim | RUNNING, SUCCESS, FAILED, TIMEOUT, CANCELLED |
| StartedAt | DateTime | Sim | Início |
| CompletedAt | DateTime | Não | Fim |
| Duration | TimeSpan | Não | Duração calculada |
| ErrorMessage | string(MAX) | Não | Mensagem de erro (se falha) |
| LogOutput | string(MAX) | Não | Stdout/stderr |
| RetryCount | int | Sim | Tentativa atual (0 = primeira execução) |
| NextRetryAt | DateTime | Não | Quando retry será tentado |
| ExecutedBy | Guid | Não | Usuário que disparou (se manual) |
| ClienteId | Guid | Sim | Multi-tenancy (desnormalizado) |

**Índices** (performance crítica):

```sql
CREATE INDEX IDX_Jobs_ClienteId_Name ON Jobs (ClienteId, Name);
CREATE INDEX IDX_Jobs_ClienteId_Status ON Jobs (ClienteId, Status);
CREATE INDEX IDX_Jobs_NextExecution ON Jobs (NextExecution) WHERE Status = 'ACTIVE';
CREATE INDEX IDX_JobExecutions_JobId ON JobExecutions (JobId);
CREATE INDEX IDX_JobExecutions_Status ON JobExecutions (Status);
CREATE INDEX IDX_JobExecutions_StartedAt ON JobExecutions (StartedAt);
```

---

## SEÇÃO 8: DEPENDÊNCIAS

### 8.1 Dependências de Outros RFs

| RF | Descrição | Tipo de Dependência |
|----|-----------|-------------------|
| RF-004 | Auditoria | **CRÍTICA** (todas operações auditadas) |
| RF-013 | RBAC | **CRÍTICA** (validação de permissões) |
| RF-066 | Notificações | **IMPORTANTE** (notificações de falha) |
| RF-001 | Configurações | **OPCIONAL** (feature flags) |

### 8.2 Dependências Técnicas

| Dependência | Versão Mínima | Propósito |
|-------------|---------------|-----------|
| Hangfire.Core | 1.8.0+ | Orquestração de jobs |
| Cronos | 0.7.0+ | Validação de cron expressions |
| Redis | 6.0+ | Storage do Hangfire |
| Application Insights | 2.21.0+ | Telemetria e logs |
| MailKit | 4.0.0+ | Envio de emails (notificações) |

---

## SEÇÃO 9: KPIs E MÉTRICAS

### 9.1 KPIs

| KPI | Meta | Medição |
|-----|------|---------|
| **Taxa de Sucesso de Jobs** | ≥ 95% | (Execuções bem-sucedidas / Total de execuções) * 100 |
| **Tempo Médio de Execução** | ≤ 30 segundos (padrão) | Duration média em JobExecution |
| **Taxa de Retry** | ≤ 5% | (Execuções com retry / Total) * 100 |
| **Utilização de Workers** | 40-60% | (Workers ativos / Max workers) * 100 |
| **Tempo de Fila** | ≤ 5 minutos | (Tempo de saída de fila - Tempo de entrada) |
| **MTTR (Mean Time To Recover)** | ≤ 30 minutos | Tempo entre detecção de falha e correção |
| **Disponibilidade do Scheduler** | ≥ 99.9% | (Tempo ativo / Tempo total) * 100 |
| **Alertas de Falha Enviados** | 100% | (Notificações enviadas / Falhas críticas) * 100 |

### 9.2 Métricas de Monitoramento

**Monitoradas em Real-Time**:

1. Jobs executando agora (gauge)
2. Workers utilizados por tenant (gauge)
3. Jobs em fila (gauge)
4. Taxa de sucesso últimas 24h (counter)
5. Tempo médio de execução últimas 24h (histogram)
6. Falhas consecutivas (counter)

---

## SEÇÃO 10: ALERTAS CRÍTICOS

### 10.1 Alertas Configurados

| Alerta | Condição | Ação |
|--------|----------|------|
| **Job Falhado** | Status = Failed após 3 retries | Notificar admin via email; abrir ticket |
| **Worker Pool Saturado** | Workers ativos ≥ 10 | Log WARN; considerar aumentar capacidade |
| **Fila Congestionada** | Jobs em fila ≥ 100 | Log ERROR; investigar workers lentos |
| **Timeout Frequente** | > 10% jobs com timeout em 1 hora | Log WARN; aumentar timeout ou otimizar job |
| **Scheduler Indisponível** | Hangfire servidor off | Page on-call engineer |
| **Auditoria Cheia** | Logs ≥ 1GB por mês | Archive para JobExecutionArchive |

---

## SEÇÃO 11: CENTRAL DE FUNCIONALIDADES

### 11.1 Registro na Central

**Dados do Registro**:

```json
{
  "rfId": "RF-112",
  "nome": "Jobs e Tarefas Agendadas",
  "categoria": "Automação e Background",
  "descricao": "Sistema de agendamento, execução e monitoramento de jobs em background",
  "icone": "schedule",
  "rota": "/jobs",
  "permissaoRequerida": "jobs:read",
  "habilitadoPorPadrao": true,
  "isSystemFeature": true,
  "dependencias": [
    "RF-004",
    "RF-013",
    "RF-066"
  ],
  "tags": [
    "jobs",
    "scheduling",
    "background",
    "automation",
    "hangfire"
  ],
  "metricas": {
    "jobsAtivos": 0,
    "taxaSucesso": 0,
    "workersUtilizados": 0
  }
}
```

### 11.2 Integração com Menu

**Localização no Menu**:

- Módulo: Service Desk
- Submenu: Automação
- Item: Jobs e Tarefas Agendadas
- Ordem: 40
- Visível se: `jobs:read`

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-31 | **Governança v2.0**: Separação RF/RL, remoção COMPLETA de referências ao legado (migradas para RL-RF112.md), 11 seções padronizadas, 10 RNs funcionais, 13 endpoints, 4 integrações, 8 KPIs | Claude Code |
| 1.0 | 2025-12-28 | Versão inicial com legado misturado (DEPRECIADA) | Claude Code |

---

**Última Atualização**: 2025-12-31
**Autor**: Claude Code / IControlIT Team
**Status**: ✅ CONFORME Governança v2.0

**Linhas Totais**: 607 linhas
**Regras de Negócio**: 10 (RN-JOB-112-01 até RN-JOB-112-10)
**Endpoints**: 18 (5 CRUD + 13 operações especiais)
**Integrações**: 4 (Feature Flags, i18n, Auditoria, RBAC)
**Referências ao Legado**: **ZERO** (migradas para RL-RF112.md)
