# =============================================
# RL-RF079 — Referência ao Legado
# Gestão de Políticas e Compliance
# Versão: 2.0
# Data: 2025-12-30
# Autor: Agência ALC - alc.dev.br
# =============================================

rf_id: RF079
titulo: "Gestão de Políticas e Compliance"

legado:
  sistema: "ASP.NET Web Forms + VB.NET + SQL Server 2019"
  versao: "ic1_legado v3.5.2"
  arquitetura: "Monolítica Web Forms com múltiplos bancos SQL Server"
  banco_dados: "SQL Server 2019 (ic1_legado)"
  multi_tenant: false
  auditoria: "partial"

# SEÇÃO CRÍTICA: Referências ao Legado com Destino Obrigatório
referencias:
  # Telas (Não existiam telas ASPX específicas)
  - id: "LEG-RF079-001"
    tipo: "processo_manual"
    nome: "Armazenamento de Políticas em Pasta Compartilhada"
    caminho: "\\\\servidor\\politicas\\[ano]\\[categoria]\\"
    descricao: |
      Políticas corporativas armazenadas como documentos Word/PDF em pasta de rede.
      Estrutura: \\servidor\politicas\[ano]\[categoria]\[nome_politica].docx
      Controle de versão manual (v1, v2, etc. no nome do arquivo).
      Sem rastreabilidade de quem modificou e quando.
    destino: "substituido"
    justificativa: |
      Sistema modernizado armazena políticas em banco de dados com versionamento automático.
      Permite rastreabilidade completa (quem, quando, o quê) e auditoria imutável.
      Performance superior (busca < 200ms vs > 5s em arquivos de rede).
    rf_item_relacionado: "RN-RF079-01"
    uc_relacionado: "UC01"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF079-002"
    tipo: "processo_manual"
    nome: "Controle de Aceites em Planilha Excel"
    caminho: "\\\\servidor\\compliance\\aceites\\Aceites_Políticas_[ano].xlsx"
    descricao: |
      Aceites registrados manualmente em planilha Excel com colunas:
      - Data, Usuário, Política, Email Enviado, Confirmação
      Sem rastreabilidade de IP, User-Agent ou timestamp exato.
      Múltiplos usuários editam simultaneamente causando conflitos.
      Dados podem ser alterados retroativamente sem registro.
    destino: "substituido"
    justificativa: |
      Sistema modernizado registra aceites automaticamente em tabela AceitePolitica.
      Campos obrigatórios: DataAceite, IpAddress, UserAgent, VersaoPolitica.
      Imutável: registro não pode ser alterado após criação.
      Auditável: comprovação em auditorias LGPD/SOX/ISO 27001.
    rf_item_relacionado: "RN-RF079-02"
    uc_relacionado: "UC07"
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF079-003"
    tipo: "script_manual"
    nome: "Envio Manual de Notificações por Email"
    caminho: "D:\\IC2\\ic1_legado\\Scripts\\EnviarNotificacaoPolitica.sql"
    descricao: |
      Quando política publicada, compliance officer executava script SQL manual:
      1. SELECT emails de lista de distribuição
      2. Copia para Outlook
      3. Envia email manualmente
      Sem rastreamento de quem recebeu/leu.
      Sem notificação in-app.
      Tempo médio: 30-60 minutos por política.
    destino: "substituido"
    justificativa: |
      Sistema modernizado envia notificações automaticamente:
      - Email via SendGrid (rastreável)
      - In-app via SignalR (real-time)
      - SMS opcional (Twilio)
      Registro completo de envio, entrega, abertura.
      Tempo de envio: < 1 minuto para todos os usuários.
    rf_item_relacionado: "RN-RF079-08"
    uc_relacionado: "UC06"
    complexidade: "alta"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF079-004"
    tipo: "processo_manual"
    nome: "Verificação Manual de Conformidade"
    caminho: "D:\\IC2\\ic1_legado\\Documentacao\\ProcessoVerificacaoConformidade.docx"
    descricao: |
      Compliance officer verificava manualmente uma vez por mês:
      1. Exporta lista de usuários
      2. Cruza com planilha de aceites
      3. Identifica não-conformidades
      4. Envia emails individuais
      Tempo médio: 4-8 horas por mês.
      Vulnerável a erro humano.
      Sem alertas automáticos.
    destino: "substituido"
    justificativa: |
      Sistema modernizado executa verificação automática:
      - Job diário via Hangfire
      - Detecta violações automaticamente
      - Envia alertas imediatos (usuário + gestor)
      - Atualiza dashboard em tempo real
      - Reduz tempo de compliance de 8h para 0h (100% automático).
    rf_item_relacionado: "RN-RF079-05"
    uc_relacionado: "UC08"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF079-005"
    tipo: "planilha_excel"
    nome: "Matriz de Compliance Manual"
    caminho: "\\\\servidor\\compliance\\matriz\\Matriz_Compliance.xlsx"
    descricao: |
      Planilha Excel com mapeamento:
      - Políticas × Regulamentações (LGPD, SOX, ISO 27001, ISO 20000)
      - Colunas: Política, Regulamentação, Requisito, Status Conformidade
      Sem rastreamento de mudanças.
      Sem visualização gráfica.
      Sem integração com sistema.
    destino: "substituido"
    justificativa: |
      Sistema modernizado mantém matriz em tabela MatrizCompliance:
      - Rastreável (auditoria completa)
      - Visualização gráfica (tabela dinâmica)
      - Exportável para Excel/PDF
      - Integrado com dashboard de compliance
      - Atualização automática ao publicar política.
    rf_item_relacionado: "RN-RF079-04"
    uc_relacionado: "UC09"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  # WebServices
  - id: "LEG-RF079-006"
    tipo: "webservice"
    nome: "WSAuditoria.asmx - ObterAuditoriaPorPeriodo()"
    caminho: "D:\\IC2\\ic1_legado\\WebService\\WSAuditoria.asmx.vb"
    descricao: |
      WebService ASMX que retorna logs de auditoria filtrados por período.
      Retorno: XML com registros de auditoria.
      Performance: lenta (> 5 segundos para 10.000 registros).
      Sem paginação.
    destino: "substituido"
    justificativa: |
      Substituído por REST API:
      - GET /api/auditoria/periodo?inicio={data}&fim={data}&page={page}&size={size}
      - Retorno: JSON com paginação
      - Performance: < 500ms P95
      - Suporta filtros avançados (OperacaoCodigo, UsuarioId, etc.)
    rf_item_relacionado: "RN-RF079-10"
    uc_relacionado: null
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF079-007"
    tipo: "webservice"
    nome: "WSAuditoria.asmx - ExportarAuditoriaExcel()"
    caminho: "D:\\IC2\\ic1_legado\\WebService\\WSAuditoria.asmx.vb"
    descricao: |
      WebService ASMX que gera arquivo Excel (.xls) com registros de auditoria.
      Formato: Excel 97-2003 (.xls).
      Sem formatação ou filtros avançados.
    destino: "substituido"
    justificativa: |
      Substituído por REST API:
      - GET /api/auditoria/export?formato=xlsx
      - Retorno: Excel moderno (.xlsx) com formatação
      - Suporta CSV, PDF além de Excel
      - Performance superior (geração assíncrona)
    rf_item_relacionado: "RN-RF079-10"
    uc_relacionado: null
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF079-008"
    tipo: "webservice"
    nome: "WSAuditoria.asmx - SincronizarNotificacoes()"
    caminho: "D:\\IC2\\ic1_legado\\WebService\\WSAuditoria.asmx.vb"
    descricao: |
      WebService ASMX com polling manual de notificações.
      Cliente chama método a cada 30 segundos para verificar novas notificações.
      Retorno: XML com lista de notificações não lidas.
      Ineficiente (muitas requests desnecessárias).
    destino: "substituido"
    justificativa: |
      Substituído por SignalR:
      - Notificações real-time (push em vez de polling)
      - Reduz carga no servidor (> 90% de requests eliminadas)
      - Experiência de usuário superior (latência < 100ms)
    rf_item_relacionado: "RN-RF079-08"
    uc_relacionado: null
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 2

  # Stored Procedures
  - id: "LEG-RF079-009"
    tipo: "stored_procedure"
    nome: "pa_Auditoria_Inserir"
    caminho: "Database/dbo.pa_Auditoria_Inserir"
    descricao: |
      Stored procedure para inserir registro de auditoria.
      Parâmetros: @ClienteId, @OperacaoCodigo, @EntidadeTipo, @EntidadeId,
                  @DadoAntigo, @DadoNovo, @UsuarioId
      Lógica: INSERT simples com timestamp automático.
    destino: "substituido"
    justificativa: |
      Substituído por EF Core AuditInterceptor:
      - Auditoria automática integrada ao código C#
      - Não requer SP manual
      - Suporta Entity Framework tracking
      - Mais testável e manutenível
    rf_item_relacionado: "RN-RF079-10"
    uc_relacionado: null
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF079-010"
    tipo: "stored_procedure"
    nome: "pa_Notificacao_ObterPorUsuario"
    caminho: "Database/dbo.pa_Notificacao_ObterPorUsuario"
    descricao: |
      Stored procedure para listar notificações de um usuário.
      Parâmetros: @UsuarioId, @ClienteId
      Lógica: SELECT com filtro por usuário e cliente, ORDER BY DataCriacao DESC
    destino: "assumido"
    justificativa: |
      Lógica simples de leitura, mas será implementada como Query CQRS.
      Classe: GetNotificacoesByUsuarioQuery no Application Layer.
      Performance equivalente mas mais testável.
    rf_item_relacionado: "RN-RF079-08"
    uc_relacionado: null
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 4

  - id: "LEG-RF079-011"
    tipo: "stored_procedure"
    nome: "pa_SistemaConfiguracao_ObterValor"
    caminho: "Database/dbo.pa_SistemaConfiguracao_ObterValor"
    descricao: |
      Stored procedure para obter valor de configuração específica.
      Parâmetros: @ClienteId, @ConfiguracaoCodigo
      Lógica: SELECT que retorna ConfiguracaoValor para código específico.
    destino: "substituido"
    justificativa: |
      Substituído por SistemaConfiguracaoService com cache em memória.
      Performance superior (cache vs DB query a cada request).
      Invalidação automática de cache ao alterar configuração.
    rf_item_relacionado: null
    uc_relacionado: null
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 4

  # Tabelas
  - id: "LEG-RF079-012"
    tipo: "tabela"
    nome: "Auditoria"
    caminho: "Database/dbo.Auditoria"
    descricao: |
      Tabela de auditoria centralizada.
      Colunas: Id, ClienteId, OperacaoCodigo, EntidadeTipo, EntidadeId,
               DadoAntigo, DadoNovo, UsuarioId, IpAddress, UserAgent, DataOperacao
      Problemas: falta índices em OperacaoCodigo e DataOperacao (queries lentas),
                 sem particionamento (cresce indefinidamente),
                 sem retenção automática de 7 anos (LGPD não compliance).
    destino: "assumido"
    justificativa: |
      Estrutura da tabela é adequada, mas precisa de melhorias:
      - Criar índices: IX_Auditoria_OperacaoCodigo, IX_Auditoria_DataOperacao
      - Implementar particionamento por ano
      - Criar job para purgar registros > 7 anos (LGPD)
      - Adicionar campo FlExcluido (soft delete)
    rf_item_relacionado: "RN-RF079-10"
    uc_relacionado: null
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: 2

  - id: "LEG-RF079-013"
    tipo: "tabela"
    nome: "Notificacao"
    caminho: "Database/dbo.Notificacao"
    descricao: |
      Tabela de notificações.
      Colunas: Id, ClienteId, UsuarioId, Tipo, Titulo, Mensagem, Dados,
               Lida, DataCriacao, DataLeitura
      Problemas: sem campos de auditoria (Created, CreatedBy, LastModified),
                 sem soft delete (FlExcluido),
                 tipo limitado (não suporta todos os tipos de compliance).
    destino: "substituido"
    justificativa: |
      Tabela redesenhada com auditoria completa:
      - Adicionar: Created, CreatedBy, LastModified, LastModifiedBy
      - Adicionar: FlExcluido (soft delete)
      - Expandir campo Tipo para suportar:
        PoliticaPublicada, ViolacaoDetectada, ExcecaoAprovada, ExcecaoExpirada
      - Adicionar: PrioridadeNotificacao (Alta/Media/Baixa)
    rf_item_relacionado: "RN-RF079-08"
    uc_relacionado: null
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: 2

  - id: "LEG-RF079-014"
    tipo: "tabela"
    nome: "SistemaConfiguracao"
    caminho: "Database/dbo.SistemaConfiguracao"
    descricao: |
      Tabela de configurações do sistema.
      Colunas: Id, ClienteId, ConfiguracaoCodigo, ConfiguracaoValor,
               ConfiguracaoTipo, DataAlteracao, AlteradoPor
      Problemas: falta versionamento de configurações,
                 sem validação de tipo (pode ter "abc" em campo int),
                 sem histórico de mudanças.
    destino: "assumido"
    justificativa: |
      Estrutura adequada mas precisa de melhorias:
      - Adicionar validação de tipo (FluentValidation)
      - Criar tabela SistemaConfiguracaoHistorico para auditoria
      - Adicionar campos: Created, CreatedBy, LastModified, LastModifiedBy
      - Implementar cache em memória com invalidação automática
    rf_item_relacionado: "RN-RF079-07"
    uc_relacionado: null
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 3

# Metadados de Rastreabilidade
metadados:
  total_itens_legado: 14
  cobertura_destinos: 100.0
  destinos:
    substituido: 10
    assumido: 3
    descartado: 0
    a_revisar: 1
  complexidade_media: "media"
  risco_migracao_medio: "medio"
  itens_criticos: 5
  itens_alta_prioridade: 8
  itens_media_prioridade: 4
  itens_baixa_prioridade: 2

# Regras de Negócio Implícitas
regras_implicitas:
  - id: "RL-RN-001"
    descricao: |
      Armazenamento manual de políticas em pasta compartilhada \\servidor\politicas.
      Controle de versão manual (v1, v2 no nome do arquivo).
      Sem rastreabilidade de quem modificou e quando.
    fonte: "D:\\IC2\\ic1_legado\\Documentacao\\ProcessosPoliticas.docx"
    destino: "substituido"
    rf_item_relacionado: "RN-RF079-01"

  - id: "RL-RN-002"
    descricao: |
      Aceites de políticas registrados manualmente em planilha Excel.
      Planilha: Aceites_Políticas_[ano].xlsx
      Colunas: Data, Usuário, Política, Email Enviado, Confirmação
      Sem IP, User-Agent ou timestamp exato.
    fonte: "\\\\servidor\\compliance\\aceites"
    destino: "substituido"
    rf_item_relacionado: "RN-RF079-02"

  - id: "RL-RN-003"
    descricao: |
      Envio manual de notificações via Outlook quando política publicada.
      Compliance officer executava script SQL para obter emails.
      Sem rastreamento de quem recebeu/leu.
    fonte: "D:\\IC2\\ic1_legado\\Scripts\\EnviarNotificacaoPolitica.sql"
    destino: "substituido"
    rf_item_relacionado: "RN-RF079-08"

  - id: "RL-RN-004"
    descricao: |
      Verificação manual de conformidade uma vez por mês.
      Compliance officer cruzava lista de usuários com planilha de aceites.
      Tempo médio: 4-8 horas por mês.
    fonte: "D:\\IC2\\ic1_legado\\Documentacao\\ProcessoVerificacaoConformidade.docx"
    destino: "substituido"
    rf_item_relacionado: "RN-RF079-05"

  - id: "RL-RN-005"
    descricao: |
      Matriz de compliance mantida em planilha Excel.
      Mapeamento: Políticas × Regulamentações (LGPD, SOX, ISO 27001, ISO 20000).
      Sem rastreamento de mudanças, sem visualização gráfica.
    fonte: "\\\\servidor\\compliance\\matriz\\Matriz_Compliance.xlsx"
    destino: "substituido"
    rf_item_relacionado: "RN-RF079-04"

# Gap Analysis
gap_analysis:
  - item: "Armazenamento de Políticas"
    existe_legado: true
    existe_moderno: true
    notas: "Legado: pasta compartilhada. Moderno: banco com versionamento automático."

  - item: "Aceites de Usuários"
    existe_legado: true
    existe_moderno: true
    notas: "Legado: planilha Excel. Moderno: tabela AceitePolitica rastreável."

  - item: "Rastreamento de Auditoria"
    existe_legado: true
    existe_moderno: true
    notas: "Legado: logs dispersos. Moderno: tabela centralizada com retenção 7 anos."

  - item: "Notificações"
    existe_legado: true
    existe_moderno: true
    notas: "Legado: manual (Outlook). Moderno: automático (SendGrid + SignalR)."

  - item: "Busca em Políticas"
    existe_legado: false
    existe_moderno: true
    notas: "Nova funcionalidade: ElasticSearch com performance < 200ms."

  - item: "Matriz de Compliance"
    existe_legado: true
    existe_moderno: true
    notas: "Legado: planilha Excel. Moderno: tabela MatrizCompliance integrada."

  - item: "Workflow de Aprovação"
    existe_legado: false
    existe_moderno: true
    notas: "Nova funcionalidade: estados + transições automatizadas."

  - item: "Exceções de Conformidade"
    existe_legado: true
    existe_moderno: true
    notas: "Legado: manual (emails). Moderno: tabela ExcecaoConformidade rastreável."

  - item: "Dashboard de Compliance"
    existe_legado: false
    existe_moderno: true
    notas: "Nova funcionalidade: dashboard real-time com KPIs."

  - item: "Verificação Automática"
    existe_legado: false
    existe_moderno: true
    notas: "Legado: manual (mensal). Moderno: automático (diário via Hangfire)."

# Decisões de Modernização
decisoes_modernizacao:
  - decisao: "Substituir pasta compartilhada por banco de dados"
    motivo: |
      Rastreabilidade: impossível auditar quem modificou arquivo Word.
      Versionamento: pasta de rede não oferece controle automático.
      Performance: busca em arquivos de rede é lenta (> 5 segundos).
      Segurança: pasta compartilhada permite edição não autorizada.
    impacto: "alto"
    data: "2025-12-30"

  - decisao: "Substituir planilhas Excel por tabelas SQL"
    motivo: |
      Concorrência: Excel não suporta múltiplos usuários simultaneamente.
      Auditoria: Excel não registra quem modificou quando.
      Integridade: Excel permite modificar dados retroativamente.
      Performance: Excel com > 10.000 linhas trava.
    impacto: "medio"
    data: "2025-12-30"

  - decisao: "Substituir ASMX por REST API"
    motivo: |
      Tecnologia: ASMX obsoleto desde .NET 4.5 (2012).
      Performance: REST JSON é mais rápido que SOAP XML.
      Compatibilidade: frontends modernos não consomem ASMX facilmente.
      Manutenibilidade: ASMX não suporta async/await.
    impacto: "medio"
    data: "2025-12-30"

# Riscos de Migração
riscos_migracao:
  - risco: "Perda de dados históricos de aceites"
    impacto: "alto"
    probabilidade: "baixa"
    mitigacao: |
      Script ETL com validação 100% antes de desativar planilhas.
      Backup completo de todas as planilhas em formato original.
      Verificação manual de amostragem (10% dos registros).

  - risco: "Usuários acostumados com pasta compartilhada"
    impacto: "medio"
    probabilidade: "alta"
    mitigacao: |
      Treinamento obrigatório antes do go-live.
      Guia de uso do novo sistema (vídeos + PDF).
      Suporte dedicado nas primeiras 2 semanas.

  - risco: "Compatibilidade com clientes ASMX existentes"
    impacto: "alto"
    probabilidade: "media"
    mitigacao: |
      Criar adapters ASMX → REST durante período de transição (6 meses).
      Comunicar depreciação com 90 dias de antecedência.
      Fornecer bibliotecas cliente para facilitar migração.

  - risco: "Performance de busca em políticas antigas"
    impacto: "medio"
    probabilidade: "media"
    mitigacao: |
      Indexar ElasticSearch antes de go-live.
      Executar testes de carga com 100.000 políticas.
      Implementar fallback para busca SQL se ElasticSearch falhar.

  - risco: "Auditoria incompleta de ações manuais"
    impacto: "alto"
    probabilidade: "baixa"
    mitigacao: |
      Registrar em AuditLog quando compliance officer faz ação manual.
      Criar checklist de ações auditáveis.
      Revisar logs semanalmente nas primeiras 4 semanas.

# Rastreabilidade (Legado → Moderno)
rastreabilidade:
  - elemento_legado: "Pasta compartilhada \\\\servidor\\politicas"
    referencia_rf: "RN-RF079-01"
    referencia_uc: "UC01"
    status: "migrado"

  - elemento_legado: "Planilha Aceites_Políticas_[ano].xlsx"
    referencia_rf: "RN-RF079-02"
    referencia_uc: "UC07"
    status: "migrado"

  - elemento_legado: "Script EnviarNotificacaoPolitica.sql"
    referencia_rf: "RN-RF079-08"
    referencia_uc: "UC06"
    status: "migrado"

  - elemento_legado: "Processo manual verificação mensal"
    referencia_rf: "RN-RF079-05"
    referencia_uc: "UC08"
    status: "migrado"

  - elemento_legado: "Planilha Matriz_Compliance.xlsx"
    referencia_rf: "RN-RF079-04"
    referencia_uc: "UC09"
    status: "migrado"

  - elemento_legado: "WebService WSAuditoria.asmx"
    referencia_rf: "RN-RF079-10"
    referencia_uc: null
    status: "migrado"

  - elemento_legado: "Tabela Auditoria"
    referencia_rf: "RN-RF079-10"
    referencia_uc: null
    status: "assumido_com_melhorias"

  - elemento_legado: "Tabela Notificacao"
    referencia_rf: "RN-RF079-08"
    referencia_uc: null
    status: "redesenhado"

  - elemento_legado: "Tabela SistemaConfiguracao"
    referencia_rf: null
    referencia_uc: null
    status: "assumido_com_validacao"

# Changelog
changelog:
  - versao: "2.0"
    data: "2025-12-30"
    descricao: "Adequação para automação e rastreabilidade (campo destino obrigatório em 100% dos itens)"
    autor: "Agência ALC - alc.dev.br"

  - versao: "1.0"
    data: "2025-12-30"
    descricao: "Documentação inicial da referência ao legado (separação RF/RL v2.0)"
    autor: "Agência ALC - alc.dev.br"
