# RF074 - Gestão de Chamados - Portal Self-Service
# Versão: 2.0 (Governance v2.0)
# Data: 2025-12-30

metadata:
  rf_id: RF074
  versao: "2.0"
  data_criacao: "2025-12-30"
  fase: Fase-5-Service-Desk
  epic: EPIC008-SD-Service-Desk
  titulo: Gestão de Chamados - Portal Self-Service
  modulo: Service Desk
  rf_relacionado: RF073

visao_geral:
  objetivo: Portal self-service para usuários finais abrirem, acompanharem e gerenciarem tickets via wizard 3-passos com FAQ integrada, notificações real-time, CSAT inline e PWA offline
  escopo_dentro:
    - Wizard 3-passos criar chamado
    - Listagem cards responsivos
    - Notificações SignalR real-time
    - CSAT inline pós-resolução
    - FAQ integrada busca real-time
    - PWA suporte offline
    - Upload anexos antivírus
    - Comentários públicos apenas
  escopo_fora:
    - Gestão interna tickets (RF073)
    - Criação categorias (RF021)
    - Criação artigos FAQ (RF070)

funcionalidades:
  - id: F-SD-074-01
    nome: Visualizar Meus Chamados
    atores: [Solicitante]
    permissao: tkt:selfservice:read
  - id: F-SD-074-02
    nome: Criar Chamado Wizard 3-Passos
    atores: [Solicitante]
    permissao: tkt:selfservice:create
  - id: F-SD-074-03
    nome: Ver Detalhes Chamado
    atores: [Solicitante]
    permissao: tkt:selfservice:read
  - id: F-SD-074-04
    nome: Adicionar Comentário Público
    atores: [Solicitante]
    permissao: tkt:selfservice:comment
  - id: F-SD-074-05
    nome: Receber Notificações Real-Time
    atores: [Solicitante, Sistema]
    permissao: null
  - id: F-SD-074-06
    nome: Avaliar Atendimento CSAT
    atores: [Solicitante]
    permissao: tkt:selfservice:csat
  - id: F-SD-074-07
    nome: Buscar FAQ Integrada
    atores: [Solicitante]
    permissao: tkt:faq:read
  - id: F-SD-074-08
    nome: Acessar Portal Offline PWA
    atores: [Solicitante, Service Worker]
    permissao: null
  - id: F-SD-074-09
    nome: Receber Notificações Push
    atores: [Solicitante, Sistema]
    permissao: null
  - id: F-SD-074-10
    nome: Configurar Preferências Notificação
    atores: [Solicitante]
    permissao: tkt:selfservice:read

regras_negocio:
  - id: RN-SD-074-01
    titulo: Isolamento Dados por Usuário
    descricao: WHERE UserId = CurrentUserId AND ClienteId = CurrentClienteId em todas queries
  - id: RN-SD-074-02
    titulo: Wizard 3-Passos Obrigatório
    descricao: Criação apenas via wizard; API direta desabilitada para usuários finais
  - id: RN-SD-074-03
    titulo: Categorias do Catálogo
    descricao: Dropdown preenchido de ServicoCategoria (RF021); cards se tem ícone
  - id: RN-SD-074-04
    titulo: FAQ Busca Real-Time
    descricao: Modal Ctrl+/ com busca em títulos/conteúdo; top 5 resultados
  - id: RN-SD-074-05
    titulo: Notificações SignalR
    descricao: Real-time via WebSocket; fallback polling 30s se falhar
  - id: RN-SD-074-06
    titulo: Comentários Públicos Apenas
    descricao: Apenas visibilidade Externa; internos NUNCA exibidos
  - id: RN-SD-074-07
    titulo: CSAT Inline
    descricao: Popup inline 1-5 stars pós-Resolvido; não email externo
  - id: RN-SD-074-08
    titulo: Upload Antivírus
    descricao: Máx 5 MB; tipos jpg,png,pdf,log,txt; ClamAV scan; Azure Blob
  - id: RN-SD-074-09
    titulo: Auditoria Completa
    descricao: Todas ações auditadas; retenção 7 anos LGPD
  - id: RN-SD-074-10
    titulo: PWA Offline
    descricao: Service worker cache tickets/categorias/FAQ; queue escrita offline
  - id: RN-SD-074-11
    titulo: Rate Limiting
    descricao: 10 tickets/hora; 5 comentários/min; HTTP 429 se exceder
  - id: RN-SD-074-12
    titulo: Multi-Tenancy Isolamento
    descricao: ClienteId obrigatório todas queries; cross-tenant HTTP 403
  - id: RN-SD-074-13
    titulo: i18n
    descricao: pt-BR, en-US, es-ES; fallback pt-BR
  - id: RN-SD-074-14
    titulo: Responsividade Mobile-First
    descricao: Breakpoints <768px, 768-1024px, >1024px; botões 44x44px
  - id: RN-SD-074-15
    titulo: Acessibilidade WCAG 2.1 AA
    descricao: Navegação teclado; ARIA labels; contraste 4.5:1

integracoes_obrigatorias:
  central_funcionalidades:
    required: true
    chave: SELFSERVICE_PORTAL_ENABLED
    sub_features:
      - SELFSERVICE_CSAT_INLINE
      - SELFSERVICE_FAQ_INTEGRATION
      - SELFSERVICE_OFFLINE_MODE
      - SELFSERVICE_PUSH_NOTIFICATIONS
  i18n:
    required: true
    idiomas: [pt-BR, en-US, es-ES]
    fallback: pt-BR
  auditoria:
    required: true
    codigos:
      - TKT_SELFSERVICE_CREATE
      - TKT_SELFSERVICE_VIEW
      - TKT_SELFSERVICE_COMMENT
      - TKT_SELFSERVICE_CSAT
      - TKT_SELFSERVICE_FAQ_VIEW
    retencao_anos: 7
  rbac:
    required: true
    permissoes:
      - tkt:selfservice:read
      - tkt:selfservice:create
      - tkt:selfservice:comment
      - tkt:selfservice:csat
      - tkt:faq:read

endpoints_api:
  - metodo: GET
    rota: /api/my-tickets
    descricao: Listar meus chamados paginado
    permissao: tkt:selfservice:read
  - metodo: GET
    rota: /api/my-tickets/{id}
    descricao: Detalhes do meu chamado
    permissao: tkt:selfservice:read
  - metodo: POST
    rota: /api/my-tickets
    descricao: Criar chamado wizard
    permissao: tkt:selfservice:create
  - metodo: GET
    rota: /api/my-tickets/{id}/comments
    descricao: Comentários públicos
    permissao: tkt:selfservice:read
  - metodo: POST
    rota: /api/my-tickets/{id}/comments
    descricao: Adicionar comentário+arquivo
    permissao: tkt:selfservice:comment
  - metodo: POST
    rota: /api/my-tickets/{id}/satisfaction
    descricao: Submeter CSAT
    permissao: tkt:selfservice:csat
  - metodo: GET
    rota: /api/service-categories
    descricao: Categorias wizard passo 1
    permissao: tkt:selfservice:read
  - metodo: GET
    rota: /api/faq/search
    descricao: Buscar artigos FAQ
    permissao: tkt:faq:read

dependencias:
  rf_dependentes_criticas:
    - RF073: Gestão Interna Tickets (base dados compartilhada)
    - RF021: Catálogo Serviços (categorias wizard)
    - RF070: Base Conhecimento (FAQ integrada)
    - RF028: SLA Operações (exibição prazos)
  rf_impactados:
    - RF066: Notificações Alertas
    - RF001: Gestão Usuários
    - RF002: Gestão Empresas

metricas_kpis:
  - nome: Taxa Auto-Resolução FAQ
    meta: "≥ 20%"
  - nome: Tempo Criação Wizard
    meta: "< 2 min"
  - nome: CSAT Médio
    meta: "≥ 4.0 stars"
  - nome: Taxa Resposta CSAT
    meta: "≥ 60%"
  - nome: Adoção PWA Offline
    meta: "≥ 10%"
  - nome: Performance P75
    meta: "< 1s"
  - nome: Taxa Upload Sucesso
    meta: "≥ 99%"
  - nome: Taxa Detecção Malware
    meta: "100%"

criterios_aceite:
  backend:
    - 15 RNs implementadas
    - Hub SignalR real-time
    - Rate limiting 10/h 5/min
    - Isolamento UserId+ClienteId
    - ClamAV antivírus
    - Azure Blob Storage
    - Auditoria automática
    - Multi-tenancy
    - Cobertura >80%
  frontend:
    - Wizard 3-passos
    - Cards responsivos mobile-first
    - SignalR client
    - FAQ modal debounced
    - CSAT inline
    - PWA service worker
    - Push notifications
    - i18n pt/en/es
    - WCAG 2.1 AA
    - Performance P75 <1s
