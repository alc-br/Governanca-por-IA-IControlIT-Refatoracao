# CONTRATO DE GERA√á√ÉO E EXECU√á√ÉO DE TESTES E2E COM PLAYWRIGHT

**‚ö†Ô∏è DEPRECADO EM:** 2026-01-11
**Status:** DEPRECATED (N√ÉO USAR)
**Substitu√≠do por:**
- [CONTRATO-TESTES-E2E-ISOLADOS.md](../testes/CONTRATO-TESTES-E2E-ISOLADOS.md) (padr√£o recomendado para 90% dos casos)
- [CONTRATO-TESTES-E2E-STATEFUL.md](../testes/CONTRATO-TESTES-E2E-STATEFUL.md) (apenas para CRUD completo com depend√™ncias sequenciais)

**Motivo da deprecia√ß√£o:**
Este contrato promovia uso de `test.describe.serial` (stateful) como padr√£o, causando problemas sistem√°ticos:
- ‚ùå Taxa de aprova√ß√£o E2E: 10-60% (vs 95-100% do padr√£o isolated)
- ‚ùå Contamina√ß√£o de estado entre testes (67% dos problemas RF006)
- ‚ùå Overlay/backdrop persistente entre testes
- ‚ùå Depend√™ncias impl√≠citas entre testes
- ‚ùå Debug dif√≠cil (teste falha por problema em teste anterior)

**Evid√™ncias:**
- RF006: 12 execu√ß√µes necess√°rias para atingir 74% aprova√ß√£o (meta: 100%)
- RF006: Apenas 10-60% aprova√ß√£o E2E por contamina√ß√£o de estado
- An√°lise completa: `D:\IC2\.temp_ia\RELATORIO-TESTES-RF006-2026-01-11.md`
- Proposta de substitui√ß√£o: `D:\IC2\.temp_ia\PROPOSTA-ARQUITETO-INTEGRACAO-E2E-ISOLADOS.md`

**Migra√ß√£o:**
Se voc√™ precisa criar novos testes E2E, use:
1. [geracao-e2e-isolados.md](../prompts/testes/geracao-e2e-isolados.md) (90% dos casos - RECOMENDADO)
2. [geracao-testes-e2e-stateful.md](../prompts/testes/geracao-testes-e2e-stateful.md) (apenas CRUD completo)

**IMPORTANTE:** Este arquivo foi movido para `contracts/deprecated/` e N√ÉO DEVE ser usado.

---

# [ARQUIVO ORIGINAL ABAIXO - N√ÉO USAR]

---

**Vers√£o:** 1.0
**Data:** 2026-01-02
**Status:** DEPRECATED (veja nota acima)
**Changelog v1.0:** Cria√ß√£o do contrato para gera√ß√£o autom√°tica de specs Playwright a partir de TC e MT

---

## üìã SUM√ÅRIO EXECUTIVO

### ‚ö° O que este contrato faz

Este contrato **GERA e EXECUTA testes E2E Playwright** automaticamente a partir de **TC-RFXXX.yaml** e **MT-RFXXX.yaml**, garantindo:

- ‚úÖ **Gera√ß√£o Autom√°tica**: Specs Playwright (.spec.ts) gerados a partir de TC
- ‚úÖ **Dados Automatizados**: MT usado como dados de setup antes dos testes
- ‚úÖ **Simula√ß√£o Real**: Testes simulam usu√°rio real (clicar, preencher, navegar)
- ‚úÖ **Valida√ß√£o Completa**: Todos os 4 estados renderizados (Padr√£o, Loading, Vazio, Erro)
- ‚úÖ **Responsabiliza√ß√£o**: Falhas atribu√≠das a backend ou frontend automaticamente
- ‚úÖ **Evid√™ncias Autom√°ticas**: Screenshots, v√≠deos, logs gerados

---

## 1. Identifica√ß√£o do Agente

| Campo | Valor |
|-------|-------|
| **Papel** | Agente Gerador e Executor de Testes E2E Playwright |
| **Escopo** | Gera√ß√£o de specs + Execu√ß√£o + Relat√≥rio de evid√™ncias |
| **Modo** | Automa√ß√£o completa (sem interven√ß√£o manual) |

---

## 2. Ativa√ß√£o do Contrato

Este contrato √© ativado quando a solicita√ß√£o mencionar explicitamente:

> **"Conforme geracao-testes-e2e-playwright para RFXXX"**

Exemplo:
```
Conforme geracao-testes-e2e-playwright para RF060.
Seguir D:\IC2\CLAUDE.md.
```

---

## 3. PR√â-REQUISITOS OBRIGAT√ìRIOS (BLOQUEANTES)

O contrato TRAVA se qualquer condi√ß√£o falhar:

| Pr√©-requisito | Descri√ß√£o | Bloqueante |
|---------------|-----------|------------|
| TC-RFXXX.yaml | Casos de teste criados e validados | Sim |
| MT-RFXXX.yaml | Massa de teste criada e validada | Sim |
| UC-RFXXX.md | Casos de uso para contexto | Sim |
| MD-RFXXX.md | Modelo de dados para setup | Sim |
| Backend aprovado | Valida√ß√£o backend = 100% | Sim |
| Frontend aprovado | Valida√ß√£o frontend = 100% | Sim |
| STATUS.yaml | `documentacao.tc = true` E `documentacao.mt = true` | Sim |

**PARAR se qualquer item falhar.**

---

## 3.1 SETUP DE AMBIENTE (OBRIGAT√ìRIO - AUTOM√ÅTICO)

**REGRA CR√çTICA:** O agente DEVE SEMPRE iniciar backend e frontend ANTES de executar testes E2E.

**‚ùå N√ÉO assumir que aplica√ß√£o est√° rodando**
**‚úÖ SEMPRE iniciar backend e frontend**

### 3.1.1 Build Obrigat√≥rio

```bash
cd backend/IControlIT.API
dotnet build --no-incremental

cd frontend
npm run build
```

**Se build falhar:** REPROVAR imediatamente

### 3.1.2 Aplicar Seeds Funcionais

```bash
cd backend/IControlIT.API
dotnet ef database update
```

### 3.1.3 Iniciar Backend (Background)

```bash
cd backend/IControlIT.API
dotnet run &
```

**Aguardar pronto:** Polling em `http://localhost:5000/health` (timeout 60s)

### 3.1.4 Iniciar Frontend (Background)

```bash
cd frontend
npm start &
```

**Aguardar pronto:** Polling em `http://localhost:4200` (timeout 120s)

### 3.1.5 Valida√ß√£o de Ambiente

Antes de QUALQUER teste E2E:
- ‚úÖ Backend respondendo (http://localhost:5000/health = 200)
- ‚úÖ Frontend respondendo (http://localhost:4200 = 200)

**Se QUALQUER valida√ß√£o falhar:** REPROVAR com "ENVIRONMENT_SETUP_FAILED"

### 3.1.6 Credenciais de Teste (OBRIGAT√ìRIO)

**REGRA CR√çTICA:** NUNCA assuma credenciais. SEMPRE use as credenciais definidas nos seeds.

**Credenciais Padr√£o (Seeds):**

| Perfil | Email | Senha | Uso em Testes |
|--------|-------|-------|---------------|
| **Admin Teste** | `admin@teste.com` | `Test@123` | Testes gerais E2E (recomendado) |
| **Usu√°rio Teste** | `usuario@teste.com` | `Test@123` | Testes de permiss√µes limitadas |
| **Sem Permiss√£o** | `sempermissao@teste.com` | `Test@123` | Testes de autoriza√ß√£o (403) |

**Fonte de Verdade:** `D:\IC2\backend\IControlIT.API/src/Infrastructure/Data/ApplicationDbContextInitialiser.cs`

**Exemplo em spec Playwright:**
```typescript
test('TC-E2E-001: Login e acesso ao m√≥dulo', async ({ page }) => {
  // CORRETO: Usar credenciais dos seeds
  await page.goto('http://localhost:4200/sign-in');
  await page.fill('[data-test="email"]', 'admin@teste.com');
  await page.fill('[data-test="password"]', 'Test@123');
  await page.click('[data-test="sign-in-button"]');

  // Validar login bem-sucedido
  await expect(page).toHaveURL(/dashboard/);
});
```

**PROIBIDO:**
- ‚ùå Assumir credenciais n√£o documentadas
- ‚ùå Usar credenciais hardcoded sem validar nos seeds
- ‚ùå Ignorar campo `contexto.autenticacao` da MT

---

## 3.2 DEPEND√äNCIA CR√çTICA - Data-test Attributes (BLOQUEANTE)

**Testes E2E Playwright DEPENDEM ABSOLUTAMENTE de data-test attributes nos componentes Angular.**

### Valida√ß√£o Pr√©-teste (BLOQUEANTE)

Antes de gerar specs Playwright, o agente DEVE validar que componentes t√™m data-test:

```bash
# Verificar presen√ßa de data-test no m√≥dulo do RF
grep -r "data-test=" frontend/src/app/modules/RFXXX/

# Se resultado vazio ou insuficiente ‚Üí BLOQUEAR gera√ß√£o de testes
```

**Elementos que DEVEM ter data-test:**
- Bot√µes (salvar, cancelar, excluir, etc.)
- Campos de formul√°rio (input, select, textarea)
- Links de navega√ß√£o
- Grids/tabelas (headers, rows)
- Modals/dialogs

### BLOQUEIO: Frontend sem data-test

Se componente N√ÉO tiver data-test attributes:

1. **PARAR** gera√ß√£o de testes imediatamente
2. **REPORTAR** elementos faltantes ao usu√°rio
3. **DECLARAR** que testes E2E n√£o podem ser gerados
4. **SUGERIR** ativa√ß√£o de corre√ß√£o sist√™mica cross-RF para data-test
5. **AGUARDAR** corre√ß√£o do frontend

**Mensagem de Bloqueio:**
```
‚ùå BLOQUEIO: Componentes do RFXXX sem data-test attributes

Elementos faltantes:
- Bot√£o "Salvar" (sem data-test)
- Campo "Nome" (sem data-test)
- Grid "Clientes" (sem data-test)

A√á√ÉO NECESS√ÅRIA:
1. Corrigir frontend para adicionar data-test attributes
2. Seguir padr√£o: data-test="<contexto>-<elemento>-<acao>"
3. Ver: docs/CONVENTIONS.md (se√ß√£o 5.6 - Data-test Attributes)

TESTES E2E N√ÉO PODEM SER GERADOS sem data-test attributes.
```

### Seletores Obrigat√≥rios (SEMPRE usar data-test)

**TODOS os seletores Playwright DEVEM usar data-test:**

```typescript
// ‚úÖ CORRETO - SEMPRE usar data-test
await page.click('[data-test="btn-save"]');
await page.fill('[data-test="input-name"]', 'Jo√£o Silva');
await page.selectOption('[data-test="select-status"]', 'Ativo');
await page.locator('[data-test="grid-clients"]').waitFor();

// ‚ùå INCORRETO - NUNCA usar (inst√°veis, podem quebrar)
await page.click('.btn-primary'); // ‚ùå classe CSS pode mudar
await page.click('#saveButton');  // ‚ùå ID pode mudar
await page.click('button:has-text("Salvar")'); // ‚ùå texto pode ser traduzido (i18n)
await page.locator('div.container > button'); // ‚ùå hierarquia pode mudar
```

**Raz√£o:**
- **Classes CSS** mudam em refatora√ß√µes de estilo
- **IDs** podem mudar em refatora√ß√µes de c√≥digo
- **Texto** muda com i18n (pt-BR, en-US, es-ES)
- **Hierarquia** muda em refatora√ß√µes de estrutura
- **data-test** √© est√°vel e explicitamente para testes

### Valida√ß√£o de Seletores (Autom√°tica)

Ao gerar specs, o agente DEVE validar:

```typescript
// Para CADA seletor gerado, validar que usa data-test
const seletoresInvalidos = specs
  .filter(spec => !spec.includes('[data-test="'))
  .length;

if (seletoresInvalidos > 0) {
  throw new Error('Specs cont√™m seletores sem data-test. Gera√ß√£o BLOQUEADA.');
}
```

### Exemplo Completo - RF006 (Gest√£o de Clientes)

**TC-RF006-E2E-001.yaml: Criar novo cliente**

**Frontend (CORRETO - COM data-test):**
```html
<form>
  <input data-test="input-name" formControlName="nome" />
  <input data-test="input-cnpj" formControlName="cnpj" />
  <button data-test="btn-save">Salvar</button>
  <button data-test="btn-cancel">Cancelar</button>
</form>
```

**Spec Playwright Gerado (CORRETO):**
```typescript
test('TC-RF006-E2E-001: Criar novo cliente', async ({ page }) => {
  // Navegar
  await page.goto('http://localhost:4200/clients');

  // Preencher formul√°rio (usando data-test)
  await page.fill('[data-test="input-name"]', 'Empresa Teste LTDA');
  await page.fill('[data-test="input-cnpj"]', '12.345.678/0001-90');

  // Salvar (usando data-test)
  await page.click('[data-test="btn-save"]');

  // Validar sucesso
  await expect(page.locator('[data-test="toast-success"]')).toBeVisible();
});
```

**Frontend (INCORRETO - SEM data-test):**
```html
<form>
  <input formControlName="nome" />
  <input formControlName="cnpj" />
  <button>Salvar</button>
  <button>Cancelar</button>
</form>
```

**Resultado:**
```
‚ùå BLOQUEIO: Testes E2E n√£o podem ser gerados
Raz√£o: Componentes sem data-test attributes
Status: AGUARDANDO corre√ß√£o do frontend
```

### Integra√ß√£o com Corre√ß√£o Sist√™mica Cross-RF

Se M√öLTIPLOS RFs n√£o t√™m data-test:

**Sugerir ao usu√°rio:**
```
üìã RECOMENDA√á√ÉO: Corre√ß√£o Sist√™mica Cross-RF

Identificados 42 RFs sem data-test attributes.

A√ß√£o sugerida:
1. Ativar: CONTRATO DE CORRE√á√ÉO SIST√äMICA CROSS-RF
2. Corrigir data-test em todos os 42 RFs simultaneamente
3. Tempo estimado: ~5 horas (vs 42 horas RF por RF)

Prompt pronto em:
prompts/manutencao/correcao-sistemica-cross-rf.md
```

**Ver padr√µes completos em:** `CONVENTIONS.md` (se√ß√£o 5.6 - Data-test Attributes)

---

## 4. CRIT√âRIO DE PRONTO

O contrato s√≥ √© considerado CONCLU√çDO quando:

### 4.1 Arquivos Gerados

- [ ] `D:\IC2\frontend\e2e/data/MT-RFXXX.data.ts` criado
- [ ] `D:\IC2\frontend\e2e/helpers/rf-helpers.ts` criado ou atualizado
- [ ] Specs Playwright criados (1 spec por TC-E2E)
- [ ] Evid√™ncias geradas (screenshots, traces, logs)
- [ ] Relat√≥rio consolidado criado

### 4.2 Execu√ß√£o Bem-Sucedida

- [ ] **Taxa de aprova√ß√£o = 100%** (TODOS os testes passaram)
- [ ] Todos os 4 estados validados (Padr√£o, Loading, Vazio, Erro)
- [ ] i18n validado (pt-BR, en-US, es-ES)
- [ ] CRUD completo validado (criar, editar, excluir, consultar)
- [ ] Seguran√ßa validada (401, 403)
- [ ] Multi-tenancy validado (isolamento entre tenants)

### 4.3 Rastreabilidade Completa

- [ ] Todos TC-E2E-NNN t√™m spec correspondente
- [ ] Todos specs referenciam MT correspondente
- [ ] Falhas (se houver) t√™m respons√°vel identificado
- [ ] Prompts de corre√ß√£o gerados (se reprovado)

**REGRA DE BLOQUEIO:** Se taxa de aprova√ß√£o < 100%, RF N√ÉO pode ser considerado PRONTO.

### 4.4 Exporta√ß√£o Azure DevOps (OBRIGAT√ìRIO)

Ap√≥s executar os testes E2E, o agente DEVE atualizar os arquivos Azure DevOps com resultados:

**Atualizar `azure-test-cases-RF[XXX].csv`:**
- [ ] Coluna "State" atualizada (Design ‚Üí Ready ‚Üí Active ‚Üí Closed)
- [ ] Resultados de execu√ß√£o adicionados (se aplic√°vel)
- [ ] Data de √∫ltima execu√ß√£o registrada

**Atualizar STATUS.yaml:**
```yaml
testes:
  azure_devops:
    ultima_execucao_e2e: "2026-01-02"
    taxa_aprovacao_e2e: "100%"
    specs_playwright_gerados: true
    total_specs_e2e: 3  # N√∫mero de specs TC-E2E
```

---

## 5. REGRA DE NEGA√á√ÉO ZERO

Se uma solicita√ß√£o:
- n√£o estiver explicitamente prevista no contrato ativo, ou
- conflitar com qualquer regra do contrato

ENT√ÉO:

- A execu√ß√£o DEVE ser NEGADA
- Nenhuma a√ß√£o parcial pode ser realizada
- Nenhum "adiantamento" √© permitido

---

**FIM DO CONTRATO**
