# =============================================
# RL-RF013: Referência ao Legado - Gestão de Perfis de Acesso
# Versão: 1.0
# Data: 2025-12-30
# Autor: Agência ALC - alc.dev.br
# =============================================

rf_id: RF013
titulo: "Gestão de Perfis de Acesso (RBAC)"

legado:
  sistema: "VB.NET + ASP.NET Web Forms 4.x"
  versao: "Legado IControlIT v3.x"
  arquitetura: "Monolítica WebForms"
  banco_dados: "SQL Server (múltiplas instâncias separadas por cliente)"
  multi_tenant: false  # Separação física (18+ bancos)
  auditoria: "partial"  # Logs manuais em algumas operações

# =============================================
# SEÇÃO CRÍTICA: Referências ao Legado com Destino Obrigatório
# Cada item DEVE ter campo "destino" preenchido
# =============================================

referencias:
  # --- TELAS LEGADO ---

  - id: "LEG-RF013-001"
    tipo: "tela"
    nome: "Usuario_Perfil.aspx"
    caminho: "ic1_legado/IControlIT/IControlIT/Cadastro/Usuario_Perfil.aspx"
    descricao: |
      Tela principal de gestão de perfis de acesso no legado.
      Componentes principais:
      - DropDownList de níveis (AutoPostBack)
      - DataGrid de ativos vinculados
      - ListBox duplo para selecionar permissões (disponíveis ↔ atribuídas)
      - Botões Adicionar/Remover para mover permissões
      - Campos ReadOnly com cor laranja (convenção visual)

    destino: "substituido"
    justificativa: |
      Interface WebForms substituída por componentes Angular Material modernos:
      - Checkboxes organizados por módulo (ao invés de ListBox duplo)
      - Mat-Table para visualização de usuários vinculados
      - Formulário responsivo com validação em tempo real
      Melhora significativa em UX e performance.

    documentacao_item_relacionado: "Seção 7 - Interface Angular Moderna"
    uc_relacionado: "UC02"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  # --- WEBSERVICES LEGADO ---

  - id: "LEG-RF013-002"
    tipo: "webservice"
    nome: "PerfilService.asmx/CriarPerfil()"
    caminho: "ic1_legado/IControlIT/Services/PerfilService.asmx"
    descricao: |
      WebService SOAP para criação de perfil.
      Validação manual de unicidade de nome (case-sensitive).
      Retorna string genérica ("success" ou mensagem de erro).

    destino: "substituido"
    justificativa: |
      SOAP substituído por REST API com CQRS (MediatR).
      Endpoint moderno: POST /api/perfis (CreateRoleCommand).
      Validação automática via FluentValidation.
      Retorno estruturado com Result pattern.

    documentacao_item_relacionado: "RN-RF013-01"
    uc_relacionado: "UC01"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 1

  - id: "LEG-RF013-003"
    tipo: "webservice"
    nome: "PerfilService.asmx/ExcluirPerfil()"
    caminho: "ic1_legado/IControlIT/Services/PerfilService.asmx"
    descricao: |
      WebService SOAP para exclusão de perfil.
      Realiza DELETE físico (dados perdidos permanentemente).
      Validação manual se há usuários vinculados (pode ser burlada).

    destino: "substituido"
    justificativa: |
      DELETE físico substituído por soft delete (Fl_Ativo = 0).
      Preservação de dados históricos e conformidade LGPD.
      Validação automática via EF Core (não pode ser burlada).

    documentacao_item_relacionado: "RN-RF013-08, RN-RF013-10"
    uc_relacionado: "UC04"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 1

  - id: "LEG-RF013-004"
    tipo: "webservice"
    nome: "PerfilService.asmx/AtribuirPermissoes()"
    caminho: "ic1_legado/IControlIT/Services/PerfilService.asmx"
    descricao: |
      Atribui múltiplas permissões a um perfil.
      Recebe array de IDs de permissões.
      Sem transação: pode falhar parcialmente (algumas permissões atribuídas, outras não).

    destino: "substituido"
    justificativa: |
      Substituído por endpoint transacional (AssignPermissionsToRoleCommand).
      Operação atômica: ou todas as permissões são atribuídas, ou nenhuma.
      Auditoria automática de cada atribuição.

    documentacao_item_relacionado: "Seção 4 - Gestão de Permissões"
    uc_relacionado: "UC02"
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: 1

  # --- REGRAS DE NEGÓCIO IMPLÍCITAS ---

  - id: "LEG-RF013-005"
    tipo: "regra_negocio"
    nome: "Perfis de Sistema Bloqueados para Edição (Parcial)"
    caminho: "ic1_legado/IControlIT/Cadastro/Usuario_Perfil.aspx.vb (linha ~230)"
    descricao: |
      Código VB.NET verifica se IsSystemRole = true e bloqueia edição de nome/descrição.
      Porém, permite deletar perfis de sistema se não houver usuários vinculados.
      Implementação:
        If perfil.IsSystemRole Then
            txtNome.Enabled = False
            txtDescricao.Enabled = False
        End If

    destino: "assumido"
    justificativa: |
      Comportamento mantido no RF-013 (RN-RF013-02).
      Perfis de Sistema são não-editáveis, mas deletáveis (se sem usuários).
      Validação movida para backend (FluentValidation).

    documentacao_item_relacionado: "RN-RF013-02"
    uc_relacionado: "UC02"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF013-006"
    tipo: "regra_negocio"
    nome: "Super Admin Bypassa Validações"
    caminho: "ic1_legado/IControlIT/Global.asax.vb (Application_AuthorizeRequest)"
    descricao: |
      Usuários com Fl_Super_Admin = 1 não passam por verificação de permissões.
      Implementação no Global.asax.vb:
        If usuarioAtual.Fl_Super_Admin Then
            ' Bypass todas as validações
            Return
        End If

    destino: "assumido"
    justificativa: |
      Comportamento essencial mantido no RF-013 (RN-RF013-03).
      Super Admin sempre tem acesso total irrestrito.
      Implementado no middleware de autorização (.NET).

    documentacao_item_relacionado: "RN-RF013-03"
    uc_relacionado: null
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 1

  - id: "LEG-RF013-007"
    tipo: "regra_negocio"
    nome: "Validação de Nome Único (Manual, Case-Sensitive)"
    caminho: "ic1_legado/IControlIT/Cadastro/Usuario_Perfil.aspx.vb (ValidarNomeUnico())"
    descricao: |
      Validação manual via query SQL direta (vulnerável a SQL Injection).
      Case-sensitive: permite criar "Administrador" e "administrador" como perfis diferentes.
      Implementação:
        Dim sql = "SELECT COUNT(*) FROM Perfil WHERE Nm_Perfil = '" & txtNome.Text & "'"

    destino: "substituido"
    justificativa: |
      Substituído por constraint UNIQUE no banco (UQ_Perfil_Nome_Tenant).
      Validação case-insensitive (evita duplicação).
      EF Core parametrizado (sem SQL Injection).

    documentacao_item_relacionado: "RN-RF013-01"
    uc_relacionado: "UC01"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 1

  - id: "LEG-RF013-008"
    tipo: "regra_negocio"
    nome: "Exclusão Bloqueada Se Houver Usuários (Manual)"
    caminho: "ic1_legado/IControlIT/Cadastro/Usuario_Perfil.aspx.vb (ExcluirPerfil())"
    descricao: |
      Validação manual: conta usuários vinculados antes de deletar.
      Vulnerável a race conditions (2 requests simultâneas podem burlar).
      Implementação:
        Dim countUsuarios = db.ExecuteScalar("SELECT COUNT(*) FROM Usuario WHERE Id_Perfil = " & perfilId)
        If countUsuarios > 0 Then
            ShowError("Não é possível excluir perfil com usuários vinculados")
        End If

    destino: "assumido"
    justificativa: |
      Comportamento mantido no RF-013 (RN-RF013-08).
      Porém, validação movida para backend com transação (EF Core).
      Não vulnerável a race conditions (validação atômica).

    documentacao_item_relacionado: "RN-RF013-08"
    uc_relacionado: "UC04"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 1

  - id: "LEG-RF013-009"
    tipo: "regra_negocio"
    nome: "Fl_Desativado = 2 Significa Ativo (Confuso)"
    caminho: "Schema do banco de dados legado"
    descricao: |
      Campo Fl_Desativado INT com valores:
        1 = Desativado
        2 = Ativo (!?)
      Causa confusão semântica e desperdício de espaço (INT vs BIT).
      DDL:
        Fl_Desativado INT DEFAULT 2 CHECK (Fl_Desativado IN (1, 2))

    destino: "substituido"
    justificativa: |
      Substituído por Fl_Ativo BIT (0=inativo, 1=ativo).
      Clareza semântica e economia de espaço.
      Script de migração disponível.

    documentacao_item_relacionado: "RN-RF013-10"
    uc_relacionado: null
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF013-010"
    tipo: "regra_negocio"
    nome: "Sem Cache de Permissões (Performance Degradada)"
    caminho: "Observado em testes de carga"
    descricao: |
      Toda requisição consulta banco para verificar permissões do usuário.
      Com muitas requisições simultâneas, causa lentidão (observado degradação 5x em testes).

    destino: "substituido"
    justificativa: |
      Implementado cache Redis com TTL de 5 minutos (RN-RF013-07).
      Performance melhorada em ~10x em testes de carga.
      Invalidação automática ao alterar permissões.

    documentacao_item_relacionado: "RN-RF013-07"
    uc_relacionado: null
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: 1

  # --- STORED PROCEDURES (Não aplicável neste RF) ---

  # --- COMPONENTES UI ---

  - id: "LEG-RF013-011"
    tipo: "componente"
    nome: "ListBox Duplo de Permissões"
    caminho: "ic1_legado/IControlIT/Cadastro/Usuario_Perfil.aspx"
    descricao: |
      Interface clássica de seleção de permissões:
      - ListBox esquerda: permissões disponíveis
      - Botões no meio (Adicionar/Remover)
      - ListBox direita: permissões atribuídas
      Carrega todas as permissões de uma vez (sem paginação).

    destino: "substituido"
    justificativa: |
      Substituído por checkboxes organizados por módulo (Angular Material).
      Melhor UX, paginação server-side, busca/filtro.

    documentacao_item_relacionado: "Seção 7 - Interface Angular Moderna"
    uc_relacionado: "UC02"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 2

# =============================================
# TELAS LEGADAS (estrutura detalhada)
# =============================================

telas:
  - id: "LEG-RF013-001"
    nome: "Usuario_Perfil.aspx"
    caminho: "ic1_legado/IControlIT/IControlIT/Cadastro/Usuario_Perfil.aspx"
    responsabilidade: "Gerenciar perfis de acesso (CRUD) e atribuir permissões"
    campos:
      - nome: "txtNome"
        tipo: "TextBox"
        obrigatorio: true
        validacao: "Manual (case-sensitive)"
      - nome: "txtDescricao"
        tipo: "TextBox"
        obrigatorio: false
        validacao: "Nenhuma"
      - nome: "ddlNivel"
        tipo: "DropDownList"
        obrigatorio: false
        validacao: "AutoPostBack (recarrega grid)"
      - nome: "lstPermissoesDisponiveis"
        tipo: "ListBox"
        obrigatorio: false
        validacao: "Carrega todas de uma vez (sem paginação)"
      - nome: "lstPermissoesAtribuidas"
        tipo: "ListBox"
        obrigatorio: false
        validacao: "Sincronizado via código VB.NET"
    comportamentos_implicitos:
      - "AutoPostBack no DropDownList causa reload completo da página"
      - "Campos ReadOnly com cor laranja (convenção visual não semântica)"
      - "Sem confirmação de exclusão (deletar direto)"
      - "Validação de nome único case-sensitive (permite duplicação)"

# =============================================
# WEBSERVICES LEGADOS
# =============================================

servicos:
  - id: "LEG-RF013-002"
    nome: "PerfilService.asmx"
    localizacao: "ic1_legado/IControlIT/Services/PerfilService.asmx"
    responsabilidade: "CRUD de perfis e gestão de permissões"
    metodos:
      - "CriarPerfil()"
      - "AtualizarPerfil()"
      - "ExcluirPerfil()"
      - "ObterPermissoes()"
      - "AtribuirPermissoes()"
    notas: "WebService SOAP, retornos genéricos (string), sem transações"

# =============================================
# TABELAS LEGADAS COM PROBLEMAS
# =============================================

tabelas:
  - nome: "Perfil"
    finalidade: "Armazenar perfis de acesso"
    problemas:
      - "Sem constraint UNIQUE (permite duplicação de nome)"
      - "Fl_Desativado INT (confuso, deveria ser Fl_Ativo BIT)"
      - "Sem campos de auditoria (Created, CreatedBy, LastModified, LastModifiedBy)"
      - "Sem multi-tenancy lógico (TenantId ausente)"
      - "Chave primária INT (não GUID, dificulta merge)"

  - nome: "Permissao"
    finalidade: "Catálogo de permissões disponíveis"
    problemas:
      - "Cd_Permissao sem padrão (inconsistente: 'CRIAR_USUARIO', 'usuario.criar', 'usuario:criar')"
      - "Nm_Permissao hardcoded em português (sem i18n)"
      - "Sem auditoria de criação/modificação"

  - nome: "Perfil_Permissao"
    finalidade: "Relacionamento N:N entre perfis e permissões"
    problemas:
      - "Sem PK composta (permite duplicação)"
      - "ON DELETE CASCADE (perigoso, apaga sem log)"
      - "Sem auditoria de quem/quando atribuiu permissão"

# =============================================
# REGRAS IMPLÍCITAS (não documentadas)
# =============================================

regras_implicitas:
  - id: "RL-RN-001"
    descricao: |
      Perfis de Sistema bloqueados para edição de nome/descrição,
      mas deletáveis se não houver usuários vinculados.
    fonte: "Usuario_Perfil.aspx.vb, linha ~230"
    destino: "assumido"

  - id: "RL-RN-002"
    descricao: |
      Super Admin bypassa todas as validações de permissões.
    fonte: "Global.asax.vb, Application_AuthorizeRequest"
    destino: "assumido"

  - id: "RL-RN-003"
    descricao: |
      Validação de nome único manual, case-sensitive, vulnerável a SQL Injection.
    fonte: "Usuario_Perfil.aspx.vb, ValidarNomeUnico()"
    destino: "substituido"

  - id: "RL-RN-004"
    descricao: |
      Exclusão bloqueada se houver usuários vinculados (validação manual).
    fonte: "Usuario_Perfil.aspx.vb, ExcluirPerfil()"
    destino: "assumido"

  - id: "RL-RN-005"
    descricao: |
      Fl_Desativado = 2 significa ativo (confuso semanticamente).
    fonte: "Schema do banco de dados"
    destino: "substituido"

  - id: "RL-RN-006"
    descricao: |
      Sem cache de permissões (toda requisição consulta banco).
    fonte: "Observado em testes de carga"
    destino: "substituido"

# =============================================
# GAP ANALYSIS (Legado x Moderno)
# =============================================

gap_analysis:
  - item: "Arquitetura"
    existe_legado: true
    descricao_legado: "WebForms monolítico"
    existe_moderno: true
    descricao_moderno: "REST API + CQRS + Angular"
    notas: "Modernização completa de stack tecnológico"

  - item: "Validação"
    existe_legado: true
    descricao_legado: "Manual no code-behind"
    existe_moderno: true
    descricao_moderno: "FluentValidation + Middleware"
    notas: "Centralizado e automatizado"

  - item: "Auditoria"
    existe_legado: true
    descricao_legado: "Logs manuais parciais"
    existe_moderno: true
    descricao_moderno: "BaseAuditableEntity automático"
    notas: "Conformidade LGPD garantida"

  - item: "Cache"
    existe_legado: false
    descricao_legado: "Sem cache"
    existe_moderno: true
    descricao_moderno: "Redis (5 min TTL)"
    notas: "Performance melhorada ~10x"

  - item: "Multi-tenancy"
    existe_legado: true
    descricao_legado: "Bancos separados (18+)"
    existe_moderno: true
    descricao_moderno: "Row-Level Security (1 banco)"
    notas: "Redução de custos operacionais"

  - item: "Soft Delete"
    existe_legado: false
    descricao_legado: "DELETE físico"
    existe_moderno: true
    descricao_moderno: "Fl_Ativo = 0"
    notas: "Preservação de dados históricos"

# =============================================
# DECISÕES DE MODERNIZAÇÃO
# =============================================

decisoes_modernizacao:
  - decisao: "Substituir Fl_Desativado por Fl_Ativo"
    motivo: |
      Clareza semântica (Fl_Ativo = 1 é intuitivo).
      Economia de espaço (BIT 1 byte vs INT 4 bytes).
      Padrão da indústria.
    impacto: "baixo"
    data: "2025-12-30"
    script_migracao: |
      ALTER TABLE Role ADD Fl_Ativo BIT NULL;
      UPDATE Role SET Fl_Ativo = CASE WHEN Fl_Desativado = 2 THEN 1 ELSE 0 END;
      ALTER TABLE Role ALTER COLUMN Fl_Ativo BIT NOT NULL;
      ALTER TABLE Role DROP COLUMN Fl_Desativado;

  - decisao: "Implementar Soft Delete ao invés de DELETE físico"
    motivo: |
      Preservação de dados históricos.
      Conformidade LGPD (rastreabilidade).
      Possibilidade de recuperação (undo).
    impacto: "medio"
    data: "2025-12-30"

  - decisao: "Padronizar formato de permissões (modulo:recurso:acao)"
    motivo: |
      Legado tem formatos inconsistentes.
      Padronização facilita validação, logs, auditoria.
    impacto: "alto"
    data: "2025-12-30"
    script_normalizacao: |
      UPDATE Permissao SET Cd_Permissao = 'usuarios:usuario:create'
      WHERE Cd_Permissao IN ('CRIAR_USUARIO', 'usuario.criar');

  - decisao: "Centralizar Multi-Tenancy em 1 banco com Row-Level Security"
    motivo: |
      Redução de custos operacionais (18 bancos → 1).
      Simplificação de backups e disaster recovery.
      Facilita analytics cross-tenant.
    impacto: "alto"
    data: "2025-12-30"

# =============================================
# RISCOS DE MIGRAÇÃO
# =============================================

riscos_migracao:
  - risco: "Perda de dados durante migração de Fl_Desativado"
    impacto: "alto"
    probabilidade: "baixa"
    mitigacao: |
      Script de migração testado em ambiente dev.
      Backup completo antes de executar.

  - risco: "Queries lentas sem índices TenantId"
    impacto: "medio"
    probabilidade: "media"
    mitigacao: |
      Criar índices compostos antes de migração.
      Testes de carga pré-produção.

  - risco: "Inconsistência no formato de permissões"
    impacto: "medio"
    probabilidade: "media"
    mitigacao: |
      Script de normalização + validação pós-migração.

  - risco: "Usuários bloqueados por cache desatualizado"
    impacto: "baixo"
    probabilidade: "baixa"
    mitigacao: |
      Invalidação automática de cache ao alterar permissões.

# =============================================
# RASTREABILIDADE (Legado → Moderno)
# =============================================

rastreabilidade:
  - elemento_legado: "Usuario_Perfil.aspx"
    referencia_rf: "Seção 7 - Interface Angular Moderna"
    referencia_uc: "UC01-UC04"
    status: "substituido"

  - elemento_legado: "PerfilService.asmx/CriarPerfil()"
    referencia_rf: "RN-RF013-01"
    referencia_uc: "UC01"
    status: "substituido"

  - elemento_legado: "Fl_Desativado INT"
    referencia_rf: "RN-RF013-10"
    referencia_uc: null
    status: "substituido"

  - elemento_legado: "Super Admin bypass"
    referencia_rf: "RN-RF013-03"
    referencia_uc: null
    status: "assumido"

  - elemento_legado: "Perfis de Sistema bloqueados"
    referencia_rf: "RN-RF013-02"
    referencia_uc: "UC02"
    status: "assumido"

# =============================================
# CHANGELOG
# =============================================

changelog:
  - versao: "1.0"
    data: "2025-12-30"
    descricao: "Documentação inicial de referência ao legado - separação RF/RL v2.0"
    autor: "Agência ALC - alc.dev.br"
