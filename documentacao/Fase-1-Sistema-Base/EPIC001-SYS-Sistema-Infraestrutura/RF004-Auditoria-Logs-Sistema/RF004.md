# RF-004: Auditoria e Logs do Sistema

**Versão**: 2.0
**Data**: 2025-12-29
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC001-SYS - Sistema e Infraestrutura
**Fase**: Fase 1 - Fundação e Cadastros Base

---

## 1. OBJETIVO DO REQUISITO

Implementar o **Sistema de Auditoria Completa** do IControlIT, registrando todas as operações críticas do sistema para compliance (LGPD, SOX, ISO 27001), troubleshooting, segurança e análise forense.

Este RF é **CRÍTICO PARA COMPLIANCE** pois garante rastreabilidade completa de todas as ações de usuários e mudanças de dados, atendendo requisitos regulatórios de LGPD (Art. 37, 38, 46), SOX (Seção 404) e ISO 27001.

**Diferença: RF-003 (Logs) vs RF-004 (Auditoria)**

| Aspecto | RF-003 (Logs Técnicos) | RF-004 (Auditoria de Negócio) |
|---------|------------------------|-------------------------------|
| **Foco** | Logs de aplicação, performance, erros | Auditoria de ações de usuários e mudanças de dados |
| **Exemplos** | Exception logs, response time, queries SQL | Usuário criou fatura, alterou perfil, exportou relatório |
| **Armazenamento** | Seq/Elasticsearch (otimizado para volume) | SQL Server (estruturado, relacional, imutável) |
| **Retenção** | 90 dias (padrão), 7 anos (segurança) | **7 anos obrigatório** (compliance SOX/LGPD) |
| **Granularidade** | Request/Response HTTP, exceptions | Operação de negócio (CRUD em entidades) |
| **Busca** | Full-text search (Seq/Elasticsearch) | SQL queries (filtros estruturados) |
| **Usuário Final** | Desenvolvedores, DevOps | Auditores, Compliance, Gerentes |

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- ✅ **Auditoria Automática**: Interceptor MediatR registra todas as operações
- ✅ **Snapshot de Dados**: Armazena estado anterior e novo (diff JSON)
- ✅ **Rastreamento de Usuário**: Quem fez, quando, de onde (IP), com qual dispositivo
- ✅ **Categorização**: Operações categorizadas (CRUD, EXPORT, ACCESS, LOGIN, etc.)
- ✅ **Retenção Configurável**: 7 anos (SOX/LGPD), 90 dias (operações não críticas)
- ✅ **Busca Avançada**: Filtros por usuário, entidade, período, tipo de operação
- ✅ **Timeline de Entidade**: Histórico completo de mudanças de uma entidade
- ✅ **Relatórios de Compliance**: Exportação formatada para auditores
- ✅ **Detecção de Anomalias**: Padrões suspeitos (ex: 100 exportações em 1h)
- ✅ **Auditoria de LGPD**: Registro de acesso, consentimento, exclusão de dados
- ✅ **Segregação de Funções**: Auditoria de acesso a funções críticas (SOX)
- ✅ **Imutabilidade**: Registros de auditoria NÃO podem ser alterados/deletados
- ✅ **Assinatura Digital**: Hash SHA-256 para garantir integridade
- ✅ **Arquivamento Automático**: Cold storage após 1 ano (Azure Blob)
- ✅ **Alertas de Compliance**: Notificar quando retention expira

### 2.2 Fora do escopo (não objetivos)

- ❌ Interface visual específica (UI definida em WF-004)
- ❌ Tecnologia de armazenamento específica (SQL Server é sugestão)
- ❌ Formato de export específico (CSV/JSON/PDF são sugestões)
- ❌ Estratégia de arquivamento (Azure Blob é sugestão)
- ❌ Análise de log técnico de aplicação (responsabilidade do RF-003)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Auditoria** | Registro imutável de uma operação executada por usuário, contendo o que foi feito, quando, por quem, de onde |
| **Snapshot** | Estado completo de uma entidade antes e depois de uma operação de mudança |
| **Diff (JSON Patch)** | Diferença estruturada entre estado anterior e novo, seguindo RFC 6902 |
| **Retention** | Período obrigatório de retenção de registros de auditoria (7 anos para compliance) |
| **Timeline** | Histórico cronológico completo de todas as mudanças de uma entidade específica |
| **Categoria** | Classificação da operação (CRUD, AUTH, EXPORT, ACCESS, CONFIG, LGPD, FINANCIAL, SECURITY, ADMIN, PRINT) |
| **Imutabilidade** | Garantia que registro de auditoria não pode ser alterado ou deletado após criação |
| **Assinatura Digital** | Hash SHA-256 calculado sobre o registro para garantir integridade |
| **Cold Storage** | Armazenamento de baixo custo para registros antigos (> 1 ano) |
| **Anomalia** | Padrão de comportamento suspeito detectado automaticamente |

---

## 4. FUNCIONALIDADES COBERTAS

1. ✅ **Registrar Auditoria Automática**: Via interceptor MediatR em todos os Commands/Queries
2. ✅ **Registrar Auditoria Manual**: Para casos especiais (LGPD, exports)
3. ✅ **Buscar Registros de Auditoria**: Filtros por usuário, entidade, período, tipo
4. ✅ **Visualizar Timeline de Entidade**: Histórico completo de mudanças
5. ✅ **Exportar Relatórios de Compliance**: LGPD, SOX, ISO 27001
6. ✅ **Detectar Anomalias**: Padrões suspeitos automaticamente
7. ✅ **Visualizar Dashboards Analíticos**: Métricas de uso e compliance
8. ✅ **Arquivar Registros Antigos**: Move registros > 1 ano para cold storage
9. ✅ **Alertar Retention Expirando**: Notificar 30 dias antes da expiração
10. ✅ **Validar Integridade**: Verificar hash SHA-256 dos registros

---

## 5. REGRAS DE NEGÓCIO

### RN-AUD-001 — Auditoria Automática via Interceptor

**Descrição**: Todo Command/Query do MediatR que altere dados DEVE registrar auditoria automaticamente através do `AuditingBehaviour<TRequest, TResponse>`.

**Justificativa**: Garante que nenhuma operação de mudança de dados passe sem auditoria, eliminando risco de compliance.

**Critério de Aceite**:
- Operações de CRUD (Create, Update, Delete) registram auditoria sem intervenção manual
- Operações de leitura (Query) registram auditoria se envolverem dados sensíveis (CPF, emails, dados financeiros)
- Falha na auditoria NÃO deve bloquear a operação principal (fire-and-forget com retry)

---

### RN-AUD-002 — Snapshot Completo (Antes/Depois)

**Descrição**: Para operações de UPDATE e DELETE, armazenar estado completo da entidade **ANTES** e **DEPOIS** da operação em formato JSON.

**Justificativa**: Permite reconstruir estado da entidade em qualquer ponto do tempo (Time Travel Debugging).

**Critério de Aceite**:
- Campo `Dados_Antes` contém JSON serializado do estado anterior
- Campo `Dados_Depois` contém JSON serializado do estado novo
- Operações CREATE têm `Dados_Antes = null`
- Operações DELETE têm `Dados_Depois = null`

---

### RN-AUD-003 — Diff Estruturado (JSON Patch)

**Descrição**: Calcular diff estruturado entre estado anterior e novo usando JSON Patch (RFC 6902) e armazenar no campo `Diff_JSON`.

**Justificativa**: Permite visualização clara de **o que mudou** sem necessidade de comparar JSONs completos.

**Critério de Aceite**:
- Diff armazenado em formato JSON Patch padrão RFC 6902
- Apenas campos que mudaram aparecem no diff
- Diff é legível e pode ser aplicado via library JSON Patch

**Exemplo de Diff**:
```json
[
  { "op": "replace", "path": "/Nome", "value": "João Silva" },
  { "op": "replace", "path": "/Email", "value": "joao.silva@example.com" }
]
```

---

### RN-AUD-004 — Retenção por Categoria (SOX/LGPD)

**Descrição**: Aplicar período de retenção diferenciado conforme categoria da operação:

| Categoria | Retenção | Justificativa |
|-----------|----------|---------------|
| **FINANCIAL** (transações financeiras) | 7 anos | SOX Seção 404 |
| **LGPD** (dados pessoais, consentimento) | 7 anos | LGPD Art. 37, 38, 46 |
| **SECURITY** (acesso, auth) | 7 anos | ISO 27001 |
| **CONFIG** (configurações críticas) | 7 anos | Compliance interno |
| **EXPORT** (exportação de dados) | 7 anos | LGPD Art. 18 (portabilidade) |
| **CRUD** (operações normais) | 1 ano | Troubleshooting |
| **ACCESS** (leitura não crítica) | 90 dias | Performance |
| **ADMIN** (operações admin) | 1 ano | Troubleshooting |

**Critério de Aceite**:
- Job diário purga registros expirados conforme retenção
- Alerta enviado 30 dias antes da expiração (para categorias críticas)
- Registros purgados são movidos para cold storage (Azure Blob) antes de deleção

---

### RN-AUD-005 — Imutabilidade Garantida

**Descrição**: Tabela `Sistema_Auditoria` é **append-only**. Registros NÃO podem ser atualizados ou deletados após criação.

**Justificativa**: Compliance SOX, LGPD e ISO 27001 exigem que registros de auditoria sejam imutáveis.

**Critério de Aceite**:
- Schema da tabela NÃO tem UPDATE ou DELETE permissions
- Tentativa de UPDATE/DELETE lança exceção
- Único método de remoção é via job automático após expiração de retention (com arquivamento prévio)

---

### RN-AUD-006 — Assinatura Digital (Integridade)

**Descrição**: Calcular hash SHA-256 de cada registro de auditoria e armazenar no campo `Hash_Integridade`.

**Justificativa**: Detectar adulterações não autorizadas em registros de auditoria (compliance ISO 27001).

**Critério de Aceite**:
- Hash calculado sobre: `{Timestamp}|{Usuario_Id}|{Entidade}|{EntidadeId}|{Tipo}|{Dados_Antes}|{Dados_Depois}`
- Hash verificável via endpoint `/api/auditoria/verificar-integridade/{id}`
- Tentativa de alteração manual da tabela invalidará o hash

---

### RN-AUD-007 — Detecção de Anomalias

**Descrição**: Detectar padrões de comportamento suspeitos automaticamente:

| Anomalia | Threshold | Ação |
|----------|-----------|------|
| Exportações excessivas | > 100 exportações em 1 hora | Alerta para segurança |
| Acesso multi-tenant anormal | Acesso a dados de > 50 empresas em 1 dia | Alerta + bloqueio temporário |
| Operações fora do horário | Operações entre 22h-6h (exceto jobs automáticos) | Alerta para auditoria |
| Deletions em massa | > 50 deletions em 10 minutos | Alerta + confirmação obrigatória |

**Critério de Aceite**:
- Dashboard exibe anomalias detectadas nos últimos 7 dias
- Alertas enviados para equipe de segurança via email/SMS
- Usuário recebe notificação quando comportamento anômalo é detectado

---

### RN-AUD-008 — Auditoria de LGPD

**Descrição**: Registrar especificamente operações relacionadas a LGPD:

| Tipo LGPD | Quando Registrar | Retenção |
|-----------|------------------|----------|
| **LGPD_ACCESS** | Acesso a CPF, emails, telefones | 7 anos |
| **LGPD_EXPORT** | Exportação de dados pessoais | 7 anos |
| **LGPD_CONSENT** | Registro de consentimento | 7 anos |
| **LGPD_DELETION** | Solicitação de exclusão (Art. 18) | 7 anos |
| **LGPD_PORTABILITY** | Exportação de dados (Art. 18) | 7 anos |

**Critério de Aceite**:
- Endpoint `/api/auditoria/lgpd` retorna apenas registros LGPD
- Relatório LGPD exportável em PDF formatado para autoridades
- Campos obrigatórios: Titular (usuário), Tipo de dado, Finalidade, Base legal

---

### RN-AUD-009 — Timeline de Entidade

**Descrição**: Endpoint `/api/auditoria/timeline/{entidade}/{id}` retorna timeline cronológica completa de todas as mudanças de uma entidade específica.

**Justificativa**: Facilita troubleshooting e investigação de incidentes (quem mudou o quê e quando).

**Critério de Aceite**:
- Timeline ordenada por Timestamp DESC (mais recente primeiro)
- Cada item contém: Timestamp, Usuário, Tipo de operação, Diff (o que mudou)
- Timeline inclui operações de CREATE, UPDATE, DELETE, ACCESS (se sensível)
- Paginação de 50 itens por página

---

### RN-AUD-010 — Contexto Enriquecido

**Descrição**: Capturar contexto completo da operação:

| Campo | Descrição | Obrigatório |
|-------|-----------|-------------|
| **IP_Origem** | Endereço IP do cliente | Sim |
| **User_Agent** | Navegador/dispositivo completo | Sim |
| **Correlation_Id** | GUID do request (RF-003) | Sim |
| **Tenant_Id** | Empresa/Departamento (multi-tenancy) | Sim |
| **Request_Id** | ID do request HTTP | Sim |
| **Justificativa** | Motivo da operação (obrigatório para CONFIG) | Condicional |

**Critério de Aceite**:
- Todos os campos obrigatórios presentes em 100% dos registros
- `Justificativa` obrigatória para mudanças em configurações críticas (RN-AUD-013)
- `Correlation_Id` permite rastrear request completo (RF-003 integração)

---

### RN-AUD-011 — Arquivamento Automático (Cold Storage)

**Descrição**: Job mensal move registros de auditoria com mais de 1 ano para Azure Blob Storage (cold storage).

**Justificativa**: Reduzir custo de armazenamento em SQL Server mantendo compliance (registros ainda acessíveis).

**Critério de Aceite**:
- Job executa no dia 1 de cada mês às 2h (horário de baixo tráfego)
- Registros arquivados mantêm mesmo formato JSON
- Busca em registros arquivados é mais lenta (aceitável para dados antigos)
- Registros arquivados NÃO contam para quota de banco de dados

---

### RN-AUD-012 — Segregação de Funções (SOX)

**Descrição**: Detectar violações de segregação de funções (SOX Seção 404):

| Violação | Detecção | Ação |
|----------|----------|------|
| Mesmo usuário criou e aprovou transação financeira | Query detecta mesmo `Usuario_Id` em operações CREATE + APPROVE | Alerta para auditoria |
| Desenvolvedor acessou produção sem ticket | Desenvolvedor acessa PRD sem `Ticket_Id` na justificativa | Alerta + bloqueio |
| Admin alterou próprio perfil de permissões | Usuario_Id = Entidade_Id e Tipo = UPDATE em tabela Permissoes | Alerta crítico |

**Critério de Aceite**:
- Dashboard exibe violações detectadas nos últimos 30 dias
- Alertas enviados para compliance officer em tempo real
- Relatório mensal de segregação de funções para auditores

---

### RN-AUD-013 — Auditoria de Configurações Críticas

**Descrição**: Mudanças em configurações críticas (ex: feature flags, parâmetros de segurança) exigem `Justificativa` obrigatória.

**Justificativa**: Rastrear motivo de mudanças que impactam comportamento do sistema.

**Critério de Aceite**:
- Tentativa de alterar configuração crítica sem justificativa é rejeitada (HTTP 400)
- Justificativa armazenada no campo `Justificativa` da auditoria
- Lista de configurações críticas definida em `ConfiguracoesCriticas.json`

---

### RN-AUD-014 — Busca Full-Text Otimizada

**Descrição**: Índice Full-Text em campos `Descricao`, `Dados_Antes`, `Dados_Depois` para buscas rápidas.

**Justificativa**: Auditores precisam buscar por palavras-chave (ex: "CPF 123.456.789-00") em milhões de registros.

**Critério de Aceite**:
- Busca full-text retorna resultados em < 2 segundos para 50M registros
- Índice atualizado automaticamente (não requer rebuild manual)
- Suporte a regex e wildcards (ex: "CPF ***.***.*89-**")

---

### RN-AUD-015 — Alertas de Retention Expirando

**Descrição**: Enviar alerta 30 dias antes da expiração de retenção de registros críticos (categorias FINANCIAL, LGPD, SECURITY).

**Justificativa**: Garantir que compliance officer tenha tempo para revisar/arquivar manualmente se necessário.

**Critério de Aceite**:
- Email enviado para compliance officer listando registros que expirarão em 30 dias
- Alerta inclui: Categoria, Quantidade de registros, Entidades afetadas
- Opção de estender retenção manualmente via endpoint `/api/auditoria/estender-retencao`

---

## 6. ESTADOS DA ENTIDADE

**Observação**: Registros de auditoria NÃO têm estados. São eventos imutáveis (append-only).

---

## 7. TRANSIÇÕES DE ESTADO

**Observação**: Não aplicável. Registros de auditoria são criados uma vez e nunca mudam.

---

## 8. VALIDAÇÕES

### 8.1 Validações de Entrada

| Campo | Validação | Mensagem de Erro |
|-------|-----------|------------------|
| `Usuario_Id` | Obrigatório, GUID válido | "Usuário obrigatório" |
| `Tipo` | Obrigatório, enum válido (CRUD, AUTH, EXPORT, etc.) | "Tipo de operação inválido" |
| `Entidade` | Obrigatório, string max 100 chars | "Entidade obrigatória" |
| `Entidade_Id` | Obrigatório se Tipo != LOGIN/LOGOUT | "ID da entidade obrigatório" |
| `Dados_Antes` | JSON válido (se presente) | "JSON inválido em Dados_Antes" |
| `Dados_Depois` | JSON válido (se presente) | "JSON inválido em Dados_Depois" |
| `Justificativa` | Obrigatório se Tipo = CONFIG e entidade crítica | "Justificativa obrigatória para mudança de configuração" |

### 8.2 Validações de Negócio

- ✅ Registro de auditoria NÃO pode ser criado sem usuário autenticado (exceto operações de sistema)
- ✅ Categoria de retenção DEVE ser válida conforme RN-AUD-004
- ✅ Hash SHA-256 DEVE ser calculado e armazenado (RN-AUD-006)
- ✅ Registros NÃO podem ser atualizados ou deletados após criação (RN-AUD-005)

---

## 9. SEGURANÇA

### 9.1 Autenticação

- ✅ Todas as operações de consulta/export de auditoria requerem autenticação JWT
- ✅ Operações de sistema (jobs automáticos) usam service account com token específico

### 9.2 Controle de Permissões

| Operação | Permissão Necessária | Perfis com Acesso |
|----------|---------------------|-------------------|
| Visualizar auditoria | `SYS.AUDITORIA.READ` | Super Admin, Auditor, Gerente Operações, Admin Sistema, Desenvolvedor |
| Buscar com filtros avançados | `SYS.AUDITORIA.SEARCH` | Super Admin, Auditor, Gerente Operações, Admin Sistema, Desenvolvedor |
| Exportar relatórios | `SYS.AUDITORIA.EXPORT` | Super Admin, Auditor, Gerente Operações |
| Visualizar timeline de entidade | `SYS.AUDITORIA.TIMELINE` | Super Admin, Auditor, Gerente Operações, Admin Sistema, Desenvolvedor |
| Acessar relatórios de compliance | `SYS.AUDITORIA.COMPLIANCE` | Super Admin, Auditor |
| Visualizar dashboards analíticos | `SYS.AUDITORIA.ANALYTICS` | Super Admin, Auditor, Gerente Operações |
| Visualizar própria auditoria | `SYS.AUDITORIA.READ_OWN` | Todos (usuário vê apenas seus próprios registros) |

### 9.3 Isolamento Multi-Tenant

- ✅ Registros de auditoria isolados por `Tenant_Id` (EmpresaId)
- ✅ Super Admin pode acessar auditoria de todos os tenants
- ✅ Usuários comuns acessam apenas auditoria do próprio tenant

---

## 10. INTEGRAÇÕES OBRIGATÓRIAS

### 10.1 Central de Funcionalidades

**Código**: `FNC-SYS-004`
**Nome**: Sistema de Auditoria
**Categoria**: Sistema / Infraestrutura
**Tipo**: Tela + API
**Descrição**: Permite aos auditores e administradores visualizar e exportar registros de auditoria do sistema.

### 10.2 Internacionalização (i18n)

**Chaves obrigatórias**: 35 chaves em `pt-BR`, `en`, `es` (ver RL-RF004.md para lista completa)

### 10.3 Auditoria (Recursiva)

**Nota**: Este próprio RF registra suas operações em auditoria (meta-auditoria).

**Operações Auditadas**:
- Visualizar Auditoria → ACCESS (retenção 7 anos)
- Exportar Relatório → EXPORT (retenção 7 anos)
- Buscar Dados Sensíveis → SEARCH (retenção 7 anos)

### 10.4 RF-003 (Sistema de Logs)

**Integração**: Correlation IDs do RF-003 são incluídos nos registros de auditoria (RN-AUD-010).

---

## 11. CATEGORIAS DE AUDITORIA

| Categoria | Descrição | Retenção | Exemplos |
|-----------|-----------|----------|----------|
| **CRUD** | Criar, Ler, Atualizar, Deletar | 7 anos | Usuario criado, Fatura editada |
| **AUTH** | Autenticação e autorização | 1 ano | Login, Logout, Troca de senha |
| **EXPORT** | Exportação de dados | 7 anos | Relatório exportado, Dados baixados |
| **ACCESS** | Acesso a dados sensíveis | 7 anos | Visualizou CPF, Acessou dados financeiros |
| **CONFIG** | Mudanças em configurações | 7 anos | Parâmetro alterado, Feature flag ativada |
| **LGPD** | Operações LGPD | 7 anos | Consentimento, Exclusão, Portabilidade |
| **FINANCIAL** | Transações financeiras | 7 anos | Fatura aprovada, Pagamento processado |
| **SECURITY** | Eventos de segurança | 7 anos | Falha de login, Acesso negado |
| **ADMIN** | Operações administrativas | 1 ano | Backup executado, Job agendado |
| **PRINT** | Impressão de documentos | 1 ano | Relatório impresso, Nota fiscal impressa |

---

**Este documento serve como contrato oficial entre negócio, desenvolvimento, testes e agentes de IA. Alterações devem ser versionadas e rastreáveis.**
