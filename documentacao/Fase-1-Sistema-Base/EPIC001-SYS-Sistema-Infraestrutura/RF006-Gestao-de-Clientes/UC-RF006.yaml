# UC-RF006.yaml — Casos de Uso Estruturados: Gestão de Clientes (Multi-Tenancy SaaS)
# Versão: 2.0
# Data: 2025-12-30
# Autor padrão: Agência ALC - alc.dev.br

uc:
  documentacao: "RF006"
  versao: "2.0"
  data: "2025-12-30"

rf_id: RF006
rf_titulo: "Gestão de Clientes (Multi-Tenancy SaaS)"
uc_versao: "2.0"
uc_data: "2025-12-30"
ator_principal: "Super Admin"
total_ucs: 9

# ==============================================================================
# SUMÁRIO DE CASOS DE USO
# ==============================================================================

casos_de_uso:
  - id: "UC00"
    nome: "Listar Clientes"
    ator: "Super Admin"
    permissao: "CAD.CLIENTES.VISUALIZAR"
    rns_cobertas:
      - "RN-CLI-006-01"
      - "RN-CLI-006-08"
    endpoints:
      - metodo: "GET"
        rota: "/api/clientes"
        autenticacao: "JWT Bearer Token"
        autorizacao: "IsSuperAdmin = true"

  - id: "UC01"
    nome: "Criar Cliente com ReceitaWS"
    ator: "Super Admin"
    permissao: "CAD.CLIENTES.GERENCIAR"
    rns_cobertas:
      - "RN-CLI-006-02"
      - "RN-CLI-006-03"
      - "RN-CLI-006-04"
      - "RN-CLI-006-05"
      - "RN-CLI-006-10"
    endpoints:
      - metodo: "POST"
        rota: "/api/clientes"
        autenticacao: "JWT Bearer Token"
        autorizacao: "IsSuperAdmin = true"
      - metodo: "POST"
        rota: "/api/clientes/consultar-cnpj"
        autenticacao: "JWT Bearer Token"
        autorizacao: "IsSuperAdmin = true"

  - id: "UC02"
    nome: "Visualizar Cliente"
    ator: "Super Admin"
    permissao: "CAD.CLIENTES.VISUALIZAR"
    rns_cobertas:
      - "RN-CLI-006-01"
      - "RN-CLI-006-08"
    endpoints:
      - metodo: "GET"
        rota: "/api/clientes/{id}"
        autenticacao: "JWT Bearer Token"
        autorizacao: "IsSuperAdmin = true"

  - id: "UC03"
    nome: "Editar Cliente"
    ator: "Super Admin"
    permissao: "CAD.CLIENTES.GERENCIAR"
    rns_cobertas:
      - "RN-CLI-006-04"
      - "RN-CLI-006-10"
    endpoints:
      - metodo: "PUT"
        rota: "/api/clientes/{id}"
        autenticacao: "JWT Bearer Token"
        autorizacao: "IsSuperAdmin = true"

  - id: "UC04"
    nome: "Excluir Cliente (Soft Delete)"
    ator: "Super Admin"
    permissao: "CAD.CLIENTES.GERENCIAR"
    rns_cobertas:
      - "RN-CLI-006-07"
      - "RN-CLI-006-09"
      - "RN-CLI-006-10"
    endpoints:
      - metodo: "DELETE"
        rota: "/api/clientes/{id}"
        autenticacao: "JWT Bearer Token"
        autorizacao: "IsSuperAdmin = true"

  - id: "UC05"
    nome: "Upload de Logo do Cliente"
    ator: "Super Admin"
    permissao: "CAD.CLIENTES.GERENCIAR"
    rns_cobertas:
      - "RN-CLI-006-06"
      - "RN-CLI-006-10"
    endpoints:
      - metodo: "POST"
        rota: "/api/clientes/{id}/logo"
        autenticacao: "JWT Bearer Token"
        autorizacao: "IsSuperAdmin = true"
        content_type: "multipart/form-data"

  - id: "UC06"
    nome: "Restaurar Cliente Excluído"
    ator: "Super Admin"
    permissao: "CAD.CLIENTES.GERENCIAR"
    rns_cobertas:
      - "RN-CLI-006-07"
      - "RN-CLI-006-10"
    endpoints:
      - metodo: "POST"
        rota: "/api/clientes/{id}/restaurar"
        autenticacao: "JWT Bearer Token"
        autorizacao: "IsSuperAdmin = true"

  - id: "UC07"
    nome: "Desativar Cliente"
    ator: "Super Admin"
    permissao: "CAD.CLIENTES.GERENCIAR"
    rns_cobertas:
      - "RN-CLI-006-09"
      - "RN-CLI-006-10"
    endpoints:
      - metodo: "PUT"
        rota: "/api/clientes/{id}/desativar"
        autenticacao: "JWT Bearer Token"
        autorizacao: "IsSuperAdmin = true"

  - id: "UC08"
    nome: "Consultar CNPJ na ReceitaWS"
    ator: "Super Admin"
    permissao: "CAD.CLIENTES.GERENCIAR"
    rns_cobertas:
      - "RN-CLI-006-05"
      - "RN-CLI-006-03"
      - "RN-CLI-006-10"
    endpoints:
      - metodo: "POST"
        rota: "/api/clientes/consultar-cnpj"
        autenticacao: "JWT Bearer Token"
        autorizacao: "IsSuperAdmin = true"

# ==============================================================================
# MATRIZ DE RASTREABILIDADE: RF → UC
# ==============================================================================

rastreabilidade_rf_uc:
  total_rns: 10
  total_ucs: 9
  cobertura_percentual: 100

  mapeamento:
    - rn_id: "RN-CLI-006-01"
      titulo: "Cliente como Tenant Raiz"
      criticidade: "CRÍTICA"
      ucs_que_cobrem:
        - "UC00"
        - "UC02"
      status: "100% COBERTA"

    - rn_id: "RN-CLI-006-02"
      titulo: "CNPJ Único por Cliente"
      criticidade: "CRÍTICA"
      ucs_que_cobrem:
        - "UC01"
      status: "100% COBERTA"

    - rn_id: "RN-CLI-006-03"
      titulo: "Validação de Dígitos Verificadores do CNPJ"
      criticidade: "CRÍTICA"
      ucs_que_cobrem:
        - "UC01"
        - "UC08"
      status: "100% COBERTA"

    - rn_id: "RN-CLI-006-04"
      titulo: "Razão Social Obrigatória"
      criticidade: "CRÍTICA"
      ucs_que_cobrem:
        - "UC01"
        - "UC03"
      status: "100% COBERTA"

    - rn_id: "RN-CLI-006-05"
      titulo: "Consulta ReceitaWS Automática"
      criticidade: "MÉDIA"
      ucs_que_cobrem:
        - "UC01"
        - "UC08"
      status: "100% COBERTA"

    - rn_id: "RN-CLI-006-06"
      titulo: "Upload de Logo com Validação"
      criticidade: "MÉDIA"
      ucs_que_cobrem:
        - "UC05"
      status: "100% COBERTA"

    - rn_id: "RN-CLI-006-07"
      titulo: "Soft Delete Obrigatório"
      criticidade: "CRÍTICA"
      ucs_que_cobrem:
        - "UC04"
        - "UC06"
      status: "100% COBERTA"

    - rn_id: "RN-CLI-006-08"
      titulo: "Super Admin Bypass de Multi-Tenancy"
      criticidade: "CRÍTICA"
      ucs_que_cobrem:
        - "UC00"
        - "UC02"
      status: "100% COBERTA"

    - rn_id: "RN-CLI-006-09"
      titulo: "Desativação de Cliente Bloqueia Usuários"
      criticidade: "CRÍTICA"
      ucs_que_cobrem:
        - "UC04"
        - "UC07"
      status: "100% COBERTA"

    - rn_id: "RN-CLI-006-10"
      titulo: "Auditoria de Operações de Cliente"
      criticidade: "CRÍTICA"
      ucs_que_cobrem:
        - "UC01"
        - "UC03"
        - "UC04"
        - "UC05"
        - "UC06"
        - "UC07"
        - "UC08"
      status: "100% COBERTA"

# ==============================================================================
# MATRIZ DE RASTREABILIDADE: UC → ENDPOINTS API
# ==============================================================================

rastreabilidade_uc_endpoints:
  total_endpoints_unicos: 7
  total_operacoes: 13

  mapeamento:
    - uc_id: "UC00"
      endpoint: "/api/clientes"
      metodo: "GET"
      validacoes:
        - "IsSuperAdmin = true"
        - "Permissão: CAD.CLIENTES.VISUALIZAR"
        - "JWT válido"
      query_filters_bypass: true

    - uc_id: "UC01"
      endpoint: "/api/clientes"
      metodo: "POST"
      validacoes:
        - "IsSuperAdmin = true"
        - "Permissão: CAD.CLIENTES.GERENCIAR"
        - "CNPJ único"
        - "Validação dígitos verificadores CNPJ"
        - "Razão Social obrigatória"
      operacao_auditoria: "CLI_CREATE"

    - uc_id: "UC01"
      endpoint: "/api/clientes/consultar-cnpj"
      metodo: "POST"
      validacoes:
        - "IsSuperAdmin = true"
        - "Permissão: CAD.CLIENTES.GERENCIAR"
        - "Validação dígitos verificadores CNPJ"
        - "Rate limit: 3 consultas/minuto/usuário"
      operacao_auditoria: "CLI_RECEITA_QUERY"

    - uc_id: "UC02"
      endpoint: "/api/clientes/{id}"
      metodo: "GET"
      validacoes:
        - "IsSuperAdmin = true"
        - "Permissão: CAD.CLIENTES.VISUALIZAR"
        - "Cliente existe"
      query_filters_bypass: true

    - uc_id: "UC03"
      endpoint: "/api/clientes/{id}"
      metodo: "PUT"
      validacoes:
        - "IsSuperAdmin = true"
        - "Permissão: CAD.CLIENTES.GERENCIAR"
        - "Razão Social obrigatória"
        - "FlExcluido = false"
        - "CNPJ read-only (não pode ser alterado)"
      operacao_auditoria: "CLI_UPDATE"

    - uc_id: "UC04"
      endpoint: "/api/clientes/{id}"
      metodo: "DELETE"
      validacoes:
        - "IsSuperAdmin = true"
        - "Permissão: CAD.CLIENTES.GERENCIAR"
        - "Trigger INSTEAD OF DELETE (bloqueia DELETE físico)"
        - "FlExcluido = false"
      operacoes_auditoria:
        - "CLI_DELETE"
        - "CLI_DEACTIVATE_USERS"

    - uc_id: "UC05"
      endpoint: "/api/clientes/{id}/logo"
      metodo: "POST"
      content_type: "multipart/form-data"
      validacoes:
        - "IsSuperAdmin = true"
        - "Permissão: CAD.CLIENTES.GERENCIAR"
        - "Magic bytes validation (PNG, JPG, SVG)"
        - "Tamanho máximo: 2 MB"
        - "FlExcluido = false"
      operacao_auditoria: "CLI_LOGO_UPLOAD"

    - uc_id: "UC06"
      endpoint: "/api/clientes/{id}/restaurar"
      metodo: "POST"
      validacoes:
        - "IsSuperAdmin = true"
        - "Permissão: CAD.CLIENTES.GERENCIAR"
        - "FlExcluido = true"
      operacao_auditoria: "CLI_RESTORE"

    - uc_id: "UC07"
      endpoint: "/api/clientes/{id}/desativar"
      metodo: "PUT"
      validacoes:
        - "IsSuperAdmin = true"
        - "Permissão: CAD.CLIENTES.GERENCIAR"
        - "FlAtivo = true"
        - "FlExcluido = false"
      operacoes_auditoria:
        - "CLI_DEACTIVATE"
        - "CLI_DEACTIVATE_USERS"

    - uc_id: "UC08"
      endpoint: "/api/clientes/consultar-cnpj"
      metodo: "POST"
      validacoes:
        - "IsSuperAdmin = true"
        - "Permissão: CAD.CLIENTES.GERENCIAR"
        - "Validação dígitos verificadores CNPJ"
        - "Rate limit: 3 consultas/minuto/usuário"
      operacao_auditoria: "CLI_RECEITA_QUERY"

# ==============================================================================
# MATRIZ DE RASTREABILIDADE: UC → PERMISSÕES RBAC
# ==============================================================================

rastreabilidade_uc_permissoes:
  total_permissoes: 2

  permissoes:
    - codigo: "CAD.CLIENTES.VISUALIZAR"
      nome: "Visualizar Clientes"
      tipo: "READ"
      roles_autorizadas:
        - "Super Admin"
      ucs_que_requerem:
        - "UC00"
        - "UC02"

    - codigo: "CAD.CLIENTES.GERENCIAR"
      nome: "Gerenciar Clientes"
      tipo: "WRITE"
      roles_autorizadas:
        - "Super Admin"
      ucs_que_requerem:
        - "UC01"
        - "UC03"
        - "UC04"
        - "UC05"
        - "UC06"
        - "UC07"
        - "UC08"

# ==============================================================================
# MATRIZ DE RASTREABILIDADE: UC → INTEGRAÇÕES OBRIGATÓRIAS
# ==============================================================================

rastreabilidade_uc_integracoes:
  total_integracoes: 5

  integracoes:
    - nome: "ReceitaWS API"
      tipo: "API Externa"
      url: "https://www.receitaws.com.br/v1/cnpj/{cnpj}"
      timeout: "10 segundos"
      rate_limit: "3 consultas/minuto/usuário"
      fallback: "Preenchimento manual permitido"
      ucs_que_utilizam:
        - "UC01"
        - "UC08"
      obrigatoriedade: "OPCIONAL (fallback disponível)"

    - nome: "Azure Blob Storage"
      tipo: "Cloud Storage"
      container: "clientes-logos"
      public_access: "Blob"
      tier: "Hot"
      ucs_que_utilizam:
        - "UC05"
      obrigatoriedade: "OBRIGATÓRIO"

    - nome: "i18n (Transloco)"
      tipo: "Internacionalização"
      namespaces:
        - "gestao-clientes.errors.*"
        - "gestao-clientes.success.*"
        - "gestao-clientes.warnings.*"
        - "gestao-clientes.labels.*"
        - "gestao-clientes.confirmations.*"
      idiomas_suportados:
        - "pt-BR"
        - "en"
        - "es"
      ucs_que_utilizam:
        - "UC00"
        - "UC01"
        - "UC02"
        - "UC03"
        - "UC04"
        - "UC05"
        - "UC06"
        - "UC07"
        - "UC08"
      obrigatoriedade: "OBRIGATÓRIO"

    - nome: "Auditoria (AuditInterceptor)"
      tipo: "Sistema"
      retencao: "7 anos (LGPD Art. 16)"
      tipos_operacao:
        - "CLI_CREATE"
        - "CLI_UPDATE"
        - "CLI_DELETE"
        - "CLI_LOGO_UPLOAD"
        - "CLI_RESTORE"
        - "CLI_DEACTIVATE"
        - "CLI_DEACTIVATE_USERS"
        - "CLI_RECEITA_QUERY"
        - "CLI_LIST"
      ucs_que_utilizam:
        - "UC00"
        - "UC01"
        - "UC03"
        - "UC04"
        - "UC05"
        - "UC06"
        - "UC07"
        - "UC08"
      obrigatoriedade: "OBRIGATÓRIO"

    - nome: "EF Core Query Filters"
      tipo: "Multi-Tenancy"
      filtro_global: "WHERE ClienteId = @CurrentClienteId"
      bypass: "IsSuperAdmin = true → IgnoreQueryFilters()"
      interface_marker: "IClienteEntity"
      ucs_que_utilizam:
        - "UC00"
        - "UC02"
      obrigatoriedade: "OBRIGATÓRIO"

# ==============================================================================
# VALIDAÇÕES TRANSVERSAIS
# ==============================================================================

validacoes_transversais:
  seguranca:
    autenticacao: "JWT Bearer Token"
    autorizacao: "RBAC (Super Admin APENAS)"
    https_obrigatorio: true
    protecao_csrf: true
    protecao_sql_injection: "EF Core parametrização automática"
    protecao_xss: "Frontend sanitiza inputs"

  auditoria:
    framework: "AuditInterceptor (EF Core SaveChangesInterceptor)"
    retencao: "7 anos (LGPD Art. 16)"
    campos_auditados:
      - "UsuarioId"
      - "DataOperacao"
      - "IpAddress"
      - "TipoOperacao"
      - "Detalhes (JSON before/after)"

  multi_tenancy:
    discriminador: "ClienteId"
    filtro_global: "EF Core Query Filters"
    bypass: "IsSuperAdmin = true"
    interface_marker: "IClienteEntity"
    row_level_security: true

  i18n:
    framework: "Transloco (@jsverse/transloco)"
    idiomas:
      - codigo: "pt-BR"
        nome: "Português do Brasil"
        default: true
      - codigo: "en"
        nome: "Inglês"
        default: false
      - codigo: "es"
        nome: "Espanhol"
        default: false
    fallback_chain: "pt-BR → en → es"

# ==============================================================================
# REQUISITOS NÃO-FUNCIONAIS
# ==============================================================================

requisitos_nao_funcionais:
  performance:
    tempo_resposta_get_p95: "< 200ms"
    tempo_resposta_post_put_p95: "< 500ms"
    upload_logo_2mb_p95: "< 5 segundos"
    consulta_receitaws_timeout: "10 segundos"
    paginacao_maxima: "100 registros/página"

  disponibilidade:
    sla: "99.9%"
    receitaws_offline: "Funcional (fallback manual)"
    azure_blob_offline: "Degradado (logos sem imagem)"

  escalabilidade:
    clientes_simultaneos: "Até 1.000"
    logos_armazenados: "Ilimitado (Azure Blob Storage)"
    consultas_receitaws_minuto: "180 (60 usuários × 3)"
    crescimento_anual: "+20%"

  seguranca:
    cnpj_validation: "Algoritmo dígitos verificadores obrigatório"
    magic_bytes_validation: "Obrigatório (PNG, JPG, SVG)"
    soft_delete_trigger: "INSTEAD OF DELETE (bloqueia DELETE físico)"
    rate_limiting: "3 consultas ReceitaWS/minuto/usuário"

# ==============================================================================
# GLOSSÁRIO
# ==============================================================================

glossario:
  - termo: "Cliente"
    definicao: "Entidade raiz de multi-tenancy no sistema IControlIT. Representa uma empresa cliente do SaaS."

  - termo: "ClienteId"
    definicao: "Discriminador de tenant obrigatório em TODAS as entidades do sistema (via EF Core Query Filters)."

  - termo: "Super Admin"
    definicao: "Único role autorizado a acessar Gestão de Clientes. Possui bypass de multi-tenancy (IsSuperAdmin = true)."

  - termo: "Soft Delete"
    definicao: "Exclusão lógica via FlExcluido = true. Registro permanece no banco mas é filtrado nas queries."

  - termo: "ReceitaWS"
    definicao: "API pública da Receita Federal Brasileira para consulta de CNPJ (https://www.receitaws.com.br/v1/)."

  - termo: "Magic Bytes"
    definicao: "Primeiros bytes de um arquivo que identificam seu formato real (ex: PNG = 89 50 4E 47)."

  - termo: "Azure Blob Storage"
    definicao: "Serviço de armazenamento de objetos da Microsoft Azure (container: clientes-logos)."

  - termo: "Rate Limit"
    definicao: "Limite de requisições por período (3 consultas ReceitaWS/minuto/usuário)."

  - termo: "EF Core Query Filters"
    definicao: "Filtros globais aplicados automaticamente em todas as queries (WHERE ClienteId = @CurrentClienteId)."

  - termo: "CNPJ"
    definicao: "Cadastro Nacional de Pessoa Jurídica (14 dígitos com 2 dígitos verificadores)."

  - termo: "FlAtivo"
    definicao: "Flag que indica se Cliente está ativo (true) ou desativado (false)."

  - termo: "FlExcluido"
    definicao: "Flag que indica se Cliente foi excluído (soft delete = true)."

  - termo: "LGPD"
    definicao: "Lei Geral de Proteção de Dados (Brasil) - exige auditoria com retenção de 7 anos (Art. 16)."

  - termo: "RBAC"
    definicao: "Role-Based Access Control - autorização baseada em roles (ex: Super Admin)."

  - termo: "Multi-Tenancy"
    definicao: "Arquitetura onde múltiplos clientes compartilham mesma aplicação mas com dados isolados (Row-Level Security)."

# ==============================================================================
# METADADOS DO DOCUMENTO
# ==============================================================================

metadados:
  versao: "2.0"
  data_criacao: "2025-12-30"
  status: "AGUARDANDO VALIDAÇÃO"
  validacao_obrigatoria: "validator-rf-uc.py"
  cobertura_rns: "10/10 (100%)"
  total_ucs: 9
  total_endpoints: 7
  total_permissoes: 2
  total_integracoes: 5

  referencias:
    - tipo: "RF"
      arquivo: "RF006.md"
      descricao: "Requisito Funcional completo com 10 RNs"
    - tipo: "RF_YAML"
      arquivo: "RF006.yaml"
      descricao: "Versão estruturada do RF (YAML)"
    - tipo: "RL"
      arquivo: "RL-RF006.md"
      descricao: "Referências ao Legado (18 bancos, 6 problemas)"
    - tipo: "RL_YAML"
      arquivo: "RL-RF006.yaml"
      descricao: "Versão estruturada do RL (YAML)"
    - tipo: "UC"
      arquivo: "UC-RF006.md"
      descricao: "Casos de Uso detalhados (9 UCs)"

  aprovacao:
    status: "PENDENTE"
    aprovador: null
    data_aprovacao: null

  observacoes:
    - "Cobertura de RNs: 10/10 (100%) ✅"
    - "Todos os UCs possuem ator Super Admin APENAS"
    - "Multi-tenancy com bypass obrigatório para Super Admin"
    - "ReceitaWS API com fallback manual (opcional)"
    - "Azure Blob Storage obrigatório para logos"
    - "Auditoria LGPD 7 anos obrigatória"
    - "Soft Delete obrigatório (trigger bloqueia DELETE físico)"
    - "Rate limit ReceitaWS: 3 consultas/minuto/usuário"

# ==============================================================================
# EXCLUSÕES
# ==============================================================================

exclusions:
  uc_items: []

# ==============================================================================
# HISTÓRICO
# ==============================================================================

historico:
  - versao: "2.0"
    data: "2025-12-30"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Versão canônica orientada a contrato - adequada aos templates oficiais"
  - versao: "1.0"
    data: "2025-12-29"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Versão inicial"
