# RF006 — Gestão de Clientes (Multi-Tenancy SaaS)

**Versão**: 2.0
**Data**: 2025-12-29
**Responsável**: Architect Agent
**EPIC**: EPIC001-SYS-Sistema-Infraestrutura
**Fase**: Fase-1-Sistema-Base

---

## 1. VISÃO GERAL

### 1.1 Resumo Executivo

Cliente representa a **empresa que assinou a plataforma IControlIT** e é a **raiz da hierarquia organizacional** do sistema SaaS multi-tenant. Cada Cliente possui **isolamento total de dados** implementado via **Row-Level Security** (EF Core Query Filters), garantindo que um Cliente nunca acesse dados de outro Cliente.

O módulo de Gestão de Clientes permite que **Super Admins** criem, editem, visualizem e desativem Clientes da plataforma, além de gerenciar logos corporativos (white-label) e consultar dados da Receita Federal automaticamente via **ReceitaWS API**.

**Contexto de Negócio**: No sistema legado, cada Cliente tinha um **banco de dados SQL Server completamente separado** (18 bancos isolados: Alpargatas, Vale, Bombril, etc.). A migração para arquitetura SaaS **consolidou todos os Clientes em um único banco** usando `ClienteId` como discriminador de tenant.

**Benefícios**:
- ✅ Onboarding de Clientes em < 5 minutos (vs. dias no legado com criação manual de banco)
- ✅ Redução de custos de infraestrutura (single database vs. 18+ databases)
- ✅ Consulta automática de dados da Receita Federal (reduz erros de digitação)
- ✅ White-label via upload de logo corporativo
- ✅ Isolamento total de dados via Row-Level Security
- ✅ Compliance LGPD com auditoria completa (retenção 7 anos)

---

### 1.2 Objetivos

**O01**: Permitir que Super Admins criem novos Clientes na plataforma SaaS em menos de 5 minutos
**O02**: Garantir isolamento total de dados entre Clientes via Row-Level Security (multi-tenancy seguro)
**O03**: Automatizar preenchimento de dados cadastrais via consulta ReceitaWS (Receita Federal)
**O04**: Validar CNPJ com dígitos verificadores no backend (prevenir bypass client-side)
**O05**: Permitir upload de logo corporativo (JPG/PNG/SVG, max 2MB) para white-label
**O06**: Implementar soft delete obrigatório para preservar auditoria e integridade referencial
**O07**: Bloquear automaticamente todos os usuários ao desativar um Cliente
**O08**: Registrar todas as operações em auditoria com retenção de 7 anos (LGPD)
**O09**: Garantir que apenas Super Admins gerenciem Clientes (RBAC restrito)
**O10**: Manter uptime de 99.9% do sistema de multi-tenancy sem data leakage cross-tenant

---

### 1.3 Escopo

**Incluído**:
- ✅ CRUD completo de Clientes (Create, Read, Update, Soft Delete)
- ✅ Validação de CNPJ com dígitos verificadores (algoritmo Receita Federal)
- ✅ Consulta automática ReceitaWS para preenchimento de dados cadastrais
- ✅ Upload de logo do Cliente para Azure Blob Storage (white-label)
- ✅ Soft delete obrigatório (FlExcluido = true, DELETE físico bloqueado por trigger)
- ✅ Desativação de Cliente com bloqueio automático de todos os usuários vinculados
- ✅ Row-Level Security via EF Core Query Filters (isolamento ClienteId)
- ✅ Super Admin bypass de multi-tenancy (visão global de todos os Clientes)
- ✅ Auditoria completa de operações (CLI_CREATE, CLI_UPDATE, CLI_DELETE, etc.)
- ✅ Paginação, busca, filtros e exportação (CSV/Excel)
- ✅ Restauração de Cliente excluído (FlExcluido = false)
- ✅ Listagem de usuários e empresas vinculadas ao Cliente
- ✅ Histórico de auditoria por Cliente

**Não Incluído (fora do escopo)**:
- ❌ Gestão de cobranças e pagamentos (será RF separado)
- ❌ Gestão de planos e assinaturas (será RF separado)
- ❌ Onboarding automático de usuários do Cliente (será RF separado)
- ❌ Migração de dados do legado (multi-database → single database)
- ❌ Personalização de domínio customizado (ex: cliente.icontrolit.com)

---

## 2. REGRAS DE NEGÓCIO (10 RNs)

### RN-CLI-006-01: Cliente como Tenant Raiz

**Descrição**: `ClienteId` é o discriminador de tenant obrigatório em **TODAS** as entidades do sistema (exceto entidades de sistema como `SistemaIdiomas`). Todas as queries EF Core devem filtrar automaticamente por `ClienteId` do usuário autenticado.

**Justificativa**: Garante isolamento total de dados entre Clientes, prevenindo data leakage cross-tenant. É a base do multi-tenancy seguro da plataforma SaaS.

**Implementação**:
```csharp
// ApplicationDbContext.cs - Query Filter global
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    // Aplicar query filter em TODAS as entidades com ClienteId
    foreach (var entityType in modelBuilder.Model.GetEntityTypes())
    {
        if (typeof(IClienteEntity).IsAssignableFrom(entityType.ClrType))
        {
            var parameter = Expression.Parameter(entityType.ClrType, "e");
            var property = Expression.Property(parameter, nameof(IClienteEntity.ClienteId));
            var currentClienteId = Expression.Property(
                Expression.Constant(_currentUserService),
                nameof(ICurrentUserService.ClienteId)
            );
            var isSuperAdmin = Expression.Property(
                Expression.Constant(_currentUserService),
                nameof(ICurrentUserService.IsSuperAdmin)
            );

            // Filtro: (IsSuperAdmin OR ClienteId == CurrentClienteId) AND !FlExcluido
            var filter = Expression.Lambda(
                Expression.AndAlso(
                    Expression.OrElse(
                        isSuperAdmin,
                        Expression.Equal(property, currentClienteId)
                    ),
                    Expression.Not(Expression.Property(parameter, "FlExcluido"))
                ),
                parameter
            );

            modelBuilder.Entity(entityType.ClrType).HasQueryFilter(filter);
        }
    }
}

// Interface marcadora
public interface IClienteEntity
{
    Guid ClienteId { get; set; }
}

// Exemplo de entidade
public class Empresa : AuditableEntity, IClienteEntity
{
    public Guid ClienteId { get; set; }  // ← FK obrigatória
    public Cliente Cliente { get; set; }
    // ...
}
```

**Validação**:
```sql
-- Validar que ClienteId é NOT NULL em todas as tabelas de negócio
SELECT t.TABLE_NAME, c.COLUMN_NAME
FROM INFORMATION_SCHEMA.TABLES t
JOIN INFORMATION_SCHEMA.COLUMNS c ON t.TABLE_NAME = c.TABLE_NAME
WHERE t.TABLE_SCHEMA = 'dbo'
  AND t.TABLE_TYPE = 'BASE TABLE'
  AND c.COLUMN_NAME = 'ClienteId'
  AND c.IS_NULLABLE = 'YES';  -- Deve retornar vazio
```

**Exemplos**:
- **Correto**: Usuario A do Cliente Petrobras executa `SELECT * FROM Empresas` → EF Core filtra automaticamente `WHERE ClienteId = {PetrobrasId}`
- **Correto**: Super Admin executa `SELECT * FROM Empresas` → EF Core retorna empresas de TODOS os Clientes (bypass do filtro)
- **Violação**: Query manual sem filtro `ClienteId` → Data leakage cross-tenant → CRITICAL ALERT

---

### RN-CLI-006-02: CNPJ Único por Cliente

**Descrição**: Não pode existir mais de um Cliente com o mesmo CNPJ no banco de dados. A validação deve ocorrer no backend com unique constraint no banco.

**Justificativa**: CNPJ é o identificador único legal de uma empresa brasileira. Permitir duplicidade causaria confusão, problemas fiscais e erros de atribuição de dados.

**Implementação**:
```csharp
// Entity Configuration
public class ClienteConfiguration : IEntityTypeConfiguration<Cliente>
{
    public void Configure(EntityTypeBuilder<Cliente> builder)
    {
        builder.HasIndex(c => c.CNPJ)
            .IsUnique()
            .HasDatabaseName("IX_Cliente_CNPJ_Unique");
    }
}

// CreateClienteCommandValidator.cs
public class CreateClienteCommandValidator : AbstractValidator<CreateClienteCommand>
{
    private readonly IApplicationDbContext _context;

    public CreateClienteCommandValidator(IApplicationDbContext context)
    {
        _context = context;

        RuleFor(v => v.CNPJ)
            .NotEmpty().WithMessage("CNPJ é obrigatório")
            .MustAsync(BeUniqueCnpj).WithMessage(c => $"CNPJ {c.CNPJ} já cadastrado");
    }

    private async Task<bool> BeUniqueCnpj(string cnpj, CancellationToken cancellationToken)
    {
        // Remove máscara para comparação
        var cnpjDigits = new string(cnpj.Where(char.IsDigit).ToArray());

        return !await _context.Clientes
            .AnyAsync(c => c.CNPJ == cnpjDigits, cancellationToken);
    }
}
```

**Validação**:
```sql
-- Verificar se existe unique constraint no CNPJ
SELECT * FROM sys.indexes
WHERE name = 'IX_Cliente_CNPJ_Unique'
  AND object_id = OBJECT_ID('dbo.Cliente')
  AND is_unique = 1;

-- Testar race condition: tentar inserir CNPJ duplicado simultaneamente
BEGIN TRANSACTION;
INSERT INTO Cliente (CNPJ, RazaoSocial, ...) VALUES ('33592510000154', 'Vale S.A.', ...);
-- Segunda transação deve falhar com erro de unique constraint
ROLLBACK;
```

**Exemplos**:
- **Válido**: Cliente A tem CNPJ 33.592.510/0001-54 (Vale)
- **Inválido**: Tentar criar Cliente B com CNPJ 33.592.510/0001-54 → HTTP 400 "CNPJ 33592510000154 já cadastrado"
- **Edge Case**: Tentar criar 2 Clientes com mesmo CNPJ simultaneamente (race condition) → Unique constraint bloqueia segundo INSERT

---

### RN-CLI-006-03: Validação de Dígitos Verificadores do CNPJ

**Descrição**: O sistema deve validar os dígitos verificadores do CNPJ usando o algoritmo oficial da Receita Federal. CNPJs com dígitos incorretos ou padrões inválidos (11111111111111, 00000000000000) devem ser rejeitados.

**Justificativa**: Garante que apenas CNPJs válidos sejam cadastrados, prevenindo erros de digitação, dados falsos e problemas com integrações externas (ReceitaWS, notas fiscais eletrônicas).

**Implementação**:
```csharp
// CnpjValidator.cs
public static class CnpjValidator
{
    public static bool IsValid(string cnpj)
    {
        if (string.IsNullOrWhiteSpace(cnpj))
            return false;

        // Remove máscara (pontos, barras, hífens)
        cnpj = new string(cnpj.Where(char.IsDigit).ToArray());

        if (cnpj.Length != 14)
            return false;

        // CNPJs inválidos conhecidos (todos os dígitos iguais)
        if (cnpj == "00000000000000" || cnpj == "11111111111111" ||
            cnpj == "22222222222222" || cnpj == "33333333333333" ||
            cnpj == "44444444444444" || cnpj == "55555555555555" ||
            cnpj == "66666666666666" || cnpj == "77777777777777" ||
            cnpj == "88888888888888" || cnpj == "99999999999999")
            return false;

        // Cálculo do primeiro dígito verificador
        int[] multiplicador1 = { 5, 4, 3, 2, 9, 8, 7, 6, 5, 4, 3, 2 };
        int soma = 0;
        for (int i = 0; i < 12; i++)
            soma += int.Parse(cnpj[i].ToString()) * multiplicador1[i];

        int resto = soma % 11;
        int digito1 = resto < 2 ? 0 : 11 - resto;

        if (int.Parse(cnpj[12].ToString()) != digito1)
            return false;

        // Cálculo do segundo dígito verificador
        int[] multiplicador2 = { 6, 5, 4, 3, 2, 9, 8, 7, 6, 5, 4, 3, 2 };
        soma = 0;
        for (int i = 0; i < 13; i++)
            soma += int.Parse(cnpj[i].ToString()) * multiplicador2[i];

        resto = soma % 11;
        int digito2 = resto < 2 ? 0 : 11 - resto;

        return int.Parse(cnpj[13].ToString()) == digito2;
    }
}

// Validator
RuleFor(v => v.CNPJ)
    .Must(CnpjValidator.IsValid)
    .WithMessage("CNPJ inválido (dígitos verificadores incorretos)");
```

**Exemplos**:
- **Válido**: CNPJ 33.592.510/0001-54 (dígitos 5 e 4 corretos)
- **Inválido**: CNPJ 33.592.510/0001-00 (dígitos verificadores incorretos)
- **Inválido**: CNPJ 11111111111111 (todos os dígitos iguais)
- **Inválido**: CNPJ 123456789012 (menos de 14 dígitos)

**Referência**: [Algoritmo oficial Receita Federal](http://www.receita.fazenda.gov.br/pessoajuridica/cnpj/cnpjreva.htm)

---

### RN-CLI-006-04: Razão Social Obrigatória

**Descrição**: O campo Razão Social é obrigatório e deve ter entre 3 e 200 caracteres. Não pode conter apenas espaços.

**Justificativa**: Razão Social é o **nome oficial da empresa registrado na Receita Federal** e é obrigatório para identificação fiscal, jurídica e contratual do Cliente.

**Implementação**:
```csharp
// CreateClienteCommandValidator.cs
RuleFor(v => v.RazaoSocial)
    .NotEmpty().WithMessage("Razão Social é obrigatória")
    .MinimumLength(3).WithMessage("Razão Social deve ter no mínimo 3 caracteres")
    .MaximumLength(200).WithMessage("Razão Social deve ter no máximo 200 caracteres")
    .Must(v => !string.IsNullOrWhiteSpace(v)).WithMessage("Razão Social não pode conter apenas espaços");
```

**Validação**:
```sql
ALTER TABLE [dbo].[Cliente]
ADD CONSTRAINT [CHK_Cliente_RazaoSocial_NotEmpty]
CHECK (LEN(LTRIM(RTRIM([RazaoSocial]))) >= 3);
```

**Exemplos**:
- **Válido**: "Petróleo Brasileiro S.A."
- **Válido**: "Banco Bradesco S.A."
- **Inválido**: "" (vazio) → HTTP 400
- **Inválido**: "AB" (menos de 3 caracteres) → HTTP 400
- **Inválido**: "   " (apenas espaços) → HTTP 400

---

### RN-CLI-006-05: Consulta ReceitaWS Automática

**Descrição**: Ao informar um CNPJ válido, o sistema deve consultar automaticamente a API **ReceitaWS** (https://www.receitaws.com.br/v1/) para preencher dados cadastrais (Razão Social, Nome Fantasia, Endereço, Telefone, Email).

**Justificativa**: Reduz erros de digitação, acelera onboarding de Clientes em até 80% e garante que dados cadastrais estejam atualizados conforme Receita Federal.

**Observação Importante**: **Se ReceitaWS estiver indisponível, a criação de Cliente NÃO deve ser bloqueada**. O usuário pode preencher dados manualmente.

**Implementação**:
```csharp
// ReceitaWsService.cs
public class ReceitaWsService : IReceitaWsService
{
    private readonly HttpClient _httpClient;
    private readonly ILogger<ReceitaWsService> _logger;

    public ReceitaWsService(HttpClient httpClient, ILogger<ReceitaWsService> logger)
    {
        _httpClient = httpClient;
        _httpClient.BaseAddress = new Uri("https://www.receitaws.com.br/v1/");
        _httpClient.Timeout = TimeSpan.FromSeconds(10);
        _logger = logger;
    }

    public async Task<ReceitaWsResponse?> ConsultarCnpjAsync(string cnpj, CancellationToken cancellationToken)
    {
        try
        {
            // Remove máscara
            cnpj = new string(cnpj.Where(char.IsDigit).ToArray());

            var response = await _httpClient.GetAsync($"cnpj/{cnpj}", cancellationToken);

            if (!response.IsSuccessStatusCode)
            {
                _logger.LogWarning("ReceitaWS retornou {StatusCode} para CNPJ {Cnpj}", response.StatusCode, cnpj);
                return null;
            }

            var json = await response.Content.ReadAsStringAsync(cancellationToken);
            return JsonSerializer.Deserialize<ReceitaWsResponse>(json);
        }
        catch (HttpRequestException ex)
        {
            _logger.LogError(ex, "Erro de rede ao consultar ReceitaWS para CNPJ {Cnpj}", cnpj);
            return null;  // NÃO bloqueia criação de Cliente
        }
        catch (TaskCanceledException ex)
        {
            _logger.LogWarning(ex, "Timeout ao consultar ReceitaWS para CNPJ {Cnpj}", cnpj);
            return null;  // NÃO bloqueia criação de Cliente
        }
    }
}

// Uso no Command Handler (opcional)
var receitaData = await _receitaWsService.ConsultarCnpjAsync(request.CNPJ, cancellationToken);

if (receitaData != null && receitaData.Status != "ERROR")
{
    // Preenche automaticamente se ReceitaWS retornar dados
    entity.RazaoSocial ??= receitaData.Nome;
    entity.NomeFantasia ??= receitaData.Fantasia;
    entity.Endereco ??= $"{receitaData.Logradouro}, {receitaData.Numero} - {receitaData.Bairro}, {receitaData.Municipio}/{receitaData.Uf}";
    entity.Telefone ??= receitaData.Telefone;
    entity.Email ??= receitaData.Email;
}
// Se ReceitaWS falhar, continua com dados preenchidos manualmente
```

**ReceitaWsResponse DTO**:
```csharp
public record ReceitaWsResponse
{
    public string Nome { get; init; }          // Razão Social
    public string Fantasia { get; init; }      // Nome Fantasia
    public string Situacao { get; init; }      // ATIVA, BAIXADA, SUSPENSA
    public string DataAbertura { get; init; }
    public string Logradouro { get; init; }
    public string Numero { get; init; }
    public string Complemento { get; init; }
    public string Bairro { get; init; }
    public string Municipio { get; init; }
    public string Uf { get; init; }
    public string Cep { get; init; }
    public string Telefone { get; init; }
    public string Email { get; init; }
    public string Status { get; init; }        // OK ou ERROR
}
```

**Exemplos**:
- **Sucesso**: CNPJ 33.592.510/0001-54 → ReceitaWS retorna dados da Vale S.A. → Campos preenchidos automaticamente
- **Falha (não bloqueia)**: ReceitaWS indisponível (HTTP 503) → Usuário preenche dados manualmente
- **Falha (não bloqueia)**: CNPJ válido mas não encontrado na Receita → HTTP 404 → Usuário preenche dados manualmente

**Rate Limiting**: Máximo 3 consultas por minuto por usuário (prevenir abuso)

---

### RN-CLI-006-06: Upload de Logo com Validação

**Descrição**: O sistema deve permitir upload de logo do Cliente nos formatos **JPG, PNG ou SVG** com tamanho máximo de **2MB**. A logo deve ser armazenada em **Azure Blob Storage** e URL pública retornada.

**Justificativa**: Logo corporativo permite personalização white-label da interface para cada Cliente, melhorando experiência do usuário final e branding da plataforma.

**Implementação**:
```csharp
// UploadClienteLogoCommandValidator.cs
public class UploadClienteLogoCommandValidator : AbstractValidator<UploadClienteLogoCommand>
{
    private static readonly string[] AllowedExtensions = { ".jpg", ".jpeg", ".png", ".svg" };
    private const long MaxFileSize = 2 * 1024 * 1024; // 2MB

    public UploadClienteLogoCommandValidator()
    {
        RuleFor(v => v.File)
            .NotNull().WithMessage("Arquivo é obrigatório")
            .Must(HaveAllowedExtension).WithMessage("Formato inválido. Use JPG, PNG ou SVG")
            .Must(NotExceedMaxSize).WithMessage("Arquivo muito grande. Tamanho máximo: 2MB")
            .Must(HaveValidMagicBytes).WithMessage("Arquivo não é uma imagem válida");
    }

    private bool HaveAllowedExtension(IFormFile file)
    {
        var extension = Path.GetExtension(file.FileName).ToLowerInvariant();
        return AllowedExtensions.Contains(extension);
    }

    private bool NotExceedMaxSize(IFormFile file)
    {
        return file.Length <= MaxFileSize;
    }

    private bool HaveValidMagicBytes(IFormFile file)
    {
        // Validar magic bytes (prevenir .exe renomeado para .png)
        using var stream = file.OpenReadStream();
        var buffer = new byte[8];
        stream.Read(buffer, 0, 8);

        // PNG: 89 50 4E 47 0D 0A 1A 0A
        if (buffer[0] == 0x89 && buffer[1] == 0x50 && buffer[2] == 0x4E && buffer[3] == 0x47)
            return true;

        // JPG: FF D8 FF
        if (buffer[0] == 0xFF && buffer[1] == 0xD8 && buffer[2] == 0xFF)
            return true;

        // SVG: 3C 73 76 67 ("<svg")
        if (buffer[0] == 0x3C && buffer[1] == 0x73 && buffer[2] == 0x76 && buffer[3] == 0x67)
            return true;

        return false;
    }
}

// Azure Blob Storage upload
public class AzureBlobStorageService : IAzureBlobStorageService
{
    private readonly BlobServiceClient _blobServiceClient;

    public async Task<string> UploadLogoAsync(Guid clienteId, IFormFile file, CancellationToken cancellationToken)
    {
        var containerClient = _blobServiceClient.GetBlobContainerClient("clientes-logos");
        await containerClient.CreateIfNotExistsAsync(PublicAccessType.Blob, cancellationToken: cancellationToken);

        var fileName = $"{clienteId}{Path.GetExtension(file.FileName).ToLowerInvariant()}";
        var blobClient = containerClient.GetBlobClient(fileName);

        await blobClient.UploadAsync(file.OpenReadStream(), overwrite: true, cancellationToken);

        return blobClient.Uri.ToString(); // URL pública do CDN
    }
}
```

**Exemplos**:
- **Válido**: Logo PNG de 1.5MB → Upload bem-sucedido → URL: `https://cdn.azure.com/clientes-logos/{guid}.png`
- **Válido**: Logo SVG de 500KB → Upload bem-sucedido
- **Inválido**: Logo GIF (formato não permitido) → HTTP 400 "Formato inválido. Use JPG, PNG ou SVG"
- **Inválido**: Logo JPG de 3MB (excede limite) → HTTP 400 "Arquivo muito grande. Tamanho máximo: 2MB"
- **Inválido**: Arquivo .exe renomeado para .png → HTTP 400 "Arquivo não é uma imagem válida" (magic bytes rejeitam)

**Segurança**: Validação de magic bytes previne upload de malware disfarçado de imagem.

---

### RN-CLI-006-07: Soft Delete Obrigatório

**Descrição**: Exclusão de Cliente deve ser **lógica (soft delete)** através do campo `FlExcluido = true`. Exclusão física (`DELETE FROM Cliente`) é **PROIBIDA** e bloqueada por trigger no banco de dados.

**Justificativa**: Compliance LGPD exige **retenção de histórico de auditoria por 7 anos**. Soft delete permite:
- ✅ Restauração em caso de exclusão acidental
- ✅ Preserva integridade referencial (FK de Empresas, Usuários, etc.)
- ✅ Mantém histórico de auditoria intacto
- ✅ Permite análises retroativas de Clientes inativos

**Implementação**:
```csharp
// DeleteClienteCommandHandler.cs
public async Task<Unit> Handle(DeleteClienteCommand request, CancellationToken cancellationToken)
{
    var entity = await _context.Clientes
        .Where(c => c.Id == request.Id && !c.FlExcluido)
        .FirstOrDefaultAsync(cancellationToken);

    if (entity == null)
        throw new NotFoundException(nameof(Cliente), request.Id);

    // SOFT DELETE - NÃO USAR _context.Clientes.Remove(entity)
    entity.FlExcluido = true;
    entity.FlAtivo = false;  // Desativa também
    entity.AlteradoEm = DateTime.UtcNow;
    entity.AlteradoPor = _currentUserService.UserId;

    await _context.SaveChangesAsync(cancellationToken);

    // Auditoria
    await _auditService.LogAsync("CLI_DELETE", entity.Id.ToString(),
        $"Cliente {entity.RazaoSocial} (CNPJ: {entity.CNPJ}) desativado",
        cancellationToken);

    return Unit.Value;
}

// Query Filter global ignora FlExcluido = true automaticamente
modelBuilder.Entity<Cliente>()
    .HasQueryFilter(c => !c.FlExcluido);
```

**Validação no Banco**:
```sql
-- Trigger para prevenir DELETE físico
CREATE TRIGGER [dbo].[trg_Cliente_PreventPhysicalDelete]
ON [dbo].[Cliente]
INSTEAD OF DELETE
AS
BEGIN
    RAISERROR('DELETE físico proibido. Use soft delete (FlExcluido = true)', 16, 1);
    ROLLBACK TRANSACTION;
END;
```

**Restauração**:
```csharp
// RestoreClienteCommandHandler.cs
public async Task<Unit> Handle(RestoreClienteCommand request, CancellationToken cancellationToken)
{
    // Desabilitar query filter temporariamente para encontrar Cliente excluído
    var entity = await _context.Clientes
        .IgnoreQueryFilters()  // ← Permite buscar FlExcluido = true
        .Where(c => c.Id == request.Id && c.FlExcluido)
        .FirstOrDefaultAsync(cancellationToken);

    if (entity == null)
        throw new NotFoundException("Cliente excluído", request.Id);

    entity.FlExcluido = false;
    entity.FlAtivo = true;  // Reativa também

    await _context.SaveChangesAsync(cancellationToken);

    return Unit.Value;
}
```

**Exemplos**:
- **Válido**: `UPDATE Cliente SET FlExcluido = 1 WHERE Id = @Id` → Soft delete bem-sucedido
- **Inválido**: `DELETE FROM Cliente WHERE Id = @Id` → Trigger bloqueia → RAISERROR
- **Restauração**: `UPDATE Cliente SET FlExcluido = 0 WHERE Id = @Id` → Cliente volta a aparecer nas queries

---

### RN-CLI-006-08: Super Admin Bypass de Multi-Tenancy

**Descrição**: Usuários com perfil **Super Admin** podem visualizar e gerenciar Clientes de **TODOS os tenants**, ignorando o Query Filter de `ClienteId`.

**Justificativa**: Super Admin precisa de **visão global** para:
- ✅ Administração da plataforma SaaS
- ✅ Suporte técnico cross-tenant
- ✅ Resolução de problemas de multi-tenancy
- ✅ Auditoria de segurança

**Implementação**:
```csharp
// ApplicationDbContext.cs - Query Filter com bypass
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    modelBuilder.Entity<Cliente>()
        .HasQueryFilter(c =>
            !c.FlExcluido &&
            (_currentUserService.IsSuperAdmin || c.Id == _currentClienteId)
        );

    // Super Admin: _currentUserService.IsSuperAdmin = true → bypass filtro ClienteId
    // Usuário normal: _currentUserService.IsSuperAdmin = false → filtro aplicado
}

// Authorization Policy
services.AddAuthorization(options =>
{
    options.AddPolicy("SuperAdminOnly", policy =>
        policy.RequireRole("Super Admin"));

    options.AddPolicy("ClientesGerenciar", policy =>
        policy.RequireAssertion(context =>
            context.User.IsInRole("Super Admin")
        ));
});

// Controller
[Authorize(Policy = "ClientesGerenciar")]
[HttpGet]
public async Task<ActionResult<PaginatedList<ClienteDto>>> GetClientes([FromQuery] GetClientesQuery query)
{
    // Super Admin vê todos os Clientes
    // Usuário normal NÃO consegue acessar este endpoint (403 Forbidden)
    return await Mediator.Send(query);
}
```

**Exemplos**:
- **Super Admin**: Acessa `GET /api/clientes` → Retorna TODOS os Clientes (18 clientes de diferentes tenants)
- **Admin de Cliente A**: Tenta acessar `GET /api/clientes` → HTTP 403 Forbidden (não tem permissão cross-tenant)
- **Usuário Final**: Tenta acessar `GET /api/clientes` → HTTP 403 Forbidden

**Segurança**: Apenas Super Admins podem criar, editar e desativar Clientes. Admins de Cliente NÃO têm acesso cross-tenant.

---

### RN-CLI-006-09: Desativação de Cliente Bloqueia Usuários

**Descrição**: Ao desativar um Cliente (`FlAtivo = false`), **TODOS os usuários vinculados** ao Cliente devem ser bloqueados automaticamente (`Usuario.FlAtivo = false`) e não conseguem mais fazer login.

**Justificativa**: Quando um Cliente:
- ❌ Cancela contrato
- ❌ Tem pendências financeiras
- ❌ Solicita suspensão temporária

É necessário **bloquear acesso imediato de todos os usuários** para proteger dados e evitar uso indevido da plataforma.

**Implementação**:
```csharp
// UpdateClienteCommandHandler.cs
public async Task<Unit> Handle(UpdateClienteCommand request, CancellationToken cancellationToken)
{
    var entity = await _context.Clientes.FindAsync(request.Id);

    if (entity == null)
        throw new NotFoundException(nameof(Cliente), request.Id);

    var wasActive = entity.FlAtivo;
    entity.FlAtivo = request.FlAtivo;

    // Se Cliente foi desativado, desativa todos os usuários vinculados
    if (wasActive && !request.FlAtivo)
    {
        var usuarios = await _context.Usuarios
            .Where(u => u.ClienteId == entity.Id && !u.FlExcluido)
            .ToListAsync(cancellationToken);

        foreach (var usuario in usuarios)
        {
            usuario.FlAtivo = false;
            usuario.DataInativacao = DateTime.UtcNow;
            usuario.MotivoInativacao = "Cliente desativado";
        }

        await _auditService.LogAsync("CLI_DEACTIVATE_USERS",
            $"{usuarios.Count} usuários desativados automaticamente",
            cancellationToken);
    }

    // Se Cliente foi reativado, NÃO reativa usuários automaticamente (decisão manual)

    await _context.SaveChangesAsync(cancellationToken);

    return Unit.Value;
}

// Login bloqueado para usuários de Cliente inativo
public async Task<bool> CanUserLoginAsync(string identityUserId)
{
    var usuario = await _context.Usuarios
        .Include(u => u.Cliente)
        .FirstOrDefaultAsync(u => u.IdentityUserId == identityUserId);

    if (usuario == null)
        return false;

    // Valida Usuario ativo E Cliente ativo
    return usuario.FlAtivo && !usuario.FlExcluido &&
           usuario.Cliente.FlAtivo && !usuario.Cliente.FlExcluido;
}
```

**Exemplos**:
- **Cenário**: Cliente Petrobras tem 150 usuários ativos
- **Ação**: Super Admin desativa Cliente Petrobras (`FlAtivo = false`)
- **Resultado**:
  - ✅ Todos os 150 usuários são desativados automaticamente (`Usuario.FlAtivo = false`)
  - ✅ Auditoria registra `CLI_DEACTIVATE_USERS` com quantidade de usuários
  - ✅ Nenhum usuário consegue mais fazer login (validação no `CanUserLoginAsync`)

**Observação**: Ao **reativar** um Cliente, os usuários **NÃO são reativados automaticamente**. Super Admin deve revisar e reativar usuários manualmente.

---

### RN-CLI-006-10: Auditoria de Operações de Cliente

**Descrição**: **TODAS** as operações de CREATE, UPDATE, DELETE e ACCESS (opcional) em Clientes devem ser registradas na tabela `AuditLog` com **retenção de 7 anos**.

**Justificativa**: Compliance LGPD (Art. 16) exige rastreabilidade completa de operações em dados pessoais. Auditoria permite:
- ✅ Investigação de incidentes de segurança
- ✅ Atende requisitos ISO 27001
- ✅ Evidências para auditorias externas
- ✅ Rastreamento de mudanças em dados críticos

**Implementação**:
```csharp
// AuditInterceptor.cs
public class AuditInterceptor : SaveChangesInterceptor
{
    private readonly ICurrentUserService _currentUserService;
    private readonly IAuditService _auditService;

    public override async ValueTask<int> SavedChangesAsync(
        SaveChangesCompletedEventData eventData,
        int result,
        CancellationToken cancellationToken = default)
    {
        var entries = eventData.Context!.ChangeTracker
            .Entries()
            .Where(e => e.Entity is Cliente &&
                       (e.State == EntityState.Added ||
                        e.State == EntityState.Modified ||
                        e.State == EntityState.Deleted));

        foreach (var entry in entries)
        {
            var entity = (Cliente)entry.Entity;
            var action = entry.State switch
            {
                EntityState.Added => "CLI_CREATE",
                EntityState.Modified => "CLI_UPDATE",
                EntityState.Deleted => "CLI_DELETE",
                _ => "CLI_UNKNOWN"
            };

            var changes = entry.Properties
                .Where(p => p.IsModified)
                .Select(p => new {
                    Field = p.Metadata.Name,
                    OldValue = p.OriginalValue,
                    NewValue = p.CurrentValue
                })
                .ToList();

            await _auditService.LogAsync(
                action,
                entity.Id.ToString(),
                JsonSerializer.Serialize(new {
                    entity.CNPJ,
                    entity.RazaoSocial,
                    Changes = changes
                }),
                cancellationToken
            );
        }

        return await base.SavedChangesAsync(eventData, result, cancellationToken);
    }
}
```

**Operações Auditadas**:

| Operação | Código | Dados Registrados |
|----------|--------|-------------------|
| Criar Cliente | `CLI_CREATE` | CNPJ, Razão Social, Nome Fantasia, Usuário, Timestamp, IP |
| Editar Cliente | `CLI_UPDATE` | ID, Campos alterados (before/after), Usuário, Timestamp, IP |
| Desativar Cliente | `CLI_DELETE` | ID, CNPJ, Razão Social, Usuário, Timestamp, IP |
| Visualizar Cliente | `CLI_ACCESS` | ID, Usuário, Timestamp (opcional) |
| Upload de Logo | `CLI_LOGO_UPLOAD` | ID, Nome arquivo, Tamanho, URL, Usuário, Timestamp |
| Desativar Usuários em Massa | `CLI_DEACTIVATE_USERS` | ID do Cliente, Quantidade de usuários, Motivo, Usuário, Timestamp |
| Consulta ReceitaWS | `CLI_RECEITA_QUERY` | CNPJ consultado, Sucesso/Falha, Dados retornados, Usuário, Timestamp |

**Retenção**: 7 anos conforme LGPD (Art. 16)

**Exemplo de Log**:
```json
{
  "entityName": "Cliente",
  "entityId": "guid-do-cliente",
  "action": "CLI_UPDATE",
  "userId": "guid-do-usuario",
  "timestamp": "2025-12-29T14:35:00Z",
  "clienteId": null,  // NULL pois Cliente é tenant raiz
  "changes": {
    "razaoSocial": {
      "old": "Petrobras S.A.",
      "new": "Petróleo Brasileiro S.A."
    },
    "flAtivo": {
      "old": true,
      "new": false
    }
  },
  "metadata": {
    "ipAddress": "192.168.1.100",
    "userAgent": "Mozilla/5.0...",
    "endpoint": "PUT /api/clientes/123"
  }
}
```

---

## 3. REFERÊNCIAS AO LEGADO

**Resumo**: No sistema legado, cada Cliente tinha um **banco de dados SQL Server completamente separado** (18 bancos isolados). Não havia tabela "Cliente" pois o próprio banco era o isolamento. A migração para SaaS multi-tenant **consolidou todos em um único banco** usando `ClienteId` como discriminador.

### 3.1 Arquitetura Legado vs. Moderna

| Aspecto | Legado (VB.NET + ASPX) | Moderno (SaaS Multi-Tenant) |
|---------|------------------------|------------------------------|
| **Banco de Dados** | **18 bancos isolados** (Alpargatas, Vale, Bombril, etc.) | **1 banco único** com `ClienteId` |
| **Isolamento** | Physical separation (banco separado) | **Row-Level Security** (EF Core Query Filters) |
| **Onboarding** | Manual (DBA cria banco, copia schema, configura ConnectionString) | **Automatizado** (< 5 minutos via API) |
| **Custo Infra** | **18+ licenças SQL Server** | **1 licença SQL Server** |
| **Gestão Cliente** | NÃO existia (processo manual DBA) | **CRUD completo** via interface Admin |
| **Logo** | Arquivo físico em `~/Images/Clientes/` | **Azure Blob Storage** (CDN global) |
| **ReceitaWS** | NÃO existia (dados preenchidos manualmente) | **Consulta automática** via API |

### 3.2 Mapeamento de Bancos Legados

**Total de bancos legados identificados**: 18

| Banco Legado | CNPJ | Cliente Moderno (RazaoSocial) |
|--------------|------|-------------------------------|
| `Alpargatas` | 61.079.117/0001-05 | Alpargatas S.A. |
| `Vale` | 33.592.510/0001-54 | Vale S.A. |
| `Bombril` | 50.248.011/0001-39 | Bombril S.A. |
| `Anima_Educacao` | 17.685.925/0001-92 | Anima Educação |
| `Fresenius` | 49.324.221/0001-04 | Fresenius Kabi Brasil Ltda |
| `Electrolux` | 76.487.032/0001-25 | Electrolux do Brasil S.A. |
| `CPFL` | 02.429.144/0001-93 | CPFL Energia S.A. |
| `Carrefour` | 45.543.915/0001-81 | Carrefour Comércio e Indústria Ltda |
| `Cielo` | 01.027.058/0001-91 | Cielo S.A. |
| `Gerdau` | 33.611.500/0001-19 | Gerdau S.A. |
| `Magazine_Luiza` | 47.960.950/0001-21 | Magazine Luiza S.A. |
| `Natura` | 71.673.990/0001-77 | Natura Cosméticos S.A. |
| `Rede_D_Or` | 00.387.679/0001-58 | Rede D'Or São Luiz S.A. |
| `Weg` | 07.175.725/0001-49 | WEG S.A. |
| `Ambev` | 02.808.708/0001-07 | Ambev S.A. |
| `Embraer` | 07.689.002/0001-89 | Embraer S.A. |
| `JBS` | 02.916.265/0001-60 | JBS S.A. |
| `Localiza` | 16.670.085/0001-55 | Localiza Rent a Car S.A. |

**Observação**: Cada banco tinha **schema idêntico** (cópia do template), mas **dados completamente isolados**.

### 3.3 Migração Legado → Moderno

**Decisão Arquitetural**: **CRIAR DO ZERO** (não migrar gestão de Clientes do legado)

**Justificativa**:
1. ✅ No legado **não existia gestão de Clientes** via interface (processo manual DBA)
2. ✅ Migrar bancos separados → single database exige **reescrita total** de isolamento
3. ✅ ReceitaWS API não existia no legado (dados cadastrais desatualizados)
4. ✅ Upload de logo em Azure Blob Storage é tecnologia moderna (legado usava filesystem local)
5. ✅ Soft delete com auditoria LGPD não existia no legado (DELETE físico era permitido)

**Estratégia de Migração**:
- ✅ **Fase 1 (Atual)**: Criar sistema moderno de Gestão de Clientes do zero
- ✅ **Fase 2 (Futura)**: Migração de dados de 18 bancos → 1 banco (RF separado)
- ✅ **Fase 3 (Futura)**: Desativação gradual de bancos legados após validação

**Referência ao Código Legado**: ⚠️ **NÃO SE APLICA** (gestão de Clientes não existia no legado)

---

## 4. IMPACTO E DEPENDÊNCIAS

### 4.1 Entidades Relacionadas

| Entidade | Relação | Descrição |
|----------|---------|-----------|
| `Usuario` | **N:1** (Usuario → Cliente) | Cada usuário pertence a UM Cliente. `Usuario.ClienteId` obrigatório. |
| `Empresa` | **N:1** (Empresa → Cliente) | Cada empresa pertence a UM Cliente. `Empresa.ClienteId` obrigatório. |
| `Filial` | **N:1** (via Empresa) | Cada filial pertence a uma Empresa que pertence a um Cliente. |
| `CentroCusto` | **N:1** (via Empresa) | Cada centro de custo pertence a uma Empresa que pertence a um Cliente. |
| `Departamento` | **N:1** (via Empresa) | Cada departamento pertence a uma Empresa que pertence a um Cliente. |
| `AuditLog` | **N:1 (opcional)** | Registros de auditoria podem ter `ClienteId` NULL se for operação em Cliente (tenant raiz). |

**Diagrama de Dependência**:
```
Cliente (Tenant Raiz)
  ├── Usuario (N:1)
  ├── Empresa (N:1)
  │     ├── Filial (N:1)
  │     ├── CentroCusto (N:1)
  │     └── Departamento (N:1)
  └── AuditLog (N:1 opcional)
```

### 4.2 Dependências de RFs

**RFs que DEPENDEM de RF006** (bloqueantes):
- **RF007** - Gestão de Usuários (precisa de `Usuario.ClienteId`)
- **RF008** - Gestão de Empresas (precisa de `Empresa.ClienteId`)
- **RF009** - Gestão de Filiais (precisa de ClienteId via Empresa)
- **RF010** - Gestão de Centros de Custo (precisa de ClienteId via Empresa)
- **Todos os RFs de negócio** (todos precisam de multi-tenancy via ClienteId)

**RFs que RF006 DEPENDE** (pré-requisitos):
- ✅ **RF001** - Parâmetros e Configurações (já implementado)
- ✅ **RF002** - Logs e Monitoramento (já implementado - necessário para auditoria)
- ✅ **RF003** - Auditoria (já implementado - obrigatório para RN-CLI-006-10)
- ✅ **RF004** - Feature Flags (já implementado - necessário para `CLIENTES_GESTAO`)
- ✅ **RF005** - i18n (já implementado - necessário para traduções de interface)

---

## 5. INTEGRAÇÃO COM CENTRAL DE FUNCIONALIDADES

### 5.1 Feature Flag

**FeatureKey**: `CLIENTES_GESTAO`

**Configuração**:
```json
{
  "featureKey": "CLIENTES_GESTAO",
  "nome": "Gestão de Clientes",
  "descricao": "Permite criar, editar e desativar Clientes (tenants raiz) no sistema multi-tenant",
  "habilitado": true,
  "isSystemFeature": true,
  "modulo": "Administração",
  "rota": "/admin/clientes"
}
```

**Nota**: Esta feature é **crítica para operação da plataforma SaaS** e deve estar sempre habilitada. Apenas **Super Admins** têm acesso independente do flag.

### 5.2 Registro no Menu

**Localização**: Módulo Administração → Clientes

**Visibilidade**: Apenas Super Admins

---

## 6. INTERNACIONALIZAÇÃO (i18n)

### 6.1 Chaves de Tradução

**Total de chaves**: ~80 chaves

**Namespace**: `clientes`

**Estrutura**:
```json
{
  "clientes": {
    "list": {
      "title": "Gestão de Clientes",
      "subtitle": "Gerencie Clientes da plataforma SaaS",
      "table": {
        "cnpj": "CNPJ",
        "razaoSocial": "Razão Social",
        "nomeFantasia": "Nome Fantasia",
        "status": "Status",
        "actions": "Ações"
      },
      "filters": {
        "search": "Buscar por CNPJ ou Razão Social",
        "status_all": "Todos",
        "status_active": "Ativos",
        "status_inactive": "Inativos"
      },
      "buttons": {
        "new": "Novo Cliente",
        "export": "Exportar",
        "refresh": "Atualizar"
      },
      "empty": "Nenhum cliente cadastrado",
      "empty_subtitle": "Clique em 'Novo Cliente' para cadastrar o primeiro"
    },
    "form": {
      "title_create": "Novo Cliente",
      "title_edit": "Editar Cliente",
      "tabs": {
        "basic": "Dados Básicos",
        "address": "Endereço",
        "contact": "Contato",
        "branding": "Identidade Visual"
      },
      "cnpj": "CNPJ",
      "cnpj_placeholder": "00.000.000/0000-00",
      "razaoSocial": "Razão Social",
      "nomeFantasia": "Nome Fantasia",
      "inscricaoEstadual": "Inscrição Estadual",
      "email": "E-mail",
      "telefone": "Telefone",
      "site": "Website",
      "endereco": "Endereço Completo",
      "logo": "Logo do Cliente",
      "logo_hint": "Formatos: JPG, PNG, SVG. Tamanho máximo: 2MB",
      "flAtivo": "Cliente Ativo",
      "observacoes": "Observações",
      "consultarReceita": "Consultar Receita Federal",
      "consultandoReceita": "Consultando Receita Federal..."
    },
    "messages": {
      "created": "Cliente criado com sucesso",
      "updated": "Cliente atualizado com sucesso",
      "deleted": "Cliente desativado com sucesso",
      "logo_uploaded": "Logo enviada com sucesso",
      "receita_success": "Dados preenchidos automaticamente via Receita Federal",
      "receita_error": "Não foi possível consultar Receita Federal. Preencha manualmente.",
      "deactivate_warning": "Ao desativar este Cliente, todos os {count} usuários vinculados serão bloqueados. Deseja continuar?",
      "delete_confirm": "Tem certeza que deseja desativar o Cliente {razaoSocial}?",
      "restore_confirm": "Deseja reativar o Cliente {razaoSocial}?"
    },
    "validation": {
      "cnpj_required": "CNPJ é obrigatório",
      "cnpj_invalid": "CNPJ inválido (dígitos verificadores incorretos)",
      "cnpj_length": "CNPJ deve ter 14 dígitos",
      "cnpj_duplicated": "CNPJ {cnpj} já cadastrado",
      "razaoSocial_required": "Razão Social é obrigatória",
      "razaoSocial_min": "Razão Social deve ter no mínimo 3 caracteres",
      "razaoSocial_max": "Razão Social deve ter no máximo 200 caracteres",
      "email_invalid": "E-mail inválido",
      "logo_format": "Formato inválido. Use JPG, PNG ou SVG",
      "logo_size": "Arquivo muito grande. Tamanho máximo: 2MB"
    },
    "status": {
      "active": "Ativo",
      "inactive": "Inativo",
      "deleted": "Excluído"
    }
  }
}
```

**Idiomas Suportados**: pt-BR (padrão), en-US, es-ES, fr-FR

**Fallback**: pt-BR → en-US → chave não traduzida

---

## 7. CONTROLE DE ACESSO (RBAC)

### 7.1 Permissões

**Total de permissões**: 7

| Código | Descrição | Perfis Autorizados |
|--------|-----------|-------------------|
| `clientes:cliente:create` | Criar novos Clientes | Super Admin |
| `clientes:cliente:read` | Visualizar lista e detalhes de Clientes | Super Admin, Admin do Sistema (somente leitura) |
| `clientes:cliente:update` | Editar dados de Clientes | Super Admin |
| `clientes:cliente:delete` | Desativar Clientes (soft delete) | Super Admin |
| `clientes:cliente:export` | Exportar lista de Clientes (CSV/Excel) | Super Admin |
| `clientes:cliente:logo_upload` | Fazer upload de logo | Super Admin |
| `clientes:cliente:restore` | Restaurar Cliente excluído | Super Admin |

**Observação**: Gestão de Clientes é **restrita a Super Admins** pois afeta diretamente a operação da plataforma SaaS. Admins de Cliente **não podem** criar ou editar outros Clientes (não têm acesso cross-tenant).

### 7.2 Matriz de Permissões

| Perfil | CREATE | READ | UPDATE | DELETE | EXPORT | LOGO_UPLOAD | RESTORE |
|--------|--------|------|--------|--------|--------|-------------|---------|
| Super Admin | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| Admin do Sistema | ❌ | ✅ (somente leitura) | ❌ | ❌ | ❌ | ❌ | ❌ |
| Admin de Cliente | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| Usuário Final | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |

### 7.3 Authorization Policies

```csharp
// Program.cs
services.AddAuthorization(options =>
{
    options.AddPolicy("ClientesGerenciar", policy =>
        policy.RequireAssertion(context =>
            context.User.IsInRole("Super Admin")
        ));

    options.AddPolicy("ClientesVisualizar", policy =>
        policy.RequireAssertion(context =>
            context.User.IsInRole("Super Admin") ||
            context.User.IsInRole("Admin do Sistema")
        ));
});

// Minimal API Endpoints
[Authorize(Policy = "ClientesGerenciar")]
app.MapPost("/api/clientes", CreateCliente);

[Authorize(Policy = "ClientesVisualizar")]
app.MapGet("/api/clientes", GetClientes);

[Authorize(Policy = "ClientesGerenciar")]
app.MapPut("/api/clientes/{id}", UpdateCliente);

[Authorize(Policy = "ClientesGerenciar")]
app.MapDelete("/api/clientes/{id}", DeleteCliente);
```

---

## 8. MODELO DE DADOS (RESUMO)

**Tabela Principal**: `Cliente`

**Campos Principais**:
- `Id` (Guid, PK)
- `CNPJ` (string(14), Unique, obrigatório)
- `RazaoSocial` (string(200), obrigatório)
- `NomeFantasia` (string(200), opcional)
- `InscricaoEstadual` (string(20), opcional)
- `Email` (string(100), opcional)
- `Telefone` (string(20), opcional)
- `Site` (string(200), opcional)
- `Endereco` (string(500), opcional)
- `LogoUrl` (string(500), URL Azure Blob Storage)
- `FlAtivo` (bool, default true)
- `FlExcluido` (bool, default false, soft delete)
- Campos de auditoria: `CriadoEm`, `CriadoPor`, `AlteradoEm`, `AlteradoPor`

**Índices**:
- `IX_Cliente_CNPJ_Unique` (Unique)
- `IX_Cliente_FlAtivo` (Filtered Index)
- `IX_Cliente_FlExcluido` (Filtered Index)

**Constraints**:
- `CHK_Cliente_RazaoSocial_NotEmpty` (LEN(LTRIM(RTRIM(RazaoSocial))) >= 3)
- `CHK_Cliente_CNPJ_Length` (LEN(CNPJ) = 14)

**Trigger**:
- `trg_Cliente_PreventPhysicalDelete` (INSTEAD OF DELETE) - Bloqueia DELETE físico

**Referência Completa**: Ver [MD-RF006.md](./MD-RF006.md) (a ser criado)

---

## 9. ENDPOINTS DA API

### 9.1 CRUD Principal

| Método | Endpoint | Descrição | Permissão | Payload | Response |
|--------|----------|-----------|-----------|---------|----------|
| GET | `/api/clientes` | Listar Clientes com paginação e filtros | `clientes:cliente:read` | Query params | 200 OK (PaginatedList) |
| GET | `/api/clientes/{id}` | Obter detalhes de Cliente por ID | `clientes:cliente:read` | - | 200 OK (ClienteDto) |
| POST | `/api/clientes` | Criar novo Cliente | `clientes:cliente:create` | CreateClienteCommand | 201 Created (Guid) |
| PUT | `/api/clientes/{id}` | Atualizar dados de Cliente | `clientes:cliente:update` | UpdateClienteCommand | 200 OK |
| DELETE | `/api/clientes/{id}` | Desativar Cliente (soft delete) | `clientes:cliente:delete` | - | 200 OK |

### 9.2 Operações Especiais

| Método | Endpoint | Descrição | Permissão |
|--------|----------|-----------|-----------|
| POST | `/api/clientes/{id}/logo` | Upload de logo do Cliente | `clientes:cliente:logo_upload` |
| DELETE | `/api/clientes/{id}/logo` | Remover logo do Cliente | `clientes:cliente:logo_upload` |
| POST | `/api/clientes/{id}/restore` | Restaurar Cliente excluído | `clientes:cliente:restore` |
| GET | `/api/clientes/export` | Exportar lista de Clientes (CSV ou Excel) | `clientes:cliente:export` |
| POST | `/api/clientes/consultar-cnpj` | Consultar dados na ReceitaWS por CNPJ | `clientes:cliente:create` |
| GET | `/api/clientes/{id}/usuarios` | Listar usuários vinculados ao Cliente | `clientes:cliente:read` |
| GET | `/api/clientes/{id}/empresas` | Listar empresas vinculadas ao Cliente | `clientes:cliente:read` |
| GET | `/api/clientes/{id}/audit-log` | Obter histórico de auditoria do Cliente | `clientes:cliente:read` |

### 9.3 Exemplos de Requisições

#### GET /api/clientes
```http
GET /api/clientes?page=1&pageSize=20&search=Vale&status=active
Authorization: Bearer {token}
Ocp-Apim-Subscription-Key: {key}

Response 200 OK:
{
  "items": [
    {
      "id": "guid",
      "cnpj": "33592510000154",
      "razaoSocial": "Vale S.A.",
      "nomeFantasia": "Vale",
      "email": "contato@vale.com",
      "telefone": "(21) 3814-4477",
      "logoUrl": "https://cdn.azure.com/clientes-logos/guid.png",
      "flAtivo": true,
      "criadoEm": "2025-01-15T10:30:00Z"
    }
  ],
  "pageNumber": 1,
  "totalPages": 5,
  "totalCount": 98,
  "hasPreviousPage": false,
  "hasNextPage": true
}
```

#### POST /api/clientes
```http
POST /api/clientes
Content-Type: application/json
Authorization: Bearer {token}
Ocp-Apim-Subscription-Key: {key}

{
  "cnpj": "33592510000154",
  "razaoSocial": "Vale S.A.",
  "nomeFantasia": "Vale",
  "inscricaoEstadual": "00.000.000",
  "email": "contato@vale.com",
  "telefone": "(21) 3814-4477",
  "site": "https://www.vale.com",
  "endereco": "Praia de Botafogo, 186 - Botafogo, Rio de Janeiro/RJ",
  "flAtivo": true,
  "observacoes": "Cliente onboarded em 2025"
}

Response 201 Created:
{
  "id": "guid",
  "cnpj": "33592510000154",
  "razaoSocial": "Vale S.A.",
  "criadoEm": "2025-12-29T14:35:00Z"
}

Response 400 Bad Request (CNPJ duplicado):
{
  "errors": {
    "CNPJ": ["CNPJ 33592510000154 já cadastrado"]
  }
}
```

#### POST /api/clientes/{id}/logo
```http
POST /api/clientes/{id}/logo
Content-Type: multipart/form-data
Authorization: Bearer {token}
Ocp-Apim-Subscription-Key: {key}

file: (binary PNG, 1.5MB)

Response 200 OK:
{
  "logoUrl": "https://cdn.azure.com/clientes-logos/guid.png",
  "fileName": "guid.png",
  "fileSize": 1500000,
  "uploadedAt": "2025-12-29T14:40:00Z"
}
```

#### POST /api/clientes/consultar-cnpj
```http
POST /api/clientes/consultar-cnpj
Content-Type: application/json
Authorization: Bearer {token}
Ocp-Apim-Subscription-Key: {key}

{
  "cnpj": "33592510000154"
}

Response 200 OK:
{
  "cnpj": "33.592.510/0001-54",
  "razaoSocial": "Vale S.A.",
  "nomeFantasia": "Vale",
  "situacao": "ATIVA",
  "dataAbertura": "1942-06-01",
  "cnaePrincipal": "0710-3/01",
  "logradouro": "Praia de Botafogo",
  "numero": "186",
  "complemento": "4º andar",
  "bairro": "Botafogo",
  "municipio": "Rio de Janeiro",
  "uf": "RJ",
  "cep": "22250-145",
  "telefone": "(21) 3814-4477",
  "email": "contato@vale.com"
}
```

---

## 10. CRITÉRIOS DE ACEITE

**CA01**: Super Admin cria Cliente com CNPJ válido + consulta ReceitaWS → Dados preenchidos automaticamente
**CA02**: Sistema valida dígitos verificadores de CNPJ no backend → CNPJ inválido retorna HTTP 400
**CA03**: Sistema rejeita criação de Cliente com CNPJ duplicado → HTTP 400 "CNPJ já cadastrado"
**CA04**: Super Admin faz upload de logo PNG 1.5MB → Logo armazenada em Azure Blob Storage → URL retornada
**CA05**: Sistema rejeita upload de arquivo .exe renomeado para .png → Magic bytes detectam malware → HTTP 400
**CA06**: Super Admin desativa Cliente com 150 usuários ativos → 150 usuários bloqueados automaticamente → Nenhum consegue fazer login
**CA07**: Super Admin tenta executar DELETE físico em Cliente → Trigger bloqueia → RAISERROR
**CA08**: Super Admin visualiza lista de Clientes → Retorna TODOS os Clientes (18 clientes de diferentes tenants)
**CA09**: Admin de Cliente A tenta acessar GET /api/clientes → HTTP 403 Forbidden (não tem permissão cross-tenant)
**CA10**: Sistema registra todas as operações em AuditLog → CLI_CREATE, CLI_UPDATE, CLI_DELETE, CLI_LOGO_UPLOAD → Retenção 7 anos

---

## 11. MÉTRICAS E INDICADORES

### 11.1 KPIs

| KPI | Meta | Medição |
|-----|------|---------|
| **Tempo de Onboarding de Cliente** | < 5 minutos | Tempo entre POST /api/clientes e primeiro login de usuário do Cliente |
| **Taxa de Sucesso ReceitaWS** | > 95% | (Consultas ReceitaWS bem-sucedidas / Total de consultas) * 100 |
| **Uptime Multi-Tenancy** | 99.9% | Tempo que Query Filters funcionaram corretamente sem data leakage cross-tenant |
| **Tempo de Resposta GET /api/clientes** | < 200ms (p95) | Percentil 95 de latência do endpoint de listagem |
| **Taxa de Erro Upload Logo** | < 2% | (Uploads de logo falhados / Total de uploads) * 100 |
| **Clientes Ativos** | (Meta variável) | COUNT(*) FROM Cliente WHERE FlAtivo = true AND FlExcluido = false |
| **Crescimento MoM de Clientes** | (Meta variável) | (Clientes criados mês atual - Clientes criados mês anterior) / Clientes mês anterior * 100 |

### 11.2 Alertas Críticos

| Alerta | Condição | Ação |
|--------|----------|------|
| **Data Leakage Cross-Tenant** | Query retorna dados de ClienteId diferente do usuário autenticado | **CRITICAL** - Parar sistema, investigar Query Filter bypass, notificar CISO |
| **ReceitaWS Indisponível** | > 10 falhas consecutivas em consultas ReceitaWS | WARNING - Notificar equipe DevOps, exibir banner no frontend |
| **Upload de Logo Suspeito** | Arquivo .exe renomeado detectado via magic bytes | **CRITICAL** - Bloquear upload, notificar SecOps, registrar IP do usuário |
| **CNPJ Duplicado Detectado** | Tentativa de criar Cliente com CNPJ já existente | INFO - Registrar tentativa, exibir erro ao usuário |
| **Soft Delete Trigger Falhou** | DELETE físico executado sem ser bloqueado | **CRITICAL** - Restaurar backup, investigar falha de trigger, notificar DBA |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-29 | Migração para formato governança v2.0 - 11 seções obrigatórias, 10 RNs completas | Architect Agent |
| 1.0 | 2025-12-28 | Versão inicial - Especificação completa de Gestão de Clientes SaaS multi-tenant | Architect Agent |

---

**Última Atualização**: 2025-12-29
**Versão**: 2.0
**Governança**: RF-UC-RL v2.0
