# RF-005: Internacionaliza√ß√£o (i18n) e Localiza√ß√£o

**RF:** RF005
**Fase:** Fase-1-Sistema-Base
**EPIC:** EPIC001-SYS-Sistema-Infraestrutura
**T√≠tulo:** Internacionaliza√ß√£o (i18n) e Localiza√ß√£o
**Vers√£o:** 2.0
**Data:** 2025-12-29
**Autor:** Ag√™ncia ALC - alc.dev.br

---

## 1. OBJETIVO DO REQUISITO

Implementar o **Sistema de Internacionaliza√ß√£o (i18n) e Localiza√ß√£o Completo** do IControlIT, permitindo que:

- O sistema opere em **m√∫ltiplos idiomas** (pt-BR, en-US, es-ES, fr-FR, etc.)
- Usu√°rios gerenciem tradu√ß√µes **sem acesso ao c√≥digo-fonte**
- Formata√ß√£o regional autom√°tica (datas, moedas, n√∫meros)
- Detec√ß√£o autom√°tica de idioma preferido
- Lazy loading de tradu√ß√µes (performance)
- Versionamento e auditoria completa de tradu√ß√µes
- Suporte a tradu√ß√£o autom√°tica via Azure Translator API

**Compliance e Competitividade**:
- **Expans√£o Global**: Facilita entrada em novos mercados internacionais
- **Experi√™ncia do Usu√°rio**: Interface nativa em idioma preferido
- **Competitividade**: Diferencial para empresas multinacionais
- **Acessibilidade**: Inclus√£o de usu√°rios n√£o-lus√≥fonos

---

## 2. MOTIVA√á√ÉO E CONTEXTO

### Problema Atual

O sistema legado (VB.NET/ASP.NET Web Forms) possui:
- ‚ùå Textos hardcoded em portugu√™s em centenas de arquivos
- ‚ùå Formata√ß√£o de datas/moedas fixas em pt-BR
- ‚ùå Imposs√≠vel internacionalizar sem alterar c√≥digo
- ‚ùå Emails, relat√≥rios e mensagens apenas em portugu√™s
- ‚ùå Barreiras para expans√£o internacional

### Solu√ß√£o Moderna

O sistema moderno (.NET 10 + Angular 19) implementa:
- ‚úÖ Tradu√ß√µes centralizadas em arquivos JSON/RESX
- ‚úÖ Interface de gest√£o visual (sem acesso ao c√≥digo)
- ‚úÖ Suporte a m√∫ltiplos formatos (JSON, PO, XLSX)
- ‚úÖ Versionamento e rollback de tradu√ß√µes
- ‚úÖ Tradu√ß√£o autom√°tica via Azure Translator API
- ‚úÖ Formata√ß√£o regional autom√°tica (CultureInfo)
- ‚úÖ Cache Redis para performance

---

## 3. FUNCIONALIDADES PRINCIPAIS

### F-I18N-001: Gest√£o de Idiomas
Administradores podem adicionar, ativar e desativar idiomas via interface visual.

### F-I18N-002: Download de Templates de Tradu√ß√£o
Sistema gera templates em 3 formatos (JSON, PO, XLSX) para tradutores.

### F-I18N-003: Upload de Tradu√ß√µes
Usu√°rios fazem upload de arquivos traduzidos com valida√ß√£o autom√°tica completa.

### F-I18N-004: Versionamento de Tradu√ß√µes
Sistema mant√©m hist√≥rico completo de uploads com possibilidade de rollback.

### F-I18N-005: Valida√ß√£o de Integridade
Valida interpola√ß√µes `{{variavel}}`, HTML balanceado, chaves obrigat√≥rias.

### F-I18N-006: Tradu√ß√£o Autom√°tica (Machine Translation)
Integra√ß√£o com Azure Translator API para tradu√ß√£o inicial autom√°tica.

### F-I18N-007: Formata√ß√£o Regional
Datas, moedas e n√∫meros formatados conforme cultura do idioma selecionado.

### F-I18N-008: Detec√ß√£o Autom√°tica de Idioma
Sistema detecta idioma preferido via navegador (Accept-Language) e geolocaliza√ß√£o.

### F-I18N-009: Lazy Loading de Tradu√ß√µes
Frontend carrega tradu√ß√µes sob demanda (m√≥dulos n√£o usados n√£o s√£o carregados).

### F-I18N-010: Seletor de Idiomas
Usu√°rio pode alternar idioma manualmente a qualquer momento.

### F-I18N-011: Tradu√ß√µes de Backend
Mensagens de valida√ß√£o, emails e relat√≥rios em m√∫ltiplos idiomas.

### F-I18N-012: Tradu√ß√µes de Frontend
Interface completa (labels, bot√µes, mensagens, tooltips) traduzida.

### F-I18N-013: Bandeiras e √çcones
Bandeiras autom√°ticas para cada idioma (üáßüá∑ üá∫üá∏ üá™üá∏ üá´üá∑).

### F-I18N-014: Progresso de Tradu√ß√£o
Dashboard mostra percentual de completude de cada idioma (ex: 85% - 1.060/1.247 chaves).

### F-I18N-015: Relat√≥rios de Importa√ß√£o
Relat√≥rios detalhados ap√≥s upload (sucessos, avisos, erros).

### F-I18N-016: Fallback Inteligente
Se tradu√ß√£o n√£o existir: `it-IT` ‚Üí `en-US` ‚Üí `pt-BR`.

### F-I18N-017: Cache Redis
Tradu√ß√µes cacheadas para performance (invalida√ß√£o autom√°tica ap√≥s upload).

### F-I18N-018: Auditoria Completa
Registro de quem, quando e o que foi alterado em tradu√ß√µes.

---

## 4. ARQUITETURA T√âCNICA

### Backend (.NET 10)

**Componentes**:
- `IStringLocalizer<T>` - Localiza√ß√£o nativa .NET
- `I18nController` - API REST para gest√£o de idiomas
- `TranslationFileService` - Gera√ß√£o/importa√ß√£o de arquivos (JSON/PO/XLSX)
- `TranslationValidationService` - Valida√ß√µes de integridade
- `AzureTranslatorService` - Tradu√ß√£o autom√°tica

**Tabelas do Banco**:
- `SistemaIdiomas` - Idiomas cadastrados
- `SistemaTraducaoChaves` - Chaves de tradu√ß√£o (common.buttons.save)
- `SistemaTraducoes` - Valores traduzidos por idioma
- `SistemaTraducaoVersoes` - Hist√≥rico de uploads
- `SistemaTraducaoRelatorios` - Relat√≥rios de importa√ß√£o

### Frontend (Angular 19)

**Biblioteca**: `@jsverse/transloco` (moderna, lazy loading nativo)
- **N√ÉO** usar `@ngx-translate/core` (depreciado)

**Componentes**:
- `I18nManagementComponent` - Tela principal de gest√£o
- `CreateLanguageDialogComponent` - Modal adicionar idioma
- `DownloadTemplateDialogComponent` - Modal download template
- `UploadTranslationDialogComponent` - Modal upload com drag & drop
- `TranslationHistoryDialogComponent` - Modal hist√≥rico de vers√µes
- `LanguageSelectorComponent` - Seletor de idiomas (navbar)

**Estrutura de Arquivos**:
```
src/assets/i18n/
‚îú‚îÄ‚îÄ pt-BR.json  (1.247 chaves - idioma padr√£o)
‚îú‚îÄ‚îÄ en-US.json  (lazy loaded)
‚îú‚îÄ‚îÄ es-ES.json  (lazy loaded)
‚îî‚îÄ‚îÄ fr-FR.json  (lazy loaded)
```

---

## 5. REGRAS DE NEG√ìCIO

### RN-I18N-001: Idioma Padr√£o Obrigat√≥rio (pt-BR)

**Descri√ß√£o**: pt-BR √© o idioma padr√£o do sistema e N√ÉO pode ser desativado.
**Prioridade**: CR√çTICA
**Comportamento**:
- Sistema sempre inicia em pt-BR se idioma do usu√°rio n√£o configurado
- Tentativa de desativar pt-BR ‚Üí HTTP 400 Bad Request
- pt-BR deve ter 100% das chaves traduzidas (1.247+)

**Mensagem de Erro**: "Idioma padr√£o (pt-BR) n√£o pode ser desativado"

---

### RN-I18N-002: Detec√ß√£o Autom√°tica de Idioma Preferido

**Descri√ß√£o**: Sistema detecta idioma preferido automaticamente no primeiro acesso.
**Fontes de Detec√ß√£o** (ordem de prioridade):
1. Configura√ß√£o salva do usu√°rio (banco de dados)
2. Header HTTP `Accept-Language` (navegador)
3. Geolocaliza√ß√£o via IP (GeoIP)
4. Idioma padr√£o (pt-BR)

**Comportamento**:
```typescript
// Exemplo de detec√ß√£o
const idioma = usuario.IdiomaPreferido
  || navegador.acceptLanguage[0]
  || geoIP.detectarIdiomaPorPais()
  || 'pt-BR';
```

**Persist√™ncia**: Idioma selecionado salvo em `Usuarios.IdiomaPreferido`.

---

### RN-I18N-003: Fallback em Cascata

**Descri√ß√£o**: Se tradu√ß√£o n√£o existir, usar fallback em cascata.
**Ordem de Fallback**:
```
Idioma Selecionado ‚Üí Idioma Base do Grupo ‚Üí en-US ‚Üí pt-BR
```

**Exemplo**:
```
it-IT (inexistente) ‚Üí en-US (base do grupo latino) ‚Üí pt-BR (padr√£o)
fr-CA (incompleto) ‚Üí fr-FR ‚Üí en-US ‚Üí pt-BR
```

**Comportamento no Frontend**:
- N√ÉO exibir chave t√©cnica (`common.buttons.save`)
- Exibir tradu√ß√£o do fallback silenciosamente
- Log de chave faltante (desenvolvimento)

---

### RN-I18N-004: Formata√ß√£o Regional Autom√°tica

**Descri√ß√£o**: Datas, moedas e n√∫meros formatados conforme cultura do idioma.

**Tabela de Formatos**:
| Idioma | Data | Moeda | Decimal | Timezone |
|--------|------|-------|---------|----------|
| pt-BR | dd/MM/yyyy | R$ 1.234,56 | 1.234,56 (v√≠rgula) | America/Sao_Paulo (UTC-3) |
| en-US | MM/dd/yyyy | $1,234.56 | 1,234.56 (ponto) | America/New_York (UTC-5) |
| es-ES | dd/MM/yyyy | 1.234,56 ‚Ç¨ | 1.234,56 (v√≠rgula) | Europe/Madrid (UTC+1) |
| fr-FR | dd/MM/yyyy | 1 234,56 ‚Ç¨ | 1 234,56 (espa√ßo) | Europe/Paris (UTC+1) |

**Implementa√ß√£o Backend**:
```csharp
CultureInfo.CurrentCulture = new CultureInfo(idioma);
CultureInfo.CurrentUICulture = new CultureInfo(idioma);
```

**Implementa√ß√£o Frontend**:
```typescript
// Angular DatePipe, CurrencyPipe, DecimalPipe
{{ dataAtual | date:'short':'':'pt-BR' }}
{{ valor | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}
```

---

### RN-I18N-005: Valida√ß√£o de C√≥digo de Idioma (ISO 639-1 + ISO 3166-1)

**Descri√ß√£o**: C√≥digo do idioma deve seguir padr√£o ISO.

**Formato V√°lido**: `<idioma>-<pa√≠s>` (ex: `pt-BR`, `en-US`, `es-ES`)
- `idioma`: 2 letras min√∫sculas (ISO 639-1)
- `pa√≠s`: 2 letras mai√∫sculas (ISO 3166-1)

**Valida√ß√£o**:
```regex
^[a-z]{2}-[A-Z]{2}$
```

**Exemplos V√°lidos**: `pt-BR`, `en-US`, `es-ES`, `fr-FR`, `de-DE`, `it-IT`
**Exemplos Inv√°lidos**: `ptBR` (sem h√≠fen), `PT-BR` (mai√∫scula errada), `por-BR` (3 letras)

**Mensagem de Erro**: "C√≥digo de idioma inv√°lido. Use formato: pt-BR, en-US, es-ES"

---

### RN-I18N-006: C√≥digo de Idioma √önico

**Descri√ß√£o**: N√£o pode existir dois idiomas com mesmo c√≥digo.

**Valida√ß√£o**: `UNIQUE INDEX` em `SistemaIdiomas.Codigo`

**Comportamento**:
- Tentativa de criar `en-US` quando j√° existe ‚Üí HTTP 409 Conflict
- Mensagem: "Idioma en-US j√° cadastrado no sistema"

---

### RN-I18N-007: Ativa√ß√£o de Idioma Requer M√≠nimo 80% de Tradu√ß√£o

**Descri√ß√£o**: Idioma s√≥ pode ser ativado com m√≠nimo 80% de tradu√ß√£o completa.

**Valida√ß√£o**:
```csharp
if (progresso < 80)
{
    throw new ValidationException(
        "Idioma deve ter no m√≠nimo 80% de tradu√ß√£o para ser ativado. " +
        $"Progresso atual: {progresso}%"
    );
}
```

**Exce√ß√µes**:
- pt-BR (padr√£o): sempre 100%
- Idiomas em fase de teste: podem ser ativados com aviso

**Aviso Exibido**:
```
‚ö†Ô∏è Aten√ß√£o: Este idioma possui apenas 82% de tradu√ß√£o.
Algumas chaves usar√£o fallback (en-US ou pt-BR).
Deseja continuar?
```

---

### RN-I18N-008: Estrutura Hier√°rquica de Chaves (Namespaces)

**Descri√ß√£o**: Chaves de tradu√ß√£o devem seguir estrutura hier√°rquica com namespaces.

**Formato**: `namespace.subnamespace.chave`

**Exemplos**:
```
common.buttons.save
common.buttons.cancel
menu.dashboard
menu.users.list
validation.email.required
validation.email.invalid
```

**Regras**:
- M√°ximo 5 n√≠veis de profundidade
- Usar camelCase ap√≥s o ponto
- Sem espa√ßos ou caracteres especiais
- M√≠nimo 2 n√≠veis (namespace.chave)

**Valida√ß√£o**:
```regex
^[a-z]+(\.[a-zA-Z]+){1,4}$
```

---

### RN-I18N-009: Suporte a Interpola√ß√£o de Vari√°veis

**Descri√ß√£o**: Tradu√ß√µes podem conter vari√°veis din√¢micas usando sintaxe `{{variavel}}`.

**Sintaxe**: `{{nomeVariavel}}`

**Exemplo**:
```json
{
  "welcome.message": "Bem-vindo, {{username}}!",
  "validation.minLength": "M√≠nimo {{min}} caracteres",
  "cart.total": "Total: {{count}} itens ({{price}})"
}
```

**Uso no Frontend**:
```typescript
// Angular
{{ 'welcome.message' | transloco: {username: user.name} }}

// C√≥digo TypeScript
this.transloco.translate('validation.minLength', { min: 8 })
```

**Uso no Backend**:
```csharp
_localizer["welcome.message", new { username = user.Name }]
_localizer["validation.minLength", new { min = 8 }]
```

**Valida√ß√£o**: Nomes de vari√°veis consistentes entre idiomas.

---

### RN-I18N-010: Valida√ß√£o de Interpola√ß√µes no Upload

**Descri√ß√£o**: Ao fazer upload de tradu√ß√µes, sistema valida se interpola√ß√µes s√£o consistentes.

**Valida√ß√µes**:
1. **Mesmo n√∫mero de vari√°veis**: `{{username}}` em pt-BR ‚Üí deve ter `{{username}}` em en-US
2. **Mesmos nomes de vari√°veis**: Se pt-BR usa `{{min}}`, en-US n√£o pode usar `{{minimo}}`
3. **Sintaxe correta**: `{{var}}` (v√°lido), `{var}` (inv√°lido), `{{var}` (inv√°lido)

**Exemplo de Erro**:
```
Chave: validation.minLength
pt-BR: "M√≠nimo {{min}} caracteres"
en-US: "Minimum {{minimum}} characters"  ‚ùå ERRO: Vari√°vel diferente

Erro: Interpola√ß√£o inconsistente. pt-BR usa {{min}}, mas en-US usa {{minimum}}
```

**Comportamento**: Upload rejeitado se houver erros cr√≠ticos de interpola√ß√£o.

---

### RN-I18N-011: Formatos de Arquivo Suportados (JSON, PO, XLSX)

**Descri√ß√£o**: Sistema suporta 3 formatos para download/upload de tradu√ß√µes.

#### 1. JSON (Formato Padr√£o - Desenvolvedores)
```json
{
  "common": {
    "buttons": {
      "save": "Salvar",
      "cancel": "Cancelar"
    }
  },
  "menu": {
    "dashboard": "Painel de Controle"
  }
}
```

#### 2. PO (Gettext - Ferramentas CAT)
```po
msgid "common.buttons.save"
msgstr "Salvar"

msgid "menu.dashboard"
msgstr "Painel de Controle"
```

#### 3. XLSX (Excel - Tradutores N√£o-T√©cnicos)
| Chave | pt-BR | en-US | es-ES | Contexto |
|-------|-------|-------|-------|----------|
| common.buttons.save | Salvar | Save | Guardar | Bot√£o de salvar |
| menu.dashboard | Painel de Controle | Dashboard | Panel de Control | Menu principal |

**Detec√ß√£o Autom√°tica**: Sistema detecta formato pelo conte√∫do/extens√£o.

---

### RN-I18N-012: Valida√ß√£o de HTML Balanceado

**Descri√ß√£o**: Se tradu√ß√£o contiver HTML, tags devem estar balanceadas.

**Valida√ß√µes**:
- `<b>Texto</b>` ‚úÖ V√°lido
- `<b>Texto` ‚ùå Inv√°lido (tag n√£o fechada)
- `</b>Texto<b>` ‚ùå Inv√°lido (ordem incorreta)

**Exemplo de Erro**:
```
Chave: messages.warning
Valor: "<b>Aten√ß√£o: <i>Este item ser√° exclu√≠do</b></i>"
Erro: Tags HTML n√£o balanceadas. <b> aberta antes de <i> mas fechada depois.
```

**Comportamento**: Upload rejeitado com lista de chaves problem√°ticas.

---

### RN-I18N-013: Limite de Tamanho de Tradu√ß√£o (Aviso)

**Descri√ß√£o**: Tradu√ß√µes com > 500 caracteres geram aviso (n√£o bloqueiam import).

**Raz√£o**: Tradu√ß√µes muito longas podem indicar erro ou necessidade de revis√£o UX.

**Comportamento**:
```
‚ö†Ô∏è Aviso: 3 tradu√ß√µes muito longas (> 500 caracteres)
- help.tutorial.step1 (812 caracteres)
- terms.privacy.section3 (1.024 caracteres)
- email.template.welcome (687 caracteres)

Recomenda√ß√£o: Considere dividir em textos menores para melhor UX.
Upload permitido, mas revise estas chaves.
```

---

### RN-I18N-014: Detec√ß√£o de Tradu√ß√µes Id√™nticas ao Original (Aviso)

**Descri√ß√£o**: Se tradu√ß√£o for id√™ntica ao texto de refer√™ncia (pt-BR), gerar aviso.

**Exemplo**:
```
Chave: menu.dashboard
pt-BR (ref): "Dashboard"
en-US: "Dashboard"  ‚ö†Ô∏è Aviso: Id√™ntico ao original
```

**Comportamento**: N√£o bloqueia import, mas lista chaves suspeitas no relat√≥rio.

**Raz√£o**: Pode indicar que tradutor n√£o traduziu, ou que termo √© universal (ex: "Email", "Dashboard").

---

### RN-I18N-015: Versionamento Completo de Uploads

**Descri√ß√£o**: Sistema mant√©m hist√≥rico completo de todos os uploads de tradu√ß√£o.

**Informa√ß√µes Armazenadas**:
- Arquivo original (blob)
- Data/hora do upload
- Usu√°rio respons√°vel
- Vers√£o (ex: v1.5)
- Delta de progresso (antes: 58%, depois: 85%)
- Chaves adicionadas/atualizadas/removidas
- Relat√≥rio de valida√ß√£o

**Rollback**: Administrador pode reverter para qualquer vers√£o anterior.

**Auditoria**: Registro completo em `Sistema_Auditoria` (RF-004).

---

### RN-I18N-016: Backup Autom√°tico Antes de Sobrescrever

**Descri√ß√£o**: Antes de importar novas tradu√ß√µes, sistema cria backup autom√°tico da vers√£o atual.

**Processo**:
1. Usu√°rio faz upload de `en-US-atualizado.json`
2. Sistema cria backup da vers√£o atual (`SistemaTraducaoVersoes`)
3. Sistema valida novo arquivo
4. Sistema importa tradu√ß√µes (sobrescrevendo existentes)
5. Sistema invalida cache Redis
6. Sistema gera relat√≥rio

**Rollback**: Se algo der errado, administrador pode restaurar backup.

---

### RN-I18N-017: Cache Redis para Performance

**Descri√ß√£o**: Tradu√ß√µes s√£o cacheadas em Redis para performance.

**Estrat√©gia de Cache**:
- **Chave**: `i18n:{idioma}:{namespace}` (ex: `i18n:en-US:common`)
- **TTL**: 24 horas (invalida√ß√£o autom√°tica ap√≥s upload)
- **Lazy Loading**: Carregar namespace sob demanda

**Invalida√ß√£o**:
```csharp
// Ap√≥s upload de en-US
await _cache.InvalidateAsync("i18n:en-US:*");
```

**Benef√≠cio**: Redu√ß√£o de 90% nas queries ao banco (50 RPS ‚Üí 5 RPS).

---

### RN-I18N-018: Tradu√ß√£o Autom√°tica via Azure Translator (Opcional)

**Descri√ß√£o**: Administrador pode solicitar tradu√ß√£o autom√°tica inicial via Azure Translator API.

**Fluxo**:
1. Administrador cria novo idioma (ex: `ja-JP` - Japon√™s)
2. Clica em "Traduzir Automaticamente"
3. Sistema envia todas as chaves pt-BR para Azure Translator API
4. Sistema recebe tradu√ß√µes em japon√™s
5. Sistema marca tradu√ß√µes como `FoiTraduzidoPorMaquina = True`
6. Sistema exibe aviso: "‚ö†Ô∏è Tradu√ß√£o autom√°tica. Revis√£o recomendada."
7. Tradutor humano revisa e ajusta tradu√ß√µes
8. Ap√≥s revis√£o, `FoiRevisado = True`

**Custo**: Azure Translator cobra por caractere traduzido (ex: $10/1M caracteres).

**Qualidade**: Tradu√ß√£o autom√°tica √© ponto de partida, NUNCA substitui revis√£o humana.

---

### RN-I18N-019: Permiss√µes RBAC para Gest√£o de Tradu√ß√µes

**Descri√ß√£o**: Gest√£o de tradu√ß√µes √© protegida por permiss√µes RBAC.

**Permiss√µes**:
| C√≥digo | Descri√ß√£o | Perfis Padr√£o |
|--------|-----------|---------------|
| `SYS.I18N.READ` | Visualizar idiomas e progresso | Todos autenticados |
| `SYS.I18N.UPDATE` | Atualizar idioma existente | Admin, Tradutor |
| `SYS.I18N.MANAGE_LANGUAGES` | Criar, ativar, desativar idiomas | Admin |
| `SYS.I18N.AUTO_TRANSLATE` | Tradu√ß√£o autom√°tica via API | Admin |
| `SYS.I18N.EXPORT` | Exportar tradu√ß√µes | Admin, Tradutor |
| `SYS.I18N.IMPORT` | Importar tradu√ß√µes | Admin, Tradutor |
| `SYS.I18N.DOWNLOAD_TEMPLATE` | Baixar template | Admin, Tradutor |
| `SYS.I18N.UPLOAD_TRANSLATION` | Upload de tradu√ß√µes | Admin, Tradutor |

**Valida√ß√£o**: Endpoints protegidos com `[RequirePermission("SYS.I18N.MANAGE_LANGUAGES")]`.

---

### RN-I18N-020: Lazy Loading de Tradu√ß√µes no Frontend

**Descri√ß√£o**: Frontend carrega tradu√ß√µes sob demanda (m√≥dulos n√£o usados n√£o s√£o carregados).

**Estrat√©gia**:
```typescript
// Carregar apenas m√≥dulo atual
const translocoLoader = {
  getTranslation(lang: string) {
    return this.http.get(`/assets/i18n/${lang}.json`);
  }
};

// Carregar namespaces espec√≠ficos
await this.transloco.selectTranslate('menu.dashboard', {}, 'menu').pipe(take(1)).toPromise();
```

**Benef√≠cio**:
- Redu√ß√£o de 70% no tamanho inicial do bundle
- Carregamento inicial mais r√°pido
- Tradu√ß√µes carregadas apenas quando necess√°rias

---

### RN-I18N-021: Tratamento de Pluraliza√ß√£o

**Descri√ß√£o**: Tradu√ß√µes devem suportar pluraliza√ß√£o conforme regras do idioma.

**Exemplo pt-BR**:
```json
{
  "cart.items": {
    "zero": "Nenhum item",
    "one": "{{count}} item",
    "other": "{{count}} itens"
  }
}
```

**Exemplo en-US**:
```json
{
  "cart.items": {
    "zero": "No items",
    "one": "{{count}} item",
    "other": "{{count}} items"
  }
}
```

**Uso**:
```typescript
{{ 'cart.items' | transloco: {count: 0} }}  // "Nenhum item"
{{ 'cart.items' | transloco: {count: 1} }}  // "1 item"
{{ 'cart.items' | transloco: {count: 5} }}  // "5 itens"
```

**Nota**: Regras de pluraliza√ß√£o variam por idioma (polon√™s tem 3 formas, √°rabe tem 6).

---

### RN-I18N-022: Bandeiras e √çcones de Idiomas

**Descri√ß√£o**: Sistema exibe bandeiras automaticamente para cada idioma.

**Implementa√ß√£o**:
- **Biblioteca**: [flag-icons](https://github.com/lipis/flag-icons) ou [country-flag-emoji-polyfill](https://github.com/talkjs/country-flag-emoji-polyfill)
- **Mapeamento**: `pt-BR` ‚Üí üáßüá∑, `en-US` ‚Üí üá∫üá∏, `es-ES` ‚Üí üá™üá∏, `fr-FR` ‚Üí üá´üá∑
- **Fallback**: Emoji ou √≠cone gen√©rico de idioma üåê

**Customiza√ß√£o**: Administrador pode alterar bandeira manualmente (casos especiais).

---

## 6. INTEGRA√á√ïES OBRIGAT√ìRIAS

### 6.1. Auditoria (RF-004)
- Registrar cria√ß√£o de idiomas
- Registrar uploads de tradu√ß√µes
- Registrar ativa√ß√£o/desativa√ß√£o de idiomas
- Categoria: `CONFIG`

### 6.2. Permiss√µes RBAC (RF-007)
- 8 permiss√µes espec√≠ficas (`SYS.I18N.*`)
- Valida√ß√£o em todos os endpoints
- Perfil padr√£o "Tradutor" com permiss√µes adequadas

### 6.3. Multi-Tenancy
- Tradu√ß√µes s√£o **globais** (n√£o isoladas por tenant)
- Configura√ß√£o de idioma preferido por tenant (opcional)
- Auditoria de altera√ß√µes por tenant

### 6.4. Cache Redis
- Cache de tradu√ß√µes por idioma
- Invalida√ß√£o autom√°tica ap√≥s upload
- TTL configur√°vel (padr√£o: 24h)

### 6.5. Azure Translator API
- Tradu√ß√£o autom√°tica inicial
- Configura√ß√£o via `appsettings.json`
- Chave de API gerenciada via Azure Key Vault

---

## 7. MODELO DE DADOS

### 7.1. Tabela: SistemaIdiomas
```sql
CREATE TABLE SistemaIdiomas (
    Id INT PRIMARY KEY IDENTITY(1,1),
    Codigo NVARCHAR(10) NOT NULL UNIQUE, -- pt-BR, en-US, etc
    Nome NVARCHAR(100) NOT NULL, -- Portugu√™s (Brasil)
    NomeNativo NVARCHAR(100) NOT NULL, -- Portugu√™s
    CodigoPais NVARCHAR(2) NOT NULL, -- BR, US, etc
    Cultura NVARCHAR(10) NOT NULL, -- pt-BR (para formata√ß√£o)
    BandeiraEmoji NVARCHAR(10), -- üáßüá∑
    BandeiraIconUrl NVARCHAR(500), -- URL do √≠cone
    IsAtivo BIT NOT NULL DEFAULT 0,
    ProgressoPercentual DECIMAL(5,2) NOT NULL DEFAULT 0,
    TotalChaves INT NOT NULL DEFAULT 0,
    ChavesTraduzidas INT NOT NULL DEFAULT 0,
    IdiomaReferenciaId INT NULL, -- FK para outro idioma (usado como base)
    DataCriacao DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    DataAtualizacao DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    CriadoPorUsuarioId INT NOT NULL,

    FOREIGN KEY (IdiomaReferenciaId) REFERENCES SistemaIdiomas(Id),
    FOREIGN KEY (CriadoPorUsuarioId) REFERENCES Usuarios(Id)
);
```

### 7.2. Tabela: SistemaTraducaoChaves
```sql
CREATE TABLE SistemaTraducaoChaves (
    Id INT PRIMARY KEY IDENTITY(1,1),
    Chave NVARCHAR(500) NOT NULL UNIQUE, -- common.buttons.save
    Categoria NVARCHAR(100), -- common, menu, validation
    Contexto NVARCHAR(1000), -- Descri√ß√£o para tradutores
    ExemploUso NVARCHAR(1000), -- Exemplo de uso
    TemInterpolacao BIT NOT NULL DEFAULT 0, -- Cont√©m {{variavel}}?
    VariaveisInterpolacao NVARCHAR(500), -- username,email (CSV)
    IsObrigatorio BIT NOT NULL DEFAULT 1,
    IsAtivo BIT NOT NULL DEFAULT 1,
    DataCriacao DATETIME2 NOT NULL DEFAULT GETUTCDATE(),

    INDEX IX_Chave (Chave),
    INDEX IX_Categoria (Categoria)
);
```

### 7.3. Tabela: SistemaTraducoes
```sql
CREATE TABLE SistemaTraducoes (
    Id INT PRIMARY KEY IDENTITY(1,1),
    ChaveId INT NOT NULL,
    IdiomaId INT NOT NULL,
    Valor NVARCHAR(MAX) NOT NULL,
    FoiTraduzidoPorMaquina BIT NOT NULL DEFAULT 0,
    FoiRevisado BIT NOT NULL DEFAULT 0,
    DataCriacao DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    DataAtualizacao DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    CriadoPorUsuarioId INT NOT NULL,
    AtualizadoPorUsuarioId INT NULL,

    FOREIGN KEY (ChaveId) REFERENCES SistemaTraducaoChaves(Id),
    FOREIGN KEY (IdiomaId) REFERENCES SistemaIdiomas(Id),
    FOREIGN KEY (CriadoPorUsuarioId) REFERENCES Usuarios(Id),
    FOREIGN KEY (AtualizadoPorUsuarioId) REFERENCES Usuarios(Id),

    UNIQUE (ChaveId, IdiomaId),
    INDEX IX_Idioma (IdiomaId),
    INDEX IX_Chave_Idioma (ChaveId, IdiomaId)
);
```

### 7.4. Tabela: SistemaTraducaoVersoes
```sql
CREATE TABLE SistemaTraducaoVersoes (
    Id INT PRIMARY KEY IDENTITY(1,1),
    IdiomaId INT NOT NULL,
    NumeroVersao NVARCHAR(20) NOT NULL, -- v1.5
    NomeArquivo NVARCHAR(500) NOT NULL,
    FormatoArquivo NVARCHAR(10) NOT NULL, -- JSON, PO, XLSX
    TamanhoBytes BIGINT NOT NULL,
    ConteudoArquivo VARBINARY(MAX) NOT NULL, -- Arquivo original
    ChavesAdicionadas INT NOT NULL DEFAULT 0,
    ChavesAtualizadas INT NOT NULL DEFAULT 0,
    ChavesRemovidas INT NOT NULL DEFAULT 0,
    ProgressoAnterior DECIMAL(5,2) NOT NULL,
    ProgressoNovo DECIMAL(5,2) NOT NULL,
    Observacoes NVARCHAR(MAX),
    DataUpload DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    UploadPorUsuarioId INT NOT NULL,

    FOREIGN KEY (IdiomaId) REFERENCES SistemaIdiomas(Id),
    FOREIGN KEY (UploadPorUsuarioId) REFERENCES Usuarios(Id),

    INDEX IX_Idioma_Data (IdiomaId, DataUpload DESC)
);
```

---

## 8. INTERFACES E FLUXOS

### 8.1. Tela: Gest√£o de Idiomas
**Localiza√ß√£o**: Sistema ‚Üí Configura√ß√µes ‚Üí Internacionaliza√ß√£o

**Componentes**:
1. Lista de idiomas com progresso visual (barra de progresso)
2. Bot√µes de a√ß√£o: Baixar Template, Upload, Ativar/Desativar, Hist√≥rico
3. Modal de cria√ß√£o de idioma
4. Modal de upload com drag & drop
5. Modal de hist√≥rico de vers√µes

### 8.2. Fluxo: Adicionar Novo Idioma
```
1. Admin acessa Gest√£o de Idiomas
2. Clica em [+ Novo Idioma]
3. Preenche modal:
   - Seleciona idioma (lista ISO)
   - Define c√≥digo (auto-preenchido)
   - Seleciona pa√≠s/regi√£o
   - Sistema sugere bandeira
4. Clica em [Criar]
5. Sistema cria registro (Status: Inativo, 0% progresso)
6. Admin clica em [Baixar Template]
7. Seleciona formato (XLSX recomendado)
8. Sistema gera arquivo com 1.247 chaves
9. Admin envia para tradutor
10. Tradutor preenche Excel offline
11. Admin faz upload via modal
12. Sistema valida e importa
13. Progresso atualiza (ex: 85%)
14. Quando >= 80%, Admin ativa idioma
15. Usu√°rios veem novo idioma dispon√≠vel
```

---

## 9. CRIT√âRIOS DE ACEITE

### CA-I18N-001: Gest√£o Visual de Idiomas
- ‚úÖ Administrador pode adicionar idioma sem acesso ao c√≥digo
- ‚úÖ Sistema exibe progresso visual de tradu√ß√£o (%)
- ‚úÖ Administrador pode ativar/desativar idiomas

### CA-I18N-002: Download de Templates
- ‚úÖ Sistema gera templates em 3 formatos (JSON, PO, XLSX)
- ‚úÖ Template inclui coment√°rios e contexto para tradutores
- ‚úÖ Template cont√©m todas as chaves ativas do sistema

### CA-I18N-003: Upload e Valida√ß√£o
- ‚úÖ Drag & drop funcional
- ‚úÖ Valida√ß√£o de interpola√ß√µes `{{var}}`
- ‚úÖ Valida√ß√£o de HTML balanceado
- ‚úÖ Relat√≥rio detalhado ap√≥s upload

### CA-I18N-004: Versionamento
- ‚úÖ Hist√≥rico completo de uploads
- ‚úÖ Rollback funcional para vers√£o anterior
- ‚úÖ Diff entre vers√µes exibido

### CA-I18N-005: Performance
- ‚úÖ Cache Redis implementado
- ‚úÖ Lazy loading de tradu√ß√µes no frontend
- ‚úÖ Tempo de carregamento < 200ms por idioma

### CA-I18N-006: Formata√ß√£o Regional
- ‚úÖ Datas formatadas corretamente por idioma
- ‚úÖ Moedas formatadas corretamente por idioma
- ‚úÖ N√∫meros formatados corretamente por idioma

### CA-I18N-007: Fallback
- ‚úÖ Fallback em cascata funcionando
- ‚úÖ Sem exibi√ß√£o de chaves t√©cnicas para usu√°rio final

### CA-I18N-008: Auditoria
- ‚úÖ Todos os uploads registrados em Sistema_Auditoria
- ‚úÖ Ativa√ß√£o/desativa√ß√£o de idiomas auditada

---

## 10. RISCOS E MITIGA√á√ïES

### R-I18N-001: Tradu√ß√£o Autom√°tica de Baixa Qualidade
**Risco**: Azure Translator pode gerar tradu√ß√µes inadequadas
**Probabilidade**: Alta
**Impacto**: M√©dio
**Mitiga√ß√£o**:
- Marcar tradu√ß√µes autom√°ticas como "Requer Revis√£o"
- Exibir aviso claro para usu√°rios
- Fluxo de revis√£o obrigat√≥rio antes de ativar idioma

### R-I18N-002: Performance com Muitos Idiomas
**Risco**: 20+ idiomas ativos podem degradar performance
**Probabilidade**: M√©dia
**Impacto**: Alto
**Mitiga√ß√£o**:
- Cache Redis obrigat√≥rio
- Lazy loading de tradu√ß√µes
- CDN para arquivos est√°ticos

### R-I18N-003: Inconsist√™ncia de Tradu√ß√µes
**Risco**: Tradutores podem usar termos inconsistentes
**Probabilidade**: M√©dia
**Impacto**: M√©dio
**Mitiga√ß√£o**:
- Gloss√°rio de termos t√©cnicos
- Valida√ß√£o de consist√™ncia (termos chave)
- Revis√£o por tradutor s√™nior

---

## 11. DEPEND√äNCIAS

### Depend√™ncias T√©cnicas
- **RF-004**: Auditoria de Logs do Sistema (registro de altera√ß√µes)
- **RF-007**: Login e Autentica√ß√£o (permiss√µes RBAC)
- Azure Translator API (tradu√ß√£o autom√°tica)
- Redis (cache de tradu√ß√µes)
- Angular Transloco (frontend i18n)
- .NET IStringLocalizer (backend i18n)

### Depend√™ncias de Neg√≥cio
- Defini√ß√£o de idiomas priorit√°rios (en-US, es-ES, fr-FR)
- Or√ßamento para Azure Translator API
- Equipe de tradutores/revisores

---

## CHANGELOG

| Vers√£o | Data | Autor | Descri√ß√£o |
|--------|------|-------|-----------|
| 2.0 | 2025-12-29 | Ag√™ncia ALC - alc.dev.br | Vers√£o completa com 22 RNs, gest√£o visual, versionamento, valida√ß√µes |
| 1.0 | 2025-11-04 | Equipe IControlIT | Vers√£o inicial (sistema parcialmente implementado) |

---

**Status**: Documenta√ß√£o Completa
**Pr√≥ximo Passo**: Gerar UC-RF005.md com cobertura 100% das 22 regras de neg√≥cio
