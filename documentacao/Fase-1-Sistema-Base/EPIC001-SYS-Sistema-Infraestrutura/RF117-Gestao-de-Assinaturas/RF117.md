# RF117 - Gestão de Assinaturas

**Versão:** 1.0
**Fase:** Fase 1 - Sistema Base
**Epic:** EPIC001-SYS - Sistema e Infraestrutura
**Prioridade:** Alta
**Status:** Em Especificação

---

## 1. Visão Geral

Gerenciar planos de assinatura comerciais do sistema SaaS, permitindo que clientes assinem planos, contratem módulos extras (addons), realizem upgrades/downgrades, e tenham gestão completa de vigência, renovação e faturamento recorrente.

### 1.1. Objetivos

- Cadastrar planos de assinatura comerciais com módulos inclusos
- Permitir que clientes assinem planos específicos
- Gerenciar addons e módulos extras além do plano base
- Facilitar upgrade e downgrade de planos com cálculo pro-rata
- Controlar vigência, renovação e período de graça
- Manter histórico completo de faturamento
- Enviar notificações automáticas sobre eventos da assinatura
- Integrar com RF083 (Central de Módulos) para controle de acesso

### 1.2. Diferença entre RF023 e RF117

| Aspecto | RF023 - Gestão de Contratos | RF117 - Gestão de Assinaturas |
|---------|----------------------------|-------------------------------|
| **Natureza** | Contratos jurídicos | Assinaturas comerciais |
| **Conteúdo** | Termos, cláusulas, fornecedores, SLAs | Planos, módulos, faturamento recorrente |
| **Foco** | Compliance legal | Modelo SaaS e receita recorrente |
| **Público** | Jurídico, Fornecedores | Clientes, Vendas, Financeiro |

---

## 2. Requisitos Funcionais

### 2.1. Catálogo de Planos de Assinatura

#### Descrição
Sistema deve permitir cadastrar planos comerciais de assinatura com diferentes níveis de acesso e preços.

#### Regras de Negócio

**RN-RF117-01: Estrutura de Plano**
- Todo plano deve ter: código único, nome, descrição, preço mensal, preço anual
- Plano deve conter lista de módulos inclusos (referência ao RF083)
- Plano pode ter limite de usuários e clientes (para multi-tenant)
- Plano pode ter desconto por pagamento anual (ex: 12 meses pelo preço de 10)

**RN-RF117-02: Status do Plano**
- Plano pode ter status: `ativo` (vendendo), `inativo` (não oferecido), `descontinuado` (legado)
- Planos descontinuados não podem ser contratados por novos clientes
- Clientes com planos descontinuados podem continuar usando até renovação

**RN-RF117-03: Categorização**
- Planos devem ser categorizados: `startup`, `empresarial`, `corporativo`
- Categorização facilita segmentação comercial e marketing

#### Dados Principais
- `id`: identificador único
- `codigo`: código do plano (ex: "PLAN-BASIC", "PLAN-PREMIUM")
- `nome`: nome comercial (ex: "Plano Básico", "Plano Premium")
- `descricao`: descrição detalhada do plano
- `preco_mensal`: preço mensal em centavos
- `preco_anual`: preço anual em centavos (com desconto)
- `moeda`: código da moeda (BRL, USD, EUR)
- `modulos_inclusos_json`: lista de IDs de módulos do RF083
- `limite_usuarios`: número máximo de usuários (null = ilimitado)
- `limite_clientes`: número máximo de clientes multi-tenant (null = ilimitado)
- `categoria_plano`: categoria do plano
- `ativo`: flag de ativação
- `disponivel_para_venda`: flag de disponibilidade comercial

---

### 2.2. Assinatura do Cliente

#### Descrição
Cliente deve poder assinar um plano específico, com registro de datas, status e forma de pagamento.

#### Regras de Negócio

**RN-RF117-04: Assinatura Ativa**
- Cliente pode ter apenas 1 assinatura principal ativa por vez
- Assinatura tem ciclo de vida: ativo → vencido → suspenso → cancelado
- Múltiplas assinaturas só são permitidas para addons

**RN-RF117-05: Status da Assinatura**
- `ativo`: assinatura válida e com acesso liberado
- `trial`: período de teste (se aplicável)
- `vencido`: pagamento vencido mas dentro do período de graça
- `suspenso`: período de graça expirado, acesso bloqueado
- `cancelado`: assinatura encerrada permanentemente

**RN-RF117-06: Renovação Automática**
- Assinatura pode ter renovação automática ativada
- Se renovação automática = true, sistema cobra automaticamente na data de vencimento
- Se renovação automática = false, cliente deve renovar manualmente

#### Dados Principais
- `id`: identificador único
- `cliente_id`: referência ao cliente
- `plano_id`: referência ao plano contratado
- `data_inicio`: data de início da assinatura
- `data_vencimento`: data de vencimento do ciclo atual
- `data_cancelamento`: data de cancelamento (se aplicável)
- `status`: status atual da assinatura
- `motivo_cancelamento`: motivo do cancelamento (se aplicável)
- `forma_pagamento`: boleto, cartao, transferencia
- `renovacao_automatica`: flag de renovação automática
- `desconto_aplicado`: desconto percentual ou valor fixo

---

### 2.3. Addons e Módulos Extras

#### Descrição
Cliente pode contratar módulos avulsos além do plano base, com preços e vigências próprias.

#### Regras de Negócio

**RN-RF117-07: Tipos de Addon**
- `permanente`: addon contratado até cancelamento manual
- `temporario`: addon com data de fim definida (ex: trial 30 dias)
- `cortesia`: addon gratuito por tempo limitado (marketing/retenção)

**RN-RF117-08: Renovação de Addon**
- Addon permanente pode ter renovação automática
- Addon temporário expira automaticamente na data_fim
- Sistema notifica 7 dias antes do fim de addon temporário

**RN-RF117-09: Preço de Addon**
- Addon tem preço próprio independente do plano base
- Preço de addon é somado ao valor da fatura mensal/anual
- Addon cortesia tem preço_adicional = 0

#### Dados Principais
- `id`: identificador único
- `assinatura_id`: referência à assinatura principal
- `modulo_id`: referência ao módulo do RF083
- `tipo`: permanente, temporario, cortesia
- `preco_adicional`: preço mensal do addon em centavos
- `data_inicio`: data de início do addon
- `data_fim`: data de fim (null se permanente)
- `renovacao_automatica`: flag de renovação automática

---

### 2.4. Upgrade e Downgrade de Planos

#### Descrição
Cliente pode mudar de plano (upgrade ou downgrade) com cálculo pro-rata de crédito/débito.

#### Regras de Negócio

**RN-RF117-10: Upgrade Imediato**
- Upgrade ativa imediatamente o novo plano
- Sistema calcula crédito pro-rata do plano anterior
- Sistema cobra diferença pro-rata do novo plano
- Novos módulos são liberados imediatamente no RF083

**RN-RF117-11: Downgrade Agendado**
- Downgrade é agendado para próxima renovação (não imediato)
- Cliente mantém plano atual até data de vencimento
- Após vencimento, novo plano é ativado automaticamente
- Sistema valida: downgrade não pode remover módulos em uso ativo

**RN-RF117-12: Cálculo Pro-Rata**
- Pro-rata é calculado por dias restantes no ciclo
- Fórmula crédito: `(preco_plano_anterior / dias_ciclo) * dias_restantes`
- Fórmula débito: `(preco_plano_novo / dias_ciclo) * dias_restantes`
- Valor final = débito - crédito

**RN-RF117-13: Notificação de Mudança**
- Sistema notifica cliente sobre mudança de plano
- Notificação inclui: plano anterior, plano novo, data de efetivação, valor de ajuste
- Para downgrade, notificar módulos que serão removidos

#### Dados Principais (Tabela HistoricoMudancaPlano)
- `id`: identificador único
- `assinatura_id`: referência à assinatura
- `plano_anterior_id`: plano antes da mudança
- `plano_novo_id`: plano após a mudança
- `tipo_mudanca`: upgrade, downgrade
- `data_solicitacao`: data que cliente solicitou mudança
- `data_efetivacao`: data que mudança foi aplicada
- `valor_ajuste`: valor a cobrar (positivo) ou creditar (negativo)
- `usuario_solicitante_id`: usuário que solicitou a mudança

---

### 2.5. Gestão de Vigência e Renovação

#### Descrição
Controlar ciclos de faturamento, renovação automática e período de graça para inadimplência.

#### Regras de Negócio

**RN-RF117-14: Ciclos de Faturamento**
- Assinatura pode ter ciclo: `mensal`, `trimestral`, `semestral`, `anual`
- Ciclo define periodicidade de cobrança e renovação
- Data de próximo faturamento é calculada automaticamente

**RN-RF117-15: Notificações de Vencimento**
- Sistema notifica cliente: 30 dias, 15 dias, 7 dias antes do vencimento
- Notificação inclui: valor a pagar, data de vencimento, link de pagamento
- Se renovação automática = true, notificar que cobrança será automática

**RN-RF117-16: Período de Graça**
- Quando assinatura vence sem pagamento: status = `vencido`
- Durante período de graça (7 dias padrão): sistema mantém acesso mas exibe alertas
- Após período de graça: status = `suspenso`, acesso bloqueado
- Após 30 dias suspenso: status = `cancelado`, dados removidos (LGPD)

**RN-RF117-17: Reativação**
- Cliente pode reativar assinatura suspensa pagando débitos
- Após pagamento: status = `ativo`, acesso liberado imediatamente
- Histórico de suspensão é mantido para análise de crédito

#### Dados Principais
- `ciclo_faturamento`: mensal, trimestral, semestral, anual
- `proximo_faturamento_em`: data calculada do próximo faturamento
- `dias_periodo_graca`: dias de período de graça (padrão 7)

---

### 2.6. Histórico de Faturamento

#### Descrição
Registrar todas as cobranças da assinatura com status de pagamento e integração com sistema de faturas.

#### Regras de Negócio

**RN-RF117-18: Geração Automática de Fatura**
- Sistema gera fatura automaticamente a cada ciclo de faturamento
- Fatura inclui: valor do plano base + valor de addons - descontos
- Fatura é criada com status = `pendente`

**RN-RF117-19: Status de Fatura**
- `pendente`: fatura gerada, aguardando pagamento
- `pago`: pagamento confirmado
- `vencido`: data de vencimento passou sem pagamento
- `cancelado`: fatura cancelada (ex: após cancelamento de assinatura)

**RN-RF117-20: Integração com RF026**
- Se RF026 (Gestão de Faturas) estiver disponível, usar integração
- Caso contrário, manter histórico próprio de faturamento
- Sincronização bidirecional: pagamento em RF026 atualiza status em RF117

#### Dados Principais
- `id`: identificador único
- `assinatura_id`: referência à assinatura
- `data_emissao`: data de emissão da fatura
- `data_vencimento`: data de vencimento
- `data_pagamento`: data de pagamento confirmado (se pago)
- `valor_plano`: valor do plano base
- `valor_addons`: soma de todos os addons
- `valor_desconto`: descontos aplicados
- `valor_total`: valor final a pagar
- `status`: pendente, pago, vencido, cancelado
- `metodo_pagamento`: boleto, cartao, transferencia, pix
- `nota_fiscal_id`: referência à nota fiscal (se integrado)

---

### 2.7. Notificações Automáticas

#### Descrição
Enviar notificações automáticas por email sobre eventos importantes da assinatura.

#### Regras de Negócio

**RN-RF117-21: Eventos de Notificação**
- Assinatura criada → email de boas-vindas com detalhes do plano
- Trial iniciado → email com tutorial de uso
- Trial próximo do fim → emails de lembrete (7, 3, 1 dia antes)
- Assinatura próxima do vencimento → lembrete de renovação (30, 15, 7 dias antes)
- Assinatura vencida → alerta de suspensão iminente
- Upgrade realizado → confirmação + lista de novos módulos disponíveis
- Addon adicionado → confirmação + instruções de uso
- Módulo bloqueado por falta de pagamento → alerta com link de pagamento

**RN-RF117-22: Canal de Notificação**
- Notificações são enviadas por email (canal primário)
- Notificações críticas (suspensão, bloqueio) também aparecem no sistema
- Cliente pode configurar preferências de notificação (quais eventos receber)

**RN-RF117-23: Template de Email**
- Cada evento tem template próprio com branding da empresa
- Templates incluem: logo, cores corporativas, links de ação
- Templates são personalizados com dados do cliente e assinatura

---

### 2.8. Integração com RF083 (Central de Módulos)

#### Descrição
Integração bidirecional entre gestão de assinaturas (RF117) e controle de acesso a módulos (RF083).

#### Regras de Negócio

**RN-RF117-24: Consulta de Módulos Disponíveis**
- RF117 consulta RF083 para obter lista de módulos cadastrados
- Ao criar plano, RF117 valida que todos os módulos existem no RF083
- RF117 exibe nome, descrição e categoria dos módulos (dados do RF083)

**RN-RF117-25: Registro de Módulos Contratados**
- Quando cliente assina plano, RF117 registra quais módulos foram contratados
- RF117 mantém lista atualizada de módulos por assinatura (plano base + addons)
- Mudança de plano ou addon atualiza automaticamente lista de módulos

**RN-RF117-26: Validação de Acesso pelo RF083**
- RF083 valida acesso consultando assinatura ativa no RF117
- Validação verifica: assinatura ativa + módulo na lista de contratados
- RF083 considera ambiente (Dev/Hom/Prod) + RBAC + assinatura

**RN-RF117-27: Redirect para Vendas**
- Se usuário tentar acessar módulo não contratado, RF083 redireciona para página de vendas
- Página de vendas consulta RF117 e mostra planos que incluem aquele módulo
- Cliente pode solicitar upgrade diretamente da página de vendas

**RN-RF117-28: Liberação Automática de Módulos**
- Upgrade de plano no RF117 libera automaticamente novos módulos no RF083
- Liberação é imediata após confirmação de pagamento (para upgrade)
- Downgrade remove módulos apenas na data de efetivação (próxima renovação)

---

## 3. Requisitos Não Funcionais

### 3.1. Desempenho
- Validação de assinatura ativa deve responder em < 200ms
- Cálculo pro-rata deve ser executado em < 500ms
- Geração de fatura deve ser processada em < 1 segundo

### 3.2. Segurança
- Dados de pagamento devem ser criptografados (PCI-DSS)
- Acesso a faturas deve ser auditado
- Apenas cliente proprietário ou admin pode visualizar assinatura

### 3.3. Disponibilidade
- Sistema de validação de assinatura deve ter disponibilidade de 99.9%
- Falha na validação não deve bloquear acesso a módulos já validados (cache)

### 3.4. Escalabilidade
- Sistema deve suportar 10.000 assinaturas ativas
- Renovação automática deve processar 1.000 assinaturas/dia
- Notificações devem ser enfileiradas e processadas assincronamente

---

## 4. Casos de Uso Principais

### UC-RF117-01: Contratar Plano de Assinatura
**Ator:** Cliente
**Objetivo:** Assinar um plano comercial para obter acesso aos módulos

**Fluxo Principal:**
1. Cliente acessa catálogo de planos
2. Sistema exibe planos disponíveis com preços e módulos inclusos
3. Cliente seleciona plano desejado
4. Sistema solicita confirmação e forma de pagamento
5. Cliente confirma contratação
6. Sistema cria assinatura com status `ativo` (ou `trial` se aplicável)
7. Sistema envia email de boas-vindas
8. Sistema libera módulos no RF083

---

### UC-RF117-02: Realizar Upgrade de Plano
**Ator:** Cliente
**Objetivo:** Mudar para plano superior com mais módulos

**Fluxo Principal:**
1. Cliente acessa gestão de assinatura
2. Sistema exibe plano atual e opções de upgrade
3. Cliente seleciona novo plano
4. Sistema calcula valor pro-rata a ser cobrado
5. Sistema solicita confirmação de pagamento
6. Cliente confirma upgrade
7. Sistema efetiva mudança imediatamente
8. Sistema libera novos módulos no RF083
9. Sistema envia email de confirmação

---

### UC-RF117-03: Adicionar Addon
**Ator:** Cliente
**Objetivo:** Contratar módulo extra além do plano base

**Fluxo Principal:**
1. Cliente acessa marketplace de módulos (RF083)
2. Cliente seleciona módulo não incluído no plano
3. Sistema oferece addon do módulo com preço
4. Cliente confirma contratação do addon
5. Sistema registra addon na assinatura
6. Sistema libera módulo no RF083
7. Sistema envia email de confirmação

---

## 5. Integrações

### 5.1. RF083 - Central de Módulos
- **Consulta:** RF117 consulta lista de módulos disponíveis
- **Validação:** RF083 valida acesso consultando assinatura ativa no RF117
- **Liberação:** RF117 notifica RF083 sobre módulos contratados

### 5.2. RF026 - Gestão de Faturas (Opcional)
- **Integração:** RF117 pode integrar com RF026 para emissão de faturas
- **Sincronização:** Pagamento em RF026 atualiza status de fatura no RF117

### 5.3. Sistema de Notificações
- **Email:** Envio de emails transacionais sobre eventos da assinatura
- **Fila:** Notificações são enfileiradas e processadas assincronamente

---

## 6. Modelo de Dados (Resumo)

### Tabelas Principais

#### PlanoAssinatura
- id, codigo, nome, descricao
- preco_mensal, preco_anual, moeda
- modulos_inclusos_json
- limite_usuarios, limite_clientes
- categoria_plano, ativo, disponivel_para_venda

#### Assinatura
- id, cliente_id, plano_id
- data_inicio, data_vencimento, data_cancelamento
- status, motivo_cancelamento
- forma_pagamento, renovacao_automatica, desconto_aplicado
- ciclo_faturamento, proximo_faturamento_em, dias_periodo_graca

#### AddonAssinatura
- id, assinatura_id, modulo_id
- tipo, preco_adicional
- data_inicio, data_fim, renovacao_automatica

#### HistoricoMudancaPlano
- id, assinatura_id
- plano_anterior_id, plano_novo_id, tipo_mudanca
- data_solicitacao, data_efetivacao, valor_ajuste
- usuario_solicitante_id

#### HistoricoFaturamento
- id, assinatura_id
- data_emissao, data_vencimento, data_pagamento
- valor_plano, valor_addons, valor_desconto, valor_total
- status, metodo_pagamento, nota_fiscal_id

---

## 7. Regras de Negócio (Índice)

| ID | Descrição | Seção |
|----|-----------|-------|
| RN-RF117-01 | Estrutura de Plano | 2.1 |
| RN-RF117-02 | Status do Plano | 2.1 |
| RN-RF117-03 | Categorização | 2.1 |
| RN-RF117-04 | Assinatura Ativa | 2.2 |
| RN-RF117-05 | Status da Assinatura | 2.2 |
| RN-RF117-06 | Renovação Automática | 2.2 |
| RN-RF117-07 | Tipos de Addon | 2.3 |
| RN-RF117-08 | Renovação de Addon | 2.3 |
| RN-RF117-09 | Preço de Addon | 2.3 |
| RN-RF117-10 | Upgrade Imediato | 2.4 |
| RN-RF117-11 | Downgrade Agendado | 2.4 |
| RN-RF117-12 | Cálculo Pro-Rata | 2.4 |
| RN-RF117-13 | Notificação de Mudança | 2.4 |
| RN-RF117-14 | Ciclos de Faturamento | 2.5 |
| RN-RF117-15 | Notificações de Vencimento | 2.5 |
| RN-RF117-16 | Período de Graça | 2.5 |
| RN-RF117-17 | Reativação | 2.5 |
| RN-RF117-18 | Geração Automática de Fatura | 2.6 |
| RN-RF117-19 | Status de Fatura | 2.6 |
| RN-RF117-20 | Integração com RF026 | 2.6 |
| RN-RF117-21 | Eventos de Notificação | 2.7 |
| RN-RF117-22 | Canal de Notificação | 2.7 |
| RN-RF117-23 | Template de Email | 2.7 |
| RN-RF117-24 | Consulta de Módulos Disponíveis | 2.8 |
| RN-RF117-25 | Registro de Módulos Contratados | 2.8 |
| RN-RF117-26 | Validação de Acesso pelo RF083 | 2.8 |
| RN-RF117-27 | Redirect para Vendas | 2.8 |
| RN-RF117-28 | Liberação Automática de Módulos | 2.8 |

---

## 8. Glossário

| Termo | Definição |
|-------|-----------|
| **Assinatura** | Contrato comercial entre cliente e sistema para uso de módulos |
| **Plano** | Conjunto de módulos com preço definido (Básico, Premium, Enterprise) |
| **Addon** | Módulo extra contratado além do plano base |
| **Upgrade** | Mudança para plano superior com mais módulos |
| **Downgrade** | Mudança para plano inferior com menos módulos |
| **Pro-rata** | Cálculo proporcional de valor por dias restantes no ciclo |
| **Período de Graça** | Período após vencimento onde acesso é mantido com alertas |
| **Renovação Automática** | Cobrança automática ao fim do ciclo sem ação do cliente |
| **Trial** | Período de teste gratuito ou com restrições |
| **Ciclo de Faturamento** | Periodicidade de cobrança (mensal, trimestral, semestral, anual) |

---

## 9. Próximos Passos

1. Validar modelo de dados com time de arquitetura
2. Definir API REST para integração com RF083
3. Criar casos de uso detalhados (UC-RF117.md)
4. Definir casos de teste (TC-RF117.yaml)
5. Especificar massa de testes (MT-RF117.data.ts)
6. Implementar backend (Commands/Queries/Handlers)
7. Implementar frontend (páginas de assinatura, upgrade, addons)
8. Implementar testes E2E

---

**Elaborado por:** Time de Arquitetura IControlIT
**Aprovado por:** [Pendente]
**Data de Criação:** 2026-01-14
**Última Revisão:** 2026-01-14
