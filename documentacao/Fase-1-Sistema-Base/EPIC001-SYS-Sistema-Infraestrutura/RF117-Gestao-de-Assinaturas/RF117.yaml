id: RF-117
versao: "1.0"
metadata:
  titulo: "Gestão de Assinaturas"
  fase: "Fase 1 - Sistema Base"
  epic: "EPIC001-SYS - Sistema e Infraestrutura"
  prioridade: "Alta"
  status: "Em Especificação"
  data_criacao: "2026-01-14"
  data_ultima_revisao: "2026-01-14"
  responsavel: "Time de Arquitetura IControlIT"

objetivo: |
  Gerenciar planos de assinatura comerciais do sistema SaaS, permitindo que clientes assinem planos,
  contratem módulos extras (addons), realizem upgrades/downgrades, e tenham gestão completa de vigência,
  renovação e faturamento recorrente.

escopo:
  inclui:
    - Cadastro de planos de assinatura com módulos inclusos
    - Assinatura de planos por clientes
    - Gestão de addons e módulos extras
    - Upgrade e downgrade de planos com cálculo pro-rata
    - Controle de vigência e renovação automática
    - Período de graça para inadimplência
    - Histórico completo de faturamento
    - Notificações automáticas por email
    - Integração com RF083 para controle de acesso a módulos

  exclui:
    - Integração com gateways de pagamento (implementação futura)
    - Trial gratuito (implementação futura)
    - Relatórios e métricas avançadas (MRR, ARR, Churn)
    - Limites e quotas por plano
    - Cupons e promoções
    - Gestão de cancelamento com ofertas de retenção
    - Pausa temporária de assinatura
    - Multi-moeda e multi-país
    - Self-service completo de gestão
    - White label por plano
    - SLA diferenciado por plano
    - Marketplace de módulos
    - Programa de indicação (referral)

contexto: |
  O IControlIT está migrando para modelo SaaS com assinaturas comerciais. Este RF complementa o RF083
  (Central de Módulos) adicionando camada comercial de planos, faturamento recorrente e gestão de upgrades.

  Diferença entre RF023 e RF117:
  - RF023 (Gestão de Contratos): contratos jurídicos, termos, cláusulas, fornecedores, SLAs
  - RF117 (Gestão de Assinaturas): assinaturas comerciais, planos, módulos, faturamento recorrente

dependencias:
  pre_requisitos:
    - id: RF-083
      nome: "Central de Módulos"
      motivo: "RF117 consulta módulos disponíveis e valida acesso via RF083"

    - id: RF-006
      nome: "Gestão de Clientes"
      motivo: "Assinatura é vinculada a cliente cadastrado"

  integracoes:
    - id: RF-083
      nome: "Central de Módulos"
      tipo: "bidirecional"
      descricao: "RF117 consulta módulos, RF083 valida acesso via assinatura"

    - id: RF-026
      nome: "Gestão de Faturas"
      tipo: "opcional"
      descricao: "RF117 pode integrar com RF026 para emissão de faturas"

atores:
  - nome: "Cliente"
    descricao: "Pessoa jurídica que assina planos e contrata módulos"

  - nome: "Administrador"
    descricao: "Usuário que gerencia planos de assinatura e configurações"

  - nome: "Sistema"
    descricao: "Processos automáticos (renovação, notificações, cálculos)"

funcionalidades:
  - id: "funcionalidade.rf.117.01"
    nome: "Catálogo de Planos de Assinatura"
    descricao: "Cadastrar planos comerciais com módulos inclusos, preços e limites"
    prioridade: "Alta"
    complexidade: "Média"
    user_stories:
      - "Como administrador, quero cadastrar planos de assinatura com diferentes níveis de preço e módulos"
      - "Como cliente, quero visualizar planos disponíveis com preços mensal e anual"
      - "Como administrador, quero descontinuar planos mantendo clientes atuais até renovação"

  - id: "funcionalidade.rf.117.02"
    nome: "Assinatura do Cliente"
    descricao: "Cliente assina plano específico com registro de datas e status"
    prioridade: "Alta"
    complexidade: "Alta"
    user_stories:
      - "Como cliente, quero assinar um plano comercial para obter acesso aos módulos"
      - "Como sistema, devo criar assinatura com status ativo e liberar módulos no RF083"
      - "Como administrador, quero visualizar assinaturas ativas, vencidas e suspensas"

  - id: "funcionalidade.rf.117.03"
    nome: "Addons e Módulos Extras"
    descricao: "Contratar módulos avulsos além do plano base"
    prioridade: "Média"
    complexidade: "Média"
    user_stories:
      - "Como cliente, quero contratar módulos extras além do meu plano base"
      - "Como sistema, devo somar preço de addons ao valor da fatura mensal"
      - "Como cliente, quero testar addon temporário por 30 dias antes de contratar"

  - id: "funcionalidade.rf.117.04"
    nome: "Upgrade e Downgrade de Planos"
    descricao: "Mudar de plano com cálculo pro-rata de crédito/débito"
    prioridade: "Alta"
    complexidade: "Alta"
    user_stories:
      - "Como cliente, quero fazer upgrade imediato para plano superior e obter novos módulos"
      - "Como sistema, devo calcular valor pro-rata ao realizar upgrade"
      - "Como cliente, quero fazer downgrade agendado para próxima renovação"

  - id: "funcionalidade.rf.117.05"
    nome: "Gestão de Vigência e Renovação"
    descricao: "Controlar ciclos de faturamento e período de graça"
    prioridade: "Alta"
    complexidade: "Alta"
    user_stories:
      - "Como cliente, quero renovação automática ativada para não perder acesso"
      - "Como sistema, devo notificar 30, 15, 7 dias antes do vencimento"
      - "Como sistema, devo conceder 7 dias de período de graça após vencimento"

  - id: "funcionalidade.rf.117.06"
    nome: "Histórico de Faturamento"
    descricao: "Registrar todas as cobranças com status de pagamento"
    prioridade: "Alta"
    complexidade: "Média"
    user_stories:
      - "Como sistema, devo gerar fatura automaticamente a cada ciclo de faturamento"
      - "Como cliente, quero visualizar histórico completo de faturas pagas e pendentes"
      - "Como sistema, devo integrar com RF026 se disponível para emissão de notas fiscais"

  - id: "funcionalidade.rf.117.07"
    nome: "Notificações Automáticas"
    descricao: "Enviar emails sobre eventos da assinatura"
    prioridade: "Média"
    complexidade: "Baixa"
    user_stories:
      - "Como cliente, quero receber email de boas-vindas ao assinar plano"
      - "Como cliente, quero ser notificado sobre vencimento iminente da assinatura"
      - "Como cliente, quero receber confirmação ao realizar upgrade com lista de novos módulos"

  - id: "funcionalidade.rf.117.08"
    nome: "Integração com RF083"
    descricao: "Integração bidirecional com Central de Módulos"
    prioridade: "Alta"
    complexidade: "Média"
    user_stories:
      - "Como sistema RF117, devo consultar RF083 para obter lista de módulos disponíveis"
      - "Como sistema RF083, devo validar acesso consultando assinatura ativa no RF117"
      - "Como sistema RF117, devo notificar RF083 ao liberar novos módulos por upgrade"

regras_negocio:
  - id: "RN-RF117-01"
    nome: "Estrutura de Plano"
    descricao: "Todo plano deve ter código único, nome, preços e lista de módulos inclusos"
    severidade: "obrigatoria"

  - id: "RN-RF117-02"
    nome: "Status do Plano"
    descricao: "Plano pode ser ativo, inativo ou descontinuado. Descontinuados não podem ser contratados por novos clientes"
    severidade: "obrigatoria"

  - id: "RN-RF117-03"
    nome: "Categorização"
    descricao: "Planos devem ser categorizados: startup, empresarial, corporativo"
    severidade: "obrigatoria"

  - id: "RN-RF117-04"
    nome: "Assinatura Ativa"
    descricao: "Cliente pode ter apenas 1 assinatura principal ativa por vez"
    severidade: "obrigatoria"

  - id: "RN-RF117-05"
    nome: "Status da Assinatura"
    descricao: "Status válidos: ativo, trial, vencido, suspenso, cancelado"
    severidade: "obrigatoria"

  - id: "RN-RF117-06"
    nome: "Renovação Automática"
    descricao: "Se renovacao_automatica = true, sistema cobra automaticamente na data de vencimento"
    severidade: "obrigatoria"

  - id: "RN-RF117-07"
    nome: "Tipos de Addon"
    descricao: "Addon pode ser: permanente, temporario, cortesia"
    severidade: "obrigatoria"

  - id: "RN-RF117-08"
    nome: "Renovação de Addon"
    descricao: "Addon temporário expira automaticamente na data_fim. Sistema notifica 7 dias antes"
    severidade: "obrigatoria"

  - id: "RN-RF117-09"
    nome: "Preço de Addon"
    descricao: "Preço de addon é somado ao valor da fatura mensal/anual. Cortesia tem preço_adicional = 0"
    severidade: "obrigatoria"

  - id: "RN-RF117-10"
    nome: "Upgrade Imediato"
    descricao: "Upgrade ativa imediatamente com cálculo pro-rata de crédito/débito"
    severidade: "obrigatoria"

  - id: "RN-RF117-11"
    nome: "Downgrade Agendado"
    descricao: "Downgrade é agendado para próxima renovação, não imediato"
    severidade: "obrigatoria"

  - id: "RN-RF117-12"
    nome: "Cálculo Pro-Rata"
    descricao: "Pro-rata é calculado por dias restantes no ciclo"
    severidade: "obrigatoria"

  - id: "RN-RF117-13"
    nome: "Notificação de Mudança"
    descricao: "Sistema notifica sobre mudança de plano incluindo módulos que serão adicionados/removidos"
    severidade: "obrigatoria"

  - id: "RN-RF117-14"
    nome: "Ciclos de Faturamento"
    descricao: "Ciclos válidos: mensal, trimestral, semestral, anual"
    severidade: "obrigatoria"

  - id: "RN-RF117-15"
    nome: "Notificações de Vencimento"
    descricao: "Sistema notifica: 30, 15, 7 dias antes do vencimento"
    severidade: "obrigatoria"

  - id: "RN-RF117-16"
    nome: "Período de Graça"
    descricao: "7 dias de graça após vencimento. Após isso: suspenso. Após 30 dias suspenso: cancelado"
    severidade: "obrigatoria"

  - id: "RN-RF117-17"
    nome: "Reativação"
    descricao: "Cliente pode reativar assinatura suspensa pagando débitos"
    severidade: "obrigatoria"

  - id: "RN-RF117-18"
    nome: "Geração Automática de Fatura"
    descricao: "Sistema gera fatura automaticamente a cada ciclo de faturamento"
    severidade: "obrigatoria"

  - id: "RN-RF117-19"
    nome: "Status de Fatura"
    descricao: "Status válidos: pendente, pago, vencido, cancelado"
    severidade: "obrigatoria"

  - id: "RN-RF117-20"
    nome: "Integração com RF026"
    descricao: "Se RF026 disponível, usar integração. Caso contrário, manter histórico próprio"
    severidade: "condicional"

  - id: "RN-RF117-21"
    nome: "Eventos de Notificação"
    descricao: "Eventos obrigatórios: criação, vencimento, suspensão, upgrade, addon"
    severidade: "obrigatoria"

  - id: "RN-RF117-22"
    nome: "Canal de Notificação"
    descricao: "Email é canal primário. Notificações críticas também aparecem no sistema"
    severidade: "obrigatoria"

  - id: "RN-RF117-23"
    nome: "Template de Email"
    descricao: "Cada evento tem template próprio com branding da empresa"
    severidade: "obrigatoria"

  - id: "RN-RF117-24"
    nome: "Consulta de Módulos Disponíveis"
    descricao: "RF117 consulta RF083 para obter lista de módulos cadastrados"
    severidade: "obrigatoria"

  - id: "RN-RF117-25"
    nome: "Registro de Módulos Contratados"
    descricao: "RF117 mantém lista atualizada de módulos por assinatura (plano base + addons)"
    severidade: "obrigatoria"

  - id: "RN-RF117-26"
    nome: "Validação de Acesso pelo RF083"
    descricao: "RF083 valida: assinatura ativa + módulo na lista de contratados + ambiente + RBAC"
    severidade: "obrigatoria"

  - id: "RN-RF117-27"
    nome: "Redirect para Vendas"
    descricao: "RF083 redireciona para página de vendas mostrando planos que incluem módulo"
    severidade: "obrigatoria"

  - id: "RN-RF117-28"
    nome: "Liberação Automática de Módulos"
    descricao: "Upgrade libera módulos imediatamente. Downgrade remove apenas na efetivação"
    severidade: "obrigatoria"

requisitos_nao_funcionais:
  desempenho:
    - "Validação de assinatura ativa deve responder em < 200ms"
    - "Cálculo pro-rata deve ser executado em < 500ms"
    - "Geração de fatura deve ser processada em < 1 segundo"

  seguranca:
    - "Dados de pagamento devem ser criptografados (PCI-DSS)"
    - "Acesso a faturas deve ser auditado"
    - "Apenas cliente proprietário ou admin pode visualizar assinatura"

  disponibilidade:
    - "Sistema de validação de assinatura deve ter disponibilidade de 99.9%"
    - "Falha na validação não deve bloquear acesso a módulos já validados (cache)"

  escalabilidade:
    - "Sistema deve suportar 10.000 assinaturas ativas"
    - "Renovação automática deve processar 1.000 assinaturas/dia"
    - "Notificações devem ser enfileiradas e processadas assincronamente"

modelo_dados:
  entidades:
    - nome: "PlanoAssinatura"
      descricao: "Plano comercial de assinatura"
      campos_principais:
        - "id, codigo, nome, descricao"
        - "preco_mensal, preco_anual, moeda"
        - "modulos_inclusos_json"
        - "limite_usuarios, limite_clientes"
        - "categoria_plano, ativo, disponivel_para_venda"

    - nome: "Assinatura"
      descricao: "Assinatura do cliente a um plano"
      campos_principais:
        - "id, cliente_id, plano_id"
        - "data_inicio, data_vencimento, data_cancelamento"
        - "status, motivo_cancelamento"
        - "forma_pagamento, renovacao_automatica, desconto_aplicado"
        - "ciclo_faturamento, proximo_faturamento_em, dias_periodo_graca"

    - nome: "AddonAssinatura"
      descricao: "Módulo extra contratado além do plano base"
      campos_principais:
        - "id, assinatura_id, modulo_id"
        - "tipo, preco_adicional"
        - "data_inicio, data_fim, renovacao_automatica"

    - nome: "HistoricoMudancaPlano"
      descricao: "Histórico de upgrades/downgrades"
      campos_principais:
        - "id, assinatura_id"
        - "plano_anterior_id, plano_novo_id, tipo_mudanca"
        - "data_solicitacao, data_efetivacao, valor_ajuste"
        - "usuario_solicitante_id"

    - nome: "HistoricoFaturamento"
      descricao: "Histórico de cobranças da assinatura"
      campos_principais:
        - "id, assinatura_id"
        - "data_emissao, data_vencimento, data_pagamento"
        - "valor_plano, valor_addons, valor_desconto, valor_total"
        - "status, metodo_pagamento, nota_fiscal_id"

casos_uso_principais:
  - id: "UC-RF117-01"
    nome: "Contratar Plano de Assinatura"
    ator: "Cliente"
    objetivo: "Assinar um plano comercial para obter acesso aos módulos"

  - id: "UC-RF117-02"
    nome: "Realizar Upgrade de Plano"
    ator: "Cliente"
    objetivo: "Mudar para plano superior com mais módulos"

  - id: "UC-RF117-03"
    nome: "Adicionar Addon"
    ator: "Cliente"
    objetivo: "Contratar módulo extra além do plano base"

  - id: "UC-RF117-04"
    nome: "Renovar Assinatura"
    ator: "Sistema"
    objetivo: "Processar renovação automática ou manual de assinatura"

  - id: "UC-RF117-05"
    nome: "Suspender Assinatura por Inadimplência"
    ator: "Sistema"
    objetivo: "Bloquear acesso após período de graça sem pagamento"

proximos_passos:
  - "Validar modelo de dados com time de arquitetura"
  - "Definir API REST para integração com RF083"
  - "Criar casos de uso detalhados (UC-RF117.md)"
  - "Definir casos de teste (TC-RF117.yaml)"
  - "Especificar massa de testes (MT-RF117.data.ts)"
  - "Implementar backend (Commands/Queries/Handlers)"
  - "Implementar frontend (páginas de assinatura, upgrade, addons)"
  - "Implementar testes E2E"

glossario:
  - termo: "Assinatura"
    definicao: "Contrato comercial entre cliente e sistema para uso de módulos"

  - termo: "Plano"
    definicao: "Conjunto de módulos com preço definido (Básico, Premium, Enterprise)"

  - termo: "Addon"
    definicao: "Módulo extra contratado além do plano base"

  - termo: "Upgrade"
    definicao: "Mudança para plano superior com mais módulos"

  - termo: "Downgrade"
    definicao: "Mudança para plano inferior com menos módulos"

  - termo: "Pro-rata"
    definicao: "Cálculo proporcional de valor por dias restantes no ciclo"

  - termo: "Período de Graça"
    definicao: "Período após vencimento onde acesso é mantido com alertas"

  - termo: "Renovação Automática"
    definicao: "Cobrança automática ao fim do ciclo sem ação do cliente"

  - termo: "Trial"
    definicao: "Período de teste gratuito ou com restrições"

  - termo: "Ciclo de Faturamento"
    definicao: "Periodicidade de cobrança (mensal, trimestral, semestral, anual)"
