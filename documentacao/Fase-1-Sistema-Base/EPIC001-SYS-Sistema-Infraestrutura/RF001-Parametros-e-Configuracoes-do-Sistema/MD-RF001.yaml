# =============================================
# Modelo de Dados (MD) — RF001
# Versão: 2.0
# Autor: Agência ALC - alc.dev.br
# =============================================

# =============================================
# 1. METADADOS DO DOCUMENTO (OBRIGATÓRIO)
# =============================================
metadata:
  versao: "2.0"
  data: "2026-01-04"
  autor: "Agência ALC - alc.dev.br"

  documentacao_relacionado:
    id: "RF001"
    nome: "Sistema de Parâmetros e Configurações Centralizadas"

  sistema_modulo: "Sistema Base - Infraestrutura"
  banco_de_dados:
    engine: "logico"        # Modelo lógico (independente de engine física)
    schema: "logico"        # Abstração de schema
  padroes:
    multi_tenancy: true
    auditoria: true
    soft_delete: true

# =============================================
# 2. ENTIDADES (OBRIGATÓRIO)
# =============================================
entidades:
  # =============================================
  # ENTIDADE 1: Sistema_Parametro
  # =============================================
  - nome: "sistema_parametro"
    descricao: "Armazena parâmetros configuráveis do sistema com validação tipada, criptografia de dados sensíveis e controle de acesso por tenant"

    campos:
      # CHAVE PRIMÁRIA (OBRIGATÓRIO)
      - nome: "id"
        tipo: "GUID"
        nulo: false
        default: "NEWID()"
        descricao: "Chave primária"
        pk: true

      # MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "cliente_id"
        tipo: "GUID"
        nulo: false
        descricao: "FK para clientes (multi-tenancy)"
        fk:
          tabela: "cliente"
          coluna: "id"
          on_delete: "CASCADE"
        index: true

      # CAMPOS DE NEGÓCIO (derivados do RF/UC/WF)
      - nome: "cd_parametro"
        tipo: "VARCHAR(100)"
        nulo: false
        descricao: "Código único do parâmetro (ex: MAX_LOGIN_ATTEMPTS, SMTP_HOST)"
        unique_por_tenant: true
        index: true
        mutavel: false
        origem:
          documentacao: "RF001"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-001"

      - nome: "nm_parametro"
        tipo: "VARCHAR(200)"
        nulo: false
        descricao: "Nome legível do parâmetro"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-002"

      - nome: "ds_parametro"
        tipo: "TEXT"
        nulo: false
        descricao: "Descrição detalhada do propósito do parâmetro"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-003"

      - nome: "categoria"
        tipo: "VARCHAR(50)"
        nulo: false
        descricao: "Categoria do parâmetro (Sistema, Seguranca, Integracao, Notificacao, Relatorio)"
        index: true
        mutavel: true
        check:
          definicao: "categoria IN ('Sistema','Seguranca','Integracao','Notificacao','Relatorio')"
          descricao: "Categoria válida"
        origem:
          documentacao: "RF001"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-004"

      - nome: "tipo_dado"
        tipo: "VARCHAR(20)"
        nulo: false
        descricao: "Tipo de dado do valor (String, Integer, Decimal, Boolean, Date, JSON)"
        index: true
        mutavel: true
        check:
          definicao: "tipo_dado IN ('String','Integer','Decimal','Boolean','Date','JSON')"
          descricao: "Tipo de dado válido"
        origem:
          documentacao: "RF001"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-005"

      - nome: "vl_string"
        tipo: "TEXT"
        nulo: true
        descricao: "Valor quando tipo_dado = String (pode conter valor criptografado se fl_sensivel = 1)"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-006"

      - nome: "vl_inteiro"
        tipo: "BIGINT"
        nulo: true
        descricao: "Valor quando tipo_dado = Integer"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-006"

      - nome: "vl_decimal"
        tipo: "DECIMAL(18,6)"
        nulo: true
        descricao: "Valor quando tipo_dado = Decimal"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-006"

      - nome: "vl_boolean"
        tipo: "BOOLEAN"
        nulo: true
        descricao: "Valor quando tipo_dado = Boolean"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-006"

      - nome: "vl_data"
        tipo: "DATE"
        nulo: true
        descricao: "Valor quando tipo_dado = Date"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-006"

      - nome: "vl_json"
        tipo: "TEXT"
        nulo: true
        descricao: "Valor quando tipo_dado = JSON (armazenado como texto, validado em aplicação)"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-006"

      - nome: "fl_sensivel"
        tipo: "BOOLEAN"
        nulo: false
        default: false
        descricao: "Indica se valor requer criptografia AES-256 (senhas, API keys, tokens)"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-007"

      - nome: "fl_sistema"
        tipo: "BOOLEAN"
        nulo: false
        default: false
        descricao: "Indica se parâmetro não pode ser editado/excluído via UI (apenas valor editável)"
        index: true
        mutavel: false
        origem:
          documentacao: "RF001"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-008"

      - nome: "fl_obrigatorio"
        tipo: "BOOLEAN"
        nulo: false
        default: false
        descricao: "Indica se valor não pode ser nulo (usar valor_padrao se necessário)"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-009"

      - nome: "regex_validacao"
        tipo: "VARCHAR(500)"
        nulo: true
        descricao: "Regex para validação de valores String (ex: ^[A-Z0-9]+$)"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-010"

      - nome: "valor_minimo"
        tipo: "DECIMAL(18,6)"
        nulo: true
        descricao: "Valor mínimo para Integer/Decimal"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-011"

      - nome: "valor_maximo"
        tipo: "DECIMAL(18,6)"
        nulo: true
        descricao: "Valor máximo para Integer/Decimal"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-012"

      - nome: "opcoes_validas"
        tipo: "TEXT"
        nulo: true
        descricao: "Lista de opções válidas (JSON array, ex: [\"opcao1\",\"opcao2\"])"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-013"

      - nome: "valor_padrao"
        tipo: "TEXT"
        nulo: true
        descricao: "Valor padrão para parâmetros obrigatórios (representação em string)"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-014"

      # AUDITORIA (OBRIGATÓRIO - 5 campos)
      - nome: "created_at"
        tipo: "DATETIME"
        nulo: true
        default: "GETDATE()"
        descricao: "Data de criação"
        audit: true
        mutavel: false
        origem:
          documentacao: "RF001"
          uc: "UC01"
          wf: null
          campo_wf: null
          observacao: "Campo gerado automaticamente pelo sistema"

      - nome: "created_by"
        tipo: "GUID"
        nulo: true
        default: null
        descricao: "Usuário que criou"
        audit: true
        mutavel: false
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "SET NULL"
        origem:
          documentacao: "RF001"
          uc: "UC01"
          wf: null
          campo_wf: null
          observacao: "Preenchido automaticamente com ID do usuário autenticado"

      - nome: "updated_at"
        tipo: "DATETIME"
        nulo: true
        default: null
        descricao: "Data de atualização"
        audit: true
        mutavel: false
        origem:
          documentacao: "RF001"
          uc: "UC03"
          wf: null
          campo_wf: null
          observacao: "Campo gerado automaticamente pelo sistema"

      - nome: "updated_by"
        tipo: "GUID"
        nulo: true
        default: null
        descricao: "Usuário que atualizou"
        audit: true
        mutavel: false
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "SET NULL"
        origem:
          documentacao: "RF001"
          uc: "UC03"
          wf: null
          campo_wf: null
          observacao: "Preenchido automaticamente com ID do usuário autenticado"

      # SOFT DELETE (OBRIGATÓRIO)
      - nome: "deleted_at"
        tipo: "DATETIME"
        nulo: true
        default: null
        descricao: "Soft delete"
        audit: true
        mutavel: false
        origem:
          documentacao: "RF001"
          uc: "UC04"
          wf: null
          campo_wf: null
          observacao: "Preenchido automaticamente ao excluir (soft delete)"

    indices:
      # ÍNDICE PRIMÁRIO (OBRIGATÓRIO)
      - nome: "pk_sistema_parametro"
        tipo: "PRIMARY"
        colunas: ["id"]
        descricao: "Chave primária"

      # ÍNDICE MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "idx_sistema_parametro_cliente"
        tipo: "BTREE"
        colunas: ["cliente_id"]
        descricao: "Performance multi-tenant (filtragem por tenant)"

      # ÍNDICES DE PERFORMANCE (conforme WF - filtros/buscas)
      - nome: "idx_sistema_parametro_categoria"
        tipo: "BTREE"
        colunas: ["categoria"]
        descricao: "Performance em filtros por categoria (WF-01, CMP-WF01-003)"

      - nome: "idx_sistema_parametro_tipo_dado"
        tipo: "BTREE"
        colunas: ["tipo_dado"]
        descricao: "Performance em filtros por tipo de dado (WF-01, CMP-WF01-004)"

      - nome: "idx_sistema_parametro_fl_sistema"
        tipo: "BTREE"
        colunas: ["fl_sistema"]
        descricao: "Performance em filtros de parâmetros de sistema (WF-01, CMP-WF01-005)"

      - nome: "idx_sistema_parametro_cd_parametro"
        tipo: "BTREE"
        colunas: ["cd_parametro"]
        descricao: "Performance em buscas por código (WF-01, CMP-WF01-002)"

    constraints:
      # FK MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "fk_sistema_parametro_cliente"
        tipo: "FOREIGN KEY"
        definicao: "cliente_id REFERENCES cliente(id)"
        on_delete: "CASCADE"
        descricao: "Multi-tenancy - parâmetro pertence a um cliente"

      # UNIQUE POR TENANT (RN-SYS-001-01)
      - nome: "uq_sistema_parametro_cliente_codigo"
        tipo: "UNIQUE"
        definicao: "(cliente_id, cd_parametro)"
        descricao: "Código de parâmetro único por tenant (RN-SYS-001-01)"

      # FKs DE AUDITORIA (OBRIGATÓRIO)
      - nome: "fk_sistema_parametro_created_by"
        tipo: "FOREIGN KEY"
        definicao: "created_by REFERENCES usuario(id)"
        on_delete: "SET NULL"
        descricao: "Auditoria - usuário criador"

      - nome: "fk_sistema_parametro_updated_by"
        tipo: "FOREIGN KEY"
        definicao: "updated_by REFERENCES usuario(id)"
        on_delete: "SET NULL"
        descricao: "Auditoria - usuário que atualizou"

      # CHECK (validação de categoria)
      - nome: "chk_sistema_parametro_categoria"
        tipo: "CHECK"
        definicao: "categoria IN ('Sistema','Seguranca','Integracao','Notificacao','Relatorio')"
        descricao: "Categoria válida"

      # CHECK (validação de tipo_dado)
      - nome: "chk_sistema_parametro_tipo_dado"
        tipo: "CHECK"
        definicao: "tipo_dado IN ('String','Integer','Decimal','Boolean','Date','JSON')"
        descricao: "Tipo de dado válido"

  # =============================================
  # ENTIDADE 2: Sistema_Feature_Flag
  # =============================================
  - nome: "sistema_feature_flag"
    descricao: "Controla ativação/desativação de funcionalidades com rollout gradual por percentual, lista de usuários ou período"

    campos:
      # CHAVE PRIMÁRIA (OBRIGATÓRIO)
      - nome: "id"
        tipo: "GUID"
        nulo: false
        default: "NEWID()"
        descricao: "Chave primária"
        pk: true

      # MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "cliente_id"
        tipo: "GUID"
        nulo: true
        descricao: "FK para clientes (NULL = flag global, valor = flag específica por tenant)"
        fk:
          tabela: "cliente"
          coluna: "id"
          on_delete: "CASCADE"
        index: true

      # CAMPOS DE NEGÓCIO
      - nome: "cd_feature"
        tipo: "VARCHAR(100)"
        nulo: false
        descricao: "Código único da feature flag (ex: FEATURE_DARK_MODE, FEATURE_BULK_IMPORT)"
        unique_por_tenant: true
        index: true
        mutavel: false
        origem:
          documentacao: "RF001"
          uc: "UC06"
          wf: "WF-07"
          campo_wf: "CMP-WF07-001"

      - nome: "nm_feature"
        tipo: "VARCHAR(200)"
        nulo: false
        descricao: "Nome legível da feature"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC06"
          wf: "WF-07"
          campo_wf: "CMP-WF07-002"

      - nome: "ds_feature"
        tipo: "TEXT"
        nulo: false
        descricao: "Descrição detalhada da feature"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC06"
          wf: "WF-07"
          campo_wf: "CMP-WF07-003"

      - nome: "fl_ativa"
        tipo: "BOOLEAN"
        nulo: false
        default: false
        descricao: "Indica se feature está ativa (ON/OFF)"
        index: true
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC06"
          wf: "WF-07"
          campo_wf: "CMP-WF07-004"

      - nome: "tipo_rollout"
        tipo: "VARCHAR(20)"
        nulo: false
        default: "All"
        descricao: "Tipo de rollout (All, Percentage, UserList, DateRange)"
        mutavel: true
        check:
          definicao: "tipo_rollout IN ('All','Percentage','UserList','DateRange')"
          descricao: "Tipo de rollout válido"
        origem:
          documentacao: "RF001"
          uc: "UC06"
          wf: "WF-07"
          campo_wf: "CMP-WF07-005"

      - nome: "percentual_rollout"
        tipo: "INTEGER"
        nulo: true
        descricao: "Percentual de usuários (0-100) quando tipo_rollout = Percentage"
        mutavel: true
        check:
          definicao: "percentual_rollout BETWEEN 0 AND 100"
          descricao: "Percentual válido (0-100)"
        origem:
          documentacao: "RF001"
          uc: "UC06"
          wf: "WF-07"
          campo_wf: "CMP-WF07-006"

      - nome: "lista_usuarios"
        tipo: "TEXT"
        nulo: true
        descricao: "IDs de usuários separados por vírgula quando tipo_rollout = UserList"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC06"
          wf: "WF-07"
          campo_wf: "CMP-WF07-007"

      - nome: "data_inicio"
        tipo: "DATE"
        nulo: true
        descricao: "Data de início quando tipo_rollout = DateRange"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC06"
          wf: "WF-07"
          campo_wf: "CMP-WF07-008"

      - nome: "data_fim"
        tipo: "DATE"
        nulo: true
        descricao: "Data de fim quando tipo_rollout = DateRange"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC06"
          wf: "WF-07"
          campo_wf: "CMP-WF07-009"

      # AUDITORIA (OBRIGATÓRIO)
      - nome: "created_at"
        tipo: "DATETIME"
        nulo: true
        default: "GETDATE()"
        descricao: "Data de criação"
        audit: true
        mutavel: false

      - nome: "created_by"
        tipo: "GUID"
        nulo: true
        descricao: "Usuário que criou"
        audit: true
        mutavel: false
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "SET NULL"

      - nome: "updated_at"
        tipo: "DATETIME"
        nulo: true
        descricao: "Data de atualização"
        audit: true
        mutavel: false

      - nome: "updated_by"
        tipo: "GUID"
        nulo: true
        descricao: "Usuário que atualizou"
        audit: true
        mutavel: false
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "SET NULL"

      # SOFT DELETE (OBRIGATÓRIO)
      - nome: "deleted_at"
        tipo: "DATETIME"
        nulo: true
        descricao: "Soft delete"
        audit: true
        mutavel: false

    indices:
      - nome: "pk_sistema_feature_flag"
        tipo: "PRIMARY"
        colunas: ["id"]
        descricao: "Chave primária"

      - nome: "idx_sistema_feature_flag_cliente"
        tipo: "BTREE"
        colunas: ["cliente_id"]
        descricao: "Performance multi-tenant"

      - nome: "idx_sistema_feature_flag_fl_ativa"
        tipo: "BTREE"
        colunas: ["fl_ativa"]
        descricao: "Performance em filtros por status (WF-06)"

      - nome: "idx_sistema_feature_flag_cd_feature"
        tipo: "BTREE"
        colunas: ["cd_feature"]
        descricao: "Performance em buscas por código (WF-06)"

    constraints:
      - nome: "fk_sistema_feature_flag_cliente"
        tipo: "FOREIGN KEY"
        definicao: "cliente_id REFERENCES cliente(id)"
        on_delete: "CASCADE"
        descricao: "Multi-tenancy (NULL = flag global)"

      - nome: "uq_sistema_feature_flag_cliente_codigo"
        tipo: "UNIQUE"
        definicao: "(COALESCE(cliente_id, '00000000-0000-0000-0000-000000000000'), cd_feature)"
        descricao: "Código de feature único por tenant (RN-SYS-001-08)"

      - nome: "fk_sistema_feature_flag_created_by"
        tipo: "FOREIGN KEY"
        definicao: "created_by REFERENCES usuario(id)"
        on_delete: "SET NULL"
        descricao: "Auditoria - criador"

      - nome: "fk_sistema_feature_flag_updated_by"
        tipo: "FOREIGN KEY"
        definicao: "updated_by REFERENCES usuario(id)"
        on_delete: "SET NULL"
        descricao: "Auditoria - editor"

      - nome: "chk_sistema_feature_flag_tipo_rollout"
        tipo: "CHECK"
        definicao: "tipo_rollout IN ('All','Percentage','UserList','DateRange')"
        descricao: "Tipo de rollout válido"

      - nome: "chk_sistema_feature_flag_percentual"
        tipo: "CHECK"
        definicao: "percentual_rollout IS NULL OR (percentual_rollout BETWEEN 0 AND 100)"
        descricao: "Percentual válido (0-100)"

  # =============================================
  # ENTIDADE 3: Sistema_Configuracao_Email
  # =============================================
  - nome: "sistema_configuracao_email"
    descricao: "Armazena credenciais e configurações de provedores de email (SMTP, SendGrid, AWS SES) com senha criptografada"

    campos:
      # CHAVE PRIMÁRIA (OBRIGATÓRIO)
      - nome: "id"
        tipo: "GUID"
        nulo: false
        default: "NEWID()"
        descricao: "Chave primária"
        pk: true

      # MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "cliente_id"
        tipo: "GUID"
        nulo: false
        descricao: "FK para clientes (multi-tenancy)"
        fk:
          tabela: "cliente"
          coluna: "id"
          on_delete: "CASCADE"
        index: true

      # CAMPOS DE NEGÓCIO
      - nome: "provedor"
        tipo: "VARCHAR(20)"
        nulo: false
        descricao: "Provedor de email (SMTP, SendGrid, AWS_SES)"
        index: true
        mutavel: true
        check:
          definicao: "provedor IN ('SMTP','SendGrid','AWS_SES')"
          descricao: "Provedor válido"
        origem:
          documentacao: "RF001"
          uc: "UC11"
          wf: "WF-12"
          campo_wf: "CMP-WF12-001"

      - nome: "servidor_smtp"
        tipo: "VARCHAR(200)"
        nulo: true
        descricao: "Servidor SMTP (obrigatório se provedor = SMTP)"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC11"
          wf: "WF-12"
          campo_wf: "CMP-WF12-002"

      - nome: "porta_smtp"
        tipo: "INTEGER"
        nulo: true
        descricao: "Porta SMTP (1-65535, obrigatório se provedor = SMTP)"
        mutavel: true
        check:
          definicao: "porta_smtp IS NULL OR (porta_smtp BETWEEN 1 AND 65535)"
          descricao: "Porta válida (1-65535)"
        origem:
          documentacao: "RF001"
          uc: "UC11"
          wf: "WF-12"
          campo_wf: "CMP-WF12-003"

      - nome: "usuario"
        tipo: "VARCHAR(200)"
        nulo: false
        descricao: "Usuário de autenticação"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC11"
          wf: "WF-12"
          campo_wf: "CMP-WF12-004"

      - nome: "senha"
        tipo: "TEXT"
        nulo: false
        descricao: "Senha criptografada AES-256"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC11"
          wf: "WF-12"
          campo_wf: "CMP-WF12-005"

      - nome: "fl_usar_ssl"
        tipo: "BOOLEAN"
        nulo: false
        default: true
        descricao: "Indica se deve usar SSL/TLS"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC11"
          wf: "WF-12"
          campo_wf: "CMP-WF12-006"

      - nome: "email_remetente"
        tipo: "VARCHAR(200)"
        nulo: false
        descricao: "E-mail remetente padrão"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC11"
          wf: "WF-12"
          campo_wf: "CMP-WF12-007"

      - nome: "nome_remetente"
        tipo: "VARCHAR(200)"
        nulo: false
        descricao: "Nome remetente padrão"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC11"
          wf: "WF-12"
          campo_wf: "CMP-WF12-008"

      - nome: "fl_principal"
        tipo: "BOOLEAN"
        nulo: false
        default: false
        descricao: "Indica se é configuração principal do tenant (apenas uma por tenant)"
        index: true
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC11"
          wf: "WF-12"
          campo_wf: "CMP-WF12-009"

      # AUDITORIA (OBRIGATÓRIO)
      - nome: "created_at"
        tipo: "DATETIME"
        nulo: true
        default: "GETDATE()"
        descricao: "Data de criação"
        audit: true
        mutavel: false

      - nome: "created_by"
        tipo: "GUID"
        nulo: true
        descricao: "Usuário que criou"
        audit: true
        mutavel: false
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "SET NULL"

      - nome: "updated_at"
        tipo: "DATETIME"
        nulo: true
        descricao: "Data de atualização"
        audit: true
        mutavel: false

      - nome: "updated_by"
        tipo: "GUID"
        nulo: true
        descricao: "Usuário que atualizou"
        audit: true
        mutavel: false
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "SET NULL"

      # SOFT DELETE (OBRIGATÓRIO)
      - nome: "deleted_at"
        tipo: "DATETIME"
        nulo: true
        descricao: "Soft delete"
        audit: true
        mutavel: false

    indices:
      - nome: "pk_sistema_configuracao_email"
        tipo: "PRIMARY"
        colunas: ["id"]
        descricao: "Chave primária"

      - nome: "idx_sistema_configuracao_email_cliente"
        tipo: "BTREE"
        colunas: ["cliente_id"]
        descricao: "Performance multi-tenant"

      - nome: "idx_sistema_configuracao_email_provedor"
        tipo: "BTREE"
        colunas: ["provedor"]
        descricao: "Performance em filtros por provedor (WF-11)"

      - nome: "idx_sistema_configuracao_email_fl_principal"
        tipo: "BTREE"
        colunas: ["fl_principal"]
        descricao: "Performance em filtros de configuração principal (WF-11)"

    constraints:
      - nome: "fk_sistema_configuracao_email_cliente"
        tipo: "FOREIGN KEY"
        definicao: "cliente_id REFERENCES cliente(id)"
        on_delete: "CASCADE"
        descricao: "Multi-tenancy"

      - nome: "fk_sistema_configuracao_email_created_by"
        tipo: "FOREIGN KEY"
        definicao: "created_by REFERENCES usuario(id)"
        on_delete: "SET NULL"
        descricao: "Auditoria - criador"

      - nome: "fk_sistema_configuracao_email_updated_by"
        tipo: "FOREIGN KEY"
        definicao: "updated_by REFERENCES usuario(id)"
        on_delete: "SET NULL"
        descricao: "Auditoria - editor"

      - nome: "chk_sistema_configuracao_email_provedor"
        tipo: "CHECK"
        definicao: "provedor IN ('SMTP','SendGrid','AWS_SES')"
        descricao: "Provedor válido"

      - nome: "chk_sistema_configuracao_email_porta"
        tipo: "CHECK"
        definicao: "porta_smtp IS NULL OR (porta_smtp BETWEEN 1 AND 65535)"
        descricao: "Porta SMTP válida"

  # =============================================
  # ENTIDADE 4: Sistema_Limite_Uso
  # =============================================
  - nome: "sistema_limite_uso"
    descricao: "Define limites de uso por tenant (usuários, ativos, storage, API calls) com alertas automáticos"

    campos:
      # CHAVE PRIMÁRIA (OBRIGATÓRIO)
      - nome: "id"
        tipo: "GUID"
        nulo: false
        default: "NEWID()"
        descricao: "Chave primária"
        pk: true

      # MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "cliente_id"
        tipo: "GUID"
        nulo: false
        descricao: "FK para clientes (multi-tenancy)"
        fk:
          tabela: "cliente"
          coluna: "id"
          on_delete: "CASCADE"
        index: true

      # CAMPOS DE NEGÓCIO
      - nome: "tipo_limite"
        tipo: "VARCHAR(50)"
        nulo: false
        descricao: "Tipo de limite (MAX_USUARIOS, MAX_ATIVOS, MAX_STORAGE_MB, MAX_API_CALLS_DIA)"
        unique_por_tenant: true
        index: true
        mutavel: false
        check:
          definicao: "tipo_limite IN ('MAX_USUARIOS','MAX_ATIVOS','MAX_STORAGE_MB','MAX_API_CALLS_DIA')"
          descricao: "Tipo de limite válido"
        origem:
          documentacao: "RF001"
          uc: "UC16"
          wf: "WF-17"
          campo_wf: "CMP-WF17-001"

      - nome: "limite"
        tipo: "BIGINT"
        nulo: false
        descricao: "Valor máximo permitido"
        mutavel: true
        check:
          definicao: "limite > 0"
          descricao: "Limite deve ser maior que zero"
        origem:
          documentacao: "RF001"
          uc: "UC16"
          wf: "WF-17"
          campo_wf: "CMP-WF17-002"

      - nome: "uso_atual"
        tipo: "BIGINT"
        nulo: false
        default: 0
        descricao: "Valor atual de uso (atualizado por jobs ou eventos)"
        mutavel: true
        check:
          definicao: "uso_atual >= 0"
          descricao: "Uso atual não pode ser negativo"
        origem:
          documentacao: "RF001"
          uc: "UC16"
          wf: "WF-17"
          campo_wf: "CMP-WF17-003"

      - nome: "percentual_alerta"
        tipo: "INTEGER"
        nulo: false
        default: 80
        descricao: "Percentual para envio de alerta (ex: 80 = alerta ao atingir 80% do limite)"
        mutavel: true
        check:
          definicao: "percentual_alerta BETWEEN 0 AND 100"
          descricao: "Percentual válido (0-100)"
        origem:
          documentacao: "RF001"
          uc: "UC16"
          wf: "WF-17"
          campo_wf: "CMP-WF17-004"

      - nome: "fl_alerta_enviado"
        tipo: "BOOLEAN"
        nulo: false
        default: false
        descricao: "Indica se alerta já foi enviado (resetar com hysteresis ao cair abaixo de percentual_alerta - 10%)"
        mutavel: true
        origem:
          documentacao: "RF001"
          uc: "UC20"
          wf: "WF-21"
          campo_wf: null

      # AUDITORIA (OBRIGATÓRIO)
      - nome: "created_at"
        tipo: "DATETIME"
        nulo: true
        default: "GETDATE()"
        descricao: "Data de criação"
        audit: true
        mutavel: false

      - nome: "created_by"
        tipo: "GUID"
        nulo: true
        descricao: "Usuário que criou"
        audit: true
        mutavel: false
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "SET NULL"

      - nome: "updated_at"
        tipo: "DATETIME"
        nulo: true
        descricao: "Data de atualização"
        audit: true
        mutavel: false

      - nome: "updated_by"
        tipo: "GUID"
        nulo: true
        descricao: "Usuário que atualizou"
        audit: true
        mutavel: false
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "SET NULL"

      # SOFT DELETE (OBRIGATÓRIO)
      - nome: "deleted_at"
        tipo: "DATETIME"
        nulo: true
        descricao: "Soft delete"
        audit: true
        mutavel: false

    indices:
      - nome: "pk_sistema_limite_uso"
        tipo: "PRIMARY"
        colunas: ["id"]
        descricao: "Chave primária"

      - nome: "idx_sistema_limite_uso_cliente"
        tipo: "BTREE"
        colunas: ["cliente_id"]
        descricao: "Performance multi-tenant"

      - nome: "idx_sistema_limite_uso_tipo_limite"
        tipo: "BTREE"
        colunas: ["tipo_limite"]
        descricao: "Performance em filtros por tipo (WF-16)"

      - nome: "idx_sistema_limite_uso_fl_alerta"
        tipo: "BTREE"
        colunas: ["fl_alerta_enviado"]
        descricao: "Performance em job de verificação de alertas (UC20)"

    constraints:
      - nome: "fk_sistema_limite_uso_cliente"
        tipo: "FOREIGN KEY"
        definicao: "cliente_id REFERENCES cliente(id)"
        on_delete: "CASCADE"
        descricao: "Multi-tenancy"

      - nome: "uq_sistema_limite_uso_cliente_tipo"
        tipo: "UNIQUE"
        definicao: "(cliente_id, tipo_limite)"
        descricao: "Tipo de limite único por tenant (RN-SYS-001-12)"

      - nome: "fk_sistema_limite_uso_created_by"
        tipo: "FOREIGN KEY"
        definicao: "created_by REFERENCES usuario(id)"
        on_delete: "SET NULL"
        descricao: "Auditoria - criador"

      - nome: "fk_sistema_limite_uso_updated_by"
        tipo: "FOREIGN KEY"
        definicao: "updated_by REFERENCES usuario(id)"
        on_delete: "SET NULL"
        descricao: "Auditoria - editor"

      - nome: "chk_sistema_limite_uso_tipo"
        tipo: "CHECK"
        definicao: "tipo_limite IN ('MAX_USUARIOS','MAX_ATIVOS','MAX_STORAGE_MB','MAX_API_CALLS_DIA')"
        descricao: "Tipo de limite válido"

      - nome: "chk_sistema_limite_uso_limite_positivo"
        tipo: "CHECK"
        definicao: "limite > 0"
        descricao: "Limite deve ser maior que zero"

      - nome: "chk_sistema_limite_uso_uso_positivo"
        tipo: "CHECK"
        definicao: "uso_atual >= 0"
        descricao: "Uso atual não pode ser negativo"

      - nome: "chk_sistema_limite_uso_percentual"
        tipo: "CHECK"
        definicao: "percentual_alerta BETWEEN 0 AND 100"
        descricao: "Percentual válido"

  # =============================================
  # ENTIDADE 5: Sistema_Parametro_Historico
  # =============================================
  - nome: "sistema_parametro_historico"
    descricao: "Registra TODAS as operações em Sistema_Parametro (CREATE, UPDATE, DELETE, ACCESS) com diff JSON e retenção de 7 anos"

    campos:
      # CHAVE PRIMÁRIA (OBRIGATÓRIO)
      - nome: "id"
        tipo: "GUID"
        nulo: false
        default: "NEWID()"
        descricao: "Chave primária"
        pk: true

      # MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "cliente_id"
        tipo: "GUID"
        nulo: false
        descricao: "FK para clientes (multi-tenancy)"
        fk:
          tabela: "cliente"
          coluna: "id"
          on_delete: "CASCADE"
        index: true

      # CAMPOS DE NEGÓCIO
      - nome: "id_parametro"
        tipo: "GUID"
        nulo: false
        descricao: "FK para sistema_parametro (SET NULL desabilitado - preservar histórico)"
        index: true
        mutavel: false
        origem:
          documentacao: "RF001"
          uc: "UC01, UC02, UC03, UC04"
          wf: "WF-03"
          campo_wf: "CMP-WF03-014"

      - nome: "tipo_operacao"
        tipo: "VARCHAR(20)"
        nulo: false
        descricao: "Tipo de operação (CREATE, UPDATE, DELETE, ACCESS)"
        index: true
        mutavel: false
        check:
          definicao: "tipo_operacao IN ('CREATE','UPDATE','DELETE','ACCESS')"
          descricao: "Tipo de operação válido"
        origem:
          documentacao: "RF001"
          uc: "UC01, UC02, UC03, UC04"
          wf: "WF-03"
          campo_wf: "CMP-WF03-014"

      - nome: "valor_anterior"
        tipo: "TEXT"
        nulo: true
        descricao: "JSON completo do registro antes da alteração (NULL para CREATE, JSON para UPDATE/DELETE)"
        mutavel: false
        origem:
          documentacao: "RF001"
          uc: "UC03, UC04"
          wf: "WF-03"
          campo_wf: "CMP-WF03-014"

      - nome: "valor_novo"
        tipo: "TEXT"
        nulo: true
        descricao: "JSON completo do registro após alteração (JSON para CREATE/UPDATE, NULL para DELETE)"
        mutavel: false
        origem:
          documentacao: "RF001"
          uc: "UC01, UC03"
          wf: "WF-03"
          campo_wf: "CMP-WF03-014"

      - nome: "diff_json"
        tipo: "TEXT"
        nulo: true
        descricao: "Diff JSON (apenas campos alterados) para tipo UPDATE"
        mutavel: false
        origem:
          documentacao: "RF001"
          uc: "UC03"
          wf: "WF-03"
          campo_wf: "CMP-WF03-014"

      - nome: "id_usuario"
        tipo: "GUID"
        nulo: true
        descricao: "Usuário que realizou a operação"
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "SET NULL"
        index: true
        mutavel: false

      - nome: "dt_alteracao"
        tipo: "DATETIME"
        nulo: false
        default: "GETDATE()"
        descricao: "Data/hora da operação"
        index: true
        mutavel: false

      - nome: "ip_usuario"
        tipo: "VARCHAR(45)"
        nulo: true
        descricao: "IP do usuário (IPv4 ou IPv6)"
        mutavel: false

      - nome: "user_agent"
        tipo: "TEXT"
        nulo: true
        descricao: "User-Agent do navegador/aplicação"
        mutavel: false

      # AUDITORIA (OBRIGATÓRIO - mesmo em tabela de histórico)
      - nome: "created_at"
        tipo: "DATETIME"
        nulo: true
        default: "GETDATE()"
        descricao: "Data de criação do registro de histórico"
        audit: true
        mutavel: false

      - nome: "created_by"
        tipo: "GUID"
        nulo: true
        descricao: "Usuário que criou o registro de histórico (mesm que id_usuario)"
        audit: true
        mutavel: false
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "SET NULL"

      - nome: "updated_at"
        tipo: "DATETIME"
        nulo: true
        descricao: "Não aplicável (histórico imutável)"
        audit: true
        mutavel: false

      - nome: "updated_by"
        tipo: "GUID"
        nulo: true
        descricao: "Não aplicável (histórico imutável)"
        audit: true
        mutavel: false
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "SET NULL"

      # SOFT DELETE (OBRIGATÓRIO)
      - nome: "deleted_at"
        tipo: "DATETIME"
        nulo: true
        descricao: "Soft delete (retenção de 7 anos, depois soft delete)"
        audit: true
        mutavel: false

    indices:
      - nome: "pk_sistema_parametro_historico"
        tipo: "PRIMARY"
        colunas: ["id"]
        descricao: "Chave primária"

      - nome: "idx_sistema_parametro_historico_cliente"
        tipo: "BTREE"
        colunas: ["cliente_id"]
        descricao: "Performance multi-tenant"

      - nome: "idx_sistema_parametro_historico_parametro"
        tipo: "BTREE"
        colunas: ["id_parametro"]
        descricao: "Performance em consultas de histórico de parâmetro (WF-03)"

      - nome: "idx_sistema_parametro_historico_dt_alteracao"
        tipo: "BTREE"
        colunas: ["dt_alteracao"]
        descricao: "Performance em ordenação por data (WF-03)"

      - nome: "idx_sistema_parametro_historico_tipo_operacao"
        tipo: "BTREE"
        colunas: ["tipo_operacao"]
        descricao: "Performance em filtros por tipo de operação"

      - nome: "idx_sistema_parametro_historico_usuario"
        tipo: "BTREE"
        colunas: ["id_usuario"]
        descricao: "Performance em filtros por usuário"

    constraints:
      - nome: "fk_sistema_parametro_historico_cliente"
        tipo: "FOREIGN KEY"
        definicao: "cliente_id REFERENCES cliente(id)"
        on_delete: "CASCADE"
        descricao: "Multi-tenancy"

      - nome: "fk_sistema_parametro_historico_usuario"
        tipo: "FOREIGN KEY"
        definicao: "id_usuario REFERENCES usuario(id)"
        on_delete: "SET NULL"
        descricao: "Usuário que realizou operação"

      - nome: "fk_sistema_parametro_historico_created_by"
        tipo: "FOREIGN KEY"
        definicao: "created_by REFERENCES usuario(id)"
        on_delete: "SET NULL"
        descricao: "Auditoria - criador"

      - nome: "fk_sistema_parametro_historico_updated_by"
        tipo: "FOREIGN KEY"
        definicao: "updated_by REFERENCES usuario(id)"
        on_delete: "SET NULL"
        descricao: "Auditoria - editor"

      - nome: "chk_sistema_parametro_historico_tipo_operacao"
        tipo: "CHECK"
        definicao: "tipo_operacao IN ('CREATE','UPDATE','DELETE','ACCESS')"
        descricao: "Tipo de operação válido"

# =============================================
# 3. RELACIONAMENTOS GLOBAIS (OPCIONAL)
# =============================================
relacionamentos_globais:
  - origem: "cliente"
    cardinalidade: "1:N"
    destino: "sistema_parametro"
    descricao: "Um cliente possui muitos parâmetros do sistema (multi-tenancy)"

  - origem: "cliente"
    cardinalidade: "1:N"
    destino: "sistema_feature_flag"
    descricao: "Um cliente possui muitas feature flags (flag global se cliente_id = NULL)"

  - origem: "cliente"
    cardinalidade: "1:N"
    destino: "sistema_configuracao_email"
    descricao: "Um cliente possui muitas configurações de email (apenas uma fl_principal = 1)"

  - origem: "cliente"
    cardinalidade: "1:N"
    destino: "sistema_limite_uso"
    descricao: "Um cliente possui muitos limites de uso (cada tipo_limite único por tenant)"

  - origem: "sistema_parametro"
    cardinalidade: "1:N"
    destino: "sistema_parametro_historico"
    descricao: "Um parâmetro possui muitos registros de histórico (auditoria completa)"

# =============================================
# 4. OBSERVAÇÕES E DECISÕES (OBRIGATÓRIO)
# =============================================
observacoes:
  - categoria: "Modelagem"
    descricao: "Derivado do RF001 - 4 entidades principais (Sistema_Parametro, Sistema_Feature_Flag, Sistema_Configuracao_Email, Sistema_Limite_Uso) + 1 entidade de auditoria (Sistema_Parametro_Historico). Todas as entidades possuem multi-tenancy (cliente_id), auditoria completa (5 campos) e soft delete (deleted_at). Campos mapeados de UC-RF001 (22 casos de uso) e WF-RF001 (22 wireframes)."

  - categoria: "Performance"
    descricao: "Índices criados para queries principais identificados em WF-RF001: busca por código (cd_parametro), filtros por categoria/tipo_dado (Sistema_Parametro), filtros por status (Sistema_Feature_Flag), filtros por provedor (Sistema_Configuracao_Email), filtros por tipo_limite (Sistema_Limite_Uso). Índices de auditoria criados para dt_alteracao e id_usuario em Sistema_Parametro_Historico."

  - categoria: "Segurança"
    descricao: "Multi-tenancy e auditoria completa implementados em TODAS as tabelas. Valores sensíveis (fl_sensivel = 1 em Sistema_Parametro, senha em Sistema_Configuracao_Email) são criptografados em AES-256 pela aplicação ANTES de persistir. Histórico de acesso a valores sensíveis registrado em Sistema_Parametro_Historico (tipo ACCESS). Proteção de parâmetros de sistema (fl_sistema = 1) garante que metadados não podem ser editados via UI."

  - categoria: "Migração"
    descricao: "Sistema_Parametro_Historico NÃO possui FK com ON DELETE CASCADE para id_parametro - histórico é preservado mesmo se parâmetro for fisicamente excluído (raro, pois soft delete é padrão). Retenção de histórico: 7 anos (soft delete após esse período via job background)."

  - categoria: "Validação"
    descricao: "Todas as validações de regras de negócio (RN-SYS-001-*) são implementadas em nível de aplicação (FluentValidation) e não em constraints de banco. Constraints de banco implementam apenas validações estruturais (CHECK para enums, UNIQUE para unicidade, FK para integridade referencial)."

# =============================================
# 5. HISTÓRICO DE ALTERAÇÕES (OBRIGATÓRIO)
# =============================================
historico:
  - versao: "2.0"
    data: "2026-01-04"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Versão inicial derivada do RF001 (versão 2.0), UC-RF001 (versão 2.2) e WF-RF001 (versão 1.0). Modelo lógico completo com 5 entidades, multi-tenancy, auditoria completa, soft delete, índices de performance e constraints de integridade. 100% conforme CONTRATO-GERACAO-DOCS-MD."
