# =============================================
# RF-007 - Login e Autenticação (YAML estruturado)
# Versão: 2.0
# Autor: Agência ALC - alc.dev.br
# Data: 2025-12-30
# =============================================

rf:
  id: "RF007"
  nome: "Login e Autenticação"
  versao: "2.0"
  data: "2025-12-30"
  fase: "Fase 1 - Sistema Base"
  epic: "EPIC001-SYS"
  status: "aprovado"  # draft | aprovado | em_desenvolvimento | concluido

descricao:
  objetivo: |
    Prover ao sistema IControlIT um mecanismo seguro, robusto e auditável de autenticação de usuários
    baseado em JWT (JSON Web Token), garantindo controle de acesso, proteção anti brute-force,
    recuperação de senha, gestão de sessões e auditoria completa.
  problema_resolvido: |
    Necessidade de controlar acesso ao sistema de forma segura, rastreável e conforme LGPD,
    substituindo autenticação legada baseada em Session por tokens JWT modernos.
  publico_afetado: "Todos os usuários do sistema (internos e externos)"

escopo:
  incluso:
    - "Autenticação por email corporativo e senha"
    - "Geração de JWT Token com expiração de 8 horas"
    - "Refresh token para renovação automática"
    - "Bloqueio temporário após 5 tentativas falhas (anti brute-force)"
    - "Recuperação de senha via email com token de 24 horas"
    - "Redefinição de senha com validação de requisitos mínimos"
    - "Primeiro acesso com troca obrigatória de senha temporária"
    - "Logout com invalidação de token"
    - "Timeout por inatividade (30 minutos)"
    - "Auditoria completa de tentativas de login"
    - "Notificação de login em novo dispositivo/IP"
    - "Histórico de senhas (impedir últimas 5)"
    - "Administração: desbloquear usuário, listar sessões, invalidar sessão"
  fora:
    - "Interface visual específica"
    - "Tecnologia de implementação"
    - "Layout, UX ou identidade visual"
    - "Autenticação via redes sociais (Facebook, Google)"
    - "Autenticação de dois fatores (2FA) - RF futuro"
    - "Single Sign-On (SSO) - RF futuro"

entidades:
  - nome: "TokenRecuperacaoSenha"
    descricao: "Token temporário para redefinição de senha"
    multi_tenant: false
    soft_delete: false
    auditoria: true
    estados: ["ativo", "expirado", "utilizado"]

  - nome: "SessaoAtiva"
    descricao: "Sessão JWT ativa de um usuário"
    multi_tenant: false
    soft_delete: false
    auditoria: true
    estados: ["ativa", "expirada", "invalidada"]

  - nome: "HistoricoSenhas"
    descricao: "Histórico das últimas 5 senhas do usuário"
    multi_tenant: false
    soft_delete: false
    auditoria: true

regras_negocio:
  - id: "RN-AUTH-001"
    titulo: "Autenticação por Email e Senha"
    descricao: "Sistema DEVE autenticar usuários através de email corporativo (único) e senha"
    tipo: "validacao"
    criticidade: "CRÍTICA"
    campos_afetados: ["Email", "Senha"]
    obrigatorio: true
    criterio_aceite:
      - "Email DEVE ser validado como formato válido (regex)"
      - "Email DEVE ser case-insensitive para busca"
      - "Senha DEVE ser case-sensitive para comparação"
      - "Credenciais inválidas DEVEM retornar mensagem genérica"
    implementacao: "Command LoginCommand com validação de email e BCrypt"

  - id: "RN-AUTH-002"
    titulo: "JWT Token com Expiração de 8 Horas"
    descricao: "Token JWT gerado DEVE expirar em 8 horas de trabalho"
    tipo: "regra_negocio"
    criticidade: "ALTA"
    obrigatorio: true
    criterio_aceite:
      - "Token DEVE conter claim exp configurada para UTC + 8 horas"
      - "Após expiração, token DEVE ser rejeitado"
      - "Frontend DEVE ser notificado via HTTP 401"
    implementacao: "JwtSecurityToken com expires: DateTime.UtcNow.AddHours(8)"

  - id: "RN-AUTH-003"
    titulo: "Bloqueio Após 5 Tentativas Falhas"
    descricao: "Após 5 tentativas falhas em 15 minutos, usuário DEVE ser bloqueado por 30 minutos"
    tipo: "seguranca"
    criticidade: "CRÍTICA"
    obrigatorio: true
    criterio_aceite:
      - "Sistema DEVE contar tentativas falhas por usuário (email)"
      - "Contador DEVE resetar após login bem-sucedido"
      - "Contador DEVE resetar após 15 minutos da primeira falha"
      - "Durante bloqueio, retornar HTTP 423 com tempo restante"
      - "Admin PODE desbloquear manualmente"
    implementacao: "Middleware de validação ANTES de validar credenciais"

  - id: "RN-AUTH-004"
    titulo: "Requisitos Mínimos de Senha"
    descricao: "Senha DEVE ter: 8+ caracteres, 1 maiúscula, 1 minúscula, 1 número, 1 especial"
    tipo: "validacao"
    criticidade: "ALTA"
    campos_afetados: ["Senha"]
    obrigatorio: true
    criterio_aceite:
      - "Validação DEVE ocorrer no backend"
      - "Sistema DEVE rejeitar senhas que não atendam requisitos"
      - "Mensagem DEVE indicar quais requisitos faltam"
    implementacao: "FluentValidation com PasswordValidator customizado"

  - id: "RN-AUTH-005"
    titulo: "Senha Case-Sensitive"
    descricao: "Comparação de senhas DEVE ser case-sensitive"
    tipo: "seguranca"
    criticidade: "ALTA"
    obrigatorio: true
    criterio_aceite:
      - "Senh@123 DEVE ser diferente de senh@123"
      - "BCrypt DEVE preservar case-sensitivity nativo"
    implementacao: "BCrypt nativo já é case-sensitive"

  - id: "RN-AUTH-006"
    titulo: "Token de Recuperação Válido por 24 Horas"
    descricao: "Link de recuperação de senha DEVE expirar em 24 horas"
    tipo: "seguranca"
    criticidade: "ALTA"
    obrigatorio: true
    criterio_aceite:
      - "Token DEVE ser único (Guid)"
      - "Sistema DEVE armazenar DataExpiracao = UTC + 24h"
      - "Tokens expirados DEVEM ser rejeitados"
      - "Token DEVE ser marcado como utilizado após uso"
      - "Token utilizado NÃO PODE ser reutilizado"
    implementacao: "Entidade TokenRecuperacaoSenha com validações"

  - id: "RN-AUTH-007"
    titulo: "Não Reutilizar Últimas 5 Senhas"
    descricao: "Nova senha NÃO PODE ser igual às 5 últimas utilizadas"
    tipo: "seguranca"
    criticidade: "MÉDIA"
    obrigatorio: true
    criterio_aceite:
      - "Sistema DEVE manter histórico de hashes das últimas 5 senhas"
      - "Ao definir nova senha, verificar histórico"
      - "Se já foi usada, rejeitar com mensagem clara"
    implementacao: "Tabela HistoricoSenhas com validação no Handler"

  - id: "RN-AUTH-008"
    titulo: "Primeiro Acesso Obriga Troca de Senha"
    descricao: "Usuários com senha temporária (Fl_Primeiro_Acesso = true) DEVEM trocar no primeiro login"
    tipo: "seguranca"
    criticidade: "ALTA"
    obrigatorio: true
    criterio_aceite:
      - "Após login, verificar flag Fl_Primeiro_Acesso"
      - "Se true, redirecionar para troca de senha"
      - "Usuário NÃO PODE acessar outras funcionalidades até trocar"
      - "Após troca, flag = false"
    implementacao: "Claim primeiro_acesso no JWT + Guard no frontend"

  - id: "RN-AUTH-009"
    titulo: "Timeout por Inatividade de 30 Minutos"
    descricao: "Sessão DEVE expirar após 30 minutos sem atividade"
    tipo: "seguranca"
    criticidade: "MÉDIA"
    obrigatorio: true
    criterio_aceite:
      - "Frontend DEVE monitorar eventos de atividade"
      - "Após 30 min sem evento, encerrar sessão localmente"
      - "Exibir aviso 1 minuto antes da expiração"
      - "Usuário PODE renovar clicando em 'Continuar conectado'"
    implementacao: "Interceptor Angular + Idle Timeout Service"

  - id: "RN-AUTH-010"
    titulo: "Auditoria de Todas as Tentativas de Login"
    descricao: "Registrar TODAS tentativas (sucesso e falha) com email, IP, User-Agent, data, resultado"
    tipo: "auditoria"
    criticidade: "CRÍTICA"
    obrigatorio: true
    criterio_aceite:
      - "Auditoria via Middleware automático"
      - "Armazenar em tabela AuditLog"
      - "Retenção de 7 anos (LGPD)"
      - "Admins DEVEM poder consultar via /api/auth/logs"
    implementacao: "AuditInterceptor automático + Endpoint consulta"

  - id: "RN-AUTH-011"
    titulo: "Mensagem Genérica para Credenciais Inválidas"
    descricao: "Sistema NÃO DEVE informar se problema é email ou senha"
    tipo: "seguranca"
    criticidade: "CRÍTICA"
    obrigatorio: true
    criterio_aceite:
      - "Mensagem sempre: 'Email ou senha incorretos'"
      - "NUNCA retornar 'Usuário não encontrado'"
      - "NUNCA retornar 'Senha incorreta'"
      - "HTTP sempre 401 (Unauthorized)"
    implementacao: "Tratamento de exceção unificado no Handler"

  - id: "RN-AUTH-012"
    titulo: "Notificação de Login em Novo Dispositivo"
    descricao: "Enviar email ao detectar login de IP/dispositivo desconhecido"
    tipo: "seguranca"
    criticidade: "BAIXA"
    obrigatorio: false
    criterio_aceite:
      - "Armazenar histórico de IPs e User-Agents por usuário"
      - "Ao detectar IP/UA novo, enviar email assíncrono"
      - "Email com: IP, Navegador, Localização, Data/Hora"
      - "Email NÃO DEVE bloquear login (apenas notificar)"
    implementacao: "Job Hangfire + Email Service"

estados: []  # Login é operação transacional, não possui estados

transicoes:
  permitidas: []
  proibidas: []

permissoes:
  - codigo: "auth:user:unlock"
    descricao: "Desbloquear usuário bloqueado"
    perfis: ["Admin", "Super Admin"]

  - codigo: "auth:session:view"
    descricao: "Visualizar sessões ativas"
    perfis: ["Admin", "Super Admin"]

  - codigo: "auth:session:invalidate"
    descricao: "Invalidar sessão de outro usuário"
    perfis: ["Admin", "Super Admin"]

  - codigo: "auth:logs:view"
    descricao: "Visualizar logs de acesso"
    perfis: ["Admin", "Super Admin", "Auditor"]

endpoints:
  - metodo: "POST"
    rota: "/api/auth/login"
    descricao: "Realizar login"
    autenticacao: "Pública"
    autorizacao: null

  - metodo: "POST"
    rota: "/api/auth/logout"
    descricao: "Encerrar sessão"
    autenticacao: "JWT"
    autorizacao: null

  - metodo: "POST"
    rota: "/api/auth/refresh"
    descricao: "Renovar token"
    autenticacao: "Refresh Token"
    autorizacao: null

  - metodo: "POST"
    rota: "/api/auth/forgot-password"
    descricao: "Solicitar recuperação de senha"
    autenticacao: "Pública"
    autorizacao: null

  - metodo: "POST"
    rota: "/api/auth/reset-password"
    descricao: "Redefinir senha"
    autenticacao: "Token Recuperação"
    autorizacao: null

  - metodo: "POST"
    rota: "/api/auth/change-password"
    descricao: "Alterar senha (usuário logado)"
    autenticacao: "JWT"
    autorizacao: null

  - metodo: "POST"
    rota: "/api/auth/users/{id}/unlock"
    descricao: "Desbloquear usuário"
    autenticacao: "JWT"
    autorizacao: "auth:user:unlock"

  - metodo: "GET"
    rota: "/api/auth/sessions"
    descricao: "Listar sessões ativas"
    autenticacao: "JWT"
    autorizacao: "auth:session:view"

  - metodo: "DELETE"
    rota: "/api/auth/sessions/{id}"
    descricao: "Invalidar sessão específica"
    autenticacao: "JWT"
    autorizacao: "auth:session:invalidate"

  - metodo: "GET"
    rota: "/api/auth/logs"
    descricao: "Consultar logs de acesso"
    autenticacao: "JWT"
    autorizacao: "auth:logs:view"

integracoes:
  internas:
    - nome: "Central de Funcionalidades"
      tipo: "FeatureFlag"
      feature_key: "AUTH_LOGIN"
      obrigatoria: true
      descricao: "Feature de sistema (sempre habilitada)"

    - nome: "Internacionalização (i18n)"
      tipo: "Tradução"
      namespace: "auth.*"
      obrigatoria: true
      idiomas: ["pt-BR", "en", "es"]

    - nome: "Auditoria"
      tipo: "Logging"
      operacoes: ["AUTH_LOGIN_SUCCESS", "AUTH_LOGIN_FAILURE", "AUTH_LOGOUT", "AUTH_PASSWORD_CHANGED"]
      retencao: "7 anos"
      obrigatoria: true

    - nome: "Email Service"
      tipo: "Notificação"
      templates: ["password-reset", "new-device-login"]
      sla: "5 minutos"
      obrigatoria: true

  externas: []

kpis:
  - nome: "Taxa de Login Falho"
    meta: "< 5%"
    formula: "(Tentativas falhas / Total) × 100"
    medicao: "Diária"

  - nome: "Contas Bloqueadas"
    meta: "< 1%"
    formula: "(Bloqueios / Usuários ativos) × 100"
    medicao: "Diária"

  - nome: "Tempo Médio de Login"
    meta: "< 2 segundos"
    formula: "Média do response time do endpoint /login"
    medicao: "Real-time"

  - nome: "Recuperações de Senha"
    meta: "Monitorar"
    formula: "Quantidade de solicitações"
    medicao: "Semanal"

  - nome: "Sessões Expiradas por Inatividade"
    meta: "Monitorar"
    formula: "Quantidade de timeouts"
    medicao: "Diária"

alertas:
  - nome: "Ataque Brute Force"
    condicao: "> 50 falhas/min do mesmo IP"
    acao: "Bloquear IP temporariamente (Firewall)"
    severidade: "CRÍTICA"

  - nome: "Conta Admin Bloqueada"
    condicao: "Bloqueio de Super Admin"
    acao: "Notificar equipe de segurança (urgente)"
    severidade: "CRÍTICA"

  - nome: "Token Comprometido"
    condicao: "Uso de token em IPs diferentes"
    acao: "Invalidar todas as sessões do usuário"
    severidade: "ALTA"

  - nome: "Email Service Down"
    condicao: "Falha no envio de recuperação"
    acao: "Notificar DevOps"
    severidade: "ALTA"

seguranca:
  isolamento_tenant: true
  auditoria_obrigatoria: true
  soft_delete: false
  protecoes:
    - "BCrypt com salt aleatório"
    - "JWT com RS256 (assinatura assimétrica)"
    - "Rate Limiting (10 logins/min por IP)"
    - "CORS configurável"
    - "HTTPS obrigatório em produção"
    - "HttpOnly Cookies para Refresh Token"
    - "Content Security Policy (CSP)"
    - "Anti-CSRF Tokens"
  testes_obrigatorios:
    - "SQL Injection no campo email"
    - "XSS em todos os campos"
    - "Brute Force Protection"
    - "Token Tampering"
    - "Session Fixation"
    - "CSRF Protection"
    - "Password Policy Bypass"

rastreabilidade:
  ucs_esperados:
    - "UC00" # Visão geral
    - "UC01" # Login
    - "UC02" # Recuperação de senha
    - "UC03" # Alterar senha
    - "UC04" # Administração de sessões
  tcs_esperados:
    - "TC-BACKEND" # Testes de API
    - "TC-FRONTEND" # Testes de interface
    - "TC-SEGURANCA" # Testes de segurança
    - "TC-E2E" # Testes end-to-end
  mts_esperados:
    - "MT-USUARIOS" # Massa de usuários de teste
    - "MT-CREDENCIAIS" # Credenciais válidas/inválidas
    - "MT-TOKENS" # Tokens de recuperação
  rls_esperados:
    - "RL-RF007" # Referências ao legado VB.NET/ASP.NET

catalog:
  crud:
    - id: "RF-AUTH-01"
      title: "Realizar login (autenticação)"
      required: true

    - id: "RF-AUTH-02"
      title: "Encerrar sessão (logout)"
      required: true

    - id: "RF-AUTH-03"
      title: "Renovar token (refresh)"
      required: true

    - id: "RF-AUTH-04"
      title: "Solicitar recuperação de senha"
      required: true

    - id: "RF-AUTH-05"
      title: "Redefinir senha"
      required: true

    - id: "RF-AUTH-06"
      title: "Alterar senha (usuário logado)"
      required: true

  validacoes:
    - id: "RF-AUTH-VAL-01"
      title: "Validar requisitos mínimos de senha"
      required: true

    - id: "RF-AUTH-VAL-02"
      title: "Validar formato de email"
      required: true

    - id: "RF-AUTH-VAL-03"
      title: "Validar expiração de token JWT"
      required: true

    - id: "RF-AUTH-VAL-04"
      title: "Validar histórico de senhas (últimas 5)"
      required: true

  seguranca:
    - id: "RF-AUTH-SEC-01"
      title: "Bloquear após 5 tentativas falhas"
      required: true

    - id: "RF-AUTH-SEC-02"
      title: "Auditoria de todas as tentativas"
      required: true

    - id: "RF-AUTH-SEC-03"
      title: "Mensagem genérica para credenciais inválidas"
      required: true

    - id: "RF-AUTH-SEC-04"
      title: "Timeout por inatividade (30 min)"
      required: true

    - id: "RF-AUTH-SEC-05"
      title: "Notificação de novo dispositivo"
      required: false

exclusions:
  documentacao_items:
    - id: "AUTH-2FA"
      razao: "Autenticação de dois fatores será implementada em RF futuro"

    - id: "AUTH-SSO"
      razao: "Single Sign-On será implementado em RF futuro"

    - id: "AUTH-SOCIAL"
      razao: "Login via redes sociais não faz parte do escopo inicial"

historico:
  - versao: "2.0"
    data: "2025-12-30"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Migração para v2.0 - YAML estruturado sincronizado com RF007.md"

  - versao: "1.0"
    data: "2025-11-19"
    autor: "Claude Code (Architect Agent)"
    descricao: "Versão inicial (não existia YAML separado)"
