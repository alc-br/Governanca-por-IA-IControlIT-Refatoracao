# RF-083: Central de Módulos

**Versão**: 1.0
**Data**: 2026-01-13
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC001-SYS - Sistema e Infraestrutura
**Fase**: Fase 1 - Sistema Base

---

## 1. OBJETIVO DO REQUISITO

A Central de Módulos é o sistema **fundamental** de gerenciamento de todas as funcionalidades do sistema IControlIT. Ela atua como um **catálogo centralizado** que registra, organiza e controla o acesso a todas as funcionalidades (features) disponíveis, suas ações associadas, permissões RBAC, categorização e exclusividade por cliente.

Este requisito define **o que** a Central de Módulos deve fazer, servindo como **contrato oficial** entre negócio, desenvolvimento e testes. É a **base arquitetural** para que todas as funcionalidades do sistema sejam registradas, organizadas hierarquicamente e controladas dinamicamente.

**Importância Crítica**: Este RF é **pré-requisito** para todos os demais RFs do sistema, pois **TODAS as funcionalidades devem ser cadastradas na Central de Módulos** para serem corretamente controladas via RBAC, Feature Flags e isolamento por cliente.

**Contexto SaaS**: O IControlIT é um sistema SaaS baseado em assinaturas. A Central de Módulos trabalha integrada com o RF117 (Gestão de Assinaturas) para controlar quais módulos cada cliente pode acessar baseado em seu plano contratado.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Cadastro centralizado de funcionalidades do sistema
- [x] Cadastro de ações por funcionalidade (VIEW, CREATE, UPDATE, DELETE, EXPORT, ADMIN)
- [x] Organização hierárquica de funcionalidades (funcionalidade pai/filha)
- [x] Categorização de funcionalidades (Cadastros, Sistema, Configurações, etc.)
- [x] Vinculação com Feature Flags para ativação dinâmica
- [x] Controle de empresas exclusivas (funcionalidade disponível apenas para clientes específicos)
- [x] Visualização agrupada por categoria
- [x] Estatísticas de funcionalidades (total, ativas, por categoria)
- [x] Gerenciamento de ordem de exibição e indentação
- [x] Vinculação com sistema de permissões RBAC
- [x] Controle de acesso baseado em perfil (Developer, System, Tenant)
- [x] Auditoria de operações
- [x] Soft delete
- [x] Isolamento multi-tenant
- [x] Dependências entre módulos (módulos pré-requisitos)
- [x] Controle de ativação por ambiente (Dev/Hom/Prod)
- [x] Integração com RF117 (Gestão de Assinaturas)
- [x] Redirect para página de vendas quando módulo não contratado

### 2.2 Fora do escopo (não objetivos)

- Interface visual de drag-and-drop (existente, mas não faz parte deste RF)
- Criação automática de permissões no sistema RBAC (apenas vinculação)
- Geração automática de rotas no frontend
- Sincronização automática com código-fonte
- Versionamento de funcionalidades
- Histórico de mudanças de configuração

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Funcionalidade** | Módulo ou feature do sistema registrado na Central (ex: Gestão de Usuários, Gestão de Clientes) |
| **Ação** | Operação específica dentro de uma funcionalidade (ex: Criar Usuário, Excluir Cliente) |
| **Categoria** | Agrupamento lógico de funcionalidades (ex: Cadastros, Sistema, Telecom) |
| **Código da Funcionalidade** | Identificador único no formato `FF.[CAMADA].[MODULO]` (ex: `FF.CAD.USUARIOS`) |
| **Empresas Exclusivas** | Lista de clientes que têm acesso exclusivo a uma funcionalidade (vazio = todos) |
| **Feature Flag** | Mecanismo de ativação/desativação dinâmica de funcionalidades |
| **Hierarquia** | Relação pai/filha entre funcionalidades (ex: Gestão de Usuários > Listar Usuários) |
| **Ordem** | Posição de exibição na interface (valor numérico, menor = mais acima) |
| **Nível de Indentação** | Profundidade visual na hierarquia (0 = raiz, 1 = subitem, 2 = sub-subitem) |
| **Permissão Requerida** | Código de permissão RBAC necessário para acessar a funcionalidade |
| **Dependências** | Módulos pré-requisitos que devem estar ativos para este módulo funcionar |
| **Ambiente** | Contexto de execução: Desenvolvimento, Homologação ou Produção |
| **Assinatura** | Plano comercial que inclui acesso aos módulos contratados pelo cliente |

---

## 4. FUNCIONALIDADES COBERTAS

### Funcionalidades Principais

1. **Listar funcionalidades** (RF-CRUD-02)
   - Listar todas as funcionalidades do sistema
   - Filtrar por categoria
   - Filtrar por status (ativa/inativa)
   - Incluir ações associadas
   - Incluir funcionalidades filhas

2. **Listar funcionalidades agrupadas por categoria** (RF-CRUD-02.1)
   - Agrupar funcionalidades por categoria
   - Ordenar por categoria e ordem
   - Exibir totalizadores por categoria

3. **Obter funcionalidade por ID** (RF-CRUD-03)
   - Visualizar detalhes completos de uma funcionalidade
   - Incluir ações, filhas e empresas exclusivas
   - Verificar vinculação com Feature Flag

4. **Obter estatísticas** (RF-CRUD-06)
   - Total de funcionalidades
   - Total de ações
   - Total de funcionalidades ativas
   - Funcionalidades por categoria

5. **Atualizar empresas exclusivas** (RF-CRUD-04.1)
   - Definir lista de empresas com acesso exclusivo
   - Limpar exclusividade (disponibilizar para todos)
   - Validar existência das empresas

6. **Resetar funcionalidades** (RF-ADMIN-01)
   - Repovoar funcionalidades com dados padrão
   - Apenas Developer ou Super Admin

---

## 5. REGRAS DE NEGÓCIO

### RN-RF083-01 — Código único de funcionalidade

**Descrição**: O código da funcionalidade deve ser único no sistema e seguir o formato `FF.[CAMADA].[MODULO]`.

**Justificativa**: Garantir identificação única e padronizada de funcionalidades.

**Critério de Aceite**:
- Código duplicado → rejeição
- Formato inválido → rejeição
- Formato esperado: `FF.CAD.USUARIOS`, `FF.SYS.LOGS`, `FF.TEL.INVENTARIO`

**Tipo**: Unicidade
**Campos afetados**: `codigo`

---

### RN-RF083-02 — Isolamento por perfil de usuário

**Descrição**: O acesso às funcionalidades deve ser filtrado baseado no perfil do usuário:
- **Developer**: visualiza todas as funcionalidades
- **System**: visualiza funcionalidades Corporativo + Sistema
- **Tenant**: visualiza apenas funcionalidades Corporativo

**Justificativa**: Proteger funcionalidades sensíveis de perfis inadequados.

**Critério de Aceite**:
- Developer → acesso total
- System → acesso parcial (Corporativo + Sistema)
- Tenant → acesso restrito (apenas Corporativo)

**Tipo**: Segurança
**Campos afetados**: Filtro de listagem

---

### RN-RF083-03 — Empresas exclusivas vazias = acesso total

**Descrição**: Se o campo `empresas_exclusivas` estiver vazio ou nulo, a funcionalidade está disponível para **todas as empresas**.

**Justificativa**: Modelo de exclusividade explícito (whitelist).

**Critério de Aceite**:
- Array vazio ou null → funcionalidade disponível para todos
- Array com IDs → funcionalidade disponível apenas para empresas listadas

**Tipo**: Regra de Negócio
**Campos afetados**: `empresas_exclusivas_json`

---

### RN-RF083-04 — Apenas Developer pode gerenciar empresas exclusivas

**Descrição**: A operação de atualizar empresas exclusivas é restrita ao perfil **Developer**.

**Justificativa**: Operação sensível que impacta controle de acesso de clientes.

**Critério de Aceite**:
- Usuário Developer → operação permitida
- Usuário não Developer → operação negada (403 Forbidden)

**Tipo**: Segurança
**Campos afetados**: Endpoint `PUT /funcionalidades/{id}/empresas-exclusivas`

---

### RN-RF083-05 — Soft delete obrigatório

**Descrição**: Funcionalidades e ações não devem ser fisicamente excluídas, apenas marcadas como excluídas (`fl_excluido = true`).

**Justificativa**: Preservar rastreabilidade e permitir recuperação.

**Critério de Aceite**:
- Exclusão → campo `fl_excluido` = `true`
- Listagens → filtrar registros onde `fl_excluido = false`

**Tipo**: Regra de Negócio
**Campos afetados**: `fl_excluido`

---

### RN-RF083-06 — Hierarquia de funcionalidades (pai/filha)

**Descrição**: Uma funcionalidade pode ter uma funcionalidade pai (`funcionalidade_pai_id`) e múltiplas funcionalidades filhas.

**Justificativa**: Permitir organização hierárquica em menus e sidebars.

**Critério de Aceite**:
- Funcionalidade raiz → `funcionalidade_pai_id = null`
- Funcionalidade filha → `funcionalidade_pai_id = ID da funcionalidade pai`
- Profundidade máxima → 3 níveis (raiz, subitem, sub-subitem)

**Tipo**: Regra de Negócio
**Campos afetados**: `funcionalidade_pai_id`, `nivel_indentacao`

---

### RN-RF083-07 — Vinculação com Feature Flag

**Descrição**: Uma funcionalidade pode estar vinculada a uma Feature Flag (`feature_flag_id`), permitindo ativação/desativação dinâmica sem deploy.

**Justificativa**: Controle granular de funcionalidades em produção.

**Critério de Aceite**:
- `feature_flag_id` nulo → funcionalidade sempre disponível (se ativa)
- `feature_flag_id` preenchido → funcionalidade depende do estado da Feature Flag

**Tipo**: Integração
**Campos afetados**: `feature_flag_id`

---

### RN-RF083-08 — Ações devem pertencer a uma funcionalidade

**Descrição**: Toda ação (`SistemaFuncionalidadeAcao`) deve estar vinculada a uma funcionalidade existente.

**Justificativa**: Não permitir ações órfãs sem contexto.

**Critério de Aceite**:
- Criação de ação → `funcionalidade_id` obrigatório
- Funcionalidade inexistente → rejeição (FK constraint)

**Tipo**: Validação
**Campos afetados**: `funcionalidade_id`

---

### RN-RF083-09 — Código de ação segue padrão de permissão

**Descrição**: O código da ação deve seguir o formato da permissão RBAC associada (ex: `CAD.USUARIOS.CREATE`, `CAD.USUARIOS.DELETE`).

**Justificativa**: Manter consistência entre ações e permissões.

**Critério de Aceite**:
- Formato esperado: `[MODULO].[ENTIDADE].[OPERACAO]`
- Exemplos válidos: `CAD.USUARIOS.CREATE`, `SYS.LOGS.VIEW`

**Tipo**: Validação
**Campos afetados**: `codigo` (em `SistemaFuncionalidadeAcao`)

---

### RN-RF083-10 — Tipos de ação padronizados

**Descrição**: O campo `tipo_acao` deve conter um dos valores padronizados: `VIEW`, `CREATE`, `UPDATE`, `DELETE`, `EXPORT`, `ADMIN`.

**Justificativa**: Permitir agrupamento visual e funcional de ações.

**Critério de Aceite**:
- Valor inválido → rejeição
- Valores aceitos: `VIEW`, `CREATE`, `UPDATE`, `DELETE`, `EXPORT`, `ADMIN`

**Tipo**: Validação
**Campos afetados**: `tipo_acao`

---

### RN-RF083-11 — Ordem de exibição

**Descrição**: O campo `ordem` define a sequência de exibição na interface. Menor valor = mais acima.

**Justificativa**: Controle explícito da ordem de apresentação.

**Critério de Aceite**:
- Ordem crescente → funcionalidade aparece mais acima
- Empate → ordenar por nome (alfabético)

**Tipo**: Regra de Negócio
**Campos afetados**: `ordem`

---

### RN-RF083-12 — Categoria textual legada (deprecated)

**Descrição**: O campo `categoria` (texto) ainda existe para compatibilidade, mas o relacionamento deve ser feito via `categoria_id` (FK para `SistemaCategoria`).

**Justificativa**: Migração gradual para modelo normalizado.

**Critério de Aceite**:
- Novos registros → usar `categoria_id`
- Legado → campo `categoria` pode estar preenchido
- Prioridade → `categoria_id` prevalece sobre `categoria`

**Tipo**: Regra de Negócio
**Campos afetados**: `categoria`, `categoria_id`

---

### RN-RF083-13 — Auditoria obrigatória

**Descrição**: Toda funcionalidade e ação deve registrar campos de auditoria: `created_at`, `created_by`, `updated_at`, `updated_by`.

**Justificativa**: Rastreabilidade de mudanças.

**Critério de Aceite**:
- Criação → campos `created_*` preenchidos
- Atualização → campos `updated_*` atualizados

**Tipo**: Regra de Negócio
**Campos afetados**: `created_at`, `created_by`, `updated_at`, `updated_by`

---

### RN-RF083-14 — Estatísticas refletem apenas registros ativos e não excluídos

**Descrição**: Ao calcular estatísticas, considerar apenas funcionalidades onde `ativo = true` e `fl_excluido = false`.

**Justificativa**: Estatísticas devem refletir estado real disponível.

**Critério de Aceite**:
- Funcionalidade inativa → não conta
- Funcionalidade excluída → não conta
- Apenas `ativo = true` e `fl_excluido = false` → contam

**Tipo**: Regra de Negócio
**Campos afetados**: Endpoint `/estatisticas`

---

### RN-RF083-15 — Reset de funcionalidades é operação destrutiva

**Descrição**: A operação de reset (`POST /funcionalidades/reset`) deleta todas as funcionalidades existentes e recria com dados padrão.

**Justificativa**: Operação de manutenção para ambiente de desenvolvimento.

**Critério de Aceite**:
- Apenas Developer ou Super Admin → operação permitida
- Outros perfis → operação negada (403 Forbidden)
- **CUIDADO**: Operação destrutiva, não reversível

**Tipo**: Segurança
**Campos afetados**: Endpoint `POST /funcionalidades/reset`

---

### RN-RF083-16 — Redirect para página de vendas quando módulo não contratado

**Descrição**: Quando usuário tenta acessar módulo que não está em sua assinatura ativa, sistema redireciona para página de vendas/upgrade.

**Justificativa**: Estratégia de upsell e conversão comercial.

**Critério de Aceite**:
- Usuário acessa rota de módulo não contratado
- Sistema valida: módulo existe + requer assinatura + assinatura não inclui módulo
- Redirect HTTP 307 (Temporary Redirect) para `/vendas/upgrade?modulo={codigo_modulo}`
- Página de vendas exibe: nome do módulo, benefícios, planos que incluem, botão "Solicitar ao Comercial"
- Links no menu permanecem visíveis (estratégia de upsell visual)
- Registrar tentativa de acesso em analytics (oportunidade comercial)

**Tipo**: Regra de Negócio
**Campos afetados**: `requer_contrato`, validação de acesso
**Integração**: RF117 (Gestão de Assinaturas)

---

### RN-RF083-17 — Dependências circulares são proibidas

**Descrição**: Módulos não podem ter dependências circulares (A depende de B, B depende de C, C depende de A).

**Justificativa**: Prevenir deadlocks e configurações impossíveis de resolver.

**Critério de Aceite**:
- Ao cadastrar/atualizar `modulos_requeridos_json`, sistema valida grafo de dependências
- Se detectar ciclo → rejeitar operação (400 Bad Request)
- Mensagem: "Dependência circular detectada: [Módulo A] → [Módulo B] → [Módulo C] → [Módulo A]"
- Dependências transitivas devem ser calculadas e armazenadas em `dependencias_resolvidas_json`

**Tipo**: Validação
**Campos afetados**: `modulos_requeridos_json`, `dependencias_resolvidas_json`

---

### RN-RF083-18 — Ao desativar módulo, desativar todos os dependentes

**Descrição**: Ao desativar um módulo, todos os módulos que dependem dele devem ser desativados automaticamente (ou operação deve ser bloqueada).

**Justificativa**: Evitar módulos ativos com dependências faltantes.

**Critério de Aceite**:
- Usuário tenta desativar módulo Y
- Sistema verifica se existe módulo ativo que lista Y em `modulos_requeridos_json`
- Se existe → BLOQUEAR e mostrar: "Não é possível desativar [Módulo Y] pois [Módulo A, Módulo B] dependem dele. Desative os dependentes primeiro ou desative todos juntos"
- Oferecer opção: "Desativar todos (Y + dependentes)"

**Tipo**: Validação
**Campos afetados**: `ativo`, `modulos_requeridos_json`

---

### RN-RF083-19 — Ao ativar módulo, ativar todas as dependências

**Descrição**: Ao ativar um módulo, todas as suas dependências devem ser ativadas automaticamente.

**Justificativa**: Garantir que módulo tenha todos os pré-requisitos ativos.

**Critério de Aceite**:
- Usuário tenta ativar módulo X
- Sistema lê `modulos_requeridos_json` de X
- Se dependência inativa → mostrar: "Para ativar [Módulo X], é necessário ativar: [Módulo Y, Módulo Z]"
- Oferecer botão: "Ativar todos os pré-requisitos automaticamente"
- Se usuário confirma → ativar módulo X + dependências em ordem correta (resolver grafo)

**Tipo**: Validação
**Campos afetados**: `ativo`, `modulos_requeridos_json`, `dependencias_resolvidas_json`

---

### RN-RF083-20 — Planos de assinatura devem incluir todas as dependências

**Descrição**: Ao criar plano de assinatura (RF117) com módulos selecionados, todas as dependências desses módulos devem estar incluídas no plano.

**Justificativa**: Evitar planos inconsistentes que não funcionam corretamente.

**Critério de Aceite**:
- Comercial cria plano e seleciona módulos [A, B, C]
- Sistema resolve dependências: A requer D, B requer E
- Sistema alerta: "Os módulos selecionados requerem: [Módulo D, Módulo E]. Deseja incluir automaticamente?"
- Opções: "Incluir automaticamente" (recomendado) / "Remover módulos com dependências faltantes" / "Ignorar (não recomendado)"
- Se ignorar → marcar plano com alerta de inconsistência

**Tipo**: Validação
**Campos afetados**: RF117 (Gestão de Assinaturas) - `modulos_inclusos_json`
**Integração**: RF117 (Gestão de Assinaturas)

---

### RN-RF083-21 — Controle de ativação por ambiente

**Descrição**: Módulos podem ser ativados/desativados por ambiente (Desenvolvimento, Homologação, Produção) independentemente.

**Justificativa**: Permitir testes graduais e rollout controlado de novas funcionalidades.

**Critério de Aceite**:
- Campo `ambientes_ativos_json` = `["desenvolvimento", "homologacao", "producao"]`
- Array vazio ou null → módulo inativo em todos os ambientes
- Apenas ambientes listados → módulo ativo nesses ambientes
- Validação de acesso considera ambiente atual do sistema
- Exemplo: módulo ativo em `["desenvolvimento", "homologacao"]` → bloqueado em produção

**Tipo**: Regra de Negócio
**Campos afetados**: `ambientes_ativos_json`

---

### RN-RF083-22 — Integração com Gestão de Assinaturas

**Descrição**: Central de Módulos consulta RF117 (Gestão de Assinaturas) para validar se cliente tem acesso ao módulo baseado em plano contratado.

**Justificativa**: Modelo SaaS baseado em assinaturas comerciais.

**Critério de Aceite**:
- Ao validar acesso a módulo, sistema verifica:
  1. Ambiente ativo? (RN-RF083-21)
  2. RBAC OK? (RN-RF083-02)
  3. Assinatura inclui módulo? (consulta RF117)
- Se módulo requer assinatura (`requer_contrato = true`) mas cliente não tem:
  - Redirect para página de vendas (RN-RF083-16)
- Se módulo não requer assinatura → liberar acesso (módulos core gratuitos)

**Tipo**: Integração
**Campos afetados**: `requer_contrato`
**Integração**: RF117 (Gestão de Assinaturas)

---

## 6. ESTADOS DA ENTIDADE

### Estados de Funcionalidade

| Estado | Descrição | Campo no Banco |
|--------|-----------|----------------|
| **ativo** | Funcionalidade disponível para uso | `ativo = true` |
| **inativo** | Funcionalidade temporariamente desabilitada | `ativo = false` |
| **excluído** | Funcionalidade excluída logicamente | `fl_excluido = true` |

### Transições permitidas

| De | Para | Condição |
|----|------|----------|
| ativo | inativo | Operação de desativação |
| inativo | ativo | Operação de reativação |
| ativo | excluído | Operação de exclusão (soft delete) |
| inativo | excluído | Operação de exclusão (soft delete) |

**Observação**: Não existe transição de `excluído` para outros estados (soft delete é irreversível via API).

---

## 7. PERMISSÕES (RBAC)

### Permissões da Central de Módulos

| Código | Descrição | Escopo |
|--------|-----------|--------|
| `central_modulos.view_any` | Listar funcionalidades | Developer, System, Tenant |
| `central_modulos.view` | Visualizar funcionalidade específica | Developer, System, Tenant |
| `central_modulos.create` | Criar funcionalidade | Developer |
| `central_modulos.update` | Atualizar funcionalidade | Developer |
| `central_modulos.delete` | Excluir funcionalidade | Developer |
| `central_modulos.manage_exclusives` | Gerenciar empresas exclusivas | Developer |
| `central_modulos.reset` | Resetar funcionalidades | Developer, Super Admin |

**Observação**: Atualmente, a API não impõe permissões RBAC explícitas nos endpoints de funcionalidades (todos os endpoints exigem apenas `RequireAuthorization()`), mas o filtro por perfil (Developer/System/Tenant) é aplicado na Query Handler.

---

## 8. ENDPOINTS DA API

### 8.1 Listar Funcionalidades

**Endpoint**: `GET /api/funcionalidades`

**Autenticação**: Obrigatória

**Query Parameters**:
- `categoria` (string, opcional): Filtrar por categoria
- `apenasAtivas` (boolean, opcional, default: `true`): Retornar apenas funcionalidades ativas
- `incluirAcoes` (boolean, opcional, default: `true`): Incluir ações associadas
- `incluirFilhas` (boolean, opcional, default: `true`): Incluir funcionalidades filhas

**Response**: `200 OK`
```json
[
  {
    "id": "uuid",
    "codigo": "FF.CAD.USUARIOS",
    "nome": "Gestão de Usuários",
    "descricao": "Gerenciamento de usuários do sistema",
    "icone": "heroicons_outline:users",
    "rota": "/management/users",
    "featureFlagId": "uuid | null",
    "ativo": true,
    "ordem": 10,
    "categoria": "Cadastros",
    "categoriaId": "uuid | null",
    "funcionalidadePaiId": "uuid | null",
    "permissaoRequerida": "CAD.USUARIOS.VIEW",
    "acoes": [
      {
        "id": "uuid",
        "codigo": "CAD.USUARIOS.CREATE",
        "nome": "Criar Usuário",
        "descricao": "Permite criar novos usuários",
        "icone": "heroicons_outline:plus",
        "permissaoCodigo": "CAD.USUARIOS.CREATE",
        "tipoAcao": "CREATE",
        "ativo": true,
        "ordem": 1,
        "acaoPadrao": false
      }
    ],
    "filhas": [],
    "empresasExclusivas": ["uuid1", "uuid2"] // ou null
  }
]
```

**Regras aplicadas**:
- RN-RF083-02 (isolamento por perfil)
- RN-RF083-05 (soft delete)
- RN-RF083-14 (apenas ativos se `apenasAtivas = true`)

---

### 8.2 Obter Funcionalidade por ID

**Endpoint**: `GET /api/funcionalidades/{id}`

**Autenticação**: Obrigatória

**Path Parameters**:
- `id` (guid): ID da funcionalidade

**Response**: `200 OK`
```json
{
  "id": "uuid",
  "codigo": "FF.CAD.USUARIOS",
  "nome": "Gestão de Usuários",
  "descricao": "Gerenciamento de usuários do sistema",
  "icone": "heroicons_outline:users",
  "rota": "/management/users",
  "featureFlagId": "uuid | null",
  "ativo": true,
  "ordem": 10,
  "categoria": "Cadastros",
  "categoriaId": "uuid | null",
  "funcionalidadePaiId": "uuid | null",
  "permissaoRequerida": "CAD.USUARIOS.VIEW",
  "acoes": [],
  "filhas": [],
  "empresasExclusivas": null,
  "totalAcoes": 5,
  "acoesAtivas": 5,
  "featureFlagAtiva": true,
  "usuariosComAcesso": 120
}
```

**Response**: `404 Not Found` (funcionalidade não encontrada ou excluída)

**Regras aplicadas**:
- RN-RF083-05 (soft delete)

---

### 8.3 Listar Funcionalidades por Categoria

**Endpoint**: `GET /api/funcionalidades/categoria/{categoria}`

**Autenticação**: Obrigatória

**Path Parameters**:
- `categoria` (string): Nome da categoria

**Response**: `200 OK` (mesmo formato de 8.1)

**Regras aplicadas**:
- RN-RF083-02 (isolamento por perfil)
- RN-RF083-05 (soft delete)

---

### 8.4 Obter Estatísticas

**Endpoint**: `GET /api/funcionalidades/estatisticas`

**Autenticação**: Obrigatória

**Response**: `200 OK`
```json
{
  "totalGeral": 35,
  "porCategoria": {
    "Cadastros": 12,
    "Sistema": 8,
    "Telecom": 10,
    "Configurações": 5
  }
}
```

**Regras aplicadas**:
- RN-RF083-14 (apenas registros ativos e não excluídos)

---

### 8.5 Atualizar Empresas Exclusivas

**Endpoint**: `PUT /api/funcionalidades/{id}/empresas-exclusivas`

**Autenticação**: Obrigatória

**Autorização**: Apenas Developer (RN-RF083-04)

**Path Parameters**:
- `id` (guid): ID da funcionalidade

**Request Body**:
```json
{
  "empresasIds": ["uuid1", "uuid2"]
}
```

**Response**: `200 OK`
```json
true
```

**Response**: `403 Forbidden` (usuário não é Developer)

**Response**: `404 Not Found` (funcionalidade não encontrada)

**Regras aplicadas**:
- RN-RF083-03 (empresas exclusivas)
- RN-RF083-04 (apenas Developer)

---

### 8.6 Resetar Funcionalidades

**Endpoint**: `POST /api/funcionalidades/reset`

**Autenticação**: Obrigatória

**Autorização**: Apenas Developer ou Super Admin (RN-RF083-15)

**Response**: `200 OK`
```json
{
  "sucesso": true,
  "mensagem": "Funcionalidades resetadas e repopuladas com sucesso. 35 funcionalidades criadas."
}
```

**Response**: `403 Forbidden` (usuário não autorizado)

**Regras aplicadas**:
- RN-RF083-15 (reset é operação destrutiva)

---

## 9. MODELO DE DADOS

### 9.1 Entidade: SistemaFuncionalidade

| Campo | Tipo | Obrigatório | Descrição |
|-------|------|-------------|-----------|
| `id` | Guid | Sim | Identificador único |
| `codigo` | String(100) | Sim | Código único da funcionalidade (ex: `FF.CAD.USUARIOS`) |
| `nome` | String(200) | Sim | Nome amigável da funcionalidade |
| `descricao` | String(500) | Não | Descrição detalhada |
| `icone` | String(100) | Não | Ícone heroicons (ex: `heroicons_outline:users`) |
| `rota` | String(200) | Não | Rota principal no frontend (ex: `/management/users`) |
| `feature_flag_id` | Guid | Não | FK para `SistemaFeatureFlagAvancado` |
| `ativo` | Boolean | Sim | Se a funcionalidade está ativa (default: `true`) |
| `ordem` | Integer | Sim | Ordem de exibição (default: `0`) |
| `categoria` | String(100) | Não | Categoria textual legada (deprecated) |
| `categoria_id` | Guid | Não | FK para `SistemaCategoria` (recomendado) |
| `ordem_na_categoria` | Integer | Sim | Ordem dentro da categoria (default: `0`) |
| `nivel_indentacao` | Integer | Sim | Nível de indentação (0, 1, 2) (default: `0`) |
| `funcionalidade_pai_id` | Guid | Não | FK auto-referência (funcionalidade pai) |
| `permissao_requerida` | String(100) | Não | Código de permissão RBAC base |
| `tags_json` | String | Não | Tags em formato JSON (ex: `["cadastro", "usuarios"]`) |
| `empresas_exclusivas_json` | String | Não | IDs de empresas com acesso exclusivo em JSON |
| `modulos_requeridos_json` | String | Não | IDs de módulos pré-requisitos (dependências diretas) |
| `dependencias_resolvidas_json` | String | Não | IDs de todas as dependências (diretas + transitivas, calculado) |
| `modulos_dependentes_json` | String | Não | IDs de módulos que dependem deste (reverso, calculado) |
| `ambientes_ativos_json` | String | Não | Ambientes onde módulo está ativo (`["desenvolvimento", "homologacao", "producao"]`) |
| `requer_contrato` | Boolean | Sim | Se requer assinatura ativa para acesso (default: `true`) |
| `disponivel_para_venda` | Boolean | Sim | Se está disponível para incluir em planos (default: `true`) |
| `disponivel_preview` | Boolean | Sim | Se está em modo preview/beta (default: `false`) |
| `clientes_preview_json` | String | Não | IDs de clientes com acesso antecipado (preview) |
| `fl_excluido` | Boolean | Sim | Soft delete (default: `false`) |
| `created_at` | DateTime | Sim | Data de criação (auditoria) |
| `created_by` | Guid | Sim | Usuário criador (auditoria) |
| `updated_at` | DateTime | Sim | Data de última atualização (auditoria) |
| `updated_by` | Guid | Sim | Usuário que atualizou (auditoria) |

**Índices**:
- `codigo` (unique)
- `categoria_id`
- `funcionalidade_pai_id`
- `fl_excluido`

---

### 9.2 Entidade: SistemaFuncionalidadeAcao

| Campo | Tipo | Obrigatório | Descrição |
|-------|------|-------------|-----------|
| `id` | Guid | Sim | Identificador único |
| `funcionalidade_id` | Guid | Sim | FK para `SistemaFuncionalidade` |
| `codigo` | String(100) | Sim | Código único da ação (ex: `CAD.USUARIOS.CREATE`) |
| `nome` | String(200) | Sim | Nome amigável da ação |
| `descricao` | String(500) | Não | Descrição da ação |
| `icone` | String(100) | Não | Ícone heroicons |
| `permissao_codigo` | String(100) | Não | Código de permissão RBAC vinculada |
| `tipo_acao` | String(20) | Sim | Tipo de ação (`VIEW`, `CREATE`, `UPDATE`, `DELETE`, `EXPORT`, `ADMIN`) |
| `ativo` | Boolean | Sim | Se a ação está ativa (default: `true`) |
| `ordem` | Integer | Sim | Ordem de exibição (default: `0`) |
| `acao_padrao` | Boolean | Sim | Se é ação padrão que aparece para todos (default: `false`) |
| `fl_excluido` | Boolean | Sim | Soft delete (default: `false`) |
| `created_at` | DateTime | Sim | Data de criação (auditoria) |
| `created_by` | Guid | Sim | Usuário criador (auditoria) |
| `updated_at` | DateTime | Sim | Data de última atualização (auditoria) |
| `updated_by` | Guid | Sim | Usuário que atualizou (auditoria) |

**Índices**:
- `funcionalidade_id`
- `codigo` (unique)
- `fl_excluido`

---

## 10. DEPENDÊNCIAS

### 10.1 Dependências Internas (Sistema IControlIT)

| Sistema | Tipo | Obrigatória | Descrição |
|---------|------|-------------|-----------|
| **Autenticação** | Integração | Sim | Identificar usuário autenticado e perfil (Developer/System/Tenant) |
| **RBAC (Permissões)** | Integração | Sim | Vincular funcionalidades e ações com permissões |
| **Feature Flags** | Integração | Não | Vincular funcionalidades com flags de ativação dinâmica |
| **Empresas (Tenants)** | Integração | Não | Validar IDs de empresas para exclusividade |
| **Auditoria** | Integração | Sim | Registrar quem criou/atualizou funcionalidades e ações |
| **RF117 (Gestão de Assinaturas)** | Integração | Sim | Validar se cliente tem assinatura ativa que inclui o módulo |

### 10.2 Dependências Externas

Nenhuma dependência externa.

---

### 10.3 Integração com RF117 (Gestão de Assinaturas)

**Descrição**: Central de Módulos (RF116) trabalha integrada com Gestão de Assinaturas (RF117) para controlar acesso baseado em planos comerciais.

**Fluxo de Validação**:
1. Usuário tenta acessar módulo X
2. RF116 valida:
   - Ambiente ativo? (campo `ambientes_ativos_json`)
   - RBAC OK? (permissões do usuário)
   - Módulo requer assinatura? (campo `requer_contrato`)
3. Se `requer_contrato = true`:
   - RF116 consulta RF117: "Cliente tem assinatura ativa que inclui módulo X?"
   - RF117 retorna: sim/não
4. Se não tem assinatura:
   - Redirect para `/vendas/upgrade?modulo={codigo_modulo}`
5. Se tem assinatura:
   - Liberar acesso

**Endpoints Consumidos (RF117)**:
- `GET /api/assinaturas/cliente/{clienteId}/modulos` → Lista módulos ativos na assinatura do cliente
- `GET /api/assinaturas/cliente/{clienteId}/tem-modulo/{moduloId}` → Verifica se cliente tem acesso ao módulo específico

**Dados Compartilhados**:
- RF116 expõe catálogo de módulos para RF117 usar na criação de planos
- RF117 valida dependências de módulos usando `modulos_requeridos_json` de RF116
- RF116 marca módulos com `disponivel_para_venda = false` → RF117 não permite incluir em novos planos

---

## 11. INTEGRAÇÕES OBRIGATÓRIAS

### 11.1 Internacionalização (i18n)

**Chaves de tradução** (formato `rf.083.[chave]`):

**Português (pt-BR)**:
- `rf.083.titulo`: "Central de Módulos"
- `rf.083.descricao`: "Gerencie as funcionalidades do sistema organizadas por categoria"
- `rf.083.funcionalidade`: "Funcionalidade"
- `rf.083.acoes`: "Ações"
- `rf.083.categoria`: "Categoria"
- `rf.083.ativo`: "Ativo"
- `rf.083.inativo`: "Inativo"
- `rf.083.exclusivo`: "Exclusivo"
- `rf.083.empresas_exclusivas`: "Clientes com acesso"
- `rf.083.todos`: "Todos"
- `rf.083.expandir`: "Expandir"
- `rf.083.contrair`: "Contrair"
- `rf.083.estatisticas.total`: "Funcionalidades"
- `rf.083.estatisticas.acoes`: "Ações"
- `rf.083.estatisticas.ativas`: "Ativas"
- `rf.083.validacao.codigo_obrigatorio`: "Código da funcionalidade é obrigatório"
- `rf.083.validacao.codigo_duplicado`: "Código da funcionalidade já existe"
- `rf.083.validacao.nome_obrigatorio`: "Nome da funcionalidade é obrigatório"
- `rf.083.validacao.apenas_developer`: "Apenas desenvolvedores podem gerenciar empresas exclusivas"
- `rf.083.erro.nao_encontrada`: "Funcionalidade não encontrada"
- `rf.083.sucesso.empresas_atualizadas`: "Empresas exclusivas atualizadas com sucesso"

**Inglês (en-US)**:
- `rf.083.titulo`: "Module Center"
- `rf.083.descricao`: "Manage system features organized by category"
- `rf.083.funcionalidade`: "Feature"
- `rf.083.acoes`: "Actions"
- `rf.083.categoria`: "Category"
- `rf.083.ativo`: "Active"
- `rf.083.inativo`: "Inactive"
- `rf.083.exclusivo`: "Exclusive"
- `rf.083.empresas_exclusivas`: "Client access"
- `rf.083.todos`: "All"
- `rf.083.expandir`: "Expand"
- `rf.083.contrair`: "Collapse"
- `rf.083.estatisticas.total`: "Features"
- `rf.083.estatisticas.acoes`: "Actions"
- `rf.083.estatisticas.ativas`: "Active"
- `rf.083.validacao.codigo_obrigatorio`: "Feature code is required"
- `rf.083.validacao.codigo_duplicado`: "Feature code already exists"
- `rf.083.validacao.nome_obrigatorio`: "Feature name is required"
- `rf.083.validacao.apenas_developer`: "Only developers can manage exclusive clients"
- `rf.083.erro.nao_encontrada`: "Feature not found"
- `rf.083.sucesso.empresas_atualizadas`: "Exclusive clients updated successfully"

**Espanhol (es-ES)**:
- `rf.083.titulo`: "Central de Módulos"
- `rf.083.descricao`: "Gestione las funcionalidades del sistema organizadas por categoría"
- `rf.083.funcionalidade`: "Funcionalidad"
- `rf.083.acoes`: "Acciones"
- `rf.083.categoria`: "Categoría"
- `rf.083.ativo`: "Activo"
- `rf.083.inativo`: "Inactivo"
- `rf.083.exclusivo`: "Exclusivo"
- `rf.083.empresas_exclusivas`: "Acceso de clientes"
- `rf.083.todos`: "Todos"
- `rf.083.expandir`: "Expandir"
- `rf.083.contrair`: "Contraer"
- `rf.083.estatisticas.total`: "Funcionalidades"
- `rf.083.estatisticas.acoes`: "Acciones"
- `rf.083.estatisticas.ativas`: "Activas"
- `rf.083.validacao.codigo_obrigatorio`: "El código de funcionalidad es obligatorio"
- `rf.083.validacao.codigo_duplicado`: "El código de funcionalidad ya existe"
- `rf.083.validacao.nome_obrigatorio`: "El nombre de funcionalidad es obligatorio"
- `rf.083.validacao.apenas_developer`: "Solo los desarrolladores pueden gestionar clientes exclusivos"
- `rf.083.erro.nao_encontrada`: "Funcionalidad no encontrada"
- `rf.083.sucesso.empresas_atualizadas`: "Clientes exclusivos actualizados exitosamente"

---

### 11.2 Auditoria

**Campos obrigatórios** (aplicados automaticamente via `[Auditable]`):
- `created_at`: Data de criação (UTC)
- `created_by`: ID do usuário que criou
- `updated_at`: Data de última atualização (UTC)
- `updated_by`: ID do usuário que atualizou

**Soft delete obrigatório**:
- `fl_excluido`: Marcador de exclusão lógica (default: `false`)

---

### 11.3 RBAC (Controle de Acesso)

**Vinculação**:
- Campo `permissao_requerida` em `SistemaFuncionalidade` vincula com código de permissão no sistema RBAC
- Campo `permissao_codigo` em `SistemaFuncionalidadeAcao` vincula ação com permissão específica
- Filtro por perfil aplicado na Query Handler (Developer/System/Tenant)

---

### 11.4 Central de Funcionalidades (Auto-referência)

**IMPORTANTE**: Este RF **É** a Central de Funcionalidades, portanto ele **deve se registrar a si mesmo** no banco de dados.

**Registro esperado**:
- Código: `FF.SYS.CENTRAL_MODULOS`
- Nome: "Central de Módulos"
- Categoria: "Sistema"
- Rota: `/management/central-modulos`
- Permissão requerida: `central_modulos.view_any`

**Ações esperadas**:
- `CENTRAL_MODULOS.VIEW_ANY` (Listar funcionalidades)
- `CENTRAL_MODULOS.VIEW` (Visualizar funcionalidade)
- `CENTRAL_MODULOS.MANAGE_EXCLUSIVES` (Gerenciar empresas exclusivas)
- `CENTRAL_MODULOS.RESET` (Resetar funcionalidades)

---

## CHANGELOG

### v1.0 (2026-01-13)
- Versão inicial do RF-083
- Documentação baseada em análise de código existente
- 15 regras de negócio identificadas
- 6 endpoints da API documentados
- Modelo de dados completo (2 entidades)
- Integrações obrigatórias: i18n, auditoria, RBAC, auto-referência
- Estrutura de 11 seções conforme template
