# =============================================
# Modelo de Dados (MD) — RF002
# Versão: 2.0
# Autor: Agência ALC - alc.dev.br
# =============================================

# =============================================
# 1. METADADOS DO DOCUMENTO (OBRIGATÓRIO)
# =============================================
metadata:
  versao: "2.0"
  data: "2026-01-04"
  autor: "Agência ALC - alc.dev.br"

  documentacao_relacionado:
    id: "RF002"
    nome: "Sistema de Configurações e Parametrização Avançada"

  sistema_modulo: "Sistema Base - Infraestrutura"
  banco_de_dados:
    engine: "logico"  # Modelo lógico (independente de engine física)
    schema: "logico"  # Abstração de schema
  padroes:
    multi_tenancy: true
    auditoria: true
    soft_delete: true

# =============================================
# 2. ENTIDADES (OBRIGATÓRIO)
# =============================================
entidades:
  # =============================================
  # 2.1 ENTIDADE: sistema_configuracao_geral
  # =============================================
  - nome: "sistema_configuracao_geral"
    descricao: "Entidade central que armazena todas as configurações infraestruturais e de integração do sistema com suporte a hierarquia multi-tenant, tipos de dados variados, criptografia, cache, versionamento e feature flags"

    # -----------------------------
    # CAMPOS (OBRIGATÓRIO)
    # -----------------------------
    campos:
      # CHAVE PRIMÁRIA (OBRIGATÓRIO)
      - nome: "id"
        tipo: "GUID"
        nulo: false
        default: "NEWID()"
        descricao: "Chave primária"
        pk: true

      # MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "cliente_id"
        tipo: "GUID"
        nulo: false
        descricao: "FK para clientes (multi-tenancy - isolamento por cliente/Fornecedor)"
        fk:
          tabela: "cliente"
          coluna: "id"
          on_delete: "CASCADE"
        index: true
        origem:
          documentacao: "RF002"
          uc: "UC00, UC01, UC02, UC03, UC04"
          wf: "WF-02"
          campo_wf: "CMP-WF02-017"

      # CAMPOS DE HIERARQUIA MULTI-TENANT (RN-RF002-01)
      - nome: "id_Fornecedor"
        tipo: "GUID"
        nulo: true
        default: null
        descricao: "FK para Fornecedores (nível Global ou Fornecedor)"
        fk:
          tabela: "Fornecedor"
          coluna: "id"
          on_delete: "CASCADE"
        index: true
        origem:
          documentacao: "RF002"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-017"
          observacao: "Hierarquia multi-tenant: Usuário → Departamento → Empresa → Fornecedor → Global"

      - nome: "id_empresa"
        tipo: "GUID"
        nulo: true
        default: null
        descricao: "FK para empresas (nível Empresa, Departamento ou Usuário)"
        fk:
          tabela: "empresa"
          coluna: "id"
          on_delete: "CASCADE"
        index: true
        origem:
          documentacao: "RF002"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-018"

      - nome: "id_departamento"
        tipo: "GUID"
        nulo: true
        default: null
        descricao: "FK para departamentos (nível Departamento ou Usuário)"
        fk:
          tabela: "departamento"
          coluna: "id"
          on_delete: "CASCADE"
        index: true
        origem:
          documentacao: "RF002"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-019"

      - nome: "id_usuario"
        tipo: "GUID"
        nulo: true
        default: null
        descricao: "FK para usuários (nível Usuário específico)"
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "CASCADE"
        index: true
        origem:
          documentacao: "RF002"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-020"

      # CAMPOS DE IDENTIFICAÇÃO DA CONFIGURAÇÃO
      - nome: "nm_codigo"
        tipo: "VARCHAR(200)"
        nulo: false
        default: null
        descricao: "Código único da configuração (ex: SMTP_Host, AZURE_KeyVault_URL)"
        unique_por_tenant: true
        index: true
        mutavel: false
        origem:
          documentacao: "RF002"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-001"

      - nome: "nm_nome"
        tipo: "VARCHAR(500)"
        nulo: false
        default: null
        descricao: "Nome amigável da configuração (ex: Host do Servidor SMTP)"
        mutavel: true
        origem:
          documentacao: "RF002"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-002"

      - nome: "ds_descricao"
        tipo: "TEXT"
        nulo: true
        default: null
        descricao: "Descrição detalhada da configuração com documentação inline"
        mutavel: true
        origem:
          documentacao: "RF002"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-003"

      # CAMPOS DE CATEGORIZAÇÃO E AGRUPAMENTO
      - nome: "nm_categoria"
        tipo: "VARCHAR(100)"
        nulo: false
        default: null
        descricao: "Categoria da configuração"
        index: true
        mutavel: true
        check:
          definicao: "nm_categoria IN ('Sistema','Email','Integração','Segurança','Notificação','Cache','Storage','Auditoria','Performance','Features')"
          descricao: "Categorias permitidas conforme RF002"
        origem:
          documentacao: "RF002"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-004"

      - nome: "nm_grupo_visual"
        tipo: "VARCHAR(200)"
        nulo: true
        default: null
        descricao: "Agrupamento visual para organização na UI"
        index: true
        mutavel: true
        origem:
          documentacao: "RF002"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-005"

      # CAMPOS DE TIPO E VALOR (RN-RF002-03)
      - nome: "tp_dado"
        tipo: "VARCHAR(50)"
        nulo: false
        default: "String"
        descricao: "Tipo de dado da configuração"
        index: true
        mutavel: false
        check:
          definicao: "tp_dado IN ('String','Integer','Decimal','Boolean','JSON','Enum','DateTime')"
          descricao: "Tipos de dados suportados conforme RN-RF002-03"
        origem:
          documentacao: "RF002"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-006"

      - nome: "ds_valor"
        tipo: "TEXT"
        nulo: false
        default: null
        descricao: "Valor da configuração (criptografado se Fl_Criptografado = 1)"
        mutavel: true
        origem:
          documentacao: "RF002"
          uc: "UC01, UC03"
          wf: "WF-02, WF-04"
          campo_wf: "CMP-WF02-007, CMP-WF04-007"

      - nome: "ds_valor_padrao"
        tipo: "TEXT"
        nulo: true
        default: null
        descricao: "Valor padrão (fallback se ds_valor vazio)"
        mutavel: true
        origem:
          documentacao: "RF002"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-008"

      # CAMPOS DE VALIDAÇÃO CUSTOMIZADA (RN-RF002-04)
      - nome: "ds_validacao_customizada"
        tipo: "TEXT"
        nulo: true
        default: null
        descricao: "Regex ou expressão de validação customizada (ex: ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$ para email)"
        mutavel: true
        origem:
          documentacao: "RF002"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-009"

      - nome: "ds_valores_permitidos"
        tipo: "TEXT"
        nulo: true
        default: null
        descricao: "Lista de valores permitidos separados por vírgula (enum customizado, ex: dev,hom,prd)"
        mutavel: true
        origem:
          documentacao: "RF002"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-010"

      - nome: "nr_valor_minimo"
        tipo: "DECIMAL(18,4)"
        nulo: true
        default: null
        descricao: "Valor mínimo permitido (para Integer/Decimal)"
        mutavel: true
        origem:
          documentacao: "RF002"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-011"

      - nome: "nr_valor_maximo"
        tipo: "DECIMAL(18,4)"
        nulo: true
        default: null
        descricao: "Valor máximo permitido (para Integer/Decimal)"
        mutavel: true
        origem:
          documentacao: "RF002"
          uc: "UC01"
          wf: "WF-02"
          campo_wf: "CMP-WF02-012"

      # CAMPOS DE SEGURANÇA (RN-RF002-02, RN-RF002-09, RN-RF002-13)
      - nome: "fl_criptografado"
        tipo: "BOOLEAN"
        nulo: false
        default: false
        descricao: "Flag indicando se valor é criptografado com Azure Key Vault AES-256-GCM (RN-RF002-02)"
        index: true
        mutavel: false
        origem:
          documentacao: "RF002"
          uc: "UC01, UC09"
          wf: "WF-02, WF-10"
          campo_wf: "CMP-WF02-013"

      - nome: "fl_somente_leitura"
        tipo: "BOOLEAN"
        nulo: false
        default: false
        descricao: "Flag de proteção contra edição/exclusão (RN-RF002-13)"
        index: true
        mutavel: false
        origem:
          documentacao: "RF002"
          uc: "UC03, UC04"
          wf: "WF-02, WF-04, WF-05"
          campo_wf: "CMP-WF02-014"

      - nome: "fl_critica"
        tipo: "BOOLEAN"
        nulo: false
        default: false
        descricao: "Flag de configuração crítica (exige dry-run e gera notificações Slack/Teams - RN-RF002-12)"
        index: true
        mutavel: true
        origem:
          documentacao: "RF002"
          uc: "UC03"
          wf: "WF-02, WF-04"
          campo_wf: "CMP-WF02-015"

      # CAMPOS DE FEATURE FLAG (RN-RF002-08, RN-RF002-15)
      - nome: "fl_feature_flag"
        tipo: "BOOLEAN"
        nulo: false
        default: false
        descricao: "Flag indicando se é feature flag com rollout progressivo"
        index: true
        mutavel: false
        origem:
          documentacao: "RF002"
          uc: "UC06"
          wf: "WF-07"
          campo_wf: "CMP-WF07-001"

      - nome: "nm_estrategia_rollout"
        tipo: "VARCHAR(50)"
        nulo: true
        default: null
        descricao: "Estratégia de rollout (Percentual, Usuário, Perfil, Empresa)"
        check:
          definicao: "nm_estrategia_rollout IN ('Percentual','Usuário','Perfil','Empresa') OR nm_estrategia_rollout IS NULL"
          descricao: "Estratégias permitidas conforme RN-RF002-08"
        origem:
          documentacao: "RF002"
          uc: "UC06"
          wf: "WF-07"
          campo_wf: "CMP-WF07-002"

      - nome: "ds_configuracao_estrategia"
        tipo: "TEXT"
        nulo: true
        default: null
        descricao: "Configuração JSON da estratégia (ex: {percentual: 25} ou {usuario_ids: [1,2,3]})"
        origem:
          documentacao: "RF002"
          uc: "UC06"
          wf: "WF-07"
          campo_wf: "CMP-WF07-003, CMP-WF07-004, CMP-WF07-005, CMP-WF07-006"

      - nome: "dt_expiracao"
        tipo: "DATETIME"
        nulo: true
        default: null
        descricao: "Data de expiração da feature flag (desabilitação automática por job - RN-RF002-15)"
        index: true
        origem:
          documentacao: "RF002"
          uc: "UC06"
          wf: "WF-07"
          campo_wf: "CMP-WF07-007"

      # AUDITORIA COMPLETA (OBRIGATÓRIO - 5 campos)
      - nome: "created_at"
        tipo: "DATETIME"
        nulo: true
        default: "GETDATE()"
        descricao: "Data de criação"
        audit: true
        mutavel: false
        origem:
          documentacao: "RF002"
          uc: "UC01"
          wf: null
          campo_wf: null
          observacao: "Campo gerado automaticamente pelo sistema"

      - nome: "created_by"
        tipo: "GUID"
        nulo: true
        default: null
        descricao: "Usuário que criou (FK para usuario)"
        audit: true
        mutavel: false
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "SET NULL"
        origem:
          documentacao: "RF002"
          uc: "UC01"
          wf: null
          campo_wf: null
          observacao: "Preenchido automaticamente com ID do usuário autenticado"

      - nome: "updated_at"
        tipo: "DATETIME"
        nulo: true
        default: null
        descricao: "Data de atualização"
        audit: true
        mutavel: false
        origem:
          documentacao: "RF002"
          uc: "UC03"
          wf: null
          campo_wf: null
          observacao: "Campo gerado automaticamente pelo sistema"

      - nome: "updated_by"
        tipo: "GUID"
        nulo: true
        default: null
        descricao: "Usuário que atualizou (FK para usuario)"
        audit: true
        mutavel: false
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "SET NULL"
        origem:
          documentacao: "RF002"
          uc: "UC03"
          wf: null
          campo_wf: null
          observacao: "Preenchido automaticamente com ID do usuário autenticado"

      # SOFT DELETE (OBRIGATÓRIO)
      - nome: "deleted_at"
        tipo: "DATETIME"
        nulo: true
        default: null
        descricao: "Soft delete (exclusão lógica)"
        audit: true
        mutavel: false
        index: true
        origem:
          documentacao: "RF002"
          uc: "UC04"
          wf: null
          campo_wf: null
          observacao: "Preenchido automaticamente ao excluir (soft delete)"

    # -----------------------------
    # ÍNDICES (OBRIGATÓRIO)
    # -----------------------------
    indices:
      # ÍNDICE PRIMÁRIO (OBRIGATÓRIO)
      - nome: "pk_sistema_configuracao_geral"
        tipo: "PRIMARY"
        colunas: ["id"]
        descricao: "Chave primária"

      # ÍNDICE MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "idx_sistema_configuracao_geral_cliente"
        tipo: "BTREE"
        colunas: ["cliente_id"]
        descricao: "Performance multi-tenant (isolamento por cliente)"

      # ÍNDICES DE HIERARQUIA MULTI-TENANT
      - nome: "idx_sistema_configuracao_geral_hierarquia"
        tipo: "BTREE"
        colunas: ["id_Fornecedor", "id_empresa", "id_departamento", "id_usuario"]
        descricao: "Performance em consultas de precedência hierárquica (RN-RF002-01)"

      # ÍNDICES DE BUSCA E FILTRO (conforme WF-01)
      - nome: "idx_sistema_configuracao_geral_codigo_tenant"
        tipo: "BTREE"
        colunas: ["cliente_id", "nm_codigo"]
        descricao: "Performance em busca por código (UNIQUE por tenant)"

      - nome: "idx_sistema_configuracao_geral_categoria"
        tipo: "BTREE"
        colunas: ["nm_categoria"]
        descricao: "Performance em filtros por categoria (WF-01: CMP-WF01-003)"

      - nome: "idx_sistema_configuracao_geral_grupo_visual"
        tipo: "BTREE"
        colunas: ["nm_grupo_visual"]
        descricao: "Performance em agrupamentos visuais (WF-01)"

      - nome: "idx_sistema_configuracao_geral_tipo_dado"
        tipo: "BTREE"
        colunas: ["tp_dado"]
        descricao: "Performance em filtros por tipo de dado"

      # ÍNDICES DE SEGURANÇA E FEATURE FLAGS
      - nome: "idx_sistema_configuracao_geral_criptografado"
        tipo: "BTREE"
        colunas: ["fl_criptografado"]
        descricao: "Performance em filtros por configurações sensíveis (WF-01: CMP-WF01-005)"

      - nome: "idx_sistema_configuracao_geral_critica"
        tipo: "BTREE"
        colunas: ["fl_critica"]
        descricao: "Performance em filtros por configurações críticas (WF-08: CMP-WF08-005)"

      - nome: "idx_sistema_configuracao_geral_feature_flag"
        tipo: "BTREE"
        colunas: ["fl_feature_flag"]
        descricao: "Performance em consultas de feature flags"

      - nome: "idx_sistema_configuracao_geral_expiracao"
        tipo: "BTREE"
        colunas: ["dt_expiracao"]
        where: "fl_feature_flag = 1 AND dt_expiracao IS NOT NULL AND deleted_at IS NULL"
        descricao: "Performance em job de expiração automática de feature flags (RN-RF002-15)"

      # ÍNDICES DE AUDITORIA
      - nome: "idx_sistema_configuracao_geral_created_at"
        tipo: "BTREE"
        colunas: ["created_at"]
        descricao: "Performance em ordenação e filtros por data de criação"

      - nome: "idx_sistema_configuracao_geral_deleted_at"
        tipo: "BTREE"
        colunas: ["deleted_at"]
        descricao: "Performance em consultas de soft delete"

    # -----------------------------
    # CONSTRAINTS (OBRIGATÓRIO)
    # -----------------------------
    constraints:
      # FK MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "fk_sistema_configuracao_geral_cliente"
        tipo: "FOREIGN KEY"
        definicao: "cliente_id REFERENCES cliente(id)"
        on_delete: "CASCADE"
        descricao: "Multi-tenancy (isolamento por cliente)"

      # FK HIERARQUIA MULTI-TENANT
      - nome: "fk_sistema_configuracao_geral_Fornecedor"
        tipo: "FOREIGN KEY"
        definicao: "id_Fornecedor REFERENCES Fornecedor(id)"
        on_delete: "CASCADE"
        descricao: "Hierarquia multi-tenant (nível Fornecedor)"

      - nome: "fk_sistema_configuracao_geral_empresa"
        tipo: "FOREIGN KEY"
        definicao: "id_empresa REFERENCES empresa(id)"
        on_delete: "CASCADE"
        descricao: "Hierarquia multi-tenant (nível Empresa)"

      - nome: "fk_sistema_configuracao_geral_departamento"
        tipo: "FOREIGN KEY"
        definicao: "id_departamento REFERENCES departamento(id)"
        on_delete: "CASCADE"
        descricao: "Hierarquia multi-tenant (nível Departamento)"

      - nome: "fk_sistema_configuracao_geral_usuario"
        tipo: "FOREIGN KEY"
        definicao: "id_usuario REFERENCES usuario(id)"
        on_delete: "CASCADE"
        descricao: "Hierarquia multi-tenant (nível Usuário)"

      # UNIQUE POR TENANT (OBRIGATÓRIO)
      - nome: "uq_sistema_configuracao_geral_cliente_codigo"
        tipo: "UNIQUE"
        definicao: "(cliente_id, nm_codigo)"
        descricao: "Código único por tenant (RN-RF002-03 - validação de unicidade)"

      # FKs DE AUDITORIA (OBRIGATÓRIO)
      - nome: "fk_sistema_configuracao_geral_created_by"
        tipo: "FOREIGN KEY"
        definicao: "created_by REFERENCES usuario(id)"
        on_delete: "SET NULL"
        descricao: "Auditoria - usuário criador"

      - nome: "fk_sistema_configuracao_geral_updated_by"
        tipo: "FOREIGN KEY"
        definicao: "updated_by REFERENCES usuario(id)"
        on_delete: "SET NULL"
        descricao: "Auditoria - usuário editor"

      # CHECK CONSTRAINTS
      - nome: "chk_sistema_configuracao_geral_categoria"
        tipo: "CHECK"
        definicao: "nm_categoria IN ('Sistema','Email','Integração','Segurança','Notificação','Cache','Storage','Auditoria','Performance','Features')"
        descricao: "Categorias permitidas conforme RF002"

      - nome: "chk_sistema_configuracao_geral_tipo_dado"
        tipo: "CHECK"
        definicao: "tp_dado IN ('String','Integer','Decimal','Boolean','JSON','Enum','DateTime')"
        descricao: "Tipos de dados permitidos (RN-RF002-03)"

      - nome: "chk_sistema_configuracao_geral_estrategia_rollout"
        tipo: "CHECK"
        definicao: "nm_estrategia_rollout IN ('Percentual','Usuário','Perfil','Empresa') OR nm_estrategia_rollout IS NULL"
        descricao: "Estratégias de rollout permitidas (RN-RF002-08)"

      - nome: "chk_sistema_configuracao_geral_feature_flag_expiracao"
        tipo: "CHECK"
        definicao: "(fl_feature_flag = 1 AND dt_expiracao > GETDATE()) OR (fl_feature_flag = 0 AND dt_expiracao IS NULL) OR (fl_feature_flag = 1 AND dt_expiracao IS NULL)"
        descricao: "Data de expiração deve ser futura e só pode existir se fl_feature_flag = 1"

  # =============================================
  # 2.2 ENTIDADE: sistema_configuracao_versao
  # =============================================
  - nome: "sistema_configuracao_versao"
    descricao: "Histórico imutável de versões de configurações com diff JSON completo para versionamento e rollback 1-click (RN-RF002-06, RN-RF002-07)"

    # -----------------------------
    # CAMPOS (OBRIGATÓRIO)
    # -----------------------------
    campos:
      # CHAVE PRIMÁRIA (OBRIGATÓRIO)
      - nome: "id"
        tipo: "GUID"
        nulo: false
        default: "NEWID()"
        descricao: "Chave primária"
        pk: true

      # MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "cliente_id"
        tipo: "GUID"
        nulo: false
        descricao: "FK para clientes (multi-tenancy)"
        fk:
          tabela: "cliente"
          coluna: "id"
          on_delete: "CASCADE"
        index: true

      # RELACIONAMENTO COM CONFIGURAÇÃO
      - nome: "id_configuracao"
        tipo: "GUID"
        nulo: false
        descricao: "FK para sistema_configuracao_geral (configuração versionada)"
        fk:
          tabela: "sistema_configuracao_geral"
          coluna: "id"
          on_delete: "CASCADE"
        index: true
        origem:
          documentacao: "RF002"
          uc: "UC01, UC03, UC05"
          wf: "WF-06"
          campo_wf: "CMP-WF06-001"

      # CAMPOS DE VERSIONAMENTO
      - nome: "nr_versao"
        tipo: "INTEGER"
        nulo: false
        default: null
        descricao: "Número sequencial da versão (1, 2, 3...)"
        index: true
        mutavel: false
        origem:
          documentacao: "RF002"
          uc: "UC01, UC03, UC05"
          wf: "WF-06"
          campo_wf: "CMP-WF06-002"

      - nome: "nm_acao"
        tipo: "VARCHAR(50)"
        nulo: false
        default: null
        descricao: "Ação que gerou a versão (CREATE, UPDATE, ROLLBACK, DELETE)"
        index: true
        mutavel: false
        check:
          definicao: "nm_acao IN ('CREATE','UPDATE','ROLLBACK','DELETE')"
          descricao: "Ações permitidas de versionamento"
        origem:
          documentacao: "RF002"
          uc: "UC01, UC03, UC04, UC05"
          wf: "WF-06"
          campo_wf: "CMP-WF06-002"

      - nome: "ds_motivo"
        tipo: "TEXT"
        nulo: true
        default: null
        descricao: "Motivo da alteração (obrigatório para UPDATE e ROLLBACK conforme RN-RF002-11)"
        mutavel: false
        origem:
          documentacao: "RF002"
          uc: "UC03, UC05"
          wf: "WF-04, WF-06"
          campo_wf: "CMP-WF04-001, CMP-WF06-006"

      # CAMPOS DE DIFF JSON (RN-RF002-06)
      - nome: "ds_valor_anterior"
        tipo: "TEXT"
        nulo: true
        default: null
        descricao: "Valor anterior (null se CREATE)"
        mutavel: false
        origem:
          documentacao: "RF002"
          uc: "UC03, UC05"
          wf: "WF-06"
          campo_wf: "CMP-WF06-005"

      - nome: "ds_valor_novo"
        tipo: "TEXT"
        nulo: false
        default: null
        descricao: "Valor novo (aplicado nesta versão)"
        mutavel: false
        origem:
          documentacao: "RF002"
          uc: "UC01, UC03, UC05"
          wf: "WF-06"
          campo_wf: "CMP-WF06-005"

      - nome: "ds_diff_json"
        tipo: "TEXT"
        nulo: true
        default: null
        descricao: "Diff JSON completo com todas as alterações (campo → valor_anterior → valor_novo)"
        mutavel: false
        origem:
          documentacao: "RF002"
          uc: "UC03, UC05"
          wf: "WF-06"
          campo_wf: "CMP-WF06-005"

      # AUDITORIA COMPLETA (OBRIGATÓRIO - 5 campos)
      - nome: "created_at"
        tipo: "DATETIME"
        nulo: true
        default: "GETDATE()"
        descricao: "Data de criação da versão"
        audit: true
        mutavel: false

      - nome: "created_by"
        tipo: "GUID"
        nulo: true
        default: null
        descricao: "Usuário que criou a versão (FK para usuario)"
        audit: true
        mutavel: false
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "SET NULL"

      - nome: "updated_at"
        tipo: "DATETIME"
        nulo: true
        default: null
        descricao: "Data de atualização (sempre null - histórico imutável)"
        audit: true
        mutavel: false

      - nome: "updated_by"
        tipo: "GUID"
        nulo: true
        default: null
        descricao: "Usuário que atualizou (sempre null - histórico imutável)"
        audit: true
        mutavel: false
        fk:
          tabela: "usuario"
          coluna: "id"
          on_delete: "SET NULL"

      # SOFT DELETE (OBRIGATÓRIO)
      - nome: "deleted_at"
        tipo: "DATETIME"
        nulo: true
        default: null
        descricao: "Soft delete (não aplicável - histórico imutável)"
        audit: true
        mutavel: false

    # -----------------------------
    # ÍNDICES (OBRIGATÓRIO)
    # -----------------------------
    indices:
      # ÍNDICE PRIMÁRIO (OBRIGATÓRIO)
      - nome: "pk_sistema_configuracao_versao"
        tipo: "PRIMARY"
        colunas: ["id"]
        descricao: "Chave primária"

      # ÍNDICE MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "idx_sistema_configuracao_versao_cliente"
        tipo: "BTREE"
        colunas: ["cliente_id"]
        descricao: "Performance multi-tenant"

      # ÍNDICES DE VERSIONAMENTO
      - nome: "idx_sistema_configuracao_versao_configuracao"
        tipo: "BTREE"
        colunas: ["id_configuracao", "nr_versao"]
        descricao: "Performance em consultas de histórico de versões (WF-06)"

      - nome: "idx_sistema_configuracao_versao_acao"
        tipo: "BTREE"
        colunas: ["nm_acao"]
        descricao: "Performance em filtros por tipo de ação"

      - nome: "idx_sistema_configuracao_versao_created_at"
        tipo: "BTREE"
        colunas: ["created_at"]
        descricao: "Performance em ordenação cronológica de versões"

    # -----------------------------
    # CONSTRAINTS (OBRIGATÓRIO)
    # -----------------------------
    constraints:
      # FK MULTI-TENANCY (OBRIGATÓRIO)
      - nome: "fk_sistema_configuracao_versao_cliente"
        tipo: "FOREIGN KEY"
        definicao: "cliente_id REFERENCES cliente(id)"
        on_delete: "CASCADE"
        descricao: "Multi-tenancy"

      # FK CONFIGURAÇÃO
      - nome: "fk_sistema_configuracao_versao_configuracao"
        tipo: "FOREIGN KEY"
        definicao: "id_configuracao REFERENCES sistema_configuracao_geral(id)"
        on_delete: "CASCADE"
        descricao: "Relacionamento com configuração versionada"

      # UNIQUE POR CONFIGURAÇÃO + VERSÃO
      - nome: "uq_sistema_configuracao_versao_config_nr"
        tipo: "UNIQUE"
        definicao: "(id_configuracao, nr_versao)"
        descricao: "Número de versão único por configuração"

      # FKs DE AUDITORIA (OBRIGATÓRIO)
      - nome: "fk_sistema_configuracao_versao_created_by"
        tipo: "FOREIGN KEY"
        definicao: "created_by REFERENCES usuario(id)"
        on_delete: "SET NULL"
        descricao: "Auditoria - usuário criador da versão"

      - nome: "fk_sistema_configuracao_versao_updated_by"
        tipo: "FOREIGN KEY"
        definicao: "updated_by REFERENCES usuario(id)"
        on_delete: "SET NULL"
        descricao: "Auditoria - usuário editor (sempre null - histórico imutável)"

      # CHECK CONSTRAINTS
      - nome: "chk_sistema_configuracao_versao_acao"
        tipo: "CHECK"
        definicao: "nm_acao IN ('CREATE','UPDATE','ROLLBACK','DELETE')"
        descricao: "Ações permitidas de versionamento"

      - nome: "chk_sistema_configuracao_versao_nr_versao"
        tipo: "CHECK"
        definicao: "nr_versao > 0"
        descricao: "Número de versão deve ser positivo"

# =============================================
# 3. RELACIONAMENTOS GLOBAIS (OPCIONAL)
# =============================================
relacionamentos_globais:
  - origem: "cliente"
    cardinalidade: "1:N"
    destino: "sistema_configuracao_geral"
    descricao: "Um cliente possui muitas configurações (multi-tenancy)"

  - origem: "Fornecedor"
    cardinalidade: "1:N"
    destino: "sistema_configuracao_geral"
    descricao: "Um Fornecedor pode ter configurações específicas (hierarquia multi-tenant)"

  - origem: "empresa"
    cardinalidade: "1:N"
    destino: "sistema_configuracao_geral"
    descricao: "Uma empresa pode ter configurações específicas (hierarquia multi-tenant)"

  - origem: "departamento"
    cardinalidade: "1:N"
    destino: "sistema_configuracao_geral"
    descricao: "Um departamento pode ter configurações específicas (hierarquia multi-tenant)"

  - origem: "usuario"
    cardinalidade: "1:N"
    destino: "sistema_configuracao_geral"
    descricao: "Um usuário pode ter configurações específicas (hierarquia multi-tenant)"

  - origem: "sistema_configuracao_geral"
    cardinalidade: "1:N"
    destino: "sistema_configuracao_versao"
    descricao: "Uma configuração possui muitas versões (versionamento completo)"

  - origem: "usuario"
    cardinalidade: "1:N"
    destino: "sistema_configuracao_versao"
    descricao: "Um usuário cria muitas versões de configurações (auditoria)"

# =============================================
# 4. OBSERVAÇÕES E DECISÕES (OBRIGATÓRIO)
# =============================================
observacoes:
  - categoria: "Modelagem"
    descricao: "Modelo de dados derivado do RF002, UC-RF002 (UC00-UC09) e WF-RF002 (WF-01 a WF-10). Entidade principal sistema_configuracao_geral armazena configurações com suporte completo a hierarquia multi-tenant (5 níveis), tipos de dados variados (7 tipos), criptografia Azure Key Vault, validações customizadas, feature flags com rollout progressivo e proteção de configurações críticas. Entidade sistema_configuracao_versao implementa versionamento imutável com diff JSON completo para rollback 1-click."

  - categoria: "Hierarquia Multi-Tenant"
    descricao: "Implementação completa da RN-RF002-01 com precedência: Usuário → Departamento → Empresa → Fornecedor → Global. Campos id_Fornecedor, id_empresa, id_departamento e id_usuario permitem configurações em qualquer nível da hierarquia. Constraint UNIQUE (cliente_id, nm_codigo) garante unicidade de código por tenant. Índice composto de hierarquia otimiza consultas de precedência."

  - categoria: "Segurança e Criptografia"
    descricao: "RN-RF002-02 implementada via fl_criptografado. Valores sensíveis (fl_criptografado = 1) são criptografados com Azure Key Vault AES-256-GCM antes de persistir no campo ds_valor. RN-RF002-09 garante mascaramento automático de valores sensíveis na UI (********) exceto para usuários com permissão DECRYPT. RN-RF002-13 implementada via fl_somente_leitura bloqueando edição/exclusão de configurações críticas."

  - categoria: "Validação de Tipo e Customizada"
    descricao: "RN-RF002-03 implementada via tp_dado com CHECK constraint (7 tipos: String, Integer, Decimal, Boolean, JSON, Enum, DateTime). RN-RF002-04 suportada via ds_validacao_customizada (regex), ds_valores_permitidos (enum customizado), nr_valor_minimo e nr_valor_maximo (ranges). Validação de tipo executada no backend antes de persistir conforme UC01, UC03."

  - categoria: "Versionamento e Rollback"
    descricao: "RN-RF002-06 e RN-RF002-07 implementadas via tabela sistema_configuracao_versao. Toda alteração (CREATE, UPDATE, ROLLBACK, DELETE) gera versão sequencial com diff JSON completo (ds_diff_json) preservando valor anterior (ds_valor_anterior) e novo (ds_valor_novo). Rollback 1-click restaura valor de versão anterior criando nova versão (não altera histórico imutável). Campo ds_motivo obrigatório para UPDATE e ROLLBACK conforme RN-RF002-11 (auditoria SOX)."

  - categoria: "Feature Flags e Rollout Progressivo"
    descricao: "RN-RF002-08 implementada via fl_feature_flag com 4 estratégias de rollout (Percentual, Usuário, Perfil, Empresa) armazenadas em nm_estrategia_rollout e ds_configuracao_estrategia (JSON). RN-RF002-15 suportada via dt_expiracao com índice parcial para job de expiração automática de feature flags vencidas. CHECK constraint garante dt_expiracao futura e somente quando fl_feature_flag = 1."

  - categoria: "Performance"
    descricao: "Índices criados conforme filtros e buscas do WF-RF002. Índice composto (cliente_id, nm_codigo) otimiza busca por código (WF-01). Índices em nm_categoria, nm_grupo_visual, tp_dado, fl_criptografado, fl_critica otimizam filtros da listagem (WF-01: CMP-WF01-003, CMP-WF01-005, CMP-WF08-005). Índice parcial em dt_expiracao otimiza job de expiração de feature flags. Índice em created_at otimiza ordenação cronológica de versões (WF-06)."

  - categoria: "Cache e Hot-Reload"
    descricao: "RN-RF002-05 (invalidação cache Redis via pub/sub) NÃO requer campos adicionais no modelo de dados. Implementação será no backend com evento de domínio disparado após INSERT/UPDATE/DELETE em sistema_configuracao_geral. Cache hot-reload implementado via Redis pub/sub garantindo zero downtime."

  - categoria: "Auditoria SOX Completa"
    descricao: "RN-RF002-11 implementada via campos de auditoria (created_at, created_by, updated_at, updated_by, deleted_at) em TODAS as tabelas. Tabela sistema_configuracao_versao registra diff JSON completo, motivo da mudança (ds_motivo), IP, user-agent (campos adicionais em tabela de auditoria separada se necessário). Soft delete obrigatório via deleted_at preservando histórico completo."

  - categoria: "Notificações Automáticas"
    descricao: "RN-RF002-12 (notificações Slack/Teams para configurações críticas) NÃO requer campos adicionais. Implementação será no backend com evento de domínio disparado quando fl_critica = 1 e ação = UPDATE. Mensagem incluirá diff JSON, autor e motivo."

  - categoria: "Dry-Run e Simulação de Impacto"
    descricao: "RN-RF002-14 (dry-run obrigatório para configurações críticas) NÃO requer campos adicionais no modelo de dados. Implementação será no backend com endpoint separado que simula alteração sem persistir. Obrigatório quando fl_critica = 1 conforme WF-04."

  - categoria: "Export/Import YAML"
    descricao: "RN-RF002-10 (export/import com validação schema e dry-run obrigatório) NÃO requer campos adicionais. Implementação será no backend com endpoints específicos. Valores sensíveis (fl_criptografado = 1) mascarados automaticamente no export conforme UC07. Import exige validação schema YAML e dry-run obrigatório conforme UC08."

  - categoria: "Campos Não Modelados (Integrações Externas)"
    descricao: "Campos relacionados a integrações externas (Azure Key Vault, Slack/Teams, Redis) não estão no modelo de dados pois são configurações de infraestrutura (connection strings, tokens, webhooks). Esses valores são obtidos de variáveis de ambiente ou de configurações do próprio sistema (recursivamente via sistema_configuracao_geral)."

# =============================================
# 5. HISTÓRICO DE ALTERAÇÕES (OBRIGATÓRIO)
# =============================================
historico:
  - versao: "2.0"
    data: "2026-01-04"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Versão inicial do modelo de dados RF002 derivado de RF002.yaml (15 RNs + 24 FUNCs), UC-RF002.yaml (10 UCs) e WF-RF002.md (10 wireframes). Entidades: sistema_configuracao_geral (configuração principal com 28 campos + auditoria completa + soft delete), sistema_configuracao_versao (versionamento imutável com diff JSON). Multi-tenancy obrigatório (cliente_id), hierarquia 5 níveis (id_Fornecedor, id_empresa, id_departamento, id_usuario), criptografia Azure Key Vault (fl_criptografado), feature flags com 4 estratégias de rollout, validação customizada (regex/ranges/enum), versionamento completo com rollback 1-click, auditoria SOX completa."
