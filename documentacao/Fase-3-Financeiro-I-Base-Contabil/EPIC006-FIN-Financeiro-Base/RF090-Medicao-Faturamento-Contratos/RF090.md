# RF-090: Medição e Faturamento de Contratos

**Versão**: 2.0
**Data**: 2025-12-31
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC006-FIN-Financeiro-Base
**Fase**: Fase 3 - Financeiro I - Base Contábil

---

## 1. OBJETIVO DO REQUISITO

Especificar o comportamento do **módulo de Medição e Faturamento de Contratos** do sistema IControlIT, responsável pela gestão completa do ciclo de medições de consumo/serviços prestados vinculados a contratos comerciais, cálculo automático de valores faturáveis, aplicação de reajustes contratuais, rateio entre centros de custo, geração de faturas, gest glosas de valores contestados e rastreamento imutável de toda operação para conformidade fiscal e contábil.

Este documento serve como **contrato oficial** entre negócio, desenvolvimento, testes e agentes de IA, definindo **o que o sistema deve fazer**, sob quais condições e quais garantias devem ser preservadas, sem especificar implementação técnica.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Criação de medições de consumo/serviços (fixa, variável, híbrida)
- [x] Atualização de medições em status permitidos
- [x] Listagem de medições com filtros (período, contrato, status)
- [x] Exclusão lógica de medições não faturadas
- [x] Cálculo automático de valores faturáveis por tipo de medição
- [x] Aplicação automática de reajustes econômicos (IGPM, IPCA, percentual)
- [x] Rateio proporcional entre centros de custo/filiais
- [x] Workflow de aprovação (Rascunho → Pendente → Aprovada → Faturada)
- [x] Geração automática de faturas após aprovação
- [x] Gestão de glosas (contestações) com análise e decisão
- [x] Validações de período sem sobreposição ou gaps
- [x] Controle de acesso e isolamento multi-tenant
- [x] Auditoria de operações com retenção 7 anos
- [x] Relatórios de faturamento e dashboard gerencial

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica ou layout
- Tecnologia, framework ou linguagem de implementação
- Estratégia de deploy ou infraestrutura
- Geração física de notas fiscais XML (responsabilidade RF032)
- Integração direta com ERPs (responsabilidade RF078)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Medição** | Registro de consumo/serviço prestado em período específico vinculado a um contrato |
| **Período de Medição** | Intervalo temporal (geralmente mês) para o qual consumo é registrado |
| **Tipo de Medição** | Categoria: Fixa (valor pré-determinado), Variável (baseada em consumo), Híbrida (base + consumo) |
| **Valor Faturável** | Valor total calculado a ser faturado, após reajustes e rateios |
| **Reajuste Contratual** | Aumento automático de valores conforme índice econômico na data de aniversário |
| **Rateio** | Distribuição de valor entre filiais/centros de custo conforme percentuais |
| **Glosa** | Contestação de valor faturado proposta pelo cliente com análise de justificativa |
| **Tenant** | Cliente/empresa contratante (multi-tenant row-level isolation) |
| **Estado/Status** | Situação atual da medição no workflow (Rascunho, Pendente, Aprovada, Faturada, Glosa) |

---

## 4. FUNCIONALIDADES COBERTAS

1. **CRUD Completo de Medições** - Criar, editar, consultar, excluir lógico com validações de período
2. **Tipos de Medição Variáveis** - Suporte a Fixa, Variável e Híbrida com cálculos automáticos
3. **Validação de Períodos** - Sem sobreposição, sem gaps, dentro da vigência do contrato
4. **Cálculo Automático de Valores** - Aplicação de valor base + reajustes + adicionais
5. **Reajustes Econômicos** - Automáticos por IGPM, IPCA ou percentual em data de aniversário
6. **Rateio Proporcional** - Distribuição entre filiais/centros de custo (soma = 100%)
7. **Workflow de Aprovação** - Medidor → Gestor → Financeiro com transições validadas
8. **Geração de Faturas** - Integração automática com RF032 após aprovação
9. **Gestão de Glosas** - Análise de contestações com registro e decisão
10. **Relatórios de Faturamento** - Por período, contrato, fornecedor com exportação
11. **Dashboard de Medições** - Visão em tempo real de pendentes, aprovadas, faturadas
12. **Notificações de Vencimento** - Alertas para medições próximas do vencimento
13. **Auditoria Imutável** - Criação, alteração, aprovação, cancelamento rastreados
14. **Integração com ERP** - Exportação de lançamento contábil (via RF078)
15. **Histórico Completo** - Versioning de medições, reajustes, rateios

---

## 5. REGRAS DE NEGÓCIO

### RN-RF090-001 — Validação de Período de Medição

**Descrição**: Todo período de medição deve estar dentro da vigência do contrato associado.

**Critério de Aceite**:
- Data de início do período não pode ser anterior ao DataInicio do contrato
- Data de fim do período não pode ser posterior ao DataFim do contrato
- Validação ocorre antes de persistência
- Rejeição com HTTP 400 se período inválido

**Justificativa**: Prevenir medições fora do período contratual que resultariam em faturamento indevido.

---

### RN-RF090-002 — Validação de Sobreposição de Períodos

**Descrição**: Não é permitido criar medições com períodos sobrepostos para o mesmo contrato.

**Critério de Aceite**:
- Períodos devem ser sequenciais sem lacunas (gaps)
- Períodos não podem sobrepor parcial ou totalmente
- Validação verifica medições existentes antes de criar nova
- Rejeição com HTTP 400 se sobreposição detectada

**Justificativa**: Evitar faturamento duplicado e garantir integridade histórica.

---

### RN-RF090-003 — Cálculo de Valor Faturável por Tipo

**Descrição**: Valor faturável calculado conforme tipo:
- **Fixa**: ValorFixo
- **Variável**: Quantidade × ValorUnitario
- **Híbrida**: ValorFixo + (Quantidade × ValorUnitario)

**Critério de Aceite**:
- Cálculo automático ao criar/atualizar medição
- Campos obrigatórios por tipo validados
- Tipo Fixa exige ValorFixo
- Tipo Variável exige Quantidade e ValorUnitario
- Tipo Híbrida exige todos os campos

**Justificativa**: Aplicar corretamente tipo de medição conforme contrato.

---

### RN-RF090-004 — Aplicação de Reajuste Contratual

**Descrição**: Reajustes automáticos aplicados em data de aniversário conforme índice configurado.

**Critério de Aceite**:
- Suporta índices: IGPM, IPCA, INPC, Percentual Fixo
- Aplica somente em medições não aprovadas ainda
- Cria registro em histórico de reajustes
- Registra valor anterior, valor novo, índice, percentual
- Execução via job automático diário

**Justificativa**: Automatizar reajustes, eliminar erros manuais, garantir conformidade com índices oficiais.

---

### RN-RF090-005 — Rateio Proporcional

**Descrição**: Medições podem ser rateadas entre múltiplos centros de custo com percentual definido.

**Critério de Aceite**:
- Soma de percentuais deve ser exatamente 100% (tolerância 0,01%)
- Cada centro de custo recebe valor proporcional
- Rateio registrado em entidade separada vinculada à medição
- Validação impede rateio desequilibrado

**Justificativa**: Distribuir custos apropriadamente entre responsáveis.

---

### RN-RF090-006 — Validação de Integração com Contrato

**Descrição**: Toda medição deve estar vinculada a contrato válido (FK obrigatória).

**Critério de Aceite**:
- Contrato deve existir e não estar excluído logicamente
- Contrato deve estar em status Ativo
- Contrato deve estar dentro da vigência
- Validação antes de criar medição

**Justificativa**: Garantir integridade referencial e rastreabilidade.

---

### RN-RF090-007 — Workflow de Aprovação

**Descrição**: Medições seguem state machine com 5 estados e transições validadas.

**Estados**:
- Rascunho
- PendenteAprovacao
- Aprovada
- Faturada
- Glosa

**Transições Permitidas**:
| De | Para | Permissão Exigida |
|----|------|-------------------|
| Rascunho | PendenteAprovacao | med:create |
| PendenteAprovacao | Aprovada | med:approve |
| Aprovada | Faturada | med:invoice |
| Faturada | Glosa | med:dispute |
| Glosa | Aprovada | med:dispute |

**Critério de Aceite**:
- Transições inválidas são rejeitadas
- Cada transição registrada em auditoria com usuário e timestamp
- Permissões validadas antes de transição

**Justificativa**: Garantir controle de qualidade e segregação de funções.

---

### RN-RF090-008 — Geração Automática de Fatura

**Descrição**: Após aprovação, job automático cria nota fiscal via RF032.

**Critério de Aceite**:
- Job executa a cada hora
- Busca medições em status Aprovada
- Cria nota fiscal via integração RF032
- Vincula NotaFiscalId na medição
- Transiciona para status Faturada
- Em caso de erro, medição permanece Aprovada e log é gerado

**Justificativa**: Automatizar geração de faturas, eliminar delay manual.

---

### RN-RF090-009 — Gestão de Glosa

**Descrição**: Cliente pode contestar fatura com glosa (percentual + justificativa).

**Critério de Aceite**:
- Glosa somente permitida para medições Faturadas
- Percentual entre 0% e 100%
- Justificativa obrigatória (máx 500 caracteres)
- Cria entidade Glosa em status PendenteAnalise
- Transiciona medição para status Glosa
- Gestor analisa e aprova/rejeita
- Se aprovada, gera nota fiscal de ajuste (crédito)

**Justificativa**: Permitir questionamento justo, manter transparência.

---

### RN-RF090-010 — Auditoria Imutável

**Descrição**: Toda operação registrada em tabela de auditoria com retenção 7 anos.

**Critério de Aceite**:
- Registro de: timestamp UTC, usuário, IP, operação, valores antes/depois (JSON), hash SHA-256
- Operações auditadas: criação, atualização, aprovação, cancelamento, glosa, reajuste, rateio
- Tabela append-only (sem UPDATE/DELETE)
- Retenção obrigatória 7 anos (LGPD)

**Justificativa**: Conformidade regulatória, rastreabilidade, detecção de alterações.

---

## 6. ESTADOS DA ENTIDADE

### Estados de Medição

| Estado | Descrição |
|--------|-----------|
| **Rascunho** | Criada, editável, aguardando submissão |
| **PendenteAprovacao** | Submetida, aguardando aprovação de gestor |
| **Aprovada** | Aprovada por gestor, elegível para faturação |
| **Faturada** | Nota fiscal gerada, não editável |
| **Glosa** | Contestada pelo cliente, em análise |

### Transições Permitidas

| De | Para |
|----|------|
| Rascunho | PendenteAprovacao |
| PendenteAprovacao | Aprovada |
| PendenteAprovacao | Rascunho (rejeição) |
| Aprovada | Faturada |
| Faturada | Glosa |
| Glosa | Aprovada (após decisão) |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando Ocorre |
|--------|---------------|
| medicao.criada | Após criação de medição em status Rascunho |
| medicao.submetida | Transição de Rascunho → PendenteAprovacao |
| medicao.aprovada | Transição de PendenteAprovacao → Aprovada |
| medicao.faturada | Após geração de nota fiscal e transição para Faturada |
| medicao.glosa_registrada | Quando cliente registra contestação |
| medicao.glosa_decidida | Após gestor aprovar/rejeitar glosa |
| medicao.reajuste_aplicado | Após aplicação de reajuste econômico |
| medicao.rateio_aplicado | Após distribuição entre centros de custo |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- [ ] Nenhuma operação pode violar isolamento de tenant (ClienteId filtrado sempre)
- [ ] Nenhuma regra de negócio pode ser ignorada (validações obrigatórias)
- [ ] Erros devem ser previsíveis e rastreáveis (códigos HTTP + mensagens i18n)
- [ ] Auditoria deve registrar quem, quando e o que mudou (100% cobertura)
- [ ] Períodos sem sobreposição e sem gaps (validação automática)
- [ ] Workflow de aprovação respeita permissões (RBAC)
- [ ] Geração de faturas é automática e rastreável (job Hangfire)
- [ ] Reajustes aplicados corretamente conforme índices oficiais
- [ ] Rateio sempre soma 100% (validação de equilíbrio)
- [ ] Glosas analisadas e decididas (não ficam pendentes indefinidamente)

---

## 9. SEGURANÇA

### 9.1 Proteções Obrigatórias

- **Multi-tenancy Row-Level**: Query Filter automático por ClienteId
- **Soft Delete**: Exclusão lógica com FlExcluido=true, dados preservados
- **Validação de Entrada**: Todos os campos validados contra tipo, range, formato
- **Proteção contra Injeção**: Sanitização de inputs (Justificativa, Observações)
- **RBAC Granular**: Permissões `med:*` validadas em middleware
- **State Machine**: Transições inválidas rejeitadas
- **Auditoria Hash**: SHA-256 detecta alterações pós-fato
- **Retenção LGPD**: Dados de auditoria retidos 7 anos
- **Integração Validada**: FK com RF023 (Contratos) e RF032 (Notas Fiscais)

### 9.2 Permissões RBAC

| Permissão | Descrição | Perfis Autorizados |
|-----------|-----------|-------------------|
| `med:create` | Criar medição | Medidor, Gestor Financeiro, Admin |
| `med:read` | Visualizar medição | Medidor, Gestor Financeiro, Gestor Contrato, Financeiro, Admin |
| `med:update` | Editar medição | Medidor (se Rascunho), Gestor Financeiro, Admin |
| `med:delete` | Excluir medição | Admin apenas |
| `med:approve` | Aprovar medição | Gestor Financeiro, Diretor Financeiro, Admin |
| `med:invoice` | Marcar como faturada | Financeiro, Admin |
| `med:dispute` | Registrar/analisar glosa | Gestor Financeiro, Cliente, Admin |
| `med:adjustment` | Aplicar reajuste manual | Admin apenas (automático via job) |
| `med:export` | Exportar relatório | Gestor Financeiro, Admin, Executivo |
| `med:allocate` | Configurar rateio | Gestor Financeiro, Admin |

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF090.md** - Casos de Uso (mínimo 5):
  - UC00-Listar Medições
  - UC01-Criar Medição
  - UC02-Aprovar Medição
  - UC03-Faturar Medição
  - UC04-Gerenciar Glosa

- **MD-RF090.md** - Modelo de Dados:
  - Entidade Medicao
  - Entidade RegistroRateio
  - Entidade Glosa
  - Entidade HistoricoReajuste

- **WF-RF090.md** - Workflows:
  - Fluxo de Medição até Faturação
  - Fluxo de Reajuste Automático
  - Fluxo de Glosa

- **MT-RF090.yaml** - Massas de Teste
- **TC-RF090-BACKEND.yaml** - Casos de Teste Backend
- **TC-RF090-FRONTEND.yaml** - Casos de Teste Frontend
- **TC-RF090-E2E.yaml** - Casos de Teste E2E

---

## 11. RASTREABILIDADE

### 11.1 Dependências Upstream (RF que este RF depende)

| RF | Descrição | Justificativa |
|----|-----------|---------------|
| RF023 | Gestão de Contratos | FK obrigatória - medição vinculada a contrato |
| RF032 | Notas Fiscais | Geração automática de faturas após aprovação |

### 11.2 Dependências Downstream (RF que dependem deste)

| RF | Descrição | Justificativa |
|----|-----------|---------------|
| RF078 | Integrações ERPs | Exportação de lançamento contábil |
| RF089 | Conciliação Fiscal | Análise de faturas geradas via medições |
| RF034 | Contas a Receber | Saldo atualizado com faturas de medições |
| RF035 | Contas a Pagar | Gestão de créditos de glosas aprovadas |

### 11.3 Integrações Obrigatórias

- **Central de Funcionalidades (Feature Flags)**: Controle de features `MEDICAO_*`
- **i18n (Transloco)**: Chaves de tradução `medicao.*` em pt-BR/en/es
- **Auditoria**: Tabela AuditoriaMedicao com retenção 7 anos
- **RBAC**: Permissões `med:*` integradas com RF013 (Perfis de Acesso)

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-31 | Migração v1.0 → v2.0 - Separação RF/RL. Contrato funcional moderno sem referências ao legado. 11 seções, 10 regras de negócio em linguagem natural, integrações obrigatórias, eventos de domínio, segurança RBAC, auditoria LGPD. | Agência ALC - alc.dev.br |
| 1.0 | 2025-12-28 | Versão inicial com 9 seções, regras de negócio com código, referências ao legado misturadas | IControlIT - Equipe de Arquitetura |
