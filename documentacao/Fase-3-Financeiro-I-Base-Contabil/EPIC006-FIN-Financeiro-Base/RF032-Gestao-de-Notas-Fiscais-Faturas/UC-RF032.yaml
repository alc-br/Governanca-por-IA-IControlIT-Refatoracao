# =============================================
# UC - Casos de Uso RF032 (Gestão de Notas Fiscais e Faturas)
# Versão: 2.0
# Autor: Agência ALC - alc.dev.br
# Data: 2025-12-31
# =============================================

uc:
  documentacao: "RF032"
  versao: "2.0"
  data: "2025-12-31"

casos_de_uso:

  - id: "UC00"
    nome: "Listar Notas Fiscais"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      documentacao_items:
        - "RF-CRUD-02"
      uc_items:
        - id: "FP-UC00-001"
          title: "Usuário acessa funcionalidade Notas Fiscais"
          required: true
        - id: "FP-UC00-002"
          title: "Sistema valida permissão fin:notasfiscais:read"
          required: true
        - id: "FP-UC00-003"
          title: "Sistema carrega notas do tenant (FornecedorId)"
          required: true
        - id: "FP-UC00-004"
          title: "Sistema aplica paginação (50 registros/página)"
          required: true
        - id: "FP-UC00-005"
          title: "Sistema exibe lista"
          required: true
        - id: "FA-UC00-001"
          title: "Filtrar por período (data emissão/entrada)"
          required: false
        - id: "FA-UC00-002"
          title: "Filtrar por status"
          required: false
        - id: "FA-UC00-003"
          title: "Filtrar por emitente (CNPJ)"
          required: false
        - id: "FA-UC00-004"
          title: "Filtrar por chave de acesso"
          required: false
        - id: "FA-UC00-005"
          title: "Ordenar por coluna"
          required: false
        - id: "FA-UC00-006"
          title: "Exportar para Excel/CSV"
          required: false
        - id: "FE-UC00-001"
          title: "Usuário sem permissão → HTTP 403"
          required: true
        - id: "FE-UC00-002"
          title: "Nenhuma nota cadastrada → estado vazio"
          required: true

    precondicoes:
      - permissao: "fin:notasfiscais:read"

    gatilho: "Usuário acessa menu Notas Fiscais"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessa_menu_notas_fiscais"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "listar_notas_tenant"
      - passo: 4
        ator: "sistema"
        acao: "exibir_lista_paginada"

    fluxos_alternativos:
      - id: "FA-UC00-01"
        condicao: "usuario_aplica_filtro"
        resultado: "lista_filtrada"
      - id: "FA-UC00-02"
        condicao: "usuario_exporta"
        resultado: "arquivo_gerado"

    fluxos_excecao:
      - id: "FE-UC00-01"
        condicao: "sem_permissao"
        resultado: "http_403"
      - id: "FE-UC00-02"
        condicao: "sem_registros"
        resultado: "estado_vazio"

    regras_aplicadas:
      - "RN-NFE-032-01"
      - "RN-NFE-032-08"

    resultado_final:
      estado: "lista_exibida"

  - id: "UC01"
    nome: "Importar Nota Fiscal (XML/DANFE/CSV)"
    ator_principal: "usuario_autenticado"
    tipo: "crud"
    impacta_dados: true

    covers:
      documentacao_items:
        - "RF-CRUD-01"
        - "RF-VAL-01"
        - "RF-VAL-02"
        - "RF-VAL-03"
        - "RF-FUNC-02"
        - "RF-FUNC-08"
        - "RF-FUNC-10"
      uc_items:
        - id: "FP-UC01-001"
          title: "Usuário seleciona arquivo (XML/PDF/CSV)"
          required: true
        - id: "FP-UC01-002"
          title: "Sistema valida permissão"
          required: true
        - id: "FP-UC01-003"
          title: "Sistema valida formato do arquivo"
          required: true
        - id: "FP-UC01-004"
          title: "Sistema valida estrutura XML (schema XSD 4.00 SEFAZ)"
          required: true
        - id: "FP-UC01-005"
          title: "Sistema extrai metadados"
          required: true
        - id: "FP-UC01-006"
          title: "Sistema valida chave de acesso (44 dígitos, unicidade)"
          required: true
        - id: "FP-UC01-007"
          title: "Sistema salva XML/DANFE em Azure Blob Storage"
          required: true
        - id: "FP-UC01-008"
          title: "Sistema cria registro NotaFiscal com FornecedorId"
          required: true
        - id: "FP-UC01-009"
          title: "Sistema agenda validação de assinatura (UC03)"
          required: true
        - id: "FP-UC01-010"
          title: "Sistema registra auditoria"
          required: true
        - id: "FP-UC01-011"
          title: "Sistema confirma sucesso"
          required: true
        - id: "FA-UC01-001"
          title: "Importar lote de XMLs"
          required: false
        - id: "FA-UC01-002"
          title: "Importar DANFE PDF → OCR"
          required: false
        - id: "FA-UC01-003"
          title: "Importar CSV → download SEFAZ"
          required: false
        - id: "FE-UC01-001"
          title: "Estrutura XML inválida → HTTP 400"
          required: true
        - id: "FE-UC01-002"
          title: "Chave duplicada → HTTP 409"
          required: true
        - id: "FE-UC01-003"
          title: "Assinatura inválida → HTTP 422"
          required: true
        - id: "FE-UC01-004"
          title: "CNPJ inválido → HTTP 400"
          required: true
        - id: "FE-UC01-005"
          title: "Arquivo corrompido → HTTP 400"
          required: true
        - id: "FE-UC01-006"
          title: "OCR falhou → HTTP 422"
          required: true

    precondicoes:
      - permissao: "fin:notasfiscais:importar"

    gatilho: "Usuário clica em 'Importar Nota Fiscal'"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "seleciona_arquivo"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "validar_formato"
      - passo: 4
        ator: "sistema"
        acao: "validar_estrutura_xml"
      - passo: 5
        ator: "sistema"
        acao: "extrair_metadados"
      - passo: 6
        ator: "sistema"
        acao: "salvar_blob_storage"
      - passo: 7
        ator: "sistema"
        acao: "criar_registro_nfe"
      - passo: 8
        ator: "sistema"
        acao: "agendar_validacao_assinatura"
      - passo: 9
        ator: "sistema"
        acao: "registrar_auditoria"

    fluxos_excecao:
      - id: "FE-UC01-01"
        condicao: "validacao_falhou"
        resultado: "exibir_erros_400"
      - id: "FE-UC01-02"
        condicao: "chave_duplicada"
        resultado: "http_409"

    regras_aplicadas:
      - "RN-NFE-032-01"
      - "RN-NFE-032-02"
      - "RN-NFE-032-08"
      - "RN-NFE-032-09"
      - "RN-NFE-032-10"

    resultado_final:
      estado: "nota_importada"

  - id: "UC02"
    nome: "Visualizar Nota Fiscal"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      documentacao_items:
        - "RF-CRUD-03"
      uc_items:
        - id: "FP-UC02-001"
          title: "Usuário seleciona nota na listagem"
          required: true
        - id: "FP-UC02-002"
          title: "Sistema valida permissão"
          required: true
        - id: "FP-UC02-003"
          title: "Sistema valida tenant (FornecedorId)"
          required: true
        - id: "FP-UC02-004"
          title: "Sistema carrega dados completos"
          required: true
        - id: "FP-UC02-005"
          title: "Sistema carrega divergências (se houver)"
          required: true
        - id: "FP-UC02-006"
          title: "Sistema carrega histórico de aprovações"
          required: true
        - id: "FP-UC02-007"
          title: "Sistema carrega rateios (se houver)"
          required: true
        - id: "FP-UC02-008"
          title: "Sistema exibe dados formatados"
          required: true
        - id: "FA-UC02-001"
          title: "Download XML original"
          required: false
        - id: "FA-UC02-002"
          title: "Download DANFE PDF"
          required: false
        - id: "FA-UC02-003"
          title: "Visualizar pedido vinculado"
          required: false
        - id: "FA-UC02-004"
          title: "Visualizar organograma de rateio"
          required: false
        - id: "FA-UC02-005"
          title: "Consultar status SEFAZ"
          required: false
        - id: "FE-UC02-001"
          title: "Nota não encontrada → HTTP 404"
          required: true
        - id: "FE-UC02-002"
          title: "Nota de outro tenant → HTTP 404"
          required: true
        - id: "FE-UC02-003"
          title: "Erro SEFAZ → exibir último status"
          required: true

    precondicoes:
      - permissao: "fin:notasfiscais:read"

    gatilho: "Usuário clica em nota na listagem"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "seleciona_nota"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "validar_tenant"
      - passo: 4
        ator: "sistema"
        acao: "carregar_dados_completos"
      - passo: 5
        ator: "sistema"
        acao: "exibir_detalhes"

    fluxos_excecao:
      - id: "FE-UC02-01"
        condicao: "nota_nao_encontrada"
        resultado: "http_404"
      - id: "FE-UC02-02"
        condicao: "nota_outro_tenant"
        resultado: "http_404"

    regras_aplicadas:
      - "RN-NFE-032-03"
      - "RN-NFE-032-05"

    resultado_final:
      estado: "detalhes_exibidos"

  - id: "UC03"
    nome: "Validar Assinatura Digital"
    ator_principal: "sistema"
    tipo: "validacao"
    impacta_dados: true

    covers:
      documentacao_items:
        - "RF-VAL-02"
        - "RF-SEC-04"
      uc_items:
        - id: "FP-UC03-001"
          title: "Sistema agenda validação (job assíncrono)"
          required: true
        - id: "FP-UC03-002"
          title: "Sistema baixa XML de Azure Blob Storage"
          required: true
        - id: "FP-UC03-003"
          title: "Sistema extrai certificado digital"
          required: true
        - id: "FP-UC03-004"
          title: "Sistema valida certificado ICP-Brasil"
          required: true
        - id: "FP-UC03-005"
          title: "Sistema verifica assinatura RSA-2048 SHA-256"
          required: true
        - id: "FP-UC03-006"
          title: "Sistema valida cadeia de certificação"
          required: true
        - id: "FP-UC03-007"
          title: "Sistema atualiza status"
          required: true
        - id: "FP-UC03-008"
          title: "Sistema registra auditoria"
          required: true
        - id: "FP-UC03-009"
          title: "Sistema agenda consulta SEFAZ"
          required: true
        - id: "FA-UC03-001"
          title: "Validação manual (se job falhar)"
          required: false
        - id: "FE-UC03-001"
          title: "Certificado expirado → rejeitada"
          required: true
        - id: "FE-UC03-002"
          title: "Assinatura corrompida → rejeitada"
          required: true
        - id: "FE-UC03-003"
          title: "Cadeia inválida → rejeitada"
          required: true
        - id: "FE-UC03-004"
          title: "Não é ICP-Brasil → rejeitada"
          required: true

    precondicoes:
      - nota_importada: true

    gatilho: "Sistema após importação"

    fluxo_principal:
      - passo: 1
        ator: "sistema"
        acao: "agendar_validacao_job"
      - passo: 2
        ator: "sistema"
        acao: "baixar_xml_blob"
      - passo: 3
        ator: "sistema"
        acao: "extrair_certificado"
      - passo: 4
        ator: "sistema"
        acao: "validar_certificado_icp_brasil"
      - passo: 5
        ator: "sistema"
        acao: "verificar_assinatura_rsa_2048"
      - passo: 6
        ator: "sistema"
        acao: "atualizar_status"
      - passo: 7
        ator: "sistema"
        acao: "registrar_auditoria"

    fluxos_excecao:
      - id: "FE-UC03-01"
        condicao: "certificado_expirado"
        resultado: "status_rejeitada"

    regras_aplicadas:
      - "RN-NFE-032-02"

    resultado_final:
      estado: "assinatura_validada"

  - id: "UC04"
    nome: "Conciliar Nota Fiscal com Pedido"
    ator_principal: "usuario_autenticado"
    tipo: "regra_negocio"
    impacta_dados: true

    covers:
      documentacao_items:
        - "RF-FUNC-04"
        - "RF-FUNC-05"
        - "RF-FUNC-06"
      uc_items:
        - id: "FP-UC04-001"
          title: "Usuário solicita conciliação manual OU sistema executa automático"
          required: true
        - id: "FP-UC04-002"
          title: "Sistema valida permissão"
          required: true
        - id: "FP-UC04-003"
          title: "Sistema localiza pedido vinculado (RF026)"
          required: true
        - id: "FP-UC04-004"
          title: "Sistema compara valores"
          required: true
        - id: "FP-UC04-005"
          title: "Sistema compara metadados (CFOP, NCM, CST)"
          required: true
        - id: "FP-UC04-006"
          title: "Sistema calcula divergência percentual"
          required: true
        - id: "FP-UC04-007"
          title: "Sistema classifica divergência"
          required: true
        - id: "FP-UC04-008"
          title: "Sistema atualiza status"
          required: true
        - id: "FP-UC04-009"
          title: "Sistema registra auditoria"
          required: true
        - id: "FA-UC04-001"
          title: "Divergência <1% → auto-ajuste"
          required: false
        - id: "FA-UC04-002"
          title: "Divergência 1-5% → warning"
          required: false
        - id: "FA-UC04-003"
          title: "Divergência >5% → workflow"
          required: false
        - id: "FE-UC04-001"
          title: "Pedido não encontrado → HTTP 404"
          required: true
        - id: "FE-UC04-002"
          title: "Pedido de outro tenant → HTTP 403"
          required: true
        - id: "FE-UC04-003"
          title: "Divergência crítica não aprovada → bloqueada"
          required: true

    precondicoes:
      - permissao: "fin:notasfiscais:conciliar"
      - assinatura_validada: true
      - autorizada_sefaz: true

    gatilho: "Usuário clica em 'Conciliar' OU sistema automático"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "solicita_conciliacao"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "localizar_pedido"
      - passo: 4
        ator: "sistema"
        acao: "comparar_valores"
      - passo: 5
        ator: "sistema"
        acao: "calcular_divergencia"
      - passo: 6
        ator: "sistema"
        acao: "classificar_divergencia"
      - passo: 7
        ator: "sistema"
        acao: "atualizar_status"
      - passo: 8
        ator: "sistema"
        acao: "registrar_auditoria"

    fluxos_alternativos:
      - id: "FA-UC04-01"
        condicao: "divergencia_menor_1_porcento"
        resultado: "auto_ajuste"
      - id: "FA-UC04-02"
        condicao: "divergencia_1_5_porcento"
        resultado: "warning"
      - id: "FA-UC04-03"
        condicao: "divergencia_maior_5_porcento"
        resultado: "workflow_aprovacao"

    fluxos_excecao:
      - id: "FE-UC04-01"
        condicao: "pedido_nao_encontrado"
        resultado: "http_404"
      - id: "FE-UC04-02"
        condicao: "pedido_outro_tenant"
        resultado: "http_403"
      - id: "FE-UC04-03"
        condicao: "divergencia_critica_nao_aprovada"
        resultado: "status_bloqueada"

    regras_aplicadas:
      - "RN-NFE-032-04"
      - "RN-NFE-032-06"

    resultado_final:
      estado: "conciliada_ou_divergente"

exclusions:
  uc_items: []

historico:
  - versao: "2.0"
    data: "2025-12-31"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Versão completa - UC canônicos UC00-UC04 para RF032"
  - versao: "1.0"
    data: "2025-01-14"
    autor: "Architect Agent"
    descricao: "Versão stub incompleta"
