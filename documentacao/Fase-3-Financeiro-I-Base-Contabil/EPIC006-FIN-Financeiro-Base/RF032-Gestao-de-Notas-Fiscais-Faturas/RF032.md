# RF032: Gestão de Notas Fiscais e Faturas

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC006-FIN-Financeiro-Base
**Fase**: Fase 3 - Financeiro I (Base Contábil)

---

## 1. OBJETIVO DO REQUISITO

O **RF032 - Gestão de Notas Fiscais e Faturas** implementa o módulo responsável pela **gestão completa do ciclo de vida de Notas Fiscais Eletrônicas (NF-e)** no sistema IControlIT. Este requisito é crítico para conformidade fiscal, rastreabilidade de custos, auditoria contábil e integração com órgãos fazendários brasileiros.

O módulo permite a importação, validação, armazenamento, processamento, conciliação e auditoria de notas fiscais de entrada (compras) e saída (vendas), com suporte a múltiplas formas de aquisição: upload de XML, integração com SEFAZ, OCR de DANFE em PDF, e importação em lote via CSV.

A solução implementa validações criptográficas de assinatura digital (certificado A1/A3), consulta de status junto à SEFAZ, extração automática de metadados (emitente, destinatário, impostos, CFOP, NCM), cálculo de tributos federais e estaduais, detecção de divergências com pedidos e contratos, e geração de relatórios fiscais para conformidade SPED, DCTF e auditoria externa (SOX/LGPD).

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Importação de Notas Fiscais Eletrônicas (NF-e) via XML
- [x] Integração com SEFAZ para consulta de status de NF-e
- [x] OCR de DANFE em PDF quando XML indisponível
- [x] Importação em lote via CSV
- [x] Validação de assinatura digital (RSA-2048 com SHA-256)
- [x] Validação de estrutura XML contra schema XSD 4.00 da SEFAZ
- [x] Extração automática de metadados (emitente, destinatário, itens, impostos)
- [x] Cálculo automático de impostos (ICMS, IPI, PIS, COFINS, ISS, IRRF, CSLL, INSS)
- [x] Conciliação automática NF-e vs Pedido (RF026)
- [x] Detecção de divergências (quantidade, valor, CFOP, NCM, impostos)
- [x] Rateio de notas entre filiais e centros de custo
- [x] Fluxo de aprovação multi-nível para divergências críticas
- [x] Armazenamento permanente em Azure Blob Storage (7 anos LGPD)
- [x] Geração de relatórios fiscais (SPED, DCTF, Livro Registro)
- [x] Dashboard de monitoramento e indicadores fiscais
- [x] Auditoria completa de todas operações
- [x] Controle de acesso RBAC granular
- [x] Internacionalização (pt-BR, en-US, es-ES)
- [x] Multi-tenancy com isolamento por Fornecedor

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (responsabilidade do frontend)
- Tecnologia, framework ou linguagem específicos
- Layout, UX ou identidade visual
- Estratégia de deploy ou infraestrutura
- Emissão de notas fiscais (apenas gestão de NF recebidas/emitidas)
- Integração com sistemas contábeis de terceiros (exceto exportação de dados)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-----|---------|
| **Nota Fiscal Eletrônica (NF-e)** | Documento fiscal digital emitido em formato XML, assinado digitalmente e autorizado pela Secretaria da Fazenda estadual. Estrutura padrão ABNT NBR ISO/IEC 27001 com certificação digital. |
| **DANFE** | Documento Auxiliar da NF-e. Representação em papel da NF-e, contendo código QR, código de barras e chave de acesso de 44 caracteres. |
| **Chave de Acesso** | Identificador único de 44 dígitos gerado a partir de hash SHA-1 dos dados essenciais da NF-e. Formato: UF(2) + AAMM(4) + CNPJ(8) + MOD(1) + SERIE(3) + NUMERO(9) + DV(1) + CVNFE(16). |
| **SEFAZ** | Sistema Eletrônico de Facturação. Serviço federal que autoriza, rejeita ou nega protocolo para NF-e. Cada UF possui instância própria. |
| **Certificado Digital (A1/A3)** | Comprovação criptográfica da identidade da empresa. A1: arquivo .pfx (12 meses), A3: smartcard/token (3 anos). Algoritmo RSA-2048, hash SHA-256, padrão ICP-Brasil. |
| **CFOP** | Código Fiscal de Operação. Classifica natureza da operação fiscal (venda, devolução, transferência). 4 dígitos: 1000-1999 (entrada), 5000-5999 (saída). |
| **NCM** | Nomenclatura Comum do MERCOSUL. Código de 8 dígitos que classifica produtos para tributação e comércio exterior. Determina alíquota de ICMS, IPI, PIS, COFINS. |
| **Substituição Tributária (ST)** | Regime onde um contribuinte substitui outro na obrigação de recolhimento de ICMS. Operações com ST não geram ICMS próprio no destinatário. |
| **Retenções de Impostos** | Descontos obrigatórios: IRRF (1,5%-25%), CSLL (1%), INSS (11%), ISS (2%-5% por município). |
| **Divergência Fiscal** | Descrepância entre dados da NF-e e pedido/contrato. Pode ser: quantidade diferente, valor diferente, CFOP inconsistente, NCM faltante, impostos incorretos. |
| **Tenant** | Unidade lógica de isolamento de dados (Fornecedor) |
| **Operação** | Ação executável sobre notas fiscais (importar, validar, conciliar, ratear, aprovar, cancelar) |

---

## 4. FUNCIONALIDADES COBERTAS

1. Importar Nota Fiscal (XML, DANFE PDF, lote CSV)
2. Validar estrutura XML contra schema SEFAZ
3. Validar assinatura digital (RSA-2048 com SHA-256)
4. Consultar status na SEFAZ (autorizada, rejeitada, cancelada)
5. Extrair metadados automaticamente (emitente, itens, impostos)
6. Calcular impostos (ICMS, IPI, PIS, COFINS, ISS, retenções)
7. Conciliar NF-e com Pedido (RF026) automaticamente
8. Detectar e classificar divergências (crítica, importante, menor)
9. Aprovar/rejeitar divergências com workflow multi-nível
10. Ratear nota entre filiais e centros de custo
11. Armazenar XML e DANFE em Azure Blob Storage
12. Gerar relatórios fiscais (SPED, DCTF, Livro Registro)
13. Monitorar KPIs e alertas críticos
14. Exportar dados para sistemas contábeis

---

## 5. REGRAS DE NEGÓCIO

### RN-NFE-032-01: Importação de NF-e com Validação de Estrutura XML

**Descrição**: Toda nota fiscal importada deve ter sua estrutura XML validada contra o schema XSD 4.00 da SEFAZ antes de ser persistida em banco de dados.

**Justificativa**: Evita corrupção de dados através de XML malformado ou compatível com versão antiga da NF-e. O schema XSD garante conformidade com padrão federal.

**Critério de Aceite**:
- XML inválido → rejeição com mensagem de erro detalhada
- XML válido → extração de metadados e persistência
- Validação contra schema XSD 4.00 obrigatória
- Encoding UTF-8 obrigatório

**Exemplos**:
- ✅ XML válido com estrutura completa, emitente e destinatário preenchidos
- ❌ XML com tags faltantes (ex: falta bloco de valores)
- ❌ XML com encoding incorreto (ex: ASCII em vez de UTF-8)
- ❌ XML de versão 3.10 em vez de 4.00

---

### RN-NFE-032-02: Validação de Assinatura Digital (RSA-2048 com SHA-256)

**Descrição**: A assinatura digital da NF-e deve ser validada usando algoritmo RSA-2048 com hash SHA-256 antes de qualquer processamento.

**Justificativa**: Garante autenticidade e integridade da nota fiscal. Detecta falsificações ou alterações pós-assinatura.

**Critério de Aceite**:
- Assinatura válida → processamento continua
- Assinatura inválida → rejeição com erro criptográfico
- Certificado expirado → rejeição
- Certificado não reconhecido como ICP-Brasil → rejeição

**Exemplos**:
- ✅ Assinatura válida, certificado não expirado, data correta
- ❌ Assinatura inválida (XML alterado após assinatura)
- ❌ Certificado expirado
- ❌ Certificado não reconhecido como ICP-Brasil

---

### RN-NFE-032-03: Consulta Automática de Status na SEFAZ

**Descrição**: Ao importar NF-e, o sistema deve consultar o status junto à SEFAZ (autorizada, rejeitada, cancelada, cancelamento autorizado) e registrar resultado no banco.

**Justificativa**: Evita processamento de notas rejeitadas ou canceladas. Garante que nota processada foi efectivamente autorizada pela fazenda estadual.

**Critério de Aceite**:
- Status autorizada → processamento continua
- Status rejeitada → registro de motivo, bloqueio de pagamento
- Status cancelada → registro de data cancelamento
- Timeout SEFAZ (>30s) → retry automático até 10 tentativas
- Após 10 tentativas → status "AguardandoConfirmacao"

**Exemplos**:
- ✅ NF-e autorizada pela SEFAZ-SP com protocolo válido
- ❌ NF-e rejeitada por CFOP inválido
- ❌ NF-e cancelada (cancelamento autorizado)
- ❌ Timeout na consulta (sem resposta em 30 segundos)

---

### RN-NFE-032-04: Detecção de Divergências entre NF-e e Pedido

**Descrição**: Ao conciliar NF-e com pedido (RF026), o sistema deve detectar divergências em: quantidade, valor total, CFOP, NCM, impostos calculados. Divergências menores (<1%) são automaticamente ajustadas; maiores requerem aprovação.

**Justificativa**: Evita lançamentos contábeis incorretos. Detecta erros de digitação do fornecedor ou alterações fraudulentas.

**Critério de Aceite**:
- Divergência < 1% → auto-ajusta silenciosamente
- Divergência 1%-5% → marcação como "importante", sugere aprovação
- Divergência > 5% → marcação como "crítica", bloqueia pagamento até aprovação
- Item na NF mas não no pedido → divergência crítica

**Implementação**:
- Comparação de quantidade por item
- Comparação de valor total
- Validação de CFOP e NCM
- Validação de impostos calculados vs esperado

**Exemplos**:
- ✅ NF-e com 5 unidades, pedido com 5 unidades = sem divergência
- ❌ NF-e com 10 unidades, pedido com 12 unidades = divergência de quantidade (8% > 1%)
- ❌ NF-e com R$ 1.100, pedido com R$ 1.000 = divergência de valor (10% > 1%)
- ❌ NF-e com CFOP 5102, pedido com CFOP 5405 = divergência de CFOP

---

### RN-NFE-032-05: Cálculo Automático de Impostos (ICMS, IPI, PIS, COFINS, IRRF, CSLL, INSS)

**Descrição**: O sistema deve calcular automaticamente todos os impostos incidentes sobre a NF-e baseando-se em regras fiscais do CNAE, estado, município e regime tributário. Retenções obrigatórias (IRRF, CSLL, INSS) devem ser calculadas conforme legislação específica.

**Justificativa**: Evita erros de cálculo manual de impostos. Garante conformidade com legislação fiscal. Essencial para geração de relatórios SPED e DCTF.

**Critério de Aceite**:
- ICMS calculado conforme UF origem/destino e NCM
- IPI calculado conforme enquadramento fiscal
- PIS/COFINS calculados conforme regime tributário
- ISS calculado conforme lei municipal (se serviço)
- IRRF calculado conforme tipo de serviço (1,5%-25%)
- CSLL calculado 1% (Lei 13.172/2015)
- INSS calculado 11% (serviços PJ)
- Precisão mínima 99,99% (desvio máx 1 centavo)

**Exemplos**:
- ✅ Serviço com ICMS 7%, IPI 0%, PIS 1,65%, COFINS 7,6%, IRRF 1,5%, CSLL 1%, INSS 11%
- ❌ Cálculo manual sem validação de alíquotas = erro até 15%
- ✅ Produto substituição tributária: ICMS = 0%, mas ICMS-ST calculado na origem
- ✅ Serviço ISS por município: 2% a 5% conforme lei local

---

### RN-NFE-032-06: Bloqueio de Pagamento se Divergência Crítica não Aprovada

**Descrição**: Nenhuma nota fiscal com divergência crítica pode ser paga até que a divergência seja explicitamente aprovada por gerente autorizado. Sistema deve bloquear automaticamente no fluxo de pagamento.

**Justificativa**: Evita pagamento de notas com dados incorretos que podem gerar problemas contábeis posteriores.

**Critério de Aceite**:
- Nota com divergência crítica não aprovada → bloqueio automático
- Tentativa de pagamento → erro "NF_BLOQUEADA_DIVERGENCIA_CRITICA"
- Aprovação por gerente autorizado → desbloqueio
- Nota já paga → erro "NF_JA_PAGA"

**Implementação**:
- Validação em endpoint de pagamento
- Verificação de divergências críticas
- Verificação de status de aprovação
- Registro de tentativa em auditoria

---

### RN-NFE-032-07: Rateio Automático de Notas entre Filiais/Centros de Custo

**Descrição**: O sistema deve permitir rateio automático de valor total da NF-e entre múltiplas filiais e centros de custo conforme regras pré-configuradas (percentual fixo, volume, peso, contrato).

**Justificativa**: Permite alocação correta de custos em empresas com múltiplas filiais. Automatiza processo que antes era manual em planilhas.

**Critério de Aceite**:
- Soma de percentuais = 100% (tolerância 0,01%)
- Suporte a 4 tipos de rateio: percentual fixo, volume, peso, contrato
- Última regra ajustada automaticamente para totalizar 100%
- Validação de filiais/centros de custo existentes

**Tipos de Rateio**:
- **Percentual Fixo**: Definição manual (ex: 30% filial A, 70% filial B)
- **Por Volume**: Distribuição proporcional ao m³ consumido
- **Por Peso**: Distribuição proporcional ao kg transportado
- **Por Contrato**: Distribuição conforme cláusula contratual (RF023)

**Exemplos**:
- ✅ Rateio 30%-70% entre 2 filiais, total = 100%
- ❌ Rateio 30%-60% entre 2 filiais, total = 90% (erro)
- ✅ Rateio por volume: 1000m³ total, filial A consome 300m³ = 30%

---

### RN-NFE-032-08: Armazenamento Permanente de XML e DANFE em Azure Blob Storage

**Descrição**: O XML original e PDF DANFE da NF-e devem ser armazenados permanentemente em Azure Blob Storage com versionamento, segregação por Fornecedor, e conformidade com LGPD (retenção de 7 anos).

**Justificativa**: Azure oferece durabilidade de 99,9999999999%, conformidade com legislação, e gerenciamento automático de ciclo de vida. Libera espaço em disco do servidor.

**Critério de Aceite**:
- Container segregado por Fornecedor: `notas-fiscais-{FornecedorId}`
- Nomenclatura: `xml/{chaveAcesso}.xml`, `danfe/{chaveAcesso}.pdf`
- Metadados obrigatórios: ChaveAcesso, DataEmissao, CnpjEmitente, NotaFiscalId
- Política de retenção: 7 anos (2.555 dias)
- Versionamento habilitado
- URL registrada em banco de dados

**Implementação**:
- Upload assíncrono após validação
- Geração automática de DANFE PDF
- Configuração de lifecycle policy
- Registro de URLs em NotaFiscal.UriXmlBlob e UriDanfePdfBlob

---

### RN-NFE-032-09: OCR de DANFE em PDF quando XML Indisponível

**Descrição**: Se o XML não estiver disponível, o sistema pode fazer upload de DANFE em PDF e usar Azure Cognitive Services (Computer Vision) para extrair automaticamente dados de emitente, número nota, valores, impostos via OCR.

**Justificativa**: Permite integração de documentos importados manualmente ou de fornecedores que não disponibilizam XML. Fallback para casos de perda de arquivo.

**Critério de Aceite**:
- Extração de chave de acesso (44 dígitos) obrigatória
- Fallback para Tesseract se Azure falhar
- Confiança mínima de 70% para aceitação
- Dados extraídos: chave, número, série, CNPJ emitente, destinatário, valor total
- Falha em ambos OCR → erro "Importação manual necessária"

**Implementação**:
- Azure Cognitive Services (Computer Vision API) como primário
- Tesseract OCR como fallback
- Parser customizado para padrões de DANFE
- Regex para extração de chave de acesso (44 dígitos)

---

### RN-NFE-032-10: Auditoria Completa com Retenção de 7 Anos (LGPD Compliance)

**Descrição**: Todas as operações sobre notas fiscais devem ser auditadas com registro imutável contendo: usuário, timestamp, operação (import, validate, conciliate, cancel), dados antes/depois, e IP. Retenção por 7 anos.

**Justificativa**: Conformidade com LGPD (Lei Geral Proteção Dados), SOX (Sarbanes-Oxley), e legislação fiscal. Essencial para investigação de fraudes.

**Critério de Aceite**:
- 100% das operações auditadas
- Registro imutável (sem update/delete)
- Dados obrigatórios: usuário, timestamp, IP, operação, antes/depois
- Retenção: 7 anos (2.555 dias)
- Integração com RF004 (Auditoria)

**Operações Auditadas**:
- FIN_NOTAFISCAL_IMPORTA
- FIN_NOTAFISCAL_ASSINATURA
- FIN_NOTAFISCAL_CONSULT_SEFAZ
- FIN_NOTAFISCAL_CONCILIACAO
- FIN_NOTAFISCAL_RATEIO
- FIN_NOTAFISCAL_IMPOSTOS
- FIN_NOTAFISCAL_APROVACAO
- FIN_NOTAFISCAL_PAGTO
- FIN_NOTAFISCAL_CANCEL
- FIN_NOTAFISCAL_BLOB_STORE

---

## 6. ESTADOS DA ENTIDADE

| Estado | Descrição |
|------|-----------|
| **AguardandoProcessamento** | NF importada, aguardando validação |
| **Validando** | Em processo de validação de assinatura/estrutura |
| **AssinaturaValidada** | Assinatura digital confirmada |
| **Autorizada** | Confirmada pela SEFAZ como autorizada |
| **Rejeitada** | Rejeitada pela SEFAZ (motivo registrado) |
| **Cancelada** | Cancelada (por emitente ou destinatário) |
| **Conciliada** | Reconciliada com pedido sem divergências |
| **DivergenciaDetectada** | Divergências identificadas na conciliação |
| **AprovacaoPendente** | Aguardando aprovação de divergência crítica |
| **Rateiada** | Rateio configurado e validado |
| **ImpostosCalculados** | Todos impostos calculados automaticamente |
| **Pronta** | Pronta para pagamento |
| **Paga** | Pagamento realizado |
| **Bloqueada** | Bloqueada para pagamento (divergência não aprovada) |

### Transições permitidas

| De | Para |
|---|---|
| AguardandoProcessamento | Validando |
| Validando | AssinaturaValidada, Rejeitada |
| AssinaturaValidada | Autorizada, Cancelada |
| Autorizada | Conciliada, DivergenciaDetectada |
| DivergenciaDetectada | AprovacaoPendente |
| AprovacaoPendente | Conciliada, Bloqueada |
| Conciliada | Rateiada, ImpostosCalculados |
| Rateiada | ImpostosCalculados |
| ImpostosCalculados | Pronta |
| Pronta | Paga |

### Transições proibidas

| De | Para | Motivo |
|---|---|---|
| Paga | qualquer estado | Pagamento é irreversível |
| Cancelada | Autorizada | Cancelamento é definitivo |
| Rejeitada | Autorizada | Rejeição SEFAZ é definitiva |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre |
|------|--------------|
| **NotaFiscalImportada** | Após importação com sucesso |
| **AssinaturaValidada** | Após validação criptográfica com sucesso |
| **StatusSefazConsultado** | Após consulta SEFAZ (autorizada/rejeitada/cancelada) |
| **DivergenciaDetectada** | Ao encontrar divergência crítica na conciliação |
| **NotaFiscalConciliada** | Após conciliação com pedido sem divergências |
| **RateioConfigurado** | Após configuração de rateio (soma = 100%) |
| **ImpostosCalculados** | Após cálculo automático de todos impostos |
| **NotaFiscalAprovada** | Após aprovação de divergência por gerente |
| **NotaFiscalRejeitada** | Após rejeição de divergência |
| **NotaFiscalPaga** | Após confirmação de pagamento |
| **NotaFiscalCancelada** | Após cancelamento |
| **ArmazenadaEmBlob** | Após upload XML/DANFE no Azure |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant (FornecedorId)
- Nenhuma regra de negócio pode ser ignorada
- Erros devem ser previsíveis e rastreáveis
- Auditoria deve registrar quem, quando e o que mudou (100% cobertura)
- Assinatura digital obrigatória para NF-e importada via XML
- Consulta SEFAZ obrigatória antes de processar pagamento
- Divergências críticas bloqueiam pagamento até aprovação
- Rateio deve totalizar 100% (tolerância 0,01%)
- Impostos calculados com precisão 99,99% (desvio máx 1 centavo)
- XML e DANFE armazenados por 7 anos (LGPD)

---

## 9. INTEGRAÇÕES OBRIGATÓRIAS

### 9.1 Central de Funcionalidades (Feature Flags)

**FeatureKey**: `NOTASFISCAIS_IMPORTACAO_AUTOMATICA`

**Configuração**:
```json
{
    "featureKey": "NOTASFISCAIS_IMPORTACAO_AUTOMATICA",
    "nome": "Importação Automática de Notas Fiscais",
    "descricao": "Ativa importação automática de NF-e via SEFAZ e OCR de DANFE em PDF",
    "habilitado": true,
    "isSystemFeature": false,
    "escopoPorFornecedor": true
}
```

**Configurações Relacionadas**:
- `NOTASFISCAIS_VALIDACAO_ASSINATURA`: Validação RSA-2048
- `NOTASFISCAIS_CONCILIACAO_AUTOMATICA`: Match automático NF-e vs Pedido
- `NOTASFISCAIS_OCR_DANFE`: OCR com Azure Cognitive Services

---

### 9.2 Internacionalização (i18n)

**Módulo**: `financeiro`
**Contexto**: `notas-fiscais`

**Chaves de Tradução Obrigatórias**:

```json
{
    "financeiro": {
        "notas-fiscais": {
            "titulo": "Gestão de Notas Fiscais",
            "subtitulo": "Importar, validar, conciliar e processar notas fiscais eletrônicas",
            "formulario": {
                "chaveAcesso": "Chave de Acesso",
                "numeroNota": "Número da Nota",
                "serie": "Série",
                "dataEmissao": "Data de Emissão",
                "cnpjEmitente": "CNPJ Emitente",
                "valorTotal": "Valor Total",
                "status": "Status"
            },
            "mensagens": {
                "importacaoSucesso": "Nota fiscal importada com sucesso",
                "validacaoSucesso": "Validação realizada com sucesso",
                "conciliacaoSucesso": "Nota conciliada com pedido",
                "importacaoErro": "Erro ao importar nota fiscal",
                "validacaoErro": "Validação falhou",
                "divergenciaDetectada": "Divergências detectadas na conciliação",
                "arquivoInvalido": "Arquivo XML inválido ou corrompido",
                "chaveAcessoDuplicada": "Chave de acesso já foi importada",
                "assinaturaInvalida": "Assinatura digital inválida"
            },
            "validacao": {
                "obrigatorio": "Campo obrigatório",
                "chaveAcessoInvalida": "Chave de acesso deve conter 44 dígitos",
                "cnpjInvalido": "CNPJ inválido",
                "dataInvalida": "Data inválida",
                "valorNegativo": "Valor não pode ser negativo"
            }
        }
    }
}
```

---

### 9.3 Auditoria

**Operações Auditadas**:

| Operação | Código | Dados Registrados |
|----------|--------|-------------------|
| Importação | `FIN_NOTAFISCAL_IMPORTA` | ChaveAcesso, NumeroNota, CnpjEmitente, Valor, Usuário, IP |
| Validação | `FIN_NOTAFISCAL_ASSINATURA` | Resultado (OK/ERRO), Certificado, Thumbprint |
| Consulta SEFAZ | `FIN_NOTAFISCAL_CONSULT_SEFAZ` | Status, ProtocoloAutorizacao, Tentativas |
| Conciliação | `FIN_NOTAFISCAL_CONCILIACAO` | PedidoId, Divergências, Usuário |
| Rateamento | `FIN_NOTAFISCAL_RATEIO` | Filiais/Centros, Percentuais, Usuário |
| Cálculo Impostos | `FIN_NOTAFISCAL_IMPOSTOS` | ICMS, IPI, PIS, COFINS, retenções |
| Aprovação | `FIN_NOTAFISCAL_APROVACAO` | Divergência, Decisão, Justificativa |
| Pagamento | `FIN_NOTAFISCAL_PAGTO` | DataPagamento, MeioPagamento |
| Cancelamento | `FIN_NOTAFISCAL_CANCEL` | Motivo, Usuário, Data |

**Retenção**: 7 anos (conforme LGPD e legislação fiscal)

---

### 9.4 Controle de Acesso (RBAC)

**Permissões**:

| Permissão | Descrição | Perfis |
|-----------|-----------|--------|
| `fin:notasfiscais:read` | Visualizar notas | Gerente Fiscal, Analista, Auditor, Contador, CFO |
| `fin:notasfiscais:create` | Criar/importar | Gerente Fiscal, Analista, Contabilista |
| `fin:notasfiscais:update` | Editar metadados | Gerente Fiscal, Analista |
| `fin:notasfiscais:delete` | Excluir (soft delete) | Gerente Fiscal, Auditor |
| `fin:notasfiscais:importar` | Importar XML/DANFE | Gerente Fiscal, Analista, Contabilista |
| `fin:notasfiscais:validar` | Validar assinatura | Sistema (automático) |
| `fin:notasfiscais:conciliar` | Reconciliar com pedidos | Gerente Fiscal, Analista |
| `fin:notasfiscais:ratear` | Configurar rateio | Gerente Fiscal, Contador |
| `fin:notasfiscais:aprovar` | Aprovar divergências | Gerente Fiscal, CFO (> R$ 50.000) |
| `fin:notasfiscais:cancelar` | Cancelar notas | Gerente Fiscal, Auditor |
| `fin:notasfiscais:exportar` | Exportar relatórios | Gerente Fiscal, Auditor, Contador, CFO |
| `fin:notasfiscais:pagar` | Marcar como paga | Gerente Fiscal, Contador, CFO |

**Regras Especiais**:
- Aprovação de divergência crítica (valor > R$ 50.000) requer CFO
- Cancelamento de nota requer CFO
- Exportação SPED requer Auditor ou Contador

---

## 10. ENDPOINTS DA API

### 10.1 CRUD Principal

| Método | Endpoint | Descrição | Permissão | HTTP Status |
|--------|----------|-----------|-----------|-------------|
| GET | `/api/notas-fiscais` | Listar notas (paginação/filtros) | `fin:notasfiscais:read` | 200 |
| GET | `/api/notas-fiscais/{id}` | Obter por ID | `fin:notasfiscais:read` | 200, 404 |
| GET | `/api/notas-fiscais/{chaveAcesso}` | Obter por chave acesso | `fin:notasfiscais:read` | 200, 404 |
| POST | `/api/notas-fiscais/importar` | Importar XML | `fin:notasfiscais:importar` | 201, 400, 409 |
| POST | `/api/notas-fiscais/importar-lote` | Importar múltiplos | `fin:notasfiscais:importar` | 202, 400 |
| PUT | `/api/notas-fiscais/{id}` | Atualizar metadados | `fin:notasfiscais:update` | 200, 400, 404 |
| DELETE | `/api/notas-fiscais/{id}` | Excluir (soft delete) | `fin:notasfiscais:delete` | 204, 404, 403 |

### 10.2 Operações Especiais

| Método | Endpoint | Descrição | Permissão | HTTP Status |
|--------|----------|-----------|-----------|-------------|
| POST | `/api/notas-fiscais/{id}/validar-assinatura` | Validar RSA-2048 | `fin:notasfiscais:validar` | 200, 400, 422 |
| POST | `/api/notas-fiscais/{id}/consultar-sefaz` | Consultar SEFAZ | Sistema | 200, 408, 503 |
| POST | `/api/notas-fiscais/{id}/conciliar` | Reconciliar pedido | `fin:notasfiscais:conciliar` | 200, 400, 404 |
| POST | `/api/notas-fiscais/{id}/calcular-impostos` | Calcular impostos | `fin:notasfiscais:update` | 200, 400 |
| POST | `/api/notas-fiscais/{id}/rateio` | Configurar rateio | `fin:notasfiscais:ratear` | 200, 400, 422 |
| POST | `/api/notas-fiscais/{id}/aprovar-divergencia` | Aprovar divergência | `fin:notasfiscais:aprovar` | 200, 400, 403 |
| POST | `/api/notas-fiscais/{id}/marcar-paga` | Marcar paga | `fin:notasfiscais:pagar` | 200, 400, 403 |
| POST | `/api/notas-fiscais/{id}/cancelar` | Cancelar nota | `fin:notasfiscais:cancelar` | 200, 400, 403 |
| GET | `/api/notas-fiscais/{id}/xml` | Download XML | `fin:notasfiscais:read` | 200, 404 |
| GET | `/api/notas-fiscais/{id}/danfe` | Download DANFE PDF | `fin:notasfiscais:read` | 200, 404 |
| POST | `/api/notas-fiscais/ocr-danfe` | OCR de DANFE PDF | `fin:notasfiscais:importar` | 200, 400, 422 |

### 10.3 Relatórios

| Método | Endpoint | Descrição | Permissão | HTTP Status |
|--------|----------|-----------|-----------|-------------|
| GET | `/api/relatorios/sped-fiscal` | SPED Fiscal | `fin:notasfiscais:exportar` | 200, 400 |
| GET | `/api/relatorios/dctf` | DCTF | `fin:notasfiscais:exportar` | 200, 400 |
| GET | `/api/relatorios/livro-registro` | Livro Registro | `fin:notasfiscais:exportar` | 200, 400 |
| GET | `/api/relatorios/impostos-retidos` | Impostos Retidos | `fin:notasfiscais:exportar` | 200, 400 |

---

## 11. MODELO DE DADOS (Referência)

**Entidades Principais**:
- `NotaFiscal`: Entidade principal com metadados, status, URLs blob
- `NotaFiscalItem`: Itens da nota (produtos/serviços)
- `NotaFiscalImposto`: Impostos calculados por tipo
- `NotaFiscalDivergencia`: Divergências detectadas na conciliação
- `RateioNotaFiscal`: Rateio entre filiais/centros de custo
- `NotaFiscalAprovacao`: Histórico de aprovações de divergências

**Multi-tenancy**: FornecedorId obrigatório em todas tabelas
**Soft Delete**: FlExcluido em todas tabelas
**Auditoria**: Campos padrão (CriadoPor, DataCriacao, ModificadoPor, DataModificacao)

**Detalhes completos**: Ver [MD-RF032.md](./MD-RF032.md)

---

## 12. SEGURANÇA

### 12.1 Proteções Implementadas

| Proteção | Implementação |
|----------|---------------|
| **Validação Assinatura Digital** | RSA-2048 com SHA-256 (ICP-Brasil) |
| **SQL Injection** | Entity Framework Core com parametrização |
| **XSS** | Angular DomSanitizer |
| **CSRF** | Anti-forgery token obrigatório |
| **RBAC** | Permissões granulares por operação |
| **TLS 1.3** | HTTPS obrigatório em todos endpoints |
| **Encriptação em repouso** | Azure SQL TDE |
| **Auditoria Imutável** | Log completo com constraints |
| **Soft Delete** | FlExcluido em vez de delete físico |
| **Row-Level Security** | Filtro automático por FornecedorId |
| **Rate Limiting** | 100 req/min por IP |
| **Timeout SEFAZ** | 30s com retry exponential backoff |

### 12.2 Testes de Segurança Obrigatórios

- [ ] SQL Injection em ChaveAcesso, NumeroNota, CnpjEmitente
- [ ] XSS em RazaoSocialEmitente, RazaoSocialDestinatario
- [ ] CSRF em POST/PUT/DELETE
- [ ] Validação de permissões (acesso cruzado entre Fornecedores)
- [ ] Validação de assinatura (XML alterado)
- [ ] Rate limiting (100+ requisições simultâneas)
- [ ] Timeout SEFAZ (serviço indisponível)
- [ ] Certificado inválido/expirado
- [ ] XML malformado (tags incompletas, encoding inválido)

---

## 13. MÉTRICAS E INDICADORES

### 13.1 KPIs

| KPI | Meta | Medição | Alerta |
|-----|------|---------|--------|
| **Tempo de Importação** | < 2s | Timestamp importação - consulta SEFAZ | > 5s |
| **Taxa Sucesso Validação** | > 98% | (Validadas / Total) * 100 | < 95% |
| **Precisão Conciliação** | > 95% | (Sem divergência crítica / Total) * 100 | < 90% |
| **Tempo Resposta SEFAZ** | < 30s | Tempo consulta status | > 45s |
| **Taxa Sucesso Rateio** | 100% | (Soma=100% / Total) * 100 | < 99% |
| **Precisão Cálculo Impostos** | 99,99% | Desvio máx 1 centavo | > 0,01 |
| **Auditoria Completa** | 100% | (Auditadas / Total) * 100 | < 100% |
| **Disponibilidade** | > 99,5% | Uptime mensal | < 99% |

### 13.2 Alertas Críticos

| Alerta | Condição | Ação |
|--------|----------|------|
| **Divergência Crítica** | Percentual > 5% | Notificar gerente fiscal (email/SMS) |
| **SEFAZ Indisponível** | 5+ falhas consecutivas | Escalatar TI, notificar usuário |
| **Certificado Expirando** | Expira em < 30 dias | Notificar admin |
| **Impostos Atrasados** | Vencimento < hoje | Notificar CFO e contador |
| **OCR Alta Taxa Erro** | Falhas > 10% | Revisar qualidade PDFs |
| **Blob Storage Cheio** | Uso > 80% | Alertar admin |
| **Nota Cancelada** | Detectada via SEFAZ | Notificar gerente imediatamente |
| **Tentativa de Fraude** | 3+ assinaturas inválidas | Incidente de segurança |

---

## 14. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF032.md**: Casos de Uso detalhados com atores, fluxos, precondições
- **MD-RF032.md**: Modelo de Dados com entidades, relacionamentos, constraints
- **WF-RF032.md**: Wireframes e fluxos de tela (Angular)
- **user-stories.yaml**: User Stories implementáveis com critérios de aceite
- **TC-RF032-BACKEND.yaml**: Casos de Teste Backend
- **TC-RF032-FRONTEND.yaml**: Casos de Teste Frontend
- **TC-RF032-SEGURANCA.yaml**: Casos de Teste Segurança
- **TC-RF032-E2E.yaml**: Casos de Teste End-to-End

---

## 15. RASTREABILIDADE

| Artefato | Status | Responsável |
|--------|-------|-------------|
| UC-RF032.md | Pendente | Architect |
| MD-RF032.md | Pendente | Architect |
| WF-RF032.md | Pendente | Architect |
| user-stories.yaml | Pendente | Architect |
| TC-RF032-*.yaml | Pendente | Tester |
| Backend (Commands/Queries) | Pendente | Developer |
| Frontend (Angular) | Pendente | Developer |
| Testes Automatizados | Pendente | Tester |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|------|------|----------|------|
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0: Separação completa RF/RL, remoção de conteúdo legado, reestruturação conforme template RF.md oficial | Agência ALC - alc.dev.br |
| 1.0 | 2025-01-14 | Versão inicial (RF+RL misturados) | Architect Agent |

---

**Última Atualização**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**Revisão**: Pendente de aprovação técnica
**Status**: Pronto para desenvolvimento backend
