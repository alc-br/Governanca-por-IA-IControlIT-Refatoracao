# RF-089: Conciliação e Auditoria de Faturas

**Versão**: 2.0
**Data**: 2025-12-31
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC006-FIN-Financeiro-Base
**Fase**: Fase 3 - Financeiro I - Base Contábil

---

## 1. OBJETIVO DO REQUISITO

Implementar sistema automatizado de conciliação e auditoria de faturas (Notas Fiscais Eletrônicas) com matching automático multi-nível (two-way e three-way), detecção de divergências por severidade, workflow de aprovação, conciliação bancária, detecção de anomalias via Machine Learning, e geração de relatórios fiscais com conformidade SPED, SOX e LGPD.

O sistema deve servir como **contrato oficial** entre negócio, desenvolvimento e testes, definindo comportamento esperado sem especificar implementação técnica.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Matching automático two-way (NF-e ↔ PC)
- [x] Matching automático three-way (NF-e ↔ PC ↔ RM)
- [x] Detecção de divergências em valores, quantidades, datas e dados fiscais
- [x] Classificação de divergências por severidade (CRÍTICA, ALTA, MÉDIA, BAIXA)
- [x] Workflow de aprovação com roteamento automático e SLA
- [x] Validação de termos contratuais
- [x] Detecção de anomalias com Machine Learning
- [x] Conciliação bancária (faturas × pagamentos)
- [x] Bloqueio automático de pagamentos em divergências críticas
- [x] Auditoria completa com event sourcing e hash de integridade
- [x] Exportação de relatórios fiscais (SPED, Excel, PDF, JSON)
- [x] Notificações em tempo real via SignalR
- [x] Processamento batch noturno via Hangfire
- [x] Controle de acesso RBAC multi-nível
- [x] Isolamento multi-tenant

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (responsabilidade do frontend)
- Tecnologia, framework ou linguagem (decisão de arquitetura)
- Layout, UX ou identidade visual (design system)
- Estratégia de deploy ou infraestrutura (DevOps)
- Importação de NF-e XML (responsabilidade do RF-032)
- Gestão de Pedidos de Compra (RF-032)
- Gestão de Contratos (RF-023)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Matching** | Processo automático de validação cruzada de documentos (NF-e, PC, RM) |
| **Two-Way Matching** | Validação entre Nota Fiscal e Pedido de Compra |
| **Three-Way Matching** | Validação entre Nota Fiscal, Pedido de Compra e Recebimento de Mercadoria |
| **Divergência** | Diferença identificada entre documentos (valor, quantidade, data, CFOP) |
| **Severidade** | Classificação de impacto da divergência (CRÍTICA, ALTA, MÉDIA, BAIXA) |
| **Conciliação Bancária** | Vinculação de faturas com pagamentos em extratos bancários |
| **Anomalia** | Padrão suspeito detectado por Machine Learning (fraude, erro) |
| **SLA** | Service Level Agreement - prazo máximo para aprovação por severidade |
| **Event Sourcing** | Registro imutável de todas as operações com hash de integridade |
| **CHAVE_NFE** | Identificador único de 44 dígitos da Nota Fiscal Eletrônica |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Matching Automático Multi-Nível**
   - Two-way matching (NF-e ↔ PC)
   - Three-way matching (NF-e ↔ PC ↔ RM)
   - Tolerâncias configuráveis por empresa e tipo de item

2. **Detecção de Divergências**
   - Análise de valores (preço unitário, subtotal, impostos, frete)
   - Análise de quantidades (pedida, recebida, faturada)
   - Análise de datas (pedido, recebimento, emissão, vencimento)
   - Análise de dados fiscais (CFOP, alíquotas ICMS/IPI)

3. **Classificação por Severidade**
   - CRÍTICA: >10% divergência ou CFOP inválido
   - ALTA: 5-10% divergência ou desconto não contratado >5%
   - MÉDIA: 2-5% divergência ou diferença de datas >30 dias
   - BAIXA: <2% divergência

4. **Workflow de Aprovação**
   - Roteamento automático conforme severidade
   - SLA diferenciado (CRÍTICA: 4h, ALTA: 24h, MÉDIA: 72h, BAIXA: auto-aprovação)
   - Notificações em tempo real (SignalR, e-mail)

5. **Validação de Contratos**
   - Verificação de preços contratados
   - Verificação de prazos de pagamento
   - Verificação de descontos permitidos
   - Verificação de condições tributárias

6. **Detecção de Anomalias (ML)**
   - Análise de padrões históricos (24 meses)
   - Score de anomalia (0.0 a 1.0)
   - Classificação de risco (ALTO: >0.75, MÉDIO: 0.5-0.75, BAIXO: <0.5)

7. **Conciliação Bancária**
   - Matching fatura × pagamento
   - Detecção de atrasos e adiantamentos
   - Identificação de pagamentos órfãos
   - Cálculo de juros e multas

8. **Bloqueio Automático de Pagamentos**
   - Bloqueio em divergências CRÍTICAS
   - Bloqueio em divergências ALTAS não resolvidas
   - Auditoria de tentativas de bypass

9. **Auditoria Completa**
   - Event sourcing com hash SHA-512
   - Trilha imutável de todas as operações
   - Retenção configurável (7 anos padrão)

10. **Relatórios Fiscais**
    - Exportação SPED (E-100, E-200, E-310)
    - Exportação Excel
    - Exportação PDF
    - Exportação JSON (APIs)

---

## 5. REGRAS DE NEGÓCIO

### RN-FIN-089-01 — Validação de Integração de Nota Fiscal com Pedido de Compra

**Descrição**: Toda Nota Fiscal deve ser automaticamente associada ao seu Pedido de Compra antes de qualquer processamento de conciliação.

**Critério de Aceite**:
- CHAVE_NFE deve ter exatamente 44 dígitos
- Fornecedor da NF-e deve corresponder ao fornecedor do PC
- Cliente da NF-e deve corresponder ao cliente do PC (multi-tenancy)
- CHAVE_NFE duplicada deve ser rejeitada

**Validações**:
- Campo ausente → HTTP 400 "CHAVE_NFE é obrigatória"
- Campo inválido → HTTP 400 "CHAVE_NFE deve ter 44 dígitos"
- Fornecedor diferente → HTTP 400 "Fornecedor da NF-e não corresponde ao pedido"
- Duplicação → HTTP 409 "NF-e já existe (ID: {id})"

---

### RN-FIN-089-02 — Classificação de Divergências por Severidade

**Descrição**: Toda divergência identificada deve ser classificada automaticamente em CRÍTICA, ALTA, MÉDIA ou BAIXA conforme impacto financeiro e operacional.

**Critério de Aceite**:
- **CRÍTICA**: divergência >10% OU quantidade=0 OU CFOP inválido
- **ALTA**: divergência 5-10% OU desconto não contratado >5%
- **MÉDIA**: divergência 2-5% OU diferença de datas >30 dias
- **BAIXA**: divergência <2%

**Cálculo**:
```
percentual_diferenca = ABS((valor_realizado - valor_esperado) / valor_esperado) * 100
```

---

### RN-FIN-089-03 — Three-Way Matching com Tolerâncias Configuráveis

**Descrição**: Sistema deve validar concordância entre Pedido (PC), Recebimento (RM) e Nota Fiscal (NF-e) com tolerâncias configuráveis por empresa e tipo de item.

**Critério de Aceite**:
- Tolerância de quantidade: absoluta (unidades) e percentual (%)
- Tolerância de valor: absoluta (R$) e percentual (%)
- Validação de cronologia: PC.Data ≤ RM.Data ≤ NF-e.Data (±2 dias tolerância)

**Validações**:
- Quantidade fora de tolerância → Divergência "QuantidadeInsuportada"
- Valor fora de tolerância → Divergência "ValorInsuportado"
- Recebimento anterior ao pedido → Divergência "DataInconsistente" (CRÍTICA)
- NF-e emitida >2 dias após recebimento → Divergência "DataInconsistente" (MÉDIA)

---

### RN-FIN-089-04 — Integração com Contratos para Validação de Termos

**Descrição**: Antes de marcar fatura como conciliada, sistema deve validar que termos da NF-e (preço, condições de pagamento, descontos) estão de acordo com contrato vinculado ao pedido.

**Critério de Aceite**:
- Preço unitário deve corresponder ao preço contratado (tolerância: R$ 0,01)
- Prazo de pagamento deve corresponder ao prazo contratado
- Desconto não pode exceder percentual máximo contratado
- Alíquotas ICMS/IPI devem corresponder ao Incoterm contratado

**Validações**:
- Preço diferente → Divergência "PreçoForaContrato" (ALTA)
- Prazo diferente → Divergência "PrazoForaContrato" (MÉDIA)
- Desconto acima do permitido → Divergência "DescontoNãoAutorizado" (ALTA)
- Alíquota diferente → Divergência "AlíquotaIncorreta" (MÉDIA)

---

### RN-FIN-089-05 — Detecção Automática de Anomalias com Machine Learning

**Descrição**: Sistema deve utilizar modelo de Machine Learning treinado em histórico de 24 meses para detectar padrões anômalos. Faturas com score >0.75 devem ser automaticamente marcadas como "Revisar".

**Critério de Aceite**:
- Score de anomalia: 0.0 (normal) a 1.0 (anômalo)
- Risco ALTO: score >0.75 → marcar como "Revisar" + notificar gestor
- Risco MÉDIO: score 0.5-0.75 → alocar para supervisor
- Risco BAIXO: score <0.5 → workflow normal

**Features analisadas**:
- Desvio de valor em relação à média do fornecedor
- Desvio de quantidade em relação à média do fornecedor
- Horário de emissão atípico (ex: madrugada)
- Dia da semana atípico
- CFOP inusual para o fornecedor
- Intervalo desde última fatura do fornecedor

---

### RN-FIN-089-06 — Workflow de Aprovação com SLA por Severidade

**Descrição**: Divergências devem passar por workflow de aprovação com roteamento automático conforme severidade e SLA diferenciado.

**Critério de Aceite**:
- **CRÍTICA**: roteado para Diretor + Controller, SLA 4 horas
- **ALTA**: roteado para Manager + Supervisor, SLA 24 horas
- **MÉDIA**: roteado para Supervisor, SLA 72 horas
- **BAIXA**: auto-aprovação após 24 horas sem ação

**Notificações**:
- SignalR (dashboard em tempo real)
- E-mail (notificação assíncrona)
- Sistema registra em auditoria todas as aprovações/rejeições

---

### RN-FIN-089-07 — Bloqueio de Pagamento Automático em Divergências Críticas

**Descrição**: Qualquer fatura com divergência CRÍTICA ou ALTA não resolvida deve ter pagamento automaticamente bloqueado. Sistema deve impedir criar contas a pagar enquanto divergência não for aprovada.

**Critério de Aceite**:
- Divergência CRÍTICA pendente → bloqueio obrigatório
- Divergência ALTA pendente → bloqueio obrigatório
- Tentativa de criar conta a pagar bloqueada → HTTP 403 "Fatura bloqueada por divergência {tipo}"
- Auditoria de tentativas de bypass → log de segurança

**Desbloqueio**:
- Apenas após aprovação da divergência por usuário autorizado
- Registro em auditoria: usuário, timestamp, justificativa

---

### RN-FIN-089-08 — Conciliação Bancária Automática com Detecção de Desvios

**Descrição**: Sistema deve implementar matching automático entre faturas (contas a pagar) e pagamentos em extratos bancários, identificando atrasos, adiantamentos e divergências de valor.

**Critério de Aceite**:
- Matching de valor: diferença <R$ 0,01
- Matching de data: ±5 dias da data de vencimento
- Detecção de atrasos: pagamento após vencimento → calcular juros e multa
- Detecção de pagamentos órfãos: sem fatura correspondente → sugerir conciliação manual

**Cálculo de Multa**:
```
juros = valor * dias_atraso * 0.00033  (0.033% ao dia)
multa = valor * 0.02  (2% fixo)
total_multa = MIN(juros + multa, valor * 0.20)  (limite 20%)
```

---

### RN-FIN-089-09 — Auditoria Completa com Event Sourcing

**Descrição**: Todas as operações de conciliação, aprovação, rejeição e alteração devem ser registradas em log imutável de auditoria com hash de integridade SHA-512.

**Critério de Aceite**:
- Registro de operação: timestamp UTC, usuário, tipo de operação, descrição
- Hash de integridade: SHA-512(timestamp|usuarioId|operacao|descricao)
- Trilha completa: todas as operações em ordem cronológica
- Validação de integridade: hash recalculado deve corresponder ao armazenado

**Operações auditadas**:
- Conciliação de fatura
- Aprovação de divergência
- Rejeição de divergência
- Bloqueio de pagamento
- Desbloqueio de pagamento
- Matching automático
- Detecção de anomalia

**Retenção**: 7 anos (Lei da Contabilidade, Código Civil Art. 406)

---

### RN-FIN-089-10 — Exportação de Relatórios Fiscais com Conformidade SPED

**Descrição**: Sistema deve gerar relatórios de conciliação em formato compatível com SPED Fiscal (registros E-100, E-200, E-310) e permitir exportação em Excel, PDF e JSON.

**Critério de Aceite**:
- **SPED**: arquivo .txt com registros E-100 (identificação), E-200 (NF-e), E-310 (itens)
- **Excel**: planilha com todas as faturas, status de conciliação e divergências
- **PDF**: relatório formatado para impressão
- **JSON**: dados estruturados para APIs

**Filtros disponíveis**:
- Período (data início, data fim)
- Fornecedor
- Status de conciliação
- Severidade de divergências
- Cliente (multi-tenancy)

---

## 6. ESTADOS DA ENTIDADE

### Estados de Nota Fiscal

| Estado | Descrição |
|--------|-----------|
| `nao_conciliada` | NF-e importada, aguardando matching |
| `conciliada_parcial` | Matching com divergências identificadas |
| `conciliada` | Matching completo sem divergências ou com divergências aprovadas |
| `bloqueada` | Pagamento bloqueado por divergência crítica/alta |
| `paga` | Fatura paga e conciliada com extrato bancário |
| `cancelada` | NF-e cancelada pelo fornecedor |

### Estados de Divergência

| Estado | Descrição |
|--------|-----------|
| `pendente` | Divergência detectada, aguardando aprovação |
| `em_analise` | Em análise por aprovador |
| `aprovada` | Divergência aprovada, fatura liberada |
| `rejeitada` | Divergência rejeitada, requer correção |
| `auto_aprovada` | Divergência BAIXA aprovada automaticamente após 24h |

### Transições Permitidas (Nota Fiscal)

| De | Para | Condição |
|----|------|----------|
| `nao_conciliada` | `conciliada` | Matching sem divergências |
| `nao_conciliada` | `conciliada_parcial` | Matching com divergências |
| `conciliada_parcial` | `bloqueada` | Divergência CRÍTICA ou ALTA |
| `conciliada_parcial` | `conciliada` | Todas as divergências aprovadas |
| `bloqueada` | `conciliada` | Divergências resolvidas |
| `conciliada` | `paga` | Pagamento conciliado bancariamente |

### Transições Proibidas

| De | Para | Motivo |
|----|------|--------|
| `paga` | `nao_conciliada` | Operação irreversível |
| `cancelada` | Qualquer | NF-e cancelada não pode ser reativada |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre | Dados do Evento |
|--------|---------------|-----------------|
| `NotaFiscalConciliada` | Após matching bem-sucedido | ChaveNFe, PedidoId, RecebimentoId, Score |
| `DivergenciaDetectada` | Quando divergência é identificada | ChaveNFe, TipoDivergencia, Severidade, Valor |
| `DivergenciaAprovada` | Aprovação manual de divergência | DivergenciaId, UsuarioAprovador, Justificativa |
| `DivergenciaRejeitada` | Rejeição manual de divergência | DivergenciaId, UsuarioRejeitador, Motivo |
| `PagamentoBloqueado` | Bloqueio automático de pagamento | ChaveNFe, MotivoBloqueio, DivergenciaId |
| `PagamentoDesbloqueado` | Desbloqueio manual de pagamento | ChaveNFe, UsuarioDesbloqueador, Justificativa |
| `AnomaliaDetectada` | Score de anomalia >0.75 | ChaveNFe, Score, TopFatores |
| `ConciliacaoBancariaRealizada` | Matching fatura × pagamento | ChaveNFe, MovimentacaoBancariaId, DesvioData |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant (multi-tenancy obrigatório)
- Nenhuma regra de negócio pode ser ignorada
- Divergências CRÍTICAS e ALTAS DEVEM bloquear pagamentos
- Auditoria DEVE registrar todas as operações com hash de integridade
- SLA de aprovação DEVE ser respeitado (notificação se ultrapassar)
- Matching automático DEVE processar 85% das faturas sem intervenção manual
- Modelo de ML DEVE ter acurácia ≥92% na detecção de anomalias
- Exportação SPED DEVE ser compatível com validador PVA da Receita Federal

---

## 9. SEGURANÇA

### Validações Obrigatórias

- Validação de entrada em todos os endpoints (Command Validators)
- Proteção contra SQL Injection (Entity Framework + Parametrização)
- Proteção contra XSS (sanitização de inputs de texto)
- CSRF Protection (Anti-Forgery Tokens)
- Validação de CHAVE_NFE (44 dígitos, dígito verificador)

### Controle de Acesso

- Autenticação JWT obrigatória
- Permissões RBAC multi-nível
- Isolamento multi-tenant (ClienteId em todas as queries)
- Auditoria de tentativas de acesso não autorizado

### Proteção de Dados Sensíveis

- Criptografia em repouso (CNPJ, valores, dados bancários)
- Criptografia em trânsito (HTTPS obrigatório)
- Hash SHA-512 para integridade de auditoria
- LGPD: direito ao esquecimento, anonimização, retenção configurável

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF089.md** - Casos de Uso (UC00-UC09: Listar, Criar, Visualizar, Editar, Excluir, Conciliar, Aprovar Divergência, Conciliar Bancariamente, Exportar Relatórios)
- **MD-RF089.md** - Modelo de Dados (NotaFiscal, NotaFiscalItem, Divergencia, Conciliacao, AuditoriaEvento)
- **TC-RF089.yaml** - Casos de Teste (mínimo 100 cenários cobrindo todos os fluxos)
- **MT-RF089.yaml** - Massas de Teste (dados válidos e inválidos para automação)
- **WF-RF089.md** - Wireframes e fluxos de tela

---

## 11. RASTREABILIDADE

### Dependências Upstream (este RF depende de)

| RF | Descrição | Tipo |
|----|-----------|------|
| RF-032 | Gestão de Notas Fiscais | OBRIGATÓRIO |
| RF-023 | Gestão de Contratos | OBRIGATÓRIO |
| RF-XXX | Gestão de Pedidos de Compra | OBRIGATÓRIO |
| RF-XXX | Gestão de Recebimento de Mercadorias | OBRIGATÓRIO |

### Dependências Downstream (dependem deste RF)

| RF | Descrição | Tipo |
|----|-----------|------|
| RF-XXX | Contas a Pagar | OPCIONAL |
| RF-XXX | Gestão de Caixa | OPCIONAL |

### Artefatos Obrigatórios

| Artefato | Status | Responsável |
|----------|--------|-------------|
| UC-RF089.md | Pendente | Arquiteto |
| MD-RF089.md | Pendente | Arquiteto |
| WF-RF089.md | Pendente | Arquiteto |
| TC-RF089.yaml | Pendente | Tester |
| MT-RF089.yaml | Pendente | Tester |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-31 | Migração v1.0 → v2.0 (separação RF/RL, remoção de referências ao legado) | Agência ALC - alc.dev.br |
| 1.0 | 2025-12-28 | Versão inicial com referências ao legado | Sistema |

---

**Última Atualização**: 2025-12-31 10:00 UTC
**Próximo Passo**: Criar UC-RF089.md, MD-RF089.md, WF-RF089.md
