# Referência ao Legado - RF031 - Gestão de Plano de Contas
# Versão: 2.0
# Data: 2025-12-30
# Autor: Agência ALC - alc.dev.br

rf_id: RF031
titulo: "Gestão de Plano de Contas Contábil"

legado:
  sistema: "VB.NET + ASP.NET Web Forms"
  versao: ".NET Framework 4.7"
  arquitetura: "Monolítica WebForms"
  banco_dados: "SQL Server 2016"
  multi_tenant: false
  auditoria: "partial"  # Log básico quem/quando
  problema_principal: "Funcionalidade fragmentada em 4 telas sem integração, limitação 3 níveis hierárquicos"

# SEÇÃO CRÍTICA: Referencias ao Legado com Destino Obrigatório
referencias:
  # TELAS LEGADO
  - id: "LEG-RF031-001"
    tipo: "tela"
    nome: "Centro_Custo.aspx"
    caminho: "ic1_legado/IControlIT/Cadastro/Centro_Custo.aspx"
    descricao: |
      Cadastro básico de centros de custo sem hierarquia organizacional.
      GridView ASP.NET com stored procedure pa_Centro_Custo.

      Problemas identificados:
      - Sem vínculo hierárquico organizacional (Empresa → Filial → Departamento)
      - Sem rateio automático entre centros
      - Código livre sem validação de formato ou unicidade
      - Sem auditoria de mudanças (não rastreia quem alterou percentuais)
      - DELETE físico (perde histórico para compliance fiscal)

    destino: "substituido"
    justificativa: |
      Substituído por entidade CentroCusto integrada à hierarquia organizacional.

      Melhorias implementadas:
      - Integrado a Empresa → Filial → Departamento (FKs obrigatórias)
      - Rateio cascata automático multi-nível (96% redução tempo)
      - Código padrão sugerido CC-{ClienteId}-{DeptId} com validação unicidade
      - Auditoria completa versionada (before/after 7 anos)
      - Soft delete obrigatório (FlExcluido=TRUE)

    documentacao_item_relacionado: "RN-RF031-03"
    uc_relacionado: "UC01-Criar-Centro-Custo"
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: 2

  - id: "LEG-RF031-002"
    tipo: "tela"
    nome: "Plano_Conta.aspx"
    caminho: "ic1_legado/IControlIT/Recepcao_Fatura/Plano_Conta.aspx"
    descricao: |
      Cadastro de contas contábeis com hierarquia rígida de 3 níveis.
      TreeView VB6-style com stored procedure pa_Plano_Conta.

      Problemas identificados:
      - Hierarquia rígida 3 níveis fixos (Codigo_Nivel_1, Codigo_Nivel_2, Codigo_Nivel_3)
      - Campos separados vs hierarquia recursiva (impossibilita query CTE)
      - Sem validação lançamento apenas em conta Analítica (permite lançamento em Sintética)
      - Sem validação unicidade de código global
      - Tree estático sem drag-drop visual
      - Sem preview impacto mudanças em lançamentos existentes

    destino: "substituido"
    justificativa: |
      Substituído por PlanoContaContabil com hierarquia recursiva flexível.

      Melhorias implementadas:
      - Até 7 níveis configuráveis (atende Big Four)
      - Hierarquia recursiva (PlanoContaContabil_PaiId FK self-reference)
      - Validação obrigatória: lançamento APENAS em conta Analítica (HTTP 400 se violar)
      - Builder visual drag-drop com reorganização hierarquia
      - Preview impacto antes de salvar (quantos lançamentos afetados)
      - Versionamento automático com data vigência

    documentacao_item_relacionado: "RN-RF031-01, RN-RF031-02, RN-RF031-11"
    uc_relacionado: "UC01-Criar-Plano-Conta"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF031-003"
    tipo: "tela"
    nome: "Rateio.aspx"
    caminho: "ic1_legado/IControlIT/Recepcao_Fatura/Rateio.aspx"
    descricao: |
      Rateio manual de faturas via importação de Excel.
      Import Excel com stored procedure sp_Rateio_Calcular.

      Problemas identificados:
      - 100% manual (120h/mês esforço, 18% taxa erro)
      - Sem validação soma percentuais = 100% (erro descoberto no ERP)
      - Sem rateio cascata multi-nível (só 1 dimensão: centro custo)
      - Sem histórico mudanças configuração rateio
      - Cálculo em stored procedure (lógica não testável unitariamente)
      - Valor_Rateado redundante (armazenado mas recalculado toda vez)

    destino: "substituido"
    justificativa: |
      Substituído por rateio automático cascata multi-dimensional.

      Melhorias implementadas:
      - Rateio automático cascata (5h/mês - 96% redução)
      - Validação obrigatória soma 100% antes salvar (HTTP 400 se falhar)
      - Multi-dimensional (Projeto, Região, Filial simultâneos)
      - Versionamento mudanças com data vigência início/fim
      - Lógica Application Layer (testável unitariamente)
      - Valor calculado on-the-fly (não armazenado redundante)

    documentacao_item_relacionado: "RN-RF031-03, RN-RF031-04"
    uc_relacionado: "UC01-Criar-Configuracao-Rateio"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF031-004"
    tipo: "tela"
    nome: "Template_Consulta.aspx"
    caminho: "ic1_legado/IControlIT/Consulta/Template_Consulta.aspx"
    descricao: |
      DRE (Demonstração Resultado Exercício) simplificado mensal.
      GridView com stored procedure sp_Relatorio_DRE.

      Problemas identificados:
      - Estático - sem filtros customizáveis
      - Sem drill-down detalhado até lançamentos
      - Sem comparações MoM (Month-over-Month) ou YoY (Year-over-Year)
      - Export Excel dump bruto sem formatação
      - Sem filtros multi-dimensionais (Projeto, Centro Custo, Região)
      - Apenas mês corrente (analistas mantinham Excel paralelo para comparações)

    destino: "substituido"
    justificativa: |
      Substituído por DRE multi-dimensional com análise comparativa.

      Melhorias implementadas:
      - Filtros multi-dimensionais (Projeto, Centro Custo, Região, etc)
      - Drill-down ilimitado até lançamentos origem
      - Comparação MoM, YoY, Orçado x Realizado tempo real
      - Export Excel formatado profissional (cores, gráficos)
      - Análise vertical/horizontal tempo real
      - Salvamento filtros favoritos usuário

    documentacao_item_relacionado: "RN-RF031-08"
    uc_relacionado: "UC05-Relatorio-DRE-Multi-Dimensional"
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: 2

  # WEBSERVICES LEGADO
  - id: "LEG-RF031-005"
    tipo: "webservice"
    nome: "WSCadastro.asmx - Centro_Custo_Insert"
    caminho: "ic1_legado/IControlIT/WebServices/WSCadastro.asmx"
    descricao: |
      Método SOAP para inserir centro de custo.
      Chama stored procedure pa_Centro_Custo diretamente sem validações negócio.

      Problemas:
      - Sem validações negócio (aceita qualquer código)
      - Exceções genéricas sem detalhamento (System.Exception)
      - Sem logging estruturado
      - Sem versionamento API

    destino: "substituido"
    justificativa: |
      Substituído por endpoint REST com validações robustas.

      Novo endpoint: POST /api/centros-custo
      Command: CreateCentroCustoCommand
      Validator: CreateCentroCustoCommandValidator (FluentValidation)

      Melhorias:
      - Validação código unicidade, formato padrão
      - Erros estruturados HTTP 400 com detalhamento
      - Logging estruturado Application Insights
      - Versionamento API via headers

    documentacao_item_relacionado: "RN-RF031-03"
    uc_relacionado: "UC01-Criar-Centro-Custo"

  - id: "LEG-RF031-006"
    tipo: "webservice"
    nome: "WSCadastro.asmx - Centro_Custo_Update"
    caminho: "ic1_legado/IControlIT/WebServices/WSCadastro.asmx"
    descricao: |
      Método SOAP para atualizar centro de custo.
      Sem validação negócio (permite alterar sem verificar rateios dependentes).

    destino: "substituido"
    justificativa: |
      Substituído por endpoint REST com preview impacto.

      Novo endpoint: PUT /api/centros-custo/{id}
      Command: UpdateCentroCustoCommand

      Melhorias:
      - Preview quantos rateios serão afetados antes confirmar
      - Validação negócio dependências
      - Versionamento auditoria before/after

    documentacao_item_relacionado: "RN-RF031-03"
    uc_relacionado: "UC03-Editar-Centro-Custo"

  - id: "LEG-RF031-007"
    tipo: "webservice"
    nome: "WSCadastro.asmx - Centro_Custo_Delete"
    caminho: "ic1_legado/IControlIT/WebServices/WSCadastro.asmx"
    descricao: |
      Método SOAP para deletar centro de custo.
      DELETE físico (viola compliance fiscal retenção 7 anos).

    destino: "substituido"
    justificativa: |
      Substituído por soft delete obrigatório.

      Novo endpoint: DELETE /api/centros-custo/{id}
      Command: DeleteCentroCustoCommand

      Comportamento:
      - Soft delete (FlExcluido=TRUE)
      - Auditoria quem/quando deletou
      - Possibilidade restauração
      - Compliance fiscal (retenção 7 anos)

    documentacao_item_relacionado: "RN-RF031-03"
    uc_relacionado: "UC04-Excluir-Centro-Custo"

  - id: "LEG-RF031-008"
    tipo: "webservice"
    nome: "WSCadastro.asmx - Centro_Custo_GetAll"
    caminho: "ic1_legado/IControlIT/WebServices/WSCadastro.asmx"
    descricao: |
      Método SOAP para listar todos centros de custo.
      Sem paginação (retorna 10k+ registros single call).

    destino: "substituido"
    justificativa: |
      Substituído por endpoint REST paginado.

      Novo endpoint: GET /api/centros-custo
      Query: GetCentrosCustoQuery

      Melhorias:
      - Paginação obrigatória (PageNumber, PageSize)
      - Filtros (Nome, Codigo, Ativo)
      - Ordenação customizável
      - Performance otimizada

    documentacao_item_relacionado: "RN-RF031-03"
    uc_relacionado: "UC00-Listar-Centros-Custo"

  - id: "LEG-RF031-009"
    tipo: "webservice"
    nome: "WSRecepcao_Fatura.asmx - Plano_Conta_Insert"
    caminho: "ic1_legado/IControlIT/WebServices/WSRecepcao_Fatura.asmx"
    descricao: |
      Método SOAP para inserir conta contábil.
      Chama stored procedure pa_Plano_Conta.

    destino: "substituido"
    justificativa: |
      Substituído por endpoint REST com validações hierarquia.

      Novo endpoint: POST /api/plano-contas
      Command: CreatePlanoContaCommand

      Melhorias:
      - Validação hierarquia (pai deve existir, tipo conta compatível)
      - Validação unicidade código global
      - Código padrão sugerido

    documentacao_item_relacionado: "RN-RF031-01"
    uc_relacionado: "UC01-Criar-Plano-Conta"

  - id: "LEG-RF031-010"
    tipo: "webservice"
    nome: "WSRecepcao_Fatura.asmx - Plano_Conta_GetHierarquia"
    caminho: "ic1_legado/IControlIT/WebServices/WSRecepcao_Fatura.asmx"
    descricao: |
      Método SOAP para buscar hierarquia plano de contas.
      Retorna XML recursivo complexo.

    destino: "substituido"
    justificativa: |
      Substituído por endpoint REST com JSON estruturado.

      Novo endpoint: GET /api/plano-contas/hierarquia
      Query: GetPlanoContasHierarquiaQuery

      Melhorias:
      - JSON estruturado hierárquico
      - Paginação nível raiz
      - Lazy loading filhos (performance)
      - Filtros por tipo conta

    documentacao_item_relacionado: "RN-RF031-02"
    uc_relacionado: "UC00-Listar-Plano-Contas"

  - id: "LEG-RF031-011"
    tipo: "webservice"
    nome: "WSRateio.asmx - Rateio_Calcular"
    caminho: "ic1_legado/IControlIT/WebServices/WSRateio.asmx"
    descricao: |
      Método SOAP para calcular rateio.
      Lógica em stored procedure sp_Rateio_Calcular (não testável).

    destino: "substituido"
    justificativa: |
      Substituído por serviço Application Layer testável.

      Service: CalcularRateioAutomaticoService

      Melhorias:
      - Lógica C# Application Layer (testável unitariamente)
      - Rateio cascata multi-dimensional
      - Validação soma 100% obrigatória
      - Cache configurações rateio (performance)

    documentacao_item_relacionado: "RN-RF031-03, RN-RF031-04"
    uc_relacionado: "UC02-Executar-Rateio-Automatico"

  # STORED PROCEDURES LEGADO
  - id: "LEG-RF031-012"
    tipo: "stored_procedure"
    nome: "pa_Centro_Custo"
    caminho: "Database/dbo.pa_Centro_Custo"
    descricao: |
      Procedure CRUD centro de custo.
      Lógica negócio misturada com acesso dados.

    destino: "substituido"
    justificativa: |
      Substituído por Commands/Queries CQRS.

      Lógica movida para:
      - CreateCentroCustoCommand
      - UpdateCentroCustoCommand
      - DeleteCentroCustoCommand
      - GetCentrosCustoQuery

    documentacao_item_relacionado: "RN-RF031-03"
    uc_relacionado: "UC01, UC03, UC04, UC00"

  - id: "LEG-RF031-013"
    tipo: "stored_procedure"
    nome: "pa_Plano_Conta"
    caminho: "Database/dbo.pa_Plano_Conta"
    descricao: |
      Procedure CRUD plano de contas.
      Query CTE recursiva impossível (campos separados vs FK PaiId).

    destino: "substituido"
    justificativa: |
      Substituído por Commands/Queries com hierarquia recursiva.

      Lógica movida para:
      - CreatePlanoContaCommand
      - UpdatePlanoContaCommand
      - GetPlanoContasHierarquiaQuery (CTE recursiva)

    documentacao_item_relacionado: "RN-RF031-01, RN-RF031-02"
    uc_relacionado: "UC01, UC00"

  - id: "LEG-RF031-014"
    tipo: "stored_procedure"
    nome: "sp_Rateio_Calcular"
    caminho: "Database/dbo.sp_Rateio_Calcular"
    descricao: |
      Procedure para calcular rateio faturas.
      Lógica complexa (200+ linhas T-SQL) não testável.

    destino: "substituido"
    justificativa: |
      Substituído por Application Service testável.

      Service: CalcularRateioAutomaticoService

      Motivo:
      - Lógica testável unitariamente (xUnit)
      - Facilita manutenção futura
      - Performance similar (testes benchmark realizados)

    documentacao_item_relacionado: "RN-RF031-03"
    uc_relacionado: "UC02"

  - id: "LEG-RF031-015"
    tipo: "stored_procedure"
    nome: "sp_Relatorio_DRE"
    caminho: "Database/dbo.sp_Relatorio_DRE"
    descricao: |
      Procedure para gerar DRE mensal.
      Apenas mês corrente, sem comparações.

    destino: "substituido"
    justificativa: |
      Substituído por Query multi-dimensional.

      Query: GetDREMultiDimensionalQuery

      Melhorias:
      - Filtros multi-dimensionais
      - Comparações MoM, YoY
      - Drill-down até lançamentos

    documentacao_item_relacionado: "RN-RF031-08"
    uc_relacionado: "UC05"

  - id: "LEG-RF031-016"
    tipo: "stored_procedure"
    nome: "sp_Exportar_Lancamentos_DE"
    caminho: "Database/dbo.sp_Exportar_Lancamentos_DE"
    descricao: |
      Procedure para exportar lançamentos formato D-E (Débito-Crédito).
      Sem validação partida dobrada (soma débitos = soma créditos).

    destino: "substituido"
    justificativa: |
      Substituído por Command com validações obrigatórias.

      Command: ExportarLancamentosContabeisCommand

      Melhorias:
      - Validação obrigatória partida dobrada antes exportar
      - Preview UI impacto antes confirmar
      - Erros estruturados HTTP 400

    documentacao_item_relacionado: "RN-RF031-07"
    uc_relacionado: "UC06"

  # TABELAS LEGADO
  - id: "LEG-RF031-017"
    tipo: "componente"
    nome: "Tabela Centro_Custo"
    caminho: "Database/dbo.Centro_Custo"
    descricao: |
      CREATE TABLE Centro_Custo (
          Id_Centro_Custo INT IDENTITY(1,1) PRIMARY KEY,
          Nm_Centro_Custo NVARCHAR(100) NOT NULL,
          Codigo_Centro_Custo VARCHAR(50) NULL,
          Fl_Desativado BIT DEFAULT 0
      );

      Problemas:
      - Sem FK Empresa/Filial/Departamento (não vinculado hierarquia)
      - Sem campos auditoria (Created_By, Created_At, Updated_By, Updated_At)
      - Sem soft delete (Fl_Excluido)
      - Código livre sem padrão ou validação

    destino: "substituido"
    justificativa: |
      Substituído por entidade CentroCusto moderna.

      Nova estrutura:
      - FKs obrigatórias: ClienteId, EmpresaId, FilialId, DepartamentoId
      - Auditoria completa: BaseAuditableEntity (IdUsuarioCriacao, DtCriacao, etc)
      - Soft delete: FlExcluido
      - Multi-tenancy: ClienteId
      - Código padrão sugerido com validação

    documentacao_item_relacionado: "RN-RF031-03"
    uc_relacionado: "UC01"

  - id: "LEG-RF031-018"
    tipo: "componente"
    nome: "Tabela Plano_Conta"
    caminho: "Database/dbo.Plano_Conta"
    descricao: |
      CREATE TABLE Plano_Conta (
          Id_Plano_Conta INT IDENTITY(1,1) PRIMARY KEY,
          Codigo_Nivel_1 VARCHAR(10) NULL,
          Codigo_Nivel_2 VARCHAR(10) NULL,
          Codigo_Nivel_3 VARCHAR(10) NULL,
          Nm_Conta NVARCHAR(200) NOT NULL,
          Tipo_Conta CHAR(1) CHECK (Tipo_Conta IN ('S','A'))
      );

      Problemas CRÍTICOS:
      - Estrutura rígida 3 níveis fixos (insuficiente Big Four)
      - Campos separados vs recursiva (query CTE impossível)
      - Sem FK pai (PlanoContaContabil_PaiId)
      - Sem validação sintética/analítica
      - Sem multi-tenancy (ClienteId)
      - Sem auditoria

    destino: "substituido"
    justificativa: |
      Substituído por PlanoContaContabil hierarquia recursiva.

      Nova estrutura:
      - Hierarquia recursiva: PlanoContaContabil_PaiId FK self-reference
      - Até 7 níveis configuráveis
      - Validação obrigatória tipo conta
      - Multi-tenancy: ClienteId
      - Auditoria completa + versionamento

      Script migração: legacy_plano_conta_to_recursive.sql

    documentacao_item_relacionado: "RN-RF031-01, RN-RF031-02"
    uc_relacionado: "UC01"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF031-019"
    tipo: "componente"
    nome: "Tabela Rateio"
    caminho: "Database/dbo.Rateio"
    descricao: |
      CREATE TABLE Rateio (
          Id_Rateio INT IDENTITY(1,1) PRIMARY KEY,
          Id_Fatura INT NOT NULL,
          Id_Centro_Custo INT NOT NULL,
          Percentual DECIMAL(5,2) NOT NULL,
          Valor_Rateado DECIMAL(18,2) NULL
      );

      Problemas:
      - Sem validação soma percentuais = 100%
      - Valor_Rateado redundante (armazenado mas recalculado)
      - Sem rateio cascata multi-nível
      - Sem histórico mudanças configuração
      - Sem dimensões (só centro custo, sem Projeto, Região, etc)

    destino: "substituido"
    justificativa: |
      Substituído por integração na entidade LancamentoContabil.

      Melhorias:
      - Rateio integrado na entidade principal
      - Validação automática soma 100%
      - Múltiplas dimensões simultâneas (Projeto, Região, Filial)
      - Versionamento automático mudanças
      - Valor calculado on-the-fly (não armazenado)

    documentacao_item_relacionado: "RN-RF031-03, RN-RF031-04"
    uc_relacionado: "UC01, UC02"

  # REGRAS DE NEGÓCIO IMPLÍCITAS
  - id: "LEG-RF031-020"
    tipo: "regra_negocio"
    nome: "Código Centro Custo Manual Sem Validação"
    caminho: "ic1_legado/IControlIT/Cadastro/Centro_Custo.aspx.vb:127"
    descricao: |
      Sistema permitia usuário digitar qualquer código de centro custo sem validação
      de formato ou unicidade global. Controllers mantinham padrão informal CC-{EmpresaId}-{DeptId}
      em planilhas Excel paralelas.

      Código VB.NET:
      ' VB.NET - Sem validação
      txtCodigoCentroCusto.Text = txtCodigoCentroCusto.Text.Trim()
      ' Salvava direto no banco sem checar duplicidade

    destino: "substituido"
    justificativa: |
      Sistema moderno sugere código padrão CC-{ClienteId}-{DeptId} com validação unicidade.

      Validação CreateCentroCustoCommandValidator:
      - Formato obrigatório padrão (sugestão automática)
      - Unicidade global (query banco antes inserir)
      - HTTP 400 se duplicado

    documentacao_item_relacionado: "RN-RF031-03"
    uc_relacionado: "UC01"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF031-021"
    tipo: "regra_negocio"
    nome: "Lançamento Permitido em Conta Sintética"
    caminho: "ic1_legado/IControlIT/Database/sp_Lancamento_Insert.sql:45"
    descricao: |
      Stored procedure sp_Lancamento_Insert não validava se conta era Analítica antes de
      inserir lançamento. Erro descoberto apenas no fechamento fiscal quando auditor rejeitava.

      Código SQL:
      -- SQL - Sem validação tipo conta
      INSERT INTO Lancamento (Id_Plano_Conta, Valor, ...)
      VALUES (@Id_Plano_Conta, @Valor, ...)

    destino: "substituido"
    justificativa: |
      Validação obrigatória pré-save: lançamento só em conta Analítica.

      Validação CreateLancamentoCommandValidator:
      - Query verifica TipoConta='ANALITICA' antes inserir
      - HTTP 400 se tentar lançar em Sintética
      - Mensagem clara: "Lançamentos permitidos apenas em contas analíticas"

    documentacao_item_relacionado: "RN-RF031-11"
    uc_relacionado: "UC01-Criar-Lancamento"
    complexidade: "media"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF031-022"
    tipo: "regra_negocio"
    nome: "Rateio Sem Validação Soma 100%"
    caminho: "ic1_legado/IControlIT/Recepcao_Fatura/Rateio.aspx.vb:203"
    descricao: |
      Tela Rateio.aspx permitia salvar rateio mesmo se soma percentuais diferente de 100%.
      Erro descoberto ao exportar para ERP que rejeitava arquivo.

      Código VB.NET:
      ' VB.NET - Sem validação soma
      For Each row In gridRateio.Rows
          soma += CDec(row.Cells("Percentual").Value)
      Next
      ' FALTAVA: If soma <> 100 Then Throw New Exception

    destino: "substituido"
    justificativa: |
      Validação automática soma 100% obrigatória.

      Validação CreateConfiguracaoRateioCommandValidator:
      - Calcula soma percentuais antes salvar
      - HTTP 400 se soma != 100.00
      - Mensagem: "Soma percentuais deve ser exatamente 100%. Atual: {soma}%"

    documentacao_item_relacionado: "RN-RF031-03"
    uc_relacionado: "UC01-Criar-Configuracao-Rateio"
    complexidade: "baixa"
    risco_migracao: "medio"
    prioridade: 2

  - id: "LEG-RF031-023"
    tipo: "regra_negocio"
    nome: "Importação CSV TOTVS Encoding ISO-8859-1"
    caminho: "ic1_legado/IControlIT/Recepcao_Fatura/ImportPlanoContas.aspx.vb:87"
    descricao: |
      TOTVS Protheus 12 exportava CSV em ISO-8859-1 mas sistema assumia UTF-8,
      causando corrupção de acentos. Descoberta manual durante testes.

      Código VB.NET:
      ' VB.NET - Encoding fixo errado
      Dim reader As New StreamReader(arquivoCSV, Encoding.UTF8)

    destino: "substituido"
    justificativa: |
      Engine detecta encoding automaticamente.

      Implementação ImportPlanoContasService:
      - Detecta encoding automaticamente (UTF-8, ISO-8859-1, Windows-1252)
      - Testa múltiplos encodings até encontrar válido
      - Configurable por ERP (tabela ERP_Configuracao)

    documentacao_item_relacionado: "RN-RF031-06"
    uc_relacionado: "UC07-Importar-Plano-Contas"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF031-024"
    tipo: "regra_negocio"
    nome: "Exportação D-E Sem Validação Partida Dobrada"
    caminho: "ic1_legado/IControlIT/Database/sp_Exportar_Lancamentos_DE.sql:134"
    descricao: |
      Stored procedure sp_Exportar_Lancamentos_DE gerava arquivo contábil mas não validava
      se soma débitos igual soma créditos. ERP rejeitava arquivo no import.

      Código SQL:
      -- SQL - Sem validação partida dobrada
      SELECT 'D' AS Tipo, Conta_Debito, Valor, ...
      UNION ALL
      SELECT 'C' AS Tipo, Conta_Credito, Valor, ...

    destino: "substituido"
    justificativa: |
      Validação obrigatória partida dobrada antes exportar.

      Implementação ExportarLancamentosContabeisCommand:
      - Calcula soma débitos vs soma créditos antes gerar arquivo
      - HTTP 400 se somas diferentes
      - Preview UI mostra somas antes confirmar exportação
      - Mensagem: "Partida dobrada inválida. Débitos: {debitos}, Créditos: {creditos}"

    documentacao_item_relacionado: "RN-RF031-07"
    uc_relacionado: "UC06-Exportar-Lancamentos"
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: 2

  - id: "LEG-RF031-025"
    tipo: "regra_negocio"
    nome: "DRE Sem Comparação Períodos"
    caminho: "ic1_legado/IControlIT/Database/sp_Relatorio_DRE.sql:23"
    descricao: |
      Relatório DRE exibia apenas mês corrente, sem comparação MoM ou YoY.
      Analistas mantinham planilhas Excel paralelas para comparações.

      Código SQL:
      -- SQL - Apenas mês corrente
      WHERE MONTH(Lancamento.Dt_Lancamento) = @Mes
      AND YEAR(Lancamento.Dt_Lancamento) = @Ano

    destino: "substituido"
    justificativa: |
      DRE com filtro comparação integrado.

      Implementação GetDREMultiDimensionalQuery:
      - Filtro comparação: MoM, YoY, Orçado x Realizado
      - Cálculo variação % automático
      - Drill-down detalhado até lançamentos
      - Export Excel com comparações formatadas

    documentacao_item_relacionado: "RN-RF031-08"
    uc_relacionado: "UC05-Relatorio-DRE"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 3

# Telas Legadas (estrutura detalhada opcional)
telas:
  - id: "LEG-RF031-001"
    nome: "Centro_Custo.aspx"
    caminho: "ic1_legado/IControlIT/Cadastro/Centro_Custo.aspx"
    responsabilidade: "Cadastro básico centros custo sem hierarquia"
    campos:
      - nome: "Nm_Centro_Custo"
        tipo: "TextBox"
        obrigatorio: true
        validacao: "Sem validação específica"
      - nome: "Codigo_Centro_Custo"
        tipo: "TextBox"
        obrigatorio: false
        validacao: "Sem validação formato/unicidade"
    comportamentos_implicitos:
      - "Código livre sem padrão"
      - "Sem validação unicidade global"
      - "DELETE físico perde histórico"

  - id: "LEG-RF031-002"
    nome: "Plano_Conta.aspx"
    caminho: "ic1_legado/IControlIT/Recepcao_Fatura/Plano_Conta.aspx"
    responsabilidade: "Cadastro contas contábeis 3 níveis fixos"
    campos:
      - nome: "Codigo_Nivel_1"
        tipo: "TextBox"
        obrigatorio: false
        validacao: "Sem validação"
      - nome: "Codigo_Nivel_2"
        tipo: "TextBox"
        obrigatorio: false
        validacao: "Sem validação"
      - nome: "Codigo_Nivel_3"
        tipo: "TextBox"
        obrigatorio: false
        validacao: "Sem validação"
      - nome: "Tipo_Conta"
        tipo: "DropDownList"
        obrigatorio: true
        validacao: "S=Sintética, A=Analítica"
    comportamentos_implicitos:
      - "Hierarquia rígida 3 níveis (insuficiente)"
      - "Sem validação lançamento apenas Analítica"
      - "Sem preview impacto mudanças"

  - id: "LEG-RF031-003"
    nome: "Rateio.aspx"
    caminho: "ic1_legado/IControlIT/Recepcao_Fatura/Rateio.aspx"
    responsabilidade: "Rateio manual via Excel"
    campos:
      - nome: "Id_Centro_Custo"
        tipo: "DropDownList"
        obrigatorio: true
        validacao: "Deve existir"
      - nome: "Percentual"
        tipo: "TextBox"
        obrigatorio: true
        validacao: "Sem validação soma 100%"
    comportamentos_implicitos:
      - "100% manual (120h/mês)"
      - "Sem validação soma 100%"
      - "Sem rateio cascata"

  - id: "LEG-RF031-004"
    nome: "Template_Consulta.aspx"
    caminho: "ic1_legado/IControlIT/Consulta/Template_Consulta.aspx"
    responsabilidade: "DRE simplificado mensal"
    campos:
      - nome: "Mes"
        tipo: "DropDownList"
        obrigatorio: true
        validacao: "1-12"
      - nome: "Ano"
        tipo: "TextBox"
        obrigatorio: true
        validacao: "YYYY"
    comportamentos_implicitos:
      - "Apenas mês corrente"
      - "Sem comparações MoM/YoY"
      - "Export Excel dump bruto"

# WebServices Legados
servicos:
  - id: "LEG-RF031-005"
    nome: "WSCadastro.asmx"
    localizacao: "ic1_legado/IControlIT/WebServices/WSCadastro.asmx"
    responsabilidade: "CRUD centros custo via SOAP"
    notas: "Substituído por REST API com validações robustas"

  - id: "LEG-RF031-009"
    nome: "WSRecepcao_Fatura.asmx"
    localizacao: "ic1_legado/IControlIT/WebServices/WSRecepcao_Fatura.asmx"
    responsabilidade: "CRUD plano contas via SOAP"
    notas: "Substituído por REST API hierarquia recursiva"

  - id: "LEG-RF031-011"
    nome: "WSRateio.asmx"
    localizacao: "ic1_legado/IControlIT/WebServices/WSRateio.asmx"
    responsabilidade: "Calcular rateio via SOAP"
    notas: "Substituído por Application Service testável"

# Tabelas Legadas com Problemas
tabelas:
  - nome: "Centro_Custo"
    finalidade: "Cadastro centros custo sem hierarquia"
    problemas:
      - "Sem FK Empresa/Filial/Departamento"
      - "Sem campos auditoria (Created_By, Created_At)"
      - "Sem soft delete (Fl_Excluido)"
      - "Código livre sem padrão"

  - nome: "Plano_Conta"
    finalidade: "Plano contas 3 níveis fixos"
    problemas:
      - "Estrutura rígida 3 níveis fixos"
      - "Campos separados vs recursiva"
      - "Sem FK pai (query CTE impossível)"
      - "Sem validação sintética/analítica"
      - "Sem multi-tenancy"
      - "Sem auditoria"

  - nome: "Rateio"
    finalidade: "Rateio manual faturas"
    problemas:
      - "Sem validação soma 100%"
      - "Valor redundante (calculado mas armazenado)"
      - "Sem rateio cascata"
      - "Sem histórico mudanças"
      - "Sem dimensões (só centro custo)"

# Regras de Negócio Implícitas (não documentadas no legado)
regras_implicitas:
  - id: "RL-RN-001"
    descricao: |
      Código Centro Custo Manual Sem Validação
    fonte: "Centro_Custo.aspx.vb:127"

  - id: "RL-RN-002"
    descricao: |
      Lançamento Permitido em Conta Sintética
    fonte: "sp_Lancamento_Insert.sql:45"

  - id: "RL-RN-003"
    descricao: |
      Rateio Sem Validação Soma 100%
    fonte: "Rateio.aspx.vb:203"

  - id: "RL-RN-004"
    descricao: |
      Importação CSV TOTVS Encoding ISO-8859-1
    fonte: "ImportPlanoContas.aspx.vb:87"

  - id: "RL-RN-005"
    descricao: |
      Exportação D-E Sem Validação Partida Dobrada
    fonte: "sp_Exportar_Lancamentos_DE.sql:134"

  - id: "RL-RN-006"
    descricao: |
      DRE Sem Comparação Períodos
    fonte: "sp_Relatorio_DRE.sql:23"

# Gap Analysis (Legado x Moderno)
gap_analysis:
  - item: "Níveis Hierarquia"
    existe_legado: true
    existe_moderno: true
    notas: "Legado: 3 fixos | Moderno: Até 7 configuráveis (CRÍTICO)"

  - item: "Auditoria Estrutural"
    existe_legado: false
    existe_moderno: true
    notas: "Legado: Nenhuma | Moderno: Trilha completa before/after 7 anos (CRÍTICO)"

  - item: "Validações Contábeis"
    existe_legado: false
    existe_moderno: true
    notas: "Legado: Nenhuma | Moderno: 20+ regras pré-save (CRÍTICO)"

  - item: "Rateio Automático"
    existe_legado: false
    existe_moderno: true
    notas: "Legado: Manual 120h/mês | Moderno: Automático 5h/mês (96% redução)"

  - item: "Dimensões Multi-dimensionais"
    existe_legado: false
    existe_moderno: true
    notas: "Legado: Nenhuma | Moderno: Ilimitadas (Projeto, Região)"

  - item: "Integração ERP"
    existe_legado: true
    existe_moderno: true
    notas: "Legado: Manual 12 dias | Moderno: API REST 3 dias (75% redução)"

  - item: "Classificação Automática"
    existe_legado: false
    existe_moderno: true
    notas: "Legado: 100% manual 18% erro | Moderno: Automática ML >95% match <2% erro"

  - item: "DRE Multi-dimensional"
    existe_legado: false
    existe_moderno: true
    notas: "Legado: Estático mensal | Moderno: Drill-down MoM/YoY comparações"

  - item: "Versionamento"
    existe_legado: false
    existe_moderno: true
    notas: "Legado: Nenhum | Moderno: Snapshot JSON before/after"

# Decisões de Modernização
decisoes_modernizacao:
  - decisao: "Hierarquia Recursiva em vez de Campos Separados"
    motivo: |
      Campos separados limitam flexibilidade e dificultam queries recursivas
    impacto: "alto"
    data: "2025-12-30"

  - decisao: "Soft Delete Obrigatório para Compliance Fiscal"
    motivo: |
      DELETE físico viola exigência Receita Federal retenção 7 anos
    impacto: "alto"
    data: "2025-12-30"

  - decisao: "Classificação Automática Regras + Machine Learning"
    motivo: |
      Manual 120h/mês com 18% erro insustentável. ROI 4 meses
    impacto: "alto"
    data: "2025-12-30"

  - decisao: "Integração Bidirecional ERP via API REST"
    motivo: |
      Integração manual causa atrasos 12 dias fechamento. Redução 75% prazo
    impacto: "alto"
    data: "2025-12-30"

  - decisao: "Multi-Tenancy via Row-Level Security (ClienteId)"
    motivo: |
      Bancos separados não escalam. SaaS multi-tenant necessário
    impacto: "medio"
    data: "2025-12-30"

# Riscos de Migração
riscos_migracao:
  - risco: "Migração dados hierarquia recursiva falha"
    impacto: "alto"
    probabilidade: "media"
    mitigacao: |
      Script reversível + backup completo + testes carga dados reais

  - risco: "Performance queries recursivas CTE lenta"
    impacto: "alto"
    probabilidade: "baixa"
    mitigacao: |
      Índice composto + cache Redis estrutura + benchmark 100k contas

  - risco: "Usuários resistência classificação automática"
    impacto: "medio"
    probabilidade: "alta"
    mitigacao: |
      Treinamento + modo simulação + dashboard taxa match

  - risco: "Integração API ERP timeout/falha"
    impacto: "alto"
    probabilidade: "media"
    mitigacao: |
      Retry policy Polly + fallback manual + alertas TI

  - risco: "ML modelo baixa acurácia inicial"
    impacto: "medio"
    probabilidade: "alta"
    mitigacao: |
      Regras determinísticas primeiro, ML incremental 3 meses

  - risco: "Perda dados auditoria migração"
    impacto: "alto"
    probabilidade: "baixa"
    mitigacao: |
      Migrar log legado para nova estrutura + retenção 7 anos

# Rastreabilidade (Legado → Moderno)
rastreabilidade:
  - elemento_legado: "Centro_Custo.aspx"
    referencia_rf: "RN-RF031-03"
    referencia_uc: "UC01-Criar-Centro-Custo"
    status: "migrado"

  - elemento_legado: "Plano_Conta.aspx"
    referencia_rf: "RN-RF031-01, RN-RF031-02"
    referencia_uc: "UC01-Criar-Plano-Conta"
    status: "migrado"

  - elemento_legado: "Rateio.aspx"
    referencia_rf: "RN-RF031-03, RN-RF031-04"
    referencia_uc: "UC01-Criar-Configuracao-Rateio, UC02-Executar-Rateio"
    status: "migrado"

  - elemento_legado: "Template_Consulta.aspx"
    referencia_rf: "RN-RF031-08"
    referencia_uc: "UC05-Relatorio-DRE"
    status: "migrado"

  - elemento_legado: "pa_Centro_Custo"
    referencia_rf: "RN-RF031-03"
    referencia_uc: "UC01, UC03, UC04, UC00"
    status: "migrado"

  - elemento_legado: "pa_Plano_Conta"
    referencia_rf: "RN-RF031-01, RN-RF031-02"
    referencia_uc: "UC01-Criar-Plano-Conta, UC00-Listar-Plano-Contas"
    status: "migrado"

  - elemento_legado: "sp_Rateio_Calcular"
    referencia_rf: "RN-RF031-03"
    referencia_uc: "UC02-Executar-Rateio-Automatico"
    status: "migrado"

  - elemento_legado: "sp_Relatorio_DRE"
    referencia_rf: "RN-RF031-08"
    referencia_uc: "UC05-Relatorio-DRE"
    status: "migrado"

  - elemento_legado: "sp_Exportar_Lancamentos_DE"
    referencia_rf: "RN-RF031-07"
    referencia_uc: "UC06-Exportar-Lancamentos"
    status: "migrado"

# Changelog
changelog:
  - versao: "2.0"
    data: "2025-12-30"
    descricao: "Adequação para validador validator-rl.py (campo documentacao_id, seção referencias unificada)"
    autor: "Agência ALC - alc.dev.br"

  - versao: "1.0"
    data: "2025-12-30"
    descricao: "Documentação inicial referência legado fragmentado com rastreabilidade completa"
    autor: "Agência ALC - alc.dev.br"
