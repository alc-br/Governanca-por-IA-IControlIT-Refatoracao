# =============================================
# UC - Casos de Uso (Contrato Comportamental)
# RF071 - Pesquisa de Satisfação
# Versão: 2.0
# Data: 2025-12-31
# Autor: Claude Sonnet 4.5
# =============================================

uc:
  documentacao: "RF071"
  versao: "2.0"
  data: "2025-12-31"

ucs:

  - id: "UC00"
    nome: "Listar Pesquisas de Satisfação (Visualização Geral)"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      documentacao_items:
        - "RN-RF071-002"  # Cálculo Automático de NPS
        - "RN-RF071-008"  # Cálculo de CES
      uc_items:
        - id: "FP-UC00-001"
          title: "Usuário acessa módulo de pesquisas"
          required: true
        - id: "FP-UC00-002"
          title: "Sistema valida permissão pesquisas:dashboard:view"
          required: true
        - id: "FP-UC00-003"
          title: "Sistema carrega resumo de pesquisas ativas"
          required: true
        - id: "FP-UC00-004"
          title: "Sistema exibe métricas consolidadas (NPS, CSAT, CES, taxa resposta)"
          required: true
        - id: "FP-UC00-005"
          title: "Sistema renderiza lista paginada de pesquisas"
          required: true
        - id: "FA-UC00-001"
          title: "Filtrar por tipo de pesquisa (NPS/CSAT/CES)"
          required: false
        - id: "FA-UC00-002"
          title: "Ordenar por data, taxa resposta ou NPS"
          required: false
        - id: "FE-UC00-001"
          title: "Usuário sem permissão → acesso negado HTTP 403"
          required: true
        - id: "FE-UC00-002"
          title: "Nenhuma pesquisa ativa → estado vazio exibido"
          required: true

    precondicoes:
      - permissao: "pesquisas:dashboard:view"
      - feature_flag: "SERVICE_DESK_PESQUISA_SATISFACAO"

    gatilho: "Usuário acessa rota /service-desk/pesquisas"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessa_modulo_pesquisas"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "carregar_resumo_pesquisas_ativas"
      - passo: 4
        ator: "sistema"
        acao: "calcular_metricas_consolidadas"
      - passo: 5
        ator: "sistema"
        acao: "exibir_lista_paginada"

    fluxos_alternativos:
      - id: "FA-UC00-01"
        condicao: "usuario_aplica_filtro_tipo"
        resultado: "lista_filtrada_por_tipo"
      - id: "FA-UC00-02"
        condicao: "usuario_ordena_por_nps"
        resultado: "lista_ordenada_nps_desc"

    fluxos_excecao:
      - id: "FE-UC00-01"
        condicao: "sem_permissao"
        resultado: "acesso_negado_http_403"
      - id: "FE-UC00-02"
        condicao: "nenhuma_pesquisa_ativa"
        resultado: "estado_vazio_exibido"

    regras_aplicadas:
      - "RN-RF071-002"
      - "RN-RF071-008"

    resultado_final:
      estado: "lista_pesquisas_exibida"

  - id: "UC01"
    nome: "Listar e Configurar Templates de Pesquisa (NPS/CSAT/CES)"
    ator_principal: "gestor_service_desk"
    tipo: "crud"
    impacta_dados: true

    covers:
      documentacao_items:
        - "RN-RF071-004"  # Anonimização Configurável por Tipo de Pesquisa
        - "RN-RF071-006"  # Validação de Taxa de Resposta Mínima
        - "RN-RF071-007"  # Expiração de Link de Pesquisa
        - "RN-RF071-010"  # Limite de Caracteres em Respostas Abertas
      uc_items:
        - id: "FP-UC01-001"
          title: "Gestor acessa módulo de templates de pesquisa"
          required: true
        - id: "FP-UC01-002"
          title: "Sistema valida permissão service-desk:pesquisa-satisfacao:gestao"
          required: true
        - id: "FP-UC01-003"
          title: "Sistema carrega lista de templates existentes com métricas"
          required: true
        - id: "FP-UC01-004"
          title: "Gestor cria novo template com wizard 4 passos"
          required: true
        - id: "FP-UC01-005"
          title: "Sistema exibe designer de perguntas drag-and-drop (12 tipos)"
          required: true
        - id: "FP-UC01-006"
          title: "Gestor configura triggers automáticos (pós-chamado/SLA/agendamento)"
          required: true
        - id: "FP-UC01-007"
          title: "Gestor define canais de envio (e-mail/SMS/in-app/WhatsApp)"
          required: true
        - id: "FP-UC01-008"
          title: "Gestor estabelece nível de anonimização LGPD"
          required: true
        - id: "FP-UC01-009"
          title: "Sistema valida conformidade LGPD (RN-RF071-004)"
          required: true
        - id: "FP-UC01-010"
          title: "Sistema valida critérios de significância estatística (RN-RF071-006)"
          required: true
        - id: "FP-UC01-011"
          title: "Sistema cria template com status Inativo"
          required: true
        - id: "FP-UC01-012"
          title: "Gestor ativa template e sistema registra trigger no Hangfire"
          required: true
        - id: "FA-UC01-001"
          title: "Template NPS Relacional com anonimização total obrigatória"
          required: false
        - id: "FA-UC01-002"
          title: "Template com múltiplas perguntas e lógica condicional"
          required: false
        - id: "FA-UC01-003"
          title: "Validação de significância ao desativar template"
          required: false
        - id: "FA-UC01-004"
          title: "Exportação e importação de template entre clientes"
          required: false
        - id: "FE-UC01-001"
          title: "Usuário sem permissão → acesso negado HTTP 403"
          required: true
        - id: "FE-UC01-002"
          title: "Violação LGPD → NPS Relacional sem anonimização total HTTP 400"
          required: true
        - id: "FE-UC01-003"
          title: "Template sem perguntas → validação falha HTTP 400"
          required: true
        - id: "FE-UC01-004"
          title: "Trigger inválido ao ativar → erro de configuração HTTP 400"
          required: true

    precondicoes:
      - permissao: "service-desk:pesquisa-satisfacao:gestao"
      - feature_flag: "SERVICE_DESK_PESQUISA_SATISFACAO"

    gatilho: "Gestor acessa rota /service-desk/pesquisas/templates"

    fluxo_principal:
      - passo: 1
        ator: "gestor"
        acao: "acessa_modulo_templates"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao_rbac"
      - passo: 3
        ator: "sistema"
        acao: "listar_templates_existentes_com_metricas"
      - passo: 4
        ator: "gestor"
        acao: "criar_novo_template_wizard_4_passos"
      - passo: 5
        ator: "sistema"
        acao: "exibir_designer_perguntas_drag_drop"
      - passo: 6
        ator: "gestor"
        acao: "configurar_triggers_automaticos"
      - passo: 7
        ator: "gestor"
        acao: "definir_canais_envio_multi_canal"
      - passo: 8
        ator: "gestor"
        acao: "estabelecer_nivel_anonimizacao_lgpd"
      - passo: 9
        ator: "sistema"
        acao: "validar_conformidade_lgpd_rn004"
      - passo: 10
        ator: "sistema"
        acao: "validar_significancia_estatistica_rn006"
      - passo: 11
        ator: "sistema"
        acao: "criar_template_status_inativo"
      - passo: 12
        ator: "gestor"
        acao: "ativar_template"
      - passo: 13
        ator: "sistema"
        acao: "registrar_trigger_hangfire"

    fluxos_alternativos:
      - id: "FA-UC01-01"
        condicao: "template_nps_relacional_exige_anonimizacao_total"
        resultado: "sistema_forca_anonimizacao_total_desabilita_campo"
      - id: "FA-UC01-02"
        condicao: "template_com_logica_condicional_entre_perguntas"
        resultado: "sistema_serializa_condicoes_json_renderiza_dinamicamente"
      - id: "FA-UC01-03"
        condicao: "desativar_template_com_significancia_insuficiente"
        resultado: "sistema_exibe_warning_permite_desativar_com_flag"
      - id: "FA-UC01-04"
        condicao: "exportar_template_para_outro_cliente"
        resultado: "sistema_serializa_json_sem_dados_sensiveis_permite_importacao"

    fluxos_excecao:
      - id: "FE-UC01-01"
        condicao: "usuario_sem_permissao_gestao"
        resultado: "http_403_acesso_negado"
      - id: "FE-UC01-02"
        condicao: "violacao_lgpd_nps_relacional_nao_anonimizado"
        resultado: "http_400_lgpd_violation_exception"
      - id: "FE-UC01-03"
        condicao: "template_sem_perguntas_array_vazio"
        resultado: "http_400_fluent_validation_falha"
      - id: "FE-UC01-04"
        condicao: "ativar_template_trigger_invalido"
        resultado: "http_400_trigger_invalido"

    regras_aplicadas:
      - "RN-RF071-004"
      - "RN-RF071-006"
      - "RN-RF071-007"
      - "RN-RF071-010"

    resultado_final:
      estado: "template_criado_ativado_trigger_registrado_hangfire"

  - id: "UC02"
    nome: "Enviar Pesquisa Automaticamente via Trigger Pós-Chamado"
    ator_principal: "sistema_hangfire"
    tipo: "acao"
    impacta_dados: true

    covers:
      documentacao_items:
        - "RN-RF071-001"  # Frequência Máxima de Pesquisas (Anti-Fadiga)
        - "RN-RF071-007"  # Expiração de Link de Pesquisa
        - "RN-RF071-009"  # Correlação Automática com Chamado de Origem
      uc_items:
        - id: "FP-UC02-001"
          title: "Hangfire Job detecta chamado resolvido (trigger disparado)"
          required: true
        - id: "FP-UC02-002"
          title: "Job aguarda delay configurado no template (ex: 30min)"
          required: true
        - id: "FP-UC02-003"
          title: "Job carrega template ativo e dados do chamado"
          required: true
        - id: "FP-UC02-004"
          title: "Sistema valida throttling anti-fadiga (RN-RF071-001)"
          required: true
        - id: "FP-UC02-005"
          title: "Job cria registro RespostaPesquisa com token único e validade (RN-RF071-007)"
          required: true
        - id: "FP-UC02-006"
          title: "Job gera URL pública tokenizada da pesquisa"
          required: true
        - id: "FP-UC02-007"
          title: "Sistema seleciona canal prioritário (in-app/WhatsApp/e-mail/SMS)"
          required: true
        - id: "FP-UC02-008"
          title: "Job envia pesquisa via provedor externo (SendGrid/Twilio/WhatsApp API)"
          required: true
        - id: "FP-UC02-009"
          title: "Sistema registra evento de envio em auditoria"
          required: true
        - id: "FP-UC02-010"
          title: "Usuário acessa link da pesquisa"
          required: true
        - id: "FP-UC02-011"
          title: "Sistema valida token e verifica expiração (RN-RF071-007)"
          required: true
        - id: "FP-UC02-012"
          title: "Sistema renderiza formulário de pesquisa com contexto do chamado (RN-RF071-009)"
          required: true
        - id: "FP-UC02-013"
          title: "Usuário responde perguntas e envia avaliação"
          required: true
        - id: "FP-UC02-014"
          title: "Sistema valida respostas (limites de caracteres RN-RF071-010)"
          required: true
        - id: "FP-UC02-015"
          title: "Sistema salva resposta com correlação ao chamado origem (RN-RF071-009)"
          required: true
        - id: "FP-UC02-016"
          title: "Sistema exibe tela de agradecimento"
          required: true
        - id: "FA-UC02-001"
          title: "Throttling bloqueia envio (usuário recebeu pesquisa <7 dias)"
          required: false
        - id: "FA-UC02-002"
          title: "Falha no envio de e-mail → retry exponencial (1min/5min/15min)"
          required: false
        - id: "FA-UC02-003"
          title: "Link expirado → usuário tenta responder após 7 dias"
          required: false
        - id: "FA-UC02-004"
          title: "Pesquisa já respondida → tentativa de responder novamente"
          required: false
        - id: "FA-UC02-005"
          title: "Envio multi-canal simultâneo (e-mail + SMS) com URL shortener"
          required: false
        - id: "FE-UC02-001"
          title: "Template inativo ou excluído → job não encontra template"
          required: true
        - id: "FE-UC02-002"
          title: "Usuário sem e-mail ou telefone cadastrado"
          required: true
        - id: "FE-UC02-003"
          title: "Token inválido ou manipulado → tentativa de fraude"
          required: true

    precondicoes:
      - template_pesquisa_ativo_trigger_pos_chamado: true
      - feature_flag: "SERVICE_DESK_PESQUISA_SATISFACAO"
      - provedores_externos_configurados: "SendGrid, Twilio, WhatsApp Business API"

    gatilho: "Chamado resolvido dispara trigger pós-resolução"

    fluxo_principal:
      - passo: 1
        ator: "sistema"
        acao: "hangfire_job_detecta_chamado_resolvido"
      - passo: 2
        ator: "sistema"
        acao: "aguardar_delay_configurado_template"
      - passo: 3
        ator: "sistema"
        acao: "carregar_template_ativo_dados_chamado"
      - passo: 4
        ator: "sistema"
        acao: "validar_throttling_anti_fadiga_rn001"
      - passo: 5
        ator: "sistema"
        acao: "criar_registro_resposta_token_unico_validade_rn007"
      - passo: 6
        ator: "sistema"
        acao: "gerar_url_publica_tokenizada"
      - passo: 7
        ator: "sistema"
        acao: "selecionar_canal_prioritario_multi_canal"
      - passo: 8
        ator: "sistema"
        acao: "enviar_pesquisa_via_provedor_externo"
      - passo: 9
        ator: "sistema"
        acao: "registrar_evento_envio_auditoria"
      - passo: 10
        ator: "usuario"
        acao: "acessar_link_pesquisa"
      - passo: 11
        ator: "sistema"
        acao: "validar_token_verificar_expiracao_rn007"
      - passo: 12
        ator: "sistema"
        acao: "renderizar_formulario_pesquisa_contexto_chamado_rn009"
      - passo: 13
        ator: "usuario"
        acao: "responder_perguntas_enviar_avaliacao"
      - passo: 14
        ator: "sistema"
        acao: "validar_respostas_limites_caracteres_rn010"
      - passo: 15
        ator: "sistema"
        acao: "salvar_resposta_correlacao_chamado_origem_rn009"
      - passo: 16
        ator: "sistema"
        acao: "exibir_tela_agradecimento"

    fluxos_alternativos:
      - id: "FA-UC02-01"
        condicao: "throttling_detecta_pesquisa_enviada_ultimos_7_dias"
        resultado: "job_bloqueia_envio_registra_log_info_nao_envia_pesquisa"
      - id: "FA-UC02-02"
        condicao: "sendgrid_retorna_http_500_falha_temporaria"
        resultado: "retry_exponencial_backoff_1min_5min_15min_max_3_tentativas"
      - id: "FA-UC02-03"
        condicao: "link_expirado_usuario_tenta_abrir_apos_7_dias"
        resultado: "http_410_gone_frontend_exibe_mensagem_link_expirado"
      - id: "FA-UC02-04"
        condicao: "pesquisa_ja_respondida_tentativa_dupla"
        resultado: "http_409_conflict_frontend_exibe_mensagem_ja_respondida"
      - id: "FA-UC02-05"
        condicao: "envio_multi_canal_simultaneo_email_sms"
        resultado: "task_when_all_paralelo_url_shortener_bitly_para_sms"

    fluxos_excecao:
      - id: "FE-UC02-01"
        condicao: "template_csat_transacional_nao_encontrado_ou_inativo"
        resultado: "job_lanca_not_found_exception_finaliza_sem_enviar"
      - id: "FE-UC02-02"
        condicao: "usuario_sem_email_ou_telefone_cadastrado"
        resultado: "job_salva_status_falha_envio_motivo_sem_contatos"
      - id: "FE-UC02-03"
        condicao: "token_manipulado_query_nao_retorna_registro"
        resultado: "http_404_link_invalido_registra_security_event"

    regras_aplicadas:
      - "RN-RF071-001"
      - "RN-RF071-007"
      - "RN-RF071-009"

    resultado_final:
      estado: "pesquisa_enviada_resposta_salva_correlacao_preservada"

  - id: "UC03"
    nome: "Processar Resposta com Análise NLP e Follow-up Detratores"
    ator_principal: "sistema_event_handler"
    tipo: "acao"
    impacta_dados: true

    covers:
      documentacao_items:
        - "RN-RF071-002"  # Cálculo Automático de NPS
        - "RN-RF071-003"  # Follow-up Automático para Detratores
        - "RN-RF071-005"  # Análise de Sentimento Automática (NLP)
        - "RN-RF071-011"  # Prazo SLA de Follow-up para Gestores
      uc_items:
        - id: "FP-UC03-001"
          title: "Handler recebe evento PesquisaRespondidaEvent"
          required: true
        - id: "FP-UC03-002"
          title: "Handler carrega resposta completa com chamado origem"
          required: true
        - id: "FP-UC03-003"
          title: "Sistema extrai texto livre das respostas"
          required: true
        - id: "FP-UC03-004"
          title: "Sistema invoca análise de sentimento Azure Cognitive Services (RN-RF071-005)"
          required: true
        - id: "FP-UC03-005"
          title: "Sistema salva resultado NLP (score/classificação/keywords)"
          required: true
        - id: "FP-UC03-006"
          title: "Sistema dispara alerta se sentimento muito negativo (<-0.7)"
          required: true
        - id: "FP-UC03-007"
          title: "Sistema analisa correlação com chamado origem (RN-RF071-009)"
          required: true
        - id: "FP-UC03-008"
          title: "Sistema identifica causa raiz provável (tempo resposta/reaberturas)"
          required: true
        - id: "FP-UC03-009"
          title: "Sistema atualiza ranking de analista responsável"
          required: true
        - id: "FP-UC03-010"
          title: "Sistema calcula métrica agregada (NPS/CSAT/CES) (RN-RF071-002)"
          required: true
        - id: "FP-UC03-011"
          title: "Sistema valida significância estatística"
          required: true
        - id: "FP-UC03-012"
          title: "Sistema atualiza dashboard tempo real via SignalR (RN-RF071-012)"
          required: true
        - id: "FA-UC03-001"
          title: "Detrator NPS identificado → follow-up automático <2h (RN-RF071-003)"
          required: false
        - id: "FA-UC03-002"
          title: "Sentimento muito negativo → alerta imediato gestor"
          required: false
        - id: "FA-UC03-003"
          title: "Cálculo de NPS agregado com classificação Bain & Company"
          required: false
        - id: "FA-UC03-004"
          title: "Identificação de padrão de insatisfação por categoria"
          required: false
        - id: "FA-UC03-005"
          title: "CES crítico (≥6.2) → alerta de churn iminente"
          required: false
        - id: "FE-UC03-001"
          title: "Azure Cognitive Services timeout → análise não processada"
          required: true
        - id: "FE-UC03-002"
          title: "Chamado origem não encontrado → correlação falha"
          required: true
        - id: "FE-UC03-003"
          title: "Resposta duplicada → evento já processado"
          required: true
        - id: "FE-UC03-004"
          title: "Gestor Service Desk não configurado → follow-up falha"
          required: true

    precondicoes:
      - resposta_pesquisa_recebida_via_uc02: true
      - azure_cognitive_services_configurado: true
      - feature_flag: "SERVICE_DESK_PESQUISA_SATISFACAO"

    gatilho: "Evento PesquisaRespondidaEvent publicado após resposta"

    fluxo_principal:
      - passo: 1
        ator: "sistema"
        acao: "handler_recebe_evento_pesquisa_respondida"
      - passo: 2
        ator: "sistema"
        acao: "carregar_resposta_completa_chamado_origem"
      - passo: 3
        ator: "sistema"
        acao: "extrair_texto_livre_respostas_json"
      - passo: 4
        ator: "sistema"
        acao: "invocar_analise_sentimento_azure_nlp_rn005"
      - passo: 5
        ator: "sistema"
        acao: "salvar_resultado_nlp_score_classificacao_keywords"
      - passo: 6
        ator: "sistema"
        acao: "disparar_alerta_sentimento_muito_negativo"
      - passo: 7
        ator: "sistema"
        acao: "analisar_correlacao_chamado_origem_rn009"
      - passo: 8
        ator: "sistema"
        acao: "identificar_causa_raiz_provavel_tempo_reaberturas"
      - passo: 9
        ator: "sistema"
        acao: "atualizar_ranking_analista_responsavel"
      - passo: 10
        ator: "sistema"
        acao: "calcular_metrica_agregada_nps_csat_ces_rn002"
      - passo: 11
        ator: "sistema"
        acao: "validar_significancia_estatistica_rn006"
      - passo: 12
        ator: "sistema"
        acao: "atualizar_dashboard_tempo_real_signalr_rn012"

    fluxos_alternativos:
      - id: "FA-UC03-01"
        condicao: "detrator_nps_0_6_identificado"
        resultado: "dispara_3_acoes_paralelas_chamado_interno_notificacao_gestor_email_personalizado_2h_rn003"
      - id: "FA-UC03-02"
        condicao: "sentimento_score_menor_menos_0_7"
        resultado: "cria_alerta_critico_notificacao_sms_email_gestor_badge_vermelho_chamado"
      - id: "FA-UC03-03"
        condicao: "template_tipo_nps_calculo_agregado_trimestral"
        resultado: "calcula_nps_bain_company_promotores_detratores_classifica_faixa_benchmark_ti"
      - id: "FA-UC03-04"
        condicao: "15_de_20_respostas_csat_3_categoria_redes"
        resultado: "cria_recomendacao_automatica_investigacao_processo_equipe_75_insatisfacao"
      - id: "FA-UC03-05"
        condicao: "ces_maior_igual_6_2_alto_esforco"
        resultado: "alerta_critico_96_probabilidade_churn_task_action_reducao_ces_48h"

    fluxos_excecao:
      - id: "FE-UC03-01"
        condicao: "azure_cognitive_services_timeout_10_segundos"
        resultado: "salva_resposta_sem_analise_enfileira_reprocessamento_1h_hangfire"
      - id: "FE-UC03-02"
        condicao: "chamado_origem_id_null_pesquisa_relacional_nps"
        resultado: "correlador_retorna_analise_vazia_pula_passos_ranking_analista"
      - id: "FE-UC03-03"
        condicao: "resposta_id_ja_processada_flag_processado_true"
        resultado: "handler_finaliza_sem_reprocessar_idempotencia_garantida"
      - id: "FE-UC03-04"
        condicao: "gestor_service_desk_id_null_cliente_sem_gestor"
        resultado: "follow_up_falha_salva_motivo_falha_notifica_administrador_sistema"

    regras_aplicadas:
      - "RN-RF071-002"
      - "RN-RF071-003"
      - "RN-RF071-005"
      - "RN-RF071-011"

    resultado_final:
      estado: "resposta_processada_nlp_metricas_atualizadas_follow_up_detratores_disparado"

  - id: "UC04"
    nome: "Visualizar Dashboard Tempo Real com Métricas NPS/CSAT/CES"
    ator_principal: "gestor_service_desk"
    tipo: "leitura"
    impacta_dados: false

    covers:
      documentacao_items:
        - "RN-RF071-002"  # Cálculo Automático de NPS
        - "RN-RF071-008"  # Cálculo de CES (Customer Effort Score)
        - "RN-RF071-012"  # Dashboard Atualização SignalR
      uc_items:
        - id: "FP-UC04-001"
          title: "Gestor acessa dashboard de métricas de satisfação"
          required: true
        - id: "FP-UC04-002"
          title: "Sistema valida permissão service-desk:pesquisa-satisfacao:dashboard"
          required: true
        - id: "FP-UC04-003"
          title: "Frontend estabelece conexão SignalR e junta ao grupo do cliente"
          required: true
        - id: "FP-UC04-004"
          title: "Sistema verifica cache Redis (TTL 5min) (RN-RF071-012)"
          required: true
        - id: "FP-UC04-005"
          title: "Sistema executa 7 queries agregadas em paralelo se cache miss"
          required: true
        - id: "FP-UC04-006"
          title: "Sistema calcula NPS atual (% Promotores - % Detratores) (RN-RF071-002)"
          required: true
        - id: "FP-UC04-007"
          title: "Sistema calcula CSAT percentual (respostas 4-5 / total)"
          required: true
        - id: "FP-UC04-008"
          title: "Sistema calcula CES médio (média aritmética 1-7) (RN-RF071-008)"
          required: true
        - id: "FP-UC04-009"
          title: "Sistema retorna 18 widgets configuráveis (NPS Gauge/CSAT Trend/CES Heatmap/Word Cloud/Ranking Analistas)"
          required: true
        - id: "FP-UC04-010"
          title: "Frontend renderiza dashboard interativo com gráficos Chart.js"
          required: true
        - id: "FP-UC04-011"
          title: "Gestor aplica filtros facetados (período/categoria/analista/canal)"
          required: true
        - id: "FP-UC04-012"
          title: "Sistema atualiza dashboard em tempo real via SignalR a cada 5min (RN-RF071-012)"
          required: true
        - id: "FA-UC04-001"
          title: "Exportação de dados (Excel/PDF/PowerBI Dataset/REST API)"
          required: false
        - id: "FA-UC04-002"
          title: "Configuração de alertas customizados (8 condições críticas)"
          required: false
        - id: "FA-UC04-003"
          title: "Comparação de períodos (trimestre atual vs anterior)"
          required: false
        - id: "FA-UC04-004"
          title: "Dashboard mobile responsivo (gestor acessa via smartphone)"
          required: false
        - id: "FE-UC04-001"
          title: "Usuário sem permissão dashboard → acesso negado HTTP 403"
          required: true
        - id: "FE-UC04-002"
          title: "SignalR Hub offline → dashboard não atualiza tempo real"
          required: true
        - id: "FE-UC04-003"
          title: "Redis Cache offline → queries executadas direto no banco"
          required: true

    precondicoes:
      - permissao: "service-desk:pesquisa-satisfacao:dashboard"
      - feature_flag: "SERVICE_DESK_PESQUISA_SATISFACAO"
      - signalr_hub_configurado: true

    gatilho: "Gestor acessa rota /service-desk/pesquisas/dashboard"

    fluxo_principal:
      - passo: 1
        ator: "gestor"
        acao: "acessar_dashboard_metricas_satisfacao"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao_dashboard_rbac"
      - passo: 3
        ator: "sistema"
        acao: "estabelecer_conexao_signalr_juntar_grupo_cliente"
      - passo: 4
        ator: "sistema"
        acao: "verificar_cache_redis_ttl_5min_rn012"
      - passo: 5
        ator: "sistema"
        acao: "executar_7_queries_agregadas_paralelo_cache_miss"
      - passo: 6
        ator: "sistema"
        acao: "calcular_nps_atual_promotores_detratores_rn002"
      - passo: 7
        ator: "sistema"
        acao: "calcular_csat_percentual_respostas_4_5"
      - passo: 8
        ator: "sistema"
        acao: "calcular_ces_medio_aritmetica_1_7_rn008"
      - passo: 9
        ator: "sistema"
        acao: "retornar_18_widgets_configuraceis_nps_gauge_csat_trend_ces_heatmap_word_cloud_ranking"
      - passo: 10
        ator: "sistema"
        acao: "renderizar_dashboard_interativo_graficos_chartjs"
      - passo: 11
        ator: "gestor"
        acao: "aplicar_filtros_facetados_periodo_categoria_analista_canal"
      - passo: 12
        ator: "sistema"
        acao: "atualizar_dashboard_tempo_real_signalr_5min_rn012"

    fluxos_alternativos:
      - id: "FA-UC04-01"
        condicao: "gestor_solicita_exportacao_dados_excel_pdf_powerbi_api"
        resultado: "backend_gera_relatorio_formato_solicitado_download_direto"
      - id: "FA-UC04-02"
        condicao: "gestor_configura_alertas_customizados_8_condicoes"
        resultado: "backend_cria_hangfire_recurring_jobs_monitora_condicoes_envia_notificacoes"
      - id: "FA-UC04-03"
        condicao: "gestor_compara_periodos_trimestre_atual_vs_anterior"
        resultado: "backend_calcula_delta_percentual_exibe_graficos_comparativos_setas_tendencia"
      - id: "FA-UC04-04"
        condicao: "gestor_acessa_dashboard_smartphone_responsivo"
        resultado: "frontend_detecta_mobile_renderiza_layout_otimizado_touch_gestures"

    fluxos_excecao:
      - id: "FE-UC04-01"
        condicao: "usuario_sem_permissao_dashboard"
        resultado: "http_403_acesso_negado_redireciona_home"
      - id: "FE-UC04-02"
        condicao: "signalr_hub_offline_conexao_falha"
        resultado: "frontend_exibe_warning_atualizacao_tempo_real_indisponivel_fallback_reload_manual"
      - id: "FE-UC04-03"
        condicao: "redis_cache_offline_timeout"
        resultado: "backend_executa_queries_direto_banco_latencia_maior_sem_cache"

    regras_aplicadas:
      - "RN-RF071-002"
      - "RN-RF071-008"
      - "RN-RF071-012"

    resultado_final:
      estado: "dashboard_exibido_metricas_tempo_real_signalr_filtros_aplicados"

  - id: "UC05"
    nome: "Gerenciar Alertas e Recomendações de Melhoria"
    ator_principal: "gestor_service_desk"
    tipo: "crud"
    impacta_dados: true

    covers:
      documentacao_items:
        - "RN-RF071-003"  # Follow-up Automático para Detratores
        - "RN-RF071-011"  # Prazo SLA de Follow-up para Gestores
      uc_items:
        - id: "FP-UC05-001"
          title: "Gestor acessa módulo de alertas e recomendações"
          required: true
        - id: "FP-UC05-002"
          title: "Sistema lista alertas configurados (status/última verificação/disparos)"
          required: true
        - id: "FP-UC05-003"
          title: "Gestor cria novo alerta customizado (8 tipos disponíveis)"
          required: true
        - id: "FP-UC05-004"
          title: "Gestor configura limiares/janela temporal/destinatários/canais"
          required: true
        - id: "FP-UC05-005"
          title: "Sistema valida configuração do alerta"
          required: true
        - id: "FP-UC05-006"
          title: "Sistema registra Hangfire recurring job para monitoramento"
          required: true
        - id: "FP-UC05-007"
          title: "Hangfire executa job de monitoramento conforme recorrência"
          required: true
        - id: "FP-UC05-008"
          title: "Sistema calcula métrica e valida condição do alerta"
          required: true
        - id: "FP-UC05-009"
          title: "Sistema dispara notificações multi-canal (e-mail/in-app/webhook/SMS)"
          required: true
        - id: "FP-UC05-010"
          title: "Sistema registra histórico de disparo com snapshot de dados"
          required: true
        - id: "FP-UC05-011"
          title: "Gestor visualiza histórico de disparos e registra ações tomadas (RN-RF071-011)"
          required: true
        - id: "FA-UC05-001"
          title: "Alerta com palavras-gatilho em comentários (detecção a cada 15min)"
          required: false
        - id: "FA-UC05-002"
          title: "Recomendação automática gerada por padrão de insatisfação"
          required: false
        - id: "FA-UC05-003"
          title: "Exportar relatório de compliance de follow-up detratores (RN-RF071-003)"
          required: false
        - id: "FA-UC05-004"
          title: "Alerta customizado com operadores lógicos complexos (AND/OR)"
          required: false
        - id: "FE-UC05-001"
          title: "Configuração de alerta inválida → validação falha HTTP 400"
          required: true
        - id: "FE-UC05-002"
          title: "Job de monitoramento falha → erro registrado e notificado"
          required: true
        - id: "FE-UC05-003"
          title: "Webhook Slack retorna HTTP 500 → falha registrada tentativa posterior"
          required: true

    precondicoes:
      - permissao: "service-desk:pesquisa-satisfacao:gestao"
      - feature_flag: "SERVICE_DESK_PESQUISA_SATISFACAO"
      - hangfire_configurado: true

    gatilho: "Gestor acessa rota /service-desk/pesquisas/alertas"

    fluxo_principal:
      - passo: 1
        ator: "gestor"
        acao: "acessar_modulo_alertas_recomendacoes"
      - passo: 2
        ator: "sistema"
        acao: "listar_alertas_configurados_status_ultima_verificacao_disparos"
      - passo: 3
        ator: "gestor"
        acao: "criar_novo_alerta_customizado_8_tipos"
      - passo: 4
        ator: "gestor"
        acao: "configurar_limiares_janela_temporal_destinatarios_canais"
      - passo: 5
        ator: "sistema"
        acao: "validar_configuracao_alerta_threshold_janela_destinatarios"
      - passo: 6
        ator: "sistema"
        acao: "registrar_hangfire_recurring_job_monitoramento"
      - passo: 7
        ator: "sistema"
        acao: "hangfire_executa_job_monitoramento_recorrencia"
      - passo: 8
        ator: "sistema"
        acao: "calcular_metrica_validar_condicao_alerta"
      - passo: 9
        ator: "sistema"
        acao: "disparar_notificacoes_multi_canal_email_inapp_webhook_sms"
      - passo: 10
        ator: "sistema"
        acao: "registrar_historico_disparo_snapshot_dados"
      - passo: 11
        ator: "gestor"
        acao: "visualizar_historico_disparos_registrar_acoes_tomadas_rn011"

    fluxos_alternativos:
      - id: "FA-UC05-01"
        condicao: "alerta_palavras_gatilho_comentarios_deteccao_15min"
        resultado: "job_busca_respostas_15min_verifica_palavras_lista_dispara_alerta_urgente_se_detectado"
      - id: "FA-UC05-02"
        condicao: "padrao_insatisfacao_90_categoria_suporte_nivel_2"
        resultado: "handler_cria_recomendacao_automatica_3_acoes_sugeridas_gestor_aceita_cria_plano_acao"
      - id: "FA-UC05-03"
        condicao: "exportar_relatorio_compliance_follow_up_detratores_rn003"
        resultado: "backend_calcula_percentual_compliance_sla_2h_gera_pdf_assinatura_digital_auditoria"
      - id: "FA-UC05-04"
        condicao: "alerta_customizado_operadores_logicos_and_or"
        resultado: "backend_avalia_expressao_logica_complexa_dispara_se_condicao_composta_verdadeira"

    fluxos_excecao:
      - id: "FE-UC05-01"
        condicao: "configuracao_alerta_invalida_threshold_0_100_janela_0"
        resultado: "http_400_fluent_validation_falha_mensagens_erro_especificas"
      - id: "FE-UC05-02"
        condicao: "job_monitoramento_falha_excecao_nao_tratada"
        resultado: "hangfire_registra_erro_envia_notificacao_devops_retry_automatico"
      - id: "FE-UC05-03"
        condicao: "webhook_slack_retorna_http_500_falha_temporaria"
        resultado: "backend_registra_falha_historico_marca_notificacao_nao_entregue_retry_1h"

    regras_aplicadas:
      - "RN-RF071-003"
      - "RN-RF071-011"

    resultado_final:
      estado: "alerta_criado_hangfire_job_registrado_monitoramento_ativo_notificacoes_disparadas"

exclusions:
  uc_items: []

historico:
  - versao: "1.0"
    data: "2025-12-30"
    autor: "Equipe IControlIT"
    descricao: "Versão inicial narrativa com 5 casos de uso"
  - versao: "2.0"
    data: "2025-12-31"
    autor: "Claude Sonnet 4.5"
    descricao: "Adequação completa - migração nomenclatura RN-SAT-071-XX → RN-RF071-XXX + estrutura UC.yaml v2.0 + cobertura 100% das 12 regras de negócio"
