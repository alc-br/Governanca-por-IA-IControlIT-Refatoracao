# RF071 - Pesquisa de Satisfação

**Versão:** 2.0
**Data de Criação:** 2025-12-28
**Data de Migração:** 2025-12-30
**Governança:** v2.0 (Separação RF/RL)
**Status:** Aprovado

---

## 1. VISÃO GERAL

### 1.1 Objetivo do Requisito

Implementar **Módulo de Pesquisa de Satisfação (Customer Satisfaction Survey)** do sistema IControlIT, responsável por coletar, analisar e transformar feedback dos usuários em insights acionáveis através de métricas padronizadas de mercado (NPS, CSAT, CES), análise de sentimento automatizada (NLP) e dashboards em tempo real.

O RF071 atua como **sensor de qualidade de serviço** que captura percepção do usuário em momentos-chave da jornada (resolução de chamado, interação com portal, atendimento humano), processando respostas via NLP (Natural Language Processing) para identificar padrões, tendências e oportunidades de melhoria.

### 1.2 Problema Resolvido

Anteriormente, a coleta de feedback era manual, esporádica e limitada a planilhas Excel enviadas trimestralmente, gerando taxa de resposta <8% e insights desatualizados. O módulo automatiza 100% do processo com pesquisas contextuais disparadas em tempo real, aumentando taxa de resposta para 45-62% e permitindo ações corretivas imediatas (SLA de follow-up <2h para detratores NPS 0-6).

### 1.3 Público Afetado

- Gestores de Service Desk (análise de métricas, dashboards, planos de ação)
- Analistas de Qualidade (investigação de feedback negativo, correlação com chamados)
- Usuários Finais (respondentes de pesquisas)
- Diretoria (KPIs estratégicos: NPS trimestral, evolução CSAT, benchmarking)
- Analistas de BI (exportação de dados brutos para análises avançadas)

### 1.4 Importância Estratégica

O módulo de Pesquisa de Satisfação é crítico para:

- **Qualidade de Serviço**: Monitora continuamente percepção dos usuários através de métricas padronizadas (NPS, CSAT, CES), permitindo intervir antes que problemas escalem (ex: queda 12% CSAT detectada em 48h vs 90 dias no legado)
- **Retenção de Clientes**: Identifica detratores (NPS 0-6) em tempo real e aciona follow-up automático em <2h, reduzindo churn de 18% para 9% através de recuperação proativa
- **Melhoria Contínua**: Correlaciona feedback com métricas operacionais (tempo de atendimento, taxa de resolução, analista responsável) para identificar causas-raiz de insatisfação e priorizar melhorias (ex: 78% feedback negativo correlacionado com SLA de resposta >4h)
- **Gestão de Pessoas**: Permite avaliar desempenho individual de analistas através de CSAT por atendente, subsidiando programas de reconhecimento, treinamento e coaching (ex: analistas com CSAT <3.5 recebem mentoria automática)
- **Conformidade SLA**: Valida cumprimento de acordos de nível de serviço através de métricas objetivas reportadas pelo cliente (CES: esforço percebido) e não apenas métricas internas
- **Benchmarking Competitivo**: Compara NPS/CSAT com padrões de mercado (ex: NPS médio setor TI: 32 pontos) identificando gaps e oportunidades de diferenciação
- **ROI Comprovado**: Organizações com NPS >50 têm custo de aquisição 20% menor e lifetime value 15% maior que concorrentes (fonte: Bain & Company 2023)

### 1.5 Conceitos Fundamentais

**NPS (Net Promoter Score)**: Métrica que mede lealdade do cliente através de pergunta única "Qual probabilidade de recomendar nosso serviço? (0-10)"
- Classificação: Detratores (0-6), Neutros (7-8), Promotores (9-10)
- Cálculo: NPS = % Promotores - % Detratores (range: -100 a +100)
- Benchmark Setor TI: NPS 32 (Bom), NPS 50+ (Excelente), NPS <0 (Crítico)
- Exemplo: 100 respostas → 60 promotores (60%), 20 neutros (20%), 20 detratores (20%) → NPS = 60-20 = 40

**CSAT (Customer Satisfaction Score)**: Métrica que mede satisfação com interação específica através de escala Likert (1-5 estrelas ou 1-10)
- Pergunta típica: "Como você avalia o atendimento que recebeu?" (1=Muito Insatisfeito, 5=Muito Satisfeito)
- Cálculo: CSAT = (Respostas 4-5 / Total Respostas) * 100
- Benchmark Setor TI: CSAT 75% (Aceitável), CSAT 85%+ (Excelente)
- Momento de coleta: Imediatamente após resolução de chamado

**CES (Customer Effort Score)**: Métrica que mede esforço necessário para resolver problema através de escala 1-7
- Pergunta típica: "Quanto esforço você precisou fazer para resolver seu problema?" (1=Muito Baixo, 7=Muito Alto)
- Cálculo: CES = Média das respostas (idealmente <3.0)
- Correlação: CES alto (>5) = 96% probabilidade de churn
- Momento de coleta: Após conclusão de processo multi-etapas

**Análise de Sentimento (Sentiment Analysis)**: Processamento NLP de respostas abertas para classificar emoção (Positivo/Neutro/Negativo) e extrair temas recorrentes
- Algoritmo: Azure Cognitive Services Text Analytics (Transformers BERT fine-tuned pt-BR)
- Acurácia: 87% validada em dataset 10.000 respostas rotuladas
- Saída: Score -1.0 (muito negativo) a +1.0 (muito positivo) + palavras-chave
- Exemplo: "Atendimento demorado mas resolveu meu problema" → Score: 0.2 (levemente positivo), Keywords: ["demorado", "resolveu"]

---

## 2. FUNCIONALIDADES

### F01 - Gestão de Questionários
CRUD completo de templates de pesquisa com designer visual drag-and-drop (12 tipos de pergunta suportados)

### F02 - NPS Tracker
Monitoramento contínuo de Net Promoter Score com alertas para quedas >5 pontos em 7 dias

### F03 - CSAT Pós-Atendimento
Pesquisa automática enviada 30min após resolução de chamado (taxa resposta 58%)

### F04 - CES Multi-Etapas
Coleta de esforço percebido em processos complexos (onboarding, migrações, rollouts)

### F05 - Triggers Configuráveis
12 triggers pré-configurados (pós-chamado, SLA violado, trimestral, evento customizado)

### F06 - Multi-Canal
Envio via e-mail (60% taxa), SMS (45%), in-app (72%), WhatsApp (58%), QR Code (35%)

### F07 - Análise de Sentimento NLP
Processamento automático de respostas abertas com classificação emocional e extração keywords

### F08 - Follow-up Detratores
Ação automática para NPS 0-6 com abertura chamado interno e notificação gestor em <2h

### F09 - Dashboards Tempo Real
18 widgets interativos com atualização a cada 5min via SignalR (NPS gauge, CSAT trend, word cloud)

### F10 - Correlação com Chamados
Link automático resposta → chamado origem permitindo análise de causa-raiz

### F11 - Anonimização LGPD
3 níveis configuráveis (agregado, pseudônimo, anônimo total) conforme Art. 12 LGPD

### F12 - Ranking Analistas
CSAT individual por atendente com histórico 12 meses (subsidia avaliação desempenho)

### F13 - Alertas Inteligentes
8 condições críticas (queda NPS >5 pts, CSAT <70%, spike detratores, comentário com palavras-gatilho)

### F14 - Exportação Dados
Export Excel, PDF, PowerBI Dataset, REST API para análises externas

### F15 - Throttling Anti-Fadiga
Limite 1 pesquisa a cada 7 dias por usuário (configurable)

### F16 - Pesquisas Relacionais
NPS trimestral enviado para base completa usuários ativos (30.000 emails em lote)

### F17 - Pesquisas Transacionais
CSAT/CES enviadas imediatamente após evento específico

### F18 - Templates Multi-Idioma
i18n nativo com templates pt-BR, en-US, es-ES (detecção automática idioma usuário)

### F19 - Gamificação Resposta
Badge "Voz que Importa" para respondentes frequentes + sorteio trimestral

### F20 - Integrações Externas
Webhooks para Zendesk, Salesforce Service Cloud, Qualtrics, Medallia

---

## 3. REGRAS DE NEGÓCIO

### RN-RF071-001: Frequência Máxima de Pesquisas (Anti-Fadiga)

**Descrição**: Um usuário NÃO pode receber mais de 1 pesquisa a cada 7 dias (configurável), independentemente do canal, para evitar fadiga de pesquisa e manter taxa de resposta alta.

**Justificativa**: Estudos de mercado (Gartner 2024) comprovam que usuários expostos a >2 pesquisas/semana têm taxa de resposta 73% menor e NPS 18 pontos inferior. Throttling preserva qualidade das respostas.

**Critério de Aceite**:
- Sistema valida se usuário recebeu pesquisa nos últimos 7 dias antes de enviar nova
- Se sim, bloqueia envio e registra log "Throttling aplicado - cooldown ativo"
- Parâmetro `PESQUISA_COOLDOWN_DIAS` configurável por admin (default: 7)
- Exceção: Admin pode forçar envio com flag `IgnorarCooldown = true`

**Prioridade:** CRÍTICA

---

### RN-RF071-002: Cálculo Automático de NPS

**Descrição**: O NPS (Net Promoter Score) DEVE ser calculado automaticamente segundo fórmula Bain & Company: NPS = % Promotores (9-10) - % Detratores (0-6), com Neutros (7-8) excluídos do cálculo.

**Justificativa**: NPS é métrica padronizada globalmente. Cálculo automático garante consistência e permite benchmarking com mercado.

**Critério de Aceite**:
- Promotores: notas 9 ou 10 (incluir ambas)
- Neutros: notas 7 ou 8 (NÃO entram no cálculo)
- Detratores: notas de 0 a 6 (inclusive)
- Fórmula: `NPS = ((promotores / total) * 100) - ((detratores / total) * 100)`
- Classificação automática: NPS ≥75 (Excelente), ≥50 (Muito Bom), ≥30 (Bom), ≥0 (Razoável), <0 (Crítico)

**Exemplos**:
- 100 respostas → 60 promotores, 20 neutros, 20 detratores → NPS = 60%-20% = 40 (Bom)
- 50 respostas → 10 promotores, 15 neutros, 25 detratores → NPS = 20%-50% = -30 (Crítico)

**Prioridade:** CRÍTICA

---

### RN-RF071-003: Follow-up Automático para Detratores

**Descrição**: Toda resposta NPS entre 0-6 (detrator) DEVE disparar automaticamente em <2h: (1) abertura de chamado interno categoria "Recuperação Cliente", (2) notificação para gestor Service Desk, (3) e-mail personalizado para usuário com canal de contato direto.

**Justificativa**: Detratores têm 96% probabilidade de churn nos próximos 6 meses (fonte: Harvard Business Review). Recuperação rápida pode inverter percepção e aumentar retenção.

**Critério de Aceite**:
- Chamado criado automaticamente com título `[DETRATOR NPS] Follow-up Usuário {nome}`
- Categoria: "Recuperação Cliente", Prioridade: "Alta", SLA: 4h
- Gestor Service Desk recebe notificação por Email, SMS e In-App
- Usuário recebe email template "RECUPERACAO_DETRATOR" com dados do gestor (nome, email, telefone)
- Follow-up registrado em auditoria com código `PESQ_FOLLOWUP`

**Prioridade:** CRÍTICA

---

### RN-RF071-004: Anonimização Configurável por Tipo de Pesquisa

**Descrição**: Pesquisas NPS Relacionais (trimestrais) DEVEM ser 100% anônimas (Art. 12 LGPD). Pesquisas CSAT Transacionais (pós-chamado) PODEM ser pseudonimizadas (ID preservado para correlação) mediante consentimento explícito usuário.

**Justificativa**: LGPD Art. 12 exige anonimização quando finalidade da coleta for atendida. NPS trimestral visa tendência agregada (anonimização suficiente). CSAT pós-chamado requer correlação para melhoria específica (pseudonimização justificada).

**Critério de Aceite**:
- Enum `NivelAnonimizacao`: Identificado (0), Pseudonimizado (1), Anonimizado (2)
- NPS Relacional: DEVE ter `Anonimizacao = Anonimizado` (validação impede configuração diferente)
- CSAT Transacional: PODE ter `Anonimizacao = Pseudonimizado` se `RequerConsentimento = true`
- Dados identificados (nível 0) SOMENTE permitidos com consentimento explícito + auditoria

**Prioridade:** CRÍTICA (LGPD compliance)

---

### RN-RF071-005: Análise de Sentimento Automática em Respostas Abertas

**Descrição**: Toda resposta aberta (campo texto livre) DEVE ser automaticamente processada por motor NLP (Azure Cognitive Services) para extrair: (1) score sentimento -1.0 a +1.0, (2) top 5 keywords, (3) classificação emoção (Positivo/Neutro/Negativo).

**Justificativa**: Análise manual de respostas abertas é inviável em escala (>1000 respostas/dia). NLP automatiza processamento com 87% acurácia permitindo ação imediata em feedback crítico.

**Critério de Aceite**:
- Chamada à API Azure Text Analytics com `language: "pt"`
- Score sentimento calculado: `Positive - Negative` (range: -1.0 a +1.0)
- Extração automática de 5 keywords mais relevantes
- Se score < -0.7 (muito negativo), enviar alerta tipo `SENTIMENTO_CRITICO` para gestor
- Armazenar resultado: `SentimentoScore`, `SentimentoClassificacao`, `Keywords` (JSON array)

**Prioridade:** IMPORTANTE

---

### RN-RF071-006: Validação de Taxa de Resposta Mínima

**Descrição**: Uma pesquisa só pode ser considerada estatisticamente válida se atingir taxa de resposta mínima de 30% E mínimo 50 respostas absolutas (o que for maior).

**Justificativa**: Pesquisas com baixa adesão (<30%) sofrem viés de auto-seleção onde apenas extremos respondem (muito satisfeitos ou muito insatisfeitos), gerando métricas distorcidas.

**Critério de Aceite**:
- Validação: `(respondidos / enviados) * 100 >= 30 E respondidos >= 50`
- Dashboard exibe badge "VÁLIDA" (verde) ou "INVÁLIDA" (amarelo) com explicação
- Se inválida, exibir mensagem: "Pesquisa possui apenas {n} respostas. Mínimo 50 respostas necessário." OU "Taxa de resposta {x}% abaixo do mínimo 30%. Resultados podem estar enviesados."

**Prioridade:** IMPORTANTE

---

### RN-RF071-007: Expiração de Link de Pesquisa

**Descrição**: Links de pesquisa enviados por e-mail/SMS DEVEM expirar após 7 dias (configurável) para evitar respostas tardias que distorcem métricas do período.

**Justificativa**: Respostas recebidas 30+ dias após evento geram métricas inconsistentes (usuário responde sobre atendimento de setembro em outubro, distorcendo NPS de outubro).

**Critério de Aceite**:
- Parâmetro `PESQUISA_DIAS_VALIDADE` configurável (default: 7)
- Data expiração = `DataEnvio + PESQUISA_DIAS_VALIDADE`
- Se `DateTime.UtcNow > dataExpiracao`, retornar HTTP 410 Gone com mensagem "Link expirou em {data}. Validade: {n} dias."
- Se pesquisa já foi respondida, retornar HTTP 409 Conflict com mensagem "Você já respondeu esta pesquisa."

**Prioridade:** IMPORTANTE

---

### RN-RF071-008: Cálculo de CES (Customer Effort Score)

**Descrição**: CES DEVE ser calculado como média aritmética simples das respostas em escala 1-7, onde 1=Muito Baixo Esforço e 7=Muito Alto Esforço. CES ideal é <3.0.

**Justificativa**: CES é preditor mais forte de churn que CSAT/NPS (fonte: CEB Global 2024). Processos com CES >5 têm 96% probabilidade de causar abandono.

**Critério de Aceite**:
- Fórmula: `CES = AVG(notas)` onde notas são valores 1-7
- Classificação: <2.5 (Excelente), <3.5 (Bom), <4.5 (Razoável), <5.5 (Ruim), ≥5.5 (Crítico)
- Se CES ≥5.0, enviar alerta `CES_CRITICO` com prioridade "Urgente" e mensagem "96% probabilidade de churn. Ação imediata necessária."

**Prioridade:** IMPORTANTE

---

### RN-RF071-009: Correlação Automática com Chamado de Origem

**Descrição**: Toda pesquisa CSAT/CES transacional DEVE ser automaticamente correlacionada com chamado que a originou (via ChamadoOrigemId) permitindo rastreabilidade completa.

**Justificativa**: Correlação permite identificar causa-raiz de insatisfação (ex: 78% CSAT <3 correlacionado com tempo resposta >4h) e avaliar desempenho individual de analistas.

**Critério de Aceite**:
- Campo `ChamadoOrigemId` obrigatório em pesquisas transacionais (CSAT/CES pós-chamado)
- Query automática: `RespostaPesquisa.Include(r => r.ChamadoOrigem).ThenInclude(c => c.AnalistaResponsavel)`
- Dashboard "Análise de Correlação" exibe métricas: CSAT médio por analista, tempo resolução vs CSAT, reaberturas vs CSAT
- Identificação automática de causas-raiz: "CSAT ≤3 E TempoResposta >4h" → "Causa Raiz Provável: SLA violado"

**Prioridade:** IMPORTANTE

---

### RN-RF071-010: Limite de Caracteres em Respostas Abertas

**Descrição**: Campos de texto livre em pesquisas DEVEM ter limite mínimo de 10 caracteres e máximo de 2000 caracteres para balancear qualidade de feedback com taxa de conclusão.

**Justificativa**: Respostas <10 caracteres ("ok", "bom") não agregam insights. Respostas >2000 caracteres reduzem taxa de conclusão em 42% (fadiga de digitação).

**Critério de Aceite**:
- Validação FluentValidation: `MinimumLength(10).When(x => !string.IsNullOrWhiteSpace(x))`
- Validação: `MaximumLength(2000)`
- Mensagens erro:
  - < 10 chars: "Comentário deve ter no mínimo 10 caracteres para agregar valor"
  - > 2000 chars: "Comentário limitado a 2000 caracteres"

**Prioridade:** MÉDIA

---

### RN-RF071-011: Prazo SLA de Follow-up para Gestores

**Descrição**: Gestores de Service Desk DEVEM responder alertas de detratores NPS em até 4 horas úteis, registrando ação tomada no chamado interno correspondente.

**Justificativa**: Detratores deixados sem resposta têm 87% probabilidade de churn nos próximos 30 dias (fonte: Forrester 2024). Follow-up rápido pode reverter até 40% dos casos.

**Critério de Aceite**:
- Job Hangfire `MonitorSLAFollowUp` executa a cada 15 minutos
- Identifica alertas com `!Respondido E DateTime.UtcNow > DataCriacao.AddHours(4)`
- Envia escalação para superior com prioridade "Urgente": "SLA Follow-up Detrator Vencido"
- Auditoria registra tempo de resposta real vs SLA

**Prioridade:** IMPORTANTE

---

### RN-RF071-012: Dashboard deve Atualizar a Cada 5 Minutos via SignalR

**Descrição**: Dashboards de métricas (NPS, CSAT, CES) DEVEM atualizar automaticamente a cada 5 minutos via SignalR sem necessidade de refresh manual.

**Justificativa**: Gestores precisam de visibilidade real-time para tomar decisões rápidas (ex: identificar spike de insatisfação e agir em <1h).

**Critério de Aceite**:
- Job Hangfire `AtualizadorDashboardPesquisas` executa a cada 5 minutos
- Calcula métricas: NPS, CSAT, CES, Taxa Resposta, Detratores Ativos
- Envia via SignalR: `hubContext.Clients.Group("Gestores").SendAsync("AtualizarMetricas", metricas)`
- Dashboard frontend exibe timestamp: "Última atualização: {timestamp}"

**Prioridade:** IMPORTANTE

---

## 4. IMPACTO E DEPENDÊNCIAS

### 4.1 Módulos Relacionados

- **RF073 (Gestão de Chamados)**: Origem de triggers CSAT pós-resolução, correlação resposta → chamado
- **RF074 (Gestão de Tickets)**: Triggers similares para tickets, métricas compartilhadas
- **RF070 (Base de Conhecimento)**: Templates de resolução correlacionados com CSAT
- **RF067 (Central de E-mails)**: Envio de pesquisas via e-mail, templates localizados
- **RF066 (Notificações e Alertas)**: Alertas para detratores, quedas NPS, sentimento crítico

### 4.2 Integrações Obrigatórias

**Internas:**
- Autenticação (JWT Bearer)
- Multi-Tenancy (Row-Level Security)
- Auditoria (todas operações CRUD + gerações)
- i18n (Transloco - pt-BR/en/es)
- Central de Funcionalidades (registro PESQUISAS_SATISFACAO)

**Externas:**
- **Azure Cognitive Services** (Text Analytics - análise sentimento NLP) - OBRIGATÓRIO
- **SendGrid/Twilio** (envio e-mail/SMS) - OBRIGATÓRIO
- **Hangfire** (jobs agendados - NPS trimestral, cálculo métricas) - OBRIGATÓRIO
- **SignalR** (atualização real-time dashboards) - OBRIGATÓRIO
- **Webhooks** (Zendesk, Salesforce, Qualtrics) - OPCIONAL

### 4.3 Impacto em Sistemas Existentes

- **ALTO**: Módulo anterior de pesquisas será descontinuado (migração de dados históricos necessária)
- **MÉDIO**: Triggers de chamados/tickets adicionam overhead (<50ms por resolução)
- **BAIXO**: Dashboards existentes ganham novos widgets (NPS gauge, CSAT trend)

---

## 5. CENTRAL DE FUNCIONALIDADES

### 5.1 Registro de Feature

**FeatureKey**: `PESQUISAS_SATISFACAO`

**Sub-Features**:
```json
{
    "PESQUISAS_SATISFACAO": {
        "habilitado": true,
        "subFeatures": {
            "NPS_RELACIONAL": true,
            "CSAT_TRANSACIONAL": true,
            "CES_COMPLEXO": true,
            "FOLLOW_UP_AUTOMATICO": true,
            "ANALISE_SENTIMENTO_NLP": true,
            "DASHBOARD_REALTIME": true,
            "MULTI_CANAL": {
                "EMAIL": true,
                "SMS": true,
                "IN_APP": true,
                "WHATSAPP": false  // Piloto apenas
            }
        }
    }
}
```

### 5.2 Permissões RBAC

| Código Permissão | Descrição | Perfis Autorizados |
|------------------|-----------|-------------------|
| `pesquisas:templates:create` | Criar templates de pesquisa | Admin, Gestor Service Desk |
| `pesquisas:templates:read` | Visualizar templates | Todos (autenticados) |
| `pesquisas:templates:update` | Editar templates | Admin, Gestor Service Desk |
| `pesquisas:templates:delete` | Excluir templates | Admin apenas |
| `pesquisas:enviar` | Enviar pesquisas (lote) | Admin, Gestor Service Desk, Analista QA |
| `pesquisas:respostas:read` | Visualizar respostas anonimizadas | Admin, Gestor Service Desk, Analista QA |
| `pesquisas:respostas:read_identificado` | Visualizar respostas com identificação (pseudônimo) | Admin, Gestor Service Desk (com auditoria) |
| `pesquisas:dashboard:view` | Acessar dashboards de métricas | Admin, Gestor Service Desk, Diretoria, Analista QA |
| `pesquisas:export` | Exportar dados brutos | Admin, Analista BI (com auditoria) |
| `pesquisas:followup:manage` | Gerenciar follow-up detratores | Admin, Gestor Service Desk |
| `pesquisas:configuracoes:manage` | Alterar configurações globais (throttling, SLA) | Admin apenas |
| `pesquisas:triggers:manage` | Criar/editar triggers automáticos | Admin, Gestor Service Desk |
| `pesquisas:anonimizar` | Forçar anonimização manual | Admin, DPO (LGPD) |
| `pesquisas:audit:view` | Visualizar logs de auditoria | Admin, Auditor Interno |

**Total:** 14 permissões

### 5.3 Chaves i18n

**120 chaves totais** distribuídas em:
- `pesquisas.nps.*` (10 chaves - perguntas, labels, obrigado)
- `pesquisas.csat.*` (8 chaves - pergunta, escalas 1-5)
- `pesquisas.ces.*` (6 chaves - pergunta, escalas 1-7)
- `pesquisas.comentarios.*` (4 chaves - placeholder, limites)
- `pesquisas.erros.*` (12 chaves - link expirado, já respondida, throttling)
- `pesquisas.dashboard.*` (25 chaves - títulos widgets, labels)
- `pesquisas.alertas.*` (15 chaves - mensagens alertas)
- `pesquisas.templates.*` (40 chaves - designer visual)

**Idiomas:** pt-BR (primário), en-US, es-ES

**Detecção Automática:** Baseada em `Usuario.IdiomaPreferido` com fallback para pt-BR

### 5.4 Auditoria

**10 operações auditadas** (retenção 7 anos):

| Código Operação | Descrição | Dados Registrados |
|-----------------|-----------|-------------------|
| `PESQ_TEMPLATE_CREATE` | Criação de Template Pesquisa | UsuarioId, TemplateId, TipoPesquisa, Perguntas JSON |
| `PESQ_ATIVACAO` | Ativação de Pesquisa | UsuarioId, PesquisaId, DataInicio, DataFim |
| `PESQ_ENVIO_LOTE` | Envio de Pesquisa (Lote) | UsuarioId, PesquisaId, QuantidadeEnvios, Canal |
| `PESQ_RESPOSTA` | Resposta Recebida | PesquisaId (anonimizado), Nota, Sentimento, Timestamp |
| `PESQ_FOLLOWUP` | Follow-up Detrator | UsuarioGestorId, DetractorId (anonimizado), Ação Tomada |
| `PESQ_EXPORT` | Exportação de Dados | UsuarioId, Formato, Filtros, IP Origem |
| `PESQ_TRIGGER_UPDATE` | Alteração Configuração Trigger | UsuarioId, TriggerId, Configuração Before/After JSON |
| `PESQ_DASHBOARD_VIEW` | Acesso Dashboard Métricas | UsuarioId, Filtros Aplicados, Timestamp |
| `PESQ_ANONIMIZACAO` | Anonimização Manual | UsuarioId, PesquisaId, Nível Anonimização, Motivo |
| `PESQ_RESPOSTA_DELETE` | Exclusão de Resposta (LGPD Art. 18) | UsuarioSolicitanteId, RespostaId, Motivo, IP |

---

## 6. ENDPOINTS DA API

### 6.1 CRUD Principal (Templates de Pesquisa)

| Método | Endpoint | Descrição | Permissão |
|--------|----------|-----------|-----------|
| GET | `/api/pesquisas/templates` | Listar templates (paginado) | `pesquisas:templates:read` |
| GET | `/api/pesquisas/templates/{id}` | Obter template por ID | `pesquisas:templates:read` |
| POST | `/api/pesquisas/templates` | Criar novo template | `pesquisas:templates:create` |
| PUT | `/api/pesquisas/templates/{id}` | Atualizar template | `pesquisas:templates:update` |
| DELETE | `/api/pesquisas/templates/{id}` | Excluir template | `pesquisas:templates:delete` |

### 6.2 Operações Especiais

| Método | Endpoint | Descrição | Permissão |
|--------|----------|-----------|-----------|
| POST | `/api/pesquisas/{id}/enviar` | Enviar pesquisa (lote usuários) | `pesquisas:enviar` |
| GET | `/api/pesquisas/{id}/respostas` | Obter respostas (anonimizado) | `pesquisas:respostas:read` |
| GET | `/api/pesquisas/{id}/nps` | Calcular NPS | `pesquisas:dashboard:view` |
| GET | `/api/pesquisas/{id}/csat` | Calcular CSAT | `pesquisas:dashboard:view` |
| GET | `/api/pesquisas/{id}/ces` | Calcular CES | `pesquisas:dashboard:view` |
| GET | `/api/pesquisas/{id}/sentimento` | Análise de sentimento agregada | `pesquisas:dashboard:view` |
| GET | `/api/pesquisas/{id}/detratores` | Listar detratores aguardando follow-up | `pesquisas:followup:manage` |
| POST | `/api/pesquisas/{id}/detratores/{detractorId}/followup` | Registrar ação de follow-up | `pesquisas:followup:manage` |
| POST | `/api/pesquisas/responder` | Responder pesquisa (endpoint público) | `AllowAnonymous` |
| GET | `/api/pesquisas/dashboard/metricas` | Obter métricas agregadas | `pesquisas:dashboard:view` |
| GET | `/api/pesquisas/dashboard/wordcloud` | Obter word cloud de comentários | `pesquisas:dashboard:view` |
| GET | `/api/pesquisas/dashboard/ranking-analistas` | Ranking analistas por CSAT | `pesquisas:dashboard:view` |
| POST | `/api/pesquisas/{id}/export` | Exportar dados (Excel/PDF/PowerBI) | `pesquisas:export` |
| GET | `/api/pesquisas/triggers` | Listar triggers configurados | `pesquisas:triggers:manage` |
| POST | `/api/pesquisas/triggers` | Criar novo trigger | `pesquisas:triggers:manage` |
| PUT | `/api/pesquisas/triggers/{id}` | Atualizar trigger | `pesquisas:triggers:manage` |
| DELETE | `/api/pesquisas/triggers/{id}` | Excluir trigger | `pesquisas:triggers:manage` |
| POST | `/api/pesquisas/{id}/anonimizar` | Forçar anonimização manual | `pesquisas:anonimizar` |
| GET | `/api/pesquisas/{id}/auditoria` | Obter logs de auditoria | `pesquisas:audit:view` |
| GET | `/api/pesquisas/configuracoes` | Obter configurações globais | `pesquisas:configuracoes:manage` |
| PUT | `/api/pesquisas/configuracoes` | Atualizar configurações | `pesquisas:configuracoes:manage` |

**Total:** 22 endpoints

---

## 7. FLUXOS PRINCIPAIS

### 7.1 Fluxo de Envio Automático de Pesquisa CSAT Pós-Chamado

1. **Trigger**: Chamado #12345 resolvido
2. **Validação**: Sistema valida throttling (RN-RF071-001)
   - Se usuário recebeu pesquisa <7 dias → BLOQUEIA (log + exit)
3. **Geração Token**: Token único (Guid + HMAC SHA256)
4. **Detecção Idioma**: pt-BR, en-US ou es-ES baseado em `Usuario.IdiomaPreferido`
5. **Renderização Template**: Template localizado com dados contextuais
6. **Envio Multi-Canal**: Email (SendGrid) + SMS (Twilio) + In-App (SignalR push)
7. **Aguarda Resposta**: Timeout 7 dias (RN-RF071-007)
8. **Validação Link**: Verifica expiração e resposta duplicada
9. **Processamento Resposta**:
   - Salva dados (CSAT, comentário)
   - Análise sentimento NLP (RN-RF071-005)
   - Correlação com chamado origem (RN-RF071-009)
10. **Follow-up**: Se CSAT ≤3 → Dispara RN-RF071-003 (detrator)
11. **Dashboard**: Atualiza métricas via SignalR (RN-RF071-012)

### 7.2 Fluxo de Cálculo de NPS Trimestral

1. **Job Hangfire**: Cron `0 0 1 */3 *` (dia 1 de cada trimestre)
2. **Obter Usuários**: Ativos últimos 90 dias (excluindo throttling)
3. **Envio em Batches**: 500 emails por vez (rate limiting SendGrid)
4. **Aguarda 7 dias**: Deadline para respostas
5. **Cálculo NPS**: Classifica respostas (promotores/neutros/detratores)
6. **Análise Tendência**: Compara com trimestre anterior
7. **Alertas**: Se queda >5 pontos → Notificação CEO + Diretoria
8. **Relatório**: Gera dataset PowerBI + email executivo

### 7.3 Fluxo de Follow-up de Detrator NPS

1. **Detecção**: Resposta NPS ≤6 identificada
2. **Chamado Interno**: Criado automaticamente (categoria "Recuperação Cliente", prioridade Alta)
3. **Notificação Gestor**: Email + SMS + In-App com detalhes do detrator
4. **Email Usuário**: Template personalizado com contato direto do gestor
5. **Timer SLA**: Inicia contagem 4h (RN-RF071-011)
6. **Ação Gestor**: Registra ação tomada (ligação, reunião, compensação)
7. **Pesquisa Follow-up**: Envia nova pesquisa após intervenção
8. **Métricas Recuperação**: Taxa conversão detrator → promotor (meta: 40%)

### 7.4 Fluxo de Análise de Sentimento Automática

1. **Resposta Recebida**: Comentário com ≥10 caracteres (RN-RF071-010)
2. **Azure Cognitive Services**: Chamada Text Analytics API
3. **Processamento NLP**: Score sentimento + keywords + classificação
4. **Score Crítico**: Se <-0.7 → Alerta imediato para gestor
5. **Armazenamento**: Salva resultado (SentimentoScore, Classificação, Keywords)
6. **Correlação**: Identifica causa-raiz (ex: SLA violado + reabertura)
7. **Dashboard**: Atualiza word cloud e métricas de sentimento

---

## 8. METRICAS E INDICADORES

### 8.1 KPIs (10 indicadores)

| KPI | Meta | Medição | Ação se Abaixo da Meta |
|-----|------|---------|------------------------|
| **NPS (Net Promoter Score)** | ≥32 (Bom) | Trimestral | Análise detratores + plano ação 30 dias |
| **CSAT (Customer Satisfaction)** | ≥75% | Contínuo | Investigar chamados CSAT <3 + coaching |
| **CES (Customer Effort Score)** | ≤3.0 | Por processo | Simplificar processos CES >4.5 |
| **Taxa de Resposta** | ≥45% | Por pesquisa | Ajustar canais (testar WhatsApp) |
| **Taxa Recuperação Detratores** | ≥40% | Mensal | Revisar script + treinamento gestores |
| **Tempo Médio Follow-up** | ≤2h | Contínuo | Escalar se >4h |
| **Conversão Detrator → Promotor** | ≥15% | Trimestral | Replicar práticas bem-sucedidas |
| **Correlação CSAT × Tempo Resolução** | r ≥0.7 | Mensal | Revisar SLAs se r <0.5 |
| **Taxa Fadiga Pesquisa** | ≤5% | Mensal | Reduzir frequência |
| **Acurácia NLP** | ≥85% | Trimestral | Re-treinar modelo |

### 8.2 Alertas (8 condições críticas)

| Alerta | Condição | Ação Automática | Destinatários |
|--------|----------|-----------------|---------------|
| **Queda Abrupta NPS** | NPS caiu >5 pts em 7 dias | Email urgente + reunião emergencial | CEO + Diretoria + Gestor SD |
| **CSAT Crítico** | CSAT <70% por 3 dias | Notificação multi-canal + chamado interno | Gestor SD + Supervisor |
| **CES Perigoso** | Processo CES >5.0 | Alerta + análise causa-raiz | Gestor SD + Engenharia Processos |
| **Taxa Resposta Baixa** | Taxa <30% | Sugestão canais alternativos | Gestor SD + Marketing |
| **Spike Detratores** | >10 detratores em 24h | Dashboard vermelho + notificação CEO | CEO + Diretoria + Gestor SD |
| **SLA Follow-up Vencido** | Detrator sem follow-up >4h | Escalação supervisor | Supervisor + RH |
| **Sentimento Crítico** | Comentário score <-0.7 | Alerta imediato | Gestor SD |
| **Palavra-Gatilho** | Comentário contém "processo", "demissão", "jurídico" | Encaminhamento Jurídico/RH | Jurídico + RH + Gestor SD |

---

## 9. SEGURANÇA

### 9.1 Proteções Implementadas

| Proteção | Implementação |
|----------|---------------|
| **LGPD Compliance** | 3 níveis anonimização (RN-RF071-004) |
| **CSRF Protection** | Token anti-CSRF em formulários públicos |
| **XSS Prevention** | Sanitização DOMPurify + validação backend |
| **Rate Limiting** | 100 req/min por IP em endpoint público |
| **Token Expiration** | Links expiram em 7 dias (RN-RF071-007) |
| **Throttling Anti-Spam** | 1 pesquisa a cada 7 dias (RN-RF071-001) |
| **SQL Injection Prevention** | Queries parametrizadas EF Core (100% LINQ) |
| **Sensitive Data Encryption** | Azure Key Vault + AES-256 |
| **Auditoria Completa** | 10 operações auditadas (7 anos retenção) |
| **RBAC Granular** | 14 permissões detalhadas |
| **HTTPS Obrigatório** | Enforce HTTPS em todos endpoints |
| **CORS Restrito** | Whitelist domínios internos |

### 9.2 Testes de Segurança Obrigatórios (12 cenários)

- SQL Injection (campo comentário)
- XSS Stored (script em comentário)
- XSS Reflected (parâmetro URL)
- CSRF (envio sem token)
- IDOR (acesso respostas outra empresa)
- Rate Limiting Bypass (200 requests/min)
- Token Reuse (responder 2x)
- Token Expiration (link 8+ dias)
- Sensitive Data Exposure (logs)
- Brute Force Protection (1000 tentativas token)
- LGPD Anonimização (irreversibilidade)
- RBAC Enforcement (perfil não autorizado → 403)

---

## 10. IMPACTO NA IMPLEMENTAÇÃO

### 10.1 Estimativa de Esforço

- **Backend (.NET 10)**: 80 horas
  - Entities (8 tabelas): 10h
  - Commands/Queries (CQRS): 25h
  - Validators (FluentValidation): 8h
  - Handlers (MediatR): 15h
  - Jobs Hangfire (5 jobs): 10h
  - Integrações (Azure, SendGrid, Twilio): 12h

- **Frontend (Angular 19)**: 60 horas
  - Telas Admin (3 telas): 20h
  - Tela Pública (PWA responsivo): 12h
  - Dashboards (18 widgets): 18h
  - Componentes (12 tipos pergunta): 10h

- **Testes**: 40 horas
  - Unitários (backend): 12h
  - Integração (NLP, SendGrid): 10h
  - E2E (Playwright): 12h
  - Segurança (12 cenários): 6h

**Total estimado:** 180 horas (4.5 semanas com 1 desenvolvedor)

### 10.2 Dependências Técnicas

**Backend:**
- .NET 10
- Entity Framework Core 10
- MediatR (CQRS)
- FluentValidation
- Hangfire (jobs)
- SignalR (real-time)
- Azure.AI.TextAnalytics (NLP)

**Frontend:**
- Angular 19
- Chart.js (gráficos)
- Transloco (i18n)
- ngx-file-upload
- ApexCharts (word cloud)

**Infraestrutura:**
- Azure Cognitive Services (Text Analytics)
- SendGrid (email)
- Twilio (SMS)
- Redis (cache - opcional)

### 10.3 Riscos e Mitigações

| Risco | Probabilidade | Impacto | Mitigação |
|-------|---------------|---------|-----------|
| **Falha NLP Azure** | Baixa | Alto | Fallback para classificação manual + retry exponencial |
| **Taxa resposta <30%** | Média | Médio | A/B test canais + gamificação |
| **Throttling SendGrid** | Média | Alto | Batches 500 emails + retry queue |
| **Violação LGPD** | Baixa | Crítico | Code review obrigatório + audit logs |

---

## 11. HISTÓRICO DE VERSÕES

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 1.0 | 2025-12-28 | Versão inicial com código C# misturado | Claude Architect |
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0 - Separação RF/RL, extração código para RL, 12 RNs em linguagem natural, 22 endpoints, 10 KPIs, 8 alertas | Claude Code (Migração) |

---

**Documento controlado pela Governança v2.0 - IControlIT**
**Última revisão:** 2025-12-30
