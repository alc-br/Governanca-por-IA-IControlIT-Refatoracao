# RL-RF044 - Referência ao Legado (Gestão de KPIs)
# Versão: 1.0
# Data: 2025-12-30
# Autor: Agência ALC - alc.dev.br

rf_id: RF044
titulo: "Gestão de KPIs (Key Performance Indicators)"

legado:
  sistema: "ASP.NET Web Forms + VB.NET"
  versao: "Sistema IControlIT Legado"
  arquitetura: "Monolítica WebForms"
  banco_dados: "SQL Server"
  multi_tenant: false
  auditoria: "none"

# Referencias ao Legado com Destino Obrigatório
referencias:
  - id: "LEG-RF044-001"
    tipo: "tela"
    nome: "DashboardGerencial.aspx"
    caminho: "ic1_legado/IControlIT/Relatorios/DashboardGerencial.aspx"
    descricao: |
      Tela de dashboard gerencial com cards de KPIs fixos e gráficos estáticos.
      - Cards com valores hardcoded (Receita, Custo, SLA)
      - Gráficos Chart.js versão antiga (sem interatividade)
      - Sem drill-down ou filtros avançados
      - Refresh manual obrigatório
      - Timeout em consultas > 2min
    destino: "substituido"
    justificativa: |
      Sistema moderno utiliza dashboards Angular 19 com ApexCharts interativos,
      real-time updates via SignalR, drill-down completo e performance otimizada.
    documentacao_item_relacionado: "RN-RF044-01 a RN-RF044-15"
    uc_relacionado: "UC07-visualizar-dashboard"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF044-002"
    tipo: "tela"
    nome: "RelatorioKPIs.aspx"
    caminho: "ic1_legado/IControlIT/Relatorios/RelatorioKPIs.aspx"
    descricao: |
      Lista de KPIs pré-definidos com exportação Excel básica.
      - KPIs fixos definidos em code-behind
      - Exportação Excel sem formatação
      - Cálculos manuais a cada request (sem cache)
      - Sem versionamento de fórmulas
      - Performance ruim com muitos registros
    destino: "substituido"
    justificativa: |
      Sistema moderno permite criação de KPIs customizáveis com fórmulas SQL/C#,
      exportação avançada (Power BI, Tableau, PDF), caching distribuído e
      versionamento de fórmulas.
    documentacao_item_relacionado: "RN-RF044-01, RN-RF044-02, RN-RF044-11"
    uc_relacionado: "UC01-criar-kpi, UC02-visualizar-kpi, UC08-exportar-kpis"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF044-003"
    tipo: "tela"
    nome: "GraficosCustos.aspx"
    caminho: "ic1_legado/IControlIT/Relatorios/GraficosCustos.aspx"
    descricao: |
      Gráficos de evolução de custos com comparação YoY.
      - Biblioteca Chart.js antiga (versão 2.x)
      - Sem zoom ou interatividade
      - Dados limitados a 12 meses
      - Sem análise de tendências
      - Performance degradada ao carregar muitos pontos
    destino: "substituido"
    justificativa: |
      ApexCharts moderno oferece zoom, drill-down, filtering,
      histórico de 7 anos, análise preditiva com Azure ML.
    documentacao_item_relacionado: "RN-RF044-06, RN-RF044-07, RN-RF044-15"
    uc_relacionado: "UC07-visualizar-dashboard"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF044-004"
    tipo: "tela"
    nome: "ConfiguracaoMetas.aspx"
    caminho: "ic1_legado/IControlIT/Relatorios/ConfiguracaoMetas.aspx"
    descricao: |
      CRUD básico de metas mensais.
      - Sem cascateamento hierárquico (corporativa → divisão → departamento)
      - Alertas manuais via e-mail (não automáticos)
      - Sem tipos de meta (mínima, ideal, desafiadora)
      - Validação básica apenas no frontend (vulnerável)
    destino: "substituido"
    justificativa: |
      Sistema moderno implementa metas hierárquicas com cascateamento automático,
      3 tipos de meta (mínima, ideal, desafiadora), alertas automáticos
      (threshold, tendência, anomalia) e validação backend robusta.
    documentacao_item_relacionado: "RN-RF044-04, RN-RF044-05, RN-RF044-06, RN-RF044-10"
    uc_relacionado: "UC05-definir-metas, UC06-configurar-alertas"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF044-005"
    tipo: "webservice"
    nome: "WS_Relatorios.asmx:GetDadosKPIs"
    caminho: "ic1_legado/IControlIT/Services/WS_Relatorios.asmx"
    descricao: |
      WebService que retorna DataTable com KPIs fixos.
      - Sem paginação ou filtros
      - Timeout em consultas grandes
      - Sem cache, recalcula toda vez
    destino: "substituido"
    justificativa: |
      Endpoints REST modernos com CQRS, paginação obrigatória,
      caching distribuído (Redis), background jobs (Hangfire).
    documentacao_item_relacionado: "RN-RF044-09"
    uc_relacionado: "UC00-listar-kpis"
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: 2

  - id: "LEG-RF044-006"
    tipo: "componente"
    nome: "KPIHelper.vb:CalcularReceitaMensal"
    caminho: "ic1_legado/IControlIT/App_Code/Helpers/KPIHelper.vb"
    descricao: |
      Função VB.NET que calcula receita mensal com SQL hardcoded.
      - Fórmula fixa: SELECT SUM(ValorTotal) FROM Faturas WHERE MONTH(Data) = MONTH(GETDATE())
      - Sem parametrização ou customização
      - Executada em cada request (sem cache)
    destino: "assumido"
    justificativa: |
      Lógica preservada mas migrada para fórmula customizável no motor de cálculo.
      Usuário pode alterar a fórmula sem modificar código.
    documentacao_item_relacionado: "RN-RF044-02"
    uc_relacionado: "UC01-criar-kpi"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF044-007"
    tipo: "componente"
    nome: "KPIHelper.vb:CalcularSLAUptime"
    caminho: "ic1_legado/IControlIT/App_Code/Helpers/KPIHelper.vb"
    descricao: |
      Função VB.NET que calcula SLA de uptime.
      - Fórmula fixa: (totalMinutos - minutosIndisponivel) / totalMinutos * 100
      - Período hardcoded: 30 dias
      - Sem parametrização
    destino: "assumido"
    justificativa: |
      Lógica preservada mas período torna-se configurável.
      Fórmula pode ser adaptada por tipo de serviço.
    documentacao_item_relacionado: "RN-RF044-02"
    uc_relacionado: "UC01-criar-kpi"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF044-008"
    tipo: "componente"
    nome: "MetasHelper.vb:VerificarAtingimentoMeta"
    caminho: "ic1_legado/IControlIT/App_Code/Helpers/MetasHelper.vb"
    descricao: |
      Função VB.NET que calcula semáforo de metas (Vermelho/Amarelo/Verde).
      - Thresholds hardcoded: < 80% = Vermelho, 80-99% = Amarelo, >= 100% = Verde
      - Sem tipos de meta (mínima, ideal, desafiadora)
    destino: "substituido"
    justificativa: |
      Sistema moderno adiciona Azul (meta ideal 105-119%) e Roxo (meta desafiadora >= 120%).
      Thresholds customizáveis por KPI.
    documentacao_item_relacionado: "RN-RF044-05"
    uc_relacionado: "UC05-definir-metas"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF044-009"
    tipo: "stored_procedure"
    nome: "sp_CalcularKPIs"
    caminho: "Database/dbo.sp_CalcularKPIs"
    descricao: |
      Stored Procedure que recalcula todos os KPIs usando cursor (anti-pattern).
      - Loop cursor por cada KPI (performance ruim)
      - Executa query dinâmica (vulnerável a SQL injection)
      - Sem paralelização ou otimização
    destino: "descartado"
    justificativa: |
      Sistema moderno utiliza background jobs (Hangfire) com paralelização,
      queries parametrizadas (EF Core), caching distribuído (Redis).
      Stored procedures não são utilizadas na arquitetura Clean + CQRS.
    documentacao_item_relacionado: "RN-RF044-09"
    uc_relacionado: null
    complexidade: "alta"
    risco_migracao: "baixo"
    prioridade: 4

  - id: "LEG-RF044-010"
    tipo: "stored_procedure"
    nome: "sp_VerificarMetas"
    caminho: "Database/dbo.sp_VerificarMetas"
    descricao: |
      Stored Procedure que verifica atingimento de metas mensais.
      - Retorna status Vermelho/Amarelo/Verde
      - Sem alertas automáticos
      - Executada sob demanda (não proativa)
    destino: "descartado"
    justificativa: |
      Sistema moderno utiliza alertas automáticos com machine learning
      (threshold, tendência, anomalia). Verificação ocorre em background
      jobs com notificações via e-mail, SMS, push, SignalR, webhook.
    documentacao_item_relacionado: "RN-RF044-06, RN-RF044-07, RN-RF044-10"
    uc_relacionado: "UC06-configurar-alertas"
    complexidade: "alta"
    risco_migracao: "baixo"
    prioridade: 4

  - id: "LEG-RF044-011"
    tipo: "regra_negocio"
    nome: "Histórico limitado a 90 dias"
    caminho: "Configuração de sistema (Web.config)"
    descricao: |
      Sistema legado armazenava apenas 90 dias de histórico de KPIs.
      - Job de limpeza excluía dados antigos (sem arquivamento)
      - Impossível realizar análises de longo prazo
      - Sem conformidade com LGPD (7 anos)
    destino: "substituido"
    justificativa: |
      RF moderno exige retenção de 7 anos conforme LGPD.
      Particionamento de tabelas + cold storage (Azure Blob) após 7 anos.
      Permite análises históricas e comparações YoY de múltiplos anos.
    documentacao_item_relacionado: "RN-RF044-15"
    uc_relacionado: "UC02-visualizar-kpi"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

# Telas Legadas (estrutura detalhada)
telas:
  - id: "LEG-RF044-001"
    nome: "DashboardGerencial.aspx"
    caminho: "ic1_legado/IControlIT/Relatorios/DashboardGerencial.aspx"
    responsabilidade: "Dashboard gerencial com KPIs e gráficos"
    campos:
      - nome: "ddlFornecedor"
        tipo: "DropDownList"
        obrigatorio: true
        validacao: "Seleção obrigatória"
      - nome: "txtDataInicio"
        tipo: "TextBox (Date)"
        obrigatorio: true
        validacao: "Data válida"
      - nome: "txtDataFim"
        tipo: "TextBox (Date)"
        obrigatorio: true
        validacao: "Data válida, >= dataInicio"
    comportamentos_implicitos:
      - "Gráficos gerados com Chart.js versão antiga (sem interatividade)"
      - "Refresh manual da página obrigatório"
      - "Timeout em consultas > 2min"

# WebServices Legados
servicos:
  - id: "LEG-RF044-005"
    nome: "WS_Relatorios.asmx"
    localizacao: "ic1_legado/IControlIT/Services/WS_Relatorios.asmx"
    responsabilidade: "Fornecer dados de KPIs para frontend"
    notas: "Sem paginação, cache ou otimização"

# Tabelas Legadas com Problemas
tabelas:
  - nome: "KPI"
    finalidade: "Armazenar definição de KPIs"
    problemas:
      - "Sem multi-tenancy (Id_Fornecedor ausente)"
      - "Sem auditoria (quem criou/alterou)"
      - "Sem soft delete (Fl_Excluido)"
      - "Sem versionamento de fórmulas"
      - "Performance ruim (sem índices otimizados)"

  - nome: "KPIValor"
    finalidade: "Armazenar valores históricos de KPIs"
    problemas:
      - "Sem particionamento (performance degrada com volume)"
      - "Sem rastreabilidade (quem calculou, fonte)"
      - "Dados limitados a 90 dias"

  - nome: "KPIMeta"
    finalidade: "Armazenar metas mensais"
    problemas:
      - "Sem hierarquia (corporativa → divisão → departamento)"
      - "Sem tipos de meta (mínima, ideal, desafiadora)"
      - "Sem cascateamento automático"

# Regras de Negócio Implícitas (não documentadas no legado)
regras_implicitas:
  - id: "RL-RN-001"
    descricao: "Cálculo de Receita Mensal = SUM(ValorTotal) de faturas do mês atual"
    fonte: "KPIHelper.vb:CalcularReceitaMensal(), linha 23"

  - id: "RL-RN-002"
    descricao: "Cálculo de SLA Uptime = (totalMinutos - minutosIndisponivel) / totalMinutos * 100"
    fonte: "KPIHelper.vb:CalcularSLAUptime(), linha 45"

  - id: "RL-RN-003"
    descricao: "Semáforo de Metas: < 80% = Vermelho, 80-99% = Amarelo, >= 100% = Verde"
    fonte: "MetasHelper.vb:VerificarAtingimentoMeta(), linha 67"

# Gap Analysis (Legado x Moderno)
gap_analysis:
  - item: "KPIs Customizáveis"
    existe_legado: false
    existe_moderno: true
    notas: "Legado tinha KPIs fixos hardcoded. Moderno permite fórmulas SQL/C# customizáveis."

  - item: "Dashboards Interativos"
    existe_legado: false
    existe_moderno: true
    notas: "Legado tinha gráficos estáticos Chart.js v2. Moderno usa ApexCharts com zoom, drill-down."

  - item: "Alertas Automáticos"
    existe_legado: false
    existe_moderno: true
    notas: "Legado tinha e-mails manuais. Moderno tem alertas automáticos (threshold, tendência, anomalia)."

  - item: "Análise Preditiva"
    existe_legado: false
    existe_moderno: true
    notas: "Legado sem forecasting. Moderno integra Azure ML para previsões 30/60/90 dias."

  - item: "Histórico de 7 Anos"
    existe_legado: false
    existe_moderno: true
    notas: "Legado: 90 dias. Moderno: 7 anos (LGPD) com particionamento e cold storage."

  - item: "Metas Hierárquicas"
    existe_legado: false
    existe_moderno: true
    notas: "Legado: metas planas. Moderno: cascateamento corporativa → divisão → departamento."

  - item: "Exportação Avançada"
    existe_legado: false
    existe_moderno: true
    notas: "Legado: Excel básico. Moderno: Power BI, Tableau, PDF, JSON."

  - item: "Versionamento de Fórmulas"
    existe_legado: false
    existe_moderno: true
    notas: "Legado: sem histórico de alterações. Moderno: versões rastreadas + opção de recalcular histórico."

  - item: "Permissões por Categoria"
    existe_legado: false
    existe_moderno: true
    notas: "Legado: sem controle RBAC. Moderno: permissões GES.KPI.VIEW.{CATEGORIA}."

  - item: "Dashboard Público"
    existe_legado: false
    existe_moderno: true
    notas: "Legado: sem compartilhamento. Moderno: token JWT temporário para stakeholders externos."

# Decisões de Modernização
decisoes_modernizacao:
  - decisao: "Motor de Cálculo Customizável"
    motivo: |
      Substituir KPIs fixos por sistema de fórmulas customizáveis (SQL + C#).
      Permite criar KPIs sem alterar código.
    impacto: "alto"
    data: "2025-12-30"

  - decisao: "Análise Preditiva com Azure ML"
    motivo: |
      Integrar Azure Machine Learning para forecasting e detecção de anomalias.
      Permite alertas proativos antes de problemas se agravarem.
    impacto: "alto"
    data: "2025-12-30"

  - decisao: "Dashboards com ApexCharts"
    motivo: |
      Substituir Chart.js antigo por ApexCharts moderno.
      Gráficos responsivos, interativos (zoom, drill-down), melhor UX.
    impacto: "medio"
    data: "2025-12-30"

  - decisao: "Histórico de 7 Anos (LGPD)"
    motivo: |
      Estender retenção de dados históricos de 90 dias para 7 anos.
      Conformidade LGPD + análises de longo prazo.
    impacto: "alto"
    data: "2025-12-30"

  - decisao: "Alertas Automáticos Inteligentes"
    motivo: |
      Sistema de alertas com ML (threshold, tendência, anomalia, comparativo, SLA).
      Reduz carga manual de monitoramento.
    impacto: "alto"
    data: "2025-12-30"

# Riscos de Migração
riscos_migracao:
  - risco: "Migração de dados históricos incompleta"
    impacto: "alto"
    probabilidade: "media"
    mitigacao: |
      Script de migração testado em ambiente de homologação.
      Validação de integridade de dados (count, sums, checksums).
      Backup completo antes da migração.

  - risco: "Fórmulas legadas incompatíveis"
    impacto: "medio"
    probabilidade: "alta"
    mitigacao: |
      Mapeamento manual de todas as fórmulas legadas.
      Testes de regressão comparando resultados legado vs moderno.
      Período de convivência (2 semanas) para validação.

  - risco: "Performance de cálculos complexos"
    impacto: "medio"
    probabilidade: "media"
    mitigacao: |
      Caching distribuído (Redis) para resultados frequentes.
      Background jobs (Hangfire) para cálculos pesados.
      Timeout configurável (30s padrão).

  - risco: "Custo de APIs externas (Azure ML)"
    impacto: "medio"
    probabilidade: "baixa"
    mitigacao: |
      Rate limiting para evitar chamadas excessivas.
      Fallback para cálculos locais quando API indisponível.
      Monitoramento de custos via Azure Cost Management.

  - risco: "Resistência de usuários a novo sistema"
    impacto: "baixo"
    probabilidade: "media"
    mitigacao: |
      Treinamento presencial/online para usuários-chave.
      Documentação detalhada + vídeos tutoriais.
      Período de convivência legado/moderno (1 mês).

# Rastreabilidade (Legado → Moderno)
rastreabilidade:
  - elemento_legado: "DashboardGerencial.aspx"
    referencia_rf: "RN-RF044-01 a RN-RF044-15"
    referencia_uc: "UC07-visualizar-dashboard"
    status: "migrado"

  - elemento_legado: "RelatorioKPIs.aspx"
    referencia_rf: "RN-RF044-01, RN-RF044-02, RN-RF044-11"
    referencia_uc: "UC01-criar-kpi, UC02-visualizar-kpi, UC08-exportar-kpis"
    status: "migrado"

  - elemento_legado: "GraficosCustos.aspx"
    referencia_rf: "RN-RF044-06, RN-RF044-07, RN-RF044-15"
    referencia_uc: "UC07-visualizar-dashboard"
    status: "migrado"

  - elemento_legado: "ConfiguracaoMetas.aspx"
    referencia_rf: "RN-RF044-04, RN-RF044-05, RN-RF044-06, RN-RF044-10"
    referencia_uc: "UC05-definir-metas, UC06-configurar-alertas"
    status: "migrado"

  - elemento_legado: "KPIHelper.vb:CalcularReceitaMensal()"
    referencia_rf: "RN-RF044-02"
    referencia_uc: "UC01-criar-kpi"
    status: "migrado"

  - elemento_legado: "KPIHelper.vb:CalcularSLAUptime()"
    referencia_rf: "RN-RF044-02"
    referencia_uc: "UC01-criar-kpi"
    status: "migrado"

  - elemento_legado: "MetasHelper.vb:VerificarAtingimentoMeta()"
    referencia_rf: "RN-RF044-05"
    referencia_uc: "UC05-definir-metas"
    status: "migrado"

  - elemento_legado: "sp_CalcularKPIs"
    referencia_rf: "RN-RF044-09"
    referencia_uc: null
    status: "descartado"

  - elemento_legado: "sp_VerificarMetas"
    referencia_rf: "RN-RF044-06, RN-RF044-07, RN-RF044-10"
    referencia_uc: "UC06-configurar-alertas"
    status: "descartado"

# Changelog
changelog:
  - versao: "1.0"
    data: "2025-12-30"
    descricao: "Criação inicial - separação RF/RL após migração v2.0"
    autor: "Agência ALC - alc.dev.br"
