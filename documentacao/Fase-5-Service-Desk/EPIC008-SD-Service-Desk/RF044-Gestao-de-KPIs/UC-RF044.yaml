# =============================================
# UC-RF044 - Casos de Uso de Gestão de KPIs
# Versão: 2.0
# Autor: Agência ALC - alc.dev.br
# =============================================

uc:
  documentacao: "RF044"
  versao: "2.0"
  data: "2025-12-31"

casos_de_uso:

  - id: "UC00"
    nome: "Listar KPIs"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      documentacao_items:
        - "RF-CRUD-02"
      uc_items:
        - id: "FP-UC00-001"
          title: "Usuário acessa menu KPIs"
          required: true
        - id: "FP-UC00-002"
          title: "Sistema valida permissão GES.KPI.LISTAR"
          required: true
        - id: "FP-UC00-003"
          title: "Sistema valida permissões de categoria (RBAC)"
          required: true
        - id: "FP-UC00-004"
          title: "Sistema carrega KPIs do tenant com filtro por categoria permitida"
          required: true
        - id: "FP-UC00-005"
          title: "Sistema aplica paginação e ordenação"
          required: true
        - id: "FP-UC00-006"
          title: "Sistema calcula status semáforo conforme RN-RF044-05"
          required: true
        - id: "FP-UC00-007"
          title: "Sistema exibe lista com colunas definidas"
          required: true
        - id: "FA-UC00-001"
          title: "Filtrar por categoria"
          required: false
        - id: "FA-UC00-002"
          title: "Filtrar por status (Draft, Active, Inactive)"
          required: false
        - id: "FA-UC00-003"
          title: "Ordenar por colunas"
          required: false
        - id: "FA-UC00-004"
          title: "Buscar por código ou nome"
          required: false
        - id: "FE-UC00-001"
          title: "Usuário sem permissão GES.KPI.LISTAR → 403"
          required: true
        - id: "FE-UC00-002"
          title: "Usuário sem permissão categoria → KPIs filtrados"
          required: true
        - id: "FE-UC00-003"
          title: "Nenhum KPI cadastrado → estado vazio"
          required: true

    precondicoes:
      - permissao: "GES.KPI.LISTAR"
      - permissao_categoria: "GES.KPI.VIEW.*"

    gatilho: "Usuario acessa menu KPIs"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessa_menu_kpis"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "aplicar_filtro_rbac_categoria"
      - passo: 4
        ator: "sistema"
        acao: "listar_kpis_tenant"
      - passo: 5
        ator: "sistema"
        acao: "calcular_semaforo"
      - passo: 6
        ator: "sistema"
        acao: "exibir_lista"

    regras_aplicadas:
      - "RN-RF044-12"
      - "RN-RF044-15"
      - "RN-RF044-05"

    resultado_final:
      estado: "lista_kpis_exibida_com_rbac"

  - id: "UC01"
    nome: "Criar KPI"
    ator_principal: "usuario_autenticado"
    tipo: "crud"
    impacta_dados: true

    covers:
      documentacao_items:
        - "RF-CRUD-01"
        - "RF-VAL-01"
        - "RF-VAL-02"
        - "RF-VAL-03"
      uc_items:
        - id: "FP-UC01-001"
          title: "Usuário solicita criação de KPI"
          required: true
        - id: "FP-UC01-002"
          title: "Sistema valida permissão GES.KPI.CRIAR"
          required: true
        - id: "FP-UC01-003"
          title: "Sistema exibe formulário"
          required: true
        - id: "FP-UC01-004"
          title: "Usuário informa dados obrigatórios"
          required: true
        - id: "FP-UC01-005"
          title: "Sistema valida código único RN-RF044-01"
          required: true
        - id: "FP-UC01-006"
          title: "Sistema valida fórmula SQL RN-RF044-02"
          required: true
        - id: "FP-UC01-007"
          title: "Sistema valida periodicidade RN-RF044-03"
          required: true
        - id: "FP-UC01-008"
          title: "Sistema cria registro em draft"
          required: true
        - id: "FP-UC01-009"
          title: "Sistema cria versão 1.0 fórmula RN-RF044-11"
          required: true
        - id: "FP-UC01-010"
          title: "Sistema registra auditoria"
          required: true
        - id: "FP-UC01-011"
          title: "Sistema confirma sucesso"
          required: true
        - id: "FA-UC01-001"
          title: "Testar fórmula (dry-run timeout 5s)"
          required: false
        - id: "FA-UC01-002"
          title: "Salvar em draft incompleto"
          required: false
        - id: "FA-UC01-003"
          title: "Cancelar criação"
          required: false
        - id: "FE-UC01-001"
          title: "Código duplicado → erro 400"
          required: true
        - id: "FE-UC01-002"
          title: "Fórmula SQL inválida → erro 400"
          required: true
        - id: "FE-UC01-003"
          title: "Periodicidade inválida → erro 400"
          required: true
        - id: "FE-UC01-004"
          title: "Timeout validação fórmula → salva draft"
          required: true

    precondicoes:
      - permissao: "GES.KPI.CRIAR"

    gatilho: "Usuario clica em Novo KPI"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "solicitar_criacao"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "exibir_formulario"
      - passo: 4
        ator: "usuario"
        acao: "preencher_campos"
      - passo: 5
        ator: "sistema"
        acao: "validar_codigo_unico"
      - passo: 6
        ator: "sistema"
        acao: "validar_formula_sql"
      - passo: 7
        ator: "sistema"
        acao: "validar_periodicidade"
      - passo: 8
        ator: "sistema"
        acao: "criar_kpi_draft"
      - passo: 9
        ator: "sistema"
        acao: "criar_versao_formula"
      - passo: 10
        ator: "sistema"
        acao: "registrar_auditoria"

    regras_aplicadas:
      - "RN-RF044-01"
      - "RN-RF044-02"
      - "RN-RF044-03"
      - "RN-RF044-11"

    resultado_final:
      estado: "kpi_criado_draft"

  - id: "UC02"
    nome: "Visualizar KPI"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      documentacao_items:
        - "RF-CRUD-03"
      uc_items:
        - id: "FP-UC02-001"
          title: "Usuário seleciona KPI"
          required: true
        - id: "FP-UC02-002"
          title: "Sistema valida permissão GES.KPI.LISTAR"
          required: true
        - id: "FP-UC02-003"
          title: "Sistema valida permissão categoria"
          required: true
        - id: "FP-UC02-004"
          title: "Sistema valida tenant"
          required: true
        - id: "FP-UC02-005"
          title: "Sistema exibe detalhes"
          required: true
        - id: "FP-UC02-006"
          title: "Sistema calcula semáforo RN-RF044-05"
          required: true
        - id: "FP-UC02-007"
          title: "Sistema carrega histórico 12 meses"
          required: true
        - id: "FP-UC02-008"
          title: "Sistema exibe gráfico ApexCharts"
          required: true
        - id: "FP-UC02-009"
          title: "Sistema habilita drill-down RN-RF044-08"
          required: true
        - id: "FA-UC02-001"
          title: "Drill-down para transação individual"
          required: false
        - id: "FA-UC02-002"
          title: "Visualizar histórico versões fórmula"
          required: false
        - id: "FA-UC02-003"
          title: "Comparar MoM/YoY"
          required: false
        - id: "FA-UC02-004"
          title: "Visualizar eventos marcados"
          required: false
        - id: "FE-UC02-001"
          title: "KPI inexistente → 404"
          required: true
        - id: "FE-UC02-002"
          title: "KPI outro tenant → 404"
          required: true
        - id: "FE-UC02-003"
          title: "Sem permissão categoria → 403"
          required: true

    precondicoes:
      - permissao: "GES.KPI.LISTAR"
      - permissao_categoria: "GES.KPI.VIEW.*"

    gatilho: "Usuario seleciona KPI na listagem"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "selecionar_kpi"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "validar_tenant"
      - passo: 4
        ator: "sistema"
        acao: "exibir_detalhes"
      - passo: 5
        ator: "sistema"
        acao: "calcular_semaforo"
      - passo: 6
        ator: "sistema"
        acao: "carregar_historico"
      - passo: 7
        ator: "sistema"
        acao: "exibir_grafico"

    regras_aplicadas:
      - "RN-RF044-05"
      - "RN-RF044-08"
      - "RN-RF044-15"

    resultado_final:
      estado: "detalhes_kpi_exibidos_com_grafico"

  - id: "UC03"
    nome: "Editar KPI"
    ator_principal: "usuario_autenticado"
    tipo: "crud"
    impacta_dados: true

    covers:
      documentacao_items:
        - "RF-CRUD-04"
        - "RF-VAL-02"
      uc_items:
        - id: "FP-UC03-001"
          title: "Usuário solicita edição"
          required: true
        - id: "FP-UC03-002"
          title: "Sistema valida permissão GES.KPI.EDITAR"
          required: true
        - id: "FP-UC03-003"
          title: "Sistema valida tenant"
          required: true
        - id: "FP-UC03-004"
          title: "Sistema carrega dados atuais"
          required: true
        - id: "FP-UC03-005"
          title: "Usuário altera dados"
          required: true
        - id: "FP-UC03-006"
          title: "Se fórmula alterada valida RN-RF044-02"
          required: true
        - id: "FP-UC03-007"
          title: "Se fórmula alterada cria versão RN-RF044-11"
          required: true
        - id: "FP-UC03-008"
          title: "Sistema persiste alterações"
          required: true
        - id: "FP-UC03-009"
          title: "Sistema registra auditoria com diff"
          required: true
        - id: "FP-UC03-010"
          title: "Sistema confirma sucesso"
          required: true
        - id: "FA-UC03-001"
          title: "Testar nova fórmula antes salvar"
          required: false
        - id: "FA-UC03-002"
          title: "Cancelar edição"
          required: false
        - id: "FE-UC03-001"
          title: "Nova fórmula inválida → erro 400"
          required: true
        - id: "FE-UC03-002"
          title: "KPI deleted não pode editar → erro 400"
          required: true
        - id: "FE-UC03-003"
          title: "Timeout validação → erro 408"
          required: true

    precondicoes:
      - permissao: "GES.KPI.EDITAR"
      - kpi_estado: ["draft", "active", "inactive"]

    gatilho: "Usuario clica em Editar KPI"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "solicitar_edicao"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "validar_tenant"
      - passo: 4
        ator: "sistema"
        acao: "carregar_dados"
      - passo: 5
        ator: "usuario"
        acao: "alterar_dados"
      - passo: 6
        ator: "sistema"
        acao: "validar_alteracoes"
      - passo: 7
        ator: "sistema"
        acao: "versionar_formula_se_alterada"
      - passo: 8
        ator: "sistema"
        acao: "persistir_alteracoes"
      - passo: 9
        ator: "sistema"
        acao: "registrar_auditoria"

    regras_aplicadas:
      - "RN-RF044-02"
      - "RN-RF044-11"
      - "RN-RF044-09"

    resultado_final:
      estado: "kpi_atualizado"

  - id: "UC04"
    nome: "Excluir KPI"
    ator_principal: "usuario_autenticado"
    tipo: "crud"
    impacta_dados: true

    covers:
      documentacao_items:
        - "RF-CRUD-05"
      uc_items:
        - id: "FP-UC04-001"
          title: "Usuário solicita exclusão"
          required: true
        - id: "FP-UC04-002"
          title: "Sistema exibe confirmação"
          required: true
        - id: "FP-UC04-003"
          title: "Usuário confirma"
          required: true
        - id: "FP-UC04-004"
          title: "Sistema valida permissão GES.KPI.EXCLUIR"
          required: true
        - id: "FP-UC04-005"
          title: "Sistema valida tenant"
          required: true
        - id: "FP-UC04-006"
          title: "Sistema verifica dependências"
          required: true
        - id: "FP-UC04-007"
          title: "Sistema executa soft delete"
          required: true
        - id: "FP-UC04-008"
          title: "Sistema desabilita jobs Hangfire"
          required: true
        - id: "FP-UC04-009"
          title: "Sistema registra auditoria"
          required: true
        - id: "FP-UC04-010"
          title: "Sistema confirma sucesso"
          required: true
        - id: "FA-UC04-001"
          title: "Cancelar exclusão"
          required: false
        - id: "FA-UC04-002"
          title: "Visualizar dependências antes confirmar"
          required: false
        - id: "FE-UC04-001"
          title: "KPI em dashboards → erro 400"
          required: true
        - id: "FE-UC04-002"
          title: "KPI em alertas → erro 400"
          required: true
        - id: "FE-UC04-003"
          title: "KPI já excluído → erro 400"
          required: true

    precondicoes:
      - permissao: "GES.KPI.EXCLUIR"
      - kpi_estado: ["draft", "active", "inactive"]

    gatilho: "Usuario clica em Excluir KPI"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "solicitar_exclusao"
      - passo: 2
        ator: "sistema"
        acao: "exibir_confirmacao"
      - passo: 3
        ator: "usuario"
        acao: "confirmar"
      - passo: 4
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 5
        ator: "sistema"
        acao: "verificar_dependencias"
      - passo: 6
        ator: "sistema"
        acao: "soft_delete"
      - passo: 7
        ator: "sistema"
        acao: "desabilitar_jobs"
      - passo: 8
        ator: "sistema"
        acao: "registrar_auditoria"

    regras_aplicadas:
      - "RN-RF044-15"

    resultado_final:
      estado: "kpi_excluido_soft_delete"

  - id: "UC05"
    nome: "Definir Metas"
    ator_principal: "usuario_autenticado"
    tipo: "acao"
    impacta_dados: true

    covers:
      documentacao_items:
        - "RF-VAL-04"
      uc_items:
        - id: "FP-UC05-001"
          title: "Usuário acessa tela metas"
          required: true
        - id: "FP-UC05-002"
          title: "Sistema valida permissão GES.KPI.META.DEFINIR"
          required: true
        - id: "FP-UC05-003"
          title: "Sistema valida tenant"
          required: true
        - id: "FP-UC05-004"
          title: "Sistema exibe formulário metas"
          required: true
        - id: "FP-UC05-005"
          title: "Usuário informa valores"
          required: true
        - id: "FP-UC05-006"
          title: "Sistema valida hierarquia RN-RF044-04"
          required: true
        - id: "FP-UC05-007"
          title: "Sistema valida lógica mínima < ideal < desafiadora"
          required: true
        - id: "FP-UC05-008"
          title: "Sistema persiste em KPIMeta"
          required: true
        - id: "FP-UC05-009"
          title: "Sistema recalcula semáforo RN-RF044-05"
          required: true
        - id: "FP-UC05-010"
          title: "Sistema registra auditoria"
          required: true
        - id: "FP-UC05-011"
          title: "Sistema confirma sucesso"
          required: true
        - id: "FA-UC05-001"
          title: "Definir metas múltiplos períodos"
          required: false
        - id: "FA-UC05-002"
          title: "Copiar metas período anterior"
          required: false
        - id: "FA-UC05-003"
          title: "Definir metas hierárquicas pai-filho"
          required: false
        - id: "FE-UC05-001"
          title: "Mínima >= Ideal → erro 400"
          required: true
        - id: "FE-UC05-002"
          title: "Soma filhas > 100% pai → erro 400"
          required: true
        - id: "FE-UC05-003"
          title: "Valores negativos → erro 400"
          required: true

    precondicoes:
      - permissao: "GES.KPI.META.DEFINIR"

    gatilho: "Usuario acessa configuracao metas do KPI"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessar_tela_metas"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "exibir_formulario"
      - passo: 4
        ator: "usuario"
        acao: "informar_metas"
      - passo: 5
        ator: "sistema"
        acao: "validar_hierarquia"
      - passo: 6
        ator: "sistema"
        acao: "validar_logica_valores"
      - passo: 7
        ator: "sistema"
        acao: "persistir_metas"
      - passo: 8
        ator: "sistema"
        acao: "recalcular_semaforo"
      - passo: 9
        ator: "sistema"
        acao: "registrar_auditoria"

    regras_aplicadas:
      - "RN-RF044-04"
      - "RN-RF044-05"

    resultado_final:
      estado: "metas_definidas_semaforo_atualizado"

  - id: "UC06"
    nome: "Configurar Alertas"
    ator_principal: "usuario_autenticado"
    tipo: "acao"
    impacta_dados: true

    covers:
      documentacao_items:
        - "RF-SEC-01"
      uc_items:
        - id: "FP-UC06-001"
          title: "Usuário acessa configuração alertas"
          required: true
        - id: "FP-UC06-002"
          title: "Sistema valida permissão GES.KPI.ALERTA.CONFIGURAR"
          required: true
        - id: "FP-UC06-003"
          title: "Sistema valida tenant"
          required: true
        - id: "FP-UC06-004"
          title: "Sistema exibe formulário alertas"
          required: true
        - id: "FP-UC06-005"
          title: "Usuário configura alerta"
          required: true
        - id: "FP-UC06-006"
          title: "Sistema valida cooldown mínimo RN-RF044-10"
          required: true
        - id: "FP-UC06-007"
          title: "Sistema valida tendência RN-RF044-06"
          required: true
        - id: "FP-UC06-008"
          title: "Sistema valida anomalia RN-RF044-07"
          required: true
        - id: "FP-UC06-009"
          title: "Sistema persiste em KPIAlerta"
          required: true
        - id: "FP-UC06-010"
          title: "Sistema agenda job Hangfire"
          required: true
        - id: "FP-UC06-011"
          title: "Sistema registra auditoria"
          required: true
        - id: "FP-UC06-012"
          title: "Sistema confirma sucesso"
          required: true
        - id: "FA-UC06-001"
          title: "Testar alerta envio manual"
          required: false
        - id: "FA-UC06-002"
          title: "Configurar múltiplos destinatários"
          required: false
        - id: "FA-UC06-003"
          title: "Configurar escalonamento 7 dias"
          required: false
        - id: "FE-UC06-001"
          title: "Cooldown < 1h → erro 400"
          required: true
        - id: "FE-UC06-002"
          title: "KPI sem meta → erro 400"
          required: true
        - id: "FE-UC06-003"
          title: "Destinatários inválidos → erro 400"
          required: true

    precondicoes:
      - permissao: "GES.KPI.ALERTA.CONFIGURAR"
      - kpi_meta: "definida"

    gatilho: "Usuario acessa configuracao alertas"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessar_configuracao"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "exibir_formulario"
      - passo: 4
        ator: "usuario"
        acao: "configurar_alerta"
      - passo: 5
        ator: "sistema"
        acao: "validar_cooldown"
      - passo: 6
        ator: "sistema"
        acao: "validar_tipo_alerta"
      - passo: 7
        ator: "sistema"
        acao: "persistir_alerta"
      - passo: 8
        ator: "sistema"
        acao: "agendar_job"
      - passo: 9
        ator: "sistema"
        acao: "registrar_auditoria"

    regras_aplicadas:
      - "RN-RF044-06"
      - "RN-RF044-07"
      - "RN-RF044-10"

    resultado_final:
      estado: "alerta_configurado_job_agendado"

  - id: "UC07"
    nome: "Visualizar Dashboard"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      documentacao_items:
        - "RF-SEC-02"
        - "RF-SEC-03"
      uc_items:
        - id: "FP-UC07-001"
          title: "Usuário acessa dashboard KPIs"
          required: true
        - id: "FP-UC07-002"
          title: "Sistema valida permissão GES.KPI.DASHBOARD"
          required: true
        - id: "FP-UC07-003"
          title: "Sistema valida permissões categoria RBAC"
          required: true
        - id: "FP-UC07-004"
          title: "Sistema carrega configuração dashboard"
          required: true
        - id: "FP-UC07-005"
          title: "Sistema aplica agregação RN-RF044-14"
          required: true
        - id: "FP-UC07-006"
          title: "Sistema exibe cards KPIs"
          required: true
        - id: "FP-UC07-007"
          title: "Sistema exibe gráficos ApexCharts"
          required: true
        - id: "FP-UC07-008"
          title: "Sistema exibe alertas críticos"
          required: true
        - id: "FP-UC07-009"
          title: "Sistema habilita SignalR real-time"
          required: true
        - id: "FA-UC07-001"
          title: "Filtrar por categoria"
          required: false
        - id: "FA-UC07-002"
          title: "Filtrar por período"
          required: false
        - id: "FA-UC07-003"
          title: "Personalizar layout drag-drop"
          required: false
        - id: "FA-UC07-004"
          title: "Gerar link público JWT RN-RF044-13"
          required: false
        - id: "FA-UC07-005"
          title: "Drill-down para UC02"
          required: false
        - id: "FE-UC07-001"
          title: "Nenhum KPI → estado vazio"
          required: true
        - id: "FE-UC07-002"
          title: "Sem permissão categoria → KPIs filtrados"
          required: true

    precondicoes:
      - permissao: "GES.KPI.DASHBOARD"
      - permissao_categoria: "GES.KPI.VIEW.*"

    gatilho: "Usuario acessa dashboard executivo"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessar_dashboard"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "aplicar_rbac_categoria"
      - passo: 4
        ator: "sistema"
        acao: "carregar_configuracao"
      - passo: 5
        ator: "sistema"
        acao: "aplicar_agregacao"
      - passo: 6
        ator: "sistema"
        acao: "exibir_dashboard"
      - passo: 7
        ator: "sistema"
        acao: "habilitar_signalr"

    regras_aplicadas:
      - "RN-RF044-13"
      - "RN-RF044-14"

    resultado_final:
      estado: "dashboard_exibido_realtime"

  - id: "UC08"
    nome: "Exportar KPIs"
    ator_principal: "usuario_autenticado"
    tipo: "acao"
    impacta_dados: false

    covers:
      documentacao_items:
        - "RF-SEC-01"
      uc_items:
        - id: "FP-UC08-001"
          title: "Usuário solicita exportação"
          required: true
        - id: "FP-UC08-002"
          title: "Sistema valida permissão GES.KPI.EXPORTAR"
          required: true
        - id: "FP-UC08-003"
          title: "Sistema valida permissões categoria"
          required: true
        - id: "FP-UC08-004"
          title: "Sistema valida tenant"
          required: true
        - id: "FP-UC08-005"
          title: "Usuário seleciona formato"
          required: true
        - id: "FP-UC08-006"
          title: "Usuário seleciona período e KPIs"
          required: true
        - id: "FP-UC08-007"
          title: "Sistema aplica filtro RBAC categoria"
          required: true
        - id: "FP-UC08-008"
          title: "Sistema gera arquivo"
          required: true
        - id: "FP-UC08-009"
          title: "Sistema respeita retenção 7 anos RN-RF044-15"
          required: true
        - id: "FP-UC08-010"
          title: "Sistema registra auditoria"
          required: true
        - id: "FP-UC08-011"
          title: "Sistema disponibiliza download"
          required: true
        - id: "FA-UC08-001"
          title: "Agendar exportação recorrente"
          required: false
        - id: "FA-UC08-002"
          title: "Exportar OData Power BI"
          required: false
        - id: "FA-UC08-003"
          title: "Exportar API Tableau"
          required: false
        - id: "FA-UC08-004"
          title: "Incluir drill-down Excel"
          required: false
        - id: "FE-UC08-001"
          title: "Período > 7 anos → erro 400"
          required: true
        - id: "FE-UC08-002"
          title: "Sem permissão categoria → KPIs filtrados"
          required: true
        - id: "FE-UC08-003"
          title: "Erro geração arquivo → erro 500"
          required: true

    precondicoes:
      - permissao: "GES.KPI.EXPORTAR"
      - permissao_categoria: "GES.KPI.VIEW.*"

    gatilho: "Usuario solicita exportacao"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "solicitar_exportacao"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "validar_categoria"
      - passo: 4
        ator: "usuario"
        acao: "selecionar_formato_periodo"
      - passo: 5
        ator: "sistema"
        acao: "aplicar_filtro_rbac"
      - passo: 6
        ator: "sistema"
        acao: "gerar_arquivo"
      - passo: 7
        ator: "sistema"
        acao: "validar_retencao"
      - passo: 8
        ator: "sistema"
        acao: "registrar_auditoria"
      - passo: 9
        ator: "sistema"
        acao: "disponibilizar_download"

    regras_aplicadas:
      - "RN-RF044-15"

    resultado_final:
      estado: "arquivo_exportado_disponivel"

exclusions:
  uc_items: []

historico:
  - versao: "2.0"
    data: "2025-12-31"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Versão canônica orientada a contrato - adequada aos templates oficiais"
  - versao: "1.0"
    data: "2025-12-18"
    autor: "Equipe IControlIT"
    descricao: "Versão inicial com estrutura resumida"
