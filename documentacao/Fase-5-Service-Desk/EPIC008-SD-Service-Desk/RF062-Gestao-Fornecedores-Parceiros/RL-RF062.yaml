# =============================================
# RL-RF062 — Referência ao Legado
# Gestão de Fornecedores e Parceiros
# Versão: 2.0
# Data: 2025-12-30
# =============================================

rf_id: RF062
titulo: "Gestão de Fornecedores e Parceiros"

legado:
  sistema: "VB.NET + ASP.NET Web Forms"
  versao: "IControlIT v1.0 (legado)"
  arquitetura: "Monolítica WebForms"
  banco_dados: "SQL Server (multi-database por cliente)"
  multi_tenant: false  # Segregação por bancos separados
  auditoria: "partial"  # Auditoria apenas em algumas tabelas

# ==============================================================================
# REFERÊNCIAS AO LEGADO (LISTA UNIFICADA)
# ==============================================================================
# CRÍTICO: Campo "destino" OBRIGATÓRIO em todos os itens
# Valores permitidos: assumido | substituido | descartado | a_revisar
# ==============================================================================

referencias:
  # ------------------------------------------------------------------------------
  # TELAS RELACIONADAS (PARCIAIS - NÃO DEDICADAS A FORNECEDORES)
  # ------------------------------------------------------------------------------
  - id: "LEG-RF062-001"
    tipo: "tela"
    nome: "Cadastro de Contratos"
    caminho: "ic1_legado/IControlIT/IControlIT/Contrato/Contrato.aspx"
    descricao: |
      Tela de cadastro de contratos no legado.
      Possuía campo texto livre "Fornecedor" (TextBox txtFornecedor) sem validação de CNPJ.
      Não havia vínculo formal com entidade Fornecedor (não existia).
      Dados de fornecedor eram armazenados como texto livre, causando duplicação e inconsistência.
    regras_implicitas:
      - "Campo 'Fornecedor' aceitava qualquer texto (sem validação de CNPJ ou razão social)"
      - "Mesmo fornecedor podia aparecer com grafias diferentes"
      - "Impossibilidade de rastrear contratos por fornecedor de forma confiável"
    destino: "substituido"
    justificativa: |
      No sistema moderno, contratos são vinculados a entidade Fornecedor via FK.
      Campo texto livre foi substituído por relacionamento normalizado (ContratoFornecedor.FornecedorId).
      CNPJ agora é validado com dígitos verificadores.
    documentacao_item_relacionado: "RN-RF062-005"
    uc_relacionado: "UC07"
    migracao_moderna:
      componente_angular: "contratos-fornecedor.component.ts"
      rota_frontend: "/service-desk/fornecedores/{id}/contratos"

  - id: "LEG-RF062-002"
    tipo: "tela"
    nome: "Cadastro de SLA de Operação"
    caminho: "ic1_legado/IControlIT/IControlIT/Contrato/Contrato_SLA_Operacao.aspx"
    descricao: |
      Tela de cadastro de SLA contratual no legado.
      SLA era cadastrado manualmente, mas não havia medição automática de cumprimento.
      Não havia rastreamento de atendimentos reais para calcular percentual de compliance.
    regras_implicitas:
      - "SLA definido manualmente (tempo de resposta, tempo de resolução)"
      - "Sem medição automática de cumprimento"
      - "Sem vínculo com solicitações/OSs atendidas"
      - "Gestores precisavam calcular compliance manualmente"
    destino: "substituido"
    justificativa: |
      No sistema moderno, SLA é medido automaticamente com base em atendimentos reais.
      Vínculo com solicitações permite cálculo de percentual de cumprimento mensal.
      Alertas automáticos quando SLA fica abaixo da meta.
    documentacao_item_relacionado: "RN-RF062-006"
    uc_relacionado: "UC08"
    migracao_moderna:
      componente_angular: "fornecedor-sla.component.ts"
      rota_frontend: "/service-desk/fornecedores/{id}/slas"

  - id: "LEG-RF062-003"
    tipo: "tela"
    nome: "Cadastro de Nota Fiscal"
    caminho: "ic1_legado/IControlIT/IControlIT/Estoque/Nota_Fiscal.aspx"
    descricao: |
      Tela de cadastro de notas fiscais no legado.
      Possuía campos CNPJ_Emissor e RazaoSocial_Emissor como VARCHAR sem validação.
      CNPJs inválidos eram aceitos, causando problemas de consolidação.
    regras_implicitas:
      - "CNPJ armazenado como VARCHAR(18) sem validação de dígitos verificadores"
      - "Razão Social duplicada em múltiplas notas fiscais (sem normalização)"
      - "Impossibilidade de consolidar compras por fornecedor confiável"
    destino: "substituido"
    justificativa: |
      No sistema moderno, Nota Fiscal terá FK para entidade Fornecedor.
      CNPJ validado com algoritmo de dígitos verificadores.
      Dados normalizados, eliminando duplicação.
    documentacao_item_relacionado: "RN-RF062-002"
    uc_relacionado: null
    migracao_moderna:
      componente_angular: null
      rota_frontend: null
    observacao: "Integração com módulo de Estoque (RF futuro)"

  - id: "LEG-RF062-004"
    tipo: "tela"
    nome: "Solicitações e Chamados"
    caminho: "ic1_legado/IControlIT/IControlIT/Chamado/Solicitacao.aspx"
    descricao: |
      Tela de gestão de solicitações e chamados no legado.
      OSs eram atribuídas apenas a técnicos internos.
      Não havia opção de atribuir a fornecedores externos.
      Sem rastreamento de histórico de atendimentos por fornecedor.
    regras_implicitas:
      - "Atribuição apenas para usuários internos (tabela Usuario)"
      - "Sem campo para fornecedor externo"
      - "Impossibilidade de rastrear performance de fornecedores em atendimentos"
    destino: "substituido"
    justificativa: |
      No sistema moderno, solicitações podem ser atribuídas a fornecedores externos.
      Vínculo automático cria histórico de atendimentos.
      Histórico alimenta cálculo de SLA compliance e avaliações.
    documentacao_item_relacionado: "RN-RF062-010"
    uc_relacionado: "UC14"
    migracao_moderna:
      componente_angular: "solicitacao-fornecedor.component.ts"
      rota_frontend: "/service-desk/solicitacoes/{id}/fornecedor"
    observacao: "Requer modificação no módulo de Solicitações (RF021)"

  # ------------------------------------------------------------------------------
  # WEBSERVICES RELACIONADOS (PARCIAIS)
  # ------------------------------------------------------------------------------
  - id: "LEG-RF062-005"
    tipo: "webservice"
    nome: "WSContrato.asmx - Cadastro de Contratos"
    caminho: "ic1_legado/IControlIT/WS_IControlIT/WSContrato.asmx"
    descricao: |
      WebService SOAP para CRUD de contratos.
      Métodos: CriarContrato, AtualizarContrato, ListarContratos.
      Fornecedor era recebido como string (parâmetro @Fornecedor VARCHAR).
      Sem validação de CNPJ ou existência de fornecedor.
    metodos:
      - nome: "CriarContrato"
        parametros: "@NumeroContrato, @Fornecedor (VARCHAR), @DataInicio, @DataFim, @ValorMensal"
        retorno: "DataSet com ID do contrato criado"
      - nome: "AtualizarContrato"
        parametros: "@ContratoId, @Fornecedor (VARCHAR), @DataFim, @ValorMensal"
        retorno: "Boolean (sucesso/falha)"
    destino: "substituido"
    justificativa: |
      No sistema moderno, substituído por REST API com validação de FornecedorId.
      Endpoint POST /api/contratos-fornecedor recebe DTO com FornecedorId validado.
      Validação de existência de fornecedor no handler.
    documentacao_item_relacionado: "RN-RF062-005"
    uc_relacionado: "UC07"
    migracao_moderna:
      command_cqrs: "CreateContratoFornecedorCommand"
      handler: "CreateContratoFornecedorCommandHandler"
      endpoint_moderno: "POST /api/fornecedores/{id}/contratos"

  # ------------------------------------------------------------------------------
  # STORED PROCEDURES RELACIONADAS
  # ------------------------------------------------------------------------------
  - id: "LEG-RF062-006"
    tipo: "stored_procedure"
    nome: "pa_Contrato_Insert"
    caminho: "ic1_legado/BancoDados/Base/Branco.sql (procedure pa_Contrato_Insert)"
    descricao: |
      Stored procedure para inserir contrato no legado.
      Recebia parâmetro @Fornecedor VARCHAR(200) e armazenava como texto livre.
      Sem validação de CNPJ ou FK.
    parametros_entrada:
      - "@NumeroContrato VARCHAR(50)"
      - "@Fornecedor VARCHAR(200)"
      - "@DataInicio DATE"
      - "@DataFim DATE"
      - "@ValorMensal DECIMAL(18,2)"
    parametros_saida:
      - "@ContratoId INT OUTPUT"
    destino: "substituido"
    justificativa: |
      No sistema moderno, lógica movida para Application Layer (CQRS Handler).
      Entity Framework Core gerencia persistência com FK para Fornecedor.
      Validações no FluentValidator antes de persistir.
    documentacao_item_relacionado: "RN-RF062-005"
    uc_relacionado: "UC07"
    migracao_moderna:
      handler: "CreateContratoFornecedorCommandHandler"
      validacao: "CreateContratoFornecedorCommandValidator"
      migration_ef_core: "20261230_CreateContratoFornecedorTable.cs"

  # ------------------------------------------------------------------------------
  # TABELAS LEGADAS RELACIONADAS
  # ------------------------------------------------------------------------------
  - id: "LEG-RF062-007"
    tipo: "tabela"
    nome: "Contrato"
    caminho: "Database/dbo.Contrato"
    schema_legado: "[dbo].[Contrato]"
    descricao: |
      Tabela de contratos no legado.
      Possuía campos Fornecedor_RazaoSocial e Fornecedor_CNPJ como VARCHAR.
      Dados duplicados, sem FK para entidade Fornecedor (que não existia).
    problemas_identificados:
      - "Fornecedor_CNPJ VARCHAR(18) sem validação de formato ou dígitos verificadores"
      - "Fornecedor_RazaoSocial VARCHAR(200) duplicado em múltiplos contratos"
      - "Sem FK para tabela Fornecedor (não existia)"
      - "Impossibilidade de rastrear contratos por fornecedor confiável"
      - "Sem auditoria de alterações de fornecedor"
    destino: "substituido"
    justificativa: |
      No sistema moderno, tabela ContratoFornecedor tem FK para Fornecedor.
      Dados normalizados, CNPJ validado, auditoria completa.
    documentacao_item_relacionado: "RN-RF062-005"
    uc_relacionado: "UC07"
    migracao_moderna:
      tabela_moderna: "ContratoFornecedor"
      migration_ef_core: "20261230_CreateContratoFornecedorTable.cs"
      fk_adicionadas: ["FornecedorId → Fornecedor(Id)"]

  - id: "LEG-RF062-008"
    tipo: "tabela"
    nome: "Nota_Fiscal"
    caminho: "Database/dbo.Nota_Fiscal"
    schema_legado: "[dbo].[Nota_Fiscal]"
    descricao: |
      Tabela de notas fiscais no legado.
      Possuía campos CNPJ_Emissor e RazaoSocial_Emissor sem normalização.
    problemas_identificados:
      - "CNPJ_Emissor VARCHAR(14) sem validação"
      - "RazaoSocial_Emissor VARCHAR(200) duplicado"
      - "Sem FK para Fornecedor"
      - "Dados inconsistentes (mesmo CNPJ com razões sociais diferentes)"
    destino: "substituido"
    justificativa: |
      No sistema moderno, Nota_Fiscal terá FK para Fornecedor.
      Dados consolidados e normalizados.
    documentacao_item_relacionado: "RN-RF062-002"
    uc_relacionado: null
    migracao_moderna:
      tabela_moderna: "NotaFiscal"
      migration_ef_core: "Futuro (módulo Estoque)"
      fk_adicionadas: ["FornecedorId → Fornecedor(Id)"]

# ==============================================================================
# ANÁLISE DE GAPS (FUNCIONALIDADES NOVAS)
# ==============================================================================
# Funcionalidades que NÃO existiam no legado e foram criadas no sistema moderno

gap_analysis:
  - item: "Entidade Fornecedor"
    existe_legado: false
    existe_moderno: true
    notas: |
      Entidade formal de Fornecedor NÃO EXISTIA no legado.
      Informações de fornecedores eram armazenadas como texto livre em múltiplas tabelas.
      Sistema moderno cria entidade dedicada com CNPJ validado, categoria, status, homologação.
      Benefícios: normalização de dados, histórico consolidado, decisões baseadas em dados.
    documentacao_item_relacionado: "RN-RF062-001, RN-RF062-002"
    uc_relacionado: "UC01, UC02, UC03, UC04"
    tabela_moderna: "Fornecedor"
    migration_ef_core: "20261230_CreateFornecedorTable.cs"

  - item: "Upload de Documentação Obrigatória"
    existe_legado: false
    existe_moderno: true
    notas: |
      Controle de documentação obrigatória (CNDs) NÃO EXISTIA no legado.
      Sistema moderno implementa upload, validação de vencimentos, alertas automáticos.
      Alertas automáticos em D-30, D-15, D-7 evitam bloqueios por vencimento.
    documentacao_item_relacionado: "RN-RF062-002, RN-RF062-003, RN-RF062-004"
    uc_relacionado: "UC05"
    tabela_moderna: "DocumentoFornecedor"
    migration_ef_core: "20261230_CreateDocumentoFornecedorTable.cs"
    job_hangfire: "VerificarVencimentosDocumentosJob (diário 08:00)"

  - item: "Processo de Homologação"
    existe_legado: false
    existe_moderno: true
    notas: |
      Workflow de homologação de fornecedores NÃO EXISTIA no legado.
      Sistema moderno implementa estados (rascunho → em_analise → ativo) com aprovador formal.
      Garante que apenas fornecedores qualificados sejam habilitados.
    documentacao_item_relacionado: "RN-RF062-014"
    uc_relacionado: "UC09"
    tabela_moderna: "HomologacaoFornecedor"
    migration_ef_core: "20261230_CreateHomologacaoFornecedorTable.cs"

  - item: "Avaliações Periódicas"
    existe_legado: false
    existe_moderno: true
    notas: |
      Sistema de avaliação estruturada de fornecedores NÃO EXISTIA no legado.
      Sistema moderno implementa avaliações trimestrais com 4 dimensões (Qualidade, Prazo, Custo, Atendimento).
      Histórico de avaliações permite identificar tendências de melhoria ou piora.
    documentacao_item_relacionado: "RN-RF062-007"
    uc_relacionado: "UC10"
    tabela_moderna: "AvaliacaoFornecedor"
    migration_ef_core: "20261230_CreateAvaliacaoFornecedorTable.cs"

  - item: "Ranking de Fornecedores"
    existe_legado: false
    existe_moderno: true
    notas: |
      Ranking automático de fornecedores NÃO EXISTIA no legado.
      Sistema moderno calcula score combinando avaliações (60%) e SLA compliance (40%).
      Dados objetivos reduzem viés e melhoram qualidade das decisões.
    documentacao_item_relacionado: "RN-RF062-008"
    uc_relacionado: "UC11"
    query: "GetRankingFornecedoresQuery"
    job_hangfire: "RecalcularRankingFornecedoresJob (mensal, dia 1)"

  - item: "Dashboard de Performance"
    existe_legado: false
    existe_moderno: true
    notas: |
      Dashboard executivo de fornecedores NÃO EXISTIA no legado.
      Sistema moderno exibe métricas em tempo real: SLA compliance, nota média, contratos ativos, documentos vencidos.
      Gráficos de evolução temporal facilitam identificação de problemas.
    documentacao_item_relacionado: "RN-RF062-012"
    uc_relacionado: "UC12"
    componente_angular: "fornecedor-dashboard.component.ts"
    rota_frontend: "/service-desk/fornecedores/dashboard"
    query: "GetDashboardFornecedoresQuery"

  - item: "Múltiplos Contatos por Fornecedor"
    existe_legado: false
    existe_moderno: true
    notas: |
      Gestão de múltiplos contatos por fornecedor NÃO EXISTIA no legado.
      Sistema moderno permite cadastrar contatos por departamento (Comercial, Técnico, Financeiro).
      Contatos primários por departamento agilizam resolução de problemas.
    documentacao_item_relacionado: "RN-RF062-009"
    uc_relacionado: "UC06"
    tabela_moderna: "ContatoFornecedor"
    migration_ef_core: "20261230_CreateContatoFornecedorTable.cs"

  - item: "Histórico de Atendimentos"
    existe_legado: false
    existe_moderno: true
    notas: |
      Rastreamento de histórico de atendimentos por fornecedor NÃO EXISTIA no legado.
      Sistema moderno vincula automaticamente OSs ao fornecedor e mantém histórico completo.
      Histórico permite identificar padrões de qualidade ou problemas recorrentes.
    documentacao_item_relacionado: "RN-RF062-010, RN-RF062-011"
    uc_relacionado: "UC14"
    tabela_moderna: "AtendimentoFornecedor (view derivada)"
    query: "GetHistoricoAtendimentosFornecedorQuery"

  - item: "Export para Compliance"
    existe_legado: false
    existe_moderno: true
    notas: |
      Exportação de relatório de compliance de fornecedores NÃO EXISTIA no legado.
      Sistema moderno gera relatórios consolidados em Excel/PDF para auditorias.
      Relatórios padronizados agilizam processos de compliance.
    documentacao_item_relacionado: "RN-RF062-015"
    uc_relacionado: "UC13"
    handler: "ExportRelatorioComplianceFornecedoresCommandHandler"
    bibliotecas: "ClosedXML (Excel), iTextSharp (PDF)"

# ==============================================================================
# BANCOS LEGADOS MAPEADOS
# ==============================================================================

bancos_legados:
  - nome: "Cliente_Modelo"
    servidor: "SQL-LEGADO-01"
    tabelas_relacionadas:
      - "Contrato (campo texto Fornecedor)"
      - "Nota_Fiscal (campos CNPJ_Emissor, RazaoSocial_Emissor)"
    destino: "consolidado"
    justificativa: "Migrado para banco único com multi-tenancy (EmpresaId). Dados de fornecedores consolidados em entidade Fornecedor normalizada."
    banco_moderno: "IControlIT.db (SQLite dev) / SQL Server moderno (prod)"

# ==============================================================================
# PROBLEMAS LEGADO IDENTIFICADOS
# ==============================================================================

problemas_legado:
  - id: "PROB-RF062-001"
    titulo: "Ausência de entidade Fornecedor"
    severidade: "CRÍTICA"
    descricao: |
      Sistema legado não possuía entidade formal de Fornecedor.
      Dados espalhados em múltiplas tabelas como texto livre (Contrato.Fornecedor, Nota_Fiscal.CNPJ_Emissor).
      Duplicação, inconsistência, impossibilidade de rastreamento consolidado.
    impacto: "Decisões de contratação sem embasamento, risco de compliance legal, dados inconsistentes."
    solucao_moderna: "Criação de entidade Fornecedor com CNPJ validado, categoria, status, homologação, auditoria completa."

  - id: "PROB-RF062-002"
    titulo: "Falta de controle de documentação obrigatória"
    severidade: "CRÍTICA"
    descricao: |
      Sistema legado não controlava validade de certidões obrigatórias (CNDs).
      Fornecedores podiam estar com documentação vencida sem conhecimento da empresa.
    impacto: "Risco legal alto, possibilidade de contratar fornecedores irregulares, multas em auditorias."
    solucao_moderna: "Upload de documentação com validação de vencimentos, alertas automáticos D-30/D-15/D-7, bloqueio automático por doc vencida."

  - id: "PROB-RF062-003"
    titulo: "SLA não monitorado automaticamente"
    severidade: "ALTA"
    descricao: |
      SLA contratual era cadastrado mas não medido automaticamente.
      Gestores precisavam calcular compliance manualmente, sujeito a erros.
    impacto: "Impossibilidade de avaliar performance objetivamente, dificuldade em identificar fornecedores com baixo desempenho."
    solucao_moderna: "Medição automática de SLA com base em atendimentos reais, alertas quando SLA < meta, dashboard de compliance."

  - id: "PROB-RF062-004"
    titulo: "Avaliação informal e não estruturada"
    severidade: "ALTA"
    descricao: |
      Performance de fornecedores era avaliada informalmente.
      Decisões de renovação baseadas em memória individual, sem dados históricos objetivos.
    impacto: "Viés em decisões de contratação, dificuldade em justificar substituição de fornecedores ruins."
    solucao_moderna: "Avaliações trimestrais estruturadas com 4 dimensões, histórico completo, ranking automático por categoria."

  - id: "PROB-RF062-005"
    titulo: "Alertas de vencimento manuais"
    severidade: "MÉDIA"
    descricao: |
      Alertas de vencimento de contratos e documentos eram feitos manualmente.
      Dependia de lembrança de gestores, causando atrasos e perda de prazos de negociação.
    impacto: "Renovações atrasadas, perda de janelas de negociação, custos de contratação emergencial."
    solucao_moderna: "Jobs diários automáticos com alertas em D-90/D-60/D-30 (contratos) e D-30/D-15/D-7 (documentos)."

  - id: "PROB-RF062-006"
    titulo: "Dados de fornecedores não normalizados"
    severidade: "ALTA"
    descricao: |
      Mesmo fornecedor aparecia com grafias diferentes (CNPJ ou Razão Social).
      Impossibilidade de consolidar compras, contratos e histórico de forma confiável.
    impacto: "Relatórios imprecisos, dificuldade em negociar volumes, perda de oportunidades de economia de escala."
    solucao_moderna: "Entidade Fornecedor normalizada, CNPJ validado como chave de negócio única, consolidação automática."

# ==============================================================================
# METADADOS DE MIGRAÇÃO
# ==============================================================================

metadados:
  total_itens_referencias: 8  # Apenas itens com referência real ao legado
  itens_assumidos: 0
  itens_substituidos: 8
  itens_descartados: 0
  itens_a_revisar: 0
  total_itens_gap_analysis: 9  # Funcionalidades novas documentadas em gap_analysis
  cobertura_destinos: "100%"  # Todos os 8 itens de referências possuem campo destino preenchido
  funcionalidade_nova_percentual: "53%"  # 9 de 17 funcionalidades são novas
  script_migracao_necessario: true
  complexidade_migracao: "ALTA"
  observacoes: |
    RF062 é majoritariamente funcionalidade NOVA (53% das funcionalidades).
    Migração exige consolidação de dados espalhados em múltiplas tabelas do legado.
    Recomenda-se período de grace de 30 dias antes de ativar bloqueios automáticos.
    Treinamento de gestores é crítico para adoção do workflow de homologação.
    Funcionalidades novas documentadas em gap_analysis (não são referências ao legado).

# ==============================================================================
# CHANGELOG
# ==============================================================================

changelog:
  - versao: "2.0"
    data: "2025-12-30"
    descricao: "Migração v1.0 → v2.0 - Estrutura RL canônica com campo destino obrigatório"
    autor: "Agência ALC - alc.dev.br"
  - versao: "1.0"
    data: "2025-12-30"
    descricao: "Criação inicial do documento de referência ao legado (funcionalidade nova)"
    autor: "Agência ALC - alc.dev.br"
