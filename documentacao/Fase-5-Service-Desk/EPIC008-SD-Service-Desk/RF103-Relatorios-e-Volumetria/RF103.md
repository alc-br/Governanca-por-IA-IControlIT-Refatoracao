# RF-103: Relatórios e Volumetria

**Versão**: 2.0
**Data**: 2025-12-31
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC008-SD-Service-Desk
**Fase**: Fase 5 - Service Desk

---

## 1. OBJETIVO DO REQUISITO

Este requisito define o comportamento do **Módulo de Relatórios e Volumetria**, responsável por fornecer análises quantitativas de chamados, ativos, usuários, contratos e consumo, através de relatórios pré-formatados otimizados para consulta rápida e tomada de decisão estratégica.

O sistema deve permitir que gestores e executivos consultem volumes agregados por período, identifiquem tendências temporais, comparem períodos históricos e visualizem rankings de maior impacto operacional, garantindo performance mesmo com milhões de registros.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Consulta de volumetria agregada (chamados, ativos, usuários, contratos, consumo)
- [x] Análise de tendências com média móvel de 7 dias
- [x] Comparativos temporais (mês vs mês, ano vs ano)
- [x] Rankings top-10 por dimensões (filial, departamento, centro de custo, responsável)
- [x] Consolidação automática diária via job agendado
- [x] Export multi-formato (Excel XLSX, CSV, PDF)
- [x] Processamento assíncrono para grandes volumes (>100k registros)
- [x] Multi-tenancy obrigatório em todos os relatórios
- [x] Auditoria de acesso a relatórios

### 2.2 Fora do escopo (não objetivos)

- Relatórios customizáveis (coberto por RF102)
- Dashboards interativos (coberto por RF099)
- Drill-down dimensional (coberto por RF102)
- Tecnologias específicas de visualização
- Layout, UX ou identidade visual
- Estratégia de deploy ou infraestrutura

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Volumetria Agregada** | Métrica calculada via agregação SQL (COUNT, SUM, AVG) em período específico |
| **Consolidação Diária** | Processo automático que pré-calcula volumetrias às 4h para melhor performance |
| **Média Móvel 7 Dias** | Técnica de suavização de tendências calculando média dos últimos 7 dias |
| **Top 10** | Ranking de dimensões ordenado descendente por volume |
| **Comparativo Temporal** | Análise de variação percentual entre dois períodos finalizados |
| **Multi-tenancy** | Isolamento de dados por ClienteId garantindo segurança |
| **Processamento Assíncrono** | Execução em background para relatórios grandes com notificação ao usuário |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Volumetria de Chamados** - Agregação por tipo, prioridade, status, com filtro temporal
2. **Volumetria de Ativos** - Agregação por tipo, localização, status, com categorização
3. **Volumetria de Usuários** - Contagem de ativos, inativos, por perfil RBAC
4. **Volumetria de Contratos** - Status de vigência (ativos, vencidos, renovados)
5. **Volumetria de Consumo** - Linhas telefônicas, dados móveis (GB), ativos de TI
6. **Análise de Tendência** - Crescimento/redução com média móvel 7 dias
7. **Comparativo de Períodos** - Mês atual vs anterior, ano vs ano, com variação %
8. **Top 10** - Maior volume por filial, centro de custo, departamento, responsável
9. **Volumetria por Dimensão** - Agregação customizável por uma dimensão específica
10. **Export Multi-formato** - Excel (XLSX), CSV, PDF com aba de resumo

---

## 5. REGRAS DE NEGÓCIO

### RN-RF103-001: Volumetria via Agregação SQL Nativa

**Descrição**: Todas as volumetrias devem ser calculadas usando agregações SQL nativas (COUNT, SUM, AVG, GROUP BY, HAVING), nunca processamento em memória na aplicação.

**Justificativa**: Agregações SQL são executadas no banco de dados, próximo aos dados, reduzindo transferência de rede e processamento em memória. Performance superior (< 100ms vs vários segundos).

**Critério de Aceite**:
- Agregação executada via SQL → aceito
- Trazer dados para memória e agregar em C# → rejeitado

---

### RN-RF103-002: Consolidação Diária Automática às 4h

**Descrição**: Um job agendado deve executar diariamente às 4h da madrugada, pré-calculando volumetrias principais e armazenando em tabela dedicada para consulta rápida.

**Justificativa**: Volumetrias são consultadas frequentemente. Pré-calcular em horário de baixa carga elimina processamento pesado durante horário comercial.

**Critério de Aceite**:
- Job executa diariamente às 4h → aceito
- Dados de "ontem" consolidados → aceito
- Usuário solicita cálculo on-demand → rejeitado (exceto para períodos customizados)

---

### RN-RF103-003: Comparativos Exigem Períodos Finalizados

**Descrição**: Comparativos temporais (mês vs mês, ano vs ano) só podem ser gerados se ambos os períodos estiverem completamente finalizados.

**Justificativa**: Evitar comparações enviesadas (período atual incompleto vs período anterior completo).

**Critério de Aceite**:
- Ambos períodos finalizados → aceito
- Período atual ainda em aberto → rejeitado com erro descritivo

---

### RN-RF103-004: Top 10 Ordenado Descendente

**Descrição**: Rankings top-10 devem ser apresentados em ordem descendente (maior volume primeiro) com totalização acumulada e percentual do total.

**Justificativa**: Priorizar visibilidade das áreas de maior impacto operacional.

**Critério de Aceite**:
- Ordenação descendente por volume → aceito
- Cálculo de percentual do total → aceito
- Ordenação ascendente ou aleatória → rejeitado

---

### RN-RF103-005: Tendências Usam Média Móvel 7 Dias

**Descrição**: Análises de tendência devem utilizar média móvel de 7 dias para suavizar flutuações diárias e identificar padrões reais.

**Justificativa**: Dados diários oscilam por fatores sazonais. Média 7 dias elimina ruído e revela tendência real.

**Critério de Aceite**:
- Cálculo de média móvel 7 dias → aceito
- Uso de valores diários brutos → rejeitado

---

### RN-RF103-006: Retenção de Volumetria Histórica 24 Meses

**Descrição**: Registros de volumetria consolidada devem ser mantidos por 24 meses. Após esse período, podem ser arquivados ou deletados conforme política de retenção.

**Justificativa**: Permite comparativos ano vs ano. Atende LGPD.

**Critério de Aceite**:
- Dados retidos por 24 meses → aceito
- Limpeza automática após 24 meses → aceito
- Deletar dados antes de 24 meses → rejeitado

---

### RN-RF103-007: Multi-tenancy Obrigatória - ClienteId em Todos os Filtros

**Descrição**: Todos os relatórios devem filtrar obrigatoriamente por ClienteId do usuário autenticado. Nenhum relatório pode retornar dados de múltiplos clientes.

**Justificativa**: Isolamento de dados entre tenants (SaaS). Segurança de dados confidenciais.

**Critério de Aceite**:
- Filtro por ClienteId presente → aceito
- Usuário de Cliente A vê apenas dados de Cliente A → aceito
- Query sem filtro ClienteId → rejeitado com erro crítico

---

### RN-RF103-008: Export Excel com Aba de Resumo

**Descrição**: Exports em Excel devem ter múltiplas abas: primeira contém resumo executivo (KPIs principais), abas subsequentes contêm dados detalhados por tipo.

**Justificativa**: Executivos visualizam aba de resumo rapidamente. Analistas consultam abas detalhadas.

**Critério de Aceite**:
- Primeira aba = resumo executivo → aceito
- Abas subsequentes = detalhes por tipo → aceito
- Excel com aba única sem organização → rejeitado

---

### RN-RF103-009: Relatórios >100k Registros Processados em Background

**Descrição**: Se um relatório gerar >100.000 registros após agregação, deve ser processado assincronamente via fila com notificação ao usuário por e-mail/sistema.

**Justificativa**: Evitar timeouts HTTP. Garantir que relatórios grandes não sejam perdidos.

**Critério de Aceite**:
- Volume estimado >100k → enfileirar em background → aceito
- Notificação ao usuário após conclusão → aceito
- Processar síncronamente > 100k → rejeitado

---

### RN-RF103-010: Auditoria de Acesso a Relatórios

**Descrição**: Cada acesso a relatório de volumetria deve ser registrado em log de auditoria com: usuário, timestamp, tipo de relatório, parâmetros, resultado.

**Justificativa**: Conformidade (LGPD, ISO 27001). Detecção de anomalias.

**Critério de Aceite**:
- Registro em log de auditoria → aceito
- Dados completos (usuário, timestamp, parâmetros) → aceito
- Acesso sem registro → rejeitado

---

## 6. ESTADOS DA ENTIDADE

| Estado | Descrição |
|--------|-----------|
| **Pendente Consolidação** | Volumetria ainda não processada pelo job diário |
| **Consolidado** | Volumetria pré-calculada e disponível para consulta rápida |
| **Em Processamento** | Export assíncrono em execução (>100k registros) |
| **Disponível para Download** | Export concluído, disponível para download |
| **Expirado** | Export com mais de 7 dias, removido automaticamente |
| **Arquivado** | Volumetria com mais de 24 meses, movida para arquivo histórico |

---

## 7. TRANSIÇÕES DE ESTADO

```
[Pendente Consolidação]
    ↓ (Job diário às 4h)
[Consolidado]
    ↓ (Usuário solicita export <100k)
[Disponível para Download] (síncrono)

[Pendente Consolidação]
    ↓ (Usuário solicita export >100k)
[Em Processamento]
    ↓ (Job finaliza)
[Disponível para Download]
    ↓ (Após 7 dias sem acesso)
[Expirado]

[Consolidado]
    ↓ (Após 24 meses)
[Arquivado]
```

---

## 8. RESTRIÇÕES E VALIDAÇÕES

| Campo | Restrição | Mensagem de Erro |
|-------|-----------|------------------|
| **Data Início** | Obrigatório, formato YYYY-MM-DD | "Data de início é obrigatória" |
| **Data Fim** | Obrigatório, >= Data Início | "Data fim deve ser maior ou igual à data início" |
| **Tipo Relatório** | Obrigatório, valores permitidos: Chamados, Ativos, Usuários, Contratos, Consumo | "Tipo de relatório inválido" |
| **Dimensão** | Opcional, valores permitidos: Filial, Departamento, CentroCusto, Responsável | "Dimensão inválida" |
| **Formato Export** | Obrigatório, valores: XLSX, CSV, PDF | "Formato de export inválido" |

---

## 9. PERMISSÕES RBAC

| Permissão | Descrição | Perfis Padrão |
|-----------|-----------|---------------|
| `relatorio.volumetria.read` | Visualizar relatórios de volumetria | Gestor, Analista, Admin, Diretoria |
| `relatorio.volumetria.export` | Exportar relatórios (Excel, PDF, CSV) | Gestor, Admin, Diretoria |
| `relatorio.volumetria.comparativo` | Gerar comparativos temporais | Analista, Admin, Diretoria |
| `relatorio.volumetria.tendencia` | Visualizar análise de tendências | Analista, Admin, Diretoria |
| `relatorio.volumetria.top10` | Visualizar ranking top-10 | Gestor, Analista, Admin, Diretoria |

---

## 10. API ENDPOINTS

| Método | Endpoint | Descrição | Permissão |
|--------|----------|-----------|-----------|
| GET | `/api/volumetria` | Listar tipos de volumetria disponíveis | `relatorio.volumetria.read` |
| GET | `/api/volumetria/chamados` | Obter volumetria de chamados | `relatorio.volumetria.read` |
| GET | `/api/volumetria/ativos` | Obter volumetria de ativos | `relatorio.volumetria.read` |
| GET | `/api/volumetria/usuarios` | Obter volumetria de usuários | `relatorio.volumetria.read` |
| GET | `/api/volumetria/contratos` | Obter volumetria de contratos | `relatorio.volumetria.read` |
| GET | `/api/volumetria/consumo` | Obter volumetria de consumo | `relatorio.volumetria.read` |
| GET | `/api/volumetria/tendencia` | Análise de tendência com média móvel 7d | `relatorio.volumetria.tendencia` |
| GET | `/api/volumetria/comparativo` | Comparativo mês vs mês ou ano vs ano | `relatorio.volumetria.comparativo` |
| GET | `/api/volumetria/top10/{tipo}` | Top 10 por tipo (filial, depto, etc) | `relatorio.volumetria.top10` |
| GET | `/api/volumetria/por-dimensao/{dimensao}` | Volumetria agregada por dimensão | `relatorio.volumetria.read` |
| POST | `/api/volumetria/export/excel` | Exportar em Excel | `relatorio.volumetria.export` |
| POST | `/api/volumetria/export/csv` | Exportar em CSV | `relatorio.volumetria.export` |
| POST | `/api/volumetria/export/pdf` | Exportar em PDF | `relatorio.volumetria.export` |
| GET | `/api/volumetria/consolidacao/status` | Status da consolidação automática | `relatorio.volumetria.read` |

---

## 11. INTEGRAÇÕES OBRIGATÓRIAS

### 11.1 Central de Funcionalidades (Feature Flags)

**FeatureKey**: `VOLUMETRIA_RELATORIOS`

**Sub-features**:
- `VOLUMETRIA_EXPORT_EXCEL` - Export em Excel
- `VOLUMETRIA_EXPORT_PDF` - Export em PDF
- `VOLUMETRIA_EXPORT_CSV` - Export em CSV
- `VOLUMETRIA_CONSOLIDACAO_AUTOMATICA` - Consolidação via job

### 11.2 Internacionalização (i18n)

**Idiomas Suportados**: pt-BR (padrão), en, es

**Chaves Principais**:
- `volumetria.titulo` - "Relatórios de Volumetria"
- `volumetria.chamados` - "Volumetria de Chamados"
- `volumetria.ativos` - "Volumetria de Ativos"
- `volumetria.periodo.de` - "De"
- `volumetria.periodo.ate` - "Até"
- `volumetria.botoes.gerar` - "Gerar Relatório"
- `volumetria.botoes.exportar` - "Exportar"
- `volumetria.mensagens.sucesso` - "Relatório gerado com sucesso"
- `volumetria.mensagens.erro` - "Erro ao gerar relatório"
- `volumetria.mensagens.processando` - "Relatório em processamento. Você receberá um e-mail quando estiver pronto."

### 11.3 Auditoria

**Operações Auditadas**:
- `REL_VOLUMETRIA_READ` - Consultar volumetria
- `REL_VOLUMETRIA_EXPORT_EXCEL` - Exportar Excel
- `REL_VOLUMETRIA_EXPORT_PDF` - Exportar PDF
- `REL_VOLUMETRIA_EXPORT_CSV` - Exportar CSV
- `REL_VOLUMETRIA_COMPARATIVO` - Gerar comparativo
- `REL_VOLUMETRIA_TENDENCIA` - Gerar tendência
- `REL_VOLUMETRIA_ERRO` - Erro ao gerar

**Retenção**: 24 meses (mesma retenção da volumetria)

### 11.4 Job Agendado (Hangfire)

**Job**: `ConsolidacaoVolumetriaJob`
**Frequência**: Diariamente às 4h (Cron.Daily(4, 0))
**Timeout**: 30 minutos
**Retry**: 3 tentativas com intervalo de 5 minutos

---

## 12. MODELO DE DADOS

Referência ao arquivo: [MD-RF103.md](./MD-RF103.md)

**Principais Entidades**:
- `VolumetriaConsolidada` - Armazena volumetrias pré-calculadas
- `ExportVolumetria` - Rastreia exports assíncronos
- `LogConsolidacao` - Histórico de execuções do job

---

## 13. DEPENDÊNCIAS

### 13.1 RFs Dependentes (Upstream)

- **RF015** - Gestão de Chamados (fonte de dados)
- **RF016** - Gestão de Ativos (fonte de dados)
- **RF006** - Gestão de Usuários (fonte de dados)
- **RF050** - Gestão de Contratos (fonte de dados)

### 13.2 RFs que Dependem Deste (Downstream)

- **RF099** - Dashboards Executivos (consome volumetrias consolidadas)
- **RF102** - Relatórios Customizados (usa mesma engine de agregação)

---

## 14. KPIs E MÉTRICAS

| KPI | Meta | Medição |
|-----|------|---------|
| **Performance Geração Relatório** | < 2 segundos | Tempo de resposta GET /api/volumetria/chamados |
| **Taxa de Sucesso Consolidação** | 99.9% | % consolidações bem-sucedidas vs tentativas |
| **Tempo Consolidação Diária** | < 5 minutos | Tempo total job Hangfire para todos clientes |
| **Acurácia Volumetria** | 100% | COUNT agregado vs count manual (amostra 1%) |
| **Disponibilidade do Módulo** | 99.95% | Uptime do endpoint /api/volumetria |
| **Taxa Export Sucesso** | 98% | % exports bem-sucedidos vs tentativas |
| **Uso de Cache** | > 80% | % requests servidas do cache vs banco |

---

## 15. ALERTAS CRÍTICOS

| Alerta | Condição | Ação |
|--------|----------|------|
| **Consolidação Falhou** | Job não completou às 5:30 AM | E-mail DevOps, ticket crítico |
| **Performance Degradada** | Tempo de resposta > 5 segundos | Investigar índices, cache, slow queries |
| **Exportação Travou** | Job export pendente > 30 minutos | Cancelar job, notificar usuário |
| **Taxa Erro Alta** | > 1% requests retornam 5xx | Investigar logs, rollback se necessário |
| **Espaço Disco Cheio** | Storage < 20% livre | Arquivar volumetria antiga, aumentar quota |
| **Cache Inválido** | Hit rate Redis < 50% | Revisar TTL cache, otimizar invalidação |

---

## 16. CENTRAL DE FUNCIONALIDADES

**Código da Funcionalidade**: `VOLUMETRIA`

**Módulo**: Relatórios

**Chaves i18n**:
- Menu: `menu.relatorios.volumetria`
- Título: `funcionalidades.volumetria.titulo`
- Descrição: `funcionalidades.volumetria.descricao`

---

## 17. PRÓXIMOS PASSOS

1. **Casos de Uso**: Criar [UC-RF103.md](./UC-RF103.md)
2. **Modelo de Dados**: Criar [MD-RF103.md](./MD-RF103.md)
3. **Fluxos de Tela**: Criar [WF-RF103.md](./WF-RF103.md)
4. **User Stories**: Criar [user-stories.yaml](./user-stories.yaml)
5. **Testes**: Criar [TC-RF103.yaml](./TC-RF103.yaml)
6. **Implementação Backend**: Commands/Queries/Handlers (CQRS + MediatR)
7. **Implementação Frontend**: Componentes Angular com Chart.js
8. **Integração Hangfire**: Configurar job de consolidação automática
9. **Validação E2E**: Testes Playwright completos
10. **Deploy HOM**: Testes em homologação

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 1.0 | 2025-12-28 | Versão inicial com legado misto | Claude Code |
| 2.0 | 2025-12-31 | Migração v1.0 → v2.0 - Separação RF/RL completa | Claude Code |

---

**Última Atualização**: 2025-12-31
**Autor**: Claude Code
**Revisão**: Pendente
**Status**: ATIVO
**Governança**: v2.0
