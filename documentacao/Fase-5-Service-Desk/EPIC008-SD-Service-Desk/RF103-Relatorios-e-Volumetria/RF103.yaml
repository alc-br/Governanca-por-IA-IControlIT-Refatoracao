rf_id: RF103
rf_title: "Relatórios e Volumetria"
versao_governanca: "2.0"
data_migracao: "2025-12-31"
epic: "EPIC008-SD-Service-Desk"
fase: "Fase 5 - Service Desk"

# ==============================================================================
# REGRAS DE NEGÓCIO
# ==============================================================================

regras_negocio:
  - id: "RN-RF103-001"
    titulo: "Volumetria via Agregação SQL Nativa"
    descricao: "Todas as volumetrias devem ser calculadas usando agregações SQL nativas (COUNT, SUM, AVG, GROUP BY, HAVING), nunca processamento em memória na aplicação"
    criticidade: "CRÍTICA"
    implementacao:
      backend: true
      frontend: false
      validacao_api: true
      validacao_ui: false
    validacao:
      tipo: "performance"
      mensagem_erro: "Agregação deve ser executada no banco de dados"
      http_code: null

  - id: "RN-RF103-002"
    titulo: "Consolidação Diária Automática às 4h"
    descricao: "Job agendado deve executar diariamente às 4h da madrugada, pré-calculando volumetrias principais e armazenando em tabela dedicada"
    criticidade: "ALTA"
    implementacao:
      backend: true
      frontend: false
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "job_agendado"
      mensagem_erro: null
      http_code: null

  - id: "RN-RF103-003"
    titulo: "Comparativos Exigem Períodos Finalizados"
    descricao: "Comparativos temporais (mês vs mês, ano vs ano) só podem ser gerados se ambos os períodos estiverem completamente finalizados"
    criticidade: "ALTA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "periodo_finalizado"
      mensagem_erro: "Comparativo não disponível. Período atual ainda está em aberto."
      http_code: 422

  - id: "RN-RF103-004"
    titulo: "Top 10 Ordenado Descendente"
    descricao: "Rankings top-10 devem ser apresentados em ordem descendente (maior volume primeiro) com totalização acumulada e percentual do total"
    criticidade: "MÉDIA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "ordenacao"
      mensagem_erro: null
      http_code: null

  - id: "RN-RF103-005"
    titulo: "Tendências Usam Média Móvel 7 Dias"
    descricao: "Análises de tendência devem utilizar média móvel de 7 dias para suavizar flutuações diárias e identificar padrões reais"
    criticidade: "MÉDIA"
    implementacao:
      backend: true
      frontend: false
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "calculo"
      mensagem_erro: null
      http_code: null

  - id: "RN-RF103-006"
    titulo: "Retenção de Volumetria Histórica 24 Meses"
    descricao: "Registros de volumetria consolidada devem ser mantidos por 24 meses. Após esse período, podem ser arquivados ou deletados conforme política de retenção"
    criticidade: "ALTA"
    implementacao:
      backend: true
      frontend: false
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "retencao_dados"
      mensagem_erro: null
      http_code: null

  - id: "RN-RF103-007"
    titulo: "Multi-tenancy Obrigatória - ClienteId em Todos os Filtros"
    descricao: "Todos os relatórios devem filtrar obrigatoriamente por ClienteId do usuário autenticado. Nenhum relatório pode retornar dados de múltiplos clientes"
    criticidade: "CRÍTICA"
    implementacao:
      backend: true
      frontend: false
      validacao_api: true
      validacao_ui: false
    validacao:
      tipo: "multi_tenancy"
      mensagem_erro: "Acesso negado. Violação de isolamento de dados"
      http_code: 403

  - id: "RN-RF103-008"
    titulo: "Export Excel com Aba de Resumo"
    descricao: "Exports em Excel devem ter múltiplas abas: primeira contém resumo executivo (KPIs principais), abas subsequentes contêm dados detalhados por tipo"
    criticidade: "MÉDIA"
    implementacao:
      backend: true
      frontend: false
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "formato_export"
      mensagem_erro: null
      http_code: null

  - id: "RN-RF103-009"
    titulo: "Relatórios >100k Registros Processados em Background"
    descricao: "Se um relatório gerar >100.000 registros após agregação, deve ser processado assincronamente via fila com notificação ao usuário"
    criticidade: "ALTA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "processamento_assincrono"
      mensagem_erro: "Relatório enfileirado para processamento. Você receberá notificação quando estiver pronto"
      http_code: 202

  - id: "RN-RF103-010"
    titulo: "Auditoria de Acesso a Relatórios"
    descricao: "Cada acesso a relatório de volumetria deve ser registrado em log de auditoria com: usuário, timestamp, tipo de relatório, parâmetros, resultado"
    criticidade: "CRÍTICA"
    implementacao:
      backend: true
      frontend: false
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "auditoria"
      mensagem_erro: null
      http_code: null

# ==============================================================================
# PERMISSÕES RBAC
# ==============================================================================

permissoes_rbac:
  - permission_code: "relatorio.volumetria.read"
    descricao: "Visualizar relatórios de volumetria"
    roles_autorizadas:
      - "Gestor"
      - "Analista"
      - "Admin"
      - "Diretoria"
    endpoint: "GET /api/volumetria/*"

  - permission_code: "relatorio.volumetria.export"
    descricao: "Exportar relatórios (Excel, PDF, CSV)"
    roles_autorizadas:
      - "Gestor"
      - "Admin"
      - "Diretoria"
    endpoint: "POST /api/volumetria/export/*"

  - permission_code: "relatorio.volumetria.comparativo"
    descricao: "Gerar comparativos temporais"
    roles_autorizadas:
      - "Analista"
      - "Admin"
      - "Diretoria"
    endpoint: "GET /api/volumetria/comparativo"

  - permission_code: "relatorio.volumetria.tendencia"
    descricao: "Visualizar análise de tendências"
    roles_autorizadas:
      - "Analista"
      - "Admin"
      - "Diretoria"
    endpoint: "GET /api/volumetria/tendencia"

  - permission_code: "relatorio.volumetria.top10"
    descricao: "Visualizar ranking top-10"
    roles_autorizadas:
      - "Gestor"
      - "Analista"
      - "Admin"
      - "Diretoria"
    endpoint: "GET /api/volumetria/top10/{tipo}"

# ==============================================================================
# API ENDPOINTS
# ==============================================================================

endpoints:
  - method: "GET"
    route: "/api/volumetria"
    descricao: "Listar tipos de volumetria disponíveis"
    autenticacao: true
    authorization_policy: "relatorio.volumetria.read"
    request_dto: null
    response_dto: "List<TipoVolumetriaDto>"

  - method: "GET"
    route: "/api/volumetria/chamados"
    descricao: "Obter volumetria de chamados"
    autenticacao: true
    authorization_policy: "relatorio.volumetria.read"
    request_dto: "GetVolumetriaChamadosQuery"
    response_dto: "VolumetriaChamadosDto"

  - method: "GET"
    route: "/api/volumetria/ativos"
    descricao: "Obter volumetria de ativos"
    autenticacao: true
    authorization_policy: "relatorio.volumetria.read"
    request_dto: "GetVolumetriaAtivosQuery"
    response_dto: "VolumetriaAtivosDto"

  - method: "GET"
    route: "/api/volumetria/usuarios"
    descricao: "Obter volumetria de usuários"
    autenticacao: true
    authorization_policy: "relatorio.volumetria.read"
    request_dto: "GetVolumetriaUsuariosQuery"
    response_dto: "VolumetriaUsuariosDto"

  - method: "GET"
    route: "/api/volumetria/contratos"
    descricao: "Obter volumetria de contratos"
    autenticacao: true
    authorization_policy: "relatorio.volumetria.read"
    request_dto: "GetVolumetriaContratosQuery"
    response_dto: "VolumetriaContratosDto"

  - method: "GET"
    route: "/api/volumetria/consumo"
    descricao: "Obter volumetria de consumo"
    autenticacao: true
    authorization_policy: "relatorio.volumetria.read"
    request_dto: "GetVolumetriaConsumoQuery"
    response_dto: "VolumetriaConsumoDto"

  - method: "GET"
    route: "/api/volumetria/tendencia"
    descricao: "Análise de tendência com média móvel 7 dias"
    autenticacao: true
    authorization_policy: "relatorio.volumetria.tendencia"
    request_dto: "GetTendenciaQuery"
    response_dto: "List<TendenciaDto>"

  - method: "GET"
    route: "/api/volumetria/comparativo"
    descricao: "Comparativo mês vs mês ou ano vs ano"
    autenticacao: true
    authorization_policy: "relatorio.volumetria.comparativo"
    request_dto: "GetComparativoTemporalQuery"
    response_dto: "ComparativoTemporalDto"

  - method: "GET"
    route: "/api/volumetria/top10/{tipo}"
    descricao: "Top 10 por tipo (filial, depto, centro custo, responsável)"
    autenticacao: true
    authorization_policy: "relatorio.volumetria.top10"
    request_dto: "GetTop10Query"
    response_dto: "List<Top10Dto>"

  - method: "GET"
    route: "/api/volumetria/por-dimensao/{dimensao}"
    descricao: "Volumetria agregada por dimensão customizada"
    autenticacao: true
    authorization_policy: "relatorio.volumetria.read"
    request_dto: "GetVolumetriaPorDimensaoQuery"
    response_dto: "VolumetriaDimensaoDto"

  - method: "POST"
    route: "/api/volumetria/export/excel"
    descricao: "Exportar relatório em Excel"
    autenticacao: true
    authorization_policy: "relatorio.volumetria.export"
    request_dto: "ExportVolumetriaExcelCommand"
    response_dto: "FileContentResult | JobId (se >100k)"

  - method: "POST"
    route: "/api/volumetria/export/csv"
    descricao: "Exportar relatório em CSV"
    autenticacao: true
    authorization_policy: "relatorio.volumetria.export"
    request_dto: "ExportVolumetriaCsvCommand"
    response_dto: "FileContentResult | JobId (se >100k)"

  - method: "POST"
    route: "/api/volumetria/export/pdf"
    descricao: "Exportar relatório em PDF"
    autenticacao: true
    authorization_policy: "relatorio.volumetria.export"
    request_dto: "ExportVolumetriaPdfCommand"
    response_dto: "FileContentResult | JobId (se >100k)"

  - method: "GET"
    route: "/api/volumetria/consolidacao/status"
    descricao: "Status da consolidação automática"
    autenticacao: true
    authorization_policy: "relatorio.volumetria.read"
    request_dto: null
    response_dto: "StatusConsolidacaoDto"

# ==============================================================================
# KPIs E MÉTRICAS
# ==============================================================================

kpis:
  - nome: "Performance Geração Relatório"
    descricao: "Tempo de resposta da API de volumetria"
    meta: "< 2 segundos"
    log_obrigatorio: true

  - nome: "Taxa de Sucesso Consolidação"
    descricao: "Percentual de consolidações bem-sucedidas vs tentativas"
    meta: ">= 99.9%"
    log_obrigatorio: true

  - nome: "Tempo Consolidação Diária"
    descricao: "Tempo total do job Hangfire para todos clientes"
    meta: "< 5 minutos"
    log_obrigatorio: true

  - nome: "Acurácia Volumetria"
    descricao: "COUNT agregado vs count manual (amostra 1%)"
    meta: "100%"
    log_obrigatorio: true

  - nome: "Disponibilidade do Módulo"
    descricao: "Uptime do endpoint /api/volumetria"
    meta: ">= 99.95%"
    log_obrigatorio: true

  - nome: "Taxa Export Sucesso"
    descricao: "Percentual de exports bem-sucedidos vs tentativas"
    meta: ">= 98%"
    log_obrigatorio: true

  - nome: "Uso de Cache"
    descricao: "Percentual de requests servidas do cache vs banco"
    meta: "> 80%"
    log_obrigatorio: true

# ==============================================================================
# ALERTAS CRÍTICOS
# ==============================================================================

alertas:
  - evento: "Consolidação Falhou"
    threshold: "Job não completou às 5:30 AM"
    severidade: "CRÍTICA"
    canal_notificacao:
      - "email"
      - "slack"

  - evento: "Performance Degradada"
    threshold: "Tempo resposta > 5 segundos"
    severidade: "ALTA"
    canal_notificacao:
      - "email"
      - "slack"

  - evento: "Exportação Travou"
    threshold: "Job export pendente > 30 minutos"
    severidade: "ALTA"
    canal_notificacao:
      - "email"

  - evento: "Taxa Erro Alta"
    threshold: "> 1% requests retornam 5xx"
    severidade: "CRÍTICA"
    canal_notificacao:
      - "email"
      - "slack"
      - "sms"

  - evento: "Espaço Disco Cheio"
    threshold: "Storage < 20% livre"
    severidade: "ALTA"
    canal_notificacao:
      - "email"

  - evento: "Cache Inválido"
    threshold: "Hit rate Redis < 50%"
    severidade: "MÉDIA"
    canal_notificacao:
      - "email"

# ==============================================================================
# METADADOS
# ==============================================================================

metadados:
  total_regras_negocio: 10
  total_endpoints_api: 14
  total_permissoes_rbac: 5
  total_integracoes_obrigatorias: 4
  total_kpis: 7
  total_alertas: 6
  linhas_documentacao:
    documentacao_md: 430
    documentacao_yaml: 385
