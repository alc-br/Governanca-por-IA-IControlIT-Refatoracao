# RF110 - Cache Distribuído e Otimização de Performance

**Versão:** 2.0
**Data:** 2025-12-31
**Epic:** EPIC008-SD-Service-Desk
**Fase:** Fase-5-Service-Desk
**Contrato de Migração:** CONTRATO-RF-PARA-RL (v1.0 → v2.0)

---

## 1. Visão Geral

### 1.1. Objetivo

Implementar sistema de cache distribuído com Redis para otimizar performance da aplicação IControlIT, reduzindo latência de consultas recorrentes, minimizando carga no banco de dados e garantindo escalabilidade horizontal com invalidação inteligente de cache.

### 1.2. Escopo

- Cache distribuído com Redis (StackExchange.Redis)
- Serialização eficiente com System.Text.Json Source Generators
- Compressão automática de payloads grandes com Gzip
- Estratégias de cache (Cache-Aside, Write-Through, Cache-Behind)
- Invalidação inteligente (por chave, por padrão, por tag)
- Multi-tenancy com isolamento por ClienteId
- Monitoramento de hit rate, latência e uso de memória
- Gestão de TTL (Time-To-Live) configurável por entidade
- Fallback automático para banco em caso de falha do Redis

### 1.3. Benefícios Esperados

- Redução de 70% no tempo de resposta de consultas frequentes
- Diminuição de 60% na carga do banco de dados
- Suporte a 10.000+ requisições simultâneas
- Economia de custos de infraestrutura de banco
- Melhoria na experiência do usuário (latência < 100ms)

---

## 2. Funcionalidades

### 2.1. Cache de Entidades Principais

Cachear automaticamente entidades de leitura frequente:
- Empresas, Filiais, Centros de Custo
- Usuários, Perfis, Permissões
- Configurações do sistema
- Domínios configuráveis (Tipos, Status)
- Feature Flags ativos

### 2.2. Estratégias de Cache

**Cache-Aside (Lazy Loading):**
- Aplicação consulta cache primeiro
- Se não encontrar (cache miss), busca no banco
- Armazena resultado no cache para próximas consultas
- Uso: Entidades de leitura frequente e escrita rara

**Write-Through:**
- Escrita simultânea em cache e banco
- Garante consistência imediata
- Uso: Dados críticos que não podem estar desatualizados

**Cache-Behind (Write-Behind):**
- Escrita assíncrona no banco após atualizar cache
- Melhora performance de escrita
- Uso: Logs, auditoria, métricas

### 2.3. Invalidação Inteligente

**Por Chave Exata:**
- Invalidar cache de entidade específica após UPDATE/DELETE
- Exemplo: Após editar Empresa ID=5, invalidar `empresa:5`

**Por Padrão (Pattern Matching):**
- Invalidar todas as chaves que correspondem a um padrão
- Exemplo: Após alterar Filial, invalidar `filial:*` e `empresa:*:filiais`

**Por Tags:**
- Agrupar chaves relacionadas por tags
- Exemplo: Tag `cliente:10` agrupa todas as entidades do ClienteId=10
- Invalidar todas as chaves da tag ao trocar de contexto

### 2.4. Compressão Automática

- Detectar payloads > 1KB
- Comprimir com Gzip antes de armazenar
- Descomprimir automaticamente ao recuperar
- Economia de 60-80% de memória Redis

### 2.5. Monitoramento e Alertas

**Métricas Coletadas:**
- Hit Rate (% de requisições atendidas pelo cache)
- Miss Rate (% de requisições que consultaram o banco)
- Latência média de leitura/escrita
- Uso de memória do Redis
- Número de chaves ativas
- Taxa de invalidação

**Alertas Automáticos:**
- Hit Rate < 70% → Investigar padrão de acesso
- Latência > 200ms → Verificar rede/Redis
- Uso de memória > 80% → Expandir capacidade ou limpar chaves antigas

### 2.6. Fallback e Resiliência

- Se Redis estiver indisponível, consultar banco diretamente
- Registrar evento de fallback para monitoramento
- Reconectar automaticamente quando Redis voltar
- Não bloquear operações críticas por falha de cache

---

## 3. Regras de Negócio

### RN-PER-110-01: Isolamento Multi-Tenancy

Toda chave de cache DEVE incluir o ClienteId como prefixo para garantir isolamento entre clientes.

**Formato Obrigatório:** `cliente:{ClienteId}:{entidade}:{id}`

**Exemplo:** `cliente:10:empresa:5` (Empresa ID=5 do Cliente ID=10)

**Validação:**
- Verificar ClienteId ao gravar/ler cache
- Rejeitar operações sem ClienteId válido
- Logar tentativas de acesso cruzado

---

### RN-PER-110-02: TTL Configurável por Entidade

Cada tipo de entidade possui Time-To-Live (TTL) específico, configurável via appsettings.json.

**TTLs Padrão:**
- Empresas, Filiais: 24 horas
- Usuários, Perfis: 1 hora
- Permissões: 30 minutos
- Feature Flags: 5 minutos
- Domínios: 12 horas

Após expirar, o cache deve ser revalidado na próxima consulta.

---

### RN-PER-110-03: Invalidação Automática em Writes

Toda operação de CREATE, UPDATE ou DELETE DEVE invalidar o cache relacionado imediatamente.

**Exemplos:**
- UPDATE Empresa ID=5 → Invalidar `cliente:X:empresa:5`
- DELETE Filial ID=20 → Invalidar `cliente:X:filial:20` e `cliente:X:empresa:Y:filiais`
- CREATE Usuario → Invalidar `cliente:X:usuarios:lista`

---

### RN-PER-110-04: Compressão Condicional

Payloads com tamanho superior a 1KB DEVEM ser comprimidos com Gzip antes de armazenar no Redis.

**Regra:**
- Serializar objeto para JSON
- Calcular tamanho em bytes
- Se > 1024 bytes, comprimir com Gzip
- Armazenar flag `compressed:true` na chave de metadados

---

### RN-PER-110-05: Limite de Tamanho de Payload

Payloads maiores que 5MB NÃO DEVEM ser cacheados, mesmo após compressão.

**Regra:**
- Calcular tamanho após compressão
- Se > 5MB, logar warning e buscar direto do banco
- Sugerir paginação ou filtragem para reduzir payload

---

### RN-PER-110-06: Hit Rate Mínimo Esperado de 80%

O sistema DEVE calcular e monitorar o Hit Rate a cada 5 minutos.

**Cálculo:** `Hit Rate = (Total Hits / (Total Hits + Total Misses)) * 100`

**Meta:** Hit Rate ≥ 80% para consultas de entidades principais.

**Ação:** Se Hit Rate < 70% por 30 minutos, acionar alerta para revisão de TTLs.

---

### RN-PER-110-07: Fallback Transparente

Se Redis estiver indisponível, a aplicação DEVE continuar funcionando consultando o banco de dados diretamente.

**Regra:**
- Detectar falha de conexão com Redis
- Logar evento de fallback
- Retornar dados do banco sem cache
- Não bloquear operação crítica

---

### RN-PER-110-08: Invalidação por Relacionamento

Ao alterar entidade pai, invalidar cache de entidades filhas relacionadas.

**Exemplos:**
- UPDATE Empresa → Invalidar cache de Filiais, Centros de Custo, Usuários dessa empresa
- DELETE Centro de Custo → Invalidar cache de Departamentos vinculados

---

### RN-PER-110-09: Cache de Listas Paginadas

Listas paginadas DEVEM ter cache separado por página e filtros aplicados.

**Formato de Chave:** `cliente:{ClienteId}:{entidade}:lista:page={page}&size={size}&filter={hash}`

**Exemplo:** `cliente:10:usuario:lista:page=1&size=20&filter=abc123`

---

### RN-PER-110-10: Auditoria de Cache

Operações de cache (hit, miss, invalidação) NÃO são auditadas em banco para evitar overhead.

**Exceção:** Eventos críticos (fallback, erro, timeout) DEVEM ser logados para análise posterior.

---

## 4. Integração com Central de Funcionalidades

### 4.1. Registro na Central

**Código da Funcionalidade:** `PER.CACHE`
**Nome:** Cache Distribuído e Performance
**Módulo:** Performance
**Tipo:** Sistema

### 4.2. Funcionalidades Filhas

| Código | Nome | Permissão Requerida |
|--------|------|---------------------|
| PER.CACHE.VIEW | Visualizar Métricas de Cache | `PER.CACHE.VIEW_METRICS` |
| PER.CACHE.CLEAR | Limpar Cache Manualmente | `PER.CACHE.CLEAR_CACHE` |
| PER.CACHE.CONFIG | Configurar TTLs | `PER.CACHE.CONFIGURE_TTL` |
| PER.CACHE.MONITOR | Monitorar Health | `PER.CACHE.VIEW_HEALTH` |

---

## 5. Endpoints da API

### 5.1. Visualizar Métricas de Cache

**Endpoint:** `GET /api/performance/cache/metrics`
**Autenticação:** Obrigatória
**Permissão:** `PER.CACHE.VIEW_METRICS`

**Parâmetros de Query:**
- `period` (opcional): Período de análise (`1h`, `24h`, `7d`, `30d`)

**Resposta (200 OK):**
```json
{
  "hitRate": 85.7,
  "missRate": 14.3,
  "totalHits": 152340,
  "totalMisses": 25890,
  "avgLatencyMs": 12.5,
  "memoryUsageMB": 450.2,
  "totalKeys": 8952,
  "period": "24h"
}
```

---

### 5.2. Limpar Cache

**Endpoint:** `DELETE /api/performance/cache`
**Autenticação:** Obrigatória
**Permissão:** `PER.CACHE.CLEAR_CACHE`

**Corpo da Requisição:**
```json
{
  "scope": "all|client|entity|key",
  "clienteId": 10,
  "entity": "empresa",
  "key": "cliente:10:empresa:5"
}
```

**Resposta (200 OK):**
```json
{
  "message": "Cache limpo com sucesso",
  "keysRemoved": 245,
  "scope": "client",
  "clienteId": 10
}
```

---

### 5.3. Configurar TTL

**Endpoint:** `PUT /api/performance/cache/ttl`
**Autenticação:** Obrigatória
**Permissão:** `PER.CACHE.CONFIGURE_TTL`

**Corpo da Requisição:**
```json
{
  "entity": "empresa",
  "ttlSeconds": 86400
}
```

**Resposta (200 OK):**
```json
{
  "message": "TTL atualizado com sucesso",
  "entity": "empresa",
  "previousTtl": 3600,
  "newTtl": 86400
}
```

---

### 5.4. Verificar Health do Redis

**Endpoint:** `GET /api/performance/cache/health`
**Autenticação:** Obrigatória
**Permissão:** `PER.CACHE.VIEW_HEALTH`

**Resposta (200 OK):**
```json
{
  "status": "healthy",
  "connected": true,
  "latencyMs": 8.3,
  "memoryUsedMB": 450.2,
  "memoryMaxMB": 2048,
  "uptime": "15d 8h 23m"
}
```

---

## 6. Matriz de Permissões RBAC

| Perfil | VIEW_METRICS | CLEAR_CACHE | CONFIGURE_TTL | VIEW_HEALTH |
|--------|--------------|-------------|---------------|-------------|
| Developer | ✅ | ✅ | ✅ | ✅ |
| Super Admin | ✅ | ✅ | ✅ | ✅ |
| Admin | ✅ | ✅ | ❌ | ✅ |
| Suporte | ✅ | ❌ | ❌ | ✅ |
| Usuario Final | ❌ | ❌ | ❌ | ❌ |

---

## 7. Internacionalização (i18n)

### 7.1. Chaves de Tradução

**Namespace:** `performance.cache`

| Chave | pt-BR | en | es |
|-------|-------|----|----|
| `title` | Cache Distribuído | Distributed Cache | Caché Distribuido |
| `metrics.hitRate` | Taxa de Acerto | Hit Rate | Tasa de Acierto |
| `metrics.missRate` | Taxa de Erro | Miss Rate | Tasa de Error |
| `metrics.avgLatency` | Latência Média | Average Latency | Latencia Promedio |
| `actions.clearCache` | Limpar Cache | Clear Cache | Limpiar Caché |
| `actions.configureTtl` | Configurar TTL | Configure TTL | Configurar TTL |
| `alerts.lowHitRate` | Taxa de acerto baixa detectada | Low hit rate detected | Tasa de acierto baja detectada |
| `alerts.highMemory` | Uso de memória acima de 80% | Memory usage above 80% | Uso de memoria superior al 80% |
| `errors.redisFailed` | Falha ao conectar com Redis | Failed to connect to Redis | Error al conectar con Redis |

---

## 8. Modelo de Dados

O cache distribuído NÃO utiliza tabelas tradicionais no banco de dados. Todas as informações são armazenadas em memória no Redis.

### 8.1. Estrutura de Chaves Redis

**Formato Padrão:** `cliente:{ClienteId}:{entidade}:{id}`

**Exemplos:**
- `cliente:10:empresa:5`
- `cliente:10:usuario:123`
- `cliente:10:filial:lista:page=1&size=20`

### 8.2. Metadados de Cache

Para cada chave, armazenar metadados em hash separado:

**Chave de Metadados:** `{chave}:meta`

**Campos:**
- `compressed`: true/false
- `createdAt`: timestamp
- `expiresAt`: timestamp
- `size`: tamanho em bytes
- `version`: versão do payload

### 8.3. Tabela de Auditoria de Invalidação

**Tabela:** `CacheInvalidationAudits`

| Campo | Tipo | Descrição |
|-------|------|-----------|
| Id | GUID | PK |
| ClienteId | GUID | FK para Cliente |
| Pattern | STRING | Padrão de chave invalidada |
| KeysInvalidated | INT | Quantidade de chaves removidas |
| Reason | STRING | Motivo (RN ou evento) |
| TriggeredBy | STRING | UserId ou "SYSTEM" |
| Timestamp | DATETIME | Data/hora da invalidação |
| MemoryFreedBytes | LONG | Memória liberada (estimativa) |

---

## 9. Configurações do Sistema

### 9.1. appsettings.json

```json
{
  "Redis": {
    "ConnectionString": "localhost:6379",
    "InstanceName": "IControlIT:",
    "DefaultTTL": 3600,
    "EnableCompression": true,
    "CompressionThresholdBytes": 1024,
    "MaxPayloadSizeMB": 5,
    "EntityTTLs": {
      "Empresa": 86400,
      "Filial": 86400,
      "Usuario": 3600,
      "Perfil": 3600,
      "Permissao": 1800,
      "FeatureFlag": 300,
      "Dominio": 43200
    }
  },
  "CacheMonitoring": {
    "Enabled": true,
    "MetricsIntervalSeconds": 300,
    "MinHitRate": 70,
    "AlertOnLowHitRate": true,
    "AlertOnHighMemory": true,
    "MemoryThresholdPercent": 80
  }
}
```

---

## 10. Dependências Técnicas

### 10.1. Backend (.NET)

**Pacotes NuGet:**
- `StackExchange.Redis` (≥ 2.8.0)
- `Microsoft.Extensions.Caching.StackExchangeRedis`
- `System.Text.Json` (≥ 10.0.0)

**Infraestrutura:**
- Redis Server (≥ 7.0)
- Rede de baixa latência entre aplicação e Redis (< 5ms)

---

## 11. KPIs e Métricas

| Métrica | Meta | Medição |
|---------|------|---------|
| Hit Rate | ≥ 80% | % de requisições atendidas pelo cache |
| Latência Média | ≤ 50ms | Tempo médio de leitura do cache |
| Uso de Memória | ≤ 70% | % da memória Redis utilizada |
| Disponibilidade | ≥ 99.9% | Uptime do Redis |
| Taxa de Compressão | ≥ 60% | Redução de tamanho após Gzip |

---

## 12. Alertas Automáticos

| Alerta | Condição | Ação |
|--------|----------|------|
| Hit Rate Baixo | < 70% por 30min | Revisar TTLs e padrões de acesso |
| Memória Alta | > 80% | Expandir capacidade ou limpar chaves antigas |
| Redis Indisponível | Falha de conexão | Acionar fallback e notificar DevOps |
| Latência Alta | > 200ms | Verificar rede e carga do Redis |

---

## 13. Casos de Uso Relacionados

- **UC00-RF110:** Configurar Cache Distribuído
- **UC01-RF110:** Visualizar Métricas de Performance
- **UC02-RF110:** Limpar Cache Manualmente
- **UC03-RF110:** Configurar TTLs por Entidade
- **UC04-RF110:** Monitorar Health do Redis

---

## 14. Testes e Validação

### 14.1. Testes de Performance

- Carga de 10.000 requisições simultâneas
- Hit Rate ≥ 80%
- Latência média ≤ 50ms
- Uso de memória estável

### 14.2. Testes de Resiliência

- Simular queda do Redis → Fallback para banco
- Reconexão automática após Redis voltar
- Validar que operações críticas não são bloqueadas

### 14.3. Testes de Segurança

- Tentar acessar cache de outro ClienteId → Bloqueado
- Injetar payload malicioso → Rejeitado na deserialização
- Tentar alterar TTL sem permissão → HTTP 403

---

## 15. Impacto e Dependências

### 15.1. RFs Beneficiados

Todos os RFs que realizam consultas frequentes:
- **RF104:** Gestão de Domínios (cache de tipos e status)
- **RF043:** Gestão de Empresas (cache de empresas e filiais)
- **RF046:** Gestão de Usuários (cache de permissões)
- **RF048:** Feature Flags (cache de flags ativos)

### 15.2. Impacto na Infraestrutura

**Positivo:**
- Redução de carga no banco de dados (60%)
- Melhoria na latência de resposta (70%)
- Suporte a maior número de usuários simultâneos

**Requisitos:**
- Servidor Redis dedicado (mínimo 2GB RAM)
- Rede de baixa latência entre app e Redis

---

## 16. Segurança

### 16.1. Isolamento Multi-Tenancy

- Todo acesso ao cache valida ClienteId
- Chaves sempre prefixadas com `cliente:{ClienteId}`
- Tentativas de acesso cruzado são logadas e bloqueadas

### 16.2. Proteção de Dados Sensíveis

- Dados sensíveis (senhas, tokens) NÃO são cacheados
- Payloads em cache são criptografados em trânsito (TLS)
- Redis protegido por autenticação (requirepass)

---

## 17. Observabilidade

### 17.1. Logs Estruturados

Registrar eventos críticos:
- Cache hit/miss (nível Debug)
- Invalidação de chaves (nível Information)
- Fallback para banco (nível Warning)
- Erro de conexão Redis (nível Error)

### 17.2. Métricas de Monitoramento

Enviar para Application Insights:
- Hit Rate
- Miss Rate
- Latência de leitura/escrita
- Uso de memória
- Número de chaves ativas

---

## 18. Roadmap e Próximas Versões

### Versão 1.0 (Atual)
- Cache básico com Redis
- Compressão Gzip
- Invalidação por chave exata
- Fallback para banco

### Versão 1.1 (Próximo Release)
- Cache distribuído em cluster Redis
- Invalidação por tags
- Warm-up automático de cache após deploy

### Versão 2.0 (Futuro)
- Cache híbrido (Redis + memória local)
- Machine Learning para prever padrões de acesso
- Cache proativo (pré-carregar dados antes da requisição)

---

**Documento gerado conforme governança v2.0**
**Contrato aplicado:** CONTRATO-RF-PARA-RL
**Data de migração:** 2025-12-31
