# Referência ao Legado - RF049 - Gestão de Políticas de Consumidores
# Versão: 2.0
# Data: 2025-12-30
# Autor: Agência ALC - alc.dev.br

rf_id: RF049
titulo: "Gestão de Políticas de Consumidores"

legado:
  sistema: "IControlIT v1 (VB.NET + ASP.NET Web Forms)"
  versao: "1.x"
  arquitetura: "Monolítica WebForms"
  banco_dados: "SQL Server"
  multi_tenant: false  # Parcial (campo IdEmpresa em algumas tabelas)
  auditoria: "none"

# SEÇÃO CRÍTICA: Referencias ao Legado com Destino Obrigatório
# IMPORTANTE: Este RF é 100% NOVO - não há funcionalidade equivalente no legado
referencias:
  - id: "LEG-RF049-001"
    tipo: "processo_manual"
    nome: "Revisão Manual Mensal de Faturas"
    caminho: "Processo operacional (não implementado em código)"
    descricao: |
      Gestor recebia relatório mensal de faturas e identificava manualmente
      consumidores que excederam limites do contrato. Processo completamente
      manual, sem automação ou alertas proativos.
    destino: "substituido"
    justificativa: |
      Processo manual substituído por monitoramento em tempo real com alertas
      proativos em múltiplos limiares (50%, 80%, 100%). Motor de políticas
      avalia consumo continuamente ao invés de esperar fechamento de fatura.
    documentacao_item_relacionado: "RN-RF049-04"
    uc_relacionado: null
    complexidade: "alta"
    risco_migracao: "baixo"
    prioridade: 1

  - id: "LEG-RF049-002"
    tipo: "campo_banco"
    nome: "Contrato.ValorLimite"
    caminho: "Tabela Contrato, campo ValorLimite DECIMAL"
    descricao: |
      Campo que armazenava limite monetário mensal único por contrato.
      Aplicava-se a TODO tipo de consumo (dados + voz + SMS combinados).
      Sem diferenciação de tipos, sem histórico de mudanças.
    destino: "substituido"
    justificativa: |
      Campo único substituído por sistema completo de políticas com 8 tipos
      diferentes (monetário, dados, voz, SMS, horário, destino, roaming, tipo
      de serviço). Nova estrutura permite múltiplas políticas por consumidor,
      cada uma com tipo específico.
    documentacao_item_relacionado: "RN-RF049-01"
    uc_relacionado: "UC01"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF049-003"
    tipo: "processo_manual"
    nome: "Bloqueio Manual de Consumidor"
    caminho: "Tela Consumidores.aspx, método AlterarStatus()"
    descricao: |
      Operador alterava manualmente status do consumidor para 'Bloqueado'
      através de dropdown. Sem auditoria de quem bloqueou, quando e por quê.
      Sem integração com políticas ou limites.
    destino: "substituido"
    justificativa: |
      Bloqueio manual substituído por bloqueio automático baseado em políticas.
      Sistema detecta violação e bloqueia automaticamente ao atingir 100% do
      limite. Histórico imutável registra quem, quando, por que e qual política
      foi violada.
    documentacao_item_relacionado: "RN-RF049-05"
    uc_relacionado: null
    complexidade: "alta"
    risco_migracao: "baixo"
    prioridade: 1

  - id: "LEG-RF049-004"
    tipo: "regra_negocio"
    nome: "Limite Igual para Todos os Consumidores"
    caminho: "ic1_legado/IControlIT/Contratos.aspx.vb"
    descricao: |
      Todos os consumidores de um mesmo contrato tinham exatamente o mesmo
      limite, independente de cargo (executivo vs estagiário). Sem
      diferenciação por perfil ou hierarquia.
    destino: "substituido"
    justificativa: |
      Regra rígida substituída por aplicação automática de políticas por
      perfil (Executivo, Gerente, Colaborador, Estagiário, Externo). Cada
      perfil pode ter conjunto diferente de políticas. Mudança de perfil
      aplica novas políticas automaticamente.
    documentacao_item_relacionado: "RN-RF049-02"
    uc_relacionado: null
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF049-005"
    tipo: "ausencia_funcionalidade"
    nome: "Sem Histórico de Mudanças de Limite"
    caminho: "Tabelas Contrato/Consumidor (sem campos de auditoria)"
    descricao: |
      Sistema legado não registrava quando limites eram alterados, quem
      alterou ou motivo da alteração. Violação de LGPD. Impossível rastrear
      decisões históricas.
    destino: "substituido"
    justificativa: |
      Ausência substituída por histórico imutável obrigatório com retenção
      de 7 anos (LGPD). Tabela PoliticaConsumidorHistorico registra TODA
      aplicação/remoção de política com usuário, data/hora, motivo e vigência.
    documentacao_item_relacionado: "RN-RF049-07"
    uc_relacionado: null
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 1

  - id: "LEG-RF049-006"
    tipo: "ausencia_funcionalidade"
    nome: "Sem Alertas Proativos"
    caminho: "N/A (funcionalidade inexistente)"
    descricao: |
      Sistema legado não enviava alertas antes de atingir limite. Gestor
      descobria excesso apenas após fatura fechada (30-60 dias de atraso).
      Sem prevenção, apenas reação.
    destino: "substituido"
    justificativa: |
      Ausência substituída por sistema de alertas proativos em múltiplos
      limiares (50%, 80%, 100%). Notificações enviadas via e-mail, SMS e
      in-app para consumidor, gestor e financeiro. Permite ação preventiva.
    documentacao_item_relacionado: "RN-RF049-04"
    uc_relacionado: null
    complexidade: "alta"
    risco_migracao: "baixo"
    prioridade: 1

  - id: "LEG-RF049-007"
    tipo: "ausencia_funcionalidade"
    nome: "Sem Simulação de Impacto"
    caminho: "N/A (funcionalidade inexistente)"
    descricao: |
      Sistema legado não permitia simular impacto de mudança de limite antes
      de aplicar. Gestor aplicava e descobria impacto apenas depois (muitas
      vezes causando bloqueios indesejados).
    destino: "substituido"
    justificativa: |
      Ausência substituída por simulador de impacto que analisa consumo
      histórico e prevê: quantos consumidores seriam bloqueados, quando
      seriam bloqueados, estimativa de economia. Preview obrigatório antes
      de aplicar políticas em lote.
    documentacao_item_relacionado: "RN-RF049-10"
    uc_relacionado: null
    complexidade: "alta"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF049-008"
    tipo: "ausencia_funcionalidade"
    nome: "Sem Templates de Políticas"
    caminho: "N/A (funcionalidade inexistente)"
    descricao: |
      Cada limite era configurado individualmente, consumidor por consumidor.
      Sem templates ou padrões reutilizáveis. Trabalho manual repetitivo.
    destino: "substituido"
    justificativa: |
      Ausência substituída por sistema de templates pré-configurados
      (Executivo, Gerente, Colaborador, Estagiário). Administradores podem
      criar templates customizados. Templates podem ser clonados e adaptados.
    documentacao_item_relacionado: "RN-RF049-11"
    uc_relacionado: "UC01"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF049-009"
    tipo: "ausencia_funcionalidade"
    nome: "Sem Dashboard de Conformidade"
    caminho: "N/A (funcionalidade inexistente)"
    descricao: |
      Sistema legado não tinha visão consolidada de conformidade. Gestor
      precisava consultar consumidor por consumidor para verificar status.
      Sem indicadores visuais, sem top violadores.
    destino: "substituido"
    justificativa: |
      Ausência substituída por dashboard em tempo real com: total de
      consumidores por status de conformidade (Conforme/Aviso/Crítico/Violação),
      gráfico temporal de violações, lista de consumidores críticos (>80%),
      top 10 violadores. Atualização via SignalR.
    documentacao_item_relacionado: "RN-RF049-13"
    uc_relacionado: null
    complexidade: "alta"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF049-010"
    tipo: "ausencia_funcionalidade"
    nome: "Sem Cálculo de Economia"
    caminho: "N/A (funcionalidade inexistente)"
    descricao: |
      Sistema legado não calculava economia gerada por limites. Impossível
      demonstrar ROI de políticas de contenção de custos.
    destino: "substituido"
    justificativa: |
      Ausência substituída por cálculo automático de economia (Consumo Real
      - Consumo Estimado sem Política). Baseline: média dos 3 meses anteriores.
      Relatório mensal de economia enviado para gestores. Economia exibida no
      dashboard.
    documentacao_item_relacionado: "RN-RF049-14"
    uc_relacionado: null
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 3

# Telas Legadas
telas:
  - id: "LEG-RF049-TELA-001"
    nome: "Contratos.aspx"
    caminho: "ic1_legado/IControlIT/Contratos.aspx"
    responsabilidade: "Gestão de contratos com campo ValorLimite único"
    campos:
      - nome: "ValorLimite"
        tipo: "TextBox (decimal)"
        obrigatorio: false
        validacao: "Apenas valor numérico positivo"
    comportamentos_implicitos:
      - "Limite aplicava-se a todos os tipos de consumo (dados + voz + SMS)"
      - "Alteração de limite não gerava histórico ou auditoria"
      - "Sem validação de impacto ao alterar limite"

  - id: "LEG-RF049-TELA-002"
    nome: "Consumidores.aspx"
    caminho: "ic1_legado/IControlIT/Consumidores.aspx"
    responsabilidade: "Gestão de consumidores com alteração manual de status"
    campos:
      - nome: "Status"
        tipo: "DropDownList"
        obrigatorio: true
        validacao: "Ativo | Bloqueado | Inativo"
    comportamentos_implicitos:
      - "Bloqueio era global (todos os serviços), sem bloqueio parcial"
      - "Sem auditoria de quem bloqueou ou motivo"
      - "Sem integração com políticas ou limites"

# WebServices Legados
servicos:
  - id: "LEG-RF049-SVC-001"
    nome: "N/A"
    localizacao: "N/A"
    responsabilidade: "Não há webservices relacionados a políticas no legado"
    notas: "Funcionalidade completamente inexistente no legado"

# Tabelas Legadas com Problemas
tabelas:
  - nome: "Contrato"
    finalidade: "Armazenar dados de contratos incluindo limite único"
    problemas:
      - "Apenas um campo ValorLimite (sem tipos diferentes)"
      - "Sem histórico de alterações de limite"
      - "Sem auditoria de quem alterou"
      - "Sem campos de multi-tenancy"

  - nome: "Consumidor"
    finalidade: "Armazenar dados de consumidores incluindo status"
    problemas:
      - "Status manual (sem automação de bloqueio)"
      - "Sem histórico de mudanças de status"
      - "Sem rastreamento de motivo de bloqueio"
      - "Sem vínculo com políticas"

# Regras de Negócio Implícitas (não documentadas no legado)
regras_implicitas:
  - id: "RL-RN-001"
    descricao: |
      Limite único por contrato aplicado a todo tipo de consumo. Sem
      diferenciação entre dados, voz e SMS. Todos os consumidores de um
      mesmo contrato tinham exatamente o mesmo limite.
    fonte: "Tabela Contrato.ValorLimite + análise de código Contratos.aspx.vb"

  - id: "RL-RN-002"
    descricao: |
      Alerta manual mensal. Gestor recebia relatório de faturas fechadas e
      identificava manualmente consumidores que excederam limite. Atraso de
      30-60 dias entre consumo e alerta.
    fonte: "Processo operacional documentado em treinamento de usuários"

  - id: "RL-RN-003"
    descricao: |
      Bloqueio manual via dropdown. Operador alterava status para 'Bloqueado'
      manualmente. Sem auditoria de quem bloqueou, quando ou por quê.
    fonte: "Tela Consumidores.aspx, método AlterarStatus()"

  - id: "RL-RN-004"
    descricao: |
      Sem diferenciação de perfil. Executivo e estagiário tinham exatamente
      o mesmo limite se estivessem no mesmo contrato. Sem flexibilidade para
      hierarquia organizacional.
    fonte: "Análise de dados históricos + código de contratos"

  - id: "RL-RN-005"
    descricao: |
      Sem histórico de mudanças. Sistema não registrava alterações de limites
      ou bloqueios. Violação de LGPD. Impossível rastrear decisões históricas.
    fonte: "Análise de tabelas (sem campos de auditoria ou histórico)"

# Gap Analysis (Legado x Moderno)
gap_analysis:
  - item: "Motor de Políticas"
    existe_legado: false
    existe_moderno: true
    notas: "Funcionalidade 100% nova. Legado não tinha avaliação em tempo real."

  - item: "Alertas Proativos"
    existe_legado: false
    existe_moderno: true
    notas: "Legado tinha apenas alertas reativos (30-60 dias de atraso)."

  - item: "Bloqueio Automático"
    existe_legado: false
    existe_moderno: true
    notas: "Legado tinha apenas bloqueio manual via dropdown."

  - item: "Histórico de Aplicações"
    existe_legado: false
    existe_moderno: true
    notas: "Legado não registrava histórico (violação LGPD)."

  - item: "Dashboard de Conformidade"
    existe_legado: false
    existe_moderno: true
    notas: "Legado não tinha visão consolidada ou indicadores visuais."

  - item: "Simulador de Impacto"
    existe_legado: false
    existe_moderno: true
    notas: "Legado não permitia prever impacto antes de aplicar."

  - item: "Templates de Políticas"
    existe_legado: false
    existe_moderno: true
    notas: "Legado exigia configuração individual de cada limite."

  - item: "Múltiplos Tipos de Política"
    existe_legado: false
    existe_moderno: true
    notas: "Legado tinha apenas limite monetário total (dados+voz+SMS)."

  - item: "Aplicação por Perfil"
    existe_legado: false
    existe_moderno: true
    notas: "Legado não diferenciava executivo de estagiário."

  - item: "Processamento em Lote"
    existe_legado: false
    existe_moderno: true
    notas: "Legado exigia configuração manual um por um."

# Decisões de Modernização
decisoes_modernizacao:
  - decisao: "Desenvolvimento completo do zero (sem migração de código)"
    motivo: |
      Sistema legado não possui estrutura ou código reutilizável para
      políticas. Processo era 100% manual. Melhor desenvolver do zero
      seguindo Clean Architecture e CQRS do que tentar adaptar código legado.
    impacto: "alto"
    data: "2025-12-30"

  - decisao: "Motor de políticas com fail-open (permitir em caso de falha)"
    motivo: |
      Disponibilidade do sistema é prioritária. Melhor permitir temporariamente
      operação do que bloquear serviço crítico. Falha gera alerta para
      investigação.
    impacto: "medio"
    data: "2025-12-30"

  - decisao: "Histórico imutável separado (apenas inserts)"
    motivo: |
      Conformidade com LGPD exige rastreabilidade total. Tabela separada
      PoliticaConsumidorHistorico garante que nenhuma mudança histórica
      seja apagada ou alterada.
    impacto: "baixo"
    data: "2025-12-30"

  - decisao: "Alertas em 3 limiares (50%, 80%, 100%)"
    motivo: |
      Dar tempo para ação preventiva. Alerta em 50% permite ajuste antes de
      problema crítico. Alerta em 80% é avisourgente. 100% é bloqueio iminente.
    impacto: "medio"
    data: "2025-12-30"

  - decisao: "Processamento assíncrono em lote via Hangfire"
    motivo: |
      Aplicar política a milhares de consumidores não pode bloquear interface.
      Hangfire permite processamento em background com retry automático e
      monitoramento.
    impacto: "baixo"
    data: "2025-12-30"

# Riscos de Migração
riscos_migracao:
  - risco: "Resistência de usuários (mudança de processo manual para automático)"
    impacto: "medio"
    probabilidade: "alta"
    mitigacao: |
      - Treinamento obrigatório antes do go-live
      - Período de transição com ambos processos (manual e automático)
      - Documentação clara de como usar novas funcionalidades
      - Suporte intensivo nas primeiras semanas

  - risco: "Políticas muito restritivas bloqueando uso legítimo"
    impacto: "alto"
    probabilidade: "media"
    mitigacao: |
      - Simulador de impacto obrigatório antes de aplicar políticas em produção
      - Piloto com grupo pequeno de consumidores
      - Políticas iniciais mais permissivas, endurecendo gradualmente
      - Flag AlertOnly para testar sem bloquear

  - risco: "Falsos positivos em alertas (notificações desnecessárias)"
    impacto: "baixo"
    probabilidade: "media"
    mitigacao: |
      - Tuning de limiares durante piloto
      - Deduplicação de alertas (apenas 1 por limiar por período)
      - Permitir desabilitar alertas por política
      - Análise de padrões de consumo antes de definir limites

  - risco: "Sobrecarga de notificações (alert fatigue)"
    impacto: "medio"
    probabilidade: "media"
    mitigacao: |
      - Deduplicação rigorosa
      - Permitir configurar canais por tipo de alerta (e-mail vs SMS)
      - Opção de resumo diário ao invés de alerta imediato
      - Dashboard para visualização ao invés de notificação

# Rastreabilidade (Legado → Moderno)
rastreabilidade:
  - elemento_legado: "Processo: Revisão manual mensal de faturas"
    referencia_rf: "RN-RF049-04"
    referencia_uc: null
    status: "substituido"

  - elemento_legado: "Campo: Contrato.ValorLimite"
    referencia_rf: "RN-RF049-01"
    referencia_uc: "UC01"
    status: "substituido"

  - elemento_legado: "Processo: Bloqueio manual de consumidor"
    referencia_rf: "RN-RF049-05"
    referencia_uc: null
    status: "substituido"

  - elemento_legado: "Regra: Limite igual para todos os consumidores"
    referencia_rf: "RN-RF049-02"
    referencia_uc: null
    status: "substituido"

  - elemento_legado: "Ausência: Histórico de mudanças"
    referencia_rf: "RN-RF049-07"
    referencia_uc: null
    status: "substituido"

# Changelog
changelog:
  - versao: "2.0"
    data: "2025-12-30"
    descricao: "Adequação para automação e rastreabilidade. Todos os itens com destino obrigatório preenchido."
    autor: "Agência ALC - alc.dev.br"

  - versao: "1.0"
    data: "2025-12-30"
    descricao: "Criação inicial - Documentação de ausência de legado e justificativa de desenvolvimento do zero"
    autor: "Agência ALC - alc.dev.br"

# Metadados Consolidados
metadados:
  total_referencias: 10
  destinos:
    substituido: 10
    assumido: 0
    descartado: 0
    a_revisar: 0
  complexidade:
    alta: 5
    media: 4
    baixa: 1
  risco_migracao:
    alto: 0
    medio: 0
    baixo: 10
  prioridade_media: 1.9
