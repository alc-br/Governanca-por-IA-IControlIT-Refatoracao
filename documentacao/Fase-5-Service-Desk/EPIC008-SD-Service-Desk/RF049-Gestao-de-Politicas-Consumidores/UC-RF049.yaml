# =============================================
# UC-RF049 - Casos de Uso (Contrato Comportamental)
# Versão: 2.0
# Data: 2025-12-31
# Autor: Agência ALC - alc.dev.br
# =============================================

uc:
  documentacao: "RF049"
  versao: "2.0"
  data: "2025-12-31"

casos_de_uso:

  - id: "UC00"
    nome: "Listar Políticas de Consumidores"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      documentacao_items:
        - "F04"
      uc_items:
        - id: "FP-UC00-001"
          title: "Usuário acessa Gestão → Políticas de Consumidores"
          required: true
        - id: "FP-UC00-002"
          title: "Sistema valida permissão GESTAO.POLITICAS.VIEW"
          required: true
        - id: "FP-UC00-003"
          title: "Sistema carrega políticas do tenant (Id_Fornecedor)"
          required: true
        - id: "FP-UC00-004"
          title: "Sistema aplica paginação padrão (20 registros)"
          required: true
        - id: "FP-UC00-005"
          title: "Sistema exibe lista com colunas"
          required: true
        - id: "FP-UC00-006"
          title: "Sistema permite ordenação por qualquer coluna"
          required: true
        - id: "FA-UC00-001"
          title: "Usuário aplica filtro por Tipo de Política"
          required: false
        - id: "FA-UC00-002"
          title: "Usuário aplica filtro por Status"
          required: false
        - id: "FA-UC00-003"
          title: "Usuário busca por nome da política"
          required: false
        - id: "FA-UC00-004"
          title: "Usuário ordena por coluna"
          required: false
        - id: "FE-UC00-001"
          title: "Usuário sem permissão → acesso negado"
          required: true
        - id: "FE-UC00-002"
          title: "Nenhuma política encontrada → estado vazio"
          required: true
        - id: "FE-UC00-003"
          title: "Erro ao carregar dados"
          required: true

    precondicoes:
      - permissao: "GESTAO.POLITICAS.VIEW"

    gatilho: "Usuario acessa menu Gestão → Políticas de Consumidores"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessa_menu"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "carregar_politicas_tenant"
      - passo: 4
        ator: "sistema"
        acao: "aplicar_paginacao"
      - passo: 5
        ator: "sistema"
        acao: "exibir_lista"

    fluxos_alternativos:
      - id: "FA-UC00-01"
        condicao: "usuario_aplica_filtro"
        resultado: "lista_filtrada"

    fluxos_excecao:
      - id: "FE-UC00-01"
        condicao: "sem_permissao"
        resultado: "acesso_negado_403"
      - id: "FE-UC00-02"
        condicao: "lista_vazia"
        resultado: "estado_vazio_exibido"

    regras_aplicadas:
      - "RN-RF049-15"

    resultado_final:
      estado: "lista_exibida"

  - id: "UC01"
    nome: "Criar Política de Consumidor"
    ator_principal: "gestor_politicas"
    tipo: "crud"
    impacta_dados: true

    covers:
      documentacao_items:
        - "F01"
      uc_items:
        - id: "FP-UC01-001"
          title: "Usuário clica em Nova Política"
          required: true
        - id: "FP-UC01-002"
          title: "Sistema valida permissão GESTAO.POLITICAS.CREATE"
          required: true
        - id: "FP-UC01-003"
          title: "Sistema exibe wizard de criação (3 etapas)"
          required: true
        - id: "FP-UC01-004"
          title: "Etapa 1 - Dados Básicos"
          required: true
        - id: "FP-UC01-005"
          title: "Sistema valida unicidade do Nome"
          required: true
        - id: "FP-UC01-006"
          title: "Etapa 2 - Configurações"
          required: true
        - id: "FP-UC01-007"
          title: "Sistema valida formato e valores"
          required: true
        - id: "FP-UC01-008"
          title: "Etapa 3 - Ações e Alertas"
          required: true
        - id: "FP-UC01-009"
          title: "Usuário clica em Salvar"
          required: true
        - id: "FP-UC01-010"
          title: "Sistema valida todos os dados"
          required: true
        - id: "FP-UC01-011"
          title: "Sistema cria registro com status Rascunho"
          required: true
        - id: "FP-UC01-012"
          title: "Sistema preenche campos de auditoria"
          required: true
        - id: "FP-UC01-013"
          title: "Sistema preenche Id_Fornecedor automaticamente"
          required: true
        - id: "FP-UC01-014"
          title: "Sistema registra auditoria POLITICA_CREATED"
          required: true
        - id: "FP-UC01-015"
          title: "Sistema exibe mensagem de sucesso"
          required: true
        - id: "FP-UC01-016"
          title: "Sistema redireciona para UC02"
          required: true
        - id: "FA-UC01-001"
          title: "Salvar e Criar Outra"
          required: false
        - id: "FA-UC01-002"
          title: "Cancelar criação"
          required: false
        - id: "FA-UC01-003"
          title: "Aplicar Template"
          required: false
        - id: "FA-UC01-004"
          title: "Criar política customizada"
          required: false
        - id: "FE-UC01-001"
          title: "Nome duplicado"
          required: true
        - id: "FE-UC01-002"
          title: "Valores inválidos"
          required: true
        - id: "FE-UC01-003"
          title: "Configuração JSON inválida"
          required: true
        - id: "FE-UC01-004"
          title: "Erro ao salvar"
          required: true

    precondicoes:
      - permissao: "GESTAO.POLITICAS.CREATE"

    gatilho: "Usuario clica em Nova Política"

    fluxo_principal:
      - passo: 1
        ator: "sistema"
        acao: "exibir_wizard"
      - passo: 2
        ator: "usuario"
        acao: "preencher_dados_basicos"
      - passo: 3
        ator: "usuario"
        acao: "configurar_limites"
      - passo: 4
        ator: "usuario"
        acao: "configurar_acoes_alertas"
      - passo: 5
        ator: "usuario"
        acao: "salvar"
      - passo: 6
        ator: "sistema"
        acao: "validar_dados"
      - passo: 7
        ator: "sistema"
        acao: "persistir_registro"
      - passo: 8
        ator: "sistema"
        acao: "registrar_auditoria"

    fluxos_excecao:
      - id: "FE-UC01-01"
        condicao: "validacao_falhou"
        resultado: "exibir_erros"

    regras_aplicadas:
      - "RN-RF049-01"
      - "RN-RF049-11"
      - "RN-RF049-15"

    resultado_final:
      estado: "politica_criada"

  - id: "UC02"
    nome: "Visualizar Política de Consumidor"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      documentacao_items:
        - "F03"
      uc_items:
        - id: "FP-UC02-001"
          title: "Usuário seleciona política"
          required: true
        - id: "FP-UC02-002"
          title: "Sistema valida permissão"
          required: true
        - id: "FP-UC02-003"
          title: "Sistema valida tenant"
          required: true
        - id: "FP-UC02-004"
          title: "Sistema carrega dados"
          required: true
        - id: "FP-UC02-005"
          title: "Sistema exibe 4 abas"
          required: true
        - id: "FE-UC02-001"
          title: "Política não encontrada"
          required: true
        - id: "FE-UC02-002"
          title: "Política de outro tenant"
          required: true

    precondicoes:
      - permissao: "GESTAO.POLITICAS.VIEW"

    gatilho: "Usuario seleciona política"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "selecionar_politica"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao_tenant"
      - passo: 3
        ator: "sistema"
        acao: "carregar_dados"
      - passo: 4
        ator: "sistema"
        acao: "exibir_detalhes"

    regras_aplicadas:
      - "RN-RF049-15"

    resultado_final:
      estado: "detalhes_exibidos"

  - id: "UC03"
    nome: "Editar Política de Consumidor"
    ator_principal: "gestor_politicas"
    tipo: "crud"
    impacta_dados: true

    covers:
      documentacao_items:
        - "F02"
      uc_items:
        - id: "FP-UC03-001"
          title: "Usuário clica em Editar"
          required: true
        - id: "FP-UC03-002"
          title: "Sistema valida permissão UPDATE"
          required: true
        - id: "FP-UC03-003"
          title: "Sistema valida estado não final"
          required: true
        - id: "FP-UC03-004"
          title: "Sistema carrega dados atuais"
          required: true
        - id: "FP-UC03-005"
          title: "Sistema exibe wizard de edição"
          required: true
        - id: "FP-UC03-006"
          title: "Usuário altera campos"
          required: true
        - id: "FP-UC03-007"
          title: "Sistema valida alterações"
          required: true
        - id: "FP-UC03-008"
          title: "Usuário salva"
          required: true
        - id: "FP-UC03-009"
          title: "Sistema persiste alterações"
          required: true
        - id: "FP-UC03-010"
          title: "Sistema preenche auditoria"
          required: true
        - id: "FP-UC03-011"
          title: "Sistema registra diff"
          required: true
        - id: "FE-UC03-001"
          title: "Erro de validação"
          required: true
        - id: "FE-UC03-002"
          title: "Política em estado final"
          required: true
        - id: "FE-UC03-003"
          title: "Conflito de edição concorrente"
          required: true

    precondicoes:
      - permissao: "GESTAO.POLITICAS.UPDATE"

    gatilho: "Usuario clica em Editar"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "solicitar_edicao"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao_estado"
      - passo: 3
        ator: "sistema"
        acao: "carregar_dados"
      - passo: 4
        ator: "usuario"
        acao: "alterar_campos"
      - passo: 5
        ator: "sistema"
        acao: "validar_alteracoes"
      - passo: 6
        ator: "sistema"
        acao: "persistir_com_auditoria"

    regras_aplicadas:
      - "RN-RF049-15"

    resultado_final:
      estado: "politica_atualizada"

  - id: "UC04"
    nome: "Excluir Política de Consumidor"
    ator_principal: "gestor_politicas"
    tipo: "crud"
    impacta_dados: true

    covers:
      documentacao_items:
        - "F05"
      uc_items:
        - id: "FP-UC04-001"
          title: "Usuário clica em Excluir"
          required: true
        - id: "FP-UC04-002"
          title: "Sistema valida permissão DELETE"
          required: true
        - id: "FP-UC04-003"
          title: "Sistema verifica dependências"
          required: true
        - id: "FP-UC04-004"
          title: "Sistema solicita confirmação"
          required: true
        - id: "FP-UC04-005"
          title: "Usuário confirma"
          required: true
        - id: "FP-UC04-006"
          title: "Sistema executa soft delete"
          required: true
        - id: "FP-UC04-007"
          title: "Sistema preenche Dt_Exclusao"
          required: true
        - id: "FP-UC04-008"
          title: "Sistema registra auditoria"
          required: true
        - id: "FE-UC04-001"
          title: "Política com dependências"
          required: true
        - id: "FE-UC04-002"
          title: "Política já excluída"
          required: true

    precondicoes:
      - permissao: "GESTAO.POLITICAS.DELETE"

    gatilho: "Usuario clica em Excluir"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "solicitar_exclusao"
      - passo: 2
        ator: "sistema"
        acao: "verificar_dependencias"
      - passo: 3
        ator: "sistema"
        acao: "solicitar_confirmacao"
      - passo: 4
        ator: "usuario"
        acao: "confirmar"
      - passo: 5
        ator: "sistema"
        acao: "soft_delete"
      - passo: 6
        ator: "sistema"
        acao: "registrar_auditoria"

    regras_aplicadas:
      - "RN-RF049-15"

    resultado_final:
      estado: "politica_excluida"

  - id: "UC05"
    nome: "Aplicar Política a Consumidores"
    ator_principal: "gestor_politicas"
    tipo: "acao"
    impacta_dados: true

    covers:
      documentacao_items:
        - "F06"
      uc_items:
        - id: "FP-UC05-001"
          title: "Usuário clica em Aplicar Política"
          required: true
        - id: "FP-UC05-002"
          title: "Sistema valida permissão APPLY"
          required: true
        - id: "FP-UC05-003"
          title: "Sistema valida política ativa"
          required: true
        - id: "FP-UC05-004"
          title: "Sistema exibe modal de aplicação"
          required: true
        - id: "FP-UC05-005"
          title: "Usuário seleciona consumidores"
          required: true
        - id: "FP-UC05-006"
          title: "Usuário informa Data Início"
          required: true
        - id: "FP-UC05-007"
          title: "Usuário informa Data Fim (opcional)"
          required: false
        - id: "FP-UC05-008"
          title: "Usuário informa Motivo (opcional)"
          required: false
        - id: "FP-UC05-009"
          title: "Sistema valida Dt_Fim >= Dt_Inicio"
          required: true
        - id: "FP-UC05-010"
          title: "Usuário confirma"
          required: true
        - id: "FP-UC05-011"
          title: "Sistema cria PoliticaConsumidorAplicacao"
          required: true
        - id: "FP-UC05-012"
          title: "Sistema cria histórico IMUTÁVEL"
          required: true
        - id: "FP-UC05-013"
          title: "Sistema registra auditoria"
          required: true
        - id: "FA-UC05-001"
          title: "Aplicação automática por perfil (Domain Event)"
          required: false
        - id: "FA-UC05-002"
          title: "Aplicação automática por status (Domain Event)"
          required: false
        - id: "FE-UC05-001"
          title: "Política não ativa"
          required: true
        - id: "FE-UC05-002"
          title: "Aplicação duplicada"
          required: true
        - id: "FE-UC05-003"
          title: "Data Fim anterior a Data Início"
          required: true

    precondicoes:
      - permissao: "GESTAO.POLITICAS.APPLY"

    gatilho: "Usuario clica em Aplicar Política"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "solicitar_aplicacao"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao_politica_ativa"
      - passo: 3
        ator: "usuario"
        acao: "selecionar_consumidores_vigencia"
      - passo: 4
        ator: "sistema"
        acao: "validar_datas"
      - passo: 5
        ator: "sistema"
        acao: "criar_aplicacao_e_historico"
      - passo: 6
        ator: "sistema"
        acao: "registrar_auditoria"

    regras_aplicadas:
      - "RN-RF049-02"
      - "RN-RF049-03"
      - "RN-RF049-07"
      - "RN-RF049-15"

    resultado_final:
      estado: "politica_aplicada"

  - id: "UC06"
    nome: "Remover Política de Consumidores"
    ator_principal: "gestor_politicas"
    tipo: "acao"
    impacta_dados: true

    covers:
      documentacao_items:
        - "F07"
      uc_items:
        - id: "FP-UC06-001"
          title: "Usuário clica em Remover Política"
          required: true
        - id: "FP-UC06-002"
          title: "Usuário seleciona consumidores"
          required: true
        - id: "FP-UC06-003"
          title: "Sistema valida permissão"
          required: true
        - id: "FP-UC06-004"
          title: "Sistema solicita confirmação"
          required: true
        - id: "FP-UC06-005"
          title: "Sistema solicita Motivo (opcional)"
          required: false
        - id: "FP-UC06-006"
          title: "Usuário confirma"
          required: true
        - id: "FP-UC06-007"
          title: "Sistema marca como removida"
          required: true
        - id: "FP-UC06-008"
          title: "Sistema cria histórico IMUTÁVEL tipo REMOCAO"
          required: true
        - id: "FP-UC06-009"
          title: "Sistema registra auditoria"
          required: true
        - id: "FE-UC06-001"
          title: "Política não aplicada"
          required: true

    precondicoes:
      - permissao: "GESTAO.POLITICAS.APPLY"

    gatilho: "Usuario clica em Remover Política"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "solicitar_remocao"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "solicitar_confirmacao_motivo"
      - passo: 4
        ator: "sistema"
        acao: "marcar_removida_criar_historico"
      - passo: 5
        ator: "sistema"
        acao: "registrar_auditoria"

    regras_aplicadas:
      - "RN-RF049-07"
      - "RN-RF049-15"

    resultado_final:
      estado: "politica_removida"

  - id: "UC07"
    nome: "Processamento em Lote de Aplicação"
    ator_principal: "gestor_politicas"
    tipo: "batch"
    impacta_dados: true

    covers:
      documentacao_items:
        - "F06"
      uc_items:
        - id: "FP-UC07-001"
          title: "Usuário clica em Aplicar em Lote"
          required: true
        - id: "FP-UC07-002"
          title: "Usuário seleciona critérios de filtro"
          required: true
        - id: "FP-UC07-003"
          title: "Sistema exibe preview"
          required: true
        - id: "FP-UC07-004"
          title: "Usuário informa vigência e motivo"
          required: true
        - id: "FP-UC07-005"
          title: "Usuário confirma"
          required: true
        - id: "FP-UC07-006"
          title: "Sistema valida N ≤ 1000"
          required: true
        - id: "FP-UC07-007"
          title: "Sistema cria job Hangfire"
          required: true
        - id: "FP-UC07-008"
          title: "Background: Hangfire processa lotes de 100"
          required: true
        - id: "FP-UC07-009"
          title: "Background: Gera relatório consolidado"
          required: true
        - id: "FP-UC07-010"
          title: "Background: Envia notificação"
          required: true
        - id: "FA-UC07-001"
          title: "Lote > 1000: divisão automática"
          required: false
        - id: "FA-UC07-003"
          title: "Rollback se ≥50% falhas"
          required: false
        - id: "FE-UC07-001"
          title: "Filtro > 1000 não aceito"
          required: true
        - id: "FE-UC07-002"
          title: "Erro ao criar job"
          required: true

    precondicoes:
      - permissao: "GESTAO.POLITICAS.APPLY"

    gatilho: "Usuario clica em Aplicar em Lote"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "solicitar_aplicacao_lote"
      - passo: 2
        ator: "sistema"
        acao: "exibir_preview_validar_limite"
      - passo: 3
        ator: "usuario"
        acao: "confirmar"
      - passo: 4
        ator: "sistema"
        acao: "criar_job_hangfire"
      - passo: 5
        ator: "sistema"
        acao: "processar_background"
      - passo: 6
        ator: "sistema"
        acao: "notificar_usuario"

    regras_aplicadas:
      - "RN-RF049-06"
      - "RN-RF049-15"

    resultado_final:
      estado: "lote_processado"

  - id: "UC08"
    nome: "Avaliar Violação em Tempo Real"
    ator_principal: "sistema"
    tipo: "acao"
    impacta_dados: false

    covers:
      documentacao_items:
        - "F08"
      uc_items:
        - id: "FP-UC08-001"
          title: "Sistema externo faz POST /avaliar"
          required: true
        - id: "FP-UC08-002"
          title: "Request contém Id_Consumidor, Tipo_Operacao, Valor"
          required: true
        - id: "FP-UC08-003"
          title: "Sistema valida autenticação"
          required: true
        - id: "FP-UC08-004"
          title: "Sistema carrega políticas (cache 5min)"
          required: true
        - id: "FP-UC08-005"
          title: "Motor avalia regras em memória"
          required: true
        - id: "FP-UC08-006"
          title: "Sistema calcula Limite, Consumo, Percentual"
          required: true
        - id: "FP-UC08-007"
          title: "Sistema verifica violação"
          required: true
        - id: "FP-UC08-008"
          title: "Sistema retorna JSON: permitido, políticas, limites"
          required: true
        - id: "FP-UC08-009"
          title: "Tempo resposta ≤ 100ms (P95)"
          required: true
        - id: "FA-UC08-001"
          title: "Atinge limiar → dispara alerta"
          required: false
        - id: "FA-UC08-002"
          title: "Sem políticas → permitir"
          required: false
        - id: "FA-UC08-003"
          title: "Fail-open: motor indisponível → permitir"
          required: false
        - id: "FE-UC08-001"
          title: "Request inválido → 400"
          required: true
        - id: "FE-UC08-002"
          title: "Consumidor não encontrado → 404"
          required: true

    precondicoes:
      - autenticacao: "JWT ou API key"

    gatilho: "Sistema externo/interno faz POST /avaliar"

    fluxo_principal:
      - passo: 1
        ator: "sistema_externo"
        acao: "post_avaliar"
      - passo: 2
        ator: "sistema"
        acao: "validar_autenticacao"
      - passo: 3
        ator: "sistema"
        acao: "carregar_politicas_cache"
      - passo: 4
        ator: "sistema"
        acao: "avaliar_regras_memoria"
      - passo: 5
        ator: "sistema"
        acao: "retornar_json"

    regras_aplicadas:
      - "RN-RF049-04"
      - "RN-RF049-09"

    resultado_final:
      estado: "avaliacao_retornada"

  - id: "UC09"
    nome: "Simular Impacto de Política"
    ator_principal: "gestor_politicas"
    tipo: "acao"
    impacta_dados: false

    covers:
      documentacao_items:
        - "F09"
      uc_items:
        - id: "FP-UC09-001"
          title: "Usuário clica em Simular Impacto"
          required: true
        - id: "FP-UC09-002"
          title: "Sistema valida permissão"
          required: true
        - id: "FP-UC09-003"
          title: "Sistema exibe modal de simulação"
          required: true
        - id: "FP-UC09-004"
          title: "Usuário seleciona critérios"
          required: true
        - id: "FP-UC09-005"
          title: "Sistema exibe preview"
          required: true
        - id: "FP-UC09-006"
          title: "Usuário seleciona período (padrão 3 meses)"
          required: true
        - id: "FP-UC09-007"
          title: "Usuário clica em Simular"
          required: true
        - id: "FP-UC09-008"
          title: "Sistema analisa consumo histórico"
          required: true
        - id: "FP-UC09-009"
          title: "Sistema calcula: bloqueados, quando, economia"
          required: true
        - id: "FP-UC09-010"
          title: "Sistema gera relatório visual (ApexCharts)"
          required: true
        - id: "FP-UC09-011"
          title: "Sistema exibe relatório em ≤5s"
          required: true
        - id: "FP-UC09-012"
          title: "Usuário exporta PDF"
          required: false
        - id: "FE-UC09-001"
          title: "Consumidores sem histórico"
          required: true
        - id: "FE-UC09-002"
          title: "Período sem dados"
          required: true

    precondicoes:
      - permissao: "GESTAO.POLITICAS.VIEW"

    gatilho: "Usuario clica em Simular Impacto"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "solicitar_simulacao"
      - passo: 2
        ator: "usuario"
        acao: "selecionar_criterios_periodo"
      - passo: 3
        ator: "sistema"
        acao: "analisar_historico"
      - passo: 4
        ator: "sistema"
        acao: "calcular_impacto"
      - passo: 5
        ator: "sistema"
        acao: "gerar_relatorio_visual"

    regras_aplicadas:
      - "RN-RF049-10"

    resultado_final:
      estado: "simulacao_gerada"

  - id: "UC10"
    nome: "Gerenciar Alertas Proativos"
    ator_principal: "sistema"
    tipo: "acao"
    impacta_dados: true

    covers:
      documentacao_items:
        - "F10"
      uc_items:
        - id: "FP-UC10-001"
          title: "Background: Motor monitora consumo"
          required: true
        - id: "FP-UC10-002"
          title: "Background: Calcula percentual"
          required: true
        - id: "FP-UC10-003"
          title: "Background: Detecta limiar atingido"
          required: true
        - id: "FP-UC10-004"
          title: "Background: Verifica se alerta já enviado"
          required: true
        - id: "FP-UC10-005"
          title: "Background: Dispara AlertThresholdReached"
          required: true
        - id: "FP-UC10-006"
          title: "Background: RF066/RF067 enviam notificações"
          required: true
        - id: "FP-UC10-007"
          title: "Background: Registra alerta enviado"
          required: true
        - id: "FP-UC10-008"
          title: "Background: Atualiza dashboard"
          required: true
        - id: "FA-UC10-001"
          title: "Alertas desabilitados"
          required: false
        - id: "FE-UC10-001"
          title: "Falha ao enviar e-mail/SMS"
          required: true
        - id: "FE-UC10-002"
          title: "Destinatário sem contato"
          required: true

    precondicoes:
      - motor_politicas: "ativo"

    gatilho: "Consumo atinge limiar (50%, 80%, 100%)"

    fluxo_principal:
      - passo: 1
        ator: "sistema"
        acao: "monitorar_consumo_tempo_real"
      - passo: 2
        ator: "sistema"
        acao: "detectar_limiar"
      - passo: 3
        ator: "sistema"
        acao: "verificar_duplicacao"
      - passo: 4
        ator: "sistema"
        acao: "disparar_alertas"
      - passo: 5
        ator: "sistema"
        acao: "registrar_alerta"

    regras_aplicadas:
      - "RN-RF049-04"

    resultado_final:
      estado: "alerta_enviado"

  - id: "UC11"
    nome: "Executar Bloqueios Automáticos"
    ator_principal: "sistema"
    tipo: "acao"
    impacta_dados: true

    covers:
      documentacao_items:
        - "F11"
        - "F13"
      uc_items:
        - id: "FP-UC11-001"
          title: "Background: Sistema detecta 100% limite"
          required: true
        - id: "FP-UC11-002"
          title: "Background: Verifica AlertOnly=false"
          required: true
        - id: "FP-UC11-003"
          title: "Background: Identifica tipo bloqueio"
          required: true
        - id: "FP-UC11-004"
          title: "Background: Dispara PolicyViolated"
          required: true
        - id: "FP-UC11-005"
          title: "Background: RF048 executa bloqueio"
          required: true
        - id: "FP-UC11-006"
          title: "Background: Registra ViolacaoPolitica"
          required: true
        - id: "FP-UC11-007"
          title: "Background: Envia notificações"
          required: true
        - id: "FP-UC11-008"
          title: "Background: Cria solicitação análise"
          required: true
        - id: "FP-UC11-009"
          title: "Background: Atualiza dashboard"
          required: true
        - id: "FP-UC11-010"
          title: "Gestor visualiza solicitação"
          required: true
        - id: "FP-UC11-011"
          title: "Gestor analisa e decide"
          required: true
        - id: "FP-UC11-012"
          title: "Se liberado: desbloqueia e registra"
          required: false
        - id: "FA-UC11-001"
          title: "AlertOnly=true → não bloqueia"
          required: false
        - id: "FA-UC11-002"
          title: "Bloqueio Parcial"
          required: false
        - id: "FA-UC11-003"
          title: "Liberação temporária"
          required: false
        - id: "FE-UC11-001"
          title: "Erro ao executar bloqueio RF048"
          required: true
        - id: "FE-UC11-002"
          title: "Conflito de políticas"
          required: true

    precondicoes:
      - consumo: "100% limite"

    gatilho: "Consumo atinge 100% do limite"

    fluxo_principal:
      - passo: 1
        ator: "sistema"
        acao: "detectar_100_limite"
      - passo: 2
        ator: "sistema"
        acao: "verificar_configuracao_bloqueio"
      - passo: 3
        ator: "sistema"
        acao: "executar_bloqueio_rf048"
      - passo: 4
        ator: "sistema"
        acao: "registrar_violacao"
      - passo: 5
        ator: "sistema"
        acao: "notificar_stakeholders"
      - passo: 6
        ator: "sistema"
        acao: "criar_solicitacao_analise"

    regras_aplicadas:
      - "RN-RF049-05"
      - "RN-RF049-08"

    resultado_final:
      estado: "consumidor_bloqueado"

  - id: "UC12"
    nome: "Visualizar Histórico de Aplicações"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      documentacao_items:
        - "F12"
      uc_items:
        - id: "FP-UC12-001"
          title: "Usuário acessa aba Histórico"
          required: true
        - id: "FP-UC12-002"
          title: "Sistema valida permissão"
          required: true
        - id: "FP-UC12-003"
          title: "Sistema carrega PoliticaConsumidorHistorico"
          required: true
        - id: "FP-UC12-004"
          title: "Sistema exibe lista"
          required: true
        - id: "FP-UC12-005"
          title: "Sistema aplica paginação"
          required: true
        - id: "FP-UC12-006"
          title: "Sistema ordena por Data DESC"
          required: true
        - id: "FA-UC12-001"
          title: "Filtrar por período"
          required: false
        - id: "FA-UC12-002"
          title: "Filtrar por tipo"
          required: false
        - id: "FA-UC12-003"
          title: "Filtrar por consumidor"
          required: false
        - id: "FA-UC12-004"
          title: "Exportar CSV/Excel"
          required: false
        - id: "FE-UC12-001"
          title: "Nenhum registro"
          required: true
        - id: "FE-UC12-002"
          title: "Erro ao carregar"
          required: true

    precondicoes:
      - permissao: "GESTAO.POLITICAS.VIEW"

    gatilho: "Usuario acessa aba Histórico"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessar_aba_historico"
      - passo: 2
        ator: "sistema"
        acao: "carregar_historico_imutavel"
      - passo: 3
        ator: "sistema"
        acao: "exibir_lista_paginada"

    regras_aplicadas:
      - "RN-RF049-07"

    resultado_final:
      estado: "historico_exibido"

  - id: "UC13"
    nome: "Visualizar Dashboard de Conformidade"
    ator_principal: "gestor_politicas"
    tipo: "leitura"
    impacta_dados: false

    covers:
      documentacao_items:
        - "F14"
      uc_items:
        - id: "FP-UC13-001"
          title: "Usuário acessa Dashboard"
          required: true
        - id: "FP-UC13-002"
          title: "Sistema valida permissão"
          required: true
        - id: "FP-UC13-003"
          title: "Sistema carrega GET /dashboard"
          required: true
        - id: "FP-UC13-004"
          title: "Seção 1: Resumo Executivo (cards)"
          required: true
        - id: "FP-UC13-005"
          title: "Seção 2: Gráfico Temporal"
          required: true
        - id: "FP-UC13-006"
          title: "Seção 3: Consumidores Críticos (>80%)"
          required: true
        - id: "FP-UC13-007"
          title: "Seção 4: Top 10 Violadores"
          required: true
        - id: "FP-UC13-008"
          title: "Sistema conecta SignalR"
          required: true
        - id: "FP-UC13-009"
          title: "SignalR atualiza em tempo real"
          required: true
        - id: "FA-UC13-001"
          title: "Selecionar período análise"
          required: false
        - id: "FA-UC13-002"
          title: "Filtrar por departamento"
          required: false
        - id: "FA-UC13-003"
          title: "Clicar em consumidor crítico"
          required: false
        - id: "FE-UC13-001"
          title: "Erro ao carregar"
          required: true
        - id: "FE-UC13-002"
          title: "SignalR desconectado"
          required: true
        - id: "FE-UC13-003"
          title: "Dashboard >2s"
          required: true

    precondicoes:
      - permissao: "GESTAO.POLITICAS.VIEW"

    gatilho: "Usuario acessa Dashboard"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessar_dashboard"
      - passo: 2
        ator: "sistema"
        acao: "carregar_dados_dashboard"
      - passo: 3
        ator: "sistema"
        acao: "exibir_4_secoes"
      - passo: 4
        ator: "sistema"
        acao: "conectar_signalr"

    regras_aplicadas:
      - "RN-RF049-13"

    resultado_final:
      estado: "dashboard_exibido"

  - id: "UC14"
    nome: "Importar/Exportar Políticas"
    ator_principal: "administrador_politicas"
    tipo: "acao"
    impacta_dados: true

    covers:
      documentacao_items:
        - "F15"
        - "F16"
      uc_items:
        - id: "FP-UC14-001"
          title: "Exportação: Usuário clica em Exportar"
          required: true
        - id: "FP-UC14-002"
          title: "Exportação: Sistema valida permissão ADMIN"
          required: true
        - id: "FP-UC14-003"
          title: "Exportação: Sistema exibe modal"
          required: true
        - id: "FP-UC14-004"
          title: "Exportação: Usuário seleciona políticas"
          required: true
        - id: "FP-UC14-005"
          title: "Exportação: Sistema gera JSON"
          required: true
        - id: "FP-UC14-006"
          title: "Exportação: Sistema oferece download"
          required: true
        - id: "FP-UC14-007"
          title: "Exportação: Sistema registra auditoria"
          required: true
        - id: "FP-UC14-008"
          title: "Importação: Usuário faz upload JSON"
          required: true
        - id: "FP-UC14-009"
          title: "Importação: Sistema valida schema"
          required: true
        - id: "FP-UC14-010"
          title: "Importação: Sistema verifica conflitos"
          required: true
        - id: "FP-UC14-011"
          title: "Importação: Sistema exibe preview"
          required: true
        - id: "FP-UC14-012"
          title: "Importação: Usuário resolve conflitos"
          required: true
        - id: "FP-UC14-013"
          title: "Importação: Sistema importa"
          required: true
        - id: "FP-UC14-014"
          title: "Importação: Sistema cria histórico"
          required: true
        - id: "FP-UC14-015"
          title: "Importação: Sistema exibe relatório"
          required: true
        - id: "FE-UC14-001"
          title: "Schema JSON inválido"
          required: true
        - id: "FE-UC14-002"
          title: "Políticas inválidas"
          required: true
        - id: "FE-UC14-003"
          title: "Erro durante importação"
          required: true

    precondicoes:
      - permissao: "GESTAO.POLITICAS.ADMIN"

    gatilho: "Usuario clica em Exportar ou Importar"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "solicitar_exportacao_ou_importacao"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao_admin"
      - passo: 3
        ator: "sistema"
        acao: "executar_operacao"
      - passo: 4
        ator: "sistema"
        acao: "registrar_auditoria"

    regras_aplicadas:
      - "RN-RF049-12"

    resultado_final:
      estado: "operacao_concluida"

  - id: "UC15"
    nome: "Gerenciar Templates de Políticas"
    ator_principal: "administrador_politicas"
    tipo: "crud"
    impacta_dados: true

    covers:
      documentacao_items:
        - "F17"
      uc_items:
        - id: "FP-UC15-001"
          title: "Usuário acessa Templates"
          required: true
        - id: "FP-UC15-002"
          title: "Sistema valida permissão ADMIN"
          required: true
        - id: "FP-UC15-003"
          title: "Sistema exibe lista templates"
          required: true
        - id: "FP-UC15-004"
          title: "Sistema exibe templates sistema (flag)"
          required: true
        - id: "FP-UC15-005"
          title: "Usuário clica em Novo Template"
          required: true
        - id: "FP-UC15-006"
          title: "Sistema exibe modal"
          required: true
        - id: "FP-UC15-007"
          title: "Usuário informa dados + JSON"
          required: true
        - id: "FP-UC15-008"
          title: "Sistema valida schema JSON"
          required: true
        - id: "FP-UC15-009"
          title: "Sistema salva template"
          required: true
        - id: "FA-UC15-001"
          title: "Editar template existente"
          required: false
        - id: "FA-UC15-002"
          title: "Excluir template customizado"
          required: false
        - id: "FA-UC15-003"
          title: "Clonar template"
          required: false
        - id: "FE-UC15-001"
          title: "Configuração JSON inválida"
          required: true
        - id: "FE-UC15-002"
          title: "Deletar template sistema"
          required: true
        - id: "FE-UC15-003"
          title: "Deletar template em uso"
          required: true

    precondicoes:
      - permissao: "GESTAO.POLITICAS.ADMIN"

    gatilho: "Usuario acessa Templates"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessar_templates"
      - passo: 2
        ator: "sistema"
        acao: "exibir_lista_templates"
      - passo: 3
        ator: "usuario"
        acao: "criar_editar_excluir_template"
      - passo: 4
        ator: "sistema"
        acao: "validar_schema_salvar"

    regras_aplicadas:
      - "RN-RF049-11"

    resultado_final:
      estado: "template_gerenciado"

exclusions:
  uc_items: []

historico:
  - versao: "2.0"
    data: "2025-12-31"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Versão canônica orientada a contrato - Cobertura total RF049"
  - versao: "1.0"
    data: "2025-12-18"
    autor: "IControlIT Architect Agent"
    descricao: "Versão inicial"
