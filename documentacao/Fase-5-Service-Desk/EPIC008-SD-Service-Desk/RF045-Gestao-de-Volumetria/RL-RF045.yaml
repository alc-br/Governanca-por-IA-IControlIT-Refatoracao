# Template de Referência ao Legado (RL-RF045.yaml)
# Versão: 1.0
# Data: 2025-12-30

rf_id: RF045
titulo: "Gestão de Volumetria"

legado:
  sistema: "ASP.NET Web Forms + VB.NET"
  versao: "4.x"
  arquitetura: "Monolítica WebForms"
  banco_dados: "SQL Server (sem particionamento)"
  multi_tenant: false
  auditoria: "none"

# SEÇÃO CRÍTICA: Referencias ao Legado com Destino Obrigatório
referencias:
  - id: "LEG-RF045-001"
    tipo: "tela"
    nome: "LogsIIS.aspx"
    caminho: "ic1_legado/IControlIT/Admin/LogsIIS.aspx"
    descricao: |
      Tela de visualização básica de logs do IIS (arquivos .txt raw).
      Limitações:
      - Máximo 1.000 linhas retornadas (sem aviso ao usuário)
      - Período limitado a 30 dias (timeout em períodos maiores)
      - Sem agregação ou análise de tendências
      - Sem filtro por usuário ou fornecedor
      - Exportação quebrada com > 5.000 linhas
    destino: "substituido"
    justificativa: |
      Sistema moderno usa dashboard visual com agregações automáticas.
      Drill-down até request individual disponível para últimos 7 dias.
      Queries otimizadas com índices columnstore respondem em < 2s.
    documentacao_item_relacionado: "RN-RF045-14"
    uc_relacionado: "UC02"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF045-002"
    tipo: "tela"
    nome: "ConsumoMensal.aspx"
    caminho: "ic1_legado/IControlIT/Relatorios/ConsumoMensal.aspx"
    descricao: |
      Relatório de tamanho de tabelas do banco de dados.
      Limitações:
      - Query lenta (COUNT(*) em tabelas grandes, 5+ minutos)
      - Estimativa imprecisa (rows * 1KB, não usa sp_spaceused)
      - Sem histórico (impossível ver crescimento ao longo do tempo)
      - Sem alertas automáticos
      - Lista todas as tabelas (até system tables, 400+ linhas sem filtro)
    destino: "substituido"
    justificativa: |
      Sistema moderno usa sys.allocation_units (preciso e rápido).
      Snapshot diário salvo em VolumetriaStorage com histórico de 7 anos.
      Dashboard mostra crescimento com gráficos e heatmaps.
    documentacao_item_relacionado: "RN-RF045-13"
    uc_relacionado: "UC00"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF045-003"
    tipo: "componente"
    nome: "VolumetriaHelper.vb"
    caminho: "ic1_legado/IControlIT/App_Code/Helpers/VolumetriaHelper.vb"
    descricao: |
      Classe helper com queries lentas e ineficientes:
      - GetConsumoMensal(): Query sem índices (full table scan)
      - GetTamanhoTabelas(): COUNT(*) em loop (5+ minutos)
      - Sem multi-tenancy (não filtra por FornecedorId)
      - Sem cache (recalcula tudo a cada chamada)
    destino: "substituido"
    justificativa: |
      Sistema moderno usa CQRS com queries otimizadas.
      VolumetriaQueries usa índices columnstore e particionamento.
      Cache de 15min em dados estáticos (90% redução de queries).
      Isolamento multi-tenant obrigatório (FornecedorId em WHERE).
    documentacao_item_relacionado: "RN-RF045-05"
    uc_relacionado: null
    complexidade: "alta"
    risco_migracao: "baixo"
    prioridade: 1

  - id: "LEG-RF045-004"
    tipo: "stored_procedure"
    nome: "sp_GetDatabaseSize"
    caminho: "Database/dbo.sp_GetDatabaseSize"
    descricao: |
      Stored Procedure para calcular tamanho de tabelas.
      Lógica:
      - JOIN em sys.tables, sys.indexes, sys.partitions, sys.allocation_units
      - GROUP BY table name
      - Execução: 5+ minutos em bancos > 100GB
      - Sem cache ou histórico salvo
    destino: "substituido"
    justificativa: |
      Sistema moderno usa query otimizada com índices filtrados.
      Snapshot diário em VolumetriaAgregada.
      Resposta < 2 segundos mesmo em bancos de terabytes.
    documentacao_item_relacionado: "RN-RF045-13"
    uc_relacionado: "UC02"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF045-005"
    tipo: "regra_negocio"
    nome: "Limitação de 30 Dias por Performance"
    caminho: "ic1_legado/IControlIT/Admin/LogsIIS.aspx.vb (linha 45)"
    descricao: |
      Regra implícita que impede consulta de logs > 30 dias atrás.
      Código VB.NET:
      If DateDiff(DateInterval.Day, dtInicio, dtFim) > 30 Then
          ShowError("Período máximo: 30 dias")
          Exit Sub
      End If
      Motivo: Queries em tabela de 500M+ linhas causavam timeout.
    destino: "substituido"
    justificativa: |
      Sistema moderno usa agregações (não trava mesmo com anos de histórico).
      Dados raw mantidos apenas 7 dias (drill-down).
      Agregados mensais mantidos por 7 anos (conformidade LGPD).
    documentacao_item_relacionado: "RN-RF045-01"
    uc_relacionado: "UC02"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF045-006"
    tipo: "regra_negocio"
    nome: "Estimativa Imprecisa (1KB por Linha)"
    caminho: "ic1_legado/IControlIT/App_Code/Helpers/VolumetriaHelper.vb (linha 87)"
    descricao: |
      Regra implícita que estima tamanho de tabela como rows * 1024 bytes.
      Código VB.NET:
      Dim tamanhoEstimado = rows * 1024 ' 1KB por linha (chute)
      Motivo: sp_spaceused era lento, preferiram estimativa rápida e imprecisa.
    destino: "substituido"
    justificativa: |
      Sistema moderno usa sys.allocation_units (preciso).
      Calcula tamanho real incluindo índices, LOBs e espaço vazio.
    documentacao_item_relacionado: "RN-RF045-13"
    uc_relacionado: "UC00"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF045-007"
    tipo: "regra_negocio"
    nome: "Limpeza Manual de Logs a Cada 6 Meses"
    caminho: "Prática operacional (não documentado em código)"
    descricao: |
      Regra operacional descoberta em entrevista com DBA.
      DBA executava DELETE manual em LogAcesso a cada 6 meses:
      DELETE FROM LogAcesso WHERE Data < DATEADD(MONTH, -6, GETDATE())
      Motivo: Sem política de retenção automática, banco crescia indefinidamente.
    destino: "assumido"
    justificativa: |
      Sistema moderno tem rollup automático com retenção de 7 anos (agregados).
      Raw data deletada após 7 dias automaticamente (job Hangfire).
      Economia de 95% de storage mantendo dados úteis por mais tempo.
    documentacao_item_relacionado: "RN-RF045-08"
    uc_relacionado: null
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 1

  - id: "LEG-RF045-008"
    tipo: "regra_negocio"
    nome: "Alertas Manuais por E-mail (Ad-hoc)"
    caminho: "Prática operacional (não documentado em código)"
    descricao: |
      Regra operacional: quando DBA notava banco > 80GB, enviava e-mail manual.
      Sem automação, sem thresholds configuráveis, sem histórico de alertas.
      Frequência: Irregular (dependia de DBA lembrar de verificar).
    destino: "substituido"
    justificativa: |
      Sistema moderno tem alertas automáticos em 80%, 95%, 100%.
      Previsão de esgotamento com Azure ML (aviso 7 dias antes).
      Notificações via e-mail + in-app + webhook configuráveis.
    documentacao_item_relacionado: "RN-RF045-03"
    uc_relacionado: "UC03"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 1

  - id: "LEG-RF045-009"
    tipo: "regra_negocio"
    nome: "Sem Monitoramento de Custos Cloud"
    caminho: "Gap funcional (não existia no legado)"
    descricao: |
      Sistema legado não tinha visibilidade de custos de Azure Blob Storage.
      Custos cresceram 200% ao ano sem controle.
      Análise era feita manualmente em planilhas após fatura chegar.
    destino: "descartado"
    justificativa: |
      Sistema moderno adiciona relatórios de FinOps com recomendações.
      Integração com Azure Cost Management (API).
      Dashboard mostra custo estimado em tempo real.
      NOTA: Billing automático está FORA do escopo (ver RF045.md seção 2.2).
    documentacao_item_relacionado: null
    uc_relacionado: null
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 2

  - id: "LEG-RF045-010"
    tipo: "regra_negocio"
    nome: "Sem Previsão de Capacidade"
    caminho: "Gap funcional (não existia no legado)"
    descricao: |
      Sistema legado não fazia forecast de consumo futuro.
      Planejamento de expansão era reativo (só após problemas).
      Impossível prever quando quota seria atingida.
    destino: "descartado"
    justificativa: |
      Sistema moderno adiciona previsão com Azure ML (30/60/90 dias).
      Intervalo de confiança 95% permite planejamento seguro.
      Fallback para média simples se histórico < 3 meses.
    documentacao_item_relacionado: "RN-RF045-10"
    uc_relacionado: "UC02"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

# Telas Legadas (estrutura detalhada)
telas:
  - id: "LEG-RF045-001"
    nome: "LogsIIS.aspx"
    caminho: "ic1_legado/IControlIT/Admin/LogsIIS.aspx"
    responsabilidade: "Visualização de logs do IIS (texto raw)"
    campos:
      - nome: "Data Inicial"
        tipo: "DatePicker"
        obrigatorio: true
        validacao: "Limitado a 30 dias atrás"
      - nome: "Data Final"
        tipo: "DatePicker"
        obrigatorio: true
        validacao: "Máximo 7 dias de range"
      - nome: "Filtro Endpoint"
        tipo: "TextBox"
        obrigatorio: false
        validacao: "Busca textual simples (LIKE %)"
    comportamentos_implicitos:
      - "Limitação de 1.000 linhas sem aviso ao usuário"
      - "Timeout em queries > 30 dias"
      - "Sem agregação ou análise de tendências"
      - "Exportação quebrada com > 5.000 linhas"

  - id: "LEG-RF045-002"
    nome: "ConsumoMensal.aspx"
    caminho: "ic1_legado/IControlIT/Relatorios/ConsumoMensal.aspx"
    responsabilidade: "Relatório de tamanho de tabelas do banco"
    campos:
      - nome: "Mês"
        tipo: "DropDown"
        obrigatorio: true
        validacao: "Apenas 12 meses atrás"
      - nome: "Ano"
        tipo: "DropDown"
        obrigatorio: true
        validacao: "2010 até ano atual"
    comportamentos_implicitos:
      - "Query lenta (COUNT(*), 5+ minutos)"
      - "Estimativa imprecisa (rows * 1KB)"
      - "Sem histórico ou comparação temporal"
      - "Sem paginação (400+ linhas de uma vez)"

# WebServices Legados
servicos:
  - id: "LEG-RF045-WS-001"
    nome: "N/A"
    localizacao: "N/A"
    responsabilidade: "Não havia WebServices para volumetria no legado"
    notas: "Funcionalidade limitada a queries SQL diretas via SSMS"

# Tabelas Legadas com Problemas
tabelas:
  - nome: "LogAcesso"
    finalidade: "Armazenar logs de acesso (auditoria básica)"
    problemas:
      - "Falta FornecedorId (sem multi-tenancy)"
      - "Falta BytesRequest e BytesResponse (sem volumetria)"
      - "Sem índices por data (full table scan)"
      - "Sem particionamento (500M+ linhas em partição única)"
      - "Sem retenção automática (crescimento infinito)"

# Regras de Negócio Implícitas
regras_implicitas:
  - id: "RL-RN-001"
    descricao: "Logs limitados a 30 dias por performance (timeout em períodos maiores)"
    fonte: "LogsIIS.aspx.vb, linha 45"
  - id: "RL-RN-002"
    descricao: "Tamanho de tabela estimado em 1KB por linha (impreciso)"
    fonte: "VolumetriaHelper.vb, linha 87"
  - id: "RL-RN-003"
    descricao: "Limpeza manual de logs a cada 6 meses (DELETE ad-hoc pelo DBA)"
    fonte: "Prática operacional"
  - id: "RL-RN-004"
    descricao: "Sem monitoramento de custos de storage cloud (Azure Blob)"
    fonte: "Gap funcional"
  - id: "RL-RN-005"
    descricao: "Alertas manuais por e-mail quando banco > 80GB (ad-hoc)"
    fonte: "Prática operacional"

# Gap Analysis (Legado x Moderno)
gap_analysis:
  - item: "Coleta Automática de Volumetria"
    existe_legado: false
    existe_moderno: true
    notas: "Legado: manual via logs IIS. Moderno: middleware automático"

  - item: "Multi-Tenancy"
    existe_legado: false
    existe_moderno: true
    notas: "Legado: sem FornecedorId. Moderno: isolamento completo"

  - item: "Agregação de Dados"
    existe_legado: false
    existe_moderno: true
    notas: "Legado: apenas raw data. Moderno: rollups automáticos"

  - item: "Alertas Automáticos"
    existe_legado: false
    existe_moderno: true
    notas: "Legado: e-mails ad-hoc. Moderno: 80%, 95%, 100%"

  - item: "Previsão de Capacidade"
    existe_legado: false
    existe_moderno: true
    notas: "Legado: inexistente. Moderno: Azure ML (30/60/90 dias)"

  - item: "Dashboards Visuais"
    existe_legado: false
    existe_moderno: true
    notas: "Legado: queries SQL manuais. Moderno: heatmaps, gráficos"

  - item: "Throttling Progressivo"
    existe_legado: false
    existe_moderno: true
    notas: "Legado: timeout abrupto. Moderno: degradação escalonada"

  - item: "Relatórios FinOps"
    existe_legado: false
    existe_moderno: true
    notas: "Legado: sem visibilidade custos. Moderno: otimização 30-40%"

# Decisões de Modernização
decisoes_modernizacao:
  - decisao: "Middleware ASP.NET Core ao invés de logs IIS"
    motivo: |
      Logs IIS não capturam tamanho request/response.
      Middleware permite captura estruturada em tempo real.
    impacto: "alto"
    data: "2025-12-30"

  - decisao: "Azure ML para forecast ao invés de média simples"
    motivo: |
      Machine learning detecta sazonalidade e tendências complexas.
      Confiança de 95% permite planejamento com margem de segurança.
    impacto: "medio"
    data: "2025-12-30"

  - decisao: "Rollup irreversível (delete de raw data após agregação)"
    motivo: |
      Raw data consome 95% do storage mas é usada em < 1% das análises.
      Custo de manter raw seria proibitivo (R$2.000/mês vs R$100/mês).
    impacto: "baixo"
    data: "2025-12-30"

  - decisao: "Throttling progressivo ao invés de bloqueio abrupto"
    motivo: |
      Bloqueio abrupto causa impacto severo em operações críticas.
      Degradação progressiva permite finalizar transações em andamento.
    impacto: "alto"
    data: "2025-12-30"

# Riscos de Migração
riscos_migracao:
  - risco: "Overhead de middleware (adicionar latência aos requests)"
    impacto: "alto"
    probabilidade: "media"
    mitigacao: |
      Limitar a 5ms por request usando fila assíncrona.
      Captura não bloqueia response (MemoryStream).

  - risco: "Custo elevado de Azure ML"
    impacto: "medio"
    probabilidade: "baixa"
    mitigacao: |
      Fallback para média simples se histórico < 3 meses.
      Custo estimado: R$50/mês (aceitável).

  - risco: "Jobs de agregação travarem banco de dados"
    impacto: "alto"
    probabilidade: "baixa"
    mitigacao: |
      Rodar em horário de baixo uso (madrugada 3h-5h).
      Delete em batch de 100K registros por vez.

  - risco: "Spam de alertas (muitos e-mails)"
    impacto: "medio"
    probabilidade: "media"
    mitigacao: |
      Enviar alerta 1x por threshold (não repetir).
      Cooldown de 24h entre alertas do mesmo tipo.

  - risco: "Usuários reclamarem de throttling"
    impacto: "medio"
    probabilidade: "alta"
    mitigacao: |
      Dashboard mostra consumo em tempo real.
      Avisos prévios em 80% e 95% (7 dias de antecedência).

# Rastreabilidade (Legado → Moderno)
rastreabilidade:
  - elemento_legado: "LogsIIS.aspx"
    referencia_rf: "RN-RF045-14"
    referencia_uc: "UC02"
    status: "migrado"

  - elemento_legado: "ConsumoMensal.aspx"
    referencia_rf: "RN-RF045-13"
    referencia_uc: "UC00"
    status: "migrado"

  - elemento_legado: "VolumetriaHelper.vb"
    referencia_rf: "RN-RF045-05"
    referencia_uc: null
    status: "migrado"

  - elemento_legado: "sp_GetDatabaseSize"
    referencia_rf: "RN-RF045-13"
    referencia_uc: "UC02"
    status: "migrado"

  - elemento_legado: "Limpeza manual de logs"
    referencia_rf: "RN-RF045-08"
    referencia_uc: null
    status: "migrado"

  - elemento_legado: "Alertas manuais (DBA)"
    referencia_rf: "RN-RF045-03"
    referencia_uc: "UC03"
    status: "migrado"

  - elemento_legado: "Queries ad-hoc (SSMS)"
    referencia_rf: "RN-RF045-14"
    referencia_uc: "UC02"
    status: "migrado"

# Changelog
changelog:
  - versao: "1.0"
    data: "2025-12-30"
    descricao: "Extração completa de regras do legado com destinos obrigatórios"
    autor: "Agência ALC - alc.dev.br"
