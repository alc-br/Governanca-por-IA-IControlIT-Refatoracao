rf_id: RF027
rf_title: "Gestão de Aditivos de Contratos"
versao_governanca: "2.0"
data_migracao: "2025-12-30"
autor: "Agência ALC - alc.dev.br"
epic: "EPIC008-SD - Service Desk"
fase: "Fase 5 - Service Desk"

# ==============================================================================
# OBJETIVO
# ==============================================================================

objetivo: |
  Fornecer sistema completo de gestão de aditivos contratuais para contratos de Telecom e TI,
  permitindo controle rigoroso de versões, workflow de aprovação multi-nível, cálculo automático
  de impacto financeiro, rastreamento de prazos, alertas de renovação automática e rastreabilidade
  jurídica completa. Este documento define o que o sistema deve fazer, servindo como contrato oficial
  entre negócio, desenvolvimento, testes e agentes de IA.

# ==============================================================================
# ESCOPO
# ==============================================================================

escopo:
  dentro:
    - "Criação de aditivos em wizard multi-step (5 etapas)"
    - "Suporte a 8 tipos de aditivos (acréscimo/supressão linhas, alteração tarifária, prorrogação prazo, mudança SLA, inclusão/exclusão serviços, reajuste inflacionário, troca garantias)"
    - "Cálculo automático de impacto financeiro (mensal/anual/projeção 12 meses)"
    - "Versionamento completo de contratos (snapshot + diff visual)"
    - "Workflow de aprovação multi-nível (3 níveis configuráveis)"
    - "Library jurídica de cláusulas (50+ templates)"
    - "Gestão documental integrada (upload, OCR, versionamento, assinatura digital)"
    - "Alertas inteligentes de vencimento (90/60/30 dias + ML)"
    - "Dashboard pipeline de aditivos (Kanban + KPIs)"
    - "Comparação visual entre versões de contrato (diff engine)"
    - "Validação automática de datas e vigências"
    - "Isolamento multi-tenant obrigatório"
    - "Soft delete e auditoria completa"
    - "Cálculo automático de multas rescisórias"
    - "Integração com sistema jurídico externo"

  fora:
    - "Interface visual específica (responsabilidade do frontend)"
    - "Tecnologia, framework ou linguagem de implementação"
    - "Layout, UX ou identidade visual"
    - "Estratégia de deploy ou infraestrutura"
    - "Gestão de contratos base (RF-026)"
    - "Gestão de SLA operações (RF-028)"

# ==============================================================================
# CONCEITOS E DEFINIÇÕES
# ==============================================================================

conceitos:
  - termo: "Aditivo"
    definicao: "Modificação formal de contrato existente que altera condições originais (valores, prazos, serviços, SLAs)"

  - termo: "Contrato Base"
    definicao: "Contrato original ao qual aditivos são vinculados"

  - termo: "Versão de Contrato"
    definicao: "Snapshot completo do estado do contrato em determinado momento, gerado após cada aditivo aprovado"

  - termo: "Wizard Multi-Step"
    definicao: "Interface guiada em 5 etapas progressivas (Identificação → Dados → Impacto → Documentos → Revisão)"

  - termo: "Impacto Financeiro"
    definicao: "Diferença calculada automaticamente entre valor contrato antes e após aditivo (mensal/anual/projeção)"

  - termo: "Workflow Aprovação"
    definicao: "Processo multi-nível configurável (Gestor → Jurídico → Diretoria) com SLA e escalação"

  - termo: "Library Jurídica"
    definicao: "Conjunto de 50+ templates de cláusulas contratuais pré-aprovadas pelo departamento jurídico"

  - termo: "Diff Engine"
    definicao: "Motor de comparação que destaca visualmente diferenças entre versões de contrato (Myers' algorithm)"

  - termo: "DocuSign"
    definicao: "Plataforma de assinatura digital integrada para formalizar aditivos"

  - termo: "OCR"
    definicao: "Optical Character Recognition - extração automática de dados de PDFs/imagens (Azure Form Recognizer)"

  - termo: "Tenant"
    definicao: "Unidade lógica de isolamento de dados (ClienteId)"

  - termo: "Soft Delete"
    definicao: "Exclusão lógica via flag FlExcluido = TRUE (preserva auditoria)"

# ==============================================================================
# FUNCIONALIDADES COBERTAS
# ==============================================================================

funcionalidades:
  - id: "FUNC-001"
    titulo: "Criar Aditivo via Wizard"
    descricao: "Fluxo guiado 5 etapas com validações contextuais por tipo"

  - id: "FUNC-002"
    titulo: "Calcular Impacto Financeiro"
    descricao: "Motor automático gera 4 métricas + gráfico waterfall"

  - id: "FUNC-003"
    titulo: "Versionar Contratos"
    descricao: "Cada aditivo aprovado cria nova versão preservando histórico"

  - id: "FUNC-004"
    titulo: "Aprovar via Workflow"
    descricao: "3 níveis configuráveis (Gestor → Jurídico → Diretoria) com SLA e escalação"

  - id: "FUNC-005"
    titulo: "Gerenciar Cláusulas"
    descricao: "Library 50+ templates + builder drag-and-drop"

  - id: "FUNC-006"
    titulo: "Gerenciar Documentos"
    descricao: "Upload, OCR automático, versionamento, assinatura digital"

  - id: "FUNC-007"
    titulo: "Alertar Vencimentos"
    descricao: "ML prevê renovação automática + alertas 90/60/30 dias"

  - id: "FUNC-008"
    titulo: "Visualizar Pipeline"
    descricao: "Dashboard Kanban (Rascunho → Aprovação → Assinatura → Vigente → Encerrado)"

  - id: "FUNC-009"
    titulo: "Comparar Versões"
    descricao: "Diff visual destaca cláusulas adicionadas/removidas/modificadas"

  - id: "FUNC-010"
    titulo: "Validar Datas"
    descricao: "Validação automática vigência aditivo vs. contrato base"

  - id: "FUNC-011"
    titulo: "Calcular Multas"
    descricao: "Cálculo automático multa rescisória em supressões dentro de fidelização"

  - id: "FUNC-012"
    titulo: "Sincronizar Sistema Jurídico"
    descricao: "API REST ou webhook para sistemas externos (Projuris, Legal One, SAP)"

# ==============================================================================
# REGRAS DE NEGÓCIO
# ==============================================================================

regras_negocio:
  - id: "RN-RF027-001"
    titulo: "8 Tipos de Aditivos Suportados"
    descricao: "Sistema DEVE suportar exatamente 8 tipos distintos de aditivos contratuais, cada um com wizard e validações específicas"
    criticidade: "CRÍTICA"
    justificativa: "Cada tipo de aditivo tem campos e validações diferentes que devem ser aplicados corretamente"
    criterios_aceite:
      - "Wizard exibe campos dinâmicos baseados no tipo selecionado"
      - "Validações específicas são aplicadas por tipo"
      - "Tipo não pode ser alterado após criação do aditivo"
      - "Acréscimo Linhas: Validação ≤25% valor contrato base"
      - "Supressão Linhas: Validação ≤50% das linhas"
      - "Reajuste Inflacionário: Consulta API Banco Central"
      - "Troca Garantias: Upload obrigatório documento"
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "enum"
      mensagem_erro: "Tipo de aditivo não reconhecido ou validações específicas falharam"
      http_code: 400
    tipos_suportados:
      - codigo: "ACRESCIMO_LINHAS"
        nome: "Acréscimo de Linhas/Ativos"
        validacao_especifica: "Valor total ≤ 25% do valor contrato base"
      - codigo: "SUPRESSAO_LINHAS"
        nome: "Supressão de Linhas/Ativos"
        validacao_especifica: "Não pode suprimir >50% das linhas"
      - codigo: "ALTERACAO_TARIFARIA"
        nome: "Alteração Tarifária"
        validacao_especifica: "Gráfico comparativo obrigatório"
      - codigo: "PRORROGACAO_PRAZO"
        nome: "Prorrogação de Prazo"
        validacao_especifica: "Nova data ≥ Data atual + 1 mês"
      - codigo: "MUDANCA_SLA"
        nome: "Mudança de SLA"
        validacao_especifica: "Referência cruzada com RF-028"
      - codigo: "INCLUSAO_SERVICOS"
        nome: "Inclusão de Novos Serviços"
        validacao_especifica: "Serviço não duplicado"
      - codigo: "REAJUSTE_INFLACIONARIO"
        nome: "Reajuste Inflacionário"
        validacao_especifica: "% reajuste ≤ índice oficial + 2%"
      - codigo: "TROCA_GARANTIAS"
        nome: "Troca de Garantias"
        validacao_especifica: "Upload documento obrigatório"

  - id: "RN-RF027-002"
    titulo: "Wizard Multi-Step com Validações Progressivas"
    descricao: "Criação de aditivo DEVE seguir wizard guiado em 5 etapas obrigatórias com validações progressivas"
    criticidade: "CRÍTICA"
    criterios_aceite:
      - "Não permite avançar etapa se validações falharem"
      - "Permite voltar etapas anteriores sem perder dados"
      - "Salvamento automático a cada 30 segundos"
      - "Etapa 1: Contrato deve estar vigente"
      - "Etapa 2: Vigência aditivo ⊆ Vigência contrato base"
      - "Etapa 3: Variação >20% exige justificativa"
      - "Etapa 4: Hash SHA-256 do documento"
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "progressiva"
      mensagem_erro: "Validação pendente - não pode avançar etapa"
      http_code: 400
    etapas:
      - numero: 1
        nome: "Identificação"
        campos: ["contrato_base", "tipo_aditivo", "numero_aditivo"]
        validacoes: ["Contrato vigente"]
      - numero: 2
        nome: "Dados Específicos"
        campos: ["campos_dinamicos", "datas_vigencia"]
        validacoes: ["Vigência aditivo ⊆ Vigência contrato base"]
      - numero: 3
        nome: "Impacto Financeiro"
        campos: ["calculo_automatico", "ajuste_manual"]
        validacoes: ["Variação >20% exige justificativa"]
      - numero: 4
        nome: "Documentos"
        campos: ["upload_pdf", "upload_anexos"]
        validacoes: ["Hash SHA-256"]
      - numero: 5
        nome: "Revisão e Envio"
        campos: ["sumario", "comparacao"]
        validacoes: ["Todos dados completos"]

  - id: "RN-RF027-003"
    titulo: "Cálculo Automático de Impacto Financeiro"
    descricao: "Sistema DEVE calcular automaticamente 4 métricas obrigatórias de impacto financeiro"
    criticidade: "ALTA"
    criterios_aceite:
      - "Cálculo executa em <5 segundos"
      - "Todas as 4 métricas são exibidas"
      - "Gráfico waterfall é gerado automaticamente"
      - "Exportação PDF contém todos os gráficos"
    implementacao:
      backend: true
      frontend: true
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "calculo"
      mensagem_erro: "Erro no cálculo de impacto financeiro"
      http_code: 500
    metricas_calculadas:
      - nome: "Valor Incremental Mensal"
        formula: "Valor_Novo_Mensal - Valor_Atual_Mensal"
        formato: "R$ +XX.XXX (verde) ou R$ -XX.XXX (vermelho)"
      - nome: "Valor Incremental Anual"
        formula: "Valor_Incremental_Mensal × Meses_Vigencia_Restante"
        formato: "R$ +XXX.XXX"
      - nome: "Valor Total Contrato Pós-Aditivo"
        formula: "Valor_Base + Σ(Aditivos_Vigentes)"
        formato: "R$ XXX.XXX + % variação"
      - nome: "Projeção 12 Meses"
        formula: "Gráfico linha evolução mensal"
        formato: "Chart com reajustes e sazonalidade"

  - id: "RN-RF027-004"
    titulo: "Versionamento Completo de Contratos"
    descricao: "Cada aditivo aprovado DEVE criar nova versão do contrato com histórico completo e diff visual"
    criticidade: "CRÍTICA"
    criterios_aceite:
      - "Nova versão criada automaticamente ao aprovar aditivo"
      - "Hash SHA-256 validado em cada consulta"
      - "Diff visual funciona para contratos >100 páginas"
      - "Restauração exige justificativa + log auditoria"
      - "Versões anteriores são imutáveis"
    implementacao:
      backend: true
      frontend: true
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "integridade"
      mensagem_erro: "Erro ao criar versão do contrato"
      http_code: 500
    versionamento_semantico:
      minor_version:
        criterio: "Impacto financeiro ≤15%"
        tipos: ["ALTERACAO_TARIFARIA", "REAJUSTE_INFLACIONARIO"]
        formato: "v1.0 → v1.1"
      major_version:
        criterio: "Impacto financeiro >15%"
        tipos: ["ACRESCIMO_LINHAS", "SUPRESSAO_LINHAS", "PRORROGACAO_PRAZO"]
        formato: "v1.2 → v2.0"

  - id: "RN-RF027-005"
    titulo: "Workflow de Aprovação Multi-Nível"
    descricao: "Aditivo DEVE passar por workflow configurável de até 3 níveis antes de vigência"
    criticidade: "CRÍTICA"
    criterios_aceite:
      - "Workflow não permite pular níveis"
      - "Escalação automática dispara no prazo (80% e 100% SLA)"
      - "Aprovação/rejeição registrada em log auditoria"
      - "DocuSign obrigatório no nível final"
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "permissao"
      mensagem_erro: "Usuário não autorizado para aprovar nível atual"
      http_code: 403
    niveis_workflow:
      - nivel: 1
        nome: "Gestor Operacional"
        responsavel: "Gerente do departamento solicitante"
        sla_dias: 2
        validacao: "Checklist técnico (linhas, planos, valores)"
      - nivel: 2
        nome: "Jurídico"
        responsavel: "Advogado/Analista Jurídico"
        sla_dias: 5
        validacao: "Conformidade cláusulas, riscos, multas"
        permite_retorno: true
      - nivel: 3
        nome: "Diretoria Financeira"
        responsavel: "CFO/Controller"
        sla_dias: 3
        gatilho_financeiro: "Impacto >R$50k/ano"
        validacao: "Aprovação orçamentária"
        requer_docusign: true

  - id: "RN-RF027-006"
    titulo: "Library Jurídica de Cláusulas"
    descricao: "Sistema DEVE fornecer biblioteca de 50+ templates de cláusulas pré-aprovadas + builder visual"
    criticidade: "MÉDIA"
    criterios_aceite:
      - "Biblioteca contém mínimo 50 templates"
      - "Builder permite drag-and-drop funcional"
      - "Preview PDF gerado em <3 segundos"
      - "Templates customizados exigem aprovação jurídica"
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "permissao"
      mensagem_erro: "Template customizado não aprovado pelo jurídico"
      http_code: 403
    categorias_templates:
      - categoria: "Telecom"
        quantidade: 20
        exemplos: ["SLA disponibilidade 99.9%", "Multa descumprimento SLA", "Reajuste IPCA", "Portabilidade linhas"]
      - categoria: "TI/Cloud"
        quantidade: 15
        exemplos: ["SLA uptime cloud", "Licenciamento per-user", "Suporte 24x7", "LGPD DPA"]
      - categoria: "Gerais"
        quantidade: 15
        exemplos: ["Renovação automática", "Rescisão antecipada", "Foro competente", "NDA"]

  - id: "RN-RF027-007"
    titulo: "Gestão Documental Integrada"
    descricao: "Sistema DEVE gerenciar ciclo de vida completo (upload, OCR, versionamento, assinatura, arquivamento)"
    criticidade: "ALTA"
    criterios_aceite:
      - "Upload aceita PDF/DOCX/imagens (máx 25MB)"
      - "OCR extrai dados em <10 segundos"
      - "Divergência >5% gera alerta"
      - "DocuSign integrado com callback funcional"
      - "Hash SHA-256 garante integridade"
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "tamanho_arquivo"
      mensagem_erro: "Arquivo excede 25MB ou tipo não suportado"
      http_code: 413
    tipos_documentos:
      - tipo: "ADITIVO_ASSINADO"
        obrigatorio: true
        descricao: "Documento oficial pós-assinatura"
      - tipo: "MINUTA_ADITIVO"
        obrigatorio: false
        descricao: "Versão pré-assinatura"
      - tipo: "EMAILS_NEGOCIACAO"
        obrigatorio: false
        descricao: "Evidências discussão comercial"
      - tipo: "PROPOSTAS_COMERCIAIS"
        obrigatorio: false
        descricao: "Propostas operadora/fornecedor"
      - tipo: "APROVACOES_INTERNAS"
        obrigatorio: false
        descricao: "PDFs gerados do workflow"

  - id: "RN-RF027-008"
    titulo: "Alertas Inteligentes de Vencimento"
    descricao: "Sistema DEVE monitorar vencimentos gerando alertas escalonados 90/60/30 dias com ML"
    criticidade: "MÉDIA"
    criterios_aceite:
      - "Alertas disparados automaticamente nos prazos (90/60/30 dias)"
      - "ML treinado com histórico mínimo 100 contratos"
      - "Dashboard atualizado em tempo real"
      - "Botão 'Iniciar Renegociação' funcional"
    implementacao:
      backend: true
      frontend: true
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "logica_negocio"
      mensagem_erro: "Erro ao gerar alertas de vencimento"
      http_code: 500
    alertas_escalonados:
      - prazo_dias: 90
        destinatarios: ["Gestor Operacional"]
        canais: ["email"]
        conteudo: "Resumo aditivo + valor + próximas ações"
      - prazo_dias: 60
        destinatarios: ["Gestor Operacional", "Jurídico"]
        canais: ["email", "push"]
        conteudo: "Resumo + histórico variação preços + sugestão renegociação"
      - prazo_dias: 30
        destinatarios: ["Todos stakeholders"]
        canais: ["email", "push", "in-app"]
        conteudo: "Resumo + KPI comparação mercado + botão renegociação"
    ml_previsao:
      modelo: "Probabilidade renovação automática"
      features: ["tipo_servico", "valor", "fornecedor", "historico_contestacoes", "NPS"]
      output: "Probabilidade 0-100%"
      alerta_threshold: 80

  - id: "RN-RF027-009"
    titulo: "Dashboard Pipeline de Aditivos"
    descricao: "Sistema DEVE exibir dashboard executivo com Kanban e KPIs principais"
    criticidade: "MÉDIA"
    criterios_aceite:
      - "Kanban atualizado em tempo real"
      - "Métricas calculadas corretamente"
      - "5 gráficos obrigatórios presentes"
      - "Drill-down funcional"
      - "Exportação PDF completa"
    implementacao:
      backend: true
      frontend: true
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "apresentacao"
      mensagem_erro: "Erro ao gerar dashboard"
      http_code: 500
    kanban_colunas:
      - status: "Rascunho"
        cor: "cinza"
        descricao: "Em elaboração"
      - status: "Em Aprovação"
        cor: "amarelo"
        descricao: "Workflow em andamento"
      - status: "Aguardando Assinatura"
        cor: "laranja"
        descricao: "Aprovado, pendente DocuSign"
      - status: "Vigente"
        cor: "verde"
        descricao: "Aditivo ativo"
      - status: "Encerrado"
        cor: "azul"
        descricao: "Concluído/expirado"
    metricas_pipeline:
      - metrica: "Total aditivos em pipeline"
        tipo: "contador"
      - metrica: "Valor total em aprovação (R$)"
        tipo: "soma"
      - metrica: "Tempo médio aprovação (dias)"
        tipo: "media"
      - metrica: "Taxa aprovação 1ª rodada (%)"
        tipo: "percentual"
      - metrica: "Bottleneck atual"
        tipo: "analise"
    graficos_executivos:
      - tipo: "Pie Chart"
        titulo: "Distribuição por Tipo"
        dados: "% de cada tipo de aditivo"
      - tipo: "Line Chart"
        titulo: "Evolução Temporal"
        dados: "Aditivos criados por mês (12 meses)"
      - tipo: "Bar Chart"
        titulo: "Ranking Fornecedores"
        dados: "Top 10 fornecedores com mais aditivos"
      - tipo: "Waterfall Chart"
        titulo: "Impacto Financeiro"
        dados: "Economia vs. custo adicional gerado"
      - tipo: "Funnel Chart"
        titulo: "Funil Aprovação"
        dados: "Taxa conversão por nível"

  - id: "RN-RF027-010"
    titulo: "Comparação Visual entre Versões"
    descricao: "Sistema DEVE permitir comparação lado a lado com highlight automático (Myers' algorithm)"
    criticidade: "MÉDIA"
    criterios_aceite:
      - "Comparação funciona para qualquer par de versões"
      - "Color coding correto (verde/vermelho/amarelo/cinza)"
      - "Split View e Unified View funcionais"
      - "Export PDF contém highlights"
      - "Background job para contratos >100 páginas"
    implementacao:
      backend: true
      frontend: true
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "processamento"
      mensagem_erro: "Erro ao comparar versões"
      http_code: 500
    diff_engine:
      algoritmo: "Myers' diff algorithm"
      granularidade: "palavra por palavra"
      color_coding:
        verde: "Texto adicionado"
        vermelho: "Texto removido (strikethrough)"
        amarelo: "Texto modificado (hover mostra anterior)"
        cinza: "Texto inalterado"
      views:
        - tipo: "Split View"
          descricao: "2 colunas lado a lado sincronizadas"
        - tipo: "Unified View"
          descricao: "Coluna única com color coding"

  - id: "RN-RF027-011"
    titulo: "Validação de Vigência e Datas"
    descricao: "Sistema DEVE validar automaticamente consistência de datas entre aditivo e contrato base"
    criticidade: "CRÍTICA"
    criterios_aceite:
      - "Validações aplicadas antes de salvar"
      - "Mensagens erro claras e descritivas"
      - "Retroatividade exige justificativa obrigatória"
      - "Não permite 2 aditivos do mesmo tipo vigentes simultaneamente"
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "data"
      mensagem_erro: "Data término aditivo posterior a contrato. Use tipo 'Prorrogação de Prazo'"
      http_code: 400
    regras_validacao:
      - regra: "Dt_Inicio_Aditivo >= Dt_Inicio_Contrato_Base"
        descricao: "Aditivo não pode iniciar antes do contrato base"
      - regra: "Dt_Inicio_Aditivo <= Dt_Termino_Contrato_Base (se não prorrogação)"
        descricao: "Aditivo não pode iniciar após término do contrato"
      - regra: "Dt_Termino_Aditivo <= Dt_Termino_Contrato_Base (se não prorrogação)"
        descricao: "Aditivo não pode terminar após contrato base"
      - regra: "Se prorrogação: Dt_Termino_Aditivo > Dt_Termino_Contrato_Base"
        descricao: "Prorrogação deve estender data de término"
      - regra: "Não permite sobreposição de aditivos mesmo tipo"
        descricao: "Ex: 2 reajustes IPCA ativos simultaneamente"
      - regra: "Dt_Inicio < Dt_Hoje exige justificativa + aprovação diretoria"
        descricao: "Retroatividade controlada"

  - id: "RN-RF027-012"
    titulo: "Isolamento Multi-Tenant Obrigatório"
    descricao: "TODAS as queries e operações DEVEM filtrar por ClienteId obtido do JWT token"
    criticidade: "CRÍTICA"
    justificativa: "Segurança de dados - Cliente A não pode ver dados de Cliente B"
    criterios_aceite:
      - "Filtro ClienteId em 100% das queries"
      - "Teste cross-tenant retorna HTTP 403"
      - "Índice composto (ClienteId, Id_Contrato, Status) validado"
    implementacao:
      backend: true
      frontend: false
      validacao_api: true
      validacao_ui: false
    validacao:
      tipo: "seguranca"
      mensagem_erro: "Acesso negado - tentativa de acesso cross-tenant"
      http_code: 403

  - id: "RN-RF027-013"
    titulo: "Soft Delete Obrigatório"
    descricao: "Sistema NUNCA deve fazer DELETE físico. Exclusão lógica via FlExcluido = TRUE"
    criticidade: "CRÍTICA"
    justificativa: "Preservar auditoria completa (rastreabilidade SOX)"
    criterios_aceite:
      - "DELETE físico bloqueado (somente UPDATE FlExcluido)"
      - "Query Filter aplicado globalmente via EF Core"
      - "Restauração possível (FlExcluido = FALSE)"
    implementacao:
      backend: true
      frontend: false
      validacao_api: true
      validacao_ui: false
    validacao:
      tipo: "auditoria"
      mensagem_erro: "Operação não permitida - use exclusão lógica"
      http_code: 403

  - id: "RN-RF027-014"
    titulo: "Cálculo de Multas Rescisórias"
    descricao: "Para supressões, sistema DEVE calcular automaticamente multa rescisória se dentro de fidelização"
    criticidade: "ALTA"
    criterios_aceite:
      - "Cálculo automático para tipo Supressão"
      - "Alerta visual destacando valor da multa"
      - "Sobrescrita exige justificativa obrigatória"
    implementacao:
      backend: true
      frontend: true
      validacao_api: false
      validacao_ui: true
    validacao:
      tipo: "calculo"
      mensagem_erro: "Erro ao calcular multa rescisória"
      http_code: 500
    formula_calculo:
      condicao: "Meses_Fidelizacao_Restante > 0 AND Tipo_Aditivo = Supressao"
      formula: "Multa = Valor_Mensal_Linhas_Suprimidas × Meses_Fidelizacao_Restante × Percentual_Multa"
      percentual_padrao: 100

  - id: "RN-RF027-015"
    titulo: "Integração com Sistema Jurídico Externo"
    descricao: "Sistema DEVE sincronizar aditivos aprovados com gestão jurídica via API REST/webhook"
    criticidade: "MÉDIA"
    criterios_aceite:
      - "Webhook ou API REST funcional"
      - "Retry policy aplicado (Polly 3 tentativas)"
      - "DLQ funcional para falhas"
      - "Payload JSON validado (schema v1)"
    implementacao:
      backend: true
      frontend: false
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "integracao"
      mensagem_erro: "Sistema externo indisponível - retry automático"
      http_code: 502
    sistemas_suportados:
      - sistema: "Projuris"
        metodo: "API REST"
      - sistema: "Legal One"
        metodo: "Webhook"
      - sistema: "SAP ERP Legal"
        metodo: "API REST"
    retry_policy:
      tentativas: 3
      backoff: "2s, 4s, 8s"
      dlq: "Azure Service Bus"

# ==============================================================================
# ESTADOS DO ADITIVO
# ==============================================================================

estados:
  - estado: "Rascunho"
    descricao: "Criado, não enviado para aprovação"
    cor: "cinza"

  - estado: "Em Aprovação"
    descricao: "Workflow aprovação em andamento"
    cor: "amarelo"

  - estado: "Aguardando Assinatura"
    descricao: "Aprovado, pendente DocuSign"
    cor: "laranja"

  - estado: "Vigente"
    descricao: "Aditivo ativo e em vigor"
    cor: "verde"

  - estado: "Encerrado"
    descricao: "Aditivo concluído/expirado"
    cor: "azul"

  - estado: "Cancelado"
    descricao: "Aditivo cancelado antes de vigência"
    cor: "vermelho"

  - estado: "Rejeitado"
    descricao: "Workflow rejeitado por aprovador"
    cor: "vermelho"

transicoes_permitidas:
  - de: "Rascunho"
    para: ["Em Aprovação", "Cancelado"]

  - de: "Em Aprovação"
    para: ["Aguardando Assinatura", "Rejeitado", "Rascunho"]

  - de: "Aguardando Assinatura"
    para: ["Vigente"]

  - de: "Vigente"
    para: ["Encerrado"]

# ==============================================================================
# EVENTOS DE DOMÍNIO
# ==============================================================================

eventos_dominio:
  - evento: "aditivo.criado"
    quando: "Após criação wizard"
    payload: ["id_aditivo", "tipo", "id_contrato"]

  - evento: "aditivo.enviado_aprovacao"
    quando: "Ao enviar workflow"
    payload: ["id_aditivo", "nivel_inicial", "aprovador_nivel1"]

  - evento: "aditivo.aprovado_nivel1"
    quando: "Gestor aprova"
    payload: ["id_aditivo", "aprovador", "timestamp"]

  - evento: "aditivo.aprovado_nivel2"
    quando: "Jurídico aprova"
    payload: ["id_aditivo", "aprovador", "timestamp"]

  - evento: "aditivo.aprovado_nivel3"
    quando: "Diretoria aprova"
    payload: ["id_aditivo", "aprovador", "timestamp"]

  - evento: "aditivo.rejeitado"
    quando: "Qualquer nível rejeita"
    payload: ["id_aditivo", "nivel", "aprovador", "justificativa"]

  - evento: "aditivo.assinado"
    quando: "DocuSign concluído"
    payload: ["id_aditivo", "envelope_id", "timestamp"]

  - evento: "aditivo.vigente"
    quando: "Entra em vigor"
    payload: ["id_aditivo", "data_inicio_vigencia"]

  - evento: "aditivo.vencimento_proximo"
    quando: "90/60/30 dias antes"
    payload: ["id_aditivo", "dias_restantes", "probabilidade_renovacao"]

  - evento: "aditivo.encerrado"
    quando: "Vigência termina"
    payload: ["id_aditivo", "data_encerramento"]

  - evento: "contrato_versao.criada"
    quando: "Nova versão contrato"
    payload: ["id_contrato", "numero_versao", "id_aditivo_gerador"]

# ==============================================================================
# SEGURANÇA E PERMISSÕES (RBAC)
# ==============================================================================

permissoes:
  - codigo: "aditivos.create"
    descricao: "Criar aditivo"
    roles: ["Gestor", "Administrador"]

  - codigo: "aditivos.update"
    descricao: "Atualizar aditivo rascunho"
    roles: ["Gestor", "Administrador"]

  - codigo: "aditivos.view"
    descricao: "Visualizar aditivo"
    roles: ["Gestor", "Administrador", "Visualizador"]

  - codigo: "aditivos.view_any"
    descricao: "Listar aditivos"
    roles: ["Gestor", "Administrador", "Visualizador"]

  - codigo: "aditivos.delete"
    descricao: "Excluir aditivo (soft delete)"
    roles: ["Administrador"]

  - codigo: "aditivos.approve_level1"
    descricao: "Aprovar Nível 1 (Gestor)"
    roles: ["Gestor Operacional"]

  - codigo: "aditivos.approve_level2"
    descricao: "Aprovar Nível 2 (Jurídico)"
    roles: ["Advogado", "Analista Jurídico"]

  - codigo: "aditivos.approve_level3"
    descricao: "Aprovar Nível 3 (Diretoria)"
    roles: ["CFO", "Controller", "Diretor"]

  - codigo: "aditivos.docusign"
    descricao: "Enviar DocuSign"
    roles: ["Administrador", "Jurídico"]

  - codigo: "aditivos.restore_version"
    descricao: "Restaurar versão"
    roles: ["Administrador"]

  - codigo: "templates.manage"
    descricao: "Gerenciar templates cláusulas"
    roles: ["Advogado", "Administrador"]

  - codigo: "aditivos.export"
    descricao: "Exportar dashboard"
    roles: ["Gestor", "Administrador", "Diretor"]

# ==============================================================================
# INTEGRAÇÕES OBRIGATÓRIAS
# ==============================================================================

integracoes_obrigatorias:
  - integracao: "i18n"
    descricao: "Internacionalização"
    detalhes:
      - "Suporte pt-BR (padrão), en, es"
      - "Chaves de tradução para todos os textos UI"
      - "Formatação monetária, datas e números por locale"

  - integracao: "auditoria"
    descricao: "Auditoria automática"
    detalhes:
      - "Interceptor automático registra todas operações CRUD"
      - "Campos: DataCriacao, UsuarioCriacao, DataModificacao, UsuarioModificacao"
      - "Tabela Aditivo_Auditoria_Log preservada indefinidamente"
      - "Compliance: SOX, LGPD"

  - integracao: "central_funcionalidades"
    descricao: "Central de Funcionalidades"
    detalhes:
      - "Registrar feature 'Gestão de Aditivos' com flag ON/OFF"
      - "Desabilitar funcionalidade se flag OFF (HTTP 503)"

  - integracao: "notificacoes"
    descricao: "Sistema de Notificações"
    detalhes:
      - "Email via SendGrid"
      - "Push notifications via SignalR"
      - "In-app notifications via hub"

  - integracao: "azure_blob_storage"
    descricao: "Armazenamento de documentos"
    detalhes:
      - "Hot tier: Documentos vigentes"
      - "Cool tier: Documentos históricos (>1 ano)"
      - "Retention policy: 7 anos para docs cancelados"

  - integracao: "docusign"
    descricao: "Assinatura digital"
    detalhes:
      - "Integração via webhook para callback assinatura"
      - "Certificado digital incluído no PDF"
      - "Rastreamento status envelope"

  - integracao: "azure_form_recognizer"
    descricao: "OCR de documentos"
    detalhes:
      - "Extração automática de dados de PDFs/imagens"
      - "Precisão mínima 95%"
      - "Validação cruzada com dados cadastrados"

  - integracao: "api_banco_central"
    descricao: "Consulta índices econômicos"
    detalhes:
      - "Consulta IPCA, IGP-M, IPC"
      - "Timeout 5 segundos"
      - "Retry policy 3 tentativas"

  - integracao: "ml_net"
    descricao: "Machine Learning"
    detalhes:
      - "Modelo previsão renovação automática"
      - "Retreinamento mensal com novos dados"
      - "Precisão mínima 70%"

  - integracao: "sistema_juridico_externo"
    descricao: "Sincronização com gestão jurídica"
    detalhes:
      - "API REST ou webhook"
      - "Sistemas: Projuris, Legal One, SAP ERP Legal"
      - "Retry policy Polly (3 tentativas)"
      - "Dead Letter Queue para falhas"

# ==============================================================================
# API ENDPOINTS
# ==============================================================================

api_endpoints:
  crud:
    - metodo: "POST"
      endpoint: "/api/v1/aditivos"
      descricao: "Criar aditivo (wizard)"
      permissao: "aditivos.create"
      payload: "CreateAditivoCommand"
      response: "Guid (Id do aditivo)"

    - metodo: "GET"
      endpoint: "/api/v1/aditivos"
      descricao: "Listar com paginação"
      permissao: "aditivos.view_any"
      query_params: ["page", "pageSize", "filter", "sort"]
      response: "PagedResult<AditivoDto>"

    - metodo: "GET"
      endpoint: "/api/v1/aditivos/{id}"
      descricao: "Buscar por ID"
      permissao: "aditivos.view"
      response: "AditivoDto"

    - metodo: "PUT"
      endpoint: "/api/v1/aditivos/{id}"
      descricao: "Atualizar (apenas rascunho)"
      permissao: "aditivos.update"
      payload: "UpdateAditivoCommand"
      response: "void"

    - metodo: "DELETE"
      endpoint: "/api/v1/aditivos/{id}"
      descricao: "Soft delete"
      permissao: "aditivos.delete"
      response: "void"

  workflow:
    - metodo: "POST"
      endpoint: "/api/v1/aditivos/{id}/enviar-aprovacao"
      descricao: "Inicia workflow"
      permissao: "aditivos.create"
      response: "void"

    - metodo: "POST"
      endpoint: "/api/v1/aditivos/{id}/aprovar"
      descricao: "Aprovar nível atual"
      permissao: "aditivos.approve_level1|level2|level3"
      payload: "AprovarAditivoCommand"
      response: "void"

    - metodo: "POST"
      endpoint: "/api/v1/aditivos/{id}/rejeitar"
      descricao: "Rejeitar com justificativa"
      permissao: "aditivos.approve_level1|level2|level3"
      payload: "RejeitarAditivoCommand"
      response: "void"

    - metodo: "POST"
      endpoint: "/api/v1/aditivos/{id}/docusign"
      descricao: "Enviar para assinatura"
      permissao: "aditivos.docusign"
      response: "string (Envelope ID)"

  impacto_financeiro:
    - metodo: "GET"
      endpoint: "/api/v1/aditivos/{id}/impacto"
      descricao: "Calcular impacto"
      permissao: "aditivos.view"
      response: "ImpactoFinanceiroDto"

    - metodo: "GET"
      endpoint: "/api/v1/aditivos/{id}/projecao"
      descricao: "Gráfico projeção 12 meses"
      permissao: "aditivos.view"
      response: "ProjecaoFinanceiraDto"

    - metodo: "POST"
      endpoint: "/api/v1/aditivos/{id}/recalcular"
      descricao: "Recalcular com novos parâmetros"
      permissao: "aditivos.update"
      payload: "RecalcularImpactoCommand"
      response: "ImpactoFinanceiroDto"

  versionamento:
    - metodo: "GET"
      endpoint: "/api/v1/contratos/{id}/versoes"
      descricao: "Listar versões contrato"
      permissao: "aditivos.view"
      response: "List<ContratoVersaoDto>"

    - metodo: "GET"
      endpoint: "/api/v1/contratos/{id}/versoes/comparar"
      descricao: "Diff visual"
      permissao: "aditivos.view"
      query_params: ["v1", "v2"]
      response: "DiffResultDto"

    - metodo: "POST"
      endpoint: "/api/v1/contratos/{id}/versoes/restaurar"
      descricao: "Restaurar versão"
      permissao: "aditivos.restore_version"
      payload: "RestaurarVersaoCommand"
      response: "void"

  documentos:
    - metodo: "POST"
      endpoint: "/api/v1/aditivos/{id}/documentos"
      descricao: "Upload documento"
      permissao: "aditivos.update"
      payload: "multipart/form-data"
      response: "Guid (Id do documento)"

    - metodo: "GET"
      endpoint: "/api/v1/aditivos/{id}/documentos"
      descricao: "Listar documentos"
      permissao: "aditivos.view"
      response: "List<DocumentoDto>"

    - metodo: "GET"
      endpoint: "/api/v1/aditivos/{id}/documentos/{docId}/ocr"
      descricao: "Dados extraídos OCR"
      permissao: "aditivos.view"
      response: "OcrResultDto"

  templates_clausulas:
    - metodo: "GET"
      endpoint: "/api/v1/templates-clausulas"
      descricao: "Library completa"
      permissao: "aditivos.view"
      query_params: ["categoria"]
      response: "List<ClausulaTemplateDto>"

    - metodo: "POST"
      endpoint: "/api/v1/templates-clausulas"
      descricao: "Criar template customizado"
      permissao: "templates.manage"
      payload: "CreateTemplateCommand"
      response: "Guid (Id do template)"

    - metodo: "PUT"
      endpoint: "/api/v1/templates-clausulas/{id}/aprovar"
      descricao: "Aprovação jurídico"
      permissao: "templates.manage"
      response: "void"

  dashboard:
    - metodo: "GET"
      endpoint: "/api/v1/aditivos/dashboard/pipeline"
      descricao: "Kanban pipeline"
      permissao: "aditivos.view_any"
      response: "PipelineDto"

    - metodo: "GET"
      endpoint: "/api/v1/aditivos/dashboard/kpis"
      descricao: "Métricas principais"
      permissao: "aditivos.view_any"
      response: "KpisDto"

    - metodo: "GET"
      endpoint: "/api/v1/aditivos/dashboard/vencimentos"
      descricao: "Alertas próximos 90 dias"
      permissao: "aditivos.view_any"
      response: "List<VencimentoDto>"

# ==============================================================================
# ARTEFATOS DERIVADOS
# ==============================================================================

artefatos_derivados:
  - tipo: "UC-RF027.md"
    descricao: "Casos de Uso (5 UCs obrigatórios)"
    obrigatorio: true

  - tipo: "MD-RF027.md"
    descricao: "Modelo de Dados (8 tabelas)"
    obrigatorio: true

  - tipo: "WF-RF027.md"
    descricao: "Wireframes (Wizard 5 etapas, Dashboard, Diff Visual)"
    obrigatorio: true

  - tipo: "TC-RF027-BACKEND.yaml"
    descricao: "Testes Backend (CRUD, Workflow, Cálculos)"
    obrigatorio: true

  - tipo: "TC-RF027-FRONTEND.yaml"
    descricao: "Testes Frontend (Wizard, Dashboard, Diff)"
    obrigatorio: true

  - tipo: "TC-RF027-SEGURANCA.yaml"
    descricao: "Testes Segurança (Multi-tenant, RBAC)"
    obrigatorio: true

  - tipo: "TC-RF027-E2E.yaml"
    descricao: "Testes E2E (Fluxo completo criação → aprovação → assinatura)"
    obrigatorio: true

# ==============================================================================
# DEPENDÊNCIAS
# ==============================================================================

dependencias:
  requisitos_funcionais:
    - documentacao_id: "RF-026"
      titulo: "Gestão de Contratos"
      tipo: "FORTE"
      descricao: "Aditivos vinculados a contratos base"

    - documentacao_id: "RF-028"
      titulo: "Gestão de SLA Operações"
      tipo: "MÉDIA"
      descricao: "Validação SLA em aditivos tipo 'Mudança SLA'"

  servicos_externos:
    - servico: "Azure Blob Storage"
      finalidade: "Armazenamento de documentos"
      criticidade: "ALTA"

    - servico: "DocuSign API"
      finalidade: "Assinatura digital"
      criticidade: "ALTA"

    - servico: "Azure Form Recognizer"
      finalidade: "OCR de documentos"
      criticidade: "MÉDIA"

    - servico: "API Banco Central"
      finalidade: "Consulta índices econômicos (IPCA, IGP-M)"
      criticidade: "MÉDIA"

    - servico: "Sistema Jurídico Externo"
      finalidade: "Sincronização com Projuris/Legal One/SAP"
      criticidade: "BAIXA"

    - servico: "SendGrid"
      finalidade: "Envio de emails"
      criticidade: "MÉDIA"

    - servico: "SignalR"
      finalidade: "Notificações em tempo real"
      criticidade: "BAIXA"

# ==============================================================================
# METADADOS DE MIGRAÇÃO
# ==============================================================================

metadados_migracao:
  total_regras_negocio: 15
  total_endpoints_api: 30
  total_permissoes_rbac: 12
  total_integracoes_obrigatorias: 10
  total_estados: 7
  total_eventos_dominio: 11
  total_tipos_aditivos: 8
  total_niveis_workflow: 3
  linhas_rf_md: 900
  linhas_rf_yaml: 1100
