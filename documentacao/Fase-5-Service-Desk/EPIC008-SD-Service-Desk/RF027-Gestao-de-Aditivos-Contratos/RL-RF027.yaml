rf_id: RF027
rf_title: Gestão de Aditivos de Contratos
versao_governanca: '2.0'
data_migracao: '2025-12-30'
autor: Agência ALC - alc.dev.br
referencias:
- id: LEG-RF027-001
  tipo: tela
  nome: Contrato\Aditivo.aspx
  caminho: D:\IC2\ic1_legado\IControlIT\IControlIT\Contrato\Aditivo.aspx
  descricao: 'Tela de cadastro/edição de aditivos de contratos usando ASP.NET Web
    Forms.

    Interface simples com 5 campos principais: Contrato Base (dropdown), Tipo Aditivo
    (texto livre),

    Número Aditivo (autoincremento inconsistente), Valor Alteração (textbox decimal
    sem contexto),

    Observação (textarea 200 chars).


    Problemas identificados:

    - Tipo Aditivo em texto livre causava 15+ variações ("Acréscimo", "Acrescimo",
    "acréscimo de linhas", etc)

    - Valor Alteração sem indicar se mensal/anual/total

    - Impacto financeiro calculado manualmente em Excel (4-6 horas de trabalho)

    - Workflow de aprovação via email (sem rastreabilidade)

    - Upload de documentos perdidos em rede compartilhada

    - Sem versionamento de aditivos (sobrescrevia dados do contrato original)

    '
  regras_implicitas:
  - Tipo Aditivo obrigatório no frontend mas backend aceitava NULL
  - Número Aditivo gerado por MAX(Id_Aditivo)+1 (não sequencial por contrato)
  - Valor Alteração validado apenas >0 no frontend (backend aceitava negativo)
  - Observação limitada a 200 caracteres (truncava sem avisar)
  - Upload apenas 1 documento PDF (outros formatos rejeitados silenciosamente)
  - Botão 'Salvar' sobrescrevia valores do contrato base (histórico perdido)
  destino: substituido
  justificativa: Tela completamente redesenhada em Angular 19 com wizard multi-step
    (5 etapas), validações progressivas, enum de 8 tipos de aditivos, cálculo automático
    de impacto financeiro (<5s), upload múltiplo com OCR, workflow BPM 3 níveis, versionamento
    semântico, auditoria completa
  rastreabilidade:
    documentacao_moderno: RF-027 - Seção 4 (12 Funcionalidades), Seção 5 (RN-RF027-001 a RN-RF027-015)
    uc_moderno: UC01-RF027 (Criar Aditivo Wizard), UC02-RF027 (Editar Aditivo), UC03-RF027
      (Aprovar Aditivo Multinível)
  migracao_moderna:
    componente_angular: aditivos-wizard-create.component.ts, aditivos-edit.component.ts,
      aditivos-approval.component.ts
    rota_frontend: /service-desk/contratos/:contratoId/aditivos/wizard, /service-desk/contratos/:contratoId/aditivos/edit/:id,
      /service-desk/contratos/:contratoId/aditivos/approve/:id
    endpoints_api: POST /api/v1/aditivos, PUT /api/v1/aditivos/{id}, POST /api/v1/aditivos/{id}/aprovar-nivel1
- id: LEG-RF027-002
  tipo: tela
  nome: Contrato\ListaAditivos.aspx
  caminho: D:\IC2\ic1_legado\IControlIT\IControlIT\Contrato\ListaAditivos.aspx
  descricao: 'Tela de listagem de aditivos usando GridView ASP.NET.

    Grid simples com 6 colunas: Número Aditivo, Tipo, Valor, Data, Status (texto livre),
    Ações (Editar/Excluir).


    Problemas identificados:

    - Sem paginação (carregava todos registros >3s para 500+ aditivos)

    - Filtro apenas por Contrato (dropdown)

    - Status em texto livre ("Pendente", "Aprovado", "Reprovado", "Em andamento",
    "Aguardando", etc - 10+ variações)

    - Exclusão física sem confirmação (perdida histórico)

    - Sem indicadores visuais de urgência (aditivos vencidos passavam despercebidos)

    - Ordenação apenas por Data (sem opção de ordenar por Status, Tipo, Valor)

    '
  regras_implicitas:
  - Listagem ordenada por Data DESC (fixo, não configurável)
  - Excluir executava DELETE físico sem validar vínculos
  - Status 'Aprovado' permitia edição (inconsistência)
  - Valor exibido sem formatação de moeda consistente
  - Tipo Aditivo truncado em 20 caracteres (grid limitado)
  destino: substituido
  justificativa: Tela redesenhada com DataTable Angular Material, paginação server-side,
    filtros avançados (Tipo enum, Status enum, Range de Valor, Range de Data, Texto),
    ordenação multi-coluna, indicadores visuais (badges coloridos por status, ícones
    de urgência), soft delete, actions menu contextual
  rastreabilidade:
    documentacao_moderno: 'RF-027 - Seção 4 (Funcionalidade 4: Listar Aditivos), RN-RF027-005
      (Paginação obrigatória), RN-RF027-015 (Soft delete)'
    uc_moderno: UC04-RF027 (Consultar Aditivos com Filtros Avançados)
  migracao_moderna:
    componente_angular: aditivos-list.component.ts, aditivos-filters.component.ts
    rota_frontend: /service-desk/contratos/:contratoId/aditivos, /service-desk/aditivos/global
    endpoints_api: GET /api/v1/aditivos (paginado), GET /api/v1/aditivos/filtros
- id: LEG-RF027-003
  tipo: webservice
  nome: WS_Aditivo.asmx
  caminho: D:\IC2\ic1_legado\IControlIT\WebServices\WS_Aditivo.asmx
  metodos:
  - nome: CriarAditivo
    parametros: idContrato (int), tipoAditivo (string), valorAlteracao (decimal),
      observacao (string)
    retorno: int (ID inserido)
    descricao: Criar aditivo básico. SEM validações de tipo (texto livre), SEM workflow
      de aprovação, SEM cálculo de impacto financeiro automático
  - nome: ListarAditivos
    parametros: idContrato (int)
    retorno: List<Aditivo>
    descricao: Listar aditivos de um contrato. SEM PAGINAÇÃO (retorna todos registros),
      SEM filtros, SEM ordenação configurável
  - nome: AprovarAditivo
    parametros: idAditivo (int), usuarioAprovador (string - texto livre)
    retorno: bool
    descricao: Aprovar aditivo SEM níveis de aprovação, SEM validação de permissão,
      SEM rastreabilidade de quem aprovou, SEM integração DocuSign
  descricao: 'Webservice SOAP para operações básicas de aditivos.


    Problemas identificados:

    - SOAP sem padrão REST (dificulta integração moderna)

    - Sem autenticação JWT (validação apenas por IP)

    - Sem versionamento de API (quebra compatibilidade)

    - Sem validações de enum (tipoAditivo texto livre)

    - Sem workflow de aprovação multinível

    - Sem integração Azure Blob Storage (documentos em rede)

    - Sem integração DocuSign (assinatura digital)

    - Sem cálculo automático de impacto financeiro

    - Sem OCR (extração manual de dados de documentos)

    - Sem ML para sugestão de renovação

    '
  destino: substituido
  justificativa: Webservices SOAP substituídos por REST API moderna com autenticação
    JWT, versionamento /api/v1/, validações FluentValidation, workflow BPM 3 níveis
    com DocuSign, cálculo automático impacto financeiro (<5s), upload Azure Blob com
    OCR, ML.NET para análise preditiva, paginação obrigatória, DTOs tipados
  rastreabilidade:
    documentacao_moderno: RF-027 - Seção 11 (30+ API Endpoints)
    endpoint_moderno: POST /api/v1/aditivos, GET /api/v1/aditivos, POST /api/v1/aditivos/{id}/aprovar-nivel1,
      POST /api/v1/aditivos/{id}/aprovar-nivel2, POST /api/v1/aditivos/{id}/aprovar-nivel3,
      POST /api/v1/aditivos/{id}/calcular-impacto, POST /api/v1/aditivos/{id}/upload-documento,
      POST /api/v1/aditivos/{id}/extrair-dados-ocr
  migracao_moderna:
    command_cqrs: CreateAditivoCommand, ApproveAditivoLevel1Command, ApproveAditivoLevel2Command,
      ApproveAditivoLevel3Command, CalculateImpactoFinanceiroCommand, UploadDocumentoCommand
    handler: CreateAditivoCommandHandler, ApproveAditivoLevel1CommandHandler, CalculateImpactoFinanceiroCommandHandler
    query_cqrs: GetAditivosQuery, GetAditivoByIdQuery, GetAditivosPendentesAprovacaoQuery
- id: LEG-RF027-004
  tipo: stored_procedure
  nome: sp_InserirAditivo
  caminho: Database\Procedures\sp_InserirAditivo.sql
  parametros_entrada:
  - '@IdContrato INT'
  - '@TipoAditivo VARCHAR(100)'
  - '@ValorAlteracao DECIMAL(18,2)'
  - '@Observacao VARCHAR(200)'
  - '@DataCadastro DATETIME'
  parametros_saida:
  - '@IdAditivo INT OUTPUT'
  descricao: 'Stored procedure para inserir aditivo básico.

    Executava INSERT direto em Contrato_Aditivo sem:

    - Validar tipo de aditivo (enum)

    - Validar valor de alteração (range, contexto mensal/anual)

    - Calcular impacto financeiro no contrato base

    - Gerar número de aditivo sequencial por contrato (usava IDENTITY global)

    - Validar permissões do usuário

    - Iniciar workflow de aprovação

    - Registrar auditoria


    Retornava ID gerado via SCOPE_IDENTITY().

    '
  destino: substituido
  justificativa: Lógica movida para Application Layer (CQRS Handler) com validações
    completas (FluentValidation), cálculo automático de impacto financeiro, geração
    de número sequencial por contrato, workflow BPM, auditoria completa
  rastreabilidade:
    documentacao_moderno: RF-027 - RN-RF027-001 (8 Tipos de Aditivos validados), RN-RF027-002
      (Wizard Multi-Step), RN-RF027-003 (Número sequencial), RN-RF027-004 (Cálculo
      automático <5s), RN-RF027-008 (Workflow 3 níveis)
    regra_moderna: RN-RF027-001, RN-RF027-002, RN-RF027-003, RN-RF027-004, RN-RF027-008
  migracao_moderna:
    handler: CreateAditivoCommandHandler
    validacao: CreateAditivoCommandValidator (FluentValidation)
- id: LEG-RF027-005
  tipo: stored_procedure
  nome: sp_AprovarAditivo
  caminho: Database\Procedures\sp_AprovarAditivo.sql
  parametros_entrada:
  - '@IdAditivo INT'
  - '@UsuarioAprovador VARCHAR(100)'
  - '@DataAprovacao DATETIME'
  parametros_saida: []
  descricao: 'Stored procedure para aprovar aditivo.

    Executava UPDATE direto em Contrato_Aditivo (campo Status = ''Aprovado'') sem:

    - Níveis de aprovação (Gestor → Jurídico → Diretoria)

    - Validação de permissão do usuário

    - Rastreabilidade de quem aprovou em cada nível

    - Sobrescrever valores no contrato base (perda de histórico)

    - Integração DocuSign para assinatura digital

    - Auditoria completa (quem, quando, IP, payload antes/depois)

    - Notificação automática para próximo aprovador

    - Cálculo de data efetiva de vigência


    Após aprovação, outra SP (sp_AtualizarContratoBase) sobrescrevia valores do contrato
    original.

    '
  destino: substituido
  justificativa: 'Lógica movida para Application Layer com workflow BPM 3 níveis (Commands
    separados: ApproveLevel1, ApproveLevel2, ApproveLevel3), validação RBAC (aditivos.approve_level1/2/3),
    integração DocuSign, auditoria completa, versionamento semântico do contrato (v1.0
    → v1.1 ou v2.0), notificações automáticas'
  rastreabilidade:
    documentacao_moderno: RF-027 - RN-RF027-008 (Workflow 3 níveis BPM), RN-RF027-009 (Versionamento
      semântico), RN-RF027-011 (Integração DocuSign), RN-RF027-015 (Auditoria completa)
    regra_moderna: RN-RF027-008, RN-RF027-009, RN-RF027-011, RN-RF027-015
  migracao_moderna:
    handler: ApproveAditivoLevel1CommandHandler, ApproveAditivoLevel2CommandHandler,
      ApproveAditivoLevel3CommandHandler
    auditoria: AditivoHistorico (registra payload_antes, payload_depois, nivel_aprovacao,
      aprovador_id, timestamp, ip_address)
- id: LEG-RF027-006
  tipo: stored_procedure
  nome: sp_AtualizarContratoBase
  caminho: Database\Procedures\sp_AtualizarContratoBase.sql
  parametros_entrada:
  - '@IdContrato INT'
  - '@ValorAlteracao DECIMAL(18,2)'
  - '@TipoAlteracao VARCHAR(50)'
  parametros_saida: []
  descricao: 'Stored procedure que SOBRESCREVIA valores do contrato base após aprovação
    de aditivo.


    PROBLEMA CRÍTICO:

    - Executava UPDATE direto em Contrato (tabela principal)

    - PERDIA HISTÓRICO: valor anterior era sobrescrito sem backup

    - Impossibilidade de auditoria: não sabia valores antes do aditivo

    - Compliance violado: não atendia retenção de 7 anos de histórico

    - Relatórios inconsistentes: contratos mostravam apenas valor atual

    - Impossibilidade de rollback: se aditivo fosse cancelado, valor original perdido


    Tipos de alteração suportados (hardcoded):

    - "ACRESCIMO_VALOR": Contrato.Valor += ValorAlteracao

    - "SUPRESSAO_VALOR": Contrato.Valor -= ValorAlteracao

    - "PRORROGACAO": Contrato.DataFim += DATEADD(MONTH, ValorAlteracao, DataFim)

    - Outros tipos eram ignorados silenciosamente

    '
  destino: descartado
  justificativa: 'Lógica de sobrescrever contrato base COMPLETAMENTE DESCARTADA no
    sistema moderno. Decisão de modernização: manter versionamento semântico (v1.0
    → v1.1 → v2.0), tabela ContratoVersao para histórico completo, cálculo de valores
    atuais por agregação de aditivos, auditoria 100%, possibilidade de rollback, compliance
    fiscal garantido'
  rastreabilidade:
    documentacao_moderno: 'RF-027 - RN-RF027-009 (Versionamento semântico), RN-RF027-014 (Valores
      atuais por agregação), RN-RF027-015 (Auditoria completa), Seção 6.7 (Decisão
      MD-007: NUNCA sobrescrever contrato base)'
    md_moderno: MD-RF027.md - Entidade ContratoVersao, Decisão MD-007
  migracao_moderna:
    tabela_moderna: ContratoVersao (versionamento semântico completo)
    query_agregacao: CalcularValorAtualContratoQuery (soma valor_base + SUM(aditivos
      aprovados))
    auditoria: ContratoHistorico + AditivoHistorico (histórico completo sem perda)
- id: LEG-RF027-007
  tipo: tabela
  nome: Contrato_Aditivo
  schema_legado: '[dbo].[Contrato_Aditivo]'
  colunas_principais:
  - Id_Aditivo INT PRIMARY KEY IDENTITY
  - Id_Contrato INT
  - Tipo_Aditivo VARCHAR(100)
  - Valor_Alteracao DECIMAL(18,2)
  - Numero_Aditivo INT
  - Observacao VARCHAR(200)
  - Status VARCHAR(50)
  - Data_Cadastro DATETIME
  - Usuario_Cadastro VARCHAR(100)
  problemas_identificados:
  - Sem FK para Id_Contrato (não valida tenant, permite aditivo órfão)
  - Tipo_Aditivo VARCHAR(100) texto livre (15+ variações inconsistentes)
  - Valor_Alteracao sem contexto (mensal? anual? total?)
  - Numero_Aditivo INT não sequencial por contrato (usava IDENTITY global)
  - 'Status VARCHAR(50) texto livre (10+ variações: Pendente, Aprovado, Em andamento,
    etc)'
  - Sem campos de auditoria completa (apenas Data_Cadastro, sem LastModified, sem
    IP, sem payload antes/depois)
  - Sem versionamento (sobrescrevia contrato base, perdia histórico)
  - Sem workflow (não rastreava níveis de aprovação Gestor → Jurídico → Diretoria)
  - Sem validação UNIQUE para Numero_Aditivo por contrato (permitia duplicatas)
  - Sem soft delete (FL_Excluido ou IsDeleted)
  - Sem campos de impacto financeiro calculado (ImpactoValorMensal, ImpactoValorAnual,
    ImpactoPercentual)
  - Sem integração DocuSign (campo AssinaturaDigitalUrl, DocuSignEnvelopeId)
  - Sem armazenamento de documentos (Azure Blob Storage URL)
  - Sem campos de OCR (DadosExtraidosOCR JSON)
  - Sem campos de ML (SugestaoRenovacao, ScoreRisco)
  destino: substituido
  justificativa: Tabela redesenhada com multi-tenancy rigoroso (TenantId FK), enum
    de 8 tipos de aditivos, versionamento semântico, workflow 3 níveis rastreado,
    auditoria completa, soft delete, campos de impacto financeiro calculado, integração
    DocuSign, Azure Blob Storage, OCR, ML.NET, UNIQUE constraint (Numero, ContratoId)
  rastreabilidade:
    documentacao_moderno: RF-027 - Seção 7 (Modelo de Dados)
    md_moderno: MD-RF027.md - Entidade Aditivo
  migracao_moderna:
    tabela_moderna: Aditivo
    migration_ef_core: 20251230_CreateAditivoTable.cs
    mudancas_estruturais:
    - Id_Aditivo INT → Id UNIQUEIDENTIFIER
    - Id_Contrato INT → ContratoId UNIQUEIDENTIFIER NOT NULL (FK RESTRICT)
    - 'Adicionado: TenantId UNIQUEIDENTIFIER NOT NULL (FK, multi-tenancy)'
    - 'Tipo_Aditivo VARCHAR(100) → Tipo NVARCHAR(50) NOT NULL (Enum: ACRESCIMO_LINHAS,
      SUPRESSAO_LINHAS, PRORROGACAO_PRAZO, REAJUSTE_VALOR, ALTERACAO_SERVICO, ALTERACAO_FORNECEDOR,
      TRANSFERENCIA_TITULARIDADE, RESCISAO_PARCIAL)'
    - Valor_Alteracao DECIMAL(18,2) → ValorAlteracao DECIMAL(18,2) NOT NULL + ContextoValor
      NVARCHAR(50) (MENSAL, ANUAL, TOTAL)
    - Numero_Aditivo INT → Numero INT NOT NULL (sequencial por contrato, UNIQUE (Numero,
      ContratoId))
    - 'Adicionado: Versao NVARCHAR(20) (ex: ''v1.1'', ''v2.0'' - versionamento semântico)'
    - 'Status VARCHAR(50) → Status NVARCHAR(50) NOT NULL (Enum: RASCUNHO, PENDENTE_APROVACAO_NIVEL1,
      PENDENTE_APROVACAO_NIVEL2, PENDENTE_APROVACAO_NIVEL3, APROVADO, REJEITADO, CANCELADO)'
    - 'Adicionado: WorkflowNivelAtual INT DEFAULT 0 (0=rascunho, 1=gestor, 2=juridico,
      3=diretoria)'
    - 'Adicionado: AprovadorNivel1Id UNIQUEIDENTIFIER, DataAprovacaoNivel1 DATETIME2'
    - 'Adicionado: AprovadorNivel2Id UNIQUEIDENTIFIER, DataAprovacaoNivel2 DATETIME2'
    - 'Adicionado: AprovadorNivel3Id UNIQUEIDENTIFIER, DataAprovacaoNivel3 DATETIME2'
    - Observacao VARCHAR(200) → Justificativa NVARCHAR(2000) NOT NULL
    - Data_Cadastro DATETIME → Created DATETIME2 NOT NULL
    - Usuario_Cadastro VARCHAR(100) → CreatedBy UNIQUEIDENTIFIER NOT NULL (FK User)
    - 'Adicionado: LastModified DATETIME2, LastModifiedBy UNIQUEIDENTIFIER'
    - 'Adicionado: IsDeleted BIT DEFAULT 0, DeletedAt DATETIME2, DeletedBy UNIQUEIDENTIFIER
      (soft delete)'
    - 'Adicionado: ImpactoValorMensal DECIMAL(18,2) (calculado automaticamente)'
    - 'Adicionado: ImpactoValorAnual DECIMAL(18,2) (calculado automaticamente)'
    - 'Adicionado: ImpactoPercentual DECIMAL(5,2) (calculado automaticamente)'
    - 'Adicionado: DataEfetivaVigencia DATE (calculado após aprovação final)'
    - 'Adicionado: DocumentosUrl NVARCHAR(MAX) (JSON array de Azure Blob Storage URLs)'
    - 'Adicionado: DocuSignEnvelopeId NVARCHAR(100)'
    - 'Adicionado: AssinaturaDigitalUrl NVARCHAR(500)'
    - 'Adicionado: DadosExtraidosOCR NVARCHAR(MAX) (JSON)'
    - 'Adicionado: SugestaoRenovacao BIT, ScoreRisco DECIMAL(3,2) (ML.NET)'
  caminho: '[dbo].[Contrato_Aditivo]'
- id: LEG-RF027-008
  tipo: tabela
  nome: Aditivo_Documento (NÃO EXISTIA)
  schema_legado: 'null'
  descricao: 'Tabela NÃO EXISTIA no sistema legado.

    Documentos de aditivos eram armazenados em rede compartilhada

    (caminho: \\FileServer\IControlIT\Contratos\Aditivos\{IdContrato}\{IdAditivo}\).


    Problemas:

    - Documentos perdidos (rede compartilhada sem backup adequado)

    - Sem versionamento de documentos

    - Sem hash para integridade

    - Sem OCR para extração de dados

    - Sem integração DocuSign para assinatura digital

    - Sem metadados (tipo de documento, data vencimento, responsável)

    - Sem auditoria de acesso (quem baixou, quando)

    - Sem controle de permissões (qualquer usuário com acesso à rede podia ver/deletar)

    '
  destino: a_revisar
  justificativa: Nova entidade criada para gestão de documentos obrigatórios com Azure
    Blob Storage (tiers Hot/Cool), hash SHA-256 para integridade, OCR com Azure Form
    Recognizer, integração DocuSign, metadados completos, auditoria de acesso, controle
    de permissões RBAC, versionamento de documentos
  rastreabilidade:
    documentacao_moderno: RF-027 - RN-RF027-006 (Upload múltiplo, OCR, hash SHA-256), RN-RF027-011
      (Integração DocuSign), RN-RF027-012 (Azure Blob Storage), Seção 10.2 (Integração
      Azure Blob Storage), Seção 10.7 (Integração Azure Form Recognizer)
    md_moderno: MD-RF027.md - Entidade AditivoDocumento
  migracao_moderna:
    tabela_moderna: AditivoDocumento
    migration_ef_core: 20251230_CreateAditivoDocumentoTable.cs
    colunas:
    - Id UNIQUEIDENTIFIER PRIMARY KEY
    - AditivoId UNIQUEIDENTIFIER NOT NULL (FK)
    - TenantId UNIQUEIDENTIFIER NOT NULL (FK, multi-tenancy)
    - 'TipoDocumento NVARCHAR(100) NOT NULL (Enum: ADITIVO_ASSINADO, TERMO_ADITIVO,
      ANEXO_TECNICO, PROPOSTA_COMERCIAL, PARECER_JURIDICO, ATA_REUNIAO, COMPROVANTE_PAGAMENTO,
      OUTRO)'
    - NomeArquivo NVARCHAR(200) NOT NULL
    - BlobStorageUrl NVARCHAR(500) NOT NULL (Azure Blob Storage URL)
    - BlobStorageContainer NVARCHAR(100) NOT NULL (hot/cool tier)
    - HashSHA256 NVARCHAR(64) NOT NULL (integridade)
    - TamanhoBytes BIGINT NOT NULL
    - MimeType NVARCHAR(100) NOT NULL
    - Versao INT DEFAULT 1 (versionamento de documentos)
    - DadosExtraidosOCR NVARCHAR(MAX) (JSON, Azure Form Recognizer)
    - DocuSignEnvelopeId NVARCHAR(100) (integração DocuSign)
    - DataAssinatura DATETIME2 (se aplicável)
    - AssinadoPor UNIQUEIDENTIFIER (FK User, se aplicável)
    - Observacao NVARCHAR(1000)
    - Created DATETIME2 NOT NULL
    - CreatedBy UNIQUEIDENTIFIER NOT NULL (FK User)
    - LastModified DATETIME2
    - LastModifiedBy UNIQUEIDENTIFIER
    - IsDeleted BIT DEFAULT 0
    - DeletedAt DATETIME2
    - DeletedBy UNIQUEIDENTIFIER
  caminho: 'null'
- id: LEG-RF027-009
  tipo: tabela
  nome: Aditivo_Historico (NÃO EXISTIA COMPLETO)
  schema_legado: null (auditoria parcial inconsistente)
  descricao: 'Auditoria parcial e inconsistente no legado.

    Algumas operações eram auditadas em tabela genérica Log_Sistema (formato inconsistente):

    - Criação de aditivo: auditada (às vezes)

    - Aprovação: auditada (às vezes) - sem rastrear níveis

    - Edição: raramente auditada

    - Exclusão: NUNCA auditada

    - Upload de documentos: NUNCA auditado

    - Cálculo de impacto: NUNCA auditado


    Campos inconsistentes:

    - Ora registrava JSON (parcial, sem schema definido)

    - Ora registrava apenas "Aditivo X aprovado por Usuário Y"

    - Sem payload_antes / payload_depois estruturado

    - Sem IP address

    - Sem campos_alterados (diff)

    - Sem retenção 7 anos (dados antigos deletados manualmente)

    '
  destino: a_revisar
  justificativa: Tabela de auditoria padronizada para compliance fiscal (retenção
    7 anos, LGPD Art. 16), rastreabilidade completa de operações (CREATE/UPDATE/DELETE/APPROVE_L1/APPROVE_L2/APPROVE_L3/REJECT/CANCEL/UPLOAD_DOC/CALCULATE_IMPACT/SIGN_DOCUSIGN/OCR_EXTRACT),
    payload_antes/payload_depois em JSON, campos_alterados (diff Myers' Algorithm),
    IP address, user agent, retenção automática 7 anos com Azure Blob Archive tier
  rastreabilidade:
    documentacao_moderno: RF-027 - RN-RF027-015 (Auditoria completa)
    md_moderno: MD-RF027.md - Entidade AditivoHistorico
  migracao_moderna:
    tabela_moderna: AditivoHistorico
    migration_ef_core: 20251230_CreateAditivoHistoricoTable.cs
    colunas:
    - Id UNIQUEIDENTIFIER PRIMARY KEY
    - AditivoId UNIQUEIDENTIFIER NOT NULL (FK)
    - TenantId UNIQUEIDENTIFIER NOT NULL (FK, multi-tenancy)
    - 'Operacao NVARCHAR(50) NOT NULL (Enum: CREATE, UPDATE, DELETE, APPROVE_L1, APPROVE_L2,
      APPROVE_L3, REJECT, CANCEL, UPLOAD_DOC, CALCULATE_IMPACT, SIGN_DOCUSIGN, OCR_EXTRACT)'
    - UsuarioId UNIQUEIDENTIFIER NOT NULL (FK User)
    - Timestamp DATETIME2 NOT NULL
    - PayloadAntes NVARCHAR(MAX) (JSON - estado antes da operação)
    - PayloadDepois NVARCHAR(MAX) (JSON - estado depois da operação)
    - 'CamposAlterados NVARCHAR(500) (diff: campo1, campo2, campo3)'
    - IpAddress NVARCHAR(50)
    - UserAgent NVARCHAR(500)
    - DataRetencao DATETIME2 NOT NULL (Created + 7 anos, compliance fiscal)
  caminho: null (auditoria parcial inconsistente)
- id: LEG-RF027-010
  tipo: tabela
  nome: ContratoVersao (NÃO EXISTIA)
  schema_legado: 'null'
  descricao: 'Tabela NÃO EXISTIA no sistema legado.

    Versionamento de contratos após aditivos era inexistente.


    Consequência:

    - Aditivo aprovado sobrescrevia valores do contrato base (sp_AtualizarContratoBase)

    - Histórico de versões perdido

    - Impossibilidade de auditoria (valor antes do aditivo não recuperável)

    - Impossibilidade de rollback (se aditivo fosse cancelado, valor original perdido)

    - Compliance violado (não atendia retenção de 7 anos de histórico de alterações
    contratuais)

    - Relatórios inconsistentes (contratos mostravam apenas valor atual, sem histórico
    de reajustes)

    - Impossibilidade de comparação (ex: "Qual era o valor do contrato em Jan/2023?")

    '
  destino: a_revisar
  justificativa: 'Nova entidade para versionamento semântico de contratos (v1.0 →
    v1.1 → v2.0). Decisão de arquitetura: NUNCA sobrescrever contrato base, manter
    histórico completo de versões, calcular valores atuais por agregação de aditivos,
    permitir rollback, garantir compliance fiscal (retenção 7 anos)'
  rastreabilidade:
    documentacao_moderno: 'RF-027 - RN-RF027-009 (Versionamento semântico), RN-RF027-014 (Valores
      atuais por agregação), Seção 6.7 (Decisão MD-007: NUNCA sobrescrever contrato
      base)'
    md_moderno: MD-RF027.md - Entidade ContratoVersao, Decisão MD-007
  migracao_moderna:
    tabela_moderna: ContratoVersao
    migration_ef_core: 20251230_CreateContratoVersaoTable.cs
    colunas:
    - Id UNIQUEIDENTIFIER PRIMARY KEY
    - ContratoId UNIQUEIDENTIFIER NOT NULL (FK)
    - TenantId UNIQUEIDENTIFIER NOT NULL (FK, multi-tenancy)
    - 'Versao NVARCHAR(20) NOT NULL (ex: ''v1.0'', ''v1.1'', ''v2.0'')'
    - 'TipoVersao NVARCHAR(50) NOT NULL (Enum: ORIGINAL, MINOR, MAJOR)'
    - AditivoId UNIQUEIDENTIFIER (FK - se versão foi criada por aditivo)
    - ValorMensal DECIMAL(18,2) NOT NULL (snapshot da versão)
    - ValorAnual DECIMAL(18,2) NOT NULL (snapshot da versão)
    - DataInicioVigencia DATE NOT NULL
    - DataFimVigencia DATE NOT NULL
    - Justificativa NVARCHAR(2000)
    - SnapshotContratoCompleto NVARCHAR(MAX) (JSON - todos campos do contrato nesta
      versão)
    - Created DATETIME2 NOT NULL
    - CreatedBy UNIQUEIDENTIFIER NOT NULL (FK User)
    - UNIQUE (ContratoId, Versao)
  caminho: 'null'
- id: LEG-RF027-011
  tipo: regra_negocio
  nome: Tipo Aditivo em texto livre (não documentado)
  localizacao_codigo: Contrato\Aditivo.aspx.vb - Método btnSalvar_Click, sp_InserirAditivo.sql
  descricao: 'Tipo de aditivo era armazenado em texto livre (VARCHAR(100)).

    Causava 15+ variações inconsistentes na base de dados:

    - "Acréscimo", "Acrescimo", "acréscimo de linhas", "Acréscimo Linhas"

    - "Supressão", "Supressao", "supressão de ativos", "Supressão Ativos"

    - "Prorrogação", "Prorrogacao", "prorrogação de prazo", "Prorrogação Prazo"

    - "Reajuste", "Reajuste Valor", "Reajuste de Valor", "Reajuste Anual"

    - "Alteração", "Alteracao", "Alteração de Serviço", "Alteração Servico"

    - E mais 10+ variações não padronizadas


    Consequências:

    - Filtros de relatórios falhavam (buscava "Acréscimo" mas tinha "Acrescimo")

    - Cálculos de impacto inconsistentes (lógica hardcoded em VB.NET para cada variação)

    - Impossibilidade de análise agregada (quantos aditivos de cada tipo? Impossível
    saber com precisão)

    - Novos tipos criados arbitrariamente por usuários (sem governança)

    '
  destino: substituido
  justificativa: 'Substituído por ENUM de 8 tipos padronizados (RN-RF027-001): ACRESCIMO_LINHAS,
    SUPRESSAO_LINHAS, PRORROGACAO_PRAZO, REAJUSTE_VALOR, ALTERACAO_SERVICO, ALTERACAO_FORNECEDOR,
    TRANSFERENCIA_TITULARIDADE, RESCISAO_PARCIAL. Validação backend FluentValidation,
    dropdown frontend tipado, impossibilidade de criar tipos fora do enum'
  rastreabilidade:
    documentacao_moderno: RF-027 - RN-RF027-001 (8 Tipos de Aditivos Suportados)
    regra_moderna: RN-RF027-001
  migracao_moderna:
    validador: CreateAditivoCommandValidator
    linha_codigo: 'RuleFor(x => x.Tipo).IsInEnum().WithMessage(''Tipo de aditivo inválido.
      Valores permitidos: ACRESCIMO_LINHAS, SUPRESSAO_LINHAS, ...'')'
    script_normalizacao: "-- Normalizar tipos legados para enum moderno\nUPDATE Aditivo\
      \ SET Tipo =\n  CASE\n    WHEN Tipo_Aditivo LIKE '%acr%sc%' OR Tipo_Aditivo\
      \ LIKE '%Acr%sc%' THEN 'ACRESCIMO_LINHAS'\n    WHEN Tipo_Aditivo LIKE '%supress%'\
      \ OR Tipo_Aditivo LIKE '%Supress%' THEN 'SUPRESSAO_LINHAS'\n    WHEN Tipo_Aditivo\
      \ LIKE '%prorrog%' OR Tipo_Aditivo LIKE '%Prorrog%' THEN 'PRORROGACAO_PRAZO'\n\
      \    WHEN Tipo_Aditivo LIKE '%reajust%' OR Tipo_Aditivo LIKE '%Reajust%' THEN\
      \ 'REAJUSTE_VALOR'\n    WHEN Tipo_Aditivo LIKE '%altera%' AND Tipo_Aditivo LIKE\
      \ '%servi%' THEN 'ALTERACAO_SERVICO'\n    WHEN Tipo_Aditivo LIKE '%altera%'\
      \ AND Tipo_Aditivo LIKE '%fornec%' THEN 'ALTERACAO_FORNECEDOR'\n    WHEN Tipo_Aditivo\
      \ LIKE '%transfer%' OR Tipo_Aditivo LIKE '%titular%' THEN 'TRANSFERENCIA_TITULARIDADE'\n\
      \    WHEN Tipo_Aditivo LIKE '%rescis%' THEN 'RESCISAO_PARCIAL'\n    ELSE 'ALTERACAO_SERVICO'\
      \ -- Fallback para tipos desconhecidos\n  END\n"
  caminho: Contrato\Aditivo.aspx.vb - Método btnSalvar_Click, sp_InserirAditivo.sql
- id: LEG-RF027-012
  tipo: regra_negocio
  nome: Aprovação sem níveis (não documentado)
  localizacao_codigo: sp_AprovarAditivo.sql, WS_Aditivo.asmx.vb - Método AprovarAditivo
  descricao: 'Aprovação de aditivo era binária: Pendente → Aprovado (único passo).

    Não havia workflow de aprovação multinível (Gestor → Jurídico → Diretoria).


    Processo legado:

    1. Usuário criava aditivo (Status = ''Pendente'')

    2. Qualquer usuário com permissão "Aprovar" podia aprovar direto (sem níveis)

    3. Status mudava para ''Aprovado''

    4. sp_AtualizarContratoBase sobrescrevia valores do contrato base


    Problemas:

    - Aditivos de alto valor (>R$ 100k) aprovados sem revisão jurídica/diretoria

    - Sem rastreabilidade de quem aprovou em cada nível

    - Sem notificação automática para próximo aprovador

    - Sem integração DocuSign (assinatura digital)

    - Sem validação de permissão por nível (qualquer aprovador podia aprovar qualquer
    aditivo)

    '
  destino: substituido
  justificativa: 'Substituído por workflow BPM 3 níveis (RN-RF027-008): Gestor (Nível
    1) → Jurídico (Nível 2) → Diretoria (Nível 3). Cada nível tem permissão específica
    (aditivos.approve_level1/2/3), rastreabilidade completa (quem, quando, IP), notificações
    automáticas (email + push), integração DocuSign para assinatura digital em cada
    nível'
  rastreabilidade:
    documentacao_moderno: RF-027 - RN-RF027-008 (Workflow 3 níveis BPM)
    regra_moderna: RN-RF027-008
  migracao_moderna:
    handler: ApproveAditivoLevel1CommandHandler, ApproveAditivoLevel2CommandHandler,
      ApproveAditivoLevel3CommandHandler
    permissoes: aditivos.approve_level1 (Gestor), aditivos.approve_level2 (Jurídico),
      aditivos.approve_level3 (Diretoria)
    linha_codigo: '// Validação de permissão por nível

      [Authorize(Roles = "Gestor")]

      public record ApproveAditivoLevel1Command(Guid AditivoId) : IRequest;


      [Authorize(Roles = "Jurídico")]

      public record ApproveAditivoLevel2Command(Guid AditivoId) : IRequest;


      [Authorize(Roles = "Diretoria")]

      public record ApproveAditivoLevel3Command(Guid AditivoId) : IRequest;

      '
  caminho: sp_AprovarAditivo.sql, WS_Aditivo.asmx.vb - Método AprovarAditivo
- id: LEG-RF027-013
  tipo: regra_negocio
  nome: Número de aditivo não sequencial por contrato (não documentado)
  localizacao_codigo: sp_InserirAditivo.sql, Contrato\Aditivo.aspx.vb
  descricao: 'Número de aditivo era gerado usando IDENTITY global (não sequencial
    por contrato).


    Exemplo problemático:

    - Contrato 1001: Aditivo #1 (Id_Aditivo 500), Aditivo #2 (Id_Aditivo 507), Aditivo
    #3 (Id_Aditivo 512)

    - Contrato 1002: Aditivo #1 (Id_Aditivo 501), Aditivo #2 (Id_Aditivo 508)


    Consequências:

    - Usuários confusos (Aditivo #507? É o 2º do contrato 1001)

    - Relatórios inconsistentes (ordenar por número de aditivo não funcionava)

    - Impossibilidade de identificar "1º Termo Aditivo", "2º Termo Aditivo" de forma
    clara

    - Documentação legal confusa (termos aditivos devem ser sequenciais por contrato)

    '
  destino: substituido
  justificativa: 'Substituído por numeração sequencial por contrato (RN-RF027-003):
    Numero INT NOT NULL com UNIQUE (Numero, ContratoId). Gerado automaticamente por
    MAX(Numero WHERE ContratoId = X) + 1. Frontend exibe ''Aditivo #1'', ''Aditivo
    #2'', etc (sequencial claro)'
  rastreabilidade:
    documentacao_moderno: RF-027 - RN-RF027-003 (Número sequencial por contrato)
    regra_moderna: RN-RF027-003
  migracao_moderna:
    handler: CreateAditivoCommandHandler
    linha_codigo: "// Gerar número sequencial por contrato\nvar proximoNumero = await\
      \ _context.Aditivos\n  .Where(a => a.ContratoId == command.ContratoId && !a.IsDeleted)\n\
      \  .MaxAsync(a => (int?)a.Numero) ?? 0;\n\nvar aditivo = new Aditivo\n{\n  ContratoId\
      \ = command.ContratoId,\n  Numero = proximoNumero + 1,\n  // ...\n};\n"
  caminho: sp_InserirAditivo.sql, Contrato\Aditivo.aspx.vb
- id: LEG-RF027-014
  tipo: regra_negocio
  nome: Impacto financeiro calculado manualmente em Excel (não documentado)
  localizacao_codigo: Processo manual externo ao sistema
  descricao: 'Cálculo de impacto financeiro de aditivos era TOTALMENTE MANUAL.


    Processo legado:

    1. Usuário criava aditivo no sistema (valor básico)

    2. Baixava planilha Excel ("Modelo Impacto Aditivo.xlsx")

    3. Preenchia manualmente: valor contrato base, valor aditivo, tipo, prazo

    4. Excel calculava: impacto mensal, impacto anual, impacto percentual, data efetiva
    vigência

    5. Usuário COPIAVA valores calculados de volta para o sistema (campo Observação)

    6. Tempo médio: 4-6 horas por aditivo (dependendo complexidade)


    Problemas:

    - Processo lento e trabalhoso (4-6h)

    - Erros de digitação ao copiar valores do Excel

    - Fórmulas Excel corrompidas/desatualizadas (cada analista tinha versão diferente)

    - Impossibilidade de auditoria (não sabia qual fórmula foi usada)

    - Inconsistência de resultados (fórmulas diferentes = resultados diferentes)

    - Atraso na aprovação (aditivo ficava semanas parado aguardando cálculo)

    '
  destino: substituido
  justificativa: 'Substituído por motor de cálculo automático (RN-RF027-004): cálculo
    <5s via command CalculateImpactoFinanceiroCommand, fórmulas padronizadas no backend
    (C#), auditoria de cálculo (registra fórmula + inputs + outputs em AditivoHistorico),
    validação de regras (ex: acréscimo ≤25% do valor base), integração com API Banco
    Central para taxas de inflação/juros'
  rastreabilidade:
    documentacao_moderno: RF-027 - RN-RF027-004 (Cálculo automático impacto financeiro <5s)
    regra_moderna: RN-RF027-004
  migracao_moderna:
    handler: CalculateImpactoFinanceiroCommandHandler
    servico: ImpactoFinanceiroService (fórmulas padronizadas)
    linha_codigo: "public class CalculateImpactoFinanceiroCommandHandler : IRequestHandler<CalculateImpactoFinanceiroCommand,\
      \ ImpactoFinanceiroDto>\n{\n  public async Task<ImpactoFinanceiroDto> Handle(CalculateImpactoFinanceiroCommand\
      \ request, CancellationToken ct)\n  {\n    var contrato = await _context.Contratos.FindAsync(request.ContratoId);\n\
      \    var aditivo = await _context.Aditivos.FindAsync(request.AditivoId);\n\n\
      \    var impacto = _impactoFinanceiroService.Calcular(\n      valorBase: contrato.ValorMensal,\n\
      \      valorAditivo: aditivo.ValorAlteracao,\n      tipo: aditivo.Tipo,\n  \
      \    contexto: aditivo.ContextoValor\n    );\n\n    // Atualizar aditivo com\
      \ valores calculados\n    aditivo.ImpactoValorMensal = impacto.ValorMensal;\n\
      \    aditivo.ImpactoValorAnual = impacto.ValorAnual;\n    aditivo.ImpactoPercentual\
      \ = impacto.Percentual;\n\n    // Auditar cálculo\n    await _auditService.Registrar(new\
      \ AuditoriaCalculo\n    {\n      AditivoId = aditivo.Id,\n      Formula = impacto.FormulaUtilizada,\n\
      \      Inputs = impacto.InputsUtilizados,\n      Outputs = impacto.ResultadosCalculados,\n\
      \      TempoExecucao = impacto.TempoMs // <5000ms\n    });\n\n    return impacto;\n\
      \  }\n}\n"
  caminho: Processo manual externo ao sistema
- id: LEG-RF027-015
  tipo: regra_negocio
  nome: Status em texto livre (não documentado)
  localizacao_codigo: Contrato_Aditivo tabela, sp_AprovarAditivo.sql
  descricao: 'Status de aditivo armazenado em texto livre (VARCHAR(50)).

    Causava 10+ variações inconsistentes:

    - "Pendente", "Pendente Aprovação", "Pendente de Aprovação"

    - "Aprovado", "Aprovado pelo Gestor", "Aprovado Nível 1"

    - "Rejeitado", "Reprovado", "Negado"

    - "Em andamento", "Em Análise", "Aguardando Análise"

    - "Cancelado", "Cancelado pelo Usuário"

    - E mais 5+ variações não padronizadas


    Consequências:

    - Filtros de relatórios falhavam (buscava "Aprovado" mas tinha "Aprovado pelo
    Gestor")

    - Impossibilidade de análise agregada (quantos aditivos pendentes? Impossível
    saber com precisão)

    - Lógica de workflow inconsistente (hardcoded em VB.NET para cada variação)

    - Novos status criados arbitrariamente por usuários (sem governança)

    '
  destino: substituido
  justificativa: 'Substituído por ENUM de 7 status padronizados (RN-RF027-005): RASCUNHO,
    PENDENTE_APROVACAO_NIVEL1, PENDENTE_APROVACAO_NIVEL2, PENDENTE_APROVACAO_NIVEL3,
    APROVADO, REJEITADO, CANCELADO. Validação backend FluentValidation, impossibilidade
    de criar status fora do enum'
  rastreabilidade:
    documentacao_moderno: RF-027 - RN-RF027-005 (7 Estados de Aditivo)
    regra_moderna: RN-RF027-005
  migracao_moderna:
    validador: UpdateAditivoCommandValidator
    linha_codigo: 'RuleFor(x => x.Status).IsInEnum().WithMessage(''Status de aditivo
      inválido. Valores permitidos: RASCUNHO, PENDENTE_APROVACAO_NIVEL1, ...'')'
    script_normalizacao: "-- Normalizar status legados para enum moderno\nUPDATE Aditivo\
      \ SET Status =\n  CASE\n    WHEN Status LIKE '%rascun%' OR Status LIKE '%Rascun%'\
      \ THEN 'RASCUNHO'\n    WHEN Status LIKE '%pendent%' AND Status NOT LIKE '%nivel%'\
      \ THEN 'PENDENTE_APROVACAO_NIVEL1'\n    WHEN Status LIKE '%aprovad%' AND Status\
      \ NOT LIKE '%nivel%' THEN 'APROVADO'\n    WHEN Status LIKE '%rejeit%' OR Status\
      \ LIKE '%reprov%' OR Status LIKE '%negad%' THEN 'REJEITADO'\n    WHEN Status\
      \ LIKE '%cancel%' THEN 'CANCELADO'\n    ELSE 'PENDENTE_APROVACAO_NIVEL1' --\
      \ Fallback para status desconhecidos\n  END\n"
  caminho: Contrato_Aditivo tabela, sp_AprovarAditivo.sql
bancos_legados:
- nome: IControlIT_Cliente01
  servidor: SQL-LEGADO-01
  tabelas_relacionadas:
  - Contrato_Aditivo
  destino: CONSOLIDADO
  justificativa: Migrado para banco único com multi-tenancy (TenantId) usando Row-Level
    Security
  banco_moderno: IControlIT.db (SQLite dev) / SQL Server moderno (prod)
- nome: IControlIT_Cliente02
  servidor: SQL-LEGADO-01
  tabelas_relacionadas:
  - Contrato_Aditivo
  destino: CONSOLIDADO
  justificativa: Migrado para banco único com multi-tenancy (TenantId) usando Row-Level
    Security
  banco_moderno: IControlIT.db (SQLite dev) / SQL Server moderno (prod)
- nome: IControlIT_Cliente03
  servidor: SQL-LEGADO-02
  tabelas_relacionadas:
  - Contrato_Aditivo
  destino: CONSOLIDADO
  justificativa: Migrado para banco único com multi-tenancy (TenantId) usando Row-Level
    Security
  banco_moderno: IControlIT.db (SQLite dev) / SQL Server moderno (prod)
problemas_legado:
- id: PROB-RF027-001
  nome: Multi-database sem governança
  severidade: CRÍTICA
  descricao: 'Cada cliente tinha banco SQL Server separado (IControlIT_ClienteXX).

    Dificultava manutenção, backup, deploy, versionamento de schema.

    Scripts de migration tinham que rodar em 100+ bancos.

    '
  impacto: Operacional alto, custo de manutenção elevado, risco de inconsistência
    de schema
  solucao_moderna: Banco único com multi-tenancy via TenantId + Row-Level Security.
    Migration automática via EF Core.
- id: PROB-RF027-002
  nome: Sobrescrita de contrato base (perda de histórico)
  severidade: CRÍTICA
  descricao: 'sp_AtualizarContratoBase sobrescrevia valores do contrato original após
    aprovação de aditivo.

    PERDIA HISTÓRICO: valor anterior era sobrescrito sem backup.

    Violação de compliance fiscal (retenção 7 anos de histórico de alterações contratuais).

    Impossibilidade de auditoria (não sabia valores antes do aditivo).

    Impossibilidade de rollback (se aditivo fosse cancelado, valor original perdido).

    '
  impacto: Compliance violado, auditoria impossível, histórico perdido, risco legal
    alto
  solucao_moderna: Versionamento semântico (v1.0 → v1.1 → v2.0) com tabela ContratoVersao.
    NUNCA sobrescrever contrato base. Valores atuais calculados por agregação de aditivos.
    Auditoria completa com retenção 7 anos.
- id: PROB-RF027-003
  nome: Código misturado em code-behind VB.NET
  severidade: ALTA
  descricao: 'Lógica de negócio misturada em arquivos .aspx.vb (code-behind).

    Dificultava testes unitários, reuso, manutenção.

    Validações ora no frontend, ora no backend, ora ausentes.

    '
  impacto: Qualidade de código baixa, dívida técnica alta, bugs recorrentes
  solucao_moderna: Clean Architecture + CQRS. Lógica de negócio em Handlers (Application
    Layer), validações em Validators (FluentValidation), separação clara backend/frontend.
- id: PROB-RF027-004
  nome: Webservices SOAP sem padrão REST
  severidade: ALTA
  descricao: 'Webservices ASMX (SOAP) dificultavam integração moderna.

    Sem versionamento de API, sem paginação, sem autenticação JWT.

    Quebra de compatibilidade em cada mudança.

    '
  impacto: Dificulta integrações externas, performance ruim, falta de controle de
    versão
  solucao_moderna: REST API com versionamento /api/v1/, autenticação JWT Bearer, paginação
    obrigatória, DTOs tipados, HTTP status codes padronizados.
- id: PROB-RF027-005
  nome: Validações inconsistentes (texto livre em Tipo e Status)
  severidade: ALTA
  descricao: 'Tipo_Aditivo e Status armazenados em texto livre (VARCHAR).

    Causava 15+ variações em Tipo e 10+ em Status.

    Validação apenas no frontend (MaskedEditValidator).

    Backend aceitava valores inválidos ou duplicados.

    '
  impacto: Dados inconsistentes no banco, duplicatas, erros em relatórios, análise
    agregada impossível
  solucao_moderna: Validações sempre no backend (FluentValidation), ENUMs padronizados
    (8 tipos de aditivos, 7 status), frontend apenas UX.
- id: PROB-RF027-006
  nome: Workflow de aprovação inexistente
  severidade: ALTA
  descricao: 'Aprovação binária (Pendente → Aprovado) sem níveis.

    Aditivos de alto valor (>R$ 100k) aprovados sem revisão jurídica/diretoria.

    Sem rastreabilidade de quem aprovou em cada nível.

    Sem integração DocuSign (assinatura digital).

    '
  impacto: Risco legal alto, falta de governança, aditivos aprovados indevidamente
  solucao_moderna: Workflow BPM 3 níveis (Gestor → Jurídico → Diretoria), permissões
    específicas por nível (RBAC), rastreabilidade completa, integração DocuSign para
    assinatura digital em cada nível.
- id: PROB-RF027-007
  nome: Cálculo de impacto financeiro manual (4-6h por aditivo)
  severidade: ALTA
  descricao: 'Cálculo de impacto financeiro era TOTALMENTE MANUAL via Excel.

    Processo lento (4-6h), erros de digitação, fórmulas inconsistentes.

    Atraso na aprovação (aditivo ficava semanas parado aguardando cálculo).

    '
  impacto: Processo lento, erros frequentes, atraso na aprovação, custo operacional
    alto
  solucao_moderna: Motor de cálculo automático (<5s) via CalculateImpactoFinanceiroCommand,
    fórmulas padronizadas backend (C#), auditoria de cálculo, integração API Banco
    Central para taxas.
- id: PROB-RF027-008
  nome: Documentos perdidos em rede compartilhada
  severidade: MÉDIA
  descricao: 'Documentos de aditivos armazenados em rede compartilhada (\\FileServer\...).

    Sem versionamento, sem hash, sem OCR, sem integração DocuSign.

    Documentos perdidos (backup inadequado), sem auditoria de acesso.

    '
  impacto: Perda de documentos, risco legal, compliance violado, impossibilidade de
    auditoria
  solucao_moderna: Azure Blob Storage (tiers Hot/Cool), hash SHA-256 para integridade,
    OCR com Azure Form Recognizer, integração DocuSign, metadados completos, auditoria
    de acesso, controle de permissões RBAC.
- id: PROB-RF027-009
  nome: Auditoria parcial e inconsistente
  severidade: ALTA
  descricao: 'Algumas operações auditadas em Log_Sistema (inconsistente).

    Outras operações sem auditoria (edição, exclusão, upload documentos).

    Sem padrão de campos (ora JSON, ora texto livre).

    Sem retenção 7 anos (dados antigos deletados manualmente).

    '
  impacto: Não conformidade fiscal, impossibilidade de rastrear alterações, risco
    legal
  solucao_moderna: 'Auditoria completa padronizada em AditivoHistorico: todas operações
    (CREATE/UPDATE/DELETE/APPROVE_L1/L2/L3/REJECT/CANCEL/UPLOAD_DOC/CALCULATE_IMPACT/SIGN_DOCUSIGN/OCR_EXTRACT),
    payload_antes/payload_depois em JSON, campos_alterados (diff Myers'' Algorithm),
    IP address, user agent, retenção automática 7 anos com Azure Blob Archive tier.'
metadados:
  total_itens_legado: 15
  itens_assumidos: 0
  itens_substituidos: 11
  itens_descartados: 1
  itens_novos: 4
  itens_a_revisar: 0
  cobertura_destinos: 100%
  contagem_por_tipo:
    telas: 2
    webservices: 1
    stored_procedures: 3
    tabelas: 4
    regras_negocio: 5
    bancos_legados: 3
  problemas_criticos: 2
  problemas_altos: 6
  problemas_medios: 1
changelog:
- versao: '1.0'
  data: '2025-12-30'
  descricao: Criação inicial - Separação RF/RL na migração v1.0 → v2.0, 15 itens rastreados,
    100% com destino definido (11 SUBSTITUÍDOS, 1 DESCARTADO, 4 NOVOS)
  autor: Agência ALC - alc.dev.br
