# RF-027: Gestão de Aditivos de Contratos

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC008-SD-Service-Desk
**Fase**: Fase 5 - Service Desk

---

## 1. OBJETIVO DO REQUISITO

Fornecer sistema completo de gestão de aditivos contratuais para contratos de Telecom e TI, permitindo controle rigoroso de versões, workflow de aprovação multi-nível, cálculo automático de impacto financeiro, rastreamento de prazos, alertas de renovação automática e rastreabilidade jurídica completa.

Este documento define **o que o sistema deve fazer** em relação a criação, versionamento, aprovação, gestão documental e controle de aditivos contratuais, servindo como **contrato oficial** entre negócio, desenvolvimento, testes e agentes de IA.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Criação de aditivos em wizard multi-step (5 etapas)
- [x] Suporte a 8 tipos de aditivos (acréscimo/supressão linhas, alteração tarifária, prorrogação prazo, mudança SLA, inclusão/exclusão serviços, reajuste inflacionário, troca garantias)
- [x] Cálculo automático de impacto financeiro (mensal/anual/projeção 12 meses)
- [x] Versionamento completo de contratos (snapshot + diff visual)
- [x] Workflow de aprovação multi-nível (3 níveis configuráveis)
- [x] Library jurídica de cláusulas (50+ templates)
- [x] Gestão documental integrada (upload, OCR, versionamento, assinatura digital)
- [x] Alertas inteligentes de vencimento (90/60/30 dias + ML)
- [x] Dashboard pipeline de aditivos (Kanban + KPIs)
- [x] Comparação visual entre versões de contrato (diff engine)
- [x] Validação automática de datas e vigências
- [x] Isolamento multi-tenant obrigatório
- [x] Soft delete e auditoria completa
- [x] Cálculo automático de multas rescisórias
- [x] Integração com sistema jurídico externo

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (responsabilidade do frontend)
- Tecnologia, framework ou linguagem de implementação
- Layout, UX ou identidade visual
- Estratégia de deploy ou infraestrutura
- Gestão de contratos base (RF-026)
- Gestão de SLA operações (RF-028)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-----|---------|
| Aditivo | Modificação formal de contrato existente que altera condições originais (valores, prazos, serviços, SLAs) |
| Contrato Base | Contrato original ao qual aditivos são vinculados |
| Versão de Contrato | Snapshot completo do estado do contrato em determinado momento, gerado após cada aditivo aprovado |
| Wizard Multi-Step | Interface guiada em 5 etapas progressivas (Identificação → Dados → Impacto → Documentos → Revisão) |
| Impacto Financeiro | Diferença calculada automaticamente entre valor contrato antes e após aditivo (mensal/anual/projeção) |
| Workflow Aprovação | Processo multi-nível configurável (Gestor → Jurídico → Diretoria) com SLA e escalação |
| Library Jurídica | Conjunto de 50+ templates de cláusulas contratuais pré-aprovadas pelo departamento jurídico |
| Diff Engine | Motor de comparação que destaca visualmente diferenças entre versões de contrato (Myers' algorithm) |
| DocuSign | Plataforma de assinatura digital integrada para formalizar aditivos |
| OCR | Optical Character Recognition - extração automática de dados de PDFs/imagens (Azure Form Recognizer) |
| Tenant | Unidade lógica de isolamento de dados (ClienteId) |
| Soft Delete | Exclusão lógica via flag FlExcluido = TRUE (preserva auditoria) |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Criar Aditivo via Wizard**: Fluxo guiado 5 etapas com validações contextuais por tipo
2. **Calcular Impacto Financeiro**: Motor automático gera 4 métricas + gráfico waterfall
3. **Versionar Contratos**: Cada aditivo aprovado cria nova versão preservando histórico
4. **Aprovar via Workflow**: 3 níveis configuráveis (Gestor → Jurídico → Diretoria) com SLA e escalação
5. **Gerenciar Cláusulas**: Library 50+ templates + builder drag-and-drop
6. **Gerenciar Documentos**: Upload, OCR automático, versionamento, assinatura digital
7. **Alertar Vencimentos**: ML prevê renovação automática + alertas 90/60/30 dias
8. **Visualizar Pipeline**: Dashboard Kanban (Rascunho → Aprovação → Assinatura → Vigente → Encerrado)
9. **Comparar Versões**: Diff visual destaca cláusulas adicionadas/removidas/modificadas
10. **Validar Datas**: Validação automática vigência aditivo vs. contrato base
11. **Calcular Multas**: Cálculo automático multa rescisória em supressões dentro de fidelização
12. **Sincronizar Sistema Jurídico**: API REST ou webhook para sistemas externos (Projuris, Legal One, SAP)

---

## 5. REGRAS DE NEGÓCIO

### RN-RF027-001 — 8 Tipos de Aditivos Suportados

**Descrição**: Sistema DEVE suportar exatamente 8 tipos distintos de aditivos contratuais, cada um com wizard e validações específicas.

**Tipos Obrigatórios**:

1. **Acréscimo de Linhas/Ativos**: Adicionar linhas telefônicas, chips, equipamentos
   - Campos: Quantidade, Valor Unitário, Plano/Serviço, Data Ativação
   - Validação: Valor total ≤ 25% do valor contrato base (acima requer aprovação diretoria)

2. **Supressão de Linhas/Ativos**: Remover linhas/ativos (cancelamento parcial)
   - Campos: Linhas a remover, Motivo, Data Desligamento
   - Validação: Não pode suprimir >50% das linhas sem criar novo contrato
   - Cálculo Multa: Se supressão antes de fidelização, calcula multa automaticamente

3. **Alteração Tarifária**: Modificar valores sem alterar quantidade
   - Campos: Plano Original, Plano Novo, % Desconto Negociado
   - Comparação: Gráfico comparativo valor mensal antes/depois

4. **Prorrogação de Prazo**: Estender vigência do contrato
   - Campos: Nova Data Término, Mantém Condições Originais (Sim/Não)
   - Validação: Data término ≥ Data término atual + 1 mês

5. **Mudança de SLA**: Alterar acordos de nível serviço
   - Campos: SLA Atual, SLA Novo, Impacto Tarifário
   - Referência Cruzada: Validar contra RF-028 (Gestão SLA Operações)

6. **Inclusão de Novos Serviços**: Adicionar serviços não previstos
   - Campos: Descrição Serviço, Valor, Forma Cobrança (mensal/única)
   - Validação: Serviço não pode ser duplicado de existente

7. **Reajuste Inflacionário**: Aplicação de índices econômicos (IPCA, IGP-M, IPC)
   - Campos: Índice Aplicado, Período Base, % Reajuste
   - Cálculo: Consulta API Banco Central para obter índice oficial
   - Validação: % reajuste ≤ índice oficial + 2% (teto cláusula)

8. **Troca de Garantias**: Substituir tipo de garantia
   - Campos: Garantia Atual, Garantia Nova, Valor, Instituição
   - Upload Obrigatório: Documento nova garantia (PDF/scan)

**Critério de Aceite**:
- Wizard exibe campos dinâmicos baseados no tipo selecionado
- Validações específicas são aplicadas por tipo
- Tipo não pode ser alterado após criação do aditivo

**Erro**: HTTP 400 se tipo não reconhecido ou validações específicas falharem

---

### RN-RF027-002 — Wizard Multi-Step com Validações Progressivas

**Descrição**: Criação de aditivo DEVE seguir wizard guiado em 5 etapas obrigatórias com validações progressivas (não permite avançar se etapa incompleta).

**Etapas Obrigatórias**:

**Etapa 1 - Identificação**:
- Selecionar contrato base (dropdown autocomplete)
- Tipo de aditivo (radio buttons 8 opções)
- Número aditivo (auto-gerado: ADD-{Num_Contrato}-{Seq})
- Validação: Contrato deve estar vigente (status = Ativo)

**Etapa 2 - Dados Específicos**:
- Campos dinâmicos baseados no tipo (vide RN-RF027-001)
- Datas vigência (início/término)
- Validação: Vigência aditivo ⊆ Vigência contrato base + prorrogação

**Etapa 3 - Impacto Financeiro**:
- Sistema calcula automaticamente (vide RN-RF027-003)
- Usuário pode ajustar valores com justificativa
- Gráficos comparativos (antes/depois)
- Validação: Variação >20% exige justificativa obrigatória

**Etapa 4 - Documentos**:
- Upload PDF/Word aditivo assinado (obrigatório ao finalizar)
- Upload anexos opcionais (emails, propostas)
- OCR automático extrai dados para validação cruzada
- Validação: Hash SHA-256 para detectar modificações

**Etapa 5 - Revisão e Envio**:
- Tela sumário com todos os dados
- Comparação lado a lado (original vs. pós-aditivo)
- Botão "Salvar Rascunho" ou "Enviar para Aprovação"

**Salvamento Automático**: Wizard salva progresso a cada 30 segundos em `Aditivo` table com status "Rascunho"

**Critério de Aceite**:
- Não permite avançar etapa se validações falharem
- Permite voltar etapas anteriores sem perder dados
- Salvamento automático preserva progresso em caso de desconexão

**Erro**: HTTP 400 se tentar avançar com validação pendente

---

### RN-RF027-003 — Cálculo Automático de Impacto Financeiro

**Descrição**: Sistema DEVE calcular automaticamente o impacto financeiro de cada aditivo gerando 4 métricas obrigatórias.

**Métricas Calculadas**:

1. **Valor Incremental Mensal**:
   - Fórmula: `Valor_Novo_Mensal - Valor_Atual_Mensal`
   - Exibição: R$ +XX.XXX (verde) ou R$ -XX.XXX (vermelho)

2. **Valor Incremental Anual**:
   - Fórmula: `Valor_Incremental_Mensal × Meses_Vigencia_Restante`
   - Considera: Vigência específica do aditivo

3. **Valor Total Contrato Pós-Aditivo**:
   - Soma: Valor contrato base + todos os aditivos vigentes
   - Comparação: % aumento/redução vs. valor original

4. **Projeção 12 Meses**:
   - Gráfico linha mostrando evolução mensal do custo
   - Considera: Reajustes automáticos, sazonalidade (se histórico disponível)

**Gráfico Waterfall Obrigatório**:
- Barra base (valor contrato original)
- Barras incrementais/decrementais (aditivos anteriores)
- Barra destacada (aditivo atual)
- Barra total final

**Exportação**: Permite exportar cálculo em PDF com gráficos

**Critério de Aceite**:
- Cálculo executa em <5 segundos
- Todas as 4 métricas são exibidas
- Gráfico waterfall é gerado automaticamente
- Exportação PDF contém todos os gráficos

---

### RN-RF027-004 — Versionamento Completo de Contratos

**Descrição**: Cada aditivo aprovado DEVE criar nova versão do contrato preservando histórico completo com diff visual automático.

**Estrutura Versionamento**:
- Tabela `Contrato_Versao` com campos obrigatórios:
  - Numero_Versao (v1.0, v1.1, v1.2... semântico)
  - Id_Aditivo_Gerador (FK para Aditivo)
  - Snapshot_Dados (JSON completo da versão)
  - Documento_PDF_URL (Azure Blob Storage)
  - Hash_SHA256 (integridade)
  - Dt_Criacao_Versao
  - Usuario_Responsavel_Id

**Versionamento Semântico**:
- Aditivos pequenos (alteração tarifária, reajuste): Minor version (v1.0 → v1.1)
- Aditivos significativos (acréscimo/supressão >15%): Major version (v1.2 → v2.0)
- Critério: Impacto financeiro >15% = major version

**Diff Visual Obrigatório**:
- Verde: Cláusulas/itens adicionados
- Vermelho: Cláusulas/itens removidos (strikethrough)
- Amarelo: Cláusulas modificadas (hover mostra antes/depois)
- Cinza: Cláusulas inalteradas (pode ocultar)

**Restauração**: Administrador pode restaurar versão anterior com justificativa obrigatória

**Imutabilidade**: Versões anteriores NÃO podem ser editadas (somente consulta) para compliance

**Critério de Aceite**:
- Nova versão criada automaticamente ao aprovar aditivo
- Hash SHA-256 validado em cada consulta
- Diff visual funciona para contratos >100 páginas
- Restauração exige justificativa + log auditoria

**Erro**: HTTP 409 se tentar editar versão fechada

---

### RN-RF027-005 — Workflow de Aprovação Multi-Nível

**Descrição**: Aditivo DEVE passar por workflow aprovação configurável de até 3 níveis antes de entrar em vigência.

**Níveis Padrão**:

**Nível 1 - Gestor Operacional**:
- Responsável: Gerente departamento solicitante
- Validação: Checklist técnico (linhas, planos, valores)
- SLA: 2 dias úteis

**Nível 2 - Jurídico**:
- Responsável: Advogado/Analista Jurídico
- Validação: Conformidade cláusulas, riscos, multas
- SLA: 5 dias úteis
- Pode solicitar ajustes (retorna para solicitante)

**Nível 3 - Diretoria Financeira**:
- Responsável: CFO/Controller
- Gatilho: Apenas se impacto >R$50k/ano (configurável)
- Validação: Aprovação orçamentária, alinhamento budget
- SLA: 3 dias úteis

**Configurabilidade**:
- Administrador pode adicionar/remover níveis por tipo
- Alterar SLA por nível
- Definir gatilhos financeiros (ex: >R$100k = CEO)
- Configurar delegação (substituto se aprovador ausente)

**Escalação Automática**:
- 80% SLA: Lembrete email + push notification
- 100% SLA: Escala para gestor superior + log auditoria

**Aprovação Mobile**: Aprovadores podem aprovar/rejeitar via app com justificativa obrigatória se rejeitar

**Assinatura Digital**: Nível final requer assinatura digital via DocuSign antes de marcar "Vigente"

**Critério de Aceite**:
- Workflow não permite pular níveis
- Escalação automática dispara no prazo
- Aprovação/rejeição registrada em log auditoria
- DocuSign obrigatório no nível final

**Erro**: HTTP 403 se usuário não autorizado para aprovar nível atual

---

### RN-RF027-006 — Library Jurídica de Cláusulas

**Descrição**: Sistema DEVE fornecer biblioteca de 50+ templates de cláusulas contratuais pré-aprovadas + builder visual para compor aditivo.

**Categorias Obrigatórias**:

**Telecom (20 templates)**:
- Cláusula SLA disponibilidade (99,5%, 99,9%, 99,99%)
- Multa descumprimento SLA (% desconto proporcional)
- Reajuste IPCA/IGP-M anual
- Cancelamento sem multa (pós-fidelização)
- Portabilidade de linhas

**TI/Cloud (15 templates)**:
- SLA uptime cloud (AWS, Azure, GCP)
- Licenciamento per-user/per-device
- Suporte 24x7 vs. horário comercial
- Backup e disaster recovery (RPO/RTO)
- LGPD data processing agreement

**Gerais (15 templates)**:
- Renovação automática
- Rescisão antecipada (multa rescisória)
- Foro competente
- Confidencialidade (NDA)
- Força maior (caso fortuito)

**Builder Visual**:
1. Drag-and-drop cláusulas da biblioteca para canvas
2. Editar texto cláusula (personalizar variáveis: datas, valores, nomes)
3. Reordenar cláusulas
4. Preview PDF em tempo real
5. Salvar como novo template customizado

**Versionamento Templates**: Jurídico pode criar novas versões (ex: "Cláusula SLA v2.0"). Aditivos históricos mantêm referência para versão usada

**Aprovação Jurídica**: Templates customizados requerem aprovação jurídica antes de usar

**Critério de Aceite**:
- Biblioteca contém mínimo 50 templates
- Builder permite drag-and-drop funcional
- Preview PDF gerado em <3 segundos
- Templates customizados exigem aprovação

**Erro**: HTTP 403 se tentar usar template customizado não aprovado

---

### RN-RF027-007 — Gestão Documental Integrada

**Descrição**: Sistema DEVE gerenciar ciclo de vida completo de documentos do aditivo (upload, OCR, versionamento, assinatura, arquivamento).

**Upload Documentos**:
- Suporta: PDF, Word (DOCX), imagens (scan)
- Tamanho máximo: 25 MB por arquivo
- OCR automático: Azure Form Recognizer extrai dados-chave
- Armazenamento: Azure Blob Storage (hot tier vigentes, cool tier históricos)

**Tipos de Documentos**:
1. **Aditivo Assinado** (obrigatório) - Documento oficial pós-assinatura
2. **Minuta Aditivo** (opcional) - Versão pré-assinatura
3. **Emails Negociação** (opcional) - Evidências discussão
4. **Propostas Comerciais** (opcional) - Propostas operadora/fornecedor
5. **Aprovações Internas** (automático) - PDFs gerados workflow

**OCR e Validação Cruzada**:
- Sistema extrai: Número aditivo, datas, valores, partes
- Compara extraído vs. dados cadastrados
- Alerta se divergência >5%

**Versionamento Docs**:
- Cada upload cria nova versão (v1, v2, v3...)
- Hash SHA-256 garante integridade
- Download sempre da versão recente, mas pode consultar anteriores

**Assinatura Digital DocuSign**:
- Workflow: Gera PDF minuta → Envia DocuSign → Recebe callback → Armazena assinado
- Signatários: Representante empresa + Representante operadora
- Certificado incluído no PDF (validade jurídica)

**Retenção**: Docs vigentes indefinidamente, cancelados 7 anos (compliance fiscal)

**Critério de Aceite**:
- Upload aceita PDF/DOCX/imagens
- OCR extrai dados em <10 segundos
- Divergência >5% gera alerta
- DocuSign integrado com callback funcional

**Erro**: HTTP 413 se arquivo >25MB, HTTP 400 se tipo não suportado

---

### RN-RF027-008 — Alertas Inteligentes de Vencimento

**Descrição**: Sistema DEVE monitorar vencimentos de aditivos gerando alertas escalonados 90/60/30 dias antes com ML prevendo renovação automática.

**Alertas Padrão**:

**90 dias antes**:
- Email para gestor operacional
- Conteúdo: Resumo aditivo, valor, próximas ações

**60 dias antes**:
- Email + push notification para gestor + jurídico
- Conteúdo: + Histórico variação preços (sugestão renegociação)

**30 dias antes**:
- Email + push + in-app notification para todos stakeholders
- Conteúdo: + KPI comparação mercado (benchmark)
- Ação: Botão "Iniciar Renegociação"

**Previsão ML Renovação Automática**:
- Modelo: 70% contratos renovam automaticamente sem renegociação
- Features: Tipo serviço, valor, fornecedor, histórico contestações, NPS
- Output: Probabilidade 0-100% de renovação automática
- Alerta: Se probabilidade >80%, sugere revisão preventiva

**Dashboard Vencimentos**: Kanban 4 colunas:
- >90 dias (verde)
- 60-90 dias (amarelo)
- 30-60 dias (laranja)
- <30 dias (vermelho)

**Critério de Aceite**:
- Alertas disparados automaticamente nos prazos
- ML treinado com histórico mínimo 100 contratos
- Dashboard atualizado em tempo real
- Botão "Iniciar Renegociação" funcional

---

### RN-RF027-009 — Dashboard Pipeline de Aditivos

**Descrição**: Sistema DEVE exibir dashboard executivo com pipeline visual de aditivos em andamento e KPIs principais.

**Pipeline Kanban (5 colunas)**:
1. **Rascunho** (cinza) - Em elaboração
2. **Em Aprovação** (amarelo) - Workflow andamento
3. **Aguardando Assinatura** (laranja) - Aprovado, pendente DocuSign
4. **Vigente** (verde) - Aditivo ativo
5. **Encerrado** (azul) - Concluído/expirado

**Métricas Pipeline**:
- Total aditivos em pipeline
- Valor total em aprovação (R$)
- Tempo médio aprovação (dias)
- Taxa aprovação 1ª rodada (%)
- Bottleneck atual (nível aprovação mais lento)

**Gráficos Executivos**:
1. **Distribuição por Tipo**: Pie chart - % cada tipo
2. **Evolução Temporal**: Line chart - aditivos criados por mês (12 meses)
3. **Ranking Fornecedores**: Bar chart - Top 10 com mais aditivos
4. **Impacto Financeiro**: Waterfall - economia vs. custo adicional
5. **Funil Aprovação**: Funnel chart - taxa conversão por nível

**Drill-Down**: Clicar em gráfico exibe lista detalhada com filtros

**Exportação**: Dashboard exportável em PDF (snapshot mensal)

**Critério de Aceite**:
- Kanban atualizado em tempo real
- Métricas calculadas corretamente
- 5 gráficos obrigatórios presentes
- Drill-down funcional
- Exportação PDF completa

---

### RN-RF027-010 — Comparação Visual entre Versões

**Descrição**: Sistema DEVE permitir comparação lado a lado entre quaisquer duas versões do contrato com highlight automático de diferenças.

**Diff Engine**:
- Algoritmo: Myers' diff algorithm (mesmo do Git)
- Granularidade: Palavra por palavra
- Color Coding:
  - Verde: Texto adicionado
  - Vermelho: Texto removido (strikethrough)
  - Amarelo: Texto modificado (hover mostra anterior)
  - Cinza: Texto inalterado

**UI Comparação**:
- Dropdown: Selecionar "Versão A" vs. "Versão B"
- Split View: 2 colunas sincronizadas (scroll)
- Unified View: Coluna única com color coding
- Toggle: Ocultar cláusulas inalteradas

**Navegação**:
- Botões "Próxima Diferença" / "Diferença Anterior"
- Jump to Section (menu lateral)

**Exportação**: Gera PDF comparativo com highlight

**Performance**: Comparação contratos >100 páginas executa em background job Hangfire, usuário recebe notificação quando concluída

**Critério de Aceite**:
- Comparação funciona para qualquer par de versões
- Color coding correto
- Split/Unified View funcionais
- Export PDF contém highlights
- Background job para contratos grandes

---

### RN-RF027-011 — Validação de Vigência e Datas

**Descrição**: Sistema DEVE validar automaticamente consistência de datas entre aditivo e contrato base.

**Regras de Validação**:

1. **Início Aditivo**:
   - `Dt_Inicio_Aditivo >= Dt_Inicio_Contrato_Base`
   - `Dt_Inicio_Aditivo <= Dt_Termino_Contrato_Base` (se não for prorrogação)

2. **Término Aditivo**:
   - `Dt_Termino_Aditivo <= Dt_Termino_Contrato_Base` (se não for prorrogação)
   - Se prorrogação: `Dt_Termino_Aditivo > Dt_Termino_Contrato_Base` e atualiza contrato base

3. **Sobreposição**:
   - Não permite 2 aditivos do mesmo tipo vigentes simultaneamente

4. **Retroatividade**:
   - Aditivos NÃO podem ter `Dt_Inicio < Dt_Hoje` sem justificativa + aprovação diretoria

**Critério de Aceite**:
- Validações aplicadas antes de salvar
- Mensagens erro claras
- Retroatividade exige justificativa obrigatória

**Erro**: HTTP 400 Bad Request com mensagem descritiva (ex: "Data término aditivo posterior a contrato. Use tipo 'Prorrogação de Prazo'")

---

### RN-RF027-012 — Isolamento Multi-Tenant Obrigatório

**Descrição**: TODAS as queries e operações DEVEM filtrar por `ClienteId` obtido do JWT token.

**Segurança**: Usuário de Cliente A NÃO pode ver/editar aditivos de Cliente B

**Performance**: Índice composto (ClienteId, Id_Contrato, Status) otimiza queries

**Critério de Aceite**:
- Filtro ClienteId em 100% das queries
- Teste cross-tenant retorna HTTP 403
- Índice composto validado em queries

**Erro**: HTTP 403 Forbidden se tentativa acesso cross-tenant

---

### RN-RF027-013 — Soft Delete Obrigatório

**Descrição**: Sistema NUNCA deve fazer DELETE físico de aditivos. Exclusão lógica via `FlExcluido = TRUE`.

**Motivo**: Preservar auditoria completa (rastreabilidade SOX)

**Queries**: Filtro global `WHERE FlExcluido = 0` via EF Core Query Filter

**Critério de Aceite**:
- DELETE físico bloqueado (somente UPDATE FlExcluido)
- Query Filter aplicado globalmente
- Restauração possível (FlExcluido = FALSE)

---

### RN-RF027-014 — Cálculo de Multas Rescisórias

**Descrição**: Para aditivos tipo "Supressão de Linhas" ou "Rescisão Parcial", sistema DEVE calcular automaticamente multa rescisória se dentro de fidelização.

**Cálculo**:
- **SE** `Meses_Fidelizacao_Restante > 0` **E** `Tipo_Aditivo = Supressao`
- **ENTÃO** `Multa = Valor_Mensal_Linhas_Suprimidas × Meses_Fidelizacao_Restante × Percentual_Multa`
- **ONDE** `Percentual_Multa` vem de cláusula contrato base (default 100%)

**Validação**: Sistema exibe alerta destacando valor multa antes de salvar

**Negociação**: Usuário pode sobrescrever multa com justificativa obrigatória

**Critério de Aceite**:
- Cálculo automático para supressões
- Alerta visual de multa
- Sobrescrita exige justificativa

---

### RN-RF027-015 — Integração com Sistema Jurídico Externo

**Descrição**: Sistema DEVE sincronizar aditivos aprovados com sistema de gestão jurídica (Projuris, Legal One, SAP ERP Legal) via API REST ou webhook.

**Dados Sincronizados**:
- Cabeçalho aditivo (número, tipo, datas, partes)
- Documentos PDF assinados (URL Azure Blob compartilhada)
- Workflow aprovação (histórico completo)
- Valores financeiros (impacto)

**Formato**: JSON payload com schema versionado (v1)

**Retry**: Polly policy 3 tentativas (backoff 2s, 4s, 8s)

**DLQ**: Eventos não sincronizados vão para Dead Letter Queue (Azure Service Bus) para reprocessamento manual

**Critério de Aceite**:
- Webhook ou API REST funcional
- Retry policy aplicado
- DLQ funcional para falhas
- Payload JSON validado

**Erro**: HTTP 502 se sistema externo indisponível (retry automático)

---

## 6. ESTADOS DO ADITIVO

| Estado | Descrição |
|------|-----------|
| Rascunho | Criado, não enviado para aprovação |
| Em Aprovação | Workflow aprovação em andamento |
| Aguardando Assinatura | Aprovado, pendente DocuSign |
| Vigente | Aditivo ativo e em vigor |
| Encerrado | Aditivo concluído/expirado |
| Cancelado | Aditivo cancelado antes de vigência |
| Rejeitado | Workflow rejeitado por aprovador |

### Transições permitidas

| De | Para |
|---|---|
| Rascunho | Em Aprovação |
| Rascunho | Cancelado |
| Em Aprovação | Aguardando Assinatura |
| Em Aprovação | Rejeitado |
| Em Aprovação | Rascunho (se retornado) |
| Aguardando Assinatura | Vigente |
| Vigente | Encerrado |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre |
|------|--------------|
| aditivo.criado | Após criação wizard |
| aditivo.enviado_aprovacao | Ao enviar workflow |
| aditivo.aprovado_nivel1 | Gestor aprova |
| aditivo.aprovado_nivel2 | Jurídico aprova |
| aditivo.aprovado_nivel3 | Diretoria aprova |
| aditivo.rejeitado | Qualquer nível rejeita |
| aditivo.assinado | DocuSign concluído |
| aditivo.vigente | Entra em vigor |
| aditivo.vencimento_proximo | 90/60/30 dias antes |
| aditivo.encerrado | Vigência termina |
| contrato_versao.criada | Nova versão contrato |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento multi-tenant (ClienteId)
- Nenhuma regra de negócio pode ser ignorada
- Erros devem ser previsíveis, rastreáveis e com mensagens claras
- Auditoria deve registrar quem, quando e o que mudou em TODAS operações
- Workflow não pode permitir pular níveis ou aprovar sem permissão
- Cálculo impacto financeiro deve executar em <5 segundos
- Versionamento deve preservar histórico completo e imutável
- DocuSign obrigatório antes de marcar aditivo como Vigente
- OCR deve extrair dados com precisão >95%
- ML renovação deve ter precisão >70%
- Dashboard deve atualizar em tempo real
- Diff visual deve funcionar para contratos >100 páginas

---

## 9. SEGURANÇA

### 9.1 Validações de Entrada

- Todos os campos obrigatórios devem ser validados
- Proteção contra injeção SQL, XSS, CSRF
- Upload de arquivos: validação tipo MIME, tamanho, vírus scan
- OCR: sanitização de dados extraídos antes de usar

### 9.2 Controle de Permissões (RBAC)

| Operação | Permissão |
|-------|---------|
| Criar aditivo | aditivos.create |
| Atualizar aditivo rascunho | aditivos.update |
| Visualizar aditivo | aditivos.view |
| Listar aditivos | aditivos.view_any |
| Excluir aditivo | aditivos.delete |
| Aprovar Nível 1 | aditivos.approve_level1 |
| Aprovar Nível 2 | aditivos.approve_level2 |
| Aprovar Nível 3 | aditivos.approve_level3 |
| Enviar DocuSign | aditivos.docusign |
| Restaurar versão | aditivos.restore_version |
| Gerenciar templates | templates.manage |
| Exportar dashboard | aditivos.export |

### 9.3 Isolamento Multi-Tenant

- Row-Level Security com `ClienteId`
- Filtro automático em TODAS queries via EF Core Query Filter
- Tentativa acesso cross-tenant retorna HTTP 403

### 9.4 Auditoria

- Log completo de ações: usuário, IP, device, timestamp
- Dados antes/depois em formato JSON
- Tabela `Aditivo_Auditoria_Log` preservada indefinidamente
- Compliance: SOX, LGPD

---

## 10. INTEGRAÇÕES OBRIGATÓRIAS

### 10.1 i18n (Internacionalização)

- Suporte pt-BR (padrão), en, es
- Chaves de tradução para todos os textos UI
- Formatação monetária, datas e números por locale

### 10.2 Auditoria

- Interceptor automático registra todas operações CRUD
- Campos auditoria em todas tabelas: DataCriacao, UsuarioCriacao, DataModificacao, UsuarioModificacao

### 10.3 Central de Funcionalidades

- Registrar feature "Gestão de Aditivos" com flag ON/OFF
- Desabilitar funcionalidade se flag OFF (HTTP 503)

### 10.4 Notificações

- Email via SendGrid
- Push notifications via SignalR
- In-app notifications via hub

### 10.5 Azure Blob Storage

- Hot tier: Documentos vigentes
- Cool tier: Documentos históricos (>1 ano)
- Retention policy: 7 anos para docs cancelados

### 10.6 DocuSign API

- Integração via webhook para callback assinatura
- Certificado digital incluído no PDF
- Rastreamento status envelope

### 10.7 Azure Form Recognizer (OCR)

- Extração automática de dados de PDFs/imagens
- Precisão mínima 95%
- Validação cruzada com dados cadastrados

### 10.8 API Banco Central

- Consulta índices econômicos (IPCA, IGP-M, IPC)
- Timeout 5 segundos
- Retry policy 3 tentativas

### 10.9 ML.NET

- Modelo previsão renovação automática
- Retreinamento mensal com novos dados
- Precisão mínima 70%

### 10.10 Sistema Jurídico Externo

- API REST ou webhook
- Retry policy Polly (3 tentativas)
- Dead Letter Queue para falhas

---

## 11. API ENDPOINTS

### CRUD

| Método | Endpoint | Descrição |
|--------|----------|-----------|
| POST | /api/v1/aditivos | Criar aditivo (wizard) |
| GET | /api/v1/aditivos | Listar com paginação |
| GET | /api/v1/aditivos/{id} | Buscar por ID |
| PUT | /api/v1/aditivos/{id} | Atualizar (apenas rascunho) |
| DELETE | /api/v1/aditivos/{id} | Soft delete |

### Workflow

| Método | Endpoint | Descrição |
|--------|----------|-----------|
| POST | /api/v1/aditivos/{id}/enviar-aprovacao | Inicia workflow |
| POST | /api/v1/aditivos/{id}/aprovar | Aprovar nível atual |
| POST | /api/v1/aditivos/{id}/rejeitar | Rejeitar com justificativa |
| POST | /api/v1/aditivos/{id}/docusign | Enviar para assinatura |

### Impacto Financeiro

| Método | Endpoint | Descrição |
|--------|----------|-----------|
| GET | /api/v1/aditivos/{id}/impacto | Calcular impacto |
| GET | /api/v1/aditivos/{id}/projecao | Gráfico projeção 12 meses |
| POST | /api/v1/aditivos/{id}/recalcular | Recalcular com novos parâmetros |

### Versionamento

| Método | Endpoint | Descrição |
|--------|----------|-----------|
| GET | /api/v1/contratos/{id}/versoes | Listar versões contrato |
| GET | /api/v1/contratos/{id}/versoes/comparar?v1=X&v2=Y | Diff visual |
| POST | /api/v1/contratos/{id}/versoes/restaurar | Restaurar versão |

### Documentos

| Método | Endpoint | Descrição |
|--------|----------|-----------|
| POST | /api/v1/aditivos/{id}/documentos | Upload documento |
| GET | /api/v1/aditivos/{id}/documentos | Listar documentos |
| GET | /api/v1/aditivos/{id}/documentos/{docId}/ocr | Dados extraídos OCR |

### Templates Cláusulas

| Método | Endpoint | Descrição |
|--------|----------|-----------|
| GET | /api/v1/templates-clausulas | Library completa |
| POST | /api/v1/templates-clausulas | Criar template customizado |
| PUT | /api/v1/templates-clausulas/{id}/aprovar | Aprovação jurídico |

### Dashboard

| Método | Endpoint | Descrição |
|--------|----------|-----------|
| GET | /api/v1/aditivos/dashboard/pipeline | Kanban pipeline |
| GET | /api/v1/aditivos/dashboard/kpis | Métricas principais |
| GET | /api/v1/aditivos/dashboard/vencimentos | Alertas próximos 90 dias |

---

## 12. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF027.md** (Casos de Uso): 5 UCs obrigatórios
- **MD-RF027.md** (Modelo de Dados): 8 tabelas
- **WF-RF027.md** (Wireframes): Wizard 5 etapas, Dashboard, Diff Visual
- **TC-RF027-BACKEND.yaml** (Testes Backend): CRUD, Workflow, Cálculos
- **TC-RF027-FRONTEND.yaml** (Testes Frontend): Wizard, Dashboard, Diff
- **TC-RF027-SEGURANCA.yaml** (Testes Segurança): Multi-tenant, RBAC
- **TC-RF027-E2E.yaml** (Testes E2E): Fluxo completo criação → aprovação → assinatura

---

## 13. RASTREABILIDADE

| Artefato | Status |
|--------|-------|
| Casos de Uso (UC-RF027.md) | Obrigatório |
| Modelo de Dados (MD-RF027.md) | Obrigatório |
| Wireframes (WF-RF027.md) | Obrigatório |
| Testes Backend (TC-RF027-BACKEND.yaml) | Obrigatório |
| Testes Frontend (TC-RF027-FRONTEND.yaml) | Obrigatório |
| Testes Segurança (TC-RF027-SEGURANCA.yaml) | Obrigatório |
| Testes E2E (TC-RF027-E2E.yaml) | Obrigatório |

---

## 14. DEPENDÊNCIAS

### Requisitos Funcionais Relacionados

| RF | Descrição | Tipo Dependência |
|----|-----------|------------------|
| RF-026 | Gestão de Contratos | FORTE - Aditivos vinculados a contratos base |
| RF-028 | Gestão de SLA Operações | MÉDIA - Validação SLA em aditivos tipo "Mudança SLA" |

### Serviços Externos

- Azure Blob Storage (armazenamento docs)
- DocuSign API (assinatura digital)
- Azure Form Recognizer (OCR)
- API Banco Central (índices econômicos)
- Sistema Jurídico Externo (sincronização)
- SendGrid (email)
- SignalR (notificações)

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|------|------|----------|------|
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0: Separação RF/RL completa. RF limpo de referências legado. 15 regras de negócio formalizadas. Workflow multi-nível detalhado. Integrações obrigatórias documentadas. | Agência ALC - alc.dev.br |
| 1.0 | 2025-12-17 | Versão inicial com mistura RF + referências legado (depreciada) | Equipe IControlIT Architect |
