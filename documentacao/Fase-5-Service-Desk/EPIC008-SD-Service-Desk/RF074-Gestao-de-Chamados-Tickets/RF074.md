# RF074: Gestão de Chamados - Portal Self-Service

**Versão**: 2.0 (Governance v2.0 - Natural Language Only)
**Data**: 2025-12-30
**RF Relacionado**: RF073
**EPIC**: EPIC008-SD-Service-Desk
**Fase**: Fase 5 - Service Desk

---

## 1. VISÃO GERAL

### 1.1 Objetivo

Especificar o **Portal Self-Service de Gestão de Chamados (Tickets)** destinado a usuários finais para abertura, acompanhamento e gestão independente de suas próprias solicitações de suporte. O portal oferece experiência simplificada e intuitiva focada no self-service, permitindo que usuários abram chamados via wizard de 3 passos, acompanhem status em tempo real, adicionem comentários públicos, avaliem atendimento (CSAT), e consultem FAQ integrada.

### 1.2 Importância Estratégica

- **Redução de Carga no Suporte**: Self-service reduz chamados evitáveis via FAQ/base conhecimento (meta: 20-30% economia)
- **Autonomia do Usuário**: Usuários acompanham seus próprios tickets sem depender de equipe; notificações automáticas real-time via SignalR
- **Experiência Mobile-First**: PWA com suporte completo a mobile (Android/iOS); funciona offline com cache via service workers
- **Velocidade de Resolução**: Wizard 3-passos vs forms complexos reduz tempo de preenchimento (meta: <2 min vs 10 min)
- **Satisfação Medida (CSAT)**: Avaliação imediata pós-resolução via interface NPS inline (sem redirect externo)
- **Conformidade Contratual**: Usuários visualizam SLA em linguagem clara (não técnica); aumenta transparência

### 1.3 Escopo

#### Dentro do Escopo

- Portal restrito - usuário vê APENAS seus próprios chamados (isolamento por ClienteId + UserId)
- Wizard de 3 passos para criar chamado (Selecionar serviço → Descrever → Confirmar)
- Listagem com cards responsivos (status visual por cores, prioridade, SLA countdown)
- Detalhes do chamado (descrição, ativos afetados, histórico de atualizações, SLA atual)
- Comentários públicos (adicionar comentários visíveis; não vê comentários internos da equipe)
- Upload de anexos (screenshots, logs, documentos; máx 5 MB; tipos: jpg, png, pdf, log, txt)
- Acompanhamento em tempo real (SignalR notifica mudanças de status/comentários sem refresh)
- CSAT avaliação (estrelas 1-5 pós-resolução; comentário opcional)
- FAQ/Base de Conhecimento integrada (modal com busca; sugestões enquanto digita)
- Catálogo de Serviços (integração com RF021 para pré-popular categorias com ícones)
- PWA com suporte offline (service workers; cache de tickets, categorias, FAQ)
- Notificações push (service worker notifications para mudanças de status)

#### Fora do Escopo

- Gestão interna de chamados (coberto por RF073 - Gestão Interna de Tickets)
- Criação de categorias de serviço (coberto por RF021 - Catálogo de Serviços)
- Criação de artigos FAQ (coberto por RF070 - Base de Conhecimento)
- Gestão de SLA (coberto por RF028 - SLA de Operações)
- Atribuição de tickets a técnicos (RF073)
- Comentários internos (visíveis apenas para equipe)
- Relatórios gerenciais de chamados (RF073)

---

## 2. FUNCIONALIDADES

### 2.1 Visualizar Meus Chamados (Listagem)

**Descrição**: Permite que usuário final visualize APENAS seus próprios chamados em listagem com cards responsivos exibindo status visual (cores), prioridade, número do chamado, categoria, data de criação e SLA countdown.

**Atores**: Solicitante (Usuário Final)

**Pré-condições**: Usuário autenticado no sistema

**Fluxo**:
1. Usuário acessa rota `/my-tickets`
2. Sistema carrega chamados do usuário com filtro obrigatório `WHERE UserId = CurrentUserId AND ClienteId = CurrentClienteId`
3. Sistema ordena por data de criação (mais recente primeiro)
4. Sistema exibe cards com informações resumidas (número, categoria, status, SLA)
5. Sistema aplica cores visuais baseado em status (Novo=azul, Em Andamento=amarelo, Resolvido=verde, Fechado=cinza)
6. Sistema exibe contador de SLA se aplicável (ex: "Vence em 2h 30min")
7. Usuário pode filtrar por status, categoria ou período
8. Usuário pode clicar em card para ver detalhes completos

**Pós-condições**: Usuário visualiza apenas seus próprios chamados; outros chamados permanecem invisíveis

**Exceções**:
- Usuário não tem chamados → Exibir mensagem "Você não tem chamados. Clique aqui para criar seu primeiro chamado"
- Timeout de conexão → Carregar do cache offline (PWA)

---

### 2.2 Criar Chamado via Wizard 3-Passos

**Descrição**: Permite que usuário crie novo chamado através de wizard guiado em 3 passos (Selecionar categoria → Descrever problema → Confirmar detalhes), sem sobrecarga de campos obrigatórios em tela única.

**Atores**: Solicitante (Usuário Final)

**Pré-condições**: Usuário autenticado; categorias de serviço cadastradas em RF021

**Fluxo**:
1. **Passo 1 - Selecionar Categoria**:
   - Usuário acessa `/my-tickets/new`
   - Sistema carrega categorias ativas de ServicoCategoria (RF021)
   - Sistema exibe categorias como cards com ícones (se disponível) ou dropdown simples
   - Usuário seleciona categoria
   - Sistema valida seleção obrigatória
   - Usuário clica "Continuar" e avança para Passo 2

2. **Passo 2 - Descrever Problema**:
   - Sistema exibe textarea para descrição do problema
   - Sistema valida descrição mínima de 20 caracteres
   - Enquanto usuário digita, sistema busca artigos FAQ em tempo real
   - Sistema exibe sugestões de FAQ abaixo do textarea (overlay)
   - Usuário pode clicar em artigo FAQ para auto-resolução (não cria chamado) OU
   - Usuário continua descrevendo problema
   - Usuário pode fazer upload opcional de 1 arquivo (máx 5 MB)
   - Usuário clica "Continuar" e avança para Passo 3

3. **Passo 3 - Confirmar Detalhes**:
   - Sistema exibe resumo do que será enviado (categoria, descrição, arquivo anexo)
   - Usuário revisa informações
   - Usuário clica "Enviar Chamado"
   - Sistema valida payload completo
   - Sistema escaneia arquivo com antivírus se houver upload
   - Sistema cria ticket no banco de dados com status "Novo"
   - Sistema armazena arquivo em Azure Blob Storage se aplicável
   - Sistema registra auditoria da operação
   - Sistema exibe tela de sucesso com número do chamado (ex: "CHD-2025-001 criado!")
   - Sistema redireciona para `/my-tickets/CHD-2025-001` (detalhe do chamado)

**Pós-condições**: Chamado criado e visível na listagem; equipe de suporte notificada

**Exceções**:
- Descrição < 20 caracteres → Erro inline no Passo 2, não avança
- Arquivo > 5 MB → Erro inline, usuário deve selecionar arquivo menor
- Arquivo com malware detectado → Erro de segurança, upload rejeitado
- Usuário abandona wizard antes de finalizar → Dados não são salvos (sem draft)

---

### 2.3 Visualizar Detalhes do Chamado

**Descrição**: Permite que usuário visualize detalhes completos de um chamado específico incluindo descrição, ativos afetados, histórico de atualizações, comentários públicos, SLA atual e anexos.

**Atores**: Solicitante (Usuário Final)

**Pré-condições**: Usuário possui chamado criado; usuário é dono do chamado

**Fluxo**:
1. Usuário acessa `/my-tickets/{id}` (clicando em card da listagem)
2. Sistema valida ownership (ticket pertence ao usuário logado)
3. Sistema carrega dados completos do chamado
4. Sistema exibe seção "Detalhes" com:
   - Número do chamado, categoria, status atual, prioridade
   - Descrição completa fornecida pelo usuário
   - SLA atual com countdown visual se aplicável
   - Data de criação, última atualização
5. Sistema exibe seção "Histórico de Atualizações" com:
   - Timeline de mudanças de status (Novo → Em Andamento → Resolvido)
   - Timestamps de cada mudança
6. Sistema exibe seção "Comentários Públicos" com:
   - Apenas comentários marcados como visibilidade "Externa"
   - Comentários internos da equipe NÃO são exibidos
   - Ordenação por data (mais recente primeiro)
7. Sistema exibe seção "Anexos" com:
   - Links para download de arquivos anexados pelo usuário ou equipe
   - Preview de imagens se aplicável
8. Sistema conecta WebSocket SignalR para notificações em tempo real

**Pós-condições**: Usuário visualiza detalhes completos do seu chamado; conexão SignalR ativa para updates

**Exceções**:
- Usuário tenta acessar ticket de outro usuário → HTTP 403 Forbidden
- Ticket não existe → HTTP 404 Not Found
- Conexão SignalR falha → Fallback para polling a cada 30s

---

### 2.4 Adicionar Comentário Público

**Descrição**: Permite que usuário adicione comentário público ao seu chamado com opção de anexar arquivo (screenshot, log, documento).

**Atores**: Solicitante (Usuário Final)

**Pré-condições**: Usuário possui chamado criado; chamado não está com status "Fechado"

**Fluxo**:
1. Na tela de detalhes do chamado, usuário clica em "Adicionar Comentário"
2. Sistema exibe textarea com placeholder "Seu comentário aqui..."
3. Usuário digita comentário
4. Usuário pode clicar em "Anexar Arquivo" para fazer upload opcional (máx 5 MB)
5. Sistema valida extensão de arquivo permitida (jpg, png, pdf, log, txt)
6. Usuário clica "Enviar Comentário"
7. Sistema valida comentário não vazio
8. Sistema escaneia arquivo com antivírus se houver upload
9. Sistema armazena arquivo em Azure Blob Storage se aplicável
10. Sistema salva comentário no banco com visibilidade "Externa"
11. Sistema registra auditoria da operação
12. Sistema notifica equipe de suporte via SignalR sobre novo comentário
13. Sistema exibe comentário na timeline imediatamente (sem refresh)
14. Sistema exibe mensagem de sucesso "Comentário adicionado"

**Pós-condições**: Comentário visível na timeline; equipe notificada

**Exceções**:
- Comentário vazio → Erro inline, botão "Enviar" desabilitado
- Arquivo > 5 MB → Erro, usuário deve selecionar arquivo menor
- Arquivo com malware → Upload rejeitado, erro de segurança
- Chamado fechado → Botão "Adicionar Comentário" desabilitado com tooltip "Chamado fechado"
- Timeout de conexão → Comentário salvo localmente (PWA), sincroniza quando voltar online

---

### 2.5 Receber Notificações em Tempo Real

**Descrição**: Permite que usuário receba notificações em tempo real quando seu chamado sofre atualizações (mudança de status, novo comentário da equipe) sem necessidade de refresh manual.

**Atores**: Solicitante (Usuário Final); Sistema (automático)

**Pré-condições**: Usuário autenticado; conexão WebSocket SignalR ativa

**Fluxo**:
1. Usuário acessa portal e sistema estabelece conexão SignalR
2. Quando técnico adiciona comentário externo OU muda status do chamado:
   - Sistema backend dispara evento SignalR para usuário específico
   - Sistema frontend recebe evento via listener
3. Sistema frontend atualiza tela em tempo real:
   - Bell icon exibe contador (+1)
   - Toast notification exibido no canto (ex: "Novo comentário de suporte")
   - Timeline de comentários atualizada (lazy load, sem flash)
   - Status visual atualizado se aplicável
4. Usuário pode clicar em bell icon para ver notificações recentes
5. Usuário pode clicar em notificação para navegar para ticket específico
6. Sistema marca notificação como "lida" após clique

**Pós-condições**: Usuário sempre vê informações atualizadas sem refresh manual

**Exceções**:
- Conexão SignalR falha → Sistema tenta reconectar automaticamente (5 tentativas)
- Se reconexão falhar → Fallback para polling a cada 30s
- Notificações acumuladas durante offline → Exibidas quando voltar online

---

### 2.6 Avaliar Atendimento (CSAT)

**Descrição**: Permite que usuário avalie atendimento recebido imediatamente após resolução do chamado via interface inline (não email externo) com escala de 1-5 estrelas e comentário opcional.

**Atores**: Solicitante (Usuário Final)

**Pré-condições**: Chamado mudou para status "Resolvido"

**Fluxo**:
1. Quando técnico marca chamado como "Resolvido":
   - Sistema notifica usuário via SignalR
   - Sistema exibe toast inline (não modal bloqueador) solicitando avaliação
2. Toast exibe: "Sua solicitação foi resolvida! ⭐ Avalie seu atendimento"
3. Usuário pode clicar em toast OU ignorar
4. Se clicar, sistema exibe popup de avaliação com:
   - Pergunta: "Como foi sua experiência?"
   - 5 estrelas clicáveis (1=muito insatisfeito, 5=muito satisfeito)
   - Campo opcional: "Comentário adicional (opcional)"
   - Botão "Enviar Avaliação"
5. Usuário seleciona quantidade de estrelas
6. Usuário pode adicionar comentário opcional (máx 500 caracteres)
7. Usuário clica "Enviar Avaliação"
8. Sistema valida rating (obrigatório entre 1-5)
9. Sistema salva avaliação em tabela TicketSatisfaction
10. Sistema registra auditoria da operação
11. Sistema exibe mensagem "Obrigado pelo feedback!"
12. Sistema fecha popup automaticamente após 3 segundos

**Pós-condições**: Avaliação CSAT registrada; dados disponíveis para métricas em RF073

**Exceções**:
- Usuário ignora toast → Avaliação não é obrigatória, sem impacto
- Usuário fecha popup sem avaliar → Sem avaliação registrada
- Timeout de conexão → Avaliação salva localmente (PWA), sincroniza quando voltar online

---

### 2.7 Buscar FAQ Integrada

**Descrição**: Permite que usuário busque artigos da Base de Conhecimento (RF070) diretamente dentro do portal via modal com busca em tempo real, promovendo auto-resolução antes de criar chamado.

**Atores**: Solicitante (Usuário Final)

**Pré-condições**: Artigos FAQ cadastrados em RF070

**Fluxo**:
1. Usuário pode abrir FAQ de duas formas:
   - Clicando em link "Consulte FAQ Primeiro" no wizard Passo 2
   - Pressionando atalho Ctrl+/ em qualquer tela do portal
2. Sistema exibe modal/overlay com campo de busca
3. Usuário digita termo de busca (mín 3 caracteres)
4. Sistema busca em tempo real em artigos de FaqArticles (título e conteúdo)
5. Sistema exibe top 5 resultados ordenados por relevância
6. Cada resultado exibe:
   - Título do artigo
   - Resumo (primeiros 200 caracteres)
   - Link "Ler Mais"
7. Usuário pode clicar em "Ler Mais" para abrir artigo completo
8. Sistema exibe pergunta no final do artigo: "Isso resolveu seu problema?"
9. Se usuário clicar "Sim" → Sistema registra auto-resolução (métrica: evitou chamado)
10. Se usuário clicar "Não" → Sistema sugere criar chamado
11. Usuário pode fechar modal a qualquer momento (Esc ou clique fora)

**Pós-condições**: Usuário pode auto-resolver problema sem criar chamado (reduz carga)

**Exceções**:
- Nenhum artigo encontrado → Exibir "Nenhum artigo encontrado. Criar chamado?"
- Busca < 3 caracteres → Exibir placeholder "Digite pelo menos 3 caracteres"
- Timeout de busca → Exibir erro "Erro ao buscar. Tente novamente"

---

### 2.8 Acessar Portal Offline (PWA)

**Descrição**: Permite que usuário acesse portal mesmo sem conexão à internet via Progressive Web App com service workers que fazem cache de tickets, categorias e FAQ.

**Atores**: Solicitante (Usuário Final); Service Worker (automático)

**Pré-condições**: Navegador compatível com PWA (Chrome, Edge, Safari); usuário já acessou portal online ao menos uma vez

**Fluxo**:
1. **Primeira Visita (Online)**:
   - Usuário acessa portal via navegador
   - Sistema instala service worker automaticamente
   - Service worker faz cache de:
     - Assets estáticos (JS, CSS, imagens)
     - Lista de tickets do usuário
     - Categorias de serviço
     - Top 10 artigos FAQ mais acessados
   - Navegador exibe opção "Adicionar à Tela Inicial" (PWA prompt)

2. **Acesso Offline**:
   - Usuário perde conexão à internet (ex: entra em túnel)
   - Usuário tenta acessar `/my-tickets`
   - Service worker intercepta requisição
   - Service worker retorna dados do cache (IndexedDB)
   - Usuário visualiza seus tickets do cache
   - Usuário pode ler FAQ do cache
   - Ações de escrita (criar ticket, comentar) ficam em fila

3. **Retorno Online**:
   - Usuário volta a ter conexão
   - Service worker detecta conexão restaurada
   - Service worker sincroniza ações pendentes (fila)
   - Service worker atualiza cache com dados mais recentes
   - Sistema exibe toast: "Sincronizado com sucesso"

**Pós-condições**: Portal utilizável offline; dados sincronizados quando voltar online

**Exceções**:
- Navegador não suporta PWA → Portal funciona normalmente (degradação graciosa)
- Tentativa de criar ticket offline → Salvo em fila, enviado quando voltar online
- Cache muito antigo (>7 dias) → Service worker força atualização ao voltar online

---

### 2.9 Receber Notificações Push

**Descrição**: Permite que usuário receba notificações push no sistema operacional (Windows, Android, iOS) quando seu chamado sofre atualizações mesmo com portal fechado.

**Atores**: Solicitante (Usuário Final); Sistema (automático)

**Pré-condições**: Usuário concedeu permissão de notificações; service worker instalado

**Fluxo**:
1. Na primeira visita, sistema solicita permissão de notificações
2. Usuário clica "Permitir" no prompt do navegador
3. Sistema registra token de notificação push
4. Quando técnico atualiza chamado:
   - Sistema backend envia notificação push via service worker
   - Notificação aparece no sistema operacional mesmo com portal fechado
5. Usuário pode clicar na notificação para abrir portal diretamente no ticket
6. Usuário pode configurar preferências de notificação em `/settings`

**Pós-condições**: Usuário recebe notificações mesmo com portal fechado

**Exceções**:
- Usuário nega permissão → Notificações push desabilitadas (fallback para in-app apenas)
- Navegador não suporta push → Fallback para in-app notifications

---

### 2.10 Configurar Preferências de Notificação

**Descrição**: Permite que usuário configure preferências de notificação (push, in-app, email) por tipo de evento (novo comentário, mudança de status, resolução).

**Atores**: Solicitante (Usuário Final)

**Pré-condições**: Usuário autenticado

**Fluxo**:
1. Usuário acessa `/settings/notifications`
2. Sistema exibe tabela de preferências com colunas:
   - Tipo de Evento (Novo Comentário, Mudança Status, Resolução)
   - Push Notification (toggle on/off)
   - In-App Notification (toggle on/off)
   - Email (toggle on/off)
3. Usuário ajusta toggles conforme preferência
4. Usuário clica "Salvar Preferências"
5. Sistema valida (ao menos um canal deve estar ativo por evento)
6. Sistema salva preferências em NotificacaoPreferencia
7. Sistema exibe mensagem "Preferências salvas com sucesso"

**Pós-condições**: Notificações futuras respeitam preferências do usuário

**Exceções**:
- Todos canais desabilitados para um evento → Erro "Ao menos um canal deve estar ativo"

---

## 3. REGRAS DE NEGÓCIO

### RN-SD-074-01: Isolamento de Dados por Usuário

**Descrição**: Usuário final NUNCA pode visualizar chamados de outro usuário. Filtro obrigatório aplicado em todas as queries: WHERE UserId = CurrentUserId AND ClienteId = CurrentClienteId.

**Motivação**: Confidencialidade de informações; compliance LGPD; múltiplos usuários podem usar mesmo navegador.

**Impacto**: Backend deve validar ownership em TODOS os endpoints. Tentativa de acesso a ticket de outro usuário retorna HTTP 403 Forbidden.

---

### RN-SD-074-02: Wizard 3-Passos Obrigatório

**Descrição**: Criação de chamado via portal self-service APENAS através de wizard guiado em 3 passos. API direta de criação desabilitada para usuários finais (apenas equipe interna via RF073). Cada passo valida campos obrigatórios antes de permitir avanço.

**Motivação**: Simplificar UX; guiar usuário através de campos obrigatórios sem sobrecarregar; reduzir abandono de criação (atualmente 30% em form único).

**Impacto**: Frontend deve implementar wizard com validação por passo. Backend deve aceitar payload completo apenas no Passo 3.

---

### RN-SD-074-03: Categorias do Catálogo de Serviços

**Descrição**: Dropdown de categorias no Passo 1 do wizard é preenchido automaticamente a partir de ServicoCategoria (RF021). Se serviço possui ícone cadastrado, exibir como cards visuais ao invés de dropdown simples. Apenas categorias ativas são exibidas.

**Motivação**: Reutilização de dados corporativos; UX visual melhor que dropdown textual; integração com catálogo oficial.

**Impacto**: Backend deve expor endpoint específico para buscar categorias ativas com ícones. Categoria desativada em RF021 automaticamente desaparece do wizard RF074.

---

### RN-SD-074-04: FAQ Integrada com Busca Real-Time

**Descrição**: Modal/overlay de FAQ com busca em tempo real em artigos da Base de Conhecimento (RF070). Busca ativável via Ctrl+/ ou link "Consulte FAQ Primeiro" no wizard Passo 2. Sistema busca em títulos e conteúdo de artigos, retorna top 5 resultados ordenados por relevância. Se usuário encontrar resposta, pode auto-resolver sem criar chamado.

**Motivação**: Reduzir 20-30% dos chamados evitáveis conforme meta estratégica; auto-resolução melhora satisfação e reduz carga operacional.

**Impacto**: Backend deve expor endpoint de busca em FaqArticles com filtro de texto full-text. Frontend deve implementar busca debounced (300ms) para não sobrecarregar servidor.

---

### RN-SD-074-05: Notificações Tempo Real SignalR

**Descrição**: Quando chamado do usuário recebe comentário externo da equipe OU muda de status, usuário recebe notificação em tempo real via SignalR (não precisa refresh). Notificações são persistidas em banco de dados e exibidas em bell icon com contador. Conexão SignalR estabelecida automaticamente ao acessar portal.

**Motivação**: Transparência; melhora experiência evitando refresh manual; alinhamento com ITIL v4 best practice (comunicação proativa).

**Impacto**: Backend deve implementar Hub SignalR específico para usuários finais. Frontend deve manter conexão WebSocket ativa. Em caso de falha de conexão, fallback para polling a cada 30s.

---

### RN-SD-074-06: Comentários Públicos Apenas

**Descrição**: Usuário final visualiza APENAS comentários com visibilidade "Externa". Comentários internos (equipe de coordenação, técnicos) com visibilidade "Interna" NUNCA são exibidos no portal self-service.

**Motivação**: Confidencialidade de processos internos; evitar exposição de informações sensíveis (ex: "aguardando peça do fornecedor há 30 dias").

**Impacto**: Backend deve filtrar comentários por visibilidade "Externa" em query. Frontend nunca recebe comentários internos no payload.

---

### RN-SD-074-07: CSAT Inline Pós-Resolução

**Descrição**: Quando chamado muda para status "Resolvido", sistema exibe popup inline (não modal bloqueador, não email externo) solicitando: (1) Avaliação 1-5 estrelas (obrigatório), (2) Comentário opcional (máx 500 caracteres). Usuário pode ignorar ou responder. Avaliação registrada em tabela TicketSatisfaction.

**Motivação**: Coleta de CSAT imediata e não-intrusiva; melhora taxa de resposta vs email (60% vs 15%); dados em tempo real para métricas.

**Impacto**: Backend deve detectar mudança de status para "Resolvido" e notificar frontend via SignalR. Frontend exibe toast com link para avaliar.

---

### RN-SD-074-08: Upload com Validação e Antivírus

**Descrição**: Usuário pode fazer upload de máximo 1 arquivo por comentário (máx 5 MB). Tipos permitidos: jpg, png, pdf, log, txt. Arquivo é escaneado por antivírus (ClamAV) antes de armazenar. Arquivo aprovado é armazenado em Azure Blob Storage (não filesystem local) com nome aleatório.

**Motivação**: Segurança contra malware; escalabilidade (blob storage); conformidade (não armazenar em servidor local).

**Impacto**: Backend deve integrar com ClamAV para scan. Upload rejeitado se malware detectado. Frontend deve validar tamanho e extensão antes de enviar.

---

### RN-SD-074-09: Auditoria Completa

**Descrição**: Toda ação do usuário final em portal é auditada: criação de ticket, adição de comentário, upload de anexo, submissão de CSAT. Auditoria registra: usuário, timestamp, ação, IP, dados relevantes (resumidos). Retenção: 7 anos (LGPD).

**Motivação**: Conformidade regulatória; investigação de disputas; rastreamento de acesso não autorizado.

**Impacto**: Backend deve registrar auditoria via interceptor em TODOS os comandos do portal self-service. Dados sensíveis (senhas, tokens) NUNCA devem ser logados.

---

### RN-SD-074-10: PWA com Suporte Offline

**Descrição**: Portal é Progressive Web App (PWA) com suporte offline via service workers. Service worker faz cache de: lista de tickets do usuário, categorias de serviço, top 10 artigos FAQ mais acessados. Quando offline, usuário pode ler seus tickets e FAQ; ações de escrita (criar ticket, comentar) ficam em fila e sincronizam automaticamente ao voltar online.

**Motivação**: Disponibilidade mesmo com conexão ruim/intermitente; experiência mobile-first competitiva vs apps nativos; meta de 10% adoção de PWA offline.

**Impacto**: Frontend deve implementar service worker com estratégia cache-first para leitura e queue para escrita. Backend deve suportar sincronização de ações enfileiradas.

---

### RN-SD-074-11: Rate Limiting de Criação

**Descrição**: Usuário final pode criar máximo 10 tickets por hora. Comentários limitados a 5 por minuto. Limite aplicado por UserId. Se limite atingido, sistema retorna HTTP 429 Too Many Requests com header Retry-After indicando quando pode tentar novamente.

**Motivação**: Prevenir spam/abuso; proteger sistema contra DoS acidental ou intencional; reduzir risco de flood de tickets.

**Impacto**: Backend deve implementar rate limiting em criação e comentários. Frontend deve exibir mensagem amigável "Você atingiu o limite de X por hora. Aguarde Y minutos."

---

### RN-SD-074-12: Multi-Tenancy e Isolamento

**Descrição**: Todos os dados do portal são isolados por ClienteId (multi-tenancy). Queries obrigatoriamente filtram por ClienteId do usuário autenticado. Usuário de Cliente A NUNCA vê dados de Cliente B mesmo se tiver acesso ao ID do ticket.

**Motivação**: Isolamento total entre clientes; compliance contratual; segurança de dados.

**Impacto**: Backend deve aplicar filtro ClienteId em TODAS as queries de portal. Tentativa de acesso cross-tenant retorna HTTP 403.

---

### RN-SD-074-13: Internacionalização (i18n)

**Descrição**: Portal deve suportar 3 idiomas: Português (pt-BR), Inglês (en-US), Espanhol (es-ES). Idioma selecionado baseado em preferência do usuário (salvo em perfil) ou locale do navegador. Todas as labels, mensagens de erro, tooltips devem ter traduções. Fallback para pt-BR se tradução não existir.

**Motivação**: Atender clientes internacionais; melhorar acessibilidade; compliance com contratos globais.

**Impacto**: Frontend deve usar biblioteca de i18n (Transloco). Backend deve retornar mensagens de erro no idioma do usuário (via header Accept-Language).

---

### RN-SD-074-14: Responsividade Mobile-First

**Descrição**: Portal deve ser 100% responsivo com design mobile-first. Breakpoints: Mobile (<768px), Tablet (768-1024px), Desktop (>1024px). Cards de listagem se ajustam ao tamanho da tela. Wizard otimizado para telas pequenas (passos verticais ao invés de horizontais). Botões com tamanho mínimo de 44x44px para touch (WCAG).

**Motivação**: Usuários acessam principalmente via mobile (70% dos acessos); UX mobile ruim causa abandono.

**Impacto**: Frontend deve usar design system responsivo (Angular Material, PrimeNG). Testes E2E devem validar em múltiplas resoluções.

---

### RN-SD-074-15: Acessibilidade (WCAG 2.1 AA)

**Descrição**: Portal deve cumprir WCAG 2.1 nível AA incluindo: navegação por teclado (Tab, Enter, Esc), labels ARIA para screen readers, contraste mínimo 4.5:1, foco visual claro, sem dependência exclusiva de cor para informação.

**Motivação**: Inclusão de usuários com deficiência; compliance legal (Lei Brasileira de Inclusão); ética corporativa.

**Impacto**: Frontend deve implementar atributos ARIA. Testes devem validar com ferramentas de acessibilidade (axe-core, Lighthouse).

---

## 4. INTEGRAÇÕES OBRIGATÓRIAS

### 4.1 Central de Funcionalidades (Feature Flags)

**Chave**: `SELFSERVICE_PORTAL_ENABLED`
**Descrição**: Habilita/desabilita portal self-service globalmente
**Perfis**: Todos os usuários finais

**Sub-features**:
- `SELFSERVICE_CSAT_INLINE` - Avaliação CSAT inline (não email)
- `SELFSERVICE_FAQ_INTEGRATION` - Integração com FAQ (RF070)
- `SELFSERVICE_OFFLINE_MODE` - Modo offline (PWA)
- `SELFSERVICE_PUSH_NOTIFICATIONS` - Notificações push

---

### 4.2 Internacionalização (i18n)

**Idiomas Suportados**: pt-BR (padrão), en-US, es-ES
**Fallback**: pt-BR

**Chaves Principais**:
- `selfservice.portal.title` - "Meus Chamados"
- `selfservice.wizard.step1` - "Selecionar Serviço"
- `selfservice.tickets.status_new` - "Novo"
- `selfservice.csat.title` - "Avalie Nosso Atendimento"
- `selfservice.faq.title` - "Base de Conhecimento"
- `selfservice.comments.add_comment` - "Adicionar Comentário"

---

### 4.3 Auditoria

**Código de Operações**:
- `TKT_SELFSERVICE_CREATE` - Criação de ticket via portal
- `TKT_SELFSERVICE_VIEW` - Visualização de ticket
- `TKT_SELFSERVICE_COMMENT` - Adição de comentário
- `TKT_SELFSERVICE_CSAT` - Submissão de CSAT
- `TKT_SELFSERVICE_FAQ_VIEW` - Acesso a artigo FAQ

**Retenção**: 7 anos (LGPD)

---

### 4.4 Controle de Acesso (RBAC)

**Permissões**:
- `tkt:selfservice:read` - Visualizar meus chamados
- `tkt:selfservice:create` - Criar novo chamado
- `tkt:selfservice:comment` - Adicionar comentário
- `tkt:selfservice:csat` - Enviar avaliação CSAT
- `tkt:faq:read` - Acessar FAQ

**Perfil Padrão**: Solicitante (todos os usuários finais)

---

## 5. SEGURANÇA

### 5.1 Proteções Implementadas

- **Isolamento por UserId**: WHERE UserId = CurrentUserId em todas as queries
- **Validação de Entrada**: Min/Max length, enum validation, MIME type whitelist
- **XSS Protection**: Angular XSS guard automático; comentários escapados
- **CSRF Token**: HttpOnly cookie + Angular interceptor automático
- **Rate Limiting**: 10 tickets/hora; 5 comentários/min por usuário
- **Antivírus Scanning**: ClamAV antes de armazenar arquivo
- **Soft Delete**: IsDeleted=true; nunca deletar fisicamente
- **Auditoria Completa**: Toda ação logada
- **HTTPS Obrigatório**: TLS 1.2+ mínimo
- **Blob Storage Seguro**: Arquivos com nome aleatório GUID

### 5.2 Testes de Segurança Obrigatórios

- Tentar acessar ticket de outro usuário → HTTP 403
- XSS em comentário → Escapado e renderizado como texto
- Upload de `.exe` → Rejeitado (MIME whitelist)
- SQL Injection em busca FAQ → Parametrizado, sem risco
- Rate limiting: 11º ticket em 1h → HTTP 429
- Antivírus: arquivo infectado → Detectado e rejeitado
- Soft delete: ticket IsDeleted=true → Invisível em listagens
- Auditoria: senhas NUNCA logadas

---

## 6. MÉTRICAS E INDICADORES

### 6.1 KPIs

| KPI | Meta | Medição |
|-----|------|---------|
| **Taxa Auto-Resolução via FAQ** | ≥ 20% | (Buscas FAQ sem criar ticket / Buscas FAQ totais) × 100 |
| **Tempo Criação via Wizard** | < 2 min | AVG(tempo completo wizard) |
| **CSAT Médio** | ≥ 4.0 stars | AVG(TicketSatisfaction.Rating) |
| **Taxa Resposta CSAT** | ≥ 60% | (Tickets com CSAT / Tickets Resolvidos) × 100 |
| **Adoção PWA Offline** | ≥ 10% | (Usuários com SW instalado / Total usuários) × 100 |
| **Performance P75** | < 1s | P75 do tempo carregamento `/my-tickets` |
| **Taxa Upload Sucesso** | ≥ 99% | (Uploads sucesso / Uploads tentados) × 100 |
| **Taxa Detecção Malware** | 100% | Arquivos infectados bloqueados / Arquivos infectados submetidos |

---

## 7. DEPENDÊNCIAS

### 7.1 RFs Dependentes (CRÍTICAS)

- **RF073** (Gestão Interna de Tickets) - Compartilham mesma base de dados (Tickets)
- **RF021** (Catálogo de Serviços) - Categorias pré-populam wizard
- **RF070** (Base de Conhecimento) - FAQ integrada para auto-resolução
- **RF028** (SLA de Operações) - Exibição de prazos em linguagem amigável

### 7.2 RFs Impactados

- **RF066** (Notificações e Alertas) - Notificações de mudança de status/comentários
- **RF001** (Gestão de Usuários) - Autenticação e perfis
- **RF002** (Gestão de Empresas) - Multi-tenancy isolamento

---

## 8. CRITÉRIOS DE ACEITE

### 8.1 Backend

- [ ] Todas as 15 RNs implementadas
- [ ] Hub SignalR para notificações real-time
- [ ] Rate limiting funcionando (10 tickets/h, 5 comentários/min)
- [ ] Isolamento UserId + ClienteId em todas queries
- [ ] Antivírus ClamAV integrado
- [ ] Azure Blob Storage para anexos
- [ ] Auditoria automática em todos comandos
- [ ] Multi-tenancy garantido
- [ ] Testes unitários cobertura >80%
- [ ] Testes de integração com mocks

### 8.2 Frontend

- [ ] Wizard 3-passos implementado
- [ ] Cards responsivos mobile-first
- [ ] SignalR client conectando real-time
- [ ] FAQ modal com busca debounced
- [ ] CSAT inline pós-resolução
- [ ] PWA com service worker
- [ ] Notificações push configuráveis
- [ ] i18n completo (pt-BR, en-US, es-ES)
- [ ] Acessibilidade WCAG 2.1 AA
- [ ] Testes E2E com Playwright
- [ ] Performance P75 < 1s

### 8.3 Testes

- [ ] Bateria Backend: 100% RNs validadas
- [ ] Bateria Sistema: Fluxos E2E completos
- [ ] Bateria Segurança: Todos testes de segurança
- [ ] Testes offline: PWA funcionando sem internet
- [ ] Testes rate limiting: Bloqueio em limites
- [ ] Testes multi-dispositivo: Mobile, Tablet, Desktop

---

**Última Atualização**: 2025-12-30
**Autor**: IControlIT Governance v2.0
**Versão**: 2.0 (Natural Language Only)
