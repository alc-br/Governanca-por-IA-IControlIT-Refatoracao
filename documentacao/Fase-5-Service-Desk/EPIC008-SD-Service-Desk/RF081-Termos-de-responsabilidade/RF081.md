# RF-081: Termos de Responsabilidade por Ativos e Equipamentos

**Versão**: 2.0
**Data**: 2025-12-31
**Autor**: Claude Code
**EPIC**: EPIC008-SD-Service-Desk
**Fase**: Fase 5 - Service Desk e Governança

---

## 1. VISÃO GERAL

### 1.1 Resumo Executivo

Este requisito especifica o módulo de **Gestão de Termos de Responsabilidade por Ativos e Equipamentos** do sistema IControlIT, responsável por:

- Criação e versionamento de termos de responsabilidade customizados por tipo de ativo
- Captura de aceite obrigatório com assinatura digital (touch/mouse/stylus)
- Registro imutável de aceite com timestamp UTC, geolocalização (IP + GPS), foto comprovante
- Versionamento automático de termos com rastreabilidade histórica (LGPD/SOX)
- Notificações inteligentes de vencimento, devolução, penalidades
- Revogação de termo quando equipamento é devolvido ou perdido
- Dashboard de aceites pendentes, vencidos, ativos por usuário/departamento/empresa
- Exportação de comprovante de aceite em PDF com QRCode para rastreabilidade
- Integração com workflows de movimentação de ativos (RF-027)
- Suporte multi-idioma (pt-BR, en-US, es-ES) e multi-tenancy (ClienteId obrigatório)

**Objetivo Estratégico**: Garantir que 100% dos ativos entregues sejam formalmente aceitos por seus responsáveis, criando prova legal de custódia para proteção patrimonial, conformidade LGPD e eficiência operacional.

### 1.2 Importância Estratégica

- **Proteção Patrimonial**: Documentar formalmente a transferência de custódia de ativos
- **Conformidade LGPD**: Rastrear quem aceitou quais termos, quando, com quais dados pessoais
- **Conformidade SOX**: Documentar controles internos sobre ativos corporativos
- **Eficiência Operacional**: Automatizar fluxo manual de entrega de ativos
- **Gestão de Riscos**: Identificar equipamentos sem aceite vs. com aceite
- **Recuperação de Ativos**: Rastrear quem tem qual equipamento
- **Dashboard Executivo**: Visibilidade em tempo real de aceites pendentes, taxa de devolução

**Impacto de Negócio**:
- Redução de 85% no tempo de entrega de ativos (de 2-3h para 20min)
- Recuperação de 15-20% de ativos "perdidos" (valor médio R$500k/ano)
- Zero multas LGPD relacionadas a rastreamento inadequado (potencial economia: R$50M)
- Documentação completa para auditorias SOX/ISO (economia: 40h/ano)

### 1.3 Conceitos Fundamentais

**Termo de Responsabilidade (TR)**: Documento formal que transfere custódia de um ativo de uma entidade jurídica para uma pessoa natural, especificando responsabilidades, período de vigência e condições especiais.

**Aceite de Termo**: Ato formal onde o usuário concorda em ser responsável pelo ativo, capturando identificação, timestamp UTC, geolocalização, dispositivo, biométrica opcional e versão do termo.

**Vigência de Termo**: Período durante o qual o aceite permanece válido (Início: data/hora do aceite, Fim: data esperada de devolução, Status: Ativo/Vencido/Revogado/Pendente).

**Penalidades de Retenção**: Cálculo automático de multa por retenção de ativo além do prazo (Tipo 1: Multa fixa diária, Tipo 2: Multa progressiva, Tipo 3: Custo de reposição integral).

**Comprovante de Aceite**: Documento PDF com QRCode, dados do termo aceito, assinatura digital, hash SHA-256 para verificação de integridade.

### 1.4 Funcionalidades Principais

1. **CRUD de Termos de Responsabilidade**: Criar, ler, atualizar, versionar termos específicos por tipo de ativo
2. **Versionamento Automático**: Cada alteração gera nova versão com changelog, autor, data
3. **Captura de Aceite com Assinatura Digital**: SignaturePad (touch/mouse/stylus) com imagem PNG
4. **Validação de Identidade**: BrasilAPI para validação de CPF, verificação de matrícula corporativa
5. **Geolocalização e Contexto**: Captura IP + GPS (autorizado) + User-Agent + tipo dispositivo
6. **Notificações Inteligentes**: Alertas automáticos 30/15/7 dias antes vencimento
7. **Revogação de Termo**: Quando equipamento é devolvido/perdido, revoga termo
8. **Comprovante PDF com QRCode**: Geração automática com assinatura, timestamp, dados equipamento
9. **Dashboard de Aceites**: Filtros por usuário/departamento/status com métricas
10. **Integração com RF-027**: Webhook automático quando ativo é entregue
11. **Cálculo de Penalidades**: Multa automática por retenção além do prazo
12. **Auditoria LGPD Completa**: Rastreamento de quem aceitou, quando, qual versão
13. **Busca e Filtros Avançados**: Pesquisa por código patrimonial, usuário, status, tipo
14. **Suporte Multi-idioma e Multi-tenancy**: 3 idiomas, isolamento por ClienteId

---

## 2. FUNCIONALIDADES

1. Criar termo de responsabilidade customizado por tipo de ativo
2. Atualizar termo existente (versionamento automático)
3. Listar termos vigentes com filtros
4. Visualizar termo completo com histórico de versões
5. Validar identidade de usuário (CPF/matrícula) antes de aceite
6. Capturar aceite com assinatura digital (SignaturePad)
7. Registrar contexto completo do aceite (timestamp UTC, IP, GPS, User-Agent)
8. Gerar comprovante PDF com QRCode automaticamente
9. Enviar comprovante por email e armazenar em Blob Storage
10. Notificar usuário 30/15/7 dias antes do vencimento
11. Calcular penalidade automática por retenção além do prazo
12. Revogar termo quando equipamento é devolvido
13. Visualizar dashboard com métricas de aceites
14. Exportar relatórios de aceites pendentes/vencidos
15. Integrar com RF-027 via webhook (criação automática de termo pendente)

---

## 3. REGRAS DE NEGÓCIO

### RN-TRM-081-01: Tipos de Ativos e Termos Customizados

**Descrição**: Sistema DEVE suportar no mínimo 12 tipos de ativos diferentes, cada um com termo de responsabilidade customizado.

**Justificativa**: Diferentes equipamentos têm diferentes riscos, responsabilidades e períodos de vigência.

**Critério de Aceite**:
- Mínimo 12 tipos suportados: Notebook, Telefone, Badge/Cartão, Monitor, Mouse/Teclado, Webcam/Headset, Estação Acoplável, Projetor, Roteador/Modem, Tablet/iPad, Unidade Armazenamento, Ferramentas/Equipamentos
- Cada tipo pode ter termo, vigência e penalidades personalizadas

---

### RN-TRM-081-02: Validação de Identidade - CPF/Matrícula Obrigatória

**Descrição**: Antes de capturar aceite, sistema DEVE validar identidade do usuário verificando CPF (via BrasilAPI) ou matrícula corporativa.

**Justificativa**: Garantir que a pessoa assinando é realmente a responsável pelo ativo (prevenção de fraude).

**Critério de Aceite**:
- CPF válido e cadastrado → permite aceite
- CPF válido mas NÃO cadastrado → rejeita com mensagem "Cadastre-se antes de aceitar termo"
- Matrícula inativa no RH → rejeita com mensagem "Usuário inativo, contacte RH"

---

### RN-TRM-081-03: Captura de Assinatura Digital com Timestamp UTC e Geolocalização

**Descrição**: Aceite DEVE capturar assinatura rasterizada (PNG) via SignaturePad, timestamp UTC sincronizado (NTP), geolocalização (IP + GPS se autorizado), User-Agent.

**Justificativa**: Prova forense de que assinatura foi feita em data/hora/local específicos por pessoa específica.

**Critério de Aceite**:
- Assinatura em branco ou muito pequena → rejeita
- Timestamp UTC sincronizado com servidor NTP
- IP capturado automaticamente do HttpContext
- GPS capturado apenas com consentimento explícito do usuário

---

### RN-TRM-081-04: Versionamento Automático de Termos

**Descrição**: Quando conteúdo de termo é alterado, sistema cria automaticamente nova versão com histórico completo e changelog. Versões anteriores são imutáveis (append-only).

**Justificativa**: Rastreabilidade histórica para LGPD (qual versão cada usuário aceitou) e auditorias.

**Critério de Aceite**:
- Alteração no conteúdo → incrementa versão automaticamente
- Versões anteriores não podem ser modificadas
- Changelog obrigatório descrevendo alterações

---

### RN-TRM-081-05: Aceite Obrigatório - Bloqueio de Acesso

**Descrição**: Usuário que recebeu equipamento novo ou cujo termo está vencido NÃO pode acessar certos módulos do sistema até aceitar termo vigente.

**Justificativa**: Conformidade legal (documentação de custódia), proteção patrimonial.

**Critério de Aceite**:
- Usuário com termo pendente → modal bloqueante em login
- Termo vencido → modal bloqueante em login
- Usuário aceita termo → acesso liberado

---

### RN-TRM-081-06: Notificações Inteligentes de Vencimento

**Descrição**: Sistema DEVE gerar notificações automáticas (email, SMS, in-app via SignalR) com 30, 15 e 7 dias antes do vencimento.

**Justificativa**: Lembrar usuário para devolver equipamento no prazo, evitando penalidades.

**Critério de Aceite**:
- 30 dias antes: email moderado (lembrete)
- 15 dias antes: email + SMS + notificação in-app
- 7 dias antes: email URGENTE + SMS
- Vencido: email diário com penalidade acumulada

---

### RN-TRM-081-07: Cálculo de Penalidades por Retenção

**Descrição**: Quando termo vence e ativo não é devolvido, sistema calcula automaticamente multa de retenção (fixa diária, progressiva ou custo de reposição).

**Justificativa**: Incentivar devolução no prazo, proteger empresa contra perda patrimonial.

**Critério de Aceite**:
- Tipo 1 (Fixa): R$ fixo por dia de atraso
- Tipo 2 (Progressiva): Aumenta a cada X dias (ex: R$50 dias 1-5, R$75 dias 6-10)
- Tipo 3 (Custo Reposição): Custo integral do equipamento após 30 dias

---

### RN-TRM-081-08: Revogação de Termo - Encerramento Formal

**Descrição**: Quando equipamento é devolvido ou perdido, termo é revogado automaticamente com registro imutável de data, motivo, quem revogou.

**Justificativa**: Conformidade LGPD (fim da custódia = fim do processamento), rastreabilidade patrimonial.

**Critério de Aceite**:
- Motivo obrigatório: Devolução/Perda/Roubo/Aposentadoria/Troca
- Gera documento PDF de encerramento
- Aceite status muda para "Revogado"

---

### RN-TRM-081-09: Dashboard com Filtros e Métricas

**Descrição**: Dashboard exibe métricas em tempo real: total aceites (Pendente/Ativo/Vencido/Revogado), taxa aceite (%), tempo médio, penalidades acumuladas.

**Justificativa**: Visibilidade gerencial para gestores de TI.

**Critério de Aceite**:
- Filtros: usuário, departamento, tipo ativo, período
- Métricas: total aceites, taxa aceite, penalidades acumuladas, dias atraso médio
- Atualização em tempo real (cache 5 minutos)

---

### RN-TRM-081-10: Exportação de Comprovante PDF com QRCode

**Descrição**: Após aceitar termo, sistema gera PDF com QRCode único que permite verificar autenticidade online.

**Justificativa**: Prova física para arquivo do usuário, rastreabilidade via QRCode.

**Critério de Aceite**:
- PDF inclui: dados pessoais, equipamento, assinatura rasterizada, hash SHA-256, timestamp
- QRCode aponta para URL pública de verificação
- PDF enviado automaticamente por email

---

### RN-TRM-081-11: Integração com RF-027 (Movimentação de Ativos)

**Descrição**: Quando ativo é transferido para novo usuário via RF-027, webhook automático dispara criação de novo termo pendente de aceite.

**Justificativa**: Fluxo seamless - não quebra continuidade de trabalho.

**Critério de Aceite**:
- Webhook RF-027 → cria AceiteTermo com status "Pendente"
- Notifica novo usuário automaticamente
- Integração testada end-to-end

---

### RN-TRM-081-12: Suporte Multi-idioma e Multi-tenancy

**Descrição**: Interface e termos devem ser traduzidos para português, inglês e espanhol. Isolamento completo por ClienteId.

**Justificativa**: Compliance com multinacionais, isolamento de dados por segurança.

**Critério de Aceite**:
- 3 idiomas suportados: pt-BR, en-US, es-ES
- Isolamento 100% por ClienteId (Row-Level Security)
- Termos customizados por cliente

---

## 4. INTEGRAÇÕES OBRIGATÓRIAS

### 4.1 Central de Funcionalidades

**FeatureKey**: `TERMO_RESPONSABILIDADE_ACEITE_DIGITAL`

Habilita/desabilita captura de assinatura digital (SignaturePad) por cliente sem alterar código.

### 4.2 Internacionalização (i18n)

**Chaves de Tradução** (mínimo):
- `termos.responsabilidade.pageTitle`
- `termos.responsabilidade.form.tipoAtivo`
- `termos.responsabilidade.form.codigoPatrimonial`
- `termos.responsabilidade.form.campo_cpf`
- `termos.responsabilidade.form.campo_assinatura`
- `termos.responsabilidade.messages.sucessoAceite`
- `termos.responsabilidade.messages.erroAceite`
- `termos.responsabilidade.validation.required`
- `termos.responsabilidade.validation.cpfFormat`

### 4.3 Auditoria (LGPD Completa)

**Operações Auditadas**:
- `TERMO_RESPONSABILIDADE_CREATE` → TipoAtivo, Título, Conteúdo, UsuárioCriação
- `TERMO_RESPONSABILIDADE_UPDATE` → TermoId, Alterações, UsuárioAtualizaçã, Motivo
- `TERMO_RESPONSABILIDADE_ACEITE` → UsuarioId, TermoId, AtivoId, IP, GPS, Timestamp
- `TERMO_RESPONSABILIDADE_REVOGACAO` → AceiteId, Motivo, UsuarioRevogador, Penalidade

**Retenção**: 7 anos (conforme LGPD Art. 16 para dados de custódia/patrimonial)

### 4.4 Controle de Acesso (RBAC)

| Permissão | Descrição | Perfis |
|-----------|-----------|--------|
| `termo:create` | Criar termo de responsabilidade | Gestor TI, Diretor Patrimonial |
| `termo:read` | Visualizar termo (conteúdo e histórico) | Todos |
| `termo:update` | Editar termo vigente | Gestor TI, Advogado |
| `termo:delete` | Excluir termo (rascunho apenas) | Diretor Patrimonial |
| `aceite:read` | Ver aceites (próprio ou equipe) | Todos |
| `aceite:aceitar` | Aceitar termo (próprio usuário) | Todos |
| `aceite:revogar` | Revogar aceite | Gestor TI, Almoxarife |
| `dashboard:view` | Acessar dashboard de aceites | Gestor TI, Diretor Patrimonial |
| `comprovante:export` | Exportar/baixar comprovante | Todos |

---

## 5. PERMISSÕES RBAC

| Permission Code | Descrição | Roles Autorizadas |
|----------------|-----------|-------------------|
| `CAD.TERMOS.CREATE` | Criar termo de responsabilidade | Super Admin, Admin, Gestor TI |
| `CAD.TERMOS.UPDATE` | Editar termo vigente | Super Admin, Admin, Gestor TI |
| `CAD.TERMOS.DELETE` | Excluir termo (rascunho) | Super Admin, Diretor Patrimonial |
| `CAD.TERMOS.READ` | Visualizar termo | Todos |
| `CAD.ACEITES.CREATE` | Aceitar termo (próprio usuário) | Todos |
| `CAD.ACEITES.REVOKE` | Revogar aceite | Super Admin, Gestor TI, Almoxarife |
| `CAD.ACEITES.READ` | Ver aceites (próprio ou equipe) | Todos |
| `CAD.ACEITES.EXPORT` | Exportar comprovante PDF | Todos |
| `CAD.TERMOS.DASHBOARD` | Acessar dashboard | Super Admin, Admin, Gestor TI |

---

## 6. API ENDPOINTS

### 6.1 CRUD Termos

| Método | Endpoint | Descrição | Permissão |
|--------|----------|-----------|-----------|
| GET | `/api/termos` | Listar termos vigentes | `termo:read` |
| GET | `/api/termos/{id}` | Obter termo completo com histórico | `termo:read` |
| POST | `/api/termos` | Criar novo termo | `termo:create` |
| PUT | `/api/termos/{id}` | Atualizar termo (cria nova versão) | `termo:update` |
| DELETE | `/api/termos/{id}` | Excluir termo (rascunho apenas) | `termo:delete` |

### 6.2 Operações de Aceite

| Método | Endpoint | Descrição | Permissão |
|--------|----------|-----------|-----------|
| POST | `/api/aceites/validar-identidade` | Validar CPF/matrícula | `aceite:aceitar` |
| POST | `/api/aceites` | Aceitar termo (captura assinatura) | `aceite:aceitar` |
| GET | `/api/aceites/{id}` | Obter detalhes do aceite | `aceite:read` |
| GET | `/api/aceites/usuario/{usuarioId}` | Listar aceites do usuário | `aceite:read` |
| POST | `/api/aceites/{id}/revogar` | Revogar aceite (devolução) | `aceite:revogar` |
| GET | `/api/aceites/{id}/comprovante` | Baixar PDF comprovante | `comprovante:export` |
| GET | `/api/aceites/{id}/verificar` | Verificar autenticidade (público) | - |

### 6.3 Operações Especiais

| Método | Endpoint | Descrição | Permissão |
|--------|----------|-----------|-----------|
| GET | `/api/dashboard/aceites` | Dashboard com métricas | `dashboard:view` |
| GET | `/api/dashboard/penalidades` | Penalidades acumuladas | `relatorio:penalidades` |
| GET | `/api/relatorios/aceites-pendentes` | Relatório aceites pendentes | `dashboard:view` |
| POST | `/api/termos/{id}/versoes/{numero}` | Comparar versões (diff) | `termo:read` |

---

## 7. MODELO DE DADOS

**Referência**: [MD-081-Termos-Responsabilidade.md](./MD-081-Termos-Responsabilidade.md)

**Principais Entidades**:
- `TipoAtivo` → Notebook, Telefone, Badge, Monitor, etc.
- `TermoResponsabilidade` → Documento formal, versionado
- `TermoVersao` → Histórico de versões (append-only)
- `AceiteTermo` → Registro de aceite com assinatura digital
- `RevogacaoTermo` → Registro de revogação (devolução/perda)
- `CobrancaPenalidade` → Multa por retenção além do prazo

**Relacionamentos Críticos**:
- TipoAtivo 1:N TermoResponsabilidade (cada tipo tem seu termo)
- TermoResponsabilidade 1:N TermoVersao (versionamento)
- TermoResponsabilidade 1:N AceiteTermo (quem aceitou)
- AceiteTermo 1:1 RevogacaoTermo (opcional, quando revogado)
- AceiteTermo 1:N CobrancaPenalidade (se houver atraso)

---

## 8. DEPENDÊNCIAS

### 8.1 RFs Dependentes (Upstream)

- **RF-024**: Gestão de Ativos → fornece entidade `Ativo` para vincular ao termo
- **RF-027**: Movimentação de Ativos → webhook para criar termo pendente automaticamente
- **RF-080**: LGPD → auditoria completa de aceites e revogações

### 8.2 RFs que Dependem Deste (Downstream)

- **RF-053**: Gestão de Solicitações (Service Desk) → pode exigir aceite de termo antes de entregar equipamento

### 8.3 Bibliotecas Externas

- **SignaturePad** (frontend): Captura de assinatura digital via touch/mouse
- **BrasilAPI** (backend): Validação de CPF em tempo real
- **iText7** (backend): Geração de PDF com QRCode
- **Hangfire** (backend): Jobs de notificação de vencimento

---

## 9. KPIs E MÉTRICAS

| KPI | Meta | Medição |
|-----|------|---------|
| **Taxa de Aceite (%)** | ≥ 95% | (Aceites Ativos / Total Entregues) × 100 |
| **Tempo Médio Aceite (horas)** | < 2h | Média (DataAceite - DataEntrega) |
| **Equipamentos com Atraso (%)** | < 5% | (Vencidos Não Devolvidos / Total Vigentes) × 100 |
| **Penalidade Acumulada (R$)** | < 5% faturamento TI | Soma penalidades não pagas |
| **Taxa Re-aceite (%)** | ≥ 90% | (Re-aceites Realizados / Notificados) × 100 |
| **Comprovantes Baixados (%)** | ≥ 80% | (Downloads Comprovante / Aceites Gerados) × 100 |
| **Satisfação Usuário (NPS)** | ≥ 7 | Survey anual escala 1-10 |

---

## 10. ALERTAS CRÍTICOS

| Alerta | Condição | Ação |
|--------|----------|------|
| **Aceite Crítico Pendente** | Ativo crítico sem aceite > 24h | Notificar Diretor TI |
| **Taxa Atraso Elevada** | > 10% aceites com atraso | Revisão de política de entrega |
| **Penalidade Acumulada** | > R$50k/mês | Auditoria de processos |
| **Falha no Vencimento** | Aceite vencido sem notificação | Investigar falha do job |

---

## 11. CENTRAL DE FUNCIONALIDADES

**Código da Funcionalidade**: `TERMOS_RESPONSABILIDADE`

**Módulo**: Configurações > Cadastros

**i18n keys**:
- `menu.termos-responsabilidade` → "Termos de Responsabilidade"
- `title.termos-responsabilidade` → "Gestão de Termos de Responsabilidade"

**Configuração**:
```json
{
  "featureKey": "TERMO_RESPONSABILIDADE_ACEITE_DIGITAL",
  "habilitado": true,
  "clientesPiloto": ["cliente-001", "cliente-002"]
}
```

---

## PRÓXIMOS PASSOS

1. **Modelo de Dados**: Criar [MD-081](./MD-081-Termos-Responsabilidade.md)
2. **Casos de Uso**: Criar [UC-081](./UC-081-Termos-Responsabilidade.md)
3. **Workflow**: Criar [WF-081](./WF-081-Termos-Responsabilidade.md)
4. **User Stories**: Criar [user-stories.yaml](./user-stories.yaml)
5. **Testes**: Criar TC-081 (Backend, Frontend, E2E)

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-31 | Migração v1.0 → v2.0 - Separação RF/RL completa | Claude Code |
| 1.0 | 2025-12-28 | Versão inicial com 12 regras de negócio | Claude Code |

---

**Última Atualização**: 2025-12-31
**Autor**: Claude Code
**Revisão**: Pendente

---

[← Voltar](../README.md)
