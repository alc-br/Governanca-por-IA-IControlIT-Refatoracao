# =============================================
# RL-RF081 - Referência ao Legado (Termos de Responsabilidade)
# Versão: 2.0 (Adequação para Automação e Rastreabilidade)
# Data: 2025-12-31
# Autor: Claude Code
# =============================================

rf_id: RF081
titulo: "Termos de Responsabilidade por Ativos e Equipamentos"

legado:
  sistema: "VB.NET + ASP.NET Web Forms + SQL Server"
  versao: "IControlIT Legacy (Monolítico)"
  arquitetura: "Monolítica WebForms"
  banco_dados: "SQL Server (Multi-Database - um banco por cliente)"
  multi_tenant: false
  auditoria: "none"

# SEÇÃO CRÍTICA: Referencias ao Legado com Destino Obrigatório
referencias:
  - id: "LEG-RF081-001"
    tipo: "componente"
    nome: "Si_Texto_Termo (Tabela Legada)"
    caminho: "[ic1_legado].[dbo].[Si_Texto_Termo]"
    descricao: |
      Armazenava texto do termo de responsabilidade genérico (não específico para ativos).
      Estrutura: Id_Texto_Termo (PK), Ds_Titulo, Ds_Termo, Dt_Criacao, Ativo (bit).
      Problemas: Sem versionamento (alteração sobrescrevia anterior), sem auditoria,
      sem multi-tenancy, sem relacionamento com tipo de ativo.

    destino: "substituido"
    justificativa: |
      Tabela legada não suportava versionamento, auditoria ou campos obrigatórios para LGPD/SOX.
      Substituída por entidade `TermoResponsabilidade` com versionamento automático (TermoVersao),
      auditoria completa, multi-tenancy (ClienteId) e relacionamento com TipoAtivo.

    documentacao_item_relacionado: "RN-TRM-081-04"
    uc_relacionado: "UC01"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF081-002"
    tipo: "componente"
    nome: "Usuario_Envio_TermoResponsabilidade (Tabela Legada)"
    caminho: "[ic1_legado].[dbo].[Usuario_Envio_TermoResponsabilidade]"
    descricao: |
      Registrava envio de termo para usuário e capturava aceite básico (checkbox simples).
      Estrutura: Id_Usuario_Envio_Termo (PK), Id_Usuario (FK), Id_Texto_Termo (FK),
      Dt_Envio, Flg_Lido (bit), Dt_Leitura, Flg_Aceito (bit), Dt_Aceito.
      Problemas: Aceite via flag boolean (sem assinatura digital), sem captura de IP/GPS,
      sem timestamp UTC, sem vigência, sem relacionamento com ativo específico,
      sem campos de revogação ou penalidade.

    destino: "substituido"
    justificativa: |
      Aceite via checkbox não tem valor legal. Substituído por entidade `AceiteTermo`
      com assinatura digital (SignaturePad), timestamp UTC sincronizado (NTP),
      geolocalização (IP + GPS), hash SHA-256 de integridade, campos de vigência,
      relacionamento com ativo específico e suporte a revogação formal.

    documentacao_item_relacionado: "RN-TRM-081-03"
    uc_relacionado: "UC02"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF081-003"
    tipo: "regra_negocio"
    nome: "Aceite Simples sem Validação de Identidade"
    caminho: "ic1_legado/IControlIT/Sistema/Termos/ (telas ASPX genéricas)"
    descricao: |
      No legado, aceite era apenas marcar checkbox "Li e Aceito", sem validar CPF ou matrícula.
      Não havia integração com BrasilAPI ou sistema de RH para confirmar identidade.

    destino: "substituido"
    justificativa: |
      Checkbox simples permite fraude (pessoa errada assina). Substituído por validação
      obrigatória de identidade via BrasilAPI (validação CPF em tempo real) ou
      matrícula corporativa integrada com RH.

    documentacao_item_relacionado: "RN-TRM-081-02"
    uc_relacionado: "UC02"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF081-004"
    tipo: "regra_negocio"
    nome: "Sem Notificações Automáticas de Vencimento"
    caminho: "ic1_legado (ausência de Hangfire Jobs ou SPs de notificação)"
    descricao: |
      Gestores precisavam enviar emails manualmente lembrando usuários de devolver equipamentos.
      Não havia job automático para notificar 30/15/7 dias antes do vencimento.

    destino: "substituido"
    justificativa: |
      Notificações manuais são ineficientes e sujeitas a esquecimento. Substituído por job
      Hangfire automático que notifica 30, 15 e 7 dias antes do vencimento (email + SMS + SignalR).

    documentacao_item_relacionado: "RN-TRM-081-06"
    uc_relacionado: "UC05"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF081-005"
    tipo: "regra_negocio"
    nome: "Timestamp em Fuso Local (Não UTC)"
    caminho: "[ic1_legado].[dbo].[Usuario_Envio_TermoResponsabilidade].Dt_Aceito (datetime)"
    descricao: |
      Data/hora de aceite era registrada em fuso local do servidor SQL Server (America/Sao_Paulo).
      Não havia sincronização com NTP, apenas `GETDATE()` do SQL Server.

    destino: "substituido"
    justificativa: |
      Timestamp local dificulta auditorias internacionais e pode gerar inconsistências em
      servidor com fuso local alterado. Substituído por timestamp UTC sincronizado com NTP
      para precisão forense e compatibilidade com auditorias SOX/LGPD.

    documentacao_item_relacionado: "RN-TRM-081-03"
    uc_relacionado: "UC02"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF081-006"
    tipo: "regra_negocio"
    nome: "Sem Cálculo Automático de Penalidades"
    caminho: "ic1_legado (ausência de lógica de cálculo)"
    descricao: |
      Quando equipamento não era devolvido no prazo, penalidade era calculada manualmente
      por gestor em planilha Excel. Não havia campo de penalidade nas tabelas.

    destino: "substituido"
    justificativa: |
      Cálculo manual é propenso a erros e inconsistências. Substituído por service
      `CalculadorPenuldadeService` que calcula automaticamente multa (fixa diária,
      progressiva ou custo de reposição) baseado em tipo de ativo e dias de atraso.

    documentacao_item_relacionado: "RN-TRM-081-07"
    uc_relacionado: "UC03"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF081-007"
    tipo: "regra_negocio"
    nome: "Edição de Termo Sobrescreve Versão Anterior"
    caminho: "[ic1_legado].[dbo].[Si_Texto_Termo] (UPDATE direto sem histórico)"
    descricao: |
      Quando gestor editava termo, SQL `UPDATE` sobrescrevia versão anterior.
      Usuários que aceitaram versão antiga ficavam sem rastreabilidade de qual versão assinaram.

    destino: "substituido"
    justificativa: |
      Perda de histórico viola LGPD (Art. 16) e SOX (rastreabilidade de controles internos).
      Substituído por versionamento automático com tabela `TermoVersao` (append-only),
      changelog obrigatório e rastreabilidade de qual versão cada usuário aceitou.

    documentacao_item_relacionado: "RN-TRM-081-04"
    uc_relacionado: "UC01"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF081-008"
    tipo: "regra_negocio"
    nome: "Sem Revogação Formal de Termo"
    caminho: "ic1_legado (ausência de fluxo de devolução/revogação)"
    descricao: |
      Não havia fluxo formal para revogar termo quando equipamento era devolvido.
      Gestores apenas atualizavam manualmente status do ativo sem documentar fim da custódia.

    destino: "substituido"
    justificativa: |
      Ausência de revogação formal deixa custódia indefinida (usuário continua legalmente
      responsável mesmo após devolver). Substituído por entidade `RevogacaoTermo` que
      registra imutavelmente data, motivo, quem revogou e gera PDF de encerramento.

    documentacao_item_relacionado: "RN-TRM-081-08"
    uc_relacionado: "UC03"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF081-009"
    tipo: "regra_negocio"
    nome: "Sem Comprovante PDF com QRCode"
    caminho: "ic1_legado (ausência de geração de comprovante)"
    descricao: |
      Não havia geração automática de comprovante de aceite. Usuários não tinham prova física
      de que aceitaram termo. Gestores precisavam imprimir manualmente se solicitado.

    destino: "substituido"
    justificativa: |
      Ausência de comprovante deixa usuário sem prova de aceite (pode alegar que nunca assinou).
      Substituído por geração automática de PDF com QRCode único, hash SHA-256, assinatura
      rasterizada, timestamp e dados do equipamento para verificação online de autenticidade.

    documentacao_item_relacionado: "RN-TRM-081-10"
    uc_relacionado: "UC02"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF081-010"
    tipo: "regra_negocio"
    nome: "Sem Dashboard de Aceites"
    caminho: "ic1_legado (apenas relatórios SSRS estáticos)"
    descricao: |
      Gestores tinham apenas relatórios SSRS estáticos (gerados manualmente, sem filtros dinâmicos).
      Não havia visibilidade em tempo real de aceites pendentes, vencidos ou penalidades acumuladas.

    destino: "substituido"
    justificativa: |
      Relatórios estáticos são lentos e não permitem análise exploratória. Substituído por
      dashboard Angular em tempo real com D3.js, filtros por usuário/departamento/tipo de ativo,
      métricas dinâmicas (taxa de aceite, penalidades acumuladas, dias de atraso médio).

    documentacao_item_relacionado: "RN-TRM-081-09"
    uc_relacionado: "UC04"
    complexidade: "alta"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF081-011"
    tipo: "regra_negocio"
    nome: "Sem Integração com Movimentação de Ativos"
    caminho: "ic1_legado (fluxos manuais, sem webhooks)"
    descricao: |
      Quando ativo era entregue a novo usuário, gestor precisava criar termo manualmente
      e enviar por email. Não havia integração automática com sistema de movimentação.

    destino: "substituido"
    justificativa: |
      Fluxo manual é lento e sujeito a esquecimento (equipamento entregue sem termo assinado).
      Substituído por webhook automático com RF-027 que cria termo pendente automaticamente
      quando ativo é transferido + notifica novo usuário em tempo real (email + SMS + SignalR).

    documentacao_item_relacionado: "RN-TRM-081-11"
    uc_relacionado: "UC02"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

# Telas Legadas
telas:
  - id: "LEG-RF081-TELA-001"
    nome: "[Funcionalidade Inexistente no Legado]"
    caminho: "ic1_legado/IControlIT/Sistema/Termos/ (apenas tela genérica)"
    responsabilidade: |
      Legado tinha apenas tela genérica de "Gerenciamento de Termos" (envio de texto por email).
      NÃO havia tela dedicada para "Termos de Responsabilidade por Ativos".
    campos: []
    comportamentos_implicitos:
      - "Aceite via checkbox simples (sem assinatura digital)"
      - "Sem validação de identidade (CPF/matrícula)"
      - "Sem captura de contexto (IP, GPS, User-Agent)"

# WebServices Legados
servicos:
  - id: "LEG-RF081-WS-001"
    nome: "[Nenhum WebService dedicado]"
    localizacao: "N/A"
    responsabilidade: "Lógica integrada em code-behind VB.NET de telas ASPX"
    notas: "Sem separação de camadas (monolítico)"

# Tabelas Legadas com Problemas
tabelas:
  - nome: "Si_Texto_Termo"
    finalidade: "Armazenar texto do termo"
    problemas:
      - "Sem versionamento (alteração sobrescreve anterior)"
      - "Sem auditoria (não rastreia quem criou/editou)"
      - "Sem multi-tenancy (ClienteId/EmpresaId)"
      - "Sem relacionamento com tipo de ativo"
      - "Sem campos de vigência ou penalidade"

  - nome: "Usuario_Envio_TermoResponsabilidade"
    finalidade: "Registrar envio e aceite de termo"
    problemas:
      - "Aceite via flag boolean (sem assinatura digital)"
      - "Sem captura de IP ou geolocalização"
      - "Timestamp em datetime local (não UTC)"
      - "Sem relacionamento com ativo específico"
      - "Sem campos de revogação ou penalidade"
      - "Sem hash de integridade (SHA-256)"

# Regras de Negócio Implícitas
regras_implicitas:
  - id: "RL-RN-001"
    descricao: "Aceite simples sem validação de identidade (checkbox apenas)"
    fonte: "ic1_legado/IControlIT/Sistema/Termos/ (code-behind VB.NET)"

  - id: "RL-RN-002"
    descricao: "Notificações de vencimento enviadas manualmente por gestores"
    fonte: "Ausência de jobs automáticos (Hangfire/SQL Agent)"

  - id: "RL-RN-003"
    descricao: "Penalidades calculadas manualmente em planilha Excel"
    fonte: "Ausência de campos de penalidade nas tabelas"

  - id: "RL-RN-004"
    descricao: "Versionamento inexistente (edição sobrescreve versão anterior)"
    fonte: "[ic1_legado].[dbo].[Si_Texto_Termo] (UPDATE direto)"

  - id: "RL-RN-005"
    descricao: "Timestamp local (não UTC, sem sincronização NTP)"
    fonte: "Campos `Dt_Aceito` do tipo datetime (SQL Server GETDATE())"

# Gap Analysis (Legado x Moderno)
gap_analysis:
  - item: "Criação de Termo Customizado por Tipo de Ativo"
    existe_legado: false
    existe_moderno: true
    notas: "Legado tinha apenas termo genérico (não específico por equipamento)"

  - item: "Versionamento Automático de Termos"
    existe_legado: false
    existe_moderno: true
    notas: "Legado sobrescrevia versão anterior (sem histórico)"

  - item: "Assinatura Digital (SignaturePad)"
    existe_legado: false
    existe_moderno: true
    notas: "Legado tinha apenas checkbox simples"

  - item: "Validação de CPF via BrasilAPI"
    existe_legado: false
    existe_moderno: true
    notas: "Legado não validava identidade"

  - item: "Captura de Geolocalização (IP + GPS)"
    existe_legado: false
    existe_moderno: true
    notas: "Legado não capturava contexto do aceite"

  - item: "Timestamp UTC Sincronizado (NTP)"
    existe_legado: false
    existe_moderno: true
    notas: "Legado usava datetime local do servidor"

  - item: "Notificações Automáticas de Vencimento"
    existe_legado: false
    existe_moderno: true
    notas: "Legado exigia envio manual por gestor"

  - item: "Cálculo Automático de Penalidades"
    existe_legado: false
    existe_moderno: true
    notas: "Legado calculava manualmente em planilha"

  - item: "Revogação Formal de Termo"
    existe_legado: false
    existe_moderno: true
    notas: "Legado não tinha fluxo de revogação"

  - item: "Comprovante PDF com QRCode"
    existe_legado: false
    existe_moderno: true
    notas: "Legado não gerava comprovante automático"

  - item: "Dashboard de Aceites (Tempo Real)"
    existe_legado: false
    existe_moderno: true
    notas: "Legado tinha apenas relatórios SSRS estáticos"

  - item: "Integração com RF-027 (Webhook)"
    existe_legado: false
    existe_moderno: true
    notas: "Legado não integrava com movimentação de ativos"

# Decisões de Modernização
decisoes_modernizacao:
  - decisao: "Abandonar tabelas legadas e criar modelo novo com versionamento"
    motivo: |
      Tabelas legadas não suportam versionamento, auditoria ou campos obrigatórios para LGPD/SOX.
      Criar modelo novo com entidades modernas (TermoResponsabilidade, TermoVersao, AceiteTermo).
    impacto: "alto"
    data: "2025-12-31"

  - decisao: "Migrar de Multi-Database para Row-Level Security (ClienteId)"
    motivo: |
      Legado tinha banco separado por cliente (dificulta consolidação). Moderno usa banco único
      com isolamento por ClienteId (Row-Level Security).
    impacto: "alto"
    data: "2025-12-31"

  - decisao: "Substituir checkbox por assinatura digital (SignaturePad)"
    motivo: |
      Checkbox simples não tem valor legal. Assinatura digital cria prova forense de aceite.
    impacto: "medio"
    data: "2025-12-31"

  - decisao: "Implementar Timestamp UTC Sincronizado (NTP)"
    motivo: |
      Timestamp local dificulta auditorias internacionais. UTC sincronizado garante precisão forense.
    impacto: "baixo"
    data: "2025-12-31"

# Riscos de Migração
riscos_migracao:
  - risco: "Perda de dados históricos de aceites legados"
    impacto: "alto"
    probabilidade: "media"
    mitigacao: |
      Script ETL de migração testado em ambiente de homologação antes de produção.
      Backup completo dos bancos legados antes de migração.

  - risco: "Usuários não familiarizados com assinatura digital"
    impacto: "medio"
    probabilidade: "alta"
    mitigacao: |
      Vídeo tutorial + tooltip in-app explicando como assinar com touch/mouse.
      Treinamento presencial para gestores e almoxarifes.

  - risco: "Falha na integração com BrasilAPI (validação de CPF)"
    impacto: "alto"
    probabilidade: "baixa"
    mitigacao: |
      Fallback para validação offline (regex CPF + dígito verificador).
      Cache de CPFs já validados para reduzir chamadas à API.

  - risco: "Performance do job de notificações (muitos aceites vencendo)"
    impacto: "medio"
    probabilidade: "baixa"
    mitigacao: |
      Job executado em horário de baixo uso (madrugada).
      Processamento em lote com paginação (100 aceites por vez).

# Rastreabilidade (Legado → Moderno)
rastreabilidade:
  - elemento_legado: "Si_Texto_Termo (tabela)"
    referencia_rf: "RN-TRM-081-04"
    referencia_uc: "UC01"
    status: "substituido"

  - elemento_legado: "Usuario_Envio_TermoResponsabilidade (tabela)"
    referencia_rf: "RN-TRM-081-03"
    referencia_uc: "UC02"
    status: "substituido"

  - elemento_legado: "Aceite via checkbox"
    referencia_rf: "RN-TRM-081-03"
    referencia_uc: "UC02"
    status: "substituido"

  - elemento_legado: "Notificações manuais"
    referencia_rf: "RN-TRM-081-06"
    referencia_uc: "UC05"
    status: "substituido"

  - elemento_legado: "Cálculo manual de penalidades"
    referencia_rf: "RN-TRM-081-07"
    referencia_uc: "UC03"
    status: "substituido"

# Metadados de Migração
metadados:
  total_itens_legado: 11
  itens_assumidos: 0
  itens_substituidos: 11
  itens_descartados: 0
  itens_a_revisar: 0
  cobertura_destinos: "100%"

# Changelog
changelog:
  - versao: "2.0"
    data: "2025-12-31"
    descricao: "Adequação para automação e rastreabilidade (campo destino obrigatório 100%)"
    autor: "Claude Code"

  - versao: "1.0"
    data: "2025-12-31"
    descricao: "Criação do RL-RF081 com referências ao sistema legado"
    autor: "Claude Code"
