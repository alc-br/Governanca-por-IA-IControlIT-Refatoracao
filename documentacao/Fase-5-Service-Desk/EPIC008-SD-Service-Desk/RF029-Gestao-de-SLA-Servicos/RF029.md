# RF-029: Gestão de SLA - Serviços

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC008-SD-Service-Desk
**Fase**: Fase 5 - Service Desk

---

## 1. OBJETIVO DO REQUISITO

Especificar o módulo de **Gestão de SLA para Serviços** do sistema IControlIT, responsável por definir, monitorar e garantir o cumprimento de Service Level Agreements (SLAs) para serviços de TI do catálogo (RF021) e seus respectivos chamados/tickets (RF073, RF074).

Este documento define **o que o sistema deve fazer** para gerenciar metas de atendimento (resposta e resolução), priorizar por matriz de impacto/urgência, calcular consumo de SLA em tempo real, pausar fora do horário, disparar alertas em cascata e escalar automaticamente quando SLAs são violados.

**Diferenciação fundamental**: Este RF foca em **serviços e chamados** de Service Desk, enquanto RF028 trata de **operações físicas** em ativos (instalação, configuração, manutenção preventiva).

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Criação de SLA por serviço do catálogo
- [x] Atualização de SLA existente
- [x] Listagem de SLAs com filtros e paginação
- [x] Exclusão lógica de SLA (soft delete)
- [x] Definição de metas por prioridade (P1/P2/P3/P4)
- [x] Matriz de priorização (Impacto × Urgência)
- [x] Cálculo automático de consumo de SLA em tempo real
- [x] Pausa automática fora de horário de atendimento
- [x] Alertas em cascata (50%, 75%, 90%, 100%)
- [x] Escalação automática quando SLA viola
- [x] Dashboard de compliance em tempo real (SignalR)
- [x] Integração com BrasilAPI para feriados nacionais
- [x] Controle de acesso e isolamento por tenant
- [x] Auditoria completa de operações

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (definida em WF-RF029)
- Tecnologia, framework ou linguagem (definida em arquitetura)
- SLA de operações físicas (RF028)
- Layout, UX ou identidade visual
- Estratégia de deploy ou infraestrutura

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **SLA (Service Level Agreement)** | Contrato que define metas de atendimento para um serviço (tempo resposta, tempo resolução) |
| **Prioridade** | Classificação do chamado (P1-Crítico, P2-Alto, P3-Médio, P4-Baixo) resultante da matriz Impacto × Urgência |
| **Impacto** | Extensão do efeito de um incidente ou problema (Alto, Médio, Baixo) |
| **Urgência** | Rapidez necessária para resolver o incidente (Alta, Média, Baixa) |
| **Tempo de Resposta** | Tempo máximo para primeiro contato com o solicitante após abertura do chamado |
| **Tempo de Resolução** | Tempo máximo para resolver completamente o chamado |
| **Consumo de SLA** | Percentual do tempo de SLA já decorrido (0% = aberto agora, 100% = deadline atingido) |
| **Pausa de SLA** | Suspensão temporária do cálculo de SLA (fora de horário, aguardando usuário) |
| **Escalação** | Transferência do chamado para nível técnico superior quando SLA está em risco |
| **Compliance** | Percentual de chamados que cumpriram as metas de SLA |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Criar SLA para serviço** - Definir metas de resposta/resolução por prioridade
2. **Atualizar SLA existente** - Modificar metas, horário de atendimento, calendário
3. **Consultar SLA por ID** - Visualizar detalhes completos de um SLA específico
4. **Listar SLAs** - Listar com filtros (serviço, prioridade, ativo/inativo) e paginação
5. **Excluir SLA** - Exclusão lógica (soft delete) preservando auditoria
6. **Calcular consumo de SLA** - Atualização em tempo real do percentual consumido
7. **Pausar/retomar SLA** - Pausa automática fora de horário e manual quando aguardando usuário
8. **Disparar alertas** - Notificações automáticas em 50%, 75%, 90%, 100% de consumo
9. **Escalar chamado** - Escalação automática para nível superior quando SLA viola
10. **Dashboard de compliance** - Visibilidade em tempo real via SignalR de % atendimento, violações, tendências

---

## 5. REGRAS DE NEGÓCIO

### RN-RF029-001 — Matriz de Priorização Impacto × Urgência

**Descrição**: A prioridade de um chamado é determinada automaticamente pelo cruzamento de Impacto e Urgência, conforme matriz pré-definida.

**Justificativa**: Elimina subjetividade na priorização, garante consistência e permite atribuição automática de metas de SLA.

**Critério de Aceite**:
- Impacto Alto + Urgência Alta → P1 (Crítico)
- Impacto Alto + Urgência Média OU Impacto Médio + Urgência Alta → P2 (Alto)
- Impacto Médio + Urgência Média OU Impacto Baixo + Urgência Alta → P3 (Médio)
- Demais combinações → P4 (Baixo)
- Sistema DEVE aplicar matriz automaticamente ao criar chamado
- Usuário NÃO pode alterar prioridade manualmente (regra de negócio)

---

### RN-RF029-002 — Metas de SLA por Prioridade P1 (Crítico)

**Descrição**: Chamados com Prioridade P1 (Crítico) possuem metas rigorosas: resposta em 15 minutos, resolução em 4 horas.

**Justificativa**: P1 indica alto impacto e alta urgência, exigindo resposta e resolução ágeis para minimizar indisponibilidade crítica.

**Critério de Aceite**:
- Tempo de resposta máximo: 15 minutos
- Tempo de resolução máximo: 4 horas
- Sistema DEVE calcular deadlines automaticamente ao criar chamado P1
- Violação de deadline DEVE disparar escalação automática

---

### RN-RF029-003 — Metas de SLA por Prioridade P2 (Alto)

**Descrição**: Chamados com Prioridade P2 (Alto) possuem metas moderadas: resposta em 1 hora, resolução em 8 horas.

**Justificativa**: P2 indica alto impacto mas urgência média (ou vice-versa), requer resposta rápida mas resolução pode levar mais tempo.

**Critério de Aceite**:
- Tempo de resposta máximo: 1 hora (60 minutos)
- Tempo de resolução máximo: 8 horas
- Sistema DEVE calcular deadlines automaticamente ao criar chamado P2

---

### RN-RF029-004 — Metas de SLA por Prioridade P3 (Médio)

**Descrição**: Chamados com Prioridade P3 (Médio) possuem metas relaxadas: resposta em 4 horas, resolução em 24 horas.

**Justificativa**: P3 indica impacto e urgência média, permitindo resposta mais lenta com resolução em tempo comercial normal.

**Critério de Aceite**:
- Tempo de resposta máximo: 4 horas (240 minutos)
- Tempo de resolução máximo: 24 horas
- Sistema DEVE calcular deadlines automaticamente ao criar chamado P3

---

### RN-RF029-005 — Metas de SLA por Prioridade P4 (Baixo)

**Descrição**: Chamados com Prioridade P4 (Baixo) possuem metas mais relaxadas: resposta em 8 horas, resolução em 72 horas.

**Justificativa**: P4 indica baixo impacto e baixa urgência, permitindo resposta e resolução em escala de dias.

**Critério de Aceite**:
- Tempo de resposta máximo: 8 horas (480 minutos)
- Tempo de resolução máximo: 72 horas (3 dias)
- Sistema DEVE calcular deadlines automaticamente ao criar chamado P4

---

### RN-RF029-006 — Pausa Automática Fora de Horário de Atendimento

**Descrição**: SLA pausa automaticamente fora do horário de atendimento configurado (comercial 08:00-17:00, 24x7, plantão 18:00-08:00) e retoma automaticamente quando entra em horário.

**Justificativa**: Garante que tempo fora de expediente não conte contra SLA, tornando metas alcançáveis mesmo fora do horário comercial.

**Critério de Aceite**:
- Sistema DEVE verificar horário de atendimento a cada minuto
- Fora de horário → SLA pausado automaticamente, registro de timestamp de pausa
- Retorno ao horário → SLA retomado automaticamente, tempo de pausa NÃO conta no consumo
- Calendário DEVE considerar: dias úteis, finais de semana, feriados nacionais (BrasilAPI)
- Usuário PODE pausar manualmente (ex: aguardando informação do solicitante)

---

### RN-RF029-007 — Alertas em Cascata

**Descrição**: Sistema dispara automaticamente alertas quando SLA atinge 50%, 75%, 90% e 100% de consumo. Cada alerta é uma notificação (SignalR, Email, SMS) com severidade crescente.

**Justificativa**: Alertas escalonados permitem intervenção progressiva antes da violação total do SLA.

**Critério de Aceite**:
- 50% consumido → SignalR notificação (informativo, ícone amarelo)
- 75% consumido → SignalR + Email (atenção, ícone laranja)
- 90% consumido → SignalR + Email + SMS (urgente, ícone vermelho piscando)
- 100% consumido (violado) → SignalR + Email + SMS + Escalação automática (crítico, alerta sonoro)
- Cada alerta DEVE ser registrado uma única vez por threshold
- Sistema NÃO deve disparar alerta duplicado para mesmo threshold

---

### RN-RF029-008 — Escalação Automática Quando SLA Viola

**Descrição**: Quando SLA atinge 100% de consumo (deadline atingido), o sistema automaticamente escala o chamado para nível técnico superior e notifica responsáveis.

**Justificativa**: Garante que SLA violado receba atenção imediata de especialista, minimizando tempo de violação contínua.

**Critério de Aceite**:
- SLA 100% consumido + Chamado NÃO resolvido → Escalação automática
- Níveis de escalação: N1 → N2 → N3 → Especialista
- Sistema DEVE atribuir chamado para fila do nível superior
- Sistema DEVE notificar supervisor do nível superior (SignalR + Email + SMS)
- Sistema DEVE registrar histórico de escalação (timestamp, de qual nível, para qual nível, motivo: "SLA Violado")
- Escalação PODE ser revertida apenas por supervisor

---

### RN-RF029-009 — Cálculo de SLA Exclui Pausas e Feriados

**Descrição**: O cálculo de tempo consumido de SLA exclui períodos em pausa (fora de horário, pausas manuais) e feriados nacionais/estaduais/municipais.

**Justificativa**: Garante cálculo justo de SLA, não penalizando por indisponibilidade externa (finais de semana, feriados, aguardando usuário).

**Critério de Aceite**:
- Cálculo DEVE considerar apenas tempo útil (dentro de horário de atendimento)
- Pausas (automáticas ou manuais) NÃO contam no consumo
- Feriados nacionais NÃO contam no consumo (obtidos via BrasilAPI)
- Sistema DEVE recalcular consumo a cada minuto
- Fórmula: `Consumo% = (TempoDecorrido - TempoPausado) / TempoTotal * 100`

---

### RN-RF029-010 — Isolamento Multi-Tenancy por ClienteId

**Descrição**: Toda entidade de SLA (SlaServico, SlaCalculacao, SlaAlert) DEVE possuir ClienteId para isolamento total de dados por cliente.

**Justificativa**: Garante segurança e privacidade entre clientes, impede vazamento de dados.

**Critério de Aceite**:
- Toda query DEVE filtrar automaticamente por ClienteId do usuário logado
- Usuário do Cliente A NÃO pode acessar SLAs do Cliente B (retornar HTTP 403)
- Validação de ClienteId DEVE ocorrer em todas as operações (CRUD, cálculo, alertas)
- Índices de banco DEVEM incluir ClienteId para performance

---

### RN-RF029-011 — Soft Delete com IsDeleted

**Descrição**: Exclusão lógica de SLA utiliza flag IsDeleted = true, preservando histórico de auditoria.

**Justificativa**: Permite recuperação de dados, auditoria histórica e evita cascata de exclusão de dados relacionados.

**Critério de Aceite**:
- DELETE /api/sla-servicos/{id} DEVE setar IsDeleted = true (não remover fisicamente)
- Query padrão DEVE filtrar IsDeleted = false automaticamente
- Auditoria DEVE registrar quem excluiu, quando e motivo
- SLA excluído NÃO aparece em listagens normais
- SLA excluído PODE ser restaurado (setar IsDeleted = false) apenas por administrador

---

### RN-RF029-012 — Integração com BrasilAPI para Feriados

**Descrição**: Sistema integra com API pública BrasilAPI para obter feriados nacionais, estaduais e municipais (GET https://brasilapi.com.br/api/feriados/v1/{ano}).

**Justificativa**: Garante cálculo preciso de SLA excluindo feriados legais, sem manutenção manual de calendário.

**Critério de Aceite**:
- Sistema DEVE consultar BrasilAPI uma vez por ano e cachear feriados
- Cache DEVE ter TTL de 365 dias
- Em caso de falha da API, sistema DEVE usar cache do ano anterior (log warning)
- Feriados DEVEM ser considerados como "fora de horário" para cálculo de SLA
- Administrador PODE adicionar feriados municipais/estaduais manualmente (não cobertos pela BrasilAPI)

---

### RN-RF029-013 — Campos Obrigatórios na Criação de SLA

**Descrição**: Campos definidos como obrigatórios devem estar presentes e válidos ao criar SLA.

**Justificativa**: Garantir integridade mínima dos dados.

**Critério de Aceite**:
- Campos obrigatórios: ServicoId, Prioridade, TempoResposta, TempoResolucao, HorarioAtendimento, ClienteId
- Campo ausente ou vazio → rejeição HTTP 400 com mensagem específica
- Tipo inválido → rejeição HTTP 400
- Validação DEVE ocorrer antes de persistir no banco

---

### RN-RF029-014 — Unicidade de SLA por Serviço e Prioridade

**Descrição**: Um serviço pode ter no máximo um SLA por combinação de prioridade e cliente.

**Justificativa**: Evita ambiguidade na aplicação de metas de SLA.

**Critério de Aceite**:
- Sistema DEVE validar unicidade antes de criar SLA
- Tentativa de criar SLA duplicado (mesmo ServicoId + Prioridade + ClienteId) → rejeição HTTP 409 "Conflict: SLA já existe para este serviço e prioridade"
- Atualização de SLA NÃO altera Prioridade (campo imutável após criação)

---

## 6. ESTADOS DA ENTIDADE SLA

| Estado | Descrição |
|--------|-----------|
| **Ativo** | SLA ativo e sendo aplicado a novos chamados |
| **Inativo** | SLA temporariamente desativado (não aplicado a novos chamados, chamados existentes mantêm SLA) |
| **Excluído** | SLA excluído logicamente (IsDeleted = true), não aparece em listagens |

### Transições permitidas

| De | Para |
|----|------|
| Ativo | Inativo |
| Inativo | Ativo |
| Ativo | Excluído |
| Inativo | Excluído |

**Nota**: NÃO há transição de Excluído para Ativo/Inativo (apenas restauração via admin).

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre | Payload |
|--------|---------------|---------|
| `sla.criado` | Após criação de SLA | { SlaId, ServicoId, Prioridade, TempoResposta, TempoResolucao, ClienteId } |
| `sla.atualizado` | Após atualização de SLA | { SlaId, CamposAlterados[] } |
| `sla.excluido` | Após exclusão lógica | { SlaId, DeletadoPor, Timestamp } |
| `sla.alerta_disparado` | Alerta de consumo (50/75/90/100%) | { ChamadoId, SlaId, Threshold, ConsumoAtual } |
| `sla.violado` | SLA atinge 100% | { ChamadoId, SlaId, TempoViolacao, Deadline } |
| `sla.escalado` | Escalação automática | { ChamadoId, DeNivel, ParaNivel, Motivo } |
| `sla.pausado` | Pausa manual ou automática | { ChamadoId, SlaId, Motivo, Timestamp } |
| `sla.retomado` | Retomada após pausa | { ChamadoId, SlaId, TempoPausado, Timestamp } |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant (ClienteId obrigatório em todas queries)
- Nenhuma regra de negócio pode ser ignorada (validação obrigatória)
- Erros devem ser previsíveis e rastreáveis (HTTP status codes padrão, mensagens claras)
- Auditoria deve registrar quem, quando, o que mudou e de qual IP
- Performance: cálculo de SLA a cada 1 minuto para todos chamados ativos (job assíncrono)
- Performance: dashboard em tempo real atualizado via SignalR a cada 5 segundos
- Segurança: validação de permissões em todos endpoints
- Segurança: proteção contra SQL Injection (EF Core parametrizado)
- Segurança: proteção contra XSS (sanitização no frontend Angular)

---

## 9. SEGURANÇA

### 9.1 Controle de Acesso

- Autenticação JWT obrigatória em todos endpoints
- Validação de permissões RBAC antes de executar operação
- Isolamento multi-tenant rigoroso (ClienteId em todas queries)
- Proteção contra CSRF (tokens em mutações)

### 9.2 Proteções Implementadas

| Proteção | Descrição |
|----------|-----------|
| **SQL Injection** | Entity Framework Core com queries parametrizadas |
| **XSS** | Angular sanitiza strings automaticamente |
| **CSRF** | Token obrigatório em POST/PUT/DELETE |
| **Rate Limiting** | Máximo 100 requisições/minuto por usuário |
| **Auditoria** | Todos acessos/alterações registrados (UserId, IP, timestamp, ação) |

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF029.md** - Casos de Uso (UC00-UC04 + casos especiais)
- **MD-RF029.md** - Modelo de Dados (entidades, DDL, migrations)
- **WF-RF029.md** - Wireframes e fluxos visuais
- **TC-RF029.yaml** - Casos de Teste (Backend, Frontend, E2E, Segurança)
- **MT-RF029.yaml** - Massas de Teste

---

## 11. RASTREABILIDADE

| Artefato | Status | Obrigatório |
|----------|--------|-------------|
| Casos de Uso (UC-RF029.md) | Criado | Sim |
| Modelo de Dados (MD-RF029.md) | Criado | Sim |
| Wireframes (WF-RF029.md) | Criado | Sim |
| Casos de Teste (TC-RF029.yaml) | Pendente | Sim |
| Massas de Teste (MT-RF029.yaml) | Pendente | Sim |

### Dependências de RFs

| RF Dependente | Descrição |
|---------------|-----------|
| RF021 | Catálogo de Serviços (fonte de serviços para SLA) |
| RF073 | Gestão de Chamados (chamados têm SLA aplicado) |
| RF074 | Gestão de Tickets (tickets têm SLA aplicado) |
| RF028 | Gestão de SLA Operações (compartilha lógica de cálculo) |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0 (separação RF/RL completa, 14 RNs em linguagem natural) | Agência ALC - alc.dev.br |
| 1.0 | 2025-12-28 | Versão inicial com referências ao legado misturadas | Claude Code |
