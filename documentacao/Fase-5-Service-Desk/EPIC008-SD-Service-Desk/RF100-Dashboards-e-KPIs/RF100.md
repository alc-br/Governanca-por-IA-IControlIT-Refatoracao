# RF-100: Dashboards e KPIs com Análise Preditiva

**Versão**: 2.0
**Data**: 2025-12-31
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC008-SD-Service-Desk
**Fase**: Fase 5 - Service Desk

---

## 1. OBJETIVO DO REQUISITO

Implementar módulo de **Dashboards com Análise Preditiva e Machine Learning** que transforma históricos de dados em inteligência preditiva actionável. O RF-100 fornece forecasting, detecção de anomalias, clustering inteligente e recomendações prescritivas via modelos de Machine Learning, permitindo que gestores executivos identifiquem tendências futuras, anomalias operacionais em tempo real, riscos de churn de clientes/contratos, e recebam recomendações automáticas para otimização de recursos.

Diferentemente de dashboards tradicionais que exibem métricas passadas, o RF-100 responde "o que acontecerá e o que fazer", utilizando Azure Machine Learning Studio, ML.NET, Prophet (Facebook) e Scikit-learn.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [ ] Forecasting automático de custos e KPIs (3, 6, 12 meses) com intervalo de confiança >= 95%
- [ ] Detecção de anomalias em tempo real (Z-score, Isolation Forest)
- [ ] Clustering inteligente de ativos/usuários (K-means, DBSCAN)
- [ ] Churn prediction de clientes/contratos (score 0-100, precisão >= 70%)
- [ ] What-If Analysis (simulação de cenários hipotéticos, máximo 5 paralelos)
- [ ] Análise de tendências com decomposição STL (Seasonal Trend Decomposition)
- [ ] Recomendações prescritivas automatizadas
- [ ] Dashboard inteligente com confidence bands e visualizações interativas
- [ ] Retreinamento automático mensal de modelos ML via Hangfire
- [ ] Análise de correlação entre KPIs (Pearson/Spearman)
- [ ] Cache de resultados ML em Redis (24 horas)
- [ ] Auditoria completa de predições e recomendações (retenção 2 anos)
- [ ] Multi-tenancy com ClienteId obrigatório em todos datasets
- [ ] Integrações com i18n, auditoria, RBAC, Central de Funcionalidades

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (responsabilidade do frontend Angular)
- Tecnologia de visualização de gráficos (D3.js, Power BI, etc.)
- Layout, UX ou identidade visual
- Estratégia de deploy ou infraestrutura
- Implementação de outros módulos de Service Desk não relacionados

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Forecasting** | Uso de séries temporais históricas para prever valores futuros. Métodos: ARIMA, Prophet, Exponential Smoothing. Entrada: histórico mínimo 12 meses. Saída: série prevista com intervalo de confiança 95%. |
| **Detecção de Anomalias** | Identificação de pontos de dados que desviam significativamente do padrão esperado. Métodos: Z-score, Isolation Forest, Moving Average Deviation. Threshold padrão: Z-score > 3 (99.7% confiança). |
| **Clustering** | Particionamento não supervisionado que agrupa dados similares. Métodos: K-means, DBSCAN, Hierarchical Clustering. Restrições: mínimo 3 clusters, máximo 10. |
| **Churn Prediction** | Modelo que prediz probabilidade de um cliente/contrato ser cancelado nos próximos 30-90 dias. Output: score 0-100 (>70 = risco alto). Precisão mínima: 70%. |
| **What-If Analysis** | Simulação de impacto de mudanças operacionais em KPIs futuros. Usuário define cenário, sistema prediz impacto em SLA, custos, receita. Máximo 5 cenários simultâneos. |
| **Análise de Tendências** | Decomposição de série temporal em componentes (trend, seasonality, noise). Identifica mudanças de longo prazo, padrões sazonais e anomalias. |
| **Confidence Interval** | Faixa de valores em que a previsão é esperada com certa probabilidade. Padrão: mínimo 95% confiança. Cálculo: baseado em desvio padrão histórico + erro do modelo. |
| **ClienteId** | Identificador único do tenant. Obrigatório em todos os datasets para garantir isolamento multi-tenant. |
| **RMSE** | Root Mean Squared Error - métrica de erro médio do modelo. |
| **MAE** | Mean Absolute Error - métrica de erro absoluto médio. |
| **Z-score** | Número de desvios-padrão que um valor está da média. Fórmula: (valor - média) / desvio_padrão. |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Forecasting Automático** - Previsão de custos/KPIs (3, 6, 12 meses) usando Prophet/ARIMA
2. **Detecção de Anomalias em Tempo Real** - Monitor contínuo de KPIs com alertas automáticos
3. **Clustering Inteligente** - Segmentação automática de ativos/usuários em 3-10 clusters
4. **Churn Prediction** - Identificação de clientes/contratos em risco de cancelamento
5. **What-If Analysis** - Simulação de cenários hipotéticos com impacto previsto
6. **Análise de Tendências** - Decomposição STL de séries temporais
7. **Recomendações Prescritivas** - Sistema analisa padrões e recomenda ações
8. **Dashboard Inteligente** - Visualização com confidence bands e cores inteligentes
9. **Retreinamento Automático** - Job Hangfire mensal para manter modelos atualizados
10. **Correlação de KPIs** - Análise Pearson/Spearman entre métricas

---

## 5. REGRAS DE NEGÓCIO

### RN-100-001: Forecast Requer Mínimo 12 Meses de Histórico

**Descrição**: Qualquer modelo de forecasting (Prophet, ARIMA, Exponential Smoothing) requer mínimo 12 meses de dados históricos para treinamento. Dados com menos de 12 meses retornam erro 400 "Insufficient Historical Data".

**Justificativa**: Modelos de séries temporais necessitam capturar padrões sazonais completos. Com menos de 12 meses, não há ciclo completo de sazonalidade, resultando em previsões imprecisas.

**Critério de Aceite**:
- Sistema valida contagem de datapoints históricos >= 365 dias
- Se insuficiente, retorna HTTP 400 com mensagem clara
- Nenhuma previsão é gerada sem dados mínimos

---

### RN-100-002: Anomaly Detection com Threshold Configurável (Padrão Z-score > 3)

**Descrição**: Sistema detecta anomalias usando Z-score normalizado. Threshold padrão: |Z-score| > 3 (99.7% confiança). Threshold é configurável por tipo de métrica.

**Justificativa**: Z-score é estatisticamente robusto e ajusta-se dinamicamente. Threshold 3 evita falsos positivos. Configurabilidade permite ajuste fino por negócio.

**Critério de Aceite**:
- Cálculo correto: Z = (valor - média) / desvio_padrão
- Threshold padrão = 3.0 se não configurado
- Threshold respeitado em alertas automáticos
- Anomalia dispara alerta em tempo real

---

### RN-100-003: Modelos ML Retreinados Mensalmente via Hangfire

**Descrição**: Cada modelo ML é retreinado automaticamente todo mês (domingo 02h UTC via Hangfire). Métricas de performance (RMSE, MAE, acurácia) são registradas. Se performance degrada >5% vs mês anterior, flag para revisão manual.

**Justificativa**: Modelos ML degradam com o tempo ("model drift"). Retreinamento mensal mantém modelos atualizados. Validação automática evita deploy de modelos ruins.

**Critério de Aceite**:
- Job Hangfire agendado todo domingo 02h UTC
- Usa dados dos últimos 12-24 meses (janela deslizante)
- Valida métricas: RMSE, MAE, Accuracy
- Se degradação > 5%, notifica admin sem fazer deploy
- Se degradação <= 5%, faz deploy automático

---

### RN-100-004: Forecast Requer Intervalo de Confiança Mínimo 95%

**Descrição**: Qualquer forecast gerado deve ter intervalo de confiança >= 95%. Forecast com confiança < 95% retorna erro 422 "Confidence Too Low".

**Justificativa**: Forecast com confiança < 95% é especulação, não previsão confiável. Garante que predictions exibidas são estatisticamente significativas.

**Critério de Aceite**:
- Sistema calcula confidence level baseado em RMSE histórico
- Se confidence < 0.95, rejeita forecast
- Bounds calculados como: valor ± 1.96 * RMSE (95% confiança)
- Forecast publicado sempre inclui UpperBound, LowerBound

---

### RN-100-005: Clustering Deve ter Mínimo 3 Clusters, Máximo 10

**Descrição**: Operação de clustering (K-means, DBSCAN) deve gerar entre 3 e 10 clusters. Se k < 3, retorna erro. Se k > 10, trunca para 10. Elbow method determina k ótimo automaticamente.

**Justificativa**: 3 clusters (mínimo) garante segmentação significativa. 10 clusters (máximo) evita fragmentação excessiva. Range 3-10 é padrão em segmentação.

**Critério de Aceite**:
- Elbow method executado para determinar k ótimo
- Se k calculado < 3, ajusta para 3
- Se k calculado > 10, ajusta para 10
- Resultado sempre entre [3, 10] clusters

---

### RN-100-006: Churn Prediction com Score >= 70% de Precisão

**Descrição**: Modelo de churn prediction requer acurácia mínima de 70% e precision/recall balanceados. Output: score 0-100 onde score >= 70 = risco alto.

**Justificativa**: Score de precisão 70% garante que cliente sinalizado como risco alto tem 70% probabilidade real de churn. Evita falsos positivos.

**Critério de Aceite**:
- Modelo validado com precision >= 0.70
- Features utilizadas: recência, frequência, monetário, NPS, tickets suporte
- Score normalizado entre 0-100
- Score >= 70 classifica como "risco alto"

---

### RN-100-007: What-If Analysis Limitado a 5 Cenários Simultâneos

**Descrição**: Sistema permite máximo 5 cenários what-if simultâneos por usuário. Tentativa de criar 6º cenário retorna erro 429 "Too Many Scenarios". Cada simulação executa em < 10 segundos.

**Justificativa**: Limite 5 evita sobrecarga de CPU/memória no backend. 5 cenários paralelos é suficiente para análise de decisão. Timeout 10s garante resposta rápida.

**Critério de Aceite**:
- Sistema valida contagem de cenários abertos por UserId
- Se >= 5, retorna HTTP 429
- Simulação com timeout 10 segundos
- Resultados cacheados por 1 hora

---

### RN-100-008: Resultados ML Cacheados por 24 Horas (Redis)

**Descrição**: Qualquer resultado de ML (forecast, anomaly detection, clustering, churn prediction) é cacheado em Redis por 24 horas. Cache é invalidado se: (a) 24h expiraram, (b) usuário força refresh, (c) novo dado adicionado, (d) modelo retreinado.

**Justificativa**: Recompilação de modelos é custosa. Cache 24h reduz latência (< 100ms vs 5-10s) e custos. Invalidação automática garante relevância.

**Critério de Aceite**:
- Cache key formato: `forecast:{clienteId}:{metricName}:{params}`
- TTL = 24 horas (AbsoluteExpirationRelativeToNow)
- Cache miss: gera novo resultado e cacheia
- Cache hit: retorna resultado em < 100ms
- Invalidação automática quando novo dado chega

---

### RN-100-009: Multi-tenancy - ClienteId em Todos os Datasets

**Descrição**: Todos os dados de ML (features, histórico, registros) devem estar particionados por ClienteId. É PROIBIDO construir forecasts/clustering com dados combinados de múltiplos clientes. Modelos são treinados por cliente, separadamente.

**Justificativa**: Garantir isolamento de dados entre clientes (SaaS multi-tenancy). Compliance LGPD/GDPR.

**Critério de Aceite**:
- Toda query ML recebe ClienteId obrigatório
- Filtro `WHERE ClienteId = @clienteId` sempre presente
- ClienteId validado como GUID válido
- Tentativa de query sem ClienteId retorna erro 400

---

### RN-100-010: Auditoria de Todas as Predições e Recomendações

**Descrição**: Sistema registra em AuditLog CADA predição gerada, CADA anomalia detectada, CADA recomendação emitida. Auditoria é imutável (append-only) e retida por 2 anos (LGPD).

**Justificativa**: Rastreabilidade completa de decisões baseadas em ML. LGPD/compliance exige log de operações. Defesa em caso de litígio.

**Critério de Aceite**:
- Registro inclui: timestamp, tipo (forecast/anomaly/churn/whatif), usuário, parâmetros entrada, resultado, score confiança
- Auditoria imutável (IsDeleted soft delete apenas)
- Retenção 2 anos (job Hangfire cleanup)
- Nenhuma operação ML ocorre sem auditoria

---

## 6. ESTADOS DA ENTIDADE

Dashboards e modelos ML não possuem estados de lifecycle. São entidades read-heavy com dados imutáveis após geração.

| Estado | Descrição |
|--------|-----------|
| N/A | RF-100 trabalha com dados históricos e predições, não possui estados de entidade |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre |
|--------|---------------|
| `MLForecastGenerated` | Após geração de forecast com confiança >= 95% |
| `MLAnomalyDetected` | Quando Z-score > threshold e anomalia confirmada |
| `MLClusteringCompleted` | Após execução de K-means/DBSCAN com k clusters |
| `MLChurnPredicted` | Após predição de churn com score calculado |
| `MLWhatIfSimulated` | Após simulação de cenário what-if |
| `MLModelRetrained` | Após retreinamento mensal de modelo |
| `MLRecommendationGenerated` | Quando sistema gera recomendação prescritiva |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação ML pode violar isolamento de tenant (ClienteId obrigatório)
- Nenhum forecast pode ser publicado com confiança < 95%
- Nenhum modelo pode ser deployed com degradação > 5%
- Erros devem ser previsíveis e rastreáveis (HTTP codes corretos)
- Auditoria deve registrar quem, quando e o que mudou (2 anos retenção)
- Cache Redis deve funcionar (fallback se indisponível)
- Hangfire jobs devem executar sem falha (retry automático 3x)

---

## 9. SEGURANÇA

- **Validação de ClienteId**: GUID válido obrigatório em todos endpoints
- **Proteção contra Injeção**: Parameterização de queries, nunca string interpolation
- **Controle de Permissões**: RBAC por operação (ml:forecast:create, ml:anomaly:read, etc.)
- **Isolamento Multi-tenant**: Row-Level Security via ClienteId
- **Rate Limiting**: Máximo 5 what-if simultâneos, máximo 100 requests/min por IP
- **Cache com TTL**: Redis 24h evita recalcular modelos a cada request
- **Auditoria Imutável**: Append-only, impossível apagar (compliance)
- **TLS 1.3**: Comunicação Azure ML ↔ Backend criptografada
- **Secret Management**: Azure KeyVault para chaves Azure ML

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF100.md** (Casos de Uso): 6+ cenários (forecasting, anomaly detection, clustering, churn, what-if, trend analysis)
- **MD-RF100.md** (Modelo de Dados): Schema SQL para MetricDataPoint, ModelMetrics, ClusteringResult, ChurnPrediction, Scenario, AuditLog
- **WF-RF100.md** (Workflows): Telas Angular para dashboards, forecast view, anomaly alerts, clustering viz, churn report
- **TC-RF100.yaml** (Casos de Teste): Validação de confiança 95%, threshold Z-score, multi-tenancy, cache Redis
- **MT-RF100.yaml** (Massas de Teste): Datasets históricos 12+ meses, clientes em risco, anomalias sintéticas

---

## 11. RASTREABILIDADE

| Artefato | Status |
|----------|--------|
| RF-100.md v2.0 | ✅ Criado (este documento) |
| RL-RF100.md | ⏳ A criar (referência ao legado) |
| UC-RF100.md | ⏳ Pendente |
| MD-RF100.md | ⏳ Pendente |
| WF-RF100.md | ⏳ Pendente |
| TC-RF100.yaml | ⏳ Pendente |
| MT-RF100.yaml | ⏳ Pendente |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-31 | Migração v1.0 → v2.0 - Separação RF/RL (CONTRATO-RF-PARA-RL) | Agência ALC - alc.dev.br |
| 1.0 | 2025-12-28 | Versão inicial com referências ao legado | Claude Code |
