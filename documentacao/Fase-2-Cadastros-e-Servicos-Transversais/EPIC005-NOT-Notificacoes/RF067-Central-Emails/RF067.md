# RF067: Central de E-mails

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC005-NOT - Notificações
**Fase**: Fase 2 - Cadastros e Serviços Transversais

---

## 1. OBJETIVO DO REQUISITO

Prover um sistema centralizado de gestão de envio de e-mails transacionais e marketing, garantindo deliverability através de filas de prioridade, retry automático, rastreamento completo de eventos (entrega, abertura, cliques, bounces), gerenciamento de templates, blacklist, SMTP pools com failover e conformidade com leis anti-spam (LGPD, CAN-SPAM).

Este documento define **o que o sistema deve fazer** em termos de gerenciamento de e-mails, sob quais condições e quais garantias devem ser preservadas, sem definir implementação técnica específica.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Enfileiramento de e-mails com priorização (crítica, alta, normal, baixa, bulk)
- [x] Envio através de múltiplos servidores SMTP com balanceamento
- [x] Retry automático com backoff exponencial para falhas temporárias
- [x] Rastreamento completo de eventos (enviado, entregue, aberto, clicado, bounce, spam, unsubscribe)
- [x] Gestão de blacklist automática e manual
- [x] Rate limiting por domínio para evitar spam flags
- [x] Warmup de IPs novos com incremento gradual de volume
- [x] Validação de e-mail (sintaxe e MX record)
- [x] Unsubscribe com um clique (conformidade LGPD)
- [x] Monitoramento de saúde SMTP
- [x] Configuração de SPF, DKIM, DMARC
- [x] Integração com templates de e-mail (RF064)
- [x] Supressão de duplicatas (mesmo e-mail não enviado 2x em 24h)
- [x] Relatórios de deliverability
- [x] Suporte a múltiplos provedores (SendGrid, Mailgun, Amazon SES, SMTP próprio)
- [x] Controle de acesso e isolamento por tenant
- [x] Auditoria de operações

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica de criação de templates (coberto por RF064)
- Envio de SMS ou notificações push
- Gerenciamento de campanhas de marketing (funcionalidade futura)
- Análise de conteúdo de e-mail (anti-phishing)
- Layout, UX ou identidade visual
- Estratégia de deploy ou infraestrutura

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-----|---------|
| E-mail Transacional | E-mail acionado por ação do usuário (senha reset, confirmação, aprovação) |
| E-mail Marketing | E-mail promocional ou newsletter |
| Prioridade | Nível de urgência que determina ordem de processamento na fila |
| SMTP Pool | Conjunto de servidores SMTP para balanceamento e failover |
| Hard Bounce | Falha permanente de entrega (e-mail inexistente) |
| Soft Bounce | Falha temporária de entrega (caixa cheia, servidor temporariamente indisponível) |
| Deliverability | Taxa de sucesso de entrega de e-mails |
| SPF/DKIM/DMARC | Protocolos de autenticação de e-mail |
| Warmup | Processo gradual de aumento de volume em IPs novos |
| Blacklist | Lista de e-mails que não devem receber mensagens |
| Rate Limiting | Limite de e-mails por domínio/período |
| Tenant | Unidade lógica de isolamento de dados (empresa) |

---

## 4. FUNCIONALIDADES COBERTAS

1. Criar solicitação de envio de e-mail
2. Enfileirar e-mail com priorização
3. Processar fila de envio com retry automático
4. Rastrear eventos de e-mail (entrega, abertura, cliques, bounces)
5. Gerenciar blacklist (adicionar, remover, consultar)
6. Configurar e monitorar servidores SMTP
7. Validar e-mails antes do envio
8. Processar unsubscribe
9. Gerar relatórios de deliverability
10. Configurar provedores de e-mail

---

## 5. REGRAS DE NEGÓCIO

### RN-RF067-01 — Fila de Prioridades

**Descrição**: E-mails devem ser processados por ordem de prioridade, onde e-mails críticos têm precedência absoluta sobre marketing.

**Justificativa**: Garantir que operações críticas (reset de senha, 2FA, aprovações) não sejam atrasadas por campanhas de marketing.

**Critério de Aceite**:
- E-mail com prioridade crítica deve ser processado antes de qualquer e-mail de prioridade inferior
- Ordem de prioridades: Crítica (1) > Alta (2) > Normal (3) > Baixa (4) > Bulk (5)
- Dentro da mesma prioridade, processar por ordem de criação (FIFO)

---

### RN-RF067-02 — SMTP Pools com Balanceamento

**Descrição**: Sistema deve suportar múltiplos servidores SMTP e selecionar o melhor disponível baseado em estratégia configurada.

**Justificativa**: Garantir alta disponibilidade e distribuir carga entre servidores.

**Critério de Aceite**:
- Estratégias suportadas: ROUND_ROBIN, LEAST_USED, FAILOVER
- Servidor marcado como inativo não deve ser selecionado
- Servidor com saúde não-OK deve ser ignorado
- Em caso de falha, tentar próximo servidor disponível

---

### RN-RF067-03 — Retry Automático com Backoff Exponencial

**Descrição**: Em caso de falha temporária, sistema deve retentar envio até 5 vezes com intervalo exponencial.

**Justificativa**: Maximizar taxa de entrega sem sobrecarregar servidores.

**Critério de Aceite**:
- Máximo 5 tentativas por e-mail
- Intervalo entre tentativas: 2, 4, 8, 16, 32 minutos (potência de 2)
- Após 5 falhas, marcar como FALHA_PERMANENTE
- Soft bounce deve seguir retry, hard bounce deve blacklistar imediatamente

---

### RN-RF067-04 — Rastreamento Completo de Eventos

**Descrição**: Sistema deve rastrear todos os eventos do ciclo de vida de um e-mail.

**Justificativa**: Prover métricas de engajamento e diagnóstico de problemas de deliverability.

**Critério de Aceite**:
- Eventos rastreados: ENVIADO, ENTREGUE, ABERTO, CLICADO, BOUNCE, SPAM, UNSUBSCRIBE
- Cada evento deve registrar: timestamp, IP do usuário, user agent
- Abertura rastreada via pixel invisível (quando HTML)
- Cliques rastreados via URL redirecionada

---

### RN-RF067-05 — Blacklist Automática para Hard Bounce

**Descrição**: E-mails que retornam hard bounce devem ser automaticamente adicionados à blacklist.

**Justificativa**: Evitar desperdício de recursos e manter boa reputação de envio.

**Critério de Aceite**:
- Hard bounce (e-mail inexistente) → adicionar à blacklist automaticamente
- Soft bounce (caixa cheia) → não adicionar à blacklist, fazer retry
- E-mail na blacklist não deve receber novos envios
- Blacklist deve registrar motivo (bounce, spam complaint, unsubscribe manual)

---

### RN-RF067-06 — Rate Limiting por Domínio

**Descrição**: Limitar número de e-mails enviados para o mesmo domínio por hora.

**Justificativa**: Evitar ser marcado como spam por provedores que detectam volume anormal.

**Critério de Aceite**:
- Limite padrão: 100 e-mails por domínio por hora
- Limite deve ser configurável por domínio
- E-mail que exceder limite deve ser enfileirado para próxima janela
- Contadores devem ser resetados a cada hora

---

### RN-RF067-07 — Warmup de IPs Novos

**Descrição**: IPs novos devem ter volume de envio aumentado gradualmente ao longo de 15 dias.

**Justificativa**: Estabelecer reputação positiva com provedores de e-mail.

**Critério de Aceite**:
- Dia 1: máximo 50 e-mails
- Dia 2: máximo 100 e-mails
- Dia 3: máximo 250 e-mails
- Dia 4: máximo 500 e-mails
- Dia 5: máximo 1.000 e-mails
- Dias 6-14: máximo 2.000 e-mails
- Após dia 15: sem limite
- E-mails que excederem limite do dia devem aguardar próximo dia

---

### RN-RF067-08 — Validação de E-mail antes de Enviar

**Descrição**: Validar sintaxe e verificar existência de MX record antes de enfileirar e-mail.

**Justificativa**: Reduzir bounces e economizar recursos.

**Critério de Aceite**:
- Validação de sintaxe (RFC 5322)
- Verificação de MX record do domínio
- E-mail inválido deve ser rejeitado imediatamente
- E-mail sem MX record deve ser rejeitado

---

### RN-RF067-09 — Unsubscribe com Um Clique (LGPD)

**Descrição**: Link de descadastramento deve funcionar sem exigir login do usuário.

**Justificativa**: Conformidade com LGPD e melhores práticas anti-spam.

**Critério de Aceite**:
- Link de unsubscribe deve conter token criptografado com e-mail
- Clicar no link deve adicionar e-mail à blacklist automaticamente
- Não deve exigir autenticação
- Deve exibir página de confirmação
- Unsubscribe deve ser auditado

---

### RN-RF067-10 — Monitoramento de Saúde SMTP

**Descrição**: Executar health check periódico em todos os servidores SMTP configurados.

**Justificativa**: Detectar problemas proativamente e evitar falhas de envio.

**Critério de Aceite**:
- Health check a cada 5 minutos
- Tentativa de conexão em cada servidor
- Marcar servidor como saudável (SaudeOK=true) se conectar com sucesso
- Marcar servidor como não-saudável (SaudeOK=false) em caso de falha
- Enviar alerta para administradores quando servidor ficar não-saudável
- Registrar timestamp do último check bem-sucedido

---

### RN-RF067-11 — Configuração SPF, DKIM, DMARC

**Descrição**: Sistema deve validar e exibir configuração DNS necessária para autenticação de e-mail.

**Justificativa**: Maximizar deliverability através de autenticação adequada.

**Critério de Aceite**:
- Armazenar configuração SPF, DKIM, DMARC por domínio remetente
- Exibir registros DNS necessários para configuração
- Validar se DKIM está corretamente assinando e-mails
- Registrar falhas de autenticação

---

### RN-RF067-12 — Integração com Templates de E-mail

**Descrição**: Sistema deve permitir envio de e-mail utilizando templates cadastrados (RF064).

**Justificativa**: Padronizar comunicação e facilitar manutenção de conteúdo.

**Critério de Aceite**:
- Permitir referenciar template por ID
- Substituir variáveis do template por valores dinâmicos
- Validar que template existe antes de enviar
- Se template não existir, rejeitar envio

---

### RN-RF067-13 — Supressão de Duplicatas

**Descrição**: Não enviar o mesmo e-mail (mesmo destinatário e assunto) duas vezes em 24 horas.

**Justificativa**: Evitar spam e melhorar experiência do usuário.

**Critério de Aceite**:
- Verificar se combinação destinatário+assunto já foi enviada nas últimas 24h
- Se encontrado envio recente, rejeitar novo envio
- Registrar tentativa de duplicata em log
- Contador deve considerar apenas e-mails com status ENVIADO

---

### RN-RF067-14 — Relatórios de Deliverability

**Descrição**: Gerar relatórios consolidados de métricas de envio por período.

**Justificativa**: Permitir análise de desempenho e identificação de problemas.

**Critério de Aceite**:
- Métricas: total enviados, taxa de entrega, taxa de abertura, taxa de bounce, taxa de spam
- Filtrar por período (data início e fim)
- Filtrar por prioridade, provedor, servidor SMTP
- Exibir evolução temporal (gráfico de linha)
- Permitir exportação em CSV/Excel

---

### RN-RF067-15 — Suporte a Múltiplos Provedores

**Descrição**: Suportar envio através de diferentes provedores de e-mail.

**Justificativa**: Permitir uso de serviços especializados (SendGrid, Mailgun) ou SMTP próprio.

**Critério de Aceite**:
- Provedores suportados: SendGrid, Mailgun, Amazon SES, SMTP Próprio
- Configuração de credenciais por provedor
- Seleção de provedor por servidor SMTP
- Adaptar chamada de API conforme provedor
- Normalizar retorno de eventos entre provedores

---

### RN-RF067-16 — Isolamento Multi-Tenant

**Descrição**: Cada tenant (empresa) só pode acessar seus próprios e-mails e configurações.

**Justificativa**: Garantir privacidade e segurança dos dados.

**Critério de Aceite**:
- Todos os e-mails devem ter EmpresaId
- Filtro automático por EmpresaId em todas as consultas
- Tentativa de acesso cruzado deve retornar 404 (não 403)
- Configurações SMTP devem ser isoladas por tenant

---

### RN-RF067-17 — Auditoria de Operações

**Descrição**: Todas as operações críticas devem ser auditadas.

**Justificativa**: Rastreabilidade e conformidade (LGPD).

**Critério de Aceite**:
- Operações auditadas: EMAIL_ENVIADO, EMAIL_BOUNCE, EMAIL_SPAM, EMAIL_UNSUBSCRIBE, SMTP_CONFIGURADO, BLACKLIST_ADICIONADO
- Registrar: usuário, timestamp, IP, before/after
- Auditoria não pode falhar envio (deve ser assíncrona)
- Retenção de 7 anos

---

### RN-RF067-18 — Permissões RBAC

**Descrição**: Cada operação exige permissão explícita.

**Justificativa**: Controle fino de acesso a funcionalidades sensíveis.

**Critério de Aceite**:

| Operação | Permissão |
|-------|---------|
| Enviar e-mail | NOT.EMAILS.SEND |
| Visualizar todos os e-mails | NOT.EMAILS.VIEW_ALL |
| Gerenciar SMTP | NOT.EMAILS.MANAGE_SMTP |
| Gerenciar blacklist | NOT.EMAILS.MANAGE_BLACKLIST |
| Visualizar relatórios | NOT.EMAILS.VIEW_REPORTS |

---

### RN-RF067-19 — Limites de Performance

**Descrição**: Sistema deve processar grandes volumes de e-mails com baixa latência.

**Justificativa**: Garantir escalabilidade.

**Critério de Aceite**:
- Capacidade: 10.000 e-mails por minuto
- E-mail crítico deve ser enviado em menos de 5 segundos (do enfileiramento ao envio)
- E-mail normal deve ser enviado em menos de 30 segundos
- Fila de e-mails não deve exceder 100.000 itens (alertar se exceder)

---

### RN-RF067-20 — Disponibilidade e SLA

**Descrição**: Serviço de envio de e-mails deve ter alta disponibilidade.

**Justificativa**: E-mails transacionais são críticos para operação.

**Critério de Aceite**:
- Disponibilidade: 99.95% uptime
- Taxa de entrega esperada: > 98%
- Alertar se taxa de entrega cair abaixo de 95% em 1 hora
- Failover automático entre servidores SMTP

---

## 6. ESTADOS DA ENTIDADE

### Estados do E-mail

| Estado | Descrição |
|------|-----------|
| FILA | Criado, aguardando processamento |
| ENVIANDO | Em processo de envio |
| ENVIADO | Aceito pelo servidor SMTP |
| ENTREGUE | Confirmado entrega na caixa do destinatário |
| ABERTO | Destinatário abriu o e-mail |
| CLICADO | Destinatário clicou em link |
| BOUNCE | Retornou (hard ou soft bounce) |
| SPAM | Marcado como spam |
| FALHA_PERMANENTE | Falhou após todas as tentativas |

### Transições permitidas

| De | Para |
|---|---|
| FILA | ENVIANDO |
| ENVIANDO | ENVIADO, BOUNCE, FALHA_PERMANENTE |
| ENVIADO | ENTREGUE, BOUNCE |
| ENTREGUE | ABERTO, SPAM |
| ABERTO | CLICADO |

### Estados do Servidor SMTP

| Estado | Descrição |
|------|-----------|
| ATIVO | Configurado e disponível para envio |
| INATIVO | Desabilitado manualmente |
| FALHA | Falha detectada em health check |
| WARMUP | Em processo de warmup (limitado) |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre |
|------|--------------|
| EmailEnfileirado | Após criação do e-mail |
| EmailEnviado | Após envio bem-sucedido |
| EmailEntregue | Após confirmação de entrega |
| EmailAberto | Quando destinatário abre e-mail |
| EmailClicado | Quando destinatário clica em link |
| EmailBounced | Quando e-mail retorna |
| EmailMarcadoComoSpam | Quando destinatário marca como spam |
| EmailUnsubscribe | Quando destinatário cancela inscrição |
| SMTPServerConfigurado | Após configuração de servidor SMTP |
| BlacklistAdicionado | Quando e-mail é adicionado à blacklist |
| BlacklistRemovido | Quando e-mail é removido da blacklist |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant
- Nenhuma regra de negócio pode ser ignorada
- E-mail na blacklist nunca deve ser enviado
- Taxa de entrega deve ser > 98%
- E-mails críticos devem ser enviados em < 5 segundos
- Health check deve detectar falhas em < 5 minutos
- Erros devem ser previsíveis e rastreáveis
- Auditoria deve registrar quem, quando e o que mudou
- Conformidade com LGPD (direito ao unsubscribe)
- Conformidade com CAN-SPAM (identificação de remetente, unsubscribe)

---

## 9. SEGURANÇA

- Validação de entrada obrigatória (sintaxe de e-mail, MX record)
- Proteção contra injeção (sanitizar headers de e-mail)
- Controle de permissões (RBAC)
- Isolamento multi-tenant
- Criptografia de credenciais SMTP em repouso
- Token criptografado para unsubscribe (não expor e-mail em URL)
- Rate limiting para evitar abuso
- Auditoria de operações sensíveis

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- UC-RF067.md (Casos de Uso)
- MD-RF067.md (Modelo de Dados)
- WF-RF067.md (Wireframes)
- TC-RF067.yaml (Casos de Teste)
- MT-RF067.yaml (Massas de Teste)
- user-stories.yaml (User Stories)

---

## 11. RASTREABILIDADE

| Artefato | Gerado |
|--------|-------|
| Casos de Uso | Obrigatório |
| Modelo de Dados | Obrigatório |
| Wireframes | Obrigatório |
| Casos de Teste | Obrigatório |
| Massas de Teste | Obrigatório |
| User Stories | Obrigatório |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|------|------|----------|------|
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0 - Separação RF/RL completa - 20 regras de negócio | Agência ALC - alc.dev.br |
| 1.0 | 2025-01-14 | Versão inicial | Agência ALC - alc.dev.br |
