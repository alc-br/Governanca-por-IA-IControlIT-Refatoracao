# Template de Referência ao Legado (RL-RF067.yaml)
# Versão: 1.0
# Data: 2025-12-30

rf_id: RF067
titulo: "Central de E-mails"

legado:
  sistema: "VB.NET + ASP.NET Web Forms"
  versao: ".NET Framework 4.7.2"
  arquitetura: "Monolítica WebForms com WebServices SOAP"
  banco_dados: "SQL Server (multi-banco, não multi-tenant por EmpresaId)"
  multi_tenant: false
  auditoria: "partial"  # Apenas logs em arquivo texto

# SEÇÃO CRÍTICA: Referencias ao Legado com Destino Obrigatório
referencias:
  - id: "LEG-RF067-001"
    tipo: "tela"
    nome: "Default.aspx - Reset de Senha"
    caminho: "ic1_legado/IControlIT/IControlIT/Default.aspx"
    descricao: |
      Tela de login que envia e-mail para reset de senha usando SmtpClient.
      - Envio síncrono (bloqueia UI em caso de falha SMTP)
      - Sem retry
      - Sem rastreamento de entrega
      - Configuração SMTP em stored procedure
    destino: "substituido"
    justificativa: |
      Substituído por envio assíncrono através da Central de E-mails (RF067).
      E-mail de reset de senha agora tem prioridade CRÍTICA na fila.
      Rastreamento completo de entrega implementado.
    documentacao_item_relacionado: "RN-RF067-01"
    uc_relacionado: "UC01"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF067-002"
    tipo: "tela"
    nome: "Termo/Correio.aspx - Envio de Termo"
    caminho: "ic1_legado/IControlIT/IControlIT/Termo/Correio.aspx"
    descricao: |
      Envio de termo de responsabilidade/devolução por e-mail.
      - Anexos salvos em C:/Temp/mail/att/
      - Envio síncrono sem retry
      - Sem rastreamento
    destino: "substituido"
    justificativa: |
      Substituído por integração com RF064 (Templates) e RF067 (Central de E-mails).
      Anexos migrados para Azure Blob Storage.
      Rastreamento de entrega e abertura implementado.
    documentacao_item_relacionado: "RN-RF067-12"
    uc_relacionado: "UC01"
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: 2

  - id: "LEG-RF067-003"
    tipo: "regra_negocio"
    nome: "Configuração SMTP em web.config"
    caminho: "ic1_legado/IControlIT/IControlIT/web.config"
    descricao: |
      Configurações SMTP armazenadas em web.config ou stored procedures.
      - Não isolado por tenant
      - Credenciais em texto claro ou criptografia proprietária
      - Host, porta, usuário, senha hardcoded
    destino: "substituido"
    justificativa: |
      Substituído por tabela SMTPServer com isolamento multi-tenant.
      Cada tenant pode ter múltiplos servidores SMTP configurados.
      Credenciais criptografadas com algoritmo padrão (.NET Data Protection).
    documentacao_item_relacionado: "RN-RF067-02"
    uc_relacionado: "UC05"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF067-004"
    tipo: "regra_negocio"
    nome: "Envio Síncrono sem Fila"
    caminho: "Padrao observado em multiplos modulos"
    descricao: |
      E-mails enviados de forma síncrona durante processamento HTTP.
      - Bloqueia UI em caso de falha SMTP
      - Sem fila de envio
      - Sem priorização
      - Sem retry automático
    destino: "substituido"
    justificativa: |
      Substituído por fila assíncrona com Hangfire.
      E-mails enfileirados por prioridade (crítica > alta > normal > baixa > bulk).
      Retry automático com backoff exponencial (até 5 tentativas).
      UI nunca bloqueada por envio de e-mail.
    documentacao_item_relacionado: "RN-RF067-03"
    uc_relacionado: "UC01"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF067-005"
    tipo: "regra_negocio"
    nome: "Sem Rastreamento de Entrega"
    caminho: "Ausência de tabela de histórico"
    descricao: |
      Sistema não rastreava:
      - Se e-mail foi entregue
      - Se e-mail foi aberto
      - Se links foram clicados
      - Bounces (hard ou soft)
      - Spam complaints
    destino: "substituido"
    justificativa: |
      Substituído por rastreamento completo de eventos:
      - Pixel invisível para rastreamento de abertura
      - URL redirecionada para rastreamento de cliques
      - Webhooks de provedores (SendGrid, Mailgun) para bounces e spam
      - Tabela EventoEmail com histórico completo
    documentacao_item_relacionado: "RN-RF067-04"
    uc_relacionado: "UC03"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 2

  - id: "LEG-RF067-006"
    tipo: "regra_negocio"
    nome: "Anexos em Pasta Local (C:/Temp)"
    caminho: "C:/Temp/mail/att/"
    descricao: |
      Anexos de e-mail salvos em pasta local no servidor.
      - Não escalável
      - Risco de saturação de disco
      - Sem limpeza automática
      - Dependência de filesystem do servidor
    destino: "substituido"
    justificativa: |
      Substituído por Azure Blob Storage para anexos.
      - Escalável e resiliente
      - Limpeza automática de anexos antigos (90 dias)
      - Acesso via URL assinada
      - Isolamento multi-tenant
    documentacao_item_relacionado: "RN-RF067-12"
    uc_relacionado: "UC01"
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: 2

  - id: "LEG-RF067-007"
    tipo: "regra_negocio"
    nome: "Logs em Arquivo Texto"
    caminho: "C:/Temp/Log*.txt"
    descricao: |
      Erros de envio gravados em arquivos texto.
      - Sem estruturação
      - Difícil consulta
      - Sem retenção controlada
      - Risco de saturação de disco
    destino: "substituido"
    justificativa: |
      Substituído por auditoria estruturada no banco.
      - Operações auditadas: EMAIL_ENVIADO, EMAIL_BOUNCE, EMAIL_SPAM, etc.
      - Retenção de 7 anos (conformidade LGPD)
      - Consulta estruturada via API
      - Alertas automáticos para falhas críticas
    documentacao_item_relacionado: "RN-RF067-17"
    uc_relacionado: null
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF067-008"
    tipo: "regra_negocio"
    nome: "Sem Blacklist"
    caminho: "Ausência de funcionalidade"
    descricao: |
      Sistema não mantinha blacklist de e-mails.
      - E-mails com hard bounce tentados repetidamente
      - Desperdício de recursos
      - Risco de prejudicar reputação de envio
    destino: "substituido"
    justificativa: |
      Implementada blacklist automática e manual.
      - Hard bounce adiciona automaticamente à blacklist
      - Spam complaints adicionam à blacklist
      - Unsubscribe adiciona à blacklist
      - Validação antes de enfileirar e-mail
    documentacao_item_relacionado: "RN-RF067-05"
    uc_relacionado: "UC04"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF067-009"
    tipo: "regra_negocio"
    nome: "Sem Rate Limiting"
    caminho: "Ausência de controle de fila"
    descricao: |
      Nenhum controle de limite de envios:
      - Por domínio
      - Por período
      - Por IP
      - Risco de ser marcado como spam
    destino: "substituido"
    justificativa: |
      Implementado rate limiting:
      - 100 e-mails por domínio por hora (configurável)
      - Warmup de IPs novos (15 dias graduais)
      - Distribuição de carga entre servidores SMTP
      - Monitoramento de reputação de envio
    documentacao_item_relacionado: "RN-RF067-06"
    uc_relacionado: null
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF067-010"
    tipo: "regra_negocio"
    nome: "Sem Validação de MX Record"
    caminho: "Padrão de envio direto"
    descricao: |
      Sistema não verificava MX record do domínio antes de enviar.
      - Tentativas de envio para domínios inexistentes
      - Desperdício de recursos
      - Bounces evitáveis
    destino: "substituido"
    justificativa: |
      Implementada validação antes de enfileirar:
      - Validação de sintaxe (RFC 5322)
      - Verificação de MX record
      - Rejeição imediata de e-mails inválidos
      - Economia de recursos de fila
    documentacao_item_relacionado: "RN-RF067-08"
    uc_relacionado: "UC01"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF067-011"
    tipo: "regra_negocio"
    nome: "Sem Unsubscribe (LGPD)"
    caminho: "Ausência de funcionalidade"
    descricao: |
      Sistema não oferecia mecanismo de unsubscribe.
      - Não-conformidade com LGPD
      - Não-conformidade com CAN-SPAM
      - Risco legal
      - Experiência ruim do usuário
    destino: "substituido"
    justificativa: |
      Implementado unsubscribe com um clique:
      - Link com token criptografado
      - Sem exigir login
      - Adiciona automaticamente à blacklist
      - Auditado (quem, quando)
      - Conformidade LGPD e CAN-SPAM
    documentacao_item_relacionado: "RN-RF067-09"
    uc_relacionado: "UC04"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 1

  - id: "LEG-RF067-012"
    tipo: "regra_negocio"
    nome: "Sem Health Check SMTP"
    caminho: "Ausência de monitoramento"
    descricao: |
      Sistema não monitorava saúde de servidores SMTP.
      - Falhas detectadas apenas no momento do envio
      - Sem detecção proativa
      - Sem failover automático
    destino: "substituido"
    justificativa: |
      Implementado health check periódico:
      - Verificação a cada 5 minutos
      - Tentativa de conexão em cada servidor
      - Marcação de servidor como saudável/não-saudável
      - Alerta para administradores em caso de falha
      - Failover automático para servidor saudável
    documentacao_item_relacionado: "RN-RF067-10"
    uc_relacionado: "UC05"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF067-013"
    tipo: "regra_negocio"
    nome: "Sem SPF/DKIM/DMARC"
    caminho: "Ausência de configuração DNS"
    descricao: |
      Sistema não validava ou exibia configuração de autenticação de e-mail.
      - SPF não configurado
      - DKIM não configurado
      - DMARC não configurado
      - Deliverability prejudicada
      - Risco de e-mails marcados como spam
    destino: "substituido"
    justificativa: |
      Implementada gestão de configuração DNS:
      - Armazenamento de SPF, DKIM, DMARC por domínio
      - Exibição de registros DNS necessários
      - Validação de assinatura DKIM
      - Registro de falhas de autenticação
      - Melhora significativa de deliverability
    documentacao_item_relacionado: "RN-RF067-11"
    uc_relacionado: "UC05"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF067-014"
    tipo: "regra_negocio"
    nome: "Sem Supressão de Duplicatas"
    caminho: "Ausência de controle"
    descricao: |
      Sistema podia enviar mesmo e-mail múltiplas vezes.
      - Experiência ruim do usuário
      - Risco de spam complaints
      - Desperdício de recursos
    destino: "substituido"
    justificativa: |
      Implementada supressão de duplicatas:
      - Verificação por destinatário + assunto
      - Janela de 24 horas
      - Rejeição de duplicata com log
      - Melhora experiência do usuário
    documentacao_item_relacionado: "RN-RF067-13"
    uc_relacionado: "UC01"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF067-015"
    tipo: "regra_negocio"
    nome: "Sem Relatórios de Deliverability"
    caminho: "Ausência de funcionalidade"
    descricao: |
      Sistema não oferecia métricas de envio:
      - Taxa de entrega
      - Taxa de abertura
      - Taxa de bounce
      - Taxa de spam
      - Impossível diagnosticar problemas
    destino: "substituido"
    justificativa: |
      Implementados relatórios completos:
      - Total enviados, taxa entrega, abertura, bounce, spam
      - Filtros por período, prioridade, provedor
      - Gráficos de evolução temporal
      - Exportação CSV/Excel
      - Análise de desempenho e diagnóstico
    documentacao_item_relacionado: "RN-RF067-14"
    uc_relacionado: "UC06"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

# Telas Legadas (estrutura detalhada)
telas:
  - id: "LEG-RF067-001"
    nome: "Default.aspx"
    caminho: "ic1_legado/IControlIT/IControlIT/Default.aspx"
    responsabilidade: "Autenticação e reset de senha"
    campos:
      - nome: "E-mail"
        tipo: "TextBox"
        obrigatorio: true
        validacao: "Validação básica de sintaxe"
    comportamentos_implicitos:
      - "Envio síncrono de e-mail para reset de senha"
      - "Bloqueio de UI em caso de falha SMTP"
      - "Sem retry em caso de falha"

  - id: "LEG-RF067-002"
    nome: "Termo/Correio.aspx"
    caminho: "ic1_legado/IControlIT/IControlIT/Termo/Correio.aspx"
    responsabilidade: "Envio de termo por e-mail"
    campos:
      - nome: "Destinatário"
        tipo: "TextBox"
        obrigatorio: true
        validacao: "Validação básica de sintaxe"
      - nome: "Anexo"
        tipo: "FileUpload"
        obrigatorio: false
        validacao: "Nenhuma"
    comportamentos_implicitos:
      - "Anexos salvos em C:/Temp/mail/att/"
      - "Envio síncrono sem retry"
      - "Sem rastreamento de entrega"

# Tabelas Legadas com Problemas
tabelas:
  - nome: "Nenhuma tabela específica"
    finalidade: "Sistema legado não armazenava histórico de e-mails"
    problemas:
      - "Sem rastreamento de e-mails enviados"
      - "Sem histórico de eventos (entrega, abertura, cliques)"
      - "Sem blacklist"
      - "Configuração SMTP não isolada por tenant"

# Regras de Negócio Implícitas (não documentadas no legado)
regras_implicitas:
  - id: "RL-RN-001"
    descricao: "Configuração SMTP via stored procedure ou web.config"
    fonte: "web.config e README legado"

  - id: "RL-RN-002"
    descricao: "Envio síncrono bloqueante"
    fonte: "Padrao observado em multiplos modulos"

  - id: "RL-RN-003"
    descricao: "Sem retry em falha"
    fonte: "Ausência de mecanismo de fila"

  - id: "RL-RN-004"
    descricao: "Anexos em pasta local C:/Temp"
    fonte: "README legado linha 66"

  - id: "RL-RN-005"
    descricao: "Logs em arquivo texto"
    fonte: "README legado linha 22"

# Gap Analysis (Legado x Moderno)
gap_analysis:
  - item: "Fila de envio"
    existe_legado: false
    existe_moderno: true
    notas: "CRÍTICO - E-mails críticos podiam ser atrasados"

  - item: "Retry automático"
    existe_legado: false
    existe_moderno: true
    notas: "CRÍTICO - E-mails perdidos em falhas temporárias"

  - item: "Rastreamento de eventos"
    existe_legado: false
    existe_moderno: true
    notas: "IMPORTANTE - Sem métricas de engajamento"

  - item: "Blacklist"
    existe_legado: false
    existe_moderno: true
    notas: "IMPORTANTE - Desperdício de recursos"

  - item: "Rate limiting"
    existe_legado: false
    existe_moderno: true
    notas: "IMPORTANTE - Risco de spam flags"

  - item: "Warmup de IP"
    existe_legado: false
    existe_moderno: true
    notas: "IMPORTANTE - Reputação de envio"

  - item: "Unsubscribe"
    existe_legado: false
    existe_moderno: true
    notas: "CRÍTICO - Conformidade LGPD"

  - item: "Multi-tenant SMTP"
    existe_legado: false
    existe_moderno: true
    notas: "CRÍTICO - Isolamento de configuração"

# Decisões de Modernização
decisoes_modernizacao:
  - decisao: "Criar Central de E-mails do zero"
    motivo: "Sistema legado não possui funcionalidade equivalente"
    impacto: "alto"
    data: "2025-12-30"

  - decisao: "Usar Hangfire para fila e retry"
    motivo: "Suporta filas priorizadas, retry e monitoramento"
    impacto: "medio"
    data: "2025-12-30"

  - decisao: "Rastreamento com pixel e URL redirecionada"
    motivo: "Padrão de mercado"
    impacto: "baixo"
    data: "2025-12-30"

  - decisao: "Blacklist automática para hard bounce"
    motivo: "Evitar desperdício e manter reputação"
    impacto: "medio"
    data: "2025-12-30"

  - decisao: "Suporte a múltiplos provedores"
    motivo: "Flexibilidade (SendGrid, Mailgun, SES, SMTP)"
    impacto: "alto"
    data: "2025-12-30"

# Riscos de Migração
riscos_migracao:
  - risco: "Migração de pontos de envio"
    impacto: "alto"
    probabilidade: "alta"
    mitigacao: "Identificar todos os pontos de envio e migrar para Central"

  - risco: "Configuração SMTP por tenant"
    impacto: "alto"
    probabilidade: "media"
    mitigacao: "Criar migração de web.config para tabela multi-tenant"

  - risco: "Anexos em C:/Temp"
    impacto: "medio"
    probabilidade: "media"
    mitigacao: "Migrar anexos para Azure Blob Storage"

  - risco: "E-mails em fila durante migração"
    impacto: "medio"
    probabilidade: "baixa"
    mitigacao: "Garantir que fila seja processada antes de desligar legado"

# Rastreabilidade (Legado → Moderno)
rastreabilidade:
  - elemento_legado: "Default.aspx (reset senha)"
    referencia_rf: "RN-RF067-01"
    referencia_uc: "UC01"
    status: "substituido"

  - elemento_legado: "Termo/Correio.aspx"
    referencia_rf: "RN-RF067-12"
    referencia_uc: "UC01"
    status: "substituido"

  - elemento_legado: "Configuração SMTP web.config"
    referencia_rf: "RN-RF067-02"
    referencia_uc: "UC05"
    status: "substituido"

  - elemento_legado: "Logs em C:/Temp"
    referencia_rf: "RN-RF067-17"
    referencia_uc: null
    status: "substituido"

  - elemento_legado: "Anexos em C:/Temp/mail/att"
    referencia_rf: "RN-RF067-12"
    referencia_uc: "UC01"
    status: "substituido"

# Changelog
changelog:
  - versao: "1.0"
    data: "2025-12-30"
    descricao: "Documentação completa de referência ao legado - 15 itens mapeados, 100% substituído"
    autor: "Agência ALC - alc.dev.br"
