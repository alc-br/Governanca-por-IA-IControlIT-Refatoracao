# =============================================
# UC - Casos de Uso (Contrato Comportamental)
# Versão: 2.0
# RF: RF063 - Motor de Templates (Template Engine)
# Autor: Agência ALC - alc.dev.br
# =============================================

uc:
  documentacao: "RF063"
  versao: "2.0"
  data: "2025-12-31"

casos_de_uso:

  - id: "UC00"
    nome: "Listar Templates"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      documentacao_items:
        - "RF-CRUD-02"
        - "RF-SEC-01"
        - "RF-SEC-02"
      uc_items:
        - id: "FP-UC00-001"
          title: "Usuário acessa a funcionalidade de templates"
          required: true
        - id: "FP-UC00-002"
          title: "Sistema valida permissão TPL.ENGINE.VIEW_ANY"
          required: true
        - id: "FP-UC00-003"
          title: "Sistema carrega templates do tenant do usuário"
          required: true
        - id: "FP-UC00-004"
          title: "Sistema aplica paginação e ordenação padrão"
          required: true
        - id: "FP-UC00-005"
          title: "Sistema exibe lista com metadados"
          required: true
        - id: "FA-UC00-001"
          title: "Buscar por nome ou descrição"
          required: false
        - id: "FA-UC00-002"
          title: "Filtrar por tipo"
          required: false
        - id: "FA-UC00-003"
          title: "Filtrar por estado"
          required: false
        - id: "FA-UC00-004"
          title: "Ordenar por coluna"
          required: false
        - id: "FA-UC00-005"
          title: "Incluir templates globais"
          required: false
        - id: "FE-UC00-001"
          title: "Usuário sem permissão → HTTP 403"
          required: true
        - id: "FE-UC00-002"
          title: "Nenhum template → estado vazio"
          required: true

    precondicoes:
      - permissao: "TPL.ENGINE.VIEW_ANY"

    gatilho: "Usuario acessa a funcionalidade de templates"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessa_funcionalidade"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "carregar_templates_tenant"
      - passo: 4
        ator: "sistema"
        acao: "aplicar_paginacao"
      - passo: 5
        ator: "sistema"
        acao: "exibir_lista"

    fluxos_alternativos:
      - id: "FA-UC00-01"
        condicao: "usuario_aplica_busca_ou_filtro"
        resultado: "lista_filtrada"

    fluxos_excecao:
      - id: "FE-UC00-01"
        condicao: "sem_permissao"
        resultado: "acesso_negado_403"

    regras_aplicadas:
      - "RN-UC-00-001"
      - "RN-UC-00-002"
      - "RN-UC-00-003"
      - "RN-UC-00-004"
      - "RN-RF063-015"

    resultado_final:
      estado: "lista_exibida"

  - id: "UC01"
    nome: "Criar Template"
    ator_principal: "usuario_autenticado"
    tipo: "crud"
    impacta_dados: true

    covers:
      documentacao_items:
        - "RF-CRUD-01"
        - "RF-VAL-01"
        - "RF-SEC-01"
      uc_items:
        - id: "FP-UC01-001"
          title: "Usuário solicita criação de template"
          required: true
        - id: "FP-UC01-002"
          title: "Sistema valida permissão TPL.ENGINE.CREATE"
          required: true
        - id: "FP-UC01-003"
          title: "Sistema exibe formulário"
          required: true
        - id: "FP-UC01-004"
          title: "Usuário preenche campos obrigatórios"
          required: true
        - id: "FP-UC01-005"
          title: "Sistema valida sintaxe Liquid em tempo real"
          required: true
        - id: "FP-UC01-006"
          title: "Usuário confirma criação"
          required: true
        - id: "FP-UC01-007"
          title: "Sistema valida dados completos"
          required: true
        - id: "FP-UC01-008"
          title: "Sistema cria template em estado draft"
          required: true
        - id: "FP-UC01-009"
          title: "Sistema registra auditoria"
          required: true
        - id: "FP-UC01-010"
          title: "Sistema confirma sucesso"
          required: true
        - id: "FA-UC01-001"
          title: "Salvar e criar outro"
          required: false
        - id: "FA-UC01-002"
          title: "Cancelar criação"
          required: false
        - id: "FA-UC01-003"
          title: "Selecionar layout base"
          required: false
        - id: "FA-UC01-004"
          title: "Adicionar parciais"
          required: false
        - id: "FA-UC01-005"
          title: "Configurar filtros customizados"
          required: false
        - id: "FE-UC01-001"
          title: "Erro validação sintaxe Liquid"
          required: true
        - id: "FE-UC01-002"
          title: "Nome duplicado"
          required: true
        - id: "FE-UC01-003"
          title: "Variável ausente → warning"
          required: true
        - id: "FE-UC01-004"
          title: "Erro inesperado"
          required: true

    precondicoes:
      - permissao: "TPL.ENGINE.CREATE"

    gatilho: "Usuario solicita criacao de novo template"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "solicitar_criacao"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "exibir_formulario"
      - passo: 4
        ator: "usuario"
        acao: "preencher_campos"
      - passo: 5
        ator: "sistema"
        acao: "validar_sintaxe_liquid"
      - passo: 6
        ator: "usuario"
        acao: "confirmar"
      - passo: 7
        ator: "sistema"
        acao: "validar_dados"
      - passo: 8
        ator: "sistema"
        acao: "criar_template_draft"
      - passo: 9
        ator: "sistema"
        acao: "registrar_auditoria"
      - passo: 10
        ator: "sistema"
        acao: "exibir_sucesso"

    fluxos_alternativos:
      - id: "FA-UC01-01"
        condicao: "usuario_cancela"
        resultado: "criacao_cancelada"

    fluxos_excecao:
      - id: "FE-UC01-01"
        condicao: "sintaxe_invalida"
        resultado: "bloquear_salvamento"
      - id: "FE-UC01-02"
        condicao: "nome_duplicado"
        resultado: "exibir_erro_duplicacao"

    regras_aplicadas:
      - "RN-UC-01-001"
      - "RN-UC-01-002"
      - "RN-UC-01-003"
      - "RN-UC-01-004"
      - "RN-UC-01-005"
      - "RN-RF063-001"
      - "RN-RF063-006"

    resultado_final:
      estado: "template_criado_draft_v1"

  - id: "UC02"
    nome: "Visualizar Template"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      documentacao_items:
        - "RF-CRUD-03"
        - "RF-SEC-01"
      uc_items:
        - id: "FP-UC02-001"
          title: "Usuário seleciona template"
          required: true
        - id: "FP-UC02-002"
          title: "Sistema valida permissão TPL.ENGINE.VIEW"
          required: true
        - id: "FP-UC02-003"
          title: "Sistema valida tenant ou global"
          required: true
        - id: "FP-UC02-004"
          title: "Sistema carrega dados + versão ativa"
          required: true
        - id: "FP-UC02-005"
          title: "Sistema exibe dados completos"
          required: true
        - id: "FP-UC02-006"
          title: "Sistema exibe histórico de versões"
          required: true
        - id: "FP-UC02-007"
          title: "Sistema exibe botão Gerar Preview"
          required: true
        - id: "FA-UC02-001"
          title: "Visualizar versão específica"
          required: false
        - id: "FA-UC02-002"
          title: "Comparar versões (diff)"
          required: false
        - id: "FA-UC02-003"
          title: "Visualizar auditoria de uso"
          required: false
        - id: "FA-UC02-004"
          title: "Copiar como novo (duplicar)"
          required: false
        - id: "FE-UC02-001"
          title: "Template inexistente → HTTP 404"
          required: true
        - id: "FE-UC02-002"
          title: "Template outro tenant → HTTP 403"
          required: true
        - id: "FE-UC02-003"
          title: "Versão inexistente → HTTP 404"
          required: true

    precondicoes:
      - permissao: "TPL.ENGINE.VIEW"

    gatilho: "Usuario seleciona template na listagem"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "selecionar_template"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "validar_tenant"
      - passo: 4
        ator: "sistema"
        acao: "carregar_dados"
      - passo: 5
        ator: "sistema"
        acao: "exibir_detalhes"

    fluxos_alternativos:
      - id: "FA-UC02-01"
        condicao: "usuario_solicita_versao_especifica"
        resultado: "exibir_versao_selecionada"

    fluxos_excecao:
      - id: "FE-UC02-01"
        condicao: "template_nao_encontrado"
        resultado: "retornar_404"
      - id: "FE-UC02-02"
        condicao: "template_outro_tenant"
        resultado: "retornar_403"

    regras_aplicadas:
      - "RN-UC-02-001"
      - "RN-UC-02-002"
      - "RN-UC-02-003"
      - "RN-RF063-015"

    resultado_final:
      estado: "dados_exibidos"

  - id: "UC03"
    nome: "Editar Template"
    ator_principal: "usuario_autenticado"
    tipo: "crud"
    impacta_dados: true

    covers:
      documentacao_items:
        - "RF-CRUD-04"
        - "RF-VAL-01"
        - "RF-SEC-01"
      uc_items:
        - id: "FP-UC03-001"
          title: "Usuário solicita edição"
          required: true
        - id: "FP-UC03-002"
          title: "Sistema valida permissão TPL.ENGINE.EDIT"
          required: true
        - id: "FP-UC03-003"
          title: "Sistema valida tenant"
          required: true
        - id: "FP-UC03-004"
          title: "Sistema valida estado NÃO arquivado"
          required: true
        - id: "FP-UC03-005"
          title: "Sistema carrega formulário editável"
          required: true
        - id: "FP-UC03-006"
          title: "Usuário altera campos"
          required: true
        - id: "FP-UC03-007"
          title: "Sistema valida sintaxe Liquid"
          required: true
        - id: "FP-UC03-008"
          title: "Usuário confirma salvamento"
          required: true
        - id: "FP-UC03-009"
          title: "Sistema valida alterações"
          required: true
        - id: "FP-UC03-010"
          title: "Sistema cria nova versão"
          required: true
        - id: "FP-UC03-011"
          title: "Sistema atualiza auditoria"
          required: true
        - id: "FP-UC03-012"
          title: "Sistema invalida cache Redis"
          required: true
        - id: "FP-UC03-013"
          title: "Sistema registra auditoria"
          required: true
        - id: "FP-UC03-014"
          title: "Sistema confirma sucesso"
          required: true
        - id: "FA-UC03-001"
          title: "Cancelar edição"
          required: false
        - id: "FA-UC03-002"
          title: "Publicar após edição"
          required: false
        - id: "FA-UC03-003"
          title: "Salvar como rascunho"
          required: false
        - id: "FA-UC03-004"
          title: "Comparar com versão anterior"
          required: false
        - id: "FE-UC03-001"
          title: "Erro validação sintaxe"
          required: true
        - id: "FE-UC03-002"
          title: "Conflito edição concorrente"
          required: true
        - id: "FE-UC03-003"
          title: "Template arquivado"
          required: true
        - id: "FE-UC03-004"
          title: "Template outro tenant → HTTP 403"
          required: true

    precondicoes:
      - permissao: "TPL.ENGINE.EDIT"
      - estado: "draft OU active"

    gatilho: "Usuario solicita edicao de template"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "solicitar_edicao"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "validar_tenant"
      - passo: 4
        ator: "sistema"
        acao: "validar_nao_arquivado"
      - passo: 5
        ator: "sistema"
        acao: "carregar_formulario"
      - passo: 6
        ator: "usuario"
        acao: "alterar_campos"
      - passo: 7
        ator: "sistema"
        acao: "validar_sintaxe"
      - passo: 8
        ator: "usuario"
        acao: "confirmar"
      - passo: 9
        ator: "sistema"
        acao: "validar_alteracoes"
      - passo: 10
        ator: "sistema"
        acao: "criar_nova_versao"
      - passo: 11
        ator: "sistema"
        acao: "atualizar_auditoria"
      - passo: 12
        ator: "sistema"
        acao: "invalidar_cache"
      - passo: 13
        ator: "sistema"
        acao: "registrar_auditoria"
      - passo: 14
        ator: "sistema"
        acao: "exibir_sucesso"

    fluxos_alternativos:
      - id: "FA-UC03-01"
        condicao: "usuario_cancela"
        resultado: "edicao_cancelada"

    fluxos_excecao:
      - id: "FE-UC03-01"
        condicao: "sintaxe_invalida"
        resultado: "bloquear_salvamento"
      - id: "FE-UC03-02"
        condicao: "conflito_concorrente"
        resultado: "avisar_usuario"

    regras_aplicadas:
      - "RN-UC-03-001"
      - "RN-UC-03-002"
      - "RN-UC-03-003"
      - "RN-UC-03-004"
      - "RN-UC-03-005"
      - "RN-RF063-005"
      - "RN-RF063-006"
      - "RN-RF063-012"

    resultado_final:
      estado: "template_atualizado_nova_versao"

  - id: "UC04"
    nome: "Arquivar Template"
    ator_principal: "usuario_autenticado"
    tipo: "crud"
    impacta_dados: true

    covers:
      documentacao_items:
        - "RF-CRUD-05"
        - "RF-SEC-01"
      uc_items:
        - id: "FP-UC04-001"
          title: "Usuário solicita arquivamento"
          required: true
        - id: "FP-UC04-002"
          title: "Sistema exibe confirmação"
          required: true
        - id: "FP-UC04-003"
          title: "Sistema valida permissão TPL.ENGINE.ARCHIVE"
          required: true
        - id: "FP-UC04-004"
          title: "Sistema verifica uso ativo"
          required: true
        - id: "FP-UC04-005"
          title: "Sistema altera estado para archived"
          required: true
        - id: "FP-UC04-006"
          title: "Sistema invalida cache Redis"
          required: true
        - id: "FP-UC04-007"
          title: "Sistema registra auditoria"
          required: true
        - id: "FP-UC04-008"
          title: "Sistema confirma sucesso"
          required: true
        - id: "FA-UC04-001"
          title: "Cancelar arquivamento"
          required: false
        - id: "FA-UC04-002"
          title: "Desarquivar template"
          required: false
        - id: "FE-UC04-001"
          title: "Template em uso ativo"
          required: true
        - id: "FE-UC04-002"
          title: "Template já arquivado"
          required: true
        - id: "FE-UC04-003"
          title: "Template outro tenant → HTTP 403"
          required: true

    precondicoes:
      - permissao: "TPL.ENGINE.ARCHIVE"
      - estado: "draft OU active OU testing"

    gatilho: "Usuario solicita arquivamento de template"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "solicitar_arquivamento"
      - passo: 2
        ator: "sistema"
        acao: "exibir_confirmacao"
      - passo: 3
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 4
        ator: "sistema"
        acao: "verificar_uso_ativo"
      - passo: 5
        ator: "sistema"
        acao: "alterar_estado_archived"
      - passo: 6
        ator: "sistema"
        acao: "invalidar_cache"
      - passo: 7
        ator: "sistema"
        acao: "registrar_auditoria"
      - passo: 8
        ator: "sistema"
        acao: "exibir_sucesso"

    fluxos_alternativos:
      - id: "FA-UC04-01"
        condicao: "usuario_cancela"
        resultado: "arquivamento_cancelado"

    fluxos_excecao:
      - id: "FE-UC04-01"
        condicao: "template_em_uso"
        resultado: "bloquear_arquivamento"

    regras_aplicadas:
      - "RN-UC-04-001"
      - "RN-UC-04-002"
      - "RN-UC-04-003"
      - "RN-UC-04-004"
      - "RN-UC-04-005"

    resultado_final:
      estado: "template_arquivado"

  - id: "UC05"
    nome: "Renderizar Template"
    ator_principal: "sistema_ou_usuario_autenticado"
    tipo: "acao"
    impacta_dados: false

    covers:
      documentacao_items:
        - "RF-VAL-01"
        - "RF-VAL-02"
        - "RF-VAL-03"
        - "RF-SEC-01"
        - "RF-SEC-03"
      uc_items:
        - id: "FP-UC05-001"
          title: "Sistema/Usuário solicita renderização"
          required: true
        - id: "FP-UC05-002"
          title: "Sistema valida permissão (se usuário)"
          required: true
        - id: "FP-UC05-003"
          title: "Sistema valida template active"
          required: true
        - id: "FP-UC05-004"
          title: "Sistema verifica cache Redis"
          required: true
        - id: "FP-UC05-005"
          title: "Se cache miss → compila template"
          required: true
        - id: "FP-UC05-006"
          title: "Sistema armazena em cache (TTL 1h)"
          required: true
        - id: "FP-UC05-007"
          title: "Sistema aplica contexto de dados"
          required: true
        - id: "FP-UC05-008"
          title: "Sistema aplica filtros customizados"
          required: true
        - id: "FP-UC05-009"
          title: "Sistema processa condicionais e loops"
          required: true
        - id: "FP-UC05-010"
          title: "Sistema sanitiza HTML automaticamente"
          required: true
        - id: "FP-UC05-011"
          title: "Sistema registra auditoria"
          required: true
        - id: "FP-UC05-012"
          title: "Sistema retorna HTML/texto renderizado"
          required: true
        - id: "FA-UC05-001"
          title: "Renderizar com dados de teste"
          required: false
        - id: "FA-UC05-002"
          title: "Renderizar com flag raw"
          required: false
        - id: "FA-UC05-003"
          title: "Renderizar com herança"
          required: false
        - id: "FA-UC05-004"
          title: "Renderizar com parciais"
          required: false
        - id: "FE-UC05-001"
          title: "Template inativo"
          required: true
        - id: "FE-UC05-002"
          title: "Erro sintaxe runtime"
          required: true
        - id: "FE-UC05-003"
          title: "Variável ausente → placeholder"
          required: true
        - id: "FE-UC05-004"
          title: "Timeout >5s"
          required: true
        - id: "FE-UC05-005"
          title: "Cache Redis indisponível"
          required: true

    precondicoes:
      - permissao: "TPL.ENGINE.RENDER"
      - estado: "active"

    gatilho: "Sistema ou usuario solicita renderizacao"

    fluxo_principal:
      - passo: 1
        ator: "sistema_ou_usuario"
        acao: "solicitar_renderizacao"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "validar_template_active"
      - passo: 4
        ator: "sistema"
        acao: "verificar_cache"
      - passo: 5
        ator: "sistema"
        acao: "compilar_se_necessario"
      - passo: 6
        ator: "sistema"
        acao: "armazenar_cache"
      - passo: 7
        ator: "sistema"
        acao: "aplicar_contexto"
      - passo: 8
        ator: "sistema"
        acao: "aplicar_filtros"
      - passo: 9
        ator: "sistema"
        acao: "processar_logica"
      - passo: 10
        ator: "sistema"
        acao: "sanitizar_html"
      - passo: 11
        ator: "sistema"
        acao: "registrar_auditoria"
      - passo: 12
        ator: "sistema"
        acao: "retornar_resultado"

    fluxos_alternativos:
      - id: "FA-UC05-01"
        condicao: "usuario_solicita_preview"
        resultado: "renderizar_com_dados_teste"

    fluxos_excecao:
      - id: "FE-UC05-01"
        condicao: "template_inativo"
        resultado: "retornar_erro"
      - id: "FE-UC05-02"
        condicao: "erro_runtime"
        resultado: "retornar_placeholder"
      - id: "FE-UC05-03"
        condicao: "timeout"
        resultado: "abortar_renderizacao"

    regras_aplicadas:
      - "RN-UC-05-001"
      - "RN-UC-05-002"
      - "RN-UC-05-003"
      - "RN-UC-05-004"
      - "RN-UC-05-005"
      - "RN-RF063-002"
      - "RN-RF063-003"
      - "RN-RF063-011"
      - "RN-RF063-012"

    resultado_final:
      estado: "html_renderizado_retornado"

  - id: "UC06"
    nome: "Gerar Preview de Template"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      documentacao_items:
        - "RF-VAL-01"
      uc_items:
        - id: "FP-UC06-001"
          title: "Usuário solicita preview"
          required: true
        - id: "FP-UC06-002"
          title: "Sistema valida sintaxe Liquid"
          required: true
        - id: "FP-UC06-003"
          title: "Sistema carrega contexto de teste"
          required: true
        - id: "FP-UC06-004"
          title: "Sistema renderiza template"
          required: true
        - id: "FP-UC06-005"
          title: "Sistema exibe lado a lado"
          required: true
        - id: "FP-UC06-006"
          title: "Sistema destaca variáveis ausentes"
          required: true
        - id: "FA-UC06-001"
          title: "Editar contexto e re-gerar"
          required: false
        - id: "FA-UC06-002"
          title: "Alternar modo (Desktop/Tablet/Mobile)"
          required: false
        - id: "FA-UC06-003"
          title: "Copiar HTML renderizado"
          required: false
        - id: "FA-UC06-004"
          title: "Visualizar em idioma específico"
          required: false
        - id: "FE-UC06-001"
          title: "Erro sintaxe Liquid"
          required: true
        - id: "FE-UC06-002"
          title: "Contexto teste inválido"
          required: true
        - id: "FE-UC06-003"
          title: "Timeout renderização"
          required: true

    precondicoes:
      - permissao: "TPL.ENGINE.EDIT OU TPL.ENGINE.CREATE"

    gatilho: "Usuario solicita preview durante criacao ou edicao"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "solicitar_preview"
      - passo: 2
        ator: "sistema"
        acao: "validar_sintaxe"
      - passo: 3
        ator: "sistema"
        acao: "carregar_contexto_teste"
      - passo: 4
        ator: "sistema"
        acao: "renderizar_template"
      - passo: 5
        ator: "sistema"
        acao: "exibir_lado_a_lado"
      - passo: 6
        ator: "sistema"
        acao: "destacar_variaveis_ausentes"

    fluxos_alternativos:
      - id: "FA-UC06-01"
        condicao: "usuario_edita_contexto"
        resultado: "regerar_preview"

    fluxos_excecao:
      - id: "FE-UC06-01"
        condicao: "erro_sintaxe"
        resultado: "destacar_erro"

    regras_aplicadas:
      - "RN-UC-06-001"
      - "RN-UC-06-002"
      - "RN-UC-06-003"
      - "RN-UC-06-004"
      - "RN-RF063-004"
      - "RN-RF063-006"

    resultado_final:
      estado: "preview_exibido"

  - id: "UC07"
    nome: "Criar Nova Versão"
    ator_principal: "usuario_autenticado"
    tipo: "acao"
    impacta_dados: true

    covers:
      documentacao_items:
        - "RF-SEC-03"
      uc_items:
        - id: "FP-UC07-001"
          title: "Sistema detecta alteração em template"
          required: true
        - id: "FP-UC07-002"
          title: "Sistema incrementa número de versão"
          required: true
        - id: "FP-UC07-003"
          title: "Sistema cria snapshot completo"
          required: true
        - id: "FP-UC07-004"
          title: "Sistema marca nova versão como ativa"
          required: true
        - id: "FP-UC07-005"
          title: "Sistema marca versão anterior como inativa"
          required: true
        - id: "FP-UC07-006"
          title: "Sistema registra auditoria"
          required: true
        - id: "FA-UC07-001"
          title: "Adicionar nota de versão"
          required: false
        - id: "FA-UC07-002"
          title: "Marcar versão como milestone"
          required: false
        - id: "FE-UC07-001"
          title: "Erro ao criar snapshot"
          required: true
        - id: "FE-UC07-002"
          title: "Limite versões atingido"
          required: true

    precondicoes:
      - permissao: "TPL.ENGINE.VERSION"

    gatilho: "Sistema detecta alteracao em template"

    fluxo_principal:
      - passo: 1
        ator: "sistema"
        acao: "detectar_alteracao"
      - passo: 2
        ator: "sistema"
        acao: "incrementar_versao"
      - passo: 3
        ator: "sistema"
        acao: "criar_snapshot"
      - passo: 4
        ator: "sistema"
        acao: "marcar_nova_ativa"
      - passo: 5
        ator: "sistema"
        acao: "marcar_anterior_inativa"
      - passo: 6
        ator: "sistema"
        acao: "registrar_auditoria"

    fluxos_alternativos:
      - id: "FA-UC07-01"
        condicao: "usuario_adiciona_nota"
        resultado: "nota_incluida_no_snapshot"

    fluxos_excecao:
      - id: "FE-UC07-01"
        condicao: "erro_criar_snapshot"
        resultado: "rollback_transacao"

    regras_aplicadas:
      - "RN-UC-07-001"
      - "RN-UC-07-002"
      - "RN-UC-07-003"
      - "RN-UC-07-004"
      - "RN-RF063-005"

    resultado_final:
      estado: "nova_versao_criada"

  - id: "UC08"
    nome: "Executar Rollback de Versão"
    ator_principal: "usuario_autenticado"
    tipo: "acao"
    impacta_dados: true

    covers:
      documentacao_items:
        - "RF-SEC-03"
      uc_items:
        - id: "FP-UC08-001"
          title: "Usuário acessa histórico de versões"
          required: true
        - id: "FP-UC08-002"
          title: "Usuário seleciona versão para rollback"
          required: true
        - id: "FP-UC08-003"
          title: "Sistema exibe comparação (diff)"
          required: true
        - id: "FP-UC08-004"
          title: "Sistema exibe confirmação"
          required: true
        - id: "FP-UC08-005"
          title: "Sistema valida permissão TPL.ENGINE.ROLLBACK"
          required: true
        - id: "FP-UC08-006"
          title: "Sistema cria nova versão com conteúdo antigo"
          required: true
        - id: "FP-UC08-007"
          title: "Sistema marca nova versão como ativa"
          required: true
        - id: "FP-UC08-008"
          title: "Sistema invalida cache Redis"
          required: true
        - id: "FP-UC08-009"
          title: "Sistema registra auditoria"
          required: true
        - id: "FP-UC08-010"
          title: "Sistema confirma sucesso"
          required: true
        - id: "FA-UC08-001"
          title: "Cancelar rollback"
          required: false
        - id: "FA-UC08-002"
          title: "Visualizar preview antes rollback"
          required: false
        - id: "FA-UC08-003"
          title: "Adicionar nota de rollback"
          required: false
        - id: "FE-UC08-001"
          title: "Versão inexistente → HTTP 404"
          required: true
        - id: "FE-UC08-002"
          title: "Template com apenas 1 versão"
          required: true
        - id: "FE-UC08-003"
          title: "Erro ao criar nova versão"
          required: true

    precondicoes:
      - permissao: "TPL.ENGINE.ROLLBACK"
      - minimo_versoes: 2

    gatilho: "Usuario solicita rollback para versao anterior"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessar_historico"
      - passo: 2
        ator: "usuario"
        acao: "selecionar_versao"
      - passo: 3
        ator: "sistema"
        acao: "exibir_diff"
      - passo: 4
        ator: "sistema"
        acao: "exibir_confirmacao"
      - passo: 5
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 6
        ator: "sistema"
        acao: "criar_nova_versao_com_conteudo_antigo"
      - passo: 7
        ator: "sistema"
        acao: "marcar_ativa"
      - passo: 8
        ator: "sistema"
        acao: "invalidar_cache"
      - passo: 9
        ator: "sistema"
        acao: "registrar_auditoria"
      - passo: 10
        ator: "sistema"
        acao: "exibir_sucesso"

    fluxos_alternativos:
      - id: "FA-UC08-01"
        condicao: "usuario_cancela"
        resultado: "rollback_cancelado"

    fluxos_excecao:
      - id: "FE-UC08-01"
        condicao: "versao_nao_encontrada"
        resultado: "retornar_404"
      - id: "FE-UC08-02"
        condicao: "apenas_uma_versao"
        resultado: "retornar_erro"

    regras_aplicadas:
      - "RN-UC-08-001"
      - "RN-UC-08-002"
      - "RN-UC-08-003"
      - "RN-UC-08-004"
      - "RN-RF063-005"

    resultado_final:
      estado: "rollback_concluido_nova_versao"

exclusions:
  uc_items: []

historico:
  - versao: "2.0"
    data: "2025-12-31"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Versão canônica v2.0 - 9 UCs completos seguindo governança v2.0"
  - versao: "1.0"
    data: "2025-12-17"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Versão inicial (pré-governança v2.0)"
