rf:
  id: RF015
  nome: Gestão de Locais e Endereços
  versao: '2.0'
  data: '2025-12-30'
  fase: Fase 2 - Cadastros e Serviços Transversais
  epic: EPIC003-CAD
  status: concluido
descricao:
  objetivo: 'Permitir que o sistema gerencie a estrutura física e geográfica da empresa através de uma hierarquia completa
    de locais (País → Estado → Cidade → Edifício → Andar → Sala → Rack → Posição), integrada com validação automática de endereços
    e geocodificação.

    '
  problema_resolvido: 'Rastreamento preciso da localização de ativos, cumprimento de conformidade regulatória, otimização
    operacional e análise geoespacial.

    '
  publico_afetado: Organizações com múltiplas filiais, unidades de negócio e centros de dados
escopo:
  incluso:
  - CRUD completo de endereços com validação de CEP
  - CRUD de hierarquia de locais (Edifício, Andar, Sala, Rack, Posição)
  - Validação automática de CEP via API externa (ViaCEP)
  - Geocodificação automática de endereços (latitude/longitude)
  - Controle de capacidade de racks (altura, profundidade, peso, potência)
  - Controle de ocupação de posições em racks (sem sobreposição)
  - Histórico imutável de movimentações de ativos entre locais
  - Validação de tipos de sala e compatibilidade com racks
  - Endereço principal único por tenant
  - Isolamento multi-tenant
  - Auditoria completa de todas as operações
  - Permissões RBAC granulares
  fora:
  - Interface visual específica (componentes Angular, layout, UX)
  - Tecnologia de implementação (backend/frontend)
  - Estratégia de deploy ou infraestrutura
  - Visualização de mapa interativo (feature opcional via feature flag)
  - Importação em lote de locais (feature opcional)
  - Integração com sistemas de logística ou RTLS
  - Cálculo de custo de deslocamento
  - Relatórios de distribuição geográfica (features opcionais)
entidades:
- nome: Endereco
  descricao: Informação geográfica completa associada a um local físico
  multi_tenant: true
  soft_delete: true
  auditoria: true
  campos_principais:
  - Id_Endereco
  - Id_Fornecedor
  - Ds_Logradouro
  - Nr_Numero
  - Ds_Complemento
  - Nm_Bairro
  - Nm_Cidade
  - Sg_Estado
  - Nr_CEP
  - Ds_Pais
  - Nr_Latitude
  - Nr_Longitude
  - Fl_Principal
  - Fl_Excluido
- nome: Local
  descricao: Estrutura hierárquica que representa uma posição geográfica ou física
  multi_tenant: true
  soft_delete: true
  auditoria: true
  campos_principais:
  - Id_Local
  - Id_Fornecedor
  - Id_Endereco
  - Nm_Local
  - Nm_Tipo
  - Id_Local_Pai
  - Nr_Sequencia
  - Ds_Descricao
  - Fl_Excluido
- nome: Rack
  descricao: Armário de TI padronizado em Us para instalação de equipamentos
  multi_tenant: true
  soft_delete: true
  auditoria: true
  campos_principais:
  - Id_Rack
  - Id_Fornecedor
  - Id_Local
  - Nm_Rack
  - Nr_Altura_Us
  - Nr_Profundidade_Mm
  - Nr_Peso_Maximo_Kg
  - Nr_Potencia_Maxima_Watts
  - Nr_Peso_Atual_Kg
  - Nr_Potencia_Atual_Watts
  - Fl_Excluido
- nome: RackPosicao
  descricao: Unidade de espaço vertical em rack (U1-U48)
  multi_tenant: false
  soft_delete: false
  auditoria: true
  campos_principais:
  - Id_Posicao
  - Id_Rack
  - Nr_Posicao_U
  - Id_Ativo
  - Fl_Ocupada
- nome: Local_Historico_Movimentacao
  descricao: Registro imutável (append-only) de toda mudança de local de ativo
  multi_tenant: true
  soft_delete: false
  auditoria: true
  campos_principais:
  - Id_Historico
  - Id_Ativo
  - Id_Local_Origem
  - Id_Local_Destino
  - Id_Usuario_Movimentacao
  - Dt_Movimentacao
  - Ds_Motivo
  - Fl_Validado
regras_negocio:
- id: RN-RF015-01
  descricao: CEPs brasileiros devem ter exatamente 8 dígitos numéricos no formato XXXXX-XXX ou XXXXXXXX. Validação via ViaCEP
    API.
  tipo: validacao
  campos_afetados:
  - Nr_CEP
  - Sg_Estado
  - Nm_Cidade
  - Nm_Bairro
  obrigatorio: true
  criterio_aceite:
  - CEP no formato inválido → rejeição HTTP 400
  - CEP não existente em ViaCEP → rejeição HTTP 400
  - CEP válido → campos estado, cidade e bairro autocompletados
- id: RN-RF015-02
  descricao: Apenas um local pode ser marcado como Principal (Fl_Principal = true) por tenant. Ao marcar novo como principal,
    desmarcar automaticamente o anterior.
  tipo: unicidade
  campos_afetados:
  - Id_Fornecedor
  - Fl_Principal
  obrigatorio: true
  criterio_aceite:
  - Tenant sem endereço principal → permitir marcar qualquer endereço como principal
  - Tenant com endereço principal → ao marcar novo, desmarcar automaticamente o anterior
- id: RN-RF015-03
  descricao: 'Hierarquia obrigatória: Sala pertence a Andar, Andar a Edifício, Edifício a Endereço, Endereço a Tenant.'
  tipo: regra_negocio
  campos_afetados:
  - Id_Local_Pai
  - Id_Endereco
  - Id_Fornecedor
  obrigatorio: true
  criterio_aceite:
  - Tentativa de criar Sala sem Andar → rejeição HTTP 400
  - Inativar Edifício → desativar Andares → Salas → Racks em cascata (soft delete)
- id: RN-RF015-04
  descricao: 'Racks devem atender padrões: Altura 1-48U, Profundidade 600/800/1000mm, Peso > 0kg, Potência > 0W.'
  tipo: validacao
  campos_afetados:
  - Nr_Altura_Us
  - Nr_Profundidade_Mm
  - Nr_Peso_Maximo_Kg
  - Nr_Potencia_Maxima_Watts
  obrigatorio: true
  criterio_aceite:
  - Altura fora do range 1-48U → rejeição HTTP 400
  - Instalar equipamento que exceda peso/potência disponível → rejeição HTTP 400
- id: RN-RF015-05
  descricao: Posições em racks (U1-U48) não podem se sobrepor. Ao instalar equipamento em U10-U12, todas estas posições são
    marcadas como ocupadas.
  tipo: regra_negocio
  campos_afetados:
  - Nr_Posicao_U
  - Fl_Ocupada
  obrigatorio: true
  criterio_aceite:
  - Equipamento instalado em U10-U12 → posições 10, 11, 12 marcadas como ocupadas
  - Tentativa de instalar em U11-U13 → rejeição HTTP 400 (sobrepõe)
- id: RN-RF015-06
  descricao: 'Tipos de sala: Datacenter/Sala_Servidores/CPD/Sala_Tecnica permitem racks. Escritório/Reunião/Armazenamento
    NÃO permitem.'
  tipo: regra_negocio
  campos_afetados:
  - Tipo_Sala
  obrigatorio: true
  criterio_aceite:
  - Tentativa de criar rack em Sala tipo 'Escritório' → rejeição HTTP 400
  - Sala com capacidade máxima de 5 racks, já com 5 → tentativa de criar 6º → rejeição HTTP 400
- id: RN-RF015-07
  descricao: Geocodificação automática assíncrona via Google Maps Geocoding API. Se falhar, não impede salvamento do endereço.
  tipo: integracao
  campos_afetados:
  - Nr_Latitude
  - Nr_Longitude
  - Dt_Ultima_Geocodificacao
  obrigatorio: false
  criterio_aceite:
  - Endereço completo salvo → geocodificação executada em background
  - Geocodificação falhada → endereço salvo sem coordenadas, log de erro gerado
- id: RN-RF015-08
  descricao: Histórico de movimentações é imutável (append-only). Somente INSERT, nunca UPDATE ou DELETE.
  tipo: seguranca
  campos_afetados:
  - Id_Historico
  - Dt_Movimentacao
  - Fl_Validado
  obrigatorio: true
  criterio_aceite:
  - Movimentação registrada → registro criado, imutável
  - Tentativa de UPDATE em histórico → rejeição HTTP 403
  - Tentativa de DELETE em histórico → rejeição HTTP 403
- id: RN-RF015-09
  descricao: Campo Sg_Estado deve conter sigla válida de UF brasileira (AC, AL, ..., TO). Sistema padroniza para UPPERCASE.
  tipo: validacao
  campos_afetados:
  - Sg_Estado
  obrigatorio: true
  criterio_aceite:
  - Entrada 'sp' → normalizado para 'SP' → aceito
  - Entrada 'XX' → rejeição HTTP 400
- id: RN-RF015-10
  descricao: Requisições para APIs externas (ViaCEP, Google Maps) com timeout 5s. Circuit breaker após 3 falhas consecutivas
    (modo aberto 60s).
  tipo: integracao
  campos_afetados: []
  obrigatorio: true
  criterio_aceite:
  - API timeout após 5s → retry automático (max 3 tentativas)
  - 3 falhas consecutivas → circuit breaker aberto por 60s
  - Durante circuit breaker aberto → operações sem integração externa continuam funcionando
estados:
  endereco:
  - id: active
    descricao: Endereço ativo e utilizável
  - id: inactive
    descricao: Endereço inativo (soft delete)
  local:
  - id: active
    descricao: Local ativo e operacional
  - id: inactive
    descricao: Local inativo (soft delete, pode afetar hierarquia)
  rack:
  - id: available
    descricao: Rack disponível para instalação de equipamentos
  - id: full
    descricao: Rack com 100% de ocupação
  - id: maintenance
    descricao: Rack em manutenção, indisponível temporariamente
  - id: inactive
    descricao: Rack inativo (soft delete)
transicoes:
  permitidas:
  - de: active
    para: inactive
    entidade: Endereco
  - de: active
    para: inactive
    entidade: Local
  - de: available
    para:
    - full
    - maintenance
    - inactive
    entidade: Rack
  - de: full
    para:
    - available
    - maintenance
    - inactive
    entidade: Rack
  - de: maintenance
    para:
    - available
    - inactive
    entidade: Rack
permissoes:
- codigo: locais:endereco:view_any
  descricao: Listar endereços do tenant
- codigo: locais:endereco:view
  descricao: Visualizar detalhes de endereço
- codigo: locais:endereco:create
  descricao: Criar novo endereço
- codigo: locais:endereco:update
  descricao: Atualizar endereço existente
- codigo: locais:endereco:delete
  descricao: Inativar endereço (soft delete)
- codigo: locais:local:view_any
  descricao: Listar locais do tenant
- codigo: locais:local:view
  descricao: Visualizar hierarquia de locais
- codigo: locais:local:create
  descricao: Criar local (Edifício, Andar, Sala, Rack, Posição)
- codigo: locais:local:update
  descricao: Atualizar local existente
- codigo: locais:local:delete
  descricao: Inativar local (soft delete)
- codigo: locais:rack:view_any
  descricao: Listar racks
- codigo: locais:rack:view
  descricao: Visualizar detalhes de rack
- codigo: locais:rack:create
  descricao: Criar rack com validação de capacidade
- codigo: locais:rack:update
  descricao: Atualizar rack
- codigo: locais:rack:delete
  descricao: Inativar rack
- codigo: locais:equipamento:instalar
  descricao: Instalar equipamento em posição de rack
- codigo: locais:equipamento:remover
  descricao: Remover equipamento de rack
- codigo: locais:movimentacao:view_any
  descricao: Consultar histórico de movimentações
- codigo: locais:movimentacao:registrar
  descricao: Registrar movimentação de ativo entre locais
- codigo: locais:movimentacao:validar
  descricao: Validar movimentação registrada
integracoes:
  internas:
  - Autenticação e Autorização (RF-002)
  - Multi-Tenancy
  - Auditoria (RF-003)
  - Central de Funcionalidades (Feature Flags)
  - Internacionalização (i18n)
  externas:
  - sistema: ViaCEP API
    tipo: REST API
    obrigatoria: true
    finalidade: Validação automática de CEP
  - sistema: Google Maps Geocoding API
    tipo: REST API
    obrigatoria: false
    finalidade: Geocodificação automática de endereços
seguranca:
  isolamento_tenant: true
  auditoria_obrigatoria: true
  soft_delete: true
  rate_limiting: true
  validacao_entrada: true
  protecao_injecao: true
  versionamento_otimista: true
  criptografia_transito: true
rastreabilidade:
  ucs_esperados:
  - UC00
  - UC01
  - UC02
  - UC03
  - UC04
catalog:
  crud:
  - id: RF-CRUD-01
    title: Criar endereço com validação automática de CEP
    required: true
  - id: RF-CRUD-02
    title: Listar endereços do tenant
    required: true
  - id: RF-CRUD-03
    title: Visualizar detalhes de endereço
    required: true
  - id: RF-CRUD-04
    title: Atualizar endereço existente
    required: true
  - id: RF-CRUD-05
    title: Inativar endereço (soft delete)
    required: true
  - id: RF-CRUD-06
    title: Criar local (Edifício, Andar, Sala, Rack, Posição)
    required: true
  - id: RF-CRUD-07
    title: Consultar hierarquia de locais
    required: true
  - id: RF-CRUD-08
    title: Criar rack com validação de capacidade
    required: true
  - id: RF-CRUD-09
    title: Instalar equipamento em posição de rack
    required: true
  - id: RF-CRUD-10
    title: Registrar movimentação de ativo entre locais
    required: true
  validacoes:
  - id: RF-VAL-01
    title: Validar formato de CEP
    required: true
  - id: RF-VAL-02
    title: Validar CEP via ViaCEP API
    required: true
  - id: RF-VAL-03
    title: Validar endereço principal único por tenant
    required: true
  - id: RF-VAL-04
    title: Validar hierarquia de locais obrigatória
    required: true
  - id: RF-VAL-05
    title: Validar capacidade de racks (altura, profundidade, peso, potência)
    required: true
  - id: RF-VAL-06
    title: Validar ocupação de posições sem sobreposição
    required: true
  - id: RF-VAL-07
    title: Validar tipos de sala e compatibilidade com racks
    required: true
  - id: RF-VAL-08
    title: Validar UF brasileira
    required: true
  seguranca:
  - id: RF-SEC-01
    title: Isolamento de tenant
    required: true
  - id: RF-SEC-02
    title: Permissões RBAC
    required: true
  - id: RF-SEC-03
    title: Histórico imutável (append-only)
    required: true
  - id: RF-SEC-04
    title: Versionamento otimista
    required: true
  - id: RF-SEC-05
    title: Rate limiting
    required: true
  - id: RF-SEC-06
    title: Validação de entrada obrigatória
    required: true
  - id: RF-SEC-07
    title: Proteção contra injeção
    required: true
exclusions:
  documentacao_items:
  - id: EX-RF015-01
    justificativa: Visualização de mapa interativo (feature opcional via feature flag)
  - id: EX-RF015-02
    justificativa: Importação em lote de locais (feature opcional)
  - id: EX-RF015-03
    justificativa: Cálculo de custo de deslocamento
  - id: EX-RF015-04
    justificativa: Relatórios de distribuição geográfica (features opcionais)
dependencias:
- documentacao_id: RF001
  titulo: Parâmetros e Configurações
  tipo: dependência funcional
  justificativa: URLs de APIs externas (ViaCEP, Google Maps)
- documentacao_id: RF002
  titulo: Autenticação e Autorização
  tipo: dependência técnica
  justificativa: Permissões RBAC granulares
- documentacao_id: RF003
  titulo: Auditoria
  tipo: dependência técnica
  justificativa: Histórico imutável de movimentações
- documentacao_id: RF043
  titulo: Endereços de Entrega
  tipo: relacionamento
  justificativa: Compartilha validação de CEP
- documentacao_id: RF052
  titulo: Gestão de Consumidores
  tipo: relacionamento
  justificativa: Usa endereços
historico:
- versao: '2.0'
  data: '2025-12-30'
  autor: Agência ALC - alc.dev.br
  descricao: 'Migração v1.0 → v2.0: separação RF/RL, adequação ao template canônico, sincronização com RF015.md'
- versao: '1.0'
  data: '2025-12-28'
  autor: IControlIT Architect Agent
  descricao: Versão inicial com conteúdo legado misturado
