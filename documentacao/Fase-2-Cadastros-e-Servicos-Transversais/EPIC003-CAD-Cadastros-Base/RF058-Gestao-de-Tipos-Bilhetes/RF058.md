# RF058 - Gestão de Tipos de Bilhetes

**Versão:** 2.0
**Última Atualização:** 2025-12-30
**Responsável:** Equipe IControlIT
**Status:** Em Desenvolvimento

---

## 1. RESUMO EXECUTIVO

### 1.1. Visão Geral
O RF058 implementa a funcionalidade de Gestão de Tipos de Bilhetes, permitindo cadastrar, editar, visualizar e gerenciar diferentes tipos de bilhetes utilizados no sistema. Esta funcionalidade é essencial para categorizar e controlar os bilhetes de suporte, identificando suas características e tratamento adequado.

### 1.2. Objetivos do Requisito
- Permitir a criação e manutenção de tipos de bilhetes
- Garantir categorização adequada dos bilhetes de suporte
- Facilitar a identificação e classificação de solicitações
- Fornecer interface intuitiva para gestão dos tipos
- Integrar com o sistema de bilhetes e atendimentos

### 1.3. Escopo Funcional
**Incluído neste RF:**
- CRUD completo de tipos de bilhetes
- Campos obrigatórios: Nome, Descrição
- Funcionalidades: Listagem, Criação, Edição, Visualização, Inativação
- Validações de dados e regras de negócio
- Auditoria completa de operações
- Controle de permissões RBAC
- Interface responsiva

**Fora do Escopo:**
- Gestão de bilhetes em si (RF separado)
- Workflow de atendimento
- SLA e métricas de tempo
- Integração com sistemas externos de ticketing

---

## 2. ESPECIFICAÇÃO FUNCIONAL

### 2.1. Funcionalidades Principais

#### 2.1.1. Listar Tipos de Bilhetes (UC00)
**Descrição:** Exibir lista paginada de todos os tipos de bilhetes cadastrados.

**Características:**
- Grid com colunas: Nome, Descrição, Status, Ações
- Paginação (padrão: 10 itens/página)
- Ordenação por Nome (A-Z)
- Filtro por Status (Ativo/Inativo)
- Busca por Nome ou Descrição
- Ações: Visualizar, Editar, Inativar/Ativar

**Permissão Requerida:** `CAD.TIPOS_BILHETES.VIEW`

---

#### 2.1.2. Criar Tipo de Bilhete (UC01)
**Descrição:** Cadastrar novo tipo de bilhete no sistema.

**Campos Obrigatórios:**
- **Nome** (string, máx. 100 caracteres)
  - Único no sistema (case-insensitive)
  - Apenas letras, números, espaços e hífen
  - Mínimo 3 caracteres

- **Descrição** (string, máx. 500 caracteres)
  - Texto livre descritivo
  - Mínimo 10 caracteres

**Campos Opcionais:**
- Status (boolean, padrão: Ativo)

**Validações:**
- Nome não pode ser duplicado
- Descrição deve ser clara e informativa
- Todos os campos obrigatórios devem estar preenchidos

**Permissão Requerida:** `CAD.TIPOS_BILHETES.CREATE`

---

#### 2.1.3. Visualizar Tipo de Bilhete (UC02)
**Descrição:** Exibir detalhes completos de um tipo de bilhete específico.

**Informações Exibidas:**
- ID do Tipo de Bilhete
- Nome
- Descrição
- Status (Ativo/Inativo)
- Data de Criação
- Usuário que Criou
- Data da Última Alteração
- Usuário que Alterou

**Permissão Requerida:** `CAD.TIPOS_BILHETES.VIEW`

---

#### 2.1.4. Editar Tipo de Bilhete (UC03)
**Descrição:** Modificar informações de um tipo de bilhete existente.

**Campos Editáveis:**
- Nome (com validação de unicidade)
- Descrição
- Status

**Validações:**
- Nome não pode duplicar com outro tipo
- Descrição deve manter padrão de qualidade
- Auditoria automática de alterações

**Permissão Requerida:** `CAD.TIPOS_BILHETES.EDIT`

---

#### 2.1.5. Inativar/Ativar Tipo de Bilhete (UC04)
**Descrição:** Alterar status de um tipo de bilhete (ativo/inativo).

**Comportamento:**
- Inativar: Tipo não aparece em seletores/dropdowns
- Ativar: Tipo volta a ficar disponível para uso
- Não há exclusão física de registros (soft delete)
- Manter histórico completo na auditoria

**Validações:**
- Verificar se tipo está em uso antes de inativar (apenas alerta)
- Permitir inativação mesmo com bilhetes associados (histórico preservado)

**Permissão Requerida:** `CAD.TIPOS_BILHETES.DELETE`

---

### 2.2. Campos da Entidade

| Campo | Tipo | Obrigatório | Descrição |
|-------|------|-------------|-----------|
| Id | GUID | Sim | Identificador único do tipo de bilhete |
| Nome | String(100) | Sim | Nome do tipo de bilhete |
| Descricao | String(500) | Sim | Descrição detalhada do tipo |
| Ativo | Boolean | Sim | Status do tipo (true=ativo, false=inativo) |
| EmpresaId | GUID | Sim | ID da empresa (multi-tenancy) |
| DataCriacao | DateTime | Sim | Data/hora de criação do registro |
| UsuarioCriacaoId | GUID | Sim | ID do usuário que criou |
| DataAlteracao | DateTime | Não | Data/hora da última alteração |
| UsuarioAlteracaoId | GUID | Não | ID do usuário que alterou |
| Excluido | Boolean | Sim | Flag de exclusão lógica (soft delete) |

---

## 3. REGRAS DE NEGÓCIO

### RN-RF058-001: Validação de Nome Único
**Descrição:** O nome do tipo de bilhete deve ser único no sistema (case-insensitive).

**Regra:**
```
SE existir tipo de bilhete com mesmo nome (ignorando maiúsculas/minúsculas)
E esse tipo pertencer à mesma empresa
E não for o próprio registro sendo editado
ENTÃO rejeitar operação
```

**Mensagem de Erro:** "Já existe um tipo de bilhete com este nome."

**Justificativa:** Evitar duplicidade e confusão na categorização.

**Implementação:**
- Validação no FluentValidator
- Query case-insensitive no banco
- Verificar EmpresaId para multi-tenancy

---

### RN-RF058-002: Tamanho Mínimo de Nome
**Descrição:** O nome do tipo de bilhete deve ter no mínimo 3 caracteres.

**Regra:**
```
SE nome.Length < 3
ENTÃO rejeitar operação
```

**Mensagem de Erro:** "O nome deve ter no mínimo 3 caracteres."

**Justificativa:** Garantir nomes significativos.

---

### RN-RF058-003: Tamanho Máximo de Nome
**Descrição:** O nome do tipo de bilhete não pode exceder 100 caracteres.

**Regra:**
```
SE nome.Length > 100
ENTÃO rejeitar operação
```

**Mensagem de Erro:** "O nome não pode exceder 100 caracteres."

---

### RN-RF058-004: Formato de Nome
**Descrição:** O nome deve conter apenas letras, números, espaços e hífen.

**Regra:**
```
SE nome contiver caracteres especiais (exceto espaço e hífen)
ENTÃO rejeitar operação
```

**Mensagem de Erro:** "O nome pode conter apenas letras, números, espaços e hífen."

**Expressão Regular:** `^[a-zA-Z0-9À-ÿ\s\-]+$`

---

### RN-RF058-005: Descrição Obrigatória
**Descrição:** A descrição do tipo de bilhete é obrigatória e deve ter no mínimo 10 caracteres.

**Regra:**
```
SE descrição estiver vazia OU descrição.Length < 10
ENTÃO rejeitar operação
```

**Mensagem de Erro:** "A descrição é obrigatória e deve ter no mínimo 10 caracteres."

---

### RN-RF058-006: Tamanho Máximo de Descrição
**Descrição:** A descrição não pode exceder 500 caracteres.

**Regra:**
```
SE descrição.Length > 500
ENTÃO rejeitar operação
```

**Mensagem de Erro:** "A descrição não pode exceder 500 caracteres."

---

### RN-RF058-007: Multi-Tenancy Obrigatório
**Descrição:** Todo tipo de bilhete DEVE estar associado a uma empresa (EmpresaId).

**Regra:**
```
SE EmpresaId estiver vazio OU não existir
ENTÃO rejeitar operação
```

**Mensagem de Erro:** "Empresa não identificada."

**Implementação:**
- EmpresaId obtido automaticamente do contexto do usuário logado
- Validação no handler do comando
- Filtro automático nas queries (Row-Level Security)

---

### RN-RF058-008: Soft Delete
**Descrição:** Tipos de bilhetes não são excluídos fisicamente, apenas marcados como excluídos.

**Regra:**
```
QUANDO solicitar exclusão
ENTÃO atualizar campo Excluido = true
E manter registro no banco
```

**Justificativa:** Preservar histórico e integridade referencial.

---

### RN-RF058-009: Auditoria Obrigatória
**Descrição:** Todas as operações devem ser auditadas.

**Operações Auditadas:**
- CREATE: Criação de tipo de bilhete
- UPDATE: Edição de tipo de bilhete
- DELETE: Inativação de tipo de bilhete
- ACCESS: Visualização de detalhes

**Dados Registrados:**
- Usuário que executou
- Data/hora da operação
- IP de origem
- Dados antes/depois (para UPDATE)

---

### RN-RF058-010: Status Padrão
**Descrição:** Novos tipos de bilhetes são criados com status Ativo por padrão.

**Regra:**
```
SE status não for informado na criação
ENTÃO Ativo = true
```

---

### RN-RF058-011: Permissões Requeridas
**Descrição:** Cada operação requer permissão específica.

**Matriz de Permissões:**
| Operação | Permissão |
|----------|-----------|
| Listar | `CAD.TIPOS_BILHETES.VIEW` |
| Criar | `CAD.TIPOS_BILHETES.CREATE` |
| Visualizar | `CAD.TIPOS_BILHETES.VIEW` |
| Editar | `CAD.TIPOS_BILHETES.EDIT` |
| Inativar | `CAD.TIPOS_BILHETES.DELETE` |

---

### RN-RF058-012: Filtros de Listagem
**Descrição:** A listagem deve respeitar filtros aplicados pelo usuário.

**Filtros Disponíveis:**
- Status (Ativo/Inativo/Todos)
- Busca por Nome (contém, case-insensitive)
- Busca por Descrição (contém, case-insensitive)

**Ordenação Padrão:** Nome (A-Z)

---

## 4. MODELO DE DADOS

### 4.1. Entidade Principal
**Tabela:** `TipoBilhete`

**Estrutura Completa (DDL):**
```sql
CREATE TABLE TipoBilhete (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    Nome NVARCHAR(100) NOT NULL,
    Descricao NVARCHAR(500) NOT NULL,
    Ativo BIT NOT NULL DEFAULT 1,

    -- Multi-tenancy
    EmpresaId UNIQUEIDENTIFIER NOT NULL,

    -- Auditoria
    DataCriacao DATETIME2 NOT NULL DEFAULT GETDATE(),
    UsuarioCriacaoId UNIQUEIDENTIFIER NOT NULL,
    DataAlteracao DATETIME2 NULL,
    UsuarioAlteracaoId UNIQUEIDENTIFIER NULL,

    -- Soft Delete
    Excluido BIT NOT NULL DEFAULT 0,

    -- Constraints
    CONSTRAINT FK_TipoBilhete_Empresa FOREIGN KEY (EmpresaId) REFERENCES Empresa(Id),
    CONSTRAINT FK_TipoBilhete_UsuarioCriacao FOREIGN KEY (UsuarioCriacaoId) REFERENCES Usuario(Id),
    CONSTRAINT FK_TipoBilhete_UsuarioAlteracao FOREIGN KEY (UsuarioAlteracaoId) REFERENCES Usuario(Id)
);

-- Índices
CREATE INDEX IX_TipoBilhete_EmpresaId ON TipoBilhete(EmpresaId);
CREATE INDEX IX_TipoBilhete_Nome ON TipoBilhete(Nome);
CREATE INDEX IX_TipoBilhete_Ativo ON TipoBilhete(Ativo);
CREATE UNIQUE INDEX IX_TipoBilhete_Nome_Empresa ON TipoBilhete(Nome, EmpresaId) WHERE Excluido = 0;
```

### 4.2. Relacionamentos
- **Empresa (N:1):** TipoBilhete pertence a uma Empresa
- **Usuario (N:1):** TipoBilhete.UsuarioCriacaoId → Usuario
- **Usuario (N:1):** TipoBilhete.UsuarioAlteracaoId → Usuario
- **Bilhete (1:N):** TipoBilhete pode ter vários Bilhetes (futuro)

---

## 5. CASOS DE USO

### UC00 - Listar Tipos de Bilhetes
**Arquivo:** `Casos de Uso/UC00-listar-tipos-bilhetes.md`

**Ator Principal:** Usuário do Sistema

**Pré-condições:**
- Usuário autenticado
- Permissão `CAD.TIPOS_BILHETES.VIEW`

**Fluxo Principal:**
1. Sistema exibe lista de tipos de bilhetes
2. Usuário visualiza grid com paginação
3. Usuário pode filtrar/ordenar/buscar
4. Usuário pode acessar ações (visualizar, editar, inativar)

---

### UC01 - Criar Tipo de Bilhete
**Arquivo:** `Casos de Uso/UC01-criar-tipo-bilhete.md`

**Ator Principal:** Administrador/Gestor

**Pré-condições:**
- Usuário autenticado
- Permissão `CAD.TIPOS_BILHETES.CREATE`

**Fluxo Principal:**
1. Usuário acessa formulário de criação
2. Usuário preenche Nome e Descrição
3. Sistema valida dados (RN-RF058-001 a RN-RF058-007)
4. Sistema cria tipo de bilhete
5. Sistema exibe mensagem de sucesso
6. Sistema registra auditoria

---

### UC02 - Visualizar Tipo de Bilhete
**Arquivo:** `Casos de Uso/UC02-visualizar-tipo-bilhete.md`

---

### UC03 - Editar Tipo de Bilhete
**Arquivo:** `Casos de Uso/UC03-editar-tipo-bilhete.md`

---

### UC04 - Inativar Tipo de Bilhete
**Arquivo:** `Casos de Uso/UC04-inativar-tipo-bilhete.md`

---

## 6. REQUISITOS NÃO FUNCIONAIS

### 6.1. Performance
- Listagem deve carregar em menos de 2 segundos
- Busca deve responder em menos de 1 segundo
- Criação/edição deve concluir em menos de 3 segundos

### 6.2. Usabilidade
- Interface responsiva (mobile-first)
- Mensagens de erro claras e acionáveis
- Feedback visual para todas as ações
- Confirmação para operações críticas (inativar)

### 6.3. Segurança
- Validação de entrada em todas as operações
- Proteção contra SQL Injection
- Proteção contra XSS
- Auditoria completa de operações

### 6.4. Confiabilidade
- Validação de dados antes de persistir
- Transações atômicas (rollback em caso de erro)
- Logs estruturados para troubleshooting

---

## 7. INTERFACE DO USUÁRIO

### 7.1. Tela de Listagem
**Rota:** `/cadastros/tipos-bilhetes`

**Componentes:**
- Header com título "Tipos de Bilhetes"
- Botão "Novo Tipo de Bilhete" (se permissão CREATE)
- Filtros: Status, Busca
- Grid com colunas: Nome, Descrição, Status, Ações
- Paginação

---

### 7.2. Tela de Criação/Edição
**Rota:** `/cadastros/tipos-bilhetes/novo` | `/cadastros/tipos-bilhetes/{id}/editar`

**Campos:**
- Nome (input text, obrigatório)
- Descrição (textarea, obrigatório)
- Status (toggle Ativo/Inativo)

**Botões:**
- Salvar
- Cancelar

---

### 7.3. Tela de Visualização
**Rota:** `/cadastros/tipos-bilhetes/{id}`

**Informações:**
- Todos os campos em modo somente leitura
- Dados de auditoria
- Botões: Editar (se permissão), Voltar

---

## 8. INTEGRAÇÃO COM SISTEMAS

### 8.1. Central de Funcionalidades
**Registro Obrigatório:**
```json
{
  "codigo": "CAD.TIPOS_BILHETES",
  "nome": "Gestão de Tipos de Bilhetes",
  "descricao": "Cadastro e manutenção de tipos de bilhetes",
  "modulo": "Cadastros",
  "rota": "/cadastros/tipos-bilhetes",
  "icone": "heroicons_outline:ticket",
  "ordem": 58,
  "ativo": true
}
```

---

### 8.2. Internacionalização (i18n)

**Chaves de Tradução Obrigatórias:**

**pt-BR:**
```json
{
  "tiposBilhetes": {
    "titulo": "Tipos de Bilhetes",
    "novo": "Novo Tipo de Bilhete",
    "editar": "Editar Tipo de Bilhete",
    "visualizar": "Detalhes do Tipo de Bilhete",
    "campos": {
      "nome": "Nome",
      "descricao": "Descrição",
      "status": "Status",
      "ativo": "Ativo",
      "inativo": "Inativo"
    },
    "mensagens": {
      "sucessoCriacao": "Tipo de bilhete criado com sucesso.",
      "sucessoEdicao": "Tipo de bilhete atualizado com sucesso.",
      "sucessoInativacao": "Tipo de bilhete inativado com sucesso.",
      "erroNomeDuplicado": "Já existe um tipo de bilhete com este nome.",
      "erroNomeMinimo": "O nome deve ter no mínimo 3 caracteres.",
      "erroDescricaoMinimo": "A descrição deve ter no mínimo 10 caracteres."
    },
    "confirmacoes": {
      "inativar": "Deseja realmente inativar este tipo de bilhete?"
    }
  }
}
```

**Idiomas Suportados:** pt-BR (primário), en-US, es-ES

---

### 8.3. Sistema de Auditoria

**Operações Auditadas:**

| Operação | Código | Descrição |
|----------|--------|-----------|
| CREATE | TIPO_BILHETE_CREATED | Tipo de bilhete criado |
| UPDATE | TIPO_BILHETE_UPDATED | Tipo de bilhete atualizado |
| DELETE | TIPO_BILHETE_DELETED | Tipo de bilhete inativado |
| ACCESS | TIPO_BILHETE_ACCESSED | Detalhes visualizados |

**Dados Registrados:**
- Usuário (ID + Nome)
- Timestamp (UTC)
- IP de origem
- Ação executada
- Entidade afetada (TipoBilhete)
- Dados antes/depois (JSON)

**Retenção:** 7 anos (conforme LGPD)

---

### 8.4. Controle de Acesso (RBAC)

**Permissões Necessárias:**

| Código | Descrição | Profiles com Acesso |
|--------|-----------|---------------------|
| `CAD.TIPOS_BILHETES.VIEW` | Visualizar tipos de bilhetes | Todos os usuários |
| `CAD.TIPOS_BILHETES.CREATE` | Criar tipos de bilhetes | Administrador, Gestor |
| `CAD.TIPOS_BILHETES.EDIT` | Editar tipos de bilhetes | Administrador, Gestor |
| `CAD.TIPOS_BILHETES.DELETE` | Inativar tipos de bilhetes | Administrador |

**Matriz de Permissões:**
- **Super Admin:** Todas as permissões
- **Administrador:** VIEW, CREATE, EDIT, DELETE
- **Gestor:** VIEW, CREATE, EDIT
- **Usuário Padrão:** VIEW

---

## 9. CRITÉRIOS DE ACEITE

### 9.1. Backend
- [ ] Endpoints implementados (GET, POST, PUT, DELETE)
- [ ] Validações implementadas (FluentValidation)
- [ ] Testes unitários (>80% cobertura)
- [ ] Testes de integração (cenários principais)
- [ ] Auditoria funcionando
- [ ] Multi-tenancy validado
- [ ] Permissões implementadas

### 9.2. Frontend
- [ ] Tela de listagem responsiva
- [ ] Tela de criação/edição funcional
- [ ] Tela de visualização funcional
- [ ] Validações de formulário
- [ ] Mensagens de erro/sucesso
- [ ] i18n completo (pt-BR, en-US, es-ES)
- [ ] Testes E2E (Playwright)

### 9.3. Integração
- [ ] Central de Funcionalidades registrada
- [ ] Permissões criadas e associadas
- [ ] Traduções completas
- [ ] Auditoria testada

---

## 10. RISCOS E MITIGAÇÕES

| Risco | Impacto | Probabilidade | Mitigação |
|-------|---------|---------------|-----------|
| Duplicidade de nomes | Médio | Média | Validação única case-insensitive |
| Performance na listagem | Baixo | Baixa | Paginação + índices otimizados |
| Tipos em uso sendo inativados | Baixo | Média | Permitir inativação com alerta |

---

## 11. DEPENDÊNCIAS

### 11.1. Requisitos Funcionais
- **RF002 - Gestão de Empresas:** Necessário para multi-tenancy
- **RF003 - Gestão de Usuários:** Necessário para auditoria
- **RF001 - Central de Funcionalidades:** Integração obrigatória

### 11.2. Requisitos Técnicos
- .NET 10
- Entity Framework Core 10
- Angular 19
- SQL Server / SQLite
- Transloco (i18n)

### 11.3. Dados Mestres
- Empresa ativa no sistema
- Usuário autenticado

---

## 12. APÊNDICES

### 12.1. Glossário
- **Tipo de Bilhete:** Categoria que classifica um bilhete de suporte
- **Bilhete:** Solicitação de suporte ou atendimento
- **Soft Delete:** Exclusão lógica (marcação como excluído sem remover fisicamente)
- **Multi-tenancy:** Isolamento de dados por empresa

### 12.2. Referências
- [Clean Architecture - Microsoft](https://docs.microsoft.com/en-us/dotnet/architecture/modern-web-apps-azure/common-web-application-architectures)
- [CQRS Pattern](https://martinfowler.com/bliki/CQRS.html)
- [LGPD - Lei Geral de Proteção de Dados](http://www.planalto.gov.br/ccivil_03/_ato2015-2018/2018/lei/l13709.htm)

---

**Documento gerado conforme TEMPLATE-RF.md v2.0**
**Projeto IControlIT - Modernização do Sistema**
