rf_id: RF085
rf_title: "Importação de Dados"
versao_governanca: "2.0"
data_migracao: "2025-12-31"
epic: "EPIC003-CAD-Cadastros-Base"
fase: "Fase 2 - Cadastros e Serviços Transversais"

# ==============================================================================
# FUNCIONALIDADES
# ==============================================================================

funcionalidades:
  - id: "F01"
    titulo: "Gerenciamento de Templates de Importação"
    prioridade: "CRÍTICA"
    descricao: "Criação, edição e exclusão de templates que definem mapeamento de campos"

  - id: "F02"
    titulo: "Transformação de Dados com Regras"
    prioridade: "ALTA"
    descricao: "Aplicação de transformações configuráveis sobre dados de origem"

  - id: "F03"
    titulo: "Validação Multi-Camadas"
    prioridade: "CRÍTICA"
    descricao: "Sistema de validação em múltiplas camadas (estrutural, semântica, referencial, negócio)"

  - id: "F04"
    titulo: "Detecção Inteligente de Duplicatas"
    prioridade: "ALTA"
    descricao: "Identificação automática de registros duplicados"

  - id: "F05"
    titulo: "Importação Incremental"
    prioridade: "ALTA"
    descricao: "Processamento apenas de registros novos ou modificados"

  - id: "F06"
    titulo: "Importação Full com Delta Detection"
    prioridade: "MÉDIA"
    descricao: "Reprocessamento completo com detecção de mudanças reais"

  - id: "F07"
    titulo: "Agendamento Recorrente (Hangfire)"
    prioridade: "ALTA"
    descricao: "Execução automática de importações em horários predefinidos"

  - id: "F08"
    titulo: "Histórico Completo de Importações"
    prioridade: "CRÍTICA"
    descricao: "Registro detalhado de todas as importações executadas"

  - id: "F09"
    titulo: "Rollback por Importação"
    prioridade: "ALTA"
    descricao: "Capacidade de reverter importações específicas"

  - id: "F10"
    titulo: "Relatório de Erros com Sugestões"
    prioridade: "ALTA"
    descricao: "Geração automática de relatórios detalhados de erros"

  - id: "F11"
    titulo: "Preview de Dados antes de Importar"
    prioridade: "ALTA"
    descricao: "Visualização das primeiras 100 linhas com validações aplicadas"

  - id: "F12"
    titulo: "Processamento Assíncrono com SignalR"
    prioridade: "ALTA"
    descricao: "Importações em background com notificações em tempo real"

  - id: "F13"
    titulo: "API de Consulta de Status"
    prioridade: "ALTA"
    descricao: "Endpoint REST para consulta de status em execução"

# ==============================================================================
# REGRAS DE NEGÓCIO
# ==============================================================================

regras_negocio:
  - id: "RN-RF085-001"
    titulo: "Mapeamento de Campos Obrigatório"
    descricao: "Toda importação deve usar um template de mapeamento que define explicitamente qual coluna de origem mapeia para qual campo de destino"
    criticidade: "CRÍTICA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "field_mapping_required"
      mensagem_erro: "Coluna '{column}' não está mapeada"
      http_code: 400

  - id: "RN-RF085-002"
    titulo: "Transformação de Dados Conforme Template"
    descricao: "Todas as transformações aplicadas devem estar documentadas no template"
    criticidade: "ALTA"
    implementacao:
      backend: true
      frontend: false
      validacao_api: true
      validacao_ui: false
    validacao:
      tipo: "transformation_documented"
      mensagem_erro: "Transformação não documentada para campo '{field}'"
      http_code: 400

  - id: "RN-RF085-003"
    titulo: "Validação de Dados Contra Regras de Negócio"
    descricao: "Cada campo deve ser validado contra regras de negócio antes de ser inserido"
    criticidade: "CRÍTICA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "business_rules"
      mensagem_erro: "Campo '{field}' não passou na validação: {error}"
      http_code: 400

  - id: "RN-RF085-004"
    titulo: "Detecção de Duplicatas por Chave Natural"
    descricao: "Sistema detecta automaticamente se registro já existe antes de inserir"
    criticidade: "ALTA"
    implementacao:
      backend: true
      frontend: false
      validacao_api: true
      validacao_ui: false
    validacao:
      tipo: "duplicate_detection"
      mensagem_erro: "Duplicata detectada: {key}"
      http_code: 400

  - id: "RN-RF085-005"
    titulo: "Importação Incremental (Delta Detection)"
    descricao: "Se modo Incremental, sistema processa apenas registros novos ou modificados"
    criticidade: "ALTA"
    implementacao:
      backend: true
      frontend: false
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "delta_detection"
      mensagem_erro: null
      http_code: null

  - id: "RN-RF085-006"
    titulo: "Agendamento Recorrente com Hangfire"
    descricao: "Importações podem ser agendadas para executar automaticamente via Hangfire"
    criticidade: "ALTA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: false
      validacao_ui: true
    validacao:
      tipo: "cron_expression"
      mensagem_erro: "Expressão cron inválida: {expression}"
      http_code: 400

  - id: "RN-RF085-007"
    titulo: "Histórico de Importações com Rollback"
    descricao: "Cada importação é registrada em tabela de auditoria com capacidade de rollback"
    criticidade: "CRÍTICA"
    implementacao:
      backend: true
      frontend: false
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "audit_required"
      mensagem_erro: null
      http_code: null

  - id: "RN-RF085-008"
    titulo: "Validação Transacional (Tudo ou Nada)"
    descricao: "Importação é executada dentro de uma transação SQL"
    criticidade: "CRÍTICA"
    implementacao:
      backend: true
      frontend: false
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "transactional"
      mensagem_erro: "Transação abortada: {error}"
      http_code: 500

  - id: "RN-RF085-009"
    titulo: "API de Status de Importação em Tempo Real"
    descricao: "Endpoint GET /api/imports/{id}/status retorna progresso em tempo real via SignalR"
    criticidade: "ALTA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: null
      mensagem_erro: null
      http_code: null

  - id: "RN-RF085-010"
    titulo: "Relatório Detalhado de Erros com Sugestões"
    descricao: "Sistema gera relatório detalhado listando cada linha rejeitada com sugestões"
    criticidade: "ALTA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: null
      mensagem_erro: null
      http_code: null

  - id: "RN-RF085-011"
    titulo: "Isolamento Multi-Tenant"
    descricao: "Todas as importações respeitam isolamento por ClienteId"
    criticidade: "CRÍTICA"
    implementacao:
      backend: true
      frontend: false
      validacao_api: true
      validacao_ui: false
    validacao:
      tipo: "multi_tenant"
      mensagem_erro: "Acesso negado: ClienteId incompatível"
      http_code: 403

  - id: "RN-RF085-012"
    titulo: "Validação de Tamanho e Tipo de Arquivo"
    descricao: "Sistema valida tipo MIME, extensão e tamanho antes de processamento"
    criticidade: "ALTA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "file_validation"
      mensagem_erro: "Arquivo inválido: {error}"
      http_code: 400

  - id: "RN-RF085-013"
    titulo: "Scan Antivírus Obrigatório"
    descricao: "Todo arquivo é escaneado por ClamAV antes de processamento"
    criticidade: "CRÍTICA"
    implementacao:
      backend: true
      frontend: false
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "antivirus_scan"
      mensagem_erro: "Malware detectado: {threat}"
      http_code: 400

# ==============================================================================
# PERMISSÕES RBAC
# ==============================================================================

permissoes_rbac:
  - permission_code: "IMP.TEMPLATE.CREATE"
    descricao: "Criar template de importação"
    roles_autorizadas:
      - "Super Admin"
      - "Admin"
      - "Gestor Financeiro"
      - "TI"
    endpoint: "POST /api/imports/templates"

  - permission_code: "IMP.TEMPLATE.READ"
    descricao: "Visualizar templates"
    roles_autorizadas:
      - "Super Admin"
      - "Admin"
      - "Gestor Financeiro"
      - "TI"
      - "Analista Dados"
      - "Usuário"
    endpoint: "GET /api/imports/templates"

  - permission_code: "IMP.TEMPLATE.UPDATE"
    descricao: "Editar template"
    roles_autorizadas:
      - "Super Admin"
      - "Admin"
      - "Gestor Financeiro"
    endpoint: "PUT /api/imports/templates/{id}"

  - permission_code: "IMP.TEMPLATE.DELETE"
    descricao: "Deletar template"
    roles_autorizadas:
      - "Super Admin"
      - "Admin"
    endpoint: "DELETE /api/imports/templates/{id}"

  - permission_code: "IMP.IMPORT.CREATE"
    descricao: "Executar importação manual"
    roles_autorizadas:
      - "Super Admin"
      - "Admin"
      - "Gestor Financeiro"
      - "TI"
      - "Analista Dados"
    endpoint: "POST /api/imports"

  - permission_code: "IMP.IMPORT.READ"
    descricao: "Visualizar importações"
    roles_autorizadas:
      - "Super Admin"
      - "Admin"
      - "Gestor Financeiro"
      - "TI"
      - "Analista Dados"
      - "Usuário"
    endpoint: "GET /api/imports"

  - permission_code: "IMP.IMPORT.PREVIEW"
    descricao: "Preview de dados antes de importar"
    roles_autorizadas:
      - "Super Admin"
      - "Admin"
      - "Gestor Financeiro"
      - "Analista Dados"
    endpoint: "POST /api/imports/preview"

  - permission_code: "IMP.IMPORT.ROLLBACK"
    descricao: "Reverter importação"
    roles_autorizadas:
      - "Super Admin"
      - "Admin"
    endpoint: "POST /api/imports/{id}/rollback"

  - permission_code: "IMP.SCHEDULE.CREATE"
    descricao: "Criar agendamento de importação"
    roles_autorizadas:
      - "Super Admin"
      - "Admin"
      - "TI"
    endpoint: "POST /api/imports/scheduled"

  - permission_code: "IMP.SCHEDULE.READ"
    descricao: "Visualizar agendamentos"
    roles_autorizadas:
      - "Super Admin"
      - "Admin"
      - "Gestor Financeiro"
      - "TI"
    endpoint: "GET /api/imports/scheduled"

  - permission_code: "IMP.SCHEDULE.UPDATE"
    descricao: "Editar agendamento"
    roles_autorizadas:
      - "Super Admin"
      - "Admin"
      - "TI"
    endpoint: "PUT /api/imports/scheduled/{id}"

  - permission_code: "IMP.SCHEDULE.DELETE"
    descricao: "Deletar agendamento"
    roles_autorizadas:
      - "Super Admin"
      - "Admin"
    endpoint: "DELETE /api/imports/scheduled/{id}"

  - permission_code: "IMP.IMPORT.EXPORT_ERRORS"
    descricao: "Exportar relatório de erros"
    roles_autorizadas:
      - "Super Admin"
      - "Admin"
      - "Gestor Financeiro"
      - "Analista Dados"
    endpoint: "GET /api/imports/{id}/errors/download"

# ==============================================================================
# API ENDPOINTS
# ==============================================================================

endpoints:
  # Templates
  - method: "GET"
    route: "/api/imports/templates"
    descricao: "Listar templates de importação"
    autenticacao: true
    authorization_policy: "IMP.TEMPLATE.READ"
    request_dto: null
    response_dto: "PaginatedListDto<ImportTemplateDto>"

  - method: "GET"
    route: "/api/imports/templates/{id}"
    descricao: "Obter template por ID"
    autenticacao: true
    authorization_policy: "IMP.TEMPLATE.READ"
    request_dto: null
    response_dto: "ImportTemplateDto"

  - method: "POST"
    route: "/api/imports/templates"
    descricao: "Criar novo template"
    autenticacao: true
    authorization_policy: "IMP.TEMPLATE.CREATE"
    request_dto: "CreateImportTemplateCommand"
    response_dto: "int"

  - method: "PUT"
    route: "/api/imports/templates/{id}"
    descricao: "Atualizar template"
    autenticacao: true
    authorization_policy: "IMP.TEMPLATE.UPDATE"
    request_dto: "UpdateImportTemplateCommand"
    response_dto: "void"

  - method: "DELETE"
    route: "/api/imports/templates/{id}"
    descricao: "Deletar template"
    autenticacao: true
    authorization_policy: "IMP.TEMPLATE.DELETE"
    request_dto: null
    response_dto: "void"

  # Importações
  - method: "POST"
    route: "/api/imports"
    descricao: "Executar importação manual"
    autenticacao: true
    authorization_policy: "IMP.IMPORT.CREATE"
    request_dto: "ExecuteImportCommand"
    response_dto: "int"

  - method: "GET"
    route: "/api/imports/{id}"
    descricao: "Obter detalhe de importação"
    autenticacao: true
    authorization_policy: "IMP.IMPORT.READ"
    request_dto: null
    response_dto: "ImportDto"

  - method: "GET"
    route: "/api/imports/{id}/status"
    descricao: "Status em tempo real"
    autenticacao: true
    authorization_policy: "IMP.IMPORT.READ"
    request_dto: null
    response_dto: "ImportStatusDto"

  - method: "GET"
    route: "/api/imports/{id}/errors"
    descricao: "Erros da importação"
    autenticacao: true
    authorization_policy: "IMP.IMPORT.READ"
    request_dto: null
    response_dto: "ImportErrorReportDto"

  - method: "GET"
    route: "/api/imports/{id}/errors/download"
    descricao: "Baixar relatório de erros (HTML/CSV)"
    autenticacao: true
    authorization_policy: "IMP.IMPORT.EXPORT_ERRORS"
    request_dto: null
    response_dto: "File"

  - method: "POST"
    route: "/api/imports/{id}/rollback"
    descricao: "Reverter importação"
    autenticacao: true
    authorization_policy: "IMP.IMPORT.ROLLBACK"
    request_dto: null
    response_dto: "RollbackResultDto"

  - method: "POST"
    route: "/api/imports/preview"
    descricao: "Preview de dados antes de importar"
    autenticacao: true
    authorization_policy: "IMP.IMPORT.PREVIEW"
    request_dto: "PreviewImportCommand"
    response_dto: "ImportPreviewDto"

  # Agendamentos
  - method: "GET"
    route: "/api/imports/scheduled"
    descricao: "Listar agendamentos"
    autenticacao: true
    authorization_policy: "IMP.SCHEDULE.READ"
    request_dto: null
    response_dto: "PaginatedListDto<ScheduledImportDto>"

  - method: "GET"
    route: "/api/imports/scheduled/{id}"
    descricao: "Obter agendamento por ID"
    autenticacao: true
    authorization_policy: "IMP.SCHEDULE.READ"
    request_dto: null
    response_dto: "ScheduledImportDto"

  - method: "POST"
    route: "/api/imports/scheduled"
    descricao: "Criar agendamento"
    autenticacao: true
    authorization_policy: "IMP.SCHEDULE.CREATE"
    request_dto: "CreateScheduledImportCommand"
    response_dto: "int"

  - method: "PUT"
    route: "/api/imports/scheduled/{id}"
    descricao: "Atualizar agendamento"
    autenticacao: true
    authorization_policy: "IMP.SCHEDULE.UPDATE"
    request_dto: "UpdateScheduledImportCommand"
    response_dto: "void"

  - method: "DELETE"
    route: "/api/imports/scheduled/{id}"
    descricao: "Deletar agendamento"
    autenticacao: true
    authorization_policy: "IMP.SCHEDULE.DELETE"
    request_dto: null
    response_dto: "void"

  # Histórico
  - method: "GET"
    route: "/api/imports/history"
    descricao: "Listar histórico de importações"
    autenticacao: true
    authorization_policy: "IMP.IMPORT.READ"
    request_dto: null
    response_dto: "PaginatedListDto<ImportHistoryDto>"

  - method: "GET"
    route: "/api/imports/history/{id}"
    descricao: "Detalhe de importação no histórico"
    autenticacao: true
    authorization_policy: "IMP.IMPORT.READ"
    request_dto: null
    response_dto: "ImportHistoryDto"

# ==============================================================================
# KPIs E MÉTRICAS
# ==============================================================================

kpis:
  - nome: "Taxa de Sucesso de Importação"
    descricao: "Percentual de importações concluídas com sucesso"
    meta: ">= 95%"
    formula: "(ImportaçõesComSucesso / TotalImportações) * 100"
    log_obrigatorio: true

  - nome: "Tempo Médio de Importação"
    descricao: "Tempo médio de processamento de uma importação"
    meta: "<= 5 minutos"
    formula: "Média(TempoDuracao)"
    log_obrigatorio: true

  - nome: "Taxa de Erros de Validação"
    descricao: "Percentual de registros rejeitados por erro de validação"
    meta: "<= 2%"
    formula: "(RegistrosRejeitados / TotalProcessados) * 100"
    log_obrigatorio: true

  - nome: "Taxa de Detecção de Duplicatas"
    descricao: "Percentual de duplicatas detectadas automaticamente"
    meta: "10-20%"
    formula: "(DuplicatasDetectadas / TotalImportados) * 100"
    log_obrigatorio: true

  - nome: "Disponibilidade do Serviço"
    descricao: "Percentual de tempo que o serviço está operacional"
    meta: ">= 99.5%"
    formula: "(TempoOperacional / TempoTotal) * 100"
    log_obrigatorio: true

  - nome: "Throughput de Processamento"
    descricao: "Quantidade de registros processados por segundo"
    meta: ">= 1000 reg/seg"
    formula: "RegistrosProcessados / TempoProcessamento"
    log_obrigatorio: true

  - nome: "Taxa de Rollback"
    descricao: "Percentual de importações que foram revertidas"
    meta: "<= 1%"
    formula: "(ImportaçõesRevertidas / TotalImportações) * 100"
    log_obrigatorio: true

# ==============================================================================
# ALERTAS CRÍTICOS
# ==============================================================================

alertas:
  - evento: "Importação com Erro"
    threshold: "IsSuccessful = false"
    severidade: "ALTA"
    canal_notificacao:
      - "email"
      - "slack"

  - evento: "Taxa de Erros Alta"
    threshold: "RejectedRecords > 10% do total"
    severidade: "MÉDIA"
    canal_notificacao:
      - "email"

  - evento: "Agendamento Falhou"
    threshold: "Job não completou em 1h após 3 retries"
    severidade: "ALTA"
    canal_notificacao:
      - "email"
      - "slack"

  - evento: "Espaço em Disco Baixo"
    threshold: "Azure Blob > 80% quota"
    severidade: "MÉDIA"
    canal_notificacao:
      - "email"

  - evento: "Throughput Degradado"
    threshold: "< 500 reg/seg por 5 minutos"
    severidade: "MÉDIA"
    canal_notificacao:
      - "email"

  - evento: "Malware Detectado"
    threshold: "ClamAV scan positivo"
    severidade: "CRÍTICA"
    canal_notificacao:
      - "email"
      - "slack"
      - "sms"

  - evento: "Tempo de Processamento Longo"
    threshold: "> 20 minutos"
    severidade: "BAIXA"
    canal_notificacao:
      - "email"

  - evento: "Tentativas 403 Recorrentes"
    threshold: "> 5 em 1 minuto"
    severidade: "CRÍTICA"
    canal_notificacao:
      - "email"
      - "slack"

# ==============================================================================
# DEPENDÊNCIAS
# ==============================================================================

dependencias:
  upstream:
    - documentacao_id: "RF084"
      descricao: "Upload/Importação"
      motivo: "RF085 depende de RF084 para upload de arquivos"

    - documentacao_id: "RF001"
      descricao: "Parâmetros e Configurações"
      motivo: "Configurações globais de importação"

    - documentacao_id: "RF006"
      descricao: "Gestão de Usuários"
      motivo: "Auditoria de quem executou cada importação"

    - documentacao_id: "RF007"
      descricao: "Gestão de Perfis de Acesso"
      motivo: "Permissões RBAC"

  downstream:
    - documentacao_id: "RF086"
      descricao: "Carga de Faturas/Consumo"
      motivo: "Usa RF085 para importar faturas de operadoras"

    - documentacao_id: "RF087"
      descricao: "Importação de Ativos"
      motivo: "Usa RF085 para importar inventário de ativos"

    - documentacao_id: "RF088"
      descricao: "Importação de Clientes"
      motivo: "Usa RF085 para migração de dados de clientes"

# ==============================================================================
# METADADOS
# ==============================================================================

metadados:
  total_funcionalidades: 13
  total_regras_negocio: 13
  total_endpoints_api: 20
  total_permissoes_rbac: 13
  total_kpis: 7
  total_alertas: 8
  total_dependencias_upstream: 4
  total_dependencias_downstream: 3
