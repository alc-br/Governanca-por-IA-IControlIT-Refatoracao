# =============================================
# UC-RF059 - Gestão de Status e Tipos Genéricos (Casos de Uso)
# Versão: 2.0
# Autor: Agência ALC - alc.dev.br
# Data: 2025-12-31
# =============================================

uc:
  documentacao: "RF059"
  versao: "2.0"
  data: "2025-12-31"

casos_de_uso:

  - id: "UC00"
    nome: "Listar Domínios e Itens"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      documentacao_items:
        - "endpoints[GET /api/dominios]"
      uc_items:
        - id: "FP-UC00-001"
          title: "Usuário acessa Gestão de Domínios"
          required: true
        - id: "FP-UC00-002"
          title: "Sistema valida permissão SIS.DOMINIOS.VIEW"
          required: true
        - id: "FP-UC00-003"
          title: "Sistema carrega lista paginada de domínios"
          required: true
        - id: "FP-UC00-004"
          title: "Sistema exibe grid: Categoria, Nome, Cor, Ordem, Qtd Uso, Status"
          required: true
        - id: "FA-UC00-001"
          title: "Filtrar por categoria (Ativos, Contratos, Chamados)"
          required: false
        - id: "FA-UC00-002"
          title: "Pesquisar por nome"
          required: false
        - id: "FE-UC00-001"
          title: "Usuário sem permissão"
          required: true

    precondicoes:
      - permissao: "SIS.DOMINIOS.VIEW"

    gatilho: "Usuario acessa Gestao Dominios"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessar_dominios"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "carregar_dominios_tenant"
      - passo: 4
        ator: "sistema"
        acao: "exibir_grid"

    fluxos_excecao:
      - id: "FE-UC00-01"
        condicao: "sem_permissao"
        resultado: "erro_403_acesso_negado"

    regras_aplicadas:
      - "RN-RF059-08"  # Multi-tenancy (globais + customizados)

    resultado_final:
      estado: "lista_dominios_exibida"

  - id: "UC01"
    nome: "Criar Item de Domínio"
    ator_principal: "usuario_autenticado"
    tipo: "crud"
    impacta_dados: true

    covers:
      documentacao_items:
        - "endpoints[POST /api/dominios/{dominioId}/itens]"
      uc_items:
        - id: "FP-UC01-001"
          title: "Usuário clica em Criar Item"
          required: true
        - id: "FP-UC01-002"
          title: "Sistema valida permissão SIS.DOMINIOS.ITEMS.CREATE"
          required: true
        - id: "FP-UC01-003"
          title: "Sistema exibe form: Categoria*, Nome*, Descrição, Cor_Badge, Icone, Ordem, Permite_Transicao_De (multi-select), Fl_Ativo"
          required: true
        - id: "FP-UC01-004"
          title: "Usuário preenche dados obrigatórios"
          required: true
        - id: "FP-UC01-005"
          title: "Sistema valida código único por domínio (case-insensitive)"
          required: true
        - id: "FP-UC01-006"
          title: "Sistema valida tradução pt-BR obrigatória"
          required: true
        - id: "FP-UC01-007"
          title: "Sistema salva item com ClienteId do usuário"
          required: true
        - id: "FP-UC01-008"
          title: "Sistema invalida cache do domínio"
          required: true
        - id: "FP-UC01-009"
          title: "Sistema registra auditoria SIS_ITEM_CRIADO"
          required: true
        - id: "FE-UC01-001"
          title: "Código duplicado no domínio"
          required: true
        - id: "FE-UC01-002"
          title: "Tradução pt-BR faltando"
          required: true

    precondicoes:
      - permissao: "SIS.DOMINIOS.ITEMS.CREATE"

    gatilho: "Usuario clica em Criar Item"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "clicar_criar"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "exibir_form"
      - passo: 4
        ator: "usuario"
        acao: "preencher_dados"
      - passo: 5
        ator: "sistema"
        acao: "validar_unicidade"
      - passo: 6
        ator: "sistema"
        acao: "validar_i18n"
      - passo: 7
        ator: "sistema"
        acao: "salvar_item"
      - passo: 8
        ator: "sistema"
        acao: "invalidar_cache"
      - passo: 9
        ator: "sistema"
        acao: "registrar_auditoria"

    fluxos_excecao:
      - id: "FE-UC01-01"
        condicao: "codigo_duplicado"
        resultado: "erro_400_codigo_existente"
      - id: "FE-UC01-02"
        condicao: "traducao_faltando"
        resultado: "erro_400_traducao_obrigatoria"

    regras_aplicadas:
      - "RN-RF059-02"  # Código único por domínio
      - "RN-RF059-07"  # i18n obrigatória
      - "RN-RF059-10"  # Cache invalidação

    resultado_final:
      estado: "item_criado_auditado"

  - id: "UC02"
    nome: "Visualizar Detalhes Item"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false

    covers:
      documentacao_items:
        - "endpoints[GET /api/dominios/itens/{id}]"
      uc_items:
        - id: "FP-UC02-001"
          title: "Usuário seleciona item na listagem"
          required: true
        - id: "FP-UC02-002"
          title: "Sistema valida permissão SIS.DOMINIOS.VIEW"
          required: true
        - id: "FP-UC02-003"
          title: "Sistema exibe detalhes completos do item"
          required: true
        - id: "FP-UC02-004"
          title: "Sistema exibe registros usando este item (count)"
          required: true
        - id: "FP-UC02-005"
          title: "Sistema exibe fluxo de transições permitidas"
          required: true
        - id: "FA-UC02-001"
          title: "Drill-down nos registros usando este item"
          required: false

    precondicoes:
      - permissao: "SIS.DOMINIOS.VIEW"

    gatilho: "Usuario seleciona item"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "selecionar_item"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "carregar_detalhes"
      - passo: 4
        ator: "sistema"
        acao: "contar_uso"
      - passo: 5
        ator: "sistema"
        acao: "carregar_transicoes"
      - passo: 6
        ator: "sistema"
        acao: "exibir_informacoes"

    regras_aplicadas:
      - "RN-RF059-03"  # Transições configuradas

    resultado_final:
      estado: "detalhes_exibidos"

  - id: "UC03"
    nome: "Editar Item de Domínio"
    ator_principal: "usuario_autenticado"
    tipo: "crud"
    impacta_dados: true

    covers:
      documentacao_items:
        - "endpoints[PUT /api/dominios/itens/{id}]"
      uc_items:
        - id: "FP-UC03-001"
          title: "Usuário clica em Editar"
          required: true
        - id: "FP-UC03-002"
          title: "Sistema valida permissão SIS.DOMINIOS.ITEMS.UPDATE"
          required: true
        - id: "FP-UC03-003"
          title: "Sistema carrega form com dados atuais"
          required: true
        - id: "FP-UC03-004"
          title: "Usuário altera nome, cor, transições"
          required: true
        - id: "FP-UC03-005"
          title: "Sistema valida alteração de transições (ciclos proibidos)"
          required: true
        - id: "FP-UC03-006"
          title: "Sistema cria snapshot histórico (DadosAntes/DadosDepois)"
          required: true
        - id: "FP-UC03-007"
          title: "Sistema invalida cache"
          required: true
        - id: "FP-UC03-008"
          title: "Sistema registra auditoria SIS_ITEM_EDITADO"
          required: true
        - id: "FE-UC03-001"
          title: "Ciclo detectado em transições"
          required: true

    precondicoes:
      - permissao: "SIS.DOMINIOS.ITEMS.UPDATE"

    gatilho: "Usuario clica em Editar"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "clicar_editar"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "carregar_form"
      - passo: 4
        ator: "usuario"
        acao: "alterar_dados"
      - passo: 5
        ator: "sistema"
        acao: "validar_transicoes"
      - passo: 6
        ator: "sistema"
        acao: "criar_historico"
      - passo: 7
        ator: "sistema"
        acao: "invalidar_cache"
      - passo: 8
        ator: "sistema"
        acao: "registrar_auditoria"

    fluxos_excecao:
      - id: "FE-UC03-01"
        condicao: "ciclo_transicao"
        resultado: "erro_400_ciclo_detectado"

    regras_aplicadas:
      - "RN-RF059-03"  # Validação transições
      - "RN-RF059-09"  # Histórico imutável
      - "RN-RF059-10"  # Cache invalidação

    resultado_final:
      estado: "item_editado_historico_criado"

  - id: "UC04"
    nome: "Inativar Item de Domínio"
    ator_principal: "usuario_autenticado"
    tipo: "crud"
    impacta_dados: true

    covers:
      documentacao_items:
        - "endpoints[DELETE /api/dominios/itens/{id}]"
      uc_items:
        - id: "FP-UC04-001"
          title: "Usuário clica em Inativar"
          required: true
        - id: "FP-UC04-002"
          title: "Sistema valida permissão SIS.DOMINIOS.ITEMS.DELETE"
          required: true
        - id: "FP-UC04-003"
          title: "Sistema valida dependências (registros ativos usando este item)"
          required: true
        - id: "FP-UC04-004"
          title: "Sistema confirma ação (modal)"
          required: true
        - id: "FP-UC04-005"
          title: "Sistema executa soft delete (fl_ativo = false)"
          required: true
        - id: "FP-UC04-006"
          title: "Sistema invalida cache"
          required: true
        - id: "FP-UC04-007"
          title: "Sistema registra auditoria SIS_ITEM_INATIVADO"
          required: true
        - id: "FE-UC04-001"
          title: "Item em uso (dependências ativas)"
          required: true

    precondicoes:
      - permissao: "SIS.DOMINIOS.ITEMS.DELETE"

    gatilho: "Usuario clica em Inativar"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "clicar_inativar"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "validar_dependencias"
      - passo: 4
        ator: "sistema"
        acao: "confirmar_modal"
      - passo: 5
        ator: "sistema"
        acao: "soft_delete"
      - passo: 6
        ator: "sistema"
        acao: "invalidar_cache"
      - passo: 7
        ator: "sistema"
        acao: "registrar_auditoria"

    fluxos_excecao:
      - id: "FE-UC04-01"
        condicao: "dependencias_ativas"
        resultado: "erro_409_migrar_primeiro"

    regras_aplicadas:
      - "RN-RF059-04"  # Inativação com validação dependências
      - "RN-RF059-10"  # Cache invalidação

    resultado_final:
      estado: "item_inativado"

  - id: "UC05"
    nome: "Reordenar Itens"
    ator_principal: "usuario_autenticado"
    tipo: "acao"
    impacta_dados: true

    covers:
      documentacao_items:
        - "endpoints[PATCH /api/dominios/itens/{id}/ordem]"
      uc_items:
        - id: "FP-UC05-001"
          title: "Usuário usa drag-and-drop para reordenar"
          required: true
        - id: "FP-UC05-002"
          title: "Sistema valida permissão SIS.DOMINIOS.ITEMS.UPDATE"
          required: true
        - id: "FP-UC05-003"
          title: "Sistema valida nova ordem (não-negativa, não-zero)"
          required: true
        - id: "FP-UC05-004"
          title: "Sistema reindexada automaticamente outros itens (evitar gaps)"
          required: true
        - id: "FP-UC05-005"
          title: "Sistema salva nova ordem"
          required: true
        - id: "FP-UC05-006"
          title: "Sistema invalida cache"
          required: true
        - id: "FP-UC05-007"
          title: "Sistema registra auditoria SIS_ITEM_EDITADO"
          required: true
        - id: "FE-UC05-001"
          title: "Ordem inválida (negativa ou zero)"
          required: true

    precondicoes:
      - permissao: "SIS.DOMINIOS.ITEMS.UPDATE"

    gatilho: "Usuario arrasta item"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "arrastar_item"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao"
      - passo: 3
        ator: "sistema"
        acao: "validar_ordem"
      - passo: 4
        ator: "sistema"
        acao: "reindexar_itens"
      - passo: 5
        ator: "sistema"
        acao: "salvar_ordem"
      - passo: 6
        ator: "sistema"
        acao: "invalidar_cache"
      - passo: 7
        ator: "sistema"
        acao: "registrar_auditoria"

    fluxos_excecao:
      - id: "FE-UC05-01"
        condicao: "ordem_invalida"
        resultado: "erro_400_ordem_positiva"

    regras_aplicadas:
      - "RN-RF059-05"  # Reindexação automática
      - "RN-RF059-10"  # Cache invalidação

    resultado_final:
      estado: "ordem_alterada_reindexada"

exclusions:
  uc_items: []

historico:
  - versao: "2.0"
    data: "2025-12-31"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Versão YAML estruturado sincronizado com RF059.yaml v2.0. Criação inicial do UC.yaml para RF059 com 6 casos de uso (UC00-UC05)."
