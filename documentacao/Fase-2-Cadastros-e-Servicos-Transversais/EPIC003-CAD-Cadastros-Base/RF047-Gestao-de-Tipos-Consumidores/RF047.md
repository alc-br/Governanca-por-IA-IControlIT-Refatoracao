# RF-047: Gestão de Tipos de Consumidores

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC003-CAD - Cadastros Base
**Fase**: Fase 2 - Cadastros e Serviços Transversais

---

## 1. OBJETIVO DO REQUISITO

Permitir a classificação e categorização de consumidores (usuários, dispositivos, máquinas) de recursos de telecomunicação através de tipos customizáveis, que determinam permissões, quotas, custos e comportamentos específicos no sistema. O requisito deve garantir flexibilidade total na criação de tipos, suporte a hierarquia e herança de configurações, auto-classificação baseada em regras, e gestão de ciclo de vida de tipos com auditoria completa.

Este documento define **o que o sistema deve fazer** em relação aos tipos de consumidores, incluindo funcionalidades, regras de negócio, estados, eventos e critérios de aceite.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Criação de tipos de consumidores customizáveis
- [x] Atualização de tipos existentes (nome, descrição, configurações)
- [x] Listagem de tipos com filtros (ativo/inativo, fornecedor, hierarquia)
- [x] Inativação lógica de tipos (sem exclusão física)
- [x] Hierarquia de tipos com relação pai/filho (acíclica)
- [x] Herança de configurações de tipo pai para tipo filho
- [x] Auto-classificação de consumidores baseada em regras (regex, domínio de e-mail, departamento)
- [x] Gestão de quotas por tipo (dados, voz, SMS)
- [x] Custo fixo mensal por tipo (somado ao billing)
- [x] Permissões default por tipo (aplicadas no onboarding)
- [x] Templates de provisioning automático por tipo
- [x] Workflow de aprovação para mudança de tipo (tipos críticos)
- [x] Dashboard de distribuição e custos por tipo
- [x] Versionamento e histórico de mudanças de tipo
- [x] Cores e ícones para identificação visual
- [x] Controle de acesso RBAC específico para tipos
- [x] Auditoria completa de operações
- [x] Multi-tenancy (isolamento por TenantId)
- [x] Limite de 50 tipos por fornecedor
- [x] Tipo padrão obrigatório por fornecedor

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (Angular)
- Tecnologia backend específica (.NET)
- Layout, UX ou identidade visual
- Estratégia de deploy ou infraestrutura
- Integrações com sistemas externos de billing (fora deste RF)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-----|---------|
| Tipo de Consumidor | Categoria que classifica consumidores (usuários/dispositivos) e define permissões, quotas, custos e comportamentos |
| Consumidor | Entidade que consome recursos (usuário, dispositivo, máquina virtual) |
| Fornecedor | Entidade responsável pela gestão de consumidores (ex: operadora telecom) |
| Hierarquia de Tipos | Relação pai-filho entre tipos, onde filho herda configurações do pai |
| Auto-Classificação | Atribuição automática de tipo baseada em regras (regex, domínio, departamento) |
| Tipo Padrão | Tipo atribuído por padrão a novos consumidores (obrigatório ter um por fornecedor) |
| Tipo Crítico | Tipo que exige aprovação para mudança (RN006) |
| Quota | Limite de consumo de recursos (dados, voz, SMS) por tipo |
| Provisioning Template | Configuração de recursos provisionados automaticamente no onboarding |
| Tenant | Unidade lógica de isolamento de dados (multi-tenancy) |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Criar Tipo de Consumidor** - Cadastrar novo tipo com código único, nome, descrição, hierarquia, quotas e configurações
2. **Atualizar Tipo de Consumidor** - Modificar tipo existente (exceto código, que é imutável)
3. **Consultar Tipo por ID** - Obter detalhes completos de um tipo específico
4. **Listar Tipos** - Listar tipos com filtros (fornecedor, ativo/inativo, hierarquia)
5. **Inativar Tipo** - Desativar tipo logicamente (consumidores migram para tipo padrão automaticamente)
6. **Reativar Tipo** - Reativar tipo previamente inativado
7. **Definir Tipo Padrão** - Marcar tipo como padrão para novos consumidores (apenas 1 por fornecedor)
8. **Configurar Hierarquia** - Definir tipo pai (validação de loops acíclicos)
9. **Configurar Quotas** - Definir limites de dados, voz, SMS (-1 = ilimitado)
10. **Configurar Auto-Classificação** - Criar regras de classificação automática (regex, domínio, departamento)
11. **Configurar Permissões Default** - Definir permissões aplicadas automaticamente no onboarding
12. **Configurar Template de Provisioning** - Definir recursos provisionados automaticamente
13. **Configurar Custo Fixo Mensal** - Definir custo adicional ao billing por tipo
14. **Workflow de Mudança de Tipo** - Aprovar/rejeitar mudança de tipo para tipos críticos
15. **Dashboard de Tipos** - Visualizar distribuição de consumidores e custos por tipo
16. **Histórico de Mudanças** - Consultar histórico de versões de um tipo (7 anos de retenção)
17. **Configurar Cores e Ícones** - Definir identificação visual do tipo

---

## 5. REGRAS DE NEGÓCIO

### RN-RF047-001 — Código de Tipo Único e Imutável

**Descrição**: O código do tipo deve ser único por fornecedor e imutável após criação.

**Justificativa**: Garantir identificação estável de tipos em integrações e relatórios.

**Critério de Aceite**:
- Código duplicado no mesmo fornecedor → rejeição HTTP 400
- Tentativa de alterar código de tipo existente → rejeição HTTP 400
- Código deve seguir padrão `[A-Z0-9_]{3,20}` (ex: `GERENTE_TI`, `FUNC_ADM`)

---

### RN-RF047-002 — Tipo Padrão Obrigatório por Fornecedor

**Descrição**: Todo fornecedor deve ter exatamente 1 tipo marcado como padrão.

**Justificativa**: Garantir que novos consumidores sempre recebam um tipo válido.

**Critério de Aceite**:
- Fornecedor sem tipo padrão → bloqueio de criação de consumidores
- Definir tipo padrão remove flag de padrão do tipo anterior (apenas 1 ativo)
- Inativar tipo padrão → obrigatório definir novo tipo padrão antes

---

### RN-RF047-003 — Hierarquia Sem Loops (Acíclica)

**Descrição**: A hierarquia de tipos deve formar um grafo acíclico direcionado (DAG).

**Justificativa**: Prevenir loops infinitos na resolução de herança.

**Critério de Aceite**:
- Tipo A → pai de B → pai de A → rejeição HTTP 400 ("Loop detectado")
- Validação recursiva de ancestrais antes de salvar
- Tipo pode ter no máximo 5 níveis de hierarquia

---

### RN-RF047-004 — Quota -1 = Ilimitado

**Descrição**: O valor -1 em quotas (dados, voz, SMS) significa consumo ilimitado.

**Justificativa**: Permitir tipos sem restrição de consumo (ex: executivos, gerentes).

**Critério de Aceite**:
- Quota = -1 → sem validação de limite
- Quota >= 0 → validação de limite em tempo real
- Quota nula ou ausente → herda do tipo pai (se houver)

---

### RN-RF047-005 — Regras de Auto-Classificação por Prioridade

**Descrição**: Regras de auto-classificação devem ser avaliadas em ordem de prioridade (1 = maior).

**Justificativa**: Permitir controle fino sobre classificação automática.

**Critério de Aceite**:
- Prioridade 1 avaliada primeiro, depois 2, 3, etc.
- Primeira regra que satisfizer → tipo é atribuído e avaliação para
- Se nenhuma regra satisfizer → tipo padrão é atribuído
- Regras suportadas: regex (e-mail, nome), domínio de e-mail, departamento, cargo

---

### RN-RF047-006 — Mudança de Tipo Exige Aprovação (Tipos Críticos)

**Descrição**: Tipos marcados como "críticos" exigem workflow de aprovação para mudança.

**Justificativa**: Proteger tipos sensíveis (ex: executivos, VIPs) de mudanças acidentais.

**Critério de Aceite**:
- Mudança de tipo crítico → cria solicitação pendente (status: `aguardando_aprovacao`)
- Aprovação → mudança aplicada + registro no histórico
- Rejeição → mudança descartada + motivo registrado
- Tipos não-críticos → mudança imediata sem aprovação

---

### RN-RF047-007 — Inativação de Tipo Move Consumidores para Tipo Padrão

**Descrição**: Ao inativar um tipo, todos os consumidores vinculados devem ser migrados automaticamente para o tipo padrão.

**Justificativa**: Evitar consumidores órfãos sem tipo válido.

**Critério de Aceite**:
- Inativação de tipo → trigger de migração em massa
- Todos os consumidores migram para tipo padrão do fornecedor
- Histórico registra migração automática com motivo "Tipo inativado"
- Notificação enviada aos responsáveis pela migração

---

### RN-RF047-008 — Custo Fixo Mensal Somado ao Billing

**Descrição**: O custo fixo mensal do tipo deve ser somado ao billing total do consumidor.

**Justificativa**: Permitir diferenciação de custo por tipo (ex: VIPs pagam mais).

**Critério de Aceite**:
- Custo fixo = R$ 50,00 → somado mensalmente ao billing
- Custo fixo = R$ 0,00 → sem impacto no billing
- Mudança de tipo → custo proporcional ao período (pro-rata)

---

### RN-RF047-009 — Limite de 50 Tipos por Fornecedor

**Descrição**: Cada fornecedor pode cadastrar no máximo 50 tipos de consumidores.

**Justificativa**: Prevenir explosão de tipos e garantir gerenciabilidade.

**Critério de Aceite**:
- Fornecedor com 50 tipos → criação de novo tipo → rejeição HTTP 400 ("Limite excedido")
- Tipos inativos contam para o limite
- Exclusão lógica de tipo não libera vaga (quota permanente)

---

### RN-RF047-010 — Auto-Classificação Apenas em Criação de Consumidor

**Descrição**: Regras de auto-classificação são aplicadas apenas na criação de novos consumidores.

**Justificativa**: Evitar mudanças automáticas inesperadas após onboarding.

**Critério de Aceite**:
- Criação de consumidor → regras avaliadas + tipo atribuído
- Atualização de consumidor → tipo NÃO é reavaliado automaticamente
- Mudança manual de tipo → sempre permitida (respeitando RN006 se crítico)

---

### RN-RF047-011 — Herança de Configurações Resolvida em Runtime

**Descrição**: Configurações ausentes no tipo filho devem ser herdadas do tipo pai em tempo de execução.

**Justificativa**: Evitar duplicação de configurações e facilitar manutenção.

**Critério de Aceite**:
- Tipo filho sem quota definida → herda quota do tipo pai
- Tipo filho sem permissões definidas → herda permissões do tipo pai
- Tipo filho com configuração explícita → sobrescreve herança
- Resolução recursiva até 5 níveis de hierarquia

---

### RN-RF047-012 — Permissões Default Aplicadas em Onboarding

**Descrição**: Permissões default do tipo devem ser aplicadas automaticamente ao criar consumidor.

**Justificativa**: Garantir que consumidor receba permissões corretas desde o início.

**Critério de Aceite**:
- Criação de consumidor → permissões do tipo copiadas para o consumidor
- Mudança de tipo → permissões antigas removidas + permissões do novo tipo aplicadas
- Permissões manuais (fora do tipo) → preservadas

---

### RN-RF047-013 — Dashboard de Custos Agregado por Tipo

**Descrição**: O sistema deve fornecer dashboard com distribuição de consumidores e custos por tipo.

**Justificativa**: Permitir análise gerencial de custos por categoria.

**Critério de Aceite**:
- Dashboard exibe: número de consumidores por tipo, custo total por tipo, percentual do custo total
- Filtros: fornecedor, período (mês, trimestre, ano), tipo específico
- Dados em tempo real (cache de 5 minutos)

---

### RN-RF047-014 — Cores e Ícones para Identificação Visual

**Descrição**: Cada tipo pode ter cor (hex) e ícone (Material Icons) para identificação visual.

**Justificativa**: Facilitar identificação rápida de tipos em dashboards e listagens.

**Critério de Aceite**:
- Cor: formato hexadecimal #RRGGBB (ex: #FF5733)
- Ícone: código Material Icons (ex: `account_circle`, `admin_panel_settings`)
- Valores opcionais (se ausente, usa padrão do sistema)

---

### RN-RF047-015 — Histórico de 7 Anos para Auditoria

**Descrição**: Todas as mudanças de tipo de consumidor devem ser registradas com retenção de 7 anos.

**Justificativa**: Conformidade com LGPD e auditoria de longo prazo.

**Critério de Aceite**:
- Tabela `TipoConsumidorHistorico` registra: consumidor, tipo anterior, tipo novo, data, usuário, motivo
- Retenção: 7 anos (2555 dias)
- Purga automática de registros > 7 anos (job mensal)

---

## 6. ESTADOS DA ENTIDADE

| Estado | Descrição |
|------|-----------|
| `ativo` | Tipo ativo e utilizável para atribuição a consumidores |
| `inativo` | Tipo desativado (consumidores migram para tipo padrão automaticamente) |

### Transições permitidas

| De | Para | Regra |
|---|---|---|
| `ativo` | `inativo` | RN-RF047-007 (migração automática de consumidores) |
| `inativo` | `ativo` | Reativação manual (sem restrições) |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre | Payload |
|------|--------------|---------|
| `TipoConsumidorCriado` | Após criação de tipo | `{ tipoId, codigo, nome, fornecedorId, usuarioCriacaoId }` |
| `TipoConsumidorAtualizado` | Após atualização de tipo | `{ tipoId, camposAlterados, usuarioAlteracaoId }` |
| `TipoConsumidorInativado` | Ao inativar tipo | `{ tipoId, qtdConsumidoresMigrados, tipoDestino }` |
| `TipoConsumidorReativado` | Ao reativar tipo | `{ tipoId, usuarioReativacaoId }` |
| `TipoPadraoAlterado` | Ao definir novo tipo padrão | `{ fornecedorId, tipoAnterior, tipoNovo }` |
| `ConsumidorMudouTipo` | Ao mudar tipo de consumidor | `{ consumidorId, tipoAnterior, tipoNovo, aprovado }` |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant (multi-tenancy)
- Nenhuma regra de negócio pode ser ignorada
- Erros devem ser previsíveis e rastreáveis (códigos HTTP padronizados)
- Auditoria deve registrar quem, quando e o que mudou (tabela `AuditLog`)
- Todas as operações devem respeitar permissões RBAC
- Validações de entrada obrigatórias (FluentValidation no backend)
- Hierarquia de tipos deve ser acíclica (validação recursiva)
- Auto-classificação deve ser determinística (mesma entrada = mesmo tipo)
- Quotas ilimitadas (-1) não devem gerar alertas de limite
- Histórico deve ser imutável (insert-only, sem updates)

---

## 9. SEGURANÇA

- **Validação de entrada**: Todos os payloads validados com FluentValidation
- **Proteção contra injeção**: Queries parametrizadas (Entity Framework)
- **Controle de permissões**: RBAC com matriz Permission → Role → User
- **Isolamento multi-tenant**: Row-Level Security com TenantId
- **Auditoria**: Interceptor automático em todas as entidades (`AuditInterceptor`)
- **Proteção contra loops**: Validação recursiva de hierarquia (máx 5 níveis)
- **Rate limiting**: 100 requisições/minuto por usuário (proteção contra abuso)
- **Proteção contra timing attacks**: Hashing de códigos antes de comparação

---

## 10. INTEGRAÇÕES OBRIGATÓRIAS

### 10.1 Internacionalização (i18n)

- **Chaves de tradução**: `tipos-consumidores.titulo`, `tipos-consumidores.criar`, `tipos-consumidores.editar`, `tipos-consumidores.listar`, `tipos-consumidores.inativar`, `tipos-consumidores.reativar`, `tipos-consumidores.definir-padrao`, `tipos-consumidores.validacao.*`
- **Idiomas obrigatórios**: pt-BR (padrão), en, es
- **Fallback**: pt-BR → en → es
- **Ferramental**: Transloco (frontend), ResourceManager (backend)

### 10.2 Auditoria

- **Tabela**: `AuditLog`
- **Campos registrados**: `EntityName`, `EntityId`, `Action`, `UserId`, `Timestamp`, `Changes`, `IpAddress`
- **Ações auditadas**: Create, Update, Delete, Inactivate, Reactivate, ChangePadrao
- **Retenção**: 7 anos (sincronizado com histórico de mudanças)

### 10.3 Controle de Acesso (RBAC)

| Operação | Permissão |
|-------|---------|
| Criar tipo | `CAD.TIPOS_CONSUMIDORES.CREATE` |
| Atualizar tipo | `CAD.TIPOS_CONSUMIDORES.UPDATE` |
| Visualizar tipo | `CAD.TIPOS_CONSUMIDORES.VIEW` |
| Listar tipos | `CAD.TIPOS_CONSUMIDORES.VIEW_ANY` |
| Inativar tipo | `CAD.TIPOS_CONSUMIDORES.INACTIVATE` |
| Reativar tipo | `CAD.TIPOS_CONSUMIDORES.REACTIVATE` |
| Definir tipo padrão | `CAD.TIPOS_CONSUMIDORES.SET_DEFAULT` |
| Aprovar mudança de tipo | `CAD.TIPOS_CONSUMIDORES.APPROVE_CHANGE` |
| Gerenciar hierarquia | `CAD.TIPOS_CONSUMIDORES.MANAGE_HIERARCHY` |

### 10.4 Central de Funcionalidades

- **Código da Funcionalidade**: `CAD.TIPOS_CONSUMIDORES`
- **Registro Obrigatório**: Ao ativar RF047, registro automático na Central de Funcionalidades
- **Feature Flags**: `tipos-consumidores.auto-classificacao`, `tipos-consumidores.workflow-aprovacao`, `tipos-consumidores.hierarquia`

---

## 11. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF047.md** (Casos de Uso) - OBRIGATÓRIO
- **MD-RF047.md** (Modelo de Dados) - OBRIGATÓRIO
- **WF-RF047.md** (Workflows) - OBRIGATÓRIO
- **TC-RF047-BACKEND.md** (Casos de Teste Backend) - OBRIGATÓRIO
- **TC-RF047-FRONTEND.md** (Casos de Teste Frontend) - OBRIGATÓRIO
- **TC-RF047-SEGURANCA.md** (Casos de Teste Segurança) - OBRIGATÓRIO
- **TC-RF047-E2E.md** (Casos de Teste E2E) - OBRIGATÓRIO
- **MT-RF047.yaml** (Massa de Teste) - OBRIGATÓRIO

---

## 12. RASTREABILIDADE

| Artefato | Status | Caminho |
|--------|-------|---------|
| RF047.md | ✅ Criado | `docs/documentacao/Fase-2/.../RF047/RF047.md` |
| RF047.yaml | ⏳ Pendente | `docs/documentacao/Fase-2/.../RF047/RF047.yaml` |
| UC-RF047.md | ✅ Criado | `docs/documentacao/Fase-2/.../RF047/UC-RF047.md` |
| MD-RF047.md | ✅ Criado | `docs/documentacao/Fase-2/.../RF047/MD-RF047.md` |
| WF-RF047.md | ✅ Criado | `docs/documentacao/Fase-2/.../RF047/WF-RF047.md` |
| RL-RF047.md | ⏳ Pendente | `docs/documentacao/Fase-2/.../RF047/RL-RF047.md` |
| RL-RF047.yaml | ⏳ Pendente | `docs/documentacao/Fase-2/.../RF047/RL-RF047.yaml` |

---

## 13. DEPENDÊNCIAS

### Dependências de RFs

- **RF-001** (Parâmetros e Configurações) - Multi-tenancy e auditoria
- **RF-022** (Gestão de Fornecedores) - Relacionamento FornecedorId
- **RF-048** (Gestão de Consumidores) - Atribuição de tipos a consumidores

### Dependências de Infraestrutura

- Entity Framework Core 10 (backend)
- Angular 19 + Transloco (frontend)
- SQLite (dev) / SQL Server (prod)
- Hangfire (jobs de migração e purga)

---

## 14. CHANGELOG

| Versão | Data | Descrição | Autor |
|------|------|----------|------|
| 1.0 | 2025-12-27 | Versão inicial com 5 seções (misturado RF + RL) | Agência ALC - alc.dev.br |
| 2.0 | 2025-12-30 | Separação RF/RL completa, 14 seções, 15 regras de negócio | Agência ALC - alc.dev.br |

---

**FIM DO DOCUMENTO - RF-047 v2.0**
