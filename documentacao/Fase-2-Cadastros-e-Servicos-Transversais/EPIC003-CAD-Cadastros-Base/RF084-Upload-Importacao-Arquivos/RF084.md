# RF084: Upload e Importação de Arquivos

**Versão**: 2.0
**Data**: 2025-12-31
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC003-CAD-Cadastros-Base
**Fase**: Fase 2 - Cadastros e Serviços Transversais

---

## 1. OBJETIVO DO REQUISITO

Prover um serviço seguro e escalável de upload e importação de arquivos em diversos formatos (CSV, Excel, XML, JSON) com validação prévia, processamento assíncrono e auditoria completa. Este requisito serve como infraestrutura transversal para todos os módulos que necessitam carga de dados em massa.

O sistema deve garantir:
- Segurança através de validação de tipo MIME e scan antivírus
- Escalabilidade via processamento assíncrono para arquivos grandes
- Rastreabilidade completa com auditoria de todas operações
- Feedback ao usuário através de preview e progresso em tempo real
- Integridade transacional com rollback automático em caso de falha

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Upload de arquivos em chunks retomáveis (até 500MB)
- [x] Validação de tipo MIME (whitelist: CSV, Excel, XML, JSON)
- [x] Scan antivírus obrigatório (ClamAV) antes do processamento
- [x] Armazenamento seguro encriptado (Azure Blob Storage)
- [x] Validação de estrutura (schema: colunas obrigatórias, tipos de dados)
- [x] Preview de dados (primeiras 100 linhas com erros mapeados)
- [x] Processamento assíncrono com Hangfire para arquivos > 10MB
- [x] Progresso em tempo real via SignalR
- [x] Importação transacional com rollback automático
- [x] Relatórios detalhados de erros
- [x] Controle de acesso RBAC
- [x] Isolamento multi-tenant
- [x] Auditoria completa (7 anos de retenção)

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (responsabilidade do frontend)
- Transformação de dados (ETL complexo)
- Conversão entre formatos de arquivo
- Agendamento de importações recorrentes (será RF separado)
- Integração direta com sistemas externos (cada integração é RF próprio)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Upload** | Transferência de arquivo do cliente para o servidor |
| **Chunk** | Fragmento de arquivo (5-10MB) enviado separadamente |
| **Preview** | Visualização prévia dos primeiros 100 registros com validações |
| **Importação** | Processamento final que insere dados no banco |
| **Session** | Contexto de upload identificado por sessionId único |
| **Scan Antivírus** | Validação de segurança via ClamAV |
| **Schema** | Definição de estrutura esperada (colunas, tipos, obrigatoriedade) |
| **Rollback** | Desfazer importação completa em caso de erro |
| **Processamento Assíncrono** | Execução em background job (Hangfire) |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Iniciar Upload**: Criar sessão de upload e receber sessionId
2. **Enviar Chunks**: Transferir fragmentos do arquivo com tracking de progresso
3. **Validar Tipo MIME**: Verificar se arquivo está na whitelist permitida
4. **Scan Antivírus**: Executar ClamAV para detectar malware
5. **Validar Schema**: Verificar estrutura do arquivo (colunas e tipos)
6. **Gerar Preview**: Exibir primeiras 100 linhas com erros identificados
7. **Confirmar Importação**: Processar dados validados
8. **Processar Assincronamente**: Executar importação em background (> 10MB)
9. **Notificar Progresso**: Enviar atualizações em tempo real via SignalR
10. **Executar Rollback**: Desfazer importação em caso de erro
11. **Gerar Relatório de Erros**: Listar linhas com falhas e motivos
12. **Listar Histórico**: Consultar importações anteriores
13. **Excluir Upload**: Remover arquivo do storage

---

## 5. REGRAS DE NEGÓCIO

### RN-RF084-001: Limite de Tamanho de Arquivo

**Descrição**: Arquivos maiores que 500MB devem ser rejeitados.

**Justificativa**: Proteção contra esgotamento de recursos e ataques DoS.

**Critério de Aceite**:
- Arquivo com 500MB ou menos → Aceito
- Arquivo com mais de 500MB → Rejeitado com erro HTTP 413 (Payload Too Large)
- Mensagem de erro: "Arquivo excede o limite de 500MB (tamanho: {tamanho}MB)"

---

### RN-RF084-002: Whitelist de Tipos MIME

**Descrição**: Apenas tipos MIME permitidos podem ser enviados.

**Tipos Permitidos**:
- `text/csv`
- `text/plain` (CSV alternativo)
- `application/vnd.ms-excel` (XLS)
- `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet` (XLSX)
- `application/xml`
- `text/xml`
- `application/json`

**Critério de Aceite**:
- Tipo MIME na whitelist → Aceito
- Tipo MIME fora da whitelist → Rejeitado com erro HTTP 415 (Unsupported Media Type)
- Validação case-insensitive

---

### RN-RF084-003: Validação de Extensão Consistente

**Descrição**: Extensão do arquivo deve corresponder ao tipo MIME declarado.

**Mapeamento Permitido**:
| MIME Type | Extensões Válidas |
|-----------|-------------------|
| text/csv, text/plain | .csv, .txt |
| application/vnd.ms-excel | .xls |
| application/vnd.openxmlformats-officedocument.spreadsheetml.sheet | .xlsx |
| application/xml, text/xml | .xml |
| application/json | .json |

**Critério de Aceite**:
- Extensão compatível com MIME Type → Aceito
- Extensão incompatível → Rejeitado com erro HTTP 400 (Bad Request)
- Mensagem: "Extensão {ext} incompatível com tipo MIME {mime}"

---

### RN-RF084-004: Scan Antivírus Obrigatório

**Descrição**: Todo arquivo deve ser escaneado por ClamAV antes do processamento.

**Critério de Aceite**:
- Scan retorna "Safe" → Prosseguir com upload
- Scan detecta ameaça → Rejeitar arquivo, auditar evento, retornar HTTP 400
- ClamAV indisponível → Bloquear upload, retornar HTTP 503 (Service Unavailable)
- Mensagem de ameaça: "Arquivo contém malware: {ameaça detectada}"

---

### RN-RF084-005: Separação Upload e Importação

**Descrição**: Upload e importação são operações distintas e sequenciais.

**Fluxo Obrigatório**:
1. Cliente faz upload → Recebe uploadId
2. Cliente solicita validação/preview → Recebe resultado
3. Cliente confirma importação → Processamento inicia

**Critério de Aceite**:
- Não é possível confirmar importação sem preview prévio
- Preview pode ser gerado múltiplas vezes
- Importação só ocorre mediante confirmação explícita

---

### RN-RF084-006: Validação de Schema Obrigatória

**Descrição**: Arquivo deve conter todas colunas obrigatórias definidas no schema do tipo de importação.

**Validações de Schema**:
- Colunas obrigatórias presentes
- Tipos de dados compatíveis (int, string, datetime, decimal)
- Headers únicos (sem duplicação de colunas)
- Nomes de colunas conforme esperado (case-insensitive)

**Critério de Aceite**:
- Schema válido → Preview gerado
- Coluna obrigatória faltando → Erro HTTP 400 com lista de colunas ausentes
- Tipo incompatível → Erro HTTP 400 com coluna e tipo esperado

---

### RN-RF084-007: Validação de Dados por Linha

**Descrição**: Cada linha do arquivo deve ser validada contra regras de negócio específicas do tipo de importação.

**Validações Aplicadas**:
- Campos obrigatórios não podem ser vazios
- Valores numéricos dentro de ranges permitidos
- Formatos de data válidos
- Foreign Keys existentes no banco
- Unicidade conforme regras do domínio

**Critério de Aceite**:
- Todas linhas válidas → Preview mostra 100% sucesso
- Linhas com erro → Preview lista linha, coluna, erro específico
- Erros não bloqueiam preview (apenas importação final)

---

### RN-RF084-008: Processamento Assíncrono Automático

**Descrição**: Arquivos maiores que 10MB são processados em background job (Hangfire).

**Critério de Aceite**:
- Arquivo ≤ 10MB → Processamento síncrono, resposta HTTP 200
- Arquivo > 10MB → Job enfileirado, resposta HTTP 202 Accepted com jobId
- Cliente pode consultar status do job via endpoint específico

---

### RN-RF084-009: Progresso em Tempo Real

**Descrição**: Durante validação e importação, cliente recebe atualizações de progresso via SignalR.

**Eventos Notificados**:
- `upload.progress` → Percentual de chunks recebidos
- `validation.progress` → Linhas validadas
- `import.progress` → Linhas processadas
- `import.completed` → Importação finalizada (sucesso ou erro)

**Critério de Aceite**:
- Cliente conectado recebe notificações em tempo real
- Notificações incluem: uploadId, operação, percentual, contadores
- Notificações enviadas a cada 5% de progresso ou 1000 linhas processadas

---

### RN-RF084-010: Rollback Transacional

**Descrição**: Importação executa em transação SQL única. Qualquer erro causa rollback completo.

**Critério de Aceite**:
- Todas linhas processadas com sucesso → COMMIT da transação
- Uma ou mais linhas com erro → ROLLBACK completo
- Nenhum dado parcial inserido no banco
- Relatório de erro gerado com todas linhas falhadas
- Auditoria registra tentativa e motivo do rollback

---

### RN-RF084-011: Isolamento Multi-Tenant

**Descrição**: Upload e importação respeitam isolamento de tenant.

**Critério de Aceite**:
- Todos registros importados recebem TenantId do usuário autenticado
- Consultas de histórico retornam apenas uploads do tenant atual
- Tentativa de acessar uploadId de outro tenant → HTTP 403 Forbidden

---

### RN-RF084-012: Auditoria Completa

**Descrição**: Todas operações de upload e importação são auditadas.

**Operações Auditadas**:
- Upload iniciado (metadata do arquivo)
- Upload concluído (hash, chunks recebidos)
- Scan antivírus (resultado)
- Preview gerado (contadores de sucesso/erro)
- Importação iniciada (tipo, total linhas)
- Importação concluída (sucesso, falha, rollback)
- Arquivo excluído (motivo)

**Critério de Aceite**:
- Auditoria inclui: UserId, TenantId, Timestamp, IP, dados da operação
- Retenção de 7 anos (conformidade LGPD)
- Logs estruturados e consultáveis

---

## 6. ESTADOS DA ENTIDADE

### Estados de Upload

| Estado | Descrição |
|--------|-----------|
| `uploading` | Chunks sendo recebidos |
| `uploaded` | Todos chunks recebidos, arquivo montado |
| `validating` | Scan antivírus e validação de schema em progresso |
| `validated` | Arquivo validado, preview disponível |
| `importing` | Processamento de importação em execução |
| `completed` | Importação concluída com sucesso |
| `failed` | Importação falhou (com rollback) |
| `cancelled` | Upload cancelado pelo usuário |
| `deleted` | Arquivo removido do storage |

### Transições Permitidas

| De | Para |
|----|------|
| uploading | uploaded |
| uploaded | validating |
| validating | validated |
| validating | failed (scan detectou malware) |
| validated | importing |
| importing | completed |
| importing | failed |
| uploading, uploaded, validated | cancelled |
| completed, failed | deleted |

---

## 7. PERMISSÕES RBAC

| Permissão | Descrição | Perfis Autorizados |
|-----------|-----------|-------------------|
| `uploads.file.upload` | Fazer upload de arquivo | Analista, Gerente, Admin |
| `uploads.file.preview` | Visualizar preview antes de importar | Analista, Gerente, Admin |
| `uploads.file.import` | Confirmar e processar importação | Gerente, Admin |
| `uploads.file.retry` | Reprocessar importação falhada | Gerente, Admin |
| `uploads.file.delete` | Excluir arquivo de upload | Admin |
| `uploads.history.read` | Visualizar histórico de importações | Analista, Gerente, Admin |
| `uploads.errors.download` | Baixar relatório de erros | Analista, Gerente, Admin |
| `uploads.config.manage` | Configurar tipos de importação e schemas | Admin |

---

## 8. API ENDPOINTS

### 8.1 Gerenciamento de Upload

| Método | Endpoint | Descrição | Permissão | Status |
|--------|----------|-----------|-----------|--------|
| POST | `/api/uploads` | Iniciar upload (retorna sessionId) | `uploads.file.upload` | 201 |
| POST | `/api/uploads/{sessionId}/chunks` | Enviar chunk do arquivo | `uploads.file.upload` | 202 |
| GET | `/api/uploads/{uploadId}` | Obter metadados do upload | `uploads.history.read` | 200 |
| GET | `/api/uploads` | Listar uploads (paginado) | `uploads.history.read` | 200 |
| DELETE | `/api/uploads/{uploadId}` | Excluir upload | `uploads.file.delete` | 204 |

### 8.2 Validação e Preview

| Método | Endpoint | Descrição | Permissão | Status |
|--------|----------|-----------|-----------|--------|
| POST | `/api/uploads/{uploadId}/validate` | Validar estrutura (schema + antivírus) | `uploads.file.preview` | 200 |
| GET | `/api/uploads/{uploadId}/preview` | Obter preview (primeiras 100 linhas) | `uploads.file.preview` | 200 |
| GET | `/api/uploads/{uploadId}/errors` | Listar linhas com erro do preview | `uploads.file.preview` | 200 |

### 8.3 Importação e Processamento

| Método | Endpoint | Descrição | Permissão | Status |
|--------|----------|-----------|-----------|--------|
| POST | `/api/uploads/{uploadId}/import` | Confirmar e iniciar importação | `uploads.file.import` | 202 |
| GET | `/api/uploads/{uploadId}/status` | Obter status da importação | `uploads.history.read` | 200 |
| POST | `/api/uploads/{uploadId}/retry` | Reprocessar importação falhada | `uploads.file.retry` | 202 |
| GET | `/api/uploads/{uploadId}/report` | Baixar relatório de erros (JSON/CSV) | `uploads.errors.download` | 200 |

### 8.4 Configuração (Admin)

| Método | Endpoint | Descrição | Permissão | Status |
|--------|----------|-----------|-----------|--------|
| GET | `/api/uploads/config/types` | Listar tipos de importação disponíveis | `uploads.config.manage` | 200 |
| GET | `/api/uploads/config/types/{type}/schema` | Obter schema de um tipo | `uploads.config.manage` | 200 |
| PUT | `/api/uploads/config/types/{type}/schema` | Atualizar schema de um tipo | `uploads.config.manage` | 200 |

---

## 9. MODELO DE DADOS

Ver documento: **MD-RF084-Upload-Importacao-Arquivos.md**

### Principais Entidades

- **Upload**: Metadados do upload (sessionId, fileName, fileSize, mimeType, status)
- **UploadChunk**: Fragmentos recebidos (chunkIndex, data, hash)
- **ImportJob**: Job de processamento assíncrono (jobId, status, progress)
- **ImportError**: Erros de importação (linha, coluna, mensagem)
- **ImportSchema**: Definição de estrutura por tipo de importação

---

## 10. DEPENDÊNCIAS

### Dependências Upstream (RF que este requisito precisa)

- **RF001**: Autenticação e Autorização (RBAC)
- **RF002**: Multi-tenancy (isolamento de dados)
- **RF003**: Auditoria (registro de operações)

### Dependências Downstream (RF que dependem deste)

- **RF085**: Importação de Dados Específicos (Ativos, Contratos, Faturas)
- **RF086**: Migração de Dados Legado
- **RF087**: Integração com ERPs

### Dependências Externas

- **ClamAV**: Antivírus daemon (porta 3310)
- **Azure Blob Storage**: Armazenamento de arquivos
- **Hangfire**: Processamento assíncrono

---

## 11. INTEGRAÇÕES OBRIGATÓRIAS

### 11.1 Internacionalização (i18n)

**Chaves de Tradução** (pt-BR, en-US, es-ES):
- `uploads.title`
- `uploads.subtitle`
- `uploads.form.*` (selectFile, importType, dragAndDrop, etc.)
- `uploads.messages.*` (uploadSuccess, uploadError, fileTooBig, etc.)
- `uploads.validation.*` (fileRequired, missingColumns, invalidDataType, etc.)
- `uploads.preview.*` (title, totalLines, errorLines, etc.)
- `uploads.progress.*` (uploading, validating, scanning, processing, etc.)
- `uploads.history.*` (title, columns, viewDetails, etc.)

### 11.2 Auditoria

**Tabela**: `AuditLog`
**Operações Registradas**:
- `UPLOADS_UPLOAD_START`, `UPLOADS_UPLOAD_COMPLETE`
- `UPLOADS_ANTIVIRUS_SCAN`
- `UPLOADS_PREVIEW_GENERATED`
- `UPLOADS_IMPORT_START`, `UPLOADS_IMPORT_COMPLETE`, `UPLOADS_IMPORT_ERROR`
- `UPLOADS_FILE_DELETE`
- `UPLOADS_ERROR_REPORT_DOWNLOAD`

**Retenção**: 7 anos

### 11.3 Controle de Acesso (RBAC)

**Policy-Based Authorization**:
- Todas permissões listadas na seção 7 devem estar registradas
- Matriz de roles vs permissões deve ser configurada
- Validação em endpoint via `[Authorize(Policy = "...")]`

### 11.4 Central de Funcionalidades

**FeatureKey**: `UPLOADS_IMPORT`
**Configurações**:
```json
{
  "maxFileSize": 524288000,
  "enableClamAV": true,
  "enableSignalR": true,
  "chunkSizeBytes": 5242880,
  "maxConcurrentChunks": 3
}
```

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-31 | Migração v1.0 → v2.0: Separação RF/RL, 11 seções, remoção de legado | Agência ALC - alc.dev.br |
| 1.0 | 2025-12-28 | Versão inicial com 10 RN, integrações, endpoints e segurança | Claude Code |

---

**Última Atualização**: 2025-12-31
**Versão Governança**: 2.0
**Status**: Pronto para criação de UC/MD/WF
