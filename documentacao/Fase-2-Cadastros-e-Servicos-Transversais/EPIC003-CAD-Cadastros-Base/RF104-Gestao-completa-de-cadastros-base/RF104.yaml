# =============================================
# RF-104 - Gestão Completa de Cadastros Base (Domínios Configuráveis)
# Versão: 2.0
# Data: 2025-12-31
# Autor: Agência ALC - alc.dev.br
# =============================================

rf:
  id: "RF104"
  nome: "Gestão Completa de Cadastros Base (Domínios Configuráveis)"
  versao: "2.0"
  data: "2025-12-31"
  fase: "Fase 2 - Cadastros e Serviços Transversais"
  epic: "EPIC003-CAD-Cadastros-Base"
  status: "em_desenvolvimento" # draft | aprovado | em_desenvolvimento | concluido

descricao:
  objetivo: "Fornecer um framework genérico e centralizado para gerenciamento de domínios configuráveis (tabelas de referência com listas controladas de valores) no sistema IControlIT, garantindo integridade referencial, auditoria completa, suporte a multi-tenancy e operações em lote (importação/exportação), sem necessidade de alteração de código para novos domínios."
  problema_resolvido: "Elimina a necessidade de criar código customizado para cada lista de valores (domínio), centralizando em API genérica reutilizável. Resolve duplicação de domínios, falta de integridade referencial e dificuldade de manutenção de valores."
  publico_afetado: "Administradores do sistema, desenvolvedores, usuários finais que utilizam dropdowns e listas de valores em toda a aplicação."

escopo:
  incluso:
    - "Criação, visualização, edição e exclusão lógica de domínios"
    - "Criação, visualização, edição e exclusão lógica de itens de domínio"
    - "Validação de integridade referencial (bloquear exclusão se houver FK)"
    - "Importação em lote via CSV/Excel com preview e validação"
    - "Exportação de domínios em CSV/Excel"
    - "Suporte a estruturas hierárquicas (pai-filho) em domínios"
    - "Reordenação de itens para controle de ordem de exibição"
    - "Ativação/desativação de itens (soft delete)"
    - "Metadados customizados via JSON por item"
    - "Auditoria completa de operações"
    - "Controle de acesso RBAC por operação"
    - "Isolamento multi-tenant"
  fora:
    - "Interface visual específica (layout, UX, identidade visual)"
    - "Tecnologia, framework ou linguagem de implementação"
    - "Estratégia de deploy ou infraestrutura"
    - "Sincronização automática com sistemas externos (SAP, ServiceNow) - será RF separado"
    - "Relatórios de uso/frequência/obsolescência - será RF separado"

entidades:
  - nome: "Dominio"
    descricao: "Entidade principal que representa um domínio configurável (ex: Status_Ativo, Prioridade)"
    multi_tenant: true
    soft_delete: true
    auditoria: true
    campos_obrigatorios:
      - "Nome"
      - "Descricao"
      - "Tipo"
      - "ClienteId"

  - nome: "ItemDominio"
    descricao: "Itens individuais de cada domínio (ex: 'ATI' = 'Ativo' no domínio Status_Ativo)"
    multi_tenant: true
    soft_delete: true
    auditoria: true
    campos_obrigatorios:
      - "DominioId"
      - "Codigo"
      - "Descricao"
      - "Ordem"

regras_negocio:
  - id: "RN-CAD-104-01"
    descricao: "Domínio Requer Nome Único e Descrição - Todo domínio deve ter nome único (case-insensitive), descrição clara e tipo (Lista, Hierarquia)"
    tipo: "unicidade"
    campos_afetados: ["Nome", "Descricao", "Tipo"]
    obrigatorio: true
    criterio_aceite:
      - "Nome de domínio ausente → rejeição (HTTP 400)"
      - "Nome duplicado (case-insensitive) → rejeição (HTTP 409)"
      - "Descrição ausente → rejeição (HTTP 400)"
      - "Tipo inválido → rejeição (HTTP 400)"

  - id: "RN-CAD-104-02"
    descricao: "Item de Domínio Requer Código Único dentro do Domínio - Cada item dentro de um domínio deve ter código único alfanumérico"
    tipo: "unicidade"
    campos_afetados: ["DominioId", "Codigo"]
    obrigatorio: true
    criterio_aceite:
      - "Código ausente → rejeição (HTTP 400)"
      - "Código duplicado no mesmo domínio → rejeição (HTTP 409)"
      - "Código com caracteres inválidos (não alfanuméricos) → rejeição (HTTP 400)"
      - "Código vazio ou apenas espaços → rejeição (HTTP 400)"

  - id: "RN-CAD-104-03"
    descricao: "Exclusão de Item Requer Validação de Integridade Referencial - Sistema valida se há registros referenciando o item via FK antes de exclusão física"
    tipo: "regra_negocio"
    campos_afetados: ["Id"]
    obrigatorio: true
    criterio_aceite:
      - "Tentativa de exclusão com FK existente → bloqueio (HTTP 409)"
      - "Mensagem deve indicar quantidade de registros referenciando"
      - "Soft delete (desativação) deve ser sempre permitido"
      - "Exclusão física permitida apenas se contador de FK = 0"

  - id: "RN-CAD-104-04"
    descricao: "Item Pode Ser Marcado como Inativo Sem Ser Deletado - Items deletados logicamente não são removidos fisicamente; marcados com Ativo=false"
    tipo: "regra_negocio"
    campos_afetados: ["Ativo"]
    obrigatorio: true
    criterio_aceite:
      - "Exclusão lógica (soft delete) marca Ativo=false"
      - "Listagens padrão excluem inativos"
      - "Filtro incluirInativos=true deve exibir todos"
      - "Dropdowns padrão exibem apenas itens ativos"

  - id: "RN-CAD-104-05"
    descricao: "Domínios Podem Ter Estrutura Hierárquica (Pai-Filho) - Campo IdItemPai permite relação 1:N. Sistema valida ciclos"
    tipo: "regra_negocio"
    campos_afetados: ["IdItemPai"]
    obrigatorio: false
    criterio_aceite:
      - "Campo IdItemPai nullable"
      - "FK para mesmo domínio"
      - "Validação de ciclos (item não pode ser pai de si mesmo)"
      - "Tentativa de criar ciclo → bloqueio (HTTP 400)"

  - id: "RN-CAD-104-06"
    descricao: "Importação em Lote com Preview e Validação - Upload CSV/Excel com valores do domínio. Sistema oferece preview, valida dados e aplica atomicamente"
    tipo: "regra_negocio"
    campos_afetados: ["*"]
    obrigatorio: true
    criterio_aceite:
      - "Upload com erros de schema → bloqueio com lista de erros"
      - "Upload com duplicatas → bloqueio ou skip (conforme configuração)"
      - "Preview exibe quantidade de inserções/atualizações"
      - "Aplicação via transação ACID"
      - "Falha em qualquer item → rollback total"

  - id: "RN-CAD-104-07"
    descricao: "Auditoria Registra Todas Alterações de Domínios - Toda operação auditada com usuário, timestamp, antes/depois"
    tipo: "seguranca"
    campos_afetados: ["Created", "CreatedBy", "LastModified", "LastModifiedBy"]
    obrigatorio: true
    criterio_aceite:
      - "Campos de auditoria obrigatórios preenchidos automaticamente"
      - "Log de auditoria com operação (CREATE/UPDATE/DELETE), entidade, ID, diff antes/depois"
      - "Auditoria automática via interceptor ou trigger de domínio"
      - "Dados de auditoria imutáveis"

  - id: "RN-CAD-104-08"
    descricao: "Exportação Permite Download em CSV ou Excel - Usuários podem exportar qualquer domínio em formato CSV ou Excel"
    tipo: "regra_negocio"
    campos_afetados: ["*"]
    obrigatorio: true
    criterio_aceite:
      - "Exportação CSV com encoding UTF-8 com BOM"
      - "Exportação Excel via biblioteca adequada (EPPlus ou similar)"
      - "Arquivo gerado com nome padrão: {NomeDominio}_{YYYYMMDD}.csv ou .xlsx"
      - "Headers obrigatórios: Código, Descrição, Ativo, Ordem, MetadadosJson"

  - id: "RN-CAD-104-09"
    descricao: "Domínios Suportam Atributos Customizados (Metadados) - Cada item pode ter JSON customizado de metadados"
    tipo: "validacao"
    campos_afetados: ["MetadadosJson"]
    obrigatorio: false
    criterio_aceite:
      - "Campo MetadadosJson aceita JSON válido ou null"
      - "Tentativa de inserir JSON inválido → bloqueio (HTTP 400)"
      - "Metadados não afetam comportamento funcional (são apenas informativos)"
      - "Frontend pode consumir metadados para customizar exibição"

  - id: "RN-CAD-104-10"
    descricao: "Reordenação de Itens Define Ordem de Exibição - Campo Ordem define sequência de exibição em dropdowns"
    tipo: "regra_negocio"
    campos_afetados: ["Ordem"]
    obrigatorio: true
    criterio_aceite:
      - "Campo Ordem obrigatório (default: valor atual + 1)"
      - "Reordenação atualiza múltiplos itens atomicamente"
      - "Listagens padrão ordenam por campo Ordem ASC"

estados:
  dominio:
    - id: "ativo"
      descricao: "Domínio ativo, pode ser usado em dropdowns e operações"
    - id: "inativo"
      descricao: "Domínio desativado, não exibido em dropdowns (mas dados históricos preservados)"

  item_dominio:
    - id: "ativo"
      descricao: "Item ativo, exibido em dropdowns"
    - id: "inativo"
      descricao: "Item desativado, não exibido em dropdowns (soft delete)"

transicoes:
  permitidas:
    - entidade: "Dominio"
      de: "ativo"
      para: "inativo"
    - entidade: "Dominio"
      de: "inativo"
      para: "ativo"
    - entidade: "ItemDominio"
      de: "ativo"
      para: "inativo"
    - entidade: "ItemDominio"
      de: "inativo"
      para: "ativo"
  proibidas: []

eventos_dominio:
  - evento: "dominio.criado"
    descricao: "Após criação de domínio"
  - evento: "dominio.atualizado"
    descricao: "Após atualização de propriedades do domínio"
  - evento: "dominio.excluido"
    descricao: "Após exclusão do domínio"
  - evento: "item.criado"
    descricao: "Após criação de item"
  - evento: "item.atualizado"
    descricao: "Após atualização de item"
  - evento: "item.excluido"
    descricao: "Após exclusão (lógica ou física) de item"
  - evento: "itens.importados"
    descricao: "Após importação em lote bem-sucedida"
  - evento: "itens.exportados"
    descricao: "Após exportação de itens"
  - evento: "itens.reordenados"
    descricao: "Após reordenação de itens"

permissoes:
  - codigo: "CAD.DOMINIO.VIEW_ANY"
    descricao: "Listar domínios"
    roles: ["Todos autenticados"]
  - codigo: "CAD.DOMINIO.VIEW"
    descricao: "Visualizar domínio específico"
    roles: ["Todos autenticados"]
  - codigo: "CAD.DOMINIO.CREATE"
    descricao: "Criar domínio"
    roles: ["Admin"]
  - codigo: "CAD.DOMINIO.UPDATE"
    descricao: "Editar domínio"
    roles: ["Admin"]
  - codigo: "CAD.DOMINIO.DELETE"
    descricao: "Excluir domínio"
    roles: ["Admin"]
  - codigo: "CAD.ITEM.VIEW_ANY"
    descricao: "Listar itens de domínio"
    roles: ["Todos autenticados"]
  - codigo: "CAD.ITEM.VIEW"
    descricao: "Visualizar item específico"
    roles: ["Todos autenticados"]
  - codigo: "CAD.ITEM.CREATE"
    descricao: "Criar item em domínio"
    roles: ["Admin", "Gestor"]
  - codigo: "CAD.ITEM.UPDATE"
    descricao: "Editar item"
    roles: ["Admin", "Gestor"]
  - codigo: "CAD.ITEM.DELETE"
    descricao: "Deletar item"
    roles: ["Admin"]
  - codigo: "CAD.ITEM.REORDER"
    descricao: "Reordenar itens"
    roles: ["Admin", "Gestor"]
  - codigo: "CAD.IMPORTACAO.EXECUTE"
    descricao: "Importar em lote"
    roles: ["Admin"]
  - codigo: "CAD.EXPORTACAO.EXECUTE"
    descricao: "Exportar domínios"
    roles: ["Admin", "Gestor"]

endpoints:
  - method: "GET"
    route: "/api/dominios"
    descricao: "Listar domínios com paginação"
    autenticacao: true
    authorization_policy: "CAD.DOMINIO.VIEW_ANY"
    request_dto: "Query: page, pageSize"
    response_dto: "PaginatedList<DominioDto>"

  - method: "GET"
    route: "/api/dominios/{nome}"
    descricao: "Obter domínio específico"
    autenticacao: true
    authorization_policy: "CAD.DOMINIO.VIEW"
    request_dto: null
    response_dto: "DominioDto"

  - method: "POST"
    route: "/api/dominios"
    descricao: "Criar novo domínio"
    autenticacao: true
    authorization_policy: "CAD.DOMINIO.CREATE"
    request_dto: "CreateDominioCommand"
    response_dto: "Guid"

  - method: "PUT"
    route: "/api/dominios/{nome}"
    descricao: "Atualizar domínio existente"
    autenticacao: true
    authorization_policy: "CAD.DOMINIO.UPDATE"
    request_dto: "UpdateDominioCommand"
    response_dto: "void"

  - method: "DELETE"
    route: "/api/dominios/{nome}"
    descricao: "Excluir domínio"
    autenticacao: true
    authorization_policy: "CAD.DOMINIO.DELETE"
    request_dto: null
    response_dto: "void"

  - method: "GET"
    route: "/api/dominios/{nome}/itens"
    descricao: "Listar itens de um domínio"
    autenticacao: true
    authorization_policy: "CAD.ITEM.VIEW_ANY"
    request_dto: "Query: incluirInativos"
    response_dto: "List<ItemDominioDto>"

  - method: "GET"
    route: "/api/dominios/{nome}/itens/{codigo}"
    descricao: "Obter item específico"
    autenticacao: true
    authorization_policy: "CAD.ITEM.VIEW"
    request_dto: null
    response_dto: "ItemDominioDto"

  - method: "POST"
    route: "/api/dominios/{nome}/itens"
    descricao: "Criar novo item em domínio"
    autenticacao: true
    authorization_policy: "CAD.ITEM.CREATE"
    request_dto: "CreateItemDominioCommand"
    response_dto: "Guid"

  - method: "PUT"
    route: "/api/dominios/{nome}/itens/{codigo}"
    descricao: "Editar item de domínio"
    autenticacao: true
    authorization_policy: "CAD.ITEM.UPDATE"
    request_dto: "UpdateItemDominioCommand"
    response_dto: "void"

  - method: "DELETE"
    route: "/api/dominios/{nome}/itens/{codigo}"
    descricao: "Deletar item (lógico ou físico)"
    autenticacao: true
    authorization_policy: "CAD.ITEM.DELETE"
    request_dto: "Query: softDelete"
    response_dto: "void"

  - method: "PUT"
    route: "/api/dominios/{nome}/itens/reordenar"
    descricao: "Reordenar itens de domínio"
    autenticacao: true
    authorization_policy: "CAD.ITEM.REORDER"
    request_dto: "ReordenarItensCommand"
    response_dto: "void"

  - method: "POST"
    route: "/api/dominios/{nome}/importar"
    descricao: "Importar itens em lote via CSV/Excel"
    autenticacao: true
    authorization_policy: "CAD.IMPORTACAO.EXECUTE"
    request_dto: "File + options"
    response_dto: "ImportResultDto"

  - method: "GET"
    route: "/api/dominios/{nome}/exportar"
    descricao: "Exportar itens de domínio em CSV/Excel"
    autenticacao: true
    authorization_policy: "CAD.EXPORTACAO.EXECUTE"
    request_dto: "Query: formato"
    response_dto: "File"

integracoes:
  internas:
    - "Autenticação (JWT Bearer Token)"
    - "Multi-Tenancy (ClienteId)"
    - "Auditoria (Interceptor automático)"
    - "Central de Funcionalidades (GESTAO_DOMINIOS_CADASTROS)"
  externas: []

i18n:
  chaves_obrigatorias:
    - "dominios.titulo"
    - "dominios.descricao"
    - "dominios.campo_nome"
    - "dominios.campo_descricao"
    - "dominios.campo_tipo"
    - "dominios.tipo_lista"
    - "dominios.tipo_hierarquia"
    - "dominios.botao_novo"
    - "dominios.botao_importar"
    - "dominios.botao_exportar"
    - "item_dominio.titulo"
    - "item_dominio.campo_codigo"
    - "item_dominio.campo_descricao"
    - "item_dominio.campo_ativo"
    - "item_dominio.campo_ordem"
    - "item_dominio.botao_novo"
    - "item_dominio.botao_reordenar"
    - "item_dominio.erro_delecao_fk"
    - "importacao.erro_schema"
    - "importacao.sucesso"
  idiomas_suportados:
    - "pt-BR"
    - "en"
    - "es"

seguranca:
  isolamento_tenant: true
  auditoria_obrigatoria: true
  soft_delete: true
  validacoes:
    - "Validação de entrada (schema, tipos, ranges)"
    - "Proteção contra injeção (SQL, JSON)"
    - "Validação de JSON em campo MetadadosJson"
    - "Validação de unicidade de códigos e nomes"
    - "Rate limiting em importações"
    - "Validação de tamanho de arquivo (max 10MB para CSV/Excel)"
    - "Validação de ciclos em hierarquias"
    - "Validação de integridade referencial antes de exclusões"

kpis:
  - nome: "Domínios Cadastrados"
    descricao: "Total de domínios gerenciados no sistema"
    meta: "50+"
    log_obrigatorio: false

  - nome: "Taxa de Reutilização de API"
    descricao: "% de dropdowns usando API genérica vs queries diretas"
    meta: ">80%"
    log_obrigatorio: false

  - nome: "Tempo de Importação"
    descricao: "Performance de bulk insert"
    meta: "<1s por 1000 itens"
    log_obrigatorio: true

  - nome: "Integridade Referencial"
    descricao: "Sem referências órfãs detectadas"
    meta: "100%"
    log_obrigatorio: true

  - nome: "Taxa de Sucesso de Importação"
    descricao: "% de importações sem erros"
    meta: ">95%"
    log_obrigatorio: true

  - nome: "Tempo Médio de Resposta (GET)"
    descricao: "Latência P95 de listagens"
    meta: "<100ms"
    log_obrigatorio: true

  - nome: "Tempo Médio de Resposta (POST)"
    descricao: "Latência P95 de criação"
    meta: "<200ms"
    log_obrigatorio: true

alertas:
  - evento: "Falha ao criar domínio"
    threshold: "> 5% em 1 hora"
    severidade: "ALTA"
    canal_notificacao:
      - "email"
      - "slack"

  - evento: "Falha ao importar lote"
    threshold: "> 3 falhas consecutivas"
    severidade: "ALTA"
    canal_notificacao:
      - "email"
      - "slack"

  - evento: "Tentativa de exclusão violando FK"
    threshold: "> 10 em 5 minutos"
    severidade: "MÉDIA"
    canal_notificacao:
      - "slack"

  - evento: "Tentativa de acesso sem permissão"
    threshold: "> 10 em 5 minutos"
    severidade: "CRÍTICA"
    canal_notificacao:
      - "email"
      - "slack"
      - "sms"

  - evento: "Violação de multi-tenancy"
    threshold: "Qualquer ocorrência"
    severidade: "CRÍTICA"
    canal_notificacao:
      - "email"
      - "slack"
      - "sms"

dependencias:
  upstream:
    - documentacao_id: "RF001"
      nome: "Parâmetros do Sistema"
      tipo: "Configurações globais"
    - documentacao_id: "RF002"
      nome: "Autenticação e Autorização"
      tipo: "RBAC e JWT"

  downstream:
    - documentacao_id: "RF016"
      nome: "Categorias"
      tipo: "Usa domínio de categorias"
    - documentacao_id: "RF051"
      nome: "Marcas/Modelos"
      tipo: "Usa domínio de marcas"
    - documentacao_id: "RF052"
      nome: "Ativos"
      tipo: "Usa domínio de status de ativo"

rastreabilidade:
  ucs_esperados:
    - "UC00" # Consultar domínios
    - "UC01" # Criar domínio
    - "UC02" # Editar domínio
    - "UC03" # Excluir domínio
    - "UC04" # Importar/Exportar
  artefatos:
    - tipo: "UC"
      arquivo: "UC-RF104.md"
      status: "pendente"
    - tipo: "MD"
      arquivo: "MD-RF104.md"
      status: "pendente"
    - tipo: "WF"
      arquivo: "WF-RF104.md"
      status: "pendente"
    - tipo: "TC"
      arquivo: "Testes/TC-RF104.yaml"
      status: "pendente"
    - tipo: "MT"
      arquivo: "Testes/MT-RF104.yaml"
      status: "pendente"

catalog:
  crud:
    - id: "RF-CRUD-01"
      title: "Criar domínio"
      required: true
    - id: "RF-CRUD-02"
      title: "Listar domínios"
      required: true
    - id: "RF-CRUD-03"
      title: "Visualizar domínio"
      required: true
    - id: "RF-CRUD-04"
      title: "Atualizar domínio"
      required: true
    - id: "RF-CRUD-05"
      title: "Excluir domínio"
      required: true
    - id: "RF-CRUD-06"
      title: "Criar item"
      required: true
    - id: "RF-CRUD-07"
      title: "Listar itens"
      required: true
    - id: "RF-CRUD-08"
      title: "Visualizar item"
      required: true
    - id: "RF-CRUD-09"
      title: "Atualizar item"
      required: true
    - id: "RF-CRUD-10"
      title: "Excluir item"
      required: true
    - id: "RF-CRUD-11"
      title: "Reordenar itens"
      required: true
    - id: "RF-CRUD-12"
      title: "Importar em lote"
      required: true
    - id: "RF-CRUD-13"
      title: "Exportar domínio"
      required: true

  validacoes:
    - id: "RF-VAL-01"
      title: "Validar campos obrigatórios"
      required: true
    - id: "RF-VAL-02"
      title: "Validar unicidade de nome de domínio"
      required: true
    - id: "RF-VAL-03"
      title: "Validar unicidade de código de item dentro do domínio"
      required: true
    - id: "RF-VAL-04"
      title: "Validar integridade referencial antes de exclusão"
      required: true
    - id: "RF-VAL-05"
      title: "Validar JSON em campo MetadadosJson"
      required: false
    - id: "RF-VAL-06"
      title: "Validar ciclos em hierarquias"
      required: false

  seguranca:
    - id: "RF-SEC-01"
      title: "Isolamento de tenant"
      required: true
    - id: "RF-SEC-02"
      title: "Permissões RBAC"
      required: true
    - id: "RF-SEC-03"
      title: "Auditoria completa"
      required: true
    - id: "RF-SEC-04"
      title: "Proteção contra injeção (SQL, JSON)"
      required: true

exclusions:
  documentacao_items: []

historico:
  - versao: "2.0"
    data: "2025-12-31"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Migração v1.0 → v2.0: Separação RF/RL, remoção de referências ao legado, adequação à governança 2.0"

  - versao: "1.0"
    data: "2025-12-28"
    autor: "Arquiteto IControlIT"
    descricao: "Versão inicial completa com 9 seções"
