# RF-104: Gestão Completa de Cadastros Base (Domínios Configuráveis)

**Versão**: 2.0
**Data**: 2025-12-31
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC003-CAD-Cadastros-Base
**Fase**: Fase 2 - Cadastros e Serviços Transversais

---

## 1. OBJETIVO DO REQUISITO

Fornecer um framework genérico e centralizado para gerenciamento de **domínios configuráveis** (tabelas de referência com listas controladas de valores) no sistema IControlIT, garantindo integridade referencial, auditoria completa, suporte a multi-tenancy e operações em lote (importação/exportação), sem necessidade de alteração de código para novos domínios.

Este documento define **o que o sistema deve fazer** em relação aos cadastros base (domínios), não como implementar.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Criação, visualização, edição e exclusão lógica de domínios
- [x] Criação, visualização, edição e exclusão lógica de itens de domínio
- [x] Validação de integridade referencial (bloquear exclusão se houver FK)
- [x] Importação em lote via CSV/Excel com preview e validação
- [x] Exportação de domínios em CSV/Excel
- [x] Suporte a estruturas hierárquicas (pai-filho) em domínios
- [x] Reordenação de itens para controle de ordem de exibição
- [x] Ativação/desativação de itens (soft delete)
- [x] Metadados customizados via JSON por item
- [x] Auditoria completa de operações
- [x] Controle de acesso RBAC por operação
- [x] Isolamento multi-tenant

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (layout, UX, identidade visual)
- Tecnologia, framework ou linguagem de implementação
- Estratégia de deploy ou infraestrutura
- Sincronização automática com sistemas externos (SAP, ServiceNow) - será RF separado
- Relatórios de uso/frequência/obsolescência - será RF separado

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-----|---------|
| **Domínio** | Tabela de referência contendo lista controlada de valores (ex: Status_Ativo) |
| **Item de Domínio** | Cada registro dentro de um domínio (ex: "Ativo" é um item do domínio Status_Ativo) |
| **Código do Item** | Identificador alfanumérico único dentro do domínio (ex: "ATI" para "Ativo") |
| **Domínio Configurável** | Domínio cujos valores podem ser alterados via interface sem código |
| **Domínio Fixo** | Domínio cujos valores não devem ser alterados (apenas consultados) |
| **Integridade Referencial** | Garantia de que não existem referências órfãs (FK para valores inexistentes) |
| **Hierarquia** | Estrutura pai-filho dentro de um domínio (ex: Região > Estado > Cidade) |
| **Metadados** | Informações customizadas em JSON anexadas a um item (ex: cor, ícone) |
| **Soft Delete** | Exclusão lógica (marcar como inativo) sem remover fisicamente o registro |

---

## 4. FUNCIONALIDADES COBERTAS

1. Criar domínio
2. Listar domínios
3. Visualizar domínio específico
4. Atualizar propriedades do domínio
5. Excluir domínio (se não houver itens)
6. Criar item em domínio
7. Listar itens de um domínio
8. Visualizar item específico
9. Atualizar item de domínio
10. Excluir item (lógico ou físico com validação de FK)
11. Reordenar itens de domínio
12. Importar itens em lote (CSV/Excel)
13. Exportar itens de domínio (CSV/Excel)
14. Ativar/desativar item

---

## 5. REGRAS DE NEGÓCIO

### RN-CAD-104-01 — Domínio Requer Nome Único e Descrição

**Descrição**: Todo domínio deve ter nome único (case-insensitive), descrição clara e tipo (Lista, Hierarquia).

**Justificativa**: Facilita identificação e uso correto do domínio em toda a aplicação.

**Critério de Aceite**:
- Nome de domínio ausente → rejeição (HTTP 400)
- Nome duplicado (case-insensitive) → rejeição (HTTP 409)
- Descrição ausente → rejeição (HTTP 400)
- Tipo inválido → rejeição (HTTP 400)

---

### RN-CAD-104-02 — Item de Domínio Requer Código Único dentro do Domínio

**Descrição**: Cada item dentro de um domínio deve ter código único alfanumérico (ex: "ATI" para "Ativo").

**Justificativa**: Permite referenciar valores em código sem dependência de strings mutáveis (descrição pode mudar, código não).

**Critério de Aceite**:
- Código ausente → rejeição (HTTP 400)
- Código duplicado no mesmo domínio → rejeição (HTTP 409)
- Código com caracteres inválidos (não alfanuméricos) → rejeição (HTTP 400)
- Código vazio ou apenas espaços → rejeição (HTTP 400)

---

### RN-CAD-104-03 — Exclusão de Item Requer Validação de Integridade Referencial

**Descrição**: Antes de excluir um item fisicamente, sistema valida se há registros referenciando-o via FK. Se houver, operação é bloqueada com mensagem clara indicando quantidade de registros afetados.

**Justificativa**: Evita referências órfãs que causam inconsistência de dados.

**Critério de Aceite**:
- Tentativa de exclusão com FK existente → bloqueio (HTTP 409)
- Mensagem deve indicar quantidade de registros referenciando
- Soft delete (desativação) deve ser sempre permitido
- Exclusão física permitida apenas se contador de FK = 0

---

### RN-CAD-104-04 — Item Pode Ser Marcado como Inativo Sem Ser Deletado

**Descrição**: Items deletados logicamente não são removidos fisicamente; marcados com `Ativo=false`. Queries por padrão excluem inativos a menos que explicitamente incluídos.

**Justificativa**: Preserva histórico; registros antigos continuam referenciando valor válido (embora inativo).

**Critério de Aceite**:
- Exclusão lógica (soft delete) marca `Ativo=false`
- Listagens padrão excluem inativos
- Filtro `incluirInativos=true` deve exibir todos
- Dropdowns padrão exibem apenas itens ativos

---

### RN-CAD-104-05 — Domínios Podem Ter Estrutura Hierárquica (Pai-Filho)

**Descrição**: Alguns domínios suportam hierarquia (ex: Região → Estado → Cidade). Campo `IdItemPai` permite relação 1:N. Sistema valida ciclos.

**Justificativa**: Modela estruturas naturalmente hierárquicas sem criar tabelas separadas.

**Critério de Aceite**:
- Campo `IdItemPai` nullable
- FK para mesmo domínio
- Validação de ciclos (item não pode ser pai de si mesmo direta ou indiretamente)
- Tentativa de criar ciclo → bloqueio (HTTP 400)

---

### RN-CAD-104-06 — Importação em Lote com Preview e Validação

**Descrição**: Administrador pode fazer upload CSV/Excel com valores do domínio. Sistema oferece preview, valida dados (schema, tipos, unicidade) e aplica atomicamente (tudo ou nada).

**Justificativa**: Facilita migração de dados e manutenção em massa.

**Critério de Aceite**:
- Upload com erros de schema → bloqueio com lista de erros
- Upload com duplicatas → bloqueio ou skip (conforme configuração)
- Preview exibe quantidade de inserções/atualizações
- Aplicação via transação ACID
- Falha em qualquer item → rollback total

---

### RN-CAD-104-07 — Auditoria Registra Todas Alterações de Domínios

**Descrição**: Toda operação em domínios (criar, editar, deletar, importar) é auditada com usuário, timestamp, antes/depois.

**Justificativa**: Conformidade; rastreabilidade de quem alterou valores críticos.

**Critério de Aceite**:
- Campos de auditoria obrigatórios: Created, CreatedBy, LastModified, LastModifiedBy
- Log de auditoria com operação (CREATE/UPDATE/DELETE), entidade, ID, diff antes/depois
- Auditoria deve ser automática (via interceptor ou trigger de domínio)
- Dados de auditoria devem ser imutáveis

---

### RN-CAD-104-08 — Exportação Permite Download em CSV ou Excel

**Descrição**: Usuários podem exportar qualquer domínio (ou lista de domínios) em formato CSV ou Excel.

**Justificativa**: Facilita análise, backup e integração com sistemas externos.

**Critério de Aceite**:
- Exportação CSV com encoding UTF-8 com BOM
- Exportação Excel via biblioteca adequada (EPPlus ou similar)
- Arquivo gerado com nome padrão: `{NomeDominio}_{YYYYMMDD}.csv` ou `.xlsx`
- Headers obrigatórios: Código, Descrição, Ativo, Ordem, MetadadosJson

---

### RN-CAD-104-09 — Domínios Suportam Atributos Customizados (Metadados)

**Descrição**: Cada item pode ter JSON customizado de metadados (ex: Prioridade tem cor hexadecimal para exibição, ícone FontAwesome, SLA em horas).

**Justificativa**: Permite estender domínios sem alterar schema de banco de dados.

**Critério de Aceite**:
- Campo `MetadadosJson` aceita JSON válido ou null
- Tentativa de inserir JSON inválido → bloqueio (HTTP 400)
- Metadados não afetam comportamento funcional (são apenas informativos)
- Frontend pode consumir metadados para customizar exibição

---

### RN-CAD-104-10 — Reordenação de Itens Define Ordem de Exibição

**Descrição**: Itens de domínio possuem campo `Ordem` (int) que define sequência de exibição em dropdowns e listagens. Usuários podem reordenar via drag-and-drop ou input direto.

**Justificativa**: Permite controle de UX (ex: prioridades mais usadas aparecem primeiro).

**Critério de Aceite**:
- Campo `Ordem` obrigatório (default: valor atual + 1)
- Reordenação atualiza múltiplos itens atomicamente
- Listagens padrão ordenam por campo `Ordem` ASC

---

## 6. ESTADOS DA ENTIDADE

### 6.1 Estados do Domínio

| Estado | Descrição |
|------|-----------|
| `ativo` | Domínio ativo, pode ser usado em dropdowns e operações |
| `inativo` | Domínio desativado, não exibido em dropdowns (mas dados históricos preservados) |

### 6.2 Estados do Item de Domínio

| Estado | Descrição |
|------|-----------|
| `ativo` | Item ativo, exibido em dropdowns |
| `inativo` | Item desativado, não exibido em dropdowns (soft delete) |

### 6.3 Transições Permitidas

| Entidade | De | Para |
|---|---|---|
| Domínio | ativo | inativo |
| Domínio | inativo | ativo |
| Item | ativo | inativo |
| Item | inativo | ativo |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre |
|------|--------------|
| `dominio.criado` | Após criação de domínio |
| `dominio.atualizado` | Após atualização de propriedades do domínio |
| `dominio.excluido` | Após exclusão do domínio |
| `item.criado` | Após criação de item |
| `item.atualizado` | Após atualização de item |
| `item.excluido` | Após exclusão (lógica ou física) de item |
| `itens.importados` | Após importação em lote bem-sucedida |
| `itens.exportados` | Após exportação de itens |
| `itens.reordenados` | Após reordenação de itens |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant
- Nenhuma regra de negócio pode ser ignorada
- Exclusões devem validar integridade referencial
- Auditoria deve registrar quem, quando e o que mudou
- Importações devem ser atômicas (tudo ou nada)
- Exportações devem gerar arquivos válidos (CSV UTF-8, Excel)
- Soft delete deve ser padrão para items
- Códigos de item devem ser imutáveis após criação

---

## 9. SEGURANÇA

### 9.1 Validações Obrigatórias

- Validação de entrada (schema, tipos, ranges)
- Proteção contra injeção (SQL, JSON)
- Validação de JSON em campo MetadadosJson
- Validação de unicidade de códigos e nomes

### 9.2 Controle de Acesso

- Isolamento multi-tenant obrigatório
- Permissões RBAC por operação (ver seção 10)
- Autenticação obrigatória em todas as rotas

### 9.3 Proteções Adicionais

- Rate limiting em importações (evitar sobrecarga)
- Validação de tamanho de arquivo (max 10MB para CSV/Excel)
- Validação de ciclos em hierarquias
- Validação de integridade referencial antes de exclusões

---

## 10. PERMISSÕES RBAC

| Permissão | Descrição | Roles Autorizadas |
|-----------|-----------|--------|
| `CAD.DOMINIO.VIEW_ANY` | Listar domínios | Todos autenticados |
| `CAD.DOMINIO.VIEW` | Visualizar domínio específico | Todos autenticados |
| `CAD.DOMINIO.CREATE` | Criar domínio | Admin |
| `CAD.DOMINIO.UPDATE` | Editar domínio | Admin |
| `CAD.DOMINIO.DELETE` | Excluir domínio | Admin |
| `CAD.ITEM.VIEW_ANY` | Listar itens de domínio | Todos autenticados |
| `CAD.ITEM.VIEW` | Visualizar item específico | Todos autenticados |
| `CAD.ITEM.CREATE` | Criar item em domínio | Admin, Gestor |
| `CAD.ITEM.UPDATE` | Editar item | Admin, Gestor |
| `CAD.ITEM.DELETE` | Deletar item | Admin |
| `CAD.ITEM.REORDER` | Reordenar itens | Admin, Gestor |
| `CAD.IMPORTACAO.EXECUTE` | Importar em lote | Admin |
| `CAD.EXPORTACAO.EXECUTE` | Exportar domínios | Admin, Gestor |

---

## 11. API ENDPOINTS

| Método | Endpoint | Descrição | Permissão | Request | Response |
|--------|----------|-----------|-----------|---------|----------|
| GET | `/api/dominios` | Listar domínios | `CAD.DOMINIO.VIEW_ANY` | Query: page, pageSize | PaginatedList\<DominioDto\> |
| GET | `/api/dominios/{nome}` | Obter domínio | `CAD.DOMINIO.VIEW` | - | DominioDto |
| POST | `/api/dominios` | Criar domínio | `CAD.DOMINIO.CREATE` | CreateDominioCommand | Guid |
| PUT | `/api/dominios/{nome}` | Atualizar domínio | `CAD.DOMINIO.UPDATE` | UpdateDominioCommand | void |
| DELETE | `/api/dominios/{nome}` | Excluir domínio | `CAD.DOMINIO.DELETE` | - | void |
| GET | `/api/dominios/{nome}/itens` | Listar itens | `CAD.ITEM.VIEW_ANY` | Query: incluirInativos | List\<ItemDominioDto\> |
| GET | `/api/dominios/{nome}/itens/{codigo}` | Obter item | `CAD.ITEM.VIEW` | - | ItemDominioDto |
| POST | `/api/dominios/{nome}/itens` | Criar item | `CAD.ITEM.CREATE` | CreateItemDominioCommand | Guid |
| PUT | `/api/dominios/{nome}/itens/{codigo}` | Editar item | `CAD.ITEM.UPDATE` | UpdateItemDominioCommand | void |
| DELETE | `/api/dominios/{nome}/itens/{codigo}` | Deletar item | `CAD.ITEM.DELETE` | Query: softDelete | void |
| PUT | `/api/dominios/{nome}/itens/reordenar` | Reordenar itens | `CAD.ITEM.REORDER` | ReordenarItensCommand | void |
| POST | `/api/dominios/{nome}/importar` | Importar CSV/Excel | `CAD.IMPORTACAO.EXECUTE` | File + options | ImportResultDto |
| GET | `/api/dominios/{nome}/exportar` | Exportar CSV/Excel | `CAD.EXPORTACAO.EXECUTE` | Query: formato | File |

---

## 12. MODELO DE DADOS (REFERÊNCIA)

O modelo de dados completo está documentado em arquivo separado: **MD-RF104.md**

Principais entidades:
- **Dominio**: Tabela que define um domínio (nome, descrição, tipo)
- **ItemDominio**: Itens de cada domínio (código, descrição, ordem, metadados)

Relacionamentos:
- Dominio 1:N ItemDominio
- ItemDominio N:1 ItemDominio (hierarquia pai-filho)

Campos obrigatórios multi-tenancy:
- ClienteId (domínios podem ser globais ou por cliente)

Campos obrigatórios auditoria:
- Created, CreatedBy, LastModified, LastModifiedBy

---

## 13. INTEGRAÇÕES OBRIGATÓRIAS

### 13.1 Internas

- **Autenticação**: JWT Bearer Token
- **Multi-Tenancy**: Isolamento por ClienteId
- **Auditoria**: Interceptor automático de auditoria
- **Central de Funcionalidades**: Registro da feature `GESTAO_DOMINIOS_CADASTROS`

### 13.2 i18n (Internacionalização)

Chaves de tradução obrigatórias (pt-BR, en, es):

```json
{
  "dominios.titulo": "Cadastros Base - Domínios",
  "dominios.descricao": "Gerenciar listas de valores configuráveis",
  "dominios.campo_nome": "Nome do Domínio",
  "dominios.campo_descricao": "Descrição",
  "dominios.campo_tipo": "Tipo",
  "dominios.tipo_lista": "Lista",
  "dominios.tipo_hierarquia": "Hierarquia",
  "dominios.botao_novo": "Novo Domínio",
  "dominios.botao_importar": "Importar CSV",
  "dominios.botao_exportar": "Exportar",
  "item_dominio.titulo": "Itens do Domínio",
  "item_dominio.campo_codigo": "Código",
  "item_dominio.campo_descricao": "Descrição",
  "item_dominio.campo_ativo": "Ativo",
  "item_dominio.campo_ordem": "Ordem",
  "item_dominio.botao_novo": "Novo Item",
  "item_dominio.botao_reordenar": "Reordenar",
  "item_dominio.erro_delecao_fk": "Não é possível deletar. Existem {quantidade} registros usando este item.",
  "importacao.erro_schema": "Arquivo com schema inválido: {erros}",
  "importacao.sucesso": "{total} itens importados com sucesso"
}
```

---

## 14. MÉTRICAS E INDICADORES (KPIs)

| KPI | Meta | Medição |
|-----|------|---------|
| **Domínios Cadastrados** | 50+ | Total de domínios gerenciados no sistema |
| **Taxa de Reutilização de API** | >80% | % de dropdowns usando API genérica vs queries diretas |
| **Tempo de Importação** | <1s por 1000 itens | Performance de bulk insert |
| **Integridade Referencial** | 100% | Sem referências órfãs detectadas |
| **Taxa de Sucesso de Importação** | >95% | % de importações sem erros |
| **Tempo Médio de Resposta (GET)** | <100ms | Latência P95 de listagens |
| **Tempo Médio de Resposta (POST)** | <200ms | Latência P95 de criação |

---

## 15. ALERTAS CRÍTICOS

| Evento | Threshold | Severidade | Canal Notificação |
|------|-----------|----------|------------|
| Falha ao criar domínio | > 5% em 1 hora | ALTA | Email, Slack |
| Falha ao importar lote | > 3 falhas consecutivas | ALTA | Email, Slack |
| Tentativa de exclusão violando FK | > 10 em 5 minutos | MÉDIA | Slack |
| Tentativa de acesso sem permissão | > 10 em 5 minutos | CRÍTICA | Email, Slack, SMS |
| Violação de multi-tenancy | Qualquer ocorrência | CRÍTICA | Email, Slack, SMS |

---

## 16. DEPENDÊNCIAS

### 16.1 RFs Dependentes (upstream)

- **RF001** (Parâmetros do Sistema): Configurações globais
- **RF002** (Autenticação e Autorização): RBAC e JWT

### 16.2 RFs que Dependem Deste (downstream)

- **RF016** (Categorias): Usa domínio de categorias
- **RF051** (Marcas/Modelos): Usa domínio de marcas
- **RF052** (Ativos): Usa domínio de status de ativo
- Qualquer RF que use listas controladas (prioridades, tipos, status)

---

## 17. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF104.md** (Casos de Uso): UC00-Consultar, UC01-Criar, UC02-Editar, UC03-Excluir, UC04-Importar/Exportar
- **MD-RF104.md** (Modelo de Dados): Entidades Dominio e ItemDominio
- **WF-RF104.md** (Wireframes): Telas de listagem, formulário, importação
- **TC-RF104.yaml** (Casos de Teste): Testes de CRUD, validações, integridade referencial
- **MT-RF104.yaml** (Massas de Teste): Dados de teste para domínios e itens

---

## 18. RASTREABILIDADE

| Artefato | Status | Caminho |
|--------|-------|---------|
| UC-RF104.md | Pendente | docs/documentacao/.../UC-RF104.md |
| MD-RF104.md | Pendente | docs/documentacao/.../MD-RF104.md |
| WF-RF104.md | Pendente | docs/documentacao/.../WF-RF104.md |
| TC-RF104.yaml | Pendente | docs/documentacao/.../Testes/TC-RF104.yaml |
| MT-RF104.yaml | Pendente | docs/documentacao/.../Testes/MT-RF104.yaml |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|------|------|----------|------|
| 2.0 | 2025-12-31 | Migração v1.0 → v2.0: Separação RF/RL, remoção de referências ao legado, adequação à governança 2.0 | Agência ALC - alc.dev.br |
| 1.0 | 2025-12-28 | Versão inicial completa com 9 seções | Arquiteto IControlIT |

---

**Última Atualização**: 2025-12-31
**Autor**: Agência ALC - alc.dev.br
**Revisão**: Pendente
