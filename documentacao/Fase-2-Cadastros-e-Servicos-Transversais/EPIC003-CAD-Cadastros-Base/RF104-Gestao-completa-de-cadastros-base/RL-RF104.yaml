# Template de Referência ao Legado (RL-RF104.yaml)
# Versão: 2.0
# Data: 2025-12-31
# Autor: Agência ALC - alc.dev.br

rf_id: RF104
titulo: "Gestão Completa de Cadastros Base (Domínios Configuráveis)"

legado:
  sistema: "VB.NET + ASP.NET Web Forms + SQL Server (multi-database)"
  versao: "4.x"
  arquitetura: "Monolítica WebForms"
  banco_dados: "SQL Server (multi-database: banco `branco` + bancos por cliente)"
  multi_tenant: false # Multi-database físico, não Row-Level Security
  auditoria: "none" # Sem campos Created, CreatedBy, LastModified, LastModifiedBy

# ==============================================================================
# SEÇÃO CRÍTICA: Referencias ao Legado com Destino Obrigatório
# ==============================================================================

referencias:
  # ----------------------------------------------------------------------------
  # TELAS LEGADAS
  # ----------------------------------------------------------------------------
  - id: "LEG-RF104-001"
    tipo: "tela"
    nome: "Status_Ativo.aspx"
    caminho: "ic1_legado/IControlIT/Configuracao/Status_Ativo.aspx"
    descricao: |
      Tela de gerenciamento de status de ativos (Ativo, Inativo, Suspendido, etc.).
      - Campos: Id_Status (hidden, auto-increment), Nome_Status (text), Ordem (numeric optional)
      - Validação de unicidade apenas no frontend (JavaScript)
      - Exclusão física sem validação de FK (causa órfãos)
      - Sem auditoria (não registra quem criou/alterou)

    destino: "substituido"
    justificativa: |
      Substituída por tela genérica reutilizável que consome API REST /api/dominios/{nome}.
      Elimina duplicação de código (~500 LOC por domínio).
      Validação de unicidade no backend, soft delete, auditoria completa.

    documentacao_item_relacionado: "RN-CAD-104-01"
    uc_relacionado: "UC01"

    migracao_moderna:
      componente_angular: "dominios-manage.component.ts (genérico reutilizável)"
      rota_frontend: "/administracao/dominios/Status_Ativo"

    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF104-002"
    tipo: "tela"
    nome: "Prioridades.aspx"
    caminho: "ic1_legado/IControlIT/Configuracao/Prioridades.aspx"
    descricao: |
      Tela de gerenciamento de prioridades de chamados (Alta, Média, Baixa, Crítica).
      - Campos: Id_Prioridade, Nome, Ordem, Cor (hardcoded como string na descrição)
      - Campo "Cor" parsing manual (ex: "Alta #FF0000")
      - Sem campo JSON para metadados estruturados

    destino: "substituido"
    justificativa: |
      Substituída por tela genérica com suporte a campo MetadadosJson.
      Metadados (cor, ícone, SLA) armazenados como JSON válido.

    documentacao_item_relacionado: "RN-CAD-104-09"
    uc_relacionado: "UC01"

    migracao_moderna:
      componente_angular: "dominios-manage.component.ts"
      rota_frontend: "/administracao/dominios/Prioridade"

    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 3

  # ----------------------------------------------------------------------------
  # WEBSERVICES LEGADOS
  # ----------------------------------------------------------------------------
  - id: "LEG-RF104-003"
    tipo: "webservice"
    nome: "StatusService.asmx - ListarStatusAtivo()"
    caminho: "ic1_legado/IControlIT/Services/StatusService.asmx"
    descricao: |
      Retorna lista de status de ativo.
      - Sem paginação (retorna todos registros de uma vez)
      - Sem filtros (retorna ativos e inativos juntos)
      - Sem autenticação (público)

    destino: "substituido"
    justificativa: |
      Substituído por REST API com autenticação JWT, paginação e filtros.
      Endpoint moderno: GET /api/dominios/Status_Ativo/itens?incluirInativos=false&page=1&pageSize=50

    documentacao_item_relacionado: "Seção 11 (Endpoints)"
    uc_relacionado: "UC00"

    migracao_moderna:
      endpoint_moderno: "GET /api/dominios/Status_Ativo/itens"
      query_cqrs: "GetItensDominioQuery"
      handler: "GetItensDominioQueryHandler"

    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF104-004"
    tipo: "webservice"
    nome: "StatusService.asmx - CriarStatus(nome)"
    caminho: "ic1_legado/IControlIT/Services/StatusService.asmx"
    descricao: |
      Cria novo status de ativo.
      - Parâmetro: nome (string)
      - Sem validação de duplicata (permite nomes repetidos)
      - Sem autenticação
      - Retorna int (Id auto-increment)

    destino: "substituido"
    justificativa: |
      Substituído por REST API com validação de unicidade, autenticação JWT.
      Campo Codigo adicionado (alfanumérico estável).

    documentacao_item_relacionado: "RN-CAD-104-01, RN-CAD-104-02"
    uc_relacionado: "UC01"

    migracao_moderna:
      endpoint_moderno: "POST /api/dominios/Status_Ativo/itens"
      command_cqrs: "CreateItemDominioCommand"
      handler: "CreateItemDominioCommandHandler"
      validador: "CreateItemDominioCommandValidator (FluentValidation)"

    complexidade: "media"
    risco_migracao: "medio" # Validação agora no backend pode quebrar integrações legadas
    prioridade: 2

  - id: "LEG-RF104-005"
    tipo: "webservice"
    nome: "StatusService.asmx - DeletarStatus(id)"
    caminho: "ic1_legado/IControlIT/Services/StatusService.asmx"
    descricao: |
      Deleta status fisicamente (DELETE FROM).
      - Sem validação de FK (pode causar referências órfãs)
      - Sem soft delete
      - Retorna bool (sucesso/falha)

    destino: "substituido"
    justificativa: |
      Substituído por soft delete padrão + validação de FK obrigatória.
      Exclusão física apenas se FK = 0 e flag softDelete=false explícito.

    documentacao_item_relacionado: "RN-CAD-104-03, RN-CAD-104-04"
    uc_relacionado: "UC03"

    migracao_moderna:
      endpoint_moderno: "DELETE /api/dominios/Status_Ativo/itens/{codigo}?softDelete=true"
      command_cqrs: "DeleteItemDominioCommand"
      handler: "DeleteItemDominioCommandHandler (valida FK antes de deletar)"

    complexidade: "alta"
    risco_migracao: "alto" # Mudança de comportamento (soft vs hard delete)
    prioridade: 1

  # ----------------------------------------------------------------------------
  # STORED PROCEDURES
  # ----------------------------------------------------------------------------
  - id: "LEG-RF104-006"
    tipo: "stored_procedure"
    nome: "pa_Ativo_Status_Listar"
    caminho: "Database/dbo.pa_Ativo_Status_Listar"
    descricao: |
      Lista status de ativo.
      - Sem parâmetros de entrada
      - Retorna todas colunas: Id_Status, Nome_Status, Ordem
      - Sem filtro de ativos/inativos
      - Sem paginação

    destino: "substituido"
    justificativa: |
      Lógica movida para Application Layer (GetItensDominioQueryHandler).
      CQRS com suporte a filtros, paginação, ordenação.

    documentacao_item_relacionado: "Seção 11 (Endpoints)"
    uc_relacionado: "UC00"

    migracao_moderna:
      handler: "GetItensDominioQueryHandler"
      validacao: null

    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF104-007"
    tipo: "stored_procedure"
    nome: "pa_Prioridade_Listar"
    caminho: "Database/dbo.pa_Prioridade_Listar"
    descricao: |
      Lista prioridades.
      - Sem paginação
      - Sem filtros
      - Retorna: Id_Prioridade, Nome, Ordem

    destino: "substituido"
    justificativa: "Mesma justificativa de pa_Ativo_Status_Listar."

    documentacao_item_relacionado: "Seção 11 (Endpoints)"
    uc_relacionado: "UC00"

    migracao_moderna:
      handler: "GetItensDominioQueryHandler"

    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  # ----------------------------------------------------------------------------
  # TABELAS LEGADAS
  # ----------------------------------------------------------------------------
  - id: "LEG-RF104-008"
    tipo: "stored_procedure"
    nome: "Tabela Ativo_Status (legado)"
    caminho: "Database/dbo.Ativo_Status"
    descricao: |
      Tabela de status de ativos.
      - Colunas: Id_Status (PK, int IDENTITY), Nome_Status (varchar(50)), Ordem (int nullable)
      - Sem FK para validação
      - Sem campos de auditoria (Created, CreatedBy, LastModified, LastModifiedBy)
      - Sem campo Ativo (soft delete)
      - Sem campo Codigo (identificador alfanumérico estável)
      - Sem campo MetadadosJson
      - Sem constraint UNIQUE em Nome_Status

    problemas_identificados:
      - "Sem Foreign Key para validar relacionamento com tabela Ativo"
      - "Sem campos de auditoria (Created, CreatedBy, LastModified, LastModifiedBy)"
      - "Sem campo Ativo para soft delete"
      - "Sem campo ClienteId (multi-tenancy)"
      - "Sem campo Codigo (identificador alfanumérico estável)"
      - "Sem campo MetadadosJson (metadados customizados)"
      - "Permite Nome_Status duplicado (sem constraint UNIQUE)"

    destino: "substituido"
    justificativa: |
      Tabela redesenhada como parte do framework genérico (Dominio + ItemDominio).
      Dominio.Nome = "Status_Ativo".
      ItemDominio contém Codigo, Descricao, Ordem, Ativo, MetadadosJson, ClienteId, Created, CreatedBy, LastModified, LastModifiedBy.

    rastreabilidade:
      documentacao_moderno: "Seção 12 (Modelo de Dados)"
      md_moderno: "MD-RF104.md - Tabela Dominio + ItemDominio"

    migracao_moderna:
      tabela_moderna: "ItemDominio (com DominioId FK para Dominio onde Nome='Status_Ativo')"
      migration_ef_core: "20251231_CreateDominioAndItemDominioTables.cs"

    complexidade: "alta"
    risco_migracao: "alto" # Migração multi-database → single database
    prioridade: 1

  - id: "LEG-RF104-009"
    tipo: "stored_procedure"
    nome: "Tabela Solicitacao_Status (legado)"
    caminho: "Database/dbo.Solicitacao_Status"
    descricao: |
      Tabela de status de solicitações (duplica estrutura de Ativo_Status).
      - Colunas: Id_Status (PK, int IDENTITY), Nome_Status (varchar(50)), Ordem (int nullable)
      - Mesmos problemas de Ativo_Status

    problemas_identificados:
      - "Duplica estrutura de Ativo_Status (deveria usar tabela genérica)"
      - "Sem auditoria, multi-tenancy, soft delete, código estável"

    destino: "substituido"
    justificativa: "Consolidada em framework genérico. Dominio.Nome = 'Status_Solicitacao'."

    rastreabilidade:
      documentacao_moderno: "Seção 12 (Modelo de Dados)"
      md_moderno: "MD-RF104.md - Tabela Dominio + ItemDominio"

    migracao_moderna:
      tabela_moderna: "ItemDominio (com DominioId FK para Dominio onde Nome='Status_Solicitacao')"

    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 2

  - id: "LEG-RF104-010"
    tipo: "stored_procedure"
    nome: "Tabela Prioridade (legado)"
    caminho: "Database/dbo.Prioridade"
    descricao: |
      Tabela de prioridades.
      - Colunas: Id_Prioridade (PK, int IDENTITY), Nome (varchar(50)), Ordem (int NOT NULL)
      - Campo Ordem sem constraint UNIQUE (permite duplicatas)

    problemas_identificados:
      - "Campo Ordem sem constraint UNIQUE (permite ordem duplicada)"
      - "Sem auditoria, multi-tenancy, soft delete"
      - "Sem campo MetadadosJson (cor, ícone armazenados como string na descrição)"

    destino: "substituido"
    justificativa: "Consolidada em framework genérico. Dominio.Nome = 'Prioridade'. MetadadosJson suporta cor, ícone, SLA."

    rastreabilidade:
      documentacao_moderno: "RN-CAD-104-09, Seção 12 (Modelo de Dados)"
      md_moderno: "MD-RF104.md - Tabela ItemDominio com campo MetadadosJson"

    migracao_moderna:
      tabela_moderna: "ItemDominio (com DominioId FK para Dominio onde Nome='Prioridade')"

    complexidade: "media"
    risco_migracao: "medio"
    prioridade: 2

  # ----------------------------------------------------------------------------
  # REGRAS DE NEGÓCIO IMPLÍCITAS
  # ----------------------------------------------------------------------------
  - id: "LEG-RF104-011"
    tipo: "regra_negocio"
    nome: "Validação de unicidade apenas no frontend"
    caminho: "ic1_legado/IControlIT/Configuracao/Status_Ativo.aspx.vb"
    descricao: |
      Localização: Linha 45
      Validação de nome único de status era feita apenas no frontend via JavaScript.
      Backend aceitava duplicatas silenciosamente.

    destino: "assumido"
    justificativa: |
      Regra documentada e validada no backend (RN-CAD-104-01).
      Constraint UNIQUE no banco de dados, validação em FluentValidation.

    documentacao_item_relacionado: "RN-CAD-104-01"
    uc_relacionado: "UC01"

    migracao_moderna:
      validador: "CreateItemDominioCommandValidator - RuleFor(x => x.Codigo).Must(BeUniqueInDomain)"

    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF104-012"
    tipo: "regra_negocio"
    nome: "Campo Ordem opcional causa null reference exception"
    caminho: "ic1_legado/IControlIT/Configuracao/Prioridades.aspx.vb"
    descricao: |
      Localização: Linha 78
      Campo Ordem era opcional, mas dropdowns quebravam se não fosse preenchido (null reference exception no VB.NET).

    destino: "assumido"
    justificativa: |
      Campo Ordem agora obrigatório (RN-CAD-104-10).
      Default: valor atual máximo + 1.

    documentacao_item_relacionado: "RN-CAD-104-10"
    uc_relacionado: "UC01"

    migracao_moderna:
      validador: "CreateItemDominioCommandValidator - RuleFor(x => x.Ordem).NotNull()"

    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF104-013"
    tipo: "regra_negocio"
    nome: "Exclusão física sem validação de FK"
    caminho: "ic1_legado/IControlIT/Services/StatusService.asmx.vb"
    descricao: |
      Localização: Linha 120
      Exclusão de item de domínio era física (DELETE FROM), sem verificação de FK.
      Causava referências órfãs silenciosamente.

    destino: "substituido"
    justificativa: |
      Soft delete padrão (RN-CAD-104-04).
      Validação de FK obrigatória antes de exclusão física (RN-CAD-104-03).

    documentacao_item_relacionado: "RN-CAD-104-03"
    uc_relacionado: "UC03"

    migracao_moderna:
      handler: "DeleteItemDominioCommandHandler - Query antes de DELETE para contar FK"

    complexidade: "alta"
    risco_migracao: "alto" # Mudança de comportamento
    prioridade: 1

  - id: "LEG-RF104-014"
    tipo: "regra_negocio"
    nome: "Metadados customizados como string na descrição"
    caminho: "ic1_legado/IControlIT/Configuracao/Prioridades.aspx.vb"
    descricao: |
      Localização: Linha 92
      Metadados (cor, ícone) armazenados como string na descrição (ex: "Alta #FF0000").
      Parsing manual no frontend via regex.

    destino: "substituido"
    justificativa: |
      Campo MetadadosJson estruturado (RN-CAD-104-09).
      JSON válido, validado no backend, consumido pelo frontend sem parsing manual.

    documentacao_item_relacionado: "RN-CAD-104-09"
    uc_relacionado: "UC02"

    migracao_moderna:
      validador: "CreateItemDominioCommandValidator - RuleFor(x => x.MetadadosJson).Must(BeValidJson)"

    complexidade: "media"
    risco_migracao: "medio"
    prioridade: 2

  - id: "LEG-RF104-015"
    tipo: "regra_negocio"
    nome: "Importação em lote via SQL manual"
    caminho: "Processo manual DBA (sem arquivo específico)"
    descricao: |
      Importação em lote feita via script SQL executado manualmente pelo DBA.
      Sem preview, sem validação, sem rollback.
      Alto risco de corrupção de dados.

    destino: "substituido"
    justificativa: |
      Upload CSV/Excel com preview, validação e transação ACID (RN-CAD-104-06).
      Self-service para administradores, sem necessidade de DBA.

    documentacao_item_relacionado: "RN-CAD-104-06"
    uc_relacionado: "UC04"

    migracao_moderna:
      handler: "ImportarItensDominioCommandHandler - Parse CSV, validação, transação ACID"

    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 2

# ==============================================================================
# TELAS LEGADAS (estrutura detalhada)
# ==============================================================================

telas:
  - id: "LEG-RF104-001"
    nome: "Status_Ativo.aspx"
    caminho: "ic1_legado/IControlIT/Configuracao/Status_Ativo.aspx"
    responsabilidade: "Gerenciar status de ativos (CRUD)"
    campos:
      - nome: "Id_Status"
        tipo: "TextBox (hidden)"
        obrigatorio: true
        validacao: "Auto-increment (PK)"
      - nome: "Nome_Status"
        tipo: "TextBox"
        obrigatorio: true
        validacao: "Required field (JavaScript)"
      - nome: "Ordem"
        tipo: "TextBox (numeric)"
        obrigatorio: false
        validacao: "Numeric (JavaScript)"
    comportamentos_implicitos:
      - "Validação de nome único apenas no frontend"
      - "Exclusão física sem validação de FK"
      - "Sem auditoria (não registra quem criou/alterou)"

  - id: "LEG-RF104-002"
    nome: "Prioridades.aspx"
    caminho: "ic1_legado/IControlIT/Configuracao/Prioridades.aspx"
    responsabilidade: "Gerenciar prioridades de chamados (CRUD)"
    campos:
      - nome: "Id_Prioridade"
        tipo: "TextBox (hidden)"
        obrigatorio: true
        validacao: "Auto-increment (PK)"
      - nome: "Nome"
        tipo: "TextBox"
        obrigatorio: true
        validacao: "Required field (JavaScript)"
      - nome: "Ordem"
        tipo: "TextBox (numeric)"
        obrigatorio: true
        validacao: "Numeric (JavaScript)"
      - nome: "Cor"
        tipo: "TextBox (hex)"
        obrigatorio: false
        validacao: "Regex hex color (JavaScript)"
    comportamentos_implicitos:
      - "Campo Cor armazenado como string na descrição"
      - "Sem campo JSON para metadados estruturados"

# ==============================================================================
# WEBSERVICES LEGADOS
# ==============================================================================

servicos:
  - id: "LEG-RF104-003"
    nome: "StatusService.asmx"
    localizacao: "ic1_legado/IControlIT/Services/StatusService.asmx"
    responsabilidade: "CRUD de status de ativo"
    notas: "SOAP, sem autenticação, sem paginação"

  - id: "LEG-RF104-004"
    nome: "PrioridadeService.asmx"
    localizacao: "ic1_legado/IControlIT/Services/PrioridadeService.asmx"
    responsabilidade: "CRUD de prioridades"
    notas: "SOAP, sem autenticação, sem paginação"

# ==============================================================================
# TABELAS LEGADAS COM PROBLEMAS
# ==============================================================================

tabelas:
  - nome: "Ativo_Status"
    finalidade: "Armazenar status de ativos"
    problemas:
      - "Sem Foreign Key para validar relacionamento"
      - "Sem campos de auditoria"
      - "Sem campo Ativo (soft delete)"
      - "Sem multi-tenancy (ClienteId)"
      - "Permite Nome_Status duplicado"

  - nome: "Solicitacao_Status"
    finalidade: "Armazenar status de solicitações"
    problemas:
      - "Duplica estrutura de Ativo_Status"
      - "Sem auditoria, multi-tenancy, soft delete"

  - nome: "Prioridade"
    finalidade: "Armazenar prioridades"
    problemas:
      - "Campo Ordem sem constraint UNIQUE"
      - "Sem auditoria, multi-tenancy, soft delete"
      - "Sem campo MetadadosJson"

# ==============================================================================
# REGRAS DE NEGÓCIO IMPLÍCITAS (não documentadas)
# ==============================================================================

regras_implicitas:
  - id: "RL-RN-001"
    descricao: "Validação de unicidade de nome de domínio era feita apenas no frontend (JavaScript), backend aceitava duplicatas"
    fonte: "Status_Ativo.aspx.vb - Linha 45"

  - id: "RL-RN-002"
    descricao: "Campo Ordem era opcional, mas dropdowns quebravam se não fosse preenchido (null reference exception)"
    fonte: "Prioridades.aspx.vb - Linha 78"

  - id: "RL-RN-003"
    descricao: "Exclusão de item de domínio era física (DELETE FROM), sem verificação de FK. Causava órfãos silenciosamente"
    fonte: "StatusService.asmx.vb - Linha 120"

  - id: "RL-RN-004"
    descricao: "Metadados customizados (ex: cor, ícone) eram armazenados como string na descrição (ex: 'Alta #FF0000'). Parsing manual no frontend"
    fonte: "Prioridades.aspx.vb - Linha 92"

  - id: "RL-RN-005"
    descricao: "Importação em lote era feita via script SQL executado manualmente pelo DBA. Sem preview, sem validação, sem rollback. Alto risco de corrupção de dados"
    fonte: "Processo manual DBA"

  - id: "RL-RN-006"
    descricao: "Dropdowns carregavam TODOS os registros de uma vez (sem paginação), causando lentidão com domínios grandes (>1000 itens)"
    fonte: "StatusService.asmx - ListarStatusAtivo()"

# ==============================================================================
# GAP ANALYSIS (Legado x Moderno)
# ==============================================================================

gap_analysis:
  - item: "Framework Genérico"
    existe_legado: false
    existe_moderno: true
    notas: "Cada domínio legado tem CRUD próprio (~500 LOC). Sistema moderno usa API genérica reutilizável (0 LOC por domínio)"

  - item: "Validação de FK"
    existe_legado: false
    existe_moderno: true
    notas: "Legado permite exclusão física sem validação. Moderno valida FK antes de exclusão"

  - item: "Auditoria"
    existe_legado: false
    existe_moderno: true
    notas: "Legado sem campos de auditoria. Moderno com auditoria automática via interceptor"

  - item: "Multi-Tenancy"
    existe_legado: false # Multi-database físico
    existe_moderno: true # Row-Level Security
    notas: "Legado usa multi-database físico. Moderno usa Row-Level Security via ClienteId"

  - item: "Soft Delete"
    existe_legado: false
    existe_moderno: true
    notas: "Legado usa DELETE físico. Moderno usa campo Ativo (soft delete)"

  - item: "Importação em Lote"
    existe_legado: false # SQL manual
    existe_moderno: true # Upload CSV/Excel
    notas: "Legado via SQL manual pelo DBA. Moderno via upload CSV/Excel com preview"

  - item: "Exportação"
    existe_legado: false
    existe_moderno: true
    notas: "Legado sem exportação. Moderno com exportação CSV/Excel"

  - item: "Hierarquias"
    existe_legado: false
    existe_moderno: true
    notas: "Legado não suporta hierarquias. Moderno suporta via campo IdItemPai"

  - item: "Metadados Customizados"
    existe_legado: false # String parsing
    existe_moderno: true # JSON estruturado
    notas: "Legado usa string parsing. Moderno usa campo MetadadosJson (JSON válido)"

  - item: "Código Alfanumérico Estável"
    existe_legado: false
    existe_moderno: true
    notas: "Legado apenas Id auto-increment. Moderno com campo Codigo (alfanumérico, imutável)"

# ==============================================================================
# DECISÕES DE MODERNIZAÇÃO
# ==============================================================================

decisoes_modernizacao:
  - decisao: "Framework Genérico vs CRUD Específico"
    motivo: |
      Reduz duplicação de código (~500 LOC por domínio × 50 domínios = 25.000 LOC eliminadas).
      Facilita manutenção e adição de novos domínios sem código.
    impacto: "alto"
    data: "2025-12-31"

  - decisao: "Soft Delete Padrão"
    motivo: |
      Preserva histórico, evita órfãos, permite "desfazer" exclusões acidentais.
    impacto: "medio"
    data: "2025-12-31"

  - decisao: "Multi-Tenancy via ClienteId (Row-Level Security)"
    motivo: |
      Simplifica infraestrutura, facilita backup, reduz custos de manutenção.
    impacto: "alto"
    data: "2025-12-31"

  - decisao: "Campo Código Alfanumérico Estável"
    motivo: |
      Permite refatorações sem quebrar código (ex: alterar descrição de 'Alta' para 'High Priority' não quebra código que referencia 'ALT').
    impacto: "baixo"
    data: "2025-12-31"

  - decisao: "Metadados JSON vs Campos Fixos"
    motivo: |
      Permite extensibilidade sem alterar schema, cada domínio pode ter metadados customizados.
    impacto: "baixo"
    data: "2025-12-31"

# ==============================================================================
# RISCOS DE MIGRAÇÃO
# ==============================================================================

riscos_migracao:
  - risco: "Perda de dados durante migração multi-database → single database"
    impacto: "alto"
    probabilidade: "media"
    mitigacao: |
      Script de migração validado em ambiente de teste, backup completo antes de migração, rollback plan documentado.

  - risco: "Referências órfãs existentes no legado"
    impacto: "medio"
    probabilidade: "alta"
    mitigacao: |
      Identificar e corrigir órfãos ANTES da migração (query de auditoria), documentar casos que não podem ser corrigidos.

  - risco: "Códigos alfanuméricos gerados conflitarem"
    impacto: "baixo"
    probabilidade: "baixa"
    mitigacao: |
      Validar unicidade de códigos gerados, usar prefixos por domínio (ex: STATUS_ATI, PRIOR_ALT).

  - risco: "Performance de queries com soft delete"
    impacto: "medio"
    probabilidade: "media"
    mitigacao: |
      Criar índices em campo Ativo, monitorar performance após migração, otimizar queries lentas.

  - risco: "Metadados JSON inválidos importados"
    impacto: "baixo"
    probabilidade: "baixa"
    mitigacao: |
      Validação obrigatória de JSON na API, rejeitar payloads inválidos com mensagem clara.

  - risco: "Alteração de comportamento (soft vs hard delete)"
    impacto: "medio"
    probabilidade: "alta"
    mitigacao: |
      Comunicar mudança para usuários, treinar administradores, documentar novo comportamento.

  - risco: "Multi-tenancy com leak de dados entre clientes"
    impacto: "alto"
    probabilidade: "baixa"
    mitigacao: |
      Testes rigorosos de isolamento, code review focado em validação de ClienteId, auditoria de acesso.

# ==============================================================================
# RASTREABILIDADE (Legado → Moderno)
# ==============================================================================

rastreabilidade:
  - elemento_legado: "Tela Status_Ativo.aspx"
    referencia_rf: "RN-CAD-104-01, RN-CAD-104-02"
    referencia_uc: "UC01, UC02"
    status: "migrado"

  - elemento_legado: "Tela Prioridades.aspx"
    referencia_rf: "RN-CAD-104-01, RN-CAD-104-09"
    referencia_uc: "UC01, UC02"
    status: "migrado"

  - elemento_legado: "Webservice StatusService.asmx - ListarStatusAtivo()"
    referencia_rf: "Seção 11 (Endpoints)"
    referencia_uc: "UC00"
    status: "migrado"

  - elemento_legado: "Webservice StatusService.asmx - CriarStatus()"
    referencia_rf: "RN-CAD-104-01"
    referencia_uc: "UC01"
    status: "migrado"

  - elemento_legado: "Webservice StatusService.asmx - DeletarStatus()"
    referencia_rf: "RN-CAD-104-03, RN-CAD-104-04"
    referencia_uc: "UC03"
    status: "migrado"

  - elemento_legado: "Tabela Ativo_Status"
    referencia_rf: "Seção 12 (Modelo de Dados)"
    referencia_uc: null
    status: "migrado"

  - elemento_legado: "Tabela Solicitacao_Status"
    referencia_rf: "Seção 12 (Modelo de Dados)"
    referencia_uc: null
    status: "migrado"

  - elemento_legado: "Tabela Prioridade"
    referencia_rf: "Seção 12 (Modelo de Dados), RN-CAD-104-09"
    referencia_uc: null
    status: "migrado"

  - elemento_legado: "Stored Procedure pa_Ativo_Status_Listar"
    referencia_rf: "Seção 11 (Endpoints)"
    referencia_uc: "UC00"
    status: "substituido"

  - elemento_legado: "Stored Procedure pa_Prioridade_Listar"
    referencia_rf: "Seção 11 (Endpoints)"
    referencia_uc: "UC00"
    status: "substituido"

# ==============================================================================
# CHANGELOG
# ==============================================================================

changelog:
  - versao: "2.0"
    data: "2025-12-31"
    descricao: "Documentação completa de referência ao legado com rastreabilidade total e destinos obrigatórios preenchidos"
    autor: "Agência ALC - alc.dev.br"
