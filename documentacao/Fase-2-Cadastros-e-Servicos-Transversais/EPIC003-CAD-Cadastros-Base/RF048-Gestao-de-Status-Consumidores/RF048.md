# RF-048: Gestão de Status de Consumidores

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC003-CAD - Cadastros Base
**Fase**: Fase 2 - Cadastros e Serviços Transversais

---

## 1. OBJETIVO DO REQUISITO

Descrever de forma clara, objetiva e verificável o comportamento esperado do requisito funcional **RF-048**, servindo como **contrato oficial** entre negócio, desenvolvimento, testes e agentes de IA.

Este RF especifica o sistema de gerenciamento de ciclo de vida de consumidores através de estados bem definidos (Ativo, Inativo, Bloqueado, Suspenso, Pendente), controlando transições entre estados, aplicando políticas automáticas conforme status, mantendo histórico completo de mudanças, e integrando com processos de faturamento, auditoria e controle de acessos.

O sistema deve garantir que apenas consumidores com status apropriado tenham acesso a recursos, que custos sejam alocados corretamente conforme status operacional, e que exista rastreabilidade completa de todas as transições de status para conformidade regulatória (LGPD, SOX, ISO 27001).

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [ ] CRUD completo de configurações de status de consumidores
- [ ] Motor de workflow de transições de status com validação de matriz de transições permitidas
- [ ] Registro de histórico completo de mudanças de status (7 anos para LGPD)
- [ ] Aplicação automática de políticas conforme status do consumidor
- [ ] Notificações automáticas multi-canal (e-mail, SMS, in-app) para stakeholders
- [ ] Processamento em lote de mudanças de status (até 1.000 registros)
- [ ] Dashboard de status com indicadores visuais e tempo real
- [ ] Aprovação multi-nível para transições críticas (Bloqueado→Ativo, Inativo→Ativo)
- [ ] Integração com módulo de faturamento para suspensão/reativação de cobrança
- [ ] Job noturno de bloqueio automático por inadimplência
- [ ] Relatórios gerenciais de ciclo de vida e transições
- [ ] Interface Angular 19 com timeline visual de histórico de transições
- [ ] Controle de acesso RBAC com permissões granulares
- [ ] Isolamento multi-tenant por Id_Fornecedor
- [ ] Auditoria completa de todas as operações sobre status

### 2.2 Fora do escopo (não objetivos)

- Gerenciamento de usuários e perfis (RF006)
- Gerenciamento de permissões (RF006)
- Gerenciamento de políticas de uso (RF049)
- Gerenciamento de consumidores (RF052)
- Faturamento detalhado (RF026)
- Auditoria de bilhetes (RF034, RF035)
- Gestão de contratos (RF023)
- Inventário de ativos (RF025)
- Layout, UX ou identidade visual específica
- Tecnologia, framework ou linguagem de implementação
- Estratégia de deploy ou infraestrutura

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-----|---------|
| Status de Consumidor | Estado operacional do consumidor que controla acesso, faturamento e aplicação de políticas |
| Consumidor | Entidade que consome recursos do sistema (colaborador, departamento, dispositivo) |
| Transição de Status | Mudança de um estado para outro seguindo regras de workflow |
| Matriz de Transições | Conjunto de transições permitidas e proibidas entre estados |
| Workflow de Status | Fluxo controlado de mudanças de status com validações e aprovações |
| Histórico de Transições | Registro imutável de todas as mudanças de status para auditoria |
| Aprovação Multi-Nível | Processo que requer aprovação de múltiplos aprovadores antes de aplicar transição |
| Política por Status | Conjunto de regras aplicadas automaticamente conforme status do consumidor |
| Processamento em Lote | Mudança de status de múltiplos consumidores simultaneamente via job assíncrono |
| Bloqueio por Inadimplência | Bloqueio automático de consumidor com faturas vencidas >60 dias |
| Tenant | Fornecedor (cliente da plataforma) com isolamento de dados |
| Stakeholder | Usuário interessado em mudanças de status (gestor, financeiro, TI, consumidor) |

---

## 4. FUNCIONALIDADES COBERTAS

1. Criar configuração de status de consumidor
2. Atualizar configuração de status existente
3. Consultar status de consumidor por ID
4. Listar status de consumidores com filtros avançados
5. Mudar status de consumidor individual com validação de transição
6. Aprovar mudança de status pendente
7. Rejeitar mudança de status pendente
8. Processar mudanças de status em lote (assíncrono)
9. Consultar histórico completo de transições de um consumidor
10. Visualizar dashboard de status em tempo real
11. Gerar relatório de ciclo de vida de consumidores
12. Configurar políticas automáticas por status
13. Configurar notificações por tipo de transição
14. Executar job noturno de bloqueio por inadimplência
15. Reativar consumidores automaticamente após regularização

---

## 5. REGRAS DE NEGÓCIO

### RN-RF048-01 — Estados de Status Obrigatórios

**Descrição**: Sistema deve implementar estados de status padrão não desativáveis.

**Justificativa**: Garantir consistência operacional e conformidade com processos de negócio.

**Critério de Aceite**:
- Sistema possui 5 estados obrigatórios: Ativo, Inativo, Bloqueado, Suspenso, Pendente
- Estados obrigatórios não podem ser desativados ou removidos
- Estados podem ter configurações customizadas de permissões, limites e restrições
- Estados adicionais customizados podem ser criados conforme necessidade do negócio
- Campo ausente de status → rejeição HTTP 400
- Status inválido (não cadastrado) → rejeição HTTP 400

---

### RN-RF048-02 — Workflow de Transições Controladas

**Descrição**: Nem todas as transições de status são permitidas diretamente. Sistema deve validar matriz de transições.

**Justificativa**: Garantir integridade do ciclo de vida e prevenir transições inválidas.

**Critério de Aceite**:
- Transições permitidas:
  - Pendente → Ativo
  - Ativo → Inativo
  - Ativo → Bloqueado
  - Ativo → Suspenso
  - Suspenso → Ativo
  - Bloqueado → Ativo (requer aprovação)
  - Inativo → Ativo (requer aprovação)
- Transições proibidas (ex: Pendente → Bloqueado) são rejeitadas com HTTP 400 e mensagem explicativa
- Perfis "Super Admin" podem forçar qualquer transição com justificativa obrigatória
- Sistema valida matriz antes de aplicar mudança → se inválida, rejeita
- Ausência de justificativa em transição forçada → rejeição HTTP 400

---

### RN-RF048-03 — Aprovação Multi-Nível para Transições Críticas

**Descrição**: Transições críticas requerem aprovação de múltiplos níveis gerenciais antes de serem aplicadas.

**Justificativa**: Controle de transições com impacto financeiro ou operacional alto.

**Critério de Aceite**:
- Reativação de Bloqueado/Inativo → Ativo requer aprovação de Gestor + Financeiro
- Bloqueio de Ativo → Bloqueado requer aprovação de Gestor
- Suspensão pode ser automática (por política) ou manual (sem aprovação)
- Sistema cria registro de solicitação de aprovação ao receber comando de transição crítica
- Sistema aguarda aprovação de todos os aprovadores antes de aplicar transição
- Super Admin pode aprovar imediatamente com justificativa obrigatória (situações emergenciais)
- Aprovação sem justificativa → rejeição HTTP 400
- Solicitação expirada (>30 dias) → cancelada automaticamente

---

### RN-RF048-04 — Histórico Completo de Transições (LGPD)

**Descrição**: Todas as mudanças de status devem ser registradas em histórico imutável para auditoria e conformidade regulatória.

**Justificativa**: Conformidade com LGPD, SOX, ISO 27001 e rastreabilidade de operações.

**Critério de Aceite**:
- Sistema registra para cada mudança: Data/Hora, Usuário Responsável, Status Anterior, Status Novo, Justificativa, IP Origem, Aprovadores (se aplicável)
- Retenção de histórico: 7 anos conforme LGPD
- Dados de histórico não podem ser alterados (apenas inseridos)
- Histórico pode ser consultado por usuários com permissão adequada
- Tentativa de alteração de histórico → rejeição HTTP 403
- Cada mudança de status gera registro automático na tabela StatusConsumidorHistorico

---

### RN-RF048-05 — Aplicação Automática de Políticas por Status

**Descrição**: Cada status tem conjunto de políticas que são aplicadas/removidas automaticamente ao mudar status.

**Justificativa**: Automatizar aplicação de regras de negócio e garantir consistência operacional.

**Critério de Aceite**:
- **Ativo**: Todas as políticas normais aplicadas, acesso completo, faturamento ativo
- **Suspenso**: Bloqueio de novas operações, mantém acesso consulta, faturamento parcial
- **Bloqueado**: Bloqueio total de operações e acesso, sem faturamento
- **Inativo**: Sem acesso, sem faturamento, dados preservados
- **Pendente**: Acesso limitado, sem faturamento, aguardando ativação
- Sistema aplica/remove políticas automaticamente ao confirmar mudança de status
- Políticas customizadas podem ser configuradas por fornecedor/departamento
- Falha ao aplicar política → rollback da mudança de status + HTTP 500

---

### RN-RF048-06 — Notificações Automáticas de Mudança de Status

**Descrição**: Stakeholders devem ser notificados automaticamente sobre mudanças de status relevantes.

**Justificativa**: Manter stakeholders informados e garantir ações tempestivas.

**Critério de Aceite**:
- Notificar: Consumidor afetado (se aplicável), Gestor responsável, Financeiro (para Bloqueado/Inativo), TI (para bloqueios técnicos)
- Canais: E-mail, SMS (transições críticas), Notificação in-app
- Conteúdo da notificação: Status anterior, Status novo, Motivo, Impactos, Próximas ações
- Sistema envia notificações de forma assíncrona via Central de E-mails (RF067)
- Notificações podem ser desabilitadas para operações em lote (com confirmação explícita)
- Falha no envio de notificação não impede mudança de status (notificação é registrada para retry)

---

### RN-RF048-07 — Processamento em Lote de Mudanças de Status

**Descrição**: Permitir mudança de status de múltiplos consumidores simultaneamente de forma assíncrona.

**Justificativa**: Eficiência operacional para mudanças em massa.

**Critério de Aceite**:
- Operação em lote valida transição permitida para cada consumidor individualmente
- Processamento ocorre de forma assíncrona via job em background (Hangfire)
- Sistema gera relatório consolidado de sucesso/falha ao final do job
- Rollback em caso de falha crítica (>50% de falhas)
- Limite máximo: 1.000 registros por lote
- Lotes com >1.000 registros são divididos automaticamente em múltiplos jobs
- Tentativa de lote vazio → rejeição HTTP 400
- Sistema retorna ID do job para consulta de progresso

---

### RN-RF048-08 — Cálculo Automático de Métricas de Ciclo de Vida

**Descrição**: Sistema deve calcular automaticamente métricas de tempo em cada status para análise gerencial.

**Justificativa**: Fornecer insights sobre ciclo de vida de consumidores e identificar padrões.

**Critério de Aceite**:
- Métricas calculadas: Tempo Total Ativo, Tempo Total Inativo, Tempo Total Bloqueado, Tempo Médio Entre Mudanças, Número Total de Transições, Taxa de Reativação (%)
- Cálculo baseado em soma de períodos em cada status extraídos do histórico
- Métricas são recalculadas automaticamente a cada mudança de status
- Métricas históricas (>1 ano) podem ser calculadas sob demanda via job noturno para performance
- Métricas disponíveis via endpoint GET /api/gestao/status-consumidores/{id}/metricas

---

### RN-RF048-09 — Bloqueio Automático por Inadimplência

**Descrição**: Consumidores com faturas vencidas devem ser bloqueados automaticamente seguindo escalonamento de prazos.

**Justificativa**: Garantir conformidade financeira e reduzir inadimplência.

**Critério de Aceite**:
- Job diário executa às 02:00 AM verificando faturas vencidas
- Escalonamento:
  - Faturas vencidas >30 dias → Notifica Gestor (alerta)
  - Faturas vencidas >45 dias → Suspende consumidor automaticamente
  - Faturas vencidas >60 dias → Bloqueia consumidor automaticamente
- Desbloqueio automático ao regularizar pagamento (integração com RF026)
- Consumidores VIP ou com acordo especial têm prazos customizados configuráveis
- Job gera relatório de bloqueios executados

---

### RN-RF048-10 — Reativação Automática Pós-Regularização

**Descrição**: Consumidores devem ser reativados automaticamente ao regularizar pendências financeiras.

**Justificativa**: Automatizar reativação e melhorar experiência do consumidor.

**Critério de Aceite**:
- Sistema monitora eventos de pagamento via integração com módulo de faturamento (RF026)
- Ao receber evento de regularização de débito:
  - Sistema verifica se motivo de bloqueio foi resolvido
  - Se SIM: Cria solicitação de reativação automática
  - Notifica aprovadores conforme RN-RF048-03
  - Reativa após aprovação (ou automaticamente se configurado)
- Bloqueios por outros motivos (fraude, segurança) não são reativados automaticamente
- Reativação automática sem resolução de débito → bloqueio HTTP 400

---

### RN-RF048-11 — Integração com Faturamento (Suspensão de Cobrança)

**Descrição**: Status deve controlar se consumidor é faturado ou não, sincronizando com módulo de faturamento.

**Justificativa**: Garantir consistência entre status operacional e faturamento.

**Critério de Aceite**:
- Status com faturamento: Ativo (100%), Suspenso (parcial configurável)
- Status sem faturamento: Inativo, Bloqueado, Pendente
- Mudança de status gera evento para módulo de faturamento (RF026) ajustar próxima cobrança
- Faturamento de períodos já processados não é afetado retroativamente
- Integração via eventos de domínio assíncronos

---

### RN-RF048-12 — Dashboard de Status com Indicadores Visuais

**Descrição**: Interface deve exibir visualmente status de consumidores em tempo real com indicadores semânticos.

**Justificativa**: Facilitar monitoramento operacional e tomada de decisão.

**Critério de Aceite**:
- Dashboard exibe: Total de consumidores por status (cards coloridos), Gráfico de evolução temporal, Lista de consumidores com status crítico, Timeline de últimas transições
- Cores padrão: Verde (Ativo), Amarelo (Suspenso), Vermelho (Bloqueado), Cinza (Inativo), Azul (Pendente)
- Dashboard atualiza em tempo real via SignalR
- Dados históricos (>3 meses) carregam sob demanda para performance
- Dashboard respeita permissões do usuário logado

---

### RN-RF048-13 — Auditoria de Todas as Operações de Status

**Descrição**: Todas as operações sobre status devem ser auditadas automaticamente.

**Justificativa**: Conformidade regulatória e rastreabilidade de operações.

**Critério de Aceite**:
- Operações auditadas: Mudança de status, Visualização de histórico, Aprovação/Rejeição de solicitações, Processamento de lotes
- Dados auditados: Usuário, Data/Hora, Ação, Dados antes/depois, IP, Justificativa
- Auditoria via AuditInterceptor automático do Entity Framework Core
- Operações de leitura simples (listagem) não geram auditoria detalhada (apenas log)
- Retenção de auditoria: 7 anos

---

### RN-RF048-14 — Multi-Tenancy com Isolamento de Status

**Descrição**: Status de consumidores devem ser isolados por fornecedor (tenant) com query filter automático.

**Justificativa**: Garantir isolamento de dados entre fornecedores.

**Critério de Aceite**:
- Cada fornecedor tem configurações próprias de status
- Histórico de transições isolado automaticamente por Id_Fornecedor
- Relatórios filtrados automaticamente pelo fornecedor do usuário logado
- Entity Framework aplica Query Filter automático em todas as queries
- Usuários "Super Admin" podem visualizar status cross-tenant para auditoria (com permissão explícita)
- Tentativa de acesso cross-tenant sem permissão → HTTP 403

---

### RN-RF048-15 — Validação de Permissões RBAC

**Descrição**: Operações sobre status devem respeitar permissões granulares por perfil via RBAC.

**Justificativa**: Controle de acesso e segregação de funções.

**Critério de Aceite**:
- Permissões obrigatórias:
  - GESTAO.STATUS_CONSUMIDORES.VIEW → visualizar status
  - GESTAO.STATUS_CONSUMIDORES.CHANGE → mudar status
  - GESTAO.STATUS_CONSUMIDORES.APPROVE → aprovar mudanças
  - GESTAO.STATUS_CONSUMIDORES.ADMIN → gerenciar configurações
- Endpoints validam permissões via RequireAuthorization
- Commands validam permissões via Authorize(Roles)
- Operação sem permissão → HTTP 403
- Nenhuma permissão pode ser bypassada (obrigatório para segurança)

---

## 6. ESTADOS DA ENTIDADE

| Estado | Descrição | Acesso | Faturamento | Transições Permitidas |
|------|-----------|---------|-------------|----------------------|
| Pendente | Criado, aguardando ativação | Limitado | Não | → Ativo |
| Ativo | Operacional normal | Completo | Sim (100%) | → Inativo, Bloqueado, Suspenso |
| Suspenso | Bloqueio temporário de operações | Consulta apenas | Parcial | → Ativo |
| Bloqueado | Bloqueio total por inadimplência ou segurança | Nenhum | Não | → Ativo (requer aprovação) |
| Inativo | Desativado permanentemente | Nenhum | Não | → Ativo (requer aprovação) |

### Transições Permitidas

| De | Para | Requer Aprovação | Justificativa Obrigatória |
|---|---|---|---|
| Pendente | Ativo | Não | Não |
| Ativo | Inativo | Não | Sim |
| Ativo | Bloqueado | Sim (Gestor) | Sim |
| Ativo | Suspenso | Não | Sim |
| Suspenso | Ativo | Não | Não |
| Bloqueado | Ativo | Sim (Gestor + Financeiro) | Sim |
| Inativo | Ativo | Sim (Gestor + Financeiro) | Sim |

### Transições Proibidas

Qualquer transição não listada acima é considerada proibida e deve ser rejeitada com HTTP 400.

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre | Dados do Evento |
|------|--------------|----------------|
| StatusConsumidorCriado | Após criação de configuração de status | Id, Status, Id_Fornecedor, DataCriacao |
| StatusConsumidorAlterado | Após mudança de status de consumidor | Id_Consumidor, StatusAnterior, StatusNovo, Usuario, Justificativa |
| TransicaoStatusAprovada | Após aprovação de mudança crítica | Id_Solicitacao, Aprovador, DataAprovacao |
| TransicaoStatusRejeitada | Após rejeição de mudança crítica | Id_Solicitacao, Aprovador, MotivoRejeicao |
| LoteStatusProcessado | Após conclusão de processamento em lote | Id_Job, TotalProcessado, Sucessos, Falhas |
| BloqueioAutomaticoExecutado | Após job de bloqueio por inadimplência | TotalBloqueados, DataExecucao |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant (Id_Fornecedor)
- Nenhuma regra de negócio pode ser ignorada ou bypassada
- Erros devem ser previsíveis, rastreáveis e com mensagens claras
- Auditoria deve registrar quem, quando e o que mudou em cada operação
- Histórico de transições deve ser imutável e não pode ser apagado
- Transições de status devem seguir matriz de workflow sem exceções (exceto Super Admin com justificativa)
- Notificações não podem bloquear mudança de status (assíncronas)
- Dashboard deve atualizar em tempo real via SignalR
- Todos os endpoints devem validar permissões RBAC
- Performance: mudança de status individual ≤ 300ms (P95)
- Performance: processamento em lote de 1.000 registros ≤ 5 minutos

---

## 9. SEGURANÇA

- Autenticação JWT Bearer Token obrigatória em todos os endpoints
- Validação de entrada obrigatória em todos os commands (FluentValidation)
- Proteção contra injeção (SQL, XSS, CSRF) via validação e sanitização
- Controle de permissões RBAC granular por operação
- Isolamento multi-tenant por Id_Fornecedor via Query Filter
- Criptografia de dados sensíveis em repouso (AES-256) e em trânsito (TLS 1.3)
- Rate Limiting: máximo 100 requests/minuto por usuário
- Histórico de transições imutável (append-only)
- Auditoria completa de todas as operações com retenção de 7 anos
- Justificativa obrigatória para transições críticas e forçadas
- Super Admin pode forçar transições com justificativa obrigatória (registrada em auditoria)

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF048.md** - Casos de Uso (UC00-UC04 + casos específicos de workflow)
- **MD-RF048.yaml** - Modelo de Dados (StatusConsumidor, StatusConsumidorHistorico, ConfiguracaoStatus)
- **MT-RF048.yaml** - Massas de Teste (cenários de transições válidas e inválidas)
- **TC-RF048.yaml** - Casos de Teste (backend, frontend, segurança, E2E)
- **WF-RF048.md** - Wireframes (dashboard, timeline, formulário de mudança de status)

---

## 11. RASTREABILIDADE

| Artefato | Status | Observações |
|--------|-------|-------------|
| Casos de Uso (UC-RF048.md) | Obrigatório | Incluir UC para cada funcionalidade coberta |
| Modelo de Dados (MD-RF048.yaml) | Obrigatório | Incluir entidades StatusConsumidor, StatusConsumidorHistorico, ConfiguracaoStatus |
| Massas de Teste (MT-RF048.yaml) | Obrigatório | Incluir cenários de todas as transições |
| Casos de Teste (TC-RF048.yaml) | Obrigatório | Incluir testes de backend, frontend, segurança, E2E |
| Wireframes (WF-RF048.md) | Obrigatório | Incluir dashboard, timeline, formulários |
| Referência ao Legado (RL-RF048.md) | Obrigatório | Documentar memória técnica do legado |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|------|------|----------|------|
| 2.0 | 2025-12-30 | Migração para template v2.0 - Separação RF/RL completa conforme CONTRATO-RF-PARA-RL | Agência ALC - alc.dev.br |
| 1.0 | 2025-12-18 | Versão inicial - Especificação completa de Gestão de Status Consumidores | IControlIT Architect Agent |
