# =============================================
# RF048 - Gestão de Status de Consumidores
# Versão: 2.0
# Data: 2025-12-30
# Autor: Agência ALC - alc.dev.br
# =============================================

rf:
  id: "RF048"
  nome: "Gestão de Status de Consumidores"
  versao: "2.0"
  data: "2025-12-30"
  fase: "Fase 2 - Cadastros e Serviços Transversais"
  epic: "EPIC003-CAD"
  status: "em_desenvolvimento"

descricao:
  objetivo: |
    Especificar o sistema de gerenciamento de ciclo de vida de consumidores através de estados bem definidos (Ativo, Inativo, Bloqueado, Suspenso, Pendente), controlando transições entre estados, aplicando políticas automáticas conforme status, mantendo histórico completo de mudanças, e integrando com processos de faturamento, auditoria e controle de acessos.
  problema_resolvido: |
    Garantir que apenas consumidores com status apropriado tenham acesso a recursos, que custos sejam alocados corretamente conforme status operacional, e que exista rastreabilidade completa de todas as transições de status para conformidade regulatória (LGPD, SOX, ISO 27001).
  publico_afetado: |
    Gestores, área financeira, TI, consumidores, auditores, usuários do sistema.

escopo:
  incluso:
    - "CRUD completo de configurações de status de consumidores"
    - "Motor de workflow de transições de status com validação de matriz de transições permitidas"
    - "Registro de histórico completo de mudanças de status (7 anos para LGPD)"
    - "Aplicação automática de políticas conforme status do consumidor"
    - "Notificações automáticas multi-canal (e-mail, SMS, in-app) para stakeholders"
    - "Processamento em lote de mudanças de status (até 1.000 registros)"
    - "Dashboard de status com indicadores visuais e tempo real"
    - "Aprovação multi-nível para transições críticas (Bloqueado→Ativo, Inativo→Ativo)"
    - "Integração com módulo de faturamento para suspensão/reativação de cobrança"
    - "Job noturno de bloqueio automático por inadimplência"
    - "Relatórios gerenciais de ciclo de vida e transições"
    - "Interface Angular 19 com timeline visual de histórico de transições"
    - "Controle de acesso RBAC com permissões granulares"
    - "Isolamento multi-tenant por Id_Fornecedor"
    - "Auditoria completa de todas as operações sobre status"
  fora:
    - "Gerenciamento de usuários e perfis (RF006)"
    - "Gerenciamento de permissões (RF006)"
    - "Gerenciamento de políticas de uso (RF049)"
    - "Gerenciamento de consumidores (RF052)"
    - "Faturamento detalhado (RF026)"
    - "Auditoria de bilhetes (RF034, RF035)"
    - "Gestão de contratos (RF023)"
    - "Inventário de ativos (RF025)"
    - "Layout, UX ou identidade visual específica"
    - "Tecnologia, framework ou linguagem de implementação"
    - "Estratégia de deploy ou infraestrutura"

entidades:
  - nome: "StatusConsumidor"
    descricao: "Entidade que representa o status atual de um consumidor"
    multi_tenant: true
    soft_delete: true
    auditoria: true

  - nome: "StatusConsumidorHistorico"
    descricao: "Histórico imutável de todas as mudanças de status (7 anos LGPD)"
    multi_tenant: true
    soft_delete: false
    auditoria: true

  - nome: "ConfiguracaoStatus"
    descricao: "Configurações de comportamento por tipo de status"
    multi_tenant: true
    soft_delete: true
    auditoria: true

  - nome: "SolicitacaoMudancaStatus"
    descricao: "Solicitações de mudança de status pendentes de aprovação"
    multi_tenant: true
    soft_delete: true
    auditoria: true

regras_negocio:
  - id: "RN-RF048-01"
    descricao: "Estados de Status Obrigatórios - Sistema deve implementar estados de status padrão não desativáveis"
    tipo: "validacao"
    campos_afetados: ["Status"]
    obrigatorio: true

  - id: "RN-RF048-02"
    descricao: "Workflow de Transições Controladas - Nem todas as transições de status são permitidas diretamente, validar matriz"
    tipo: "regra_negocio"
    campos_afetados: ["StatusAnterior", "StatusNovo"]
    obrigatorio: true

  - id: "RN-RF048-03"
    descricao: "Aprovação Multi-Nível para Transições Críticas - Transições críticas requerem aprovação de múltiplos níveis"
    tipo: "regra_negocio"
    campos_afetados: ["StatusAnterior", "StatusNovo", "Aprovadores"]
    obrigatorio: true

  - id: "RN-RF048-04"
    descricao: "Histórico Completo de Transições (LGPD) - Todas as mudanças registradas em histórico imutável (7 anos)"
    tipo: "seguranca"
    campos_afetados: ["StatusConsumidorHistorico"]
    obrigatorio: true

  - id: "RN-RF048-05"
    descricao: "Aplicação Automática de Políticas por Status - Cada status tem políticas aplicadas automaticamente"
    tipo: "regra_negocio"
    campos_afetados: ["Status", "Politicas"]
    obrigatorio: true

  - id: "RN-RF048-06"
    descricao: "Notificações Automáticas de Mudança de Status - Stakeholders notificados automaticamente"
    tipo: "regra_negocio"
    campos_afetados: ["Status", "Notificacoes"]
    obrigatorio: true

  - id: "RN-RF048-07"
    descricao: "Processamento em Lote de Mudanças de Status - Mudança de múltiplos consumidores assíncronamente (até 1.000)"
    tipo: "regra_negocio"
    campos_afetados: ["Lote"]
    obrigatorio: true

  - id: "RN-RF048-08"
    descricao: "Cálculo Automático de Métricas de Ciclo de Vida - Métricas de tempo em cada status calculadas automaticamente"
    tipo: "regra_negocio"
    campos_afetados: ["Metricas"]
    obrigatorio: true

  - id: "RN-RF048-09"
    descricao: "Bloqueio Automático por Inadimplência - Bloqueio automático por faturas vencidas (>30, >45, >60 dias)"
    tipo: "regra_negocio"
    campos_afetados: ["Status", "Faturas"]
    obrigatorio: true

  - id: "RN-RF048-10"
    descricao: "Reativação Automática Pós-Regularização - Reativação automática ao regularizar débito"
    tipo: "regra_negocio"
    campos_afetados: ["Status", "Pagamento"]
    obrigatorio: true

  - id: "RN-RF048-11"
    descricao: "Integração com Faturamento (Suspensão de Cobrança) - Status controla se consumidor é faturado"
    tipo: "regra_negocio"
    campos_afetados: ["Status", "Faturamento"]
    obrigatorio: true

  - id: "RN-RF048-12"
    descricao: "Dashboard de Status com Indicadores Visuais - Interface visual com status em tempo real via SignalR"
    tipo: "regra_negocio"
    campos_afetados: ["Dashboard"]
    obrigatorio: true

  - id: "RN-RF048-13"
    descricao: "Auditoria de Todas as Operações de Status - Todas operações auditadas automaticamente"
    tipo: "seguranca"
    campos_afetados: ["Auditoria"]
    obrigatorio: true

  - id: "RN-RF048-14"
    descricao: "Multi-Tenancy com Isolamento de Status - Isolamento por Id_Fornecedor via Query Filter"
    tipo: "seguranca"
    campos_afetados: ["Id_Fornecedor"]
    obrigatorio: true

  - id: "RN-RF048-15"
    descricao: "Validação de Permissões RBAC - Permissões granulares por perfil (VIEW, CHANGE, APPROVE, ADMIN)"
    tipo: "seguranca"
    campos_afetados: ["Permissoes"]
    obrigatorio: true

estados:
  - id: "Pendente"
    descricao: "Criado, aguardando ativação"
    acesso: "Limitado"
    faturamento: false

  - id: "Ativo"
    descricao: "Operacional normal"
    acesso: "Completo"
    faturamento: true

  - id: "Suspenso"
    descricao: "Bloqueio temporário de operações"
    acesso: "Consulta apenas"
    faturamento: "parcial"

  - id: "Bloqueado"
    descricao: "Bloqueio total por inadimplência ou segurança"
    acesso: "Nenhum"
    faturamento: false

  - id: "Inativo"
    descricao: "Desativado permanentemente"
    acesso: "Nenhum"
    faturamento: false

transicoes:
  permitidas:
    - de: "Pendente"
      para: "Ativo"
      requer_aprovacao: false
      justificativa_obrigatoria: false

    - de: "Ativo"
      para: "Inativo"
      requer_aprovacao: false
      justificativa_obrigatoria: true

    - de: "Ativo"
      para: "Bloqueado"
      requer_aprovacao: true
      aprovadores: ["Gestor"]
      justificativa_obrigatoria: true

    - de: "Ativo"
      para: "Suspenso"
      requer_aprovacao: false
      justificativa_obrigatoria: true

    - de: "Suspenso"
      para: "Ativo"
      requer_aprovacao: false
      justificativa_obrigatoria: false

    - de: "Bloqueado"
      para: "Ativo"
      requer_aprovacao: true
      aprovadores: ["Gestor", "Financeiro"]
      justificativa_obrigatoria: true

    - de: "Inativo"
      para: "Ativo"
      requer_aprovacao: true
      aprovadores: ["Gestor", "Financeiro"]
      justificativa_obrigatoria: true

  proibidas:
    - de: "Pendente"
      para: "Bloqueado"
      motivo: "Consumidor pendente não pode ser bloqueado diretamente"

    - de: "Pendente"
      para: "Suspenso"
      motivo: "Consumidor pendente não pode ser suspenso"

    - de: "Pendente"
      para: "Inativo"
      motivo: "Consumidor pendente não pode ser inativado"

    - de: "Bloqueado"
      para: "Inativo"
      motivo: "Bloqueado deve ser reativado antes de inativar"

    - de: "Bloqueado"
      para: "Suspenso"
      motivo: "Bloqueado deve ser reativado antes de suspender"

    - de: "Inativo"
      para: "Bloqueado"
      motivo: "Inativo deve ser reativado antes de bloquear"

    - de: "Inativo"
      para: "Suspenso"
      motivo: "Inativo deve ser reativado antes de suspender"

permissoes:
  - codigo: "GESTAO.STATUS_CONSUMIDORES.VIEW"
    descricao: "Visualizar status de consumidores"

  - codigo: "GESTAO.STATUS_CONSUMIDORES.CHANGE"
    descricao: "Mudar status de consumidores"

  - codigo: "GESTAO.STATUS_CONSUMIDORES.APPROVE"
    descricao: "Aprovar mudanças de status críticas"

  - codigo: "GESTAO.STATUS_CONSUMIDORES.ADMIN"
    descricao: "Gerenciar configurações de status"

  - codigo: "GESTAO.STATUS_CONSUMIDORES.VIEW_HISTORY"
    descricao: "Consultar histórico de transições"

  - codigo: "GESTAO.STATUS_CONSUMIDORES.PROCESS_BATCH"
    descricao: "Processar mudanças em lote"

integracoes:
  internas:
    - "Autenticacao (JWT Bearer Token)"
    - "Multi-Tenancy (Id_Fornecedor)"
    - "Auditoria (AuditInterceptor)"
    - "Central de E-mails (RF067)"
    - "Central de Notificações (RF066)"
    - "Faturamento (RF026)"
    - "Políticas de Consumidores (RF049)"
    - "Consumidores (RF052)"
    - "Logs e Monitoramento (RF003)"

  externas:
    - sistema: "Hangfire"
      tipo: "Job Background"
      obrigatoria: true
      descricao: "Processamento assíncrono de lotes e jobs noturnos"

    - sistema: "SignalR"
      tipo: "Real-time Communication"
      obrigatoria: true
      descricao: "Atualizações em tempo real do dashboard"

eventos_dominio:
  - nome: "StatusConsumidorCriado"
    descricao: "Após criação de configuração de status"
    dados: ["Id", "Status", "Id_Fornecedor", "DataCriacao"]

  - nome: "StatusConsumidorAlterado"
    descricao: "Após mudança de status de consumidor"
    dados: ["Id_Consumidor", "StatusAnterior", "StatusNovo", "Usuario", "Justificativa"]

  - nome: "TransicaoStatusAprovada"
    descricao: "Após aprovação de mudança crítica"
    dados: ["Id_Solicitacao", "Aprovador", "DataAprovacao"]

  - nome: "TransicaoStatusRejeitada"
    descricao: "Após rejeição de mudança crítica"
    dados: ["Id_Solicitacao", "Aprovador", "MotivoRejeicao"]

  - nome: "LoteStatusProcessado"
    descricao: "Após conclusão de processamento em lote"
    dados: ["Id_Job", "TotalProcessado", "Sucessos", "Falhas"]

  - nome: "BloqueioAutomaticoExecutado"
    descricao: "Após job de bloqueio por inadimplência"
    dados: ["TotalBloqueados", "DataExecucao"]

seguranca:
  isolamento_tenant: true
  auditoria_obrigatoria: true
  soft_delete: true
  criptografia_em_repouso: "AES-256"
  criptografia_em_transito: "TLS 1.3"
  rate_limiting: "100 requests/minuto por usuário"
  historico_imutavel: true
  retencao_auditoria_anos: 7
  retencao_historico_anos: 7

rastreabilidade:
  ucs_esperados:
    - "UC00" # Listar status de consumidores
    - "UC01" # Criar configuração de status
    - "UC02" # Visualizar status de consumidor
    - "UC03" # Editar configuração de status
    - "UC04" # Inativar configuração de status
    - "UC05" # Mudar status de consumidor
    - "UC06" # Aprovar mudança de status
    - "UC07" # Rejeitar mudança de status
    - "UC08" # Processar lote de mudanças
    - "UC09" # Consultar histórico de transições
    - "UC10" # Visualizar dashboard de status
    - "UC11" # Gerar relatório de ciclo de vida

  artefatos_derivados:
    - nome: "UC-RF048.md"
      status: "obrigatorio"
      descricao: "Casos de Uso com fluxos detalhados"

    - nome: "MD-RF048.yaml"
      status: "obrigatorio"
      descricao: "Modelo de Dados com DDL completo"

    - nome: "MT-RF048.yaml"
      status: "obrigatorio"
      descricao: "Massas de Teste para todas as transições"

    - nome: "TC-RF048.yaml"
      status: "obrigatorio"
      descricao: "Casos de Teste (backend, frontend, segurança, E2E)"

    - nome: "WF-RF048.md"
      status: "obrigatorio"
      descricao: "Wireframes (dashboard, timeline, formulários)"

    - nome: "RL-RF048.md"
      status: "obrigatorio"
      descricao: "Referência ao Legado (memória técnica)"

catalog:
  crud:
    - id: "RF048-CRUD-01"
      title: "Criar configuração de status"
      required: true

    - id: "RF048-CRUD-02"
      title: "Listar status de consumidores"
      required: true

    - id: "RF048-CRUD-03"
      title: "Visualizar status de consumidor"
      required: true

    - id: "RF048-CRUD-04"
      title: "Atualizar configuração de status"
      required: true

    - id: "RF048-CRUD-05"
      title: "Inativar configuração de status"
      required: true

  funcionalidades_especificas:
    - id: "RF048-FUNC-01"
      title: "Mudar status de consumidor individual"
      required: true

    - id: "RF048-FUNC-02"
      title: "Aprovar mudança de status pendente"
      required: true

    - id: "RF048-FUNC-03"
      title: "Rejeitar mudança de status pendente"
      required: true

    - id: "RF048-FUNC-04"
      title: "Processar mudanças de status em lote"
      required: true

    - id: "RF048-FUNC-05"
      title: "Consultar histórico completo de transições"
      required: true

    - id: "RF048-FUNC-06"
      title: "Visualizar dashboard de status em tempo real"
      required: true

    - id: "RF048-FUNC-07"
      title: "Gerar relatório de ciclo de vida"
      required: true

    - id: "RF048-FUNC-08"
      title: "Configurar políticas automáticas por status"
      required: true

    - id: "RF048-FUNC-09"
      title: "Configurar notificações por tipo de transição"
      required: true

    - id: "RF048-FUNC-10"
      title: "Executar job noturno de bloqueio por inadimplência"
      required: true

    - id: "RF048-FUNC-11"
      title: "Reativar consumidores automaticamente após regularização"
      required: true

  validacoes:
    - id: "RF048-VAL-01"
      title: "Validar estados de status obrigatórios"
      required: true

    - id: "RF048-VAL-02"
      title: "Validar matriz de transições permitidas"
      required: true

    - id: "RF048-VAL-03"
      title: "Validar justificativa obrigatória"
      required: true

    - id: "RF048-VAL-04"
      title: "Validar aprovações multi-nível"
      required: true

    - id: "RF048-VAL-05"
      title: "Validar limite de lote (1.000 registros)"
      required: true

  seguranca:
    - id: "RF048-SEC-01"
      title: "Isolamento de tenant (Id_Fornecedor)"
      required: true

    - id: "RF048-SEC-02"
      title: "Permissões RBAC granulares"
      required: true

    - id: "RF048-SEC-03"
      title: "Auditoria completa de operações"
      required: true

    - id: "RF048-SEC-04"
      title: "Histórico imutável de transições"
      required: true

    - id: "RF048-SEC-05"
      title: "Rate limiting (100 req/min)"
      required: true

exclusions:
  documentacao_items: []

performance:
  mudanca_status_individual_p95: "300ms"
  processamento_lote_1000_registros: "5 minutos"
  carregamento_dashboard: "2 segundos"
  consulta_historico_7_anos: "1 segundo"
  atualizacao_metricas: "Tempo real"

historico:
  - versao: "2.0"
    data: "2025-12-30"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Migração para template v2.0 - Separação RF/RL completa conforme CONTRATO-RF-PARA-RL"

  - versao: "1.0"
    data: "2025-12-18"
    autor: "IControlIT Architect Agent"
    descricao: "Versão inicial - Especificação completa de Gestão de Status Consumidores"
