rf:
  id: RF086
  nome: Carga e Importação de Dados - Faturas, Consumo e Inventário
  versao: '2.0'
  data: '2025-12-31'
  fase: Fase 2 - Cadastros e Serviços Transversais
  epic: EPIC003-CAD-Cadastros-Base
  status: em_desenvolvimento
  versao_governanca: '2.0'
  data_migracao: '2025-12-31'
descricao:
  objetivo: Automatizar ingestão, validação, processamento e conciliação de faturas de operadoras de telecomunicações
  problema_resolvido: Eliminar processamento manual de faturas, detectar cobranças indevidas automaticamente e integrar com
    sistema de faturamento
  publico_afetado: Gestores de Telecom, Supervisores Financeiros, Administradores de Sistema, Auditores
escopo:
  incluso:
  - Importação de arquivos de fatura (Vivo, Claro, TIM, Oi)
  - Validação automática de formato, tamanho, encoding
  - Parsing específico por operadora
  - Extração e registro de CDRs individualizados
  - Conciliação automática fatura vs CDRs
  - Detecção de cobranças duplicadas
  - Engine de glosa configurável
  - Processamento assíncrono via Hangfire
  - Histórico completo de importações
  - Integração automática com RF032 (Notas Fiscais)
  - Relatórios de conciliação
  - Isolamento multi-tenant
  - Auditoria completa
  fora:
  - Interface de visualização específica
  - OCR de faturas PDF não estruturado
  - Integração direta com APIs de operadoras
  - Análise preditiva de consumo
  - Disputa automática com operadoras
  - Processamento de faturas de outros tipos (energia, água, gás)
entidades:
- nome: ImportacaoEntity
  descricao: Registro de cada importação com rastreamento completo
  multi_tenant: true
  soft_delete: true
  auditoria: true
  campos_principais:
  - NomeArquivoOriginal
  - ConteudoArquivoHash
  - Operadora
  - Status
  - QuantidadeItensExtraidos
- nome: FaturaEntity
  descricao: Dados estruturados da fatura importada
  multi_tenant: true
  soft_delete: true
  auditoria: true
- nome: CdrEntity
  descricao: Call Detail Record individual com rastreamento de origem
  multi_tenant: true
  soft_delete: true
  auditoria: true
- nome: GlosaEntity
  descricao: Registro de glosa com evidência e motivo
  multi_tenant: true
  soft_delete: true
  auditoria: true
- nome: ConciliacaoEntity
  descricao: Resultado de conciliação fatura vs CDRs
  multi_tenant: true
  soft_delete: false
  auditoria: true
- nome: RegraGlosaEntity
  descricao: Regra configurável de glosa automática
  multi_tenant: true
  soft_delete: true
  auditoria: true
regras_negocio:
- id: RN-CRG-086-001
  titulo: Validação de Formato de Arquivo
  descricao: Todo arquivo importado DEVE ser validado quanto a formato, encoding, tamanho máximo e conformidade com schema
    esperado da operadora específica
  tipo: validacao
  criticidade: CRÍTICA
  campos_afetados:
  - arquivo
  - operadora
  implementacao:
    backend: true
    frontend: true
    validacao_api: true
    validacao_ui: true
  validacao:
    tipo: formato_arquivo
    mensagem_erro: 'Arquivo inválido: {motivo}'
    http_code: 400
  criterios_aceite:
  - Arquivo > 50MB → rejeição
  - Extensão inválida → rejeição
  - Arquivo vazio → rejeição
  - Encoding inválido → rejeição
- id: RN-CRG-086-002
  titulo: Parser Específico por Operadora
  descricao: Cada operadora possui formato de fatura distinto. DEVE existir um parser específico que extrai corretamente os
    campos conforme layout esperado
  tipo: regra_negocio
  criticidade: CRÍTICA
  implementacao:
    backend: true
    frontend: false
    validacao_api: true
    validacao_ui: false
  validacao:
    tipo: parser_operadora
    mensagem_erro: 'Operadora não suportada: {operadora}'
    http_code: 400
- id: RN-CRG-086-003
  titulo: Registro de CDR com Rastreamento Completo
  descricao: Cada item de consumo importado DEVE ser registrado como um CDR individual com rastreamento de origem, data/hora,
    quantidade, valor e referência à fatura
  tipo: regra_negocio
  criticidade: ALTA
  implementacao:
    backend: true
    frontend: false
    validacao_api: false
    validacao_ui: false
- id: RN-CRG-086-004
  titulo: Validação de Integridade de Totalizações
  descricao: Totalizadores da fatura (subtotal, impostos, desconto, total) devem corresponder exatamente à soma dos itens
    individuais
  tipo: validacao
  criticidade: CRÍTICA
  campos_afetados:
  - ValorSubtotal
  - ValorImpostos
  - ValorDesconto
  - ValorTotal
  implementacao:
    backend: true
    frontend: false
    validacao_api: true
    validacao_ui: false
  validacao:
    tipo: integridade_valores
    mensagem_erro: 'Integridade de totalizações inválida: {detalhes}'
    http_code: 400
- id: RN-CRG-086-005
  titulo: Detecção de Cobranças Duplicadas
  descricao: DEVE ser detectado automaticamente quando o mesmo item aparece mais de uma vez
  tipo: regra_negocio
  criticidade: ALTA
  implementacao:
    backend: true
    frontend: false
    validacao_api: false
    validacao_ui: false
- id: RN-CRG-086-006
  titulo: Conciliação Automática Fatura vs CDRs
  descricao: Para cada fatura importada, DEVE ser executada automaticamente uma conciliação que compara valor total da fatura
    com soma dos CDRs extraídos
  tipo: regra_negocio
  criticidade: ALTA
  implementacao:
    backend: true
    frontend: false
    validacao_api: false
    validacao_ui: false
- id: RN-CRG-086-007
  titulo: Glosa Automática de Cobranças Indevidas
  descricao: DEVEM ser definidas regras configuráveis que identificam automaticamente cobranças indevidas
  tipo: regra_negocio
  criticidade: ALTA
  implementacao:
    backend: true
    frontend: false
    validacao_api: false
    validacao_ui: false
- id: RN-CRG-086-008
  titulo: Histórico Completo de Importações
  descricao: Cada importação DEVE criar um registro imutável de rastreamento
  tipo: auditoria
  criticidade: CRÍTICA
  implementacao:
    backend: true
    frontend: false
    validacao_api: false
    validacao_ui: false
- id: RN-CRG-086-009
  titulo: Integração com Módulo de Notas Fiscais (RF032)
  descricao: Dados validados DEVEM ser automaticamente enviados para RF032
  tipo: integracao
  criticidade: ALTA
  implementacao:
    backend: true
    frontend: false
    validacao_api: false
    validacao_ui: false
- id: RN-CRG-086-010
  titulo: Processamento Assíncrono via Hangfire
  descricao: Processamento DEVE ser assíncrono com retentativas automáticas
  tipo: infraestrutura
  criticidade: ALTA
  implementacao:
    backend: true
    frontend: false
    validacao_api: false
    validacao_ui: false
estados:
- id: EmAguardoUpload
  descricao: Aguardando upload de arquivo
- id: Validando
  descricao: Validando formato e integridade do arquivo
- id: Processando
  descricao: Processando importação (parsing, CDR, conciliação)
- id: ProcessadoComErro
  descricao: Processamento falhou com erro
- id: Concluida
  descricao: Processamento concluído com sucesso
- id: Rejeitada
  descricao: Importação rejeitada por validação
- id: AguardandoAprovacao
  descricao: Aguardando aprovação manual (divergências encontradas)
transicoes:
  permitidas:
  - de: EmAguardoUpload
    para: Validando
  - de: Validando
    para: Processando
  - de: Validando
    para: Rejeitada
  - de: Processando
    para: Concluida
  - de: Processando
    para: ProcessadoComErro
  - de: Processando
    para: AguardandoAprovacao
  - de: ProcessadoComErro
    para: Processando
  - de: AguardandoAprovacao
    para: Concluida
  proibidas:
  - de: Rejeitada
    para: Concluida
  - de: Concluida
    para: Processando
permissoes:
- codigo: carga:importacao:create
  descricao: Realizar upload de arquivo
  roles_autorizadas:
  - Gestor Telecom
  - Supervisor Financeiro
  - Admin
  endpoint: POST /api/carga/importacoes
- codigo: carga:importacao:read
  descricao: Visualizar histórico de importações
  roles_autorizadas:
  - Gestor Telecom
  - Supervisor Financeiro
  - Admin
  - Auditor
  endpoint: GET /api/carga/importacoes
- codigo: carga:importacao:update
  descricao: Reprocessar importação
  roles_autorizadas:
  - Gestor Telecom
  - Admin
  endpoint: POST /api/carga/importacoes/{id}/reprocessar
- codigo: carga:importacao:delete
  descricao: Remover registro de importação
  roles_autorizadas:
  - Admin
  endpoint: DELETE /api/carga/importacoes/{id}
- codigo: carga:glosa:read
  descricao: Visualizar glosas
  roles_autorizadas:
  - Gestor Telecom
  - Supervisor Financeiro
  - Admin
  endpoint: GET /api/carga/glosas
- codigo: carga:glosa:approve
  descricao: Aprovar glosas
  roles_autorizadas:
  - Supervisor Financeiro
  - Admin
  endpoint: PUT /api/carga/glosas/{id}/aprovar
- codigo: carga:glosa:reject
  descricao: Rejeitar glosas
  roles_autorizadas:
  - Supervisor Financeiro
  - Admin
  endpoint: PUT /api/carga/glosas/{id}/rejeitar
- codigo: carga:configuracao:update
  descricao: Alterar regras de glosa
  roles_autorizadas:
  - Admin
  endpoint: PUT /api/carga/configuracao/regras-glosa/{id}
- codigo: carga:relatorios:export
  descricao: Exportar relatórios
  roles_autorizadas:
  - Gestor Telecom
  - Supervisor Financeiro
  - Admin
  endpoint: GET /api/carga/relatorios/conciliacao/exportar
endpoints:
- method: POST
  route: /api/carga/importacoes
  descricao: Criar nova importação (upload)
  autenticacao: true
  authorization_policy: carga:importacao:create
  request_dto: FormFile + OperadoraEnum
  response_dto: ImportacaoDTO
- method: GET
  route: /api/carga/importacoes
  descricao: Listar importações com filtros
  autenticacao: true
  authorization_policy: carga:importacao:read
  request_dto: null
  response_dto: PaginatedListDto<ImportacaoDTO>
- method: GET
  route: /api/carga/importacoes/{id}
  descricao: Obter detalhes de importação
  autenticacao: true
  authorization_policy: carga:importacao:read
  request_dto: Guid id
  response_dto: ImportacaoDTO
- method: GET
  route: /api/carga/importacoes/{id}/status
  descricao: Obter status em tempo real
  autenticacao: true
  authorization_policy: carga:importacao:read
  request_dto: Guid id
  response_dto: StatusImportacaoDTO
- method: POST
  route: /api/carga/importacoes/{id}/reprocessar
  descricao: Reprocessar importação
  autenticacao: true
  authorization_policy: carga:importacao:update
  request_dto: Guid id
  response_dto: ImportacaoDTO
- method: DELETE
  route: /api/carga/importacoes/{id}
  descricao: Deletar importação (soft delete)
  autenticacao: true
  authorization_policy: carga:importacao:delete
  request_dto: Guid id
  response_dto: void
- method: GET
  route: /api/carga/importacoes/{id}/arquivo
  descricao: Download do arquivo original
  autenticacao: true
  authorization_policy: carga:importacao:read
  request_dto: Guid id
  response_dto: FileResult
- method: GET
  route: /api/carga/importacoes/{id}/cdrs
  descricao: Listar CDRs extraídos
  autenticacao: true
  authorization_policy: carga:importacao:read
  request_dto: Guid id
  response_dto: List<CdrDTO>
- method: GET
  route: /api/carga/glosas
  descricao: Listar glosas pendentes
  autenticacao: true
  authorization_policy: carga:glosa:read
  request_dto: null
  response_dto: PaginatedListDto<GlosaDTO>
- method: PUT
  route: /api/carga/glosas/{id}/aprovar
  descricao: Aprovar glosa
  autenticacao: true
  authorization_policy: carga:glosa:approve
  request_dto: Guid id
  response_dto: GlosaDTO
- method: PUT
  route: /api/carga/glosas/{id}/rejeitar
  descricao: Rejeitar glosa
  autenticacao: true
  authorization_policy: carga:glosa:reject
  request_dto: Guid id + motivo
  response_dto: GlosaDTO
integracoes:
  internas:
  - i18n (Transloco - pt-BR, en, es)
  - Multi-Tenancy (IdFornecedor)
  - Auditoria (Created, CreatedBy, LastModified, LastModifiedBy)
  - RBAC (Permissões baseadas em roles)
  - Central de Funcionalidades (Feature Flags)
  externas:
  - sistema: RF032 - Gestão de Notas Fiscais
    tipo: REST API
    obrigatoria: true
    descricao: Envio de dados validados de fatura para criação de NF
  - sistema: Hangfire
    tipo: Background Jobs
    obrigatoria: true
    descricao: Processamento assíncrono com retentativas
kpis:
- nome: Taxa de Sucesso de Importação
  descricao: Percentual de importações concluídas com sucesso
  meta: '>= 98%'
  medicao: (Importações Concluídas / Total Importações) × 100
  periodicidade: Diária
  log_obrigatorio: true
- nome: Tempo Médio de Processamento
  descricao: Tempo médio desde upload até conciliação concluída
  meta: <= 2 min
  medicao: Tempo desde upload até conciliação concluída
  periodicidade: Por importação
  log_obrigatorio: true
- nome: Taxa de Glosa Automática
  descricao: Percentual de itens glosados automaticamente
  meta: 5-15%
  medicao: (Itens Glosados / Total Itens Processados) × 100
  periodicidade: Mensal
  log_obrigatorio: true
- nome: Taxa de Conciliação Automática
  descricao: Percentual de faturas conciliadas sem divergência
  meta: '>= 95%'
  medicao: (Faturas Conciliadas Sem Divergência / Total) × 100
  periodicidade: Mensal
  log_obrigatorio: true
- nome: Taxa de Acurácia de Parsing
  descricao: Percentual de itens extraídos corretamente
  meta: '>= 99.5%'
  medicao: (Itens Extraídos Corretamente / Total) × 100
  periodicidade: Por importação
  log_obrigatorio: true
alertas:
- evento: Divergência Alta
  threshold: Diferença fatura vs CDR > R$ 1.000
  severidade: CRÍTICA
  canal_notificacao:
  - email
  - slack
  - sms
  acao: Requer aprovação manual, notificar supervisor
- evento: Glosa Excessiva
  threshold: Taxa de glosa > 30%
  severidade: ALTA
  canal_notificacao:
  - email
  - slack
  acao: Alertar supervisor, revisar regras
- evento: Falha Repetida
  threshold: 3 retentativas falhadas
  severidade: ALTA
  canal_notificacao:
  - email
  - slack
  acao: Notificar admin, criar ticket suporte
- evento: Fila de Hangfire Acumulada
  threshold: Jobs pendentes > 100
  severidade: CRÍTICA
  canal_notificacao:
  - email
  - slack
  - sms
  acao: Escalacionar para operações, aumentar workers
- evento: Indisponibilidade RF032
  threshold: Integração falha 3x consecutivas
  severidade: ALTA
  canal_notificacao:
  - email
  - slack
  acao: Marcar AguardandoAprovacao, notificar admin
seguranca:
  isolamento_tenant: true
  auditoria_obrigatoria: true
  soft_delete: true
  protecoes:
  - Validação de arquivo (tamanho, extensão, encoding, schema)
  - Hash SHA256 para detecção de tamperência e duplicação
  - Isolamento por IdFornecedor (Row-Level Security)
  - RBAC em operações críticas
  - Auditoria completa (usuário, timestamp, IP, antes/depois)
  - Retentativas com Exponential Backoff
  - Soft Delete obrigatório
  - SSL/TLS para transmissão
  - Validação de integridade em banco (constraints)
  - Detecção de anomalias (valores outliers)
rastreabilidade:
  ucs_esperados:
  - UC00-listar-importacoes
  - UC01-criar-importacao
  - UC02-visualizar-importacao
  - UC03-reprocessar-importacao
  - UC04-aprovar-glosa
  artefatos_derivados:
  - UC-RF086.md
  - MD-RF086.md
  - WF-RF086.md
  - user-stories.yaml
  - TC-RF086-BACKEND.yaml
  - TC-RF086-FRONTEND.yaml
  - TC-RF086-SEGURANCA.yaml
  - RL-RF086.md
  - RL-RF086.yaml
catalog:
  crud:
  - id: RF-CRUD-01
    title: Criar importação (upload)
    required: true
  - id: RF-CRUD-02
    title: Listar importações
    required: true
  - id: RF-CRUD-03
    title: Visualizar importação
    required: true
  - id: RF-CRUD-04
    title: Reprocessar importação
    required: true
  - id: RF-CRUD-05
    title: Excluir importação (soft delete)
    required: false
  validacoes:
  - id: RF-VAL-01
    title: Validar formato de arquivo
    required: true
  - id: RF-VAL-02
    title: Validar integridade de totalizações
    required: true
  - id: RF-VAL-03
    title: Detectar cobranças duplicadas
    required: true
  seguranca:
  - id: RF-SEC-01
    title: Isolamento de tenant
    required: true
  - id: RF-SEC-02
    title: Permissões RBAC
    required: true
  - id: RF-SEC-03
    title: Hash SHA256 de arquivo
    required: true
  - id: RF-SEC-04
    title: Auditoria completa
    required: true
  processamento:
  - id: RF-PROC-01
    title: Parsing por operadora
    required: true
  - id: RF-PROC-02
    title: Extração de CDRs
    required: true
  - id: RF-PROC-03
    title: Conciliação automática
    required: true
  - id: RF-PROC-04
    title: Glosa automática
    required: true
  - id: RF-PROC-05
    title: Processamento assíncrono (Hangfire)
    required: true
  integracao:
  - id: RF-INT-01
    title: Integração com RF032 (Notas Fiscais)
    required: true
exclusions:
  documentacao_items:
  - id: EX-RF086-01
    justificativa: OCR de faturas PDF não estruturado
  - id: EX-RF086-02
    justificativa: Integração direta com APIs de operadoras
  - id: EX-RF086-03
    justificativa: Análise preditiva de consumo
  - id: EX-RF086-04
    justificativa: Disputa automática com operadoras
  - id: EX-RF086-05
    justificativa: Processamento de faturas de outros tipos (energia, água, gás)
historico:
- versao: '2.0'
  data: '2025-12-31'
  autor: Agente de Migração de Documentação
  descricao: 'Migração v1.0 → v2.0: Separação RF/RL, estruturação YAML, sincronização com RF.md'
- versao: '1.0'
  data: '2025-12-28'
  autor: Claude Architect
  descricao: Versão inicial (continha mistura de legado)
