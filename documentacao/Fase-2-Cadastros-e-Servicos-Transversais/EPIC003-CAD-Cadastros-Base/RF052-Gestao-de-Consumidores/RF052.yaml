# =============================================
# RF052 - Gestão de Consumidores
# Versão: 2.0
# Data: 2025-12-30
# Autor: Agência ALC - alc.dev.br
# =============================================

rf:
  id: "RF052"
  nome: "Gestão de Consumidores"
  versao: "2.0"
  versao_governanca: "2.0"
  data: "2025-12-30"
  data_migracao: "2025-12-30"
  fase: "Fase 2 - Cadastros e Serviços Transversais"
  epic: "EPIC003-CAD"
  status: "aprovado"

descricao:
  objetivo: "Implementar sistema completo de gestão de consumidores (usuários finais de recursos de telecomunicações) com cadastro, hierarquia organizacional, alocação de ativos, controle de custos, perfis de uso, workflows automatizados e dashboard 360°."
  problema_resolvido: "Rastreabilidade completa de consumo e custos por consumidor, permitindo rateio preciso, identificação de desvios e otimização de gastos."
  publico_afetado: "Gestores, Financeiro, RH, Consumidores (colaboradores, prestadores, visitantes)"

escopo:
  incluso:
    - "CRUD completo de consumidores"
    - "Tipos de consumidores: Funcionário, Prestador, Departamento, Visitante"
    - "Dados pessoais e profissionais completos"
    - "Hierarquia organizacional (Departamento, Cargo, Gestor, Centro de Custo)"
    - "Alocação de ativos múltiplos (linhas, ramais, aparelhos)"
    - "Controle de custos individualizados com histórico de 7 anos"
    - "Perfis de uso e aplicação automática de políticas"
    - "Status: Ativo, Suspenso, Bloqueado, Inativo, Pendente"
    - "Workflow de onboarding automatizado (6 etapas)"
    - "Workflow de offboarding automatizado (5 etapas)"
    - "Integração com sistema de RH (sincronização diária)"
    - "Dashboard 360° com 7 abas"
    - "Comparação de consumo individual vs média do departamento"
    - "Relatórios de custos por consumidor/departamento"
    - "Importação/Exportação CSV/Excel"
    - "API REST completa com permissões RBAC"
    - "Auditoria completa de operações"
    - "Multi-tenancy com isolamento de dados"
  fora:
    - "Gerenciamento de departamentos (RF024)"
    - "Gerenciamento de cargos (RF018)"
    - "Gerenciamento de usuários do sistema (RF006)"
    - "Gestão de RH completa (folha, férias, benefícios)"
    - "Gerenciamento de ativos/aparelhos (RF025)"
    - "Gerenciamento de linhas móveis (RF050)"
    - "Faturamento detalhado (RF026)"

entidades:
  - nome: "Consumidor"
    descricao: "Entidade central representando usuário final de recursos de telecomunicações"
    multi_tenant: true
    soft_delete: true
    auditoria: true
  - nome: "ConsumidorCustoMensal"
    descricao: "Histórico de custos mensais por consumidor (7 anos)"
    multi_tenant: true
    soft_delete: false
    auditoria: true
  - nome: "ConsumidorHistoricoMovimentacao"
    descricao: "Histórico de mudanças de departamento/cargo/gestor"
    multi_tenant: true
    soft_delete: false
    auditoria: true
  - nome: "ConsumidorAtivo"
    descricao: "Associação consumidor-ativo (alocação de linhas, ramais, aparelhos)"
    multi_tenant: true
    soft_delete: false
    auditoria: true

# ==============================================================================
# REGRAS DE NEGÓCIO
# ==============================================================================

regras_negocio:
  - id: "RN-RF052-01"
    titulo: "Tipos de Consumidores Suportados"
    descricao: |
      Sistema deve suportar diferentes tipos de consumidores com características e campos obrigatórios específicos.
      Tipos: Funcionário (CLT), Prestador (temporário), Departamento (coletivo), Visitante (<30 dias).
    criticidade: "CRÍTICA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "tipo_enum"
      mensagem_erro: "Tipo de consumidor inválido ou campos obrigatórios ausentes para o tipo selecionado"
      http_code: 400

  - id: "RN-RF052-02"
    titulo: "Unicidade de Identificadores"
    descricao: |
      CPF, Matrícula e E-mail devem ser únicos dentro do mesmo tenant (fornecedor).
      Validação de formato obrigatória.
    criticidade: "CRÍTICA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "unicidade"
      mensagem_erro: "CPF/Matrícula/E-mail já cadastrado neste fornecedor"
      http_code: 400

  - id: "RN-RF052-03"
    titulo: "Hierarquia Organizacional Obrigatória"
    descricao: |
      Consumidores do tipo Funcionário devem estar vinculados a Departamento, Cargo, Gestor e Centro de Custo.
    criticidade: "ALTA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "campo_obrigatorio"
      mensagem_erro: "Funcionário requer Departamento, Cargo e Centro de Custo"
      http_code: 400

  - id: "RN-RF052-04"
    titulo: "Alocação de Ativos Múltiplos"
    descricao: |
      Consumidor pode ter múltiplos ativos (linhas, ramais, aparelhos) alocados simultaneamente.
      Sistema registra histórico de alocações/desalocações.
    criticidade: "ALTA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: false
    validacao:
      tipo: "regra_negocio"
      mensagem_erro: "Ativo não disponível para alocação (já alocado a outro consumidor)"
      http_code: 400

  - id: "RN-RF052-05"
    titulo: "Controle de Custos Individualizados"
    descricao: |
      Sistema rastreia custos exatos de cada consumidor mês a mês com histórico de 7 anos (LGPD).
      Custo Total = Custos de Ativos + Consumo Variável.
    criticidade: "CRÍTICA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "calculo"
      mensagem_erro: null
      http_code: null

  - id: "RN-RF052-06"
    titulo: "Perfis de Uso e Aplicação Automática de Políticas"
    descricao: |
      Cada consumidor tem perfil de uso que determina políticas aplicadas automaticamente.
      Perfis: Executivo, Gerente, Colaborador, Estagiário, Externo.
    criticidade: "ALTA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: false
    validacao:
      tipo: "regra_negocio"
      mensagem_erro: "Perfil de uso requer políticas cadastradas no sistema"
      http_code: 400

  - id: "RN-RF052-07"
    titulo: "Status de Consumidor e Impactos"
    descricao: |
      Status controla acessos, políticas, faturamento.
      Status: Ativo, Suspenso, Bloqueado, Inativo, Pendente.
    criticidade: "CRÍTICA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "transicao_estado"
      mensagem_erro: "Transição de status não permitida"
      http_code: 400

  - id: "RN-RF052-08"
    titulo: "Workflow de Onboarding Automatizado"
    descricao: |
      Admissão de novo consumidor segue workflow de 6 etapas com aprovações.
      Etapas: Cadastro, Perfil/Políticas, Ativos, Acessos, Kit de Boas-vindas, Ativação.
    criticidade: "ALTA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "workflow"
      mensagem_erro: "Falha em etapa do workflow de onboarding"
      http_code: 500

  - id: "RN-RF052-09"
    titulo: "Workflow de Offboarding Automatizado"
    descricao: |
      Desligamento segue workflow de 5 etapas.
      Etapas: Notificação, Desalocação de Ativos, Cancelamento de Acessos, Cálculo de Custos, Inativação.
    criticidade: "ALTA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "workflow"
      mensagem_erro: "Falha em etapa do workflow de offboarding"
      http_code: 500

  - id: "RN-RF052-10"
    titulo: "Integração com RH para Sincronização Automática"
    descricao: |
      Sincronização diária com sistema de RH externo via API ou CSV.
      Dados: Nome, CPF, Matrícula, Departamento, Cargo, Admissão, Demissão, Status.
    criticidade: "MÉDIA"
    implementacao:
      backend: true
      frontend: false
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "integracao"
      mensagem_erro: "Falha na sincronização com sistema de RH"
      http_code: 500

  - id: "RN-RF052-11"
    titulo: "Dashboard 360° de Consumidor"
    descricao: |
      Visão completa em 7 abas: Dados, Ativos, Consumo, Custos, Políticas, Histórico, Chamados.
      Atualização em tempo real via SignalR para aba Consumo.
    criticidade: "ALTA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "performance"
      mensagem_erro: null
      http_code: null

  - id: "RN-RF052-12"
    titulo: "Comparação de Consumo Individual vs Média"
    descricao: |
      Comparar consumo/custo individual com média do departamento.
      Alerta se >150% da média por 3 meses consecutivos.
    criticidade: "MÉDIA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "calculo"
      mensagem_erro: null
      http_code: null

  - id: "RN-RF052-13"
    titulo: "Movimentação de Consumidores com Histórico"
    descricao: |
      Mudanças de departamento/cargo/gestor registradas com histórico completo.
      Movimentações: Departamento, Cargo, Gestor, Centro de Custo.
    criticidade: "ALTA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "auditoria"
      mensagem_erro: null
      http_code: null

  - id: "RN-RF052-14"
    titulo: "Relatórios de Custos por Consumidor/Departamento"
    descricao: |
      Relatórios: Custos por Consumidor, Custos por Departamento, Top 10, Subutilizados.
      Exportação: Excel, PDF, CSV.
    criticidade: "MÉDIA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "exportacao"
      mensagem_erro: null
      http_code: null

  - id: "RN-RF052-15"
    titulo: "Validação de Permissões RBAC"
    descricao: |
      Permissões granulares: VIEW, CREATE, UPDATE, DELETE, VIEW_CUSTOS, EXPORT.
      Gestores veem apenas seus departamentos. Financeiro vê todos.
    criticidade: "CRÍTICA"
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "permissao"
      mensagem_erro: "Acesso negado"
      http_code: 403

# ==============================================================================
# ESTADOS
# ==============================================================================

estados:
  - id: "Pendente"
    descricao: "Consumidor criado, aguardando aprovação ou configuração inicial"
  - id: "Ativo"
    descricao: "Consumidor ativo com acesso total a recursos e faturamento normal"
  - id: "Suspenso"
    descricao: "Bloqueio de novas operações, mantém consulta, aguardando resolução"
  - id: "Bloqueado"
    descricao: "Bloqueio total sem acesso a recursos (inadimplência, violação)"
  - id: "Inativo"
    descricao: "Desligado, sem custos, sem acesso, histórico preservado 7 anos"

transicoes:
  permitidas:
    - de: "Pendente"
      para: "Ativo"
      condicao: "Após conclusão do onboarding"
    - de: "Ativo"
      para: "Suspenso"
      condicao: "Por inadimplência ou violação de política"
    - de: "Ativo"
      para: "Bloqueado"
      condicao: "Por ordem administrativa ou violação grave"
    - de: "Ativo"
      para: "Inativo"
      condicao: "Após conclusão do offboarding"
    - de: "Suspenso"
      para: "Ativo"
      condicao: "Após resolução do problema"
    - de: "Bloqueado"
      para: "Ativo"
      condicao: "Após autorização administrativa"
  proibidas:
    - de: "Inativo"
      para: "Ativo"
      razao: "Consumidor inativado não pode ser reativado (criar novo cadastro)"

# ==============================================================================
# PERMISSÕES RBAC
# ==============================================================================

permissoes_rbac:
  - permission_code: "GESTAO.CONSUMIDORES.VIEW"
    descricao: "Visualizar consumidor"
    roles_autorizadas:
      - "Super Admin"
      - "Admin"
      - "Gestor"
      - "Financeiro"
    endpoint: "GET /api/gestao/consumidores/{id}"

  - permission_code: "GESTAO.CONSUMIDORES.VIEW_ANY"
    descricao: "Listar consumidores"
    roles_autorizadas:
      - "Super Admin"
      - "Admin"
      - "Gestor"
      - "Financeiro"
    endpoint: "GET /api/gestao/consumidores"

  - permission_code: "GESTAO.CONSUMIDORES.CREATE"
    descricao: "Criar consumidor"
    roles_autorizadas:
      - "Super Admin"
      - "Admin"
      - "RH"
    endpoint: "POST /api/gestao/consumidores"

  - permission_code: "GESTAO.CONSUMIDORES.UPDATE"
    descricao: "Atualizar consumidor"
    roles_autorizadas:
      - "Super Admin"
      - "Admin"
      - "RH"
    endpoint: "PUT /api/gestao/consumidores/{id}"

  - permission_code: "GESTAO.CONSUMIDORES.DELETE"
    descricao: "Inativar consumidor"
    roles_autorizadas:
      - "Super Admin"
      - "Admin"
    endpoint: "DELETE /api/gestao/consumidores/{id}"

  - permission_code: "GESTAO.CONSUMIDORES.VIEW_CUSTOS"
    descricao: "Visualizar custos do consumidor"
    roles_autorizadas:
      - "Super Admin"
      - "Financeiro"
    endpoint: "GET /api/gestao/consumidores/{id}/custos"

  - permission_code: "GESTAO.CONSUMIDORES.EXPORT"
    descricao: "Exportar relatórios"
    roles_autorizadas:
      - "Super Admin"
      - "Admin"
      - "Financeiro"
    endpoint: "GET /api/gestao/consumidores/exportar"

# ==============================================================================
# API ENDPOINTS
# ==============================================================================

endpoints:
  - method: "GET"
    route: "/api/gestao/consumidores"
    descricao: "Listar consumidores com paginação e filtros"
    autenticacao: true
    authorization_policy: "ConsumidoresViewAny"
    request_dto: null
    response_dto: "PaginatedListDto<ConsumidorDto>"

  - method: "GET"
    route: "/api/gestao/consumidores/{id}"
    descricao: "Obter detalhes de um consumidor"
    autenticacao: true
    authorization_policy: "ConsumidoresView"
    request_dto: null
    response_dto: "ConsumidorDto"

  - method: "POST"
    route: "/api/gestao/consumidores"
    descricao: "Criar novo consumidor"
    autenticacao: true
    authorization_policy: "ConsumidoresCreate"
    request_dto: "CreateConsumidorCommand"
    response_dto: "Guid"

  - method: "PUT"
    route: "/api/gestao/consumidores/{id}"
    descricao: "Atualizar consumidor existente"
    autenticacao: true
    authorization_policy: "ConsumidoresUpdate"
    request_dto: "UpdateConsumidorCommand"
    response_dto: "Guid"

  - method: "DELETE"
    route: "/api/gestao/consumidores/{id}"
    descricao: "Inativar consumidor (soft delete)"
    autenticacao: true
    authorization_policy: "ConsumidoresDelete"
    request_dto: null
    response_dto: "void"

  - method: "POST"
    route: "/api/gestao/consumidores/{id}/alocar-ativo"
    descricao: "Alocar ativo ao consumidor"
    autenticacao: true
    authorization_policy: "ConsumidoresUpdate"
    request_dto: "AllocateAtivoCommand"
    response_dto: "Guid"

  - method: "POST"
    route: "/api/gestao/consumidores/{id}/desalocar-ativo"
    descricao: "Desalocar ativo do consumidor"
    autenticacao: true
    authorization_policy: "ConsumidoresUpdate"
    request_dto: "DeallocateAtivoCommand"
    response_dto: "void"

  - method: "POST"
    route: "/api/gestao/consumidores/{id}/onboarding"
    descricao: "Executar workflow de onboarding"
    autenticacao: true
    authorization_policy: "ConsumidoresCreate"
    request_dto: "OnboardingConsumidorCommand"
    response_dto: "void"

  - method: "POST"
    route: "/api/gestao/consumidores/{id}/offboarding"
    descricao: "Executar workflow de offboarding"
    autenticacao: true
    authorization_policy: "ConsumidoresDelete"
    request_dto: "OffboardingConsumidorCommand"
    response_dto: "void"

  - method: "GET"
    route: "/api/gestao/consumidores/{id}/dashboard"
    descricao: "Obter dados do dashboard 360°"
    autenticacao: true
    authorization_policy: "ConsumidoresView"
    request_dto: null
    response_dto: "ConsumidorDashboardDto"

  - method: "GET"
    route: "/api/gestao/consumidores/{id}/custos"
    descricao: "Obter histórico de custos do consumidor"
    autenticacao: true
    authorization_policy: "ConsumidoresViewCustos"
    request_dto: null
    response_dto: "List<ConsumidorCustoMensalDto>"

  - method: "GET"
    route: "/api/gestao/consumidores/{id}/historico"
    descricao: "Obter histórico de movimentações"
    autenticacao: true
    authorization_policy: "ConsumidoresView"
    request_dto: null
    response_dto: "List<ConsumidorHistoricoMovimentacaoDto>"

  - method: "GET"
    route: "/api/gestao/consumidores/{id}/comparar"
    descricao: "Comparar consumo com média do departamento"
    autenticacao: true
    authorization_policy: "ConsumidoresView"
    request_dto: null
    response_dto: "ConsumidorComparacaoDto"

  - method: "GET"
    route: "/api/gestao/consumidores/relatorio-custos"
    descricao: "Gerar relatório de custos"
    autenticacao: true
    authorization_policy: "ConsumidoresViewCustos"
    request_dto: null
    response_dto: "RelatorioCustosDto"

  - method: "POST"
    route: "/api/gestao/consumidores/importar"
    descricao: "Importar consumidores via CSV/Excel"
    autenticacao: true
    authorization_policy: "ConsumidoresCreate"
    request_dto: "ImportConsumidoresCommand"
    response_dto: "ImportResultDto"

  - method: "GET"
    route: "/api/gestao/consumidores/exportar"
    descricao: "Exportar consumidores para arquivo"
    autenticacao: true
    authorization_policy: "ConsumidoresExport"
    request_dto: null
    response_dto: "FileContentResult"

  - method: "POST"
    route: "/api/gestao/consumidores/sincronizar-rh"
    descricao: "Sincronizar dados com sistema de RH"
    autenticacao: true
    authorization_policy: "ConsumidoresCreate"
    request_dto: "SyncRHCommand"
    response_dto: "SyncResultDto"

# ==============================================================================
# INTEGRAÇÕES
# ==============================================================================

integracoes:
  internas:
    - "Autenticação JWT (RF006)"
    - "Multi-Tenancy (Query Filters EF Core)"
    - "Auditoria (RF003)"
    - "Departamentos (RF024)"
    - "Cargos (RF018)"
    - "Ativos (RF025)"
    - "Linhas Móveis (RF050)"
    - "Políticas (RF049)"
    - "Status (RF048)"
    - "Faturamento (RF026)"
    - "Notificações (RF066)"
    - "E-mails (RF067)"
  externas:
    - sistema: "Sistema de RH"
      tipo: "API REST ou CSV"
      obrigatoria: false

# ==============================================================================
# SEGURANÇA
# ==============================================================================

seguranca:
  isolamento_tenant: true
  auditoria_obrigatoria: true
  soft_delete: true
  criptografia_dados_sensiveis: true
  validacao_entrada: true

# ==============================================================================
# KPIs E MÉTRICAS
# ==============================================================================

kpis:
  - nome: "Taxa de Sucesso de Criação"
    descricao: "Percentual de consumidores criados com sucesso"
    meta: ">= 95%"
    log_obrigatorio: true

  - nome: "Tempo Médio de Resposta CRUD"
    descricao: "Tempo médio de resposta das operações CRUD"
    meta: "<= 300ms (P95)"
    log_obrigatorio: true

  - nome: "Tempo de Carregamento Dashboard 360°"
    descricao: "Tempo para carregar dashboard completo"
    meta: "<= 2s"
    log_obrigatorio: true

  - nome: "Taxa de Sucesso de Workflows"
    descricao: "Percentual de workflows de onboarding/offboarding concluídos"
    meta: ">= 98%"
    log_obrigatorio: true

# ==============================================================================
# ALERTAS CRÍTICOS
# ==============================================================================

alertas:
  - evento: "Falha ao criar consumidor"
    threshold: "> 5% em 1 hora"
    severidade: "ALTA"
    canal_notificacao:
      - "email"
      - "slack"

  - evento: "Tentativa de acesso sem permissão"
    threshold: "> 10 em 5 minutos"
    severidade: "CRÍTICA"
    canal_notificacao:
      - "email"
      - "slack"
      - "sms"

  - evento: "Consumidor com custo >150% da média por 3 meses"
    threshold: "Detecção automática mensal"
    severidade: "MÉDIA"
    canal_notificacao:
      - "email"

  - evento: "Falha na sincronização com RH"
    threshold: "> 2 falhas consecutivas"
    severidade: "ALTA"
    canal_notificacao:
      - "email"
      - "slack"

# ==============================================================================
# RASTREABILIDADE
# ==============================================================================

rastreabilidade:
  ucs_esperados:
    - "UC00-listar-consumidores"
    - "UC01-criar-consumidor"
    - "UC02-visualizar-consumidor"
    - "UC03-editar-consumidor"
    - "UC04-inativar-consumidor"
    - "UC05-alocar-ativo"
    - "UC06-desalocar-ativo"
    - "UC07-onboarding-consumidor"
    - "UC08-offboarding-consumidor"
    - "UC09-dashboard-360"
    - "UC10-comparar-consumo"

# ==============================================================================
# CATALOG
# ==============================================================================

catalog:
  crud:
    - id: "RF-CRUD-01"
      title: "Criar consumidor"
      required: true
    - id: "RF-CRUD-02"
      title: "Listar consumidores"
      required: true
    - id: "RF-CRUD-03"
      title: "Visualizar consumidor"
      required: true
    - id: "RF-CRUD-04"
      title: "Atualizar consumidor"
      required: true
    - id: "RF-CRUD-05"
      title: "Inativar consumidor"
      required: true
  validacoes:
    - id: "RF-VAL-01"
      title: "Validar campos obrigatórios por tipo"
      required: true
    - id: "RF-VAL-02"
      title: "Validar unicidade de CPF/Matrícula/E-mail"
      required: true
    - id: "RF-VAL-03"
      title: "Validar hierarquia organizacional"
      required: true
    - id: "RF-VAL-04"
      title: "Validar disponibilidade de ativo"
      required: true
  seguranca:
    - id: "RF-SEC-01"
      title: "Isolamento de tenant"
      required: true
    - id: "RF-SEC-02"
      title: "Permissões RBAC"
      required: true
    - id: "RF-SEC-03"
      title: "Auditoria de operações"
      required: true

exclusions:
  documentacao_items: []

# ==============================================================================
# HISTÓRICO
# ==============================================================================

historico:
  - versao: "2.0"
    data: "2025-12-30"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Migração v1.0 → v2.0 (separação RF/RL, contrato moderno estruturado)"
  - versao: "1.0"
    data: "2025-12-18"
    autor: "IControlIT Architect Agent"
    descricao: "Versão inicial - Especificação completa"
