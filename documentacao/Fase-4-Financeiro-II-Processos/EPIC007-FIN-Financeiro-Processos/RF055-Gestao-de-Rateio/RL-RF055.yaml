# Template de Referência ao Legado (RL-RF055.yaml)
# Versão: 1.0
# Data: 2025-12-30
# Autor: Agência ALC - alc.dev.br

rf_id: RF055
titulo: "Gestão de Rateio de Custos"

legado:
  sistema: "VB.NET + ASP.NET Web Forms"
  versao: "IControlIT v3.x (2015-2024)"
  arquitetura: "Monolítica WebForms"
  banco_dados: "SQL Server 2012+"
  multi_tenant: true
  auditoria: "partial"  # Apenas criação e alteração de regras, sem histórico de processamento

# SEÇÃO CRÍTICA: Referencias ao Legado com Destino Obrigatório
referencias:
  - id: "LEG-RF055-001"
    tipo: "regra_negocio"
    nome: "Rateio Manual via Excel"
    caminho: "Processo operacional (DOC-FIN-001.pdf)"
    descricao: |
      O rateio era feito manualmente em planilhas Excel, com fórmulas criadas pelo analista financeiro.
      Não havia padronização ou versionamento.
      Processo demorado (2-3 dias úteis por mês) e propenso a erros humanos.
    destino: "substituido"
    justificativa: |
      Sistema automatizado substitui completamente o processo manual.
      Elimina erros humanos, reduz tempo de 2-3 dias para < 1 hora.
      Todas as regras de negócio (RN-RF055-01 a RN-RF055-15) implementam funcionalidades não existentes no legado.
    documentacao_item_relacionado: "RN-RF055-01 a RN-RF055-15"
    uc_relacionado: "UC01, UC05, UC06"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF055-002"
    tipo: "regra_negocio"
    nome: "Percentuais Fixos por Área"
    caminho: "Planilhas Excel de 15 clientes ativos"
    descricao: |
      Na prática, a maioria dos clientes usava percentuais fixos (ex: 40% TI, 30% Vendas, 30% Administrativo).
      Percentuais definidos uma vez por ano e raramente alterados.
      Sem histórico de alterações (versões antigas perdidas).
    destino: "assumido"
    justificativa: |
      Comportamento assumido e expandido no sistema moderno.
      RN-RF055-01 define "Fixo" como um dos 4 tipos de rateio suportados.
      Sistema moderno adiciona versionamento (RN-RF055-08) que não existia no legado.
    documentacao_item_relacionado: "RN-RF055-01, RN-RF055-02, RN-RF055-08"
    uc_relacionado: "UC01, UC03"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF055-003"
    tipo: "regra_negocio"
    nome: "Falta de Aprovação Formal"
    caminho: "Tickets de suporte (2022-2024)"
    descricao: |
      Não havia fluxo de aprovação.
      Analista processava e enviava direto para o ERP.
      Erros eram descobertos apenas após lançamento contábil (alto custo de estorno).
    destino: "substituido"
    justificativa: |
      Sistema moderno implementa workflow de aprovação obrigatória (RN-RF055-07).
      Reduz drasticamente erros e custos de correção.
      Aprovação antes de export para ERP é diferencial crítico.
    documentacao_item_relacionado: "RN-RF055-07"
    uc_relacionado: "UC04"
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF055-004"
    tipo: "regra_negocio"
    nome: "Sem Simulação"
    caminho: "Pesquisa de satisfação Q4/2023"
    descricao: |
      Não era possível simular o impacto de uma mudança de regra antes de aplicar.
      Mudanças eram aplicadas diretamente no mês seguinte (alto risco).
      Clientes solicitavam simulação como funcionalidade crítica.
    destino: "substituido"
    justificativa: |
      Sistema moderno implementa simulação sem persistência (RN-RF055-06).
      Permite testar múltiplos cenários antes de aplicar.
      Reduz risco de erros e aumenta confiança do usuário.
    documentacao_item_relacionado: "RN-RF055-06"
    uc_relacionado: "UC06"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 1

  - id: "LEG-RF055-005"
    tipo: "regra_negocio"
    nome: "Histórico Inexistente"
    caminho: "Backups de banco de dados (2020-2024)"
    descricao: |
      Não havia histórico de versões de regras de rateio.
      Se cliente mudava a regra, a anterior era perdida.
      Impossível auditar ou reprocessar com regra histórica.
    destino: "substituido"
    justificativa: |
      Sistema moderno implementa versionamento com vigência (RN-RF055-08).
      Mantém histórico completo por 7 anos (LGPD).
      Permite reprocessamento com regra histórica (RN-RF055-19).
    documentacao_item_relacionado: "RN-RF055-08, RN-RF055-19"
    uc_relacionado: "UC03"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF055-006"
    tipo: "regra_negocio"
    nome: "Totalização Manual"
    caminho: "Auditoria interna de qualidade (2023)"
    descricao: |
      Validação de que soma dos percentuais era 100% feita visualmente.
      Erros de 99,8% ou 100,2% eram comuns.
      Causavam discrepâncias em lançamentos contábeis.
    destino: "substituido"
    justificativa: |
      Sistema moderno valida automaticamente totalização 100% (RN-RF055-02).
      Tolerância de arredondamento: 0,01%.
      Elimina completamente erros de totalização.
    documentacao_item_relacionado: "RN-RF055-02"
    uc_relacionado: "UC01, UC03"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 1

  - id: "LEG-RF055-007"
    tipo: "regra_negocio"
    nome: "Export Manual para ERP"
    caminho: "Chamados de suporte (tags: SAP, TOTVS, lançamentos faltando)"
    descricao: |
      Arquivo CSV gerado pela planilha era enviado manualmente para o ERP.
      Sem validação de sucesso.
      Falhas silenciosas eram comuns (lançamentos não chegavam no ERP).
    destino: "substituido"
    justificativa: |
      Sistema moderno integra via API com SAP, TOTVS, Conta Azul (RN-RF055-11).
      Confirmação automática de sucesso/falha.
      Reduz tempo de processamento e elimina falhas silenciosas.
    documentacao_item_relacionado: "RN-RF055-11"
    uc_relacionado: "UC05"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF055-008"
    tipo: "regra_negocio"
    nome: "Sem Comparativo Mensal"
    caminho: "Relato de cliente (erro descoberto 6 meses depois)"
    descricao: |
      Não havia comparação automática entre meses.
      Variações anormais passavam despercebidas.
      Cliente descobriu erro de rateio 6 meses após aplicação (alto custo de correção).
    destino: "substituido"
    justificativa: |
      Sistema moderno gera comparativo automático mensal (RN-RF055-10).
      Alertas automáticos para variações > 30% (RN-RF055-13).
      Detecção precoce de erros e anomalias.
    documentacao_item_relacionado: "RN-RF055-10, RN-RF055-13"
    uc_relacionado: "UC07"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF055-009"
    tipo: "regra_negocio"
    nome: "Rateio Apenas no Nível de Centro de Custo"
    caminho: "Limitação técnica do processo manual Excel"
    descricao: |
      Legado não suportava rateio multinível (empresa → diretoria → departamento).
      Apenas um nível era possível.
      Clientes com estrutura organizacional complexa faziam múltiplos rateios sequenciais (lento e propenso a erro).
    destino: "substituido"
    justificativa: |
      Sistema moderno suporta rateio multinível em cascata (RN-RF055-12).
      Processa níveis sequencialmente com validação de consistência.
      Atende organizações com estrutura complexa.
    documentacao_item_relacionado: "RN-RF055-12"
    uc_relacionado: "UC01"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 3

  - id: "LEG-RF055-010"
    tipo: "regra_negocio"
    nome: "Ajustes Não Rateados"
    caminho: "Lançamentos contábeis (2022-2023)"
    descricao: |
      Créditos, descontos e ajustes eram lançados manualmente em centros de custo específicos.
      Sem distribuição proporcional (injustiça na distribuição de benefícios).
      Reclamações de gestores de departamentos.
    destino: "substituido"
    justificativa: |
      Sistema moderno rateia ajustes proporcionalmente (RN-RF055-14).
      Justiça na distribuição de benefícios e custos adicionais.
      Rastreabilidade de ajustes por item.
    documentacao_item_relacionado: "RN-RF055-14"
    uc_relacionado: "UC03"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

# Telas Legadas (estrutura detalhada)
telas:
  - id: "LEG-RF055-TELA-001"
    nome: "Não Aplicável - Sem Telas de Rateio"
    caminho: "N/A"
    responsabilidade: "Processo 100% manual via Excel (sem interface no sistema legado)"
    campos: []
    comportamentos_implicitos:
      - "Exportar custos do mês em Excel"
      - "Aplicar fórmulas de rateio manualmente"
      - "Gerar lançamentos contábeis em arquivo CSV"
      - "Importar no ERP (SAP/TOTVS)"

# WebServices Legados
servicos:
  - id: "LEG-RF055-SVC-001"
    nome: "Não Aplicável - Sem WebServices de Rateio"
    localizacao: "N/A"
    responsabilidade: "Não existem WebServices (.asmx) ou APIs relacionadas a rateio no legado"
    notas: "Integração com ERPs era manual via CSV"

# Tabelas Legadas com Problemas
tabelas:
  - nome: "vw_Custo_Linha"
    finalidade: "View de custos de linhas telefônicas"
    problemas:
      - "Sem agrupamento por centro de custo, apenas por linha"
      - "Não suporta rateio direto (precisa de transformação)"

  - nome: "vw_Custo_Dados"
    finalidade: "View de custos de dados móveis"
    problemas:
      - "Não separa consumo por usuário/departamento"
      - "Agregação insuficiente para rateio"

  - nome: "tbl_Centro_Custo"
    finalidade: "Cadastro de centros de custo"
    problemas:
      - "Estrutura simplificada, sem hierarquia"
      - "Sem suporte a multinível"

  - nome: "tbl_Funcionario"
    finalidade: "Cadastro de funcionários"
    problemas:
      - "Sem vínculo direto com centro de custo"
      - "Dificulta rateio por headcount"

  - nome: "tbl_Linha"
    finalidade: "Cadastro de linhas telefônicas"
    problemas:
      - "Campo centro de custo existe mas raramente preenchido"
      - "Dados inconsistentes"

# Regras de Negócio Implícitas (não documentadas no legado)
regras_implicitas:
  - id: "RL-RN-001"
    descricao: "Rateio manual via Excel com fórmulas criadas pelo analista financeiro"
    fonte: "DOC-FIN-001.pdf (manual do usuário)"

  - id: "RL-RN-002"
    descricao: "Percentuais fixos definidos uma vez por ano e raramente alterados"
    fonte: "Planilhas de 15 clientes ativos"

  - id: "RL-RN-003"
    descricao: "Sem aprovação formal (analista processa e envia direto para ERP)"
    fonte: "Tickets de suporte (2022-2024)"

  - id: "RL-RN-004"
    descricao: "Impossibilidade de simular antes de aplicar"
    fonte: "Pesquisa de satisfação Q4/2023"

  - id: "RL-RN-005"
    descricao: "Sem histórico de versões de regras (versões antigas perdidas)"
    fonte: "Backups de banco de dados (2020-2024)"

  - id: "RL-RN-006"
    descricao: "Validação de totalização 100% feita visualmente (erros comuns)"
    fonte: "Auditoria interna de qualidade (2023)"

  - id: "RL-RN-007"
    descricao: "Export CSV manual sem validação de sucesso (falhas silenciosas)"
    fonte: "Chamados de suporte (tags: SAP, TOTVS)"

  - id: "RL-RN-008"
    descricao: "Sem comparação automática entre meses (variações despercebidas)"
    fonte: "Relato de cliente (erro descoberto 6 meses depois)"

  - id: "RL-RN-009"
    descricao: "Rateio apenas no nível de centro de custo (sem multinível)"
    fonte: "Limitação técnica do Excel"

  - id: "RL-RN-010"
    descricao: "Ajustes não rateados proporcionalmente (lançamento manual)"
    fonte: "Lançamentos contábeis (2022-2023)"

# Gap Analysis (Legado x Moderno)
gap_analysis:
  - item: "Processamento"
    existe_legado: true
    existe_moderno: true
    notas: "Legado: manual/Excel | Moderno: automático agendado (dia 5, 03:00)"

  - item: "Tipos de Rateio"
    existe_legado: true
    existe_moderno: true
    notas: "Legado: apenas fixo | Moderno: 4 tipos (fixo, headcount, uso real, projeto)"

  - item: "Validação de Totalização"
    existe_legado: true
    existe_moderno: true
    notas: "Legado: visual/manual | Moderno: automática (100% ± 0,01%)"

  - item: "Simulação"
    existe_legado: false
    existe_moderno: true
    notas: "Funcionalidade nova sem equivalente no legado"

  - item: "Aprovação"
    existe_legado: false
    existe_moderno: true
    notas: "Workflow de aprovação antes de export (diferencial crítico)"

  - item: "Histórico/Versionamento"
    existe_legado: false
    existe_moderno: true
    notas: "Versionamento com vigência (7 anos de retenção)"

  - item: "Comparativo Mensal"
    existe_legado: false
    existe_moderno: true
    notas: "Automático com alertas de variação > 30%"

  - item: "Export ERP"
    existe_legado: true
    existe_moderno: true
    notas: "Legado: CSV manual | Moderno: API integrada (SAP, TOTVS, Conta Azul)"

  - item: "Multinível"
    existe_legado: false
    existe_moderno: true
    notas: "Suporta cascata (empresa → diretoria → departamento → projeto)"

  - item: "Rateio de Ajustes"
    existe_legado: true
    existe_moderno: true
    notas: "Legado: manual sem critério | Moderno: proporcional automático"

  - item: "Dashboard"
    existe_legado: false
    existe_moderno: true
    notas: "Gráficos executivos em tempo real"

  - item: "Reprocessamento"
    existe_legado: false
    existe_moderno: true
    notas: "Suporta reprocessar períodos anteriores com regra histórica"

  - item: "Cancelamento"
    existe_legado: false
    existe_moderno: true
    notas: "Cancelar rateio até antes de exportar"

  - item: "Multi-tenant"
    existe_legado: true
    existe_moderno: true
    notas: "Mantido (Id_Fornecedor → EmpresaId)"

  - item: "Auditoria"
    existe_legado: true
    existe_moderno: true
    notas: "Legado: parcial (apenas regras) | Moderno: completa (todas operações)"

# Decisões de Modernização
decisoes_modernizacao:
  - decisao: "Criar módulo completamente novo (sem dependências do legado)"
    motivo: |
      Não existe rateio no legado (processo manual Excel).
      Oportunidade de implementar best practices desde o início.
      Sem débito técnico herdado.
    impacto: "alto"
    data: "2025-12-30"

  - decisao: "Processar automaticamente no dia 5 às 03:00"
    motivo: |
      Clientes fecham custos até dia 3 do mês seguinte.
      Dia 5 dá margem para ajustes manuais se necessário.
      Horário 03:00 evita conflito com horário comercial.
    impacto: "medio"
    data: "2025-12-30"

  - decisao: "Exigir aprovação antes de exportar"
    motivo: |
      No legado, erros eram descobertos após lançamento contábil (alto custo).
      Aprovação prévia reduz drasticamente erros.
    impacto: "medio"
    data: "2025-12-30"

  - decisao: "Suportar múltiplos tipos de rateio (fixo, headcount, uso real, projeto)"
    motivo: |
      Diferentes clientes têm necessidades diferentes.
      Flexibilidade é diferencial competitivo.
    impacto: "alto"
    data: "2025-12-30"

  - decisao: "Integrar diretamente com ERPs via API"
    motivo: |
      Export manual CSV é lento e propenso a falhas.
      Integração API permite confirmação de sucesso.
      Reduz tempo de 2-3 dias para < 1 hora.
    impacto: "alto"
    data: "2025-12-30"

  - decisao: "Manter multi-tenancy (EmpresaId)"
    motivo: |
      Legado já é multi-tenant.
      Clientes compartilham mesma instância.
      Isolamento de dados é crítico para segurança.
    impacto: "medio"
    data: "2025-12-30"

# Riscos de Migração
riscos_migracao:
  - risco: "Clientes resistentes a mudança de processo (manual → automático)"
    impacto: "alto"
    probabilidade: "media"
    mitigacao: |
      Treinamento + período de teste paralelo (manual + automático) por 2 meses.
      Comunicação clara dos benefícios (redução de 80h/mês).

  - risco: "Falha na integração com ERP (SAP/TOTVS)"
    impacto: "alto"
    probabilidade: "baixa"
    mitigacao: |
      Manter fallback para export CSV manual.
      Testes extensivos em sandbox SAP/TOTVS antes de produção.

  - risco: "Regras de rateio complexas não previstas"
    impacto: "medio"
    probabilidade: "media"
    mitigacao: |
      Permitir rateio customizado via API extensível (plugin).
      Iteração com clientes durante desenvolvimento.

  - risco: "Performance com > 10.000 centros de custo"
    impacto: "medio"
    probabilidade: "baixa"
    mitigacao: |
      Testes de carga.
      Otimização de queries.
      Processamento assíncrono se necessário.

  - risco: "Dados históricos inconsistentes (custos mal categorizados)"
    impacto: "baixo"
    probabilidade: "alta"
    mitigacao: |
      Não há migração de histórico (funcionalidade nova).
      Iniciar a partir de janeiro/2025 com dados limpos.

  - risco: "Timezone em processamento automático (clientes em fusos diferentes)"
    impacto: "baixo"
    probabilidade: "media"
    mitigacao: |
      Usar UTC em jobs.
      Converter para timezone do cliente ao exibir.

# Rastreabilidade (Legado → Moderno)
rastreabilidade:
  - elemento_legado: "Processo manual Excel"
    referencia_rf: "RN-RF055-01 a RN-RF055-20"
    referencia_uc: "UC01 a UC07"
    status: "substituido"

  - elemento_legado: "Export CSV para ERP"
    referencia_rf: "RN-RF055-11"
    referencia_uc: "UC05"
    status: "substituido"

  - elemento_legado: "Percentuais fixos em planilha"
    referencia_rf: "RN-RF055-01, RN-RF055-02"
    referencia_uc: "UC01, UC03"
    status: "assumido"

  - elemento_legado: "Falta de versionamento"
    referencia_rf: "RN-RF055-08"
    referencia_uc: "UC03"
    status: "substituido"

  - elemento_legado: "Sem aprovação"
    referencia_rf: "RN-RF055-07"
    referencia_uc: "UC04"
    status: "substituido"

  - elemento_legado: "Sem simulação"
    referencia_rf: "RN-RF055-06"
    referencia_uc: "UC06"
    status: "substituido"

  - elemento_legado: "Sem comparativo mensal"
    referencia_rf: "RN-RF055-10, RN-RF055-13"
    referencia_uc: "UC07"
    status: "substituido"

  - elemento_legado: "Tabelas de custos (views)"
    referencia_rf: "RN-RF055-05, RN-RF055-18"
    referencia_uc: "UC01"
    status: "assumido"

# Metadados Calculados
metadados:
  total_referencias: 10
  total_com_destino: 10
  percentual_cobertura: 100.0
  referencias_por_destino:
    assumido: 1
    substituido: 9
    descartado: 0
    a_revisar: 0

# Changelog
changelog:
  - versao: "1.0"
    data: "2025-12-30"
    descricao: "Documentação inicial de referência ao legado (processo manual Excel)"
    autor: "Agência ALC - alc.dev.br"
