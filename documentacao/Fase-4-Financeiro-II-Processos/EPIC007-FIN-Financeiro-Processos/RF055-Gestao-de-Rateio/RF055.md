# RF-055: Gestão de Rateio de Custos

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC007 - FIN - Financeiro Processos
**Fase**: Fase 4 - Financeiro II - Processos

---

## 1. OBJETIVO DO REQUISITO

Prover sistema de rateio automático e manual de custos de telecom/TI entre centros de custo, departamentos, projetos e filiais, suportando múltiplas regras de rateio (fixo, proporcional, por uso real), simulação antes de aplicar, histórico completo e integração com sistemas de contabilidade (SAP, TOTVS).

Este RF define o comportamento esperado do sistema de rateio, incluindo:
- Configuração de regras de rateio (fixo, proporcional, uso real, projetos)
- Processamento automático mensal
- Simulação de cenários antes de aplicar
- Aprovação de rateios antes de envio para contabilidade
- Integração com ERPs contábeis
- Auditoria completa com histórico de 7 anos

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- Criação e configuração de regras de rateio
- Processamento automático mensal de rateios
- Simulação de cenários de rateio
- Aprovação de rateios processados
- Export para sistemas contábeis (SAP, TOTVS, Conta Azul, CSV)
- Validações de totalização e consistência
- Histórico completo de rateios e alterações
- Dashboard executivo de rateios
- Comparativos mensais com alertas automáticos
- Rateio multinível (empresa → diretoria → departamento → projeto)
- Controle de acesso por permissões RBAC
- Isolamento multi-tenant

### 2.2 Fora do escopo

- Interface visual específica (definida em WF-RF055)
- Integração com sistemas externos não listados
- Análise preditiva ou machine learning
- Otimização de custos (apenas distribuição)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-----|---------|
| Rateio | Distribuição proporcional de custos entre centros de custo, departamentos ou projetos |
| Regra de Rateio | Conjunto de parâmetros que define como um custo será distribuído |
| Centro de Custo | Unidade organizacional para controle de despesas |
| Tenant | Empresa ou grupo empresarial (multi-tenancy) |
| Simulação | Execução de rateio sem persistência para análise prévia |
| Aprovação | Validação humana antes de enviar rateio para contabilidade |
| Vigência | Período de validade de uma regra de rateio |

---

## 4. FUNCIONALIDADES COBERTAS

1. Criar regra de rateio (fixo, proporcional, uso real, projeto)
2. Atualizar regra de rateio com versionamento
3. Consultar regras ativas e históricas
4. Simular rateio com diferentes regras
5. Processar rateio mensal automaticamente
6. Aprovar rateio processado
7. Exportar rateio para ERP
8. Visualizar dashboard executivo
9. Gerar comparativo mensal
10. Configurar alertas de variação

---

## 5. REGRAS DE NEGÓCIO

### RN-RF055-01 — Tipos de Rateio Suportados

**Descrição**: Sistema deve suportar 4 tipos de rateio configuráveis: fixo, proporcional por headcount, uso real e por projeto.

**Justificativa**: Diferentes cenários de negócio exigem diferentes métricas de distribuição de custos.

**Critério de Aceite**:
- Tipo fixo: percentuais pré-definidos por centro de custo
- Tipo proporcional headcount: distribuição baseada em número de colaboradores
- Tipo uso real: distribuição baseada em consumo medido (minutos, MB, licenças)
- Tipo projeto: rateio temporário com data início/fim
- Sistema deve rejeitar tipos não suportados

---

### RN-RF055-02 — Validação de Totalização 100%

**Descrição**: Soma dos percentuais de rateio fixo deve ser exatamente 100%.

**Justificativa**: Evitar valores perdidos ou duplicados na distribuição.

**Critério de Aceite**:
- Soma diferente de 100% → rejeição da regra
- Tolerância de arredondamento: 0,01%
- Validação aplicada em criação e atualização
- Mensagem clara indicando a diferença encontrada

---

### RN-RF055-03 — Processamento Automático Mensal

**Descrição**: Todo dia 5 de cada mês às 03:00, processar automaticamente rateio do mês anterior.

**Justificativa**: Automatizar processo manual, garantir consistência e pontualidade.

**Critério de Aceite**:
- Job agendado para dia 5, 03:00
- Processar custos do mês anterior completo
- Aplicar todas as regras ativas na data
- Validar totalização antes de persistir
- Notificar gestores após conclusão
- Registrar log de execução

---

### RN-RF055-04 — Rateio Proporcional por Headcount

**Descrição**: Distribuir custos proporcionalmente ao número de funcionários ativos por centro de custo.

**Justificativa**: Métrica justa quando não há medição de uso individual.

**Critério de Aceite**:
- Considerar apenas funcionários ativos
- Agrupamento por centro de custo
- Cálculo: valor_total × (headcount_centro / headcount_total)
- Arredondamento para 2 casas decimais

---

### RN-RF055-05 — Rateio por Uso Real

**Descrição**: Distribuir custos baseado em consumo medido (minutos de telefone, MB de dados, licenças utilizadas).

**Justificativa**: Máxima justiça: quem consome mais, paga mais.

**Critério de Aceite**:
- Tipos de consumo suportados: MINUTOS, DADOS_MB, LICENCAS
- Buscar consumo do período correspondente
- Cálculo: valor_total × (consumo_centro / consumo_total)
- Rejeitar se não houver dados de consumo para o período

---

### RN-RF055-06 — Simulação Antes de Aplicar

**Descrição**: Permitir simular rateio com diferentes regras antes de aplicar definitivamente.

**Justificativa**: Evitar erros, testar cenários, analisar impacto de mudanças.

**Critério de Aceite**:
- Simulação não persiste dados
- Retornar distribuição calculada
- Gerar gráfico de distribuição
- Permitir comparação entre múltiplas simulações
- Indicar se soma totaliza 100%

---

### RN-RF055-07 — Aprovação Antes de Enviar para Contabilidade

**Descrição**: Rateio processado deve ser aprovado por gestor antes de export para ERP.

**Justificativa**: Revisão humana, evitar lançamentos incorretos no sistema contábil.

**Critério de Aceite**:
- Apenas rateios em status PROCESSADO podem ser aprovados
- Registrar aprovador, data e hora
- Transição de status: PROCESSADO → APROVADO
- Após aprovação, liberar para export
- Apenas usuários com permissão APPROVE podem aprovar

---

### RN-RF055-08 — Histórico de Alterações de Regras

**Descrição**: Todas as mudanças em regras de rateio devem ser versionadas com vigência.

**Justificativa**: Rastreabilidade, auditoria, capacidade de reprocessar com regra histórica.

**Critério de Aceite**:
- Ao alterar regra, arquivar versão atual
- Incrementar número de versão
- Registrar data início/fim de vigência
- Registrar usuário que fez a alteração
- Manter histórico por 7 anos (LGPD)

---

### RN-RF055-09 — Rateio por Projeto com Data de Vigência

**Descrição**: Projetos temporários podem ter rateio específico com data início/fim.

**Justificativa**: Alocação correta de custos em projetos limitados no tempo.

**Critério de Aceite**:
- Definir percentual alocado ao projeto
- Validar data início < data fim
- Fora do período de vigência, regra não é aplicada
- Valor restante distribuído entre centros de custo padrão
- Projeto inativo não participa do rateio

---

### RN-RF055-10 — Comparativo Mensal

**Descrição**: Gerar relatório comparando rateio do mês atual vs mês anterior.

**Justificativa**: Identificar variações anormais, tendências, erros.

**Critério de Aceite**:
- Calcular variação absoluta e percentual por centro de custo
- Destacar variações > 20%
- Ordenar por maior variação
- Exportar para PDF/Excel
- Incluir gráficos de evolução

---

### RN-RF055-11 — Export para SAP

**Descrição**: Exportar rateios aprovados para SAP via interface padronizada.

**Justificativa**: Integração com sistema contábil corporativo.

**Critério de Aceite**:
- Apenas rateios em status APROVADO podem ser exportados
- Gerar lançamentos contábeis por centro de custo
- Conta contábil parametrizável
- Registrar data e hora de exportação
- Marcar status como EXPORTADO
- Registrar ID do documento SAP retornado

---

### RN-RF055-12 — Rateio Multinível

**Descrição**: Suportar rateio em cascata (empresa → diretoria → departamento → projeto).

**Justificativa**: Estruturas organizacionais complexas.

**Critério de Aceite**:
- Definir ordem de processamento dos níveis
- Cada nível pode ter regra diferente
- Processar níveis sequencialmente
- Soma final deve totalizar 100% do valor inicial
- Validar consistência entre níveis

---

### RN-RF055-13 — Alertas de Variação Anormal

**Descrição**: Notificar automaticamente se rateio de um centro de custo variar > 30% vs mês anterior.

**Justificativa**: Detectar erros, mudanças significativas, consumo anormal.

**Critério de Aceite**:
- Calcular variação percentual por centro de custo
- Threshold configurável (padrão: 30%)
- Enviar notificação para gestor do centro de custo
- Incluir valores antigo, novo e percentual de variação
- Registrar notificação enviada

---

### RN-RF055-14 — Rateio de Ajustes e Créditos

**Descrição**: Ajustes, créditos e descontos devem ser rateados proporcionalmente.

**Justificativa**: Justiça na distribuição de benefícios e custos adicionais.

**Critério de Aceite**:
- Ajuste positivo ou negativo
- Distribuir proporcionalmente ao valor rateado original
- Registrar tipo de ajuste e justificativa
- Recalcular totalizações após ajuste
- Manter rastreabilidade de ajustes por item

---

### RN-RF055-15 — Dashboard de Rateios

**Descrição**: Dashboard executivo com gráficos de evolução mensal, top centros de custo, distribuição.

**Justificativa**: Visibilidade executiva, tomada de decisão informada.

**Critério de Aceite**:
- Evolução mensal (linha do tempo)
- Top 10 centros de custo por valor
- Distribuição percentual atual (pizza)
- Filtros por período, tipo de rateio
- Atualização em tempo real
- Export de gráficos para imagem

---

### RN-RF055-16 — Isolamento Multi-Tenant

**Descrição**: Rateios de um tenant não podem ser visualizados ou alterados por outro tenant.

**Justificativa**: Segurança, privacidade de dados financeiros.

**Critério de Aceite**:
- Todas as queries filtrarem por EmpresaId
- Tentativa de acesso cruzado → HTTP 403
- Validação em Commands e Queries
- Auditoria de tentativas de acesso indevido

---

### RN-RF055-17 — Auditoria Completa

**Descrição**: Todas as operações de rateio devem ser auditadas com usuário, data, ação e valores antes/depois.

**Justificativa**: Compliance, rastreabilidade, investigação de erros.

**Critério de Aceite**:
- Auditar CREATE, UPDATE, DELETE, APPROVE, EXPORT
- Registrar usuário autenticado
- Registrar timestamp UTC
- Registrar valores antes e depois (UPDATE)
- Retenção de 7 anos
- Exportável para análise externa

---

### RN-RF055-18 — Validação de Custos de Origem

**Descrição**: Antes de processar rateio, validar que existem custos no período.

**Justificativa**: Evitar processamento vazio, indicar problema de integração.

**Critério de Aceite**:
- Se valor total = 0 → rejeitar processamento
- Notificar falta de custos para o período
- Sugerir verificação de integração com fonte de custos
- Registrar tentativa de processamento sem dados

---

### RN-RF055-19 — Reprocessamento de Períodos Anteriores

**Descrição**: Permitir reprocessar rateio de período anterior com regra atual ou histórica.

**Justificativa**: Correção de erros, ajustes retroativos, compliance.

**Critério de Aceite**:
- Selecionar período a reprocessar
- Selecionar versão da regra a aplicar
- Marcar como reprocessamento (não substituir original)
- Comparar com rateio original
- Exigir aprovação adicional para reprocessamentos
- Registrar motivo do reprocessamento

---

### RN-RF055-20 — Cancelamento de Rateio

**Descrição**: Permitir cancelar rateio aprovado mas ainda não exportado.

**Justificativa**: Correção de erros antes de impactar contabilidade.

**Critério de Aceite**:
- Apenas rateios APROVADO podem ser cancelados
- Rateios EXPORTADO não podem ser cancelados
- Exigir justificativa de cancelamento
- Registrar usuário e timestamp
- Transição: APROVADO → CANCELADO
- Notificar aprovador original

---

## 6. ESTADOS DA ENTIDADE

### 6.1 Estados de Rateio

| Estado | Descrição |
|------|-----------|
| PROCESSADO | Rateio calculado automaticamente, aguardando aprovação |
| APROVADO | Rateio aprovado por gestor, pronto para export |
| EXPORTADO | Rateio enviado para sistema contábil |
| CANCELADO | Rateio cancelado antes de exportar |
| ERRO | Falha no processamento ou export |

### 6.2 Transições Permitidas

| De | Para | Condição |
|---|---|---|
| PROCESSADO | APROVADO | Usuário com permissão APPROVE |
| APROVADO | EXPORTADO | Export bem-sucedido |
| APROVADO | CANCELADO | Antes de exportar, com justificativa |
| PROCESSADO | ERRO | Falha na validação |
| EXPORTADO | (final) | Estado final |

### 6.3 Estados de Regra de Rateio

| Estado | Descrição |
|------|-----------|
| ATIVA | Regra vigente, sendo aplicada |
| INATIVA | Regra desativada, não aplicada |
| EXPIRADA | Regra fora do período de vigência |
| ARQUIVADA | Regra histórica versionada |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre | Payload |
|------|--------------|---------|
| RateioProcessado | Após processamento automático | RateioId, Periodo, ValorTotal |
| RateioAprovado | Após aprovação | RateioId, AprovadorId |
| RateioExportado | Após export para ERP | RateioId, Sistema, DocumentoId |
| RateioCancelado | Após cancelamento | RateioId, Motivo |
| RegraRateioAlterada | Após versionamento de regra | RegraId, VersaoAntiga, VersaoNova |
| AlertaVariacao | Variação > threshold | CentroCusto, Percentual |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhum rateio pode ser processado sem validação de totalização 100%
- Nenhum export pode ocorrer sem aprovação prévia
- Nenhum acesso pode violar isolamento de tenant
- Todas as operações devem ser auditadas
- Histórico deve ser mantido por 7 anos
- Performance: processar 10.000 centros de custo em < 5 minutos
- Precisão: cálculos com 4 casas decimais, arredondamento final para 2

---

## 9. SEGURANÇA

### 9.1 Controle de Acesso

| Permissão | Descrição |
|-----------|-----------|
| rateio.view_any | Listar rateios |
| rateio.view | Visualizar rateio específico |
| rateio.create | Criar regra de rateio |
| rateio.update | Atualizar regra de rateio |
| rateio.approve | Aprovar rateio processado |
| rateio.export | Exportar para ERP |
| rateio.cancel | Cancelar rateio aprovado |
| rateio.simulate | Simular cenários |
| rateio.reprocess | Reprocessar períodos anteriores |

### 9.2 Validações de Segurança

- Validação de entrada obrigatória em todos os campos
- Proteção contra SQL Injection (parameterização)
- Proteção contra valores negativos indevidos
- Isolamento multi-tenant em todas as queries
- Rate limiting em APIs de export
- Logs de acesso para auditoria

---

## 10. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF055.md** — Casos de Uso detalhados
- **MD-RF055.md** — Modelo de Dados completo
- **WF-RF055.md** — Wireframes e fluxos de tela
- **TC-RF055.yaml** — Casos de Teste
- **MT-RF055.yaml** — Massas de Teste

---

## 11. RASTREABILIDADE

### 11.1 Casos de Uso Esperados

- UC00-listar-rateios
- UC01-criar-regra-rateio
- UC02-visualizar-rateio
- UC03-editar-regra-rateio
- UC04-aprovar-rateio
- UC05-exportar-rateio
- UC06-simular-rateio
- UC07-dashboard-rateios

### 11.2 Integrações Obrigatórias

| Sistema | Tipo | Finalidade |
|---------|------|------------|
| i18n | Interna | Tradução de mensagens e labels |
| Auditoria | Interna | Registro de operações |
| RBAC | Interna | Controle de permissões |
| Central de Funcionalidades | Interna | Registro de feature |
| SAP | Externa | Export contábil |
| TOTVS Protheus | Externa | Export contábil |
| Conta Azul | Externa | Export contábil |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|------|------|----------|------|
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0: separação RF/RL completa, foco em contrato funcional moderno | Agência ALC - alc.dev.br |
| 1.0 | 2025-01-14 | Versão inicial com regras de negócio implementadas | Agência ALC - alc.dev.br |
