# RF036 - Gestão de Custos Fixos

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC007-FIN - Financeiro Processos
**Fase**: Fase 4 - Financeiro II - Processos

---

## 1. OBJETIVO DO REQUISITO

Implementar sistema completo para gerenciamento de despesas recorrentes mensais (custos fixos) com provisionamento automático, controle de variações orçamentárias, detecção de anomalias e análise de tendências, servindo como **contrato oficial** entre negócio, desenvolvimento, testes e agentes de IA.

Este documento **não define implementação**, apenas **o que o sistema deve fazer**, sob quais condições e quais garantias devem ser preservadas.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Cadastro completo de custos fixos mensais
- [x] Provisionamento automático de lançamentos mensais
- [x] Sistema de alertas de variação orçamentária (>10%, >20%, >30%)
- [x] Detecção automática de anomalias estatísticas
- [x] Análise de tendências e comparação Year-over-Year (YoY)
- [x] Dashboard gerencial com projeções de custos
- [x] Rateio multi-dimensional (centro de custo, filial)
- [x] Alertas de vencimento (7, 3, 1 dia antes)
- [x] Histórico completo de alterações
- [x] Aprovação gerencial para variações >30%
- [x] Controle de acesso RBAC por operação
- [x] Auditoria completa de todas operações
- [x] Multi-tenancy com isolamento por Fornecedor

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (responsabilidade do frontend)
- Tecnologia, framework ou linguagem (responsabilidade técnica)
- Layout, UX ou identidade visual (design system)
- Estratégia de deploy ou infraestrutura (DevOps)
- Integração direta com ERP externo (RF futuro)
- Pagamento automático de títulos (módulo financeiro)
- Gestão de custos variáveis (RF separado)
- Importação de faturas de serviços (módulo específico)

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-----|---------|
| **Custo Fixo** | Despesa recorrente mensal com valor relativamente constante (aluguel, energia, internet, telefonia, serviços) |
| **Provisionamento** | Criação automática de lançamento mensal baseado em histórico ou valor orçado |
| **Lançamento** | Registro específico de custo fixo em um mês de referência com valor provisionado e/ou realizado |
| **Valor Orçado** | Valor planejado/esperado para o custo fixo mensal |
| **Valor Realizado** | Valor efetivamente pago ou a pagar no mês de referência |
| **Variação Orçamentária** | Diferença percentual entre valor realizado e orçado |
| **Anomalia** | Valor realizado significativamente acima da média histórica (>2σ) |
| **YoY (Year-over-Year)** | Comparação do mesmo mês entre anos diferentes |
| **Rateio** | Distribuição do custo entre múltiplos centros de custo ou filiais |
| **Tenant** | Unidade lógica de isolamento de dados (Fornecedor) |

---

## 4. FUNCIONALIDADES COBERTAS

1. **CRUD de Custos Fixos**
   - Criar custo fixo com tipo, fornecedor, valor orçado, datas
   - Atualizar informações do custo fixo
   - Consultar custo fixo por ID
   - Listar custos fixos com filtros e paginação
   - Inativar/cancelar custo fixo (exclusão lógica)

2. **Provisionamento Automático**
   - Job mensal que cria lançamentos automaticamente
   - Replicação de valor do mês anterior ou valor orçado
   - Notificações de provisionamento realizado

3. **Gestão de Lançamentos**
   - Atualizar valor realizado de lançamento provisionado
   - Informar justificativa para variações significativas
   - Solicitar aprovação gerencial para variações >30%
   - Aprovar ou reprovar lançamentos

4. **Alertas e Monitoramento**
   - Alertas automáticos de variação orçamentária (3 níveis)
   - Detecção de anomalias estatísticas
   - Alertas de vencimento (7, 3, 1 dia antes)

5. **Análise e Relatórios**
   - Dashboard de custos fixos por categoria
   - Top 10 maiores custos fixos
   - Gráfico de evolução mensal por categoria
   - Análise Year-over-Year (YoY)
   - Projeção de custos futuros (3, 6, 12 meses)
   - Ranking de maiores variações

6. **Rateio Multi-Dimensional**
   - Configurar rateio por centro de custo
   - Configurar rateio por filial
   - Validação automática de soma = 100%

---

## 5. REGRAS DE NEGÓCIO

### RN-RF036-01 — Campos obrigatórios no cadastro

**Descrição**: Todo custo fixo deve ter descrição, tipo de custo, valor orçado mensal, data de início e status obrigatórios.

**Justificativa**: Garante informações mínimas para provisionamento automático e controle orçamentário.

**Tipo**: Validação

**Campos Afetados**: Descricao, TipoCustoFixoId, ValorOrcadoMensal, DataInicio, Status

**Obrigatório**: Sim

**Critério de Aceite**:
- Campo ausente → HTTP 400 com mensagem específica
- Campo vazio ou inválido → HTTP 400 com mensagem específica
- Descrição com mais de 500 caracteres → HTTP 400
- Valor orçado ≤ 0 → HTTP 400
- Data de início futura → HTTP 400

---

### RN-RF036-02 — Provisionamento automático mensal

**Descrição**: No primeiro dia útil de cada mês, o sistema deve criar automaticamente lançamentos de custos fixos ativos baseados no valor do mês anterior ou valor orçado.

**Justificativa**: Automatiza processo de provisionamento e evita esquecimento de lançamentos recorrentes.

**Tipo**: Regra de Negócio

**Critério de Aceite**:
- Job executado no 1º dia útil de cada mês
- Apenas custos com Status=Ativo são provisionados
- Apenas custos com DataInicio ≤ hoje são provisionados
- Custos com DataFim < hoje NÃO são provisionados
- Valor provisionado = valor realizado mês anterior (se existir) OU valor orçado
- FlProvisionamentoAutomatico = true no lançamento criado
- Notificação enviada ao responsável após provisionamento

---

### RN-RF036-03 — Alertas de variação orçamentária (3 níveis)

**Descrição**: Quando o valor realizado diferir do valor orçado em mais de 10%, 20% ou 30%, o sistema deve emitir alertas com níveis de severidade crescentes.

**Justificativa**: Permite ação proativa da gestão financeira sobre desvios significativos.

**Tipo**: Regra de Negócio

**Critério de Aceite**:
- Variação ≥10% e <20% → Alerta Informativo
- Variação ≥20% e <30% → Alerta de Aviso (warning)
- Variação ≥30% → Alerta Crítico + flag RequereAprovacaoGerencial = true
- Alerta enviado ao usuário responsável do custo fixo
- Percentual de variação calculado como: |valorRealizado - valorOrcado| / valorOrcado * 100

---

### RN-RF036-04 — Justificativa obrigatória para variações >20%

**Descrição**: Variações superiores a 20% entre valor realizado e orçado devem ter justificativa obrigatória.

**Justificativa**: Documenta razões de variações significativas para auditoria e análise gerencial.

**Tipo**: Validação

**Campos Afetados**: Justificativa

**Critério de Aceite**:
- Variação >20% sem justificativa → HTTP 400
- Justificativa deve ter no mínimo 10 caracteres
- Justificativa persistida no lançamento

---

### RN-RF036-05 — Aprovação gerencial para variações >30%

**Descrição**: Lançamentos com variação superior a 30% requerem aprovação gerencial antes de serem considerados válidos.

**Justificativa**: Garante governança em custos com desvios muito significativos.

**Tipo**: Regra de Negócio

**Critério de Aceite**:
- Variação >30% → RequereAprovacaoGerencial = true automaticamente
- Status do lançamento = AguardandoAprovacao
- Apenas usuários com permissão GES.CUSTOS_FIXOS.APROVAR podem aprovar
- Ao reprovar, justificativa é obrigatória
- Ao aprovar, lançamento muda para Status = Aprovado

---

### RN-RF036-06 — Rateio multi-dimensional com soma = 100%

**Descrição**: Um custo fixo pode ser rateado entre múltiplos centros de custo e/ou filiais, com percentuais que devem totalizar exatamente 100%.

**Justificativa**: Permite alocação precisa de custos compartilhados entre áreas ou unidades.

**Tipo**: Validação

**Campos Afetados**: ItensRateio[].Percentual

**Critério de Aceite**:
- Soma dos percentuais ≠ 100% → HTTP 400
- Deve haver ao menos 1 item de rateio
- Cada item deve ter Percentual > 0 e ≤ 100
- Cada item deve ter CentroCustoId válido

---

### RN-RF036-07 — Detecção automática de anomalias

**Descrição**: O sistema deve detectar automaticamente aumentos anormais comparando o valor realizado com a média dos últimos 6 meses usando estatística (média + 2σ).

**Justificativa**: Identifica custos que podem estar incorretos ou fora do padrão histórico.

**Tipo**: Regra de Negócio

**Critério de Aceite**:
- Mínimo 3 meses de histórico necessários
- Anomalia detectada se: valorAtual > média + (2 × desvio padrão)
- FlAnomalia = true no lançamento
- DescricaoAnomalia preenchida com detalhes
- Alerta enviado ao responsável

---

### RN-RF036-08 — Data de fim opcional mas validada

**Descrição**: Um custo fixo pode ter data de fim opcional. Se informada, deve ser posterior à data de início e lançamentos futuros não são provisionados após esta data.

**Justificativa**: Permite controle de custos temporários ou contratos com prazo definido.

**Tipo**: Validação

**Campos Afetados**: DataFim

**Critério de Aceite**:
- DataFim < DataInicio → HTTP 400
- Provisionamento automático NÃO cria lançamento para mês > DataFim

---

### RN-RF036-09 — Vinculação a fornecedor e contrato

**Descrição**: Um custo fixo pode ser vinculado a um fornecedor e/ou contrato específico para rastreabilidade.

**Justificativa**: Facilita análise de custos por fornecedor e acompanhamento de contratos.

**Tipo**: Regra de Negócio

**Campos Afetados**: FornecedorId, ContratoId

**Critério de Aceite**:
- FornecedorId informado → deve existir e pertencer ao mesmo FornecedorId
- ContratoId informado → deve existir e pertencer ao mesmo FornecedorId
- Ambos são opcionais

---

### RN-RF036-10 — Status do custo fixo

**Descrição**: Um custo fixo pode ter os status: Ativo, Inativo, Suspenso, Cancelado. Apenas custos "Ativos" são provisionados automaticamente.

**Justificativa**: Permite controle de ciclo de vida do custo sem deletar informações históricas.

**Tipo**: Regra de Negócio

**Campos Afetados**: Status

**Critério de Aceite**:
- Status deve ser um dos valores do enum: 1=Ativo, 2=Inativo, 3=Suspenso, 4=Cancelado
- Provisionamento automático considera apenas Status = Ativo
- Status inválido → HTTP 400

---

### RN-RF036-11 — Alertas de vencimento (7, 3, 1 dia antes)

**Descrição**: O sistema deve enviar alertas 7, 3 e 1 dia antes do vencimento de custos fixos com data de vencimento cadastrada.

**Justificativa**: Evita atrasos de pagamento e multas.

**Tipo**: Regra de Negócio

**Critério de Aceite**:
- Job diário verifica vencimentos em 7, 3 e 1 dia
- Alerta enviado apenas para lançamentos com Status ≠ Pago
- Severidade do alerta: 7 dias = Informativo, 3 dias = Aviso, 1 dia = Crítico

---

### RN-RF036-12 — Bloqueio de edição de lançamentos pagos

**Descrição**: Lançamentos com status "Pago" não podem ser editados ou excluídos, apenas visualizados.

**Justificativa**: Previne alterações em registros já processados financeiramente.

**Tipo**: Validação

**Critério de Aceite**:
- Tentativa de atualização de lançamento com Status=Pago → HTTP 400
- Tentativa de exclusão de lançamento com Status=Pago → HTTP 400
- Visualização permanece permitida

---

### RN-RF036-13 — Isolamento multi-tenant

**Descrição**: Todos os custos fixos e lançamentos devem estar isolados por FornecedorId. Um usuário só pode acessar dados do seu próprio Fornecedor.

**Justificativa**: Garantir isolamento de dados em ambiente multi-tenant.

**Tipo**: Segurança

**Critério de Aceite**:
- Tentativa de acesso a custo fixo de outro Fornecedor → HTTP 404
- Queries automáticas filtram por FornecedorId do usuário autenticado
- FornecedorId obrigatório em criação

---

## 6. ESTADOS DA ENTIDADE

### Entidade: CustoFixo

| Estado | Código | Descrição |
|--------|--------|-----------|
| Ativo | 1 | Custo fixo ativo, será provisionado automaticamente |
| Inativo | 2 | Custo fixo inativo, não será provisionado |
| Suspenso | 3 | Custo fixo temporariamente suspenso |
| Cancelado | 4 | Custo fixo cancelado definitivamente |

### Entidade: LancamentoCustoFixo

| Estado | Código | Descrição |
|--------|--------|-----------|
| Provisionado | 1 | Lançamento criado automaticamente, valor ainda não confirmado |
| Realizado | 2 | Valor realizado informado |
| AguardandoAprovacao | 3 | Lançamento com variação >30% aguardando aprovação gerencial |
| Aprovado | 4 | Lançamento aprovado pela gerência |
| Pago | 5 | Lançamento pago, não pode ser mais editado |
| Cancelado | 6 | Lançamento cancelado |

### Transições permitidas (LancamentoCustoFixo)

| De | Para | Condição |
|---|---|---|
| Provisionado | Realizado | Valor realizado informado, variação ≤30% |
| Provisionado | AguardandoAprovacao | Valor realizado informado, variação >30% |
| Realizado | AguardandoAprovacao | Recálculo identificou variação >30% |
| AguardandoAprovacao | Aprovado | Aprovação gerencial concedida |
| AguardandoAprovacao | Cancelado | Aprovação gerencial negada |
| Realizado | Pago | Pagamento efetuado |
| Aprovado | Pago | Pagamento efetuado |

### Transições proibidas

| De | Para | Motivo |
|---|---|---|
| Pago | * | Lançamentos pagos são imutáveis |
| Cancelado | * | Lançamentos cancelados não podem ser reativados |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre | Dados do Evento |
|--------|---------------|-----------------|
| CustoFixoCriado | Após criação bem-sucedida | Id, Descricao, ValorOrcado, FornecedorId |
| CustoFixoAtualizado | Após atualização | Id, CamposAlterados |
| CustoFixoInativado | Mudança de status para Inativo | Id, MotivoInativacao |
| LancamentoProvisionado | Job de provisionamento cria lançamento | CustoFixoId, MesReferencia, ValorProvisionado |
| VariacaoOrcamentariaDetectada | Variação >10% identificada | LancamentoId, PercentualVariacao, NivelSeveridade |
| AnomaliaDetectada | Valor fora do padrão estatístico | LancamentoId, ValorAtual, MediaHistorica |
| AprovacaoSolicitada | Lançamento com variação >30% | LancamentoId, UsuarioResponsavel |
| LancamentoAprovado | Aprovação gerencial concedida | LancamentoId, AprovadoPor |
| VencimentoProximo | Alerta de vencimento (7, 3, 1 dia) | LancamentoId, DiasRestantes |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant (FornecedorId)
- Nenhuma regra de negócio pode ser ignorada
- Todas as validações devem retornar HTTP 400 com mensagens claras
- Erros devem ser previsíveis e rastreáveis
- Auditoria deve registrar quem, quando e o quê mudou (campos: UsuarioCriacaoId, DataCriacao, UsuarioAlteracaoId, DataAlteracao)
- Exclusão lógica obrigatória (FlExcluido = true)
- Jobs devem ser idempotentes (executar duas vezes não cria duplicatas)
- Provisionamento automático deve ocorrer no 1º dia útil do mês
- Alertas devem ser enviados em tempo real via notificação

---

## 9. SEGURANÇA

### 9.1 Validação de Entrada

- Todos os campos obrigatórios devem ser validados
- Tipos de dados devem ser validados (decimal, date, enum)
- Tamanhos máximos devem ser respeitados (Descricao ≤ 500 caracteres)
- Proteção contra injeção de SQL (uso de ORM)

### 9.2 Controle de Permissões

Cada operação exige permissão explícita:

| Operação | Permissão Necessária |
|----------|---------------------|
| Visualizar custo fixo | GES.CUSTOS_FIXOS.VIEW |
| Listar custos fixos | GES.CUSTOS_FIXOS.VIEW |
| Criar custo fixo | GES.CUSTOS_FIXOS.CREATE |
| Atualizar custo fixo | GES.CUSTOS_FIXOS.UPDATE |
| Excluir custo fixo | GES.CUSTOS_FIXOS.DELETE |
| Aprovar lançamento | GES.CUSTOS_FIXOS.APROVAR |
| Executar provisionamento manual | GES.CUSTOS_FIXOS.PROVISIONAR |
| Exportar relatórios | GES.CUSTOS_FIXOS.EXPORT |

### 9.3 Isolamento Multi-Tenant

- Todas as queries devem filtrar automaticamente por FornecedorId do usuário autenticado
- Tentativas de acesso cruzado devem retornar HTTP 404 (não 403, para não revelar existência)
- FornecedorId deve ser obrigatório em todas as entidades

---

## 10. ARTEFATOS DERIVADOS

Este RF é base obrigatória para:

- **UC-RF036.md** - Casos de Uso (5 padrão + específicos)
- **MD-RF036.yaml** - Modelo de Dados (estrutura de tabelas)
- **WF-RF036.md** - Wireframes (telas e fluxos)
- **MT-RF036.yaml** - Massas de Teste (dados para testes)
- **TC-RF036.yaml** - Casos de Teste (cobertura de regras)

---

## 11. RASTREABILIDADE

| Artefato | Status | Obrigatório |
|---------|--------|-------------|
| UC-RF036.md | Pendente | Sim |
| MD-RF036.yaml | Pendente | Sim |
| WF-RF036.md | Pendente | Sim |
| MT-RF036.yaml | Pendente | Sim |
| TC-RF036.yaml | Pendente | Sim |

**Referência ao Legado**: RL-RF036.md (documentação histórica, sem valor contratual)

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-30 | Migração v1.0 → v2.0: Separação RF/RL completa, 11 seções obrigatórias, 13 RNs detalhadas, estados e eventos de domínio | Agência ALC - alc.dev.br |
| 1.0 | 2025-12-17 | Versão inicial com conteúdo legado misturado | Architect Agent |
