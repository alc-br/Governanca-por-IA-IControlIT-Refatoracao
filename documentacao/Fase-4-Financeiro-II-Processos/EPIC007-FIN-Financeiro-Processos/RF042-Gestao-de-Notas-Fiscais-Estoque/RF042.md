# RF042 - Gestão de Notas Fiscais Estoque

**Versão**: 2.0
**Data**: 2025-12-30
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC007-FIN-Financeiro-Processos
**Fase**: Fase-4-Financeiro-II-Processos

---

## 1. VISÃO GERAL

### 1.1 Objetivo do Requisito

Implementar sistema completo de gestão de notas fiscais eletrônicas de entrada de estoque (NFe), incluindo importação automatizada de arquivos XML via upload e monitoramento de e-mail, validação automática junto à SEFAZ, processamento OCR de PDFs escaneados, conciliação com pedidos de compra, cálculo automático de impostos (ICMS, IPI, PIS, COFINS, DIFAL), rateio proporcional de frete e despesas acessórias, lançamento automático no estoque com atualização de custo médio, workflow de aprovação com SLA configurável, geração de DANFE em PDF/A com QR Code, e integração com ERPs externos via API REST.

### 1.2 Justificativa de Negócio

A gestão eficaz de notas fiscais de entrada é crucial para garantir conformidade fiscal com a legislação brasileira (armazenamento obrigatório de XMLs por 7 anos), eliminar erros manuais de digitação que representam 15-20% dos casos em sistemas legados, acelerar o processo de entrada de mercadorias reduzindo tempo médio de 3 dias para 4 horas, identificar divergências entre pedido e recebimento antes do pagamento ao fornecedor (economia média de 2-5% do valor de compras), e fornecer visibilidade completa da cadeia de suprimentos desde emissão da NFe até entrada física no almoxarifado.

### 1.3 Escopo

**Dentro do escopo:**
- Importação de XMLs de NFe (upload manual drag-and-drop múltiplo e automática via monitoramento de e-mail IMAP/Exchange)
- Parsing completo de XML conforme layout SEFAZ v4.0 (extração de 300+ campos)
- Validação automática de chave de acesso (44 dígitos) junto à SEFAZ via WebService oficial
- OCR de PDFs escaneados com Tesseract + Azure Form Recognizer (taxa de precisão >95%)
- Detecção de duplicatas por chave de acesso + tenant
- Conciliação automática NFe ↔ Pedido de Compra via CNPJ fornecedor + número pedido
- Comparação item a item: código produto, quantidade, valor unitário com tolerâncias configuráveis (±5% quantidade, ±2% preço)
- Cálculo automático de impostos: ICMS (próprio, ST, DIFAL), IPI (Tabela TIPI), PIS/COFINS (cumulativo/não-cumulativo), ISS
- Rateio de frete e despesas acessórias proporcionalmente por peso ou valor
- Workflow de aprovação com 3 níveis: Comprador (<R$ 500) → Gestor (R$ 500-5.000) → Financeiro (>R$ 5.000)
- Lançamento automático no estoque com atualização de quantidade disponível e custo médio ponderado
- Geração de DANFE em PDF/A-1b com QR Code para consulta SEFAZ
- Notificações em tempo real via SignalR (NFe importada, divergência detectada, SLA vencido)
- Armazenamento de XMLs originais em blob storage criptografado (AES-256) por 7 anos
- Dashboard executivo com KPIs: volume mensal, top fornecedores, divergências pendentes, tempo médio aprovação
- Multi-tenancy com isolamento por ClienteId e limites por plano (Básico: 1.000 NFes/mês, Profissional: 5.000 NFes/mês, Enterprise: ilimitado)
- Integração com ERPs externos (SAP, TOTVS, Protheus) via API REST com retry automático

**Fora do escopo:**
- NFes de saída (venda/transferência) - coberto por outro RF
- Conhecimento de Transporte Eletrônico (CTe) - coberto por RF específico
- Manifestação do Destinatário (MDe) - coberto por RF específico
- Integração com portais de fornecedores (apenas e-mail e upload manual)
- Configuração avançada de regimes tributários especiais (Simples Nacional, Zona Franca)

---

## 2. FUNCIONALIDADES

### F01 - Importação Automatizada de XML NFe

Sistema monitora caixa de e-mail corporativa (ex: nfe@empresa.com) a cada 15 minutos via Hangfire job, busca e-mails não lidos com assunto contendo "NFe", "Nota Fiscal" ou "XML", extrai anexos com extensão .xml, valida se tag raiz é `<nfeProc>` ou `<NFe>`, importa automaticamente criando registro em NotaFiscalEstoque, marca e-mail como lido, e armazena XML original em blob storage. Permite também upload via drag-and-drop de múltiplos arquivos simultaneamente com barra de progresso.

**Prioridade:** CRÍTICA

### F02 - Validação Automática junto à SEFAZ

Toda NFe importada é validada automaticamente consultando WebService SEFAZ (https://nfe.fazenda.sp.gov.br/ws/nfeconsultaprotocolo4.asmx) enviando chave de acesso (44 dígitos), recebendo status de autorização (100=Autorizada, 101=Cancelada, 110=Denegada), protocolo de autorização, data/hora de autorização, e digest de assinatura digital. Se status ≠ 100, NFe é marcada como "Inválida" e bloqueada para lançamento. Retry automático com backoff exponencial (1s, 2s, 4s, 8s, 16s) em caso de indisponibilidade da SEFAZ, máximo 3 tentativas. Cache de 1 hora para evitar consultas repetidas.

**Prioridade:** CRÍTICA

### F03 - OCR de PDFs Escaneados com Fallback SEFAZ

Quando fornecedor envia apenas DANFE em PDF (sem XML), sistema processa via OCR duplo: Tesseract (gratuito, rápido) + Azure Form Recognizer (pago, alta precisão). Pré-processamento converte PDF para PNG 300 DPI com melhoria de contraste. OCR extrai chave de acesso, número NFe, CNPJ emitente, itens, valores. Se chave detectada com confiança ≥85%, busca XML oficial na SEFAZ via WebService NFeDistribuicaoDFe. Se chave não detectada, extrai dados manualmente e solicita revisão manual se confiança <85%.

**Prioridade:** ALTA

### F04 - Conciliação Automática com Pedidos de Compra

Sistema cruza automaticamente NFe recebida com pedido de compra correspondente via CNPJ fornecedor + número do pedido (campo xPed da NFe) ou CNPJ + data + valor aproximado (±10%). Compara item a item: código produto (cProd), quantidade (qCom vs qPed), valor unitário (vUnCom vs vUnPed). Tolerâncias configuráveis: quantidade ±5%, valor ±2%. Se divergência >tolerância: cria alerta, envia notificação SignalR para comprador responsável e encaminha para workflow de aprovação. Se divergência <tolerância: aprova automaticamente.

**Prioridade:** ALTA

### F05 - Cálculo Automático de Impostos Conforme Legislação

Engine fiscal calcula automaticamente todos os impostos com base em alíquotas vigentes atualizadas mensalmente (fonte: CONFAZ, RFB): ICMS próprio (vBC × pICMS), ICMS ST, DIFAL (diferencial entre UF origem e destino), IPI (Tabela TIPI por NCM), PIS/COFINS (regime cumulativo vs não-cumulativo conforme CST), ISS para serviços. Respeita regras de redução de base de cálculo, isenções e imunidades. Armazena detalhamento de impostos em campo JSON para auditoria.

**Prioridade:** ALTA

### F06 - Rateio de Frete e Despesas Acessórias

Frete total da NFe (campo vFrete) é rateado entre itens proporcionalmente conforme critério configurável: por peso ((peso_item / peso_total) × frete_total), por valor ((valor_item / valor_total) × frete_total), ou por quantidade. Também rateia seguro, despesas aduaneiras e outras despesas acessórias. Arredondamento: últimos centavos ajustados no item de maior valor. Custo médio de estoque atualizado com: (valor_item + frete_rateado + despesas_rateadas) / quantidade.

**Prioridade:** MÉDIA

### F07 - Lançamento Automático no Estoque

NFe aprovada gera automaticamente movimentação tipo "ENTRADA_COMPRA" para cada item, atualizando tabela Estoque: Quantidade += quantidade_nfe, Custo_Medio = (estoque_atual × custo_atual + qtd_nfe × custo_nfe) / (estoque_atual + qtd_nfe), Data_Ultima_Compra = data_nfe, Id_Ultima_NFe = id_nfe. Se produto não existe, cria automaticamente com dados da NFe. Gera notificação SignalR para almoxarifado: "Mercadoria aguardando recebimento físico - NFe XXXXX".

**Prioridade:** CRÍTICA

### F08 - Workflow de Aprovação com SLA

NFes com divergências seguem workflow configurável por valor: <R$ 500 (Comprador aprova sozinho), R$ 500-5.000 (Comprador + Gestor), >R$ 5.000 (Comprador + Gestor + Financeiro). SLA padrão: 24 horas por etapa. Se SLA vencido: escalação automática para superior hierárquico. Comentários obrigatórios em aprovações com divergência >R$ 1.000. Histórico completo: timestamp, usuário, ação (aprovado/rejeitado), justificativa.

**Prioridade:** ALTA

### F09 - Geração de DANFE em PDF/A

Sistema gera DANFE (Documento Auxiliar da NFe) em formato PDF/A-1b (ISO 19005-1) para arquivamento de longo prazo (7 anos). Template oficial SEFAZ com 10 seções: cabeçalho, emitente, destinatário, fatura, cálculo imposto, transportador, dados produtos, ISSQN, dados adicionais, QR Code. QR Code contém URL para consulta SEFAZ (https://nfe.fazenda.sp.gov.br/NFeConsultaPublica/...). Marca d'água "CANCELADA" em NFes canceladas. Compressão otimizada: 100-200 KB por DANFE. Armazena em blob storage.

**Prioridade:** MÉDIA

### F10 - Alertas em Tempo Real via SignalR

Notificações push em tempo real para usuários via SignalR Hub: NFeImportada (notifica comprador responsável), NFeComDivergencia (alerta comprador + gestor), NFeAprovada (notifica almoxarifado + financeiro), NFeRejeitada (notifica comprador + fornecedor via e-mail), SLAVencido (escalação para superior). Notificações salvas em tabela Notificacoes mesmo se usuário offline. Badge de contagem atualizado automaticamente: "3 NFes aguardando aprovação".

**Prioridade:** MÉDIA

---

## 3. REGRAS DE NEGÓCIO

### RN-RF042-001: Importação Automática de E-mails com XML NFe

**Descrição:** O sistema DEVE monitorar automaticamente uma caixa de e-mail corporativa configurável (ex: nfe@empresa.com) e importar todos os anexos XML de notas fiscais eletrônicas recebidos.

**Critério de Aceite:**
- Job Hangfire executa a cada 15 minutos conectando via IMAP/Exchange
- Busca e-mails não lidos com assunto contendo "NFe", "Nota Fiscal", "XML" (case-insensitive)
- Extrai anexos com extensão .xml (ignora outros tipos)
- Valida se XML é NFe válida (tag raiz `<nfeProc>` ou `<NFe>`)
- Importa automaticamente criando registro em NotaFiscalEstoque
- Marca e-mail como lido após importação bem-sucedida
- Se importação falhar, marca como não lido para retry
- Armazena XML original em blob storage criptografado (AES-256) por 7 anos

**Validações:**
- Caixa de e-mail DEVE estar acessível (credenciais válidas)
- XML DEVE ser válido conforme schema SEFAZ v4.0
- CNPJ destinatário DEVE pertencer ao tenant logado (multi-tenancy)
- NFe NÃO PODE estar duplicada (chave de acesso única por tenant)

**Prioridade:** CRÍTICA

---

### RN-RF042-002: Validação Automática na SEFAZ

**Descrição:** Toda NFe importada DEVE ser validada automaticamente junto à base da SEFAZ via WebService oficial para garantir autenticidade e status de autorização.

**Critério de Aceite:**
- Consulta WebService SEFAZ estadual apropriado baseado em UF emissor
- Envia chave de acesso (44 dígitos) via método NFeConsultaProtocolo
- Recebe status (100=Autorizada, 101=Cancelada, 110=Denegada, etc.)
- Armazena protocolo de autorização, data/hora, digest de assinatura
- Se status ≠ 100, marca NFe como "Inválida" e bloqueia lançamento
- Retry automático se SEFAZ indisponível: máx 3 tentativas com backoff exponencial (1s, 2s, 4s)
- Cache de resultado por 1 hora para evitar consultas repetidas da mesma chave

**Validações:**
- Chave de acesso DEVE ter exatamente 44 dígitos
- Status SEFAZ DEVE ser 100 (Autorizada) para permitir lançamento
- Data de autorização DEVE ser ≤ data atual
- Assinatura digital DEVE ser válida

**Prioridade:** CRÍTICA

---

### RN-RF042-003: OCR de PDFs com Fallback para Busca na SEFAZ

**Descrição:** Quando fornecedor envia apenas DANFE em PDF (sem XML), sistema DEVE aplicar OCR inteligente para extrair dados e, se detectar chave de acesso, buscar XML oficial na SEFAZ.

**Critério de Aceite:**
- Aceita upload de PDF via interface
- Pré-processa: converte para PNG 300 DPI com melhoria de contraste e remoção de ruído
- Aplica OCR duplo: Tesseract (gratuito) + Azure Form Recognizer (pago)
- Busca padrão regex para chave de acesso (44 dígitos consecutivos)
- Se chave encontrada com confiança ≥85%: consulta SEFAZ via NFeDistribuicaoDFe para download XML oficial
- Se chave NÃO encontrada: extrai manualmente número, CNPJ emitente, itens, valores
- Se confiança <85%: solicita revisão manual

**Validações:**
- PDF DEVE ser legível (não corrompido)
- Confiança do OCR DEVE ser ≥85% para processamento automático
- Se chave detectada, XML SEFAZ DEVE ser encontrado
- CNPJ emitente no PDF DEVE corresponder ao CNPJ no XML

**Prioridade:** ALTA

---

### RN-RF042-004: Conciliação Automática NFe ↔ Pedido de Compra

**Descrição:** Sistema DEVE cruzar automaticamente NFe recebida com pedido de compra correspondente, validando CNPJ fornecedor, itens, quantidades e valores conforme tolerâncias configuráveis.

**Critério de Aceite:**
- Matching por: CNPJ fornecedor + Número do Pedido (campo xPed da NFe) OU CNPJ + Data + Valor aproximado (±10%)
- Compara item a item: código produto (cProd), quantidade (qCom vs qPed), valor unitário (vUnCom vs vUnPed)
- Tolerâncias configuráveis: Quantidade ±5%, Valor ±2% (padrão, ajustável por empresa)
- Se divergência >tolerância: cria alerta com detalhamento item a item e encaminha para workflow aprovação
- Se divergência <tolerância: aprova automaticamente
- Notifica comprador responsável via SignalR e e-mail

**Validações:**
- Pedido DEVE existir e estar ativo (status ≠ Cancelado)
- CNPJ emitente NFe DEVE corresponder ao CNPJ fornecedor do pedido
- Todos os itens da NFe DEVEM estar no pedido (ou ser aprovados como "item extra")
- Divergências acima da tolerância EXIGEM justificativa obrigatória

**Prioridade:** ALTA

---

### RN-RF042-005: Cálculo Automático de Impostos Conforme Legislação Vigente

**Descrição:** Sistema DEVE calcular automaticamente todos os impostos (ICMS, IPI, PIS, COFINS, DIFAL, ISS) com base nas alíquotas vigentes, NCM, CFOP e UF origem/destino.

**Critério de Aceite:**
- Engine fiscal com tabelas de alíquotas atualizadas mensalmente (fonte: CONFAZ, RFB)
- Cálculo ICMS: Próprio (vBC × pICMS), ST (vBCST × pICMSST), DIFAL ((alíquota_destino - alíquota_origem) × vBC)
- Cálculo IPI: Tabela TIPI por NCM (8 dígitos)
- Cálculo PIS/COFINS: Regime cumulativo (CST 01, 02) vs não-cumulativo (CST 50, 51, 52)
- Respeita redução de base de cálculo, isenções e imunidades
- Armazena detalhamento em campo JSON: ImpostosDetalhes { ICMS: {}, IPI: {}, PIS: {}, COFINS: {} }

**Validações:**
- NCM DEVE ser válido (8 dígitos, existir em tabela oficial)
- CFOP DEVE existir na tabela de CFOPs
- Alíquotas DEVEM ser da competência correta (vigentes na data da NFe)
- Base de cálculo NÃO PODE ser negativa

**Prioridade:** ALTA

---

### RN-RF042-006: Rateio Proporcional de Frete por Peso ou Valor

**Descrição:** Valor do frete total da NFe DEVE ser rateado entre os itens proporcionalmente ao peso ou valor de cada um, impactando o custo médio de estoque.

**Critério de Aceite:**
- Frete total extraído do campo vFrete da NFe
- Critério de rateio configurável por empresa: Por peso, Por valor, Por quantidade
- Cálculo: frete_item = (critério_item / critério_total) × frete_total
- Arredondamento: últimos centavos ajustados no item de maior valor para garantir soma exata
- Custo médio atualizado: (valor_item + frete_rateado + outras_despesas) / quantidade
- Também rateia: seguro (vSeg), despesas acessórias (vOutro)

**Validações:**
- Soma dos rateios DEVE ser igual ao frete total (tolerância ±R$ 0,10)
- Critério de rateio DEVE estar configurado (padrão: por valor)
- Peso/valor dos itens NÃO PODE ser zero ou negativo

**Prioridade:** MÉDIA

---

### RN-RF042-007: Lançamento Automático no Estoque Após Aprovação

**Descrição:** NFe aprovada DEVE gerar automaticamente movimentação de entrada no estoque, atualizando quantidade disponível e custo médio ponderado.

**Critério de Aceite:**
- Trigger após aprovação final da NFe (status = "Aprovada")
- Cria movimentação tipo "ENTRADA_COMPRA" para cada item
- Atualiza tabela Estoque: Quantidade += quantidade_nfe, Custo_Medio = (estoque_atual × custo_atual + qtd_nfe × custo_nfe) / (estoque_atual + qtd_nfe)
- Registra Data_Ultima_Compra = data_nfe, Id_Ultima_NFe = id_nfe
- Se produto não existe: cria automaticamente com dados da NFe (código, descrição, unidade, NCM)
- Gera notificação SignalR para almoxarifado: "Mercadoria aguardando recebimento físico"
- Rastreabilidade: cada movimentação vinculada à NFe original via campo NotaFiscalId

**Validações:**
- NFe DEVE estar aprovada (status = "Aprovada")
- Produto DEVE existir ou ser criado automaticamente
- Quantidade DEVE ser >0
- Custo médio NÃO PODE ser negativo

**Prioridade:** CRÍTICA

---

### RN-RF042-008: Workflow de Aprovação com SLA Configurável

**Descrição:** NFes com divergências DEVEM seguir workflow de aprovação multinível conforme valor da divergência, com SLA configurável e escalação automática.

**Critério de Aceite:**
- Workflow configurável por valor de divergência: <R$ 500 (Comprador aprova sozinho), R$ 500-5.000 (Comprador + Gestor), >R$ 5.000 (Comprador + Gestor + Financeiro)
- SLA padrão: 24 horas por etapa (configurável)
- Se SLA vencido: escalação automática para superior hierárquico
- Comentários obrigatórios em aprovações com divergência >R$ 1.000
- Histórico completo: timestamp, usuário, ação (aprovado/rejeitado/ajustado), justificativa
- Notificações SignalR em cada transição de etapa

**Validações:**
- Todos os aprovadores DEVEM ter permissão RBAC adequada
- Comentário obrigatório se divergência >R$ 1.000
- Se rejeitado, bloquear lançamento e pagamento
- Se SLA vencido 2x consecutivas, escalar para diretoria

**Prioridade:** ALTA

---

### RN-RF042-009: Geração Automática de DANFE em PDF/A com QR Code

**Descrição:** Sistema DEVE gerar DANFE (Documento Auxiliar da NFe) em formato PDF/A-1b (ISO 19005-1) para arquivamento de longo prazo, com QR Code para consulta na SEFAZ.

**Critério de Aceite:**
- Template DANFE conforme layout oficial SEFAZ v4.0
- Geração via biblioteca iTextSharp ou PDFSharp
- QR Code contém: chave de acesso + URL consulta SEFAZ (https://nfe.fazenda.[UF].gov.br/NFeConsultaPublica/...)
- Marca d'água "CANCELADA" em vermelho diagonal em NFes canceladas
- Todas as fontes embutidas (Arial, Courier New)
- Compressão otimizada: 100-200 KB por DANFE
- Armazenamento em blob storage com retenção 7 anos
- Metadata PDF: Chave NFe, Data Emissão, CNPJ Emitente

**Validações:**
- PDF DEVE ser válido PDF/A-1b (sem JavaScript, sem criptografia)
- QR Code DEVE apontar para URL SEFAZ correta
- Todas as fontes DEVEM estar embutidas
- Tamanho máximo 5 MB por DANFE

**Prioridade:** MÉDIA

---

### RN-RF042-010: Detecção de Duplicatas por Chave de Acesso

**Descrição:** Sistema DEVE bloquear importação de NFes duplicadas verificando se chave de acesso já existe no banco de dados para o mesmo tenant.

**Critério de Aceite:**
- Índice único na tabela NotaFiscalEstoque: (ChaveAcesso, ClienteId, FlExcluido = 0)
- Validação antes de salvar: SELECT COUNT(*) WHERE ChaveAcesso = ? AND ClienteId = ?
- Se encontrada: rejeita com mensagem detalhada "NFe já importada em DD/MM/AAAA HH:MM por Usuário X"
- Log de tentativa de duplicação para auditoria (pode indicar fraude)
- Permite reimportação se NFe anterior foi cancelada ou rejeitada

**Validações:**
- Chave de acesso DEVE ser única por tenant
- Permitir reimportação SOMENTE se status anterior = "Cancelada" ou "Rejeitada"
- Logar todas as tentativas de duplicação (tabela AuditLog)

**Prioridade:** CRÍTICA

---

### RN-RF042-011: Integração com ERP via API REST

**Descrição:** Sistema DEVE exportar automaticamente dados de NFes aprovadas para ERPs externos (SAP, TOTVS, Protheus) via API REST padronizada JSON.

**Critério de Aceite:**
- API REST padronizada JSON com autenticação OAuth 2.0 ou API Key
- Payload completo: NFe + impostos detalhados + rateio de frete + pedido vinculado
- Retry automático em caso de falha: máx 5 tentativas com backoff exponencial (1s, 2s, 4s, 8s, 16s)
- Log de sincronização: timestamp, endpoint, request, response, status (sucesso/falha)
- Webhook reverso: ERP notifica IControlIT quando processar (opcional)
- Timeout: 10 segundos por requisição

**Validações:**
- API ERP DEVE estar acessível (timeout máx 10s)
- Response HTTP 200-299 = sucesso
- Se falhar 5 vezes, alertar equipe de TI via e-mail + SignalR
- Não bloquear lançamento no IControlIT se integração ERP falhar (assíncrono)

**Prioridade:** MÉDIA

---

### RN-RF042-012: Alertas em Tempo Real via SignalR

**Descrição:** Sistema DEVE enviar notificações push em tempo real para usuários quando NFe é importada, aprovada, rejeitada ou com divergência crítica.

**Critério de Aceite:**
- SignalR Hub: NotasFiscaisHub
- Grupos: por usuário, por departamento, por perfil RBAC
- Eventos: NFeImportada, NFeComDivergencia, NFeAprovada, NFeRejeitada, SLAVencido
- Notificações salvas em tabela Notificacoes mesmo se usuário offline
- Badge de contagem atualizado automaticamente: "3 NFes aguardando aprovação"
- Som de alerta configurável (ativado/desativado por usuário)

**Validações:**
- Usuário DEVE estar autenticado e conectado ao SignalR
- Notificação DEVE ser salva no banco mesmo se usuário offline
- Badge DEVE ser atualizado automaticamente ao reconectar
- Permitir marcar notificação como lida

**Prioridade:** MÉDIA

---

### RN-RF042-013: Retenção de XML Original por 7 Anos (Legislação Fiscal)

**Descrição:** Sistema DEVE armazenar XML original da NFe em blob storage com criptografia AES-256 por 7 anos conforme legislação fiscal brasileira.

**Critério de Aceite:**
- Upload para Azure Blob Storage ou AWS S3
- Criptografia em repouso: AES-256-CBC (chave armazenada em Azure Key Vault)
- Estrutura de pastas: /ano/mes/fornecedor-cnpj/NFe_ChaveAcesso.xml
- Política de retenção: 7 anos (2.555 dias) com lifecycle: Anos 0-2 (Hot Storage), Anos 2-5 (Cool Storage), Anos 5-7 (Archive Storage)
- Após 7 anos: exclusão automática ou transferência para Glacier (backup histórico)
- Backup redundante em datacenter secundário (geo-replicação)
- Auditoria: log de acesso ao XML (quem, quando, IP, motivo)

**Validações:**
- XML DEVE ser armazenado IMEDIATAMENTE após importação
- Criptografia AES-256 ou superior obrigatória
- Backup redundante em datacenter geograficamente diferente
- Logar TODOS os acessos ao XML (tabela AccessLog)

**Prioridade:** CRÍTICA

---

### RN-RF042-014: Dashboard Executivo de Notas Fiscais

**Descrição:** Sistema DEVE fornecer dashboard visual com KPIs de notas fiscais: volume mensal, top fornecedores, divergências pendentes, tempo médio de aprovação.

**Critério de Aceite:**
- Gráficos com ApexCharts ou Chart.js
- KPIs principais: Total NFes importadas no mês, Valor total (R$), NFes pendentes de aprovação, Tempo médio de aprovação, Top 10 fornecedores por valor, Taxa de divergência (%), NFes rejeitadas/canceladas
- Filtros: período (data início/fim), fornecedor (dropdown), comprador responsável, centro de custo
- Atualização em tempo real via SignalR (quando nova NFe importada/aprovada)
- Exportação: PDF (relatório formatado), Excel (dados brutos)
- Performance: carregar <2 segundos

**Validações:**
- Dados atualizados em tempo real via SignalR
- Filtros persistidos na sessão do usuário (localStorage)
- Exportação fiel ao filtro aplicado
- Performance: carregar <2 segundos para até 100.000 NFes

**Prioridade:** BAIXA

---

### RN-RF042-015: Multi-tenancy com Limite de NFes por Plano

**Descrição:** Sistema DEVE garantir isolamento completo de dados por tenant (ClienteId) com limites de importação conforme plano contratado.

**Critério de Aceite:**
- Filtro global EF Core: .Where(x => x.ClienteId == currentClienteId && x.FlExcluido == false)
- Limites por plano: Básico (1.000 NFes/mês), Profissional (5.000 NFes/mês), Enterprise (ilimitado)
- Se exceder limite: bloqueio de importação + alerta para upgrade de plano
- Dashboard de consumo: "Você usou 750/1.000 NFes neste mês (75%)"
- Reset automático todo dia 1º às 00:00 UTC
- Alertas proativos aos 80%, 90%, 95%, 100% do limite

**Validações:**
- ClienteId obrigatório em TODAS as queries
- Contador de consumo atualizado em tempo real (cache Redis)
- Reset automático no dia 1º às 00:00 UTC
- Alertas aos 80%, 90%, 95%, 100% do limite via e-mail + SignalR

**Prioridade:** CRÍTICA

---

## 4. INTEGRAÇÕES OBRIGATÓRIAS

### 4.1 Internacionalização (i18n)

**Namespace:** `ges.notasFiscaisEstoque`

Todas as mensagens, labels, títulos, validações e notificações DEVEM suportar 3 idiomas: pt-BR (padrão), en-US, es-ES.

**Chaves obrigatórias:**
- `ges.notasFiscaisEstoque.title` - "Gestão de Notas Fiscais Estoque"
- `ges.notasFiscaisEstoque.actions.import` - "Importar NFe"
- `ges.notasFiscaisEstoque.actions.approve` - "Aprovar NFe"
- `ges.notasFiscaisEstoque.fields.chaveAcesso` - "Chave de Acesso"
- `ges.notasFiscaisEstoque.status.autorizada` - "Autorizada pela SEFAZ"
- `ges.notasFiscaisEstoque.messages.importSuccess` - "NFe importada com sucesso!"
- `ges.notasFiscaisEstoque.validations.chaveAcessoInvalida` - "Chave de acesso inválida (deve ter 44 dígitos)"

**Fallback:** pt-BR → en-US → es-ES

### 4.2 Auditoria

Todas as operações DEVEM ser auditadas automaticamente via AuditInterceptor do EF Core.

**Campos obrigatórios:**
- `CriadoPor` (NVARCHAR(450)) - Usuário que importou a NFe
- `CriadoEm` (DATETIME2) - Data/hora da importação
- `AlteradoPor` (NVARCHAR(450)) - Último usuário que modificou
- `AlteradoEm` (DATETIME2) - Data/hora última modificação
- `AprovadoPor` (NVARCHAR(450)) - Usuário que aprovou
- `AprovadoEm` (DATETIME2) - Data/hora da aprovação

**Operações auditadas:**
- Importação de NFe (XML ou PDF)
- Validação na SEFAZ
- Aprovação (com justificativa se divergência)
- Rejeição (com motivo obrigatório)
- Lançamento no estoque
- Cancelamento/estorno
- Download de XML original
- Geração de DANFE
- Alteração de configurações

### 4.3 Controle de Acesso (RBAC)

**Módulo:** `GES.NOTAS_FISCAIS_ESTOQUE`

**Permissões obrigatórias:**

| Permissão | Código | Descrição | Roles Padrão |
|-----------|--------|-----------|--------------|
| Visualizar | `GES.NOTAS_FISCAIS_ESTOQUE.VIEW` | Visualizar lista e detalhes de NFes | Comprador, Gestor, Financeiro, Auditor |
| Importar | `GES.NOTAS_FISCAIS_ESTOQUE.IMPORT` | Importar XMLs/PDFs de NFes | Comprador, Almoxarife |
| Aprovar Menor | `GES.NOTAS_FISCAIS_ESTOQUE.APPROVE_MINOR` | Aprovar divergências <R$ 500 | Comprador |
| Aprovar Maior | `GES.NOTAS_FISCAIS_ESTOQUE.APPROVE_MAJOR` | Aprovar divergências >R$ 500 | Gestor, Diretor |
| Rejeitar | `GES.NOTAS_FISCAIS_ESTOQUE.REJECT` | Rejeitar NFes com problemas | Comprador, Gestor |
| Lançar Estoque | `GES.NOTAS_FISCAIS_ESTOQUE.POST_INVENTORY` | Forçar lançamento manual no estoque | Almoxarife, Gestor |
| Cancelar | `GES.NOTAS_FISCAIS_ESTOQUE.CANCEL` | Cancelar NFe lançada (estorno) | Gestor, Controller |
| Exportar | `GES.NOTAS_FISCAIS_ESTOQUE.EXPORT` | Exportar relatórios Excel/PDF | Comprador, Gestor, Auditor |
| Configurar | `GES.NOTAS_FISCAIS_ESTOQUE.CONFIGURE` | Configurar tolerâncias, SLAs, integração ERP | Super Admin, Diretor |
| Auditar | `GES.NOTAS_FISCAIS_ESTOQUE.AUDIT` | Acessar logs de auditoria completos | Auditor, Controller, Super Admin |

### 4.4 Central de Funcionalidades

**Registro obrigatório:**

```json
{
  "codigo": "GES.NOTAS_FISCAIS_ESTOQUE",
  "modulo": "Gestão",
  "titulo_i18n": "ges.notasFiscaisEstoque.title",
  "descricao_i18n": "ges.notasFiscaisEstoque.subtitle",
  "icone": "receipt_long",
  "rota": "/gestao/notas-fiscais-estoque",
  "ordem": 50,
  "ativo": true,
  "permissao_minima": "GES.NOTAS_FISCAIS_ESTOQUE.VIEW"
}
```

---

## 5. PERMISSÕES RBAC

Matriz de permissões detalhada com roles autorizadas e endpoints correspondentes.

| Funcionalidade | Permission Code | Roles Autorizadas | Endpoint API |
|----------------|-----------------|-------------------|--------------|
| Listar NFes | `GES.NOTAS_FISCAIS_ESTOQUE.VIEW` | Comprador, Gestor, Financeiro, Auditor | GET /api/notas-fiscais-estoque |
| Ver Detalhes NFe | `GES.NOTAS_FISCAIS_ESTOQUE.VIEW` | Comprador, Gestor, Financeiro, Auditor | GET /api/notas-fiscais-estoque/{id} |
| Importar XML | `GES.NOTAS_FISCAIS_ESTOQUE.IMPORT` | Comprador, Almoxarife | POST /api/notas-fiscais-estoque/import-xml |
| Importar PDF | `GES.NOTAS_FISCAIS_ESTOQUE.IMPORT` | Comprador, Almoxarife | POST /api/notas-fiscais-estoque/import-pdf |
| Validar SEFAZ | `GES.NOTAS_FISCAIS_ESTOQUE.VIEW` | Comprador, Gestor | POST /api/notas-fiscais-estoque/{id}/validar-sefaz |
| Aprovar (<R$ 500) | `GES.NOTAS_FISCAIS_ESTOQUE.APPROVE_MINOR` | Comprador | POST /api/notas-fiscais-estoque/{id}/aprovar |
| Aprovar (>R$ 500) | `GES.NOTAS_FISCAIS_ESTOQUE.APPROVE_MAJOR` | Gestor, Diretor | POST /api/notas-fiscais-estoque/{id}/aprovar |
| Rejeitar | `GES.NOTAS_FISCAIS_ESTOQUE.REJECT` | Comprador, Gestor | POST /api/notas-fiscais-estoque/{id}/rejeitar |
| Lançar Estoque | `GES.NOTAS_FISCAIS_ESTOQUE.POST_INVENTORY` | Almoxarife, Gestor | POST /api/notas-fiscais-estoque/{id}/lancar-estoque |
| Cancelar NFe | `GES.NOTAS_FISCAIS_ESTOQUE.CANCEL` | Gestor, Controller | DELETE /api/notas-fiscais-estoque/{id} |
| Gerar DANFE | `GES.NOTAS_FISCAIS_ESTOQUE.VIEW` | Comprador, Gestor, Auditor | GET /api/notas-fiscais-estoque/{id}/danfe |
| Download XML | `GES.NOTAS_FISCAIS_ESTOQUE.VIEW` | Comprador, Gestor, Auditor | GET /api/notas-fiscais-estoque/{id}/xml |
| Exportar Relatório | `GES.NOTAS_FISCAIS_ESTOQUE.EXPORT` | Comprador, Gestor, Auditor | GET /api/notas-fiscais-estoque/export |
| Configurar | `GES.NOTAS_FISCAIS_ESTOQUE.CONFIGURE` | Super Admin, Diretor | PUT /api/notas-fiscais-estoque/configuracoes |

---

## 6. API ENDPOINTS

Lista completa de endpoints REST API com métodos, rotas, autenticação, DTOs e descrições.

### GET /api/notas-fiscais-estoque

**Descrição:** Listar NFes com paginação, ordenação e filtros

**Autenticação:** Obrigatória (JWT Bearer)

**Autorização:** `RequireAuthorization(AuthorizationPolicies.NotasFiscaisEstoqueView)`

**Query Parameters:**
- `pageNumber` (int, padrão: 1)
- `pageSize` (int, padrão: 20, máx: 100)
- `sortBy` (string, padrão: "DataEmissao")
- `sortDirection` (string, "asc" ou "desc", padrão: "desc")
- `filtroFornecedor` (Guid, opcional)
- `filtroStatus` (string, opcional)
- `filtroDataInicio` (DateTime, opcional)
- `filtroDataFim` (DateTime, opcional)

**Response:** `PaginatedListDto<NotaFiscalEstoqueDto>` (HTTP 200)

---

### GET /api/notas-fiscais-estoque/{id}

**Descrição:** Consultar NFe por ID com detalhes completos

**Autenticação:** Obrigatória

**Autorização:** `RequireAuthorization(AuthorizationPolicies.NotasFiscaisEstoqueView)`

**Path Parameters:**
- `id` (Guid) - ID da NFe

**Response:** `NotaFiscalEstoqueDetalhadoDto` (HTTP 200) ou HTTP 404 se não encontrado

---

### POST /api/notas-fiscais-estoque/import-xml

**Descrição:** Importar NFe a partir de arquivo XML

**Autenticação:** Obrigatória

**Autorização:** `RequireAuthorization(AuthorizationPolicies.NotasFiscaisEstoqueImport)`

**Request DTO:** `ImportarNFeXmlCommand { XmlContent: string, NomeArquivo: string }`

**Response:** `Guid` (ID da NFe criada, HTTP 201) ou HTTP 400 se XML inválido

---

### POST /api/notas-fiscais-estoque/import-pdf

**Descrição:** Importar NFe a partir de PDF escaneado (com OCR)

**Autenticação:** Obrigatória

**Autorização:** `RequireAuthorization(AuthorizationPolicies.NotasFiscaisEstoqueImport)`

**Request DTO:** `ImportarNFePdfCommand { PdfContent: byte[], NomeArquivo: string }`

**Response:** `Guid` (ID da NFe criada, HTTP 201) ou HTTP 400 se OCR falhar

---

### POST /api/notas-fiscais-estoque/{id}/validar-sefaz

**Descrição:** Validar NFe junto à SEFAZ manualmente (forçar validação)

**Autenticação:** Obrigatória

**Autorização:** `RequireAuthorization(AuthorizationPolicies.NotasFiscaisEstoqueView)`

**Path Parameters:**
- `id` (Guid) - ID da NFe

**Response:** `ResultadoValidacaoSefazDto` (HTTP 200) ou HTTP 400 se SEFAZ indisponível

---

### POST /api/notas-fiscais-estoque/{id}/aprovar

**Descrição:** Aprovar NFe (com ou sem divergência)

**Autenticação:** Obrigatória

**Autorização:** `RequireAuthorization(AuthorizationPolicies.NotasFiscaisEstoqueApproveMinor ou NotasFiscaisEstoqueApproveMajor)`

**Path Parameters:**
- `id` (Guid) - ID da NFe

**Request DTO:** `AprovarNFeCommand { Comentario: string (obrigatório se divergência >R$ 1.000) }`

**Response:** HTTP 200 (sucesso) ou HTTP 403 (sem permissão)

---

### POST /api/notas-fiscais-estoque/{id}/rejeitar

**Descrição:** Rejeitar NFe (com motivo obrigatório)

**Autenticação:** Obrigatória

**Autorização:** `RequireAuthorization(AuthorizationPolicies.NotasFiscaisEstoqueReject)`

**Path Parameters:**
- `id` (Guid) - ID da NFe

**Request DTO:** `RejeitarNFeCommand { Motivo: string (obrigatório) }`

**Response:** HTTP 200 (sucesso) ou HTTP 400 (motivo ausente)

---

### POST /api/notas-fiscais-estoque/{id}/lancar-estoque

**Descrição:** Forçar lançamento manual no estoque (bypass aprovação)

**Autenticação:** Obrigatória

**Autorização:** `RequireAuthorization(AuthorizationPolicies.NotasFiscaisEstoquePostInventory)`

**Path Parameters:**
- `id` (Guid) - ID da NFe

**Response:** HTTP 200 (sucesso) ou HTTP 400 (NFe inválida)

---

### DELETE /api/notas-fiscais-estoque/{id}

**Descrição:** Cancelar NFe lançada (estorno de movimentação)

**Autenticação:** Obrigatória

**Autorização:** `RequireAuthorization(AuthorizationPolicies.NotasFiscaisEstoqueCancel)`

**Path Parameters:**
- `id` (Guid) - ID da NFe

**Response:** HTTP 204 (sem conteúdo) ou HTTP 403 (sem permissão)

---

### GET /api/notas-fiscais-estoque/{id}/danfe

**Descrição:** Gerar DANFE em PDF/A

**Autenticação:** Obrigatória

**Autorização:** `RequireAuthorization(AuthorizationPolicies.NotasFiscaisEstoqueView)`

**Path Parameters:**
- `id` (Guid) - ID da NFe

**Response:** `FileStreamResult` (application/pdf, HTTP 200)

---

### GET /api/notas-fiscais-estoque/{id}/xml

**Descrição:** Download do XML original

**Autenticação:** Obrigatória

**Autorização:** `RequireAuthorization(AuthorizationPolicies.NotasFiscaisEstoqueView)`

**Path Parameters:**
- `id` (Guid) - ID da NFe

**Response:** `FileStreamResult` (application/xml, HTTP 200)

---

### GET /api/notas-fiscais-estoque/export

**Descrição:** Exportar relatório Excel/PDF

**Autenticação:** Obrigatória

**Autorização:** `RequireAuthorization(AuthorizationPolicies.NotasFiscaisEstoqueExport)`

**Query Parameters:**
- `formato` (string, "excel" ou "pdf")
- Mesmos filtros de listagem

**Response:** `FileStreamResult` (HTTP 200)

---

### PUT /api/notas-fiscais-estoque/configuracoes

**Descrição:** Configurar tolerâncias, SLAs, integração ERP

**Autenticação:** Obrigatória

**Autorização:** `RequireAuthorization(AuthorizationPolicies.NotasFiscaisEstoqueConfigure)`

**Request DTO:** `ConfigurarNFeCommand { ToleranciaQuantidade: decimal, ToleranciaValor: decimal, SlaAprovacaoHoras: int, ... }`

**Response:** HTTP 200 (sucesso) ou HTTP 403 (sem permissão)

---

## 7. MODELO DE DADOS

O modelo de dados completo está documentado em arquivo separado [MD-RF042.md](./MD-RF042.md).

**Entidades principais:**
- `NotaFiscalEstoque` - Entidade raiz (Aggregate Root)
- `NotaFiscalEstoqueItem` - Itens da NFe (Entity)
- `NotaFiscalEstoqueAprovacao` - Histórico de aprovações (Entity)
- `NotaFiscalEstoqueImpostos` - Detalhamento de impostos (Value Object - JSON)

**Relacionamentos críticos:**
- NotaFiscalEstoque → Fornecedor (N:1)
- NotaFiscalEstoque → PedidoCompra (N:1, opcional)
- NotaFiscalEstoqueItem → Produto (N:1)
- NotaFiscalEstoqueItem → MovimentacaoEstoque (1:1)

**Campos obrigatórios multi-tenancy:**
- `ClienteId` (Guid) - Isolamento por tenant
- Filtro global EF Core aplicado automaticamente

**Campos obrigatórios auditoria:**
- `CriadoPor`, `CriadoEm`, `AlteradoPor`, `AlteradoEm`, `FlExcluido`

---

## 8. DEPENDÊNCIAS

### 8.1 Dependências de Outros RFs (Upstream)

| RF Dependente | Tipo Dependência | Descrição |
|---------------|------------------|-----------|
| **RF008 - Gestão de Fornecedores** | **CRÍTICA** | CNPJ do fornecedor DEVE existir na base antes de importar NFe |
| **RF010 - Gestão de Produtos** | **CRÍTICA** | Produtos da NFe DEVEM estar cadastrados (ou sistema cria automaticamente) |
| **RF019 - Gestão de Pedidos de Compra** | **ALTA** | Necessário para conciliação NFe ↔ Pedido |
| **RF021 - Gestão de Estoque** | **CRÍTICA** | Lançamento automático de entrada depende de tabela Estoque |
| **RF024 - Gestão de Centros de Custo** | **MÉDIA** | Rateio de custos por centro de custo (opcional) |
| **RF001 - Parâmetros e Configurações** | **ALTA** | Tolerâncias de conciliação, SLAs, limites de plano |
| **RF003 - Auditoria** | **ALTA** | Log de todas as operações (importação, aprovação, lançamento) |
| **RF006 - Gestão de Usuários** | **ALTA** | Workflow de aprovação, RBAC, notificações |

### 8.2 Dependências de Bibliotecas Externas

**Backend (.NET 10):**
- Entity Framework Core 10.0 - ORM
- MediatR 12.0 - CQRS (Commands/Queries)
- FluentValidation 11.0 - Validação de dados
- Hangfire 1.8 - Jobs agendados (importação e-mail, limpeza)
- Polly 8.0 - Retry policy para SEFAZ
- iTextSharp 5.5.13 - Geração de DANFE em PDF/A
- Tesseract 5.0 - OCR gratuito de PDFs
- Azure.AI.FormRecognizer 4.0 - OCR avançado (pago)
- Microsoft.AspNetCore.SignalR 7.0 - Notificações em tempo real
- Azure.Storage.Blobs 12.0 - Armazenamento de XMLs
- Azure.Security.KeyVault.Keys 4.5 - Gerenciamento de chaves criptografia

**Frontend (Angular 19):**
- @angular/material 19.0 - Componentes UI
- @jsverse/transloco 6.0 - Internacionalização (i18n)
- apexcharts 3.45 - Gráficos do dashboard
- ngx-file-drop 16.0 - Drag-and-drop de arquivos

**Integrações externas:**
- WebService SEFAZ (https://nfe.fazenda.sp.gov.br/ws/) - Validação de NFes
- APIs ERPs (SAP, TOTVS, Protheus) - Exportação automática de dados

---

## 9. KPIs E MÉTRICAS

### 9.1 KPIs de Performance

| KPI | Descrição | Meta | Frequência Medição |
|-----|-----------|------|-------------------|
| Taxa de Importação Automática | % de NFes importadas automaticamente via e-mail (sem upload manual) | ≥80% | Diária |
| Taxa de Validação SEFAZ Bem-Sucedida | % de NFes validadas com sucesso na SEFAZ (status 100) | ≥95% | Diária |
| Taxa de Precisão OCR | % de PDFs processados com OCR confiança ≥85% | ≥90% | Semanal |
| Taxa de Conciliação Automática | % de NFes conciliadas automaticamente com pedido (sem divergência) | ≥70% | Semanal |
| Tempo Médio de Importação | Tempo desde upload XML até registro criado no banco | ≤5s | Diária |
| Tempo Médio de Aprovação | Tempo desde importação até aprovação final | ≤24h | Semanal |
| Taxa de Duplicatas Detectadas | % de tentativas de importação de NFes duplicadas bloqueadas | 100% | Diária |
| Taxa de Lançamento Automático | % de NFes aprovadas lançadas automaticamente no estoque | ≥95% | Semanal |

### 9.2 Logs Obrigatórios

Todas as operações a seguir DEVEM gerar log estruturado (tabela AuditLog):

- Importação de NFe (sucesso/falha, tempo processamento, tamanho XML)
- Validação SEFAZ (chave acesso, status retornado, protocolo, tempo resposta)
- OCR de PDF (nome arquivo, confiança, chave detectada, tempo processamento)
- Detecção de duplicata (chave acesso, data importação anterior, usuário)
- Conciliação com pedido (pedido encontrado, divergências, ação tomada)
- Aprovação/rejeição (usuário, timestamp, comentário, valor divergência)
- Lançamento no estoque (produto, quantidade, custo médio antes/depois)
- Download de XML (usuário, IP, motivo, timestamp)
- Geração de DANFE (tamanho PDF gerado, tempo processamento)
- Tentativas de acesso não autorizado (403 Forbidden)

---

## 10. ALERTAS CRÍTICOS

### 10.1 Alertas de Sistema

| Evento | Threshold | Severidade | Canal Notificação |
|--------|-----------|------------|-------------------|
| Falha ao conectar e-mail IMAP | >3 falhas consecutivas | ALTA | E-mail TI + SignalR Admin |
| SEFAZ indisponível | >5 falhas consecutivas em 1 hora | CRÍTICA | E-mail TI + Slack + SMS |
| OCR com taxa de erro alta | <70% confiança em 10 PDFs consecutivos | MÉDIA | E-mail responsável + SignalR |
| Limite de importação atingido | ≥95% do limite mensal | ALTA | E-mail cliente + SignalR + Badge |
| Blob storage indisponível | 1 falha | CRÍTICA | E-mail TI + Slack |
| Integração ERP falhando | >5 falhas consecutivas | ALTA | E-mail TI + Slack |
| SLA de aprovação vencido | >24h pendente | MÉDIA | E-mail gestor + SignalR |
| Divergência >R$ 10.000 | 1 ocorrência | ALTA | E-mail diretor + SMS |

### 10.2 Alertas de Negócio

| Evento | Threshold | Severidade | Canal Notificação |
|--------|-----------|------------|-------------------|
| NFe com divergência detectada | Valor >R$ 1.000 ou %divergência >10% | MÉDIA | SignalR comprador + E-mail |
| NFe rejeitada pela SEFAZ | Status ≠ 100 | ALTA | E-mail comprador + SignalR |
| Tentativa de importação de duplicata | 1 ocorrência | BAIXA | Log auditoria (sem notificação) |
| NFe sem pedido vinculado | NFe >R$ 5.000 sem pedido | MÉDIA | E-mail comprador |
| Frete muito alto | Frete >30% do valor produtos | MÉDIA | E-mail comprador |
| Imposto calculado divergente | Diferença >5% vs XML | ALTA | E-mail fiscal + SignalR |

---

## 11. CENTRAL DE FUNCIONALIDADES

### 11.1 Registro da Funcionalidade

**Código:** `GES.NOTAS_FISCAIS_ESTOQUE`

**Módulo:** Gestão

**Título (i18n):** `ges.notasFiscaisEstoque.title` → "Gestão de Notas Fiscais Estoque"

**Descrição (i18n):** `ges.notasFiscaisEstoque.subtitle` → "Importação, validação e lançamento de NFes de entrada"

**Ícone Material:** `receipt_long`

**Rota Frontend:** `/gestao/notas-fiscais-estoque`

**Ordem no Menu:** 50

**Ativo:** `true`

**Permissão Mínima:** `GES.NOTAS_FISCAIS_ESTOQUE.VIEW`

### 11.2 Chaves i18n Completas

**Namespace:** `ges.notasFiscaisEstoque`

**Idiomas suportados:** pt-BR (padrão), en-US, es-ES

**Categorias de chaves:**
- `title` - Título da funcionalidade
- `subtitle` - Descrição curta
- `actions.*` - Botões e ações (import, approve, reject, etc.)
- `fields.*` - Labels de campos (chaveAcesso, numero, fornecedor, etc.)
- `status.*` - Status da NFe (aguardandoValidacao, autorizada, cancelada, etc.)
- `messages.*` - Mensagens de sucesso/erro (importSuccess, validateError, etc.)
- `validations.*` - Mensagens de validação (chaveAcessoInvalida, xmlInvalido, etc.)

**Exemplo completo de chaves:**
```json
{
  "ges.notasFiscaisEstoque": {
    "title": "Gestão de Notas Fiscais Estoque",
    "subtitle": "Importação, validação e lançamento de NFes de entrada",
    "actions": {
      "import": "Importar NFe",
      "importMultiple": "Importar Múltiplas NFes",
      "validate": "Validar na SEFAZ",
      "approve": "Aprovar NFe",
      "reject": "Rejeitar NFe",
      "postInventory": "Lançar no Estoque"
    },
    "fields": {
      "chaveAcesso": "Chave de Acesso",
      "numero": "Número NFe",
      "dataEmissao": "Data Emissão",
      "fornecedor": "Fornecedor",
      "valorTotal": "Valor Total"
    },
    "status": {
      "autorizada": "Autorizada pela SEFAZ",
      "aguardandoAprovacao": "Aguardando Aprovação",
      "aprovada": "Aprovada",
      "lancadaEstoque": "Lançada no Estoque"
    },
    "messages": {
      "importSuccess": "NFe importada com sucesso!",
      "duplicateDetected": "NFe duplicada! Já importada em {{date}} por {{user}}"
    },
    "validations": {
      "chaveAcessoInvalida": "Chave de acesso inválida (deve ter 44 dígitos)",
      "xmlInvalido": "XML inválido ou corrompido"
    }
  }
}
```

---

**FIM DA ESPECIFICAÇÃO RF042 v2.0**
