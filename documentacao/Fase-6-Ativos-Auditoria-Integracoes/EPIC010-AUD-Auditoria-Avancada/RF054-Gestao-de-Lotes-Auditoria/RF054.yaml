# RF054 - Gestão de Lotes de Auditoria - Especificação Estruturada

rf_id: RF054
rf_title: "Gestão de Lotes de Auditoria"
versao: "2.0"
data: "2025-12-30"
fase: "Fase-6-Ativos-Auditoria-Integracoes"
epic: "EPIC010-AUD-Auditoria-Avancada"

# ==============================================================================
# SEÇÃO 1: VISÃO GERAL
# ==============================================================================

visao_geral:
  objetivo: |
    Permitir a criação, configuração e gerenciamento de lotes de auditoria que agrupem
    múltiplas faturas com base em critérios pré-definidos, possibilitando processamento
    assíncrono em background, atribuição de auditores, monitoramento de progresso em
    tempo real, consolidação automática de resultados e integração completa com os
    módulos de itens de auditoria (RF034) e status de auditoria (RF035).

  importancia_estrategica:
    - escalabilidade_auditoria: "Permitir auditoria massiva de milhares de faturas simultaneamente"
    - automacao_workflows: "Eliminar seleção manual de faturas e consolidação de resultados"
    - visibilidade_tempo_real: "Dashboards de progresso e alertas de timeout via SignalR"
    - rastreabilidade_completa: "Histórico de todas as operações com auditoria total"
    - integracao_rf034_rf035: "Sincronização automática de itens e status de auditoria"
    - resiliencia_recuperacao: "Retry policies exponenciais para jobs falhados"
    - sla_performance: "Monitoramento de métricas críticas e cumprimento de SLAs"

  escopo_incluido:
    - "Criação e configuração de lotes com critérios múltiplos"
    - "Seleção automática de faturas baseada em critérios"
    - "Atribuição manual ou automática de auditores"
    - "Máquina de estados com transições controladas"
    - "Processamento assíncrono via Hangfire"
    - "Monitoramento em tempo real via SignalR"
    - "Integração completa com RF034 (itens de auditoria)"
    - "Consolidação automática com RF035 (status global)"
    - "Histórico completo de auditoria de operações"
    - "Notificações assíncronas via Azure Service Bus"
    - "Cancelamento com rollback automático"
    - "SLA e alertas de timeout configuráveis"
    - "Arquivamento automático de lotes antigos"
    - "Exportação de relatórios consolidados (Excel/PDF)"
    - "Dashboard de KPIs e métricas"
    - "Permissions granulares RBAC"

  escopo_excluido:
    - "Auditoria individual de faturas isoladas (RF034)"
    - "Definição de status e tipos de auditoria (RF035)"
    - "Gestão de transportadoras, filiais, centros de custo (RFs de cadastros base)"
    - "Configuração de regras de glosas (RF futuro)"
    - "Inteligência artificial para detecção de anomalias (roadmap futuro)"

# ==============================================================================
# SEÇÃO 2: FUNCIONALIDADES
# ==============================================================================

funcionalidades:
  - id: "FUNC-LOT-01"
    nome: "Criar Lote de Auditoria"
    descricao: "Criar novo lote definindo nome, descrição, critérios de seleção, auditor, prioridade e SLA"
    atores: ["Coordenador de Auditoria", "Gestor de Auditoria"]
    permissao_required: "AUD.LOTES.CREATE"
    pre_condicoes: ["Usuário autenticado com permissão"]
    pos_condicoes: ["Lote criado com status Created"]

  - id: "FUNC-LOT-02"
    nome: "Selecionar Faturas Automaticamente"
    descricao: "Job assíncrono aplica critérios e seleciona faturas elegíveis para o lote"
    atores: ["Sistema (Hangfire)"]
    permissao_required: null
    pre_condicoes: ["Lote criado com critérios válidos"]
    pos_condicoes: ["Faturas associadas, status WaitingForProcessing"]

  - id: "FUNC-LOT-03"
    nome: "Iniciar Processamento do Lote"
    descricao: "Dispara jobs Hangfire paralelos para auditar cada fatura via RF034"
    atores: ["Coordenador de Auditoria", "Gestor de Auditoria", "Sistema (scheduler)"]
    permissao_required: "AUD.LOTES.PROCESS"
    pre_condicoes: ["Lote no status WaitingForProcessing"]
    pos_condicoes: ["Lote processado, itens criados via RF034, status Completed"]

  - id: "FUNC-LOT-04"
    nome: "Monitorar Progresso em Tempo Real"
    descricao: "Dashboard com atualizações via SignalR (porcentagem, faturas processadas, erros, tempo)"
    atores: ["Coordenador de Auditoria", "Gestor de Auditoria", "Auditor"]
    permissao_required: "AUD.LOTES.VIEW"
    pre_condicoes: ["Lote no status Processing"]
    pos_condicoes: ["Usuário informado do progresso em tempo real"]

  - id: "FUNC-LOT-05"
    nome: "Cancelar Lote com Rollback"
    descricao: "Cancela lote em processamento executando rollback de itens criados"
    atores: ["Coordenador de Auditoria", "Gestor de Auditoria"]
    permissao_required: "AUD.LOTES.CANCEL"
    pre_condicoes: ["Lote no status Processing"]
    pos_condicoes: ["Lote cancelado, rollback executado, histórico registrado"]

  - id: "FUNC-LOT-06"
    nome: "Consolidar Resultados Automaticamente"
    descricao: "Job agrega valores totais, estatísticas e integra com RF035"
    atores: ["Sistema (Hangfire)"]
    permissao_required: null
    pre_condicoes: ["Lote com todas as faturas processadas"]
    pos_condicoes: ["Resultados consolidados, status Completed, RF035 atualizado"]

  - id: "FUNC-LOT-07"
    nome: "Arquivar Lote"
    descricao: "Move lote concluído para status Archived conforme política de retenção"
    atores: ["Coordenador de Auditoria", "Gestor de Auditoria", "Sistema (scheduler)"]
    permissao_required: "AUD.LOTES.ARCHIVE"
    pre_condicoes: ["Lote no status Completed"]
    pos_condicoes: ["Lote arquivado, status Archived"]

  - id: "FUNC-LOT-08"
    nome: "Exportar Relatório Consolidado"
    descricao: "Gera arquivo Excel ou PDF com critérios, faturas, resultados, estatísticas e histórico"
    atores: ["Coordenador de Auditoria", "Gestor de Auditoria", "Auditor"]
    permissao_required: "AUD.LOTES.EXPORT"
    pre_condicoes: ["Lote no status Completed ou Archived"]
    pos_condicoes: ["Relatório exportado"]

  - id: "FUNC-LOT-09"
    nome: "Reprocessar Faturas com Erro"
    descricao: "Reenfileira faturas falhadas com retry policy exponencial"
    atores: ["Coordenador de Auditoria", "Gestor de Auditoria"]
    permissao_required: "AUD.LOTES.REPROCESS"
    pre_condicoes: ["Lote com faturas em status Error"]
    pos_condicoes: ["Faturas reprocessadas ou marcadas como erro permanente"]

  - id: "FUNC-LOT-10"
    nome: "Atribuir/Reatribuir Auditor"
    descricao: "Atribui ou reatribui auditor responsável enviando notificações"
    atores: ["Coordenador de Auditoria", "Gestor de Auditoria"]
    permissao_required: "AUD.LOTES.ASSIGN_AUDITOR"
    pre_condicoes: ["Lote criado"]
    pos_condicoes: ["Auditor atribuído, notificações enviadas"]

  - id: "FUNC-LOT-11"
    nome: "Configurar SLA e Alertas de Timeout"
    descricao: "Define timeout em horas e recebe alertas quando SLA é excedido"
    atores: ["Coordenador de Auditoria", "Gestor de Auditoria"]
    permissao_required: "AUD.LOTES.MANAGE_SETTINGS"
    pre_condicoes: ["Lote criado"]
    pos_condicoes: ["SLA configurado, monitoramento ativo"]

  - id: "FUNC-LOT-12"
    nome: "Visualizar Histórico de Auditoria do Lote"
    descricao: "Exibe cronologia completa de operações com usuário, data/hora, IP, descrição"
    atores: ["Coordenador de Auditoria", "Gestor de Auditoria", "Auditor"]
    permissao_required: "AUD.LOTES.VIEW"
    pre_condicoes: ["Lote criado"]
    pos_condicoes: ["Histórico visualizado"]

  - id: "FUNC-LOT-13"
    nome: "Dashboard de KPIs de Lotes"
    descricao: "Exibe KPIs (lotes ativos, taxa de sucesso, glosas, tempo médio, distribuição por auditor)"
    atores: ["Coordenador de Auditoria", "Gestor de Auditoria"]
    permissao_required: "AUD.LOTES.VIEW_ALL"
    pre_condicoes: ["Usuário autenticado"]
    pos_condicoes: ["KPIs visualizados"]

# ==============================================================================
# SEÇÃO 3: REGRAS DE NEGÓCIO
# ==============================================================================

regras_negocio:
  - id: "RN-LOT-054-01"
    titulo: "Obrigatoriedade de Critérios de Seleção"
    descricao: |
      Todo lote de auditoria deve possuir pelo menos um critério de seleção configurado.
      Critérios válidos: período (data início + fim), transportadora, filial, valor mín/máx,
      tipo de serviço, status de fatura. Não é permitido criar lote sem critérios.
    motivacao: "Garantir escopo delimitado, evitar seleção indiscriminada de faturas"
    impacto: "Validação obrigatória na criação. Rejeitar com HTTP 400 se nenhum critério informado"

  - id: "RN-LOT-054-02"
    titulo: "Lote Imutável Após Processamento Iniciado"
    descricao: |
      Após transicionar para Processing, não é permitido alterar critérios, adicionar/remover
      faturas ou modificar prioridade/SLA. Auditor responsável pode ser alterado. Única operação
      permitida é cancelamento com rollback.
    motivacao: "Garantir integridade e rastreabilidade, prevenir inconsistências"
    impacto: "Bloquear edição quando status for Processing/Completed/Cancelled/Archived"

  - id: "RN-LOT-054-03"
    titulo: "Seleção Automática de Faturas por Critérios"
    descricao: |
      Seleção de faturas deve ser executada automaticamente em background após criação do lote.
      Sistema aplica critérios e associa todas as faturas elegíveis. Faturas já em outros lotes
      ativos (Processing/WaitingForProcessing) não devem ser incluídas.
    motivacao: "Evitar seleção manual, garantir completude, prevenir duplicação"
    impacto: "Job Hangfire assíncrono com filtros SQL otimizados, validação de lotes ativos"

  - id: "RN-LOT-054-04"
    titulo: "Atribuição Manual ou Automática de Auditor"
    descricao: |
      Auditor pode ser atribuído manualmente ou automaticamente com base em balanceamento de
      carga (distribuição equitativa). Se não houver atribuição manual, sistema seleciona
      auditor com menor quantidade de lotes ativos.
    motivação: "Distribuição justa, evitar sobrecarga, flexibilidade para casos especiais"
    impacto: "Lógica de balanceamento automático, validação de permissões, notificações"

  - id: "RN-LOT-054-05"
    titulo: "Máquina de Estados do Lote"
    descricao: |
      Estados: Created, WaitingForProcessing, Processing, Completed, Cancelled, Error, Archived.
      Transições permitidas: Created → WaitingForProcessing, WaitingForProcessing → Processing,
      Processing → Completed/Cancelled/Error, Completed → Archived.
    motivacao: "Ciclo de vida previsível e auditável, prevenir operações inválidas"
    impacto: "Validar estado antes de transições, rejeitar com HTTP 400 se inválida, histórico"

  - id: "RN-LOT-054-06"
    titulo: "Processamento Assíncrono com Hangfire"
    descricao: |
      Processamento executado em background via Hangfire. Jobs paralelos por fatura com limite
      de concorrência configurável (ex: 10 simultâneos). Jobs devem ser idempotentes, stateless
      e resilientes a falhas.
    motivacao: "Escalabilidade, monitoramento em tempo real, evitar timeouts HTTP"
    impacto: "Atributos Hangfire (AutomaticRetry, Queue), configuração de limites, idempotência"

  - id: "RN-LOT-054-07"
    titulo: "Monitoramento de Progresso com SignalR"
    descricao: |
      Sistema envia atualizações via SignalR para clientes conectados. Atualizações incluem
      porcentagem, faturas processadas/com erro, tempo decorrido, estimativa de conclusão e logs.
    motivacao: "Visibilidade sem refresh manual, intervenção rápida em erros, UX melhorada"
    impacto: "Hub SignalR dedicado, jobs enviam mensagens após cada fatura, frontend WebSocket"

  - id: "RN-LOT-054-08"
    titulo: "Reprocessamento Automático com Retry Policy"
    descricao: |
      Faturas falhadas são reprocessadas com retry exponencial: imediato, 1min, 5min, 15min.
      Se todas as 4 tentativas falharem, marca como erro permanente e gera alerta.
    motivacao: "Resiliência a falhas temporárias, maximizar sucesso, minimizar intervenção manual"
    impacto: "AutomaticRetry(Attempts=4, DelaysInSeconds=[0,60,300,900]), histórico de tentativas"

  - id: "RN-LOT-054-09"
    titulo: "Integração com RF034 (Itens de Auditoria)"
    descricao: |
      Job de processamento cria ou atualiza item de auditoria via RF034 para cada fatura.
      Se item já existe, atualizar (não duplicar). Tratar erros de integração com retry.
    motivacao: "Rastreabilidade individual, análises granulares, consistência com RF034"
    impacto: "Invocar endpoints RF034 (Create/Update), tratar erros, validar associação"

  - id: "RN-LOT-054-10"
    titulo: "Consolidação Automática com RF035"
    descricao: |
      Job de consolidação calcula valores totais (auditado, glosas, economia), estatísticas
      (taxa aprovação/rejeição, distribuição glosas) e integra com RF035 para status global.
    motivacao: "Visão consolidada, decisões estratégicas, consistência com RF035"
    impacto: "Job Hangfire após última fatura, queries SQL otimizadas, invocar endpoint RF035"

  - id: "RN-LOT-054-11"
    titulo: "Histórico e Auditoria Completa de Operações"
    descricao: |
      Todas as operações registradas com rastreabilidade: usuário, data/hora (milissegundos),
      IP de origem, descrição, valores antes/depois. Operações: criação, seleção, processamento,
      conclusão, cancelamento, arquivamento, reatribuição, alterações de configuração.
    motivacao: "Conformidade, investigação de incidentes, transparência, análise de padrões"
    impacto: "Interceptor automático, middleware de auditoria, tabela dedicada com índices"

  - id: "RN-LOT-054-12"
    titulo: "Notificações Assíncronas via Azure Service Bus"
    descricao: |
      Notificações para eventos: lote criado, pronto, iniciado, concluído, cancelado, timeout,
      erro crítico. Mensagens contêm: ID lote, tipo evento, data/hora, payload, metadados
      (correlation ID, usuário).
    motivacao: "Integração com sistemas externos, desacoplamento, escalabilidade"
    impacto: "Publicação no Azure Service Bus, topics/subscriptions, serialização JSON, resiliente"

  - id: "RN-LOT-054-13"
    titulo: "Cancelamento de Lote com Rollback"
    descricao: |
      Rollback completo: soft delete de itens RF034, desassociação de faturas, reversão de
      status, cancelamento de jobs Hangfire, registro no histórico (usuário, data/hora, motivo,
      quantidade afetada, valores processados).
    motivacao: "Evitar inconsistências, permitir reprocessamento, evitar jobs órfãos"
    impacto: "Transação distribuída ou idempotência, invocar RF034 soft delete, cancelar jobs"

  - id: "RN-LOT-054-14"
    titulo: "SLA e Alertas de Timeout"
    descricao: |
      SLA configurável em horas (24h, 48h, 72h). Monitoramento contínuo. Quando excedido:
      email para coordenador/gestores, alerta visual no dashboard (vermelho), registro no
      histórico, mensagem Azure Service Bus. Coordenador pode cancelar ou estender SLA.
    motivacao: "Identificar problemas de performance, garantir cumprimento de SLAs, intervenção proativa"
    impacto: "Job Hangfire recorrente (5 min), envio de emails, flag timeout, evento SignalR"

# ==============================================================================
# SEÇÃO 4: INTEGRAÇÕES OBRIGATÓRIAS
# ==============================================================================

integracoes_obrigatorias:
  central_funcionalidades:
    feature_key: "AUD.LOTES"
    display_name: "Gestão de Lotes de Auditoria"
    description: "Criar, processar e monitorar lotes de auditoria com processamento assíncrono"
    module: "Auditoria"
    is_enabled: true
    settings:
      - key: "MaxConcurrentJobs"
        default: 10
        description: "Máximo de faturas processadas simultaneamente"
      - key: "DefaultSLAHours"
        default: 24
        description: "SLA padrão em horas para novos lotes"
      - key: "AutoArchiveDays"
        default: 90
        description: "Dias após conclusão para arquivamento automático"
      - key: "EnableSignalRMonitoring"
        default: true
        description: "Habilitar monitoramento em tempo real via SignalR"
      - key: "EnableAzureServiceBusNotifications"
        default: true
        description: "Habilitar notificações via Azure Service Bus"

  i18n:
    idiomas_suportados: ["pt-BR", "en-US", "es-ES"]
    prefixo_chaves: "aud.lotes"
    chaves_principais:
      - "aud.lotes.title"
      - "aud.lotes.create"
      - "aud.lotes.process"
      - "aud.lotes.cancel"
      - "aud.lotes.archive"
      - "aud.lotes.export"
      - "aud.lotes.status.created"
      - "aud.lotes.status.waiting"
      - "aud.lotes.status.processing"
      - "aud.lotes.status.completed"
      - "aud.lotes.status.cancelled"
      - "aud.lotes.status.error"
      - "aud.lotes.status.archived"
      - "aud.lotes.errors.no_criteria"
      - "aud.lotes.errors.invalid_state_transition"
      - "aud.lotes.notifications.completed"

  auditoria_automatica:
    entidades:
      - "AuditBatch"
      - "AuditBatchCriteria"
      - "AuditBatchInvoice"
    campos_obrigatorios:
      - "CreatedBy"
      - "CreatedAt"
      - "UpdatedBy"
      - "UpdatedAt"
      - "DeletedBy"
      - "DeletedAt"
      - "IsDeleted"
    interceptor: "AuditInterceptor"

  rbac:
    validacao_backend: "RequireAuthorization(AuthorizationPolicies.*)"
    validacao_frontend: "*appHasPermission"

# ==============================================================================
# SEÇÃO 5: PERMISSÕES RBAC
# ==============================================================================

permissoes:
  - codigo: "AUD.LOTES.CREATE"
    nome: "Criar Lotes"
    descricao: "Criar novos lotes de auditoria com critérios configuráveis"
    roles_padrao: ["Coordenador de Auditoria", "Gestor de Auditoria"]

  - codigo: "AUD.LOTES.VIEW"
    nome: "Visualizar Lotes"
    descricao: "Visualizar lotes criados pelo usuário ou atribuídos a ele"
    roles_padrao: ["Auditor", "Coordenador de Auditoria", "Gestor de Auditoria"]

  - codigo: "AUD.LOTES.VIEW_ALL"
    nome: "Visualizar Todos os Lotes"
    descricao: "Visualizar todos os lotes do sistema independente de criador/auditor"
    roles_padrao: ["Coordenador de Auditoria", "Gestor de Auditoria"]

  - codigo: "AUD.LOTES.PROCESS"
    nome: "Iniciar Processamento"
    descricao: "Iniciar processamento de lotes no status WaitingForProcessing"
    roles_padrao: ["Coordenador de Auditoria", "Gestor de Auditoria"]

  - codigo: "AUD.LOTES.CANCEL"
    nome: "Cancelar Lotes"
    descricao: "Cancelar lotes em processamento executando rollback"
    roles_padrao: ["Coordenador de Auditoria", "Gestor de Auditoria"]

  - codigo: "AUD.LOTES.ARCHIVE"
    nome: "Arquivar Lotes"
    descricao: "Arquivar lotes concluídos manualmente ou configurar políticas"
    roles_padrao: ["Coordenador de Auditoria", "Gestor de Auditoria"]

  - codigo: "AUD.LOTES.EXPORT"
    nome: "Exportar Relatórios"
    descricao: "Exportar relatórios consolidados em Excel ou PDF"
    roles_padrao: ["Auditor", "Coordenador de Auditoria", "Gestor de Auditoria"]

  - codigo: "AUD.LOTES.REPROCESS"
    nome: "Reprocessar Faturas"
    descricao: "Reprocessar faturas que falharam durante processamento"
    roles_padrao: ["Coordenador de Auditoria", "Gestor de Auditoria"]

  - codigo: "AUD.LOTES.DELETE"
    nome: "Deletar Permanentemente"
    descricao: "Deletar permanentemente lotes (operação irreversível)"
    roles_padrao: ["Gestor de Auditoria"]

  - codigo: "AUD.LOTES.MANAGE_SETTINGS"
    nome: "Gerenciar Configurações"
    descricao: "Alterar configurações globais (SLA padrão, concorrência, feature flags)"
    roles_padrao: ["Gestor de Auditoria"]

# ==============================================================================
# SEÇÃO 6: API ENDPOINTS
# ==============================================================================

api_endpoints:
  base_path: "/api/audit-batches"
  endpoints:
    - method: "POST"
      path: "/api/audit-batches"
      nome: "Criar Lote"
      permissao: "AUD.LOTES.CREATE"
      request_body: "CreateAuditBatchRequest"
      response: "HTTP 201 + AuditBatchResponse"

    - method: "GET"
      path: "/api/audit-batches"
      nome: "Listar Lotes"
      permissao: "AUD.LOTES.VIEW ou AUD.LOTES.VIEW_ALL"
      query_params: ["status", "assignedAuditorId", "startDate", "endDate", "pageNumber", "pageSize"]
      response: "HTTP 200 + PaginatedList<AuditBatchListItemResponse>"

    - method: "GET"
      path: "/api/audit-batches/{id}"
      nome: "Obter Detalhes do Lote"
      permissao: "AUD.LOTES.VIEW ou AUD.LOTES.VIEW_ALL"
      response: "HTTP 200 + AuditBatchDetailResponse"

    - method: "POST"
      path: "/api/audit-batches/{id}/process"
      nome: "Iniciar Processamento"
      permissao: "AUD.LOTES.PROCESS"
      response: "HTTP 200 + AuditBatchProcessingStartedResponse"

    - method: "POST"
      path: "/api/audit-batches/{id}/cancel"
      nome: "Cancelar Lote"
      permissao: "AUD.LOTES.CANCEL"
      request_body: "CancelAuditBatchRequest (reason)"
      response: "HTTP 200 + AuditBatchCancelledResponse"

    - method: "POST"
      path: "/api/audit-batches/{id}/archive"
      nome: "Arquivar Lote"
      permissao: "AUD.LOTES.ARCHIVE"
      response: "HTTP 200 + AuditBatchArchivedResponse"

    - method: "GET"
      path: "/api/audit-batches/{id}/export"
      nome: "Exportar Relatório"
      permissao: "AUD.LOTES.EXPORT"
      query_params: ["format (excel|pdf)"]
      response: "HTTP 200 + Binary file stream"

    - method: "POST"
      path: "/api/audit-batches/{id}/reprocess"
      nome: "Reprocessar Faturas"
      permissao: "AUD.LOTES.REPROCESS"
      request_body: "ReprocessInvoicesRequest (invoiceIds)"
      response: "HTTP 200 + ReprocessInvoicesResponse"

    - method: "DELETE"
      path: "/api/audit-batches/{id}"
      nome: "Deletar Permanentemente"
      permissao: "AUD.LOTES.DELETE"
      response: "HTTP 204 No Content"

  signalr_hub:
    path: "/hubs/audit-batches"
    metodos:
      - "MonitorBatch(Guid batchId)"
      - "UnmonitorBatch(Guid batchId)"
    eventos:
      - "ProgressUpdated"
      - "BatchCompleted"
      - "TimeoutExceeded"

# ==============================================================================
# SEÇÃO 7: MODELO DE DADOS
# ==============================================================================

modelo_dados:
  entidade_principal:
    nome: "AuditBatch"
    tabela: "AuditBatch"
    campos_principais:
      - nome: "Id"
        tipo: "Guid"
        pk: true
      - nome: "CompanyId"
        tipo: "Guid"
        fk: "Company.Id"
        not_null: true
      - nome: "Name"
        tipo: "nvarchar(200)"
        not_null: true
      - nome: "Description"
        tipo: "nvarchar(1000)"
      - nome: "Status"
        tipo: "int"
        not_null: true
        enum: "AuditBatchStatus"
      - nome: "Priority"
        tipo: "int"
        not_null: true
        enum: "AuditBatchPriority"
      - nome: "AssignedAuditorId"
        tipo: "Guid"
        fk: "User.Id"
      - nome: "SlaTimeoutHours"
        tipo: "int"
        not_null: true
      - nome: "TotalInvoices"
        tipo: "int"
        default: 0
      - nome: "ProcessedInvoices"
        tipo: "int"
        default: 0
      - nome: "SuccessfulInvoices"
        tipo: "int"
        default: 0
      - nome: "FailedInvoices"
        tipo: "int"
        default: 0
      - nome: "PercentComplete"
        tipo: "decimal(5,2)"
        default: 0
      - nome: "TotalAuditedValue"
        tipo: "decimal(18,2)"
        default: 0
      - nome: "TotalGlossesValue"
        tipo: "decimal(18,2)"
        default: 0
      - nome: "IsTimeoutExceeded"
        tipo: "bit"
        default: 0
    indices:
      - nome: "IX_AuditBatch_CompanyId"
        campos: ["CompanyId"]
      - nome: "IX_AuditBatch_Status"
        campos: ["Status"]
      - nome: "IX_AuditBatch_AssignedAuditorId"
        campos: ["AssignedAuditorId"]
      - nome: "IX_AuditBatch_CreatedAt"
        campos: ["CreatedAt"]

  enums:
    - nome: "AuditBatchStatus"
      valores:
        - "Created = 1"
        - "WaitingForProcessing = 2"
        - "Processing = 3"
        - "Completed = 4"
        - "Cancelled = 5"
        - "Error = 6"
        - "Archived = 7"

    - nome: "AuditBatchPriority"
      valores:
        - "Low = 1"
        - "Normal = 2"
        - "High = 3"
        - "Critical = 4"

# ==============================================================================
# SEÇÃO 8: DEPENDÊNCIAS
# ==============================================================================

dependencias:
  rfs_dependentes:
    - documentacao_id: "RF034"
      nome: "Gestão de Itens de Auditoria"
      tipo: "hard_dependency"
      descricao: "Criação/atualização de itens de auditoria por fatura processada"
      endpoints_utilizados: ["POST /api/audit-items", "PUT /api/audit-items/{id}"]

    - documentacao_id: "RF035"
      nome: "Gestão de Status de Auditoria"
      tipo: "hard_dependency"
      descricao: "Atualização de status global do lote após consolidação"
      endpoints_utilizados: ["PUT /api/audit-statuses/{id}"]

    - documentacao_id: "RF001"
      nome: "Parâmetros e Configurações do Sistema"
      tipo: "soft_dependency"
      descricao: "Configurações globais (timeout SLA, concorrência jobs)"
      endpoints_utilizados: ["GET /api/system-parameters"]

  tecnologias:
    - nome: "Hangfire"
      versao: "1.8.x"
      descricao: "Framework de background jobs para processamento assíncrono"
      jobs_implementados:
        - "SelectInvoicesForBatchJob"
        - "ProcessInvoiceJob"
        - "ConsolidateBatchResultsJob"
        - "ArchiveOldBatchesJob"
        - "MonitorTimeoutJob"

    - nome: "SignalR"
      versao: "ASP.NET Core 10"
      descricao: "WebSockets para monitoramento em tempo real"
      hub: "AuditBatchHub (/hubs/audit-batches)"

    - nome: "Azure Service Bus"
      versao: "Azure.Messaging.ServiceBus 7.x"
      descricao: "Barramento de mensagens para notificações assíncronas"
      topics: ["audit-batches-events"]

# ==============================================================================
# SEÇÃO 9: KPIs E MÉTRICAS
# ==============================================================================

kpis:
  - id: "KPI-LOT-01"
    nome: "Quantidade de Lotes Ativos"
    formula: "COUNT(AuditBatch WHERE Status = Processing)"
    meta: "< 50"

  - id: "KPI-LOT-02"
    nome: "Taxa de Sucesso Global"
    formula: "(COUNT(Status=Completed) / COUNT(Status IN (Completed,Error,Cancelled))) × 100"
    meta: "≥ 95%"

  - id: "KPI-LOT-03"
    nome: "Tempo Médio de Processamento"
    formula: "AVG(DATEDIFF(hour, StartedAt, CompletedAt))"
    meta: "≤ 24h (normais), ≤ 12h (críticos)"

  - id: "KPI-LOT-04"
    nome: "Total de Glosas Identificadas"
    formula: "SUM(TotalGlossesValue WHERE Status=Completed)"
    meta: "Maximizar"

  - id: "KPI-LOT-05"
    nome: "Taxa de Aprovação Média"
    formula: "AVG(ApprovalRate WHERE Status=Completed)"
    meta: "85-95%"

# ==============================================================================
# SEÇÃO 10: ALERTAS CRÍTICOS
# ==============================================================================

alertas:
  - id: "ALERT-LOT-01"
    nome: "Timeout de SLA Excedido"
    condicao: "DATEDIFF(hour, StartedAt, NOW()) > SlaTimeoutHours"
    gravidade: "ALTA"
    acoes_automaticas:
      - "Enviar email para coordenador"
      - "Exibir alerta no dashboard (vermelho)"
      - "Registrar evento no histórico"
      - "Publicar mensagem Azure Service Bus"

  - id: "ALERT-LOT-02"
    nome: "Taxa de Erro Alta em Lote"
    condicao: "FailedInvoices / TotalInvoices > 0.10"
    gravidade: "MÉDIA"
    acoes_automaticas:
      - "Enviar email para coordenador"
      - "Exibir alerta no dashboard"
      - "Pausar processamento (opcional)"

  - id: "ALERT-LOT-03"
    nome: "Job Hangfire Travado"
    condicao: "Job com status Processing há > 2h sem atualização"
    gravidade: "CRÍTICA"
    acoes_automaticas:
      - "Cancelar job travado"
      - "Enfileirar retry"
      - "Enviar email para DevOps"

# ==============================================================================
# SEÇÃO 11: CENTRAL DE FUNCIONALIDADES
# ==============================================================================

central_funcionalidades:
  feature_key: "AUD.LOTES"
  display_name: "Gestão de Lotes de Auditoria"
  module: "Auditoria"
  category: "Auditoria Avançada"
  is_enabled: true
  icon: "playlist_add_check"
  route: "/auditoria/lotes"
  display_order: 40

  configuracoes:
    - key: "AUD.LOTES.MaxConcurrentJobs"
      display_name: "Máximo de Jobs Concorrentes"
      data_type: "Integer"
      default_value: 10
      min_value: 1
      max_value: 50
      category: "Performance"

    - key: "AUD.LOTES.DefaultSLAHours"
      display_name: "SLA Padrão (horas)"
      data_type: "Integer"
      default_value: 24
      min_value: 1
      max_value: 168
      category: "Business Rules"

    - key: "AUD.LOTES.AutoArchiveDays"
      display_name: "Dias para Arquivamento Automático"
      data_type: "Integer"
      default_value: 90
      min_value: 30
      max_value: 365
      category: "Data Retention"

    - key: "AUD.LOTES.EnableSignalRMonitoring"
      display_name: "Habilitar Monitoramento SignalR"
      data_type: "Boolean"
      default_value: true
      category: "Features"

    - key: "AUD.LOTES.EnableAzureServiceBusNotifications"
      display_name: "Habilitar Notificações Azure Service Bus"
      data_type: "Boolean"
      default_value: true
      category: "Integrations"
