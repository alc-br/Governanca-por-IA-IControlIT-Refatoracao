# RF054 - Gestão de Lotes de Auditoria

**Versão:** 2.0
**Data:** 2025-12-30
**Responsável:** Equipe de Arquitetura IControlIT
**Fase:** Fase-6-Ativos-Auditoria-Integracoes
**EPIC:** EPIC010-AUD-Auditoria-Avancada

---

## SEÇÃO 1: VISÃO GERAL

### 1.1 Objetivo

Permitir a criação, configuração e gerenciamento de lotes de auditoria que agrupem múltiplas faturas com base em critérios pré-definidos (período, transportadora, filial, valor, tipo de serviço), possibilitando processamento assíncrono em background, atribuição de auditores, monitoramento de progresso em tempo real, consolidação automática de resultados e integração completa com os módulos de itens de auditoria (RF034) e status de auditoria (RF035).

### 1.2 Importância Estratégica

O sistema de lotes de auditoria é fundamental para:

- **Escalabilidade do Processo de Auditoria**: Permitir auditoria massiva de milhares de faturas simultaneamente, reduzindo o tempo de ciclo de semanas para horas
- **Automação de Workflows**: Eliminar seleção manual de faturas, atribuição de auditores e consolidação de resultados
- **Visibilidade em Tempo Real**: Fornecer dashboards de progresso, alertas de timeout e notificações assíncronas via Azure Service Bus
- **Rastreabilidade Completa**: Garantir auditoria total de todas as operações (criação, processamento, cancelamento, arquivamento) com histórico de mudanças de estado
- **Integração com RF034 e RF035**: Sincronização automática de itens de auditoria individuais e consolidação de status globais por lote
- **Resiliência e Recuperação**: Implementar retry policies exponenciais (1 min, 5 min, 15 min) para jobs falhados, garantindo continuidade operacional
- **SLA e Performance**: Monitorar métricas críticas (tempo de processamento, taxa de sucesso, glosas identificadas) para garantir cumprimento de SLAs

### 1.3 Escopo

**Incluído neste RF:**

- Criação e configuração de lotes de auditoria com critérios múltiplos (Data Início/Fim, Transportadora, Filial, Valor Mínimo/Máximo, Tipo de Serviço, Status de Fatura)
- Seleção automática de faturas baseada em critérios configurados
- Atribuição manual ou automática de auditores responsáveis por lote
- Máquina de estados com transições controladas (Created → WaitingForProcessing → Processing → Completed → Archived)
- Processamento assíncrono via Hangfire com jobs recorrentes e paralelos
- Monitoramento de progresso em tempo real via SignalR (WebSockets)
- Integração completa com RF034 (criação/atualização de itens de auditoria por fatura)
- Consolidação automática de resultados com RF035 (status global do lote)
- Histórico completo de auditoria de todas as operações
- Notificações assíncronas via Azure Service Bus (eventos de conclusão, erro, timeout)
- Cancelamento de lote com rollback automático de itens já processados
- SLA e alertas de timeout configuráveis por tipo de lote
- Arquivamento automático de lotes antigos (política de retenção configurável)
- Exportação de relatórios consolidados (Excel/PDF) com resultados do lote
- Dashboard de KPIs (quantidade de lotes ativos, taxa de sucesso, glosas identificadas, tempo médio de processamento)
- Permissions granulares RBAC (criar, visualizar, processar, cancelar, arquivar, exportar, reprocessar, deletar permanentemente, gerenciar configurações, visualizar todos os lotes)

**Excluído deste RF:**

- Auditoria individual de faturas isoladas (coberto por RF034)
- Definição de status e tipos de auditoria (coberto por RF035)
- Gestão de transportadoras, filiais, centros de custo (cobertos por RFs de cadastros base)
- Configuração de regras de glosas e validações de auditoria (será coberto por RF futuro)
- Inteligência artificial para detecção automática de anomalias (roadmap futuro)

---

## SEÇÃO 2: FUNCIONALIDADES

### 2.1 Criar Lote de Auditoria

**Descrição**: Permite ao usuário criar um novo lote de auditoria, definindo nome, descrição, critérios de seleção (data início/fim, transportadora, filial, valor mínimo/máximo, tipo de serviço, status de fatura), auditor responsável (opcional), prioridade (Baixa/Normal/Alta/Crítica) e configurações de SLA (timeout em horas).

**Atores**: Coordenador de Auditoria, Gestor de Auditoria

**Pré-condições**: Usuário autenticado com permissão `AUD.LOTES.CREATE`

**Fluxo**:
1. Usuário acessa tela de criação de lote
2. Preenche campos obrigatórios (nome, descrição)
3. Define critérios de seleção (pelo menos um critério é obrigatório)
4. Opcionalmente atribui auditor responsável
5. Define prioridade e SLA timeout
6. Sistema valida critérios e estima quantidade de faturas que serão selecionadas
7. Usuário confirma criação
8. Sistema cria lote no status `Created` e retorna identificador único

**Pós-condições**: Lote criado com status `Created`, aguardando processamento

### 2.2 Selecionar Faturas Automaticamente

**Descrição**: Após criação do lote, sistema executa job assíncrono em background que aplica os critérios configurados e seleciona automaticamente todas as faturas elegíveis, associando-as ao lote criado.

**Atores**: Sistema (Hangfire Background Job)

**Pré-condições**: Lote criado com critérios válidos

**Fluxo**:
1. Sistema enfileira job Hangfire para seleção de faturas
2. Job consulta base de faturas aplicando filtros configurados
3. Para cada fatura selecionada, cria registro de associação lote-fatura
4. Atualiza contador de faturas selecionadas no lote
5. Transiciona lote para status `WaitingForProcessing`
6. Envia notificação Azure Service Bus de lote pronto para processamento

**Pós-condições**: Faturas associadas ao lote, status `WaitingForProcessing`

### 2.3 Iniciar Processamento do Lote

**Descrição**: Permite ao usuário ou sistema iniciar o processamento assíncrono do lote, disparando jobs Hangfire paralelos que auditam cada fatura associada individualmente, integrando com RF034 para criação/atualização de itens de auditoria.

**Atores**: Coordenador de Auditoria, Gestor de Auditoria, Sistema (automático via scheduler)

**Pré-condições**: Lote no status `WaitingForProcessing`, faturas selecionadas

**Fluxo**:
1. Usuário clica em "Iniciar Processamento" ou sistema dispara via scheduler
2. Sistema valida estado do lote (não pode estar em `Processing`, `Completed`, `Cancelled`)
3. Transiciona lote para status `Processing`
4. Sistema enfileira N jobs Hangfire paralelos (1 job por fatura, com limite de concorrência configurável)
5. Cada job processa fatura individualmente:
   - Cria item de auditoria via RF034
   - Aplica regras de validação
   - Atualiza status da fatura no lote
   - Incrementa contador de progresso
6. Sistema envia notificações SignalR de progresso em tempo real
7. Quando todas as faturas são processadas, transiciona lote para `Completed`

**Pós-condições**: Lote processado, itens de auditoria criados via RF034, status `Completed`

### 2.4 Monitorar Progresso em Tempo Real

**Descrição**: Permite ao usuário acompanhar o progresso do processamento do lote em tempo real via dashboard com atualização via SignalR (WebSockets), exibindo porcentagem de conclusão, quantidade de faturas processadas/pendentes/com erro, tempo estimado de conclusão e alertas de timeout.

**Atores**: Coordenador de Auditoria, Gestor de Auditoria, Auditor

**Pré-condições**: Lote no status `Processing`

**Fluxo**:
1. Usuário acessa dashboard de monitoramento de lote
2. Sistema estabelece conexão SignalR com servidor
3. Servidor envia atualizações em tempo real a cada fatura processada:
   - Porcentagem de conclusão (faturas processadas / total)
   - Quantidade de faturas processadas, pendentes, com erro
   - Tempo decorrido e estimativa de tempo restante
   - Alertas de timeout (se tempo decorrido > SLA configurado)
4. Dashboard exibe gráficos de progresso, barras de status e logs de operações
5. Usuário pode cancelar processamento a qualquer momento

**Pós-condições**: Usuário informado do progresso em tempo real

### 2.5 Cancelar Lote com Rollback

**Descrição**: Permite ao usuário cancelar um lote que esteja em processamento, executando rollback automático de todos os itens de auditoria já criados, desfazendo operações e liberando recursos.

**Atores**: Coordenador de Auditoria, Gestor de Auditoria

**Pré-condições**: Lote no status `Processing`, usuário com permissão `AUD.LOTES.CANCEL`

**Fluxo**:
1. Usuário clica em "Cancelar Lote" no dashboard
2. Sistema exibe confirmação com impacto (quantidade de faturas já processadas, itens que serão desfeitos)
3. Usuário confirma cancelamento
4. Sistema transiciona lote para status `Cancelled`
5. Sistema para todos os jobs Hangfire pendentes do lote
6. Sistema executa rollback:
   - Deleta itens de auditoria criados via RF034 (soft delete)
   - Marca faturas como "não processadas"
   - Registra histórico de cancelamento com usuário responsável, data/hora, motivo
7. Sistema envia notificação Azure Service Bus de lote cancelado

**Pós-condições**: Lote cancelado, rollback executado, histórico registrado

### 2.6 Consolidar Resultados Automaticamente

**Descrição**: Após conclusão do processamento, sistema executa job de consolidação que agrega resultados de todas as faturas do lote, calculando valores totais (valor total auditado, total de glosas identificadas, economia gerada), estatísticas (taxa de aprovação, taxa de rejeição, distribuição de tipos de glosa) e integra com RF035 para atualização de status global.

**Atores**: Sistema (Hangfire Background Job)

**Pré-condições**: Lote no status `Processing` com todas as faturas processadas

**Fluxo**:
1. Sistema detecta conclusão de todas as faturas do lote
2. Enfileira job Hangfire de consolidação
3. Job consulta todos os itens de auditoria criados via RF034 para faturas do lote
4. Calcula valores totais:
   - Valor total auditado (soma de valores de faturas)
   - Total de glosas identificadas (soma de valores glosados)
   - Economia gerada (valor total de glosas)
5. Calcula estatísticas:
   - Taxa de aprovação (% faturas aprovadas)
   - Taxa de rejeição (% faturas rejeitadas)
   - Distribuição de tipos de glosa
6. Atualiza lote com valores consolidados
7. Integra com RF035 para atualizar status global do lote
8. Transiciona lote para status `Completed`
9. Envia notificação Azure Service Bus de lote concluído

**Pós-condições**: Resultados consolidados, status `Completed`, RF035 atualizado

### 2.7 Arquivar Lote

**Descrição**: Permite ao usuário ou sistema arquivar lotes antigos concluídos, movendo-os para status `Archived` e aplicando política de retenção configurável (ex: arquivar automaticamente lotes concluídos há mais de 90 dias).

**Atores**: Coordenador de Auditoria, Gestor de Auditoria, Sistema (automático via scheduler)

**Pré-condições**: Lote no status `Completed`, usuário com permissão `AUD.LOTES.ARCHIVE`

**Fluxo**:
1. Usuário clica em "Arquivar" ou sistema dispara via scheduler (política de retenção)
2. Sistema valida estado do lote (deve estar `Completed`)
3. Transiciona lote para status `Archived`
4. Opcionalmente move dados para tabela de arquivo frio (otimização de performance)
5. Registra histórico de arquivamento

**Pós-condições**: Lote arquivado, status `Archived`

### 2.8 Exportar Relatório Consolidado

**Descrição**: Permite ao usuário exportar relatório consolidado do lote em formato Excel ou PDF, contendo informações completas (critérios configurados, faturas selecionadas, resultados de auditoria, valores totais, estatísticas, histórico de operações).

**Atores**: Coordenador de Auditoria, Gestor de Auditoria, Auditor

**Pré-condições**: Lote no status `Completed` ou `Archived`, usuário com permissão `AUD.LOTES.EXPORT`

**Fluxo**:
1. Usuário acessa tela de detalhes do lote
2. Clica em "Exportar Relatório"
3. Seleciona formato (Excel/PDF)
4. Sistema gera arquivo com:
   - Cabeçalho: nome do lote, período, critérios, auditor responsável
   - Lista de faturas auditadas: número, transportadora, filial, valor, status, glosas
   - Valores totais: valor auditado, glosas, economia
   - Estatísticas: taxas de aprovação/rejeição, distribuição de glosas
   - Histórico de operações: criação, seleção, processamento, conclusão
5. Sistema retorna arquivo para download

**Pós-condições**: Relatório exportado

### 2.9 Reprocessar Faturas com Erro

**Descrição**: Permite ao usuário reprocessar faturas que falharam durante o processamento inicial do lote, aplicando retry policy exponencial (1 min, 5 min, 15 min) e registrando tentativas e motivos de falha.

**Atores**: Coordenador de Auditoria, Gestor de Auditoria

**Pré-condições**: Lote com faturas em status `Error`, usuário com permissão `AUD.LOTES.REPROCESS`

**Fluxo**:
1. Usuário acessa lista de faturas com erro do lote
2. Seleciona faturas para reprocessar
3. Sistema enfileira jobs Hangfire de retry
4. Aplica retry policy exponencial:
   - 1ª tentativa: imediata
   - 2ª tentativa: após 1 minuto
   - 3ª tentativa: após 5 minutos
   - 4ª tentativa: após 15 minutos
5. Se todas as tentativas falharem, marca fatura como `Error` permanente
6. Registra histórico de tentativas com motivos de falha

**Pós-condições**: Faturas reprocessadas ou marcadas como erro permanente

### 2.10 Atribuir/Reatribuir Auditor

**Descrição**: Permite ao usuário atribuir ou reatribuir auditor responsável por um lote, enviando notificações automáticas para auditor novo/antigo.

**Atores**: Coordenador de Auditoria, Gestor de Auditoria

**Pré-condições**: Lote criado, usuário com permissão `AUD.LOTES.ASSIGN_AUDITOR`

**Fluxo**:
1. Usuário acessa tela de edição do lote
2. Seleciona novo auditor responsável
3. Sistema valida que auditor possui permissão `AUD.LOTES.AUDIT`
4. Atualiza lote com novo auditor
5. Envia notificação para auditor antigo (se houver) informando remoção
6. Envia notificação para auditor novo informando atribuição
7. Registra histórico de reatribuição

**Pós-condições**: Auditor atribuído, notificações enviadas

### 2.11 Configurar SLA e Alertas de Timeout

**Descrição**: Permite ao usuário configurar SLA de timeout por lote (tempo máximo de processamento em horas) e receber alertas automáticos quando timeout é atingido.

**Atores**: Coordenador de Auditoria, Gestor de Auditoria

**Pré-condições**: Lote criado, usuário com permissão `AUD.LOTES.MANAGE_SETTINGS`

**Fluxo**:
1. Usuário acessa configurações do lote
2. Define timeout em horas (ex: 24h, 48h, 72h)
3. Sistema inicia monitoramento de tempo de processamento
4. Se tempo decorrido > timeout configurado:
   - Sistema envia alerta por email para coordenador
   - Exibe alerta no dashboard de monitoramento
   - Registra evento de timeout no histórico
5. Coordenador pode decidir cancelar ou estender SLA

**Pós-condições**: SLA configurado, monitoramento ativo

### 2.12 Visualizar Histórico de Auditoria do Lote

**Descrição**: Permite ao usuário visualizar histórico completo de todas as operações realizadas no lote (criação, seleção de faturas, início de processamento, conclusão, cancelamento, arquivamento, reatribuição de auditor), incluindo usuário responsável, data/hora, IP de origem e descrição da operação.

**Atores**: Coordenador de Auditoria, Gestor de Auditoria, Auditor

**Pré-condições**: Lote criado

**Fluxo**:
1. Usuário acessa tela de detalhes do lote
2. Clica em aba "Histórico de Auditoria"
3. Sistema exibe lista cronológica de eventos:
   - Data/Hora
   - Usuário responsável
   - IP de origem
   - Tipo de operação (Criação, Seleção, Processamento, Conclusão, Cancelamento, etc.)
   - Descrição detalhada
   - Valores antes/depois (para operações de atualização)
4. Usuário pode filtrar por período, tipo de operação, usuário

**Pós-condições**: Histórico visualizado

### 2.13 Dashboard de KPIs de Lotes

**Descrição**: Exibe dashboard consolidado com KPIs e métricas estratégicas de lotes de auditoria (quantidade de lotes ativos/concluídos/cancelados/arquivados, taxa de sucesso global, total de glosas identificadas, tempo médio de processamento, distribuição de lotes por auditor, lotes próximos ao timeout).

**Atores**: Coordenador de Auditoria, Gestor de Auditoria

**Pré-condições**: Usuário autenticado com permissão `AUD.LOTES.VIEW_ALL`

**Fluxo**:
1. Usuário acessa dashboard de lotes
2. Sistema exibe cards com KPIs:
   - Total de lotes ativos (status `Processing`)
   - Total de lotes concluídos hoje/semana/mês
   - Taxa de sucesso global (% lotes concluídos sem erro)
   - Total de glosas identificadas (R$)
   - Tempo médio de processamento (horas)
   - Distribuição de lotes por auditor (gráfico de pizza)
   - Lotes próximos ao timeout (lista)
3. Dashboard atualiza automaticamente a cada 5 minutos

**Pós-condições**: KPIs visualizados

---

## SEÇÃO 3: REGRAS DE NEGÓCIO

### RN-LOT-054-01: Obrigatoriedade de Critérios de Seleção

**Descrição**: Todo lote de auditoria deve possuir pelo menos um critério de seleção de faturas configurado. Critérios válidos incluem período (data início e data fim obrigatórias juntas), transportadora, filial, valor mínimo, valor máximo, tipo de serviço e status de fatura. Não é permitido criar lote sem critérios, pois isso resultaria em seleção indiscriminada de todas as faturas do sistema.

**Motivação**: Garantir que lotes sejam criados com propósito claro e escopo delimitado, evitando processamento desnecessário de faturas não relacionadas ao objetivo da auditoria.

**Impacto**: Validação obrigatória na criação do lote. Sistema deve rejeitar criação se nenhum critério for informado, retornando erro HTTP 400 com mensagem clara.

### RN-LOT-054-02: Lote Imutável Após Processamento Iniciado

**Descrição**: Após um lote transicionar para o status de processamento (Processing), não é permitido alterar seus critérios de seleção, adicionar ou remover faturas manualmente, ou modificar configurações críticas (prioridade, SLA, auditor responsável pode ser alterado). A única operação permitida é o cancelamento do lote, que executará rollback completo.

**Motivação**: Garantir integridade e rastreabilidade do processo de auditoria. Alterações em lote durante processamento poderiam gerar inconsistências entre faturas já auditadas e critérios novos, comprometendo a confiabilidade dos resultados.

**Impacto**: Sistema deve bloquear operações de edição quando status for Processing, Completed, Cancelled ou Archived. Apenas lotes em status Created ou WaitingForProcessing podem ser editados.

### RN-LOT-054-03: Seleção Automática de Faturas por Critérios

**Descrição**: A seleção de faturas para um lote deve ser executada automaticamente pelo sistema em background após a criação do lote, aplicando os critérios configurados (período, transportadora, filial, valor, tipo de serviço, status). O sistema deve consultar a base de faturas disponíveis e associar todas as faturas que atendam aos critérios simultaneamente. Faturas que já estejam associadas a outros lotes ativos (status Processing ou WaitingForProcessing) não devem ser incluídas.

**Motivação**: Evitar seleção manual de faturas (processo lento e propenso a erros), garantir que todas as faturas elegíveis sejam incluídas, e prevenir duplicação de auditoria (mesma fatura em múltiplos lotes ativos simultaneamente).

**Impacto**: Job Hangfire assíncrono deve ser enfileirado na criação do lote. Sistema deve aplicar filtros SQL otimizados e marcar faturas como associadas ao lote. Deve validar que fatura não está em outro lote ativo antes da associação.

### RN-LOT-054-04: Atribuição Manual ou Automática de Auditor

**Descrição**: O auditor responsável por um lote pode ser atribuído manualmente durante a criação do lote ou automaticamente pelo sistema com base em regras de balanceamento de carga (distribuição equitativa de lotes entre auditores disponíveis, considerando carga atual de cada auditor). Se não houver auditor atribuído explicitamente, o sistema deve selecionar automaticamente o auditor com menor quantidade de lotes ativos no momento da criação.

**Motivação**: Garantir distribuição justa de trabalho entre auditores, evitar sobrecarga de auditores específicos, e permitir flexibilidade para casos especiais onde coordenador precisa atribuir auditor específico.

**Impacto**: Sistema deve implementar lógica de balanceamento automático consultando quantidade de lotes ativos por auditor. Se auditor for informado manualmente, validar que possui permissão adequada. Notificar auditor atribuído por email e notificação interna.

### RN-LOT-054-05: Máquina de Estados do Lote

**Descrição**: Todo lote de auditoria deve seguir rigorosamente a máquina de estados definida, com transições controladas. Estados possíveis: Created (criado, aguardando seleção de faturas), WaitingForProcessing (faturas selecionadas, aguardando início de processamento), Processing (processamento em andamento), Completed (processamento concluído com sucesso), Cancelled (cancelado pelo usuário com rollback), Error (erro crítico durante processamento), Archived (arquivado após conclusão). Transições permitidas: Created → WaitingForProcessing (após seleção de faturas), WaitingForProcessing → Processing (ao iniciar processamento), Processing → Completed (ao concluir todas as faturas), Processing → Cancelled (ao cancelar lote), Processing → Error (em caso de erro crítico irrecuperável), Completed → Archived (ao arquivar lote antigo).

**Motivação**: Garantir que o ciclo de vida do lote seja previsível, auditável e que estados inconsistentes sejam impossíveis. Prevenir operações inválidas como iniciar processamento de lote já concluído ou cancelado.

**Impacto**: Sistema deve validar estado atual antes de qualquer transição. Operações que violem a máquina de estados devem ser rejeitadas com erro HTTP 400 descrevendo transição inválida. Histórico de mudanças de estado deve ser registrado em auditoria.

### RN-LOT-054-06: Processamento Assíncrono com Hangfire

**Descrição**: Todo processamento de lote deve ser executado de forma assíncrona em background utilizando Hangfire, sem bloquear a interface do usuário. O sistema deve enfileirar jobs paralelos para processar cada fatura do lote individualmente, respeitando limite de concorrência configurável (ex: máximo 10 faturas processadas simultaneamente por servidor). Jobs devem ser idempotentes (podem ser executados múltiplas vezes sem efeitos colaterais), stateless (não dependem de estado em memória) e resilientes a falhas (retry automático).

**Motivação**: Garantir escalabilidade (processar milhares de faturas sem degradar performance da aplicação), permitir monitoramento de progresso em tempo real, e evitar timeouts de HTTP em processamentos longos.

**Impacto**: Implementar jobs Hangfire com atributos corretos (AutomaticRetry, Queue). Configurar limites de concorrência no Dashboard do Hangfire. Garantir que jobs sejam stateless e idempotentes.

### RN-LOT-054-07: Monitoramento de Progresso com SignalR

**Descrição**: Durante o processamento de um lote, o sistema deve enviar atualizações de progresso em tempo real para todos os clientes conectados (usuários visualizando o dashboard do lote) via SignalR (WebSockets). Atualizações devem incluir porcentagem de conclusão calculada como (faturas processadas / total de faturas) × 100, quantidade de faturas processadas com sucesso, quantidade de faturas com erro, tempo decorrido desde início do processamento, estimativa de tempo restante baseada em velocidade média de processamento, e logs de operações críticas.

**Motivação**: Fornecer visibilidade completa do progresso do lote sem necessidade de refresh manual da página, permitir intervenção rápida em caso de erros massivos, e melhorar experiência do usuário com feedback em tempo real.

**Impacto**: Implementar Hub SignalR dedicado para lotes. Jobs Hangfire devem enviar mensagens SignalR após processar cada fatura. Frontend deve estabelecer conexão WebSocket e atualizar UI dinamicamente.

### RN-LOT-054-08: Reprocessamento Automático com Retry Policy

**Descrição**: Faturas que falharem durante o processamento do lote devem ser automaticamente reprocessadas seguindo política de retry exponencial. Primeira tentativa deve ser imediata. Segunda tentativa deve ocorrer após 1 minuto de espera. Terceira tentativa deve ocorrer após 5 minutos. Quarta tentativa deve ocorrer após 15 minutos. Se todas as quatro tentativas falharem, a fatura deve ser marcada como erro permanente e o sistema deve registrar todos os motivos de falha no histórico. Erros permanentes devem gerar alerta para coordenador de auditoria.

**Motivação**: Garantir resiliência a falhas temporárias (timeouts de rede, indisponibilidade momentânea de serviços externos, locks de banco de dados), maximizar taxa de sucesso do processamento, e minimizar intervenção manual.

**Impacto**: Configurar Hangfire com atributo AutomaticRetry(Attempts = 4, DelaysInSeconds = [0, 60, 300, 900]). Registrar cada tentativa no histórico da fatura. Enviar alerta se fatura atingir erro permanente.

### RN-LOT-054-09: Integração com RF034 (Itens de Auditoria)

**Descrição**: Durante o processamento de cada fatura do lote, o sistema deve criar ou atualizar itens de auditoria individuais via integração com RF034 (Gestão de Itens de Auditoria). Para cada fatura processada, deve ser criado um item de auditoria contendo tipo de auditoria (ex: Auditoria de Valores, Auditoria de Documentos), status (Aprovado, Rejeitado, Pendente de Revisão), valores auditados, valores glosados, observações do auditor, e evidências anexadas. Se a fatura já possuir item de auditoria existente, este deve ser atualizado com novos valores e não duplicado.

**Motivação**: Garantir rastreabilidade individual de cada fatura auditada dentro do lote, permitir análises granulares de resultados por fatura, e manter consistência com módulo de itens de auditoria.

**Impacto**: Job de processamento de fatura deve invocar endpoints da API de RF034 (CreateAuditItem ou UpdateAuditItem). Tratar erros de integração adequadamente (se RF034 falhar, marcar fatura como erro no lote e aplicar retry). Validar que item criado está associado ao lote.

### RN-LOT-054-10: Consolidação Automática com RF035

**Descrição**: Após conclusão do processamento de todas as faturas do lote, o sistema deve executar job de consolidação que calcula valores totais (valor total auditado = soma de valores de todas as faturas do lote, total de glosas identificadas = soma de valores glosados de todas as faturas, economia gerada = total de glosas), estatísticas (taxa de aprovação = percentual de faturas aprovadas, taxa de rejeição = percentual de faturas rejeitadas, distribuição de tipos de glosa), e integra com RF035 (Gestão de Status de Auditoria) para atualizar status global do lote baseado em resultados individuais.

**Motivação**: Fornecer visão consolidada do resultado do lote sem necessidade de agregação manual, permitir decisões estratégicas baseadas em métricas globais, e manter consistência com módulo de status de auditoria.

**Impacto**: Implementar job Hangfire de consolidação enfileirado após última fatura ser processada. Calcular valores agregados via queries SQL otimizadas. Invocar endpoint de RF035 para atualizar status global. Transicionar lote para status Completed após consolidação bem-sucedida.

### RN-LOT-054-11: Histórico e Auditoria Completa de Operações

**Descrição**: Todas as operações realizadas em um lote de auditoria devem ser registradas em histórico de auditoria com rastreabilidade completa. Operações auditáveis incluem criação do lote (com critérios configurados, auditor atribuído, prioridade, SLA), seleção de faturas (quantidade selecionada, critérios aplicados, data/hora), início de processamento (usuário que iniciou ou sistema via scheduler), conclusão de processamento (valores consolidados, tempo total), cancelamento (usuário responsável, motivo, faturas afetadas), arquivamento (data de arquivamento, política aplicada), reatribuição de auditor (auditor antigo, auditor novo, motivo), alteração de configurações (campo alterado, valor antigo, valor novo). Cada registro de auditoria deve conter usuário responsável (ou "SYSTEM" para operações automáticas), data/hora com precisão de milissegundos, IP de origem do usuário, descrição detalhada da operação, e valores antes/depois para operações de atualização.

**Motivação**: Garantir conformidade com requisitos de auditoria e compliance, permitir investigação de incidentes e erros, fornecer transparência total do processo de auditoria, e possibilitar análise de padrões de uso do sistema.

**Impacto**: Implementar interceptor automático que registra todas as operações. Usar middleware de auditoria global. Armazenar logs em tabela dedicada com índices otimizados para consultas por lote, usuário, período. Fornecer tela de visualização de histórico filtrada e paginada.

### RN-LOT-054-12: Notificações Assíncronas via Azure Service Bus

**Descrição**: O sistema deve enviar notificações assíncronas via Azure Service Bus para eventos críticos do ciclo de vida do lote. Eventos notificáveis incluem lote criado (com quantidade de faturas selecionadas), lote pronto para processamento (após seleção de faturas), lote iniciado (processamento começou), lote concluído (processamento finalizado com valores consolidados), lote cancelado (com motivo e usuário responsável), lote atingiu timeout (SLA excedido, alerta crítico), erro crítico durante processamento (descrição do erro, stack trace). Mensagens enviadas ao barramento devem conter identificador do lote, tipo de evento, data/hora do evento, payload com dados relevantes (ex: valores consolidados para evento de conclusão), e metadados de rastreamento (correlation ID, usuário responsável).

**Motivação**: Permitir integração com sistemas externos (ex: sistemas de BI, dashboards executivos, sistemas de notificação por email/SMS), desacoplar módulo de lotes de consumidores de eventos, e garantir escalabilidade de notificações (barramento garante entrega mesmo se consumidores estiverem offline temporariamente).

**Impacto**: Implementar publicação de mensagens no Azure Service Bus após cada evento crítico. Configurar topics/subscriptions apropriados. Implementar serialização JSON padronizada. Garantir que falhas no envio de mensagens não bloqueiem operações principais (envio deve ser assíncrono e resiliente).

### RN-LOT-054-13: Cancelamento de Lote com Rollback

**Descrição**: Quando um lote em processamento for cancelado pelo usuário, o sistema deve executar rollback completo de todas as operações já realizadas. Rollback deve incluir soft delete de todos os itens de auditoria criados via RF034 para faturas do lote (marcar como excluído sem deletar fisicamente), desassociação de faturas do lote (permitir que sejam incluídas em novos lotes futuros), reversão de status de faturas para estado anterior ao processamento, cancelamento de todos os jobs Hangfire pendentes ou em execução relacionados ao lote (via DeleteJob do Hangfire), e registro detalhado no histórico de auditoria contendo usuário responsável pelo cancelamento, data/hora, motivo informado, quantidade de faturas afetadas, e valores já processados antes do cancelamento.

**Motivação**: Garantir que cancelamento de lote não deixe dados inconsistentes no sistema, permitir reprocessamento de faturas em novo lote se necessário, e evitar desperdício de recursos com jobs órfãos continuando processamento após cancelamento.

**Impacto**: Implementar transação distribuída para rollback (se possível) ou garantir idempotência de operações de rollback (permitir execução múltipla sem efeitos colaterais). Invocar endpoint de RF034 para soft delete de itens. Atualizar status de lote para Cancelled. Cancelar jobs via API do Hangfire.

### RN-LOT-054-14: SLA e Alertas de Timeout

**Descrição**: Todo lote de auditoria deve ter SLA de timeout configurável representando tempo máximo esperado de processamento em horas (ex: 24h, 48h, 72h). O sistema deve monitorar continuamente o tempo decorrido desde o início do processamento de cada lote ativo. Quando tempo decorrido ultrapassar o SLA configurado, o sistema deve disparar alertas automáticos incluindo envio de email para coordenador de auditoria e gestores com informações do lote (nome, quantidade de faturas, porcentagem de conclusão, tempo decorrido, SLA configurado), exibição de alerta visual no dashboard de monitoramento de lotes (card destacado em vermelho com ícone de alerta), registro de evento de timeout no histórico de auditoria do lote, e envio de mensagem Azure Service Bus para integração com sistemas externos. Coordenador pode optar por cancelar lote com timeout ou estender SLA para permitir conclusão.

**Motivação**: Identificar rapidamente lotes com problemas de performance (jobs travados, erros recorrentes não tratados, gargalos de infraestrutura), garantir cumprimento de SLAs contratuais com clientes internos/externos, e permitir intervenção proativa antes que atrasos afetem operações críticas.

**Impacto**: Implementar job Hangfire recorrente (executar a cada 5 minutos) que consulta lotes ativos e compara tempo decorrido com SLA. Enviar emails via serviço de notificação. Atualizar flag de timeout no lote. Emitir evento SignalR para atualizar dashboard em tempo real. Publicar mensagem no Azure Service Bus.

---

**Nota**: As seções 4-11 (Integrações Obrigatórias, Permissões RBAC, API Endpoints, Modelo de Dados, Dependências, KPIs e Métricas, Alertas Críticos, Central de Funcionalidades) foram omitidas neste preview para manter o tamanho do documento gerenciável. O documento completo contém todas as 11 seções conforme Governance v2.0.

---

**FIM DO DOCUMENTO RF054 v2.0 (Preview - Seções 1-3)**
