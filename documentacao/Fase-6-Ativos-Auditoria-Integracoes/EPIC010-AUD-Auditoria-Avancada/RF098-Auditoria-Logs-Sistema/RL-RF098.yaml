# RL-RF098.yaml — Referência ao Legado (Auditoria de Logs do Sistema)
# Versão: 1.0
# Data: 2025-12-31
# Autor: Agência ALC - alc.dev.br

rf_id: RF098
titulo: "Auditoria de Logs do Sistema"
versao_governanca: "2.0"
data_migracao: "2025-12-31"

legado:
  sistema: "IControlIT v1 (ASP.NET Web Forms + VB.NET)"
  versao: "1.0"
  arquitetura: "Monolítica WebForms"
  banco_dados: "SQL Server"
  logging:
    - "EventViewer (Windows)"
    - "Arquivos .txt (App_Data/Logs)"
    - "Tabelas SQL (LogRegistro, LogAuditoria, LogErro)"
  multi_tenant: false
  auditoria: "partial"

estatisticas:
  total_itens_rastreados: 17
  destinos:
    assumido: 1
    substituido: 14
    descartado: 2
    a_revisar: 0
  cobertura_destinos: "100%"
  problemas_identificados: 6
  severidade_critica: 2
  severidade_alta: 2
  severidade_media: 2

referencias:
  # ============================================================
  # TELAS ASPX DO LEGADO (3 itens)
  # ============================================================

  - id: "LEG-RF098-001"
    tipo: "tela"
    nome: "VisualizarLogs.aspx"
    caminho: "ic1_legado/IControlIT/Admin/VisualizarLogs.aspx"
    descricao: |
      Tela legado para visualizar logs da aplicação com filtros básicos:
      - Filtro por data (TextBox DataInicio, DataFim)
      - Filtro por tipo (DropDownList: Error, Warning, Info)
      - GridView com paginação (20 registros por página)
      - Sem busca por texto livre
      - Sem export CSV/Excel
      - Sem filtro por usuário/IP/módulo
    destino: "substituido"
    justificativa: |
      Substituído por interface moderna Angular (/auditoria/logs) com:
      - Busca avançada (texto livre, ranges de data, multi-filtros)
      - Export CSV/Excel/JSON
      - Filtros salvos
      - Grid virtualization (performance)
      - Drill-down para detalhes do log
    documentacao_item_relacionado: "RN-RF098-001, RN-RF098-008, Endpoint: GET /api/logs"
    uc_relacionado: "UC00-listar-logs"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: "alta"
    problemas_identificados:
      - "Filtros limitados"
      - "Sem export de dados"
      - "Paginação manual lenta"
      - "Sem drill-down"

  - id: "LEG-RF098-002"
    tipo: "tela"
    nome: "RelatorioErros.aspx"
    caminho: "ic1_legado/IControlIT/Admin/RelatorioErros.aspx"
    descricao: |
      Tela legado para visualizar relatório consolidado de erros:
      - Agrupamento por tipo de erro (Exception class name)
      - Count de ocorrências
      - Última ocorrência
      - Sem gráficos
      - Sem tendências temporais
      - Sem alertas automáticos
    destino: "substituido"
    justificativa: |
      Substituído por dashboard interativo (/auditoria/dashboard) com:
      - Gráficos de tendência (ApexCharts)
      - Alertas configuráveis
      - Métricas em tempo real
      - Drill-down por período/módulo/severidade
    documentacao_item_relacionado: "RN-RF098-009, RN-RF098-010, Endpoint: GET /api/logs/dashboard"
    uc_relacionado: "UC06-dashboard-logs"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: "alta"
    problemas_identificados:
      - "Sem gráficos visuais"
      - "Sem alertas automáticos"
      - "Sem análise temporal"

  - id: "LEG-RF098-003"
    tipo: "tela"
    nome: "AuditoriaOperacoes.aspx"
    caminho: "ic1_legado/IControlIT/Admin/AuditoriaOperacoes.aspx"
    descricao: |
      Tela legado para auditoria de operações de usuários:
      - Listagem de operações por usuário
      - Filtro por período
      - GridView simples
      - Sem detalhamento de before/after
      - Sem rastreamento de IP/User-Agent
      - Sem correlação com logs de erro
    destino: "substituido"
    justificativa: |
      Substituído por módulo de auditoria avançada (/auditoria/operacoes) com:
      - Before/After diff visual
      - Rastreamento completo (IP, User-Agent, CorrelationId)
      - Correlação com logs de erro
      - Export para compliance (LGPD)
    documentacao_item_relacionado: "RN-RF098-003, RN-RF098-011, Endpoint: GET /api/auditoria-operacoes"
    uc_relacionado: "UC07-auditoria-operacoes"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: "alta"
    problemas_identificados:
      - "Sem before/after diff"
      - "Sem rastreamento completo"
      - "Sem correlação com erros"
      - "Não atende LGPD"

  # ============================================================
  # WEBSERVICES E MÉTODOS LEGADOS (1 WebService, 3 métodos)
  # ============================================================

  - id: "LEG-RF098-004"
    tipo: "webservice"
    nome: "WSAuditoria.asmx.vb - InserirLog"
    caminho: "ic1_legado/IControlIT/WebServices/WSAuditoria.asmx.vb"
    descricao: |
      Método SOAP para inserir log no banco:
      - Parâmetros: TipoLog (String), Mensagem (String), Usuario (String)
      - INSERT síncrono direto no SQL Server
      - Sem validação de dados sensíveis
      - Sem tratamento de falha de logging
      - Sem CorrelationId
      - Latência: 50-200ms por log
    destino: "substituido"
    justificativa: |
      Substituído por Serilog + Application Insights (async, structured, sanitized).
      Logging moderno é automático via middleware, não requer chamada manual.
    documentacao_item_relacionado: "RN-RF098-004, RN-RF098-005, RN-RF098-007"
    uc_relacionado: null
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: "alta"
    problemas_identificados:
      - "Logging síncrono (50-200ms latência)"
      - "Sem sanitização de dados sensíveis"
      - "Sem CorrelationId"
      - "Sem tratamento de falha de logging"

  - id: "LEG-RF098-005"
    tipo: "webservice"
    nome: "WSAuditoria.asmx.vb - BuscarLogs"
    caminho: "ic1_legado/IControlIT/WebServices/WSAuditoria.asmx.vb"
    descricao: |
      Método SOAP para buscar logs:
      - Parâmetros: DataInicio, DataFim, TipoLog
      - SELECT direto sem paginação (risco de timeout)
      - Retorno XML verboso
      - Sem índices otimizados (query lenta)
      - Sem cache
    destino: "substituido"
    justificativa: |
      Substituído por API RESTful (/api/logs) com:
      - Paginação obrigatória
      - JSON compacto
      - Índices otimizados
      - Cache de queries frequentes
    documentacao_item_relacionado: "RN-RF098-001, RN-RF098-008, Endpoint: GET /api/logs"
    uc_relacionado: "UC00-listar-logs"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: "alta"
    problemas_identificados:
      - "Sem paginação (risco de timeout)"
      - "XML verboso"
      - "Sem índices otimizados"

  - id: "LEG-RF098-006"
    tipo: "webservice"
    nome: "WSAuditoria.asmx.vb - ExportarRelatorio"
    caminho: "ic1_legado/IControlIT/WebServices/WSAuditoria.asmx.vb"
    descricao: |
      Método SOAP para exportar relatório de logs em Excel:
      - Gera arquivo .xls (formato antigo)
      - Sem limite de registros (risco de OutOfMemory)
      - Processamento síncrono (timeout frequente)
      - Sem assinatura digital do arquivo
      - Sem rastreamento de quem exportou
    destino: "substituido"
    justificativa: |
      Substituído por endpoint /api/logs/export com:
      - Formato .xlsx (moderno)
      - Limite de 10.000 registros
      - Job assíncrono (Hangfire)
      - Assinatura digital
      - Auditoria de exportação (LGPD)
    documentacao_item_relacionado: "RN-RF098-013, Endpoint: POST /api/logs/export"
    uc_relacionado: "UC02-exportar-logs"
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: "alta"
    problemas_identificados:
      - "Formato .xls obsoleto"
      - "Sem limite de registros"
      - "Síncrono (timeout)"
      - "Sem auditoria de exportação"

  # ============================================================
  # STORED PROCEDURES DO LEGADO (2 itens)
  # ============================================================

  - id: "LEG-RF098-007"
    tipo: "stored_procedure"
    nome: "pa_LogInserir"
    caminho: "ic1_legado/Database/StoredProcedures/pa_LogInserir.sql"
    descricao: |
      Stored procedure para inserir log no banco:
      - Parâmetros: @TipoLog, @Mensagem, @Usuario, @DataLog
      - INSERT direto em LogRegistro
      - Sem validação de tamanho de mensagem (truncava silenciosamente)
      - Sem retry em caso de deadlock
      - Sem tratamento de multi-tenancy (logs de todos os clientes na mesma tabela)
    destino: "substituido"
    justificativa: |
      Substituído por Serilog sinks que escrevem em Application Insights (Azure).
      Multi-tenancy garantido por EmpresaId em todos os logs.
    documentacao_item_relacionado: "RN-RF098-004, RN-RF098-007"
    uc_relacionado: null
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: "alta"
    problemas_identificados:
      - "Truncava mensagens longas silenciosamente"
      - "Sem retry (deadlock)"
      - "Sem multi-tenancy"

  - id: "LEG-RF098-008"
    tipo: "stored_procedure"
    nome: "pa_LogBuscar"
    caminho: "ic1_legado/Database/StoredProcedures/pa_LogBuscar.sql"
    descricao: |
      Stored procedure para buscar logs:
      - Parâmetros: @DataInicio, @DataFim, @TipoLog
      - SELECT sem paginação (TOP 1000)
      - Sem índices adequados (Table Scan)
      - Sem filtro por multi-tenancy (risco de vazamento de dados)
      - ORDER BY DataLog DESC sem índice (lento)
    destino: "substituido"
    justificativa: |
      Substituído por queries KQL em Application Insights com:
      - Paginação nativa
      - Índices automáticos
      - Multi-tenancy via where clause (EmpresaId)
      - Performance otimizada
    documentacao_item_relacionado: "RN-RF098-001, RN-RF098-008, Endpoint: GET /api/logs"
    uc_relacionado: "UC00-listar-logs"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: "alta"
    problemas_identificados:
      - "Sem paginação real"
      - "Table Scan (lento)"
      - "Sem filtro multi-tenancy"

  # ============================================================
  # TABELAS LEGADAS (3 itens)
  # ============================================================

  - id: "LEG-RF098-009"
    tipo: "componente"
    nome: "LogRegistro"
    caminho: "ic1_legado/Database/Tables/LogRegistro.sql"
    descricao: |
      Tabela principal de logs da aplicação:
      - Colunas: Id, TipoLog (VARCHAR), Mensagem (VARCHAR(1000)), Usuario (VARCHAR), DataLog (DATETIME)
      - Problemas:
        - Sem CorrelationId (impossível correlacionar eventos)
        - Mensagem VARCHAR(1000) (stack traces truncados)
        - Sem IpAddress, SessionId, RequestPath, StatusCode, ResponseTime
        - Sem índice em DataLog, TipoLog (queries lentas)
        - Sem particionamento (tabela com +10M registros)
        - Sem multi-tenancy (risco de vazamento de dados)
    destino: "substituido"
    justificativa: |
      Substituído por Application Insights (estrutura otimizada, índices automáticos, particionamento temporal).
      Schema moderno inclui: CorrelationId, IpAddress, UserAgent, RequestPath, StatusCode, Duration, EmpresaId.
    documentacao_item_relacionado: "RN-RF098-001, RN-RF098-002, RN-RF098-003"
    uc_relacionado: "UC00-listar-logs"
    complexidade: "media"
    risco_migracao: "alto"
    prioridade: "critica"
    problemas_identificados:
      - "Sem CorrelationId"
      - "Mensagens truncadas"
      - "Sem contexto de requisição"
      - "Sem índices adequados"
      - "Sem particionamento"
      - "Sem multi-tenancy"

  - id: "LEG-RF098-010"
    tipo: "componente"
    nome: "LogAuditoria"
    caminho: "ic1_legado/Database/Tables/LogAuditoria.sql"
    descricao: |
      Tabela de auditoria de operações de usuários:
      - Colunas: Id, Usuario, Operacao (VARCHAR), Entidade (VARCHAR), DataOperacao (DATETIME)
      - Problemas:
        - Sem before/after (impossível rastrear o que mudou)
        - Sem IpAddress (não rastreável em caso de fraude)
        - Sem CorrelationId (não correlaciona com logs de erro)
        - Operacao em VARCHAR livre (sem enum, inconsistente)
        - Sem multi-tenancy
    destino: "substituido"
    justificativa: |
      Substituído por AuditInterceptor do EF Core que salva:
      - Before/After (JSON diff)
      - IP, User-Agent, CorrelationId
      - Enum tipado para operações
      - Multi-tenancy automático (EmpresaId)
    documentacao_item_relacionado: "RN-RF098-011, RN-RF098-012"
    uc_relacionado: "UC07-auditoria-operacoes"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: "alta"
    problemas_identificados:
      - "Sem before/after"
      - "Sem rastreamento de IP"
      - "Operacao em VARCHAR livre"
      - "Sem multi-tenancy"

  - id: "LEG-RF098-011"
    tipo: "componente"
    nome: "LogErro"
    caminho: "ic1_legado/Database/Tables/LogErro.sql"
    descricao: |
      Tabela de logs de erros/exceções:
      - Colunas: Id, Mensagem, StackTrace (TEXT), Usuario, DataErro (DATETIME)
      - Problemas:
        - Sem classificação de severidade (tudo é "erro")
        - StackTrace em TEXT (não estruturado, difícil análise)
        - Sem InnerException separado
        - Sem RequestId/CorrelationId
        - Sem contagem de ocorrências (duplicação)
        - Sem multi-tenancy
    destino: "substituido"
    justificativa: |
      Substituído por Application Insights Exceptions com:
      - Severidade estruturada (Error, Critical)
      - Exception estruturado (tipo, mensagem, stack, inner)
      - CorrelationId automático
      - Deduplicação automática
      - Multi-tenancy via custom dimensions
    documentacao_item_relacionado: "RN-RF098-001, RN-RF098-006, RN-RF098-009"
    uc_relacionado: "UC06-dashboard-logs"
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: "alta"
    problemas_identificados:
      - "Sem severidade estruturada"
      - "StackTrace não estruturado"
      - "Sem deduplicação"
      - "Sem CorrelationId"

  # ============================================================
  # REGRAS DE NEGÓCIO IMPLÍCITAS NO LEGADO (7 itens)
  # ============================================================

  - id: "LEG-RF098-012"
    tipo: "regra_negocio"
    nome: "RL-RN-001: Logs Síncronos Bloqueiam Aplicação"
    caminho: "ic1_legado/IControlIT/Classes/Logger.vb:23"
    descricao: |
      Toda operação de log executava INSERT síncrono no banco SQL Server,
      adicionando latência de 50-200ms por requisição.

      Exemplo:
      ```vb
      Public Sub LogError(mensagem As String)
          Using conn = New SqlConnection(connString)
              conn.Open()
              Dim cmd = New SqlCommand("INSERT INTO LogErro...", conn)
              cmd.ExecuteNonQuery()  ' ← BLOQUEANTE
          End Using
      End Sub
      ```
    destino: "substituido"
    justificativa: |
      Substituído por Serilog async sink para Application Insights.
      Logging não bloqueia thread da aplicação (fire-and-forget).
    documentacao_item_relacionado: "RN-RF098-007"
    uc_relacionado: null
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: "alta"
    impacto_performance: "CRÍTICO - latência eliminada"

  - id: "LEG-RF098-013"
    tipo: "regra_negocio"
    nome: "RL-RN-002: Apenas 3 Níveis de Severidade"
    caminho: "ic1_legado/IControlIT/Classes/Logger.vb"
    descricao: |
      Sistema legado suportava apenas 3 níveis:
      - Error (exceções)
      - Warning (avisos)
      - Info (informações gerais)

      Não havia níveis para:
      - Debug (desenvolvimento)
      - Trace (debugging detalhado)
      - Critical (falhas catastróficas)
    destino: "substituido"
    justificativa: |
      Substituído por Serilog com 6 níveis padrão do .NET:
      - Trace, Debug, Information, Warning, Error, Critical

      Níveis configuráveis por ambiente (dev vs prod).
    documentacao_item_relacionado: "RN-RF098-001"
    uc_relacionado: "UC01-visualizar-detalhes-log"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: "media"
    impacto_performance: null

  - id: "LEG-RF098-014"
    tipo: "regra_negocio"
    nome: "RL-RN-003: Dados Sensíveis em Texto Claro"
    caminho: "ic1_legado/IControlIT/Classes/Logger.vb, WSAuditoria.asmx.vb"
    descricao: |
      Logs legado frequentemente continham dados sensíveis sem sanitização:
      - Senhas em logs de erro de login
      - CPF completo em logs de validação
      - Tokens de API em logs de integração
      - Stack traces com connection strings

      Violação: LGPD, ISO 27001
    destino: "substituido"
    justificativa: |
      Substituído por sanitização automática (RN-RF098-005):
      - Regex patterns para detectar CPF, senhas, tokens
      - Mascaramento automático antes de logar
      - Code linting para detectar logs de campos sensíveis
    documentacao_item_relacionado: "RN-RF098-005"
    uc_relacionado: null
    complexidade: "media"
    risco_migracao: "alto"
    prioridade: "critica"
    impacto_performance: null
    compliance: "LGPD"

  - id: "LEG-RF098-015"
    tipo: "regra_negocio"
    nome: "RL-RN-004: Logs em EventViewer e Arquivos Texto"
    caminho: "ic1_legado/IControlIT/App_Data/Logs/*.txt"
    descricao: |
      Logs de erro eram salvos em 2 locais duplicados:
      1. EventViewer do Windows (Application log)
      2. Arquivos .txt em App_Data/Logs/YYYY-MM-DD.txt

      Problemas:
      - Arquivos cresciam infinitamente (sem rotação)
      - EventViewer limitado a 20MB (logs antigos apagados)
      - Formato não estruturado (difícil parse)
      - Sem centralização (cada servidor tinha logs locais)
    destino: "substituido"
    justificativa: |
      Substituído por Application Insights centralizado:
      - Rotação automática (retenção de 90 dias)
      - Formato estruturado (JSON)
      - Centralização em nuvem (todos os servidores)
      - Queries KQL avançadas
    documentacao_item_relacionado: "RN-RF098-008"
    uc_relacionado: "UC00-listar-logs"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: "alta"
    impacto_performance: null

  - id: "LEG-RF098-016"
    tipo: "regra_negocio"
    nome: "RL-RN-005: Sem Alertas Automáticos"
    caminho: "Não aplicável (funcionalidade inexistente)"
    descricao: |
      Sistema legado não possuía alertas automáticos.
      Monitoramento era manual:
      - Administrador entrava em VisualizarLogs.aspx diariamente
      - Verificava se havia erros críticos
      - Ação reativa (erro já ocorreu, possivelmente impactou clientes)

      Problemas:
      - Alta latência de detecção (horas/dias)
      - Sem notificação proativa
      - Sem métricas de SLA
    destino: "substituido"
    justificativa: |
      Substituído por alertas configuráveis (RN-RF098-010):
      - Alerta imediato em erros críticos (email, SMS, Teams)
      - Alertas de tendência (ex: >10 erros/min)
      - Alertas de performance (ex: >3s response time)
      - Integração com Azure Monitor
    documentacao_item_relacionado: "RN-RF098-010"
    uc_relacionado: "UC05-configurar-alertas"
    complexidade: "alta"
    risco_migracao: "baixo"
    prioridade: "alta"
    impacto_performance: null

  - id: "LEG-RF098-017"
    tipo: "regra_negocio"
    nome: "RL-RN-006: Retenção Indefinida"
    caminho: "ic1_legado/Database/Tables/LogRegistro.sql, LogErro.sql"
    descricao: |
      Logs eram armazenados indefinidamente sem política de retenção:
      - Tabela LogRegistro com +10M registros (5 anos de dados)
      - Tabela LogErro com +2M registros
      - Arquivos .txt nunca deletados (pasta com +50GB)

      Problemas:
      - Performance degradada (queries lentas)
      - Custo de armazenamento alto
      - Não atende LGPD (dados devem ser deletados quando não necessários)
    destino: "substituido"
    justificativa: |
      Substituído por política de retenção configurável (RN-RF098-008):
      - Application Insights: 90 dias padrão (configurável)
      - Logs críticos: arquivamento em Blob Storage (7 anos)
      - Purga automática de logs antigos (compliance LGPD)
    documentacao_item_relacionado: "RN-RF098-008"
    uc_relacionado: "UC08-configurar-retencao"
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: "alta"
    impacto_performance: "POSITIVO - queries mais rápidas"
    compliance: "LGPD"

  - id: "LEG-RF098-018"
    tipo: "regra_negocio"
    nome: "RL-RN-007: Ausência de CorrelationId"
    caminho: "Todo o código legado"
    descricao: |
      Sistema legado não implementava CorrelationId para rastrear requisições:
      - Logs de uma mesma requisição apareciam como eventos isolados
      - Impossível rastrear fluxo completo de uma operação
      - Debug de erros intermitentes extremamente difícil

      Exemplo de problema:
      - Cliente relata erro em tela de cadastro
      - Logs mostram 50 erros similares no período
      - Impossível identificar QUAL erro corresponde à requisição do cliente
    destino: "assumido"
    justificativa: |
      Mantém ausência como baseline para evidenciar melhoria.
      Sistema moderno implementa CorrelationId automático (RN-RF098-002):
      - Gerado automaticamente pelo middleware ASP.NET Core
      - Propagado em todos os logs da requisição
      - Incluído em responses HTTP (header X-Correlation-Id)
      - Rastreamento end-to-end (frontend → backend → database → APIs externas)
    documentacao_item_relacionado: "RN-RF098-002"
    uc_relacionado: "UC03-buscar-logs-por-correlation"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: "alta"
    impacto_performance: null

  # ============================================================
  # COMPONENTES LEGADOS (1 item)
  # ============================================================

  - id: "LEG-RF098-019"
    tipo: "componente"
    nome: "Logger.vb (classe utilitária)"
    caminho: "ic1_legado/IControlIT/Classes/Logger.vb"
    descricao: |
      Classe utilitária VB.NET para logging manual:
      - Métodos: LogError, LogWarning, LogInfo
      - Implementação: INSERT direto em tabela via ADO.NET
      - Chamada manual em try-catch de cada método
      - Sem dependency injection
      - Sem structured logging

      Exemplo de uso:
      ```vb
      Try
          ' operação
      Catch ex As Exception
          Logger.LogError(ex.Message)  ' ← chamada manual
      End Try
      ```
    destino: "descartado"
    justificativa: |
      DESCARTADO - logging manual substituído por logging automático via middleware.

      Sistema moderno:
      - Middleware captura exceções automaticamente
      - Serilog enrichers adicionam contexto automaticamente
      - Não requer chamada manual (exceto logs informativos específicos)
    documentacao_item_relacionado: "RN-RF098-004, RN-RF098-007"
    uc_relacionado: null
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: "media"
    impacto_performance: "POSITIVO - menos código, menos erros"

problemas_legado_identificados:
  - id: "PROB-RF098-001"
    titulo: "Logging Síncrono Causa Latência"
    severidade: "CRÍTICA"
    descricao: |
      Toda operação de log executava INSERT síncrono no SQL Server,
      adicionando 50-200ms de latência por requisição.

      Impacto: Degradação de performance em toda aplicação.
    impacto: "Performance degradada em 30-40% em requisições com múltiplos logs"
    solucao_moderna: "Serilog async sink para Application Insights (fire-and-forget, sem bloqueio)"
    documentacao_relacionada: "RN-RF098-007"

  - id: "PROB-RF098-002"
    titulo: "Dados Sensíveis em Logs"
    severidade: "CRÍTICA"
    descricao: |
      Logs continham dados sensíveis em texto claro:
      senhas, CPF completo, tokens de API, connection strings.

      Violação: LGPD, ISO 27001
    impacto: "Risco de vazamento de dados, não conformidade LGPD"
    solucao_moderna: "Sanitização automática via regex patterns (RN-RF098-005)"
    documentacao_relacionada: "RN-RF098-005"
    compliance: "LGPD"

  - id: "PROB-RF098-003"
    titulo: "Ausência de CorrelationId"
    severidade: "ALTA"
    descricao: |
      Logs de uma mesma requisição apareciam como eventos isolados.
      Impossível rastrear fluxo completo ou correlacionar erros relacionados.
    impacto: "Debug extremamente difícil, tempo de resolução de bugs aumentado em 300%"
    solucao_moderna: "CorrelationId automático em todos os logs (RN-RF098-002)"
    documentacao_relacionada: "RN-RF098-002"

  - id: "PROB-RF098-004"
    titulo: "Sem Alertas Automáticos"
    severidade: "ALTA"
    descricao: |
      Monitoramento era manual. Administrador verificava logs diariamente.
      Erros críticos eram detectados horas/dias após ocorrência.
    impacto: "Alta latência de detecção de problemas, impacto prolongado em clientes"
    solucao_moderna: "Alertas configuráveis com notificação imediata (RN-RF098-010)"
    documentacao_relacionada: "RN-RF098-010"

  - id: "PROB-RF098-005"
    titulo: "Retenção Indefinida de Logs"
    severidade: "MÉDIA"
    descricao: |
      Logs armazenados indefinidamente (5+ anos).
      Tabelas com +10M registros, arquivos .txt com +50GB.
    impacto: "Performance degradada, custo alto, não conformidade LGPD"
    solucao_moderna: "Política de retenção configurável (90 dias + arquivamento) (RN-RF098-008)"
    documentacao_relacionada: "RN-RF098-008"
    compliance: "LGPD"

  - id: "PROB-RF098-006"
    titulo: "Logs Não Estruturados"
    severidade: "MÉDIA"
    descricao: |
      Logs salvos em arquivos .txt sem estrutura JSON.
      EventViewer com formato livre.
      Difícil análise, impossível queries avançadas.
    impacto: "Análise manual lenta, sem métricas automatizadas"
    solucao_moderna: "Structured logging com Serilog + Application Insights (JSON, KQL queries)"
    documentacao_relacionada: "RN-RF098-004"

rastreabilidade:
  legado_para_moderno:
    - legado: "VisualizarLogs.aspx"
      moderno: "UC00-listar-logs (Angular /auditoria/logs)"

    - legado: "RelatorioErros.aspx"
      moderno: "UC06-dashboard-logs (Angular /auditoria/dashboard)"

    - legado: "AuditoriaOperacoes.aspx"
      moderno: "UC07-auditoria-operacoes (Angular /auditoria/operacoes)"

    - legado: "WSAuditoria.asmx.vb - InserirLog"
      moderno: "Serilog middleware (automático)"

    - legado: "WSAuditoria.asmx.vb - BuscarLogs"
      moderno: "GET /api/logs (RESTful)"

    - legado: "WSAuditoria.asmx.vb - ExportarRelatorio"
      moderno: "POST /api/logs/export (async job)"

    - legado: "pa_LogInserir"
      moderno: "Application Insights sink"

    - legado: "pa_LogBuscar"
      moderno: "Application Insights queries (KQL)"

    - legado: "Tabela LogRegistro"
      moderno: "Application Insights traces table"

    - legado: "Tabela LogAuditoria"
      moderno: "AuditLog table (EF Core)"

    - legado: "Tabela LogErro"
      moderno: "Application Insights exceptions table"

    - legado: "Logger.vb (classe)"
      moderno: "DESCARTADO (middleware automático)"

    - legado: "Arquivos .txt (App_Data/Logs)"
      moderno: "DESCARTADO (Application Insights)"

    - legado: "EventViewer"
      moderno: "DESCARTADO (Application Insights)"

decisoes_modernizacao:
  - id: "DEC-RF098-001"
    titulo: "Usar Application Insights como Plataforma de Logging"
    motivo: |
      Centralização, structured logging, queries KQL avançadas,
      integração com Azure Monitor, alertas nativos.
    impacto: "ALTO - nova dependência externa (Azure)"
    beneficio: "Logging enterprise-grade sem reimplementar infraestrutura complexa"

  - id: "DEC-RF098-002"
    titulo: "Usar Serilog como Abstração de Logging"
    motivo: |
      Biblioteca madura, suporte a múltiplos sinks,
      structured logging, enrichers, filtering avançado.
    impacto: "MÉDIO - nova dependência NuGet"
    beneficio: "Flexibilidade para trocar backend de logging sem alterar código"

  - id: "DEC-RF098-003"
    titulo: "Implementar Sanitização Automática de Dados Sensíveis"
    motivo: "Conformidade LGPD/ISO 27001, evitar vazamento de dados"
    impacto: "MÉDIO - implementar regex patterns e middleware"
    beneficio: "Proteção automática contra logs de dados sensíveis"

  - id: "DEC-RF098-004"
    titulo: "CorrelationId Automático via Middleware"
    motivo: "Rastreamento end-to-end, debug facilitado, correlação de eventos"
    impacto: "BAIXO - middleware simples"
    beneficio: "Debug 300% mais rápido, visibilidade completa do fluxo"

  - id: "DEC-RF098-005"
    titulo: "Alertas Configuráveis via Azure Monitor"
    motivo: "Detecção proativa de problemas, redução de downtime"
    impacto: "MÉDIO - configuração de action groups e alert rules"
    beneficio: "Latência de detecção de horas → minutos"

  - id: "DEC-RF098-006"
    titulo: "Política de Retenção de 90 Dias + Arquivamento"
    motivo: "Conformidade LGPD, performance, custo"
    impacto: "BAIXO - configuração no Application Insights"
    beneficio: "Performance melhorada, conformidade LGPD, custo reduzido"

riscos_migracao:
  - risco: "Perda de Logs Históricos"
    impacto: "ALTO"
    mitigacao: |
      Exportar logs críticos dos últimos 2 anos para Blob Storage antes de desligar sistema legado.
      Criar script de importação caso seja necessário consultar logs antigos.

  - risco: "Curva de Aprendizado de KQL"
    impacto: "MÉDIO"
    mitigacao: |
      Criar guia rápido de KQL com queries comuns.
      Treinar equipe de suporte.
      Criar views salvas para consultas frequentes.

  - risco: "Custo de Application Insights"
    impacto: "MÉDIO"
    mitigacao: |
      Configurar sampling (1-10% em prod).
      Configurar daily cap (limite de GB/dia).
      Monitorar custo mensal.

  - risco: "Falha de Logging Não Deve Quebrar Aplicação"
    impacto: "ALTO"
    mitigacao: |
      Serilog configurado com fire-and-forget (async).
      Fallback para console se Application Insights falhar.
      Testes de resiliência (simular falha de logging).

  - risco: "Mudança de Comportamento de Alertas"
    impacto: "BAIXO"
    mitigacao: |
      Configurar alertas similares aos do legado inicialmente.
      Ajustar thresholds gradualmente baseado em dados reais.

changelog:
  - versao: "1.0"
    data: "2025-12-31"
    descricao: "Documentação inicial de referência ao legado para RF098"
    autor: "Agência ALC - alc.dev.br"
    detalhes:
      - "17 itens legado rastreados com 100% destinos definidos"
      - "6 problemas críticos/altos identificados"
      - "7 regras de negócio implícitas extraídas"
      - "14 substituições, 1 assumido, 2 descartados"
