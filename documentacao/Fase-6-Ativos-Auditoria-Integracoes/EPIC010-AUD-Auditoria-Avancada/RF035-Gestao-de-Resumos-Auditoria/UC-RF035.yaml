# =============================================
# UC-RF035 - Casos de Uso (Gestão de Resumos de Auditoria)
# Versão: 2.0
# Autor: Agência ALC - alc.dev.br
# Data: 2025-12-31
# =============================================

uc:
  documentacao: "RF035"
  versao: "2.0"
  data: "2025-12-31"
  epic: "EPIC010-AUD-Auditoria-Avancada"
  fase: "Fase-6-Ativos-Auditoria-Integracoes"

casos_de_uso:

  # ==========================================
  # UC00 - Listar Resumos de Auditoria
  # ==========================================
  - id: "UC00"
    nome: "Listar Resumos de Auditoria"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false
    complexidade: "media"

    covers:
      documentacao_items:
        - "RF035-CRUD-02"  # Listar resumos
        - "RF035-SEC-01"   # Multi-tenancy
      uc_items:
        - id: "FP-UC00-001"
          title: "Usuário acessa a funcionalidade Resumos de Auditoria"
          required: true
        - id: "FP-UC00-002"
          title: "Sistema valida permissão AUD.RESUMOS.VIEW_ANY"
          required: true
        - id: "FP-UC00-003"
          title: "Sistema carrega resumos do tenant (filtro automático por EmpresaId)"
          required: true
        - id: "FP-UC00-004"
          title: "Sistema aplica filtros padrão: Período (últimos 30 dias), Tipo (Diário)"
          required: true
        - id: "FP-UC00-005"
          title: "Sistema aplica paginação (padrão: 20 registros) e ordenação (Data DESC)"
          required: true
        - id: "FP-UC00-006"
          title: "Sistema exibe grid com colunas: Período, Tipo, Total Operações, Usuários Ativos, CREATEs, UPDATEs, DELETEs, Operações Críticas, Ações"
          required: true
        - id: "FP-UC00-007"
          title: "Usuário pode clicar em resumo → redireciona para UC02 (Visualizar detalhes)"
          required: false
        - id: "FA-UC00-001"
          title: "Filtrar por período customizado (data início/fim)"
          required: false
        - id: "FA-UC00-002"
          title: "Filtrar por tipo de período (Diário, Semanal, Mensal, Anual)"
          required: false
        - id: "FA-UC00-003"
          title: "Ordenar por coluna (Total Operações, Usuários Ativos, etc.)"
          required: false
        - id: "FA-UC00-004"
          title: "Exportar lista para Excel (botão Exportar Lista)"
          required: false
        - id: "FE-UC00-001"
          title: "Usuário sem permissão → HTTP 403 + mensagem resumos_auditoria.erro_permissao"
          required: true
        - id: "FE-UC00-002"
          title: "Nenhum resumo encontrado → estado vazio exibido com mensagem resumos_auditoria.nenhum_registro"
          required: true
        - id: "FE-UC00-003"
          title: "Erro ao carregar dados → mensagem resumos_auditoria.erro_carregar"
          required: true

    precondicoes:
      - permissao: "AUD.RESUMOS.VIEW_ANY"
      - tenant_selecionado: true

    gatilho: "Usuario acessa funcionalidade Resumos de Auditoria pelo menu"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessa_menu_resumos_auditoria"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao_view_any"
      - passo: 3
        ator: "sistema"
        acao: "carregar_resumos_tenant"
      - passo: 4
        ator: "sistema"
        acao: "aplicar_filtros_padrao"
      - passo: 5
        ator: "sistema"
        acao: "aplicar_paginacao_ordenacao"
      - passo: 6
        ator: "sistema"
        acao: "exibir_grid_metricas"

    fluxos_alternativos:
      - id: "FA-UC00-01"
        condicao: "usuario_aplica_filtro_periodo"
        resultado: "lista_filtrada_por_periodo"
      - id: "FA-UC00-02"
        condicao: "usuario_ordena_coluna"
        resultado: "lista_ordenada"

    fluxos_excecao:
      - id: "FE-UC00-01"
        condicao: "sem_permissao_view_any"
        resultado: "http_403_erro_permissao"
      - id: "FE-UC00-02"
        condicao: "nenhum_resumo_encontrado"
        resultado: "estado_vazio_exibido"

    regras_aplicadas:
      - "RN-RF035-001"  # Resumos gerados automaticamente por job
      - "RN-RF035-002"  # Métricas agregadas de AuditLog
      - "RN-UC-00-001"  # Somente resumos do tenant
      - "RN-UC-00-002"  # Soft delete não aparece
      - "RN-UC-00-003"  # Paginação 20 registros

    resultado_final:
      estado: "grid_exibido_com_metricas"

  # ==========================================
  # UC01 - Criar Resumo de Auditoria (Job)
  # ==========================================
  - id: "UC01"
    nome: "Criar Resumo de Auditoria (Job Automático)"
    ator_principal: "sistema_hangfire_job"
    tipo: "batch"
    impacta_dados: true
    complexidade: "alta"

    covers:
      documentacao_items:
        - "RF035-CRUD-01"  # Criar resumo
        - "RF035-JOB-01"   # Job Hangfire automático
        - "RF035-CALC-01"  # Cálculo de métricas
      uc_items:
        - id: "FP-UC01-001"
          title: "Job Hangfire executa diariamente às 02:00"
          required: true
        - id: "FP-UC01-002"
          title: "Sistema verifica se já existe resumo para D-1 (evitar duplicação)"
          required: true
        - id: "FP-UC01-003"
          title: "Sistema agrega métricas do dia anterior via SQL"
          required: true
        - id: "FP-UC01-004"
          title: "Se for segunda-feira, sistema cria também resumo semanal (S-1)"
          required: false
        - id: "FP-UC01-005"
          title: "Se for dia 1 do mês, sistema cria também resumo mensal (M-1)"
          required: false
        - id: "FP-UC01-006"
          title: "Sistema registra auditoria: tabela AuditSummary, ação CREATE, usuário SYSTEM_JOB"
          required: true
        - id: "FP-UC01-007"
          title: "Job finaliza com sucesso → log Resumos criados: X diários, Y semanais, Z mensais"
          required: true
        - id: "FA-UC01-001"
          title: "Resumo manual (endpoint POST /api/auditoria/resumos) — requer permissão AUD.RESUMOS.CREATE"
          required: false
        - id: "FA-UC01-002"
          title: "Recalcular resumo existente (flag force_recalculate=true)"
          required: false
        - id: "FE-UC01-001"
          title: "Resumo já existe para D-1 → skip criação + log warning"
          required: true
        - id: "FE-UC01-002"
          title: "Erro no SQL → retry automático (3x com backoff exponencial)"
          required: true
        - id: "FE-UC01-003"
          title: "Falha após 3 retries → notifica admin via email + registra erro no Hangfire Dashboard"
          required: true

    precondicoes:
      - job_configurado: "cron_0_2_***"
      - tabela_auditlog_existe: true
      - tabela_auditsummary_existe: true

    gatilho: "Job Hangfire agendado (cron 0 2 * * *)"

    fluxo_principal:
      - passo: 1
        ator: "sistema"
        acao: "job_executar_diariamente_02h"
      - passo: 2
        ator: "sistema"
        acao: "verificar_resumo_d1_existente"
      - passo: 3
        ator: "sistema"
        acao: "agregar_metricas_sql"
      - passo: 4
        ator: "sistema"
        acao: "inserir_resumo_tabela"
      - passo: 5
        ator: "sistema"
        acao: "registrar_auditoria_create"
      - passo: 6
        ator: "sistema"
        acao: "log_sucesso"

    fluxos_alternativos:
      - id: "FA-UC01-01"
        condicao: "segunda_feira"
        resultado: "criar_resumo_semanal_s1"
      - id: "FA-UC01-02"
        condicao: "dia_1_mes"
        resultado: "criar_resumo_mensal_m1"

    fluxos_excecao:
      - id: "FE-UC01-01"
        condicao: "resumo_d1_ja_existe"
        resultado: "skip_log_warning"
      - id: "FE-UC01-02"
        condicao: "erro_sql"
        resultado: "retry_3x_backoff"
      - id: "FE-UC01-03"
        condicao: "falha_apos_3_retries"
        resultado: "notificar_admin_email"

    regras_aplicadas:
      - "RN-RF035-003"  # Diário/Semanal/Mensal
      - "RN-RF035-004"  # Retry 3x
      - "RN-RF035-005"  # Notifica admin falha
      - "RN-UC-01-001"  # created_by = SYSTEM_JOB
      - "RN-UC-01-002"  # EmpresaId agregado
      - "RN-UC-01-003"  # Operações críticas DELETEs + tabelas sensíveis

    resultado_final:
      estado: "resumos_criados_sucesso"

  # ==========================================
  # UC02 - Visualizar Resumo de Auditoria
  # ==========================================
  - id: "UC02"
    nome: "Visualizar Resumo de Auditoria"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false
    complexidade: "media"

    covers:
      documentacao_items:
        - "RF035-CRUD-03"  # Visualizar resumo
        - "RF035-GRAPH-01" # Renderizar gráficos
        - "RF035-DRILL-01" # Drill-down para RF034
      uc_items:
        - id: "FP-UC02-001"
          title: "Usuário clica em resumo na listagem (UC00) ou acessa URL /auditoria/resumos/:id"
          required: true
        - id: "FP-UC02-002"
          title: "Sistema valida permissão AUD.RESUMOS.VIEW"
          required: true
        - id: "FP-UC02-003"
          title: "Sistema valida que resumo pertence ao tenant (EmpresaId)"
          required: true
        - id: "FP-UC02-004"
          title: "Sistema carrega resumo do banco (SELECT * FROM AuditSummary WHERE Id = :id AND deleted_at IS NULL)"
          required: true
        - id: "FP-UC02-005"
          title: "Sistema exibe Cabeçalho: Período, Tipo (Diário/Semanal/Mensal), Total de Operações"
          required: true
        - id: "FP-UC02-006"
          title: "Sistema exibe Métricas Gerais: CREATEs, UPDATEs, DELETEs, Acessos, Usuários Ativos, Tabelas Afetadas"
          required: true
        - id: "FP-UC02-007"
          title: "Sistema renderiza Gráficos (ApexCharts): Pizza (CREATE/UPDATE/DELETE), Barras (Top 10 usuários), Barras (Top 10 tabelas)"
          required: true
        - id: "FP-UC02-008"
          title: "Sistema exibe Operações Críticas: Lista de DELETEs e operações fora do horário (22h-6h)"
          required: true
        - id: "FP-UC02-009"
          title: "Sistema exibe link Ver Logs Completos → redireciona para RF034 com filtros aplicados (período + tenant)"
          required: true
        - id: "FA-UC02-001"
          title: "Exportar resumo para PDF (botão Exportar PDF) → UC03"
          required: false
        - id: "FA-UC02-002"
          title: "Comparar com outro período (botão Comparar) → UC04"
          required: false
        - id: "FA-UC02-003"
          title: "Drill-down em gráfico (clique em barra/fatia) → filtra logs por entidade/usuário"
          required: false
        - id: "FE-UC02-001"
          title: "Resumo inexistente → HTTP 404 + mensagem resumos_auditoria.resumo_nao_encontrado"
          required: true
        - id: "FE-UC02-002"
          title: "Resumo de outro tenant → HTTP 404 (não expor existência)"
          required: true
        - id: "FE-UC02-003"
          title: "Erro ao carregar gráficos → exibe placeholder Gráficos indisponíveis"
          required: true

    precondicoes:
      - permissao: "AUD.RESUMOS.VIEW"
      - resumo_existe: true
      - resumo_pertence_tenant: true

    gatilho: "Usuario clica em resumo ou acessa URL direta"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "clicar_resumo_ou_acessar_url"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao_view"
      - passo: 3
        ator: "sistema"
        acao: "validar_tenant_ownership"
      - passo: 4
        ator: "sistema"
        acao: "carregar_resumo_banco"
      - passo: 5
        ator: "sistema"
        acao: "exibir_cabecalho_metricas"
      - passo: 6
        ator: "sistema"
        acao: "renderizar_graficos_apexcharts"
      - passo: 7
        ator: "sistema"
        acao: "exibir_operacoes_criticas"
      - passo: 8
        ator: "sistema"
        acao: "exibir_link_drilldown_rf034"

    fluxos_alternativos:
      - id: "FA-UC02-01"
        condicao: "usuario_clica_exportar_pdf"
        resultado: "redirecionar_uc03"
      - id: "FA-UC02-02"
        condicao: "usuario_clica_comparar"
        resultado: "redirecionar_uc04"

    fluxos_excecao:
      - id: "FE-UC02-01"
        condicao: "resumo_nao_existe"
        resultado: "http_404_resumo_nao_encontrado"
      - id: "FE-UC02-02"
        condicao: "resumo_outro_tenant"
        resultado: "http_404_sem_expor_existencia"

    regras_aplicadas:
      - "RN-RF035-006"  # Drill-down com filtros automáticos
      - "RN-RF035-007"  # Gráficos ApexCharts
      - "RN-UC-02-001"  # Isolamento por tenant
      - "RN-UC-02-002"  # Auditoria visível

    resultado_final:
      estado: "resumo_exibido_com_graficos"

  # ==========================================
  # UC03 - Exportar Resumo
  # ==========================================
  - id: "UC03"
    nome: "Exportar Resumo"
    ator_principal: "usuario_autenticado"
    tipo: "acao"
    impacta_dados: false
    complexidade: "media"

    covers:
      documentacao_items:
        - "RF035-EXPORT-01" # Exportar PDF
        - "RF035-EXPORT-02" # Exportar Excel
        - "RF035-STORAGE-01" # Azure Blob Storage
      uc_items:
        - id: "FP-UC03-001"
          title: "Usuário acessa UC02 (Visualizar Resumo)"
          required: true
        - id: "FP-UC03-002"
          title: "Usuário clica em Exportar e seleciona formato: PDF ou Excel"
          required: true
        - id: "FP-UC03-003"
          title: "Sistema valida permissão AUD.RESUMOS.EXPORT"
          required: true
        - id: "FP-UC03-004"
          title: "Sistema gera arquivo com: Sumário Executivo, Gráficos Visuais (PNG), Tabelas (Top 10), Detalhamento Operações Críticas"
          required: true
        - id: "FP-UC03-005"
          title: "Sistema salva arquivo em Azure Blob Storage com nome resumo_auditoria_{periodo}_{empresaId}_{timestamp}.pdf"
          required: true
        - id: "FP-UC03-006"
          title: "Sistema registra auditoria: tabela AuditSummary, ação EXPORT, detalhes {tipo_arquivo: PDF, periodo: ...}"
          required: true
        - id: "FP-UC03-007"
          title: "Sistema retorna URL de download ou inicia download automático"
          required: true
        - id: "FA-UC03-001"
          title: "Exportar múltiplos resumos (seleção em lote no UC00) → gera ZIP com múltiplos arquivos"
          required: false
        - id: "FA-UC03-002"
          title: "Agendar exportação recorrente (configurar notificação mensal)"
          required: false
        - id: "FE-UC03-001"
          title: "Erro ao gerar PDF → HTTP 500 + mensagem resumos_auditoria.erro_exportar_pdf"
          required: true
        - id: "FE-UC03-002"
          title: "Erro ao enviar para Azure Blob → fallback para download direto"
          required: true
        - id: "FE-UC03-003"
          title: "Timeout na geração de gráficos → gera arquivo sem gráficos + aviso"
          required: true

    precondicoes:
      - permissao: "AUD.RESUMOS.EXPORT"
      - resumo_existe: true
      - resumo_pertence_tenant: true

    gatilho: "Usuario clica em botão Exportar"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "clicar_exportar_selecionar_formato"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao_export"
      - passo: 3
        ator: "sistema"
        acao: "gerar_arquivo_pdf_ou_excel"
      - passo: 4
        ator: "sistema"
        acao: "salvar_azure_blob_storage"
      - passo: 5
        ator: "sistema"
        acao: "registrar_auditoria_export"
      - passo: 6
        ator: "sistema"
        acao: "retornar_url_download"

    fluxos_alternativos:
      - id: "FA-UC03-01"
        condicao: "exportacao_multiplos_resumos"
        resultado: "gerar_zip_multiplos_arquivos"

    fluxos_excecao:
      - id: "FE-UC03-01"
        condicao: "erro_gerar_pdf"
        resultado: "http_500_erro_exportar_pdf"
      - id: "FE-UC03-02"
        condicao: "erro_azure_blob"
        resultado: "fallback_download_direto"

    regras_aplicadas:
      - "RN-RF035-008"  # PDF com logo + assinatura
      - "RN-RF035-009"  # Excel múltiplas abas
      - "RN-RF035-010"  # Retenção 30 dias
      - "RN-UC-03-001"  # iText 8+
      - "RN-UC-03-002"  # EPPlus 6+

    resultado_final:
      estado: "arquivo_exportado_disponivel"

  # ==========================================
  # UC04 - Comparar Períodos
  # ==========================================
  - id: "UC04"
    nome: "Comparar Períodos"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false
    complexidade: "alta"

    covers:
      documentacao_items:
        - "RF035-COMPARE-01" # Comparação temporal
        - "RF035-CALC-02"    # Cálculo de delta
        - "RF035-ALERT-01"   # Notificação anomalia
      uc_items:
        - id: "FP-UC04-001"
          title: "Usuário acessa funcionalidade Comparar Períodos"
          required: true
        - id: "FP-UC04-002"
          title: "Sistema valida permissão AUD.RESUMOS.COMPARE"
          required: true
        - id: "FP-UC04-003"
          title: "Usuário seleciona Período 1: Janeiro/2025 (dropdown de resumos mensais)"
          required: true
        - id: "FP-UC04-004"
          title: "Usuário seleciona Período 2: Fevereiro/2025 (dropdown de resumos mensais)"
          required: true
        - id: "FP-UC04-005"
          title: "Sistema valida que ambos resumos são do mesmo tipo (ambos Mensais)"
          required: true
        - id: "FP-UC04-006"
          title: "Sistema carrega dados de ambos resumos"
          required: true
        - id: "FP-UC04-007"
          title: "Sistema calcula Δ para cada métrica: ((Periodo2 - Periodo1) / Periodo1) * 100"
          required: true
        - id: "FP-UC04-008"
          title: "Sistema exibe comparação lado a lado com tabela de métricas e Δ percentual"
          required: true
        - id: "FP-UC04-009"
          title: "Sistema destaca em vermelho anomalias: Δ > +50% OU Δ < -50%"
          required: true
        - id: "FP-UC04-010"
          title: "Sistema exibe gráfico de linhas sobreposto: Operações por dia dos dois períodos"
          required: true
        - id: "FA-UC04-001"
          title: "Comparar múltiplos períodos (3 ou mais) → gráfico de linhas multi-série"
          required: false
        - id: "FA-UC04-002"
          title: "Exportar comparação para Excel → aba adicional no UC03"
          required: false
        - id: "FE-UC04-001"
          title: "Períodos de tipos diferentes (ex: Diário vs Mensal) → erro resumos_auditoria.erro_tipos_incompativeis"
          required: true
        - id: "FE-UC04-002"
          title: "Divisão por zero no cálculo Δ → exibe N/A na célula"
          required: true

    precondicoes:
      - permissao: "AUD.RESUMOS.COMPARE"
      - minimo_2_resumos_mesmo_tipo: true

    gatilho: "Usuario acessa funcionalidade Comparar Períodos"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessar_comparar_periodos"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao_compare"
      - passo: 3
        ator: "usuario"
        acao: "selecionar_periodo1_periodo2"
      - passo: 4
        ator: "sistema"
        acao: "validar_tipos_compativeis"
      - passo: 5
        ator: "sistema"
        acao: "carregar_dados_ambos_resumos"
      - passo: 6
        ator: "sistema"
        acao: "calcular_delta_percentual"
      - passo: 7
        ator: "sistema"
        acao: "exibir_comparacao_tabela"
      - passo: 8
        ator: "sistema"
        acao: "destacar_anomalias_vermelho"
      - passo: 9
        ator: "sistema"
        acao: "exibir_grafico_linhas_sobreposto"

    fluxos_alternativos:
      - id: "FA-UC04-01"
        condicao: "comparar_3_ou_mais_periodos"
        resultado: "grafico_linhas_multiserie"

    fluxos_excecao:
      - id: "FE-UC04-01"
        condicao: "tipos_incompativeis"
        resultado: "erro_tipos_incompativeis"
      - id: "FE-UC04-02"
        condicao: "divisao_por_zero"
        resultado: "exibir_na"

    regras_aplicadas:
      - "RN-RF035-011"  # Variação > 100% notifica admin
      - "RN-RF035-012"  # Mesmo tipo obrigatório
      - "RN-UC-04-001"  # Fórmula delta
      - "RN-UC-04-002"  # Destaque visual

    resultado_final:
      estado: "comparacao_exibida_com_delta"

  # ==========================================
  # UC05 - Dashboard Executivo
  # ==========================================
  - id: "UC05"
    nome: "Dashboard Executivo"
    ator_principal: "diretor_administrador"
    tipo: "leitura"
    impacta_dados: false
    complexidade: "alta"

    covers:
      documentacao_items:
        - "RF035-DASH-01"  # Dashboard executivo
        - "RF035-KPI-01"   # KPIs
        - "RF035-CACHE-01" # Cache Redis
      uc_items:
        - id: "FP-UC05-001"
          title: "Usuário com perfil Diretor/VP acessa rota /auditoria/dashboard-executivo"
          required: true
        - id: "FP-UC05-002"
          title: "Sistema valida permissão AUD.RESUMOS.DASHBOARD_EXECUTIVO"
          required: true
        - id: "FP-UC05-003"
          title: "Sistema verifica cache (válido até 03:00 do dia seguinte)"
          required: true
        - id: "FP-UC05-004"
          title: "Se cache válido, carrega dados do cache Redis"
          required: true
        - id: "FP-UC05-005"
          title: "Se cache expirado, recalcula dashboard: KPIs, Gráficos, Top 5 Usuários, Top 5 Módulos, Alertas"
          required: true
        - id: "FP-UC05-006"
          title: "Sistema exibe dashboard renderizado"
          required: true
        - id: "FP-UC05-007"
          title: "Usuário pode clicar Exportar PDF Executivo → UC03 (versão simplificada para C-level)"
          required: false
        - id: "FA-UC05-001"
          title: "Selecionar período customizado (últimos 3/6/12 meses)"
          required: false
        - id: "FA-UC05-002"
          title: "Drill-down em KPI → redireciona para UC00 com filtro aplicado"
          required: false
        - id: "FE-UC05-001"
          title: "Usuário sem permissão → HTTP 403 + mensagem resumos_auditoria.dashboard_acesso_negado"
          required: true
        - id: "FE-UC05-002"
          title: "Nenhum resumo mensal → exibe placeholder Dados insuficientes"
          required: true

    precondicoes:
      - permissao: "AUD.RESUMOS.DASHBOARD_EXECUTIVO"
      - perfil: "Diretor|VP|Admin"
      - minimo_1_resumo_mensal: true

    gatilho: "Usuario acessa dashboard executivo"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessar_dashboard_executivo"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao_dashboard"
      - passo: 3
        ator: "sistema"
        acao: "verificar_cache_redis"
      - passo: 4
        ator: "sistema"
        acao: "carregar_cache_ou_recalcular"
      - passo: 5
        ator: "sistema"
        acao: "exibir_dashboard_kpis_graficos"

    fluxos_alternativos:
      - id: "FA-UC05-01"
        condicao: "selecionar_periodo_customizado"
        resultado: "dashboard_periodo_selecionado"

    fluxos_excecao:
      - id: "FE-UC05-01"
        condicao: "sem_permissao_dashboard"
        resultado: "http_403_acesso_negado"
      - id: "FE-UC05-02"
        condicao: "sem_resumos_mensais"
        resultado: "placeholder_dados_insuficientes"

    regras_aplicadas:
      - "RN-RF035-013"  # Cache 24h renovado 03:00
      - "RN-RF035-014"  # Perfil Diretor/Admin
      - "RN-RF035-015"  # PDF executivo simplificado
      - "RN-UC-05-001"  # Cache Redis TTL 24h
      - "RN-UC-05-002"  # Taxa crescimento fórmula

    resultado_final:
      estado: "dashboard_exibido_com_kpis"

  # ==========================================
  # UC06 - Alertas de Anomalias
  # ==========================================
  - id: "UC06"
    nome: "Alertas de Anomalias"
    ator_principal: "sistema_hangfire_job"
    tipo: "batch"
    impacta_dados: true
    complexidade: "alta"

    covers:
      documentacao_items:
        - "RF035-ANOMALY-01" # Detecção de anomalias
        - "RF035-ML-01"      # Machine Learning
        - "RF035-NOTIF-01"   # Notificação admin
      uc_items:
        - id: "FP-UC06-001"
          title: "Job Hangfire executa semanalmente (domingo 03:00)"
          required: true
        - id: "FP-UC06-002"
          title: "Sistema carrega resumos dos últimos 30 dias"
          required: true
        - id: "FP-UC06-003"
          title: "Sistema calcula baseline (média móvel de 90 dias para cada métrica)"
          required: true
        - id: "FP-UC06-004"
          title: "Sistema detecta anomalias via algoritmo: Pico DELETEs, Usuários hiperativos, Acessos fora horário, Tabelas críticas"
          required: true
        - id: "FP-UC06-005"
          title: "Para cada anomalia detectada: Cria registro AuditAnomaly, Envia email admin, Cria push notification"
          required: true
        - id: "FP-UC06-006"
          title: "Sistema registra auditoria: ação ANOMALIA_DETECTADA, detalhes {tipo, valor, threshold}"
          required: true
        - id: "FA-UC06-001"
          title: "Marcar anomalia como Falso Positivo → atualiza AuditAnomaly.Fl_Falso_Positivo = true"
          required: false
        - id: "FA-UC06-002"
          title: "Ajustar threshold de detecção (configurável por tipo de anomalia)"
          required: false
        - id: "FE-UC06-001"
          title: "Histórico insuficiente (< 90 dias) → skip detecção + log warning"
          required: true
        - id: "FE-UC06-002"
          title: "Erro ao enviar email → registra falha + retry no próximo ciclo"
          required: true

    precondicoes:
      - job_configurado: "cron_0_3_**0"
      - minimo_90_dias_historico: true

    gatilho: "Job Hangfire agendado (cron 0 3 * * 0 - domingo 03:00)"

    fluxo_principal:
      - passo: 1
        ator: "sistema"
        acao: "job_executar_semanalmente_domingo"
      - passo: 2
        ator: "sistema"
        acao: "carregar_resumos_30_dias"
      - passo: 3
        ator: "sistema"
        acao: "calcular_baseline_90_dias"
      - passo: 4
        ator: "sistema"
        acao: "detectar_anomalias_algoritmo"
      - passo: 5
        ator: "sistema"
        acao: "criar_registro_auditanomaly"
      - passo: 6
        ator: "sistema"
        acao: "enviar_email_admin"
      - passo: 7
        ator: "sistema"
        acao: "criar_push_notification"
      - passo: 8
        ator: "sistema"
        acao: "registrar_auditoria_anomalia"

    fluxos_alternativos:
      - id: "FA-UC06-01"
        condicao: "usuario_marca_falso_positivo"
        resultado: "atualizar_flag_falso_positivo"

    fluxos_excecao:
      - id: "FE-UC06-01"
        condicao: "historico_insuficiente"
        resultado: "skip_log_warning"
      - id: "FE-UC06-02"
        condicao: "erro_envio_email"
        resultado: "registrar_falha_retry_proximo"

    regras_aplicadas:
      - "RN-RF035-016"  # Baseline 90 dias
      - "RN-RF035-017"  # Threshold 3x desvio padrão
      - "RN-RF035-018"  # Falsos positivos ignorados
      - "RN-UC-06-001"  # Z-score > 3
      - "RN-UC-06-002"  # Email appsettings.json

    resultado_final:
      estado: "anomalias_detectadas_notificadas"

  # ==========================================
  # UC07 - Relatório de Tendências
  # ==========================================
  - id: "UC07"
    nome: "Relatório de Tendências"
    ator_principal: "usuario_autenticado"
    tipo: "leitura"
    impacta_dados: false
    complexidade: "media"

    covers:
      documentacao_items:
        - "RF035-TREND-01"  # Análise de tendências
        - "RF035-REGR-01"   # Regressão linear
        - "RF035-PRED-01"   # Previsão 3 meses
      uc_items:
        - id: "FP-UC07-001"
          title: "Usuário acessa rota /auditoria/tendencias"
          required: true
        - id: "FP-UC07-002"
          title: "Sistema valida permissão AUD.RESUMOS.TENDENCIAS"
          required: true
        - id: "FP-UC07-003"
          title: "Usuário seleciona período de análise (últimos 3/6/12 meses)"
          required: true
        - id: "FP-UC07-004"
          title: "Sistema carrega resumos do período selecionado"
          required: true
        - id: "FP-UC07-005"
          title: "Sistema gera relatório com: Crescimento Usuários, Módulos Populares, Horários Pico, Dias Semana, Sazonalidade"
          required: true
        - id: "FP-UC07-006"
          title: "Sistema calcula Previsão para próximos 3 meses (regressão linear simples)"
          required: true
        - id: "FP-UC07-007"
          title: "Sistema exibe relatório renderizado"
          required: true
        - id: "FA-UC07-001"
          title: "Exportar relatório para PDF → UC03"
          required: false
        - id: "FA-UC07-002"
          title: "Selecionar módulo específico para análise detalhada"
          required: false
        - id: "FE-UC07-001"
          title: "Histórico insuficiente (< 3 meses) → erro resumos_auditoria.historico_insuficiente"
          required: true
        - id: "FE-UC07-002"
          title: "Erro no cálculo de regressão → exibe tendência sem previsão"
          required: true

    precondicoes:
      - permissao: "AUD.RESUMOS.TENDENCIAS"
      - minimo_3_meses_historico: true

    gatilho: "Usuario acessa análise de tendências"

    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessar_tendencias"
      - passo: 2
        ator: "sistema"
        acao: "validar_permissao_tendencias"
      - passo: 3
        ator: "usuario"
        acao: "selecionar_periodo_analise"
      - passo: 4
        ator: "sistema"
        acao: "carregar_resumos_periodo"
      - passo: 5
        ator: "sistema"
        acao: "gerar_relatorio_completo"
      - passo: 6
        ator: "sistema"
        acao: "calcular_previsao_3_meses"
      - passo: 7
        ator: "sistema"
        acao: "exibir_relatorio"

    fluxos_alternativos:
      - id: "FA-UC07-01"
        condicao: "exportar_pdf"
        resultado: "redirecionar_uc03"

    fluxos_excecao:
      - id: "FE-UC07-01"
        condicao: "historico_insuficiente"
        resultado: "erro_minimo_3_meses"
      - id: "FE-UC07-02"
        condicao: "erro_regressao"
        resultado: "exibir_sem_previsao"

    regras_aplicadas:
      - "RN-RF035-019"  # Resumos consolidados
      - "RN-RF035-020"  # Regressão linear y=ax+b
      - "RN-RF035-021"  # Previsão 3 meses (6 meses histórico)
      - "RN-UC-07-001"  # Heatmap operações fora horário
      - "RN-UC-07-002"  # Sazonalidade variância mensal

    resultado_final:
      estado: "relatorio_tendencias_exibido"

  # ==========================================
  # UC08 - Arquivar Resumos Antigos
  # ==========================================
  - id: "UC08"
    nome: "Arquivar Resumos Antigos"
    ator_principal: "sistema_hangfire_job"
    tipo: "batch"
    impacta_dados: true
    complexidade: "baixa"

    covers:
      documentacao_items:
        - "RF035-ARCHIVE-01" # Arquivamento automático
        - "RF035-LGPD-01"    # Anonimização LGPD
        - "RF035-RETENTION-01" # Retenção 10 anos
      uc_items:
        - id: "FP-UC08-001"
          title: "Job Hangfire executa mensalmente (dia 1 às 04:00)"
          required: true
        - id: "FP-UC08-002"
          title: "Sistema busca resumos com > 2 anos via SQL WHERE DATEDIFF(YEAR, Periodo, GETDATE()) > 2"
          required: true
        - id: "FP-UC08-003"
          title: "Sistema insere resumos em AuditSummary_Archive via INSERT INTO SELECT"
          required: true
        - id: "FP-UC08-004"
          title: "Sistema marca resumos como arquivados: UPDATE SET Fl_Arquivado = 1, archived_at = GETDATE()"
          required: true
        - id: "FP-UC08-005"
          title: "Sistema registra auditoria: ação ARCHIVE, detalhes {quantidade_arquivada: X}"
          required: true
        - id: "FP-UC08-006"
          title: "Job finaliza com log: Arquivados X resumos com > 2 anos"
          required: true
        - id: "FA-UC08-001"
          title: "Restaurar resumo arquivado (acesso via interface Ver Arquivados)"
          required: false
        - id: "FA-UC08-002"
          title: "Anonimizar resumos > 10 anos (compliance LGPD)"
          required: false
        - id: "FE-UC08-001"
          title: "Nenhum resumo para arquivar → skip + log info"
          required: true
        - id: "FE-UC08-002"
          title: "Erro ao mover para arquivo → retry automático (3x)"
          required: true

    precondicoes:
      - job_configurado: "cron_0_4_1_**"
      - tabela_auditsummary_archive_existe: true

    gatilho: "Job Hangfire agendado (cron 0 4 1 * * - dia 1 04:00)"

    fluxo_principal:
      - passo: 1
        ator: "sistema"
        acao: "job_executar_mensalmente_dia1"
      - passo: 2
        ator: "sistema"
        acao: "buscar_resumos_2_anos"
      - passo: 3
        ator: "sistema"
        acao: "inserir_archive_table"
      - passo: 4
        ator: "sistema"
        acao: "marcar_flag_arquivado"
      - passo: 5
        ator: "sistema"
        acao: "registrar_auditoria_archive"
      - passo: 6
        ator: "sistema"
        acao: "log_sucesso"

    fluxos_alternativos:
      - id: "FA-UC08-01"
        condicao: "restaurar_arquivado"
        resultado: "copiar_de_archive_para_principal"
      - id: "FA-UC08-02"
        condicao: "resumos_10_anos"
        resultado: "anonimizar_lgpd"

    fluxos_excecao:
      - id: "FE-UC08-01"
        condicao: "nenhum_resumo_arquivar"
        resultado: "skip_log_info"
      - id: "FE-UC08-02"
        condicao: "erro_mover_arquivo"
        resultado: "retry_3x"

    regras_aplicadas:
      - "RN-RF035-022"  # Interface Ver Arquivados
      - "RN-RF035-023"  # Retenção 10 anos (2 ativo + 8 arquivado)
      - "RN-RF035-024"  # Anonimização após 10 anos
      - "RN-UC-08-001"  # Soft archive (flag Fl_Arquivado)
      - "RN-UC-08-002"  # Delete físico após 10 anos + anonimização

    resultado_final:
      estado: "resumos_arquivados_sucesso"

# ==========================================
# EXCLUSÕES (Itens não cobertos - Justificativa)
# ==========================================
exclusions:
  uc_items:
    - id: "NONE"
      justificativa: "Todos os itens do RF035 foram cobertos pelos 9 UCs. A divergência entre rastreabilidade (5 UCs esperados) e implementação (9 UCs) se deve à expansão funcional do RF035 após sua especificação inicial. Os 9 UCs cobrem completamente as 12 funcionalidades e 18 endpoints do catalog RF035.yaml."

# ==========================================
# HISTÓRICO DE ALTERAÇÕES
# ==========================================
historico:
  - versao: "2.0"
    data: "2025-12-31"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Migração para governança v2.0 - Criação do UC-RF035.yaml com cobertura completa dos 9 UCs do UC-RF035.md v2.0. Adicionados metadados Epic/Fase. Mapeamento completo de RF items, UC items, precondicoes, gatilhos, fluxos (principal/alternativo/exceção), regras aplicadas e resultado final para cada UC. Aderência 100% ao template UC.yaml oficial."
  - versao: "1.0"
    data: "2025-12-18"
    autor: "Architect Agent"
    descricao: "Versão inicial inexistente - RF035 não possuía UC.yaml estruturado antes da governança v2.0"
