# RF096 - Auditoria de Mudanças de Dados

**Versão:** 2.0
**Data de Migração:** 2025-12-31
**Fase:** Fase 6 - Ativos, Auditoria e Integrações
**Epic:** EPIC010-AUD-Auditoria-Avancada
**Módulo:** Auditoria
**Status:** Em Implementação

---

## 1. VISÃO GERAL

### 1.1 Objetivo

Este RF define o sistema de auditoria de mudanças de dados do IControlIT v2.0, garantindo rastreabilidade total de todas as operações de criação, alteração e exclusão de dados em entidades críticas do sistema.

O sistema deve capturar automaticamente todas as mudanças realizadas, armazenando valores anteriores e posteriores, contexto de execução completo (usuário, IP, timestamp, user-agent) e permitindo visualização temporal, rollback controlado e exportação forense.

### 1.2 Justificativa

A auditoria de mudanças de dados é requisito obrigatório para:

- **Conformidade LGPD** (Lei 13.709/2018): Art. 5º, Art. 48 - Segurança e rastreabilidade de dados pessoais
- **Conformidade SOX 404**: Controles internos sobre relatórios financeiros
- **Governança corporativa**: Rastreabilidade de alterações em ativos, faturas, contratos
- **Resolução de disputas**: Evidência temporal de alterações contestadas
- **Detecção de fraudes**: Identificação de padrões anômalos de alteração
- **Auditoria interna/externa**: Histórico completo para auditorias regulatórias

### 1.3 Escopo

**Inclui:**

- Rastreamento automático de operações CRUD (Create, Read, Update, Delete)
- Captura de valores antes/depois em nível de campo
- Contexto completo de execução (usuário, IP, timestamp, user-agent, ClienteId)
- Detecção automática de operações em lote com CorrelationId
- Visualização de linha do tempo com filtros avançados
- Rollback controlado com validação de integridade referencial
- Relatórios parametrizados com agregações
- Dashboard com alertas de anomalias
- Integração com Azure Sentinel (SIEM)
- Exportação forense (CSV, Excel, JSON, PDF)
- Retenção de dados conforme LGPD/SOX
- Soft delete com rastreamento
- Imutabilidade de registros de auditoria

**Não Inclui:**

- Auditoria de consultas (SELECT) sem alteração de dados
- Auditoria de sessões de usuário (login/logout) - coberto por RF097
- Auditoria de permissões e acessos - coberto por RF098
- Auditoria de jobs e processamentos batch - coberto por RF099

### 1.4 Benefícios Esperados

- **Conformidade regulatória**: 100% aderência LGPD + SOX 404
- **Rastreabilidade total**: Histórico completo de todas as alterações
- **Detecção de fraudes**: Alertas automáticos de padrões suspeitos
- **Resolução rápida de disputas**: Evidência temporal indisputável
- **Governança fortalecida**: Controle total sobre mudanças críticas
- **Auditoria facilitada**: Relatórios prontos para auditorias externas

---

## 2. FUNCIONALIDADES

### 2.1 Rastreamento Automático de Mudanças

O sistema deve capturar automaticamente todas as operações de criação, alteração e exclusão em entidades marcadas para auditoria, sem necessidade de código adicional nos handlers.

**Capacidades:**

- Detecção automática de entidades auditáveis
- Captura de valores antes/depois em nível de campo
- Registro de contexto completo de execução
- Suporte a multi-tenancy (ClienteId)
- Detecção automática de operações em lote

### 2.2 Visualização de Linha do Tempo

O sistema deve permitir visualização cronológica de todas as alterações em uma entidade, com filtros avançados e navegação temporal.

**Capacidades:**

- Timeline visual com todas as mudanças
- Filtros por período, usuário, tipo de operação, campo alterado
- Comparação visual entre versões (diff)
- Navegação entre snapshots históricos
- Exportação de timeline específica

### 2.3 Rollback Controlado

O sistema deve permitir restauração de versões anteriores de entidades, com validação de integridade referencial e registro de rollback como operação auditada.

**Capacidades:**

- Seleção de snapshot histórico para restauração
- Validação de integridade referencial antes de aplicar
- Registro de rollback como operação auditada
- Permissões específicas para rollback (Admin + Developer apenas)
- Preview de alterações antes de confirmar rollback

### 2.4 Relatórios de Auditoria

O sistema deve gerar relatórios parametrizados de auditoria com agregações, totalizações e exportação em múltiplos formatos.

**Capacidades:**

- Relatórios por período, usuário, entidade, operação
- Agregações (total de alterações por dia/semana/mês)
- Top N usuários com mais alterações
- Top N entidades mais alteradas
- Exportação em CSV, Excel, JSON, PDF

### 2.5 Dashboard de Auditoria

O sistema deve exibir dashboard em tempo real com métricas de auditoria e alertas de anomalias.

**Capacidades:**

- Métricas em tempo real (alterações por hora/dia)
- Alertas de anomalias (spikes de alterações)
- Alertas de dados sensíveis (LGPD)
- Top entidades/usuários com mais alterações
- Gráficos de tendência temporal

### 2.6 Integração SIEM (Azure Sentinel)

O sistema deve enviar eventos de auditoria para Azure Sentinel em tempo real, permitindo correlação com eventos de segurança.

**Capacidades:**

- Envio assíncrono de eventos para Azure Sentinel
- Formato CEF (Common Event Format)
- Retry automático em caso de falha
- Configuração de severidade por tipo de evento
- Filtragem de eventos críticos para SIEM

### 2.7 Exportação Forense

O sistema deve permitir exportação forense de trilhas de auditoria com hash criptográfico e assinatura digital, garantindo integridade para uso em processos judiciais.

**Capacidades:**

- Exportação com hash SHA-256 de cada registro
- Assinatura digital do arquivo exportado
- Metadados de exportação (timestamp, usuário, filtros aplicados)
- Formatos: CSV, Excel, JSON, PDF
- Validação de integridade de arquivo exportado

### 2.8 Retenção e Arquivamento

O sistema deve implementar políticas de retenção de dados de auditoria conforme LGPD e SOX 404, com arquivamento automático e purga controlada.

**Capacidades:**

- Retenção configurável por tipo de entidade
- Padrão LGPD: 5 anos para dados pessoais
- Padrão SOX 404: 7 anos para dados financeiros
- Arquivamento automático em blob storage
- Purga controlada após período de retenção
- Restauração de dados arquivados sob demanda

### 2.9 Soft Delete Auditado

O sistema deve implementar soft delete (exclusão lógica) com rastreamento completo, permitindo restauração de registros excluídos.

**Capacidades:**

- Marcação de exclusão com DeletedAt + DeletedBy
- Rastreamento de exclusão como operação auditada
- Filtros de visualização (incluir/excluir deletados)
- Restauração de registros deletados
- Purga física apenas após período de retenção

### 2.10 Alertas de Dados Sensíveis

O sistema deve detectar automaticamente alterações em campos de dados sensíveis (CPF, e-mail, telefone) e gerar alertas para o DPO (Data Protection Officer).

**Capacidades:**

- Detecção automática de campos sensíveis (LGPD)
- Alertas por e-mail ao DPO
- Dashboard específico de alterações sensíveis
- Relatório mensal de conformidade LGPD
- Registro de consentimento para alterações

### 2.11 Detecção de Anomalias

O sistema deve detectar padrões anômalos de alteração (volume, horário, velocidade) e gerar alertas automáticos.

**Capacidades:**

- Baseline de comportamento normal por usuário
- Detecção de spikes de volume (>3x desvio padrão)
- Detecção de horários atípicos (fora do expediente)
- Detecção de velocidade anômala (muitas alterações/segundo)
- Alertas em tempo real para Security Team

### 2.12 Rastreamento de Relacionamentos

O sistema deve capturar alterações em relacionamentos (adição/remoção de entidades relacionadas) com contexto completo.

**Capacidades:**

- Rastreamento de adição/remoção em collections
- Captura de entidade pai e filha
- Contexto de relacionamento (tipo, cardinalidade)
- Visualização de timeline de relacionamentos
- Filtros específicos para alterações de relacionamento

### 2.13 Imutabilidade de Auditoria

O sistema deve garantir que registros de auditoria sejam imutáveis (append-only), impedindo alteração ou exclusão de trilhas de auditoria.

**Capacidades:**

- Proibição total de UPDATE/DELETE em tabela AuditLog
- Validação em nível de DbContext
- Validação em nível de banco de dados (triggers)
- Alertas de tentativa de violação
- Registro de tentativas de violação

---

## 3. REGRAS DE NEGÓCIO

### RN-RF096-001: Rastreamento Automático de Todas as Operações CRUD

**Descrição**: Toda entidade decorada com atributo de auditoria deve ter rastreamento automático de Create, Update e Delete sem necessidade de código adicional no handler.

**Critério de Aceite**:
- Sistema detecta automaticamente entidades marcadas para auditoria
- Captura valores antes e depois de cada alteração em nível de campo
- Registra contexto completo (usuário, IP, timestamp, user-agent, ClienteId)
- Operação de rastreamento não pode falhar a operação principal
- Latência máxima de 50ms por operação auditada

---

### RN-RF096-002: Captura de Valores Antes/Depois com Contexto Completo

**Descrição**: Para toda alteração (Update), o sistema deve capturar valores anteriores e posteriores em nível de campo, junto com contexto completo de execução.

**Critério de Aceite**:
- Cada campo alterado gera um registro de FieldChange separado
- Valores antes/depois são serializados em JSON
- Contexto inclui: UsuarioId, IP, Timestamp, UserAgent, ClienteId, CorrelationId
- Alterações sem mudança de valor não geram registro
- Campos de auditoria interna (DataAtualizacao, AtualizadoPor) não são rastreados

---

### RN-RF096-003: Imutabilidade de Registros de Auditoria

**Descrição**: Registros de auditoria são append-only e não podem ser alterados ou excluídos após inserção, garantindo integridade da trilha de auditoria.

**Critério de Aceite**:
- Tabela AuditLog não possui UPDATE ou DELETE habilitados
- DbContext lança exceção ao detectar tentativa de alteração/exclusão
- Triggers no banco de dados bloqueiam UPDATE/DELETE
- Tentativas de violação geram alerta automático para Security Team
- Registro de tentativas de violação é auditado

---

### RN-RF096-004: Soft Delete com Rastreamento Completo

**Descrição**: Exclusões lógicas (soft delete) devem ser rastreadas como operações auditadas, registrando quem excluiu, quando e contexto completo.

**Critério de Aceite**:
- Entidade marcada com DeletedAt + DeletedBy ao ser excluída
- Operação de soft delete gera registro de auditoria
- Valores anteriores são capturados antes da marcação
- Filtros padrão excluem registros deletados (exceto em consultas de auditoria)
- Restauração de registro deletado é auditada

---

### RN-RF096-005: Detecção Automática de Operações em Lote

**Descrição**: Quando múltiplas entidades são alteradas em uma única transação, o sistema deve detectar automaticamente e agrupar com CorrelationId único.

**Critério de Aceite**:
- CorrelationId é gerado automaticamente para cada SaveChanges
- Todas as alterações na mesma transação recebem o mesmo CorrelationId
- Visualização agrupada de operações em lote na timeline
- Filtro específico para visualizar apenas operações em lote
- CorrelationId é propagado para logs e SIEM

---

### RN-RF096-006: Rastreamento de Alterações em Relacionamentos

**Descrição**: Adições e remoções de entidades relacionadas (collections) devem ser rastreadas como operações específicas de relacionamento.

**Critério de Aceite**:
- Adição de entidade em collection gera registro de tipo "RelationshipAdded"
- Remoção de entidade em collection gera registro de tipo "RelationshipRemoved"
- Registro inclui entidade pai, entidade filha e tipo de relacionamento
- Timeline específica para visualizar mudanças de relacionamentos
- Filtros para isolar alterações de relacionamento

---

### RN-RF096-007: Retenção de Dados Conforme LGPD e SOX 404

**Descrição**: Registros de auditoria devem ser retidos conforme prazos legais (5 anos LGPD para dados pessoais, 7 anos SOX 404 para dados financeiros) e automaticamente arquivados/purgados.

**Critério de Aceite**:
- Política de retenção configurável por tipo de entidade
- Job automático de arquivamento mensal
- Arquivamento em blob storage após período ativo
- Purga física após fim do período de retenção
- Restauração sob demanda de dados arquivados
- Registro de operações de arquivamento/purga

---

### RN-RF096-008: Alertas de Alteração de Dados Sensíveis (LGPD)

**Descrição**: Alterações em campos de dados sensíveis (CPF, e-mail, telefone, endereço) devem gerar alertas automáticos para o DPO (Data Protection Officer).

**Critério de Aceite**:
- Sistema identifica automaticamente campos sensíveis
- E-mail automático ao DPO a cada alteração sensível
- Dashboard específico com todas as alterações sensíveis
- Relatório mensal de conformidade LGPD
- Registro de consentimento para alterações sensíveis

---

### RN-RF096-009: Visualização de Timeline com Filtros Avançados

**Descrição**: Usuários com permissão devem poder visualizar timeline completa de alterações em uma entidade, com filtros por período, usuário, campo alterado e tipo de operação.

**Critério de Aceite**:
- Timeline ordenada cronologicamente (mais recente primeiro)
- Filtros: período, usuário, campo, tipo de operação, incluir/excluir deletados
- Comparação visual entre versões (diff)
- Navegação entre snapshots históricos
- Exportação de timeline filtrada (CSV, PDF)

---

### RN-RF096-010: Rollback Controlado com Validação de Integridade

**Descrição**: Usuários com permissão específica (Admin + Developer) devem poder restaurar versões anteriores de entidades, com validação de integridade referencial antes de aplicar.

**Critério de Aceite**:
- Seleção de snapshot histórico específico
- Validação de integridade referencial antes de aplicar
- Preview de alterações antes de confirmar
- Operação de rollback é auditada
- Permissões RBAC específicas (CAD.AUDITORIA.ROLLBACK)
- Rollback de soft delete é suportado

---

### RN-RF096-011: Relatórios Parametrizados com Agregações

**Descrição**: Sistema deve gerar relatórios parametrizados de auditoria com agregações, totalizações e exportação em múltiplos formatos.

**Critério de Aceite**:
- Filtros: período, usuário, entidade, tipo de operação, campo alterado
- Agregações: total de alterações por dia/semana/mês
- Top N usuários com mais alterações
- Top N entidades mais alteradas
- Exportação em CSV, Excel, JSON, PDF
- Agendamento de relatórios recorrentes

---

### RN-RF096-012: Dashboard com Alertas de Anomalias

**Descrição**: Dashboard em tempo real deve exibir métricas de auditoria e alertas automáticos de padrões anômalos de alteração.

**Critério de Aceite**:
- Métricas em tempo real: alterações por hora/dia/semana
- Alertas de spikes de volume (>3x desvio padrão)
- Alertas de horários atípicos (fora do expediente)
- Alertas de velocidade anômala (muitas alterações/segundo)
- Top entidades/usuários com mais alterações
- Gráficos de tendência temporal

---

### RN-RF096-013: Integração com Azure Sentinel (SIEM)

**Descrição**: Eventos de auditoria críticos devem ser enviados automaticamente para Azure Sentinel em tempo real, no formato CEF (Common Event Format).

**Critério de Aceite**:
- Envio assíncrono para não impactar performance
- Formato CEF padronizado
- Configuração de severidade por tipo de evento
- Retry automático em caso de falha (3 tentativas)
- Registro de falhas de envio para troubleshooting
- Filtragem de eventos críticos (configurável)

---

### RN-RF096-014: Exportação Forense com Hash Criptográfico

**Descrição**: Exportações forenses de trilhas de auditoria devem incluir hash SHA-256 de cada registro e assinatura digital do arquivo, garantindo integridade para uso em processos judiciais.

**Critério de Aceite**:
- Hash SHA-256 calculado para cada registro exportado
- Assinatura digital do arquivo completo (certificado digital)
- Metadados de exportação (timestamp, usuário, filtros aplicados)
- Validação de integridade de arquivo exportado
- Formatos: CSV, Excel, JSON, PDF
- Registro de exportações forenses (quem, quando, filtros)

---

### RN-RF096-015: Multi-Tenancy Obrigatório

**Descrição**: Todos os registros de auditoria devem ser isolados por ClienteId, garantindo que clientes não visualizem auditoria de outros clientes.

**Critério de Aceite**:
- Campo ClienteId obrigatório em AuditLog
- Filtro automático por ClienteId em todas as queries
- Validação de multi-tenancy em nível de DbContext
- Impossibilidade de cross-tenant access
- Testes automatizados de isolamento

---

### RN-RF096-016: Performance de Consultas de Auditoria

**Descrição**: Consultas de auditoria com filtros complexos não podem exceder 2 segundos de latência, mesmo com milhões de registros.

**Critério de Aceite**:
- Índices otimizados em EntityType, EntityId, Timestamp, ClienteId
- Paginação obrigatória em todas as consultas (máximo 100 registros por página)
- Cache de consultas frequentes (5 minutos)
- Queries otimizadas com projeções específicas (sem Select *)
- Testes de carga com 10M+ registros

---

### RN-RF096-017: Auditoria de Tentativas de Violação

**Descrição**: Tentativas de alteração ou exclusão de registros de auditoria devem ser detectadas e registradas automaticamente como violações de segurança.

**Critério de Aceite**:
- Exceções lançadas ao detectar UPDATE/DELETE em AuditLog
- Registro de tentativa de violação com stack trace completo
- Alerta automático para Security Team
- Bloqueio imediato da operação
- Registro em log de segurança separado

---

### RN-RF096-018: Auditoria de Campos Calculados e Derivados

**Descrição**: Campos calculados ou derivados (computed properties) não devem gerar registros de auditoria, evitando poluição de trilha.

**Critério de Aceite**:
- Apenas campos mapeados no banco de dados são auditados
- Propriedades com [NotMapped] são ignoradas
- Campos de navegação (related entities) são ignorados
- Apenas valores persistidos são capturados

---

### RN-RF096-019: Consistência de Timestamps

**Descrição**: Todos os timestamps de auditoria devem usar UTC e ser armazenados com precisão de milissegundos.

**Critério de Aceite**:
- Timestamps sempre em UTC (DateTimeOffset)
- Precisão de milissegundos
- Conversão automática de fuso horário na visualização
- Ordenação consistente mesmo com operações simultâneas

---

### RN-RF096-020: Auditoria de Importações em Massa

**Descrição**: Importações em massa (bulk insert) devem gerar registros de auditoria agrupados com CorrelationId específico de batch.

**Critério de Aceite**:
- CorrelationId único para cada batch de importação
- Metadados de batch (total de registros, arquivo origem, timestamp)
- Visualização agrupada de importações em massa
- Rollback de batch completo (se permitido)

---

## 4. INTEGRAÇÕES OBRIGATÓRIAS

### 4.1 Internacionalização (i18n)

**Chaves de tradução obrigatórias:**

- `auditoria.titulo` - Título principal do módulo
- `auditoria.timeline.titulo` - Título da timeline
- `auditoria.rollback.titulo` - Título da funcionalidade de rollback
- `auditoria.relatorios.titulo` - Título de relatórios
- `auditoria.dashboard.titulo` - Título do dashboard
- `auditoria.exportacao.titulo` - Título de exportação
- `auditoria.entidade.tipo` - Tipo de entidade
- `auditoria.operacao.criar` - Operação de criação
- `auditoria.operacao.alterar` - Operação de alteração
- `auditoria.operacao.excluir` - Operação de exclusão
- `auditoria.campo.valorAnterior` - Valor anterior do campo
- `auditoria.campo.valorPosterior` - Valor posterior do campo
- `auditoria.contexto.usuario` - Usuário que executou
- `auditoria.contexto.ip` - Endereço IP
- `auditoria.contexto.timestamp` - Data/hora da operação
- `auditoria.erro.semPermissao` - Erro de permissão
- `auditoria.erro.rollbackFalhou` - Erro de rollback
- `auditoria.sucesso.rollback` - Sucesso em rollback
- `auditoria.alerta.anomalia` - Alerta de anomalia detectada
- `auditoria.alerta.dadosSensiveis` - Alerta de alteração de dados sensíveis

**Idiomas suportados:** pt-BR, en, es

---

### 4.2 Auditoria Interna

**Integração:** Automática via AuditInterceptor

**Observação:** A própria tabela AuditLog NÃO é auditada (evitar recursão infinita). Tentativas de violação são registradas em log de segurança separado.

---

### 4.3 Permissões RBAC

**Matriz de permissões:**

| Funcionalidade | Permission Code | Roles Padrão |
|----------------|----------------|--------------|
| Visualizar timeline própria | CAD.AUDITORIA.TIMELINE_PROPRIA | Todos os usuários autenticados |
| Visualizar timeline de outros | CAD.AUDITORIA.TIMELINE_OUTROS | Admin, Auditor, DPO |
| Executar rollback | CAD.AUDITORIA.ROLLBACK | Admin, Developer |
| Gerar relatórios | CAD.AUDITORIA.RELATORIOS | Admin, Auditor, DPO |
| Visualizar dashboard | CAD.AUDITORIA.DASHBOARD | Admin, Auditor, DPO |
| Exportar forense | CAD.AUDITORIA.EXPORTACAO_FORENSE | Admin, Auditor |
| Configurar retenção | CAD.AUDITORIA.CONFIGURACAO | Admin |
| Visualizar alertas sensíveis | CAD.AUDITORIA.ALERTAS_SENSIVEIS | Admin, DPO |

---

### 4.4 Multi-Tenancy

**Campos obrigatórios:**

- `ClienteId` (Guid, NOT NULL) - Isolamento por cliente

**Validações:**

- Todas as queries de auditoria são filtradas automaticamente por ClienteId
- Impossibilidade de cross-tenant access
- Testes automatizados de isolamento

---

### 4.5 Central de Funcionalidades

**Registro obrigatório:**

```yaml
codigo: AUD.AUDITORIA_MUDANCAS_DADOS
modulo: Auditoria
titulo_pt: Auditoria de Mudanças de Dados
titulo_en: Data Change Auditing
titulo_es: Auditoría de Cambios de Datos
descricao_pt: Rastreamento automático de todas as alterações em entidades
icone: history
rota_frontend: /auditoria/mudancas-dados
ativo: true
```

---

### 4.6 Integração com Azure Sentinel (SIEM)

**Configuração:**

- Workspace ID do Azure Sentinel
- Shared Key para autenticação
- Tipo de log: Custom_IControlIT_Audit_CL
- Formato: CEF (Common Event Format)

**Eventos enviados:**

- Todas as alterações em entidades críticas (configurável)
- Todas as tentativas de violação de auditoria
- Todas as operações de rollback
- Todos os alertas de anomalia

---

## 5. PERMISSÕES RBAC

### 5.1 Matriz de Permissões

| Permission Code | Descrição | Roles Padrão |
|----------------|-----------|--------------|
| CAD.AUDITORIA.TIMELINE_PROPRIA | Visualizar timeline de próprias alterações | User, Admin, Auditor, Developer, DPO |
| CAD.AUDITORIA.TIMELINE_OUTROS | Visualizar timeline de alterações de outros usuários | Admin, Auditor, DPO |
| CAD.AUDITORIA.ROLLBACK | Executar rollback de entidades | Admin, Developer |
| CAD.AUDITORIA.RELATORIOS | Gerar relatórios de auditoria | Admin, Auditor, DPO |
| CAD.AUDITORIA.DASHBOARD | Visualizar dashboard de auditoria | Admin, Auditor, DPO |
| CAD.AUDITORIA.EXPORTACAO_FORENSE | Exportar trilhas com hash forense | Admin, Auditor |
| CAD.AUDITORIA.CONFIGURACAO | Configurar políticas de retenção e arquivamento | Admin |
| CAD.AUDITORIA.ALERTAS_SENSIVEIS | Visualizar alertas de dados sensíveis (LGPD) | Admin, DPO |
| CAD.AUDITORIA.VISUALIZAR_VIOLACOES | Visualizar tentativas de violação de auditoria | Admin, Security |

---

### 5.2 Regras de Negócio de Permissões

- **RN-RBAC-096-001**: Usuários podem sempre visualizar timeline de próprias alterações
- **RN-RBAC-096-002**: Apenas Admin e Developer podem executar rollback
- **RN-RBAC-096-003**: Apenas Admin pode configurar políticas de retenção
- **RN-RBAC-096-004**: DPO tem acesso obrigatório a alertas de dados sensíveis (LGPD)
- **RN-RBAC-096-005**: Auditor tem acesso read-only a todas as funcionalidades de auditoria

---

## 6. API ENDPOINTS

### 6.1 Timeline de Entidade

**Endpoint:** `GET /api/auditoria/timeline/{entityType}/{entityId}`

**Permissão:** CAD.AUDITORIA.TIMELINE_PROPRIA ou CAD.AUDITORIA.TIMELINE_OUTROS

**Query Parameters:**
- `startDate` (opcional): Data inicial do filtro
- `endDate` (opcional): Data final do filtro
- `userId` (opcional): Filtro por usuário
- `operationType` (opcional): Filtro por tipo de operação (Created, Updated, Deleted)
- `fieldName` (opcional): Filtro por campo específico
- `includeDeleted` (opcional): Incluir registros deletados
- `page` (obrigatório): Número da página
- `pageSize` (obrigatório): Tamanho da página (máximo 100)

**Response:**
```json
{
  "entityType": "Ativo",
  "entityId": "uuid",
  "totalRecords": 150,
  "page": 1,
  "pageSize": 50,
  "changes": [
    {
      "id": "uuid",
      "operationType": "Updated",
      "timestamp": "2025-12-31T10:30:00.000Z",
      "userId": "uuid",
      "userName": "João Silva",
      "ip": "192.168.1.100",
      "userAgent": "Mozilla/5.0...",
      "correlationId": "uuid",
      "fieldChanges": [
        {
          "fieldName": "Nome",
          "oldValue": "Notebook Dell",
          "newValue": "Notebook HP"
        }
      ]
    }
  ]
}
```

---

### 6.2 Executar Rollback

**Endpoint:** `POST /api/auditoria/rollback/{auditLogId}`

**Permissão:** CAD.AUDITORIA.ROLLBACK

**Body:**
```json
{
  "motivo": "Reversão de alteração incorreta"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Rollback executado com sucesso",
  "newAuditLogId": "uuid"
}
```

---

### 6.3 Gerar Relatório

**Endpoint:** `POST /api/auditoria/relatorios`

**Permissão:** CAD.AUDITORIA.RELATORIOS

**Body:**
```json
{
  "startDate": "2025-01-01",
  "endDate": "2025-12-31",
  "entityType": "Ativo",
  "userId": "uuid",
  "operationType": "Updated",
  "formato": "PDF",
  "agruparPor": "Usuario"
}
```

**Response:** Stream do arquivo PDF/CSV/Excel/JSON

---

### 6.4 Dashboard Métricas

**Endpoint:** `GET /api/auditoria/dashboard`

**Permissão:** CAD.AUDITORIA.DASHBOARD

**Query Parameters:**
- `periodo` (opcional): today, week, month, year

**Response:**
```json
{
  "periodo": "month",
  "totalAlteracoes": 5420,
  "alteracoesPorDia": [
    { "data": "2025-12-01", "total": 120 },
    { "data": "2025-12-02", "total": 145 }
  ],
  "topUsuarios": [
    { "userId": "uuid", "userName": "João Silva", "total": 320 }
  ],
  "topEntidades": [
    { "entityType": "Ativo", "total": 1200 }
  ],
  "alertas": [
    {
      "tipo": "Anomalia",
      "descricao": "Spike de alterações detectado",
      "timestamp": "2025-12-31T10:30:00.000Z"
    }
  ]
}
```

---

### 6.5 Exportar Forense

**Endpoint:** `POST /api/auditoria/exportacao-forense`

**Permissão:** CAD.AUDITORIA.EXPORTACAO_FORENSE

**Body:**
```json
{
  "startDate": "2025-01-01",
  "endDate": "2025-12-31",
  "entityType": "Ativo",
  "formato": "PDF",
  "incluirHash": true,
  "assinarDigitalmente": true
}
```

**Response:** Stream do arquivo com hash SHA-256 e assinatura digital

---

### 6.6 Configurar Retenção

**Endpoint:** `PUT /api/auditoria/configuracao/retencao`

**Permissão:** CAD.AUDITORIA.CONFIGURACAO

**Body:**
```json
{
  "entityType": "Ativo",
  "retencaoAnos": 7,
  "arquivamentoAutomatico": true
}
```

**Response:**
```json
{
  "success": true,
  "message": "Política de retenção atualizada"
}
```

---

### 6.7 Alertas de Dados Sensíveis

**Endpoint:** `GET /api/auditoria/alertas-sensiveis`

**Permissão:** CAD.AUDITORIA.ALERTAS_SENSIVEIS

**Query Parameters:**
- `startDate` (opcional): Data inicial
- `endDate` (opcional): Data final
- `page` (obrigatório): Número da página
- `pageSize` (obrigatório): Tamanho da página

**Response:**
```json
{
  "totalRecords": 45,
  "page": 1,
  "pageSize": 20,
  "alertas": [
    {
      "id": "uuid",
      "entityType": "Usuario",
      "entityId": "uuid",
      "fieldName": "CPF",
      "oldValue": "***.***.***-**",
      "newValue": "***.***.***-**",
      "timestamp": "2025-12-31T10:30:00.000Z",
      "userId": "uuid",
      "userName": "João Silva",
      "dpoNotificado": true
    }
  ]
}
```

---

## 7. MODELO DE DADOS

### 7.1 Tabela Principal: AuditLog

```sql
CREATE TABLE AuditLog (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    EntityType NVARCHAR(100) NOT NULL,
    EntityId NVARCHAR(100) NOT NULL,
    OperationType NVARCHAR(20) NOT NULL CHECK (OperationType IN ('Created', 'Updated', 'Deleted', 'Rollback')),
    Timestamp DATETIMEOFFSET NOT NULL DEFAULT SYSDATETIMEOFFSET(),
    UserId UNIQUEIDENTIFIER NOT NULL,
    UserName NVARCHAR(200) NOT NULL,
    IP NVARCHAR(45) NOT NULL,
    UserAgent NVARCHAR(500) NULL,
    ClienteId UNIQUEIDENTIFIER NOT NULL,
    CorrelationId UNIQUEIDENTIFIER NOT NULL,

    -- Índices
    INDEX IX_AuditLog_EntityType_EntityId (EntityType, EntityId, Timestamp DESC),
    INDEX IX_AuditLog_ClienteId_Timestamp (ClienteId, Timestamp DESC),
    INDEX IX_AuditLog_UserId_Timestamp (UserId, Timestamp DESC),
    INDEX IX_AuditLog_CorrelationId (CorrelationId),

    -- FK
    FOREIGN KEY (ClienteId) REFERENCES Cliente(Id),
    FOREIGN KEY (UserId) REFERENCES Usuario(Id)
);
```

---

### 7.2 Tabela de Campos Alterados: AuditFieldChange

```sql
CREATE TABLE AuditFieldChange (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    AuditLogId UNIQUEIDENTIFIER NOT NULL,
    FieldName NVARCHAR(100) NOT NULL,
    OldValue NVARCHAR(MAX) NULL,
    NewValue NVARCHAR(MAX) NULL,

    -- Índices
    INDEX IX_AuditFieldChange_AuditLogId (AuditLogId),
    INDEX IX_AuditFieldChange_FieldName (FieldName),

    -- FK
    FOREIGN KEY (AuditLogId) REFERENCES AuditLog(Id) ON DELETE CASCADE
);
```

---

### 7.3 Tabela de Políticas de Retenção: AuditRetentionPolicy

```sql
CREATE TABLE AuditRetentionPolicy (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    EntityType NVARCHAR(100) NOT NULL UNIQUE,
    RetentionYears INT NOT NULL CHECK (RetentionYears > 0),
    AutoArchive BIT NOT NULL DEFAULT 1,
    ClienteId UNIQUEIDENTIFIER NOT NULL,

    -- Auditoria
    DataCriacao DATETIMEOFFSET NOT NULL DEFAULT SYSDATETIMEOFFSET(),
    CriadoPor UNIQUEIDENTIFIER NOT NULL,
    DataAtualizacao DATETIMEOFFSET NULL,
    AtualizadoPor UNIQUEIDENTIFIER NULL,

    -- FK
    FOREIGN KEY (ClienteId) REFERENCES Cliente(Id)
);
```

---

### 7.4 Entidades Auditáveis

**Entidades que DEVEM ser auditadas:**

- Ativo (Ativos de TI)
- Fatura (Faturas de telecomunicações)
- CentroCusto (Centros de custo)
- Consumidor (Consumidores de serviços)
- Usuario (Usuários do sistema)
- Perfil (Perfis de acesso)
- Empresa (Empresas/Filiais)
- Contrato (Contratos)
- SolicitacaoServico (Solicitações de serviço)

---

## 8. DEPENDÊNCIAS

### 8.1 Dependências de Backend

**RFs Obrigatórios:**

- RF001 - Parâmetros e Configurações (SistemaConfiguracaoGeral)
- RF006 - Gestão de Usuários (Usuario)
- RF007 - Gestão de Perfis de Acesso (Perfil, Permissão)
- RF008 - Gestão de Empresas e Filiais (Empresa, ClienteId)

**Bibliotecas .NET:**

- Entity Framework Core 10+ (Change Tracker)
- MediatR 12+ (CQRS)
- Azure.Monitor.Ingestion (Azure Sentinel)
- System.Security.Cryptography (Hash SHA-256)

---

### 8.2 Dependências de Frontend

**Componentes Fuse:**

- FuseCardComponent
- FuseAlertComponent
- FuseLoadingBarComponent

**Angular Material:**

- MatTableModule (Tabelas de auditoria)
- MatPaginatorModule (Paginação)
- MatSortModule (Ordenação)
- MatFormFieldModule (Filtros)
- MatDatepickerModule (Filtros de data)
- MatSelectModule (Seleção de entidade/usuário)
- MatButtonModule (Ações)
- MatIconModule (Ícones)
- MatTooltipModule (Tooltips)
- MatDialogModule (Modais de rollback)
- MatChipsModule (Tags de operação)

**Bibliotecas Terceiras:**

- ApexCharts (Gráficos de timeline e dashboard)
- moment.js (Manipulação de datas)

---

### 8.3 Dependências de Infraestrutura

**Azure:**

- Azure Sentinel (SIEM) - Workspace configurado
- Azure Blob Storage (Arquivamento de auditoria antiga)

**SQL Server:**

- Versão 2019+ (suporte a DATETIMEOFFSET e JSON)
- Triggers habilitados (bloqueio de UPDATE/DELETE em AuditLog)

---

## 9. KPIs E MÉTRICAS

### 9.1 KPIs de Performance

| KPI | Meta | Medição |
|-----|------|---------|
| Latência de captura de auditoria | < 50ms por operação | Média de tempo do AuditInterceptor |
| Latência de consulta de timeline | < 2s | Tempo de resposta do endpoint GET /timeline |
| Taxa de sucesso de envio para SIEM | > 99% | % de eventos enviados com sucesso |
| Taxa de disponibilidade do módulo | > 99.5% | Uptime mensal |

---

### 9.2 KPIs de Compliance

| KPI | Meta | Medição |
|-----|------|---------|
| Cobertura de auditoria | 100% de entidades críticas | % de entidades com [Audited] |
| Taxa de auditoria de dados sensíveis | 100% | % de alterações em CPF/e-mail/telefone auditadas |
| Conformidade LGPD | 100% | % de registros com retenção configurada |
| Conformidade SOX 404 | 100% | % de dados financeiros com retenção de 7 anos |

---

### 9.3 KPIs de Segurança

| KPI | Meta | Medição |
|-----|------|---------|
| Tentativas de violação de auditoria | 0 | Total de tentativas de UPDATE/DELETE em AuditLog |
| Alertas de anomalias detectadas | Monitorar | Total de alertas de spikes/horários atípicos |
| Taxa de detecção de fraudes | Monitorar | % de fraudes detectadas via auditoria |

---

### 9.4 Métricas de Dashboard

**Métricas exibidas em tempo real:**

- Total de alterações (hoje/semana/mês)
- Alterações por hora (gráfico de linha)
- Top 10 usuários com mais alterações
- Top 10 entidades mais alteradas
- Total de alertas de anomalias
- Total de alertas de dados sensíveis
- Total de rollbacks executados
- Total de exportações forenses

---

## 10. ALERTAS CRÍTICOS

### 10.1 Alertas de Segurança

| Alerta | Condição | Ação Automática | Destinatários |
|--------|----------|----------------|---------------|
| Tentativa de violação de auditoria | UPDATE ou DELETE em AuditLog | Bloquear operação, registrar violação, alertar Security Team | Security Team, Admin |
| Spike de alterações | Alterações > 3x desvio padrão | Alertar em dashboard, registrar anomalia | Security Team, Auditor |
| Alteração fora do expediente | Alteração entre 22h-6h | Alertar em dashboard | Security Team |
| Velocidade anômala | Muitas alterações/segundo por usuário | Alertar em dashboard | Security Team |

---

### 10.2 Alertas de Compliance

| Alerta | Condição | Ação Automática | Destinatários |
|--------|----------|----------------|---------------|
| Alteração de dados sensíveis | Alteração em CPF/e-mail/telefone | E-mail ao DPO, registrar alerta | DPO, Admin |
| Retenção expirada | Registros além do prazo de retenção | Iniciar job de arquivamento | Admin |
| Falha de envio para SIEM | Erro ao enviar evento para Azure Sentinel | Retry automático (3x), alertar se falhar | Admin, DevOps |

---

### 10.3 Alertas de Performance

| Alerta | Condição | Ação Automática | Destinatários |
|--------|----------|----------------|---------------|
| Latência alta de auditoria | Latência > 100ms | Alertar em dashboard | DevOps, Admin |
| Latência alta de consulta | Timeline > 5s | Alertar em dashboard | DevOps, Admin |
| Crescimento acelerado de AuditLog | Crescimento > 10GB/mês | Alertar para revisar políticas de retenção | Admin, DBA |

---

## 11. CENTRAL DE FUNCIONALIDADES

### 11.1 Registro na Central

```yaml
codigo: AUD.AUDITORIA_MUDANCAS_DADOS
modulo: Auditoria
titulo_pt: Auditoria de Mudanças de Dados
titulo_en: Data Change Auditing
titulo_es: Auditoría de Cambios de Datos
descricao_pt: Rastreamento automático de todas as alterações em entidades críticas
descricao_en: Automatic tracking of all changes in critical entities
descricao_es: Seguimiento automático de todos los cambios en entidades críticas
icone: history
rota_frontend: /auditoria/mudancas-dados
ativo: true
ordem_exibicao: 1
categoria: Auditoria e Compliance
```

---

### 11.2 Navegação no Menu

**Localização no menu:**

```
Auditoria
├── Auditoria de Mudanças de Dados (RF096) ← Este RF
├── Timeline de Entidade
├── Relatórios de Auditoria
├── Dashboard de Auditoria
└── Configurações de Retenção
```

---

### 11.3 Ajuda Contextual

**Tooltips obrigatórios:**

- `auditoria.help.timeline` - "Visualize todas as alterações históricas desta entidade"
- `auditoria.help.rollback` - "Restaure uma versão anterior (requer permissão específica)"
- `auditoria.help.exportacao` - "Exporte trilha de auditoria com hash forense"
- `auditoria.help.filtros` - "Filtre por período, usuário, campo alterado ou tipo de operação"
- `auditoria.help.anomalias` - "Alertas automáticos de padrões suspeitos"

---

**FIM DO DOCUMENTO**

**Versão:** 2.0
**Data de Migração:** 2025-12-31
**Status:** Documentação migrada conforme CONTRATO-RF-PARA-RL.md
**Próximos Passos:** Criar RF096.yaml, RL-RF096.md, RL-RF096.yaml, executar validador
