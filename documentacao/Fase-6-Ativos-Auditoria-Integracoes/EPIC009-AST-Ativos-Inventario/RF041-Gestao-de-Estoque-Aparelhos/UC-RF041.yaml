uc:
  documentacao: "RF041"
  versao: "1.0"
  data: "2025-12-31"

casos_de_uso:
  - id: "UC00"
    nome: "Consultar Saldo de Estoque"
    ator_principal: "usuario_autenticado"
    tipo: "consulta"
    impacta_dados: false
    covers:
      documentacao_items:
        - "RN-AST-041-05"  # Auditoria completa
        - "RN-AST-041-16"  # Saldo exibe valor total R$
        - "RN-AST-041-17"  # Histórico imutável
        - "RN-AST-041-18"  # Exportação registrada auditoria
        - "RN-AST-041-19"  # Rastreamento IMEI timeline completa
      uc_items:
        - id: "FP-UC00-001"
          title: "Usuário acessa tela de consulta de estoque"
          required: true
        - id: "FP-UC00-002"
          title: "Sistema carrega filtros avançados"
          required: true
        - id: "FP-UC00-003"
          title: "Usuário seleciona filtros (almoxarifado, categoria, marca, modelo)"
          required: false
        - id: "FP-UC00-004"
          title: "Sistema exibe grid com saldo físico, reservado, disponível e valor total R$"
          required: true
        - id: "FA-UC00-01"
          title: "Usuário solicita consulta consolidada (todos almoxarifados)"
          required: false
        - id: "FA-UC00-02"
          title: "Usuário solicita histórico de movimentações de um item"
          required: false
        - id: "FA-UC00-03"
          title: "Usuário busca rastreamento por IMEI/SN"
          required: false
        - id: "FA-UC00-04"
          title: "Sistema exibe timeline completa do aparelho (entrada → movimentações → saída)"
          required: false
        - id: "FA-UC00-05"
          title: "Usuário solicita exportação (Excel/PDF/CSV)"
          required: false
        - id: "FA-UC00-06"
          title: "Sistema registra exportação em auditoria (LGPD)"
          required: false
    precondicoes:
      - permissao: "GES.ESTOQUE.CONSULTAR"
      - usuario_autenticado: true
    fluxo_principal:
      - passo: 1
        ator: "usuario"
        acao: "acessa_tela_consulta_estoque"
      - passo: 2
        ator: "sistema"
        acao: "carrega_filtros_avancados"
        campos: ["Almoxarifado", "Categoria", "Marca", "Modelo"]
      - passo: 3
        ator: "usuario"
        acao: "seleciona_filtros"
        opcional: true
      - passo: 4
        ator: "sistema"
        acao: "exibe_grid_saldo"
        colunas: ["Produto", "Marca/Modelo", "Almoxarifado", "Saldo Físico", "Saldo Reservado", "Saldo Disponível", "Valor Unit R$", "Valor Total R$"]
        calculo_valor_total: "saldo_fisico × custo_medio"
    fluxos_alternativos:
      - id: "FA-UC00-01"
        condicao: "consulta_consolidada"
        passos:
          - passo: 1
            ator: "usuario"
            acao: "seleciona_opcao_consolidar_almoxarifados"
          - passo: 2
            ator: "sistema"
            acao: "exibe_saldo_total_todos_almoxarifados"
            agrupamento: "Por Categoria e Marca/Modelo"
        regras: ["RN-AST-041-16"]
      - id: "FA-UC00-02"
        condicao: "consulta_historico_movimentacoes"
        passos:
          - passo: 1
            ator: "usuario"
            acao: "clica_botao_historico_item"
          - passo: 2
            ator: "sistema"
            acao: "exibe_timeline_movimentacoes_imutavel"
            colunas: ["Data", "Tipo (Entrada/Saída/Transferência)", "Quantidade", "Almoxarifado Origem", "Almoxarifado Destino", "Usuário", "Observações"]
        regras: ["RN-AST-041-17"]
      - id: "FA-UC00-03"
        condicao: "rastreamento_imei_sn"
        passos:
          - passo: 1
            ator: "usuario"
            acao: "digita_imei_ou_serial_number"
          - passo: 2
            ator: "sistema"
            acao: "exibe_timeline_visual_completa"
            eventos: ["Entrada inicial", "Movimentações (transferências)", "Saída final (distribuição/venda/descarte)"]
          - passo: 3
            ator: "sistema"
            acao: "exibe_link_ativo_rf028_se_distribuicao"
        regras: ["RN-AST-041-19"]
      - id: "FA-UC00-04"
        condicao: "exportacao_dados"
        passos:
          - passo: 1
            ator: "usuario"
            acao: "seleciona_formato_exportacao"
            formatos: ["Excel", "PDF", "CSV"]
          - passo: 2
            ator: "sistema"
            acao: "gera_arquivo_exportacao"
          - passo: 3
            ator: "sistema"
            acao: "registra_auditoria_exportacao"
            dados_registrados: ["Usuário", "IP", "Timestamp", "Formato", "Filtros aplicados"]
          - passo: 4
            ator: "sistema"
            acao: "download_arquivo"
        regras: ["RN-AST-041-18"]
    fluxos_excecao: []
    pos_condicoes:
      - consulta_registrada_auditoria_se_exportacao: true
    regras_aplicadas:
      - "RN-AST-041-05"
      - "RN-AST-041-16"
      - "RN-AST-041-17"
      - "RN-AST-041-18"
      - "RN-AST-041-19"

  - id: "UC01"
    nome: "Registrar Entrada de Aparelhos"
    ator_principal: "almoxarife_ou_gestor_estoque"
    tipo: "crud"
    impacta_dados: true
    covers:
      documentacao_items:
        - "RN-AST-041-01"  # Entrada Compra Vinculada NF
        - "RN-AST-041-02"  # Entrada Devolução Vinculada Ativo
        - "RN-AST-041-03"  # Ajuste Manual Requer Justificativa
        - "RN-AST-041-04"  # Ajuste >10 Unidades Requer Aprovação
        - "RN-AST-041-05"  # Auditoria completa movimentações
      uc_items:
        - id: "FP-UC01-001"
          title: "Almoxarife acessa tela de entrada de aparelhos"
          required: true
        - id: "FP-UC01-002"
          title: "Sistema exibe formulário com tipo de entrada (Compra/Devolução/Transferência/Ajuste)"
          required: true
        - id: "FP-UC01-003"
          title: "Almoxarife seleciona tipo de entrada"
          required: true
        - id: "FP-UC01-004"
          title: "Sistema exibe campos específicos do tipo selecionado"
          required: true
        - id: "FP-UC01-005"
          title: "Almoxarife preenche dados e confirma"
          required: true
        - id: "FP-UC01-006"
          title: "Sistema valida dados conforme regras do tipo"
          required: true
        - id: "FP-UC01-007"
          title: "Sistema incrementa saldo físico e disponível"
          required: true
        - id: "FP-UC01-008"
          title: "Sistema registra movimentação com auditoria completa"
          required: true
        - id: "FA-UC01-01"
          title: "Entrada tipo Compra - vincular Nota Fiscal (RF039)"
          required: false
        - id: "FA-UC01-02"
          title: "Entrada tipo Devolução - vincular Ativo existente (RF028)"
          required: false
        - id: "FA-UC01-03"
          title: "Ajuste Manual - exigir justificativa mínimo 20 caracteres"
          required: false
        - id: "FA-UC01-04"
          title: "Ajuste >10 unidades - workflow de aprovação gestor"
          required: false
        - id: "FE-UC01-01"
          title: "Compra sem NF vinculada - sistema rejeita (HTTP 400)"
          required: true
        - id: "FE-UC01-02"
          title: "Devolução sem Ativo vinculado - sistema rejeita (HTTP 400)"
          required: true
        - id: "FE-UC01-03"
          title: "Ajuste manual sem justificativa - sistema rejeita (HTTP 400)"
          required: true
    precondicoes:
      - permissao: "GES.ESTOQUE.ENTRADA.CREATE"
      - usuario_autenticado: true
      - almoxarifado_ativo: true
    fluxo_principal:
      - passo: 1
        ator: "almoxarife"
        acao: "acessa_tela_entrada_aparelhos"
      - passo: 2
        ator: "sistema"
        acao: "exibe_formulario_entrada"
        campos: ["Tipo Entrada*", "Almoxarifado*", "Categoria*", "Marca*", "Modelo*", "Quantidade*", "Custo Unitário*", "IMEI/SN (se rastreável)", "Observações"]
      - passo: 3
        ator: "almoxarife"
        acao: "seleciona_tipo_entrada"
        tipos: ["Compra", "Devolução", "Transferência Recebida", "Ajuste Manual"]
      - passo: 4
        ator: "sistema"
        acao: "exibe_campos_especificos_tipo"
        regras_condicionais:
          - se: "tipo = Compra"
            entao: "exibir campo Nota Fiscal (obrigatório)"
          - se: "tipo = Devolução"
            entao: "exibir campo Ativo (obrigatório)"
          - se: "tipo = Ajuste Manual"
            entao: "exibir campo Justificativa (obrigatório, mínimo 20 chars)"
      - passo: 5
        ator: "almoxarife"
        acao: "preenche_dados_confirma"
      - passo: 6
        ator: "sistema"
        acao: "valida_campos_obrigatorios"
      - passo: 7
        ator: "sistema"
        acao: "incrementa_saldo_fisico_disponivel"
      - passo: 8
        ator: "sistema"
        acao: "registra_movimentacao_auditoria"
        dados_auditados: ["Usuario", "IP", "DataHora", "DadosAntes", "DadosDepois", "Acao"]
      - passo: 9
        ator: "sistema"
        acao: "exibe_mensagem_sucesso"
    fluxos_alternativos:
      - id: "FA-UC01-01"
        condicao: "tipo_entrada_compra"
        passos:
          - passo: 1
            ator: "almoxarife"
            acao: "seleciona_nota_fiscal_vinculada"
            origem: "RF039"
          - passo: 2
            ator: "sistema"
            acao: "valida_nf_existe_ativa"
          - passo: 3
            ator: "sistema"
            acao: "preenche_campos_automaticamente"
            campos_preenchidos: ["Fornecedor", "Data Entrada", "Custo Unitário (da NF)"]
        regras: ["RN-AST-041-01"]
      - id: "FA-UC01-02"
        condicao: "tipo_entrada_devolucao"
        passos:
          - passo: 1
            ator: "almoxarife"
            acao: "seleciona_ativo_vinculado"
            origem: "RF028"
          - passo: 2
            ator: "sistema"
            acao: "valida_ativo_existe_pode_ser_devolvido"
          - passo: 3
            ator: "sistema"
            acao: "preenche_campos_automaticamente"
            campos_preenchidos: ["Categoria", "Marca", "Modelo", "IMEI/SN"]
        regras: ["RN-AST-041-02"]
      - id: "FA-UC01-03"
        condicao: "tipo_entrada_ajuste_manual"
        passos:
          - passo: 1
            ator: "almoxarife"
            acao: "preenche_justificativa"
            validacao: "Mínimo 20 caracteres"
          - passo: 2
            ator: "sistema"
            acao: "verifica_quantidade_ajuste"
          - passo: 3
            ator: "sistema"
            acao: "se_quantidade_maior_10_exige_aprovacao_gestor"
            workflow: "Status Aguardando Aprovação até aprovação do gestor"
        regras: ["RN-AST-041-03", "RN-AST-041-04"]
    fluxos_excecao:
      - id: "FE-UC01-01"
        condicao: "compra_sem_nf_vinculada"
        passos:
          - passo: 1
            ator: "sistema"
            acao: "valida_campo_nota_fiscal_obrigatorio"
          - passo: 2
            ator: "sistema"
            acao: "retorna_erro_http_400"
            mensagem: "Entrada de compra deve ser vinculada a nota fiscal (RF039)"
        regras: ["RN-AST-041-01"]
      - id: "FE-UC01-02"
        condicao: "devolucao_sem_ativo_vinculado"
        passos:
          - passo: 1
            ator: "sistema"
            acao: "valida_campo_ativo_obrigatorio"
          - passo: 2
            ator: "sistema"
            acao: "retorna_erro_http_400"
            mensagem: "Entrada de devolução deve ser vinculada a ativo existente (RF028)"
        regras: ["RN-AST-041-02"]
      - id: "FE-UC01-03"
        condicao: "ajuste_manual_sem_justificativa"
        passos:
          - passo: 1
            ator: "sistema"
            acao: "valida_campo_justificativa_minimo_20_chars"
          - passo: 2
            ator: "sistema"
            acao: "retorna_erro_http_400"
            mensagem: "Ajuste manual requer justificativa obrigatória (mínimo 20 caracteres)"
        regras: ["RN-AST-041-03"]
    pos_condicoes:
      - saldo_fisico_incrementado: true
      - saldo_disponivel_incrementado: true
      - movimentacao_auditada: true
      - retention_auditoria_2555_dias: true
    regras_aplicadas:
      - "RN-AST-041-01"
      - "RN-AST-041-02"
      - "RN-AST-041-03"
      - "RN-AST-041-04"
      - "RN-AST-041-05"

  - id: "UC02"
    nome: "Registrar Saída de Aparelhos"
    ator_principal: "almoxarife_ou_gestor_estoque"
    tipo: "crud"
    impacta_dados: true
    covers:
      documentacao_items:
        - "RN-AST-041-05"  # Auditoria completa
        - "RN-AST-041-06"  # Saída não excede saldo disponível
        - "RN-AST-041-07"  # Distribuição cria ativo automaticamente
        - "RN-AST-041-08"  # Descarte requer motivo e laudo
        - "RN-AST-041-09"  # Saída >10 unidades requer aprovação
        - "RN-AST-041-10"  # Rastreáveis devem ter saída individual
      uc_items:
        - id: "FP-UC02-001"
          title: "Almoxarife acessa tela de saída de aparelhos"
          required: true
        - id: "FP-UC02-002"
          title: "Sistema exibe formulário com tipo de saída (Distribuição/Venda/Descarte/Transferência/Ajuste)"
          required: true
        - id: "FP-UC02-003"
          title: "Almoxarife seleciona tipo de saída"
          required: true
        - id: "FP-UC02-004"
          title: "Sistema exibe campos específicos do tipo selecionado"
          required: true
        - id: "FP-UC02-005"
          title: "Almoxarife preenche dados e confirma"
          required: true
        - id: "FP-UC02-006"
          title: "Sistema valida saldo disponível suficiente"
          required: true
        - id: "FP-UC02-007"
          title: "Sistema decrementa saldo físico e disponível"
          required: true
        - id: "FP-UC02-008"
          title: "Sistema registra movimentação com auditoria completa"
          required: true
        - id: "FA-UC02-01"
          title: "Saída tipo Distribuição - criar ativo automaticamente (RF028)"
          required: false
        - id: "FA-UC02-02"
          title: "Saída tipo Descarte - exigir motivo e anexo laudo PDF"
          required: false
        - id: "FA-UC02-03"
          title: "Saída >10 unidades - workflow de aprovação gestor"
          required: false
        - id: "FA-UC02-04"
          title: "Aparelho rastreável - exigir IMEI/SN e saída individual"
          required: false
        - id: "FE-UC02-01"
          title: "Saldo insuficiente - sistema rejeita (HTTP 400)"
          required: true
        - id: "FE-UC02-02"
          title: "Descarte sem motivo - sistema rejeita (HTTP 400)"
          required: true
        - id: "FE-UC02-03"
          title: "Falha na criação de ativo (Distribuição) - rollback de transação"
          required: true
    precondicoes:
      - permissao: "GES.ESTOQUE.SAIDA.CREATE"
      - usuario_autenticado: true
      - almoxarifado_ativo: true
    fluxo_principal:
      - passo: 1
        ator: "almoxarife"
        acao: "acessa_tela_saida_aparelhos"
      - passo: 2
        ator: "sistema"
        acao: "exibe_formulario_saida"
        campos: ["Tipo Saída*", "Almoxarifado*", "Categoria*", "Marca*", "Modelo*", "Quantidade*", "IMEI/SN (se rastreável)", "Destinatário", "Observações"]
      - passo: 3
        ator: "almoxarife"
        acao: "seleciona_tipo_saida"
        tipos: ["Distribuição", "Venda", "Descarte", "Transferência Enviada", "Ajuste Manual"]
      - passo: 4
        ator: "sistema"
        acao: "exibe_campos_especificos_tipo"
        regras_condicionais:
          - se: "tipo = Distribuição"
            entao: "exibir campos Usuário Destinatário, Centro de Custo (para criar ativo RF028)"
          - se: "tipo = Descarte"
            entao: "exibir campo Motivo (obrigatório) e upload Laudo PDF"
          - se: "tipo = Ajuste Manual"
            entao: "exibir campo Justificativa (obrigatório, mínimo 20 chars)"
      - passo: 5
        ator: "almoxarife"
        acao: "preenche_dados_confirma"
      - passo: 6
        ator: "sistema"
        acao: "valida_saldo_disponivel_suficiente"
        validacao: "quantidade_saida <= saldo_disponivel"
      - passo: 7
        ator: "sistema"
        acao: "decrementa_saldo_fisico_disponivel"
      - passo: 8
        ator: "sistema"
        acao: "registra_movimentacao_auditoria"
        dados_auditados: ["Usuario", "IP", "DataHora", "DadosAntes", "DadosDepois", "Acao"]
      - passo: 9
        ator: "sistema"
        acao: "exibe_mensagem_sucesso"
    fluxos_alternativos:
      - id: "FA-UC02-01"
        condicao: "tipo_saida_distribuicao"
        passos:
          - passo: 1
            ator: "almoxarife"
            acao: "preenche_dados_destinatario"
            campos: ["Usuário Destinatário", "Centro de Custo", "Data Alocação"]
          - passo: 2
            ator: "sistema"
            acao: "chama_rf028_criar_ativo_automaticamente"
            dados_ativo: ["Categoria", "Marca", "Modelo", "IMEI/SN", "Usuário", "Centro de custo"]
            status_inicial: "Ativo ou Em Uso"
          - passo: 3
            ator: "sistema"
            acao: "vincula_ativo_movimentacao_saida"
            vinculo_bidirecional: "Ativo guarda ID da movimentação de saída"
          - passo: 4
            ator: "sistema"
            acao: "se_criacao_ativo_falhar_rollback_transacao"
        regras: ["RN-AST-041-07"]
      - id: "FA-UC02-02"
        condicao: "tipo_saida_descarte"
        passos:
          - passo: 1
            ator: "almoxarife"
            acao: "preenche_motivo_descarte"
            validacao: "Campo obrigatório"
          - passo: 2
            ator: "almoxarife"
            acao: "anexa_laudo_descarte_pdf"
            opcional: "Se aplicável"
          - passo: 3
            ator: "sistema"
            acao: "armazena_laudo_vinculado_movimentacao"
        regras: ["RN-AST-041-08"]
      - id: "FA-UC02-03"
        condicao: "saida_quantidade_maior_10"
        passos:
          - passo: 1
            ator: "sistema"
            acao: "verifica_quantidade_saida"
          - passo: 2
            ator: "sistema"
            acao: "se_quantidade_maior_10_exige_aprovacao_gestor"
            workflow: "Status Aguardando Aprovação até aprovação do gestor"
        regras: ["RN-AST-041-09"]
      - id: "FA-UC02-04"
        condicao: "aparelho_rastreavel"
        passos:
          - passo: 1
            ator: "sistema"
            acao: "verifica_categoria_rastreavel"
          - passo: 2
            ator: "sistema"
            acao: "exige_imei_sn_obrigatorio"
            validacao: "Campo IMEI/SN obrigatório se categoria = Rastreável"
          - passo: 3
            ator: "sistema"
            acao: "permite_apenas_saida_individual"
            validacao: "Uma saída por aparelho"
        regras: ["RN-AST-041-10"]
    fluxos_excecao:
      - id: "FE-UC02-01"
        condicao: "saldo_insuficiente"
        passos:
          - passo: 1
            ator: "sistema"
            acao: "valida_quantidade_saida_saldo_disponivel"
          - passo: 2
            ator: "sistema"
            acao: "retorna_erro_http_400"
            mensagem: "Saída não pode exceder saldo disponível no almoxarifado"
        regras: ["RN-AST-041-06"]
      - id: "FE-UC02-02"
        condicao: "descarte_sem_motivo"
        passos:
          - passo: 1
            ator: "sistema"
            acao: "valida_campo_motivo_obrigatorio"
          - passo: 2
            ator: "sistema"
            acao: "retorna_erro_http_400"
            mensagem: "Saída por descarte requer motivo obrigatório"
        regras: ["RN-AST-041-08"]
      - id: "FE-UC02-03"
        condicao: "falha_criacao_ativo_distribuicao"
        passos:
          - passo: 1
            ator: "sistema"
            acao: "inicia_transacao_banco"
          - passo: 2
            ator: "sistema"
            acao: "tenta_criar_ativo_rf028"
          - passo: 3
            ator: "sistema"
            acao: "se_falhar_rollback_transacao"
            mensagem: "Falha ao criar ativo automaticamente. Movimentação cancelada."
        regras: ["RN-AST-041-07"]
    pos_condicoes:
      - saldo_fisico_decrementado: true
      - saldo_disponivel_decrementado: true
      - movimentacao_auditada: true
      - ativo_criado_se_distribuicao: true
    regras_aplicadas:
      - "RN-AST-041-05"
      - "RN-AST-041-06"
      - "RN-AST-041-07"
      - "RN-AST-041-08"
      - "RN-AST-041-09"
      - "RN-AST-041-10"

  - id: "UC03"
    nome: "Transferir entre Almoxarifados"
    ator_principal: "almoxarife_gestor_origem_destino"
    tipo: "workflow"
    impacta_dados: true
    covers:
      documentacao_items:
        - "RN-AST-041-05"  # Auditoria completa
        - "RN-AST-041-06"  # Validação saldo disponível
        - "RN-AST-041-11"  # Transferência requer aprovação gestor origem
        - "RN-AST-041-12"  # Saldo deduzido após confirmação envio
        - "RN-AST-041-13"  # Saldo adicionado após confirmação recebimento
        - "RN-AST-041-14"  # Alerta transferência >15 dias
        - "RN-AST-041-15"  # Recebimento deve conferir quantidade
      uc_items:
        - id: "FP-UC03-001"
          title: "Almoxarife origem solicita transferência"
          required: true
        - id: "FP-UC03-002"
          title: "Sistema exibe formulário de transferência"
          required: true
        - id: "FP-UC03-003"
          title: "Almoxarife preenche origem, destino, quantidade e confirma"
          required: true
        - id: "FP-UC03-004"
          title: "Sistema cria transferência com status Aguardando Aprovação"
          required: true
        - id: "FP-UC03-005"
          title: "Gestor origem aprova transferência"
          required: true
        - id: "FP-UC03-006"
          title: "Sistema muda status para Aguardando Envio"
          required: true
        - id: "FP-UC03-007"
          title: "Almoxarife origem confirma envio"
          required: true
        - id: "FP-UC03-008"
          title: "Sistema decrementa saldo origem e muda status para Em Trânsito"
          required: true
        - id: "FP-UC03-009"
          title: "Almoxarife destino confirma recebimento"
          required: true
        - id: "FP-UC03-010"
          title: "Sistema incrementa saldo destino e muda status para Concluída"
          required: true
        - id: "FA-UC03-01"
          title: "Divergência na quantidade recebida - exigir justificativa"
          required: false
        - id: "FA-UC03-02"
          title: "Transferência em trânsito >15 dias - alerta automático"
          required: false
        - id: "FE-UC03-01"
          title: "Saldo insuficiente na origem - sistema rejeita (HTTP 400)"
          required: true
    precondicoes:
      - permissao_solicitacao: "GES.ESTOQUE.TRANSFERENCIA.CREATE"
      - permissao_recebimento: "GES.ESTOQUE.TRANSFERENCIA.RECEIVE"
      - usuario_autenticado: true
      - almoxarifados_origem_destino_ativos: true
    fluxo_principal:
      - passo: 1
        ator: "almoxarife_origem"
        acao: "acessa_tela_transferencia"
      - passo: 2
        ator: "sistema"
        acao: "exibe_formulario_transferencia"
        campos: ["Almoxarifado Origem*", "Almoxarifado Destino*", "Categoria*", "Marca*", "Modelo*", "Quantidade*", "Responsável Recebimento", "Observações"]
      - passo: 3
        ator: "almoxarife_origem"
        acao: "preenche_dados_confirma"
      - passo: 4
        ator: "sistema"
        acao: "valida_saldo_disponivel_origem"
        validacao: "quantidade_transferencia <= saldo_disponivel_origem"
      - passo: 5
        ator: "sistema"
        acao: "cria_transferencia_status_aguardando_aprovacao"
        observacao: "Saldo NÃO é deduzido ainda"
      - passo: 6
        ator: "sistema"
        acao: "notifica_gestor_origem_aprovar"
      - passo: 7
        ator: "gestor_origem"
        acao: "revisa_transferencia_aprova"
      - passo: 8
        ator: "sistema"
        acao: "muda_status_aguardando_envio"
        observacao: "Saldo ainda NÃO é deduzido"
      - passo: 9
        ator: "almoxarife_origem"
        acao: "confirma_envio_fisico"
      - passo: 10
        ator: "sistema"
        acao: "decrementa_saldo_origem"
        observacao: "Saldo deduzido APENAS agora"
      - passo: 11
        ator: "sistema"
        acao: "muda_status_em_transito"
      - passo: 12
        ator: "sistema"
        acao: "notifica_almoxarife_destino_conferir"
      - passo: 13
        ator: "almoxarife_destino"
        acao: "confere_quantidade_recebida"
      - passo: 14
        ator: "almoxarife_destino"
        acao: "confirma_recebimento"
      - passo: 15
        ator: "sistema"
        acao: "incrementa_saldo_destino"
        observacao: "Saldo adicionado APENAS agora"
      - passo: 16
        ator: "sistema"
        acao: "muda_status_concluida"
    fluxos_alternativos:
      - id: "FA-UC03-01"
        condicao: "divergencia_quantidade_recebida"
        passos:
          - passo: 1
            ator: "almoxarife_destino"
            acao: "informa_quantidade_recebida_diferente_enviada"
          - passo: 2
            ator: "sistema"
            acao: "exige_justificativa_divergencia"
            validacao: "Campo Justificativa Divergência obrigatório se quantidade_recebida ≠ quantidade_enviada"
          - passo: 3
            ator: "sistema"
            acao: "incrementa_saldo_destino_com_quantidade_real_recebida"
          - passo: 4
            ator: "sistema"
            acao: "registra_auditoria_divergencia"
        regras: ["RN-AST-041-15"]
      - id: "FA-UC03-02"
        condicao: "transferencia_em_transito_maior_15_dias"
        passos:
          - passo: 1
            ator: "job_hangfire_noturno"
            acao: "verifica_transferencias_em_transito"
          - passo: 2
            ator: "sistema"
            acao: "identifica_transferencias_data_envio_maior_15_dias"
          - passo: 3
            ator: "sistema"
            acao: "notifica_gestor_origem_destino"
            canais: ["Email", "In-App via RF066"]
            mensagem: "Transferência #{ID} está em trânsito há mais de 15 dias"
        regras: ["RN-AST-041-14"]
    fluxos_excecao:
      - id: "FE-UC03-01"
        condicao: "saldo_insuficiente_origem"
        passos:
          - passo: 1
            ator: "sistema"
            acao: "valida_quantidade_transferencia_saldo_disponivel_origem"
          - passo: 2
            ator: "sistema"
            acao: "retorna_erro_http_400"
            mensagem: "Transferência não pode exceder saldo disponível no almoxarifado de origem"
        regras: ["RN-AST-041-06"]
    pos_condicoes:
      - saldo_origem_decrementado_apenas_apos_confirmacao_envio: true
      - saldo_destino_incrementado_apenas_apos_confirmacao_recebimento: true
      - workflow_auditado_completo: true
    regras_aplicadas:
      - "RN-AST-041-05"
      - "RN-AST-041-06"
      - "RN-AST-041-11"
      - "RN-AST-041-12"
      - "RN-AST-041-13"
      - "RN-AST-041-14"
      - "RN-AST-041-15"

  - id: "UC04"
    nome: "Criar Reserva de Aparelhos"
    ator_principal: "gestor_estoque"
    tipo: "crud"
    impacta_dados: true
    covers:
      documentacao_items:
        - "RN-AST-041-05"  # Auditoria completa
        - "RN-AST-041-20"  # Reserva não excede saldo disponível
        - "RN-AST-041-21"  # Reserva validade máxima 30 dias
        - "RN-AST-041-22"  # Reserva expirada libera saldo
        - "RN-AST-041-23"  # Cancelamento reserva requer justificativa
        - "RN-AST-041-24"  # Job noturno reservas expiradas
        - "RN-AST-041-25"  # Job níveis estoque cada 1 hora
        - "RN-AST-041-26"  # Alertas email + in-app
        - "RN-AST-041-27"  # Alerta não reenviado até normalização
        - "RN-AST-041-28"  # Configuração níveis permissão gestor
      uc_items:
        - id: "FP-UC04-001"
          title: "Gestor acessa tela de reservas"
          required: true
        - id: "FP-UC04-002"
          title: "Sistema exibe formulário de reserva"
          required: true
        - id: "FP-UC04-003"
          title: "Gestor preenche dados e confirma"
          required: true
        - id: "FP-UC04-004"
          title: "Sistema valida saldo disponível suficiente"
          required: true
        - id: "FP-UC04-005"
          title: "Sistema bloqueia saldo (não altera físico, apenas disponível)"
          required: true
        - id: "FP-UC04-006"
          title: "Sistema cria reserva com status Ativa"
          required: true
        - id: "FA-UC04-01"
          title: "Consumo de reserva ao distribuir para destinatário"
          required: false
        - id: "FA-UC04-02"
          title: "Cancelamento de reserva com justificativa"
          required: false
        - id: "FA-UC04-03"
          title: "Job noturno expira reservas vencidas"
          required: false
        - id: "FA-UC04-04"
          title: "Notificação 3 dias antes da expiração"
          required: false
        - id: "FA-UC04-05"
          title: "Configurar alertas de estoque mínimo/máximo"
          required: false
        - id: "FA-UC04-06"
          title: "Job a cada 1 hora verifica níveis de estoque"
          required: false
        - id: "FE-UC04-01"
          title: "Saldo insuficiente - sistema rejeita (HTTP 400)"
          required: true
        - id: "FE-UC04-02"
          title: "Validade >30 dias - sistema rejeita (HTTP 400)"
          required: true
    precondicoes:
      - permissao_criar: "GES.ESTOQUE.RESERVA.CREATE"
      - permissao_cancelar: "GES.ESTOQUE.RESERVA.CANCEL"
      - permissao_config_alertas: "GES.ESTOQUE.ALERTAS.CONFIG"
      - usuario_autenticado: true
    fluxo_principal:
      - passo: 1
        ator: "gestor_estoque"
        acao: "acessa_tela_reservas"
      - passo: 2
        ator: "sistema"
        acao: "exibe_formulario_reserva"
        campos: ["Almoxarifado*", "Categoria*", "Marca*", "Modelo*", "Quantidade*", "Destinatário", "Data Validade* (máx 30 dias)", "Observações"]
      - passo: 3
        ator: "gestor_estoque"
        acao: "preenche_dados_confirma"
      - passo: 4
        ator: "sistema"
        acao: "valida_saldo_disponivel_nao_reservado"
        validacao: "quantidade_reserva <= saldo_disponivel"
      - passo: 5
        ator: "sistema"
        acao: "valida_data_validade_maxima_30_dias"
        validacao: "data_validade <= data_criacao + 30 dias"
      - passo: 6
        ator: "sistema"
        acao: "bloqueia_saldo_disponivel"
        observacao: "Saldo físico NÃO é alterado, apenas disponível é decrementado"
      - passo: 7
        ator: "sistema"
        acao: "cria_reserva_status_ativa"
      - passo: 8
        ator: "sistema"
        acao: "registra_auditoria"
    fluxos_alternativos:
      - id: "FA-UC04-01"
        condicao: "consumo_reserva_distribuicao"
        passos:
          - passo: 1
            ator: "almoxarife"
            acao: "registra_saida_distribuicao_para_destinatario_reserva"
          - passo: 2
            ator: "sistema"
            acao: "identifica_reserva_ativa_destinatario"
          - passo: 3
            ator: "sistema"
            acao: "consome_reserva_automaticamente"
            acao_detalhada: "Muda status para Consumida, libera saldo reservado restante"
        regras: []
      - id: "FA-UC04-02"
        condicao: "cancelamento_reserva"
        passos:
          - passo: 1
            ator: "gestor_estoque"
            acao: "solicita_cancelamento_reserva"
          - passo: 2
            ator: "sistema"
            acao: "exige_justificativa_cancelamento"
            validacao: "Campo Motivo do Cancelamento mínimo 20 caracteres"
          - passo: 3
            ator: "gestor_estoque"
            acao: "preenche_justificativa_confirma"
          - passo: 4
            ator: "sistema"
            acao: "libera_saldo_bloqueado"
          - passo: 5
            ator: "sistema"
            acao: "muda_status_cancelada"
        regras: ["RN-AST-041-23"]
      - id: "FA-UC04-03"
        condicao: "job_noturno_reservas_expiradas"
        passos:
          - passo: 1
            ator: "job_hangfire_02h00"
            acao: "executa_diariamente_verifica_reservas_expiradas"
          - passo: 2
            ator: "sistema"
            acao: "identifica_reservas_data_validade_vencida"
          - passo: 3
            ator: "sistema"
            acao: "muda_status_expirada"
          - passo: 4
            ator: "sistema"
            acao: "libera_saldo_bloqueado_automaticamente"
          - passo: 5
            ator: "sistema"
            acao: "notifica_gestor_reservas_expiradas"
        regras: ["RN-AST-041-22", "RN-AST-041-24"]
      - id: "FA-UC04-04"
        condicao: "notificacao_expiracao_3_dias"
        passos:
          - passo: 1
            ator: "job_hangfire_02h00"
            acao: "verifica_reservas_validade_proxima_3_dias"
          - passo: 2
            ator: "sistema"
            acao: "notifica_gestor_via_email_in_app"
            mensagem: "Reserva #{ID} expira em 3 dias. Consumir ou cancelar."
        regras: []
      - id: "FA-UC04-05"
        condicao: "configurar_alertas_estoque_minimo_maximo"
        passos:
          - passo: 1
            ator: "gestor_estoque"
            acao: "acessa_tela_configuracao_alertas"
          - passo: 2
            ator: "sistema"
            acao: "exibe_formulario_config_alertas"
            campos: ["Categoria*", "Almoxarifado*", "Estoque Mínimo*", "Estoque Máximo*", "Destinatários Email*"]
          - passo: 3
            ator: "gestor_estoque"
            acao: "preenche_niveis_confirma"
          - passo: 4
            ator: "sistema"
            acao: "salva_configuracao_alertas"
        regras: ["RN-AST-041-28"]
      - id: "FA-UC04-06"
        condicao: "job_verificacao_niveis_estoque_1_hora"
        passos:
          - passo: 1
            ator: "job_hangfire_a_cada_1_hora"
            acao: "verifica_saldo_vs_niveis_configurados"
          - passo: 2
            ator: "sistema"
            acao: "identifica_saldos_abaixo_minimo_ou_acima_maximo"
          - passo: 3
            ator: "sistema"
            acao: "envia_alertas_via_email_in_app"
            tipos_alerta:
              - "Estoque Baixo (saldo = estoque_minimo)"
              - "Estoque Crítico (saldo < 50% estoque_minimo)"
              - "Estoque Excedente (saldo >= estoque_maximo)"
          - passo: 4
            ator: "sistema"
            acao: "registra_ultima_data_envio_alerta"
            observacao: "Não reenvia até saldo normalizar e cair novamente"
        regras: ["RN-AST-041-25", "RN-AST-041-26", "RN-AST-041-27"]
    fluxos_excecao:
      - id: "FE-UC04-01"
        condicao: "saldo_insuficiente"
        passos:
          - passo: 1
            ator: "sistema"
            acao: "valida_quantidade_reserva_saldo_disponivel"
          - passo: 2
            ator: "sistema"
            acao: "retorna_erro_http_400"
            mensagem: "Reserva não pode exceder saldo disponível (não reservado)"
        regras: ["RN-AST-041-20"]
      - id: "FE-UC04-02"
        condicao: "validade_maior_30_dias"
        passos:
          - passo: 1
            ator: "sistema"
            acao: "valida_data_validade_limite_30_dias"
          - passo: 2
            ator: "sistema"
            acao: "retorna_erro_http_400"
            mensagem: "Reserva tem validade máxima de 30 dias"
        regras: ["RN-AST-041-21"]
    pos_condicoes:
      - saldo_disponivel_decrementado: true
      - saldo_fisico_inalterado: true
      - reserva_criada_status_ativa: true
      - auditoria_completa: true
    regras_aplicadas:
      - "RN-AST-041-05"
      - "RN-AST-041-20"
      - "RN-AST-041-21"
      - "RN-AST-041-22"
      - "RN-AST-041-23"
      - "RN-AST-041-24"
      - "RN-AST-041-25"
      - "RN-AST-041-26"
      - "RN-AST-041-27"
      - "RN-AST-041-28"

rastreabilidade:
  documentacao_para_uc:
    - documentacao_item: "RN-AST-041-01"
      coberto_por: ["UC01"]
      gap: false
    - documentacao_item: "RN-AST-041-02"
      coberto_por: ["UC01"]
      gap: false
    - documentacao_item: "RN-AST-041-03"
      coberto_por: ["UC01"]
      gap: false
    - documentacao_item: "RN-AST-041-04"
      coberto_por: ["UC01"]
      gap: false
    - documentacao_item: "RN-AST-041-05"
      coberto_por: ["UC00", "UC01", "UC02", "UC03", "UC04"]
      gap: false
    - documentacao_item: "RN-AST-041-06"
      coberto_por: ["UC02", "UC03"]
      gap: false
    - documentacao_item: "RN-AST-041-07"
      coberto_por: ["UC02"]
      gap: false
    - documentacao_item: "RN-AST-041-08"
      coberto_por: ["UC02"]
      gap: false
    - documentacao_item: "RN-AST-041-09"
      coberto_por: ["UC02"]
      gap: false
    - documentacao_item: "RN-AST-041-10"
      coberto_por: ["UC02"]
      gap: false
    - documentacao_item: "RN-AST-041-11"
      coberto_por: ["UC03"]
      gap: false
    - documentacao_item: "RN-AST-041-12"
      coberto_por: ["UC03"]
      gap: false
    - documentacao_item: "RN-AST-041-13"
      coberto_por: ["UC03"]
      gap: false
    - documentacao_item: "RN-AST-041-14"
      coberto_por: ["UC03"]
      gap: false
    - documentacao_item: "RN-AST-041-15"
      coberto_por: ["UC03"]
      gap: false
    - documentacao_item: "RN-AST-041-16"
      coberto_por: ["UC00"]
      gap: false
    - documentacao_item: "RN-AST-041-17"
      coberto_por: ["UC00"]
      gap: false
    - documentacao_item: "RN-AST-041-18"
      coberto_por: ["UC00"]
      gap: false
    - documentacao_item: "RN-AST-041-19"
      coberto_por: ["UC00"]
      gap: false
    - documentacao_item: "RN-AST-041-20"
      coberto_por: ["UC04"]
      gap: false
    - documentacao_item: "RN-AST-041-21"
      coberto_por: ["UC04"]
      gap: false
    - documentacao_item: "RN-AST-041-22"
      coberto_por: ["UC04"]
      gap: false
    - documentacao_item: "RN-AST-041-23"
      coberto_por: ["UC04"]
      gap: false
    - documentacao_item: "RN-AST-041-24"
      coberto_por: ["UC04"]
      gap: false
    - documentacao_item: "RN-AST-041-25"
      coberto_por: ["UC04"]
      gap: false
    - documentacao_item: "RN-AST-041-26"
      coberto_por: ["UC04"]
      gap: false
    - documentacao_item: "RN-AST-041-27"
      coberto_por: ["UC04"]
      gap: false
    - documentacao_item: "RN-AST-041-28"
      coberto_por: ["UC04"]
      gap: false

exclusions:
  uc_items: []

historico:
  - versao: "1.0"
    data: "2025-12-31"
    autor: "Agência ALC - alc.dev.br"
    mudancas: "Criação inicial do UC-RF041.yaml com 5 UCs cobrindo 28 regras de negócio"
    detalhes: |
      UC00: Consultar Saldo de Estoque
      - Cobre: RN-AST-041-05, 16, 17, 18, 19 (5 regras)
      - Consultas filtros avançados, exportação, rastreamento IMEI

      UC01: Registrar Entrada de Aparelhos
      - Cobre: RN-AST-041-01, 02, 03, 04, 05 (5 regras)
      - Tipos: Compra (vinculada NF), Devolução (vinculada Ativo), Transferência, Ajuste (>10 aprovação)

      UC02: Registrar Saída de Aparelhos
      - Cobre: RN-AST-041-05, 06, 07, 08, 09, 10 (6 regras)
      - Tipos: Distribuição (cria Ativo RF028), Venda, Descarte (laudo), Transferência, Ajuste
      - Rastreáveis exigem IMEI/SN individual

      UC03: Transferir entre Almoxarifados
      - Cobre: RN-AST-041-05, 06, 11, 12, 13, 14, 15 (7 regras)
      - Workflow 3 etapas: Solicitação → Aprovação → Envio → Recebimento
      - Saldo deduzido apenas após confirmação envio
      - Saldo adicionado apenas após confirmação recebimento
      - Alerta automático >15 dias em trânsito

      UC04: Criar Reserva de Aparelhos
      - Cobre: RN-AST-041-05, 20, 21, 22, 23, 24, 25, 26, 27, 28 (10 regras)
      - Bloqueio saldo disponível (não altera físico)
      - Validade máxima 30 dias com expiração automática
      - Consumo automático na distribuição
      - Configuração alertas estoque mínimo/máximo
      - Job a cada 1 hora verifica níveis
      - Alertas email + in-app (RF066)

      Cobertura: 28/28 regras (100%)
