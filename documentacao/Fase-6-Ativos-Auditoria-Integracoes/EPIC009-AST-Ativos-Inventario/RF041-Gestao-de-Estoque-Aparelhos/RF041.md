# RF041: Gest√£o de Estoque de Aparelhos

**Vers√£o**: 2.0 | **Data**: 2025-12-30 | **Status**: üü° Em Elabora√ß√£o | **M√≥dulo**: Gest√£o - Estoque Operacional

---

## 1. Vis√£o Geral

### 1.1. Objetivo

Gerenciar operacionalmente o estoque de aparelhos e equipamentos (smartphones, tablets, notebooks, desktops, acess√≥rios), incluindo entrada, sa√≠da, transfer√™ncia entre almoxarifados, consultas de saldo, movimenta√ß√µes e rastreabilidade completa do ciclo de vida de cada item.

### 1.2. Import√¢ncia Estrat√©gica

- **Controle Operacional**: Visibilidade em tempo real do saldo f√≠sico e dispon√≠vel por almoxarifado
- **Rastreabilidade**: Hist√≥rico imut√°vel de cada movimenta√ß√£o com usu√°rio, data, motivo e destino
- **Integra√ß√£o**: Cria√ß√£o autom√°tica de ativos (RF028) quando aparelho sai do estoque para distribui√ß√£o
- **Gest√£o Proativa**: Alertas autom√°ticos de estoque m√≠nimo/m√°ximo para evitar ruptura ou excesso
- **Compliance Fiscal**: Auditoria completa com reten√ß√£o de 7 anos para atender legisla√ß√£o

### 1.3. Escopo

**Inclu√≠do**:
- Registro de entrada de aparelhos no estoque (compra, devolu√ß√£o, recebimento)
- Registro de sa√≠da de aparelhos (distribui√ß√£o, venda, descarte)
- Transfer√™ncia entre almoxarifados/filiais com workflow de aprova√ß√£o
- Consulta de saldo por almoxarifado, categoria, marca, modelo
- Hist√≥rico de movimenta√ß√µes por aparelho (imut√°vel)
- Reserva de aparelhos para distribui√ß√£o futura
- Alertas de estoque m√≠nimo/m√°ximo
- Rastreabilidade completa por IMEI/Serial Number
- Integra√ß√£o com Gest√£o de Ativos (RF028) para vincular aparelhos a usu√°rios

**Exclu√≠do** (coberto por outros RFs):
- Invent√°rio c√≠clico e auditoria de estoque ‚Üí **RF068-Inventario-Ciclico-Auditoria-Estoque**
- Cadastro de categorias de ativos ‚Üí **RF019-Gestao-de-Tipos-de-Ativos**
- Cadastro de marcas e modelos ‚Üí **RF104-Gestao-Marcas-Modelos** (n√£o implementado)
- Gest√£o de fornecedores ‚Üí **RF022-Gestao-de-Fornecedores**
- Recebimento de notas fiscais ‚Üí **RF039-Gestao-Notas-Fiscais** (n√£o implementado)

### 1.4. Rela√ß√£o com Outros RFs

- **RF068** (Invent√°rio C√≠clico): RF068 faz a **auditoria peri√≥dica** do estoque (contagem f√≠sica, concilia√ß√£o). RF041 faz a **gest√£o operacional di√°ria** (entradas, sa√≠das, movimenta√ß√µes).
- **RF028** (Gest√£o de Ativos): Quando aparelho SAI do estoque para ser distribu√≠do, cria-se um Ativo no RF028 vinculado ao usu√°rio.
- **RF019** (Tipos de Ativos): RF041 consulta categorias cadastradas no RF019.
- **RF022** (Fornecedores): Entrada de estoque pode ser vinculada a fornecedor do RF022.

---

## 2. Funcionalidades

### 2.1. Entrada de Aparelhos no Estoque

**ID**: F-AST-041-01

**Descri√ß√£o**: Registrar entrada de aparelhos no almoxarifado com tipos espec√≠ficos (compra, devolu√ß√£o, transfer√™ncia recebida, ajuste manual).

**Tipos de Entrada**:
- **Compra**: Recebimento de fornecedor (vinculada a NF)
- **Devolu√ß√£o**: Usu√°rio devolve aparelho (vinculada a Ativo)
- **Transfer√™ncia Recebida**: Recebimento de outro almoxarifado
- **Ajuste Manual**: Corre√ß√£o de saldo (requer justificativa e aprova√ß√£o)

**Fluxo Principal**:
1. Usu√°rio acessa tela "Entrada de Estoque"
2. Sistema exibe formul√°rio com campos: Almoxarifado destino, Tipo de entrada, Categoria, Marca, Modelo, Quantidade, IMEI/Serial (se rastre√°vel), Fornecedor (se compra), Nota fiscal (se compra), Observa√ß√µes
3. Usu√°rio preenche campos obrigat√≥rios
4. Sistema valida entrada conforme tipo selecionado (RN-AST-041-01, RN-AST-041-02, RN-AST-041-03)
5. Se ajuste > 10 unidades: Sistema cria workflow de aprova√ß√£o (RN-AST-041-04)
6. Usu√°rio clica "Salvar"
7. Sistema registra entrada no banco de dados
8. Sistema atualiza saldo f√≠sico do almoxarifado (quantidade_fisica + quantidade_entrada)
9. Sistema recalcula custo m√©dio se entrada de compra
10. Sistema cria registro de auditoria com usu√°rio, IP, timestamp
11. Sistema exibe mensagem de sucesso
12. Se estoque atingir m√°ximo configurado: Sistema notifica gestor via RF066

**Atores**: Almoxarife, Gestor de Estoque

**Pr√©-condi√ß√µes**: Usu√°rio autenticado com permiss√£o `GES.ESTOQUE.ENTRADA.CREATE`; Almoxarifado cadastrado; Categoria/Marca/Modelo cadastrados

**P√≥s-condi√ß√µes**: Entrada registrada; saldo atualizado; auditoria criada; gestor notificado (se aplic√°vel)

---

### 2.2. Sa√≠da de Aparelhos do Estoque

**ID**: F-AST-041-02

**Descri√ß√£o**: Registrar sa√≠da de aparelhos do almoxarifado com cria√ß√£o autom√°tica de ativo (se distribui√ß√£o).

**Tipos de Sa√≠da**:
- **Distribui√ß√£o**: Entregar aparelho a usu√°rio (cria Ativo no RF028)
- **Venda**: Venda de aparelho (gera faturamento no RF-FAT)
- **Descarte**: Descarte/sucateamento de aparelho
- **Transfer√™ncia Enviada**: Envio para outro almoxarifado
- **Ajuste Manual**: Corre√ß√£o de saldo (requer justificativa e aprova√ß√£o)

**Fluxo Principal**:
1. Usu√°rio acessa tela "Sa√≠da de Estoque"
2. Sistema exibe formul√°rio com campos: Almoxarifado origem, Tipo de sa√≠da, Categoria, Marca, Modelo, Quantidade, IMEI/Serial, Destinat√°rio (usu√°rio/filial), Motivo da sa√≠da, Centro de custo (se distribui√ß√£o), Observa√ß√µes
3. Usu√°rio preenche campos obrigat√≥rios
4. Sistema valida saldo dispon√≠vel (RN-AST-041-06: quantidade_saida <= saldo_disponivel)
5. Se ajuste > 10 unidades: Sistema cria workflow de aprova√ß√£o (RN-AST-041-09)
6. Se descarte: Sistema valida motivo obrigat√≥rio e permite upload de laudo (RN-AST-041-08)
7. Usu√°rio clica "Salvar"
8. Sistema registra sa√≠da no banco de dados
9. Sistema atualiza saldo f√≠sico do almoxarifado (quantidade_fisica - quantidade_saida)
10. **Se tipo = "Distribui√ß√£o"**: Sistema chama endpoint do RF028 para criar ativo automaticamente (RN-AST-041-07)
    - Dados do ativo: Categoria, Marca, Modelo, IMEI/SN, Usu√°rio destinat√°rio, Centro de custo
    - Se cria√ß√£o de ativo falhar: Sistema reverte sa√≠da (rollback de transa√ß√£o)
11. Sistema cria registro de auditoria
12. Sistema exibe mensagem de sucesso
13. Sistema notifica destinat√°rio via RF066

**Atores**: Almoxarife, Gestor de Estoque

**Pr√©-condi√ß√µes**: Usu√°rio autenticado com permiss√£o `GES.ESTOQUE.SAIDA.CREATE`; Saldo dispon√≠vel suficiente

**P√≥s-condi√ß√µes**: Sa√≠da registrada; saldo atualizado; ativo criado (se distribui√ß√£o); destinat√°rio notificado; auditoria criada

---

### 2.3. Transfer√™ncia entre Almoxarifados

**ID**: F-AST-041-03

**Descri√ß√£o**: Transferir aparelhos entre almoxarifados de diferentes filiais com workflow de aprova√ß√£o em 3 etapas (solicita√ß√£o ‚Üí envio ‚Üí recebimento).

**Fluxo Principal**:
1. Usu√°rio da Filial A acessa "Transfer√™ncia de Estoque"
2. Sistema exibe formul√°rio: Almoxarifado origem, Almoxarifado destino, Categoria, Marca, Modelo, Quantidade, Motivo, Transportadora, C√≥digo de rastreio
3. Usu√°rio cria **solicita√ß√£o de transfer√™ncia**
4. Sistema registra solicita√ß√£o com status "Aguardando Aprova√ß√£o"
5. Sistema notifica gestor do almoxarifado de origem via RF066
6. Gestor aprova ou rejeita solicita√ß√£o
7. **Se aprovado**:
   - Sistema muda status para "Aguardando Envio"
   - Usu√°rio remetente confirma envio
   - Sistema registra **sa√≠da** no Almoxarifado A com status "Em Tr√¢nsito" (RN-AST-041-12)
   - Sistema deduz saldo f√≠sico do almoxarifado origem
8. Aparelhos s√£o enviados fisicamente
9. Usu√°rio da Filial B acessa "Receber Transfer√™ncia"
10. Sistema exibe transfer√™ncias pendentes
11. Usu√°rio **confirma recebimento** e informa quantidade recebida
12. Se quantidade recebida ‚â† quantidade enviada: Sistema exige justificativa de diverg√™ncia (RN-AST-041-15)
13. Sistema registra **entrada** no Almoxarifado B (RN-AST-041-13)
14. Sistema adiciona saldo f√≠sico ao almoxarifado destino
15. Status da transfer√™ncia muda para "Conclu√≠da"
16. Sistema cria auditoria de todas as etapas

**Fluxo Alternativo - Transfer√™ncia em Tr√¢nsito > 15 Dias**:
- Job noturno identifica transfer√™ncias em tr√¢nsito h√° mais de 15 dias (RN-AST-041-14)
- Sistema envia alerta para gestor origem e destino via RF066

**Atores**: Almoxarife Origem, Gestor Origem, Almoxarife Destino

**Pr√©-condi√ß√µes**: Usu√°rio autenticado com permiss√£o `GES.ESTOQUE.TRANSFERENCIA.CREATE` ou `GES.ESTOQUE.TRANSFERENCIA.RECEIVE`

**P√≥s-condi√ß√µes**: Transfer√™ncia conclu√≠da; saldo deduzido da origem; saldo adicionado ao destino; auditoria criada

---

### 2.4. Consulta de Saldo e Movimenta√ß√µes

**ID**: F-AST-041-04

**Descri√ß√£o**: Consultar saldo atual e hist√≥rico de movimenta√ß√µes com filtros avan√ßados e exporta√ß√£o em m√∫ltiplos formatos.

**Consultas Dispon√≠veis**:
- **Saldo por Almoxarifado**: Listar todos os itens com saldo > 0 em um almoxarifado
- **Saldo por Categoria**: Agrupar saldo por categoria de ativo
- **Saldo por Marca/Modelo**: Filtrar por marca e modelo espec√≠ficos
- **Saldo Consolidado**: Somar saldo de todos os almoxarifados
- **Hist√≥rico de Movimenta√ß√µes**: Listar todas as entradas/sa√≠das de um item ou almoxarifado
- **Rastreamento por IMEI/SN**: Localizar aparelho espec√≠fico e ver hist√≥rico completo

**Fluxo Principal**:
1. Usu√°rio acessa "Consulta de Estoque"
2. Sistema exibe filtros dispon√≠veis: Almoxarifado, Categoria, Marca, Modelo, Per√≠odo (data in√≠cio/fim), Tipo de movimenta√ß√£o, Usu√°rio respons√°vel
3. Usu√°rio seleciona filtros desejados
4. Sistema executa consulta e exibe resultados em grid paginado
5. Sistema exibe coluna "Valor Total (R$)" calculada como saldo_fisico √ó custo_medio (RN-AST-041-16)
6. Usu√°rio pode clicar em "Exportar" e selecionar formato (Excel/PDF/CSV)
7. Sistema gera arquivo no formato selecionado
8. Sistema registra exporta√ß√£o em auditoria com usu√°rio, IP, timestamp, formato, filtros aplicados (RN-AST-041-18)
9. Sistema disponibiliza arquivo para download

**Atores**: Almoxarife, Gestor de Estoque, Auditor

**Pr√©-condi√ß√µes**: Usu√°rio autenticado com permiss√£o `GES.ESTOQUE.CONSULTAR`

**P√≥s-condi√ß√µes**: Consulta exibida; exporta√ß√£o registrada em auditoria (se aplic√°vel)

---

### 2.5. Reserva de Aparelhos

**ID**: F-AST-041-05

**Descri√ß√£o**: Reservar aparelhos no estoque para distribui√ß√£o futura com bloqueio de saldo dispon√≠vel (sem alterar saldo f√≠sico).

**Fluxo Principal**:
1. Usu√°rio acessa "Reserva de Estoque"
2. Sistema exibe formul√°rio: Almoxarifado, Categoria, Marca, Modelo, Quantidade, Usu√°rio destinat√°rio, Motivo da reserva, Prazo de validade (m√°x 30 dias - RN-AST-041-21)
3. Usu√°rio preenche campos e clica "Criar Reserva"
4. Sistema valida saldo dispon√≠vel: quantidade_reserva <= (saldo_fisico - saldo_reservado) (RN-AST-041-20)
5. Sistema **bloqueia saldo dispon√≠vel**:
   - saldo_reservado = saldo_reservado + quantidade_reserva
   - saldo_disponivel = saldo_fisico - saldo_reservado (coluna computada)
   - saldo_fisico permanece inalterado
6. Sistema cria registro de reserva com status "Ativa"
7. Sistema notifica usu√°rio destinat√°rio via RF066
8. Sistema exibe mensagem de sucesso

**Fluxo Autom√°tico - Consumo de Reserva**:
- Quando aparelho for distribu√≠do para usu√°rio destinat√°rio: Sistema identifica reserva ativa e consome automaticamente
- Status da reserva muda para "Consumida"
- saldo_reservado diminui pela quantidade consumida

**Fluxo Autom√°tico - Expira√ß√£o de Reserva**:
- Job noturno executa diariamente √†s 02:00 AM (RN-AST-041-24)
- Identifica reservas com data_validade < hoje e status = "Ativa"
- Muda status para "Expirada"
- Libera saldo bloqueado: saldo_reservado = saldo_reservado - quantidade_reserva (RN-AST-041-22)

**Fluxo Autom√°tico - Notifica√ß√£o de Expira√ß√£o Pr√≥xima**:
- Job verifica reservas com data_validade entre hoje e hoje+3 dias
- Envia notifica√ß√£o para usu√°rio destinat√°rio via RF066

**Atores**: Gestor de Estoque

**Pr√©-condi√ß√µes**: Usu√°rio autenticado com permiss√£o `GES.ESTOQUE.RESERVA.CREATE`; Saldo dispon√≠vel suficiente

**P√≥s-condi√ß√µes**: Reserva criada; saldo dispon√≠vel bloqueado; destinat√°rio notificado

---

### 2.6. Alertas de Estoque M√≠nimo/M√°ximo

**ID**: F-AST-041-06

**Descri√ß√£o**: Configurar n√≠veis de estoque m√≠nimo e m√°ximo por almoxarifado/categoria/marca/modelo e receber alertas autom√°ticos quando saldo atingir limites.

**Fluxo de Configura√ß√£o**:
1. Gestor acessa "Configura√ß√£o de Alertas"
2. Sistema exibe lista de configura√ß√µes existentes com status (Ativo/Inativo)
3. Gestor clica "Nova Configura√ß√£o"
4. Sistema exibe formul√°rio: Almoxarifado, Categoria, Marca/Modelo (opcional), Estoque m√≠nimo, Estoque m√°ximo, Emails para notifica√ß√£o (separados por v√≠rgula)
5. Gestor preenche campos e salva
6. Sistema cria configura√ß√£o ativa

**Fluxo de Monitoramento (Job Autom√°tico)**:
1. Job Hangfire executa a cada 1 hora (RN-AST-041-25)
2. Sistema busca todas as configura√ß√µes ativas
3. Para cada configura√ß√£o:
   - Calcula saldo atual do almoxarifado+categoria+marca/modelo
   - Compara com n√≠veis configurados
   - Se saldo <= estoque_minimo: Envia alerta "Estoque Baixo"
   - Se saldo < (estoque_minimo √ó 0.5): Envia alerta "Estoque Cr√≠tico"
   - Se saldo >= estoque_maximo: Envia alerta "Estoque Excedente"
4. Sistema envia alerta via RF066 com canais Email + In-App (RN-AST-041-26)
5. Sistema registra envio em auditoria
6. Alerta N√ÉO √© reenviado at√© que saldo seja normalizado e volte a cair (RN-AST-041-27)

**Atores**: Gestor de Estoque

**Pr√©-condi√ß√µes**: Usu√°rio autenticado com permiss√£o `GES.ESTOQUE.ALERTAS.CONFIG`

**P√≥s-condi√ß√µes**: Configura√ß√£o criada; job agendado monitora saldo; alertas enviados automaticamente

---

### 2.7. Rastreamento por IMEI/Serial Number

**ID**: F-AST-041-07

**Descri√ß√£o**: Localizar aparelho espec√≠fico por IMEI ou Serial Number e visualizar timeline completa do ciclo de vida.

**Fluxo Principal**:
1. Usu√°rio acessa "Rastreamento por IMEI"
2. Sistema exibe campo de busca
3. Usu√°rio digita IMEI ou Serial Number
4. Sistema busca todas as movimenta√ß√µes relacionadas na tabela Estoque_Movimentacao
5. Sistema ordena eventos cronologicamente
6. Sistema exibe timeline visual com cart√µes de eventos:
   - **Entrada inicial**: Data, Tipo (compra/devolu√ß√£o), Almoxarifado, Fornecedor (se compra), Usu√°rio respons√°vel
   - **Movimenta√ß√µes**: Transfer√™ncias entre almoxarifados com origem/destino
   - **Sa√≠da final**: Data, Tipo (distribui√ß√£o/venda/descarte), Destinat√°rio, Usu√°rio respons√°vel
7. Se sa√≠da = "Distribui√ß√£o": Sistema exibe link para o Ativo vinculado (RF028) com nome do usu√°rio respons√°vel atual
8. Cada evento permite expandir para ver observa√ß√µes completas

**Atores**: Almoxarife, Gestor de Estoque, Auditor

**Pr√©-condi√ß√µes**: Usu√°rio autenticado com permiss√£o `GES.ESTOQUE.CONSULTAR`; IMEI/SN existente no sistema

**P√≥s-condi√ß√µes**: Timeline exibida; consulta registrada em auditoria

---

## 3. Regras de Neg√≥cio

### RN-AST-041-01: Entrada de Compra Vinculada a Nota Fiscal

**Descri√ß√£o**: Entrada de compra DEVE ser vinculada a nota fiscal (RF039).

**Motiva√ß√£o**: Compliance fiscal; rastreabilidade de origem; custeio correto.

**Impacto**: Se tipo de entrada = "Compra", campo "Nota Fiscal" √© obrigat√≥rio. Backend valida exist√™ncia da NF antes de salvar.

---

### RN-AST-041-02: Entrada de Devolu√ß√£o Vinculada a Ativo

**Descri√ß√£o**: Entrada de devolu√ß√£o DEVE ser vinculada a ativo existente (RF028).

**Motiva√ß√£o**: Garantir que aparelho devolvido estava realmente em posse do usu√°rio; atualizar status do ativo para "Devolvido".

**Impacto**: Se tipo de entrada = "Devolu√ß√£o", campo "Ativo" √© obrigat√≥rio. Backend valida que ativo existe e pertence ao usu√°rio mencionado.

---

### RN-AST-041-03: Ajuste Manual Requer Justificativa

**Descri√ß√£o**: Ajuste manual REQUER justificativa obrigat√≥ria (m√≠nimo 20 caracteres).

**Motiva√ß√£o**: Evitar ajustes arbitr√°rios; rastreabilidade de corre√ß√µes; compliance de auditoria.

**Impacto**: Se tipo de entrada/sa√≠da = "Ajuste Manual", campo "Observa√ß√µes" deve ter pelo menos 20 caracteres.

---

### RN-AST-041-04: Ajuste Acima de 10 Unidades Requer Aprova√ß√£o

**Descri√ß√£o**: Ajuste manual acima de 10 unidades REQUER aprova√ß√£o de gestor.

**Motiva√ß√£o**: Evitar fraudes; controle de grandes diverg√™ncias; segrega√ß√£o de fun√ß√µes.

**Impacto**: Se quantidade de ajuste > 10, sistema cria workflow de aprova√ß√£o (RF071 ou similar). Ajuste fica pendente at√© aprova√ß√£o do gestor.

---

### RN-AST-041-05: Auditoria Completa de Movimenta√ß√µes

**Descri√ß√£o**: Todas as movimenta√ß√µes (entrada, sa√≠da, transfer√™ncia, reserva, ajuste) DEVEM ser auditadas com usu√°rio, IP, timestamp, dados antes/depois.

**Motiva√ß√£o**: Compliance fiscal; rastreabilidade; investiga√ß√£o de diverg√™ncias.

**Impacto**: Backend registra auditoria automaticamente via `AuditInterceptor`. Retention de 2555 dias (7 anos). Hist√≥rico de movimenta√ß√µes √© IMUT√ÅVEL (n√£o pode ser editado/exclu√≠do - RN-AST-041-17).

---

### RN-AST-041-06: Sa√≠da N√£o Pode Exceder Saldo Dispon√≠vel

**Descri√ß√£o**: Sa√≠da N√ÉO pode exceder saldo dispon√≠vel no almoxarifado.

**Motiva√ß√£o**: Evitar saldo negativo; garantir consist√™ncia do estoque.

**Impacto**: Backend valida que `quantidade_saida <= saldo_disponivel` (saldo f√≠sico - saldo reservado). Se inv√°lido, retorna HTTP 400 com mensagem "Saldo insuficiente".

---

### RN-AST-041-07: Sa√≠da por Distribui√ß√£o Cria Ativo Automaticamente

**Descri√ß√£o**: Sa√≠da por distribui√ß√£o DEVE criar ativo no RF028 automaticamente vinculado ao usu√°rio destinat√°rio.

**Motiva√ß√£o**: Elimina√ß√£o de retrabalho; rastreabilidade de responsabilidade; integra√ß√£o entre m√≥dulos.

**Impacto**: Quando tipo de sa√≠da = "Distribui√ß√£o", backend chama endpoint do RF028 para criar ativo. Se cria√ß√£o falhar, sa√≠da √© revertida (rollback de transa√ß√£o).

---

### RN-AST-041-08: Sa√≠da por Descarte Requer Motivo e Laudo

**Descri√ß√£o**: Sa√≠da por descarte REQUER motivo obrigat√≥rio e anexo de laudo (se aplic√°vel).

**Motiva√ß√£o**: Compliance ambiental (PNRS - Pol√≠tica Nacional de Res√≠duos S√≥lidos); rastreabilidade de descarte.

**Impacto**: Se tipo de sa√≠da = "Descarte", campo "Motivo" √© obrigat√≥rio. Sistema permite upload de laudo de descarte (PDF).

---

### RN-AST-041-09: Sa√≠da Acima de 10 Unidades Requer Aprova√ß√£o

**Descri√ß√£o**: Sa√≠da acima de 10 unidades REQUER aprova√ß√£o de gestor.

**Motiva√ß√£o**: Evitar perdas grandes; controle de distribui√ß√µes em massa.

**Impacto**: Se quantidade de sa√≠da > 10, sistema cria workflow de aprova√ß√£o. Sa√≠da fica pendente at√© aprova√ß√£o do gestor.

---

### RN-AST-041-10: Aparelhos Rastre√°veis Devem Ter Sa√≠da Individual

**Descri√ß√£o**: Aparelhos rastre√°veis (com IMEI/SN) DEVEM ter sa√≠da individual registrada.

**Motiva√ß√£o**: Rastreabilidade completa; identifica√ß√£o de destinat√°rio espec√≠fico; auditoria de responsabilidade.

**Impacto**: Se categoria do aparelho = "Rastre√°vel", sistema exige preenchimento do campo IMEI/SN. Uma sa√≠da por aparelho.

---

### RN-AST-041-11: Transfer√™ncia Requer Aprova√ß√£o do Gestor de Origem

**Descri√ß√£o**: Transfer√™ncia DEVE ter aprova√ß√£o do gestor do almoxarifado de origem.

**Motiva√ß√£o**: Controle de movimenta√ß√µes entre filiais; evitar transfer√™ncias n√£o autorizadas.

**Impacto**: Transfer√™ncia fica com status "Aguardando Aprova√ß√£o" at√© aprova√ß√£o do gestor. Saldo s√≥ √© deduzido ap√≥s aprova√ß√£o.

---

### RN-AST-041-12: Saldo Deduzido Apenas Ap√≥s Confirma√ß√£o de Envio

**Descri√ß√£o**: Saldo N√ÉO √© deduzido da origem at√© confirma√ß√£o de envio.

**Motiva√ß√£o**: Evitar saldo incorreto se transfer√™ncia n√£o for efetivada.

**Impacto**: Transfer√™ncia aprovada fica em status "Aguardando Envio". Saldo s√≥ √© deduzido quando usu√°rio clicar "Confirmar Envio".

---

### RN-AST-041-13: Saldo Adicionado Apenas Ap√≥s Confirma√ß√£o de Recebimento

**Descri√ß√£o**: Saldo N√ÉO √© adicionado ao destino at√© confirma√ß√£o de recebimento.

**Motiva√ß√£o**: Evitar saldo incorreto se transfer√™ncia for perdida/danificada em tr√¢nsito.

**Impacto**: Transfer√™ncia em tr√¢nsito n√£o aumenta saldo do destino. Saldo s√≥ aumenta quando usu√°rio destinat√°rio clicar "Confirmar Recebimento".

---

### RN-AST-041-14: Alerta Autom√°tico para Transfer√™ncia em Tr√¢nsito > 15 Dias

**Descri√ß√£o**: Transfer√™ncia em tr√¢nsito por mais de 15 dias gera alerta autom√°tico.

**Motiva√ß√£o**: Identificar transfer√™ncias perdidas ou atrasadas; evitar diverg√™ncias de estoque.

**Impacto**: Job noturno identifica transfer√™ncias com status "Em Tr√¢nsito" h√° mais de 15 dias e notifica gestor do almoxarifado de origem e destino.

---

### RN-AST-041-15: Recebimento Deve Conferir Quantidade

**Descri√ß√£o**: Recebimento DEVE conferir quantidade enviada (diverg√™ncia requer justificativa).

**Motiva√ß√£o**: Identificar perdas/danos em tr√¢nsito; ajustar saldo corretamente.

**Impacto**: Tela de confirma√ß√£o de recebimento exibe quantidade enviada. Se usu√°rio informar quantidade diferente, campo "Justificativa de Diverg√™ncia" √© obrigat√≥rio.

---

### RN-AST-041-16: Consulta de Saldo Exibe Valor Total em R$

**Descri√ß√£o**: Consulta de saldo DEVE exibir valor total em R$ baseado no custo m√©dio.

**Motiva√ß√£o**: Visibilidade financeira do estoque; suporte a decis√µes de compra/descarte.

**Impacto**: Grid de saldo exibe coluna "Valor Total (R$)" = `saldo_fisico √ó custo_medio`.

---

### RN-AST-041-17: Hist√≥rico de Movimenta√ß√µes √© Imut√°vel

**Descri√ß√£o**: Hist√≥rico de movimenta√ß√µes √© IMUT√ÅVEL (n√£o pode ser editado/exclu√≠do).

**Motiva√ß√£o**: Compliance fiscal; auditoria; rastreabilidade.

**Impacto**: Backend N√ÉO exp√µe endpoints de UPDATE ou DELETE para tabela `Estoque_Movimentacao`. Apenas INSERT.

---

### RN-AST-041-18: Exporta√ß√£o Registrada em Auditoria

**Descri√ß√£o**: Exporta√ß√£o de dados DEVE ser registrada em auditoria (compliance LGPD).

**Motiva√ß√£o**: Rastreabilidade de acesso a dados; compliance LGPD.

**Impacto**: Quando usu√°rio exporta saldo ou movimenta√ß√µes, sistema registra em auditoria: usu√°rio, IP, timestamp, formato (Excel/PDF/CSV), filtros aplicados.

---

### RN-AST-041-19: Rastreamento IMEI/SN Exibe Timeline Completa

**Descri√ß√£o**: Consulta por IMEI/SN DEVE exibir timeline completa (entrada ‚Üí movimenta√ß√µes ‚Üí sa√≠da).

**Motiva√ß√£o**: Rastreabilidade completa de ciclo de vida do aparelho; identifica√ß√£o de respons√°veis em cada etapa.

**Impacto**: Tela de rastreamento exibe linha do tempo visual com todos os eventos relacionados ao IMEI/SN informado.

---

### RN-AST-041-20: Reserva N√£o Pode Exceder Saldo Dispon√≠vel

**Descri√ß√£o**: Reserva N√ÉO pode exceder saldo dispon√≠vel (n√£o reservado).

**Motiva√ß√£o**: Evitar reservas sobre saldo j√° bloqueado; garantir consist√™ncia.

**Impacto**: Backend valida que `quantidade_reserva <= saldo_disponivel`. Se inv√°lido, retorna HTTP 400 com mensagem "Saldo dispon√≠vel insuficiente".

---

### RN-AST-041-21: Reserva Tem Validade M√°xima de 30 Dias

**Descri√ß√£o**: Reserva tem validade m√°xima de 30 dias.

**Motiva√ß√£o**: Evitar bloqueios indefinidos; liberar saldo n√£o utilizado.

**Impacto**: Tela de cria√ß√£o de reserva permite data de validade at√© 30 dias no futuro. Backend valida que `data_validade <= data_criacao + 30 dias`.

---

### RN-AST-041-22: Reserva Expirada Libera Saldo Automaticamente

**Descri√ß√£o**: Reserva expirada automaticamente libera saldo ap√≥s data de validade.

**Motiva√ß√£o**: Evitar interven√ß√£o manual; garantir disponibilidade de saldo.

**Impacto**: Job noturno identifica reservas com `data_validade < hoje` e `status = 'Ativa'`, muda status para "Expirada" e libera saldo bloqueado.

---

### RN-AST-041-23: Cancelamento de Reserva Requer Justificativa

**Descri√ß√£o**: Cancelamento de reserva REQUER justificativa.

**Motiva√ß√£o**: Rastreabilidade de cancelamentos; evitar cancelamentos arbitr√°rios.

**Impacto**: Tela de cancelamento de reserva exige campo "Motivo do Cancelamento" (m√≠nimo 20 caracteres).

---

### RN-AST-041-24: Job Noturno Verifica Reservas Expiradas

**Descri√ß√£o**: Job noturno verifica reservas expiradas e libera saldo automaticamente.

**Motiva√ß√£o**: Garantir libera√ß√£o autom√°tica de saldo; evitar esquecimento de reservas antigas.

**Impacto**: Hangfire executa job diariamente √†s 02:00 AM para identificar e expirar reservas vencidas.

---

### RN-AST-041-25: Job Verifica N√≠veis de Estoque a Cada 1 Hora

**Descri√ß√£o**: Job agendado verifica n√≠veis de estoque a cada 1 hora.

**Motiva√ß√£o**: Alertas quase em tempo real; evitar atrasos na notifica√ß√£o.

**Impacto**: Hangfire executa job a cada 1 hora para comparar saldo atual com n√≠veis configurados (m√≠nimo/m√°ximo).

---

### RN-AST-041-26: Alertas Enviados por Email + Notifica√ß√£o Sistema

**Descri√ß√£o**: Alertas s√£o enviados por email + notifica√ß√£o no sistema (RF066).

**Motiva√ß√£o**: Garantir recebimento de alerta; redund√¢ncia de canais.

**Impacto**: Sistema envia alerta via RF066 com canal Email E In-App. Emails configurados na configura√ß√£o de alerta.

---

### RN-AST-041-27: Alerta N√£o Reenviado At√© Normaliza√ß√£o

**Descri√ß√£o**: Alerta N√ÉO √© reenviado at√© que saldo seja normalizado e volte a cair.

**Motiva√ß√£o**: Evitar spam de alertas; reduzir ru√≠do.

**Impacto**: Sistema registra √∫ltima data de envio de alerta. S√≥ reenvia se saldo foi normalizado (ficou acima do m√≠nimo/abaixo do m√°ximo) e voltou a ficar fora do range.

---

### RN-AST-041-28: Configura√ß√£o de N√≠veis Requer Permiss√£o de Gestor

**Descri√ß√£o**: Configura√ß√£o de n√≠veis de alerta REQUER permiss√£o de gestor.

**Motiva√ß√£o**: Evitar configura√ß√µes incorretas; controle de quem define pol√≠ticas de estoque.

**Impacto**: Apenas usu√°rios com permiss√£o `GES.ESTOQUE.ALERTAS.CONFIG` podem criar/editar configura√ß√µes de alerta.

---

## 4. Integra√ß√µes Obrigat√≥rias

### 4.1. Central de Funcionalidades

**C√≥digo**: `GES.ESTOQUE`
**Nome**: Gest√£o de Estoque
**Descri√ß√£o**: Controle operacional de entrada, sa√≠da e movimenta√ß√£o de aparelhos
**Categoria**: Gest√£o
**√çcone**: `warehouse`
**Rota**: `/gestao/estoque`
**Ordem**: 30

**Permiss√µes**:
- `GES.ESTOQUE.CONSULTAR` - Consultar saldo e movimenta√ß√µes
- `GES.ESTOQUE.ENTRADA.CREATE` - Registrar entrada de aparelhos
- `GES.ESTOQUE.SAIDA.CREATE` - Registrar sa√≠da de aparelhos
- `GES.ESTOQUE.TRANSFERENCIA.CREATE` - Criar transfer√™ncia entre almoxarifados
- `GES.ESTOQUE.TRANSFERENCIA.RECEIVE` - Confirmar recebimento de transfer√™ncia
- `GES.ESTOQUE.RESERVA.CREATE` - Criar reserva de aparelhos
- `GES.ESTOQUE.RESERVA.CANCEL` - Cancelar reserva de aparelhos
- `GES.ESTOQUE.ALERTAS.CONFIG` - Configurar alertas de estoque

---

### 4.2. Auditoria

- **Todas as opera√ß√µes** (entrada, sa√≠da, transfer√™ncia, reserva, ajuste, exporta√ß√£o) DEVEM ser auditadas
- **Retention**: 2555 dias (7 anos - compliance fiscal)
- **Campos auditados**: Usu√°rio, IP, Data/Hora, Dados antes/depois, A√ß√£o executada
- **Hist√≥rico imut√°vel**: Movimenta√ß√µes N√ÉO podem ser editadas ou exclu√≠das ap√≥s cria√ß√£o

---

### 4.3. Multi-tenancy

- **Todas as tabelas** incluem `Id_Empresa` ou `ClienteId`
- **Queries SEMPRE filtradas** por empresa do usu√°rio autenticado (`CurrentClienteId`)
- **Imposs√≠vel** visualizar/modificar estoque de outra empresa
- **Isolamento total** de dados entre tenants

---

### 4.4. Permiss√µes (RBAC)

- **Controle granular** por tipo de opera√ß√£o (consulta, entrada, sa√≠da, transfer√™ncia, reserva, alertas)
- **Separa√ß√£o de fun√ß√µes**: Almoxarife pode registrar, Gestor pode aprovar, Auditor pode consultar
- **Permiss√µes especiais** para ajustes manuais e cancelamentos
- **Valida√ß√£o backend**: Endpoint valida permiss√£o antes de executar a√ß√£o

---

### 4.5. i18n (Internacionaliza√ß√£o)

- **Todos os textos, mensagens, labels** traduzidos em pt-BR, en-US, es-ES
- **Fallback**: pt-BR ‚Üí en ‚Üí es
- **Chaves i18n** organizadas por m√≥dulo: `estoque.entrada.titulo`, `estoque.saida.mensagemSucesso`, etc.
- **Valida√ß√µes** retornam mensagens traduzidas

---

### 4.6. Notifica√ß√µes (RF066)

- **Alertas de estoque** enviados via RF066 com canais Email + In-App
- **Notifica√ß√µes de transfer√™ncia** (solicita√ß√£o, aprova√ß√£o, envio, recebimento)
- **Notifica√ß√µes de reserva** (cria√ß√£o, expira√ß√£o em 3 dias, cancelamento)
- **Prioridade**: Alta para alertas cr√≠ticos; Normal para outros

---

### 4.7. Integra√ß√£o com RF028 (Gest√£o de Ativos)

- **Sa√≠da por distribui√ß√£o** cria ativo automaticamente no RF028
- **Dados do ativo**: Categoria, Marca, Modelo, IMEI/SN, Usu√°rio respons√°vel, Centro de custo
- **Status inicial**: "Ativo" ou "Em Uso"
- **V√≠nculo bidirecional**: Ativo guarda ID da movimenta√ß√£o de sa√≠da

---

### 4.8. Jobs Agendados (Hangfire)

- **Job de Reservas Expiradas**: Executa diariamente √†s 02:00 AM para expirar reservas vencidas
- **Job de Alertas de Estoque**: Executa a cada 1 hora para verificar n√≠veis m√≠nimo/m√°ximo
- **Job de Transfer√™ncias em Tr√¢nsito**: Executa diariamente para alertar transfer√™ncias > 15 dias

---

## 5. Impacto e Depend√™ncias

### 5.1. RFs Dependentes

- **RF028** (Gest√£o de Ativos): Recebe ativos criados automaticamente na distribui√ß√£o
- **RF068** (Invent√°rio C√≠clico): Audita saldo do RF041 periodicamente
- **RF066** (Notifica√ß√µes): Envia alertas de estoque e notifica√ß√µes de transfer√™ncia

### 5.2. RFs Necess√°rios (Pr√©-requisitos)

- **RF019** (Tipos de Ativos): Categorias de aparelhos devem estar cadastradas
- **RF022** (Fornecedores): Fornecedores devem estar cadastrados para entrada de compra
- **RF039** (Notas Fiscais): NFs devem estar cadastradas para vincula√ß√£o (se implementado)

### 5.3. Dados Compartilhados

- **Categorias de Ativos**: Compartilhadas com RF019
- **Marcas e Modelos**: Compartilhadas com RF104 (se implementado)
- **Filiais**: Compartilhadas com RF024
- **Usu√°rios**: Compartilhados com sistema de autentica√ß√£o

---

## 6. M√©tricas e KPIs

### 6.1. Operacionais

- **Taxa de Rotatividade de Estoque**: N√∫mero de sa√≠das / saldo m√©dio (mensal)
- **Tempo M√©dio de Transfer√™ncia**: Tempo entre envio e recebimento (dias)
- **Taxa de Diverg√™ncia em Recebimentos**: % de recebimentos com quantidade diferente do enviado
- **Taxa de Reservas Expiradas**: % de reservas que expiraram sem consumo

### 6.2. Compliance

- **Taxa de Ajustes Manuais**: % de movimenta√ß√µes que s√£o ajustes (meta: < 2%)
- **Taxa de Ajustes Aprovados**: % de ajustes que foram aprovados pelo gestor
- **Tempo M√©dio de Auditoria**: Tempo m√©dio para acessar hist√≥rico completo de um aparelho

### 6.3. Efici√™ncia

- **Taxa de Cria√ß√£o Autom√°tica de Ativos**: % de distribui√ß√µes que criaram ativo automaticamente (meta: 100%)
- **Taxa de Alertas de Estoque Acionados**: Quantidade de alertas enviados (mensal)
- **Taxa de Resolu√ß√£o de Alertas**: % de alertas que resultaram em reposi√ß√£o de estoque

---

## 7. Seguran√ßa

### 7.1. Prote√ß√£o de Dados

- **Multi-tenancy obrigat√≥rio**: Filtragem por `ClienteId` em todas as queries
- **Auditoria completa**: Todas as opera√ß√µes registradas com usu√°rio e IP
- **Hist√≥rico imut√°vel**: Movimenta√ß√µes n√£o podem ser editadas/exclu√≠das
- **Exporta√ß√£o rastreada**: Registro em auditoria de todas as exporta√ß√µes

### 7.2. Controle de Acesso

- **RBAC granular**: Permiss√µes por opera√ß√£o (consultar, entrada, sa√≠da, transfer√™ncia, reserva, alertas)
- **Aprova√ß√£o de ajustes**: Ajustes > 10 unidades requerem aprova√ß√£o de gestor
- **Aprova√ß√£o de transfer√™ncias**: Transfer√™ncias requerem aprova√ß√£o do gestor de origem
- **Permiss√µes especiais**: Configura√ß√£o de alertas restrita a gestores

### 7.3. Valida√ß√µes de Seguran√ßa

- **Saldo dispon√≠vel**: Valida√ß√£o backend impede sa√≠da/reserva acima do saldo
- **Vincula√ß√£o obrigat√≥ria**: Entrada de compra requer NF; Entrada de devolu√ß√£o requer Ativo
- **Justificativas obrigat√≥rias**: Ajustes manuais e descartes requerem justificativa
- **Preven√ß√£o de fraude**: Aprova√ß√µes de gestor para opera√ß√µes > 10 unidades

---

## 8. Crit√©rios de Aceite

### 8.1. Funcionalidades

- ‚úÖ **Entrada de Aparelhos**: Registrar entrada por compra, devolu√ß√£o, transfer√™ncia recebida e ajuste manual
- ‚úÖ **Sa√≠da de Aparelhos**: Registrar sa√≠da por distribui√ß√£o, venda, descarte, transfer√™ncia enviada e ajuste manual
- ‚úÖ **Transfer√™ncia**: Workflow completo (solicita√ß√£o ‚Üí aprova√ß√£o ‚Üí envio ‚Üí recebimento)
- ‚úÖ **Consulta de Saldo**: Filtros por almoxarifado, categoria, marca/modelo; Exporta√ß√£o Excel/PDF/CSV
- ‚úÖ **Reserva**: Criar reserva com bloqueio de saldo; Consumo autom√°tico na distribui√ß√£o; Expira√ß√£o autom√°tica
- ‚úÖ **Alertas**: Configura√ß√£o de n√≠veis m√≠nimo/m√°ximo; Alertas autom√°ticos por email + notifica√ß√£o
- ‚úÖ **Rastreamento**: Busca por IMEI/SN com timeline completa de movimenta√ß√µes

### 8.2. Integra√ß√µes

- ‚úÖ **RF028**: Cria√ß√£o autom√°tica de ativo na sa√≠da por distribui√ß√£o
- ‚úÖ **RF066**: Envio de alertas e notifica√ß√µes
- ‚úÖ **Hangfire**: Jobs agendados (reservas expiradas, alertas, transfer√™ncias em tr√¢nsito)
- ‚úÖ **Auditoria**: Registro completo com retention de 7 anos

### 8.3. Qualidade

- ‚úÖ **Multi-tenancy**: Isolamento total entre empresas
- ‚úÖ **RBAC**: Permiss√µes granulares funcionando corretamente
- ‚úÖ **i18n**: Textos traduzidos em pt-BR, en-US, es-ES
- ‚úÖ **Valida√ß√µes**: Backend impede opera√ß√µes inv√°lidas (saldo negativo, ajustes sem aprova√ß√£o)
- ‚úÖ **Performance**: Consulta de saldo < 2s para 10.000 itens
- ‚úÖ **Hist√≥rico imut√°vel**: Movimenta√ß√µes n√£o podem ser editadas/exclu√≠das

---

## 9. Anexos

### 9.1. Casos de Uso

- [UC00: Consultar Saldo de Estoque](./Casos%20de%20Uso/UC00-consultar-saldo-estoque.md)
- [UC01: Registrar Entrada de Aparelhos](./Casos%20de%20Uso/UC01-registrar-entrada-aparelhos.md)
- [UC02: Registrar Sa√≠da de Aparelhos](./Casos%20de%20Uso/UC02-registrar-saida-aparelhos.md)
- [UC03: Transferir entre Almoxarifados](./Casos%20de%20Uso/UC03-transferir-entre-almoxarifados.md)
- [UC04: Criar Reserva de Aparelhos](./Casos%20de%20Uso/UC04-criar-reserva-aparelhos.md)

### 9.2. Modelo de Dados

- [MD-RF041: Modelo de Dados Completo](./MD-RF041.md)

### 9.3. Wireframes

- [WF-RF041: Wireframes das Telas](./WF-RF041.md)

### 9.4. Testes

- [Testes Backend](./Testes/Backend/README.md)
- [Testes Sistema (E2E)](./Testes/Sistema/README.md)
- [Testes Outros](./Testes/Outros/README.md)

---

**Observa√ß√µes Importantes**:
- Este RF (RF041) trata da **gest√£o operacional di√°ria** do estoque
- O **RF068** (Invent√°rio C√≠clico) trata da **auditoria peri√≥dica** do estoque
- S√£o funcionalidades COMPLEMENTARES mas DISTINTAS
- RF041 registra movimenta√ß√µes; RF068 audita se saldos est√£o corretos

---

[‚Üê Voltar ao EPIC009](../../README.md)
