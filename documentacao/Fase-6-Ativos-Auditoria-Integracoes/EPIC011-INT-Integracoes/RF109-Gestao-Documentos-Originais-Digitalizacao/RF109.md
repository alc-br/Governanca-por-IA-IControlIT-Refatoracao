# RF-109: Gestão de Documentos Originais e Digitalização

**Versão**: 2.0
**Data**: 2025-12-31
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC011-INT-Integracoes
**Fase**: Fase 6 - Ativos, Auditoria e Integrações

---

## 1. OBJETIVO DO REQUISITO

Este requisito define o comportamento do **Módulo de Gestão de Documentos Originais e Digitalização**, responsável por gerenciar o ciclo completo de documentos digitais: upload, armazenamento, indexação, processamento OCR, assinatura digital, versionamento e descarte conforme políticas de retenção.

O sistema deve permitir upload seguro de documentos em múltiplos formatos, digitalização via scanner, extração automática de texto (OCR), classificação por Machine Learning, controle de versões, workflows de aprovação, assinatura digital ICP-Brasil e armazenamento em nuvem com políticas de retenção conformes à LGPD.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Upload de documentos (PDF, JPG, PNG, DOCX, XLSX, TXT) com limite 50MB
- [x] Digitalização via scanner (TWAIN/WIA) com deskew automático
- [x] Processamento OCR automático (Azure Cognitive Services / Tesseract)
- [x] Busca full-text em ElasticSearch
- [x] Controle de versão com rastreamento de mudanças
- [x] Workflows de aprovação baseados em roles
- [x] Assinatura digital (DocuSign/Adobe Sign com ICP-Brasil)
- [x] Classificação automática via ML
- [x] Armazenamento em Azure Blob Storage (hot/cool/archive tiers)
- [x] Políticas de retenção e descarte automático (conformidade LGPD)
- [x] Auditoria completa de acesso e operações
- [x] Preview de documentos in-browser
- [x] Download com marca d'água

### 2.2 Fora do escopo (não objetivos)

- Edição de documentos in-browser (coberto por RF020)
- Sincronização desktop (Dropbox-like)
- Backup/restore de documentos (coberto por infraestrutura)
- Tecnologias específicas de OCR ou ML
- Layout, UX ou identidade visual
- Estratégia de deploy ou infraestrutura

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Documento Digital** | Arquivo armazenado com metadados (criador, versões, status, assinatura) |
| **OCR** | Extração de texto de imagens/PDFs scaneados via Azure Cognitive Services |
| **Digitalização** | Captura de documento físico via scanner TWAIN/WIA com processamento automático |
| **Assinatura Digital** | Processo criptográfico com certificado A3 ICP-Brasil garantindo autenticidade |
| **Classificação Automática** | Categorização via ML (Azure Form Recognizer) em tipos predefinidos |
| **Retenção de Documentos** | Política de permanência baseada em legislação (mínimo 7 anos LGPD) |
| **Workflow de Aprovação** | Cadeia de validações (Rascunho → Revisão → Aprovado → Publicado) |
| **Storage Tier** | Camada de armazenamento Azure (hot, cool, archive) para otimizar custo |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Upload de Documentos** - Interface web/mobile para envio de arquivos múltiplos formatos
2. **Digitalização via Scanner** - Captura de documentos físicos com deskew automático
3. **Processamento de OCR** - Extração de texto assíncrona com indexação automática
4. **Busca Full-Text** - Busca avançada em conteúdo (OCR + metadados) via ElasticSearch
5. **Controle de Versão** - Histórico completo com diffs e rollback
6. **Workflow de Aprovação** - Cadeia de validação com roles (Revisor, Aprovador)
7. **Assinatura Digital** - Integração DocuSign/Adobe Sign com ICP-Brasil
8. **Classificação Automática** - Detecção de tipo via ML (NF-e, Contrato, RG)
9. **Retenção e Descarte** - Políticas automáticas de retenção com descarte programado
10. **Auditoria Completa** - Rastreamento de todas operações (acesso, download, modificação)
11. **Download com Marca D'Água** - Aplicação de marca d'água identificando usuário/data
12. **Preview Multi-formato** - Visualização in-browser de PDFs, imagens, Office docs
13. **Sincronização com ERP** - Integração bidirecional para associar documentos a notas/compras

---

## 5. REGRAS DE NEGÓCIO

### RN-RF109-001: Tamanho Máximo de Arquivo 50MB

**Descrição**: Documentos uploadados não podem exceder 50MB. Uploads maiores são rejeitados com HTTP 413.

**Justificativa**: Evitar consumo excessivo de storage e banda; manter upload rápido; limitar uso de memória no OCR.

**Critério de Aceite**:
- Arquivo ≤ 50MB → aceito
- Arquivo > 50MB → rejeitado com erro descritivo

---

### RN-RF109-002: Formatos Permitidos (PDF, JPG, PNG, DOCX, XLSX, TXT)

**Descrição**: Apenas formatos específicos são aceitos. Validação por extensão E magic number (MIME type).

**Justificativa**: Garantir compatibilidade com OCR e visualização; evitar malware via executáveis; padronizar processamento.

**Critério de Aceite**:
- Formato permitido + MIME correto → aceito
- Formato não permitido ou MIME incorreto → rejeitado

---

### RN-RF109-003: OCR Automático para PDFs Scaneados

**Descrição**: Detectar automaticamente se PDF é nativo ou scaneado. Se scaneado, executar OCR assincronamente dentro de 5 minutos.

**Justificativa**: PDFs nativos já têm texto. PDFs scaneados precisam OCR para busca full-text. Execução assíncrona não bloqueia API.

**Critério de Aceite**:
- PDF nativo → texto extraído imediatamente
- PDF scaneado → OCR executado em até 5 minutos
- Imagem (JPG/PNG) → OCR executado em até 5 minutos

---

### RN-RF109-004: Detecção de Malware Obrigatória

**Descrição**: Todo arquivo uploadado deve ser escaneado por ClamAV antes de armazenamento. Arquivos infectados são rejeitados.

**Justificativa**: Proteger sistema contra malware, vírus e ransomware.

**Critério de Aceite**:
- Arquivo limpo → armazenado
- Arquivo infectado → rejeitado com erro de segurança, log de auditoria gerado

---

### RN-RF109-005: Versionamento Automático ao Substituir

**Descrição**: Substituir documento existente cria nova versão automaticamente. Versão anterior permanece acessível com número sequencial.

**Justificativa**: Rastreabilidade de mudanças; rollback em caso de erro; conformidade legal.

**Critério de Aceite**:
- Upload novo → versão 1
- Substituir → versão 2, 3, 4...
- Versões anteriores acessíveis via histórico

---

### RN-RF109-006: Retenção Mínima 7 Anos (LGPD)

**Descrição**: Documentos fiscais/trabalhistas devem ter retenção mínima de 7 anos. Descarte automático após período.

**Justificativa**: Conformidade LGPD e legislação fiscal.

**Critério de Aceite**:
- Documento com política de retenção → descarte agendado após período
- Tentativa de exclusão manual antes do período → bloqueada

---

### RN-RF109-007: Assinatura Digital ICP-Brasil Obrigatória

**Descrição**: Documentos críticos (contratos, procurações) exigem assinatura digital com certificado A3 ICP-Brasil.

**Justificativa**: Garantir autenticidade, integridade e não-repúdio legal.

**Critério de Aceite**:
- Assinatura com certificado válido → aceita
- Assinatura com certificado inválido/expirado → rejeitada
- Hash do documento alterado → invalidação automática da assinatura

---

### RN-RF109-008: Multi-tenancy Obrigatória - ClienteId em Todos Filtros

**Descrição**: Todos os documentos devem filtrar obrigatoriamente por ClienteId do usuário autenticado. Nenhuma query pode retornar documentos de múltiplos clientes.

**Justificativa**: Isolamento de dados entre tenants (SaaS). Segurança de dados confidenciais.

**Critério de Aceite**:
- Filtro por ClienteId presente → aceito
- Usuário de Cliente A vê apenas documentos de Cliente A → aceito
- Query sem filtro ClienteId → rejeitada com erro crítico

---

### RN-RF109-009: Classificação Automática Sobrescrita Manual

**Descrição**: Classificação automática via ML pode ser sobrescrita manualmente pelo usuário. Classificação manual tem prioridade.

**Justificativa**: ML não é 100% preciso. Usuário corrige erros de classificação.

**Critério de Aceite**:
- ML classifica como "Contrato" → usuário pode alterar para "NF-e"
- Classificação manual permanece mesmo após reprocessamento OCR

---

### RN-RF109-010: Auditoria de Download com Marca D'Água

**Descrição**: Todo download de documento gera log de auditoria E aplica marca d'água com usuário, data/hora, IP.

**Justificativa**: Rastreabilidade de vazamento de informações confidenciais; deterrence contra compartilhamento não autorizado.

**Critério de Aceite**:
- Download gera log com: UsuarioId, DocumentoId, Data/Hora, IP
- Marca d'água aplicada em PDFs/imagens
- Marca d'água contém: nome usuário, CPF, data/hora, IP

---

## 6. ESTADOS DA ENTIDADE

| Estado | Descrição |
|--------|-----------|
| **Rascunho** | Documento uploadado, aguardando validação inicial |
| **Em Processamento OCR** | OCR em execução (PDFs scaneados, imagens) |
| **Em Revisão** | Aguardando aprovação de revisor |
| **Aguardando Assinatura** | Pendente de assinatura digital |
| **Aprovado** | Validado e pronto para publicação |
| **Publicado** | Ativo e disponível para acesso geral |
| **Arquivado** | Movido para storage archive (> 2 anos sem acesso) |
| **Descartado** | Deletado conforme política de retenção |

---

## 7. TRANSIÇÕES DE ESTADO

```
[Upload] → [Rascunho]
    ↓ (Validação automática)
[Em Processamento OCR] (se scaneado)
    ↓ (OCR concluído)
[Em Revisão]
    ↓ (Aprovação revisor)
[Aguardando Assinatura] (se aplicável)
    ↓ (Assinatura concluída)
[Aprovado]
    ↓ (Publicação)
[Publicado]
    ↓ (> 2 anos sem acesso)
[Arquivado]
    ↓ (Após período retenção)
[Descartado]
```

---

## 8. RESTRIÇÕES E VALIDAÇÕES

| Campo | Restrição | Mensagem de Erro |
|-------|-----------|------------------|
| **Arquivo** | Obrigatório, ≤ 50MB, formato permitido | "Arquivo obrigatório e deve ser ≤ 50MB" |
| **Formato** | PDF, JPG, PNG, DOCX, XLSX, TXT | "Formato não permitido" |
| **MIME Type** | Deve corresponder à extensão | "Tipo de arquivo não corresponde à extensão" |
| **Malware** | ClamAV scan obrigatório | "Arquivo infectado. Upload rejeitado" |
| **Título** | Obrigatório, max 200 caracteres | "Título obrigatório (máx 200 caracteres)" |
| **Classificação** | Obrigatório após ML ou manual | "Classificação obrigatória" |

---

## 9. PERMISSÕES RBAC

| Permissão | Descrição | Perfis Padrão |
|-----------|-----------|---------------|
| `documento.upload` | Fazer upload de documentos | Todos autenticados |
| `documento.read` | Visualizar documentos | Todos autenticados |
| `documento.download` | Baixar documentos | Gestor, Admin, Usuário |
| `documento.approve` | Aprovar documentos | Revisor, Gestor, Admin |
| `documento.sign` | Assinar digitalmente | Diretor, Admin, Procurador |
| `documento.delete` | Excluir documentos (antes de período retenção bloqueado) | Admin, Super Admin |
| `documento.classify` | Classificar/reclassificar manualmente | Analista, Gestor, Admin |
| `documento.audit.view` | Visualizar logs de auditoria | Auditoria, Admin |

---

## 10. API ENDPOINTS

| Método | Endpoint | Descrição | Permissão |
|--------|----------|-----------|-----------|
| POST | `/api/documentos/upload` | Upload de documento | `documento.upload` |
| POST | `/api/documentos/scanner` | Digitalizar via scanner | `documento.upload` |
| GET | `/api/documentos` | Listar documentos com filtros | `documento.read` |
| GET | `/api/documentos/{id}` | Obter detalhes de documento | `documento.read` |
| GET | `/api/documentos/{id}/download` | Baixar documento (com marca d'água) | `documento.download` |
| GET | `/api/documentos/{id}/preview` | Preview in-browser | `documento.read` |
| GET | `/api/documentos/{id}/versions` | Listar versões do documento | `documento.read` |
| POST | `/api/documentos/{id}/classify` | Classificar/reclassificar manualmente | `documento.classify` |
| POST | `/api/documentos/{id}/approve` | Aprovar documento | `documento.approve` |
| POST | `/api/documentos/{id}/reject` | Rejeitar documento | `documento.approve` |
| POST | `/api/documentos/{id}/sign` | Assinar digitalmente | `documento.sign` |
| GET | `/api/documentos/search` | Busca full-text (ElasticSearch) | `documento.read` |
| GET | `/api/documentos/{id}/audit` | Histórico de auditoria | `documento.audit.view` |
| DELETE | `/api/documentos/{id}` | Excluir documento | `documento.delete` |

---

## 11. INTEGRAÇÕES OBRIGATÓRIAS

### 11.1 Central de Funcionalidades (Feature Flags)

**FeatureKey**: `GESTAO_DOCUMENTOS`

**Sub-features**:
- `GESTAO_DOCUMENTOS_OCR` - Processamento OCR automático
- `GESTAO_DOCUMENTOS_ML_CLASSIFICACAO` - Classificação automática via ML
- `GESTAO_DOCUMENTOS_ASSINATURA_DIGITAL` - Assinatura digital ICP-Brasil
- `GESTAO_DOCUMENTOS_SCANNER` - Digitalização via scanner TWAIN/WIA

### 11.2 Internacionalização (i18n)

**Idiomas Suportados**: pt-BR (padrão), en, es

**Chaves Principais**:
- `documentos.titulo` - "Gestão de Documentos"
- `documentos.upload.titulo` - "Enviar Documento"
- `documentos.upload.arrastar` - "Arraste arquivos aqui ou clique para selecionar"
- `documentos.formato.invalido` - "Formato de arquivo não permitido"
- `documentos.tamanho.excedido` - "Arquivo excede limite de 50MB"
- `documentos.malware.detectado` - "Arquivo infectado. Upload bloqueado"
- `documentos.ocr.processando` - "Processando OCR. Aguarde..."
- `documentos.assinatura.pendente` - "Aguardando assinatura digital"

### 11.3 Auditoria

**Operações Auditadas**:
- `DOC_UPLOAD` - Upload de documento
- `DOC_DOWNLOAD` - Download de documento
- `DOC_VIEW` - Visualização de documento
- `DOC_APPROVE` - Aprovação de documento
- `DOC_REJECT` - Rejeição de documento
- `DOC_SIGN` - Assinatura digital
- `DOC_CLASSIFY` - Classificação manual
- `DOC_DELETE` - Exclusão de documento

**Retenção**: 7 anos (mesma retenção dos documentos)

### 11.4 Job Agendado (Hangfire)

**Jobs**:
- `ProcessarOcrJob` - Processar OCR assíncrono (execução imediata ao upload)
- `ClassificarDocumentosJob` - Classificação automática via ML (execução imediata)
- `DescarteAutomaticoJob` - Descarte de documentos conforme política de retenção (diário às 3h)
- `MoverParaArchiveJob` - Mover documentos sem acesso > 2 anos para tier archive (semanal)

---

## 12. MODELO DE DADOS

Referência ao arquivo: [MD-RF109.md](./MD-RF109.md)

**Principais Entidades**:
- `Documento` - Armazena metadados de documentos
- `DocumentoVersao` - Histórico de versões
- `DocumentoAssinatura` - Assinaturas digitais aplicadas
- `DocumentoAuditoria` - Logs de acesso e operações
- `ClassificacaoDocumento` - Tipos de documentos (NF-e, Contrato, RG, etc.)

---

## 13. DEPENDÊNCIAS

### 13.1 RFs Dependentes (Upstream)

- **RF020** - Documentos e Anexos (funcionalidades básicas)
- **RF006** - Gestão de Usuários (autores, assinantes)

### 13.2 RFs que Dependem Deste (Downstream)

- **RF050** - Gestão de Contratos (anexar contratos digitalizados)
- **RF085** - Gestão de Notas Fiscais (anexar NF-e digitalizadas)

---

## 14. KPIs E MÉTRICAS

| KPI | Meta | Medição |
|-----|------|---------|
| **Performance Upload** | < 3 segundos (50MB) | Tempo upload + validação |
| **Taxa Sucesso OCR** | > 95% | % textos extraídos corretamente |
| **Tempo Processamento OCR** | < 5 minutos | Tempo médio OCR + indexação |
| **Acurácia Classificação ML** | > 90% | % classificações corretas |
| **Disponibilidade Documentos** | 99.95% | Uptime do serviço de download |
| **Taxa Conformidade Retenção** | 100% | % documentos com política definida |

---

## 15. ALERTAS CRÍTICOS

| Alerta | Condição | Ação |
|--------|----------|------|
| **Malware Detectado** | ClamAV detecta arquivo infectado | Bloquear upload, alertar admin, registrar IP |
| **OCR Falhou** | Falha processamento OCR > 3 vezes | Notificar DevOps, marcar documento para revisão manual |
| **Storage Cheio** | Azure Blob Storage > 90% | Alertar admin, executar limpeza emergencial |
| **Certificado Expirado** | Tentativa assinatura com certificado expirado | Bloquear operação, notificar usuário |

---

## 16. CENTRAL DE FUNCIONALIDADES

**Código da Funcionalidade**: `GESTAO_DOCUMENTOS`

**Módulo**: Integrações

**Chaves i18n**:
- Menu: `menu.integracoes.documentos`
- Título: `funcionalidades.documentos.titulo`
- Descrição: `funcionalidades.documentos.descricao`

---

## 17. REFERÊNCIAS

### 17.1 Documentação Complementar

**Referência ao Legado**: [RL-RF109.md](./RL-RF109.md)
**YAML Estruturado**: [RL-RF109.yaml](./RL-RF109.yaml)

Este RF define o contrato funcional moderno. Para detalhes sobre decisões de migração e rastreabilidade histórica, consultar a documentação de Referência ao Legado (RL).

### 17.2 Leis e Normas

- **Lei 14.063/2020** - Uso de assinatura eletrônica em interações com entes públicos
- **LGPD (Lei 13.709/2018)** - Artigo 16 (retenção mínima de dados pessoais)
- **ICP-Brasil** - Infraestrutura de Chaves Públicas Brasileira
- **ISO 15489** - Information and documentation — Records management
- **ISO 27001** - Information security management systems

### 17.3 Tecnologias e APIs

- **Azure Blob Storage** - Armazenamento em nuvem com tiers hot/cool/archive
- **Azure Cognitive Services** - Read API para OCR
- **Azure Form Recognizer** - Classificação automática de documentos
- **ElasticSearch** - Indexação e busca full-text
- **ClamAV** - Antivírus open-source
- **DocuSign API** - Assinatura digital
- **Adobe Sign API** - Assinatura digital alternativa
- **Tesseract OCR** - Engine OCR open-source (fallback)

---

## 18. PRÓXIMOS PASSOS

1. **Casos de Uso**: Criar [UC-RF109.md](./UC-RF109.md)
2. **Modelo de Dados**: Criar [MD-RF109.md](./MD-RF109.md)
3. **Fluxos de Tela**: Criar [WF-RF109.md](./WF-RF109.md)
4. **User Stories**: Criar [user-stories.yaml](./user-stories.yaml)
5. **Testes**: Criar [TC-RF109.yaml](./TC-RF109.yaml)
6. **Implementação Backend**: Commands/Queries/Handlers (CQRS + MediatR)
7. **Implementação Frontend**: Componentes Angular com upload drag-and-drop
8. **Integração Azure**: Blob Storage, Cognitive Services, Form Recognizer
9. **Integração DocuSign**: API de assinatura digital
10. **Validação E2E**: Testes Playwright completos

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 1.0 | 2025-12-28 | Versão inicial com legado misto | Claude Code |
| 2.0 | 2025-12-31 | Migração v1.0 → v2.0 - Separação RF/RL completa | Claude Code |

---

**Última Atualização**: 2025-12-31
**Autor**: Claude Code
**Revisão**: Pendente
**Status**: ATIVO
**Governança**: v2.0
