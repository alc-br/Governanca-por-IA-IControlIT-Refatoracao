# =============================================
# RL-RF077 - Referência ao Legado
# Ordens de Serviço e Atendimento
# Versão: 1.0
# Data: 2025-01-14
# Autor: Agência ALC - alc.dev.br
# =============================================

rf_id: RF077
titulo: "Ordens de Serviço e Atendimento"
versao_governanca: "2.0"
data_migracao: "2025-01-14"

legado:
  sistema: "IControlIT VB.NET"
  versao: "ASP.NET Web Forms 4.7.2"
  arquitetura: "Monolítica WebForms + SOAP WebServices"
  banco_dados: "SQL Server 2016+"
  multi_tenant: false  # Multi-database por cliente (SC_<OPERADORA>_<CLIENTE>)
  auditoria: "partial"  # Campos Created/Updated, sem histórico completo

# ==============================================================================
# SEÇÃO CRÍTICA: ITENS LEGADO RASTREADOS (100% COM DESTINO OBRIGATÓRIO)
# ==============================================================================

referencias:
  # ----------------------------------------------------------------------------
  # TELAS ASPX
  # ----------------------------------------------------------------------------
  - id: "LEG-RF077-001"
    tipo: "tela"
    nome: "OrdensSevico.aspx"
    caminho: "ic1_legado/IControlIT/[Modulo]/OrdensSevico.aspx"
    descricao: |
      Tela de listagem de ordens de serviço com filtros (status, técnico, data).
      DataGrid com paginação manual via ViewState.
      Sem validação de permissão por status.
    destino: "substituido"
    justificativa: |
      Substituído por componente Angular com paginação server-side, RBAC
      e validação de permissões por operação.
    documentacao_item_relacionado: "RF077 Seção 4 - Funcionalidade 1 (CRUD de OS)"
    uc_relacionado: "UC00"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF077-002"
    tipo: "tela"
    nome: "NovaOS.aspx"
    caminho: "ic1_legado/IControlIT/[Modulo]/NovaOS.aspx"
    descricao: |
      Tela de criação/edição de OS.
      Validação apenas client-side (jQuery).
      Sem validação de disponibilidade de técnico.
      Sem validação de transição de estado.
    destino: "substituido"
    justificativa: |
      Substituído por formulário reativo Angular com validações server-side
      obrigatórias (RN-RF077-001, RN-RF077-004).
    documentacao_item_relacionado: "RN-RF077-001, RN-RF077-004"
    uc_relacionado: "UC01, UC03"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF077-003"
    tipo: "tela"
    nome: "AgendaOS.aspx"
    caminho: "ic1_legado/IControlIT/[Modulo]/AgendaOS.aspx"
    descricao: |
      Calendário de agendamentos por técnico.
      ASP.NET Calendar control básico.
      Sem drag-and-drop.
      Sem validação de conflitos (permite sobreposição).
    destino: "substituido"
    justificativa: |
      Substituído por NgxBootstrap Calendar com drag-drop e validação
      automática de conflitos (RN-RF077-004).
    documentacao_item_relacionado: "RN-RF077-004"
    uc_relacionado: "UC04"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF077-004"
    tipo: "tela"
    nome: "ExecutarOS.aspx"
    caminho: "ic1_legado/IControlIT/[Modulo]/ExecutarOS.aspx"
    descricao: |
      Painel de execução (checklist, tempo, fotos, assinatura).
      Checklist HTML estático.
      Sem timer automático (manual).
      Sem registro de pausas.
      Upload de foto sem validação EXIF.
      Assinatura apenas checkbox + campo texto.
    destino: "substituido"
    justificativa: |
      Substituído por tela mobile-responsive com timer automático,
      pausa/retomada (RN-RF077-008), assinatura digital real (RN-RF077-003)
      e validação EXIF (RN-RF077-009).
    documentacao_item_relacionado: "RN-RF077-002, RN-RF077-003, RN-RF077-008, RN-RF077-009"
    uc_relacionado: "UC05, UC06"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF077-005"
    tipo: "tela"
    nome: "RelatorioTecnico.aspx"
    caminho: "ic1_legado/IControlIT/[Modulo]/RelatorioTecnico.aspx"
    descricao: |
      Dashboard de produtividade de técnico.
      Relatório gerado via stored procedure.
      Sem exportação PDF/Excel.
      Sem gráficos (apenas tabela).
    destino: "substituido"
    justificativa: |
      Substituído por dashboard com Charts.js, exportação PDF/Excel
      e cálculo preciso de tempo efetivo (RN-RF077-010).
    documentacao_item_relacionado: "RN-RF077-010"
    uc_relacionado: null
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 3

  # ----------------------------------------------------------------------------
  # WEBSERVICES (.asmx)
  # ----------------------------------------------------------------------------
  - id: "LEG-RF077-006"
    tipo: "webservice"
    nome: "WSOrdensSevico.asmx - ObterOrdens(filtro)"
    caminho: "ic1_legado/IControlIT/Services/WSOrdensSevico.asmx.vb"
    descricao: |
      Método que retorna lista de OS com filtros.
      Retorna DataSet sem paginação (risco de timeout com muitos registros).
    destino: "substituido"
    justificativa: |
      Substituído por endpoint REST GET /api/ordens-servico com paginação
      server-side obrigatória.
    documentacao_item_relacionado: "RF077 Seção 4 - Funcionalidade 1"
    uc_relacionado: "UC00"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF077-007"
    tipo: "webservice"
    nome: "WSOrdensSevico.asmx - CriarOrdem(dados)"
    caminho: "ic1_legado/IControlIT/Services/WSOrdensSevico.asmx.vb"
    descricao: |
      Método que cria nova OS.
      Validação apenas de campos obrigatórios (sem regras de negócio).
    destino: "substituido"
    justificativa: |
      Substituído por endpoint POST /api/ordens-servico com validações
      completas (RN-RF077-001 a RN-RF077-010).
    documentacao_item_relacionado: "RN-RF077-001 a RN-RF077-010"
    uc_relacionado: "UC01"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF077-008"
    tipo: "webservice"
    nome: "WSOrdensSevico.asmx - AtualizarOrdem(id, dados)"
    caminho: "ic1_legado/IControlIT/Services/WSOrdensSevico.asmx.vb"
    descricao: |
      Método que atualiza OS existente.
      Sem validação de transição de estado.
    destino: "substituido"
    justificativa: |
      Substituído por endpoint PUT /api/ordens-servico/{id} com validação
      estrita de transição de estado (RN-RF077-001).
    documentacao_item_relacionado: "RN-RF077-001"
    uc_relacionado: "UC03"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF077-009"
    tipo: "webservice"
    nome: "WSOrdensSevico.asmx - ConcluirOrdem(id, assinatura)"
    caminho: "ic1_legado/IControlIT/Services/WSOrdensSevico.asmx.vb"
    descricao: |
      Método que finaliza OS com "assinatura" (string simples).
      Assinatura é texto livre, sem hash ou timestamp.
      Sem validação de checklist completo.
    destino: "substituido"
    justificativa: |
      Substituído por endpoint POST /api/ordens-servico/{id}/concluir
      com assinatura digital real (RN-RF077-003) e validação de checklist
      (RN-RF077-002).
    documentacao_item_relacionado: "RN-RF077-002, RN-RF077-003"
    uc_relacionado: "UC06"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF077-010"
    tipo: "webservice"
    nome: "WSOrdensSevico.asmx - ObterRelatorio(dataInicio, dataFim, tecnicoId)"
    caminho: "ic1_legado/IControlIT/Services/WSOrdensSevico.asmx.vb"
    descricao: |
      Método que gera relatório de produtividade.
      Chama stored procedure, retorna DataSet.
    destino: "substituido"
    justificativa: |
      Substituído por endpoint GET /api/relatorios/tecnico com query LINQ
      otimizada (RN-RF077-010).
    documentacao_item_relacionado: "RN-RF077-010"
    uc_relacionado: null
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 3

  # ----------------------------------------------------------------------------
  # STORED PROCEDURES
  # ----------------------------------------------------------------------------
  - id: "LEG-RF077-011"
    tipo: "stored_procedure"
    nome: "pa_ObterOrdensPorTecnico"
    caminho: "Database/dbo.pa_ObterOrdensPorTecnico"
    descricao: |
      Faz SELECT em tblOrdensSevico WHERE Id_TecnicoResponsavel = @tecnicoId
      AND Fl_Deletado = 0. Retorna todas as colunas sem paginação.
    destino: "substituido"
    justificativa: |
      Substituído por query LINQ com paginação:
      _context.OrdensSevico.Where(o => o.TecnicoId == tecnicoId && !o.FlExcluido)
      .OrderByDescending(o => o.DataCriacao).Skip(offset).Take(limit)
    documentacao_item_relacionado: null
    uc_relacionado: "UC00"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 4

  - id: "LEG-RF077-012"
    tipo: "stored_procedure"
    nome: "pa_CalcularTempoTotalOS"
    caminho: "Database/dbo.pa_CalcularTempoTotalOS"
    descricao: |
      Faz SUM(Vl_Duracao_Real) agrupado por técnico.
      PROBLEMA: Inclui pausas no cálculo (impreciso).
    destino: "substituido"
    justificativa: |
      Substituído por query LINQ que exclui pausas:
      _context.OrdensSevico.Where(...).Sum(o => o.DuracaoRealMinutos -
      o.RegistrosPausa.Sum(p => p.DuracaoPausaMinutos))
    documentacao_item_relacionado: "RN-RF077-008"
    uc_relacionado: null
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF077-013"
    tipo: "stored_procedure"
    nome: "pa_RelatorioProduividadeMensal"
    caminho: "Database/dbo.pa_RelatorioProduividadeMensal"
    descricao: |
      Calcula Total OS, Tempo Médio, Taxa de Conclusão usando GROUP BY.
      PROBLEMA: Não calcula SLA violado corretamente.
    destino: "substituido"
    justificativa: |
      Substituído por query LINQ com cálculo correto de SLA (RN-RF077-007).
    documentacao_item_relacionado: "RN-RF077-007, RN-RF077-010"
    uc_relacionado: null
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF077-014"
    tipo: "stored_procedure"
    nome: "pa_ValidarConflitoriosAgendamento"
    caminho: "Database/dbo.pa_ValidarConflitoriosAgendamento"
    descricao: |
      NÃO EXISTE no legado. Validação de conflitos não é feita.
    destino: "descartado"
    justificativa: |
      Não existe no legado. Funcionalidade implementada do zero como
      RN-RF077-004 (validação de disponibilidade de técnico).
    documentacao_item_relacionado: "RN-RF077-004"
    uc_relacionado: "UC04"
    complexidade: "alta"
    risco_migracao: "baixo"
    prioridade: 1

  # ----------------------------------------------------------------------------
  # TABELAS LEGADAS
  # ----------------------------------------------------------------------------
  - id: "LEG-RF077-015"
    tipo: "componente"
    nome: "tblOrdensSevico"
    caminho: "Database/dbo.tblOrdensSevico"
    descricao: |
      Tabela principal de OS.
      PROBLEMAS:
      - Campo St_OS é VARCHAR (deveria ser ENUM)
      - Sem ClienteId (multi-tenancy fraco)
      - Campos de auditoria incompletos (sem LastModifiedBy)
    destino: "assumido"
    justificativa: |
      Migrado para tabela moderna OrdensSevico com:
      - Campo Status como ENUM
      - ClienteId adicionado
      - Campos de auditoria completos (AuditableEntity)
    documentacao_item_relacionado: "RF077 Seção 3 - OrdemServico entity"
    uc_relacionado: null
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF077-016"
    tipo: "componente"
    nome: "tblChecklistOS"
    caminho: "Database/dbo.tblChecklistOS"
    descricao: |
      NÃO EXISTE no legado. Checklist é HTML estático nas telas.
    destino: "descartado"
    justificativa: |
      Não existe no legado. Tabela ChecklistItems criada do zero para
      checklist dinâmico baseado em tipo de OS.
    documentacao_item_relacionado: "RN-RF077-002"
    uc_relacionado: "UC05"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 1

  - id: "LEG-RF077-017"
    tipo: "componente"
    nome: "tblRegistroPausaOS"
    caminho: "Database/dbo.tblRegistroPausaOS"
    descricao: |
      NÃO EXISTE no legado. Pausas não são rastreadas.
    destino: "descartado"
    justificativa: |
      Não existe no legado. Tabela RegistroPausaRetomada criada do zero
      para rastrear pausas com motivo e timestamp (RN-RF077-008).
    documentacao_item_relacionado: "RN-RF077-008"
    uc_relacionado: "UC05"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF077-018"
    tipo: "componente"
    nome: "tblMaterialConsumidoOS"
    caminho: "Database/dbo.tblMaterialConsumidoOS"
    descricao: |
      NÃO EXISTE no legado. Consumo de materiais não rastreado por OS.
    destino: "descartado"
    justificativa: |
      Não existe no legado. Tabela MaterialConsumido criada do zero
      para rastrear consumo e reduzir estoque automaticamente (RN-RF077-006).
    documentacao_item_relacionado: "RN-RF077-006"
    uc_relacionado: "UC05"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF077-019"
    tipo: "componente"
    nome: "tblAssinaturaOS"
    caminho: "Database/dbo.tblAssinaturaOS"
    descricao: |
      NÃO EXISTE no legado. Assinatura é apenas checkbox + campo texto.
    destino: "descartado"
    justificativa: |
      Não existe no legado. Tabela AssinaturaDigital criada do zero
      para assinatura com hash SHA-256 (RN-RF077-003).
    documentacao_item_relacionado: "RN-RF077-003"
    uc_relacionado: "UC06"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF077-020"
    tipo: "componente"
    nome: "tblFotosOS"
    caminho: "Database/dbo.tblFotosOS"
    descricao: |
      Tabela de fotos com caminho de arquivo em VARCHAR.
      PROBLEMAS:
      - Sem blob storage (caminho em VARCHAR)
      - Sem metadados EXIF
    destino: "substituido"
    justificativa: |
      Migrado para tabela FotosEvidencia com:
      - Blob storage (caminho em URL externa)
      - Metadados EXIF validados (RN-RF077-009)
    documentacao_item_relacionado: "RN-RF077-009"
    uc_relacionado: "UC05"
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: 2

  # ----------------------------------------------------------------------------
  # REGRAS DE NEGÓCIO IMPLÍCITAS (código VB.NET)
  # ----------------------------------------------------------------------------
  - id: "LEG-RF077-021"
    tipo: "regra_negocio"
    nome: "Status de OS é String Livre"
    caminho: "ic1_legado/IControlIT/[Modulo]/NovaOS.aspx.vb"
    descricao: |
      Campo St_OS aceita qualquer string, não é ENUM.
      Code-behind valida apenas valores esperados, mas banco permite qualquer valor.
      PROBLEMA: Dados inconsistentes (ex: "Em Execucao" vs "Em Execução").
    destino: "substituido"
    justificativa: |
      Substituído por enum OrdemServicoStatus tipado no backend.
      Migração de dados requer script de limpeza pré-migração.
    documentacao_item_relacionado: "RN-RF077-001"
    uc_relacionado: null
    complexidade: "media"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF077-022"
    tipo: "regra_negocio"
    nome: "Transição de Estado Sem Validação"
    caminho: "ic1_legado/IControlIT/[Modulo]/NovaOS.aspx.vb"
    descricao: |
      Qualquer OS pode ser salva com qualquer status sem validação de fluxo.
      Code-behind não valida se transição é permitida.
      PROBLEMA: Estados inválidos no banco (ex: Rascunho → Concluída direto).
    destino: "substituido"
    justificativa: |
      Substituído por RN-RF077-001 que implementa validação estrita de transições.
    documentacao_item_relacionado: "RN-RF077-001"
    uc_relacionado: "UC03"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF077-023"
    tipo: "regra_negocio"
    nome: "Checklist Completude Não Validada"
    caminho: "ic1_legado/IControlIT/[Modulo]/ExecutarOS.aspx.vb"
    descricao: |
      Tela permite conclusão mesmo com itens de checklist vazios.
      Validação é opcional no client-side (JavaScript), pode ser bypassada.
      PROBLEMA: OS concluídas sem todas as atividades executadas.
    destino: "substituido"
    justificativa: |
      Substituído por RN-RF077-002 que bloqueia conclusão com checklist
      incompleto no backend.
    documentacao_item_relacionado: "RN-RF077-002"
    uc_relacionado: "UC06"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF077-024"
    tipo: "regra_negocio"
    nome: "Assinatura é Apenas Checkbox"
    caminho: "ic1_legado/IControlIT/[Modulo]/ExecutarOS.aspx.vb"
    descricao: |
      Campo "Assinatura" é CheckBox + TextField (nome do signatário).
      Sem captura de imagem, timestamp ou hash.
      PROBLEMA: Sem comprovação legal, fácil falsificação.
    destino: "substituido"
    justificativa: |
      Substituído por RN-RF077-003 que exige assinatura digital com hash SHA-256.
    documentacao_item_relacionado: "RN-RF077-003"
    uc_relacionado: "UC06"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF077-025"
    tipo: "regra_negocio"
    nome: "Disponibilidade de Técnico Não Verificada"
    caminho: "ic1_legado/IControlIT/[Modulo]/AgendaOS.aspx.vb"
    descricao: |
      Agendamento permite selecionar técnico sem verificar conflitos.
      Stored procedure pa_ValidarConflitoriosAgendamento não existe.
      PROBLEMA: Dupla alocação de técnicos.
    destino: "substituido"
    justificativa: |
      Substituído por RN-RF077-004 que valida disponibilidade automaticamente.
    documentacao_item_relacionado: "RN-RF077-004"
    uc_relacionado: "UC04"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

# ==============================================================================
# RASTREABILIDADE (Legado → Moderno)
# ==============================================================================

rastreabilidade:
  telas_legado_para_moderno:
    - legado: "OrdensSevico.aspx"
      moderno: "ordens-servico-list.component.ts (Angular)"
    - legado: "NovaOS.aspx"
      moderno: "ordens-servico-form.component.ts (Angular)"
    - legado: "AgendaOS.aspx"
      moderno: "ordens-servico-agenda.component.ts (Angular)"
    - legado: "ExecutarOS.aspx"
      moderno: "ordens-servico-executar.component.ts (Angular)"
    - legado: "RelatorioTecnico.aspx"
      moderno: "relatorio-tecnico.component.ts (Angular)"

  webservices_legado_para_moderno:
    - legado: "WSOrdensSevico.ObterOrdens()"
      moderno: "GET /api/ordens-servico"
    - legado: "WSOrdensSevico.CriarOrdem()"
      moderno: "POST /api/ordens-servico"
    - legado: "WSOrdensSevico.AtualizarOrdem()"
      moderno: "PUT /api/ordens-servico/{id}"
    - legado: "WSOrdensSevico.ConcluirOrdem()"
      moderno: "POST /api/ordens-servico/{id}/concluir"
    - legado: "WSOrdensSevico.ObterRelatorio()"
      moderno: "GET /api/relatorios/tecnico"

  tabelas_legado_para_moderno:
    - legado: "tblOrdensSevico"
      moderno: "OrdensSevico"
    - legado: "(inexistente)"
      moderno: "ChecklistItems"
    - legado: "(inexistente)"
      moderno: "RegistroPausaRetomada"
    - legado: "(inexistente)"
      moderno: "MaterialConsumido"
    - legado: "(inexistente)"
      moderno: "AssinaturaDigital"
    - legado: "tblFotosOS"
      moderno: "FotosEvidencia"

# ==============================================================================
# METADADOS DE VALIDAÇÃO
# ==============================================================================

validacao:
  total_itens_legado: 25
  total_com_destino: 25
  percentual_cobertura: 100%
  tipos_distribuicao:
    tela: 5
    webservice: 5
    stored_procedure: 4
    tabela: 6
    regra_negocio: 5
  destinos_distribuicao:
    assumido: 1  # tblOrdensSevico
    substituido: 18  # Telas, Webservices, Stored Procedures, Tabelas modificadas, Regras implícitas
    descartado: 6  # Tabelas inexistentes, Stored Procedure inexistente
    a_revisar: 0

# ==============================================================================
# CHANGELOG
# ==============================================================================

historico:
  - versao: "1.0"
    data: "2025-01-14"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Referência ao legado completa: 25 itens rastreados, 100% com destino, rastreabilidade completa"
