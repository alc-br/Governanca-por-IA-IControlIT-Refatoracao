# RF102: Relatórios e Análises

**Versão**: 2.0
**Data**: 2025-12-31
**Autor**: Claude Code
**EPIC**: EPIC011-INT-Integracoes
**Fase**: Fase 6 - Ativos, Auditoria e Integrações

---

## 1. OBJETIVO DO REQUISITO

Fornecer aos usuários do sistema IControlIT a capacidade de **criar**, **personalizar**, **executar**, **agendar** e **distribuir** relatórios analíticos e gerenciais, consolidando dados operacionais de múltiplos módulos (Ativos, Contratos, Faturas, Chamados, SLA, Auditoria) em formatos exportáveis (PDF, Excel, CSV, JSON, XML), com conformidade LGPD, auditoria completa e processamento assíncrono para relatórios volumosos.

Este documento define **o que o sistema deve fazer**, sob quais condições e quais garantias devem ser preservadas.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Criação de relatórios personalizados via designer visual (drag-and-drop)
- [x] Execução de relatórios predefinidos (templates por módulo)
- [x] Aplicação de filtros parametrizados
- [x] Exportação multi-formato (PDF, Excel, CSV, JSON, XML)
- [x] Agendamento de execuções periódicas (diário, semanal, mensal)
- [x] Envio automático por e-mail
- [x] Histórico de execuções com download (90 dias)
- [x] Processamento assíncrono via Hangfire (relatórios > 10.000 registros)
- [x] Conformidade LGPD (justificativa obrigatória para dados sensíveis)
- [x] Controle de acesso granular (RBAC)
- [x] Auditoria imutável de todas as execuções
- [x] Isolamento multi-tenant (ClienteId)

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (definida em WF-RF102)
- Tecnologia de geração de PDF/Excel (implementação decide)
- Layout, UX ou identidade visual específica
- Estratégia de deploy ou infraestrutura

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **Relatório** | Conjunto estruturado de dados apresentados em formato tabular, gráfico ou narrativo. Pode ser predefinido (template) ou personalizado (criado pelo usuário) |
| **Designer Visual** | Interface para seleção de campos, filtros e formatação sem conhecimento técnico ou SQL |
| **Agendamento** | Configuração de execução automática periódica (diária, semanal, mensal) com envio por e-mail |
| **Export** | Conversão de relatório para formato persistente (PDF, Excel, CSV, JSON, XML) |
| **Histórico** | Registro de todas as execuções anteriores com links para download (mantido por 90 dias) |
| **Campo Sensível** | Dado pessoal segundo LGPD (CPF, RG, Salário, Endereço, Telefone, Email, DataNascimento, NomeMãe, Dependentes) |
| **Tenant** | Unidade lógica de isolamento de dados (ClienteId) |
| **Justificativa LGPD** | Razão comercial documentada para acesso a dados pessoais |

---

## 4. FUNCIONALIDADES COBERTAS

1. **Criar Relatório Personalizado** - Designer visual permite seleção de até 20 campos, filtros, ordenação e formatação
2. **Executar Relatório Predefinido** - Templates prontos para cada módulo (Ativos, Contratos, Faturas, Chamados, SLA)
3. **Aplicar Filtros Parametrizados** - Parâmetros dinâmicos permitem reutilizar relatório com diferentes critérios
4. **Exportar Multi-Formato** - PDF (com logo), Excel (com formatação), CSV, JSON, XML
5. **Agendar Execução Periódica** - Até 10 relatórios agendados por usuário (diário, semanal, mensal)
6. **Enviar por E-mail Automaticamente** - Distribuição para múltiplos destinatários
7. **Consultar Histórico** - Rastrear todas as execuções anteriores (90 dias)
8. **Processar em Background** - Hangfire para relatórios > 10.000 registros
9. **Drill-Down e Análise** - Relatórios analíticos permitem análise profunda
10. **Compliance LGPD** - Justificativa obrigatória para dados sensíveis + auditoria

---

## 5. REGRAS DE NEGÓCIO

### RN-RF102-001: Relatório deve ter no mínimo 1 campo selecionado

**Descrição**: Um relatório válido deve ter pelo menos um campo de dados selecionado para exibição. Campos de filtro não contam.

**Justificativa**: Um relatório sem campos de dados é inútil.

**Critério de Aceite**:
- Campo ausente ou lista vazia → HTTP 400 "Relatório deve ter no mínimo 1 campo selecionado"
- Campo presente e válido → aceito

**Implementação Obrigatória**:
- Backend: Validação em CreateRelatórioCommandValidator
- Frontend: Validação antes de submit

---

### RN-RF102-002: Relatórios sensíveis exigem justificativa (LGPD)

**Descrição**: Quando um relatório incluir dados pessoais (CPF, RG, Salário, Endereço, Telefone, Email, DataNascimento, NomeMãe, Dependentes), o usuário deve fornecer justificativa comercial antes de gerar. A justificativa é auditada.

**Justificativa**: LGPD exige consentimento e rastreabilidade documentada.

**Critério de Aceite**:
- Relatório com campos sensíveis + justificativa ausente → HTTP 400 "Justificativa LGPD é obrigatória para acessar dados pessoais"
- Relatório com campos sensíveis + justificativa presente → aceito e auditado
- Relatório SEM campos sensíveis → justificativa opcional

**Campos Sensíveis**:
- CPF, RG, Salário, Endereço, Telefone, Email, DataNascimento, NomeMãe, Dependentes

---

### RN-RF102-003: Agendamento máximo 10 relatórios por usuário

**Descrição**: Um usuário pode agendar no máximo 10 relatórios recorrentes simultaneamente.

**Justificativa**: Prevenir abuso de recursos (executar 100+ relatórios diários consumiria muito processamento).

**Critério de Aceite**:
- Usuário com < 10 agendamentos → permitir novo
- Usuário com = 10 agendamentos → HTTP 400 "Você já possui 10 relatórios agendados. Cancele um para agendar novo."
- Agendamentos inativos não contam

---

### RN-RF102-004: Relatórios com > 10.000 registros processados em background

**Descrição**: Quando um relatório retorna mais de 10.000 registros após aplicação de filtros, deve ser processado assincronamente via Hangfire. Usuário recebe notificação quando pronto.

**Justificativa**: Evitar timeout HTTP e oferecer melhor UX.

**Critério de Aceite**:
- Estimativa <= 10.000 registros → processar síncrono (< 30s)
- Estimativa > 10.000 registros → enfileirar Hangfire + retornar JobId + status "Processando"
- Notificação ao usuário quando job concluir

---

### RN-RF102-005: Export PDF deve ter logo do cliente e metadados

**Descrição**: PDFs devem incluir cabeçalho com logo do cliente, título do relatório, data/hora de geração e nome do usuário que gerou.

**Justificativa**: PDFs corporativos devem ter identidade visual. Data/hora garante rastreabilidade.

**Critério de Aceite**:
- PDF gerado sem logo → rejeição (se logo disponível)
- PDF sem data/hora ou usuário → rejeição
- PDF completo → aceito

---

### RN-RF102-006: Relatórios com dados pessoais exigem permissão especial

**Descrição**: Para criar ou executar relatórios que incluam campos sensíveis, o usuário deve ter permissão `lgpd:relatorio:dados-sensiveis`.

**Justificativa**: Restrição de acesso previne exposição acidental de dados pessoais.

**Critério de Aceite**:
- Usuário SEM permissão + campos sensíveis selecionados → HTTP 403 "Você não tem permissão para acessar dados sensíveis"
- Usuário COM permissão + campos sensíveis → aceito

---

### RN-RF102-007: Histórico de relatórios mantido por 90 dias

**Descrição**: Todas as execuções são registradas com data, hora, usuário, filtros e link para download. Histórico mantido por 90 dias. Após 90 dias, registros e arquivos são automaticamente deletados.

**Justificativa**: Conformidade com políticas de retenção de dados.

**Critério de Aceite**:
- Relatório gerado → registro criado com DataExpiracao = hoje + 90 dias
- Após 90 dias → job Hangfire deleta registro + arquivo
- Download de relatório expirado → HTTP 404

---

### RN-RF102-008: Relatórios devem respeitar filtro multi-tenancy

**Descrição**: Todos os relatórios devem incluir filtro automático por ClienteId. Um usuário só pode ver dados do seu cliente.

**Justificativa**: Multi-tenancy é crítico para SaaS.

**Critério de Aceite**:
- Query sem ClienteId → rejeição automática
- Tentativa de acesso cross-tenant → HTTP 403
- Queries sempre filtram por ClienteId do usuário autenticado

---

### RN-RF102-009: Designer visual limitado a 20 campos

**Descrição**: No designer visual, o usuário pode selecionar no máximo 20 campos para incluir no relatório.

**Justificativa**: Relatórios com muitos campos ficam ilegíveis. 20 é limite razoável que cabe em A4 ou Excel.

**Critério de Aceite**:
- Seleção de 1-20 campos → aceito
- Tentativa de selecionar > 20 campos → HTTP 400 "Máximo 20 campos permitidos"

---

### RN-RF102-010: Auditoria obrigatória de todos os relatórios

**Descrição**: Toda execução gera registro de auditoria imutável incluindo: ClienteId, RelatórioId, UsuarioId, DataHora, FiltrosUtilizados, TamanoArquivo, JustificativaLGPD, IpUsuario, UserAgent.

**Justificativa**: Conformidade LGPD exige rastreabilidade. Auditoria imutável prova quem acessou o que, quando e por quê.

**Critério de Aceite**:
- Execução de relatório SEM registro de auditoria → bloqueio (bug crítico)
- Tentativa de deletar auditoria → HTTP 403 (imutável)
- Auditoria com todos os campos obrigatórios → aceito

---

## 6. ESTADOS DO RELATÓRIO

| Estado | Descrição |
|--------|-----------|
| **Rascunho** | Criado, não finalizado |
| **Ativo** | Disponível para execução |
| **Inativo** | Desabilitado temporariamente |
| **Excluído** | Excluído logicamente (soft delete) |

### Transições permitidas

| De | Para |
|----|------|
| Rascunho | Ativo |
| Ativo | Inativo |
| Inativo | Ativo |
| Ativo | Excluído |
| Inativo | Excluído |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre |
|--------|---------------|
| `relatorio.criado` | Após criação de relatório personalizado |
| `relatorio.atualizado` | Após edição de relatório |
| `relatorio.executado` | Após execução com sucesso |
| `relatorio.agendado` | Após criação de agendamento |
| `relatorio.enviado` | Após envio por e-mail |
| `relatorio.expirado` | Após 90 dias (histórico deletado) |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- Nenhuma operação pode violar isolamento de tenant (ClienteId)
- Nenhuma regra de negócio pode ser ignorada
- Dados sensíveis sempre exigem justificativa LGPD
- Auditoria deve ser imutável e completa
- Relatórios > 10.000 registros devem usar Hangfire
- Histórico mantido exatamente 90 dias
- Export PDF deve ter logo + metadados
- Máximo 20 campos por relatório
- Máximo 10 agendamentos por usuário

---

## 9. INTEGRAÇÕES OBRIGATÓRIAS

### 9.1 Central de Funcionalidades (Feature Flags)

| FeatureKey | Nome | Descrição |
|------------|------|-----------|
| `RELATORIO_DESIGNER_VISUAL` | Designer Visual de Relatórios | Permite criar relatórios sem SQL |
| `RELATORIO_AGENDAMENTO` | Agendamento de Relatórios | Execução automática periódica |
| `RELATORIO_BACKGROUND_PROCESSING` | Processamento em Background | Hangfire para relatórios > 10k registros |
| `RELATORIO_LGPD_COMPLIANCE` | Conformidade LGPD | Justificativa obrigatória para dados sensíveis |

### 9.2 Internacionalização (i18n)

Chaves obrigatórias (pt-BR, en, es):

- `relatorio.titulo` → "Relatórios e Análises" / "Reports and Analysis" / "Informes y Análisis"
- `relatorio.listagem.novo` → "Novo Relatório" / "New Report" / "Nuevo Informe"
- `relatorio.designer.maxCampos` → "Máximo 20 campos" / "Maximum 20 fields" / "Máximo 20 campos"
- `relatorio.validacoes.justificativaLGPDObrigatoria` → "Justificativa LGPD é obrigatória para acessar dados pessoais"

### 9.3 Auditoria

Operações auditadas:

| Operação | Código | Dados Registrados |
|----------|--------|-------------------|
| Criar Relatório | `REL_RELATORIO_CREATE` | ClienteId, Nome, Módulo, CamposSelecionados, Filtros, UsuarioId |
| Executar Relatório | `REL_RELATORIO_EXECUTE` | ClienteId, RelatórioId, FiltrosUtilizados, TamanoArquivo, JustificativaLGPD, UsuarioId, IpUsuario |
| Agendar Relatório | `REL_AGENDAMENTO_CREATE` | ClienteId, RelatórioId, Frequência, EmailsDestinatarios, UsuarioId |

**Retenção**: 7 anos (Lei de Acesso à Informação + LGPD)

### 9.4 Controle de Acesso (RBAC)

| Permissão | Descrição | Perfis |
|-----------|-----------|--------|
| `relatorio:relatorio:create` | Criar relatório | Analista, Gerente, Administrador |
| `relatorio:relatorio:read` | Visualizar relatórios | Analista, Gerente, Administrador, Operador |
| `relatorio:relatorio:update` | Editar relatório | Gerente, Administrador |
| `relatorio:relatorio:delete` | Excluir relatório | Administrador |
| `relatorio:relatorio:execute` | Executar relatório | Analista, Gerente, Administrador, Operador |
| `relatorio:relatorio:export` | Exportar relatório | Analista, Gerente, Administrador, Operador |
| `relatorio:agendamento:create` | Agendar execução | Gerente, Administrador |
| `lgpd:relatorio:dados-sensiveis` | Acessar dados pessoais | Gerente RH, Administrador (restrito) |
| `audit:relatorio:read` | Visualizar auditoria | Administrador, Compliance Officer |

---

## 10. SEGURANÇA

### 10.1 Proteções Implementadas

| Proteção | Descrição |
|----------|-----------|
| **Multi-tenancy por ClienteId** | Todas as queries filtram por ClienteId |
| **RBAC** | Permissões granulares controlam cada operação |
| **LGPD Justificativa Obrigatória** | Acesso a dados pessoais exige justificativa documentada |
| **Auditoria Imutável** | Registros sem permissão DELETE |
| **Expiração de Histórico** | Arquivos expiram após 90 dias |
| **SQL Injection Prevention** | EF Core + LINQ (sem SQL inline) |
| **XSS Protection** | Frontend sanitiza automaticamente |
| **CSRF Protection** | Tokens anti-CSRF em POST/PUT/DELETE |
| **IP Logging** | IP registrado em auditoria |

### 10.2 Testes de Segurança Obrigatórios

- [ ] SQL Injection em filtros
- [ ] XSS em nome de relatório
- [ ] CSRF sem token
- [ ] Validação de permissões
- [ ] Multi-tenancy cross-tenant
- [ ] LGPD sem justificativa
- [ ] Tentativa de deletar auditoria
- [ ] Download de histórico expirado

---

## 11. ENDPOINTS DA API

### 11.1 CRUD Principal

| Método | Endpoint | Descrição | Permissão |
|--------|----------|-----------|-----------|
| GET | `/api/relatorios` | Listar relatórios | `relatorio:relatorio:read` |
| GET | `/api/relatorios/{id}` | Obter definição | `relatorio:relatorio:read` |
| POST | `/api/relatorios` | Criar relatório | `relatorio:relatorio:create` |
| PUT | `/api/relatorios/{id}` | Atualizar relatório | `relatorio:relatorio:update` |
| DELETE | `/api/relatorios/{id}` | Excluir relatório | `relatorio:relatorio:delete` |

### 11.2 Operações Especiais

| Método | Endpoint | Descrição | Permissão |
|--------|----------|-----------|-----------|
| POST | `/api/relatorios/{id}/executar` | Executar relatório | `relatorio:relatorio:execute` |
| POST | `/api/relatorios/{id}/export/pdf` | Exportar PDF | `relatorio:relatorio:export` |
| POST | `/api/relatorios/{id}/export/excel` | Exportar Excel | `relatorio:relatorio:export` |
| POST | `/api/relatorios/{id}/export/csv` | Exportar CSV | `relatorio:relatorio:export` |
| POST | `/api/relatorios/{id}/agendar` | Agendar execução | `relatorio:agendamento:create` |
| GET | `/api/relatorios/{id}/historico` | Histórico de execuções | `relatorio:relatorio:read` |
| GET | `/api/relatorios/predefinidos/{modulo}` | Templates predefinidos | `relatorio:relatorio:read` |
| GET | `/api/relatorios/{id}/preview` | Preview (100 linhas) | `relatorio:relatorio:read` |

---

## 12. MÉTRICAS E INDICADORES

### 12.1 KPIs

| KPI | Meta | Medição |
|-----|------|---------|
| **Tempo Médio de Execução** | < 5s para < 1.000 linhas | AVG(DataFim - DataInicio) |
| **Taxa de Sucesso** | > 98% | (Total - Falhados) / Total |
| **Relatórios Criados/Mês** | > 5 novos por cliente | COUNT(*) WHERE MONTH(DataCriacao) = MONTH(NOW()) |
| **Agendamentos Ativos** | 3-5 por usuário | COUNT(*) WHERE Ativo = true |
| **Tamanho Médio Arquivo** | < 5 MB | AVG(TamanoArquivo) |

### 12.2 Alertas

| Alerta | Condição | Ação |
|--------|----------|------|
| **Relatório Lento** | Execução > 30s | Notificar usuário + verificar índices |
| **Falha Hangfire** | Job falha 3x | Email suporte com log |
| **Armazenamento Cheio** | Blob > 80% quota | Alertar DevOps |
| **Acesso Dados Sensíveis** | Múltiplos acessos LGPD em 1h | Flag para análise |
| **Auditoria Desabilitada** | Nenhuma auditoria em 24h | CRÍTICO - parar sistema |

---

## 13. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF102.md** (Casos de Uso) - Obrigatório
- **MD-RF102.md** (Modelo de Dados) - Obrigatório
- **WF-RF102.md** (Wireframes e Fluxos) - Obrigatório
- **TC-RF102.yaml** (Casos de Teste) - Obrigatório
- **MT-RF102.yaml** (Massas de Teste) - Obrigatório

---

## 14. RASTREABILIDADE

| Artefato | Status | Obrigatório |
|----------|--------|-------------|
| Casos de Uso | Pendente | Sim |
| Modelo de Dados | Pendente | Sim |
| Wireframes | Pendente | Sim |
| Casos de Teste | Pendente | Sim |
| Massas de Teste | Pendente | Sim |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-31 | Migração v1.0 → v2.0 - Separação RF/RL completa | Claude Code |
| 1.0 | 2025-12-28 | Versão inicial (misturada com legado) | Claude Code |
