# RF-087: Gestão de Integrações e APIs Externas

**Versão**: 2.0
**Data**: 2025-12-31
**Autor**: Agência ALC - alc.dev.br
**EPIC**: EPIC011-INT - Integrações
**Fase**: Fase 6 - Ativos, Auditoria e Integrações

---

## 1. VISÃO GERAL

### 1.1 Resumo Executivo

Este requisito funcional define a gestão completa de integrações com sistemas externos no IControlIT. O sistema permite configurar, monitorar e executar integrações com múltiplos protocolos (REST API, SOAP, GraphQL, Webhooks, FTP/SFTP, LDAP) com recursos avançados de resiliência (Circuit Breaker, Rate Limiting, Retry com Backoff).

### 1.2 Objetivo Principal

Permitir que administradores configurem e gerenciem integrações com sistemas externos de forma segura, monitorável e resiliente, garantindo isolamento por tenant, criptografia de credenciais e rastreabilidade completa de execuções.

### 1.3 Escopo

**Dentro do escopo:**
- Criação, edição, visualização e desativação de integrações
- Suporte a múltiplos tipos de integração (REST API, SOAP, GraphQL, Webhooks, FTP/SFTP, LDAP)
- Múltiplos métodos de autenticação (Basic, Bearer, API Key, OAuth2, mTLS)
- Circuit Breaker para proteção contra falhas em cascata
- Rate Limiting para controle de requisições
- Retry automático com backoff exponencial
- Webhooks de entrada e saída com validação HMAC
- Processamento assíncrono com filas
- Estatísticas de execução (total, sucesso, erro, tempo médio)
- Execução manual de testes de conectividade
- Auditoria completa de operações
- Multi-tenancy com isolamento por empresa

**Fora do escopo:**
- Interface visual específica (definida em WF-RF087.md)
- Desenvolvimento de conectores customizados (código adicional)
- Transformação de dados (ETL) - apenas transporte
- Agendamento de execuções (coberto por outro RF)

---

## 2. FUNCIONALIDADES

### 2.1 Listagem de Integrações
**Prioridade:** ALTA
Visualizar todas as integrações cadastradas com filtros por tipo, status e busca por código/nome.

### 2.2 Criação de Integração
**Prioridade:** CRÍTICA
Configurar nova integração definindo tipo, URL base, autenticação, timeout, retry, circuit breaker e rate limiting.

### 2.3 Edição de Integração
**Prioridade:** ALTA
Atualizar parâmetros de integração existente, incluindo credenciais e configurações de resiliência.

### 2.4 Visualização de Detalhes
**Prioridade:** ALTA
Exibir detalhes completos da integração, incluindo estatísticas de execução, estado do circuit breaker e endpoints configurados.

### 2.5 Ativação/Desativação
**Prioridade:** ALTA
Controlar status ativo/inativo da integração sem excluir dados.

### 2.6 Execução Manual
**Prioridade:** MÉDIA
Executar teste de conectividade ou chamar endpoint específico manualmente.

### 2.7 Monitoramento de Execuções
**Prioridade:** ALTA
Visualizar histórico de execuções com request, response, duração e status.

### 2.8 Gestão de Endpoints
**Prioridade:** MÉDIA
Configurar múltiplos endpoints para uma integração (ex: GET /users, POST /users).

---

## 3. REGRAS DE NEGÓCIO

### RN-RF087-001: Código Único de Integração
**Descrição:** Cada integração deve possuir um código único identificador no contexto da empresa.
**Criticidade:** CRÍTICA
**Validação:**
- Backend: Validar unicidade no comando CreateIntegracaoCommand
- API: Retornar HTTP 409 (Conflict) se código já existir
- UI: Exibir mensagem "Código já cadastrado para esta empresa"

---

### RN-RF087-002: Tipos de Integração Suportados
**Descrição:** O sistema suporta apenas tipos específicos de integração.
**Criticidade:** CRÍTICA
**Validação:**
- Valores permitidos: REST_API, SOAP, GRAPHQL, WEBHOOK_IN, WEBHOOK_OUT, FTP, SFTP, LDAP
- Backend: Enum TipoIntegracao com validação
- API: Retornar HTTP 400 se tipo inválido
- UI: Dropdown com apenas valores permitidos

---

### RN-RF087-003: Métodos de Autenticação Permitidos
**Descrição:** Diferentes métodos de autenticação conforme padrões da indústria.
**Criticidade:** CRÍTICA
**Validação:**
- Valores permitidos: NONE, BASIC, BEARER, API_KEY, OAUTH2, MTLS
- Backend: Enum AutenticacaoTipo com validação
- API: Retornar HTTP 400 se tipo inválido
- UI: Dropdown com apenas valores permitidos
- Credenciais devem ser compatíveis com método escolhido

---

### RN-RF087-004: Credenciais Criptografadas
**Descrição:** Credenciais sensíveis devem ser armazenadas de forma segura e nunca expostas.
**Criticidade:** CRÍTICA
**Validação:**
- Backend: Criptografar campo CredenciaisJson antes de salvar no banco
- API: Nunca retornar credenciais em respostas GET (mascarar ou omitir)
- Logs: Nunca registrar credenciais em logs de aplicação
- Auditoria: Registrar apenas "credenciais alteradas" sem valores

---

### RN-RF087-005: Timeout Configurável
**Descrição:** Requisições devem ter timeout configurável para evitar travamentos.
**Criticidade:** ALTA
**Validação:**
- Range permitido: 1 a 300 segundos
- Valor padrão: 30 segundos
- Backend: Validar range no CreateIntegracaoCommandValidator
- API: Retornar HTTP 400 se valor fora do range
- UI: Input numérico com validação de range

---

### RN-RF087-006: Circuit Breaker
**Descrição:** Proteção contra falhas em cascata com padrão Circuit Breaker.
**Criticidade:** ALTA
**Validação:**
- Estados: CLOSED (normal), OPEN (bloqueado), HALF_OPEN (testando)
- Threshold padrão: 5 falhas consecutivas
- Duração padrão: 60 segundos com circuito aberto
- Backend: Implementar lógica de transição de estados
- API: Retornar HTTP 503 (Service Unavailable) se circuito aberto
- UI: Exibir status visual do circuito (verde/amarelo/vermelho)

---

### RN-RF087-007: Rate Limiting
**Descrição:** Limitar quantidade de requisições por período para evitar sobrecarga.
**Criticidade:** MÉDIA
**Validação:**
- Configurável: N requisições em X segundos
- Padrão: 100 requisições em 60 segundos
- Backend: Implementar sliding window counter
- API: Retornar HTTP 429 (Too Many Requests) se limite excedido
- Response Header: X-RateLimit-Remaining com contador

---

### RN-RF087-008: Retry com Backoff Exponencial
**Descrição:** Retentativas automáticas em caso de falha com delay crescente.
**Criticidade:** MÉDIA
**Validação:**
- Máximo de tentativas: 3 (configurável)
- Delay padrão: 1000ms no primeiro retry
- Backoff: exponencial (1s, 2s, 4s)
- Backend: Implementar lógica de retry no handler
- Auditoria: Registrar cada tentativa
- API: Cabeçalho X-Retry-Count com número da tentativa

---

### RN-RF087-009: Validação de URL Base
**Descrição:** URL base deve ser válida e seguir formato correto.
**Criticidade:** ALTA
**Validação:**
- Formato: protocolo + domínio (ex: https://api.example.com)
- Protocolos permitidos: http, https, ftp, ftps
- Backend: Regex de validação de URL
- API: Retornar HTTP 400 se URL inválida
- UI: Validação de formato em tempo real
- Teste de conectividade: opcional ao salvar

---

### RN-RF087-010: Certificados SSL
**Descrição:** Opção para aceitar certificados SSL inválidos (apenas desenvolvimento).
**Criticidade:** ALTA
**Validação:**
- Flag: AceitarCertificadoInvalido
- Bloqueio: Não permitir em ambiente de produção
- Backend: Verificar variável de ambiente ASPNETCORE_ENVIRONMENT
- API: Retornar HTTP 403 se tentar habilitar em produção
- UI: Campo desabilitado em produção com tooltip explicativo

---

### RN-RF087-011: Endpoints Configuráveis
**Descrição:** Cada integração pode ter múltiplos endpoints configurados.
**Criticidade:** MÉDIA
**Validação:**
- Endpoints herdam configurações da integração pai
- Path deve ser relativo à baseUrl
- Métodos HTTP permitidos: GET, POST, PUT, PATCH, DELETE
- Backend: Tabela IntegracaoEndpoint com FK para Integracao
- API: CRUD completo de endpoints
- UI: Grid editável de endpoints

---

### RN-RF087-012: Estatísticas de Execução
**Descrição:** Manter métricas de uso de cada integração para monitoramento.
**Criticidade:** MÉDIA
**Validação:**
- Métricas: Total, Sucesso, Erro, Timeout, Tempo médio/min/max
- Atualização: Após cada execução (síncrona ou assíncrona)
- Backend: Aggregate calculado a partir de IntegracaoExecucao
- API: Endpoint GET /api/integracoes/{id}/estatisticas
- UI: Dashboard com gráficos de linha e pizza

---

### RN-RF087-013: Webhooks com Validação HMAC
**Descrição:** Webhooks devem ser protegidos por secret para validar origem.
**Criticidade:** ALTA
**Validação:**
- Secret: String aleatória de 32+ caracteres
- Assinatura: HMAC-SHA256 do payload
- Header: X-Webhook-Signature
- Backend: Calcular HMAC e comparar com header recebido
- API: Retornar HTTP 401 se assinatura inválida
- Logs: Registrar tentativas de webhooks rejeitados

---

### RN-RF087-014: Filas de Processamento
**Descrição:** Processamento assíncrono para operações longas com retentativas.
**Criticidade:** MÉDIA
**Validação:**
- Máximo de retentativas: configurável (padrão: 3)
- Dead-letter queue: após esgotar tentativas
- Backend: Hangfire para processamento de jobs
- API: Endpoint POST /api/integracoes/{id}/enqueue
- UI: Badge com contador de jobs pendentes
- Monitoramento: Dashboard Hangfire

---

### RN-RF087-015: Auditoria de Execuções
**Descrição:** Registrar todas as execuções para rastreabilidade e debugging.
**Criticidade:** ALTA
**Validação:**
- Campos registrados: Request, Response, Duração, Status, Erros
- Retenção: 90 dias (configurável)
- Backend: Tabela IntegracaoExecucao com insert após cada execução
- API: Endpoint GET /api/integracoes/{id}/execucoes com paginação
- UI: Grid com filtros de data, status e busca
- Dados sensíveis: Mascarar credenciais no request/response

---

## 4. INTEGRAÇÕES OBRIGATÓRIAS

### 4.1 Internacionalização (i18n)

**Framework:** Transloco
**Idiomas:** pt-BR (padrão), en, es

**Chaves obrigatórias (prefixo `integracoes.`):**
```
integracoes.title
integracoes.list.title
integracoes.create.title
integracoes.edit.title
integracoes.details.title
integracoes.form.codigo
integracoes.form.nome
integracoes.form.descricao
integracoes.form.tipo
integracoes.form.baseUrl
integracoes.form.autenticacao
integracoes.form.timeout
integracoes.form.circuitBreaker
integracoes.form.rateLimit
integracoes.status.ativo
integracoes.status.inativo
integracoes.circuitBreaker.open
integracoes.circuitBreaker.closed
integracoes.circuitBreaker.halfOpen
integracoes.messages.created
integracoes.messages.updated
integracoes.messages.executed
integracoes.messages.activated
integracoes.messages.deactivated
integracoes.errors.duplicateCode
integracoes.errors.invalidUrl
integracoes.errors.circuitOpen
integracoes.errors.rateLimitExceeded
```

---

### 4.2 Auditoria

Todas as operações devem ser auditadas automaticamente via `AuditInterceptor`:

**Operações auditadas:**
- Criação de integração
- Edição de integração
- Ativação/Desativação
- Execução manual
- Alteração de credenciais (registrar apenas "alteradas", não valores)
- Alteração de endpoints

**Campos de auditoria (automáticos):**
- Created (DateTime)
- CreatedBy (UserId)
- LastModified (DateTime?)
- LastModifiedBy (UserId?)

---

### 4.3 RBAC (Role-Based Access Control)

**Permission Codes:**
- `INTEGRACOES.VIEW` - Visualizar integrações
- `INTEGRACOES.CREATE` - Criar integração
- `INTEGRACOES.EDIT` - Editar integração
- `INTEGRACOES.DELETE` - Excluir integração (desativação)
- `INTEGRACOES.EXECUTE` - Executar integração manualmente
- `INTEGRACOES.ADMIN` - Administrar todas as configurações

**Matriz de Permissões:**

| Funcionalidade | Super Admin | Admin | Operador | Auditor |
|----------------|-------------|-------|----------|---------|
| Visualizar | ✅ | ✅ | ✅ | ✅ |
| Criar | ✅ | ✅ | ❌ | ❌ |
| Editar | ✅ | ✅ | ❌ | ❌ |
| Excluir | ✅ | ❌ | ❌ | ❌ |
| Executar | ✅ | ✅ | ✅ | ❌ |
| Administrar | ✅ | ❌ | ❌ | ❌ |

---

### 4.4 Central de Funcionalidades

**Feature Code:** `INTEGRACOES`

**Registro obrigatório:**
```csharp
new Funcionalidade
{
    Id = Guid.NewGuid(),
    Codigo = "INTEGRACOES",
    Nome = "Gestão de Integrações",
    Descricao = "Configuração e monitoramento de integrações com sistemas externos",
    Modulo = "Integrações",
    Icone = "heroicons_outline:globe-alt",
    Rota = "/integracoes",
    Ordem = 100,
    Ativo = true,
    Permissions = new List<string>
    {
        "INTEGRACOES.VIEW",
        "INTEGRACOES.CREATE",
        "INTEGRACOES.EDIT",
        "INTEGRACOES.DELETE",
        "INTEGRACOES.EXECUTE",
        "INTEGRACOES.ADMIN"
    }
}
```

---

## 5. PERMISSÕES RBAC

### Matriz Completa

| Permission Code | Descrição | Endpoint | Roles Autorizadas |
|----------------|-----------|----------|-------------------|
| INTEGRACOES.VIEW | Visualizar integrações | GET /api/integracoes | Super Admin, Admin, Operador, Auditor |
| INTEGRACOES.CREATE | Criar integração | POST /api/integracoes | Super Admin, Admin |
| INTEGRACOES.EDIT | Editar integração | PUT /api/integracoes/{id} | Super Admin, Admin |
| INTEGRACOES.DELETE | Excluir integração | DELETE /api/integracoes/{id} | Super Admin |
| INTEGRACOES.EXECUTE | Executar integração | POST /api/integracoes/{id}/execute | Super Admin, Admin, Operador |
| INTEGRACOES.ADMIN | Administrar tudo | Todos os endpoints | Super Admin |

---

## 6. API ENDPOINTS

### 6.1 Listar Integrações
- **Método:** GET
- **Rota:** `/api/integracoes`
- **Autenticação:** Obrigatória
- **Authorization Policy:** `IntegracoesRead`
- **Request DTO:** Query parameters (pageNumber, pageSize, tipo, ativo, search)
- **Response DTO:** `PaginatedListDto<IntegracaoDto>`

---

### 6.2 Obter Integração por ID
- **Método:** GET
- **Rota:** `/api/integracoes/{id}`
- **Autenticação:** Obrigatória
- **Authorization Policy:** `IntegracoesRead`
- **Request DTO:** null
- **Response DTO:** `IntegracaoDto`

---

### 6.3 Criar Integração
- **Método:** POST
- **Rota:** `/api/integracoes`
- **Autenticação:** Obrigatória
- **Authorization Policy:** `IntegracoesCreate`
- **Request DTO:** `CreateIntegracaoCommand`
- **Response DTO:** `Guid` (ID da integração criada)

---

### 6.4 Atualizar Integração
- **Método:** PUT
- **Rota:** `/api/integracoes/{id}`
- **Autenticação:** Obrigatória
- **Authorization Policy:** `IntegracoesUpdate`
- **Request DTO:** `UpdateIntegracaoCommand`
- **Response DTO:** `void`

---

### 6.5 Excluir Integração (Desativar)
- **Método:** DELETE
- **Rota:** `/api/integracoes/{id}`
- **Autenticação:** Obrigatória
- **Authorization Policy:** `IntegracoesDelete`
- **Request DTO:** null
- **Response DTO:** `void`

---

### 6.6 Executar Integração
- **Método:** POST
- **Rota:** `/api/integracoes/{id}/execute`
- **Autenticação:** Obrigatória
- **Authorization Policy:** `IntegracoesExecute`
- **Request DTO:** `ExecuteIntegracaoCommand` (opcional: endpointId, payload)
- **Response DTO:** `IntegracaoExecucaoDto`

---

### 6.7 Obter Estatísticas
- **Método:** GET
- **Rota:** `/api/integracoes/{id}/estatisticas`
- **Autenticação:** Obrigatória
- **Authorization Policy:** `IntegracoesRead`
- **Request DTO:** Query parameters (dataInicio, dataFim)
- **Response DTO:** `IntegracaoEstatisticasDto`

---

### 6.8 Listar Execuções
- **Método:** GET
- **Rota:** `/api/integracoes/{id}/execucoes`
- **Autenticação:** Obrigatória
- **Authorization Policy:** `IntegracoesRead`
- **Request DTO:** Query parameters (pageNumber, pageSize, sucesso, dataInicio, dataFim)
- **Response DTO:** `PaginatedListDto<IntegracaoExecucaoDto>`

---

## 7. MODELO DE DADOS

### 7.1 Referência ao Arquivo MD-RF087.md

O modelo de dados completo está documentado em **MD-RF087.md** (Modelo de Dados).

### 7.2 Principais Entidades

- **Integracao** - Configuração principal da integração
- **IntegracaoEndpoint** - Endpoints configurados para a integração
- **IntegracaoExecucao** - Log de execuções para auditoria

### 7.3 Relacionamentos Críticos

- `Integracao.EmpresaId` → `Empresa.Id` (multi-tenancy)
- `IntegracaoEndpoint.IntegracaoId` → `Integracao.Id` (1:N)
- `IntegracaoExecucao.IntegracaoId` → `Integracao.Id` (1:N)
- `IntegracaoExecucao.EndpointId` → `IntegracaoEndpoint.Id` (1:N, opcional)

---

## 8. DEPENDÊNCIAS

### 8.1 RFs Upstream (Pré-requisitos)

- **RF-006** - Gestão de Usuários (permissões RBAC)
- **RF-007** - Gestão de Perfis de Acesso (roles)
- **RF-008** - Gestão de Empresas (multi-tenancy)

### 8.2 RFs Downstream (Dependentes deste RF)

- Nenhum RF depende diretamente deste (funcionalidade nova)

### 8.3 Bibliotecas Externas

- **Polly** - Circuit Breaker e Retry policies
- **Hangfire** - Processamento de jobs assíncronos
- **System.Security.Cryptography** - Criptografia de credenciais
- **FluentValidation** - Validações de comandos

---

## 9. KPIs E MÉTRICAS

### 9.1 Taxa de Sucesso de Integrações
- **Descrição:** Percentual de execuções bem-sucedidas
- **Meta:** >= 95%
- **Log Obrigatório:** Sim
- **Cálculo:** (Execuções com sucesso / Total de execuções) * 100

---

### 9.2 Tempo Médio de Resposta
- **Descrição:** Tempo médio de resposta das integrações
- **Meta:** <= 500ms
- **Log Obrigatório:** Sim
- **Cálculo:** Média de DuracaoMs de IntegracaoExecucao

---

### 9.3 Taxa de Erro de Circuit Breaker
- **Descrição:** Percentual de requisições bloqueadas por circuito aberto
- **Meta:** < 1%
- **Log Obrigatório:** Sim
- **Cálculo:** (Requisições bloqueadas / Total de tentativas) * 100

---

### 9.4 Violações de Rate Limit
- **Descrição:** Quantidade de requisições rejeitadas por rate limit
- **Meta:** < 5% do total
- **Log Obrigatório:** Sim
- **Cálculo:** Contador de respostas HTTP 429

---

## 10. ALERTAS CRÍTICOS

### 10.1 Falha em Integração Crítica
- **Evento:** Mais de 5 falhas consecutivas em integração marcada como crítica
- **Threshold:** > 5 falhas em 5 minutos
- **Severidade:** CRÍTICA
- **Canal de Notificação:** Email, Slack, SMS

---

### 10.2 Circuit Breaker Aberto
- **Evento:** Circuit Breaker de integração aberto
- **Threshold:** Estado OPEN por mais de 60 segundos
- **Severidade:** ALTA
- **Canal de Notificação:** Email, Slack

---

### 10.3 Credenciais Expiradas
- **Evento:** Tentativa de executar integração com credenciais OAuth2 expiradas
- **Threshold:** Imediato
- **Severidade:** MÉDIA
- **Canal de Notificação:** Email

---

### 10.4 Tentativa de Acesso Sem Permissão
- **Evento:** Usuário sem permissão tenta executar/editar integração
- **Threshold:** > 10 tentativas em 5 minutos
- **Severidade:** ALTA
- **Canal de Notificação:** Email, Slack, Log de Segurança

---

## 11. CENTRAL DE FUNCIONALIDADES

### 11.1 Registro da Funcionalidade

**Código:** `INTEGRACOES`
**Módulo:** Integrações
**Rota:** `/integracoes`
**Ícone:** `heroicons_outline:globe-alt`
**Ordem:** 100

### 11.2 Chaves i18n para Menu

```json
{
  "menu.integracoes": "Integrações",
  "menu.integracoes.description": "Gestão de integrações com sistemas externos"
}
```

---

## HISTÓRICO DE VERSÕES

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 1.0 | 2025-01-19 | Documentação reversa inicial | Claude |
| 2.0 | 2025-12-31 | Migração para governança v2.0 (separação RF/RL) | Agência ALC - alc.dev.br |
