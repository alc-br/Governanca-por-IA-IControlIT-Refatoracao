# =============================================
# RF-087 - Gestão de Integrações e APIs Externas
# Versão: 2.0
# Autor: Agência ALC - alc.dev.br
# Data: 2025-12-31
# =============================================

rf:
  id: "RF087"
  nome: "Gestão de Integrações e APIs Externas"
  versao: "2.0"
  versao_governanca: "2.0"
  data: "2025-12-31"
  data_migracao: "2025-12-31"
  fase: "Fase 6 - Ativos, Auditoria e Integrações"
  epic: "EPIC011-INT-Integracoes"
  status: "aprovado"

descricao:
  objetivo: "Permitir que administradores configurem e gerenciem integrações com sistemas externos de forma segura, monitorável e resiliente, garantindo isolamento por tenant, criptografia de credenciais e rastreabilidade completa de execuções."
  problema_resolvido: "Necessidade de conectar o IControlIT com sistemas externos (ERPs, RH, Cloud, etc.) de forma padronizada, segura e resiliente, com monitoramento centralizado e controle de falhas."
  publico_afetado: "Administradores de sistema, desenvolvedores de integrações, gestores de TI."

escopo:
  incluso:
    - "Criação, edição, visualização e desativação de integrações"
    - "Suporte a múltiplos tipos de integração (REST API, SOAP, GraphQL, Webhooks, FTP/SFTP, LDAP)"
    - "Múltiplos métodos de autenticação (Basic, Bearer, API Key, OAuth2, mTLS)"
    - "Circuit Breaker para proteção contra falhas em cascata"
    - "Rate Limiting para controle de requisições"
    - "Retry automático com backoff exponencial"
    - "Webhooks de entrada e saída com validação HMAC"
    - "Processamento assíncrono com filas"
    - "Estatísticas de execução (total, sucesso, erro, tempo médio)"
    - "Execução manual de testes de conectividade"
    - "Auditoria completa de operações"
    - "Multi-tenancy com isolamento por empresa"
  fora:
    - "Interface visual específica (definida em WF-RF087.md)"
    - "Desenvolvimento de conectores customizados (código adicional)"
    - "Transformação de dados (ETL) - apenas transporte"
    - "Agendamento de execuções (coberto por outro RF)"

entidades:
  - nome: "Integracao"
    descricao: "Configuração principal da integração com sistema externo"
    multi_tenant: true
    soft_delete: false
    auditoria: true

  - nome: "IntegracaoEndpoint"
    descricao: "Endpoints configurados para uma integração"
    multi_tenant: false
    soft_delete: false
    auditoria: true

  - nome: "IntegracaoExecucao"
    descricao: "Log de execuções para auditoria e estatísticas"
    multi_tenant: false
    soft_delete: false
    auditoria: false

# ==============================================================================
# REGRAS DE NEGÓCIO
# ==============================================================================

regras_negocio:
  - id: "RN-RF087-001"
    titulo: "Código Único de Integração"
    descricao: "Cada integração deve possuir um código único identificador no contexto da empresa."
    criticidade: "CRÍTICA"
    tipo: "unicidade"
    campos_afetados: ["Codigo", "EmpresaId"]
    obrigatorio: true
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "unicidade"
      mensagem_erro: "Código já cadastrado para esta empresa"
      http_code: 409

  - id: "RN-RF087-002"
    titulo: "Tipos de Integração Suportados"
    descricao: "O sistema suporta apenas tipos específicos de integração."
    criticidade: "CRÍTICA"
    tipo: "validacao"
    campos_afetados: ["Tipo"]
    obrigatorio: true
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "enum"
      valores_permitidos: ["REST_API", "SOAP", "GRAPHQL", "WEBHOOK_IN", "WEBHOOK_OUT", "FTP", "SFTP", "LDAP"]
      mensagem_erro: "Tipo de integração inválido"
      http_code: 400

  - id: "RN-RF087-003"
    titulo: "Métodos de Autenticação Permitidos"
    descricao: "Diferentes métodos de autenticação conforme padrões da indústria."
    criticidade: "CRÍTICA"
    tipo: "validacao"
    campos_afetados: ["AutenticacaoTipo"]
    obrigatorio: true
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "enum"
      valores_permitidos: ["NONE", "BASIC", "BEARER", "API_KEY", "OAUTH2", "MTLS"]
      mensagem_erro: "Método de autenticação inválido"
      http_code: 400

  - id: "RN-RF087-004"
    titulo: "Credenciais Criptografadas"
    descricao: "Credenciais sensíveis devem ser armazenadas de forma segura e nunca expostas."
    criticidade: "CRÍTICA"
    tipo: "seguranca"
    campos_afetados: ["CredenciaisJson"]
    obrigatorio: true
    implementacao:
      backend: true
      frontend: false
      validacao_api: true
      validacao_ui: false
    validacao:
      tipo: "criptografia"
      mensagem_erro: "Erro ao processar credenciais"
      http_code: 500

  - id: "RN-RF087-005"
    titulo: "Timeout Configurável"
    descricao: "Requisições devem ter timeout configurável para evitar travamentos."
    criticidade: "ALTA"
    tipo: "validacao"
    campos_afetados: ["TimeoutSegundos"]
    obrigatorio: true
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "range"
      min: 1
      max: 300
      default: 30
      mensagem_erro: "Timeout deve estar entre 1 e 300 segundos"
      http_code: 400

  - id: "RN-RF087-006"
    titulo: "Circuit Breaker"
    descricao: "Proteção contra falhas em cascata com padrão Circuit Breaker."
    criticidade: "ALTA"
    tipo: "regra_negocio"
    campos_afetados: ["CircuitBreakerThreshold", "CircuitBreakerDuracaoSegundos"]
    obrigatorio: false
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "estado_maquina"
      estados: ["CLOSED", "OPEN", "HALF_OPEN"]
      threshold_default: 5
      duracao_default: 60
      mensagem_erro: "Serviço temporariamente indisponível (Circuit Breaker aberto)"
      http_code: 503

  - id: "RN-RF087-007"
    titulo: "Rate Limiting"
    descricao: "Limitar quantidade de requisições por período para evitar sobrecarga."
    criticidade: "MÉDIA"
    tipo: "regra_negocio"
    campos_afetados: ["RateLimitRequisicoes", "RateLimitPeriodoSegundos"]
    obrigatorio: false
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: false
    validacao:
      tipo: "rate_limit"
      default_requisicoes: 100
      default_periodo: 60
      mensagem_erro: "Limite de requisições excedido. Tente novamente mais tarde."
      http_code: 429

  - id: "RN-RF087-008"
    titulo: "Retry com Backoff Exponencial"
    descricao: "Retentativas automáticas em caso de falha com delay crescente."
    criticidade: "MÉDIA"
    tipo: "regra_negocio"
    campos_afetados: ["RetryTentativas", "RetryDelayMs"]
    obrigatorio: false
    implementacao:
      backend: true
      frontend: false
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "configuracao"
      max_tentativas: 3
      delay_default: 1000
      backoff: "exponencial"

  - id: "RN-RF087-009"
    titulo: "Validação de URL Base"
    descricao: "URL base deve ser válida e seguir formato correto."
    criticidade: "ALTA"
    tipo: "validacao"
    campos_afetados: ["BaseUrl"]
    obrigatorio: true
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "formato"
      regex: "^(http|https|ftp|ftps)://[a-zA-Z0-9.-]+(:[0-9]+)?(/.*)?$"
      mensagem_erro: "URL inválida. Formato esperado: protocolo://dominio"
      http_code: 400

  - id: "RN-RF087-010"
    titulo: "Certificados SSL"
    descricao: "Opção para aceitar certificados SSL inválidos (apenas desenvolvimento)."
    criticidade: "ALTA"
    tipo: "seguranca"
    campos_afetados: ["AceitarCertificadoInvalido"]
    obrigatorio: false
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "ambiente"
      bloqueio_producao: true
      mensagem_erro: "Aceitar certificados inválidos não é permitido em produção"
      http_code: 403

  - id: "RN-RF087-011"
    titulo: "Endpoints Configuráveis"
    descricao: "Cada integração pode ter múltiplos endpoints configurados."
    criticidade: "MÉDIA"
    tipo: "regra_negocio"
    campos_afetados: ["IntegracaoEndpoint.Path", "IntegracaoEndpoint.Metodo"]
    obrigatorio: false
    implementacao:
      backend: true
      frontend: true
      validacao_api: true
      validacao_ui: true
    validacao:
      tipo: "formato"
      metodos_permitidos: ["GET", "POST", "PUT", "PATCH", "DELETE"]

  - id: "RN-RF087-012"
    titulo: "Estatísticas de Execução"
    descricao: "Manter métricas de uso de cada integração para monitoramento."
    criticidade: "MÉDIA"
    tipo: "regra_negocio"
    campos_afetados: ["IntegracaoExecucao.*"]
    obrigatorio: true
    implementacao:
      backend: true
      frontend: true
      validacao_api: false
      validacao_ui: false

  - id: "RN-RF087-013"
    titulo: "Webhooks com Validação HMAC"
    descricao: "Webhooks devem ser protegidos por secret para validar origem."
    criticidade: "ALTA"
    tipo: "seguranca"
    campos_afetados: ["WebhookSecret"]
    obrigatorio: false
    implementacao:
      backend: true
      frontend: false
      validacao_api: true
      validacao_ui: false
    validacao:
      tipo: "hmac"
      algoritmo: "HMAC-SHA256"
      header: "X-Webhook-Signature"
      mensagem_erro: "Assinatura de webhook inválida"
      http_code: 401

  - id: "RN-RF087-014"
    titulo: "Filas de Processamento"
    descricao: "Processamento assíncrono para operações longas com retentativas."
    criticidade: "MÉDIA"
    tipo: "regra_negocio"
    campos_afetados: ["HabilitarFila", "FilaMaxRetentativas"]
    obrigatorio: false
    implementacao:
      backend: true
      frontend: true
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "configuracao"
      max_retentativas_default: 3

  - id: "RN-RF087-015"
    titulo: "Auditoria de Execuções"
    descricao: "Registrar todas as execuções para rastreabilidade e debugging."
    criticidade: "ALTA"
    tipo: "auditoria"
    campos_afetados: ["IntegracaoExecucao.*"]
    obrigatorio: true
    implementacao:
      backend: true
      frontend: false
      validacao_api: false
      validacao_ui: false
    validacao:
      tipo: "retencao"
      retencao_dias: 90
      mascarar_credenciais: true

# ==============================================================================
# PERMISSÕES RBAC
# ==============================================================================

permissoes_rbac:
  - permission_code: "INTEGRACOES.VIEW"
    descricao: "Visualizar integrações"
    roles_autorizadas:
      - "Super Admin"
      - "Admin"
      - "Operador"
      - "Auditor"
    endpoint: "GET /api/integracoes"

  - permission_code: "INTEGRACOES.CREATE"
    descricao: "Criar integração"
    roles_autorizadas:
      - "Super Admin"
      - "Admin"
    endpoint: "POST /api/integracoes"

  - permission_code: "INTEGRACOES.EDIT"
    descricao: "Editar integração"
    roles_autorizadas:
      - "Super Admin"
      - "Admin"
    endpoint: "PUT /api/integracoes/{id}"

  - permission_code: "INTEGRACOES.DELETE"
    descricao: "Excluir integração"
    roles_autorizadas:
      - "Super Admin"
    endpoint: "DELETE /api/integracoes/{id}"

  - permission_code: "INTEGRACOES.EXECUTE"
    descricao: "Executar integração manualmente"
    roles_autorizadas:
      - "Super Admin"
      - "Admin"
      - "Operador"
    endpoint: "POST /api/integracoes/{id}/execute"

  - permission_code: "INTEGRACOES.ADMIN"
    descricao: "Administrar todas as configurações"
    roles_autorizadas:
      - "Super Admin"
    endpoint: "Todos os endpoints"

# ==============================================================================
# API ENDPOINTS
# ==============================================================================

endpoints:
  - method: "GET"
    route: "/api/integracoes"
    descricao: "Listar integrações com paginação e filtros"
    autenticacao: true
    authorization_policy: "IntegracoesRead"
    request_dto: "Query parameters (pageNumber, pageSize, tipo, ativo, search)"
    response_dto: "PaginatedListDto<IntegracaoDto>"

  - method: "GET"
    route: "/api/integracoes/{id}"
    descricao: "Obter integração por ID"
    autenticacao: true
    authorization_policy: "IntegracoesRead"
    request_dto: null
    response_dto: "IntegracaoDto"

  - method: "POST"
    route: "/api/integracoes"
    descricao: "Criar nova integração"
    autenticacao: true
    authorization_policy: "IntegracoesCreate"
    request_dto: "CreateIntegracaoCommand"
    response_dto: "Guid"

  - method: "PUT"
    route: "/api/integracoes/{id}"
    descricao: "Atualizar integração existente"
    autenticacao: true
    authorization_policy: "IntegracoesUpdate"
    request_dto: "UpdateIntegracaoCommand"
    response_dto: "void"

  - method: "DELETE"
    route: "/api/integracoes/{id}"
    descricao: "Excluir integração (desativar)"
    autenticacao: true
    authorization_policy: "IntegracoesDelete"
    request_dto: null
    response_dto: "void"

  - method: "POST"
    route: "/api/integracoes/{id}/execute"
    descricao: "Executar integração manualmente"
    autenticacao: true
    authorization_policy: "IntegracoesExecute"
    request_dto: "ExecuteIntegracaoCommand"
    response_dto: "IntegracaoExecucaoDto"

  - method: "GET"
    route: "/api/integracoes/{id}/estatisticas"
    descricao: "Obter estatísticas de execução"
    autenticacao: true
    authorization_policy: "IntegracoesRead"
    request_dto: "Query parameters (dataInicio, dataFim)"
    response_dto: "IntegracaoEstatisticasDto"

  - method: "GET"
    route: "/api/integracoes/{id}/execucoes"
    descricao: "Listar histórico de execuções"
    autenticacao: true
    authorization_policy: "IntegracoesRead"
    request_dto: "Query parameters (pageNumber, pageSize, sucesso, dataInicio, dataFim)"
    response_dto: "PaginatedListDto<IntegracaoExecucaoDto>"

# ==============================================================================
# KPIs E MÉTRICAS
# ==============================================================================

kpis:
  - nome: "Taxa de Sucesso de Integrações"
    descricao: "Percentual de execuções bem-sucedidas"
    meta: ">= 95%"
    log_obrigatorio: true
    calculo: "(Execuções com sucesso / Total de execuções) * 100"

  - nome: "Tempo Médio de Resposta"
    descricao: "Tempo médio de resposta das integrações"
    meta: "<= 500ms"
    log_obrigatorio: true
    calculo: "Média de DuracaoMs de IntegracaoExecucao"

  - nome: "Taxa de Erro de Circuit Breaker"
    descricao: "Percentual de requisições bloqueadas por circuito aberto"
    meta: "< 1%"
    log_obrigatorio: true
    calculo: "(Requisições bloqueadas / Total de tentativas) * 100"

  - nome: "Violações de Rate Limit"
    descricao: "Quantidade de requisições rejeitadas por rate limit"
    meta: "< 5% do total"
    log_obrigatorio: true
    calculo: "Contador de respostas HTTP 429"

# ==============================================================================
# ALERTAS CRÍTICOS
# ==============================================================================

alertas:
  - evento: "Falha em Integração Crítica"
    threshold: "> 5 falhas em 5 minutos"
    severidade: "CRÍTICA"
    canal_notificacao:
      - "email"
      - "slack"
      - "sms"

  - evento: "Circuit Breaker Aberto"
    threshold: "Estado OPEN por mais de 60 segundos"
    severidade: "ALTA"
    canal_notificacao:
      - "email"
      - "slack"

  - evento: "Credenciais Expiradas"
    threshold: "Imediato"
    severidade: "MÉDIA"
    canal_notificacao:
      - "email"

  - evento: "Tentativa de Acesso Sem Permissão"
    threshold: "> 10 tentativas em 5 minutos"
    severidade: "ALTA"
    canal_notificacao:
      - "email"
      - "slack"
      - "log_seguranca"

# ==============================================================================
# INTEGRAÇÕES
# ==============================================================================

integracoes:
  internas:
    - "i18n (Transloco)"
    - "Auditoria (AuditInterceptor)"
    - "Multi-Tenancy (EmpresaId)"
    - "RBAC (Permissões)"
    - "Central de Funcionalidades"
  externas:
    - sistema: "Polly"
      tipo: "Biblioteca"
      obrigatoria: true
      descricao: "Circuit Breaker e Retry policies"
    - sistema: "Hangfire"
      tipo: "Biblioteca"
      obrigatoria: true
      descricao: "Processamento de jobs assíncronos"
    - sistema: "System.Security.Cryptography"
      tipo: "Biblioteca"
      obrigatoria: true
      descricao: "Criptografia de credenciais"

# ==============================================================================
# DEPENDÊNCIAS
# ==============================================================================

dependencias:
  upstream:
    - documentacao_id: "RF006"
      descricao: "Gestão de Usuários (permissões RBAC)"
    - documentacao_id: "RF007"
      descricao: "Gestão de Perfis de Acesso (roles)"
    - documentacao_id: "RF008"
      descricao: "Gestão de Empresas (multi-tenancy)"
  downstream: []

# ==============================================================================
# SEGURANÇA
# ==============================================================================

seguranca:
  isolamento_tenant: true
  auditoria_obrigatoria: true
  soft_delete: false
  criptografia_credenciais: true
  validacao_hmac_webhooks: true
  bloqueio_certificados_invalidos_producao: true

# ==============================================================================
# RASTREABILIDADE
# ==============================================================================

rastreabilidade:
  ucs_esperados:
    - "UC00-listar-integracoes"
    - "UC01-criar-integracao"
    - "UC02-visualizar-integracao"
    - "UC03-editar-integracao"
    - "UC04-excluir-integracao"
    - "UC05-executar-integracao"
    - "UC06-visualizar-execucoes"
    - "UC07-visualizar-estatisticas"

# ==============================================================================
# CENTRAL DE FUNCIONALIDADES
# ==============================================================================

central_funcionalidades:
  codigo: "INTEGRACOES"
  nome: "Gestão de Integrações"
  descricao: "Configuração e monitoramento de integrações com sistemas externos"
  modulo: "Integrações"
  icone: "heroicons_outline:globe-alt"
  rota: "/integracoes"
  ordem: 100
  ativo: true
  i18n_keys:
    menu_title: "menu.integracoes"
    menu_description: "menu.integracoes.description"

# ==============================================================================
# HISTÓRICO
# ==============================================================================

historico:
  - versao: "1.0"
    data: "2025-01-19"
    autor: "Claude"
    descricao: "Documentação reversa inicial"
  - versao: "2.0"
    data: "2025-12-31"
    autor: "Agência ALC - alc.dev.br"
    descricao: "Migração para governança v2.0 (separação RF/RL)"
