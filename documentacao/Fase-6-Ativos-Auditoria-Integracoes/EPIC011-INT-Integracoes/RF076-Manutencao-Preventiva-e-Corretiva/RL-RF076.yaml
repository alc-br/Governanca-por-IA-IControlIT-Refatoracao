# =============================================
# RL-RF076 - Referência ao Legado
# Manutenção Preventiva e Corretiva
# Versão: 2.0
# Data: 2025-12-30
# Autor: Agência ALC - alc.dev.br
# =============================================

rf_id: RF076
titulo: "Manutenção Preventiva e Corretiva"

legado:
  sistema: "VB.NET + ASP.NET Web Forms"
  versao: "Não versionado"
  arquitetura: "Monolítica WebForms"
  banco_dados: "SQL Server (IControlIT_Legado)"
  multi_tenant: false
  auditoria: "partial"  # Apenas Id_Usuario_Criacao e Dt_Criacao

# =============================================
# REFERÊNCIAS AO LEGADO COM DESTINO OBRIGATÓRIO
# =============================================

referencias:
  # --- TABELAS LEGADAS ---
  - id: "LEG-RF076-001"
    tipo: "tabela"
    nome: "OrdemManutencao"
    caminho: "Database/dbo.OrdemManutencao"
    descricao: |
      Tabela principal de ordens de manutenção no legado.
      Campos: Id_Ordem, Id_Ativo, Nu_Ordem, Ds_Tipo, Ds_Status, Dt_Solicitacao, Dt_Prevista, Dt_Execucao, Dt_Fechamento, Nu_Horas, Vl_Total.
      Problemas: sem multi-tenancy, sem soft delete, sem auditoria completa, status textual sem validação.
    destino: "substituido"
    justificativa: |
      Nova tabela OrdemServico com:
      - Multi-tenancy (Id_Fornecedor)
      - Soft delete (Fl_Excluido)
      - Auditoria completa (criação, alteração, exclusão)
      - Status enum (Agendada, Aprovada, Rejeitada, EmExecucao, Concluida, Fechada)
      - FKs para responsável, técnico, aprovador
    documentacao_item_relacionado: "RN-RF076-03"
    uc_relacionado: "UC06"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF076-002"
    tipo: "tabela"
    nome: "OrdemManutencaoItem"
    caminho: "Database/dbo.OrdemManutencaoItem"
    descricao: |
      Tabela de itens (peças/materiais) de ordens de manutenção.
      Campos: Id_Item, Id_Ordem, Id_Peca, Ds_Item, Qt_Quantidade, Vl_Unitario, Vl_Total.
      Problemas: sem auditoria, Vl_Total redundante (calculado), sem unidade de medida.
    destino: "substituido"
    justificativa: |
      Nova tabela OrdemServicoItem com:
      - Auditoria completa
      - Remoção de Vl_Total (calculado dinamicamente)
      - Campo UnidadeMedida
      - Integração com inventário
    documentacao_item_relacionado: "RN-RF076-04"
    uc_relacionado: "UC08"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF076-003"
    tipo: "tabela"
    nome: "PlanoManutencao"
    caminho: "Database/dbo.PlanoManutencao"
    descricao: |
      Tabela de planos de manutenção preventiva.
      Campos: Id_Plano, Id_Ativo, Ds_Plano, Nu_Intervalo_Dias, Fl_Ativo, Dt_Proxima.
      Problemas: apenas periodicidade por dias, sem checklist, sem auditoria, sem multi-tenancy.
    destino: "substituido"
    justificativa: |
      Nova tabela PlanoManutencao com:
      - Periodicidade flexível (dias, horas, km)
      - Campo TipoPeriodicidade (enum)
      - Checklist de atividades (JSON ou tabela separada)
      - Multi-tenancy
      - Auditoria completa
      - Soft delete
    documentacao_item_relacionado: "RN-RF076-01"
    uc_relacionado: "UC01"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  # --- REGRAS DE NEGÓCIO IMPLÍCITAS ---
  - id: "LEG-RF076-004"
    tipo: "regra_negocio"
    nome: "Status textual sem validação"
    caminho: "Database/dbo.OrdemManutencao.Ds_Status"
    descricao: |
      Campo Ds_Status aceita qualquer texto (VARCHAR(50)), permitindo valores inconsistentes:
      "Agendado", "agendada", "AGENDADA", "Em andamento", "Concluído", etc.
      Nenhuma validação de constraint ou enum.
    destino: "substituido"
    justificativa: |
      No RF076, Status será enum com valores fixos:
      - Agendada
      - Aprovada
      - Rejeitada
      - EmExecucao
      - Concluida
      - Fechada
      Transições controladas por RN-RF076-03.
    documentacao_item_relacionado: "RN-RF076-03"
    uc_relacionado: "UC07"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 2

  - id: "LEG-RF076-005"
    tipo: "regra_negocio"
    nome: "Cálculo manual de custo total"
    caminho: "ic1_legado/IControlIT/OrdemManutencao.aspx.vb"
    descricao: |
      Campo Vl_Total em OrdemManutencao é preenchido manualmente.
      Não há sincronização automática com soma de OrdemManutencaoItem.
      Usuário pode editar Vl_Total livremente, causando inconsistência.
    destino: "substituido"
    justificativa: |
      No RF076, CustoTotal será propriedade calculada:
      - Soma de OrdemServicoItem (Quantidade × CustoUnitario)
      - Mais custos de mão de obra (se aplicável)
      - Não armazenado no banco (computed property)
    documentacao_item_relacionado: "RN-RF076-04"
    uc_relacionado: "UC09"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF076-006"
    tipo: "regra_negocio"
    nome: "Sem workflow de aprovação"
    caminho: "ic1_legado/IControlIT/OrdemManutencao.aspx.vb"
    descricao: |
      Não há registro de aprovação formal.
      Aprovação era feita informalmente por email.
      Campos Id_Aprovador, Dt_Aprovacao, Status_Aprovacao não existem.
    destino: "substituido"
    justificativa: |
      No RF076, workflow estruturado com:
      - Estados: Agendada → Aprovada/Rejeitada
      - Campo IdAprovador (FK Usuario)
      - Campo DataAprovacao
      - Campo MotivoRejeicao (se rejeitada)
      - Permissão man:ordem:approve obrigatória
      - Auditoria de transições
    documentacao_item_relacionado: "RN-RF076-03"
    uc_relacionado: "UC07"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF076-007"
    tipo: "regra_negocio"
    nome: "Sem integração com status de ativo"
    caminho: "ic1_legado/IControlIT/OrdemManutencao.aspx.vb"
    descricao: |
      Quando ordem entra em execução, status do ativo não é atualizado automaticamente.
      Usuário deve manualmente alterar status em tela separada (Gestão de Ativos).
      Risco de inconsistência (ordem em execução mas ativo marcado como Operacional).
    destino: "substituido"
    justificativa: |
      No RF076, integração automática via eventos de domínio:
      - Ordem passa para EmExecucao → Ativo muda para EmManutencao
      - Ordem concluída → Ativo volta para Operacional (ou status especificado)
      - RN-RF076-08 garante consistência
    documentacao_item_relacionado: "RN-RF076-08"
    uc_relacionado: "UC08"
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF076-008"
    tipo: "regra_negocio"
    nome: "MTBF/MTTR calculados manualmente em Excel"
    caminho: "ic1_legado/IControlIT/Relatorios/ExportarManutencao.aspx"
    descricao: |
      Sistema legado exporta dados brutos de ordens para Excel.
      Usuário calcula MTBF e MTTR manualmente usando fórmulas Excel.
      Nenhum cálculo automático no banco ou código VB.NET.
    destino: "substituido"
    justificativa: |
      No RF076, cálculo automático:
      - MTBF: (Total Horas Operação) / (Número de Falhas) - RN-RF076-05
      - MTTR: (Total Horas Reparo) / (Número de Falhas) - RN-RF076-06
      - Atualizado automaticamente ao fechar ordem corretiva
      - Disponível via API GET /api/manutencao/ativos/{id}/mtbf e /mttr
    documentacao_item_relacionado: "RN-RF076-05"
    uc_relacionado: "UC10"
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: 2

  - id: "LEG-RF076-009"
    tipo: "regra_negocio"
    nome: "Sem agendamento automático de manutenções"
    caminho: "ic1_legado/IControlIT/PlanoManutencao.aspx.vb"
    descricao: |
      Planos de manutenção existem apenas como "lembretes".
      Não há criação automática de ordens.
      Usuário deve verificar planos manualmente e criar ordens uma a uma.
    destino: "substituido"
    justificativa: |
      No RF076, agendamento automático via Hangfire:
      - Ao ativar plano, primeira ordem criada imediatamente
      - Ordens subsequentes criadas automaticamente conforme periodicidade
      - RecurringJob (Hangfire) garante execução mesmo após reinício
      - RN-RF076-02 especifica comportamento
    documentacao_item_relacionado: "RN-RF076-02"
    uc_relacionado: "UC01"
    complexidade: "alta"
    risco_migracao: "alto"
    prioridade: 1

  - id: "LEG-RF076-010"
    tipo: "regra_negocio"
    nome: "Sem alertas de manutenção vencida"
    caminho: "ic1_legado/IControlIT/"
    descricao: |
      Nenhum alerta automático quando manutenção preventiva não é executada.
      Usuário deve verificar manualmente ordens atrasadas.
    destino: "substituido"
    justificativa: |
      No RF076, alertas automáticos:
      - Verificação diária (job agendado)
      - Ordem preventiva com DataPrevista < (Hoje - 7 dias) → gera alerta
      - Severidade "Alta"
      - Notificação enviada para responsável
      - RN-RF076-07 especifica comportamento
    documentacao_item_relacionado: "RN-RF076-07"
    uc_relacionado: "UC06"
    complexidade: "media"
    risco_migracao: "baixo"
    prioridade: 2

  # --- STORED PROCEDURES ---
  - id: "LEG-RF076-011"
    tipo: "stored_procedure"
    nome: "pa_manutencao_listar"
    caminho: "Database/Stored Procedures/pa_manutencao_listar"
    descricao: |
      Stored Procedure para listar ordens com filtros básicos.
      Aceita parâmetros: Id_Ativo, Ds_Status, Dt_Inicio, Dt_Fim.
      Retorna recordset com ordens.
    destino: "substituido"
    justificativa: |
      No RF076, substituído por Query CQRS:
      - GetOrdensQuery com LINQ
      - Paginação (skip/take)
      - Filtros tipados (IdAtivo, Status enum, DataInicio, DataFim)
      - Ordenação configurável
    documentacao_item_relacionado: "UC05"
    uc_relacionado: "UC05"
    complexidade: "baixa"
    risco_migracao: "baixo"
    prioridade: 3

  - id: "LEG-RF076-012"
    tipo: "stored_procedure"
    nome: "pa_manutencao_gerar_agenda"
    caminho: "Database/Stored Procedures/pa_manutencao_gerar_agenda"
    descricao: |
      Stored Procedure executada manualmente para gerar próximas ordens preventivas.
      Usuário deve executar periodicamente (não automático).
    destino: "substituido"
    justificativa: |
      No RF076, substituído por Hangfire RecurringJob.
      Ordens criadas automaticamente conforme periodicidade.
      RN-RF076-02 garante automação.
    documentacao_item_relacionado: "RN-RF076-02"
    uc_relacionado: "UC01"
    complexidade: "alta"
    risco_migracao: "medio"
    prioridade: 1

  - id: "LEG-RF076-013"
    tipo: "stored_procedure"
    nome: "pa_atualizar_status_ativo"
    caminho: "Database/Stored Procedures/pa_atualizar_status_ativo"
    descricao: |
      Stored Procedure chamada manualmente para sincronizar status de ativo.
      Não há integração automática.
    destino: "substituido"
    justificativa: |
      No RF076, substituído por eventos de domínio.
      StatusAtivoAlteradoEvent publicado automaticamente ao mudar status de ordem.
      RN-RF076-08 garante consistência.
    documentacao_item_relacionado: "RN-RF076-08"
    uc_relacionado: "UC08"
    complexidade: "media"
    risco_migracao: "medio"
    prioridade: 1

# --- TELAS LEGADAS ---
# Nenhuma tela específica de manutenção encontrada no legado
# Evidência: busca por ordem*.aspx, manutencao*.aspx, servico*.aspx = 0 resultados

telas: []

# --- WEBSERVICES LEGADOS ---
# Nenhum WebService específico encontrado

servicos: []

# --- TABELAS RELACIONADAS ---
tabelas:
  - nome: "OrdemManutencao"
    finalidade: "Armazenar ordens de manutenção"
    problemas:
      - "Sem Id_Fornecedor (não multi-tenant)"
      - "Sem Fl_Excluido (não soft delete)"
      - "Auditoria incompleta"
      - "Status textual sem validação"

  - nome: "OrdemManutencaoItem"
    finalidade: "Armazenar peças/materiais utilizados"
    problemas:
      - "Sem auditoria"
      - "Vl_Total redundante"
      - "Sem unidade de medida"

  - nome: "PlanoManutencao"
    finalidade: "Armazenar planos de manutenção preventiva"
    problemas:
      - "Sem multi-tenancy"
      - "Periodicidade limitada (apenas dias)"
      - "Sem checklist"
      - "Sem auditoria"

# --- REGRAS IMPLÍCITAS ---
regras_implicitas:
  - id: "RL-RN-001"
    descricao: "Status textual sem validação permite valores inconsistentes"
    fonte: "OrdemManutencao.Ds_Status VARCHAR(50)"

  - id: "RL-RN-002"
    descricao: "Custo total calculado manualmente, pode divergir de soma de itens"
    fonte: "OrdemManutencao.Vl_Total"

  - id: "RL-RN-003"
    descricao: "Sem workflow de aprovação formal"
    fonte: "Ausência de campos de aprovação"

  - id: "RL-RN-004"
    descricao: "Status de ativo não sincronizado automaticamente"
    fonte: "Ausência de trigger ou evento"

  - id: "RL-RN-005"
    descricao: "MTBF/MTTR calculados manualmente em Excel"
    fonte: "Relatórios de exportação"

# --- GAP ANALYSIS ---
gap_analysis:
  - item: "Criação de ordem manual"
    existe_legado: true
    existe_moderno: true
    notas: "Funcionalidade mantida"

  - item: "Agendamento automático"
    existe_legado: false
    existe_moderno: true
    notas: "Nova funcionalidade (Hangfire)"

  - item: "Workflow de aprovação"
    existe_legado: false
    existe_moderno: true
    notas: "Nova funcionalidade estruturada"

  - item: "Cálculo MTBF/MTTR"
    existe_legado: false
    existe_moderno: true
    notas: "Automação de processo manual"

  - item: "Alertas de vencimento"
    existe_legado: false
    existe_moderno: true
    notas: "Nova funcionalidade"

  - item: "Multi-tenancy"
    existe_legado: false
    existe_moderno: true
    notas: "Isolamento obrigatório"

# --- DECISÕES DE MODERNIZAÇÃO ---
decisoes_modernizacao:
  - decisao: "Não migrar dados históricos de ordens antigas"
    motivo: |
      Tabelas legadas sem multi-tenancy e auditoria completa tornam migração arriscada.
      Dados históricos mantidos no legado apenas para consulta.
    impacto: "alto"
    data: "2025-12-30"

  - decisao: "Implementar agendamento com Hangfire"
    motivo: |
      Sistema legado não possui agendamento automático.
      Hangfire é padrão moderno para jobs recorrentes.
    impacto: "alto"
    data: "2025-12-30"

  - decisao: "Workflow estruturado com eventos de domínio"
    motivo: |
      Legado não possui workflow formal.
      Modernizado precisa rastreabilidade e compliance.
    impacto: "alto"
    data: "2025-12-30"

# --- RISCOS DE MIGRAÇÃO ---
riscos_migracao:
  - risco: "Perda de dados históricos se migração falhar"
    impacto: "alto"
    probabilidade: "baixa"
    mitigacao: "Manter legado como backup, migração incremental"

  - risco: "Jobs Hangfire não executarem após deploy"
    impacto: "alto"
    probabilidade: "media"
    mitigacao: "Testes de agendamento em HOM, monitoramento"

  - risco: "Usuários não compreenderem novo workflow"
    impacto: "medio"
    probabilidade: "alta"
    mitigacao: "Treinamento, documentação, tour guiado"

  - risco: "Fórmulas MTBF/MTTR incorretas"
    impacto: "medio"
    probabilidade: "media"
    mitigacao: "Validação com equipe técnica, testes com dados reais"

# --- RASTREABILIDADE ---
rastreabilidade:
  - elemento_legado: "OrdemManutencao"
    referencia_rf: "RN-RF076-03"
    referencia_uc: "UC06"
    status: "substituido"

  - elemento_legado: "OrdemManutencaoItem"
    referencia_rf: "RN-RF076-04"
    referencia_uc: "UC08"
    status: "substituido"

  - elemento_legado: "PlanoManutencao"
    referencia_rf: "RN-RF076-01"
    referencia_uc: "UC01"
    status: "substituido"

  - elemento_legado: "Cálculo manual MTBF/MTTR"
    referencia_rf: "RN-RF076-05"
    referencia_uc: "UC10"
    status: "substituido"

  - elemento_legado: "Sem workflow de aprovação"
    referencia_rf: "RN-RF076-03"
    referencia_uc: "UC07"
    status: "substituido"

# --- CHANGELOG ---
changelog:
  - versao: "2.0"
    data: "2025-12-30"
    descricao: "Adequação para governança v2.0: campo destino obrigatório, rastreabilidade completa"
    autor: "Agência ALC - alc.dev.br"

  - versao: "1.0"
    data: "2025-12-28"
    descricao: "Documentação inicial do legado"
    autor: "Claude Architect"
