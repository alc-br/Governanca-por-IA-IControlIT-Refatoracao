# RL-RF108.yaml — Referência ao Legado (CAPTCHA, MFA, Contestação e Segurança)
# Versão: 1.0
# Data: 2025-12-31
# Autor: Claude Code
# RF Moderno Relacionado: RF108 - CAPTCHA, MFA, Contestação e Segurança Avançada

rf_id: "RF108"
titulo: "Referência ao Legado - CAPTCHA, MFA, Contestação e Segurança"
versao: "1.0"
data: "2025-12-31"
autor: "Claude Code"
sistema_legado: "IControlIT VB.NET / ASP.NET Web Forms"

# ==============================================================================
# CONTEXTO DO LEGADO
# ==============================================================================

contexto_legado:
  arquitetura: "Monolítica ASP.NET Web Forms + VB.NET"
  tecnologia_captcha: "reCAPTCHA v2 (checkbox visível)"
  tecnologia_mfa: "Apenas SMS manual (sem TOTP)"
  rate_limiting: "Não implementado"
  device_fingerprinting: "Não existia"
  ueba: "Logs manuais sem análise automatizada"
  contestacao: "Formulário simples sem workflow"

  problemas_arquiteturais:
    - "CAPTCHA v2 é intrusivo (checkbox)"
    - "MFA apenas por SMS (custo alto)"
    - "Sem proteção contra DDoS"
    - "Sem device fingerprinting"
    - "Sem análise comportamental automatizada"

# ==============================================================================
# REFERÊNCIAS DO LEGADO RASTREADAS
# ==============================================================================

referencias:
  # ---------------------------------------------------------------------------
  # TELAS ASPX
  # ---------------------------------------------------------------------------

  - id: "LEG-RF108-001"
    tipo: "tela"
    nome: "login.aspx"
    caminho: "ic1_legado/IControlIT/login.aspx"
    descricao: "Login com reCAPTCHA v2 (ASP.NET Web Forms + VB.NET)"
    destino: "substituido"
    justificativa: "Tela Angular `/auth/login` com reCAPTCHA v3 invisível"
    rastreabilidade:
      documentacao_moderno: "RF108 - Seção 5 (RN-RF108-001)"
      uc_moderno: "UC00-RF108 (Login com CAPTCHA)"
      endpoint_moderno: "POST /api/seguranca/captcha/validar"

  - id: "LEG-RF108-002"
    tipo: "tela"
    nome: "contestacao.aspx"
    caminho: "ic1_legado/IControlIT/contestacao.aspx"
    descricao: "Contestação de fatura (ASP.NET Web Forms + VB.NET)"
    destino: "substituido"
    justificativa: "Tela Angular `/contestacoes` com workflow aprovação multi-nível"
    rastreabilidade:
      documentacao_moderno: "RF108 - Seção 5 (RN-RF108-005, RN-RF108-010)"
      uc_moderno: "UC02-RF108 (Gestão de Contestações)"
      endpoint_moderno: "POST /api/contestacoes"

  - id: "LEG-RF108-003"
    tipo: "tela"
    nome: "ip-bloqueados.aspx"
    caminho: "ic1_legado/IControlIT/ip-bloqueados.aspx"
    descricao: "Gestão manual de IPs bloqueados (ASP.NET Web Forms + VB.NET)"
    destino: "substituido"
    justificativa: "Tela Angular `/seguranca/ips-bloqueados` com bloqueio automático + manual"
    rastreabilidade:
      documentacao_moderno: "RF108 - Seção 5 (RN-RF108-007)"
      uc_moderno: "UC04-RF108 (Gestão de IPs Bloqueados)"
      endpoint_moderno: "GET /api/seguranca/ips-bloqueados"

  # ---------------------------------------------------------------------------
  # WEBSERVICES
  # ---------------------------------------------------------------------------

  - id: "LEG-RF108-004"
    tipo: "webservice"
    nome: "WSSeguranca.asmx"
    caminho: "ic1_legado/WebService/WSSeguranca.asmx.vb"
    descricao: "Webservice legado com métodos ValidarCaptcha, GerarCodigoMfa, ListarIpsBloqueados"
    destino: "substituido"
    justificativa: "REST API moderna com endpoints dedicados"
    rastreabilidade:
      documentacao_moderno: "RF108 - Seção 11 (Endpoints da API)"
      endpoints_modernos:
        - "POST /api/seguranca/captcha/validar"
        - "POST /api/seguranca/mfa/enviar-sms"
        - "GET /api/seguranca/ips-bloqueados"

  # ---------------------------------------------------------------------------
  # STORED PROCEDURES
  # ---------------------------------------------------------------------------

  - id: "LEG-RF108-005"
    tipo: "stored_procedure"
    nome: "pa_USER_LOGIN"
    caminho: "dbo.pa_USER_LOGIN"
    descricao: "Autentica usuário sem MFA"
    destino: "substituido"
    justificativa: "AuthenticationService com MFA obrigatório para perfis críticos"
    rastreabilidade:
      documentacao_moderno: "RF108 - Seção 5 (RN-RF108-002)"
      servico_moderno: "Application/Authentication/Commands/LoginCommand.cs"

  - id: "LEG-RF108-006"
    tipo: "stored_procedure"
    nome: "pa_AUDIT_LOG_INSERT"
    caminho: "dbo.pa_AUDIT_LOG_INSERT"
    descricao: "Registra auditoria manual"
    destino: "substituido"
    justificativa: "AuditRepository com registro automático via EF Core Interceptor"
    rastreabilidade:
      documentacao_moderno: "RF108 - Seção 9.3 (Auditoria)"
      servico_moderno: "Infrastructure/Persistence/Interceptors/AuditInterceptor.cs"

  # ---------------------------------------------------------------------------
  # TABELAS E VIEWS
  # ---------------------------------------------------------------------------

  - id: "LEG-RF108-007"
    tipo: "tabela"
    nome: "tblUsuarioMfa"
    caminho: "dbo.tblUsuarioMfa"
    descricao: "Armazenar configuração MFA (apenas SMS)"
    destino: "substituido"
    justificativa: "Tabela UserMfaConfiguration com suporte SMS, Email e TOTP"
    rastreabilidade:
      documentacao_moderno: "RF108 - Seção 13 (MD-RF108.md)"
      tabela_moderna: "UserMfaConfiguration"

  - id: "LEG-RF108-008"
    tipo: "tabela"
    nome: "tblIpBloqueado"
    caminho: "dbo.tblIpBloqueado"
    descricao: "Armazenar IPs bloqueados manualmente"
    destino: "substituido"
    justificativa: "Tabela BlockedIp com bloqueio automático + manual"
    rastreabilidade:
      documentacao_moderno: "RF108 - Seção 13 (MD-RF108.md)"
      tabela_moderna: "BlockedIp"

  - id: "LEG-RF108-009"
    tipo: "tabela"
    nome: "tblContestacao"
    caminho: "dbo.tblContestacao"
    descricao: "Armazenar contestações sem workflow"
    destino: "substituido"
    justificativa: "Tabela Contestacao com workflow aprovação multi-nível"
    rastreabilidade:
      documentacao_moderno: "RF108 - Seção 13 (MD-RF108.md)"
      tabela_moderna: "Contestacao"

  # ---------------------------------------------------------------------------
  # REGRAS DE NEGÓCIO IMPLÍCITAS NO LEGADO
  # ---------------------------------------------------------------------------

  - id: "LEG-RF108-010"
    tipo: "regra_implicita"
    nome: "CAPTCHA visível sempre"
    caminho: "Regra não documentada"
    descricao: "reCAPTCHA v2 sempre visível (checkbox) em todos os logins"
    destino: "substituido"
    justificativa: "reCAPTCHA v3 invisível com exibição condicional após 3 falhas"
    rastreabilidade:
      documentacao_moderno: "RF108 - Seção 5 (RN-RF108-001)"

  - id: "LEG-RF108-011"
    tipo: "regra_implicita"
    nome: "MFA apenas SMS"
    caminho: "Regra não documentada"
    descricao: "Código enviado apenas por SMS (custo alto, sem alternativas)"
    destino: "substituido"
    justificativa: "Multi-canal: SMS, Email e TOTP (Google Authenticator)"
    rastreabilidade:
      documentacao_moderno: "RF108 - Seção 5 (RN-RF108-002)"

  - id: "LEG-RF108-012"
    tipo: "regra_implicita"
    nome: "Sem rate limiting"
    caminho: "Regra não documentada"
    descricao: "Sistema vulnerável a DDoS (nenhum controle de taxa)"
    destino: "substituido"
    justificativa: "Rate limiting de 100 req/min por IP com HTTP 429"
    rastreabilidade:
      documentacao_moderno: "RF108 - Seção 5 (RN-RF108-006)"

  - id: "LEG-RF108-013"
    tipo: "regra_implicita"
    nome: "Bloqueio manual de IPs"
    caminho: "Regra não documentada"
    descricao: "IPs bloqueados apenas manualmente por administrador"
    destino: "substituido"
    justificativa: "Bloqueio automático após 5 falhas + bloqueio manual"
    rastreabilidade:
      documentacao_moderno: "RF108 - Seção 5 (RN-RF108-007)"

  - id: "LEG-RF108-014"
    tipo: "regra_implicita"
    nome: "Sem device fingerprinting"
    caminho: "Regra não documentada"
    descricao: "Não identifica dispositivos, MFA sempre obrigatório"
    destino: "substituido"
    justificativa: "Device fingerprinting com dispositivos confiáveis (MFA opcional)"
    rastreabilidade:
      documentacao_moderno: "RF108 - Seção 5 (RN-RF108-008)"

  - id: "LEG-RF108-015"
    tipo: "regra_implicita"
    nome: "Sem análise comportamental"
    caminho: "Regra não documentada"
    descricao: "Logs manuais sem detecção automática de anomalias"
    destino: "substituido"
    justificativa: "UEBA com análise comportamental e alertas automáticos"
    rastreabilidade:
      documentacao_moderno: "RF108 - Seção 4 (Funcionalidade 9)"

  - id: "LEG-RF108-016"
    tipo: "regra_implicita"
    nome: "Contestação sem workflow"
    caminho: "Regra não documentada"
    descricao: "Contestação criada e aprovada sem fluxo estruturado"
    destino: "substituido"
    justificativa: "Workflow com estados (Pending, Approved, Rejected, Cancelled)"
    rastreabilidade:
      documentacao_moderno: "RF108 - Seção 6 (Estados e Transições)"

  # ---------------------------------------------------------------------------
  # BIBLIOTECAS E DEPENDÊNCIAS EXTERNAS
  # ---------------------------------------------------------------------------

  - id: "LEG-RF108-017"
    tipo: "biblioteca"
    nome: "reCAPTCHA v2 Lib (Google)"
    caminho: "Biblioteca externa"
    descricao: "reCAPTCHA v2 com checkbox visível"
    destino: "substituido"
    justificativa: "reCAPTCHA v3 invisível com score de risco"
    rastreabilidade:
      documentacao_moderno: "RF108 - Seção 3 (Conceitos - CAPTCHA)"

  - id: "LEG-RF108-018"
    tipo: "biblioteca"
    nome: "Twilio SMS (manual)"
    caminho: "Biblioteca externa"
    descricao: "Twilio para envio de SMS (implementação manual)"
    destino: "assumido"
    justificativa: "Twilio continua sendo usado, mas agora com wrapper assíncrono e retry"
    rastreabilidade:
      documentacao_moderno: "RF108 - Seção 9.1 (MFA_SMS)"

# ==============================================================================
# PROBLEMAS LEGADO IDENTIFICADOS
# ==============================================================================

problemas_legado:
  - id: "PROB-LEG-RF108-001"
    titulo: "CAPTCHA v2 intrusivo"
    descricao: "reCAPTCHA v2 visível em todos os logins (UX ruim)"
    impacto: "ALTO"
    solucao_moderna: "reCAPTCHA v3 invisível, exibido apenas após 3 falhas"

  - id: "PROB-LEG-RF108-002"
    titulo: "MFA apenas SMS (custo alto)"
    descricao: "Custo elevado com SMS, sem alternativas gratuitas"
    impacto: "MÉDIO"
    solucao_moderna: "Multi-canal: SMS, Email (gratuito) e TOTP (gratuito)"

  - id: "PROB-LEG-RF108-003"
    titulo: "Sem rate limiting"
    descricao: "Sistema vulnerável a DDoS e force brute"
    impacto: "CRÍTICO"
    solucao_moderna: "Rate limiting de 100 req/min por IP + bloqueio automático"

  - id: "PROB-LEG-RF108-004"
    titulo: "Sem device fingerprinting"
    descricao: "MFA sempre obrigatório, mesmo em dispositivos conhecidos"
    impacto: "MÉDIO"
    solucao_moderna: "Device fingerprinting com dispositivos confiáveis (MFA opcional)"

  - id: "PROB-LEG-RF108-005"
    titulo: "Sem análise comportamental"
    descricao: "Detecção de fraudes apenas manual"
    impacto: "ALTO"
    solucao_moderna: "UEBA com ML para detecção automática de anomalias"

  - id: "PROB-LEG-RF108-006"
    titulo: "Contestação sem workflow"
    descricao: "Contestação sem segregação de funções e auditoria"
    impacto: "MÉDIO"
    solucao_moderna: "Workflow com aprovação multi-nível e auditoria completa"

# ==============================================================================
# OPORTUNIDADES DE MELHORIA (DO LEGADO PARA MODERNO)
# ==============================================================================

melhorias:
  - id: "MELHORIA-RF108-001"
    titulo: "CAPTCHA Invisível"
    descricao: "reCAPTCHA v3 com score de risco, sem interrupção do fluxo do usuário"
    beneficio: "Melhoria de UX + proteção superior contra bots"

  - id: "MELHORIA-RF108-002"
    titulo: "MFA Multi-canal"
    descricao: "SMS, Email e TOTP (Google Authenticator)"
    beneficio: "Redução de custo (Email/TOTP gratuitos) + flexibilidade"

  - id: "MELHORIA-RF108-003"
    titulo: "Rate Limiting Inteligente"
    descricao: "Controle de taxa por IP, usuário e tipo de operação"
    beneficio: "Proteção contra DDoS e abuso de recursos"

  - id: "MELHORIA-RF108-004"
    titulo: "Bloqueio Automático"
    descricao: "IP bloqueado automaticamente após 5 falhas"
    beneficio: "Proteção contra force brute sem intervenção manual"

  - id: "MELHORIA-RF108-005"
    titulo: "Device Fingerprinting"
    descricao: "Identificação única de dispositivos confiáveis"
    beneficio: "MFA opcional em dispositivos conhecidos (melhor UX)"

  - id: "MELHORIA-RF108-006"
    titulo: "UEBA (Análise Comportamental)"
    descricao: "Detecção automática de acessos anômalos com ML"
    beneficio: "Prevenção de fraudes em tempo real"

  - id: "MELHORIA-RF108-007"
    titulo: "Workflow de Contestação"
    descricao: "Aprovação multi-nível com segregação de funções"
    beneficio: "Compliance e auditoria completa"

  - id: "MELHORIA-RF108-008"
    titulo: "Notificações Automáticas"
    descricao: "Alerta de login de nova localização/dispositivo"
    beneficio: "Usuário informado sobre possível comprometimento de conta"

# ==============================================================================
# MAPEAMENTO LEGADO → MODERNO (RASTREABILIDADE COMPLETA)
# ==============================================================================

mapeamento_legado_moderno:
  telas:
    - legado: "login.aspx"
      moderno: "Angular `/auth/login`"

    - legado: "contestacao.aspx"
      moderno: "Angular `/contestacoes`"

    - legado: "ip-bloqueados.aspx"
      moderno: "Angular `/seguranca/ips-bloqueados`"

  webservices:
    - legado: "WSSeguranca.asmx/ValidarCaptcha"
      moderno: "POST /api/seguranca/captcha/validar"

    - legado: "WSSeguranca.asmx/GerarCodigoMfa"
      moderno: "POST /api/seguranca/mfa/enviar-sms"

    - legado: "WSSeguranca.asmx/ListarIpsBloqueados"
      moderno: "GET /api/seguranca/ips-bloqueados"

  stored_procedures:
    - legado: "pa_USER_LOGIN"
      moderno: "Application/Authentication/Commands/LoginCommand.cs"

    - legado: "pa_AUDIT_LOG_INSERT"
      moderno: "Infrastructure/Persistence/Interceptors/AuditInterceptor.cs"

  tabelas:
    - legado: "tblUsuarioMfa"
      moderno: "UserMfaConfiguration"

    - legado: "tblIpBloqueado"
      moderno: "BlockedIp"

    - legado: "tblContestacao"
      moderno: "Contestacao"

  bibliotecas:
    - legado: "reCAPTCHA v2"
      moderno: "reCAPTCHA v3"

    - legado: "Twilio SMS (manual)"
      moderno: "Twilio SDK + Hangfire (assíncrono)"

# ==============================================================================
# METADADOS DO LEGADO
# ==============================================================================

metadados:
  total_itens_legado: 18
  telas_aspx: 3
  webservices_asmx: 1
  stored_procedures: 2
  tabelas: 3
  regras_implicitas: 7
  bibliotecas: 2
  problemas_identificados: 6
  melhorias: 8
  cobertura_destinos: "100%"
  itens_substituidos: 17
  itens_assumidos: 1

destinos_distribuicao:
  substituido: 17
  assumido: 1
  descartado: 0
  a_revisar: 0

# ==============================================================================
# CHANGELOG
# ==============================================================================

changelog:
  - versao: "1.0"
    data: "2025-12-31"
    descricao: "RL-RF108 criado com rastreabilidade completa"
    autor: "Claude Code"
