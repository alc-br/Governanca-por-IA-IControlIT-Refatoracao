# RF108: CAPTCHA, MFA, Contestação e Segurança Avançada

**Versão**: 2.0
**Data**: 2025-12-31
**Autor**: Claude Code
**EPIC**: EPIC011-INT-Integracoes
**Fase**: Fase 6 - Ativos, Auditoria e Integrações

---

## 1. OBJETIVO DO REQUISITO

Implementar camadas adicionais de proteção além da autenticação básica, fornecendo CAPTCHA, Multi-Factor Authentication (MFA), contestação de faturas, detecção de bots, rate limiting, device fingerprinting e análise comportamental de usuários para proteger contra ataques automatizados e fraudes.

Este documento define **o que o sistema deve fazer**, sob quais condições e quais garantias devem ser preservadas.

---

## 2. ESCOPO

### 2.1 O que está dentro do escopo

- [x] Validação CAPTCHA (reCAPTCHA v3) em formulários sensíveis
- [x] Autenticação multi-fator (SMS, Email, TOTP)
- [x] Contestação de faturas com workflow de aprovação
- [x] Detecção e bloqueio de bots
- [x] Rate limiting por IP/usuário
- [x] Device fingerprinting
- [x] Análise comportamental (UEBA)
- [x] Notificação de acessos anômalos
- [x] Bloqueio automático de IPs
- [x] Whitelist/Blacklist de IPs

### 2.2 Fora do escopo (não objetivos)

- Interface visual específica (definida em WF-RF108)
- Tecnologia de CAPTCHA ou MFA (implementação decide)
- Layout, UX ou identidade visual específica
- Estratégia de deploy ou infraestrutura

---

## 3. CONCEITOS E DEFINIÇÕES

| Termo | Definição |
|-------|-----------|
| **CAPTCHA** | Mecanismo que diferencia humanos de bots. Usa reCAPTCHA v3 com score de risco (0.0 a 1.0) |
| **MFA** | Multi-Factor Authentication - autenticação com múltiplas formas de verificação |
| **TOTP** | Time-based One-Time Password (RFC 6238) - códigos únicos baseados em tempo |
| **Device Fingerprinting** | Identificação única de dispositivo baseada em atributos (User-Agent, resolução, timezone) |
| **UEBA** | User and Entity Behavior Analytics - análise de padrões anormais para detectar fraudes |
| **Rate Limiting** | Controle de taxa de requisições (ex: 100 req/min por IP) |

---

## 4. FUNCIONALIDADES COBERTAS

1. **CAPTCHA em Formulários Sensíveis** - Login, cadastro, redefinição de senha
2. **MFA Multi-canal** - SMS, Email ou TOTP (Google Authenticator)
3. **Contestação de Faturas** - Workflow com aprovação multi-nível
4. **Detecção de Bots** - Análise de padrões de requisição
5. **Rate Limiting Inteligente** - Por IP, usuário e tipo de operação
6. **Bloqueio Automático de IPs** - Após N tentativas falhadas
7. **Whitelist/Blacklist de IPs** - Gestão manual
8. **Device Fingerprinting** - Verificação de dispositivos confiáveis
9. **UEBA (análise comportamental)** - Detecção de acessos anômalos
10. **Notificações de Acessos** - Alerta de login de nova localização/dispositivo

---

## 5. REGRAS DE NEGÓCIO

### RN-RF108-001: CAPTCHA obrigatório após 3 falhas de login

**Descrição**: Após 3 tentativas de login falhadas em 10 minutos, CAPTCHA é obrigatório para a próxima tentativa.

**Justificativa**: Proteção contra ataque de força bruta.

**Critério de Aceite**:
- Tentativas 1-3: sem CAPTCHA
- Tentativa 4+: CAPTCHA obrigatório
- Após login bem-sucedido: contador resetado

---

### RN-RF108-002: MFA obrigatório para perfis críticos

**Descrição**: Usuários com perfis Admin, Gestor ou Auditor devem obrigatoriamente ativar MFA.

**Justificativa**: Proteção contra comprometimento de contas de alto privilégio.

**Critério de Aceite**:
- Usuário comum: MFA opcional
- Admin/Gestor/Auditor sem MFA: bloqueado até configurar
- Validação em login: erro se perfil crítico sem MFA

---

### RN-RF108-003: Código TOTP válido por 30 segundos

**Descrição**: Códigos TOTP (Google Authenticator) válidos apenas por 30 segundos conforme RFC 6238.

**Justificativa**: Padrão de segurança para one-time passwords.

**Critério de Aceite**:
- Código atual: válido
- Código expirado (> 30s): rejeitado
- Janela de tolerância: +/- 30s (1 janela antes/depois)

---

### RN-RF108-004: Código SMS válido por 5 minutos

**Descrição**: Códigos enviados por SMS válidos por 5 minutos.

**Justificativa**: Tempo suficiente para receber e digitar, com limite de segurança.

**Critério de Aceite**:
- Código enviado: válido por 5 minutos
- Após 5 minutos: código inválido
- Código usado uma vez: invalidado imediatamente

---

### RN-RF108-005: Contestação requer justificativa mínima

**Descrição**: Contestação de fatura exige justificativa com mínimo 50 caracteres.

**Justificativa**: Garantir que contestação seja bem fundamentada.

**Critério de Aceite**:
- Justificativa < 50 caracteres: HTTP 400
- Justificativa >= 50 caracteres: aceito
- Justificativa obrigatória (não pode ser null ou vazia)

---

### RN-RF108-006: Rate limiting de 100 req/min por IP

**Descrição**: Máximo 100 requisições por minuto por IP. Acima disso, retornar HTTP 429 (Too Many Requests).

**Justificativa**: Proteção contra DDoS e abuso de recursos.

**Critério de Aceite**:
- <= 100 req/min: permitido
- > 100 req/min: HTTP 429 + header Retry-After
- Whitelist de IPs: sem limite

---

### RN-RF108-007: Bloqueio automático após 5 falhas

**Descrição**: IP bloqueado automaticamente após 5 tentativas de login falhadas em 15 minutos.

**Justificativa**: Proteção contra ataque de força bruta distribuído.

**Critério de Aceite**:
- Tentativas 1-4: permitido
- Tentativa 5: IP bloqueado por 1 hora
- Bloqueio registrado em auditoria

---

### RN-RF108-008: Device fingerprint armazenado para usuários confiáveis

**Descrição**: Dispositivos marcados como confiáveis têm fingerprint armazenado para validação futura.

**Justificativa**: MFA pode ser pulado em dispositivos confiáveis.

**Critério de Aceite**:
- Primeiro acesso: dispositivo NÃO confiável
- Usuário marca como confiável: fingerprint armazenado
- Próximo login do mesmo dispositivo: MFA opcional

---

### RN-RF108-009: Notificação de login de nova localização

**Descrição**: Quando login ocorre de cidade/país diferente do padrão, enviar notificação ao usuário.

**Justificativa**: Alerta de possível comprometimento de conta.

**Critério de Aceite**:
- Login de localização conhecida: sem notificação
- Login de nova localização: email + notificação in-app
- Notificação contém: IP, localização, data/hora

---

### RN-RF108-010: Contestação aprovada/rejeitada por perfil superior

**Descrição**: Apenas Gestores ou Admins podem aprovar/rejeitar contestações de faturas.

**Justificativa**: Workflow de aprovação com segregação de funções.

**Critério de Aceite**:
- Usuário comum: pode contestar, NÃO pode aprovar
- Gestor/Admin: pode aprovar/rejeitar
- Aprovação: status APPROVED + timestamp + aprovador
- Rejeição: status REJECTED + motivo obrigatório

---

## 6. ESTADOS E TRANSIÇÕES

### Estados da Contestação

| Estado | Descrição |
|--------|-----------|
| **Pending** | Aguardando aprovação |
| **Approved** | Aprovada por gestor |
| **Rejected** | Rejeitada por gestor |
| **Cancelled** | Cancelada pelo solicitante |

### Transições permitidas

| De | Para |
|----|------|
| Pending | Approved |
| Pending | Rejected |
| Pending | Cancelled |

---

## 7. EVENTOS DE DOMÍNIO

| Evento | Quando ocorre |
|--------|---------------|
| `mfa.habilitado` | Após usuário ativar MFA |
| `mfa.codigo_enviado` | Após envio de código SMS/Email |
| `mfa.validado` | Após validação bem-sucedida |
| `contestacao.criada` | Após criar contestação |
| `contestacao.aprovada` | Após aprovação |
| `contestacao.rejeitada` | Após rejeição |
| `ip.bloqueado` | Após bloqueio automático de IP |
| `dispositivo.confiavel` | Após marcar dispositivo como confiável |
| `acesso.anomalo` | Após detecção de acesso anômalo |

---

## 8. CRITÉRIOS GLOBAIS DE ACEITE

- CAPTCHA obrigatório após 3 falhas de login
- MFA obrigatório para perfis críticos
- Códigos TOTP válidos por 30s, SMS por 5min
- Rate limiting de 100 req/min por IP
- Bloqueio automático após 5 falhas
- Contestação requer justificativa >= 50 caracteres
- Notificação de logins anômalos
- Device fingerprinting para dispositivos confiáveis
- Auditoria completa de todas as operações

---

## 9. INTEGRAÇÕES OBRIGATÓRIAS

### 9.1 Central de Funcionalidades (Feature Flags)

| FeatureKey | Nome | Descrição |
|------------|------|-----------|
| `SECURITY_ADVANCED` | Segurança Avançada | CAPTCHA, MFA, Anti-fraude |
| `CAPTCHA_RECAPTCHA_V3` | reCAPTCHA v3 | CAPTCHA invisível com score |
| `MFA_SMS` | MFA via SMS | Twilio |
| `MFA_EMAIL` | MFA via Email | SendGrid |
| `MFA_TOTP` | MFA via TOTP | Google Authenticator |
| `CONTESTACAO_WORKFLOW` | Contestação com Workflow | Aprovação multi-nível |
| `RATE_LIMITING` | Rate Limiting | Controle de taxa |
| `IP_BLOCKING` | Bloqueio de IPs | Automático/Manual |
| `DEVICE_FINGERPRINTING` | Device Fingerprinting | Identificação de dispositivos |
| `UEBA` | Análise Comportamental | Detecção de anomalias |

### 9.2 Internacionalização (i18n)

Chaves obrigatórias (pt-BR, en, es):

- `seguranca.captcha_requerido` → "CAPTCHA obrigatório após múltiplas falhas"
- `seguranca.mfa_obrigatorio` → "MFA obrigatório para seu perfil"
- `seguranca.codigo_invalido` → "Código inválido ou expirado"
- `seguranca.ip_bloqueado` → "IP bloqueado temporariamente"
- `contestacao.justificativa_minima` → "Justificativa deve ter no mínimo 50 caracteres"

### 9.3 Auditoria

Operações auditadas:

| Operação | Código | Dados Registrados |
|----------|--------|-------------------|
| Login com MFA | `AUTH_MFA_SUCCESS` | UsuarioId, MfaTipo, IP, Dispositivo |
| Bloqueio de IP | `SEC_IP_BLOCKED` | IP, Motivo, Timestamp |
| Contestação Criada | `CONTEST_CREATED` | ContestacaoId, FaturaId, UsuarioId, Justificativa |
| Contestação Aprovada | `CONTEST_APPROVED` | ContestacaoId, AprovadorId, Timestamp |

**Retenção**: 7 anos (Lei de Acesso à Informação + LGPD)

### 9.4 Controle de Acesso (RBAC)

| Permissão | Descrição | Perfis |
|-----------|-----------|--------|
| `seguranca:mfa:configurar` | Configurar MFA | Todos autenticados |
| `seguranca:ips:bloquear` | Bloquear IPs | Administrador |
| `seguranca:ips:desbloquear` | Desbloquear IPs | Administrador |
| `contestacao:criar` | Criar contestação | Analista, Gerente |
| `contestacao:aprovar` | Aprovar contestação | Gerente, Administrador |
| `contestacao:rejeitar` | Rejeitar contestação | Gerente, Administrador |
| `seguranca:dispositivos:gerenciar` | Gerenciar dispositivos confiáveis | Todos autenticados |

---

## 10. SEGURANÇA

### 10.1 Proteções Implementadas

| Proteção | Descrição |
|----------|-----------|
| **CAPTCHA reCAPTCHA v3** | Score 0.0-1.0 (abaixo 0.5 = bot provável) |
| **MFA Obrigatório** | Perfis críticos bloqueados sem MFA |
| **Rate Limiting** | 100 req/min por IP |
| **Bloqueio Automático** | IP bloqueado após 5 falhas |
| **Device Fingerprinting** | Identificação única de dispositivos |
| **UEBA** | Análise comportamental com ML |
| **Auditoria Completa** | Todas operações registradas |
| **TOTP RFC 6238** | Padrão IETF para códigos temporários |

### 10.2 Testes de Segurança Obrigatórios

- [ ] Força bruta em login (validar bloqueio após 5 tentativas)
- [ ] DDoS em endpoint público (validar rate limiting)
- [ ] Bypass de CAPTCHA (validar server-side)
- [ ] Reuso de código MFA (validar invalidação)
- [ ] Escalação de privilégios em contestação (validar RBAC)
- [ ] SQL Injection em justificativa de contestação
- [ ] XSS em campos de texto livre

---

## 11. ENDPOINTS DA API

### 11.1 CAPTCHA

| Método | Endpoint | Descrição | Permissão |
|--------|----------|-----------|-----------|
| POST | `/api/seguranca/captcha/validar` | Validar reCAPTCHA token | Público |

### 11.2 MFA

| Método | Endpoint | Descrição | Permissão |
|--------|----------|-----------|-----------|
| POST | `/api/seguranca/mfa/habilitar` | Habilitar MFA | Autenticado |
| POST | `/api/seguranca/mfa/enviar-sms` | Enviar código SMS | Autenticado |
| POST | `/api/seguranca/mfa/enviar-email` | Enviar código Email | Autenticado |
| POST | `/api/seguranca/mfa/validar-totp` | Validar código TOTP | Autenticado |
| POST | `/api/seguranca/mfa/desabilitar` | Desabilitar MFA | Autenticado |

### 11.3 Contestação

| Método | Endpoint | Descrição | Permissão |
|--------|----------|-----------|-----------|
| POST | `/api/contestacoes` | Criar contestação | `contestacao:criar` |
| GET | `/api/contestacoes/{id}` | Obter contestação | `contestacao:criar` |
| PUT | `/api/contestacoes/{id}/aprovar` | Aprovar contestação | `contestacao:aprovar` |
| PUT | `/api/contestacoes/{id}/rejeitar` | Rejeitar contestação | `contestacao:rejeitar` |
| DELETE | `/api/contestacoes/{id}` | Cancelar contestação | `contestacao:criar` |

### 11.4 Segurança

| Método | Endpoint | Descrição | Permissão |
|--------|----------|-----------|-----------|
| GET | `/api/seguranca/ips-bloqueados` | Listar IPs bloqueados | `seguranca:ips:bloquear` |
| POST | `/api/seguranca/ips-bloqueados` | Bloquear IP manualmente | `seguranca:ips:bloquear` |
| DELETE | `/api/seguranca/ips-bloqueados/{id}` | Desbloquear IP | `seguranca:ips:desbloquear` |
| GET | `/api/seguranca/dispositivos` | Listar dispositivos confiáveis | Autenticado |
| POST | `/api/seguranca/dispositivos/{id}/confiar` | Marcar como confiável | Autenticado |

---

## 12. MÉTRICAS E INDICADORES

### 12.1 KPIs

| KPI | Meta | Medição |
|-----|------|---------|
| **Taxa Bloqueio de Bots** | > 95% | CAPTCHA score < 0.5 bloqueados |
| **Taxa Adoção MFA** | > 80% perfis críticos | COUNT(MFA habilitado) / COUNT(perfis críticos) |
| **Tempo Aprovação Contestação** | < 48h | AVG(ApprovedAt - CreatedAt) |
| **Taxa Falsos Positivos UEBA** | < 5% | (Alertas falsos / Total alertas) * 100 |

### 12.2 Alertas

| Alerta | Condição | Ação |
|--------|----------|------|
| **Ataque Força Bruta** | > 100 logins falhados em 5min | Bloquear IP + alerta DevOps |
| **DDoS Detectado** | > 1000 req/min global | Ativar Cloudflare DDoS protection |
| **MFA Não Configurado** | Perfil crítico sem MFA > 7 dias | Bloquear acesso + email |
| **Contestação Pendente** | > 72h sem aprovação | Email para gestor |

---

## 13. ARTEFATOS DERIVADOS

Este RF é base para:

- **UC-RF108.md** (Casos de Uso) - Obrigatório
- **MD-RF108.md** (Modelo de Dados) - Obrigatório
- **WF-RF108.md** (Wireframes e Fluxos) - Obrigatório
- **TC-RF108.yaml** (Casos de Teste) - Obrigatório
- **MT-RF108.yaml** (Massas de Teste) - Obrigatório

---

## 14. RASTREABILIDADE

| Artefato | Status | Obrigatório |
|----------|--------|-------------|
| Casos de Uso | Pendente | Sim |
| Modelo de Dados | Pendente | Sim |
| Wireframes | Pendente | Sim |
| Casos de Teste | Pendente | Sim |
| Massas de Teste | Pendente | Sim |

---

## CHANGELOG

| Versão | Data | Descrição | Autor |
|--------|------|-----------|-------|
| 2.0 | 2025-12-31 | Migração v1.0 → v2.0 - Separação RF/RL completa | Claude Code |
| 1.0 | 2025-12-28 | Versão inicial (misturada com legado) | Claude Code |
